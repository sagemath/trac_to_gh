# Issue 24561: Add missing dependencies for building with SAGE_CHECK=yes

Issue created by migration from Trac.

Original creator: Konrad127123

Original creation time: 2018-02-20 20:49:21

CC:  slelievre




---

Comment by Konrad127123 created at 2018-02-20 20:59:37

Changing type from PLEASE CHANGE to defect.


---

Comment by Konrad127123 created at 2018-02-20 20:59:37

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by Konrad127123 created at 2018-02-20 21:01:30

This patch adds the minimal list of missing packages needed to fix things. (Tested with make distclean && make package_name )


---

Comment by Konrad127123 created at 2018-02-20 21:06:11

New commits:


---

Comment by Konrad127123 created at 2018-02-20 21:06:11

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-03-16 09:53:40

`pycrypto` works for me without your patch.


---

Comment by jdemeyer created at 2018-03-16 09:53:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-16 13:28:33

And I consider the dependency of `cypari` on `six` an upstream bug (it doesn't really need `six`) which is fixed now.


---

Comment by jdemeyer created at 2018-03-16 15:44:35

`scandir` is actually a dependency of `pathlib2`, I fixed that in #24996.


---

Comment by Konrad127123 created at 2018-03-20 11:57:24

Replying to [comment:5 jdemeyer]:
> `pycrypto` works for me without your patch.
Do you have system mpir or gmp installed? If I install the libgmp-dev package (on Debian Unstable) 

```
make distclean  && make pycrypto
```

passes. If I don't have it installed then testing fails with:

```
ERROR: test_negative_number_roundtrip_mpzToLongObj_longObjToMPZ (Crypto.SelfTest.Util.test_number.MiscTests)
Test that mpzToLongObj and longObjToMPZ (internal functions) roundtrip negative numbers correctly.
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/sage/build_experiments/sage-8.1/local/lib/python2.7/site-packages/Crypto/SelfTest/Util/test_number.py", line 283, in test_negative_number_round
trip_mpzToLongObj_longObjToMPZ
    k = number._fastmath.rsa_construct(n, e)
AttributeError: 'NoneType' object has no attribute 'rsa_construct'

----------------------------------------------------------------------
Ran 1033 tests in 48.713s

FAILED (errors=1)
Traceback (most recent call last):
  File "setup.py", line 456, in <module>
    core.setup(**kw)
  File "/home/sage/build_experiments/sage-8.1/local/lib/python2.7/distutils/core.py", line 151, in setup
    dist.run_commands()
  File "/home/sage/build_experiments/sage-8.1/local/lib/python2.7/distutils/dist.py", line 953, in run_commands
    self.run_command(cmd)
  File "/home/sage/build_experiments/sage-8.1/local/lib/python2.7/distutils/dist.py", line 972, in run_command
    cmd_obj.run()
  File "setup.py", line 336, in run
    SelfTest.run(module=moduleObj, verbosity=self.verbose, stream=sys.stdout, config=self.config)
  File "/home/sage/build_experiments/sage-8.1/local/lib/python2.7/site-packages/Crypto/SelfTest/__init__.py", line 74, in run
    raise SelfTestError("Self-test failed", result)
Crypto.SelfTest.SelfTestError: ('Self-test failed', <unittest.runner.TextTestResult run=1033 errors=1 failures=0>)
Error: PyCrypto failed to pass its test suite.
```


With my patch, testing succeeds for me even if system libgmp-dev is not installed.


---

Comment by jdemeyer created at 2018-03-20 12:53:50

Replying to [comment:9 Konrad127123]:
> Replying to [comment:5 jdemeyer]:
> > `pycrypto` works for me without your patch.
> Do you have system mpir or gmp installed?

You are right. pycrypto does require GMP/MPIR. But since it links against it, it should be a real dependency (on the left of the `|` symbol) instead of an order-only dependency (on the right of the `|` symbol).


---

Comment by jdemeyer created at 2018-03-20 12:54:53

I would prefer to revert the change to the dependencies of `cypari`. It will be fixed in the next release.


---

Comment by git created at 2018-03-20 14:02:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Konrad127123 created at 2018-03-20 14:10:10

How's the above for a solution for cypari and pycrypto?

In the latest beta `sagetex` (even with my patch) is failing with

```
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
```


I don't think that happened with 8.2.beta.6 and I haven't tried to find the cause yet. (As an aside, neither `scandir` nor `pathlib2` get pulled in as dependencies when doing make distclean && make sagetex.)


---

Comment by jdemeyer created at 2018-03-20 14:17:54

Replying to [comment:13 Konrad127123]:
> How's the above for a solution for cypari and pycrypto?
> 
> In the latest beta `sagetex` (even with my patch) is failing with
> {{{
> ************************************************************************
> It seems that you are attempting to run Sage from an unpacked source
> tarball, but you have not compiled it yet (or maybe the build has not
> finished). You should run `make` in the Sage root directory first.
> If you did not intend to build Sage from source, you should download
> a binary tarball instead. Read README.txt for more information.
> ************************************************************************
> }}}

Yes, that is #24995.


---

Comment by git created at 2018-03-20 16:29:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Konrad127123 created at 2018-03-20 16:39:22

Changing status from needs_work to needs_review.


---

Comment by Konrad127123 created at 2018-03-20 16:39:22

Ready to review again, I think.


---

Comment by jdemeyer created at 2018-03-20 19:23:46

Looks good to me on first sight. I still need to test it though.


---

Comment by Konrad127123 created at 2018-04-05 15:03:44

Have you had a chance to test it yet? Since it's a build issue, it would be nice to get this into 8.2.


---

Comment by slelievre created at 2018-07-12 11:37:17

Changing keywords from "" to "cypari, pycrypto, dependencies".


---

Comment by slelievre created at 2018-07-12 11:37:17

We might no longer need pycrypto, see #25844 (Remove package pycrypto).


---

Comment by Konrad127123 created at 2018-10-09 20:42:19

Changing keywords from "cypari, pycrypto, dependencies" to "sagetex, matplotlib, dependencies".


---

Comment by Konrad127123 created at 2018-10-09 20:42:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-10-09 21:15:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2018-10-09 21:22:36

Another SageTeX issue: #26343.


---

Comment by Konrad127123 created at 2018-10-09 21:36:41

Changing status from needs_work to positive_review.


---

Comment by Konrad127123 created at 2018-10-09 21:36:41

Dependencies updated for 8.4rc0:

Doing `make distclean && make sagetex` fails unless `kiwisolver`, `sympy`, `elliptic_curves` and `jmol` are installed.

`kiwisolver` should really get pulled in by `matplotlib`, not `sagetex`, so I've added it to `matplotlib`'s runtime dependencies (this got missed in #25702) and added to the rest to `sagetex`.

I tested with 8.4rc0 and confirmed that sagetex now builds with SAGE_CHECK=yes. I've also confirmed that adding any combination of three of the dependencies is not sufficient.


---

Comment by Konrad127123 created at 2018-10-09 21:45:55

Changing status from positive_review to needs_review.


---

Comment by Konrad127123 created at 2018-10-09 21:46:19

Sorry, should have set to needs_review above


---

Comment by Konrad127123 created at 2018-10-23 11:14:01

> I tested with 8.4rc0 and confirmed that sagetex now builds with SAGE_CHECK=yes. I've also confirmed that adding any combination of three of the dependencies is not sufficient.

I have confirmed that this is still the case with 8.5beta0.


---

Comment by Konrad127123 created at 2018-10-30 00:49:01

Patch still works for 8.5beta1 and is still the minimum set of dependencies needed.


---

Comment by jhpalmieri created at 2018-10-30 21:31:22

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2018-10-30 21:31:22

Looks okay to me.


---

Comment by jhpalmieri created at 2018-10-30 21:31:22

Changing priority from major to minor.


---

Comment by vbraun created at 2018-10-31 08:03:03

Resolution: fixed
