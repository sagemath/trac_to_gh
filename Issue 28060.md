# Issue 28060: A small optimization to arithmetic in number fields

Issue created by migration from https://trac.sagemath.org/ticket/28297

Original creator: mmezzarobba

Original creation time: 2019-07-31 07:31:54

Micro-benchmark (maybe of limited relevance):


```   
    sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))
    sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10
    sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10
}}}    
    Before:
{{{    
    sage: %timeit b+c
    The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.
    100000 loops, best of 3: 4.76 µs per loop
}}}    
    After:
{{{    
    sage: %timeit b+c
    The slowest run took 7.52 times longer than the fastest. This could mean that an intermediate result is being cached.
    100000 loops, best of 3: 3.58 µs per loop
}}}

(There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!)


---

Comment by mmezzarobba created at 2019-07-31 07:33:35

New commits:


---

Comment by mmezzarobba created at 2019-07-31 07:33:35

Changing status from new to needs_review.


---

Comment by git created at 2019-07-31 16:02:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-08-18 11:25:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-08-18 11:35:02

Rebased.


---

Comment by mjo created at 2019-08-21 12:59:00

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2019-08-21 12:59:00

Seems straightforward:

The addition to `_reduce_c_()` bails out early if the denominator is one because in that case there's nothing to do. The check is cheap and avoids several other function calls that do nothing when the denominator is one, so I believe it's an improvement on average.

The changes to  `_add_()` and `_sub_()` are identical. We now pull out the GCD of the two denominators (which are smallish numbers) early, and it eventually cancels out. This would happen anyway when we call `_reduce_c_()` before `return`ing, but at that point we would be cancelling the same GCD out of the relatively-largish product of the denominators. I have faith that doing it early at least makes things no worse, and your numbers show an improvement, so it's fine by me. (This also makes it more likely that we hit the new "fast return" in `_reduce_c_()`.)

Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.


---

Comment by git created at 2019-08-21 13:47:15

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2019-08-21 13:47:15

Changing status from positive_review to needs_review.


---

Comment by mmezzarobba created at 2019-08-21 13:49:57

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2019-08-21 13:49:57

Replying to [comment:6 mjo]:
> Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.

I've copied your detailed description (minus a few sentences) there. I hope that's okay.

Thank you for the review!


---

Comment by mjo created at 2019-08-21 21:50:09

Yes that's fine with me. You don't have to give me author credit for just describing what you did, but you're the boss =)


---

Comment by vbraun created at 2019-08-29 20:02:03

Resolution: fixed
