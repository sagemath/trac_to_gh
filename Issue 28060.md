# Issue 28060: A small optimization to arithmetic in number fields

archive/issues_028060.json:
```json
{
    "body": "Micro-benchmark (maybe of limited relevance):\n\n\n```   \n    sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))\n    sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10\n    sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10\n```\n    \n    Before:\n\n```    \n    sage: %timeit b+c\n    The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.\n    100000 loops, best of 3: 4.76 \u00b5s per loop\n```\n    \n    After:\n\n```    \n    sage: %timeit b+c\n    The slowest run took 7.52 times longer than the fastest. This could mean that an intermediate result is being cached.\n    100000 loops, best of 3: 3.58 \u00b5s per loop\n```\n\n\n(There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!)\n\nIssue created by migration from https://trac.sagemath.org/ticket/28297\n\n",
    "created_at": "2019-07-31T07:31:54Z",
    "labels": [
        "component: performance",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "A small optimization to arithmetic in number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28060",
    "user": "https://github.com/mezzarobba"
}
```
Micro-benchmark (maybe of limited relevance):


```   
    sage: NF.<a> = NumberField(x^7 + 2, embedding=QQbar(-2)^(1/7))
    sage: b = ((-7*a^6 + 3*a^4 - 5*a^3 + 2*a^2 - 4)/42)^10
    sage: c = ((-7*a^6 + 7*a^4 - 5*a^3 + 2*a^2 - 4)/56)^10
```
    
    Before:

```    
    sage: %timeit b+c
    The slowest run took 5.91 times longer than the fastest. This could mean that an intermediate result is being cached.
    100000 loops, best of 3: 4.76 µs per loop
```
    
    After:

```    
    sage: %timeit b+c
    The slowest run took 7.52 times longer than the fastest. This could mean that an intermediate result is being cached.
    100000 loops, best of 3: 3.58 µs per loop
```


(There seem to be a lot more opportunities for similar improvements, please feel free to hijack the ticket if you find the time and energy to have a look!)

Issue created by migration from https://trac.sagemath.org/ticket/28297





---

archive/issue_comments_396131.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-31T07:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396131",
    "user": "https://github.com/mezzarobba"
}
```

New commits:



---

archive/issue_comments_396132.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-31T07:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396132",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396133.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-31T16:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396133",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_396134.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-18T11:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396134",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_396135.json:
```json
{
    "body": "Rebased.",
    "created_at": "2019-08-18T11:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396135",
    "user": "https://github.com/mezzarobba"
}
```

Rebased.



---

archive/issue_comments_396136.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T12:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396136",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396137.json:
```json
{
    "body": "Seems straightforward:\n\nThe addition to `_reduce_c_()` bails out early if the denominator is one because in that case there's nothing to do. The check is cheap and avoids several other function calls that do nothing when the denominator is one, so I believe it's an improvement on average.\n\nThe changes to  `_add_()` and `_sub_()` are identical. We now pull out the GCD of the two denominators (which are smallish numbers) early, and it eventually cancels out. This would happen anyway when we call `_reduce_c_()` before `return`ing, but at that point we would be cancelling the same GCD out of the relatively-largish product of the denominators. I have faith that doing it early at least makes things no worse, and your numbers show an improvement, so it's fine by me. (This also makes it more likely that we hit the new \"fast return\" in `_reduce_c_()`.)\n\nCould you please describe the changes in a bit more detail in the commit message? That's my only nitpick.",
    "created_at": "2019-08-21T12:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396137",
    "user": "https://github.com/orlitzky"
}
```

Seems straightforward:

The addition to `_reduce_c_()` bails out early if the denominator is one because in that case there's nothing to do. The check is cheap and avoids several other function calls that do nothing when the denominator is one, so I believe it's an improvement on average.

The changes to  `_add_()` and `_sub_()` are identical. We now pull out the GCD of the two denominators (which are smallish numbers) early, and it eventually cancels out. This would happen anyway when we call `_reduce_c_()` before `return`ing, but at that point we would be cancelling the same GCD out of the relatively-largish product of the denominators. I have faith that doing it early at least makes things no worse, and your numbers show an improvement, so it's fine by me. (This also makes it more likely that we hit the new "fast return" in `_reduce_c_()`.)

Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.



---

archive/issue_comments_396138.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2019-08-21T13:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396138",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_396139.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-08-21T13:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396139",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_396140.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-21T13:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396140",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396141.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.\n\nI've copied your detailed description (minus a few sentences) there. I hope that's okay.\n\nThank you for the review!",
    "created_at": "2019-08-21T13:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396141",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:6 mjo]:
> Could you please describe the changes in a bit more detail in the commit message? That's my only nitpick.

I've copied your detailed description (minus a few sentences) there. I hope that's okay.

Thank you for the review!



---

archive/issue_comments_396142.json:
```json
{
    "body": "Yes that's fine with me. You don't have to give me author credit for just describing what you did, but you're the boss =)",
    "created_at": "2019-08-21T21:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396142",
    "user": "https://github.com/orlitzky"
}
```

Yes that's fine with me. You don't have to give me author credit for just describing what you did, but you're the boss =)



---

archive/issue_comments_396143.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-29T20:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28060",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28060#issuecomment-396143",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
