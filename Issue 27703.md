# Issue 27703: get k-regular sequence from recursions

Issue created by migration from https://trac.sagemath.org/ticket/27940

Original creator: galipnik

Original creation time: 2019-06-06 19:37:41

CC:  dkrenn

Code for constructing the linear representation of k-regular sequences given by recursions.

See also Meta ticket #21202.


---

Comment by galipnik created at 2019-06-06 19:41:51

Changing type from PLEASE CHANGE to enhancement.


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by git created at 2019-12-12 19:28:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-16 16:05:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-16 16:13:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-16 16:24:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-16 16:45:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-17 11:29:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-17 14:04:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-19 17:37:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-20 00:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-23 01:21:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-23 01:27:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-23 01:47:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-02-23 01:48:21

New commits:


---

Comment by galipnik created at 2021-02-23 01:48:21

Changing status from new to needs_review.


---

Comment by git created at 2021-02-24 18:00:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2021-04-16 16:21:39

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2021-04-16 16:21:39

1. Dependencies: It seems that many more branches are merged here than necessary. Please fill out the dependencies field here.

2. Fix patchbot findings

3. `recursions`: description of the `equations` parameter: I am not sure whether writing it as `sum(...)` can cause any confusion. I propose to write some summands with `...`.

4. `recursions`: description of the `equations` parameter: I guess you want to include some coefficients in front of the terms on the right hand side.

5. `recursions`: dead link to `minimized()` in description of parameter `minimize`

6. `_parse_recursions_`: catch `AttributeError` when a non-element of the symbolic ring is given as an equation: `Seq2._parse_recursions_([42], f, n)`

7. `_parse_recursions_` before throwing `%s is not a polynomial`: I think that explicitly naming the exceptions which are likely to occur in the conversion attempt to a polynomial is preferred over generically catching `Exception`.

8. `_parse_recursion_`: `base_ring[var](left_side.operands()[0])` I am unsure whether `base_ring` is the correct ring here. After all, arguments of a regular sequence will alwys be the integers. A few lines later, there is `ZZ[var](left_side.operands()[0])` which seems to be the ring we need to use. So my suggestion is to always use `ZZ[var]` and `polynomial_left` and removing `poly_left`. Also, `polynomial_left in base_ring` does not seem to be the correct ring.

9. `_parse_recursion_`: `initial_values.update({polynomial_left: right_side})` I suggest to check whether an initial value is repeatedly given.

10. `_parse_recursion_`: `if M != log(base_power_M, base=k):` I suggest to replace the right hand side by `M_new` which has just been defined one line before.

11. `_parse_recursion_`: `if r not in ZZ: raise ValueError("%s is not an integer." % (r,))`: I do not think that this can be reached: `r` is a coefficient of a polynomial over `ZZ` anyway. In particular, `Seq2._parse_recursions_([f(2*n+1/2) == f(n)], f, n)` leads to `ValueError: 2*n + 1/2 is not a polynomial in n.`

12. `_parse_recursion_`: `else: # check this again` I do not understand the comment.

13. `_parse_recursion_._parse_multiplication_`: I think that `if op.operator() != mul_vararg or len(op.operands()) != 2: raise ValueError("")` is unreachable, so I suggest to replace this by `assert op.operator() == mul_vararg and len(op.operands()) == 2`.

14. `_parse_recursion_._parse_one_summand_`: `raise ValueError('%s does not have integer coefficients.' % (op.operands()[0],))`: The error message does not seem to fit all cases of failing conversion to an integer polynomial; e.g., `Seq2._parse_recursions_([f(2*n+1) == 2*f(1/n)], f, n)` yields `ValueError: 1/n does not have integer coefficients.

15. `_parse_recursion_._parse_one_summand_`: It should be checked that `len(op.operands()) == 1`; currently, `Seq2._parse_recursions_([f(2*n+1) == 2*f(n+4, 5), f(2*n) == f(n)], f, n)` does not yield an error.

16. `_parse_recursion_`:  Branch `if not coeffs`: As far as I understand, this means that no general equations have been given, only initial values. I do not understand why we do not raise an error in this case.

17. `__get_ind_`: I would replace the two consecutive `.update` calls to the same dictionary by one single call `.update({(j, d): pos, pos: (j, d)})` (twice)

18. `_parse_recursion_`: docstring: I think that even for a private method, the contents of the namedtuple should be explained. 

19. `_get_ind_` docstring: I think that even for a private method, the output should be explained. 

20. `_get_matrix_from_recursions_` docstring: inputs `var` and `function` are not explained. 

21. `_get_matrix_from_recursions_` docstring: Please explain what the role of the parameter `correct_offset` is.

22. `_get_matrix_from_recursions_` example on the number of unbordered factors in the Thue–Morse sequence: please only put one recurrence equation per line in order to make the recurrences more readable.

22. `_get_matrix_from_recursions_` example on the number of unbordered factors in the Thue–Morse sequence: why are there so many initial values? If my calculations are correct, then the "largest" component of the linear representation corresponds to the sequence f(4n+9); for n=3, this is f(21). It might be that this large number of initial values is required in the current code, but I think that the original recurrences could and should be used to compute as many auxiliary values as required. This means that only initial values up to 15 should be required.

23. `_get_matrix_from_recursions_`: the line `n1 = recursion_rules.n1` appears twice.

24. `_get_matrix_from_recursions_`: I think that the lines which define `temp` twice in different ways are rather hard to read. If (as suggested in 22) the required auxiliary values are computed from the initial values in a separate method, then I imagine that these lines could be simply replaced by suitable list comprehensions. The symbolic vector `arguments` could be replaced by a function taking an argument and returning a vector, so no substitutions would be required. Then it might not be necessary to have `function` and `var` as parameters of this method.

25. `_get_matrix_from_recursions_`: the condition for construction the matrix `J` could be simplified: the conditions `i>= rem` and `i % k == rem` can be omitted, because they follow from `j*k == i-rem`. Additionally, it might be simpler to construct this matrix by the version of the matrix constructor which takes a function as an argument.

26. `_get_right_from_recursions_`: The same comment about initial values as mentioned in 22 applies. If a separate method for computing the vector of the linear representation for given arguments is implemented as proposed in 24, then this method here could be shortened considerably. The parameter `function` might then be redundant.

27. `recursions`: example Stern--Brocot: The initial value `f(2)` should not be required.

28. `recursions`: example Odd Entries in Pascal's Triangle: only `f(0)` and `f(1)` should be required as initial values.

29. `recursions`: example Unbordered Factors: one equation per line (cf. 21)

30. `recursions`: example Unbordered Factors: initial values (cf. 22)

31. `recursions`: docstring: "in the a Generalized" remove "a"

32. `recursions`: "[TODO: reference]" please resolve TODO.

33. `recursions`: example Generalized Pascal's Triangle: only initial values `f(0)` and `f(1)` should be required.

34. `recursions`: `mu` could be constructed as a list comprehension instead of appending to a list.

35. This ticket adds quite a number of private methods to `kRegularSequenceSpace` which are only useful for the public method `recursions`. For clarity's sake, I propose to introduce a "see also" block in all auxiliary private methods which refers to `recursions`.

36. The method `_get_ind_` should be renamed such that it clearly relates to the main public method (this is now the case for all other private methods except this one).

37. I am not yet convinced that `kRegularSequenceSpace.recursions` is a good description of the method. Wouldn't one expect to _get_ recursions by such a method, instead of getting a k-regular sequence from a recursion? Perhaps `from_recursion` or possibly more precise `from_recurrence` would be a better name.

38. Please extend the docstring of `recursions` in such a way that a clearer link is provided to `[HKL2021]`. For instance, the docstring could state that such recurrence relations uniquely define a k regular sequence (provided that enough initial values are provided). 

39. Test raising "Initial value ... is missing".

40. Consider using `raise ValueError(...) from None` (once this code runs under python3) in order to supress printing of the detailed exceptions which are explained by the `ValueError` of this code here.


---

Comment by git created at 2021-04-20 16:28:13

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-04-20 20:09:20

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-04-21 12:24:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-21 16:51:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-22 10:38:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-23 09:37:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-26 16:45:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-26 18:42:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-27 14:57:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-27 16:15:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-27 20:21:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-27 21:25:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-04-27 21:32:03

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-27 21:34:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-28 07:30:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2021-04-29 12:08:46

I rebased the branch such that it only contains material from the dependencies #21295, #21203 plus the changes pertinent to this ticket.

More precisely, I rebased commits from 4fe100c576 to eb44f15e6e onto #21203 and then commits from 0b039048e6 until the current branch u/galipnik/k-regular-recursions on top of that.

`@`galpnik: Please cross-review this rebase.

I will review your changes after that.
----
Last 10 new commits:


---

Comment by git created at 2021-04-29 13:50:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-04-29 13:51:26

Replying to [comment:36 cheuberg]:
> `@`galpnik: Please cross-review this rebase.
Thank you! Three new commits pushed, the rest LGTM.


---

Comment by galipnik created at 2021-05-03 17:09:22

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-05 17:25:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-05-05 17:47:42

Here is a more detailed answer to your review:

Replying to [comment:17 cheuberg]:
> 1. Dependencies: It seems that many more branches are merged here than necessary. Please fill out the dependencies field here.
Done. See also comment:36.

> 2. Fix patchbot findings
Done.

> 3. `recursions`: description of the `equations` parameter: I am not sure whether writing it as `sum(...)` can cause any confusion. I propose to write some summands with `...`.
Done and printed in LaTeX.
> 4. `recursions`: description of the `equations` parameter: I guess you want to include some coefficients in front of the terms on the right hand side.
Done.
> 5. `recursions`: dead link to `minimized()` in description of parameter `minimize`
Fixed.
> 6. `_parse_recursions_`: catch `AttributeError` when a non-element of the symbolic ring is given as an equation: `Seq2._parse_recursions_([42], f, n)`
Done and test case added.
> 7. `_parse_recursions_` before throwing `%s is not a polynomial`: I think that explicitly naming the exceptions which are likely to occur in the conversion attempt to a polynomial is preferred over generically catching `Exception`.
Done.
> 8. `_parse_recursion_`: `base_ring[var](left_side.operands()[0])` I am unsure whether `base_ring` is the correct ring here. After all, arguments of a regular sequence will alwys be the integers. A few lines later, there is `ZZ[var](left_side.operands()[0])` which seems to be the ring we need to use. So my suggestion is to always use `ZZ[var]` and `polynomial_left` and removing `poly_left`. Also, `polynomial_left in base_ring` does not seem to be the correct ring.
Done.
> 9. `_parse_recursion_`: `initial_values.update({polynomial_left: right_side})` I suggest to check whether an initial value is repeatedly given.
Done: If the values are different for same `n`, then an exception is raised.
> 10. `_parse_recursion_`: `if M != log(base_power_M, base=k):` I suggest to replace the right hand side by `M_new` which has just been defined one line before.
Done.
> 11. `_parse_recursion_`: `if r not in ZZ: raise ValueError("%s is not an integer." % (r,))`: I do not think that this can be reached: `r` is a coefficient of a polynomial over `ZZ` anyway. In particular, `Seq2._parse_recursions_([f(2*n+1/2) == f(n)], f, n)` leads to `ValueError: 2*n + 1/2 is not a polynomial in n.`
Fixed.
> 12. `_parse_recursion_`: `else: # check this again` I do not understand the comment.
Removed.
> 13. `_parse_recursion_._parse_multiplication_`: I think that `if op.operator() != mul_vararg or len(op.operands()) != 2: raise ValueError("")` is unreachable, so I suggest to replace this by `assert op.operator() == mul_vararg and len(op.operands()) == 2`.
Yes, I agree. Done.
> 14. `_parse_recursion_._parse_one_summand_`: `raise ValueError('%s does not have integer coefficients.' % (op.operands()[0],))`: The error message does not seem to fit all cases of failing conversion to an integer polynomial; e.g., `Seq2._parse_recursions_([f(2*n+1) == 2*f(1/n)], f, n)` yields `ValueError: 1/n does not have integer coefficients.
I have modified this.
> 15. `_parse_recursion_._parse_one_summand_`: It should be checked that `len(op.operands()) == 1`; currently, `Seq2._parse_recursions_([f(2*n+1) == 2*f(n+4, 5), f(2*n) == f(n)], f, n)` does not yield an error.
Exception added.
> 16. `_parse_recursion_`:  Branch `if not coeffs`: As far as I understand, this means that no general equations have been given, only initial values. I do not understand why we do not raise an error in this case.
No, this can also happen for the zero sequence, like `f(2*n) == 0, f(2*n + 1) == 0`.
After refactoring the parsing method, this case is handled in lines 835 and 933 now.
> 17. `__get_ind_`: I would replace the two consecutive `.update` calls to the same dictionary by one single call `.update({(j, d): pos, pos: (j, d)})` (twice)
Done.
> 18. `_parse_recursion_`: docstring: I think that even for a private method, the contents of the namedtuple should be explained. 
Done.
> 19. `_get_ind_` docstring: I think that even for a private method, the output should be explained. 
Done.
> 20. `_get_matrix_from_recursions_` docstring: inputs `var` and `function` are not explained. 
These inputs are not needed anymore.
> 21. `_get_matrix_from_recursions_` docstring: Please explain what the role of the parameter `correct_offset` is.
Done.
> 22. `_get_matrix_from_recursions_` example on the number of unbordered factors in the Thue–Morse sequence: please only put one recurrence equation per line in order to make the recurrences more readable.
Done.
> 22. `_get_matrix_from_recursions_` example on the number of unbordered factors in the Thue–Morse sequence: why are there so many initial values? If my calculations are correct, then the "largest" component of the linear representation corresponds to the sequence f(4n+9); for n=3, this is f(21). It might be that this large number of initial values is required in the current code, but I think that the original recurrences could and should be used to compute as many auxiliary values as required. This means that only initial values up to 15 should be required.
New method `_get_values_from_recurrence_` has been implemented now. Consequently, only values up to f(23) are needed.
> 23. `_get_matrix_from_recursions_`: the line `n1 = recursion_rules.n1` appears twice.
Removed.
> 24. `_get_matrix_from_recursions_`: I think that the lines which define `temp` twice in different ways are rather hard to read. If (as suggested in 22) the required auxiliary values are computed from the initial values in a separate method, then I imagine that these lines could be simply replaced by suitable list comprehensions. The symbolic vector `arguments` could be replaced by a function taking an argument and returning a vector, so no substitutions would be required. Then it might not be necessary to have `function` and `var` as parameters of this method.
New method `_v_eval_n_from_recurrence_` has been implemented now. Consequently, `_get_matrix_from_recursions_` is much simpler now.
> 25. `_get_matrix_from_recursions_`: the condition for construction the matrix `J` could be simplified: the conditions `i>= rem` and `i % k == rem` can be omitted, because they follow from `j*k == i-rem`. Additionally, it might be simpler to construct this matrix by the version of the matrix constructor which takes a function as an argument.
I removed the redundant conditions. I do not understand the suggestion in your last sentence.
> 26. `_get_right_from_recursions_`: The same comment about initial values as mentioned in 22 applies. If a separate method for computing the vector of the linear representation for given arguments is implemented as proposed in 24, then this method here could be shortened considerably. The parameter `function` might then be redundant.
Done.
> 27. `recursions`: example Stern--Brocot: The initial value `f(2)` should not be required.
Removed.
> 28. `recursions`: example Odd Entries in Pascal's Triangle: only `f(0)` and `f(1)` should be required as initial values.
Removed.
> 29. `recursions`: example Unbordered Factors: one equation per line (cf. 21)
Done.
> 30. `recursions`: example Unbordered Factors: initial values (cf. 22)
Done.
> 31. `recursions`: docstring: "in the a Generalized" remove "a"
Done.
> 32. `recursions`: "[TODO: reference]" please resolve TODO.
Done.
> 33. `recursions`: example Generalized Pascal's Triangle: only initial values `f(0)` and `f(1)` should be required.
Done.
> 34. `recursions`: `mu` could be constructed as a list comprehension instead of appending to a list.
Done.
> 35. This ticket adds quite a number of private methods to `kRegularSequenceSpace` which are only useful for the public method `recursions`. For clarity's sake, I propose to introduce a "see also" block in all auxiliary private methods which refers to `recursions`.
Done.
> 36. The method `_get_ind_` should be renamed such that it clearly relates to the main public method (this is now the case for all other private methods except this one).
Done.
> 37. I am not yet convinced that `kRegularSequenceSpace.recursions` is a good description of the method. Wouldn't one expect to _get_ recursions by such a method, instead of getting a k-regular sequence from a recursion? Perhaps `from_recursion` or possibly more precise `from_recurrence` would be a better name.
Changed to `from_recurrence`.
> 38. Please extend the docstring of `recursions` in such a way that a clearer link is provided to `[HKL2021]`. For instance, the docstring could state that such recurrence relations uniquely define a k regular sequence (provided that enough initial values are provided). 
Done.
> 39. Test raising "Initial value ... is missing".
This exception is removed now, because the method `_get_values_from_recurrence_` checks this.
> 40. Consider using `raise ValueError(...) from None` (once this code runs under python3) in order to supress printing of the detailed exceptions which are explained by the `ValueError` of this code here.
Done.


---

Comment by galipnik created at 2021-05-05 17:49:25

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2021-05-06 17:59:05

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2021-05-06 17:59:05

Thank you for your changes and comments.

One reply and a few more comments which came up while reading your changes.

>> 25. `_get_matrix_from_recursions_` [...] Additionally, it might be simpler to construct this matrix by the version of the matrix constructor which takes a function as an argument. 
> [...]. I do not understand the suggestion in your last sentence.

It meant rewriting it as follows:

```python
def entry(i, kk):
    j, d = ind [i]
    if j < M - 1:
        return int(kk == ind[(j + 1, k**j*rem + d)] - 1)
    else:
        rem_d = k**(M-1)*rem + (d%k**M)
        dd = d // k**M
        if rem_d < k**M:
            lambd = l - ind[(m, (k**m)*dd + l)]
            return _coeff_(rem_d, kk + lambd)
        else:
            lambd = l - ind[(m, k**m*dd + k**m + l)]
            return _coeff_(rem_d - k**M, kk + lambd)

mat = Matrix(base_ring, dim_without_corr, dim_without_corr, entry)
```



41. Naming of the variable in docstrings. In some docstrings, we have "a symbolic variable n" or similar formulations. I think that we should not make any assumptions about the name of the variable, it is simply a variable. There might be an exception in those docstrings where equations are parsed, there I would say "symbolic variable (`n` in the above description of `equations`).

42. Naming of the variable in exceptions: Some exceptions have a hard-coded `n`. I think that it would be more helpful to use the variable name provided by the user. It might also be good to have one test with different names for function and variable.

43. `_get_right_from_recurrence_`: Docstring: Please move the "see also" block before the "tests" block (I think that we should adhere to the order of the blocks as described in https://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content)

44. `from_recurrence`: Please document parameter `offset` explicitly (e.g. "an integer (default: `0`). See explanation in `equations` above")

45. `_get_values_from_recurrence_`: `if _coeff_(r, j) != 0` could be replaced by `if _coeff_(r, j)`

46. `_get_values_from_recurrence_`: the check `f_n not in base_ring` could come earlier (when checking the provided parameters, not (possibly repeatedly) on usage

47. `_parse_recurrence_`: docstring: replace "vector" by "tuple"

48. `_parse_recurrence_`: why is `remainders` a list instead of a set?

49. `_parse_recurrence_`:  `elif M and not m:` I think that this should be replaced by `elif M and m is None:`: Otherwise, I fear that legitimate situations such as `M=3`, `m=0` with a bunch of equations might be erroneously corrected to `M=3`, `m=2`.

50. `_get_parameters_from_recurrence_`: `offset = max(0, -l/k**m)`: possibly take ceiling of `-l/k**m` to have an integer offset?

51. In the old code, there were two tests

```
sage: Seq2._parse_recurrence_([f(2*n) == f(n)], f, n)
Traceback (most recent call last):
...
ValueError: Recurrence relations for [f(2*n + 1)] are missing.

sage: Seq2._parse_recurrence_([f(4*n) == f(n), f(4*n + 3) == 0], f, n)
Traceback (most recent call last):
...
ValueError: Recurrence relations for [f(4*n + 1), f(4*n + 2)] are missing.
```

    which seem not to have survived the refactoring. If I am not mistaken, the corresponding checks are no longer there.

52. I suggest to always call `_get_values_from_recurrence_` with named parameters (there is now quite a number of parameters and we might want to avoid future mistakes). If rewriting the tests is not too costly, we might even enforce that with a `*` (PEP 3102).

53. `_v_eval_n_from_recurrence`: would it be possible to simplify that method by using `_get_ind_from_recurrence_`, also guaranteeing consistency between the two methods?

54. A number of docstring has a description like "A namedtuple generated by `_parse_recurrence_()`". However, this nametuple is no longer generated by `_parse_recurrence_`, but by `_get_parameters_from_recurrence_`.

55. `_get_right_from_recurrence_`: It seems that the last line `return vector(right)` could be replaced by `return right` because all code paths seem to guarantee that `right` is already a vector.

56. `_get_ind_from_recurrence_`: The description of the input parameters does not match the signature of the method.

57. `_get_matrix_from_recurrence_`: input parameters `function`, `var` are explained, but not part of the signature.

58. `_get_parameters_from_recurrence_`: description of namedtuple misses `offset`.

59. `_v_eval_n_from_recurrence_`: missing output section in docstring.

60. `from_recurrence`: `minimize`: The same argument which led to the removal of `transpose=True` in #21295 (Review item 6) is also applicable here.

61. There is a number of ReSt-issues because constructions like ```n``th` and ``i`th` are not translated correctly and lead to "WARNING: Inline interpreted text or phrase reference start-string without end-string.". I suggest to insert hyphens in these situations.

62. In lines 486 and 493, `....:` should be replaced by `...`


---

Comment by git created at 2021-05-07 00:54:33

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-05-07 01:33:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-05-07 01:35:46

Replying to [comment:44 cheuberg]:

Again thank you very much for your review!

Here are my answers and some comments:

> >> 25. [...]
> It meant rewriting it as follows: [...]
Done (and fixed the some indices in your suggestion because `ind` is 1-based), thank you.

> 41. Naming of the variable in docstrings. In some docstrings, we have "a symbolic variable n" or similar formulations. I think that we should not make any assumptions about the name of the variable, it is simply a variable. There might be an exception in those docstrings where equations are parsed, there I would say "symbolic variable (`n` in the above description of `equations`).
Done.

> 42. Naming of the variable in exceptions: Some exceptions have a hard-coded `n`. I think that it would be more helpful to use the variable name provided by the user. It might also be good to have one test with different names for function and variable.
I'm not sure whether this is a good idea with respect to #31787: If alternative input parameters will be implemented in the future, the user might not provide a variable name. Therefore, I've rephrased the exception messages without using any variable name. 

> 43. `_get_right_from_recurrence_`: Docstring: Please move the "see also" block before the "tests" block (I think that we should adhere to the order of the blocks as described in https://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content)
Done.

> 44. `from_recurrence`: Please document parameter `offset` explicitly (e.g. "an integer (default: `0`). See explanation in `equations` above")
Done.

> 45. `_get_values_from_recurrence_`: `if _coeff_(r, j) != 0` could be replaced by `if _coeff_(r, j)`
Done.

> 46. `_get_values_from_recurrence_`: the check `f_n not in base_ring` could come earlier (when checking the provided parameters, not (possibly repeatedly) on usage
Done.

> 47. `_parse_recurrence_`: docstring: replace "vector" by "tuple"
Done.

> 48. `_parse_recurrence_`: why is `remainders` a list instead of a set?
What would be the advantage of a set here?

> 49. `_parse_recurrence_`:  `elif M and not m:` I think that this should be replaced by `elif M and m is None:`: Otherwise, I fear that legitimate situations such as `M=3`, `m=0` with a bunch of equations might be erroneously corrected to `M=3`, `m=2`.
Fixed. The same issue also occured for `m` (lines 848 and 851), also this should be fixed now. Two additional tests added.

> 50. `_get_parameters_from_recurrence_`: `offset = max(0, -l/k**m)`: possibly take ceiling of `-l/k**m` to have an integer offset?
Done.

> 51. In the old code, there were two tests
> {{{
> sage: Seq2._parse_recurrence_([f(2*n) == f(n)], f, n)
> Traceback (most recent call last):
> ...
> ValueError: Recurrence relations for [f(2*n + 1)] are missing.
> 
> sage: Seq2._parse_recurrence_([f(4*n) == f(n), f(4*n + 3) == 0], f, n)
> Traceback (most recent call last):
> ...
> ValueError: Recurrence relations for [f(4*n + 1), f(4*n + 2)] are missing.
> }}}
>     which seem not to have survived the refactoring. If I am not mistaken, the corresponding checks are no longer there.
Fixed again.

> 52. I suggest to always call `_get_values_from_recurrence_` with named parameters (there is now quite a number of parameters and we might want to avoid future mistakes). If rewriting the tests is not too costly, we might even enforce that with a `*` (PEP 3102).
Done.

> 53. `_v_eval_n_from_recurrence`: would it be possible to simplify that method by using `_get_ind_from_recurrence_`, also guaranteeing consistency between the two methods?
Done.

> 54. A number of docstring has a description like "A namedtuple generated by `_parse_recurrence_()`". However, this nametuple is no longer generated by `_parse_recurrence_`, but by `_get_parameters_from_recurrence_`.
Fixed.

> 55. `_get_right_from_recurrence_`: It seems that the last line `return vector(right)` could be replaced by `return right` because all code paths seem to guarantee that `right` is already a vector.
Done.

> 56. `_get_ind_from_recurrence_`: The description of the input parameters does not match the signature of the method.
Fixed.

> 57. `_get_matrix_from_recurrence_`: input parameters `function`, `var` are explained, but not part of the signature.
Removed.

> 58. `_get_parameters_from_recurrence_`: description of namedtuple misses `offset`.
Added.

> 59. `_v_eval_n_from_recurrence_`: missing output section in docstring.
Added.

> 60. `from_recurrence`: `minimize`: The same argument which led to the removal of `transpose=True` in #21295 (Review item 6) is also applicable here.
Ok, `minimize`-option removed.

> 61. There is a number of ReSt-issues because constructions like ```n``th` and ``i`th` are not translated correctly and lead to "WARNING: Inline interpreted text or phrase reference start-string without end-string.". I suggest to insert hyphens in these situations.
Resolved.

> 62. In lines 486 and 493, `....:` should be replaced by `...`
Done.


---

Comment by galipnik created at 2021-05-07 01:36:15

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2021-05-07 06:39:08

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2021-05-07 06:39:08

Thank you for your changes and your comments. 

I have a few comments on the previous items and list a few new items (which are only relevant now that we seem to converge soon).

>>>> 25.
>> I meant rewriting it as follows: [...]
> Done (and fixed the some indices in your suggestion because ind is 1-based), thank you. 

When writing done my suggestion yesterday, I was exactly afraid of making such off-by-one-errors.
When I first reviewed the ticket, it was not clear to me whether having a 1-based `ind` has any
advantages over having it 0-based. It seems to me that in this usage here, we //always// use `ind[j, k] - 1`
when using the map in one direction and //always// use `ind[i+1]` in the other direction. So: sorry for the late stage question, but would it not make life simpler to have `ind` 0-based (because this [SageMath](SageMath) code lives in a 0-based world?)

>> 42. Naming of the variable in exceptions: Some exceptions have a hard-coded n. I think that it would be more helpful to use the variable name provided by the user. It might also be good to have one test with different names for function and variable. 
> I'm not sure whether this is a good idea with respect to #31787: If alternative input parameters will be implemented in the future, the user might not provide a variable name. Therefore, I've rephrased the exception messages without using any variable name. 

This is better, thank you.

>> 48. `_parse_recurrence_`: why is remainders a list instead of a set? 
> What would be the advantage of a set here? 

Semantically, a python set seems to be a better fit to what is done here (check whether certain elements are present).
Performance is probably not an issue here.

> 49. Fixed. The same issue also occured for m (lines 848 and 851), also this should be fixed now. Two additional tests added.

Thank you. One remark, though, when reading the new tests: I think that the casual user might not be very happy with an error message "2 does not equal 1" because it might be difficult to see where the problem comes from. It might help to print the offending equation and the offending term: "Term 'f(2*n)' in the equation 'f(8*n + 1) == f(2*n)': 2 does not equal 1." Sorry for not thinking about this earlier. 

>> 51. In the old code, there were two tests [...] which seem not to have survived the refactoring. If I am not mistaken, the corresponding checks are no longer there.
> Fixed again. 

I think that `raise ValueError(...) from None` should be `raise ValueError(...)` in these checks because we are not handling another exception here.

>> 56 `_get_ind_from_recurrence_`: The description of the input parameters does not match the signature of the method. 
> Fixed. 

Please replace `u` by `uu` in the description of the input parameters.

>> 62. In lines 486 and 493, `....:` should be replaced by `...`
> Done. 62
There are still 4 instead of 3 dots.

63. Please merge the dependency #21203 once more (there seems to be a merge conflict).

64. Please move references to `src/doc/en/reference/references/index.rst` as per the developer's guide ​https://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content

65. Please add an arXiv identifier to reference HKL2021 once it is available.


---

Comment by galipnik created at 2021-05-07 11:59:11

Replying to [comment:49 cheuberg]:

> [...] So: sorry for the late stage question, but would it not make life simpler to have `ind` 0-based (because this [SageMath](SageMath) code lives in a 0-based world?)
Changed now. (The initial motivation for implementing it 1-based was consistency with the corresponding paper, but this is better now.)

> >> 48. `_parse_recurrence_`: why is remainders a list instead of a set? 
> > What would be the advantage of a set here? 
> 
> Semantically, a python set seems to be a better fit to what is done here (check whether certain elements are present).
> Performance is probably not an issue here.
Ok, changed.

> Thank you. One remark, though, when reading the new tests: I think that the casual user might not be very happy with an error message "2 does not equal 1" because it might be difficult to see where the problem comes from. It might help to print the offending equation and the offending term: "Term 'f(2*n)' in the equation 'f(8*n + 1) == f(2*n)': 2 does not equal 1." Sorry for not thinking about this earlier. 
Hm, good point. Changed a lot in the error messages now to make the errors clearer.

> >> 51. In the old code, there were two tests [...] which seem not to have survived the refactoring. If I am not mistaken, the corresponding checks are no longer there.
> > Fixed again. 
> 
> I think that `raise ValueError(...) from None` should be `raise ValueError(...)` in these checks because we are not handling another exception here.
Changed.

> >> 56 [...]
> Please replace `u` by `uu` in the description of the input parameters.
Done.

> >> 62. In lines 486 and 493, [...]
> There are still 4 instead of 3 dots.
Sorry, fixed now.

> 63. Please merge the dependency #21203 once more (there seems to be a merge conflict).
Done and conflict resolved.

> 64. Please move references to `src/doc/en/reference/references/index.rst` as per the developer's guide ​https://doc.sagemath.org/html/en/developer/coding_basics.html#the-docstring-of-a-function-content
Done.

> 65. Please add an arXiv identifier to reference HKL2021 once it is available.
Will be done as soon as the paper is on arXiv.


---

Comment by git created at 2021-05-07 11:59:17

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by galipnik created at 2021-05-07 12:00:20

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-07 12:11:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2021-05-07 16:13:09

Thank you for your changes.

I have no further comments, so the only open issues are 

65. arXiv identifier once available
66. wait for dependency #21203


---

Comment by git created at 2021-05-11 10:55:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by galipnik created at 2021-05-11 10:58:32

Three new commits pushed.

> 42. [...] It might also be good to have one test with different names for function and variable.
Done. (Note that the comparison for `kRegularSequence` is implemented in #21319, which is no dependency of this ticket.)

> 65. arXiv identifier once available
Done.


---

Comment by git created at 2021-06-23 15:39:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-06-23 15:48:01

As discussed, I've slightly refactored the code to have the parser and all helper methods in a separate class. I suggest to review the changes above commit-wise.


---

Comment by cheuberg created at 2021-06-26 08:23:22

Changing status from needs_review to needs_info.


---

Comment by cheuberg created at 2021-06-26 08:23:22

I reviewed the refactored code, fine for me except for one suggestion:

67. `RecurrenceParser.__call__`: I suggest to keep the signature of the output consistent with the signature of the input of  k-regular sequences, i.e., `(mu, left, right)`. Otherwise, I think that the lines
    {{{
    #!python
    left, mu, right = RP(*args, **kwds)
    return self(mu, left, right)
    }}}
    in `kRegularSequenceSpace.from_recurrence` are surprising.


---

Comment by git created at 2021-06-27 09:59:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-06-27 10:03:22

Replying to [comment:60 cheuberg]:
> I reviewed the refactored code, fine for me except for one suggestion:
> 
> 67. `RecurrenceParser.__call__`: I suggest to keep the signature of the output consistent with the signature of the input of  k-regular sequences, i.e., `(mu, left, right)`. Otherwise, I think that the lines
>     {{{
>     #!python
>     left, mu, right = RP(*args, **kwds)
>     return self(mu, left, right)
>     }}}
>     in `kRegularSequenceSpace.from_recurrence` are surprising.

Changed. (Note that `RecognizableSeries.linear_representation` uses `left, mu, right`; if this should be changed as well (on a follow-up ticket to the whole k-regular stuff #21202), then now would be a good time as it is not yet merged in a stable release, only in a beta. Any thoughts?)


---

Comment by cheuberg created at 2021-06-27 13:45:44

Yes, in the last iteration of the other ticket (#21238), I was also thinking about the inconsistency between the input of k-regular sequences and the output of `linear_representation`.

It seems that the order `left, mu, right` for `linear_representation` has not been invented within this series of tickets, but is defined in that way at least somewhere in the literature (e.g. Berstel and Reutenauer p. 10). So in my opinion if we aim for consistency, then the signature of element creation in regular sequences should be changed. And, as you say, if it is done, then it should be done very soon.


---

Comment by cheuberg created at 2021-06-29 11:46:55

Changing status from needs_info to needs_review.


---

Comment by cheuberg created at 2021-06-29 11:46:55

As discussed earlier off-site: `linear_representation` should stick to the ordering in the literature (left, matrices, right); construction of recognizable series should stick to the current implementatoin (matrices, left, right): if we ever decide to make `left` and `right` optional, this ordering is required.

This means that we do not change anything here; we just wait for the patchbot.


---

Comment by cheuberg created at 2021-06-29 11:47:59

`@`galipnik: could you please also have a look on dkrenn's changes?


---

Comment by galipnik created at 2021-06-29 12:38:23

Replying to [comment:65 cheuberg]:
> `@`galipnik: could you please also have a look on dkrenn's changes?

Done, the changes are fine for me. Thank you!


---

Comment by git created at 2021-07-02 12:37:20

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by galipnik created at 2021-07-02 12:41:08

Sorry for the late change, but I incidentally found a redundant line of code and removed it in the last commit 488123c. I've restarted the patchbot.


---

Comment by cheuberg created at 2021-07-04 05:28:30

488123c is fine. Patchbot is happy. Time to set it to positive.


---

Comment by cheuberg created at 2021-07-04 05:28:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-09 20:23:58

Resolution: fixed
