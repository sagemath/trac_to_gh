# Issue 27425: Upgrade to primecount 4.6

Issue created by migration from https://trac.sagemath.org/ticket/27662

Original creator: slelievre

Original creation time: 2019-04-14 18:02:11

CC:  slelievre vklein vdelecroix embray

Keywords: upgrade, primecount

The latest release, primecount 4.6, released 2019-04-13, has a
relaxed "cmake ≥ 3.4" dependency (instead of "cmake ≥ 3.9").

- [primecount releases](https://github.com/kimwalisch/primecount/releases)
- [primecount changelog](https://github.com/kimwalisch/primecount/blob/master/ChangeLog)

*Tarball* (to be renamed `primecount-4.6.tar.gz`):

- https://github.com/kimwalisch/primecount/archive/v4.6.tar.gz


---

Comment by slelievre created at 2019-04-14 18:04:43

After applying the changes in this ticket, downloading the tarball, and running

```
$ sage -i primecount
$ make
```

testing on python3 gives:

```
$ ./sage -t --long --optional=sage,primecount src/sage/interfaces/primecount.pyx
Running doctests with ID 2019-04-14-19-52-42-57423cc3.
Git branch: primecount-4.6
Using --optional=primecount,sage
Doctesting 1 file.
sage -t --long --warn-long 81.8 src/sage/interfaces/primecount.pyx
**********************************************************************
File "src/sage/interfaces/primecount.pyx", line 108, in sage.interfaces.primecount.prime_pi_128
Failed example:
    prime_pi_128(1000)     # optional - primecount
Exception raised:
    Traceback (most recent call last):
      File "/opt/s/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/s/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.primecount.prime_pi_128[1]>", line 1, in <module>
        prime_pi_128(Integer(1000))     # optional - primecount
      File "sage/interfaces/primecount.pyx", line 100, in sage.interfaces.primecount.prime_pi_128 (build/cythonized/sage/interfaces/primecount.cpp:1981)
        cpdef prime_pi_128(n):
      File "sage/interfaces/primecount.pyx", line 113, in sage.interfaces.primecount.prime_pi_128 (build/cythonized/sage/interfaces/primecount.cpp:1892)
        cdef cppstring s = str(n)
      File "stringsource", line 15, in string.from_py.__pyx_convert_string_from_py_std__in_string (build/cythonized/sage/interfaces/primecount.cpp:2448)
    TypeError: expected bytes, str found
**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.primecount.prime_pi_128
    [16 tests, 1 failure, 0.05 s]
----------------------------------------------------------------------
sage -t --long --warn-long 81.8 src/sage/interfaces/primecount.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.1 seconds
```

----
New commits:


---

Comment by vdelecroix created at 2019-04-15 06:18:32

Indeed, this is invalid Python 3 in Cython `cdef cppstring s = str(n)`. Replacing `str` -> `bytes` is probably sufficient.


---

Comment by slelievre created at 2019-04-17 08:40:40

Thanks for the analysis. I'll make that change in `src/sage/interfaces/primecount.pyx` and push a branch.


---

Comment by slelievre created at 2019-04-17 09:12:26

Did you mean this?

```diff
diff --git a/src/sage/interfaces/primecount.pyx b/src/sage/interfaces/primecount.pyx
index e1ef2b6da1..f9f4f85c15 100644
--- a/src/sage/interfaces/primecount.pyx
+++ b/src/sage/interfaces/primecount.pyx
@@ -110,7 +110,7 @@ cpdef prime_pi_128(n):
         sage: nth_prime_128(2**65)   # not tested
         ?
     """
-    cdef cppstring s = str(n)
+    cdef cppstring s = bytes(n)
     cdef bytes ans
     sig_on()
     ans = primecount.pi(s)
```


This gives me the following doctest failure (with primecount 4.7):

```
$ ./sage -t --long --optional=sage,primecount src/sage/interfaces/primecount.pyx
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Running doctests with ID 2019-04-17-11-08-04-ac57896a.
Git branch: primecount-4.7
Using --optional=primecount,sage
Doctesting 1 file.
sage -t --long --warn-long 81.8 src/sage/interfaces/primecount.pyx
**********************************************************************
File "src/sage/interfaces/primecount.pyx", line 108, in sage.interfaces.primecount.prime_pi_128
Failed example:
    prime_pi_128(1000)     # optional - primecount
Exception raised:
    Traceback (most recent call last):
      File "/opt/s/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/s/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.primecount.prime_pi_128[1]>", line 1, in <module>
        prime_pi_128(Integer(1000))     # optional - primecount
      File "sage/interfaces/primecount.pyx", line 100, in sage.interfaces.primecount.prime_pi_128 (build/cythonized/sage/interfaces/primecount.cpp:1981)
        cpdef prime_pi_128(n):
      File "sage/interfaces/primecount.pyx", line 115, in sage.interfaces.primecount.prime_pi_128 (build/cythonized/sage/interfaces/primecount.cpp:1903)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
1 item had failures:
   1 of   3 in sage.interfaces.primecount.prime_pi_128
    [16 tests, 1 failure, 0.05 s]
----------------------------------------------------------------------
sage -t --long --warn-long 81.8 src/sage/interfaces/primecount.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.1 seconds
```



---

Comment by vdelecroix created at 2019-04-18 22:31:12

At least the error changed. It now looks weird and the traceback does not give a clue of what went wrong.


---

Comment by slelievre created at 2019-04-24 20:46:49

Here is the branch if anyone can look into it.
----
New commits:


---

Comment by vdelecroix created at 2019-04-25 05:45:07

New commits:


---

Comment by vdelecroix created at 2019-04-25 05:45:07

Changing status from new to needs_review.


---

Comment by git created at 2019-04-25 05:46:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-04-25 09:05:34

LGTM


---

Comment by dimpase created at 2019-04-25 09:05:34

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-04-25 10:19:19

Could someone please review #27487 ? This is very easy, if you have autotools installed.


---

Comment by vbraun created at 2019-04-29 12:36:02

Resolution: fixed
