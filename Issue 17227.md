# Issue 17227: Computing the automorphism group of a graph

Issue created by migration from Trac.

Original creator: azi

Original creation time: 2014-12-08 08:34:05

CC:  ncohen

Hello!

I have a suggestion for a big improvement for the Graph Theoretical module of Sage. Right now I am a not in the proper mood to do it myself so I am leaving this here in case anyone is willing to do it or as a TODO note for a later time.

Consider the graph on ~10k vertices located in the file https://www.dropbox.com/s/pbtk2965ti71u9n/graph.txt.gz?dl=0 where each line contains an edge pair.

Using the standard way in Sage (read graph call automorphism_group() ) takes a few * hours*  (I'll tell the exact time when it actually finishes) to compute and makes a * 30GB* memory footprint.

The same thing can be done using bliss http://www.tcs.tkk.fi/Software/bliss/index.html with no actual memory footprint in *20 seconds.*

So right now its much cheaper for me to just write the graph into DIMACS format call bliss and parse its output. 

I guess the same kind of performance can be obtained using nauty so I suppose there is something OFF with the current implementation of the automorphism group method. IIRC it is written in Python?

Hopefully we can make this into a productive patch.





---

Comment by azi created at 2014-12-26 14:17:09

Changing status from new to needs_info.


---

Comment by azi created at 2014-12-26 14:17:09

New commits:


---

Comment by azi created at 2014-12-26 14:20:23

I'd be glad if someone could take a look at this branch. It is far from being "production ready" and I mainly posting it here because

1. I want any comments and suggestions if its going in the right direction(to avoid later rewrites :D)
2. I need someone to explain how to make a spkg so that I can properly include bliss headers and be able to link against bliss.
3. Discuss what to do with the add_gen function that converts a permutation to cycle notation. Do you agree that I leave it there and avoid using Permutation.to_cycle()?
4. How to handle digraphs elegantly?

As is for now, the code correctly compute the aut of a graph/digraph provided that libbliss.a is in the sage lib folder and the location of the bliss header is correctly set in bliss.pyx.


I wrote that above question for the general audience but honestly,.. Nathann what do you think??


---

Comment by git created at 2014-12-26 14:23:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-12-26 15:22:19

Yoooooooooooo !

Well, so far your branch does not look "that bad". The only weird thing is that I do not get why this bliss branch should do that modifications `:-P`

```diff
+    :meth:`~GenericGraph.geodetic_number` | Returns the geodetic number of the given graph.
```


The right way to write this code, however, begins as you say by writing the spkg, as nobody can test it without it. And the right way to do that, as usual is copy and paste.

1) There is a developer's manual that I am trying to improve these days. There is a section I never read about exactly that: http://www.sagemath.org/doc/developer/packaging.html. If you find anything wrong/unclear in there, please fix it if you can. We must make this clear to everybody. If you do not understand, tell me where it is and I will try to fix it.

2) spkgs are rather simple nowadays. The code that **installs** the program is a Sage code, like any other. You will find it in SAGE_ROOT/build/. Take a look at the structure of `buckygen`, for instance: it is an optional graph package, just like bliss will be.

3) That was for the Sage code, but the non-sage code (i.e. the source code of bliss) must be stored in the SAGE_ROOT/upstream folder. You will figure out that the code in build/ is actually instruction about what to do with the bliss-version.tar.bz2 that must be there, and which is only the official bliss release.

4) Then there are he "checksums": http://www.sagemath.org/doc/developer/packaging.html#checksums

So before continuing with this you should create a ticket to add bliss as a spkg. It could be quick, and if you have time right now we can settle it fast, I won't get to bed before one hour at least, I can review it before.

A ticket that adds a new package should contain:

1) A branch that adds the required files in the build/ folder

2) A .tar.bz2 file (hosted wherever you like) that I should download in the upstream/ folder before typing "sage -i bliss".

I am a bit offline this evening because I have a very short ethernet cable next to an uncomfortable chair. I come back from time to time to check my emails `:-P`

Good luck !

Nathann


---

Comment by azi created at 2014-12-27 11:37:24

Thanks for the input!! 

Continuing our talk here I have a short question. The class definitions of a Graph and Digraph in bliss both contain the same functions add_edge(int i, int j) and change_color(int x, int c).

Now as far as I see *if* we patch bliss to make these two functions a (virtual) part of the abstract graph class then we could do something like


```
AbstractGraph *g;
g = either Graph or Digraph
g.add_edge(i,j)
g.change_color(i,c)
g.find_automorphisms()
```


I think this would be the most efficient way to handle digraphs/graphs. 

Do you think this will work out or do you see any other way to handle these two types?


---

Comment by ncohen created at 2014-12-27 11:44:49

Yo !

> Continuing our talk here I have a short question. The class definitions of a Graph and Digraph in bliss both contain the same functions add_edge(int i, int j) and change_color(int x, int c).
> 
> Now as far as I see *if* we patch bliss to make these two functions a (virtual) part of the abstract graph class then we could do something like

Oh. Well... It would be best to not patch anything in bliss, just in case they release a new version... You can add whatever code you need in the Sage code though.

But really if it is just to avoid some "if", perhaps that's going a bit far `O_o`

Nathann


---

Comment by ncohen created at 2014-12-27 11:57:47

Note: it would be cool to make bliss the default algorithm for the computation of automorphism group <when it is available>. Some other code call this graph automorphism code: we should of course add an optional flag there to ask those function to use bliss, but it could also help if it was used by default when available.

Just in case we forget it, from time to time. 'Cause I think that this code is really called from many obscure places in Sage.

Nathann


---

Comment by azi created at 2014-12-27 19:47:46

Replying to [comment:6 ncohen]:
> Yo !
> 
> > Continuing our talk here I have a short question. The class definitions of a Graph and Digraph in bliss both contain the same functions add_edge(int i, int j) and change_color(int x, int c).
> > 
> > Now as far as I see *if* we patch bliss to make these two functions a (virtual) part of the abstract graph class then we could do something like
> 
> Oh. Well... It would be best to not patch anything in bliss, just in case they release a new version... You can add whatever code you need in the Sage code though.
> 
> But really if it is just to avoid some "if", perhaps that's going a bit far `O_o`
Yes I am most likely over-thinking it. Though with the if part we get an awful lot of duplicated (ugly). I guess there is some other way to make it nice while still being efficient - more to this when the actual branch is ready for review.

Best,

Jernej

> 
> Nathann


---

Comment by azi created at 2014-12-27 19:48:32

Replying to [comment:7 ncohen]:
> Note: it would be cool to make bliss the default algorithm for the computation of automorphism group <when it is available>. Some other code call this graph automorphism code: we should of course add an optional flag there to ask those function to use bliss, but it could also help if it was used by default when available.
I agree ! Let me first check how this performance thing works out for general graphs.

> 
> Just in case we forget it, from time to time. 'Cause I think that this code is really called from many obscure places in Sage.
Which code, the automorphism thing?
> 
> Nathann


---

Comment by ncohen created at 2014-12-28 03:53:34

> > Just in case we forget it, from time to time. 'Cause I think that this code is really called from many obscure places in Sage.
> Which code, the automorphism thing?

Yep. I'd be surprised if all functions named "automorphism_group" in Sage don't redirect to that in the end.

Nathann


---

Comment by git created at 2014-12-28 11:03:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2014-12-28 12:57:51

The speedup looks promising. Just a quick preview :


```
sage: G = graphs.CubeGraph(4)
sage: %timeit automorphism_group_bliss(G)
1000 loops, best of 3: 885 µs per loop
sage: %timeit G.automorphism_group()
1000 loops, best of 3: 1.31 ms per loop
```



```
sage: G = graphs.GeneralizedPetersenGraph(250,2)
sage: %timeit automorphism_group_bliss(G)
100 loops, best of 3: 7.21 ms per loop
sage: %timeit G.automorphism_group()
10 loops, best of 3: 45.8 ms per loop
```



```
sage: G.order()
sage: 9369
sage: t1 = time() ; A = automorphism_group_bliss(G); t2 = time()
sage: t2-t1
37.43013310432434
sage: t1 = time() ; A = G.automorphism_group(); t2 = time() # uses 50% of RAM
sage: t2-t1
624.5415680408478
```


Asymmetric graphs:


```
sage: G = graphs.RandomGNP(500,0.8)
sage: %timeit G.automorphism_group()
1 loops, best of 3: 499 ms per loop
sage: %timeit automorphism_group_bliss(G)
10 loops, best of 3: 163 ms per loop

sage: G = graphs.RandomGNP(3300, 0.1)
sage: %timeit automorphism_group_bliss(G)
1 loops, best of 3: 923 ms per loop
sage: %timeit G.automorphism_group()
1 loops, best of 3: 6.49 s per loop

```



---

Comment by ncohen created at 2014-12-29 04:42:37

Looks good ! I'm eager to use this in my hypergraph computations `:-PPPP`

Nathann


---

Comment by ncohen created at 2014-12-29 05:01:52

For the modules_list.py file: look in the same file for occurrences of "CPLEX" or "gurobi". They are also optional packages, and for optional packages you should first make sure that they are installed before asking Sage to compile the .pyx.

Nathann


---

Comment by azi created at 2014-12-29 11:11:06

Did this! Also tested your example from the other day.

A workable branch is now available at public/bliss2. I am having a mismatch trying to push it to public/bliss.

Before we change Graph.canonical_form,is_isomorphic,automorphism_group I suggest that we address the FIXME stuff in the bliss.pyx code.

Another "issue" that is not in the code is what are we to do with the heuristics. There are a few heuristics for bliss and we can make them as an available choice for Sage or just go ahead with the default one.

Let me know what you think,

Jernej

Ohh, and here is your bipartite graph example:


```
sage: t1 = time() ; A = automorphism_group_bliss(G); t2 = time()
sage: t2-t1
0.15731596946716309
sage: t1 = time() ; A = G.automorphism_group(); t2 = time()
....... indefinitely..............
```



---

Comment by azi created at 2014-12-29 11:11:21

New commits:


---

Comment by azi created at 2014-12-29 11:11:21

Changing status from needs_info to needs_work.


---

Comment by azi created at 2014-12-29 11:11:49

Oh wow what a mess again...


---

Comment by azi created at 2014-12-29 11:12:31

New commits:


---

Comment by azi created at 2014-12-29 11:12:57

Reverted back to the public/bliss branch, apparently I've pushed some old unrelated nonsesne...


---

Comment by git created at 2014-12-29 11:19:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2014-12-29 11:20:20

I think this last pushed branch should be good.


---

Comment by ncohen created at 2014-12-29 12:33:24

Yo !

> Before we change Graph.canonical_form,is_isomorphic,automorphism_group I suggest that we address the FIXME stuff in the bliss.pyx code.

I am already writing some code at the moment and when I will be done I must go back to my blackboard. Is there is some specific question that you have for this patch please ask it, but if I begin to look at bliss' API, understand your code and answer the questions that you wrote inside it will probably take me as much time as writing the interface from scratch `:-P`

> Another "issue" that is not in the code is what are we to do with the heuristics. There are a few heuristics for bliss and we can make them as an available choice for Sage or just go ahead with the default one.

The current branch contains already many commits, and there are many things to pay attention to (we really don't want this code to return wrong results because of a typo) so it will probably be best to keep this branch to a minimum.

That does not mean that anything will have to be delayed: this branch will be sooner in `positive_review`, and then you can expose those features in another ticket.

Good luck ! `:-P`

Nathann


---

Comment by azi created at 2014-12-29 12:47:09

Replying to [comment:24 ncohen]:
> Yo !
> 
> > Before we change Graph.canonical_form,is_isomorphic,automorphism_group I suggest that we address >the FIXME stuff in the bliss.pyx code.
> 
> I am already writing some code at the moment and when I will be done I must go back to my blackboard. Is there is some specific question that you have for this patch please ask it, but if I begin to look at bliss' API, understand your code and answer the questions that you wrote inside it will probably take me as much time as writing the interface from scratch `:-P`
Okay.

Sooo

1. Bliss returns a list of automorphisms as bijections. There is a function inside the code that then in one pass creates the respective cycle notation for the permutation while also applying the labelling of the graph. We have Permutation.to_cycle() that does the job but only on integer valued bijections. As is I'd like to leave this function in bliss.pyx and then perhaps once labelled permutations are supported by to_cycle(), revert to that. The main reason being that I am using Sage on graphs with 700k vertices and its a pain to have to iterate over and over for the sake of labels.

2. There is a very erratic bug  using bliss on digraphs.


```
    sage: D = digraphs.Kautz(10,2,1)
    sage: from sage.graphs.bliss import *
    sage: D.automorphism_group().is_isomorphic(automorphism_group(D))
    True
    sage: D.automorphism_group().is_isomorphic(automorphism_group(D))
    Bliss fatal error: Internal error - unknown splitting heuristics
    Aborting!
```


I have no clue why this is happening. Do you have any intuition as to where to look for the issue? The code for Graph/Digraph that raises this exception is identical yet this only happens sporadically with digraphs.

As far as technical questions go, this are the main things I need some input about.

Best,

Jernej

> > Another "issue" that is not in the code is what are we to do with the heuristics. There are a few heuristics for bliss and we can make them as an available choice for Sage or just go ahead with the default one.
> 
> The current branch contains already many commits, and there are many things to pay attention to (we really don't want this code to return wrong results because of a typo) so it will probably be best to keep this branch to a minimum.
> 
> That does not mean that anything will have to be delayed: this branch will be sooner in `positive_review`, and then you can expose those features in another ticket.
> 
> Good luck ! `:-P`
> 
> Nathann


---

Comment by ncohen created at 2014-12-29 13:00:30

Yoooooo !

> 1. Bliss returns a list of automorphisms as bijections.

Which are the automorphisms which generate the full automorphism group of the graph ?

> There is a function inside the code that then in one pass creates the respective cycle notation for the permutation while also applying the labelling of the graph. We have Permutation.to_cycle() that does the job but only on integer valued bijections. As is I'd like to leave this function in bliss.pyx and then perhaps once labelled permutations are supported by to_cycle(), revert to that. The main reason being that I am using Sage on graphs with 700k vertices and its a pain to have to iterate over and over for the sake of labels.

+1 to that. It is not a very big amount of code, and one can never tell the amount of useless computations done by the `Permutation` code anyway `:-P`

> 2. There is a very erratic bug  using bliss on digraphs.
>
> I have no clue why this is happening. Do you have any intuition as to where to look for the issue? The code for Graph/Digraph that raises this exception is identical yet this only happens sporadically with digraphs.

But can it happen the first time you call the code, or only after several attempts ? This looks like a memory leak problem... Unless it is a bug in bliss `O_o`

Actually, reading the code a bit, I am totally scared by how you cast Python objects like the two dictionaries to a bliss function. It expects C arrays, and you give it a pointer to a Python dictionary ? `O_o;;;;`

Nathann


---

Comment by azi created at 2014-12-29 13:06:30

Replying to [comment:26 ncohen]:
> Yoooooo !
> 
> > 1. Bliss returns a list of automorphisms as bijections.
> 
> Which are the automorphisms which generate the full automorphism group of the graph ?
Yes, each time bliss discovers an automorphism it calls this function to handle it.
> 
> > There is a function inside the code that then in one pass creates the respective cycle notation for the permutation while also applying the labelling of the graph. We have Permutation.to_cycle() that does the job but only on integer valued bijections. As is I'd like to leave this function in bliss.pyx and then perhaps once labelled permutations are supported by to_cycle(), revert to that. The main reason being that I am using Sage on graphs with 700k vertices and its a pain to have to iterate over and over for the sake of labels.
> 
> +1 to that. It is not a very big amount of code, and one can never tell the amount of useless computations done by the `Permutation` code anyway `:-P`
Exactly:D


> 
> > 2. There is a very erratic bug  using bliss on digraphs.
> >
> > I have no clue why this is happening. Do you have any intuition as to where to look for the issue? The code for Graph/Digraph that raises this exception is identical yet this only happens sporadically with digraphs.
> 
> But can it happen the first time you call the code, or only after several attempts ? This looks like a memory leak problem... Unless it is a bug in bliss `O_o`
Yes it can happen on first try as well!!
> 
> Actually, reading the code a bit, I am totally scared by how you cast Python objects like the two dictionaries to a bliss function. It expects C arrays, and you give it a pointer to a Python dictionary ? `O_o;;;;`
No I am sure I am not doing this. The argument there is a just a void pointer that bliss then passes on to your function. 

Soo bliss takes a function pointer to YOUR function and a pointer to YOUR data. And then it calls YOUR function passing it YOUR void pointer.

So that should be fine I suppose?
> 
> Nathann


---

Comment by azi created at 2014-12-29 13:10:55

Ohh and another reason why it may not be related to this wrapper is the fact that the same error is occuring with canonical_form which actually does not involve using this pointers/functions thing.


```
sage: from sage.graphs.bliss import *
sage: D = digraphs.Kautz(10,1,2)
sage: canonical_form(D)
Bliss fatal error: Internal error - unknown splitting heuristics
Aborting!
```



---

Comment by ncohen created at 2014-12-29 13:20:57

Yo !

> Ohh and another reason why it may not be related to this wrapper is the fact that the same error is occuring with canonical_form which actually does not involve using this pointers/functions thing.

True. HMmmmmmm... `O_o`

Well, I looked at the code for a while and I really don't see anything that could produce that.... Short of a bliss bug... `O_o`

Nathann


---

Comment by azi created at 2014-12-29 13:42:42

Replying to [comment:29 ncohen]:
> Yo !
> 
> > Ohh and another reason why it may not be related to this wrapper is the fact that the same error is occuring with canonical_form which actually does not involve using this pointers/functions thing.
> 
> True. HMmmmmmm... `O_o`
> 
> Well, I looked at the code for a while and I really don't see anything that could produce that.... Short of a bliss bug... `O_o`

Yeah.. I'll try to reproduce it in bliss directly.
> 
> Nathann


---

Comment by azi created at 2014-12-30 10:03:32

Looks really weird. 

I am waiting to figure out how can I be able to force a certain heuristic to be used because the behaviour right now is just sick. I've changed the "hook function" to an empty function (not doing any work) and its still messy:


```
sage: D = digraphs.Kautz(10,3,2)
sage: from sage.graphs.bliss import *
sage: automorphism_group(D)
Permutation Group with generators [()]
sage: automorphism_group(D)
Permutation Group with generators [()]
sage: automorphism_group(D)
Permutation Group with generators [()]
sage: automorphism_group(D)
Permutation Group with generators [()]
sage: automorphism_group(D)
Bliss fatal error: Internal error - unknown splitting heuristics
Aborting!
```


if G is a graph then 

```
while True: A = automorphism_group(G) 
```


works well. :O


---

Comment by git created at 2014-12-30 11:10:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2014-12-30 11:10:54

Okay, for *now* a working fix is to change the line in bliss that declares the splitting heuristics to include an assignment:


```

846   SplittingHeuristic sh = shs_flm;
```


Since this is not done for graphs it makes all of this very suspicious but it works. 

I've also talked with the author of bliss who confirmed this is an actually bug that he'll address in an upcoming release of bliss. In the meantime he says the above is a valid fix.

That said, I think it makes sense to see what is to be done to push this branch further? I have added some small documentation and would like to hear any kind of input that you may have.

Best,

Jernej


---

Comment by ncohen created at 2014-12-30 11:52:41

Yooooooooo !

> Since this is not done for graphs it makes all of this very suspicious but it works. 
> 
> I've also talked with the author of bliss who confirmed this is an actually bug that he'll address in an upcoming release of bliss. In the meantime he says the above is a valid fix.

Oh, excellent news !

> That said, I think it makes sense to see what is to be done to push this branch further?

First, it would be really good to have the 'spkg' ticket in `positive_review`. Jeroen set it back to `needs_work` recently, and now you have something else to add to it: the patch to change this line.

Now, you cannot modify upstream directly (i.e. the .tar.bz2 file) so you must use the 'patch' mechanism that is already being used in build/pkgs/sympy (for example). Look at the sympy/spkg-install file and the patches/ folder. The corresponding doc is there:

http://www.sagemath.org/doc/developer/packaging.html#patching-sources

> I have added some small documentation and would like to hear any kind of input that you may have.

Well, it seems that you still have some notes to yourself in the branch. Those that you cannot solve right now should probably appear in the documentation of the function to which they apply, and not at module level. (note: you can write a docstring in C functions. It will not appear as html do of course, but that's the right place to write the function's doc.)

In particular you have some formatting to do (a)length of lines b) the first line of doc is a one-line sentence describing the function.

You can also add the mechanism that makes GenericGraph.automorphism_group use bliss if available by default (set algorithm=None by default, and `if algorithm is None and is_package_installed("bliss")` then ...) if you like, otherwise I will do it at some point.

There is also this in the code

```
+        if algorithm == "bliss":
+            print 'yes'                
+            return
```


But really that's just cleaning. Short of that I do not think that there is anything important missing.

Oh, by the way: I do not think that you should really carry those vert2int or int2vert around. You could just say somewhere that the integer names of the vertices are those obtained by the ordering of `g.vertices()`

Then defining the two dictionaries is rather easy

```
int2verts = g.vertices()
vert2int = {v:i for i,v in enumerate(int2verts)}
```


Well, that's all. Only "code administration" `^^;`

Nathann


---

Comment by azi created at 2014-12-30 14:17:24

Replying to [comment:34 ncohen]:
> Yooooooooo !
> 
> > Since this is not done for graphs it makes all of this very suspicious but it works. 
> > 
> > I've also talked with the author of bliss who confirmed this is an actually bug that he'll address in an upcoming release of bliss. In the meantime he says the above is a valid fix.
> 
> Oh, excellent news !
> 
> > That said, I think it makes sense to see what is to be done to push this branch further?
> 
> First, it would be really good to have the 'spkg' ticket in `positive_review`. Jeroen set it back to `needs_work` recently, and now you have something else to add to it: the patch to change this line.
> 
> Now, you cannot modify upstream directly (i.e. the .tar.bz2 file) so you must use the 'patch' mechanism that is already being used in build/pkgs/sympy (for example). Look at the sympy/spkg-install file and the patches/ folder. The corresponding doc is there:
> 
> http://www.sagemath.org/doc/developer/packaging.html#patching-sources
> 
> > I have added some small documentation and would like to hear any kind of input that you may have.
I think it would be good to mention how the patch is created since there may be different parameters to diff and also since we like to just copy paste stuff and not think too much.

> 
> Well, it seems that you still have some notes to yourself in the branch. Those that you cannot solve right now should probably appear in the documentation of the function to which they apply, and not at module level. (note: you can write a docstring in C functions. It will not appear as html do of course, but that's the right place to write the function's doc.)
> 
> In particular you have some formatting to do (a)length of lines b) the first line of doc is a one-line sentence describing the function.
> 
> You can also add the mechanism that makes GenericGraph.automorphism_group use bliss if available by default (set algorithm=None by default, and `if algorithm is None and is_package_installed("bliss")` then ...) if you like, otherwise I will do it at some point.
> 
> There is also this in the code
> {{{
> +        if algorithm == "bliss":
> +            print 'yes'                
> +            return
> }}}
Yes, I'll make bliss the default the above was just a test. Though I we should really test this thoroughly since it can get messy if we leave a bug inside.. I spotted one before. Considering


```
return PermutationGroup(gens) 
```


everything works well most of the time (since in all tested graphs every vertex appears in some cycle of the generator). But if you do not specify the domain you may get automorphism groups not acting on all the required points...

> 
> But really that's just cleaning. Short of that I do not think that there is anything important missing.
> 
> Oh, by the way: I do not think that you should really carry those vert2int or int2vert around. You could just say somewhere that the integer names of the vertices are those obtained by the ordering of `g.vertices()`
> 
> Then defining the two dictionaries is rather easy
> {{{
> int2verts = g.vertices()
> vert2int = {v:i for i,v in enumerate(int2verts)}
> }}}
Yes that's right. What made me choose the present version is the fact that the second line is already a for loop over the vertices and from how I understand g.vertices() that always involves a loop as well (at least to get the labels of the graph, grrr)?
> 
> Well, that's all. Only "code administration" `^^;`
Thanks.
> 
> Nathann
Jernej


---

Comment by ncohen created at 2014-12-30 14:27:12

> I think it would be good to mention how the patch is created since there may be different parameters to diff and also since we like to just copy paste stuff and not think too much.

Well, open a ticket and add the explanation. Sage's doc is changed exactly like the code is `:-P`

> Yes that's right. What made me choose the present version is the fact that the second line is already a for loop over the vertices and from how I understand g.vertices() that always involves a loop as well (at least to get the labels of the graph, grrr)?

I do not think that the time difference is anything but negligible there. Plus a "loop" does not cost anything by itself, it depends on what you loop I expect. If the loop involves many calls to `.next()` or something it may cost more than doing the same on a simple list, I don't know..

Nathann


---

Comment by git created at 2015-01-01 14:44:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-01 14:49:55

First of all happy new year and stuff!!!!


I've now pushed the latest branch for bliss but I am having a problem since when I do sage -t generic_graph.py it keeps saying

```

    def is_vertex_transitive(self, partition=None, verbosity=0,
                                                              ^
IndentationError: unindent does not match any outer indentation level
```


and I and vim's :list are just blind... (dont' see it)

Do you happen to see where the indentation breaks and do you happen to have any new comments about the current code? I think it should be pretty near to what it should look like.


---

Comment by ncohen created at 2015-01-01 15:05:44

Yop !

> First of all happy new year and stuff!!!!
+1

> and I and vim's :list are just blind... (dont' see it)

What I don't like about "def canonical_label(..." is that the doc appears BEFORE the function's definition. Could it be that ?

> do you happen to have any new comments about the current code?

Well, definitely there is something wrong in `automorphism_group`, where you define a keyword `algorithm` but never read it. Then you should probably add a couple of new doctests using bliss (with an #optional flag) in the function from `generic_graph`. Whatever you do with this function's input, you should probably do the same in the similar functions btw: `canonical_label`, and `is_isomorphic`.

Also, it looks like the test that you run in `is_isomorphic`  (number of edges/vertices) already appear a bit later in the code. No reason to have them appear twice.

There is still this line which has nothing to do here


```diff
+    :meth:`~GenericGraph.geodetic_number` | Returns the geodetic number of the given graph. 
```


Oh, and several lines are still longer than 80chr, and we try to wrap them because ...

Because somebody said that we had to.

Nathann


---

Comment by git created at 2015-01-01 18:13:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-01 18:19:35

Replying to [comment:39 ncohen]:

> What I don't like about "def canonical_label(..." is that the doc appears BEFORE the function's definition. Could it be that ?

That surely didn't help but the error still persists :-S I have no idea where the mismatch is.


> Well, definitely there is something wrong in `automorphism_group`, where you define a keyword `algorithm` but never read it.
Yes I was following your advice from above which was to add a condition of the form


```
 if algorithm is None and is_package_installed("bliss") :
```


since we only offer two algorithms for now this works fine, perhaps provided that we write the option algorithm="nice" to  indicate the currently default implementation? What do you suggest?




> Then you should probably add a couple of new doctests using bliss (with an #optional flag) in the function from >`generic_graph`. Whatever you do with this function's input, you should probably do the same in the similar functions btw: >`canonical_label`, and `is_isomorphic`.
Is it not enough to have them in bliss.pyx? If not, then I'll add some doctests when we agree on the technical aspects of the code 


> Also, it looks like the test that you run in `is_isomorphic`  (number of edges/vertices) already appear a bit later in the code. No reason to have them appear twice.
fixed
> 
> There is still this line which has nothing to do here
> 
> {{{
> #!diff
> +    :meth:`~GenericGraph.geodetic_number` | Returns the geodetic number of the given graph. 
> }}}
fixed
 
> Oh, and several lines are still longer than 80chr, and we try to wrap them because ...
80chr is quite tight :O Also have you noticed that there appears to be some indentation inconsistency in the code? It looks like the functions on the bottom (example def graph_isom_equivalent_non_edge_labeled_graph) are not indented as the above ones?   

Thanks for the input,

Jernej


---

Comment by ncohen created at 2015-01-02 07:14:55

Hello !

> That surely didn't help but the error still persists :-S I have no idea where the mismatch is.

Right now when I run the tests on `generic_graph` I get several screens filled with "is_package_installed is not defined".

> Yes I was following your advice from above which was to add a condition of the form
> 
> {{{
>  if algorithm is None and is_package_installed("bliss") :
> }}}
> 
> since we only offer two algorithms for now this works fine, perhaps provided that we write the option algorithm="nice" to  indicate the currently default implementation? What do you suggest?

And what happens when you do `G.automorphism_group(algorithm="bliss")` as indicated in the function's doc ? `:-P`

> Is it not enough to have them in bliss.pyx? If not, then I'll add some doctests when we agree on the technical aspects of the code 

That would be for advertising purposes. Just one would do, just to emphasize that another algorithm is available.

> 80chr is quite tight :O 

As usual it is some PEP's fault. It probably is PEP8. It is always PEP8's fault.

> Also have you noticed that there appears to be some indentation inconsistency in the code? It looks like the functions on the bottom (example def graph_isom_equivalent_non_edge_labeled_graph) are not indented as the above ones?   

Oh ? No, I never saw that. Well, some hardcore PEP8 guy will probably change it some day.

Nathann


---

Comment by git created at 2015-01-02 12:49:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-02 12:51:11

Replying to [comment:42 ncohen]:
> Hello !
Hai!!


> And what happens when you do `G.automorphism_group(algorithm="bliss")` as indicated in the function's doc ? `:-P`
OFC it has no sense but I was just following the guideline. I've now changed that so that we check that algorithm = 'bliss' explicitly. In case you have something else in mind let me know.


> That would be for advertising purposes. Just one would do, just to emphasize that another algorithm is available.
Advertisement added. 
> 
> > 80chr is quite tight :O 
> 
> As usual it is some PEP's fault. It probably is PEP8. It is always PEP8's fault.
Its also pretty funny that 90% of the lines are 100% over 80 char.

The current code passes all the tests and I am open for further suggestions.

As far as the empty commit message that is due to a mismatch of vim commands in nano. 

> Nathann

Best,
Jernej


---

Comment by ncohen created at 2015-01-04 08:29:21

Hello !

> OFC it has no sense but I was just following the guideline. I've now changed that so that we check that algorithm = 'bliss' explicitly. In case you have something else in mind let me know.

Oh sorry, I was thinking of something different:

1) We want the users who explicitly ask for "bliss" to never run any other code
2) We want users who do not care to run "bliss" if it is available (they may be calling that code through another functions without knowing)


```
if (algorithm is None and
    is_package_installed("bliss") and
    not edge_labels):
    algorithm = "bliss"
if algorithm == "bliss":
    try:
        from sage.graphs.bliss import is_isomorphic
    except ImportError:
        raise RuntimeError("You must install the bliss spkg before running this code")
    <bliss call>
```


> The current code passes all the tests and I am open for further suggestions.

Could you move the code comments that explain the function's behaviour inside of the function ? As you would do if it were a Python function (e.g. bliss_graph/bliss_digraph, add_gen) ? It would be cool if you could also write the documentation of these functions (e.g. INPUT section), even though you cannot doctest them.

Could you also document what `empty_hook` is meant for ? It is useless right now but it would be good to know what it does if we ever want to use it for something (and that's the kind of stuff which can become *VERY* useful). Please document its parameters too.

Thanks,

Nathann


---

Comment by azi created at 2015-01-04 18:26:07

Replying to [comment:45 ncohen]:
> Hello !
> 
> > OFC it has no sense but I was just following the guideline. I've now changed that so that we check that algorithm = 'bliss' explicitly. In case you have something else in mind let me know.
> 
> Oh sorry, I was thinking of something different:
> 
> 1) We want the users who explicitly ask for "bliss" to never run any other code
> 2) We want users who do not care to run "bliss" if it is available (they may be calling that code through another functions without knowing)
> 
> {{{
> if (algorithm is None and
>     is_package_installed("bliss") and
>     not edge_labels):
>     algorithm = "bliss"
> if algorithm == "bliss":
>     try:
>         from sage.graphs.bliss import is_isomorphic
>     except ImportError:
>         raise RuntimeError("You must install the bliss spkg before running this code")
>     <bliss call>
> }}}
And this is to be placed in the say is_isomorphic/automorphism_group part and so on? If so, isn't this a bit of an overhead to be checked each time?

> 
> > The current code passes all the tests and I am open for further suggestions.
> 
> Could you move the code comments that explain the function's behaviour inside of the function ? As you would do if it were a Python function (e.g. bliss_graph/bliss_digraph, add_gen) ? It would be cool if you could also write the documentation of these functions (e.g. INPUT section), even though you cannot doctest them.
Thanks. I'll do it and post a new branch when I am done.
> 
> Could you also document what `empty_hook` is meant for ? It is useless right now but it would be good to know what it does if we ever want to use it for something (and that's the kind of stuff which can become *VERY* useful). Please document its parameters too.

Best,

Jernej

> Thanks,
> 
> Nathann


---

Comment by ncohen created at 2015-01-05 04:28:47

Yo !

> And this is to be placed in the say is_isomorphic/automorphism_group part and so on? If so, isn't this a bit of an overhead to be checked each time?

Are you afraid of the call to `is_package_installed` ? If so, it may not be a bad option to cache it at module level. Something like a "is_bliss_available = is_package_installed("bliss")" in `generic_graph.py`. It would only be loaded when the graph files are loaded first.

Nathann


---

Comment by ncohen created at 2015-01-05 04:31:08


```
sage: %timeit is_package_installed("bliss")
1000000 loops, best of 3: 1.61 µs per loop
sage: g=graphs.PetersenGraph()
sage: %timeit g.is_isomorphic(g)
1000 loops, best of 3: 171 µs per loop
sage: %timeit g.automorphism_group()
1000 loops, best of 3: 483 µs per loop
sage: %timeit g.canonical_label()
1000 loops, best of 3: 271 µs per loop
```


Perhaps it is not even worth that... `:-P`

Nathann


---

Comment by git created at 2015-01-14 08:00:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-01-14 08:00:56

(I merged all commits together as the history was a bit messy. It also conflicted with the latest beta)


---

Comment by git created at 2015-01-14 08:29:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-01-14 18:20:55

Hello again !

I made a pass on this code, added some doc, fixed a few things and... Well, now I only have a couple of questions about this branch:

- What about implementing bliss' version of `is_isomorphic` later ? The feature that we need right now is `automorphism_group`  (I needed it today, the difference is amazing!), so can't the rest be done later if we need it ? By the way, I never had any slowness problem with `is_isomorphic` (or `canonical_label`) that I can remember.

- It seems that the `Bliss fatal error: Internal error - unknown splitting heuristics` problem is not solved. I see it happen when I run the tests in the graph/ folder.

- I changed the code to list the vertices according to `enumerate(G.vertices())` instead of `enumerate(G)`. We have this standard in other places that when vertices are turned into integers, it is done using the ordering of `G.vertices()`.

Tell me what you think ! I would be glad to have this into Sage soon `;-)`

Nathann


---

Comment by git created at 2015-01-14 18:21:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-16 19:00:34

Replying to [comment:52 ncohen]:
> Hello again !
Hi there!

> 
> I made a pass on this code, added some doc, fixed a few things and... Well, now I only have a couple of questions about this branch:
> 
> - What about implementing bliss' version of `is_isomorphic` later ? The feature that we need right now is `automorphism_group`  (I needed it today, the difference is amazing!), so can't the rest be done later if we need it ? By the way, I never had any slowness problem with `is_isomorphic` (or `canonical_label`) that I can remember.
Hm.. I need these things, especially canonical_label. Do you have any practical reasons to leave this out? I mean it doesn't look like it needs that much effort at this point.



> 
> - It seems that the `Bliss fatal error: Internal error - unknown splitting heuristics` problem is not solved. I see it happen when I run the tests in the graph/ folder.
Weird. Are you sure you're using the patched version of bliss?
> 
> - I changed the code to list the vertices according to `enumerate(G.vertices())` instead of `enumerate(G)`. We have this standard in other places that when vertices are turned into integers, it is done using the ordering of `G.vertices()`.
good, thanks!
> 
> Tell me what you think ! I would be glad to have this into Sage soon `;-)`
I just have another question! Is the new add_gen function faster than before? Do you think it makes sense to try using the suggestion from here ? http://stackoverflow.com/questions/27657473/efficiently-converting-a-bijection-to-cycle-notation

> 
> Nathann


---

Comment by ncohen created at 2015-01-16 19:17:50

Hello,

> Hm.. I need these things, especially canonical_label. Do you have any practical reasons to leave this out? I mean it doesn't look like it needs that much effort at this point.

Well, there is no reason to leave `canonical_label` out, even though I don't get why the current canonical label function from Sage wouldn't do the job for you.

It was more about the `is_isomorphic` function that is not fully implemented. I wouldn't mind having this patch in Sage quick, and report the implementation of that to another ticket.

> Weird. Are you sure you're using the patched version of bliss?

I just made a test:
- Loaded the branch
- Checked that the branch contained the patches/ directory
- erased my local copy of the bliss.tar file
- installed it again

Same result when I run "sage -tp 4 -l generic_graph.py". Don't you get the same errors ?

> I just have another question! Is the new add_gen function faster than before? Do you think it makes sense to try using the suggestion from here ? http://stackoverflow.com/questions/27657473/efficiently-converting-a-bijection-to-cycle-notation

Ahahah. Well, his algorithm is short, I like it `:-)`

It's up to you. I do not think that it is the bottleneck of any computations, so to me 'the easiest to read is the best choice'

Nathann


---

Comment by ncohen created at 2015-01-16 19:23:23

btw: the doc does not compile on my computer because of some broken link

Nathann


---

Comment by azi created at 2015-01-16 20:24:31

Replying to [comment:55 ncohen]:
> Hello,
> 
> > Hm.. I need these things, especially canonical_label. Do you have any practical reasons to leave this out? I mean it doesn't look like it needs that much effort at this point.
> 
> Well, there is no reason to leave `canonical_label` out, even though I don't get why the current canonical label function from Sage wouldn't do the job for you.

> 
> It was more about the `is_isomorphic` function that is not fully implemented. I wouldn't mind having this patch in Sage quick, and report the implementation of that to another ticket.
Okay. We can leave this is_isomorphic thing for next time.

> 
> > Weird. Are you sure you're using the patched version of bliss?
> 
> I just made a test:
> - Loaded the branch
> - Checked that the branch contained the patches/ directory
> - erased my local copy of the bliss.tar file
> - installed it again
> 
> Same result when I run "sage -tp 4 -l generic_graph.py". Don't you get the same errors ?
Oh, yes I do get the errors as well. What do you suggest that we do at this point?
> 
> > I just have another question! Is the new add_gen function faster than before? Do you think it makes sense to try using the suggestion from here ? http://stackoverflow.com/questions/27657473/efficiently-converting-a-bijection-to-cycle-notation
> 
> Ahahah. Well, his algorithm is short, I like it `:-)`
Yeah.

> 
> It's up to you. I do not think that it is the bottleneck of any computations, so to me 'the easiest to read is the best choice'
Unless you find his supercool I'd like to stay with what is already there since otherwise I have to understand how his code works. His solution is faster though.
> 
Best,

Jernej
> Nathann


---

Comment by ncohen created at 2015-01-17 03:20:18

Yo !

> Oh, yes I do get the errors as well. What do you suggest that we do at this point?

Can you report this to the author again? The bug is not fixed, perhaps he will find the problem.

> Unless you find his supercool I'd like to stay with what is already there since otherwise I have to understand how his code works. His solution is faster though.

No problem, as you like. What he implemented is exactly the same algorithm, however. He just makes it shorter by using fancier pyhon. I think that in C his algorithm would be slower than yours, but not in Python `;-)`

Nathann


---

Comment by azi created at 2015-01-17 10:20:25

Replying to [comment:58 ncohen]:
> Yo !
> 
> > Oh, yes I do get the errors as well. What do you suggest that we do at this point?
> 
> Can you report this to the author again? The bug is not fixed, perhaps he will find the problem.
Yes sure. I am in correspondence with him and I am waiting for his reply right now. So before I flood him with this new email I'd like to wait for his answer.

In the meantime I'd like to push this thing further without having to wait for his fix/reply.

One way we could try is to call Digraph::set_heuristic or something. Though I was not able to make it work in cython due to some enum typedefs issue.

So what do you suggest that we do? Just avoid digraphs for now?
> 
> > Unless you find his supercool I'd like to stay with what is already there since otherwise I have to understand how his code works. His solution is faster though.
> 
> No problem, as you like. What he implemented is exactly the same algorithm, however. He just makes it shorter by using fancier pyhon. I think that in C his algorithm would be slower than yours, but not in Python `;-)`
We can leave the code as is then!

As far as I get the current state of affairs, we need to

1. Leave out the is_isomorphic thing
2. Find a workaround for the digraph thing.

and then we are almost done?

Best,

Jernej


---

Comment by ncohen created at 2015-01-17 11:36:45

Hello,

> So what do you suggest that we do? Just avoid digraphs for now?

Let's wait for his answer. It would be a pity to miss digraphs just because of that. He may know how to fix it.

> We can leave the code as is then!

Yepyep

> As far as I get the current state of affairs, we need to
> 
> 1. Leave out the is_isomorphic thing
> 2. Find a workaround for the digraph thing.
> 
> and then we are almost done?

Right !

Nathann


---

Comment by git created at 2015-01-28 12:43:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-28 12:44:09

I think this patch now fixes the digraph issue.

We now have new test failures and I am looking into them right now.

Let me know if this patch is not correctly handled or something.


---

Comment by azi created at 2015-01-28 12:47:35

Okay, so all the failures now are of the form


```
Expected:
    [This is the Trac macro *0, 1, 2, 3, 4, 5, 6, 7, 8, 9* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1, 2, 3, 4, 5, 6, 7, 8, 9-macro)
Got:
    [This is the Trac macro *0, 1, 4, 2, 5, 6, 3, 9, 7, 8* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1, 4, 2, 5, 6, 3, 9, 7, 8-macro)
....blahblah...
Expected:
    [[0], [2, 3, 6, 7, 8, 9], [1, 4, 5]]
Got:
    [[0], [1, 4, 5], [2, 3, 7, 8, 9, 6]]
```


now if I correct this to the bliss output it won't work on those installations that do not have bliss. 

Do you have any preferences how to handle that?


---

Comment by ncohen created at 2015-01-28 12:50:47

> Do you have any preferences how to handle that?

Do you have many of them? If not, perhaps you can solve the problem by just changing the doctests to add an 'algorithm="sage"' flag.

Nathann


---

Comment by azi created at 2015-01-28 13:13:22

Ohh I didn't notice you included that. I think this new fix does it. All tests pass now.


---

Comment by git created at 2015-01-28 13:13:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-01-28 13:17:12

Yo!
> Ohh I didn't notice you included that. I think this new fix does it. All tests pass now.

Looks good. Can you remove the `is_isomorphic` code? I think that it is all that remains to be done here.

Nathann


---

Comment by ncohen created at 2015-01-28 13:19:30


```
sage -t --long tutte_polynomial.py  # 2 doctests failed
```



---

Comment by git created at 2015-01-28 13:21:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-28 13:22:17

Yeah I have only tested this thing on generic_graph.py.

I guess we must be really careful to check all the places this guys are called.

I'll check now a bit...


---

Comment by git created at 2015-01-28 13:26:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-28 13:28:16

I've fixed the error in Tutte poly but there is another depreciation warning that gets triggered due to loops not being explicitly specified. Do you happen to know what is causing this?


---

Comment by ncohen created at 2015-01-28 13:30:15

> I've fixed the error in Tutte poly

It will break on a machine that does not have `bliss` installed.

> but there is another depreciation warning that gets triggered due to loops not being explicitly specified. Do you happen to know what is causing this?

I would say that it come from there

```
+            G = DiGraph(edges)
+        else:
+            from sage.graphs.graph import Graph
+            G = Graph(edges)
```


Nathann


---

Comment by git created at 2015-01-28 14:23:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-01-28 14:24:37

Okay, 

so now all doctest pass except for the loops thing in Tutte poly. I don't seem to be able to find the line that you mention. In which file is this present?


---

Comment by ncohen created at 2015-01-28 14:58:44

> so now all doctest pass except for the loops thing in Tutte poly. I don't seem to be able to find the line that you mention. In which file is this present?

Oops, sorry. It is a line added by your branch, in the function `canonical_form`.

Nathann


---

Comment by ncohen created at 2015-01-28 15:01:22

Jernej, you cannot make the computation of tutte polynomials avoid bliss only because of a doctest.

The doctest should be changed to be independent from the solver, or flagged as #random, or you should expose 'algorithm="sage/bliss"' in the tutte polynomial function... I mean, there are many workaround possible but you can't explicitly forbid people to use bliss for such computations only because of a doctest.

Nathann


---

Comment by azi created at 2015-01-28 15:18:39

Hm.. I am confused.

What I *think* I did is simply made sure the Tutte program uses sage's algorithm so that the test passes on installations not having bliss installed. 

As I understand you'd like to have a new parameter for the tutte poly to use bliss?


---

Comment by ncohen created at 2015-01-28 16:09:23

> What I *think* I did is simply made sure the Tutte program uses sage's algorithm so that the test passes on installations not having bliss installed. 

Yes. But as you changed Sage's source code and not only its doctests, now `tutte_polynomial` will never be able to use bliss even if it is installed.

> As I understand you'd like to have a new parameter for the tutte poly to use bliss?

That is one way out. Another way out is to remove the doctest if it is not actually necessary, or to modify it in such a way that it still tests what it should test, without actually printing the ordering that may depend upon the packages installed.

Nathann


---

Comment by azi created at 2015-01-28 16:10:59

Replying to [comment:79 ncohen]:
> > What I *think* I did is simply made sure the Tutte program uses sage's algorithm so that the test passes on installations not having bliss installed. 
> 
> Yes. But as you changed Sage's source code and not only its doctests, now `tutte_polynomial` will never be able to use bliss even if it is installed.
Right, good point!
> 
> > As I understand you'd like to have a new parameter for the tutte poly to use bliss?
> 
> That is one way out. Another way out is to remove the doctest if it is not actually necessary, or to modify it in such a way that it still tests what it should test, without actually printing the ordering that may depend upon the packages installed.
Unless you start raving I'll just remove the specific doctest - I don't think its releant.

Thanks,

Jernej
> 
> Nathann


---

Comment by git created at 2015-01-28 16:12:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-28 16:20:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-01-28 16:22:40

Hello again,

> Unless you start raving I'll just remove the specific doctest - I don't think its releant.

Err. Well, actually you can't just remove all doctests of a function. `sage -coverage <filename>` should answer that all functions are doctested, so at least something should call the function. I added a small commit that modified the previous doctest, in such a way that it does not depend on the ordering of the labelling.

It does not check much to be honest, only that something actually gets cached. Well.

If you are okay with this branch, you can set it to positive review. And we will at long last be able to compute automorphism groups efficiently.

Nathann


---

Comment by ncohen created at 2015-01-28 16:22:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-01-28 16:33:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by azi created at 2015-01-28 17:40:20

Changing status from needs_review to positive_review.


---

Comment by azi created at 2015-01-28 17:40:53

Thanks for helping pushing this through.I  hope all is set now.

Best,

Jernej


---

Comment by ncohen created at 2015-01-28 17:44:58

Eeeeeeeeeeeeexcellent ! `;-)`

Nathann


---

Comment by vbraun created at 2015-01-29 02:08:33

Documentation doesn't build


---

Comment by vbraun created at 2015-01-29 02:08:33

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-01-29 08:08:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-01-29 13:09:41

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-01-29 17:11:29

I get

```
...
sage: G = Graph(multiedges=True,sparse=True) ## line 17388 ##
sage: G.add_edge(('a', 'b')) ## line 17389 ##
sage: G.add_edge(('a', 'b')) ## line 17390 ##
sage: G.add_edge(('a', 'b')) ## line 17391 ##
sage: G.automorphism_group() ## line 17392 ##
Permutation Group with generators [('a','b')]
sage: D = DiGraph( { 0:[1], 1:[2], 2:[3], 3:[4], 4:[0] } ) ## line 17397 ##
sage: D.automorphism_group() ## line 17398 ##
Bliss fatal error: Internal error - unknown splitting heuristics
Aborting!
```



---

Comment by vbraun created at 2015-01-29 17:11:29

Changing status from positive_review to needs_work.


---

Comment by azi created at 2015-01-29 17:14:30

Volker, 

have you reinstalled bliss? There is a patch that has to be applied to bliss before this works and the patch was introduced in this branch.


Best,

Jernej


---

Comment by vbraun created at 2015-01-29 17:20:35

Just recompiled and its still there. Actually its always dying in a slightly different spot:

```
sage: g = digraphs.Circuit(5) ## line 11558 ##
sage: g.is_circulant(certificate = True) ## line 11559 ##
Bliss fatal error: Internal error - unknown splitting heuristics
Aborting!
```



---

Comment by azi created at 2015-01-29 17:24:25

Wow that's bad. Just to be sure, the patch applied (the one in pkgs/bliss/patches) is the following?


```
--- bliss-0.72/graph.cc	2011-05-12 15:29:46.000000000 +0200
+++ /tmp/bliss-0.72/graph.cc	2015-01-28 13:40:42.289179859 +0100
`@``@` -1920,6 +1920,7 `@``@`
 Digraph::Digraph(const unsigned int nof_vertices)
 {
   vertices.resize(nof_vertices);
+  sh = shs_f;
 }
```



---

Comment by vbraun created at 2015-01-29 17:32:40


```
$ patch=patches/digraph_heuristic.patch
$ patch -n -p1 <"$patch" 
patch: **** Only garbage was found in the patch input.
```



---

Comment by azi created at 2015-01-29 17:36:55

Hm. Question. Why don't I get this error when I issue sage -f bliss?


---

Comment by vbraun created at 2015-01-29 19:26:45

Oops, -n is not dry-run in patch.

The problem is that you first "cd src" and then iterate over "patches/*.patch". Which is then empty.


---

Comment by azi created at 2015-01-30 10:45:22

Replying to [comment:95 vbraun]:
> {{{
> $ patch=patches/digraph_heuristic.patch
> $ patch -n -p1 <"$patch" 
> patch: **** Only garbage was found in the patch input.
> }}}

What exactly is causing this error? The patch was created with 


```
diff -Naur old new > patch.txt
```



---

Comment by vbraun created at 2015-01-30 11:28:52

The "only garbage" message is because of the "-n".


---

Comment by azi created at 2015-01-30 11:56:20

Okay, so the patch actually looks fine if manually apply it, but sage -f bliss says


```
can't find file to patch at input line 3
```


how do I actually specify this file? Where are the sources expected to be?


---

Comment by vbraun created at 2015-02-05 14:37:23

As I said in comment:97, the problem is that you first "cd src" and then iterate over "patches/*.patch". Which is the wrong path when you are in "src"


---

Comment by azi created at 2015-02-05 14:44:18

Volker,

this is the actual error I get after fixing the "cd src" issue. Specifically


```
****************************************************
can't find file to patch at input line 3
Perhaps you used the wrong -p or --strip option?
The text leading up to this was:
--------------------------
```



---

Comment by vbraun created at 2015-02-05 14:48:01

For starters, why is bliss-0.72/graph.cc one directory deep but /tmp/bliss-0.72/graph.cc two directories deep? Do your diffs against identical directory trees. Then strip the right number of directory levels with the -p


---

Comment by git created at 2015-02-11 12:50:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by azi created at 2015-02-11 12:52:19

Can someone take a look if this now makes sense?

Doing sage -f bliss and testing the graph module passes OK for me.


---

Comment by ncohen created at 2015-02-11 12:57:45

Here it crashes with the usual error message. Does that work on your computer ?


```
sage: digraphs.DeBruijn(3,1).is_circulant(certificate = True)
Bliss fatal error: Internal error - unknown splitting heuristics
Aborting!
```



---

Comment by azi created at 2015-02-11 12:59:46

Weird.

```
sage: digraphs.DeBruijn(3,1).is_circulant(certificate = True)
(True, [(3, [0, 1, 2])])
```



---

Comment by azi created at 2015-02-11 13:00:55

Could you please check if this new modification that I pushed actually patches bliss for you?


---

Comment by ncohen created at 2015-02-11 13:11:18

The patching works fine. I added `grep "sh = shs_f;" -A 5 -B 5 graph.cc` right at the end of the 'for patch in' loop in spkg-install, and I see:


```
Digraph::Digraph(const unsigned int nof_vertices)
{
  vertices.resize(nof_vertices);
  sh = shs_f;
}
```


I also don't understand why it would work on your computer and not on mine.

Nathann


---

Comment by azi created at 2015-02-11 14:49:31

I have now pulled the latest branch, installed bliss and everything works fine. The above example as well as sage -t generic_graph.py o_O

I have no idea what's going on at this point.


---

Comment by ncohen created at 2015-02-11 14:52:26

Same with `sage -t -l --optional=sage,bliss graph/` for the whole folder ?

Nathann


---

Comment by azi created at 2015-02-11 16:11:15

Yes! I only get three errors. One is the depreciaton warning from Tutte poly and two are weird errors of the type


```
**********************************************************************
File "sage/src/sage/graphs/generic_graph.py", line 17448, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    A1.is_isomorphic(A2)                          # optional - bliss
Expected:
    True                                                # optional - bliss
Got:
    True
**********************************************************************
```



---

Comment by ncohen created at 2015-02-11 16:24:23

Can you try on somebody else's computer, or on some ssh machine ?

Nathann


---

Comment by azi created at 2015-03-02 13:50:48

Nathann,

sorry for the delay. Was computing something on all external machines and did want to stop to compile sage.

I have now tested this on another machine (fetch stuff with git install bliss sage -t on generic_graph.py and graph.py) and it works well.

Also


```
sage: digraphs.DeBruijn(3,1).is_circulant(certificate = True)

(True, [(3, [0, 1, 2])])
```


So I have no idea why the error is still occurring for you.

Best,

Jernej


---

Comment by ncohen created at 2015-03-03 14:55:04

I am recompiling Sage from scratch to see what happens when I reinstall this afterwards.

Nathann


---

Comment by ncohen created at 2015-03-03 17:14:13

Okay. I made a 'make distclean' on a machine on which Sage crashed with this line

```
sage: digraphs.DeBruijn(3,1).is_circulant(certificate = True)
```


I remove the bliss package, then ran 'make' then installed bliss again, and now it works. Volker? Could you do the same thing on your machine to see if it solves the problem too?

Nathann


---

Comment by vbraun created at 2015-03-03 17:24:28

What do you mean by "remove the package"? If you need to recompile (e.g. because of different patches) then you must bump the patch level in the package-version.txt


---

Comment by ncohen created at 2015-03-04 08:20:31

Okay. This branch now works on my laptop, and on my office's computer. Here is what I did:

- `make distclean`
- `rm upstream/bliss-0.72.tar.bz2`
- apply the branch
- `make`
- `sage -f bliss`
- `make`

And now it works. 

I have no clue what the problem was, however. And of course now I don't know how to reproduce the bug anymore `XD`

Nathann


---

Comment by git created at 2015-03-04 08:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2015-03-04 08:22:33

Do you think we can accept this then?


---

Comment by ncohen created at 2015-03-04 08:24:35

> Do you think we can accept this then?

Not yet. First, I think I saw somewhere that the documentation did not build, and this must be fixed. Because of some http link.

Then we must figure out what happened, for even if a distclean makes the trick something fishy is going on in the building process (Volker may know). Unless we find what it is and fix it, everybody will have to do a `make distclean` in order to have it work, just like we did.

Nathann


---

Comment by ncohen created at 2015-03-04 08:24:44

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-03-11 14:02:20

You need to bump the package-version.txt to 0.72.p1, otherwise the build system does't know that anything changed and will not recompile bliss (and, therefore, your patch will not be used).


---

Comment by ncohen created at 2015-03-11 16:04:33

Volker: the bug still happened when running 'sage -f bliss'. Isn't that a contradiction ?


---

Comment by vbraun created at 2015-03-11 21:08:08

Which bug do you mean? There are clearly multiple ones. I'll be happy to look if you don't have any obvious bugs open any more.


---

Comment by ncohen created at 2015-03-12 07:21:45

Hello Volker,

> Which bug do you mean? There are clearly multiple ones. I'll be happy to look if you don't have any obvious bugs open any more.

Well, the 'main' bug that we had was this 'undefined heuristic' poblem which caused crashes. As I reported above, running a 'make distclean' and reinstalling everything solves it, and now this branch passes all tests on my computer.

I would be tempted to switch it to 'positive review', but that would produce errors on everybody's computer unless they *also* run this make distclean! If you say that this would be solved by changing the version number, then let us do that and switch it to 'positive review'

What worries me is that I do not understand why changing the version number would have any effect that forcing a reinstall through 'sage -f bliss' did not have. I tried it, long before trying 'make distclean', and it had no effect.

What do you think we should do ?

Nathann


---

Comment by vbraun created at 2015-03-18 09:11:54

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2015-03-18 09:11:54

You need to bump the package-version.txt to 0.72.p1, otherwise the build system does't know that anything changed and will not recompile bliss (and, therefore, your patch will not be used).


---

Comment by git created at 2015-03-21 16:57:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-03-21 16:58:32

Changing status from needs_work to needs_review.


---

Comment by azi created at 2015-03-24 19:32:28

Changing status from needs_review to positive_review.


---

Comment by azi created at 2015-03-24 19:32:28

Hello!

First of all thank you for pushing this last bit!!

I've glanced at the changes, tested the relevant modules with -t and checked if sage --docbuild reference html gives any errors related to this change.

All of the above looks good so I am giving this a positive review. In case you need something else to be checked let me know.

Best,

Jernej


---

Comment by vbraun created at 2015-04-10 16:37:07

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-10 16:37:07

Conflicts with #18145


---

Comment by ncohen created at 2015-04-10 16:40:19

This ticket, in positive review since two weeks, has to be rebased on a ticket created two days ago?....

You are not being fair.

Nathann


---

Comment by vbraun created at 2015-04-10 16:45:18

Jeroen asked me to merge it first, usually they are merged in ascending order.


---

Comment by git created at 2015-04-12 10:45:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-04-12 10:46:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-04-12 10:46:33

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-12 16:32:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-12 16:32:50


```
[graphs   ] /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py:docstring of sage.graphs.generic_graph.GenericGraph.automorphism_group:25: ERROR: Unknown target name: "http://www.tcs.tkk.fi/software/bliss/index.html".
[graphs   ] /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py:docstring of sage.graphs.generic_graph.GenericGraph.canonical_label:33: ERROR: Unknown target name: "http://www.tcs.tkk.fi/software/bliss/index.html".
[graphs   ] /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py:docstring of sage.graphs.generic_graph.GenericGraph.is_isomorphic:13: ERROR: Unknown target name: "http://www.tcs.tkk.fi/software/bliss/index.html".
Error building the documentation.
Traceback (most recent call last):
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 1626, in <module>
    getattr(get_builder(name), type)()
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 292, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/Users/buildslave-sage/slave/sage_git/build/src/doc/common/builder.py", line 503, in _wrapper
    x.get(99999)
  File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python/multiprocessing/pool.py", line 558, in get
    raise self._value
OSError: [graphs   ] /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py:docstring of sage.graphs.generic_graph.GenericGraph.automorphism_group:25: ERROR: Unknown target name: "http://www.tcs.tkk.fi/software/bliss/index.html".
```



---

Comment by git created at 2015-04-12 16:45:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-12 16:52:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-04-12 16:54:39

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-14 22:50:42


```
sage -t --long src/sage/combinat/designs/incidence_structures.py
**********************************************************************
File "src/sage/combinat/designs/incidence_structures.py", line 1498, in sage.combinat.designs.incidence_structures.IncidenceStructure.automorphism_group
Failed example:
    G
Expected:
    Permutation Group with generators [(2,3)(4,5), (2,4)(3,5), (1,2)(4,6), (0,1)(4,5)]
Got:
    Permutation Group with generators [(2,3)(4,5), (2,4)(3,5), (1,2,3)(4,5,6), (1,6)(2,5,4,3), (0,1)(2,3)]
**********************************************************************
1 item had failures:
   1 of  11 in sage.combinat.designs.incidence_structures.IncidenceStructure.automorphism_group
    [287 tests, 1 failure, 3.88 s]
```



---

Comment by vbraun created at 2015-04-14 22:50:42

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2015-04-15 08:20:53

Good news:

```
sage: g1=PermutationGroup([[(2,3),(4,5)], [(2,4),(3,5)], [(1,2),(4,6)], [(0,1),(4,5)]])
sage: g2=PermutationGroup([[(2,3),(4,5)], [(2,4),(3,5)], [(1,2,3),(4,5,6)], [(1,6),(2,5,4,3)], [(0,1),(2,3)]])
sage: g1==g2
True
```



---

Comment by git created at 2015-04-15 09:41:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-15 09:43:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-04-15 09:44:24

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-04-15 10:29:13

Is bliss making random choices during the computation? There is no need for non-deterministic choices in graph automorphisms, I'm sure. Patch it out and/or setting the seed might be a better fix in the long run.


---

Comment by ncohen created at 2015-04-15 10:34:26

Hello,

> Is bliss making random choices during the computation? There is no need for non-deterministic choices in graph automorphisms, I'm sure.

A permutation group can have different sets of generators, and that's the trouble here: Sage and Nauty do not obtain the same. The groups are equal, however, as illustrated above.

> Patch it out and/or setting the seed might be a better fix in the long run. 

There was a real bug in there. I fixed it, and sent an email to Jernej hoping that he can take a look at it soon.

Nathann


---

Comment by azi created at 2015-04-15 19:36:00

Changing status from needs_review to positive_review.


---

Comment by azi created at 2015-04-15 19:41:53

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-16 08:22:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-04-16 08:23:18

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-16 08:24:13

Here it is. Some doctests were displaying canonical labellings, and of course bliss and Sage compute different ones. I changed the doctests to make them more 'anonymous'.

Nathann


---

Comment by azi created at 2015-04-16 20:34:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-19 01:52:16

Resolution: fixed


---

Comment by jdemeyer created at 2015-05-20 07:00:16


```
sage -t src/sage/graphs/generic_graph.py
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 17773, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    A1.is_isomorphic(A2)                          # optional - bliss
Expected:
    True                                                # optional - bliss
Got:
    True
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 18179, in sage.graphs.generic_graph.GenericGraph.is_isomorphic
Failed example:
    G.is_isomorphic(graphs.GeneralizedPetersenGraph(5,2),algorithm='bliss')# optional - bliss
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.is_isomorphic[43]>", line 1, in <module>
        G.is_isomorphic(graphs.GeneralizedPetersenGraph(Integer(5),Integer(2)),algorithm='bliss')# optional - bliss
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 18306, in is_isomorphic
        from sage.graphs.bliss import is_isomorphic
    ImportError: cannot import name is_isomorphic
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 18483, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    s1 == s2                                                      # optional - bliss
Expected:
    True                                                                # optional - bliss
Got:
    True
**********************************************************************
```



---

Comment by ncohen created at 2015-05-20 11:39:11

`O_o`
