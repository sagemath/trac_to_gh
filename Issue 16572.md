# Issue 16572: leak in maxima interface

Issue created by migration from https://trac.sagemath.org/ticket/16809

Original creator: nbruin

Original creation time: 2014-08-12 22:13:06

CC:  egourgoulhon @mjungmath slelievre

The following line slowly expands memory usage:

```
sage: while True: _=sin(x).simplify()
```

The problem is that this uses the string interface to maxima, which creates symbols of the form `$SAGE34` with increasing numeric part. This is a memory leak in Common Lisp, because these symbols get interned.



---

Comment by git created at 2014-08-12 22:16:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2014-08-12 22:22:00

The current branch solves the problem by augmenting the "variable clear" function with an "unintern" of the corresponding lisp symbol. It seems to work OK, but I'm not 100% sure whether it's safe to do so. If one ends up deleting a symbol that is used elsewhere in expressions, then uninterning the symbol could lead to very funny situations: the next time the symbol gets created from a string, a new (interned) symbol would be created, leading to two distinct symbols with identical print names.

```
from sage.libs.ecl import ecl_eval
def ecl_symbols():
    return set(ecl_eval("""(let ((lst ())) (do-all-symbols (s lst) (push s lst)) lst)"""))
A = ecl_symbols()
while True:
   _= sin(x).simplify()
   B = ecl_symbols()
   print B.difference(A)
   A= B
```



---

Comment by mkoeppe created at 2020-08-08 17:49:39

This looks like the right fix to me. Perhaps this could be stress tested using sage-manifolds?


---

Comment by mkoeppe created at 2020-08-09 15:38:14

Changing status from new to needs_review.


---

Comment by slelievre created at 2020-09-08 00:55:33

Changing keywords from "" to "leak".


---

Comment by tscrim created at 2020-09-08 02:12:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-09-08 02:12:06

Changing priority from major to critical.


---

Comment by tscrim created at 2020-09-08 02:12:06

LGTM. Hopefully we can sneak this in to 9.2.


---

Comment by vbraun created at 2020-09-15 22:01:10

Resolution: fixed


---

Comment by egourgoulhon created at 2020-09-22 12:52:34

Replying to [comment:5 mkoeppe]:
> This looks like the right fix to me. Perhaps this could be stress tested using sage-manifolds?

FWIW, I've just checked it on the notebook https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb, which is quite CPU demanding. Everything is fine! Thanks.
