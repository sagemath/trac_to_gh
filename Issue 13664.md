# Issue 13664: Deal with hooked tp_* functions when using a debug build of Python

archive/issues_013664.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @vbraun simonking @jdemeyer\n\nKeywords: hook debug\n\nPython debug checks are confused by the fast tp_* functions we hook in integer.pyx and real_double.pyx\n\nIssue created by migration from https://trac.sagemath.org/ticket/13868\n\n",
    "created_at": "2012-12-27T15:03:00Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.6",
    "title": "Deal with hooked tp_* functions when using a debug build of Python",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13664",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
Assignee: GeorgSWeber

CC:  @vbraun simonking @jdemeyer

Keywords: hook debug

Python debug checks are confused by the fast tp_* functions we hook in integer.pyx and real_double.pyx

Issue created by migration from https://trac.sagemath.org/ticket/13868





---

archive/issue_comments_169002.json:
```json
{
    "body": "In fact, thats commented out:\n\n```\n        # This line is only needed if Python is compiled in debugging\n        # mode './configure --with-pydebug'. If that is the case a Python\n        # object has a bunch of debugging fields which are initialized\n        # with this macro. For speed reasons, we don't call it if Python\n        # is not compiled in debug mode. So uncomment the following line\n        # if you are debugging Python.\n\n        #PyObject_INIT(new, (<RichPyObject*>global_dummy_Integer).ob_type)\n```\n",
    "created_at": "2012-12-27T16:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169002",
    "user": "https://github.com/vbraun"
}
```

In fact, thats commented out:

```
        # This line is only needed if Python is compiled in debugging
        # mode './configure --with-pydebug'. If that is the case a Python
        # object has a bunch of debugging fields which are initialized
        # with this macro. For speed reasons, we don't call it if Python
        # is not compiled in debug mode. So uncomment the following line
        # if you are debugging Python.

        #PyObject_INIT(new, (<RichPyObject*>global_dummy_Integer).ob_type)
```




---

archive/issue_comments_169003.json:
```json
{
    "body": "I tried to uncomment both these lines in integer.pyx and real_double.pyx but this lead to segfaults when starting Sage.\n\nIf I prevent the use of the fast tp_*, Sage starts (although I get a TypeError in sage/libs/gen/late_import, I've not recompiled everything after rebuilding Python)\n\nSo this will need more work.",
    "created_at": "2012-12-27T16:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169003",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I tried to uncomment both these lines in integer.pyx and real_double.pyx but this lead to segfaults when starting Sage.

If I prevent the use of the fast tp_*, Sage starts (although I get a TypeError in sage/libs/gen/late_import, I've not recompiled everything after rebuilding Python)

So this will need more work.



---

archive/issue_comments_169004.json:
```json
{
    "body": "I found the bug, the `PyObject_INIT` was only called when a new integer / real object was created and not when a recycled object from the pool was used. You have to call it in both branches, of course. I'll work out a fix where the debug preprocessor macro is used to conditionally compile it in.",
    "created_at": "2012-12-27T22:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169004",
    "user": "https://github.com/vbraun"
}
```

I found the bug, the `PyObject_INIT` was only called when a new integer / real object was created and not when a recycled object from the pool was used. You have to call it in both branches, of course. I'll work out a fix where the debug preprocessor macro is used to conditionally compile it in.



---

archive/issue_comments_169005.json:
```json
{
    "body": "Attachment [trac_13868_tp_hooks_and_debug.patch](tarball://root/attachments/some-uuid/ticket13868/trac_13868_tp_hooks_and_debug.patch) by @vbraun created at 2012-12-28 11:54:30\n\nInitial patch",
    "created_at": "2012-12-28T11:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169005",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_13868_tp_hooks_and_debug.patch](tarball://root/attachments/some-uuid/ticket13868/trac_13868_tp_hooks_and_debug.patch) by @vbraun created at 2012-12-28 11:54:30

Initial patch



---

archive/issue_comments_169006.json:
```json
{
    "body": "Replying to [comment:3 vbraun]:\n> I found the bug, the `PyObject_INIT` was only called when a new integer / real object was created and not when a recycled object from the pool was used. You have to call it in both branches, of course. I'll work out a fix where the debug preprocessor macro is used to conditionally compile it in.\n\nI am a bit puzzled. Why is this only done when the debug preprocessor macro is used? Do you claim that this is a bug *only* in debug mode? Why could it not create trouble without debug mode?",
    "created_at": "2012-12-28T12:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169006",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:3 vbraun]:
> I found the bug, the `PyObject_INIT` was only called when a new integer / real object was created and not when a recycled object from the pool was used. You have to call it in both branches, of course. I'll work out a fix where the debug preprocessor macro is used to conditionally compile it in.

I am a bit puzzled. Why is this only done when the debug preprocessor macro is used? Do you claim that this is a bug *only* in debug mode? Why could it not create trouble without debug mode?



---

archive/issue_comments_169007.json:
```json
{
    "body": "Anyway, using your patch plus the new cython plus the latest version of the python spkg in debug mode, I am now able to start Sage without a crash. It \"only\" reports\n\n```\nImportError: /home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so: undefined symbol: _Z7_p_TestP8spolyrecP9sip_sringi\n```\n\nBut on #13867 you said that for this one needs a new Singular spkg (hopefully one that still allows for using xalloc!).",
    "created_at": "2012-12-28T12:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169007",
    "user": "https://github.com/simon-king-jena"
}
```

Anyway, using your patch plus the new cython plus the latest version of the python spkg in debug mode, I am now able to start Sage without a crash. It "only" reports

```
ImportError: /home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so: undefined symbol: _Z7_p_TestP8spolyrecP9sip_sringi
```

But on #13867 you said that for this one needs a new Singular spkg (hopefully one that still allows for using xalloc!).



---

archive/issue_comments_169008.json:
```json
{
    "body": "Replying to [comment:5 SimonKing]:\n> But on #13867 you said that for this one needs a new Singular spkg\n\nFound it! #13876, right?",
    "created_at": "2012-12-28T12:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169008",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 SimonKing]:
> But on #13867 you said that for this one needs a new Singular spkg

Found it! #13876, right?



---

archive/issue_comments_169009.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-12-28T13:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169009",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_169010.json:
```json
{
    "body": "Yes!",
    "created_at": "2012-12-28T13:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169010",
    "user": "https://github.com/vbraun"
}
```

Yes!



---

archive/issue_comments_169011.json:
```json
{
    "body": "With the patches listed at #13877, I get:\n\n```\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all.py:76: RuntimeWarning: tp_compare didn't return -1 or -2 for exception\n  import sage.symbolic.pynac\n---------------------------------------------------------------------------\nSystemError                               Traceback (most recent call last)\n\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/ipmaker.py in force_import(modname, force_reload)\n     61         reload(sys.modules[modname])\n     62     else:\n---> 63         __import__(modname)\n     64         \n     65 \n\n/home/simon/SAGE/debug/sage-5.5.rc0/local/bin/ipy_profile_sage.py in <module>()\n      5     preparser(True)\n      6     \n----> 7     import sage.all_cmdline\n      8     sage.all_cmdline._init_cmdline(globals())\n      9     \n\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all_cmdline.py in <module>()\n     12 try:\n     13 \n---> 14     from sage.all import *\n     15     from sage.calculus.predefined import x\n     16     preparser(on=True)\n\n/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all.py in <module>()\n     74 \n     75 # This must come before Calculus -- it initializes the Pynac library.\n---> 76 import sage.symbolic.pynac\n     77 \n     78 from sage.modules.all    import *\n\nSystemError: Objects/object.c:854: bad argument to internal function\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n```\n\nSo, tp_compare does something unexpected here.",
    "created_at": "2012-12-28T13:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169011",
    "user": "https://github.com/simon-king-jena"
}
```

With the patches listed at #13877, I get:

```
/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all.py:76: RuntimeWarning: tp_compare didn't return -1 or -2 for exception
  import sage.symbolic.pynac
---------------------------------------------------------------------------
SystemError                               Traceback (most recent call last)

/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/IPython/ipmaker.py in force_import(modname, force_reload)
     61         reload(sys.modules[modname])
     62     else:
---> 63         __import__(modname)
     64         
     65 

/home/simon/SAGE/debug/sage-5.5.rc0/local/bin/ipy_profile_sage.py in <module>()
      5     preparser(True)
      6     
----> 7     import sage.all_cmdline
      8     sage.all_cmdline._init_cmdline(globals())
      9     

/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all_cmdline.py in <module>()
     12 try:
     13 
---> 14     from sage.all import *
     15     from sage.calculus.predefined import x
     16     preparser(on=True)

/home/simon/SAGE/debug/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/all.py in <module>()
     74 
     75 # This must come before Calculus -- it initializes the Pynac library.
---> 76 import sage.symbolic.pynac
     77 
     78 from sage.modules.all    import *

SystemError: Objects/object.c:854: bad argument to internal function
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```

So, tp_compare does something unexpected here.



---

archive/issue_comments_169012.json:
```json
{
    "body": "Did you compile everything from scratch? You definitely need to recompile pynac with debugging, maybe more?",
    "created_at": "2012-12-28T13:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169012",
    "user": "https://github.com/vbraun"
}
```

Did you compile everything from scratch? You definitely need to recompile pynac with debugging, maybe more?



---

archive/issue_comments_169013.json:
```json
{
    "body": "I did sage -ba after installing all stuff on top of an existing sage-5.5.",
    "created_at": "2012-12-28T13:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169013",
    "user": "https://github.com/simon-king-jena"
}
```

I did sage -ba after installing all stuff on top of an existing sage-5.5.



---

archive/issue_comments_169014.json:
```json
{
    "body": "If you start on sage-5.5 you at least need the patch from #13740, maybe more...",
    "created_at": "2012-12-28T13:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169014",
    "user": "https://github.com/vbraun"
}
```

If you start on sage-5.5 you at least need the patch from #13740, maybe more...



---

archive/issue_comments_169015.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> If you start on sage-5.5 you at least need the patch from #13740, maybe more...\n\nI of course have that patch, since I have the new cython spkg from #13832.",
    "created_at": "2012-12-28T13:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169015",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:11 vbraun]:
> If you start on sage-5.5 you at least need the patch from #13740, maybe more...

I of course have that patch, since I have the new cython spkg from #13832.



---

archive/issue_comments_169016.json:
```json
{
    "body": "I don't know whether *indented* preprocessor directives like\n\n```\n#if ...\n    #define ...\n#endif\n```\n\nare standard C. Maybe they are (GCC accepts them and documents this), but usually this is written as\n\n```\n#if ...\n#define ...\n#endif\n```\n",
    "created_at": "2012-12-28T16:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169016",
    "user": "https://github.com/jdemeyer"
}
```

I don't know whether *indented* preprocessor directives like

```
#if ...
    #define ...
#endif
```

are standard C. Maybe they are (GCC accepts them and documents this), but usually this is written as

```
#if ...
#define ...
#endif
```




---

archive/issue_comments_169017.json:
```json
{
    "body": "Pre-ANSI C did not allow for space, but those compilers are long dead (even by skynet standards). Its legal in all C versions that will at least start building Sage. I prefer the Cython-style indentation, then you don't have to mentally switch when reading it.",
    "created_at": "2012-12-28T17:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169017",
    "user": "https://github.com/vbraun"
}
```

Pre-ANSI C did not allow for space, but those compilers are long dead (even by skynet standards). Its legal in all C versions that will at least start building Sage. I prefer the Cython-style indentation, then you don't have to mentally switch when reading it.



---

archive/issue_comments_169018.json:
```json
{
    "body": "It would be nice if we could review and merge this ticket as it is the cause for the segfault during Sage \"make\" with `SAGE_DEBUG=yes`",
    "created_at": "2013-01-04T11:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169018",
    "user": "https://github.com/vbraun"
}
```

It would be nice if we could review and merge this ticket as it is the cause for the segfault during Sage "make" with `SAGE_DEBUG=yes`



---

archive/issue_comments_169019.json:
```json
{
    "body": "Replying to [comment:15 vbraun]:\n> It would be nice if we could review and merge this ticket as it is the cause for the segfault during Sage \"make\" with `SAGE_DEBUG=yes`\n\nIs this still the case? With all the new spkgs mentioned in the ticket description of #13864 (in particular, with cython-0.17.4), sage builds and starts fine on bsd.math, with SAGE_DEBUG=yes. Or has that only been a problem on other systems?",
    "created_at": "2013-01-04T12:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169019",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:15 vbraun]:
> It would be nice if we could review and merge this ticket as it is the cause for the segfault during Sage "make" with `SAGE_DEBUG=yes`

Is this still the case? With all the new spkgs mentioned in the ticket description of #13864 (in particular, with cython-0.17.4), sage builds and starts fine on bsd.math, with SAGE_DEBUG=yes. Or has that only been a problem on other systems?



---

archive/issue_comments_169020.json:
```json
{
    "body": "Initial patch + typo fixed.",
    "created_at": "2013-01-04T13:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169020",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Initial patch + typo fixed.



---

archive/issue_comments_169021.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-04T13:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169021",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_169022.json:
```json
{
    "body": "Attachment [trac_13868_tp_hooks_and_debug-typo.patch](tarball://root/attachments/some-uuid/ticket13868/trac_13868_tp_hooks_and_debug-typo.patch) by jpflori created at 2013-01-04 13:18:48\n\nWorks fine and seems correct to me.\nI just added a missing u in some comment.",
    "created_at": "2013-01-04T13:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169022",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_13868_tp_hooks_and_debug-typo.patch](tarball://root/attachments/some-uuid/ticket13868/trac_13868_tp_hooks_and_debug-typo.patch) by jpflori created at 2013-01-04 13:18:48

Works fine and seems correct to me.
I just added a missing u in some comment.



---

archive/issue_events_013512.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2013-01-07T20:56:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13664#event-13512"
}
```



---

archive/issue_comments_169023.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-07T20:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13664",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13664#issuecomment-169023",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
