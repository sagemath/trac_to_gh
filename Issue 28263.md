# Issue 28263: py3: DeprecationWarning not visible from Cython

Issue created by migration from https://trac.sagemath.org/ticket/28500

Original creator: vdelecroix

Original creation time: 2019-09-15 13:50:21

CC:  @mwageringel jhpalmieri

Keywords: py3

In Sage built with Python 3 deprecation warnings raised from Cython code are not visible (in both the console or Jupyter notebook). However they are visible to the doctest runner!

Example from `sage/matroids/matroid.pyx`

```
sage: M = matroids.Uniform(2, 3).is_3connected(separation=True)
```

Example from `sage/matrix/matrix_integer_dense.pyx`

```
sage: M = matrix(2, [2,1,1,1])._invert_unit()
```


Here is an example from a Python file that works fine

```
sage: P = Permutations(4)
sage: x = P([3, 2, 4, 1]).has_left_descent(2, mult='l2r')
```



---

Comment by saraedum created at 2019-09-15 13:52:17

The problem is not Python 3 specific. Same with Python 2 (8.9.beta9.)


---

Comment by vdelecroix created at 2019-09-15 13:53:01

Changing priority from critical to blocker.


---

Comment by vdelecroix created at 2019-09-15 13:53:17

Changing keywords from "py3" to "".


---

Comment by saraedum created at 2019-09-15 13:56:16

Happens also with Sage 8.4, 8.6, 8.7, 8.8.

That's all the releases that we have new docker images for.


---

Comment by vdelecroix created at 2019-09-15 13:56:44

Ouch.


---

Comment by vdelecroix created at 2019-09-15 13:57:06

Deprecation works with inline Cython code

```
sage: cython("from sage.misc.superseded import deprecation; deprecation(28500, 'hello boy')")
/opt/sage/local/lib/python3.7/site-packages/sage/misc/cython.py:538: DeprecationWarning: hello boy
See https://trac.sagemath.org/28500 for details.
  m = cython_import(filename, **kwds)
```



---

Comment by vdelecroix created at 2019-09-15 13:58:09

But not inside a function

```
sage: cython("from sage.misc.superseded import deprecation\ndef f(): deprecation(28500, 'hello boy')")
sage: f()
```



---

Comment by saraedum created at 2019-09-15 14:09:05

Did this ever work? It's been broken since 8.4 at least, shamelessly using the opportunity to advertise #28457: https://gitlab-hooks-flau3jeaza-ew.a.run.app/status/trac/tag/8.4


---

Comment by @mwageringel created at 2019-09-15 20:58:55

Replying to [comment:8 saraedum]:
> Did this ever work?

It worked with 7.5.1 at least.


---

Comment by nbruin created at 2019-09-16 22:03:56

I'm not sure how to fix the problem, but the reason things fail is because cython functions don't create a stack frame. The deprecation mechanism tries to raise the warning referring to the stack frame of the call site. That's not there in this case! You can see that things work when you make sure that there is a call frame present:

```
sage: def g():
....:     return f()
....: 
sage: g()
/usr/local/sage/sage-git/src/bin/sage-ipython:1: DeprecationWarning: hello
See https://trac.sagemath.org/28500 for details.
  #!/usr/bin/env sage-python23
```

It goes back to the python "warning" system:

```
sage: cython("""
....: from warnings import warn
....: def cyW(s):
....:     warn("test",DeprecationWarning,stacklevel=s)
....: """)
```


```
sage: def pyW(s):
....:     warn("test",DeprecationWarning,stacklevel=s)
```


```
sage: def testW(c,s):
....:     if c=="cython":     
....:         cyW(s)
....:     else:
....:         pyW(s)
```

you'll see that `testW("python",3)` and `test("cython",2)` have the same result (that's at top level) and that `testW("python",4)` and `test("cython",3)` also have the same result (no warning printed, because the stack frame lookup failed). It could be considered a bug in python that `warn(..., stacklevel=...")` fails silently if the give stack level is too high.

I think the fix is that cython's "deprecation" should be a different one from python's; and should reduce its stacklevel by one from the value used in python.

There is also the problem that we shouldn't expect deprecation warnings to work properly when called from cython, but that's going to apply to all warnings.


---

Comment by jhpalmieri created at 2019-09-16 22:24:48

Is this related to #24755?


---

Comment by nbruin created at 2019-09-17 00:51:43

Replying to [comment:12 jhpalmieri]:
> Is this related to #24755?
I don't think so. The problem there does not seem to involve cython. Also, the reported example there has gone away: the file `piecewise_old.py` doesn't exist since the resolution of #26865. That ticket should probably update its example.


---

Comment by nbruin created at 2019-10-20 23:32:38

Tried to keep the changes minimal, to avoid merge conflicts. These are all mentions of "import deprecation" in `.pyx` files, according search_src.

If someone feels the urge to add documentation to `deprecation_cython` ... go ahead!
----
New commits:


---

Comment by nbruin created at 2019-10-20 23:32:38

Changing status from new to needs_review.


---

Comment by git created at 2019-10-22 00:00:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2019-10-22 00:10:42

So ... it turns out `IPython` is a bit to blame for the fact that we're not seeing the warning (meaning, there's no bug in python here). If we override the warning filters that IPython installs we see:

```
sage: cython("from sage.misc.superseded import deprecation\ndef f(): deprecation(28500, 'hello boy')")
sage: warnings.simplefilter("always")
sage: f()
/usr/local/sage/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878: DeprecationWarning: hello boy
See https://trac.sagemath.org/28500 for details.
  exec(code_obj, self.user_global_ns, self.user_ns)
```

What happens here is that `IPython` apparently hides warnings that appear to emanate from `IPython` code. Since we refer to the wrong callsite, we normally don't get to see the warning.


---

Comment by vdelecroix created at 2019-10-25 04:30:44

Not ideal to have these two functions `deprecation` and `deprecation_cython`. But at least, this is a fix.

You should add an explanation of the problem in the documentation or/and a reference to this ticket. Also I would make a reference to `deprecation_cython` in the documentation of `deprecation`.


---

Comment by vdelecroix created at 2019-10-25 04:30:44

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-10-25 04:31:14

Ideally, the doctest framework should detect when a deprecation from Cython code is wrong.


---

Comment by nbruin created at 2019-10-25 06:32:10

Replying to [comment:19 vdelecroix]:
> Ideally, the doctest framework should detect when a deprecation from Cython code is wrong.

Similar to the inserted doctest, you can catch raised deprecation warnings and investigate if they are referencing the right callsite. If you make sure you call the deprecated routine from a recognizable location you can check that the raised warning is referencing it. More particularly, if you want to make sure that deprecation warnings are not referring to one-level-too-high you could install in the doctest framework a warning filter [https://docs.python.org/3/library/warnings.html#overriding-the-default-filter](https://docs.python.org/3/library/warnings.html#overriding-the-default-filter) that generates an error rather than a warning.

For documentation: If you adapt it how you'd like it, I'm fine with it. I never know which bits of documentation get processed/placed where.


---

Comment by vbraun created at 2019-12-28 11:12:34

Changing priority from blocker to critical.


---

Comment by vbraun created at 2019-12-28 11:12:34

Definitely a bug that should be fixed, but not a blocker


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2021-07-18 17:13:48

Related: #32139


---

Comment by mkoeppe created at 2021-07-18 18:44:30

Rebased on #32139 (and 9.4.beta4). Many of the changed calls to deprecation had already disappeared
----
New commits:


---

Comment by git created at 2021-07-18 18:48:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-18 18:55:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-18 18:55:58

Many or all of the calls to `deprecation` that are updated in this ticket are already so old that the code can be removed. But that's best done in individual tickets


---

Comment by jhpalmieri created at 2021-07-21 04:21:59

I'm getting this (after merging with 9.4.beta5):

```
sage -t --warn-long 98.1 --random-seed=0 src/sage/misc/superseded.py
**********************************************************************
File "src/sage/misc/superseded.py", line 129, in sage.misc.superseded.deprecation_cython
Failed example:
    w1[0].filename == w3[0].filename
Expected:
    True
Got:
    False
```



---

Comment by git created at 2021-08-13 19:03:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-13 21:30:13

Replying to [comment:34 jhpalmieri]:
> I'm getting this (after merging with 9.4.beta5):
> {{{
> sage -t --warn-long 98.1 --random-seed=0 src/sage/misc/superseded.py
> **********************************************************************
> File "src/sage/misc/superseded.py", line 129, in sage.misc.superseded.deprecation_cython
> Failed example:
>     w1[0].filename == w3[0].filename
> Expected:
>     True
> Got:
>     False
> }}}

Yes, this doctest is only true interactively. Within the actual doctesting, printing out the filenames gives:

```
**********************************************************************
File "src/sage/misc/superseded.py", line 133, in sage.misc.superseded.deprecation_cython
Failed example:
    w1[0].filename
Expected nothing
Got:
    '<doctest sage.misc.superseded.deprecation_cython[2]>'
**********************************************************************
File "src/sage/misc/superseded.py", line 134, in sage.misc.superseded.deprecation_cython
Failed example:
    w2[0].filename
Expected nothing
Got:
    '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py'
**********************************************************************
File "src/sage/misc/superseded.py", line 135, in sage.misc.superseded.deprecation_cython
Failed example:
    w3[0].filename
Expected nothing
Got:
    '<doctest sage.misc.superseded.deprecation_cython[4]>'
**********************************************************************
```



---

Comment by mkoeppe created at 2021-08-13 21:32:41

(In the interactive shell, the results are:

```
sage: w1[0].filename 
sage: w2[0].filename 
sage: w3[0].filename 
....:                                                                                                                                                                        
'<ipython-input-1-816ba0309bb2>'
'/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py'
'<ipython-input-1-816ba0309bb2>'
```



---

Comment by git created at 2021-08-13 21:47:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-08-14 17:24:18

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-08-14 17:28:28

Thanks!


---

Comment by vbraun created at 2021-08-29 09:38:19

Resolution: fixed
