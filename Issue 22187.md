# Issue 22187: graph to_directed can have side effect when plotting

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2017-02-23 11:57:12

According to [this ask.sagemath question](https://ask.sagemath.org/question/36705/to_directed-affects-original-graph/), we have a very bizarre behavior for certain graphs:

```
G1=graphs.RandomGNP(5,0.5)
G1.plot(save_pos=True)
G2=G1.to_directed()
G2.delete_vertex(0)
G2.add_vertex(5)
G2.plot()
G1.plot()
```

gives

```
    485                 self._plot_components['vertex_labels'].append(text(str(v),
--> 486                     self._pos[v], rgbcolor=(0,0,0), zorder=8))

KeyError: 0
```

As if the zero vertex had been removed from `G1`.  Plotting only one of them does NOT cause the error, and doing anything else seems fine.  Reversing the order of the plotting gives `KeyError: 5` as if the 5 vertex had never been added - in both cases it is the _second_ plot which gives fits.


---

Comment by dcoudert created at 2017-02-23 15:41:56

Changing status from new to needs_review.


---

Comment by dcoudert created at 2017-02-23 15:41:56

In the `to_directed`method, we have:

```
        D = DiGraph(name           = self.name(),
                    pos            = self._pos,
                    multiedges     = self.allows_multiple_edges(),
                    loops          = self.allows_loops(),
                    implementation = implementation,
                    data_structure = (data_structure if data_structure!="static_sparse"
                                      else "sparse")) # we need a mutable copy
```

Hence, the dictionary `_pos` storing the positions of the vertices is the same.

This patch solves this issue passing a copy of the position dictionary.
----
New commits:


---

Comment by kcrisman created at 2017-02-23 17:07:26

Nice quick find.  This makes perfect sense - and I see why it didn't show up before!    Thanks.

You'll want to add some sort of doctest to verify that this is fixed.


---

Comment by kcrisman created at 2017-02-23 17:07:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-02-24 00:33:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-02-24 00:37:06

The problem reported in this patch is reproducible as:

```
sage: G1=graphs.Grid2RandomGNP(5,0.5)
sage: gp1 = G1.graphplot(save_pos=True)
sage: G2=G1.to_directed()
sage: G2.delete_vertex(0)
sage: G2.add_vertex(5)
sage: gp2 = G2.graphplot()
sage: gp1 = G1.graphplot()
```

So I added this test to the ticket rather than a `show` or `plot` call.


---

Comment by dcoudert created at 2017-02-24 00:37:06

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-02-27 09:06:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-02-27 09:31:02

Ready for review


---

Comment by jdemeyer created at 2017-02-27 09:34:42

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-02-27 09:34:42

Passing a copy to the `DiGraph` constructor is not the right fix.

Instead, `DiGraph` should not modify its input!


---

Comment by jdemeyer created at 2017-02-27 09:36:03

In other words: do not _work around_ the bug but _fix_ the bug instead.


---

Comment by git created at 2017-02-27 10:34:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-02-27 10:35:35

This should be a better way for both graphs and digraphs.


---

Comment by dcoudert created at 2017-02-27 16:47:01

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-03-03 17:23:05

Anyone to review this patch?


---

Comment by jdemeyer created at 2017-03-03 21:02:43

Two details:

1. there is some trailing whitespace in this patch.

2. why did you remove the plotting doctest in the last commit? Even if you changed the fix, you should keep that test.


---

Comment by git created at 2017-03-04 08:44:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-03-04 08:46:35

I have put back the plotting doctest and removed the trailing white space (always hard to find).


---

Comment by jdemeyer created at 2017-03-06 14:31:56

There is still trailing whitespace here:

```diff
+        The position dictionary is not the input one (:trac:`22424`)::
+
+            sage: my_pos = {0:(0,0), 1:(1,1)} <-----------------------------
+            sage: G = Graph([[0,1], [(0,1)]], pos=my_pos)
+            sage: my_pos == G._pos
+            True
+            sage: my_pos is G._pos
+            False
```



---

Comment by jdemeyer created at 2017-03-06 14:31:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-03-06 14:43:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2017-03-06 14:43:41

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-03-06 14:43:41

Sorry, removed.


---

Comment by jdemeyer created at 2017-03-06 16:15:58

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2017-03-06 16:18:37

Thank you.


---

Comment by vbraun created at 2017-03-08 18:45:54

Resolution: fixed
