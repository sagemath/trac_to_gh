# Issue 21921: Extraneous line for multiline output in Sage command line

Issue created by migration from Trac.

Original creator: klee

Original creation time: 2017-01-09 09:53:58

CC:  stakemori tscrim

To reproduce it, run Sage in the terminal and evaluate the following code. Extra blank lines are printed before outputs as below:


```
class Foo(object):

    def __repr__(self):
        return "foo"


class Bar(object):

    def __repr__(self):
        return "bar\nbar"


sage: identity_matrix(QQ, 2)

[1 0]
[0 1]
sage: Foo()
foo
sage: Bar()

bar
bar
```


This was first discussed in https://groups.google.com/forum/#!topic/sage-devel/AYYaUb_9kjw


---

Comment by klee created at 2017-01-09 09:57:04

The related upstream discussion is in https://github.com/ipython/ipython/issues/10138


---

Comment by stakemori created at 2017-01-09 12:14:36

Thank you. I will try to make a patch this weekend.


---

Comment by klee created at 2017-01-09 14:36:39

Replying to [comment:3 stakemori]:
> Thank you. I will try to make a patch this weekend.

Did you see the comment posted in the upstream discussion? We may think that the bug is in IPython than in Sage. So we need a patch for IPython. You may submit a pull request of the patch to IPython Github repo.


---

Comment by klee created at 2017-01-09 17:08:06

Fixed upstream in https://github.com/ipython/ipython/pull/10146


---

Comment by stakemori created at 2017-01-10 09:09:47

Replying to [comment:4 klee]:

I saw the pull request. This has been fixed in IPython. But I think this can be fixed immediately in Sage (how long will it take before the fix will be merged into Sage?). Right now I have a fever, so I avoid coding.


---

Comment by klee created at 2017-01-10 19:56:13

It will take some time for the fix in the upstream eventually to get into a release of Sage. For the impatient, copy and paste the following to replace the code for `write_output_prompt` method in `sage/local/lib/python/site-packages/IPython/terminal`.


```
    def write_output_prompt(self):
        sys.stdout.write(self.shell.separate_out)
        # If we're not displaying a prompt, it effectively ends with a newline,
        # because the output will be left-aligned.
        self.prompt_end_newline = True

        if self.do_full_cache:
            tokens = self.shell.prompts.out_prompt_tokens()
            prompt_txt = ''.join(s for t, s in tokens)
            if prompt_txt and not prompt_txt.endswith('\n'):
                # Ask for a newline before multiline output
                self.prompt_end_newline = False

            if self.shell.pt_cli:
                self.shell.pt_cli.print_tokens(tokens)
            else:
                sys.stdout.write(prompt_txt) 
```



---

Comment by stakemori created at 2017-01-10 21:49:10

>  For the impatient, copy and paste the following to replace the code for write_output_prompt method in sage/local/lib/python/site-packages/IPython/terminal.

The method `write_output_prompt` of the class `RichPromptDisplayHook` in `$SAGE_ROOT/local/lib/python/site-packages/IPython/terminal/prompts.py` more precisely.


---

Comment by tscrim created at 2017-01-11 08:15:48

We can just patch Sage's IPython in the meantime. This is the fastest fix, as we have to wait for the next version of IPython with the PR included.

I doubt Volker will let this ticket get into the 7.5 release though. :/


---

Comment by jdemeyer created at 2017-01-11 08:24:47

Replying to [comment:9 tscrim]:
> as we have to wait for the next version of IPython with the PR included.

That would be a pity for such an important major bug like this one ;-)


---

Comment by stakemori created at 2017-01-14 02:47:44

I made a patch for this problem. I think the attribute `prompt_end_newline` should be always true.
https://gist.github.com/stakemori/68f42ba2f9ac6f6d581e9525c1c41e07


---

Comment by klee created at 2017-01-14 08:23:53

Your patch will be redundant once the next release of IPython is incorporated to Sage. Note that the upstream patch was back ported to the current release, which means, I guess, that the fixed IPython would be available in Sage sooner than usual.

Your patch can be used as an (alternative) temporary measure to fix the issue, but should not be merged to Sage.


---

Comment by klee created at 2018-01-31 01:53:01

Changing status from new to needs_review.


---

Comment by klee created at 2018-01-31 01:53:01

As Sage's IPython was updated to version 5.5, this issue is now fixed. Nice!


---

Comment by tscrim created at 2018-01-31 02:42:10

Indeed!


---

Comment by tscrim created at 2018-01-31 02:42:10

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-05-18 17:16:26

closing positively reviewed duplicates


---

Comment by vdelecroix created at 2018-05-18 17:16:26

Resolution: wontfix
