# Issue 14400: Don't sort files by (previous) doctest running time (which is wall time!) by default

archive/issues_014400.json:
```json
{
    "body": "Assignee: roed\n\nKeywords: ptestlong timeout time-out timed\n\nDoing so is just pretty stupid, because if doctesting file A, B, C took very long (or even timed out) *because A, B, C eat up quite a lot of resources* (e.g. memory, or do heavy I/O), running them *simultaneously* next time will just worsen the situation.  (This of course applies to parallel doctesting only, i.e., when `SAGE_NUM_THREADS` >1.)\n\nAlso, files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14604\n\n",
    "created_at": "2013-05-17T12:55:48Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "title": "Don't sort files by (previous) doctest running time (which is wall time!) by default",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14400",
    "user": "leif"
}
```
Assignee: roed

Keywords: ptestlong timeout time-out timed

Doing so is just pretty stupid, because if doctesting file A, B, C took very long (or even timed out) *because A, B, C eat up quite a lot of resources* (e.g. memory, or do heavy I/O), running them *simultaneously* next time will just worsen the situation.  (This of course applies to parallel doctesting only, i.e., when `SAGE_NUM_THREADS` >1.)

Also, files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.


Issue created by migration from https://trac.sagemath.org/ticket/14604





---

archive/issue_comments_182049.json:
```json
{
    "body": "If at all, \"long\" and \"short\" tests should get *mixed*, i.e., run at the same time.",
    "created_at": "2013-05-17T12:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182049",
    "user": "leif"
}
```

If at all, "long" and "short" tests should get *mixed*, i.e., run at the same time.



---

archive/issue_comments_182050.json:
```json
{
    "body": "Replying to [ticket:14604 leif]:\n> files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.\nReally? Why would that cause I/O peaks? Sage is imported before forking.",
    "created_at": "2013-05-17T14:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182050",
    "user": "jdemeyer"
}
```

Replying to [ticket:14604 leif]:
> files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.
Really? Why would that cause I/O peaks? Sage is imported before forking.



---

archive/issue_comments_182051.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Replying to [ticket:14604 leif]:\n> > files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.\n> Really? Why would that cause I/O peaks? Sage is imported before forking.\n\nWell, meanwhile (with the new doctesting framework), at least the terminal (and the logfile) gets flooded ... :-)\n\nBesides that, as far as I know, not everything a doctest may use gets imported in advance.  (And doctests still have to get extracted from the sources, don't they?)",
    "created_at": "2013-05-17T15:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182051",
    "user": "leif"
}
```

Replying to [comment:2 jdemeyer]:
> Replying to [ticket:14604 leif]:
> > files that take only fractions of a second to test will all be doctested at the same time (i.e., last), which in turn causes undesirable I/O peaks.
> Really? Why would that cause I/O peaks? Sage is imported before forking.

Well, meanwhile (with the new doctesting framework), at least the terminal (and the logfile) gets flooded ... :-)

Besides that, as far as I know, not everything a doctest may use gets imported in advance.  (And doctests still have to get extracted from the sources, don't they?)



---

archive/issue_comments_182052.json:
```json
{
    "body": "The standard lore for \"bag of tasks\" parallelism is to do the long ones first and then backfill with the shorter tasks. Its true that this might cause memory issues if long-running = lots of memory consumption task. But I'm not sure thats true in the Sage library, some doctests are just slow because they sleep (e.g. to test alarm).",
    "created_at": "2013-05-18T22:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182052",
    "user": "vbraun"
}
```

The standard lore for "bag of tasks" parallelism is to do the long ones first and then backfill with the shorter tasks. Its true that this might cause memory issues if long-running = lots of memory consumption task. But I'm not sure thats true in the Sage library, some doctests are just slow because they sleep (e.g. to test alarm).



---

archive/issue_comments_182053.json:
```json
{
    "body": "Replying to [comment:4 vbraun]:\n> The standard lore for \"bag of tasks\" parallelism is to do the long ones first and then backfill with the shorter tasks.\n\nNobody would schedule tasks blindly by just *wall time they once took* (for whatever, ignored reason), at least not if they use the same set of other resources, hence can't run independently of each other.\n \n> Its true that this might cause memory issues if long-running = lots of memory consumption task. But I'm not sure thats true in the Sage library\n\nIt *is* true, although not in the sense of a one-to-one correspondence (and gets even worse because a few people seem pretty ignorant concerning memory consumption or runtime -- or both at the same time -- of [long] doctests); just try...\n\n\n\n\n> some doctests are just slow because they sleep (e.g. to test alarm).\n\nThat's not the problem.  (They shouldn't sleep for minutes; some *appear* to do so though...)\n\n\n\n\nNote also that a couple of doctests use more than one thread (or, more precisely, process); running these simultaneously is especially bad (also w.r.t. memory consumption or more generally, access), at least if they already tend to take longer because of that.\n\nThe only benefit of sorting doctests by wall time (on rather resource-unlimited machines) is that some rare, broken tests that idle most of the time (like `sandpile.py` on some systems) get started early such that the overall test time (again wall time) might decrease; on such systems, one should explicitly ask for doing so.  And this of course only works if the sysload is almost constant during testing. \n\nCurrently, there's not even an option to *disable* this.  (One has to search and delete the rather hidden timings of previous tests.)",
    "created_at": "2013-05-19T00:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182053",
    "user": "leif"
}
```

Replying to [comment:4 vbraun]:
> The standard lore for "bag of tasks" parallelism is to do the long ones first and then backfill with the shorter tasks.

Nobody would schedule tasks blindly by just *wall time they once took* (for whatever, ignored reason), at least not if they use the same set of other resources, hence can't run independently of each other.
 
> Its true that this might cause memory issues if long-running = lots of memory consumption task. But I'm not sure thats true in the Sage library

It *is* true, although not in the sense of a one-to-one correspondence (and gets even worse because a few people seem pretty ignorant concerning memory consumption or runtime -- or both at the same time -- of [long] doctests); just try...




> some doctests are just slow because they sleep (e.g. to test alarm).

That's not the problem.  (They shouldn't sleep for minutes; some *appear* to do so though...)




Note also that a couple of doctests use more than one thread (or, more precisely, process); running these simultaneously is especially bad (also w.r.t. memory consumption or more generally, access), at least if they already tend to take longer because of that.

The only benefit of sorting doctests by wall time (on rather resource-unlimited machines) is that some rare, broken tests that idle most of the time (like `sandpile.py` on some systems) get started early such that the overall test time (again wall time) might decrease; on such systems, one should explicitly ask for doing so.  And this of course only works if the sysload is almost constant during testing. 

Currently, there's not even an option to *disable* this.  (One has to search and delete the rather hidden timings of previous tests.)



---

archive/issue_comments_182054.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> The only benefit of sorting doctests by wall time (on rather resource-unlimited machines) is that some rare, broken tests that idle most of the time (like `sandpile.py` on some systems) get started early such that the overall test time (again wall time) might decrease;\n\nIf you have multiple of such tests and start all these first, the effect is of course again *counter-productive*, as then the machine will first idle most of the time, afterwards running all \"busy\" ones together.",
    "created_at": "2013-05-19T00:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182054",
    "user": "leif"
}
```

Replying to [comment:5 leif]:
> The only benefit of sorting doctests by wall time (on rather resource-unlimited machines) is that some rare, broken tests that idle most of the time (like `sandpile.py` on some systems) get started early such that the overall test time (again wall time) might decrease;

If you have multiple of such tests and start all these first, the effect is of course again *counter-productive*, as then the machine will first idle most of the time, afterwards running all "busy" ones together.



---

archive/issue_comments_182055.json:
```json
{
    "body": "Running doctests sorted by walltime is most useful when you're just doctesting one folder: imagine you have two processes, one task that takes 100 seconds and 10 tasks that take 10 seconds.  You certainly want to start the 100 second task first.\n\nIn the case of the whole Sage library, I would like to see some data from different machines on whether sorting the tasks is good, bad or neutral.\n\nAdding an option to disable the sorting is certainly reasonable if there are cases where it's counterproductive.  What the default should be is another matter.",
    "created_at": "2013-05-19T16:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182055",
    "user": "roed"
}
```

Running doctests sorted by walltime is most useful when you're just doctesting one folder: imagine you have two processes, one task that takes 100 seconds and 10 tasks that take 10 seconds.  You certainly want to start the 100 second task first.

In the case of the whole Sage library, I would like to see some data from different machines on whether sorting the tasks is good, bad or neutral.

Adding an option to disable the sorting is certainly reasonable if there are cases where it's counterproductive.  What the default should be is another matter.



---

archive/issue_comments_182056.json:
```json
{
    "body": "Agree, there may be better ways to sort. But not sorting is crap.",
    "created_at": "2013-05-19T16:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182056",
    "user": "vbraun"
}
```

Agree, there may be better ways to sort. But not sorting is crap.



---

archive/issue_comments_182057.json:
```json
{
    "body": "Replying to [comment:8 vbraun]:\n> Agree, there may be better ways to sort. But not sorting is crap.\n\nWell, you at least get a \"natural\" mixture when not sorting at all (and hence better results *on average*<sup>TM</sup>).\n\n(IIRC, not sure whether that's still true for the new doctesting framework, but even when doing e.g. `sage -t file1 file2 ...` the files got reordered, not necessarily by previous doctest time.)",
    "created_at": "2013-05-19T17:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182057",
    "user": "leif"
}
```

Replying to [comment:8 vbraun]:
> Agree, there may be better ways to sort. But not sorting is crap.

Well, you at least get a "natural" mixture when not sorting at all (and hence better results *on average*<sup>TM</sup>).

(IIRC, not sure whether that's still true for the new doctesting framework, but even when doing e.g. `sage -t file1 file2 ...` the files got reordered, not necessarily by previous doctest time.)



---

archive/issue_comments_182058.json:
```json
{
    "body": "P.S.:  Cf. the discussion at #2695.",
    "created_at": "2013-05-19T17:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14400",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14400#issuecomment-182058",
    "user": "leif"
}
```

P.S.:  Cf. the discussion at #2695.
