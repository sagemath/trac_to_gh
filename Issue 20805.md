# Issue 20805: Contour plot of zero fails with rich representation warning

Issue created by migration from https://trac.sagemath.org/ticket/21042

Original creator: paulmasson

Original creation time: 2016-07-18 01:40:48

CC:  mjo

Attempting the contour plot


```
var('x y')
contour_plot(0, (x,-1,1), (y,-1,1))
```


does not show a plot and fails with the error


```
/home/sc_serv/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:590: RichReprWarning: Exception in _rich_repr_ while displaying object: zero-size array to reduction operation minimum which has no identity
  RichReprWarning,

Graphics object consisting of 1 graphics primitive
```


Contour plots of nonzero values display as expected


---

Comment by mjo created at 2021-07-26 19:34:09

It's not just the zero function, something else weird is going on here. This produces the line `x=y` like you'd expect:


```
contour_plot(x-y, (0,1), (0,1), contours=[0], fill=False)
```


But then this produces... nothing:


```
contour_plot(abs(x-y), (0,1), (0,1), contours=[0], fill=False)
```


Even though it should be the same plot. Which is weird, but not as weird as being able to fix it with...


```
contour_plot(abs(x-y)-0.000001, (0,1), (0,1), contours=[0], fill=False)
```


which gives you (roughly) the plot of `x=y` again.


---

Comment by slelievre created at 2021-07-26 20:19:20

I think contour plot and implicit plot work by detecting
sign changes to know where something vanishes.

So no surprise they don't work well with absolute values
and squares of some quantities even though those have
the same vanishing loci.


---

Comment by slelievre created at 2021-07-26 20:24:46

It would make sense to document that and add examples.


---

Comment by mjo created at 2021-08-07 01:04:07

Actually... I don't think matplotlib expects `levels` (our `contours`) to contain only one element. We can probably fix this by using `contours=[-epsilon, epsilon]` instead of `contours=[0]`, which does who-knows-what under the hood.


---

Comment by mjo created at 2021-08-07 02:50:14

Update: using `contours=[-epsilon, epsilon]` doesn't break any existing implicit plots, but how good it looks depends on `epsilon` and the function you're plotting. Some functions require a lot more plot points for a given epsilon, or a smaller xrange and yrange.

I wonder if there's a cheap heuristic we could use instead of a fixed tolerance.


---

Comment by mjo created at 2021-10-08 01:43:16

Changing status from new to needs_review.


---

Comment by mjo created at 2021-10-08 01:43:16

This heuristic is real hacky, but it can only improve things; and the important part is that we now warn the user anyway.
----
New commits:


---

Comment by git created at 2021-10-08 01:46:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-12-03 10:38:45

Do we want this in? The milestone was off...


---

Comment by dimpase created at 2021-12-03 10:55:32

OK, looks good


---

Comment by dimpase created at 2021-12-03 10:55:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-12 15:09:03

Resolution: fixed


---

Comment by chapoton created at 2021-12-13 17:58:57

This has broken our linter, by using a bad comparison to False.


---

Comment by slelievre created at 2021-12-14 18:37:31

Replying to [comment:12 chapoton]:
> This has broken our linter, by using a bad comparison to False.

See follow-up ticket for that at #33021.
