# Issue 30628: sage_bootstrap: Implement system package tools

archive/issues_030628.json:
```json
{
    "body": "CC:  @seblabbe @tobiasdiez @slel @jhpalmieri @vbraun\n\n(from #29146, #30861)\n\nThere are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:\n- `build/bin/write_dockerfile.sh`\n- `build/bin/sage-get-system-packages`\n- `tox.ini` (for `local-homebrew`, `local-conda`)\n- `.github/workflows/ci-wsl.yml` (using powershell)\n\nThe purpose of this ticket is to refactor it by reimplementing it as a new Python module of the `sage_bootstrap` package.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30865\n\n",
    "created_at": "2020-11-04T22:01:05Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "sage_bootstrap: Implement system package tools",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30628",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @seblabbe @tobiasdiez @slel @jhpalmieri @vbraun

(from #29146, #30861)

There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:
- `build/bin/write_dockerfile.sh`
- `build/bin/sage-get-system-packages`
- `tox.ini` (for `local-homebrew`, `local-conda`)
- `.github/workflows/ci-wsl.yml` (using powershell)

The purpose of this ticket is to refactor it by reimplementing it as a new Python module of the `sage_bootstrap` package.

Issue created by migration from https://trac.sagemath.org/ticket/30865





---

archive/issue_comments_437288.json:
```json
{
    "body": "Developers interested in improving the system package advice may want to work on this ticket",
    "created_at": "2020-11-05T18:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437288",
    "user": "https://github.com/mkoeppe"
}
```

Developers interested in improving the system package advice may want to work on this ticket



---

archive/issue_comments_437289.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-11-19T18:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437289",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_437290.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-19T20:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437291.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-19T20:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437292.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-19T20:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437292",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_437293.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-19T20:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437294.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-11-19T20:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437294",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review



---

archive/issue_comments_437295.json:
```json
{
    "body": "The current branch is doing this:\n\n```diff\n-    def download_cls(self, package_name_or_class):\n+    def download_cls(self, package_name_or_class, allow_upstream=False):\n```\n\nSo should the change I made in #30648 be reverted then?\n\n(I recall that the problem fixed in #30648 was that `download_cls` method had no argument `allow_upstream` where `download` method did, so I changed `download_cls` to `download`. But at the time, I was wondering if that was the good fix. Because another fix could have been to add the `allow_upstream` argument to the `download_cls` method which you are doing in this branch)",
    "created_at": "2020-11-22T09:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437295",
    "user": "https://github.com/seblabbe"
}
```

The current branch is doing this:

```diff
-    def download_cls(self, package_name_or_class):
+    def download_cls(self, package_name_or_class, allow_upstream=False):
```

So should the change I made in #30648 be reverted then?

(I recall that the problem fixed in #30648 was that `download_cls` method had no argument `allow_upstream` where `download` method did, so I changed `download_cls` to `download`. But at the time, I was wondering if that was the good fix. Because another fix could have been to add the `allow_upstream` argument to the `download_cls` method which you are doing in this branch)



---

archive/issue_comments_437296.json:
```json
{
    "body": "Doing `+=` on lists creates a new list in memory as opposed to `append` or `extend`:\n\n```\nsage: L = list(range(10))                                                       \nsage: K = list('abcd')                                                          \nsage: id(L)                                                                     \n140556349258880\nsage: id(L+K)                                                                   \n140556349147776\nsage: L.extend(K)                                                               \nsage: id(L)                                                                     \n140556349258880\n```\nSo using `+=` to append elements to a list uses a quadratic amount of memory until the garbage collector gets called.\n\nSo I would suggest the following change:\n\n```diff\n- self.names += [package_name_or_class]\n+ self.names.append(package_name_or_class)\n```\n\nas well as (5 times):\n\n```diff\n- self.names += [pkg.name for pkg in Package.all() if predicate(pkg)]\n+ self.names.extend(pkg.name for pkg in Package.all() if predicate(pkg))\n```",
    "created_at": "2020-11-22T09:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437296",
    "user": "https://github.com/seblabbe"
}
```

Doing `+=` on lists creates a new list in memory as opposed to `append` or `extend`:

```
sage: L = list(range(10))                                                       
sage: K = list('abcd')                                                          
sage: id(L)                                                                     
140556349258880
sage: id(L+K)                                                                   
140556349147776
sage: L.extend(K)                                                               
sage: id(L)                                                                     
140556349258880
```
So using `+=` to append elements to a list uses a quadratic amount of memory until the garbage collector gets called.

So I would suggest the following change:

```diff
- self.names += [package_name_or_class]
+ self.names.append(package_name_or_class)
```

as well as (5 times):

```diff
- self.names += [pkg.name for pkg in Package.all() if predicate(pkg)]
+ self.names.extend(pkg.name for pkg in Package.all() if predicate(pkg))
```



---

archive/issue_comments_437297.json:
```json
{
    "body": "I will try the branch later today, and come back with further comments if I have.",
    "created_at": "2020-11-22T09:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437297",
    "user": "https://github.com/seblabbe"
}
```

I will try the branch later today, and come back with further comments if I have.



---

archive/issue_comments_437298.json:
```json
{
    "body": "Replying to [comment:16 slabbe]:\n> The current branch is doing this:\n> \n> ```\n> #!diff\n> -    def download_cls(self, package_name_or_class):\n> +    def download_cls(self, package_name_or_class, allow_upstream=False):\n> ```\n> \n> So should the change I made in #30648 be reverted then?\n\n\nYes, in fact I have already reverted it as part of the branch on this ticket.",
    "created_at": "2020-11-22T20:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437298",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:16 slabbe]:
> The current branch is doing this:
> 
> ```
> #!diff
> -    def download_cls(self, package_name_or_class):
> +    def download_cls(self, package_name_or_class, allow_upstream=False):
> ```
> 
> So should the change I made in #30648 be reverted then?


Yes, in fact I have already reverted it as part of the branch on this ticket.



---

archive/issue_comments_437299.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-22T20:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437299",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437300.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> Yes, in fact I have already reverted it as part of the branch on this ticket.\n\n\nOk, yes, I agree. Since #30648 is not in sage yet, this is why I don't see it in the diff.",
    "created_at": "2020-11-23T08:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437300",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:19 mkoeppe]:
> Yes, in fact I have already reverted it as part of the branch on this ticket.


Ok, yes, I agree. Since #30648 is not in sage yet, this is why I don't see it in the diff.



---

archive/issue_comments_437301.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-23T09:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437301",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_437302.json:
```json
{
    "body": "> (cd build && tox)\n\n\nI did that. It finishes with a big list of typos and says that there were errors while running the tests. When I scroll back, I can't see the errors, because the typos takes all of the lines in the finite history of the terminal. Are the output of tox logged somewhere?\n\nI find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.\n\n(0) I confirm that `sage --package list` works with inputs such as \n`--has-file=spkg-configure.m4`, `--has-file=distros/debian.txt`, `--has-file=SPKG.rst`. Also `sage --package download` works. Also `make download` works.\n\nSorry, I still have few more comments listed below.\n\n(1) When I read the documentation of `sage --package`, I don't know what `Sage Bootstrap Library` means. I suggest to add a sentence in the file `sage_bootstrap.cmdline.py` to explain it. Something as follows, but please replace the verb `deal` with any more precise verb:\n\n```diff\n description = \\\n \"\"\"\n Sage Bootstrap Library\n+\n+It deals with all of the packages in SageMath.\n \"\"\"\n```\n\n(2) I don't like the following error message:\n\n```\n$ sage --package list :standardd:\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/bin/sage-package\", line 42, in <module>\n    run()\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/cmdline.py\", line 306, in run\n    app.list_cls(*args.package_class, has_files=args.has_files)\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/app.py\", line 69, in list_cls\n    pc = PackageClass(*package_classes, **filters)\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/expand_class.py\", line 48, in __init__\n    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\nValueError: ('Package name cannot start with \":\", got %s', ':standardd:')\n```\n\nIt tells me the input cannot start with \":\", but this is false, as `:standard:` is accepted.\n\nThus, I would suggest the following change in `sage_bootstrap/expand_class.py`:\n\n```diff\n             else:\n-                if package_name_or_class.startswith(':'):\n-                    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\n-                if package_name_or_class.endswith(':'):\n-                    raise ValueError('Package name cannot end with \":\", got %s', package_name_or_class)\n+                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):\n+                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)\n                 self.names.append(package_name_or_class)\n```\n\nQuestion: do you confirm that the following is a desirable feature?\n\n```\n$ sage --package list pari\npari\n```\n\n(3) Finally, in `build/sage_bootstrap/package.py`, I suggest:\n\n```diff\n-        if pattern:\n-            return self.tarball_pattern.replace('VERSION', self.version)\n+        if pattern:\n+            return pattern.replace('VERSION', self.version)\n```\n\n(4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?\n\nI am currently waiting for the report of `make ptestlong`.",
    "created_at": "2020-11-23T09:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437302",
    "user": "https://github.com/seblabbe"
}
```

> (cd build && tox)


I did that. It finishes with a big list of typos and says that there were errors while running the tests. When I scroll back, I can't see the errors, because the typos takes all of the lines in the finite history of the terminal. Are the output of tox logged somewhere?

I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.

(0) I confirm that `sage --package list` works with inputs such as 
`--has-file=spkg-configure.m4`, `--has-file=distros/debian.txt`, `--has-file=SPKG.rst`. Also `sage --package download` works. Also `make download` works.

Sorry, I still have few more comments listed below.

(1) When I read the documentation of `sage --package`, I don't know what `Sage Bootstrap Library` means. I suggest to add a sentence in the file `sage_bootstrap.cmdline.py` to explain it. Something as follows, but please replace the verb `deal` with any more precise verb:

```diff
 description = \
 """
 Sage Bootstrap Library
+
+It deals with all of the packages in SageMath.
 """
```

(2) I don't like the following error message:

```
$ sage --package list :standardd:
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/cmdline.py", line 306, in run
    app.list_cls(*args.package_class, has_files=args.has_files)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/app.py", line 69, in list_cls
    pc = PackageClass(*package_classes, **filters)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/expand_class.py", line 48, in __init__
    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
ValueError: ('Package name cannot start with ":", got %s', ':standardd:')
```

It tells me the input cannot start with ":", but this is false, as `:standard:` is accepted.

Thus, I would suggest the following change in `sage_bootstrap/expand_class.py`:

```diff
             else:
-                if package_name_or_class.startswith(':'):
-                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
-                if package_name_or_class.endswith(':'):
-                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
+                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
+                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
                 self.names.append(package_name_or_class)
```

Question: do you confirm that the following is a desirable feature?

```
$ sage --package list pari
pari
```

(3) Finally, in `build/sage_bootstrap/package.py`, I suggest:

```diff
-        if pattern:
-            return self.tarball_pattern.replace('VERSION', self.version)
+        if pattern:
+            return pattern.replace('VERSION', self.version)
```

(4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?

I am currently waiting for the report of `make ptestlong`.



---

archive/issue_comments_437303.json:
```json
{
    "body": "The `make ptestlong` finished with:\n\n```\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault\n----------------------------------------------------------------------\n```\nwhich is unrelated to this ticket.",
    "created_at": "2020-11-23T09:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437303",
    "user": "https://github.com/seblabbe"
}
```

The `make ptestlong` finished with:

```
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```
which is unrelated to this ticket.



---

archive/issue_comments_437304.json:
```json
{
    "body": "Replying to [comment:25 slabbe]:\n> The `make ptestlong` finished with:\n> \n> ```\n> ----------------------------------------------------------------------\n> sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault\n> ----------------------------------------------------------------------\n> ```\n> which is unrelated to this ticket.\n\n\nIndeed that is different, and tracked at #30945.",
    "created_at": "2020-11-23T11:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437304",
    "user": "https://github.com/slel"
}
```

Replying to [comment:25 slabbe]:
> The `make ptestlong` finished with:
> 
> ```
> ----------------------------------------------------------------------
> sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
> ----------------------------------------------------------------------
> ```
> which is unrelated to this ticket.


Indeed that is different, and tracked at #30945.



---

archive/issue_comments_437305.json:
```json
{
    "body": "Replying to [comment:24 slabbe]:\n> > (cd build && tox)\n\n> \n> I did that. It finishes with a big list of typos \n\n\nIf it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.\n\n> Are the output of tox logged somewhere?\n\n\nYes, it creates a subdirectory `.tox`, where you'll find logs.",
    "created_at": "2020-11-23T18:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437305",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 slabbe]:
> > (cd build && tox)

> 
> I did that. It finishes with a big list of typos 


If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.

> Are the output of tox logged somewhere?


Yes, it creates a subdirectory `.tox`, where you'll find logs.



---

archive/issue_comments_437306.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-23T19:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437306",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437307.json:
```json
{
    "body": "Replying to [comment:24 slabbe]:\n> I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.\n\n\nI agree. I have now made a change to eliminate this (unexplained) terminology from user-facing messages.  But I haven't changed the class name `PackageClass` or argument names, to keep the diff small.",
    "created_at": "2020-11-23T19:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437307",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 slabbe]:
> I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.


I agree. I have now made a change to eliminate this (unexplained) terminology from user-facing messages.  But I haven't changed the class name `PackageClass` or argument names, to keep the diff small.



---

archive/issue_comments_437308.json:
```json
{
    "body": "Replying to [comment:24 slabbe]:\n> (4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?\n\n\nThis is referring to https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types",
    "created_at": "2020-11-23T19:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437308",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 slabbe]:
> (4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?


This is referring to https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types



---

archive/issue_comments_437309.json:
```json
{
    "body": "Replying to [comment:24 slabbe]:\n> I would suggest the following change in `sage_bootstrap/expand_class.py`:\n> \n> \n> ```\n> #!diff\n>              else:\n> -                if package_name_or_class.startswith(':'):\n> -                    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\n> -                if package_name_or_class.endswith(':'):\n> -                    raise ValueError('Package name cannot end with \":\", got %s', package_name_or_class)\n> +                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):\n> +                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)\n>                  self.names.append(package_name_or_class)\n> ```\n\n\nI have made a similar change in the above commit.\n\n> Question: do you confirm that the following is a desirable feature?\n> \n> ```\n> $ sage --package list pari\n> pari\n> ```\n\n\nYes, this is a feature, and the above commit documents it.",
    "created_at": "2020-11-23T19:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437309",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 slabbe]:
> I would suggest the following change in `sage_bootstrap/expand_class.py`:
> 
> 
> ```
> #!diff
>              else:
> -                if package_name_or_class.startswith(':'):
> -                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
> -                if package_name_or_class.endswith(':'):
> -                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
> +                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
> +                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
>                  self.names.append(package_name_or_class)
> ```


I have made a similar change in the above commit.

> Question: do you confirm that the following is a desirable feature?
> 
> ```
> $ sage --package list pari
> pari
> ```


Yes, this is a feature, and the above commit documents it.



---

archive/issue_comments_437310.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-23T19:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437310",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437311.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-23T19:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437311",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_437312.json:
```json
{
    "body": "Replying to [comment:28 mkoeppe]:\n> If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.\n\n\nWell, I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. So, your guess is right, that was after the run of `sage -tox`.\n \n> > Are the output of tox logged somewhere?\n\n> \n> Yes, it creates a subdirectory `.tox`, where you'll find logs.\n\n\nGreat. Thank you.",
    "created_at": "2020-11-23T21:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437312",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:28 mkoeppe]:
> If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.


Well, I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. So, your guess is right, that was after the run of `sage -tox`.
 
> > Are the output of tox logged somewhere?

> 
> Yes, it creates a subdirectory `.tox`, where you'll find logs.


Great. Thank you.



---

archive/issue_comments_437313.json:
```json
{
    "body": "Thanks for the answers and commits, I will check this tomorrow morning Bordeaux time.\n\n[I think my comment (3) is still not fixed (well, it is just a small detail).]",
    "created_at": "2020-11-23T21:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437313",
    "user": "https://github.com/seblabbe"
}
```

Thanks for the answers and commits, I will check this tomorrow morning Bordeaux time.

[I think my comment (3) is still not fixed (well, it is just a small detail).]



---

archive/issue_comments_437314.json:
```json
{
    "body": "Replying to [comment:35 slabbe]:\n> I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. \n\n\nThat should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.",
    "created_at": "2020-11-23T23:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437314",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:35 slabbe]:
> I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 


That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.



---

archive/issue_comments_437315.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-23T23:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_437316.json:
```json
{
    "body": "Replying to [comment:37 mkoeppe]:\n> Replying to [comment:35 slabbe]:\n> > I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. \n\n> \n> That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.\n\n\nOk, I see. But after `cd build`, the tox command prints few lines and seems to get stuck:\n\n```\n$ cd build\n$ tox\nGLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py\npy26 create: /home/slabbe/GitBox/sage/build/.tox/py26\nERROR: InterpreterNotFound: python2.6\npy27 create: /home/slabbe/GitBox/sage/build/.tox/py27\npy27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 runtests: PYTHONHASHSEED='3230691582'\npy27 runtests: commands[0] | python2.7 -m unittest discover\n......\n```",
    "created_at": "2020-11-24T08:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437316",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:37 mkoeppe]:
> Replying to [comment:35 slabbe]:
> > I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 

> 
> That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.


Ok, I see. But after `cd build`, the tox command prints few lines and seems to get stuck:

```
$ cd build
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......
```



---

archive/issue_comments_437317.json:
```json
{
    "body": "Actually, it did not get stuck, but I obtain three errors after few minutes:\n\n```\n$ tox\nGLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py\npy26 create: /home/slabbe/GitBox/sage/build/.tox/py26\nERROR: InterpreterNotFound: python2.6\npy27 create: /home/slabbe/GitBox/sage/build/.tox/py27\npy27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 runtests: PYTHONHASHSEED='3230691582'\npy27 runtests: commands[0] | python2.7 -m unittest discover\n......FF..............[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\n[......................................................................]\n......F........ERROR [package|all:249]: Failed to open pari\n..\n======================================================================\nFAIL: test_error (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 49, in test_error\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 64, in assertIsNotFoundError\n    \"[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'\"))\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_ignore_errors (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 57, in test_ignore_errors\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 64, in assertIsNotFoundError\n    \"[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'\"))\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_checksum (test.test_tarball.TarballTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_tarball.py\", line 59, in test_checksum\n    '[......................................................................]\\n')\nAssertionError: '[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\\n[......................................................................]\\n' != '[......................................................................]\\n'\n\n----------------------------------------------------------------------\nRan 39 tests in 228.835s\n\nFAILED (failures=3)\n```\n\nAfter that it seems tox does the same with other version of Python it finds on the system. With python 3.6, it returns two errors instead of three (the `test_checksum` does not fail).\n\nLet me now check whether this is related to the current ticket or not by rerunning it after a `git checkout develop`.",
    "created_at": "2020-11-24T08:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437317",
    "user": "https://github.com/seblabbe"
}
```

Actually, it did not get stuck, but I obtain three errors after few minutes:

```
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......FF..............[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[......................................................................]
......F........ERROR [package|all:249]: Failed to open pari
..
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_checksum (test.test_tarball.TarballTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_tarball.py", line 59, in test_checksum
    '[......................................................................]\n')
AssertionError: '[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\n[......................................................................]\n' != '[......................................................................]\n'

----------------------------------------------------------------------
Ran 39 tests in 228.835s

FAILED (failures=3)
```

After that it seems tox does the same with other version of Python it finds on the system. With python 3.6, it returns two errors instead of three (the `test_checksum` does not fail).

Let me now check whether this is related to the current ticket or not by rerunning it after a `git checkout develop`.



---

archive/issue_comments_437318.json:
```json
{
    "body": "I also get errors with 9.3.beta1, but not exactly the same. `test_ignore_errors` and `test_error`  both fails as with the branch. But `test_download` fails only on 9.3.beta1 whereas `test_checksum` fails only with the current branch.\n\n```\n======================================================================\nFAIL: test_error (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 49, in test_error\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 63, in assertIsNotFoundError\n    self.assertTrue(messages[0][1].endswith(\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_ignore_errors (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 57, in test_ignore_errors\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 63, in assertIsNotFoundError\n    self.assertTrue(messages[0][1].endswith(\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_download (test.test_package_cmdline.SagePackageTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_package_cmdline.py\", line 115, in test_download\n    self.assertTrue(stderr.startswith('Using cached file'))\nAssertionError: False is not true\n\n----------------------------------------------------------------------\nRan 39 tests in 134.424s\n\nFAILED (failures=3)\n```\n\nI don't know how much this is related to the current ticket. From my point of view, I give a positive review to the commits done up to now.\n\nMatthias, I let you change the status to positive review if you think the tox issues are unrelated or if they can be dealt in another ticket.",
    "created_at": "2020-11-24T08:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437318",
    "user": "https://github.com/seblabbe"
}
```

I also get errors with 9.3.beta1, but not exactly the same. `test_ignore_errors` and `test_error`  both fails as with the branch. But `test_download` fails only on 9.3.beta1 whereas `test_checksum` fails only with the current branch.

```
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_download (test.test_package_cmdline.SagePackageTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_package_cmdline.py", line 115, in test_download
    self.assertTrue(stderr.startswith('Using cached file'))
AssertionError: False is not true

----------------------------------------------------------------------
Ran 39 tests in 134.424s

FAILED (failures=3)
```

I don't know how much this is related to the current ticket. From my point of view, I give a positive review to the commits done up to now.

Matthias, I let you change the status to positive review if you think the tox issues are unrelated or if they can be dealt in another ticket.



---

archive/issue_comments_437319.json:
```json
{
    "body": "Thank you!\n\n(I also get the additional `test_checksum` failure on this branch. This test only passes on a release tag; this is not specific to this ticket. The other failures, also not specific to this ticket, should be investigated on a separate ticket.)",
    "created_at": "2020-11-24T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437319",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!

(I also get the additional `test_checksum` failure on this branch. This test only passes on a release tag; this is not specific to this ticket. The other failures, also not specific to this ticket, should be investigated on a separate ticket.)



---

archive/issue_comments_437320.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-24T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437320",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_437321.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-29T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437321",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080550.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-29T11:57:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30628#event-80550"
}
```



---

archive/issue_comments_437322.json:
```json
{
    "body": "I tried `make download` and it failed to download scipoptsuite.\n\nWhich is expected. Indeed, reading from the last scipoptsuite ticket:\n\n- #24662: Upgrade scipoptsuite to 5.0.1\n\n> Upstream archive: <snip>\n> (DO NOT put on sage servers -- we cannot redistribute this archive)\n\n\nHow do we deal with that?",
    "created_at": "2020-12-10T02:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437322",
    "user": "https://github.com/slel"
}
```

I tried `make download` and it failed to download scipoptsuite.

Which is expected. Indeed, reading from the last scipoptsuite ticket:

- #24662: Upgrade scipoptsuite to 5.0.1

> Upstream archive: <snip>
> (DO NOT put on sage servers -- we cannot redistribute this archive)


How do we deal with that?



---

archive/issue_comments_437323.json:
```json
{
    "body": "Replying to [comment:45 slelievre]:\n> > (DO NOT put on sage servers -- we cannot redistribute this archive)\n\n> \n> How do we deal with that?\n\n\nLet's discuss this on #31034",
    "created_at": "2020-12-10T03:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30628",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30628#issuecomment-437323",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:45 slelievre]:
> > (DO NOT put on sage servers -- we cannot redistribute this archive)

> 
> How do we deal with that?


Let's discuss this on #31034
