# Issue 30628: sage_bootstrap: Implement system package tools

Issue created by migration from https://trac.sagemath.org/ticket/30865

Original creator: mkoeppe

Original creation time: 2020-11-04 22:01:05

CC:  slabbe @tobiasdiez slelievre jhpalmieri vbraun

(from #29146, #30861)

There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:
 - `build/bin/write_dockerfile.sh`
 - `build/bin/sage-get-system-packages`
 - `tox.ini` (for `local-homebrew`, `local-conda`)
 - `.github/workflows/ci-wsl.yml` (using powershell)

The purpose of this ticket is to refactor it by reimplementing it as a new Python module of the `sage_bootstrap` package.


---

Comment by mkoeppe created at 2020-11-05 18:27:05

Developers interested in improving the system package advice may want to work on this ticket


---

Comment by mkoeppe created at 2020-11-19 18:45:39

New commits:


---

Comment by git created at 2020-11-19 20:12:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-19 20:42:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-19 20:43:11

Changing status from new to needs_review.


---

Comment by git created at 2020-11-19 20:54:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-19 20:56:56

Ready for review


---

Comment by slabbe created at 2020-11-22 09:18:49

The current branch is doing this:

```diff
-    def download_cls(self, package_name_or_class):
+    def download_cls(self, package_name_or_class, allow_upstream=False):
```


So should the change I made in #30648 be reverted then?

(I recall that the problem fixed in #30648 was that `download_cls` method had no argument `allow_upstream` where `download` method did, so I changed `download_cls` to `download`. But at the time, I was wondering if that was the good fix. Because another fix could have been to add the `allow_upstream` argument to the `download_cls` method which you are doing in this branch)


---

Comment by slabbe created at 2020-11-22 09:49:33

Doing `+=` on lists creates a new list in memory as opposed to `append` or `extend`:

```
sage: L = list(range(10))                                                       
sage: K = list('abcd')                                                          
sage: id(L)                                                                     
140556349258880
sage: id(L+K)                                                                   
140556349147776
sage: L.extend(K)                                                               
sage: id(L)                                                                     
140556349258880
```

So using `+=` to append elements to a list uses a quadratic amount of memory until the garbage collector gets called.

So I would suggest the following change:

```diff
- self.names += [package_name_or_class]
+ self.names.append(package_name_or_class)
```


as well as (5 times):

```diff
- self.names += [pkg.name for pkg in Package.all() if predicate(pkg)]
+ self.names.extend(pkg.name for pkg in Package.all() if predicate(pkg))
```



---

Comment by slabbe created at 2020-11-22 09:50:57

I will try the branch later today, and come back with further comments if I have.


---

Comment by mkoeppe created at 2020-11-22 20:25:08

Replying to [comment:16 slabbe]:
> The current branch is doing this:
> {{{
> #!diff
> -    def download_cls(self, package_name_or_class):
> +    def download_cls(self, package_name_or_class, allow_upstream=False):
> }}}
> 
> So should the change I made in #30648 be reverted then?

Yes, in fact I have already reverted it as part of the branch on this ticket.


---

Comment by git created at 2020-11-22 20:28:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2020-11-23 08:35:23

Replying to [comment:19 mkoeppe]:
> Yes, in fact I have already reverted it as part of the branch on this ticket.

Ok, yes, I agree. Since #30648 is not in sage yet, this is why I don't see it in the diff.


---

Comment by slabbe created at 2020-11-23 09:51:58

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-11-23 09:51:58

> (cd build && tox)

I did that. It finishes with a big list of typos and says that there were errors while running the tests. When I scroll back, I can't see the errors, because the typos takes all of the lines in the finite history of the terminal. Are the output of tox logged somewhere?

I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.

(0) I confirm that `sage --package list` works with inputs such as 
`--has-file=spkg-configure.m4`, `--has-file=distros/debian.txt`, `--has-file=SPKG.rst`. Also `sage --package download` works. Also `make download` works.

Sorry, I still have few more comments listed below.

(1) When I read the documentation of `sage --package`, I don't know what `Sage Bootstrap Library` means. I suggest to add a sentence in the file `sage_bootstrap.cmdline.py` to explain it. Something as follows, but please replace the verb `deal` with any more precise verb:


```diff
 description = \
 """
 Sage Bootstrap Library
+
+It deals with all of the packages in SageMath.
 """
```


(2) I don't like the following error message:


```
$ sage --package list :standardd:
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/cmdline.py", line 306, in run
    app.list_cls(*args.package_class, has_files=args.has_files)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/app.py", line 69, in list_cls
    pc = PackageClass(*package_classes, **filters)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/expand_class.py", line 48, in __init__
    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
ValueError: ('Package name cannot start with ":", got %s', ':standardd:')
```


It tells me the input cannot start with ":", but this is false, as `:standard:` is accepted.

Thus, I would suggest the following change in `sage_bootstrap/expand_class.py`:


```diff
             else:
-                if package_name_or_class.startswith(':'):
-                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
-                if package_name_or_class.endswith(':'):
-                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
+                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
+                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
                 self.names.append(package_name_or_class)
```


Question: do you confirm that the following is a desirable feature?

```
$ sage --package list pari
pari
```


(3) Finally, in `build/sage_bootstrap/package.py`, I suggest:


```diff
-        if pattern:
-            return self.tarball_pattern.replace('VERSION', self.version)
+        if pattern:
+            return pattern.replace('VERSION', self.version)
```


(4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?

I am currently waiting for the report of `make ptestlong`.


---

Comment by slabbe created at 2020-11-23 09:59:21

The `make ptestlong` finished with:

```
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```

which is unrelated to this ticket.


---

Comment by slelievre created at 2020-11-23 11:54:51

Replying to [comment:25 slabbe]:
> The `make ptestlong` finished with:
> {{{
> ----------------------------------------------------------------------
> sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
> ----------------------------------------------------------------------
> }}}
> which is unrelated to this ticket.

Indeed that is different, and tracked at #30945.


---

Comment by mkoeppe created at 2020-11-23 18:29:23

Replying to [comment:24 slabbe]:
> > (cd build && tox)
> 
> I did that. It finishes with a big list of typos 

If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.

> Are the output of tox logged somewhere?

Yes, it creates a subdirectory `.tox`, where you'll find logs.


---

Comment by git created at 2020-11-23 19:01:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-23 19:04:00

Replying to [comment:24 slabbe]:
> I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.

I agree. I have now made a change to eliminate this (unexplained) terminology from user-facing messages.  But I haven't changed the class name `PackageClass` or argument names, to keep the diff small.


---

Comment by mkoeppe created at 2020-11-23 19:05:33

Replying to [comment:24 slabbe]:
> (4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?

This is referring to https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types


---

Comment by mkoeppe created at 2020-11-23 19:07:56

Replying to [comment:24 slabbe]:
> I would suggest the following change in `sage_bootstrap/expand_class.py`:
> 
> {{{
> #!diff
>              else:
> -                if package_name_or_class.startswith(':'):
> -                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
> -                if package_name_or_class.endswith(':'):
> -                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
> +                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
> +                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
>                  self.names.append(package_name_or_class)
> }}}

I have made a similar change in the above commit.

> Question: do you confirm that the following is a desirable feature?
> {{{
> $ sage --package list pari
> pari
> }}}

Yes, this is a feature, and the above commit documents it.


---

Comment by git created at 2020-11-23 19:19:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-23 19:20:49

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-11-23 21:48:16

Replying to [comment:28 mkoeppe]:
> If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.

Well, I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. So, your guess is right, that was after the run of `sage -tox`.
 
> > Are the output of tox logged somewhere?
> 
> Yes, it creates a subdirectory `.tox`, where you'll find logs.

Great. Thank you.


---

Comment by slabbe created at 2020-11-23 21:53:19

Thanks for the answers and commits, I will check this tomorrow morning Bordeaux time.

[I think my comment (3) is still not fixed (well, it is just a small detail).]


---

Comment by mkoeppe created at 2020-11-23 23:25:48

Replying to [comment:35 slabbe]:
> I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 

That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.


---

Comment by git created at 2020-11-23 23:28:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2020-11-24 08:03:34

Replying to [comment:37 mkoeppe]:
> Replying to [comment:35 slabbe]:
> > I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 
> 
> That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.

Ok, I see. But after `cd build`, the tox command prints few lines and seems to get stuck:


```
$ cd build
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......
```



---

Comment by slabbe created at 2020-11-24 08:11:02

Actually, it did not get stuck, but I obtain three errors after few minutes:


```
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......FF..............[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[......................................................................]
......F........ERROR [package|all:249]: Failed to open pari
..
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_checksum (test.test_tarball.TarballTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_tarball.py", line 59, in test_checksum
    '[......................................................................]\n')
AssertionError: '[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\n[......................................................................]\n' != '[......................................................................]\n'

----------------------------------------------------------------------
Ran 39 tests in 228.835s

FAILED (failures=3)
```


After that it seems tox does the same with other version of Python it finds on the system. With python 3.6, it returns two errors instead of three (the `test_checksum` does not fail).

Let me now check whether this is related to the current ticket or not by rerunning it after a `git checkout develop`.


---

Comment by slabbe created at 2020-11-24 08:32:01

I also get errors with 9.3.beta1, but not exactly the same. `test_ignore_errors` and `test_error`  both fails as with the branch. But `test_download` fails only on 9.3.beta1 whereas `test_checksum` fails only with the current branch.


```
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_download (test.test_package_cmdline.SagePackageTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_package_cmdline.py", line 115, in test_download
    self.assertTrue(stderr.startswith('Using cached file'))
AssertionError: False is not true

----------------------------------------------------------------------
Ran 39 tests in 134.424s

FAILED (failures=3)
```


I don't know how much this is related to the current ticket. From my point of view, I give a positive review to the commits done up to now.

Matthias, I let you change the status to positive review if you think the tox issues are unrelated or if they can be dealt in another ticket.


---

Comment by mkoeppe created at 2020-11-24 17:28:29

Thank you!

(I also get the additional `test_checksum` failure on this branch. This test only passes on a release tag; this is not specific to this ticket. The other failures, also not specific to this ticket, should be investigated on a separate ticket.)


---

Comment by mkoeppe created at 2020-11-24 17:28:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-29 11:57:50

Resolution: fixed


---

Comment by slelievre created at 2020-12-10 02:18:07

I tried `make download` and it failed to download scipoptsuite.

Which is expected. Indeed, reading from the last scipoptsuite ticket:

- #24662: Upgrade scipoptsuite to 5.0.1

> Upstream archive: <snip>
> (DO NOT put on sage servers -- we cannot redistribute this archive)

How do we deal with that?


---

Comment by mkoeppe created at 2020-12-10 03:20:46

Replying to [comment:45 slelievre]:
> > (DO NOT put on sage servers -- we cannot redistribute this archive)
> 
> How do we deal with that?

Let's discuss this on #31034
