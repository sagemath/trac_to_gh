# Issue 10096: Sage won't start after moving or renaming the 4.6.alpha3 root directory

archive/issues_010096.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  @jasongrout @kcrisman @TimDumol\n\nThis is a follow-up to #9920.  The package extraction patch at that ticket makes an absolute link\n\n```\nln -sf \"$SAGE_ROOT/devel/sagenb-main\" \"$SAGE_ROOT/devel/sagenb\" \n```\n\nthat should be relative.  Also, it seems we need to rerun `python setup.py develop` in `SAGE_LOCAL/bin/sage-location`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10097\n\n",
    "created_at": "2010-10-07T22:01:39Z",
    "labels": [
        "component: notebook",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6",
    "title": "Sage won't start after moving or renaming the 4.6.alpha3 root directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10096",
    "user": "https://github.com/qed777"
}
```
Assignee: jason, was

CC:  @jasongrout @kcrisman @TimDumol

This is a follow-up to #9920.  The package extraction patch at that ticket makes an absolute link

```
ln -sf "$SAGE_ROOT/devel/sagenb-main" "$SAGE_ROOT/devel/sagenb" 
```

that should be relative.  Also, it seems we need to rerun `python setup.py develop` in `SAGE_LOCAL/bin/sage-location`.


Issue created by migration from https://trac.sagemath.org/ticket/10097





---

archive/issue_comments_101701.json:
```json
{
    "body": "Can we fix this within a day?  I'd really like to release 4.6.alpha3 with this fixed.  The current trial 4.6.alpha3, which is otherwise ready to go, is at\n\n http://sage.math.washington.edu/home/release/sage-4.6.alpha3",
    "created_at": "2010-10-07T22:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101701",
    "user": "https://github.com/qed777"
}
```

Can we fix this within a day?  I'd really like to release 4.6.alpha3 with this fixed.  The current trial 4.6.alpha3, which is otherwise ready to go, is at

 http://sage.math.washington.edu/home/release/sage-4.6.alpha3



---

archive/issue_comments_101702.json:
```json
{
    "body": "Both good points.  sage-location is seriously broken right now anyway.  #9210 goes a long ways towards fixing sage-location, but is mired in some reports of it not working (and some reports of it working).\n\nShouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.",
    "created_at": "2010-10-07T22:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101702",
    "user": "https://github.com/jasongrout"
}
```

Both good points.  sage-location is seriously broken right now anyway.  #9210 goes a long ways towards fixing sage-location, but is mired in some reports of it not working (and some reports of it working).

Shouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.



---

archive/issue_comments_101703.json:
```json
{
    "body": "Okay, it looks like the absolute reference in setup.py develop is in $SAGE_ROOT/local/lib/python2.6/site-packages/easy-install.pth: `/Users/grout/sage-4.6/devel/sagenb-main` -- that should be a relative reference like the rest of the paths in the .pth file are.\n\nThe other absolute reference is the $SAGE_ROOT/local/lib/python2.6/site-packages/sagenb.egg-link file: `/Users/grout/sage-4.6/devel/sagenb-main`, which should also be a relative reference.\n\nIt looks like we can set this path when we do setup.py develop:\n\n\n```\nsage -python setup.py develop --egg-path ../../../../devel/sagenb-main\n```\n",
    "created_at": "2010-10-07T22:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101703",
    "user": "https://github.com/jasongrout"
}
```

Okay, it looks like the absolute reference in setup.py develop is in $SAGE_ROOT/local/lib/python2.6/site-packages/easy-install.pth: `/Users/grout/sage-4.6/devel/sagenb-main` -- that should be a relative reference like the rest of the paths in the .pth file are.

The other absolute reference is the $SAGE_ROOT/local/lib/python2.6/site-packages/sagenb.egg-link file: `/Users/grout/sage-4.6/devel/sagenb-main`, which should also be a relative reference.

It looks like we can set this path when we do setup.py develop:


```
sage -python setup.py develop --egg-path ../../../../devel/sagenb-main
```




---

archive/issue_comments_101704.json:
```json
{
    "body": "Replying to [comment:2 jason]:\n> Shouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.\n\nFor the \"topmost\" link, we could use\n\n```sh\ncd \"$SAGE_ROOT/devel\"\nln -snf sagenb-main sagenb\n```\n\nin SageNB's `spkg-install`.\n\nFor example, `sage-build` does\n\n```sh\nif [ \"$1\" != \"\" ]; then\n    # make devel/sage point to devel/$1\n    cd \"$SAGE_ROOT/devel/\"\n    if [ ! -d \"sage-$1\" ]; then\n        # this will happen a lot because of people (=me) making typos.\n        echo \"No such branch '$SAGE_ROOT/devel/sage-$1'\"\n        echo \"Use 'sage -clone' to create a new branch.\"\n        exit 1\n    fi\n    ln -snf \"sage-$1\" sage\nfi\n```\n",
    "created_at": "2010-10-07T22:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101704",
    "user": "https://github.com/qed777"
}
```

Replying to [comment:2 jason]:
> Shouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.

For the "topmost" link, we could use

```sh
cd "$SAGE_ROOT/devel"
ln -snf sagenb-main sagenb
```

in SageNB's `spkg-install`.

For example, `sage-build` does

```sh
if [ "$1" != "" ]; then
    # make devel/sage point to devel/$1
    cd "$SAGE_ROOT/devel/"
    if [ ! -d "sage-$1" ]; then
        # this will happen a lot because of people (=me) making typos.
        echo "No such branch '$SAGE_ROOT/devel/sage-$1'"
        echo "Use 'sage -clone' to create a new branch."
        exit 1
    fi
    ln -snf "sage-$1" sage
fi
```




---

archive/issue_comments_101705.json:
```json
{
    "body": "So we have solutions for everything except the easy-install.pth file.  I can't figure out how to get setuptools to change that path to a relative path.  I suppose we could just search/replace that one path after doing setup.py develop.",
    "created_at": "2010-10-07T23:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101705",
    "user": "https://github.com/jasongrout"
}
```

So we have solutions for everything except the easy-install.pth file.  I can't figure out how to get setuptools to change that path to a relative path.  I suppose we could just search/replace that one path after doing setup.py develop.



---

archive/issue_comments_101706.json:
```json
{
    "body": "Sorry, to set the .egg-link file to have a relative path, we need to:\n\n\n```\ncd $SAGE_ROOT/devel/sagenb\nsage -python setup.py develop --egg-path ../../../../devel/sagenb\n```\n",
    "created_at": "2010-10-07T23:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101706",
    "user": "https://github.com/jasongrout"
}
```

Sorry, to set the .egg-link file to have a relative path, we need to:


```
cd $SAGE_ROOT/devel/sagenb
sage -python setup.py develop --egg-path ../../../../devel/sagenb
```




---

archive/issue_comments_101707.json:
```json
{
    "body": "I've posted a question to stackoverflow: http://stackoverflow.com/questions/3886667/how-to-get-setuptools-to-use-a-relative-path-in-easy-install-pth-when-doing-setu\n\nAlso, the solution might be in using the virtualenv feature of setuptools.  There is a --relocatable option that might make things in Sage easier.",
    "created_at": "2010-10-07T23:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101707",
    "user": "https://github.com/jasongrout"
}
```

I've posted a question to stackoverflow: http://stackoverflow.com/questions/3886667/how-to-get-setuptools-to-use-a-relative-path-in-easy-install-pth-when-doing-setu

Also, the solution might be in using the virtualenv feature of setuptools.  There is a --relocatable option that might make things in Sage easier.



---

archive/issue_comments_101708.json:
```json
{
    "body": "See http://pypi.python.org/pypi/virtualenv for the virtualenv (search for \"Making Environments Relocatable\")",
    "created_at": "2010-10-07T23:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101708",
    "user": "https://github.com/jasongrout"
}
```

See http://pypi.python.org/pypi/virtualenv for the virtualenv (search for "Making Environments Relocatable")



---

archive/issue_comments_101709.json:
```json
{
    "body": "What if we do\n\n```\ncd SAGE_ROOT/local/lib/python/site-packages\necho ../../../../devel/sagenb > sagenb.pth\n```\n\n?  Does this effectively override the path in `easy-install.pth`?",
    "created_at": "2010-10-08T02:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101709",
    "user": "https://github.com/qed777"
}
```

What if we do

```
cd SAGE_ROOT/local/lib/python/site-packages
echo ../../../../devel/sagenb > sagenb.pth
```

?  Does this effectively override the path in `easy-install.pth`?



---

archive/issue_comments_101710.json:
```json
{
    "body": "Replying to [comment:9 mpatel]:\n> What if we do\n> {{{\n> cd SAGE_ROOT/local/lib/python/site-packages\n> echo ../../../../devel/sagenb > sagenb.pth\n> }}}\n> ?  Does this effectively override the path in `easy-install.pth`?\n\nNo.  There is one easy-install.pth file, and that's it.  I think we need to change the absolute pathname in it to be a relative path name (which should be a simple search/replace or sed command)",
    "created_at": "2010-10-08T03:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101710",
    "user": "https://github.com/jasongrout"
}
```

Replying to [comment:9 mpatel]:
> What if we do
> {{{
> cd SAGE_ROOT/local/lib/python/site-packages
> echo ../../../../devel/sagenb > sagenb.pth
> }}}
> ?  Does this effectively override the path in `easy-install.pth`?

No.  There is one easy-install.pth file, and that's it.  I think we need to change the absolute pathname in it to be a relative path name (which should be a simple search/replace or sed command)



---

archive/issue_comments_101711.json:
```json
{
    "body": "Attachment [trac_10097-sagenb_relocatability.patch](tarball://root/attachments/some-uuid/ticket10097/trac_10097-sagenb_relocatability.patch) by @qed777 created at 2010-10-08 07:12:37\n\nUse relative paths.  sagenb repository.",
    "created_at": "2010-10-08T07:12:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101711",
    "user": "https://github.com/qed777"
}
```

Attachment [trac_10097-sagenb_relocatability.patch](tarball://root/attachments/some-uuid/ticket10097/trac_10097-sagenb_relocatability.patch) by @qed777 created at 2010-10-08 07:12:37

Use relative paths.  sagenb repository.



---

archive/issue_comments_101712.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-10-08T07:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101712",
    "user": "https://github.com/qed777"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_101713.json:
```json
{
    "body": "I've attached a patch, which is part of\n\n http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg\n\n(I haven't used sed's `-i` option, because it does not work on Solaris.)",
    "created_at": "2010-10-08T07:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101713",
    "user": "https://github.com/qed777"
}
```

I've attached a patch, which is part of

 http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg

(I haven't used sed's `-i` option, because it does not work on Solaris.)



---

archive/issue_comments_101714.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-08T18:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101714",
    "user": "https://github.com/jasongrout"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_101715.json:
```json
{
    "body": "Replying to [comment:11 mpatel]:\n> I've attached a patch, which is part of\n> \n>  http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg\n> \n> (I haven't used sed's `-i` option, because it does not work on Solaris.)\n\nThe effect looks good and spkg looks good.  Positive review.",
    "created_at": "2010-10-08T18:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101715",
    "user": "https://github.com/jasongrout"
}
```

Replying to [comment:11 mpatel]:
> I've attached a patch, which is part of
> 
>  http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg
> 
> (I haven't used sed's `-i` option, because it does not work on Solaris.)

The effect looks good and spkg looks good.  Positive review.



---

archive/issue_comments_101716.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-10-08T22:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101716",
    "user": "https://github.com/qed777"
}
```

Resolution: fixed



---

archive/issue_comments_101717.json:
```json
{
    "body": "Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, \"sagenb\" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.",
    "created_at": "2010-10-25T01:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101717",
    "user": "https://github.com/qed777"
}
```

Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.



---

archive/issue_comments_101718.json:
```json
{
    "body": "Replying to [comment:16 mpatel]:\n> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, \"sagenb\" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.\n\nSee Leif Leonhardy's replies for some suggestions.",
    "created_at": "2010-10-25T03:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101718",
    "user": "https://github.com/qed777"
}
```

Replying to [comment:16 mpatel]:
> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.

See Leif Leonhardy's replies for some suggestions.



---

archive/issue_comments_101719.json:
```json
{
    "body": "Replying to [comment:16 mpatel]:\n> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, \"sagenb\" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.\n\nI've opened #10176 for this problem.",
    "created_at": "2010-10-27T08:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101719",
    "user": "https://github.com/qed777"
}
```

Replying to [comment:16 mpatel]:
> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.

I've opened #10176 for this problem.



---

archive/issue_comments_101720.json:
```json
{
    "body": "Replying to [comment:18 mpatel]:\n> Replying to [comment:16 mpatel]:\n> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, \"sagenb\" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.\n> \n> I've opened #10176 for this problem.\n\nI've uploaded a follow-up spkg patch (currently just for testing / debugging) at #10176, no idea if that fixes the problem. (Others can of course test it on other platforms to make sure it doesn't break anything. Works for me on Ubuntu 10.04.)\n\nFlorent reported he had the same failure on OpenSuSE 11.**1**, too, so it might be specific to his installations, since Sage 4.6.rc0 was said to work on Skynet's menas (which runs OpenSuSE 11.1, too), but perhaps just by good luck...",
    "created_at": "2010-10-27T15:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101720",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:18 mpatel]:
> Replying to [comment:16 mpatel]:
> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.
> 
> I've opened #10176 for this problem.

I've uploaded a follow-up spkg patch (currently just for testing / debugging) at #10176, no idea if that fixes the problem. (Others can of course test it on other platforms to make sure it doesn't break anything. Works for me on Ubuntu 10.04.)

Florent reported he had the same failure on OpenSuSE 11.**1**, too, so it might be specific to his installations, since Sage 4.6.rc0 was said to work on Skynet's menas (which runs OpenSuSE 11.1, too), but perhaps just by good luck...



---

archive/issue_comments_101721.json:
```json
{
    "body": "Replying to [comment:18 mpatel]:\n> Replying to [comment:16 mpatel]:\n> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, \"sagenb\" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.\n> \n> I've opened #10176 for this problem.\n\n#10192 (currently needing review) also solves this, but in a different way (by patching `sage-spkg` to get rid of \"`.`\" in `PYTHONPATH` before installing an spkg).",
    "created_at": "2010-10-31T01:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10096#issuecomment-101721",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:18 mpatel]:
> Replying to [comment:16 mpatel]:
> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.
> 
> I've opened #10176 for this problem.

#10192 (currently needing review) also solves this, but in a different way (by patching `sage-spkg` to get rid of "`.`" in `PYTHONPATH` before installing an spkg).
