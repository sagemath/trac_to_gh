# Issue 10096: Sage won't start after moving or renaming the 4.6.alpha3 root directory

Issue created by migration from https://trac.sagemath.org/ticket/10097

Original creator: mpatel

Original creation time: 2010-10-07 22:01:39

Assignee: jason, was

CC:  jason kcrisman timdumol

This is a follow-up to #9920.  The package extraction patch at that ticket makes an absolute link

```
ln -sf "$SAGE_ROOT/devel/sagenb-main" "$SAGE_ROOT/devel/sagenb" 
```

that should be relative.  Also, it seems we need to rerun `python setup.py develop` in `SAGE_LOCAL/bin/sage-location`.



---

Comment by mpatel created at 2010-10-07 22:03:33

Can we fix this within a day?  I'd really like to release 4.6.alpha3 with this fixed.  The current trial 4.6.alpha3, which is otherwise ready to go, is at

 http://sage.math.washington.edu/home/release/sage-4.6.alpha3


---

Comment by jason created at 2010-10-07 22:05:55

Both good points.  sage-location is seriously broken right now anyway.  #9210 goes a long ways towards fixing sage-location, but is mired in some reports of it not working (and some reports of it working).

Shouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.


---

Comment by jason created at 2010-10-07 22:26:56

Okay, it looks like the absolute reference in setup.py develop is in $SAGE_ROOT/local/lib/python2.6/site-packages/easy-install.pth: `/Users/grout/sage-4.6/devel/sagenb-main` -- that should be a relative reference like the rest of the paths in the .pth file are.

The other absolute reference is the $SAGE_ROOT/local/lib/python2.6/site-packages/sagenb.egg-link file: `/Users/grout/sage-4.6/devel/sagenb-main`, which should also be a relative reference.

It looks like we can set this path when we do setup.py develop:


```
sage -python setup.py develop --egg-path ../../../../devel/sagenb-main
```



---

Comment by mpatel created at 2010-10-07 22:28:37

Replying to [comment:2 jason]:
> Shouldn't the setup.py develop create relative references to the sagenb repository, rather than absolute references?  That would take care of the second point.

For the "topmost" link, we could use

```sh
cd "$SAGE_ROOT/devel"
ln -snf sagenb-main sagenb
```

in SageNB's `spkg-install`.

For example, `sage-build` does

```sh
if [ "$1" != "" ]; then
    # make devel/sage point to devel/$1
    cd "$SAGE_ROOT/devel/"
    if [ ! -d "sage-$1" ]; then
        # this will happen a lot because of people (=me) making typos.
        echo "No such branch '$SAGE_ROOT/devel/sage-$1'"
        echo "Use 'sage -clone' to create a new branch."
        exit 1
    fi
    ln -snf "sage-$1" sage
fi
```



---

Comment by jason created at 2010-10-07 23:17:28

So we have solutions for everything except the easy-install.pth file.  I can't figure out how to get setuptools to change that path to a relative path.  I suppose we could just search/replace that one path after doing setup.py develop.


---

Comment by jason created at 2010-10-07 23:18:29

Sorry, to set the .egg-link file to have a relative path, we need to:


```
cd $SAGE_ROOT/devel/sagenb
sage -python setup.py develop --egg-path ../../../../devel/sagenb
```



---

Comment by jason created at 2010-10-07 23:28:44

I've posted a question to stackoverflow: http://stackoverflow.com/questions/3886667/how-to-get-setuptools-to-use-a-relative-path-in-easy-install-pth-when-doing-setu

Also, the solution might be in using the virtualenv feature of setuptools.  There is a --relocatable option that might make things in Sage easier.


---

Comment by jason created at 2010-10-07 23:32:16

See http://pypi.python.org/pypi/virtualenv for the virtualenv (search for "Making Environments Relocatable")


---

Comment by mpatel created at 2010-10-08 02:55:46

What if we do

```
cd SAGE_ROOT/local/lib/python/site-packages
echo ../../../../devel/sagenb > sagenb.pth
```

?  Does this effectively override the path in `easy-install.pth`?


---

Comment by jason created at 2010-10-08 03:05:27

Replying to [comment:9 mpatel]:
> What if we do
> {{{
> cd SAGE_ROOT/local/lib/python/site-packages
> echo ../../../../devel/sagenb > sagenb.pth
> }}}
> ?  Does this effectively override the path in `easy-install.pth`?

No.  There is one easy-install.pth file, and that's it.  I think we need to change the absolute pathname in it to be a relative path name (which should be a simple search/replace or sed command)


---

Attachment

Use relative paths.  sagenb repository.


---

Comment by mpatel created at 2010-10-08 07:24:25

Changing status from new to needs_review.


---

Comment by mpatel created at 2010-10-08 07:24:25

I've attached a patch, which is part of

 http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg

(I haven't used sed's `-i` option, because it does not work on Solaris.)


---

Comment by jason created at 2010-10-08 18:05:42

Changing status from needs_review to positive_review.


---

Comment by jason created at 2010-10-08 18:05:42

Replying to [comment:11 mpatel]:
> I've attached a patch, which is part of
> 
>  http://sage.math.washington.edu/home/mpatel/trac/10097/sagenb-0.8.7.spkg
> 
> (I haven't used sed's `-i` option, because it does not work on Solaris.)

The effect looks good and spkg looks good.  Positive review.


---

Comment by mpatel created at 2010-10-08 22:15:38

Resolution: fixed


---

Comment by mpatel created at 2010-10-25 01:42:48

Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.


---

Comment by mpatel created at 2010-10-25 03:48:32

Replying to [comment:16 mpatel]:
> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.

See Leif Leonhardy's replies for some suggestions.


---

Comment by mpatel created at 2010-10-27 08:56:54

Replying to [comment:16 mpatel]:
> Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.

I've opened #10176 for this problem.


---

Comment by leif created at 2010-10-27 15:21:24

Replying to [comment:18 mpatel]:
> Replying to [comment:16 mpatel]:
> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.
> 
> I've opened #10176 for this problem.

I've uploaded a follow-up spkg patch (currently just for testing / debugging) at #10176, no idea if that fixes the problem. (Others can of course test it on other platforms to make sure it doesn't break anything. Works for me on Ubuntu 10.04.)

Florent reported he had the same failure on OpenSuSE 11.*1*, too, so it might be specific to his installations, since Sage 4.6.rc0 was said to work on Skynet's menas (which runs OpenSuSE 11.1, too), but perhaps just by good luck...


---

Comment by leif created at 2010-10-31 01:36:12

Replying to [comment:18 mpatel]:
> Replying to [comment:16 mpatel]:
> > Florent Hivert has reported [on sage-release](http://groups.google.com/group/sage-release/browse_thread/thread/bb636656e2153332) a problem starting Sage 4.6.rc0 built from scratch on openSUSE 11.3.  Apparently, "sagenb" does not appear in `easy-install.pth` during the build, so the patch above does not insert the relative path we want.
> 
> I've opened #10176 for this problem.

#10192 (currently needing review) also solves this, but in a different way (by patching `sage-spkg` to get rid of "`.`" in `PYTHONPATH` before installing an spkg).
