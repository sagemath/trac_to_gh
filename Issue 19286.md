# Issue 19286: Adding constraints for the wrong MILP crashes Sage

Issue created by migration from https://trac.sagemath.org/ticket/19523

Original creator: jdemeyer

Original creation time: 2015-11-04 16:10:26

CC:  yzh


```
sage: p = MixedIntegerLinearProgram()
sage: q = MixedIntegerLinearProgram() 
sage: q.add_constraint(p[0] <= 1)
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
------------------------------------------------------------------------
```



---

Comment by jdemeyer created at 2015-11-05 10:13:02

Changing priority from critical to major.


---

Comment by mkoeppe created at 2016-03-31 02:08:09

While `MIPVariable` objects know which MIP they belong to,
their "components" gotten by `p[0]` etc. are elements of `LinearFunctionsParent(base_ring)`, and do not remember their MIP (nor even their name).
So with the current design it does not seem possible to catch the error of adding constraints to the wrong MIP. 
So unfortunately only lower-level error checking, catching out-of-bounds indices, is possible.


---

Comment by jdemeyer created at 2016-03-31 06:57:07

Given that `p[0]` is just a linear function, it would make the most sense if `q.add_constraint(p[0] <= 1)` would simply work, not give an error message.


---

Comment by mkoeppe created at 2016-03-31 06:58:12

No, q has no variables at this point.


---

Comment by jdemeyer created at 2016-03-31 07:35:45

Replying to [comment:7 mkoeppe]:
> No, q has no variables at this point.

That's exactly my point: the variables should be added by `q.add_constraint()`.


---

Comment by mkoeppe created at 2016-03-31 20:37:20

I'm not sure that this would be a good interface. It would allow to add variables, but only variables with default settings (continuous, lower bound 0, no upper bound, no name). 
I think it's better to raise an error, which could help spot programming mistakes -- at least when there's a dimension mismatch between the two problems. 
This bound checking should be done by the backends -- see #10232.


---

Comment by jdemeyer created at 2016-04-01 19:36:19

Replying to [comment:9 mkoeppe]:
> at least when there's a dimension mismatch between the two problems.

No. It should be always an error, or never an error. If it's only an error "when there's a dimension mismatch between the two problems", that will be more confusing than either extreme.


---

Comment by mkoeppe created at 2016-04-01 22:57:37

Then I strongly prefer to always raise an error in this situation. This requires changes to `LinearFunction` (a class that is I think only used in the context of `MixedIntegerLinearProgram`), so that it remembers the MIP that it relates to.

The mapping from MIP variables (and their indexed components) to integer indices (designating backend columns) is determined dynamically, adding a backend column when a MIP variable component is accessed.
Because of this there's simply no good way to write correct code that interchanges MIP variables between two `MixedIntegerLinearProgram`s, or to use `LinearFunction`s directly somehow (without referring to the correct MIP's variables).


---

Comment by mkoeppe created at 2016-04-05 21:52:10

Since the crashes are now on separate tickets, I have changed the title of this ticket.


---

Comment by mkoeppe created at 2016-04-17 00:06:06

See also #15159, which raises a similar question when `q` started out as a copy of `p`.


---

Comment by mkoeppe created at 2016-06-27 03:16:03

A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.


---

Comment by yzh created at 2021-02-01 04:11:54

Replying to [comment:15 mkoeppe]:
> A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.
In contrast the example in the ticket description, no error is raised in the following examples, which is very confusing. 

```
sage: p = MixedIntegerLinearProgram(solver="glpk")                              
sage: q = MixedIntegerLinearProgram(solver="glpk")                              
sage: v = q.new_variable()                                                      
sage: q.add_constraint(v[0] <= 1)
```


and 


```
sage: p = MixedIntegerLinearProgram(solver='InteractiveLP')                     
sage: v = p.new_variable()                                                      
sage: x,y = v[0], v[1]                                                          
sage: pp = MixedIntegerLinearProgram(solver='InteractiveLP')                    
sage: vv = pp.new_variable()                                                    
sage: xx,yy = vv[0], vv[1]                                                      
sage: p.add_constraint(x + y, max = 10)                                         
sage: p.add_constraint(xx + 3*yy, max = 15)                                     
sage: p.set_objective(x + 3*y)                                                  
sage: p.solve()                                                                 
15
sage: p.show()                                                                  
Maximization:
  x1 + 3 x2 

Constraints:
  x1 + x2 <= 10
  x1 + 3 x2 <= 15
Variables:
  x1 = x_0 is a continuous variable (min=-oo, max=+oo)
  x2 = x_1 is a continuous variable (min=-oo, max=+oo)
```


It would be nice to have `LinearFunctionsParent` etc. remember its MIP.
