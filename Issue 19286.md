# Issue 19286: Adding constraints for the wrong MILP crashes Sage

archive/issues_019286.json:
```json
{
    "body": "CC:  yzh\n\n\n```\nsage: p = MixedIntegerLinearProgram()\nsage: q = MixedIntegerLinearProgram() \nsage: q.add_constraint(p[0] <= 1)\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nSage will now terminate.\n------------------------------------------------------------------------\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19523\n\n",
    "created_at": "2015-11-04T16:10:26Z",
    "labels": [
        "linear programming",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Adding constraints for the wrong MILP crashes Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19286",
    "user": "jdemeyer"
}
```
CC:  yzh


```
sage: p = MixedIntegerLinearProgram()
sage: q = MixedIntegerLinearProgram() 
sage: q.add_constraint(p[0] <= 1)
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
------------------------------------------------------------------------
```


Issue created by migration from https://trac.sagemath.org/ticket/19523





---

archive/issue_comments_264853.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2015-11-05T10:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264853",
    "user": "jdemeyer"
}
```

Changing priority from critical to major.



---

archive/issue_comments_264854.json:
```json
{
    "body": "While `MIPVariable` objects know which MIP they belong to,\ntheir \"components\" gotten by `p[0]` etc. are elements of `LinearFunctionsParent(base_ring)`, and do not remember their MIP (nor even their name).\nSo with the current design it does not seem possible to catch the error of adding constraints to the wrong MIP. \nSo unfortunately only lower-level error checking, catching out-of-bounds indices, is possible.",
    "created_at": "2016-03-31T02:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264854",
    "user": "mkoeppe"
}
```

While `MIPVariable` objects know which MIP they belong to,
their "components" gotten by `p[0]` etc. are elements of `LinearFunctionsParent(base_ring)`, and do not remember their MIP (nor even their name).
So with the current design it does not seem possible to catch the error of adding constraints to the wrong MIP. 
So unfortunately only lower-level error checking, catching out-of-bounds indices, is possible.



---

archive/issue_comments_264855.json:
```json
{
    "body": "Given that `p[0]` is just a linear function, it would make the most sense if `q.add_constraint(p[0] <= 1)` would simply work, not give an error message.",
    "created_at": "2016-03-31T06:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264855",
    "user": "jdemeyer"
}
```

Given that `p[0]` is just a linear function, it would make the most sense if `q.add_constraint(p[0] <= 1)` would simply work, not give an error message.



---

archive/issue_comments_264856.json:
```json
{
    "body": "No, q has no variables at this point.",
    "created_at": "2016-03-31T06:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264856",
    "user": "mkoeppe"
}
```

No, q has no variables at this point.



---

archive/issue_comments_264857.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> No, q has no variables at this point.\n\nThat's exactly my point: the variables should be added by `q.add_constraint()`.",
    "created_at": "2016-03-31T07:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264857",
    "user": "jdemeyer"
}
```

Replying to [comment:7 mkoeppe]:
> No, q has no variables at this point.

That's exactly my point: the variables should be added by `q.add_constraint()`.



---

archive/issue_comments_264858.json:
```json
{
    "body": "I'm not sure that this would be a good interface. It would allow to add variables, but only variables with default settings (continuous, lower bound 0, no upper bound, no name). \nI think it's better to raise an error, which could help spot programming mistakes -- at least when there's a dimension mismatch between the two problems. \nThis bound checking should be done by the backends -- see #10232.",
    "created_at": "2016-03-31T20:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264858",
    "user": "mkoeppe"
}
```

I'm not sure that this would be a good interface. It would allow to add variables, but only variables with default settings (continuous, lower bound 0, no upper bound, no name). 
I think it's better to raise an error, which could help spot programming mistakes -- at least when there's a dimension mismatch between the two problems. 
This bound checking should be done by the backends -- see #10232.



---

archive/issue_comments_264859.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> at least when there's a dimension mismatch between the two problems.\n\nNo. It should be always an error, or never an error. If it's only an error \"when there's a dimension mismatch between the two problems\", that will be more confusing than either extreme.",
    "created_at": "2016-04-01T19:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264859",
    "user": "jdemeyer"
}
```

Replying to [comment:9 mkoeppe]:
> at least when there's a dimension mismatch between the two problems.

No. It should be always an error, or never an error. If it's only an error "when there's a dimension mismatch between the two problems", that will be more confusing than either extreme.



---

archive/issue_comments_264860.json:
```json
{
    "body": "Then I strongly prefer to always raise an error in this situation. This requires changes to `LinearFunction` (a class that is I think only used in the context of `MixedIntegerLinearProgram`), so that it remembers the MIP that it relates to.\n\nThe mapping from MIP variables (and their indexed components) to integer indices (designating backend columns) is determined dynamically, adding a backend column when a MIP variable component is accessed.\nBecause of this there's simply no good way to write correct code that interchanges MIP variables between two `MixedIntegerLinearProgram`s, or to use `LinearFunction`s directly somehow (without referring to the correct MIP's variables).",
    "created_at": "2016-04-01T22:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264860",
    "user": "mkoeppe"
}
```

Then I strongly prefer to always raise an error in this situation. This requires changes to `LinearFunction` (a class that is I think only used in the context of `MixedIntegerLinearProgram`), so that it remembers the MIP that it relates to.

The mapping from MIP variables (and their indexed components) to integer indices (designating backend columns) is determined dynamically, adding a backend column when a MIP variable component is accessed.
Because of this there's simply no good way to write correct code that interchanges MIP variables between two `MixedIntegerLinearProgram`s, or to use `LinearFunction`s directly somehow (without referring to the correct MIP's variables).



---

archive/issue_comments_264861.json:
```json
{
    "body": "Since the crashes are now on separate tickets, I have changed the title of this ticket.",
    "created_at": "2016-04-05T21:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264861",
    "user": "mkoeppe"
}
```

Since the crashes are now on separate tickets, I have changed the title of this ticket.



---

archive/issue_comments_264862.json:
```json
{
    "body": "See also #15159, which raises a similar question when `q` started out as a copy of `p`.",
    "created_at": "2016-04-17T00:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264862",
    "user": "mkoeppe"
}
```

See also #15159, which raises a similar question when `q` started out as a copy of `p`.



---

archive/issue_comments_264863.json:
```json
{
    "body": "A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.",
    "created_at": "2016-06-27T03:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264863",
    "user": "mkoeppe"
}
```

A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.



---

archive/issue_comments_264864.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.\nIn contrast the example in the ticket description, no error is raised in the following examples, which is very confusing. \n\n```\nsage: p = MixedIntegerLinearProgram(solver=\"glpk\")                              \nsage: q = MixedIntegerLinearProgram(solver=\"glpk\")                              \nsage: v = q.new_variable()                                                      \nsage: q.add_constraint(v[0] <= 1)\n```\n\n\nand \n\n\n```\nsage: p = MixedIntegerLinearProgram(solver='InteractiveLP')                     \nsage: v = p.new_variable()                                                      \nsage: x,y = v[0], v[1]                                                          \nsage: pp = MixedIntegerLinearProgram(solver='InteractiveLP')                    \nsage: vv = pp.new_variable()                                                    \nsage: xx,yy = vv[0], vv[1]                                                      \nsage: p.add_constraint(x + y, max = 10)                                         \nsage: p.add_constraint(xx + 3*yy, max = 15)                                     \nsage: p.set_objective(x + 3*y)                                                  \nsage: p.solve()                                                                 \n15\nsage: p.show()                                                                  \nMaximization:\n  x1 + 3 x2 \n\nConstraints:\n  x1 + x2 <= 10\n  x1 + 3 x2 <= 15\nVariables:\n  x1 = x_0 is a continuous variable (min=-oo, max=+oo)\n  x2 = x_1 is a continuous variable (min=-oo, max=+oo)\n```\n\n\nIt would be nice to have `LinearFunctionsParent` etc. remember its MIP.",
    "created_at": "2021-02-01T04:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19286",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19286#issuecomment-264864",
    "user": "yzh"
}
```

Replying to [comment:15 mkoeppe]:
> A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.
In contrast the example in the ticket description, no error is raised in the following examples, which is very confusing. 

```
sage: p = MixedIntegerLinearProgram(solver="glpk")                              
sage: q = MixedIntegerLinearProgram(solver="glpk")                              
sage: v = q.new_variable()                                                      
sage: q.add_constraint(v[0] <= 1)
```


and 


```
sage: p = MixedIntegerLinearProgram(solver='InteractiveLP')                     
sage: v = p.new_variable()                                                      
sage: x,y = v[0], v[1]                                                          
sage: pp = MixedIntegerLinearProgram(solver='InteractiveLP')                    
sage: vv = pp.new_variable()                                                    
sage: xx,yy = vv[0], vv[1]                                                      
sage: p.add_constraint(x + y, max = 10)                                         
sage: p.add_constraint(xx + 3*yy, max = 15)                                     
sage: p.set_objective(x + 3*y)                                                  
sage: p.solve()                                                                 
15
sage: p.show()                                                                  
Maximization:
  x1 + 3 x2 

Constraints:
  x1 + x2 <= 10
  x1 + 3 x2 <= 15
Variables:
  x1 = x_0 is a continuous variable (min=-oo, max=+oo)
  x2 = x_1 is a continuous variable (min=-oo, max=+oo)
```


It would be nice to have `LinearFunctionsParent` etc. remember its MIP.
