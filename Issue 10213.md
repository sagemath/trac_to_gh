# Issue 10213: Add numpy dependencies to module_list.py

archive/issues_010213.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @nexttime maldun\n\nKeywords: numpy upgrade\n\nIn order to fix `sage -upgrade` after #9808, we need to add missing includes in `module_list.py`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10214\n\n",
    "created_at": "2010-11-04T20:35:59Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Add numpy dependencies to module_list.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10213",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: GeorgSWeber

CC:  @nexttime maldun

Keywords: numpy upgrade

In order to fix `sage -upgrade` after #9808, we need to add missing includes in `module_list.py`.

Issue created by migration from https://trac.sagemath.org/ticket/10214





---

archive/issue_comments_103775.json:
```json
{
    "body": "Attachment [10124_numpy_depends.patch](tarball://root/attachments/some-uuid/ticket10214/10124_numpy_depends.patch) by @jdemeyer created at 2010-11-04 21:13:15",
    "created_at": "2010-11-04T21:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103775",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10124_numpy_depends.patch](tarball://root/attachments/some-uuid/ticket10214/10124_numpy_depends.patch) by @jdemeyer created at 2010-11-04 21:13:15



---

archive/issue_comments_103776.json:
```json
{
    "body": "Attachment [10124_numpy_depends.2.patch](tarball://root/attachments/some-uuid/ticket10214/10124_numpy_depends.2.patch) by @jdemeyer created at 2010-11-04 21:26:52",
    "created_at": "2010-11-04T21:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103776",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [10124_numpy_depends.2.patch](tarball://root/attachments/some-uuid/ticket10214/10124_numpy_depends.2.patch) by @jdemeyer created at 2010-11-04 21:26:52



---

archive/issue_comments_103777.json:
```json
{
    "body": "Apply ONLY THIS PATCH to sagelib",
    "created_at": "2010-11-04T21:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103777",
    "user": "https://github.com/jdemeyer"
}
```

Apply ONLY THIS PATCH to sagelib



---

archive/issue_comments_103778.json:
```json
{
    "body": "Attachment [10214_numpy_depends.patch](tarball://root/attachments/some-uuid/ticket10214/10214_numpy_depends.patch) by @nexttime created at 2010-11-04 22:33:06\n\nI counted only 13 extension modules that did **not** get rebuilt by `sage -b`:\n\n```\nUpdating Cython code....\nBuilding sage/calculus/riemann.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/calculus/interpolators.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/finance/time_series.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/matrix/change_ring.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/matrix/matrix_complex_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/matrix/matrix_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/matrix/matrix_real_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/modules/vector_complex_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/modules/vector_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/modules/vector_real_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/plot/complex_plot.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/plot/plot3d/implicit_surface.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nBuilding sage/rings/polynomial/real_roots.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.\nExecute 13 commands (using 8 threads)\n```\n",
    "created_at": "2010-11-04T22:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103778",
    "user": "https://github.com/nexttime"
}
```

Attachment [10214_numpy_depends.patch](tarball://root/attachments/some-uuid/ticket10214/10214_numpy_depends.patch) by @nexttime created at 2010-11-04 22:33:06

I counted only 13 extension modules that did **not** get rebuilt by `sage -b`:

```
Updating Cython code....
Building sage/calculus/riemann.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/calculus/interpolators.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/finance/time_series.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/matrix/change_ring.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/matrix/matrix_complex_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/matrix/matrix_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/matrix/matrix_real_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/modules/vector_complex_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/modules/vector_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/modules/vector_real_double_dense.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/plot/complex_plot.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/plot/plot3d/implicit_surface.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Building sage/rings/polynomial/real_roots.pyx because it depends on /home/leif/Sage/sage-4.6.1.alpha0/local/lib/python/site-packages/Cython/Includes/numpy.pxd.
Execute 13 commands (using 8 threads)
```




---

archive/issue_comments_103779.json:
```json
{
    "body": "What I did was `grep` all pyx files for `numpy` and then added the numpy dependency for all those files.",
    "created_at": "2010-11-04T22:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103779",
    "user": "https://github.com/jdemeyer"
}
```

What I did was `grep` all pyx files for `numpy` and then added the numpy dependency for all those files.



---

archive/issue_comments_103780.json:
```json
{
    "body": "I believe this patch to be finished, but I will do some more testing before putting it officially to review.",
    "created_at": "2010-11-04T22:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103780",
    "user": "https://github.com/jdemeyer"
}
```

I believe this patch to be finished, but I will do some more testing before putting it officially to review.



---

archive/issue_comments_103781.json:
```json
{
    "body": "Patch looks fine so far; I think it will perhaps trigger more rebuilds than necessary, but won't leave out dependent modules (at first glance).\n\nDefining the other includes and depends also looks much better. (We could create a class for libraries, perhaps in a separate file, or read definitions from [a] text file[s].)\n\nNote that there's also a lot of crap in `module_list.py` (unused libraries listed, wrong language, ...), and - worse - the Cython files (`.pyx`, `.pxi`, `.pxd`) themselves import or include a lot of unnecessary stuff (cf. e.g. #4000).",
    "created_at": "2010-11-04T22:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103781",
    "user": "https://github.com/nexttime"
}
```

Patch looks fine so far; I think it will perhaps trigger more rebuilds than necessary, but won't leave out dependent modules (at first glance).

Defining the other includes and depends also looks much better. (We could create a class for libraries, perhaps in a separate file, or read definitions from [a] text file[s].)

Note that there's also a lot of crap in `module_list.py` (unused libraries listed, wrong language, ...), and - worse - the Cython files (`.pyx`, `.pxi`, `.pxd`) themselves import or include a lot of unnecessary stuff (cf. e.g. #4000).



---

archive/issue_comments_103782.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> (We could create a class for libraries, perhaps in a separate file, or read definitions from [a] text file[s].)\n\n... and create our own derived `Extension` class that automates more, or at least takes some more constructor arguments.",
    "created_at": "2010-11-04T22:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103782",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:5 leif]:
> (We could create a class for libraries, perhaps in a separate file, or read definitions from [a] text file[s].)

... and create our own derived `Extension` class that automates more, or at least takes some more constructor arguments.



---

archive/issue_comments_103783.json:
```json
{
    "body": "\n```python\n# We pick a file from numpy which is autogenerated so it has the \n# timestamp of the numpy build. \nnumpy_depends = [SAGE_LOCAL + '/lib/python/site-packages/numpy/core/include/numpy/_numpyconfig.h']\n```\n\n\nUsing an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.",
    "created_at": "2010-11-04T23:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103783",
    "user": "https://github.com/nexttime"
}
```


```python
# We pick a file from numpy which is autogenerated so it has the 
# timestamp of the numpy build. 
numpy_depends = [SAGE_LOCAL + '/lib/python/site-packages/numpy/core/include/numpy/_numpyconfig.h']
```


Using an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.



---

archive/issue_comments_103784.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-05T14:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103784",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_103785.json:
```json
{
    "body": "Upgrade path for testing: [http://sage.math.washington.edu/home/jdemeyer/release/sage-4.6.1.alpha0-upgrade/sage-4.6.1.alpha0-upgrade/](http://sage.math.washington.edu/home/jdemeyer/release/sage-4.6.1.alpha0-upgrade/sage-4.6.1.alpha0-upgrade/)\n\nI tested an upgrade from 4.6 and it worked fine.",
    "created_at": "2010-11-05T14:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103785",
    "user": "https://github.com/jdemeyer"
}
```

Upgrade path for testing: [http://sage.math.washington.edu/home/jdemeyer/release/sage-4.6.1.alpha0-upgrade/sage-4.6.1.alpha0-upgrade/](http://sage.math.washington.edu/home/jdemeyer/release/sage-4.6.1.alpha0-upgrade/sage-4.6.1.alpha0-upgrade/)

I tested an upgrade from 4.6 and it worked fine.



---

archive/issue_comments_103786.json:
```json
{
    "body": "Replying to [comment:7 leif]:\n> Using an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.\n\nYou mean touching only if numpy's `spkg-install` detects that we really are upgrading to a new version of numpy as opposed to upgrading from `numpy-1.5.0.spkg` to `numpy-1.5.0.p0.spkg`?  That looks like a lot of hassle for a small gain...",
    "created_at": "2010-11-05T14:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103786",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 leif]:
> Using an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.

You mean touching only if numpy's `spkg-install` detects that we really are upgrading to a new version of numpy as opposed to upgrading from `numpy-1.5.0.spkg` to `numpy-1.5.0.p0.spkg`?  That looks like a lot of hassle for a small gain...



---

archive/issue_comments_103787.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:7 leif]:\n> > Using an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.\n> \n> You mean touching only if numpy's `spkg-install` detects that we really are upgrading to a new version of numpy as opposed to upgrading from `numpy-1.5.0.spkg` to `numpy-1.5.0.p0.spkg`?\n\nAt least that. (In rare cases, a Sage-only update might also require rebuilding the libraries though, which the spkg [maintainer] will be aware of and do the touch, too.)\n\nMany upstream upgrades will not require rebuilding the extension modules at all.\n\n> That looks like a lot of hassle for a small gain...\n\n:-) Depends on your hardware...\n\nIt's just that there are so many \"brute-force\" schemes in Sage that could be much cleaner, not necessarily to speed up the build process but because they break potential improvements, frequently cause trouble and make Sage *less* maintainable.\n\nBut I'm ok with your patch. There's always a next release for further improvements... ;-)\n\n(I assume the upgrade path contains your unmodified patch.)",
    "created_at": "2010-11-05T14:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103787",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 leif]:
> > Using an autogenerated file is of course safe, but we could also handle proper touching (as needed) in NumPy's `spkg-install` (cf. #4797); bumping the (Sage) patch level usually does not require a rebuild of modules depending on such an spkg.
> 
> You mean touching only if numpy's `spkg-install` detects that we really are upgrading to a new version of numpy as opposed to upgrading from `numpy-1.5.0.spkg` to `numpy-1.5.0.p0.spkg`?

At least that. (In rare cases, a Sage-only update might also require rebuilding the libraries though, which the spkg [maintainer] will be aware of and do the touch, too.)

Many upstream upgrades will not require rebuilding the extension modules at all.

> That looks like a lot of hassle for a small gain...

:-) Depends on your hardware...

It's just that there are so many "brute-force" schemes in Sage that could be much cleaner, not necessarily to speed up the build process but because they break potential improvements, frequently cause trouble and make Sage *less* maintainable.

But I'm ok with your patch. There's always a next release for further improvements... ;-)

(I assume the upgrade path contains your unmodified patch.)



---

archive/issue_comments_103788.json:
```json
{
    "body": "P.S.: In the case of NumPy (#9808), I also used `_numpyconfig.h`, but apparently forgot to post that on the long ticket I could then no longer follow.\n\nAn alternative is to use Cython's NumPy header (`local/lib/python/site-packages/Cython/Includes/numpy.pxd`, which all relevant extension modules include) and in addition NumPy's C headers this file depends on, which are `numpy/arrayobject.h` and `numpy/ufuncobject.h`.\n\nI haven't tested this though; *in principle* our build system should be smart enough to deduce these indirect dependencies by itself.",
    "created_at": "2010-11-05T15:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103788",
    "user": "https://github.com/nexttime"
}
```

P.S.: In the case of NumPy (#9808), I also used `_numpyconfig.h`, but apparently forgot to post that on the long ticket I could then no longer follow.

An alternative is to use Cython's NumPy header (`local/lib/python/site-packages/Cython/Includes/numpy.pxd`, which all relevant extension modules include) and in addition NumPy's C headers this file depends on, which are `numpy/arrayobject.h` and `numpy/ufuncobject.h`.

I haven't tested this though; *in principle* our build system should be smart enough to deduce these indirect dependencies by itself.



---

archive/issue_comments_103789.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> Many upstream upgrades will not require rebuilding the extension modules at all. \n\nTrying to automagically detect when to rebuild modules depending on numpy looks error-prone to me.  Rebuilding them for every numpy upgrade might not be necessary, but I don't think it is that much overkill (at least you have to agree that rebuilding only *selected* modules is better than a `./sage -ba`)",
    "created_at": "2010-11-05T16:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103789",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 leif]:
> Many upstream upgrades will not require rebuilding the extension modules at all. 

Trying to automagically detect when to rebuild modules depending on numpy looks error-prone to me.  Rebuilding them for every numpy upgrade might not be necessary, but I don't think it is that much overkill (at least you have to agree that rebuilding only *selected* modules is better than a `./sage -ba`)



---

archive/issue_comments_103790.json:
```json
{
    "body": "So it's not impossible... ;-)\n\nSuccessfully upgraded from Sage 4.5.3 (built from scratch, without renaming the directory) on Ubuntu 10.04 x86_64.\n\n`ptestlong` in progress, though I don't expect any issues (at least not caused by NumPy or this patch).",
    "created_at": "2010-11-05T18:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103790",
    "user": "https://github.com/nexttime"
}
```

So it's not impossible... ;-)

Successfully upgraded from Sage 4.5.3 (built from scratch, without renaming the directory) on Ubuntu 10.04 x86_64.

`ptestlong` in progress, though I don't expect any issues (at least not caused by NumPy or this patch).



---

archive/issue_comments_103791.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-05T18:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103791",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_103792.json:
```json
{
    "body": "Replying to [comment:13 leif]:\n> Successfully upgraded from Sage 4.5.3 (built from scratch, without renaming the directory) on Ubuntu 10.04 x86_64.\n> \n> `ptestlong` in progress, though I don't expect any issues (at least not caused by NumPy or this patch).\n\nAs expected, `ptestlong` passed all tests.",
    "created_at": "2010-11-05T19:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103792",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:13 leif]:
> Successfully upgraded from Sage 4.5.3 (built from scratch, without renaming the directory) on Ubuntu 10.04 x86_64.
> 
> `ptestlong` in progress, though I don't expect any issues (at least not caused by NumPy or this patch).

As expected, `ptestlong` passed all tests.



---

archive/issue_comments_103793.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-10T22:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10213",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10213#issuecomment-103793",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
