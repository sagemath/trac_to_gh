# Issue 14196: Run sage-location before installing spkgs

archive/issues_014196.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @jdemeyer\n\nIt turns out that, in principle, one could download a binary of Sage, and then *before starting* try to install an optional spkg.  If that spkg depends on one of the things which `sage-location` changes the hardcoding location of, then compilation will fail.\n\nThis happened with graphviz, for example; see comment:5:ticket:7438.  See also [this sage-devel thread](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/KVaRN7l-5oo).\n\n**Apply** [attachment:14400_location_before_spkg.patch] to `SAGE_ROOT`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14400\n\n",
    "closed_at": "2013-04-12T14:36:00Z",
    "created_at": "2013-04-02T18:43:34Z",
    "labels": [
        "component: scripts",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Run sage-location before installing spkgs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14196",
    "user": "https://github.com/kcrisman"
}
```
Assignee: @nexttime

CC:  @jdemeyer

It turns out that, in principle, one could download a binary of Sage, and then *before starting* try to install an optional spkg.  If that spkg depends on one of the things which `sage-location` changes the hardcoding location of, then compilation will fail.

This happened with graphviz, for example; see comment:5:ticket:7438.  See also [this sage-devel thread](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/KVaRN7l-5oo).

**Apply** [attachment:14400_location_before_spkg.patch] to `SAGE_ROOT`.

Issue created by migration from https://trac.sagemath.org/ticket/14400





---

archive/issue_comments_178150.json:
```json
{
    "body": "Then please add the file triggering the run of `sage-location` to any bdist.\n\n`sage-location` is already run too often, and meanwhile does a lot of things regardless whether it's necessary or not, taking pretty long on slow media.",
    "created_at": "2013-04-02T23:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178150",
    "user": "https://github.com/nexttime"
}
```

Then please add the file triggering the run of `sage-location` to any bdist.

`sage-location` is already run too often, and meanwhile does a lot of things regardless whether it's necessary or not, taking pretty long on slow media.



---

archive/issue_comments_178151.json:
```json
{
    "body": "P.S.: I agree it makes sense to run `sage-location` in this case (once), but its purpose is not to in general do what an spkg's `spkg-install` should do.",
    "created_at": "2013-04-02T23:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178151",
    "user": "https://github.com/nexttime"
}
```

P.S.: I agree it makes sense to run `sage-location` in this case (once), but its purpose is not to in general do what an spkg's `spkg-install` should do.



---

archive/issue_comments_178152.json:
```json
{
    "body": "> Then please add the file triggering the run of `sage-location` to any bdist.\n\nI'm not sure what you mean by this.  What file?  \n> P.S.: I agree it makes sense to run sage-location in this case (once), but its purpose is not to in general do what an spkg's spkg-install should do.\n\nYes, I totally agree, just am not sure how else to resolve this.\n\nBasically, we just need a way to ensure that before *anything* else happens with a bdist run for the first time, including a new spkg, `sage-location` is run.",
    "created_at": "2013-04-03T01:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178152",
    "user": "https://github.com/kcrisman"
}
```

> Then please add the file triggering the run of `sage-location` to any bdist.

I'm not sure what you mean by this.  What file?  
> P.S.: I agree it makes sense to run sage-location in this case (once), but its purpose is not to in general do what an spkg's spkg-install should do.

Yes, I totally agree, just am not sure how else to resolve this.

Basically, we just need a way to ensure that before *anything* else happens with a bdist run for the first time, including a new spkg, `sage-location` is run.



---

archive/issue_comments_178153.json:
```json
{
    "body": "Replying to [comment:3 kcrisman]:\n> > Then please add the file triggering the run of `sage-location` to any bdist.\n\n> I'm not sure what you mean by this.  What file?\n\n```sh\n# Touch this file to force a sage-location run next time Sage is\n# started.  This is needed to make some of the installed libraries and\n# scripts independent of the SAGE_ROOT path.\ntouch \"$SAGE_LOCAL/lib/sage-force-relocate.txt\"\n```",
    "created_at": "2013-04-03T01:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178153",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:3 kcrisman]:
> > Then please add the file triggering the run of `sage-location` to any bdist.

> I'm not sure what you mean by this.  What file?

```sh
# Touch this file to force a sage-location run next time Sage is
# started.  This is needed to make some of the installed libraries and
# scripts independent of the SAGE_ROOT path.
touch "$SAGE_LOCAL/lib/sage-force-relocate.txt"
```



---

archive/issue_comments_178154.json:
```json
{
    "body": "(We still have to change `spkg/bin/sage` to run `sage-location` *before* `sage-spkg` [if `sage-force-relocate` exists].)",
    "created_at": "2013-04-03T01:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178154",
    "user": "https://github.com/nexttime"
}
```

(We still have to change `spkg/bin/sage` to run `sage-location` *before* `sage-spkg` [if `sage-force-relocate` exists].)



---

archive/issue_comments_178155.json:
```json
{
    "body": "Attachment [14400_location_before_spkg.patch](tarball://root/attachments/some-uuid/ticket14400/14400_location_before_spkg.patch) by @jdemeyer created at 2013-04-10 10:47:32",
    "created_at": "2013-04-10T10:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178155",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14400_location_before_spkg.patch](tarball://root/attachments/some-uuid/ticket14400/14400_location_before_spkg.patch) by @jdemeyer created at 2013-04-10 10:47:32



---

archive/issue_comments_178156.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-10T10:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178156",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_178157.json:
```json
{
    "body": "Shouldn't we also run sage-location after installation (\"to update paths of the package(s) we just installed.\")?  (Alternately, does this patch now run sage-location too often?)",
    "created_at": "2013-04-10T15:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178157",
    "user": "https://github.com/kcrisman"
}
```

Shouldn't we also run sage-location after installation ("to update paths of the package(s) we just installed.")?  (Alternately, does this patch now run sage-location too often?)



---

archive/issue_comments_178158.json:
```json
{
    "body": "Replying to [comment:8 kcrisman]:\n> Shouldn't we also run sage-location after installation (\"to update paths of the package(s) we just installed.\")?\n\nWe now run `sage-location` at `./sage -b` instead.\n\n> Alternately, does this patch now run sage-location too often?\n\nIt's not really a problem since `sage-location` only does something if needed (e.g. install moved or package installed).",
    "created_at": "2013-04-10T19:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178158",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 kcrisman]:
> Shouldn't we also run sage-location after installation ("to update paths of the package(s) we just installed.")?

We now run `sage-location` at `./sage -b` instead.

> Alternately, does this patch now run sage-location too often?

It's not really a problem since `sage-location` only does something if needed (e.g. install moved or package installed).



---

archive/issue_comments_178159.json:
```json
{
    "body": "But my point is that one might do the following.\n* Install a package (sage-location run)\n* Start Sage without `-b`\nAnd sage-location isn't run, but maybe it should be.  One ordinarily only has to do `sage -b` after an spkg if some files depend on that spkg somehow, but for some optional ones it might not (or one might forget to do it).\n\nAnyway, just trying to make sure that we don't incur the converse problem to the one this ticket is about.\n\n> It's not really a problem since sage-location only does something if needed (e.g. install moved or package installed).\n\nPoint taken.",
    "created_at": "2013-04-10T19:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178159",
    "user": "https://github.com/kcrisman"
}
```

But my point is that one might do the following.
* Install a package (sage-location run)
* Start Sage without `-b`
And sage-location isn't run, but maybe it should be.  One ordinarily only has to do `sage -b` after an spkg if some files depend on that spkg somehow, but for some optional ones it might not (or one might forget to do it).

Anyway, just trying to make sure that we don't incur the converse problem to the one this ticket is about.

> It's not really a problem since sage-location only does something if needed (e.g. install moved or package installed).

Point taken.



---

archive/issue_comments_178160.json:
```json
{
    "body": "Replying to [comment:10 kcrisman]:\n> But my point is that one might do the following.\n> * Install a package (sage-location run)\n> * Start Sage without `-b`\n> And sage-location isn't run\n\n`sage-location` is always run when starting Sage (and this has always been so).",
    "created_at": "2013-04-11T07:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178160",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 kcrisman]:
> But my point is that one might do the following.
> * Install a package (sage-location run)
> * Start Sage without `-b`
> And sage-location isn't run

`sage-location` is always run when starting Sage (and this has always been so).



---

archive/issue_comments_178161.json:
```json
{
    "body": "Gotcha.  In that case I like most of this.  Why are we asking for the banner and setup when searching the src and doc?\n\nI think that Leif's comment about bdists is taken care of since all the build, install, and running options seem to now do `maybe_sage_location`.",
    "created_at": "2013-04-11T15:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178161",
    "user": "https://github.com/kcrisman"
}
```

Gotcha.  In that case I like most of this.  Why are we asking for the banner and setup when searching the src and doc?

I think that Leif's comment about bdists is taken care of since all the build, install, and running options seem to now do `maybe_sage_location`.



---

archive/issue_comments_178162.json:
```json
{
    "body": "Replying to [comment:12 kcrisman]:\n> Why are we asking for the banner and setup when searching the src and doc?\n\nWhat do you mean? I *removed* that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).",
    "created_at": "2013-04-11T15:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178162",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 kcrisman]:
> Why are we asking for the banner and setup when searching the src and doc?

What do you mean? I *removed* that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).



---

archive/issue_comments_178163.json:
```json
{
    "body": "> > Why are we asking for the banner and setup when searching the src and doc?\n\n> What do you mean? I *removed* that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).\nMaybe I misread this, then.\n\n```\n    if [ \"$SAGE_BANNER\" != \"no\" ]; then\n        cat \"$SAGE_LOCAL/bin/sage-banner\"\n    fi\n```\nSo... now we *will* be printing the banner when doing a search, since you removed\n\n```\nSAGE_BANNER=\"no\" \n```\nthis?  Or... I guess if you don't run `sage_setup` you don't have to use that at all, huh.\n\nOkay.  I haven't got a recent enough version of Sage built to check that this applies and really does work, but in principle this is good, thank you for the quick work!",
    "created_at": "2013-04-11T16:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178163",
    "user": "https://github.com/kcrisman"
}
```

> > Why are we asking for the banner and setup when searching the src and doc?

> What do you mean? I *removed* that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).
Maybe I misread this, then.

```
    if [ "$SAGE_BANNER" != "no" ]; then
        cat "$SAGE_LOCAL/bin/sage-banner"
    fi
```
So... now we *will* be printing the banner when doing a search, since you removed

```
SAGE_BANNER="no" 
```
this?  Or... I guess if you don't run `sage_setup` you don't have to use that at all, huh.

Okay.  I haven't got a recent enough version of Sage built to check that this applies and really does work, but in principle this is good, thank you for the quick work!



---

archive/issue_comments_178164.json:
```json
{
    "body": "In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).  I may get to confirm this later today - again, it seems fine, just want to actually try it :)",
    "created_at": "2013-04-11T16:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178164",
    "user": "https://github.com/kcrisman"
}
```

In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).  I may get to confirm this later today - again, it seems fine, just want to actually try it :)



---

archive/issue_comments_178165.json:
```json
{
    "body": "Replying to [comment:15 kcrisman]:\n> In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).\n\n\nI just tried it and it seems that `sage-location` is indeed run:\n\n```\njdemeyer@boxen:/release$ curl http://boxen.math.washington.edu/home/release/sage-5.9.rc0/sage-5.9.rc0-boxen-x86_64-Linux.tar.gz |tar xz\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  885M  100  885M    0     0  18.6M      0  0:00:47  0:00:47 --:--:-- 29.4M\njdemeyer@boxen:/release$ cd sage-5.9.rc0-boxen-x86_64-Linux/\njdemeyer@boxen:/release/sage-5.9.rc0-boxen-x86_64-Linux$ ./sage -f graphviz\nThe Sage installation tree has moved\nfrom /mazur/release/merger/sage-5.9.rc0\n  to /mazur/release/sage-5.9.rc0-boxen-x86_64-Linux\nUpdating various hardcoded paths...\n(Please wait at most a few minutes.)\nDO NOT INTERRUPT THIS.\nDone updating paths.\nAttempting to download package graphviz\n>>> Checking online list of optional packages.\n[.]\n>>> Checking online list of experimental packages.\n[.]\n>>> Found graphviz-2.16.1.p0\n```",
    "created_at": "2013-04-11T20:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178165",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 kcrisman]:
> In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).


I just tried it and it seems that `sage-location` is indeed run:

```
jdemeyer@boxen:/release$ curl http://boxen.math.washington.edu/home/release/sage-5.9.rc0/sage-5.9.rc0-boxen-x86_64-Linux.tar.gz |tar xz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  885M  100  885M    0     0  18.6M      0  0:00:47  0:00:47 --:--:-- 29.4M
jdemeyer@boxen:/release$ cd sage-5.9.rc0-boxen-x86_64-Linux/
jdemeyer@boxen:/release/sage-5.9.rc0-boxen-x86_64-Linux$ ./sage -f graphviz
The Sage installation tree has moved
from /mazur/release/merger/sage-5.9.rc0
  to /mazur/release/sage-5.9.rc0-boxen-x86_64-Linux
Updating various hardcoded paths...
(Please wait at most a few minutes.)
DO NOT INTERRUPT THIS.
Done updating paths.
Attempting to download package graphviz
>>> Checking online list of optional packages.
[.]
>>> Checking online list of experimental packages.
[.]
>>> Found graphviz-2.16.1.p0
```



---

archive/issue_comments_178166.json:
```json
{
    "body": "Given that it applies to my 5.9.beta5 and apparently applies to 5.9.rc0, I guess I'm okay with this :)",
    "created_at": "2013-04-11T20:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178166",
    "user": "https://github.com/kcrisman"
}
```

Given that it applies to my 5.9.beta5 and apparently applies to 5.9.rc0, I guess I'm okay with this :)



---

archive/issue_comments_178167.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-11T20:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178167",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_178168.json:
```json
{
    "body": "graphviz still fails to build though (but that shouldn't matter for this ticket):\n\n```\nIn file included from ../../lib/common/geom.h:24:0,\n                 from ../../lib/common/types.h:29,\n                 from ../../lib/gvc/gvc.h:20,\n                 from gv_tcl.cpp:1672:\n../../lib/common/arith.h:56:24: error: missing binary operator before token \"(\"\n #define INT_MAX  ((int)(~(unsigned)0 >> 1))\n                        ^\n../../lib/common/arith.h:56:24: error: missing binary operator before token \"(\"\n #define INT_MAX  ((int)(~(unsigned)0 >> 1))\n                        ^\nmake[3]: *** [gv_tcl.lo] Error 1\nmake[3]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg/gv'\nmake[2]: *** [all-recursive] Error 1\nmake[2]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg'\nmake[1]: *** [all-recursive] Error 1\nmake[1]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src'\nmake: *** [all] Error 2\nError building Graphviz\n```",
    "created_at": "2013-04-11T20:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178168",
    "user": "https://github.com/jdemeyer"
}
```

graphviz still fails to build though (but that shouldn't matter for this ticket):

```
In file included from ../../lib/common/geom.h:24:0,
                 from ../../lib/common/types.h:29,
                 from ../../lib/gvc/gvc.h:20,
                 from gv_tcl.cpp:1672:
../../lib/common/arith.h:56:24: error: missing binary operator before token "("
 #define INT_MAX  ((int)(~(unsigned)0 >> 1))
                        ^
../../lib/common/arith.h:56:24: error: missing binary operator before token "("
 #define INT_MAX  ((int)(~(unsigned)0 >> 1))
                        ^
make[3]: *** [gv_tcl.lo] Error 1
make[3]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg/gv'
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src'
make: *** [all] Error 2
Error building Graphviz
```



---

archive/issue_comments_178169.json:
```json
{
    "body": "Hilarious.  But you are right that this is irrelevant.  Note that it does build on various systems - at least Mac and sage.math (or at least it did for me on sage.math).",
    "created_at": "2013-04-12T01:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178169",
    "user": "https://github.com/kcrisman"
}
```

Hilarious.  But you are right that this is irrelevant.  Note that it does build on various systems - at least Mac and sage.math (or at least it did for me on sage.math).



---

archive/issue_events_040884.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-12T14:36:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14196#event-40884"
}
```



---

archive/issue_comments_178170.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-12T14:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14196#issuecomment-178170",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
