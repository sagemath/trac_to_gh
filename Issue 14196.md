# Issue 14196: Run sage-location before installing spkgs

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2013-04-02 18:43:34

Assignee: leif

CC:  jdemeyer

It turns out that, in principle, one could download a binary of Sage, and then *before starting* try to install an optional spkg.  If that spkg depends on one of the things which `sage-location` changes the hardcoding location of, then compilation will fail.

This happened with graphviz, for example; see comment:5:ticket:7438.  See also [this sage-devel thread](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/KVaRN7l-5oo).


---

Comment by leif created at 2013-04-02 23:26:19

Then please add the file triggering the run of `sage-location` to any bdist.

`sage-location` is already run too often, and meanwhile does a lot of things regardless whether it's necessary or not, taking pretty long on slow media.


---

Comment by leif created at 2013-04-02 23:32:50

P.S.: I agree it makes sense to run `sage-location` in this case (once), but its purpose is not to in general do what an spkg's `spkg-install` should do.


---

Comment by kcrisman created at 2013-04-03 01:12:27

> Then please add the file triggering the run of `sage-location` to any bdist.
I'm not sure what you mean by this.  What file?  
> P.S.: I agree it makes sense to run sage-location in this case (once), but its purpose is not to in general do what an spkg's spkg-install should do.
Yes, I totally agree, just am not sure how else to resolve this.

Basically, we just need a way to ensure that before _anything_ else happens with a bdist run for the first time, including a new spkg, `sage-location` is run.


---

Comment by leif created at 2013-04-03 01:20:08

Replying to [comment:3 kcrisman]:
> > Then please add the file triggering the run of `sage-location` to any bdist.
> I'm not sure what you mean by this.  What file?


```sh
# Touch this file to force a sage-location run next time Sage is
# started.  This is needed to make some of the installed libraries and
# scripts independent of the SAGE_ROOT path.
touch "$SAGE_LOCAL/lib/sage-force-relocate.txt"
```



---

Comment by leif created at 2013-04-03 01:32:16

(We still have to change `spkg/bin/sage` to run `sage-location` _before_ `sage-spkg` [if `sage-force-relocate` exists].)


---

Attachment


---

Comment by jdemeyer created at 2013-04-10 10:54:40

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-04-10 15:15:34

Shouldn't we also run sage-location after installation ("to update paths of the package(s) we just installed.")?  (Alternately, does this patch now run sage-location too often?)


---

Comment by jdemeyer created at 2013-04-10 19:04:52

Replying to [comment:8 kcrisman]:
> Shouldn't we also run sage-location after installation ("to update paths of the package(s) we just installed.")?
We now run `sage-location` at `./sage -b` instead.

> Alternately, does this patch now run sage-location too often?
It's not really a problem since `sage-location` only does something if needed (e.g. install moved or package installed).


---

Comment by kcrisman created at 2013-04-10 19:36:35

But my point is that one might do the following.
 * Install a package (sage-location run)
 * Start Sage without `-b`
And sage-location isn't run, but maybe it should be.  One ordinarily only has to do `sage -b` after an spkg if some files depend on that spkg somehow, but for some optional ones it might not (or one might forget to do it).

Anyway, just trying to make sure that we don't incur the converse problem to the one this ticket is about.

> It's not really a problem since sage-location only does something if needed (e.g. install moved or package installed).
Point taken.


---

Comment by jdemeyer created at 2013-04-11 07:01:49

Replying to [comment:10 kcrisman]:
> But my point is that one might do the following.
>  * Install a package (sage-location run)
>  * Start Sage without `-b`
> And sage-location isn't run
`sage-location` is always run when starting Sage (and this has always been so).


---

Comment by kcrisman created at 2013-04-11 15:49:08

Gotcha.  In that case I like most of this.  Why are we asking for the banner and setup when searching the src and doc?

I think that Leif's comment about bdists is taken care of since all the build, install, and running options seem to now do `maybe_sage_location`.


---

Comment by jdemeyer created at 2013-04-11 15:57:52

Replying to [comment:12 kcrisman]:
> Why are we asking for the banner and setup when searching the src and doc?
What do you mean? I _removed_ that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).


---

Comment by kcrisman created at 2013-04-11 16:09:59

> > Why are we asking for the banner and setup when searching the src and doc?
> What do you mean? I _removed_ that part in this patch (if you are color-blind like me, I agree it is sometimes difficult to see the difference between added and removed lines in the highlighted patch).
Maybe I misread this, then.

```
    if [ "$SAGE_BANNER" != "no" ]; then
        cat "$SAGE_LOCAL/bin/sage-banner"
    fi
```

So... now we _will_ be printing the banner when doing a search, since you removed

```
SAGE_BANNER="no" 
```

this?  Or... I guess if you don't run `sage_setup` you don't have to use that at all, huh.

Okay.  I haven't got a recent enough version of Sage built to check that this applies and really does work, but in principle this is good, thank you for the quick work!


---

Comment by kcrisman created at 2013-04-11 16:12:48

In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).  I may get to confirm this later today - again, it seems fine, just want to actually try it :)


---

Comment by jdemeyer created at 2013-04-11 20:06:39

Replying to [comment:15 kcrisman]:
> In fact, I guess to review positively, one would want to try it with a build that had this applied, then was immediately moved before installing graphviz (if it hadn't been previously).

I just tried it and it seems that `sage-location` is indeed run:

```
jdemeyer`@`boxen:/release$ curl http://boxen.math.washington.edu/home/release/sage-5.9.rc0/sage-5.9.rc0-boxen-x86_64-Linux.tar.gz |tar xz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  885M  100  885M    0     0  18.6M      0  0:00:47  0:00:47 --:--:-- 29.4M
jdemeyer`@`boxen:/release$ cd sage-5.9.rc0-boxen-x86_64-Linux/
jdemeyer`@`boxen:/release/sage-5.9.rc0-boxen-x86_64-Linux$ ./sage -f graphviz
The Sage installation tree has moved
from /mazur/release/merger/sage-5.9.rc0
  to /mazur/release/sage-5.9.rc0-boxen-x86_64-Linux
Updating various hardcoded paths...
(Please wait at most a few minutes.)
DO NOT INTERRUPT THIS.
Done updating paths.
Attempting to download package graphviz
>>> Checking online list of optional packages.
[.]
>>> Checking online list of experimental packages.
[.]
>>> Found graphviz-2.16.1.p0
```



---

Comment by kcrisman created at 2013-04-11 20:24:43

Given that it applies to my 5.9.beta5 and apparently applies to 5.9.rc0, I guess I'm okay with this :)


---

Comment by kcrisman created at 2013-04-11 20:24:43

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-11 20:43:21

graphviz still fails to build though (but that shouldn't matter for this ticket):

```
In file included from ../../lib/common/geom.h:24:0,
                 from ../../lib/common/types.h:29,
                 from ../../lib/gvc/gvc.h:20,
                 from gv_tcl.cpp:1672:
../../lib/common/arith.h:56:24: error: missing binary operator before token "("
 #define INT_MAX  ((int)(~(unsigned)0 >> 1))
                        ^
../../lib/common/arith.h:56:24: error: missing binary operator before token "("
 #define INT_MAX  ((int)(~(unsigned)0 >> 1))
                        ^
make[3]: *** [gv_tcl.lo] Error 1
make[3]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg/gv'
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src/tclpkg'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/mazur/release/sage-5.9.beta5-boxen-x86_64-Linux/spkg/build/graphviz-2.16.1.p0/src'
make: *** [all] Error 2
Error building Graphviz
```



---

Comment by kcrisman created at 2013-04-12 01:21:19

Hilarious.  But you are right that this is irrelevant.  Note that it does build on various systems - at least Mac and sage.math (or at least it did for me on sage.math).


---

Comment by jdemeyer created at 2013-04-12 14:36:00

Resolution: fixed
