# Issue 11494: Upgrade MPFR to 3.0.1 + upstream patches

archive/issues_011494.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  jpflori zimmerma\n\nKeywords: MPFR spkg wishlist\n\nOur current MPFR spkg is fairly old (based on MPFR 2.4.2), and upgrading it to the latest [stable] upstream release is now on the [\"high-priority wishlist\"](http://wiki.sagemath.org/days32/wishlist).\n\n`spkg-install` also needs a major rewrite, e.g. to make use of (some of) GMP's / MPIR's build flags.\n\nI think I'll provide a new spkg in the next days (weekend, say).\n\nMPFR 3.0.1 was released on April 4th 2011; there are already some [additional upstream patches](http://www.mpfr.org/mpfr-current/allpatches) for that version; see http://www.mpfr.org/mpfr-current/ .\n\nIssue created by migration from https://trac.sagemath.org/ticket/11666\n\n",
    "created_at": "2011-08-08T17:37:32Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Upgrade MPFR to 3.0.1 + upstream patches",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11494",
    "user": "leif"
}
```
Assignee: tbd

CC:  jpflori zimmerma

Keywords: MPFR spkg wishlist

Our current MPFR spkg is fairly old (based on MPFR 2.4.2), and upgrading it to the latest [stable] upstream release is now on the ["high-priority wishlist"](http://wiki.sagemath.org/days32/wishlist).

`spkg-install` also needs a major rewrite, e.g. to make use of (some of) GMP's / MPIR's build flags.

I think I'll provide a new spkg in the next days (weekend, say).

MPFR 3.0.1 was released on April 4th 2011; there are already some [additional upstream patches](http://www.mpfr.org/mpfr-current/allpatches) for that version; see http://www.mpfr.org/mpfr-current/ .

Issue created by migration from https://trac.sagemath.org/ticket/11666





---

archive/issue_comments_128415.json:
```json
{
    "body": "Changing keywords from \"MPFR spkg wishlist\" to \"sd32 MPFR spkg wishlist\".",
    "created_at": "2011-08-24T23:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128415",
    "user": "was"
}
```

Changing keywords from "MPFR spkg wishlist" to "sd32 MPFR spkg wishlist".



---

archive/issue_comments_128416.json:
```json
{
    "body": "Changing assignee from tbd to leif.",
    "created_at": "2011-09-18T01:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128416",
    "user": "leif"
}
```

Changing assignee from tbd to leif.



---

archive/issue_comments_128417.json:
```json
{
    "body": "The second release candidate is out:\n\n [...] The main changes since this first release candidate are:\n \n- Fixed `--enable-gmp-internals`.\n- Handle the special cases in `mpfr_cmp_q()` and `mpfr_cmp_f()` (fixing the problem with the `erange` flag in particular).\n- Added `mpfr_buildopt_gmpinternals_p()` function.\n- MPFR manual update and minor corrections.\n\n Here's a second release candidate. As there should not be new platform-specific problems, the final release is delayed by a few days only.\n\n [...] \n\n http://www.mpfr.org/mpfr-3.1.0/mpfr-3.1.0-rc2.tar.bz2 \n\n [...] \n\n\n The MD5's: \n\n [...] \n\n `6ba48c87687959d5e68cd695686257f4  mpfr-3.1.0-rc2.tar.bz2` \n\n [...] \n\n\n [...]\n\n\nFinal release now scheduled for October 3rd.",
    "created_at": "2011-09-22T17:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128417",
    "user": "leif"
}
```

The second release candidate is out:

 [...] The main changes since this first release candidate are:
 
- Fixed `--enable-gmp-internals`.
- Handle the special cases in `mpfr_cmp_q()` and `mpfr_cmp_f()` (fixing the problem with the `erange` flag in particular).
- Added `mpfr_buildopt_gmpinternals_p()` function.
- MPFR manual update and minor corrections.

 Here's a second release candidate. As there should not be new platform-specific problems, the final release is delayed by a few days only.

 [...] 

 http://www.mpfr.org/mpfr-3.1.0/mpfr-3.1.0-rc2.tar.bz2 

 [...] 


 The MD5's: 

 [...] 

 `6ba48c87687959d5e68cd695686257f4  mpfr-3.1.0-rc2.tar.bz2` 

 [...] 


 [...]


Final release now scheduled for October 3rd.



---

archive/issue_comments_128418.json:
```json
{
    "body": "The final MPFR 3.1.0 has been released today.\n\nSee the description for links.",
    "created_at": "2011-10-03T22:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128418",
    "user": "leif"
}
```

The final MPFR 3.1.0 has been released today.

See the description for links.



---

archive/issue_comments_128419.json:
```json
{
    "body": "I have an spkg at http://sage.math.washington.edu/mpfr-3.1.0.spkg.  This is needed for flint2.",
    "created_at": "2011-12-17T11:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128419",
    "user": "mhansen"
}
```

I have an spkg at http://sage.math.washington.edu/mpfr-3.1.0.spkg.  This is needed for flint2.



---

archive/issue_comments_128420.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-12-17T11:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128420",
    "user": "mhansen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128421.json:
```json
{
    "body": "Shouldn't the dependency be the other way around? That is mpfi needs mpfr rather than mpfr needs mpfi? Have you tested this on a 32bit OS?",
    "created_at": "2011-12-17T18:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128421",
    "user": "fbissey"
}
```

Shouldn't the dependency be the other way around? That is mpfi needs mpfr rather than mpfr needs mpfi? Have you tested this on a 32bit OS?



---

archive/issue_comments_128422.json:
```json
{
    "body": "This version of MPFI should work with both versions of MPFR.  However, the old version of MPFI will not work with the new version of MPFI.\n\nI haven't tested it on a 32bit OS.  This was primarily just so we could build flint2 in Sage.",
    "created_at": "2011-12-17T18:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128422",
    "user": "mhansen"
}
```

This version of MPFI should work with both versions of MPFR.  However, the old version of MPFI will not work with the new version of MPFI.

I haven't tested it on a 32bit OS.  This was primarily just so we could build flint2 in Sage.



---

archive/issue_comments_128423.json:
```json
{
    "body": "I wonder why comment [comment:8] speaks about MPFI. Also, upstream (MPFR) we have seen several\nproblems with the `--enable-thread-safe` option which is now enabled by default. Unless needed\nfor Sage, my advice would be to configure MPFR with `--disable-thread-safe`.\n\nPaul",
    "created_at": "2011-12-18T19:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128423",
    "user": "zimmerma"
}
```

I wonder why comment [comment:8] speaks about MPFI. Also, upstream (MPFR) we have seen several
problems with the `--enable-thread-safe` option which is now enabled by default. Unless needed
for Sage, my advice would be to configure MPFR with `--disable-thread-safe`.

Paul



---

archive/issue_comments_128424.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-12-18T19:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128424",
    "user": "zimmerma"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_128425.json:
```json
{
    "body": "the url from comment [comment:7] does not work.\n\nPaul",
    "created_at": "2011-12-18T19:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128425",
    "user": "zimmerma"
}
```

the url from comment [comment:7] does not work.

Paul



---

archive/issue_comments_128426.json:
```json
{
    "body": "Replying to [comment:11 zimmerma]:\n> I wonder why comment [comment:8] speaks about MPFI. Also, upstream (MPFR) we have seen several\n> problems with the `--enable-thread-safe` option which is now enabled by default. Unless needed\n> for Sage, my advice would be to configure MPFR with `--disable-thread-safe`.\n> \nI spoke about mpfi because this ticket is marked as depending on #12171 which is upgrading mpfi. My understanding of the dependency field is that it means that you need #12171 for this ticket. This is silly and should be the other way around.\n\nI think comment 9 has not been written with a clear mind. \n\nI asked about test on 32bit machine because of this [ https://github.com/cschwan/sage-on-gentoo/issues/13].",
    "created_at": "2011-12-18T21:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128426",
    "user": "fbissey"
}
```

Replying to [comment:11 zimmerma]:
> I wonder why comment [comment:8] speaks about MPFI. Also, upstream (MPFR) we have seen several
> problems with the `--enable-thread-safe` option which is now enabled by default. Unless needed
> for Sage, my advice would be to configure MPFR with `--disable-thread-safe`.
> 
I spoke about mpfi because this ticket is marked as depending on #12171 which is upgrading mpfi. My understanding of the dependency field is that it means that you need #12171 for this ticket. This is silly and should be the other way around.

I think comment 9 has not been written with a clear mind. 

I asked about test on 32bit machine because of this [ https://github.com/cschwan/sage-on-gentoo/issues/13].



---

archive/issue_comments_128427.json:
```json
{
    "body": "The spkg is actually at http://sage.math.washington.edu/home/mhansen/mpfr-3.1.0.spkg\n\nLet me clarify the MPFI issue since I must have been too tired when I tried before.  If we were to just install this version of MPFR, the current MPFI (1.3.4) will fail to build since it uses something which has been removed/moved in the new version of MPFR.  If the new version of MPFI works with both the old and new versions of MPFR.  So, if we want to actually include this package in Sage, we have to have the new version of MPFI in first.  This is the reason I listed the MPFI ticket as a dependency of this one.",
    "created_at": "2011-12-19T10:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128427",
    "user": "mhansen"
}
```

The spkg is actually at http://sage.math.washington.edu/home/mhansen/mpfr-3.1.0.spkg

Let me clarify the MPFI issue since I must have been too tired when I tried before.  If we were to just install this version of MPFR, the current MPFI (1.3.4) will fail to build since it uses something which has been removed/moved in the new version of MPFR.  If the new version of MPFI works with both the old and new versions of MPFR.  So, if we want to actually include this package in Sage, we have to have the new version of MPFI in first.  This is the reason I listed the MPFI ticket as a dependency of this one.



---

archive/issue_comments_128428.json:
```json
{
    "body": "You are making sense now. I indeed remember making a patch for mpfi-1.4 to build against mpfr-3.x in gentoo, it would apply to 1.3.4 as well I think. Anyway there are a number of things to fix as far as I can see because of the inclusion of these two.",
    "created_at": "2011-12-19T18:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128428",
    "user": "fbissey"
}
```

You are making sense now. I indeed remember making a patch for mpfi-1.4 to build against mpfr-3.x in gentoo, it would apply to 1.3.4 as well I think. Anyway there are a number of things to fix as far as I can see because of the inclusion of these two.



---

archive/issue_comments_128429.json:
```json
{
    "body": "Some thoughts about the spkg-install script:\n\n* It sets some CFLAGS and others itself, is it needed? does not mpfr look for the gmp header and pumps from there if possible? and should we take advantage of this (as in done for mpir where spkg-install look at what mpir chooses if CFLAGS et al. are empty)?\n* Is the patch for Solaris stuff still needed? (see #6453) -> at least the code in mpn_exp.c did not change in mpfr 3.1.0, so I guess it has to be included to support outdated Solaris systems where memset is buggy?\n* It always runs the test suite, whether SAGE_CHECK is set (then it is ran twice...) or not (then just once), is there still a good reason for doing so? It seems that such a behavior was also present in the MPIR spkg but was removed (see #9522 and !#8664)\n* make should be replaced by $MAKE in spkg-check",
    "created_at": "2012-01-08T12:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128429",
    "user": "jpflori"
}
```

Some thoughts about the spkg-install script:

* It sets some CFLAGS and others itself, is it needed? does not mpfr look for the gmp header and pumps from there if possible? and should we take advantage of this (as in done for mpir where spkg-install look at what mpir chooses if CFLAGS et al. are empty)?
* Is the patch for Solaris stuff still needed? (see #6453) -> at least the code in mpn_exp.c did not change in mpfr 3.1.0, so I guess it has to be included to support outdated Solaris systems where memset is buggy?
* It always runs the test suite, whether SAGE_CHECK is set (then it is ran twice...) or not (then just once), is there still a good reason for doing so? It seems that such a behavior was also present in the MPIR spkg but was removed (see #9522 and !#8664)
* make should be replaced by $MAKE in spkg-check



---

archive/issue_comments_128430.json:
```json
{
    "body": "> It sets some CFLAGS and others itself, is it needed? \n\nas a developer of MPFR I strongly recommend to let MPFR choose the same CC and CFLAGS as GMP\n(they are read in gmp.h). Since we do this for MPFR, this greatly improved the portability of\nMPFR on different platforms with different compilers, in particuler it solves the ABI=32 vs ABI=64\nissues.\n\n> Is the patch for Solaris stuff still needed?\n\nI guess yes, since this was a bug in the Solaris kernel.\n\nPaul",
    "created_at": "2012-01-08T21:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128430",
    "user": "zimmerma"
}
```

> It sets some CFLAGS and others itself, is it needed? 

as a developer of MPFR I strongly recommend to let MPFR choose the same CC and CFLAGS as GMP
(they are read in gmp.h). Since we do this for MPFR, this greatly improved the portability of
MPFR on different platforms with different compilers, in particuler it solves the ABI=32 vs ABI=64
issues.

> Is the patch for Solaris stuff still needed?

I guess yes, since this was a bug in the Solaris kernel.

Paul



---

archive/issue_comments_128431.json:
```json
{
    "body": "I've tested this spkg on top of #12171 on my 64-bit laptop (Core 2 Duo): all doctests pass.\n\nPaul",
    "created_at": "2012-01-08T23:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128431",
    "user": "zimmerma"
}
```

I've tested this spkg on top of #12171 on my 64-bit laptop (Core 2 Duo): all doctests pass.

Paul



---

archive/issue_comments_128432.json:
```json
{
    "body": "Replying to [comment:18 zimmerma]:\n> I've tested this spkg on top of #12171 on my 64-bit laptop (Core 2 Duo): all doctests pass.\n> \nYes 64bit is fine as far as I can tell. It's 32bit that's the trouble - both linux and OS X [10.5.8], don't know about other like solaris or cygwin.",
    "created_at": "2012-01-09T00:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128432",
    "user": "fbissey"
}
```

Replying to [comment:18 zimmerma]:
> I've tested this spkg on top of #12171 on my 64-bit laptop (Core 2 Duo): all doctests pass.
> 
Yes 64bit is fine as far as I can tell. It's 32bit that's the trouble - both linux and OS X [10.5.8], don't know about other like solaris or cygwin.



---

archive/issue_comments_128433.json:
```json
{
    "body": "Changing keywords from \"sd32 MPFR spkg wishlist\" to \"sd32 MPFR spkg wishlist sd35.5\".",
    "created_at": "2012-01-09T08:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128433",
    "user": "zimmerma"
}
```

Changing keywords from "sd32 MPFR spkg wishlist" to "sd32 MPFR spkg wishlist sd35.5".



---

archive/issue_comments_128434.json:
```json
{
    "body": "on a 32-bit Pentium 4, after applying #12171 and importing this spkg, I get when I start Sage:\n\n```\nImportError: /localdisk/tmp/sage-4.7.2/local/lib/libmpfi.so.0: undefined symbol: mpfr_add_d\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n```\n\nMaybe I should first import this spkg then that of MPFI?\n\nPaul",
    "created_at": "2012-01-09T08:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128434",
    "user": "zimmerma"
}
```

on a 32-bit Pentium 4, after applying #12171 and importing this spkg, I get when I start Sage:

```
ImportError: /localdisk/tmp/sage-4.7.2/local/lib/libmpfi.so.0: undefined symbol: mpfr_add_d
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```

Maybe I should first import this spkg then that of MPFI?

Paul



---

archive/issue_comments_128435.json:
```json
{
    "body": "Still about the spkg itself:\n\n* Is there any reason to \"unset RM\"? it says it messes with libtool while running \"make check\". I do not see this restriction in the MPIR package, or the MPFI one e.g. Is this for a specific architecture? Is this really needed? I guess this is fixed by #3537\n* MAKE is set back to make before running \"make install\" (and then \"make check\" in the original package), any undocumented reason?\n\nI'll test all of this on my system but if someone can point me to the relevant info, I'd be grateful, Google wans not that helpful.",
    "created_at": "2012-01-09T08:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128435",
    "user": "jpflori"
}
```

Still about the spkg itself:

* Is there any reason to "unset RM"? it says it messes with libtool while running "make check". I do not see this restriction in the MPIR package, or the MPFI one e.g. Is this for a specific architecture? Is this really needed? I guess this is fixed by #3537
* MAKE is set back to make before running "make install" (and then "make check" in the original package), any undocumented reason?

I'll test all of this on my system but if someone can point me to the relevant info, I'd be grateful, Google wans not that helpful.



---

archive/issue_comments_128436.json:
```json
{
    "body": "I've put an updated package implementing my remarks, mainly using the mpir spkg-install file, I've also updated the description and license info.\n\nIt can be found at\n\nhttp://perso.telecom-paristech.fr/sage/mpfr-3.1.0.spkg\n\nIt seems to do what it should, and uccessfully built and rand MPFR test suite on a \"usual\" intel 64 bit system, not any idea if I broke anything for more exotic architectures. Did not ran sage test suite either.",
    "created_at": "2012-01-09T10:30:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128436",
    "user": "jpflori"
}
```

I've put an updated package implementing my remarks, mainly using the mpir spkg-install file, I've also updated the description and license info.

It can be found at

http://perso.telecom-paristech.fr/sage/mpfr-3.1.0.spkg

It seems to do what it should, and uccessfully built and rand MPFR test suite on a "usual" intel 64 bit system, not any idea if I broke anything for more exotic architectures. Did not ran sage test suite either.



---

archive/issue_comments_128437.json:
```json
{
    "body": "Replying to [comment:23 jpflori]:\n> It can be found at\n> \n> http://perso.telecom-paristech.fr/sage/mpfr-3.1.0.spkg\n\nI do get a 301 to http://perso.telecom-paristech.fr/~sage/mpfr-3.1.0.spkg and that gives a 404.",
    "created_at": "2012-01-09T22:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128437",
    "user": "leif"
}
```

Replying to [comment:23 jpflori]:
> It can be found at
> 
> http://perso.telecom-paristech.fr/sage/mpfr-3.1.0.spkg

I do get a 301 to http://perso.telecom-paristech.fr/~sage/mpfr-3.1.0.spkg and that gives a 404.



---

archive/issue_comments_128438.json:
```json
{
    "body": "Replying to [comment:22 jpflori]:\n> Still about the spkg itself:\n> \n>  * Is there any reason to \"unset RM\"? it says it messes with libtool while running \"make check\". I do not see this restriction in the MPIR package, or the MPFI one e.g. Is this for a specific architecture? Is this really needed? I guess this is fixed by #3537.\n\nUnsetting `RM` is safe, but meanwhile a bit redundant.  Newer autotools use `$RM` instead of `rm -f` (or `$RM -f`), so tend to fail if `RM` happens to be set to (just) `rm`.\n\n\n\n\n>  * MAKE is set back to make before running \"make install\" (and then \"make check\" in the original package), any undocumented reason?\n\nI'm pretty sure that's a relict from when people didn't know how to properly disable *parallel* `make`.  If in doubt, use `$MAKE -j1 install` etc.",
    "created_at": "2012-01-09T22:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128438",
    "user": "leif"
}
```

Replying to [comment:22 jpflori]:
> Still about the spkg itself:
> 
>  * Is there any reason to "unset RM"? it says it messes with libtool while running "make check". I do not see this restriction in the MPIR package, or the MPFI one e.g. Is this for a specific architecture? Is this really needed? I guess this is fixed by #3537.

Unsetting `RM` is safe, but meanwhile a bit redundant.  Newer autotools use `$RM` instead of `rm -f` (or `$RM -f`), so tend to fail if `RM` happens to be set to (just) `rm`.




>  * MAKE is set back to make before running "make install" (and then "make check" in the original package), any undocumented reason?

I'm pretty sure that's a relict from when people didn't know how to properly disable *parallel* `make`.  If in doubt, use `$MAKE -j1 install` etc.



---

archive/issue_comments_128439.json:
```json
{
    "body": "Sorry, this should be http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.spkg",
    "created_at": "2012-01-09T22:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128439",
    "user": "jpflori"
}
```

Sorry, this should be http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.spkg



---

archive/issue_comments_128440.json:
```json
{
    "body": "Replying to [comment:21 zimmerma]:\n> Maybe I should first import this spkg then that of MPFI?\n\nSince MPFI depends on MPFR (and MPIR), you have to rebuild MPFI after upgrading one of the latter.\n\nIf you have enough time (and/or the machine is fast enough), you can copy new/updated spkgs into `$SAGE_ROOT/spkg/standard/` and run\n\n\n```sh\n$ env SAGE_UPGRADING=yes make build\n```\n\nafterwards.  That way all dependent packages automatically get rebuilt, which can take some time.\n\n(Unfortunately there are also a couple of stupid transitive dependencies; e.g. ATLAS gets rebuilt if you update readline -- just because ATLAS now has an `spkg-install` file written in Python, and Python depends on readline...  So a lot of rebuilds performed by `make` aren't really necessary.)",
    "created_at": "2012-01-09T22:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128440",
    "user": "leif"
}
```

Replying to [comment:21 zimmerma]:
> Maybe I should first import this spkg then that of MPFI?

Since MPFI depends on MPFR (and MPIR), you have to rebuild MPFI after upgrading one of the latter.

If you have enough time (and/or the machine is fast enough), you can copy new/updated spkgs into `$SAGE_ROOT/spkg/standard/` and run


```sh
$ env SAGE_UPGRADING=yes make build
```

afterwards.  That way all dependent packages automatically get rebuilt, which can take some time.

(Unfortunately there are also a couple of stupid transitive dependencies; e.g. ATLAS gets rebuilt if you update readline -- just because ATLAS now has an `spkg-install` file written in Python, and Python depends on readline...  So a lot of rebuilds performed by `make` aren't really necessary.)



---

archive/issue_comments_128441.json:
```json
{
    "body": "I tried importing the MPFI spkg+patches (#12171) and that spkg on top of 4.8.alpha6 on a 32-bit\nPentium 4 and got the following failures:\n\n```\nsage -t  \"devel/sage-main/sage/matrix/matrix_mpolynomial_dense.pyx\"\nsage -t  \"devel/sage-main/sage/matrix/constructor.py\"\nsage -t  \"devel/sage-main/sage/matrix/matrix2.pyx\"\nsage -t  \"devel/sage-main/sage/misc/randstate.pyx\"\nsage -t  \"devel/sage-main/sage/modules/free_module_element.pyx\"\nsage -t  \"devel/sage-main/sage/rings/real_mpfi.pyx\"\nsage -t  \"devel/sage-main/sage/rings/complex_field.py\"\nsage -t  \"devel/sage-main/sage/rings/complex_interval_field.py\"\nsage -t  \"devel/sage-main/sage/rings/real_mpfr.pyx\" # Killed/crashed\nsage -t  \"devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py\"\n```\n\nPaul",
    "created_at": "2012-01-10T12:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128441",
    "user": "zimmerma"
}
```

I tried importing the MPFI spkg+patches (#12171) and that spkg on top of 4.8.alpha6 on a 32-bit
Pentium 4 and got the following failures:

```
sage -t  "devel/sage-main/sage/matrix/matrix_mpolynomial_dense.pyx"
sage -t  "devel/sage-main/sage/matrix/constructor.py"
sage -t  "devel/sage-main/sage/matrix/matrix2.pyx"
sage -t  "devel/sage-main/sage/misc/randstate.pyx"
sage -t  "devel/sage-main/sage/modules/free_module_element.pyx"
sage -t  "devel/sage-main/sage/rings/real_mpfi.pyx"
sage -t  "devel/sage-main/sage/rings/complex_field.py"
sage -t  "devel/sage-main/sage/rings/complex_interval_field.py"
sage -t  "devel/sage-main/sage/rings/real_mpfr.pyx" # Killed/crashed
sage -t  "devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py"
```

Paul



---

archive/issue_comments_128442.json:
```json
{
    "body": "the failures are most likely due to the fact that the `mpfr_urandom` and `mpfr_urandomb`\nreturn identical values on processors with different word size in MPFR 3.1.0\n(see http://www.mpfr.org/mpfr-3.1.0/#changes).\n\nThe bad news is that this will need changing the doctests.\n\nThe good news is that we won't need any more different doctests on 32-bit and 64-bit\n(assuming the MPIR random generator is independent of the word size).\n\nPaul Zimmermann",
    "created_at": "2012-01-10T12:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128442",
    "user": "zimmerma"
}
```

the failures are most likely due to the fact that the `mpfr_urandom` and `mpfr_urandomb`
return identical values on processors with different word size in MPFR 3.1.0
(see http://www.mpfr.org/mpfr-3.1.0/#changes).

The bad news is that this will need changing the doctests.

The good news is that we won't need any more different doctests on 32-bit and 64-bit
(assuming the MPIR random generator is independent of the word size).

Paul Zimmermann



---

archive/issue_comments_128443.json:
```json
{
    "body": "For the record, Mike's spkg and my updated one both need to be rebased on top of #12131.\n\nI'll take care of that later.",
    "created_at": "2012-01-12T10:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128443",
    "user": "jpflori"
}
```

For the record, Mike's spkg and my updated one both need to be rebased on top of #12131.

I'll take care of that later.



---

archive/issue_comments_128444.json:
```json
{
    "body": "You can finally find a rebased spkg where I discarded some stuff involving ABI which previously made sage print that it was building for 32 bits, whereas it actually had no effect, and which is rebased on #12131 at the usual address:\n\nhttp://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.spkg\n\nI guess the issue with doctests is the last step before \"needs review\"",
    "created_at": "2012-01-23T17:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128444",
    "user": "jpflori"
}
```

You can finally find a rebased spkg where I discarded some stuff involving ABI which previously made sage print that it was building for 32 bits, whereas it actually had no effect, and which is rebased on #12131 at the usual address:

http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.spkg

I guess the issue with doctests is the last step before "needs review"



---

archive/issue_comments_128445.json:
```json
{
    "body": "I guess my last package should be rebased on #12366 which has been merged into 5.beta4.\n\nPaul, any news on the doctests problems ?",
    "created_at": "2012-02-16T08:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128445",
    "user": "jpflori"
}
```

I guess my last package should be rebased on #12366 which has been merged into 5.beta4.

Paul, any news on the doctests problems ?



---

archive/issue_comments_128446.json:
```json
{
    "body": "I will check the doctests on cicero (skynet) but I guess the issue is still there, since nothing was changed. I will try to make a patch (but since I'm in holidays, it might take some time).\n\nPaul",
    "created_at": "2012-02-16T11:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128446",
    "user": "zimmerma"
}
```

I will check the doctests on cicero (skynet) but I guess the issue is still there, since nothing was changed. I will try to make a patch (but since I'm in holidays, it might take some time).

Paul



---

archive/issue_comments_128447.json:
```json
{
    "body": "I tried this patch (with dependencies) on top of Sage 4.8 and got several doctests failures:\n\n```\n        sage -t  devel/sage-11666/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed\n        sage -t  devel/sage-11666/sage/schemes/elliptic_curves/heegner.py # 2 doctests failed\n        sage -t  devel/sage-11666/sage/matrix/matrix2.pyx # 3 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/partition.py # 30 doctests failed\n        sage -t  devel/sage-11666/sage/calculus/calculus.py # 7 doctests failed\n        sage -t  devel/sage-11666/sage/misc/randstate.pyx # 13 doctests failed\n        sage -t  devel/sage-11666/sage/misc/misc.py # 1 doctests failed\n        sage -t  devel/sage-11666/sage/modules/free_module_element.pyx # 2 doctests failed\n        sage -t  devel/sage-11666/sage/rings/real_mpfr.pyx # 12 doctests failed\n        sage -t  devel/sage-11666/sage/matrix/constructor.py # 2 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/sloane_functions.py # 5 doctests failed\n        sage -t  devel/sage-11666/sage/misc/cachefunc.py # 14 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/combinat.py # 1 doctests failed\n        sage -t  devel/sage-11666/sage/libs/fplll/fplll.pyx # Killed/crashed\n        sage -t  devel/sage-11666/sage/combinat/species/species.py # 3 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/species/sum_species.py # 3 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/species/permutation_species.py # 3 doctests failed\n        sage -t  devel/sage-11666/sage/sets/disjoint_union_enumerated_sets.py # 8 doctests failed\n        sage -t  devel/sage-11666/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/species/partition_species.py # 4 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/species/product_species.py # 2 doctests failed\n        sage -t  devel/sage-11666/sage/rings/complex_field.py # 4 doctests failed\n        sage -t  devel/sage-11666/sage/rings/complex_interval_field.py # 3 doctests failed\n        sage -t  devel/sage-11666/sage/combinat/partitions.pyx # 1 doctests failed\n        sage -t  devel/sage-11666/sage/rings/real_mpfi.pyx # 5 doctests failed\n```\n\nCan someone reproduce that?\n\nPaul",
    "created_at": "2012-02-16T16:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128447",
    "user": "zimmerma"
}
```

I tried this patch (with dependencies) on top of Sage 4.8 and got several doctests failures:

```
        sage -t  devel/sage-11666/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed
        sage -t  devel/sage-11666/sage/schemes/elliptic_curves/heegner.py # 2 doctests failed
        sage -t  devel/sage-11666/sage/matrix/matrix2.pyx # 3 doctests failed
        sage -t  devel/sage-11666/sage/combinat/partition.py # 30 doctests failed
        sage -t  devel/sage-11666/sage/calculus/calculus.py # 7 doctests failed
        sage -t  devel/sage-11666/sage/misc/randstate.pyx # 13 doctests failed
        sage -t  devel/sage-11666/sage/misc/misc.py # 1 doctests failed
        sage -t  devel/sage-11666/sage/modules/free_module_element.pyx # 2 doctests failed
        sage -t  devel/sage-11666/sage/rings/real_mpfr.pyx # 12 doctests failed
        sage -t  devel/sage-11666/sage/matrix/constructor.py # 2 doctests failed
        sage -t  devel/sage-11666/sage/combinat/sloane_functions.py # 5 doctests failed
        sage -t  devel/sage-11666/sage/misc/cachefunc.py # 14 doctests failed
        sage -t  devel/sage-11666/sage/combinat/combinat.py # 1 doctests failed
        sage -t  devel/sage-11666/sage/libs/fplll/fplll.pyx # Killed/crashed
        sage -t  devel/sage-11666/sage/combinat/species/species.py # 3 doctests failed
        sage -t  devel/sage-11666/sage/combinat/species/sum_species.py # 3 doctests failed
        sage -t  devel/sage-11666/sage/combinat/species/permutation_species.py # 3 doctests failed
        sage -t  devel/sage-11666/sage/sets/disjoint_union_enumerated_sets.py # 8 doctests failed
        sage -t  devel/sage-11666/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed
        sage -t  devel/sage-11666/sage/combinat/species/partition_species.py # 4 doctests failed
        sage -t  devel/sage-11666/sage/combinat/species/product_species.py # 2 doctests failed
        sage -t  devel/sage-11666/sage/rings/complex_field.py # 4 doctests failed
        sage -t  devel/sage-11666/sage/rings/complex_interval_field.py # 3 doctests failed
        sage -t  devel/sage-11666/sage/combinat/partitions.pyx # 1 doctests failed
        sage -t  devel/sage-11666/sage/rings/real_mpfi.pyx # 5 doctests failed
```

Can someone reproduce that?

Paul



---

archive/issue_comments_128448.json:
```json
{
    "body": "I've begun the test suite. Here are my failures on a Debian amd64 experimental system (on intel core i7) :\n\n\n```\nThe following tests failed:\n\n\tsage -t  -force_lib devel/sage/sage/modular/modsym/ambient.py # 0 doctests failed\n\tsage -t  -force_lib devel/sage/sage/modular/hecke/hecke_operator.py # 0 doctests failed\n\tsage -t  -force_lib devel/sage/sage/modular/hecke/ambient_module.py # 0 doctests failed\n\tsage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/tests/cmdline.py # 4 doctests failed\n\tsage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed\n\tsage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed\n\n```\n\nI'll have a look at them tomorrow.\n\nSome of them at least are just changes in random output (e. g. real_mpfr and real_mpfi)",
    "created_at": "2012-02-16T22:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128448",
    "user": "jpflori"
}
```

I've begun the test suite. Here are my failures on a Debian amd64 experimental system (on intel core i7) :


```
The following tests failed:

	sage -t  -force_lib devel/sage/sage/modular/modsym/ambient.py # 0 doctests failed
	sage -t  -force_lib devel/sage/sage/modular/hecke/hecke_operator.py # 0 doctests failed
	sage -t  -force_lib devel/sage/sage/modular/hecke/ambient_module.py # 0 doctests failed
	sage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/tests/cmdline.py # 4 doctests failed
	sage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed
	sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed

```

I'll have a look at them tomorrow.

Some of them at least are just changes in random output (e. g. real_mpfr and real_mpfi)



---

archive/issue_comments_128449.json:
```json
{
    "body": "Some other look more problematic:\n\n\n```\nsage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\n  ***   Warning: new stack size = 1003360 (0.957 Mbytes).\nSaturation index bound = 265\nWARNING: saturation at primes p > 97 will not be done;  \npoints may be unsaturated at primes between 97 and index bound\nFailed to saturate MW basis at primes [ ]\nSaturation index bound = 265\nWARNING: saturation at primes p > 199 will not be done;  \npoints may be unsaturated at primes between 199 and index bound\nFailed to saturate MW basis at primes [ ]\nAfter 10 attempts at enlargement, giving up!\n--points not proved 2-saturated,\n2-saturation failed!\nFailed to saturate MW basis at primes [ 2 ]\n2 After 10 attempts at enlargement, giving up!\n--points not proved 2-saturated,\n2-saturation failed!\nFailed to saturate MW basis at primes [ 2 ]\n\n```\n\nMaybe because I did not rebuild Pari spkg?\n\nApart from running sage -b I just forced rebuild of libfplll before the above make ptest (because of lack of time).\n\nI'll properly rebuild everything tomorrow and rerun the testsuite.",
    "created_at": "2012-02-16T22:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128449",
    "user": "jpflori"
}
```

Some other look more problematic:


```
sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
Saturation index bound = 265
WARNING: saturation at primes p > 97 will not be done;  
points may be unsaturated at primes between 97 and index bound
Failed to saturate MW basis at primes [ ]
Saturation index bound = 265
WARNING: saturation at primes p > 199 will not be done;  
points may be unsaturated at primes between 199 and index bound
Failed to saturate MW basis at primes [ ]
After 10 attempts at enlargement, giving up!
--points not proved 2-saturated,
2-saturation failed!
Failed to saturate MW basis at primes [ 2 ]
2 After 10 attempts at enlargement, giving up!
--points not proved 2-saturated,
2-saturation failed!
Failed to saturate MW basis at primes [ 2 ]

```

Maybe because I did not rebuild Pari spkg?

Apart from running sage -b I just forced rebuild of libfplll before the above make ptest (because of lack of time).

I'll properly rebuild everything tomorrow and rerun the testsuite.



---

archive/issue_comments_128450.json:
```json
{
    "body": "Nevermind, the above is potentially just verbosity and not related to the actual errors\n\n\n```\nFile \"/home/jp/boulot/sage/sage-4.8/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\", line 2921:\n    sage: 2 * E.elliptic_exponential(z)\nExpected:\n    (2.04119347066305 - 1.10251372205166*I : 2.23105000976838 - 2.69795281735238*I : 1.00000000000000)\nGot:\n    (-1.52184235874404 - 0.0581413944316544*I : 0.948655866506124 - 0.0381469928565030*I : 1.00000000000000)\n**********************************************************************\nFile \"/home/jp/boulot/sage/sage-4.8/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py\", line 2923:\n    sage: E.elliptic_exponential(2 * z)\nExpected:\n    (2.04119347066305 - 1.10251372205167*I : 2.23105000976839 - 2.69795281735236*I : 1.00000000000000)\nGot:\n    (-1.52184235874404 - 0.0581413944316562*I : 0.948655866506128 - 0.0381469928565034*I : 1.00000000000000)\n**********************************************************************\n\n```\n\nAnd the line above defining z implies random so...",
    "created_at": "2012-02-16T22:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128450",
    "user": "jpflori"
}
```

Nevermind, the above is potentially just verbosity and not related to the actual errors


```
File "/home/jp/boulot/sage/sage-4.8/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 2921:
    sage: 2 * E.elliptic_exponential(z)
Expected:
    (2.04119347066305 - 1.10251372205166*I : 2.23105000976838 - 2.69795281735238*I : 1.00000000000000)
Got:
    (-1.52184235874404 - 0.0581413944316544*I : 0.948655866506124 - 0.0381469928565030*I : 1.00000000000000)
**********************************************************************
File "/home/jp/boulot/sage/sage-4.8/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 2923:
    sage: E.elliptic_exponential(2 * z)
Expected:
    (2.04119347066305 - 1.10251372205167*I : 2.23105000976839 - 2.69795281735236*I : 1.00000000000000)
Got:
    (-1.52184235874404 - 0.0581413944316562*I : 0.948655866506128 - 0.0381469928565034*I : 1.00000000000000)
**********************************************************************

```

And the line above defining z implies random so...



---

archive/issue_comments_128451.json:
```json
{
    "body": "On a different system (Debian amd64 experimental on an intel QuadCore2) I get\n\n\n```\nThe following tests failed:\n\n\tsage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed\n\tsage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed\n----------------------------------------------------------------------\n\n```\n\nThis also is on top of 4.8, but I could not launch sage before also rebuilding MPIR which was not necessary on the other system.",
    "created_at": "2012-02-17T11:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128451",
    "user": "jpflori"
}
```

On a different system (Debian amd64 experimental on an intel QuadCore2) I get


```
The following tests failed:

	sage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed
	sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed
----------------------------------------------------------------------

```

This also is on top of 4.8, but I could not launch sage before also rebuilding MPIR which was not necessary on the other system.



---

archive/issue_comments_128452.json:
```json
{
    "body": "Replying to [comment:28 zimmerma]:\n\n> I tried importing the MPFI spkg+patches (#12171) and that spkg on top of 4.8.alpha6 on a 32-bit Pentium 4 and got the following failures: ` sage -t  \"devel/sage-main/sage/matrix/matrix_mpolynomial_dense.pyx\" sage -t  \"devel/sage-main/sage/matrix/constructor.py\" sage -t  \"devel/sage-main/sage/matrix/matrix2.pyx\" sage -t  \"devel/sage-main/sage/misc/randstate.pyx\" sage -t  \"devel/sage-main/sage/modules/free_module_element.pyx\" sage -t  \"devel/sage-main/sage/rings/real_mpfi.pyx\" sage -t  \"devel/sage-main/sage/rings/complex_field.py\" sage -t  \"devel/sage-main/sage/rings/complex_interval_field.py\" sage -t  \"devel/sage-main/sage/rings/real_mpfr.pyx\" # Killed/crashed sage -t  \"devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py\" ` Paul\n\nMy last failures happen in the same files as what you posted some time ago and are always involving some random function.\n\nAs you posted later, this should be because MPFR changed its behavior.\n\nI'll post a patch fixing the doctest, but cannot test it on a 32 bits computer (nor exotic architectures), so I'll leave that to someone else.\n\nThe question is whether this change of behavior is actually a problem ?\n\nIf someone saved old stuff with a given random seed, or something like that, its results will not be reproducible... I do not really feel concerned about that.\n\nIf someone could also test the spkg on sunos, solaris, apple or other exotic oses/cpus combinations, that would be more than welcome.",
    "created_at": "2012-02-17T12:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128452",
    "user": "jpflori"
}
```

Replying to [comment:28 zimmerma]:

> I tried importing the MPFI spkg+patches (#12171) and that spkg on top of 4.8.alpha6 on a 32-bit Pentium 4 and got the following failures: ` sage -t  "devel/sage-main/sage/matrix/matrix_mpolynomial_dense.pyx" sage -t  "devel/sage-main/sage/matrix/constructor.py" sage -t  "devel/sage-main/sage/matrix/matrix2.pyx" sage -t  "devel/sage-main/sage/misc/randstate.pyx" sage -t  "devel/sage-main/sage/modules/free_module_element.pyx" sage -t  "devel/sage-main/sage/rings/real_mpfi.pyx" sage -t  "devel/sage-main/sage/rings/complex_field.py" sage -t  "devel/sage-main/sage/rings/complex_interval_field.py" sage -t  "devel/sage-main/sage/rings/real_mpfr.pyx" # Killed/crashed sage -t  "devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py" ` Paul

My last failures happen in the same files as what you posted some time ago and are always involving some random function.

As you posted later, this should be because MPFR changed its behavior.

I'll post a patch fixing the doctest, but cannot test it on a 32 bits computer (nor exotic architectures), so I'll leave that to someone else.

The question is whether this change of behavior is actually a problem ?

If someone saved old stuff with a given random seed, or something like that, its results will not be reproducible... I do not really feel concerned about that.

If someone could also test the spkg on sunos, solaris, apple or other exotic oses/cpus combinations, that would be more than welcome.



---

archive/issue_comments_128453.json:
```json
{
    "body": "After rebuilding mpir and atlas (which was screwed) on my core i7 setup, here is what I get\n\n\n```\n----------------------------------------------------------------------\nThe temporary doctesting directory\n   /home/jp/.sage/tmp/jp_x220-9822\nwas not removed: it is not empty, presumably because doctests\nfailed or doctesting was interrupted.\n\n----------------------------------------------------------------------\n\nThe following tests failed:\n\n\tsage -t  -force_lib devel/sage/sage/modular/modsym/space.py # 0 doctests failed\n\tsage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed\n\tsage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed\n\tsage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed\n\tsage -t  -force_lib devel/sage/sage/tests/cmdline.py # 4 doctests failed\n\tsage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed\n\tsage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed\n\n```\n\nI guess something went wrong with that installation because the failing doctest in cmdline.pyx really look strange.",
    "created_at": "2012-02-17T17:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128453",
    "user": "jpflori"
}
```

After rebuilding mpir and atlas (which was screwed) on my core i7 setup, here is what I get


```
----------------------------------------------------------------------
The temporary doctesting directory
   /home/jp/.sage/tmp/jp_x220-9822
was not removed: it is not empty, presumably because doctests
failed or doctesting was interrupted.

----------------------------------------------------------------------

The following tests failed:

	sage -t  -force_lib devel/sage/sage/modular/modsym/space.py # 0 doctests failed
	sage -t  -force_lib devel/sage/sage/modules/free_module_element.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix_mpolynomial_dense.pyx # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/constructor.py # 2 doctests failed
	sage -t  -force_lib devel/sage/sage/matrix/matrix2.pyx # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfi.pyx # 5 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_field.py # 4 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/real_mpfr.pyx # 12 doctests failed
	sage -t  -force_lib devel/sage/sage/rings/complex_interval_field.py # 3 doctests failed
	sage -t  -force_lib devel/sage/sage/tests/cmdline.py # 4 doctests failed
	sage -t  -force_lib devel/sage/sage/misc/randstate.pyx # 13 doctests failed
	sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 2 doctests failed

```

I guess something went wrong with that installation because the failing doctest in cmdline.pyx really look strange.



---

archive/issue_comments_128454.json:
```json
{
    "body": "Replying to [comment:27 leif]:\n> If you have enough time (and/or the machine is fast enough), you can copy new/updated spkgs into `$SAGE_ROOT/spkg/standard/` and run\n> \n> {{{\n> #!sh\n> $ env SAGE_UPGRADING=yes make build\n> }}}\n> afterwards.  That way all dependent packages automatically get rebuilt, which can take some time.\n\nshould I rename new packages with the old name? Or keep the new name?\nFor example Sage 4.8 contains `mpfi-1.3.4-cvs20071125.p9.spkg`. Should I put\n`mpfi-1.5.1.spkg` aside this one, or rename it?\n\nPaul",
    "created_at": "2012-02-17T20:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128454",
    "user": "zimmerma"
}
```

Replying to [comment:27 leif]:
> If you have enough time (and/or the machine is fast enough), you can copy new/updated spkgs into `$SAGE_ROOT/spkg/standard/` and run
> 
> {{{
> #!sh
> $ env SAGE_UPGRADING=yes make build
> }}}
> afterwards.  That way all dependent packages automatically get rebuilt, which can take some time.

should I rename new packages with the old name? Or keep the new name?
For example Sage 4.8 contains `mpfi-1.3.4-cvs20071125.p9.spkg`. Should I put
`mpfi-1.5.1.spkg` aside this one, or rename it?

Paul



---

archive/issue_comments_128455.json:
```json
{
    "body": "I just ran the doctests on cicero (skynet) with vanilla 4.8 and all of them pass.\n\nPaul",
    "created_at": "2012-02-20T17:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128455",
    "user": "zimmerma"
}
```

I just ran the doctests on cicero (skynet) with vanilla 4.8 and all of them pass.

Paul



---

archive/issue_comments_128456.json:
```json
{
    "body": "Just to confirm my above statements, on a third amd64 ubuntu system, I get the same errors as above, except the two \"strange\" ones, i.e. cmdline.py and space.py.",
    "created_at": "2012-02-21T08:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128456",
    "user": "jpflori"
}
```

Just to confirm my above statements, on a third amd64 ubuntu system, I get the same errors as above, except the two "strange" ones, i.e. cmdline.py and space.py.



---

archive/issue_comments_128457.json:
```json
{
    "body": "And those last tests were on top sage-5.0.beta4",
    "created_at": "2012-02-21T08:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128457",
    "user": "jpflori"
}
```

And those last tests were on top sage-5.0.beta4



---

archive/issue_comments_128458.json:
```json
{
    "body": "I've had a look at the random MPFR real number generation code and there was indeed a \"hack\" for 32 bits systems before which requested more bits (31 from randstate doc, although real_mpfr says 32) from MPIR to get an equivalent MPFR behavior. Although, if I force sage to do the same on my 64 bits system (just adding a call to rstate.c_random() unconditionally in real_mpfr), I do not get what 32 bits (and 64 bits) systems used to return (nor what my 64 bits system now return which was to expect).\n\nPaul, I'm confused by your last message. By vanilla 4.8, do you mean vanilla+this ticket and dependencies? If that's the case, and I somehow understand correctly the random generation stuff of MPIR and MPFR which should both be hardware independent now, the change I made above should give me a similar behavior as you on a 32 bits system and get no doctest failures.\n\nFor example the last failing test in real_mpfr used to give\n\n\n```\n0.979095507956490\n\n```\n\nWith this ticket and dependencies, I get (on all of my 64 systems)\n\n\n```\n-0.616678906367394\n\n```\n\nWith the additional call to c_random() I get (on all of my 64 systems)\n\n\n```\n0.681934947736557\n```\n",
    "created_at": "2012-02-21T09:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128458",
    "user": "jpflori"
}
```

I've had a look at the random MPFR real number generation code and there was indeed a "hack" for 32 bits systems before which requested more bits (31 from randstate doc, although real_mpfr says 32) from MPIR to get an equivalent MPFR behavior. Although, if I force sage to do the same on my 64 bits system (just adding a call to rstate.c_random() unconditionally in real_mpfr), I do not get what 32 bits (and 64 bits) systems used to return (nor what my 64 bits system now return which was to expect).

Paul, I'm confused by your last message. By vanilla 4.8, do you mean vanilla+this ticket and dependencies? If that's the case, and I somehow understand correctly the random generation stuff of MPIR and MPFR which should both be hardware independent now, the change I made above should give me a similar behavior as you on a 32 bits system and get no doctest failures.

For example the last failing test in real_mpfr used to give


```
0.979095507956490

```

With this ticket and dependencies, I get (on all of my 64 systems)


```
-0.616678906367394

```

With the additional call to c_random() I get (on all of my 64 systems)


```
0.681934947736557
```




---

archive/issue_comments_128459.json:
```json
{
    "body": "> Paul, I'm confused by your last message. By vanilla 4.8, do you mean vanilla+this ticket and dependencies? \n\nno, I just meant vanilla 4.8. This was just to make sure that potential failing doctests did not fail before this patch.\n\nNow with #12171 all doctests still pass (with one timeout even with `-long`,\nfor a test taking more than half an hour).\n\nI'll now try with this spkg.\n\nPaul",
    "created_at": "2012-02-21T11:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128459",
    "user": "zimmerma"
}
```

> Paul, I'm confused by your last message. By vanilla 4.8, do you mean vanilla+this ticket and dependencies? 

no, I just meant vanilla 4.8. This was just to make sure that potential failing doctests did not fail before this patch.

Now with #12171 all doctests still pass (with one timeout even with `-long`,
for a test taking more than half an hour).

I'll now try with this spkg.

Paul



---

archive/issue_comments_128460.json:
```json
{
    "body": "Replying to [comment:46 zimmerma]:\n\n> no, I just meant vanilla 4.8. This was just to make sure that potential failing doctests did not fail before this patch.\n\nThat's good news for the tests I ran above. I guess the piece of hack in real_mpfr should now be removed. Could you try running the tests with and without the c_random() stuff in real_mpfr and post the values you get for the last failing (I guess it will fail as well) in real_mpfr (on 32 bits I mean)?\n\nThe bad news is that we won't be able (or it will be very hackish???) to reproduce the previous behavior of Sage, thus breaking all use code depending on the deterministic behavior of PRNG.",
    "created_at": "2012-02-21T11:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128460",
    "user": "jpflori"
}
```

Replying to [comment:46 zimmerma]:

> no, I just meant vanilla 4.8. This was just to make sure that potential failing doctests did not fail before this patch.

That's good news for the tests I ran above. I guess the piece of hack in real_mpfr should now be removed. Could you try running the tests with and without the c_random() stuff in real_mpfr and post the values you get for the last failing (I guess it will fail as well) in real_mpfr (on 32 bits I mean)?

The bad news is that we won't be able (or it will be very hackish???) to reproduce the previous behavior of Sage, thus breaking all use code depending on the deterministic behavior of PRNG.



---

archive/issue_comments_128461.json:
```json
{
    "body": "> Could you try running the tests with and without the c_random() stuff in real_mpfr [...]\n\nok, I'll first run the tests with the attached spkg. Currently running\n`env SAGE_UPGRADING=yes make build`, this will take some time since cicero is slow.\n\nPaul",
    "created_at": "2012-02-21T11:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128461",
    "user": "zimmerma"
}
```

> Could you try running the tests with and without the c_random() stuff in real_mpfr [...]

ok, I'll first run the tests with the attached spkg. Currently running
`env SAGE_UPGRADING=yes make build`, this will take some time since cicero is slow.

Paul



---

archive/issue_comments_128462.json:
```json
{
    "body": "Jean-Pierre,\n\n> I've had a look at the random MPFR real number generation code and there was indeed a \"hack\" for 32 bits systems before which requested more bits (31 from randstate doc, although real_mpfr says 32) from MPIR to get an equivalent MPFR behavior. Although, if I force sage to do the same on my 64 bits system (just adding a call to rstate.c_random() unconditionally in real_mpfr), I do not get what 32 bits (and 64 bits) systems used to return (nor what my 64 bits system now return which was to expect).\n\nthis is expected. If you add the call to `rstate.c_random()` unconditionally,\nthen on 64-bit systems you will draw 64 extra random bits when the precision mod 64 is between 1 and 32, whereas on 32-bit systems you will draw only 32 extra random bits.\n\nIn fact, since version 3.1.0, MPFR leaves the GMP random generator in the same state,\nwhatever the number of bits per limb. See changeset 7133 from MPFR, and\nhttp://gmplib.org/list-archives/gmp-devel/2010-September/001642.html. Thus the fix is\nsimply to remove the \"gross hack\" at lines 930-942 in real_mpfr.pyx.\n\nPaul",
    "created_at": "2012-02-21T12:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128462",
    "user": "zimmerma"
}
```

Jean-Pierre,

> I've had a look at the random MPFR real number generation code and there was indeed a "hack" for 32 bits systems before which requested more bits (31 from randstate doc, although real_mpfr says 32) from MPIR to get an equivalent MPFR behavior. Although, if I force sage to do the same on my 64 bits system (just adding a call to rstate.c_random() unconditionally in real_mpfr), I do not get what 32 bits (and 64 bits) systems used to return (nor what my 64 bits system now return which was to expect).

this is expected. If you add the call to `rstate.c_random()` unconditionally,
then on 64-bit systems you will draw 64 extra random bits when the precision mod 64 is between 1 and 32, whereas on 32-bit systems you will draw only 32 extra random bits.

In fact, since version 3.1.0, MPFR leaves the GMP random generator in the same state,
whatever the number of bits per limb. See changeset 7133 from MPFR, and
http://gmplib.org/list-archives/gmp-devel/2010-September/001642.html. Thus the fix is
simply to remove the "gross hack" at lines 930-942 in real_mpfr.pyx.

Paul



---

archive/issue_comments_128463.json:
```json
{
    "body": "From what i saw in randstate, c_random calls gmp_urandomb_ui(self.gmp_state, 31).\n\nSo this has different behaviors on the gmp rand internal state on 32 and 64 bits ?\n\nI expected that it didn't, so that adding a call to c_random() even on 64 bits (just to see, I don't plan on integrating it to Sage, removing the hack is indeed the right solution) would produce identical behaviors on 32 and 64 bits, whence my request for you to test it (in fact with the hack and without it, not with a call to c_random added, on 32 bits).\n\nI also had little hope that it could revert the real PNRG to its previous behavior for a given seed (in order not to break existing code, outside Sage source tree I mean).\n\nAnyway, if the mpfr code changed, its completely understandable that the random output changes, even with the same seed, so this is hopeless and not really harmful (to me at least).\n\nAnyway, if you confirm that you get the same values that I get (with no call to c_random at all, ie without the hackish section only running on 32 bits currently), I'll post patches to remove the hack section and correct the doctests.\n",
    "created_at": "2012-02-21T12:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128463",
    "user": "jpflori"
}
```

From what i saw in randstate, c_random calls gmp_urandomb_ui(self.gmp_state, 31).

So this has different behaviors on the gmp rand internal state on 32 and 64 bits ?

I expected that it didn't, so that adding a call to c_random() even on 64 bits (just to see, I don't plan on integrating it to Sage, removing the hack is indeed the right solution) would produce identical behaviors on 32 and 64 bits, whence my request for you to test it (in fact with the hack and without it, not with a call to c_random added, on 32 bits).

I also had little hope that it could revert the real PNRG to its previous behavior for a given seed (in order not to break existing code, outside Sage source tree I mean).

Anyway, if the mpfr code changed, its completely understandable that the random output changes, even with the same seed, so this is hopeless and not really harmful (to me at least).

Anyway, if you confirm that you get the same values that I get (with no call to c_random at all, ie without the hackish section only running on 32 bits currently), I'll post patches to remove the hack section and correct the doctests.




---

archive/issue_comments_128464.json:
```json
{
    "body": "> From what i saw in randstate, c_random calls gmp_urandomb_ui(self.gmp_state, 31).\n> So this has different behaviors on the gmp rand internal state on 32 and 64 bits ?\n\nno it shouldn't. But beware that Sage uses MPIR, not GMP. We should check that MPIR\ngives the same behaviour for the random state on 32-bit and 64-bit processors.\n\nI'll tell you what I get as soon as `make build` finished...\n\nPaul",
    "created_at": "2012-02-21T12:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128464",
    "user": "zimmerma"
}
```

> From what i saw in randstate, c_random calls gmp_urandomb_ui(self.gmp_state, 31).
> So this has different behaviors on the gmp rand internal state on 32 and 64 bits ?

no it shouldn't. But beware that Sage uses MPIR, not GMP. We should check that MPIR
gives the same behaviour for the random state on 32-bit and 64-bit processors.

I'll tell you what I get as soon as `make build` finished...

Paul



---

archive/issue_comments_128465.json:
```json
{
    "body": "The files randbui.c where gmp_urandomb_ui is defined are similar in GMP (5.04) and MPIR (2.1.3.p9 in Sage).\n\nThey only call _gmp_rand defined in gmp-impl.h which looks quite similar as well (in fact I saw no diff but did not check completely, there could be some black magic somewhere deep enough).\n\nFrom what I see in integer_ring.pyx and more specifically in the _randomize_mpz function where c_random is called as well, there is no different sections for 32 and 64 bits, nor different doctest in randstate.pyx (only rgp from Pari does change), so I guess it is not that unsafe to assume that MPIR behaves the same for both.",
    "created_at": "2012-02-21T13:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128465",
    "user": "jpflori"
}
```

The files randbui.c where gmp_urandomb_ui is defined are similar in GMP (5.04) and MPIR (2.1.3.p9 in Sage).

They only call _gmp_rand defined in gmp-impl.h which looks quite similar as well (in fact I saw no diff but did not check completely, there could be some black magic somewhere deep enough).

From what I see in integer_ring.pyx and more specifically in the _randomize_mpz function where c_random is called as well, there is no different sections for 32 and 64 bits, nor different doctest in randstate.pyx (only rgp from Pari does change), so I guess it is not that unsafe to assume that MPIR behaves the same for both.



---

archive/issue_comments_128466.json:
```json
{
    "body": "Jean-Pierre,\n\nthe test of `real_mpfr` failed with a Segmentation fault on cicero. However I get\nthe following with the \"gross hack\" on cicero (32-bit Pentium 4):\n\n```\n\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: R=RealField(65)\nsage: set_random_seed(42)\nsage: R.random_element()\n0.9396630990748764761\nsage: R.random_element()\n0.2987261287446042432\n```\n\nand without the \"gross hack\":\n\n```\n| Sage Version 4.8, Release Date: 2012-01-20                         |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: R=RealField(65)\nsage: set_random_seed(42)\nsage: R.random_element()\n0.7846023201112678858\nsage: R.random_element()\n0.3289891249716495404\n```\n\nYou should be able to reproduce the later on a 64-bit machine.\n| Sage Version 4.8, Release Date: 2012-01-20                         |\n| Type notebook() for the GUI, and license() for information.        |\nPaul",
    "created_at": "2012-02-21T16:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128466",
    "user": "zimmerma"
}
```

Jean-Pierre,

the test of `real_mpfr` failed with a Segmentation fault on cicero. However I get
the following with the "gross hack" on cicero (32-bit Pentium 4):

```

----------------------------------------------------------------------
----------------------------------------------------------------------
sage: R=RealField(65)
sage: set_random_seed(42)
sage: R.random_element()
0.9396630990748764761
sage: R.random_element()
0.2987261287446042432
```

and without the "gross hack":

```
| Sage Version 4.8, Release Date: 2012-01-20                         |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: R=RealField(65)
sage: set_random_seed(42)
sage: R.random_element()
0.7846023201112678858
sage: R.random_element()
0.3289891249716495404
```

You should be able to reproduce the later on a 64-bit machine.
| Sage Version 4.8, Release Date: 2012-01-20                         |
| Type notebook() for the GUI, and license() for information.        |
Paul



---

archive/issue_comments_128467.json:
```json
{
    "body": "Indeed.\n\nWhen forcing the call to c_random(), I get\n\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nLoading Sage library. Current Mercurial branch is: mpfr\nsage: R=RealField(65)\nsage: set_random_seed(42)\nsage: R.random_element()\n0.9396630990748764761\nsage: R.random_element()\n0.2987261287446042432\n| Sage Version 4.8, Release Date: 2012-01-20                         |\n| Type notebook() for the GUI, and license() for information.        |\n```\n\nAnd with \"normal\" behavior:\n\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nLoading Sage library. Current Mercurial branch is: mpfr\nsage: R=RealField(65)    \nsage: set_random_seed(42)\nsage: R.random_element() \n0.7846023201112678858\nsage: R.random_element() \n0.3289891249716495404\n| Sage Version 4.8, Release Date: 2012-01-20                         |\n| Type notebook() for the GUI, and license() for information.        |\n```\n\nSo everything looks fine, except for the segfault you got.\n\nHopefully, I'll provide patches for removing the hackish section and fixing the doctests tomorrow.",
    "created_at": "2012-02-21T17:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128467",
    "user": "jpflori"
}
```

Indeed.

When forcing the call to c_random(), I get


```
----------------------------------------------------------------------
----------------------------------------------------------------------
Loading Sage library. Current Mercurial branch is: mpfr
sage: R=RealField(65)
sage: set_random_seed(42)
sage: R.random_element()
0.9396630990748764761
sage: R.random_element()
0.2987261287446042432
| Sage Version 4.8, Release Date: 2012-01-20                         |
| Type notebook() for the GUI, and license() for information.        |
```

And with "normal" behavior:


```
----------------------------------------------------------------------
----------------------------------------------------------------------
Loading Sage library. Current Mercurial branch is: mpfr
sage: R=RealField(65)    
sage: set_random_seed(42)
sage: R.random_element() 
0.7846023201112678858
sage: R.random_element() 
0.3289891249716495404
| Sage Version 4.8, Release Date: 2012-01-20                         |
| Type notebook() for the GUI, and license() for information.        |
```

So everything looks fine, except for the segfault you got.

Hopefully, I'll provide patches for removing the hackish section and fixing the doctests tomorrow.



---

archive/issue_comments_128468.json:
```json
{
    "body": "Changing keywords from \"sd32 MPFR spkg wishlist sd35.5\" to \"sd36 sd32 MPFR spkg wishlist sd35.5\".",
    "created_at": "2012-02-21T19:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128468",
    "user": "vbraun"
}
```

Changing keywords from "sd32 MPFR spkg wishlist sd35.5" to "sd36 sd32 MPFR spkg wishlist sd35.5".



---

archive/issue_comments_128469.json:
```json
{
    "body": "We want to work on the FLINT update at Sage Days 36 so I'll give this a try. I have access to a i7-920 running Linux i386 so it would be easy to test.",
    "created_at": "2012-02-21T19:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128469",
    "user": "vbraun"
}
```

We want to work on the FLINT update at Sage Days 36 so I'll give this a try. I have access to a i7-920 running Linux i386 so it would be easy to test.



---

archive/issue_comments_128470.json:
```json
{
    "body": "The segfault is from \n\n```\nsage: R = RealField(2147483647)\n```\n\nbecause MPFR contains code like\n\n```\n        _srcs  = (_srcprec  + GMP_NUMB_BITS-1)/GMP_NUMB_BITS;         \n        _dests = (_destprec + GMP_NUMB_BITS-1)/GMP_NUMB_BITS - _srcs; \n```\n\nThis gives an int overflow when `prec=INT_MAX`, and soon after as segfault because the buffer sizes are wrong.",
    "created_at": "2012-02-21T21:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128470",
    "user": "vbraun"
}
```

The segfault is from 

```
sage: R = RealField(2147483647)
```

because MPFR contains code like

```
        _srcs  = (_srcprec  + GMP_NUMB_BITS-1)/GMP_NUMB_BITS;         
        _dests = (_destprec + GMP_NUMB_BITS-1)/GMP_NUMB_BITS - _srcs; 
```

This gives an int overflow when `prec=INT_MAX`, and soon after as segfault because the buffer sizes are wrong.



---

archive/issue_comments_128471.json:
```json
{
    "body": "Initial patch",
    "created_at": "2012-02-21T23:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128471",
    "user": "vbraun"
}
```

Initial patch



---

archive/issue_comments_128472.json:
```json
{
    "body": "Attachment [trac_11666_remove_random_hack.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_remove_random_hack.patch) by vbraun created at 2012-02-21 23:49:29\n\nInitial patch",
    "created_at": "2012-02-21T23:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128472",
    "user": "vbraun"
}
```

Attachment [trac_11666_remove_random_hack.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_remove_random_hack.patch) by vbraun created at 2012-02-21 23:49:29

Initial patch



---

archive/issue_comments_128473.json:
```json
{
    "body": "Attachment [trac_11666_fix_random_doctests.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_fix_random_doctests.patch) by vbraun created at 2012-02-21 23:51:14\n\nI think the easiest solution is to limit the maximal precision in Sage to be slightly below 32-bit INT_MAX. The attached patches do that.",
    "created_at": "2012-02-21T23:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128473",
    "user": "vbraun"
}
```

Attachment [trac_11666_fix_random_doctests.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_fix_random_doctests.patch) by vbraun created at 2012-02-21 23:51:14

I think the easiest solution is to limit the maximal precision in Sage to be slightly below 32-bit INT_MAX. The attached patches do that.



---

archive/issue_comments_128474.json:
```json
{
    "body": "Reported upstream at https://gforge.inria.fr/tracker/index.php?func=detail&aid=13918&group_id=136&atid=619",
    "created_at": "2012-02-22T00:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128474",
    "user": "vbraun"
}
```

Reported upstream at https://gforge.inria.fr/tracker/index.php?func=detail&aid=13918&group_id=136&atid=619



---

archive/issue_comments_128475.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-02-22T00:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128475",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_128476.json:
```json
{
    "body": "I ran the doctests on 32-bit and 64-bit machines and they work.",
    "created_at": "2012-02-22T04:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128476",
    "user": "vbraun"
}
```

I ran the doctests on 32-bit and 64-bit machines and they work.



---

archive/issue_comments_128477.json:
```json
{
    "body": "As I commented above, the current package needs to be rebased on #12366.\n\nI'm doing it right now. I'll also fix the MPFI package so everything can finally be merged.\n\nI had a look at your patches and have nothing to say :) So once I upload the new spkg, I guess it will be positive_review.",
    "created_at": "2012-02-22T08:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128477",
    "user": "jpflori"
}
```

As I commented above, the current package needs to be rebased on #12366.

I'm doing it right now. I'll also fix the MPFI package so everything can finally be merged.

I had a look at your patches and have nothing to say :) So once I upload the new spkg, I guess it will be positive_review.



---

archive/issue_comments_128478.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-22T08:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128478",
    "user": "jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128479.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-22T10:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128479",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128480.json:
```json
{
    "body": "Updated spkg is available at [http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.p0.spkg](http://perso.telecom-paristech.fr/%7Eflori/sage/mpfr-3.1.0.spkg)",
    "created_at": "2012-02-22T10:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128480",
    "user": "jpflori"
}
```

Updated spkg is available at [http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.p0.spkg](http://perso.telecom-paristech.fr/%7Eflori/sage/mpfr-3.1.0.spkg)



---

archive/issue_comments_128481.json:
```json
{
    "body": "The above link doesn't point to the right file when clicked...\n\n[http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.p0.spkg](http://perso.telecom-paristech.fr/%7Eflori/sage/mpfr-3.1.0.p0.spkg)\n\nThis one should be ok.",
    "created_at": "2012-02-22T10:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128481",
    "user": "jpflori"
}
```

The above link doesn't point to the right file when clicked...

[http://perso.telecom-paristech.fr/~flori/sage/mpfr-3.1.0.p0.spkg](http://perso.telecom-paristech.fr/%7Eflori/sage/mpfr-3.1.0.p0.spkg)

This one should be ok.



---

archive/issue_comments_128482.json:
```json
{
    "body": "All test passed on my amd64 system.\n\nIf someone could have a final look at the updated spkg, I guess this can be finally set as positive_review.",
    "created_at": "2012-02-22T11:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128482",
    "user": "jpflori"
}
```

All test passed on my amd64 system.

If someone could have a final look at the updated spkg, I guess this can be finally set as positive_review.



---

archive/issue_comments_128483.json:
```json
{
    "body": "The Solaris patch is applied to the wrong directory, it is currenty doing `cp ../patches/mpn_exp.c mpn_exp.c` but if you want to overwrite the MPFR source then you should do `cp ../patches/mpn_exp.c src/mpn_exp.c` (there is a `src/src` directory in MPFR-3.1.0, this was just `src/` in the old MPFR). Can you fix this as well?",
    "created_at": "2012-02-22T19:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128483",
    "user": "vbraun"
}
```

The Solaris patch is applied to the wrong directory, it is currenty doing `cp ../patches/mpn_exp.c mpn_exp.c` but if you want to overwrite the MPFR source then you should do `cp ../patches/mpn_exp.c src/mpn_exp.c` (there is a `src/src` directory in MPFR-3.1.0, this was just `src/` in the old MPFR). Can you fix this as well?



---

archive/issue_comments_128484.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-22T19:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128484",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128485.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-22T19:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128485",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_128486.json:
```json
{
    "body": "Too fast with positive review ;-)",
    "created_at": "2012-02-22T19:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128486",
    "user": "vbraun"
}
```

Too fast with positive review ;-)



---

archive/issue_comments_128487.json:
```json
{
    "body": "I wonder why some random tests still differ between 32-bit and 64-bit computers.\nIs there any reason?\n\nPaul",
    "created_at": "2012-02-23T08:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128487",
    "user": "zimmerma"
}
```

I wonder why some random tests still differ between 32-bit and 64-bit computers.
Is there any reason?

Paul



---

archive/issue_comments_128488.json:
```json
{
    "body": "I tried the patches on top of Sage 4.8 (after #12171) but the 2nd and 3rd failed to apply:\n\n```\n\nsage: hg_sage.import_patch(\"trac_11666_reduce_precision_max.patch\")\ncd \"/home/zimmerma/sage-4.8/devel/sage\" && sage --hg import   \"/home/zimmerma/sage-4.8/trac_11666_reduce_precision_max.patch\"\napplying /home/zimmerma/sage-4.8/trac_11666_reduce_precision_max.patch\npatching file sage/rings/real_mpfr.pyx\nHunk #1 FAILED at 183\n1 out of 1 hunks FAILED -- saving rejects to file sage/rings/real_mpfr.pyx.rej\nabort: patch failed to apply\n```\n\nand\n\n```\n\nsage: hg_sage.import_patch(\"trac_11666_fix_random_doctests.patch\") \ncd \"/home/zimmerma/sage-4.8/devel/sage\" && sage --hg import   \"/home/zimmerma/sage-4.8/trac_11666_fix_random_doctests.patch\"\napplying /home/zimmerma/sage-4.8/trac_11666_fix_random_doctests.patch\npatching file sage/misc/randstate.pyx\nHunk #1 FAILED at 54\nHunk #2 FAILED at 85\nHunk #3 FAILED at 221\nHunk #4 FAILED at 233\nHunk #5 FAILED at 254\nHunk #6 FAILED at 276\n6 out of 6 hunks FAILED -- saving rejects to file sage/misc/randstate.pyx.rej\nabort: patch failed to apply\n```\n\nPaul",
    "created_at": "2012-02-23T08:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128488",
    "user": "zimmerma"
}
```

I tried the patches on top of Sage 4.8 (after #12171) but the 2nd and 3rd failed to apply:

```

sage: hg_sage.import_patch("trac_11666_reduce_precision_max.patch")
cd "/home/zimmerma/sage-4.8/devel/sage" && sage --hg import   "/home/zimmerma/sage-4.8/trac_11666_reduce_precision_max.patch"
applying /home/zimmerma/sage-4.8/trac_11666_reduce_precision_max.patch
patching file sage/rings/real_mpfr.pyx
Hunk #1 FAILED at 183
1 out of 1 hunks FAILED -- saving rejects to file sage/rings/real_mpfr.pyx.rej
abort: patch failed to apply
```

and

```

sage: hg_sage.import_patch("trac_11666_fix_random_doctests.patch") 
cd "/home/zimmerma/sage-4.8/devel/sage" && sage --hg import   "/home/zimmerma/sage-4.8/trac_11666_fix_random_doctests.patch"
applying /home/zimmerma/sage-4.8/trac_11666_fix_random_doctests.patch
patching file sage/misc/randstate.pyx
Hunk #1 FAILED at 54
Hunk #2 FAILED at 85
Hunk #3 FAILED at 221
Hunk #4 FAILED at 233
Hunk #5 FAILED at 254
Hunk #6 FAILED at 276
6 out of 6 hunks FAILED -- saving rejects to file sage/misc/randstate.pyx.rej
abort: patch failed to apply
```

Paul



---

archive/issue_comments_128489.json:
```json
{
    "body": "Replying to [zimmerma](http://trac.sagemath.org/sage_trac/ticket/11666#comment:66):\n\n\n> I wonder why some random tests still differ between 32-bit and 64-bit computers. Is there any reason? Paul\n\nYou mean in randstate.pyx? I guess that Pari RNG does not behaves the  same on 32 and 64 bits. The other tests (MPIR, MPFR, GAP, NTL, Python)  looks the same to me, but i might have missed something.\n\nThe spkg at the usual address is updated, if someone could test that the patch now applies on Solaris :) \n\nFor Paul: the Sage patches of the ticker did apply for me on top of 5.0.beta4",
    "created_at": "2012-02-23T08:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128489",
    "user": "jpflori"
}
```

Replying to [zimmerma](http://trac.sagemath.org/sage_trac/ticket/11666#comment:66):


> I wonder why some random tests still differ between 32-bit and 64-bit computers. Is there any reason? Paul

You mean in randstate.pyx? I guess that Pari RNG does not behaves the  same on 32 and 64 bits. The other tests (MPIR, MPFR, GAP, NTL, Python)  looks the same to me, but i might have missed something.

The spkg at the usual address is updated, if someone could test that the patch now applies on Solaris :) 

For Paul: the Sage patches of the ticker did apply for me on top of 5.0.beta4



---

archive/issue_comments_128490.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-23T08:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128490",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128491.json:
```json
{
    "body": "we decided in the MPFR development version to decrease the maximal value of the precision from 256, i.e., it is now 2<sup>31</sup>-257. You might want to do the same in Sage, so that upgrading to future MPFR versions will not cause any problem.\n\nPaul",
    "created_at": "2012-02-23T16:17:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128491",
    "user": "zimmerma"
}
```

we decided in the MPFR development version to decrease the maximal value of the precision from 256, i.e., it is now 2<sup>31</sup>-257. You might want to do the same in Sage, so that upgrading to future MPFR versions will not cause any problem.

Paul



---

archive/issue_comments_128492.json:
```json
{
    "body": "Updated patch to limit precision at 2**31-257 Updated patch to limit precision at 2**31-257 Updated patch to limit precision at 2**31-257",
    "created_at": "2012-02-23T18:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128492",
    "user": "vbraun"
}
```

Updated patch to limit precision at 2**31-257 Updated patch to limit precision at 2**31-257 Updated patch to limit precision at 2**31-257



---

archive/issue_comments_128493.json:
```json
{
    "body": "Attachment [trac_11666_reduce_precision_max.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_reduce_precision_max.patch) by vbraun created at 2012-02-23 18:28:28\n\nLooks good. I'm happy to give the spkg a positive review. Nothing changed in `mpn_exp.c` except the file location, so I don't foresee any Solaris issues.\n\nI've implemented Paul's suggestion about the precision limit, which was the only reviewer complaint. So I'll take it that everyone agrees with positive review ;-)\n\nPatches apply cleanly against sage-5.0.alpha4 and alpha5.",
    "created_at": "2012-02-23T18:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128493",
    "user": "vbraun"
}
```

Attachment [trac_11666_reduce_precision_max.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_reduce_precision_max.patch) by vbraun created at 2012-02-23 18:28:28

Looks good. I'm happy to give the spkg a positive review. Nothing changed in `mpn_exp.c` except the file location, so I don't foresee any Solaris issues.

I've implemented Paul's suggestion about the precision limit, which was the only reviewer complaint. So I'll take it that everyone agrees with positive review ;-)

Patches apply cleanly against sage-5.0.alpha4 and alpha5.



---

archive/issue_comments_128494.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-23T18:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128494",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128495.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-23T20:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128495",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_128496.json:
```json
{
    "body": "Sorry for the trouble, but this should be rebased to #12548.",
    "created_at": "2012-02-23T20:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128496",
    "user": "jdemeyer"
}
```

Sorry for the trouble, but this should be rebased to #12548.



---

archive/issue_comments_128497.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-25T10:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128497",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128498.json:
```json
{
    "body": "Here you go.\n\nSame address as usual.",
    "created_at": "2012-02-25T10:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128498",
    "user": "jpflori"
}
```

Here you go.

Same address as usual.



---

archive/issue_comments_128499.json:
```json
{
    "body": "`SPKG.txt` refers incorrectly to `mpfr-3.1.0.p1`, it should be `.p0`",
    "created_at": "2012-02-25T14:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128499",
    "user": "jdemeyer"
}
```

`SPKG.txt` refers incorrectly to `mpfr-3.1.0.p1`, it should be `.p0`



---

archive/issue_comments_128500.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-25T14:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128500",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128501.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-25T14:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128501",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128502.json:
```json
{
    "body": "Corrected.",
    "created_at": "2012-02-25T14:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128502",
    "user": "jpflori"
}
```

Corrected.



---

archive/issue_comments_128503.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-25T20:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128503",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128504.json:
```json
{
    "body": "Looks good!",
    "created_at": "2012-02-25T20:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128504",
    "user": "vbraun"
}
```

Looks good!



---

archive/issue_comments_128505.json:
```json
{
    "body": "I'm not sure my advice in comment [comment:11] to configure MPFR with `-disable-thread-safe` was taken into account. This might cause problems on various systems, see for example\nhttp://www.loria.fr/~zimmerma/software/compilerbugs.html\n\nIn addition, I'm not sure MPFR can be used as multi-thread within Sage.\n\nPaul",
    "created_at": "2012-02-26T22:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128505",
    "user": "zimmerma"
}
```

I'm not sure my advice in comment [comment:11] to configure MPFR with `-disable-thread-safe` was taken into account. This might cause problems on various systems, see for example
http://www.loria.fr/~zimmerma/software/compilerbugs.html

In addition, I'm not sure MPFR can be used as multi-thread within Sage.

Paul



---

archive/issue_comments_128506.json:
```json
{
    "body": "No, I did not. I just started on top of Mikes package which came before your comment and I don't remmeber that MPFR includes that flag by default. Ill send a new package tomorrow if you think that's needed. Too late for today.",
    "created_at": "2012-02-26T22:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128506",
    "user": "jpflori"
}
```

No, I did not. I just started on top of Mikes package which came before your comment and I don't remmeber that MPFR includes that flag by default. Ill send a new package tomorrow if you think that's needed. Too late for today.



---

archive/issue_comments_128507.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-26T22:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128507",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_128508.json:
```json
{
    "body": "I'm pretty sure we don't use multithreading with MPFR so we can just pass `--disable-thread-safe` to configure. I'll be happy to review it tomorrow ;-)",
    "created_at": "2012-02-26T22:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128508",
    "user": "vbraun"
}
```

I'm pretty sure we don't use multithreading with MPFR so we can just pass `--disable-thread-safe` to configure. I'll be happy to review it tomorrow ;-)



---

archive/issue_comments_128509.json:
```json
{
    "body": "Jean-Pierre, the `-disable-thread-safe` is not needed, but since Sage does not use\nmultithreading with MPFR, and given the poor support of multithreading by some compilers and operating systems, I recommend disabling thread local storage.\n\nPaul",
    "created_at": "2012-02-27T07:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128509",
    "user": "zimmerma"
}
```

Jean-Pierre, the `-disable-thread-safe` is not needed, but since Sage does not use
multithreading with MPFR, and given the poor support of multithreading by some compilers and operating systems, I recommend disabling thread local storage.

Paul



---

archive/issue_comments_128510.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-27T10:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128510",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128511.json:
```json
{
    "body": "SPKG updated at the same address.",
    "created_at": "2012-02-27T10:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128511",
    "user": "jpflori"
}
```

SPKG updated at the same address.



---

archive/issue_comments_128512.json:
```json
{
    "body": "Is there anything preventing this from getting positive review ?\n\nThe package address did not change, so I've not updated the ticket description.",
    "created_at": "2012-03-02T14:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128512",
    "user": "jpflori"
}
```

Is there anything preventing this from getting positive review ?

The package address did not change, so I've not updated the ticket description.



---

archive/issue_comments_128513.json:
```json
{
    "body": "Here is a review of `trac_11666_spkg.patch`:\nthere are small typos in `SPKG.txt`, which were already there before:\n`coment` should be `comment`,\n`occured` should be `occurred`,\n`reccommened` should be `recommended`.\n\nApart from that, the more important would be to test the modified spkg.\n\nIf this was already tested by the buildbot, then I will give a positive review.\n\nPaul Zimmermann",
    "created_at": "2012-03-02T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128513",
    "user": "zimmerma"
}
```

Here is a review of `trac_11666_spkg.patch`:
there are small typos in `SPKG.txt`, which were already there before:
`coment` should be `comment`,
`occured` should be `occurred`,
`reccommened` should be `recommended`.

Apart from that, the more important would be to test the modified spkg.

If this was already tested by the buildbot, then I will give a positive review.

Paul Zimmermann



---

archive/issue_comments_128514.json:
```json
{
    "body": "From http://wiki.sagemath.org/buildbot it seems that the patchbot does not feel concerned by automatically testing spkg and I have no idea how to use Sage facilities to perform automatically such tests. I even think I have no account on the needed machines, so I cannot take care of launching automated tests.\n\nAnyway, I'll take the typos into account tomorrow and update the spkg.",
    "created_at": "2012-03-02T17:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128514",
    "user": "jpflori"
}
```

From http://wiki.sagemath.org/buildbot it seems that the patchbot does not feel concerned by automatically testing spkg and I have no idea how to use Sage facilities to perform automatically such tests. I even think I have no account on the needed machines, so I cannot take care of launching automated tests.

Anyway, I'll take the typos into account tomorrow and update the spkg.



---

archive/issue_comments_128515.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-03-02T17:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128515",
    "user": "jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128516.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-02T17:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128516",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128517.json:
```json
{
    "body": "In fact I had some time right now and corrected the typos.\n\nThe package is at the same address as before.",
    "created_at": "2012-03-02T17:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128517",
    "user": "jpflori"
}
```

In fact I had some time right now and corrected the typos.

The package is at the same address as before.



---

archive/issue_comments_128518.json:
```json
{
    "body": "Attachment [trac_11666_spkg.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_spkg.patch) by jpflori created at 2012-03-02 17:17:46\n\nspkg diff, for review only",
    "created_at": "2012-03-02T17:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128518",
    "user": "jpflori"
}
```

Attachment [trac_11666_spkg.patch](tarball://root/attachments/some-uuid/ticket11666/trac_11666_spkg.patch) by jpflori created at 2012-03-02 17:17:46

spkg diff, for review only



---

archive/issue_comments_128519.json:
```json
{
    "body": "Replying to [comment:83 jpflori]:\n> From http://wiki.sagemath.org/buildbot it seems that the patchbot does not feel concerned by automatically testing spkg and I have no idea how to use Sage facilities to perform automatically such tests. I even think I have no account on the needed machines, so I cannot take care of launching automated tests.\nYes, there is currently no way to automatically test spkgs.",
    "created_at": "2012-03-02T21:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128519",
    "user": "jdemeyer"
}
```

Replying to [comment:83 jpflori]:
> From http://wiki.sagemath.org/buildbot it seems that the patchbot does not feel concerned by automatically testing spkg and I have no idea how to use Sage facilities to perform automatically such tests. I even think I have no account on the needed machines, so I cannot take care of launching automated tests.
Yes, there is currently no way to automatically test spkgs.



---

archive/issue_comments_128520.json:
```json
{
    "body": "The current workflow is positive review -> release manage tests beta on build bot. While the authors should of course test patches, you don't have to test it on every supported machine to give a positive review.\n\nWe did test it on 32 and 6-bit machines which is the most likely source of errors. Specifics for other systems were not changed so its likely that it'll continue to work. I'll give the spell-checked SPKG.txt my positive review.",
    "created_at": "2012-03-02T22:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128520",
    "user": "vbraun"
}
```

The current workflow is positive review -> release manage tests beta on build bot. While the authors should of course test patches, you don't have to test it on every supported machine to give a positive review.

We did test it on 32 and 6-bit machines which is the most likely source of errors. Specifics for other systems were not changed so its likely that it'll continue to work. I'll give the spell-checked SPKG.txt my positive review.



---

archive/issue_comments_128521.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-02T22:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128521",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128522.json:
```json
{
    "body": "Replying to [comment:86 vbraun]:\n> We did test it on 32 and 6-bit machines which is the most likely source of errors.\nAgreed.  My impression from Paul Zimmermann's comment was that it hadn't been tested at all.",
    "created_at": "2012-03-03T13:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128522",
    "user": "jdemeyer"
}
```

Replying to [comment:86 vbraun]:
> We did test it on 32 and 6-bit machines which is the most likely source of errors.
Agreed.  My impression from Paul Zimmermann's comment was that it hadn't been tested at all.



---

archive/issue_comments_128523.json:
```json
{
    "body": "Replying to [comment:86 vbraun]:\n> We did test it on [...] 6-bit machines\nImpressive!",
    "created_at": "2012-03-03T13:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128523",
    "user": "jdemeyer"
}
```

Replying to [comment:86 vbraun]:
> We did test it on [...] 6-bit machines
Impressive!



---

archive/issue_comments_128524.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-04T21:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11494#issuecomment-128524",
    "user": "jdemeyer"
}
```

Resolution: fixed
