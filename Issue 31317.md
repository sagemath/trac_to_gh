# Issue 31317: Wrong answer when evaluating a series inside a hold context

Issue created by migration from https://trac.sagemath.org/ticket/31554

Original creator: @DaveWitteMorris

Original creation time: 2021-03-25 01:46:27

CC:  dimpase egourgoulhon

Keywords: series, hold, segmentation fault

Analysis of the bug reported in #31530 revealed that evaluating a series inside a hold context can yield incorrect results or a crash:

```
sage: a,b,c = var("a b c")
sage: f(x) = (a + b*x).series(x, 2)
sage: print(f"f(c) = {f(c)},    f(1) = {f(1)}")
f(c) = b*c + a,    f(1) = a + b
sage: with hold: 
....:     print(f(c)) 
b*(c)
sage: with hold: 
....:     print(f(1))

<segmentation fault>
```

This bug was present at least as far back as v9.1. The segmentation fault seems to be from running out of memory. 


---

Comment by @DaveWitteMorris created at 2021-03-25 02:49:19

Here is an example that seems very strange to me. Does the `()` in the final line mean that something returned `None` instead of `0`?

```
sage: f(x) = (cos(a + x) + b*x).series(x,2)
sage: f
x |--> (cos(a)) + (b - sin(a))*x + Order(x^2)
sage: with hold: 
....:     print(f(0))
(b - sin(a))*()
```

I have tentatively rated this ticket as a blocker because it gives wrong results in a quite simple situation, but perhaps we will soon see that its impact is limited.


---

Comment by @DaveWitteMorris created at 2021-03-26 06:41:48

The disappearance of `a` has nothing to do with series. There is a bug in the handling of `x^0`:

```
sage: a,b,c = var("a b c")
sage: with hold:
....:    print((a*x^0).subs({x:c}))
....:    print((a*x^0 + b*x^1).subs({x:c}))
0*a
b*c
```



---

Comment by @DaveWitteMorris created at 2021-04-03 05:49:56

I know how to fix the `print(f(c))` example on this ticket. (The problem is that pynac's `handle_factor` method does not handle `x^0` correctly.) However, the same issue arises in three other (nearby) places in the code, so I have to do a bit more work before I upload a PR.

After fixing this bug, I found another pynac method that does not handle `x^0` correctly. I opened  #31599 for this bug, and I opened #31597 to squash any other pynac bugs that arise in a hold context. I opened #31598 for the printing bug that was pointed out in comment:1.

I haven't yet tracked down the cause of the crash in the ticket description, but I don't expect it to be difficult.


---

Comment by @DaveWitteMorris created at 2021-04-05 00:30:14

The purpose of pynac's `handle_factor` method is to help convert `0*x` to `0` and `x^0` to `1`. The `print(f(c))` bug in the ticket description is a result of the fact that `handle_factor` erroneously converts `x^0` to `0`, instead of `1`.  The PR fixes the two places where this problem occurs, by eliminating the call to `handle_factor`.  

The other three calls to `handle_factor` in the pynac source code are essentially no-ops, so they should be removed.  I opened #31608 for this.

I opened #31607 for fixing the `f(1)` segmentation fault.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-04-05 00:30:14

Changing status from new to needs_review.


---

Comment by git created at 2021-04-05 00:40:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2021-04-05 00:42:52

Oops! The branch I pushed had some test code (print statements) in the pynac patch.


---

Comment by mkoeppe created at 2021-04-05 17:07:12

LGTM. Note all of these pynac patches should really become PRs to pynac, but it's fine as is for 9.3


---

Comment by mkoeppe created at 2021-04-05 17:07:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-04-05 19:53:58

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-04-05 19:53:58

Reviewer name missing


---

Comment by @DaveWitteMorris created at 2021-04-05 21:53:34

Thanks for the review!


---

Comment by @DaveWitteMorris created at 2021-04-05 21:53:34

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-04-06 22:35:57

Merge conflict


---

Comment by vbraun created at 2021-04-06 22:35:57

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-04-06 23:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-07 00:14:35

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-04-10 11:01:09

Circular dependency


---

Comment by vbraun created at 2021-04-10 11:01:09

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-04-10 16:26:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-10 16:27:18

Sorry for messing this up. I think I've got it right now.


---

Comment by mkoeppe created at 2021-04-10 16:27:18

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-04-12 21:35:45

On 32-bit:

```
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4882, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36  
Got:
    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36
**********************************************************************
1 item had failures:
   1 of  43 in sage.symbolic.expression.Expression.expand
    [2941 tests, 1 failure, 43.02 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2021-04-12 21:35:51

Changing status from positive_review to needs_work.


---

Comment by @DaveWitteMorris created at 2021-04-17 03:45:41

This is a known bug on 32-bit.  (See #31585.)  In commit [96b0f8b](https://git.sagemath.org/sage.git/commit/?id=96b0f8bd3c791f533989d92d026e9558fa880a5c) of ticket #31479, I added a `# 32-bit # known bug` tag to this line of the output. (And the tag shows up in the branch of this ticket, even though it's not in the expected output of the failed doctest.) Was that the wrong thing to do? I don't know much about doctesting and I couldn't find any examples to emulate in the sage source code.

How are we supposed to handle the doctest in this situation where 32-bit gives a wrong answer? (64-bit works correctly.)


---

Comment by mkoeppe created at 2021-04-17 03:51:51

Sorry, it looks like I lost this commit when I rebased #31479.  It's not in 9.3.rc3 as far as I can see.


---

Comment by git created at 2021-04-17 07:29:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-04-17 07:31:01

Somehow the branches of #31479 and #31554 were switched.

Anyway here's the rebase of what's missing in 9.3.rc3...


---

Comment by mkoeppe created at 2021-04-17 18:44:51

I have put the branch on the new ticket #31679 now to clean up the confusion.


---

Comment by mkoeppe created at 2021-04-17 18:45:14

Changing status from needs_work to needs_review.


---

Comment by @DaveWitteMorris created at 2021-04-18 05:37:59

Changing status from needs_review to positive_review.


---

Comment by @DaveWitteMorris created at 2021-04-18 05:37:59

Changing priority from blocker to major.


---

Comment by @DaveWitteMorris created at 2021-04-18 05:37:59

The branch has been moved to #31679, so this ticket can be closed as a duplicate.


---

Comment by mkoeppe created at 2021-06-24 20:15:37

Resolution: invalid
