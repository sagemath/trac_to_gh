# Issue 31317: Wrong answer when evaluating a series inside a hold context

archive/issues_031317.json:
```json
{
    "body": "CC:  @dimpase @egourgoulhon\n\nKeywords: series, hold, segmentation fault\n\nAnalysis of the bug reported in #31530 revealed that evaluating a series inside a hold context can yield incorrect results or a crash:\n\n```\nsage: a,b,c = var(\"a b c\")\nsage: f(x) = (a + b*x).series(x, 2)\nsage: print(f\"f(c) = {f(c)},    f(1) = {f(1)}\")\nf(c) = b*c + a,    f(1) = a + b\nsage: with hold: \n....:     print(f(c)) \nb*(c)\nsage: with hold: \n....:     print(f(1))\n\n<segmentation fault>\n```\n\nThis bug was present at least as far back as v9.1. The segmentation fault seems to be from running out of memory. \n\nIssue created by migration from https://trac.sagemath.org/ticket/31554\n\n",
    "created_at": "2021-03-25T01:46:27Z",
    "labels": [
        "symbolics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Wrong answer when evaluating a series inside a hold context",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31317",
    "user": "@DaveWitteMorris"
}
```
CC:  @dimpase @egourgoulhon

Keywords: series, hold, segmentation fault

Analysis of the bug reported in #31530 revealed that evaluating a series inside a hold context can yield incorrect results or a crash:

```
sage: a,b,c = var("a b c")
sage: f(x) = (a + b*x).series(x, 2)
sage: print(f"f(c) = {f(c)},    f(1) = {f(1)}")
f(c) = b*c + a,    f(1) = a + b
sage: with hold: 
....:     print(f(c)) 
b*(c)
sage: with hold: 
....:     print(f(1))

<segmentation fault>
```

This bug was present at least as far back as v9.1. The segmentation fault seems to be from running out of memory. 

Issue created by migration from https://trac.sagemath.org/ticket/31554





---

archive/issue_comments_447728.json:
```json
{
    "body": "Here is an example that seems very strange to me. Does the `()` in the final line mean that something returned `None` instead of `0`?\n\n```\nsage: f(x) = (cos(a + x) + b*x).series(x,2)\nsage: f\nx |--> (cos(a)) + (b - sin(a))*x + Order(x^2)\nsage: with hold: \n....:     print(f(0))\n(b - sin(a))*()\n```\n\nI have tentatively rated this ticket as a blocker because it gives wrong results in a quite simple situation, but perhaps we will soon see that its impact is limited.",
    "created_at": "2021-03-25T02:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447728",
    "user": "@DaveWitteMorris"
}
```

Here is an example that seems very strange to me. Does the `()` in the final line mean that something returned `None` instead of `0`?

```
sage: f(x) = (cos(a + x) + b*x).series(x,2)
sage: f
x |--> (cos(a)) + (b - sin(a))*x + Order(x^2)
sage: with hold: 
....:     print(f(0))
(b - sin(a))*()
```

I have tentatively rated this ticket as a blocker because it gives wrong results in a quite simple situation, but perhaps we will soon see that its impact is limited.



---

archive/issue_comments_447729.json:
```json
{
    "body": "The disappearance of `a` has nothing to do with series. There is a bug in the handling of `x^0`:\n\n```\nsage: a,b,c = var(\"a b c\")\nsage: with hold:\n....:    print((a*x^0).subs({x:c}))\n....:    print((a*x^0 + b*x^1).subs({x:c}))\n0*a\nb*c\n```\n",
    "created_at": "2021-03-26T06:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447729",
    "user": "@DaveWitteMorris"
}
```

The disappearance of `a` has nothing to do with series. There is a bug in the handling of `x^0`:

```
sage: a,b,c = var("a b c")
sage: with hold:
....:    print((a*x^0).subs({x:c}))
....:    print((a*x^0 + b*x^1).subs({x:c}))
0*a
b*c
```




---

archive/issue_comments_447730.json:
```json
{
    "body": "I know how to fix the `print(f(c))` example on this ticket. (The problem is that pynac's `handle_factor` method does not handle `x^0` correctly.) However, the same issue arises in three other (nearby) places in the code, so I have to do a bit more work before I upload a PR.\n\nAfter fixing this bug, I found another pynac method that does not handle `x^0` correctly. I opened  #31599 for this bug, and I opened #31597 to squash any other pynac bugs that arise in a hold context. I opened #31598 for the printing bug that was pointed out in comment:1.\n\nI haven't yet tracked down the cause of the crash in the ticket description, but I don't expect it to be difficult.",
    "created_at": "2021-04-03T05:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447730",
    "user": "@DaveWitteMorris"
}
```

I know how to fix the `print(f(c))` example on this ticket. (The problem is that pynac's `handle_factor` method does not handle `x^0` correctly.) However, the same issue arises in three other (nearby) places in the code, so I have to do a bit more work before I upload a PR.

After fixing this bug, I found another pynac method that does not handle `x^0` correctly. I opened  #31599 for this bug, and I opened #31597 to squash any other pynac bugs that arise in a hold context. I opened #31598 for the printing bug that was pointed out in comment:1.

I haven't yet tracked down the cause of the crash in the ticket description, but I don't expect it to be difficult.



---

archive/issue_comments_447731.json:
```json
{
    "body": "The purpose of pynac's `handle_factor` method is to help convert `0*x` to `0` and `x^0` to `1`. The `print(f(c))` bug in the ticket description is a result of the fact that `handle_factor` erroneously converts `x^0` to `0`, instead of `1`.  The PR fixes the two places where this problem occurs, by eliminating the call to `handle_factor`.  \n\nThe other three calls to `handle_factor` in the pynac source code are essentially no-ops, so they should be removed.  I opened #31608 for this.\n\nI opened #31607 for fixing the `f(1)` segmentation fault.\n----\nNew commits:",
    "created_at": "2021-04-05T00:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447731",
    "user": "@DaveWitteMorris"
}
```

The purpose of pynac's `handle_factor` method is to help convert `0*x` to `0` and `x^0` to `1`. The `print(f(c))` bug in the ticket description is a result of the fact that `handle_factor` erroneously converts `x^0` to `0`, instead of `1`.  The PR fixes the two places where this problem occurs, by eliminating the call to `handle_factor`.  

The other three calls to `handle_factor` in the pynac source code are essentially no-ops, so they should be removed.  I opened #31608 for this.

I opened #31607 for fixing the `f(1)` segmentation fault.
----
New commits:



---

archive/issue_comments_447732.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-05T00:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447732",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_447733.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-05T00:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447733",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447734.json:
```json
{
    "body": "Oops! The branch I pushed had some test code (print statements) in the pynac patch.",
    "created_at": "2021-04-05T00:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447734",
    "user": "@DaveWitteMorris"
}
```

Oops! The branch I pushed had some test code (print statements) in the pynac patch.



---

archive/issue_comments_447735.json:
```json
{
    "body": "LGTM. Note all of these pynac patches should really become PRs to pynac, but it's fine as is for 9.3",
    "created_at": "2021-04-05T17:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447735",
    "user": "@mkoeppe"
}
```

LGTM. Note all of these pynac patches should really become PRs to pynac, but it's fine as is for 9.3



---

archive/issue_comments_447736.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-05T17:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447736",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_447737.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-05T19:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447737",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_447738.json:
```json
{
    "body": "Reviewer name missing",
    "created_at": "2021-04-05T19:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447738",
    "user": "@vbraun"
}
```

Reviewer name missing



---

archive/issue_comments_447739.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2021-04-05T21:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447739",
    "user": "@DaveWitteMorris"
}
```

Thanks for the review!



---

archive/issue_comments_447740.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-04-05T21:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447740",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_447741.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2021-04-06T22:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447741",
    "user": "@vbraun"
}
```

Merge conflict



---

archive/issue_comments_447742.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-06T22:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447742",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_447743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-06T23:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447743",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447744.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-04-07T00:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447744",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_447745.json:
```json
{
    "body": "Circular dependency",
    "created_at": "2021-04-10T11:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447745",
    "user": "@vbraun"
}
```

Circular dependency



---

archive/issue_comments_447746.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-10T11:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447746",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_447747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T16:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447747",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447748.json:
```json
{
    "body": "Sorry for messing this up. I think I've got it right now.",
    "created_at": "2021-04-10T16:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447748",
    "user": "@mkoeppe"
}
```

Sorry for messing this up. I think I've got it right now.



---

archive/issue_comments_447749.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-04-10T16:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447749",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_447750.json:
```json
{
    "body": "On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 4882, in sage.symbolic.expression.Expression.expand\nFailed example:\n    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)\nExpected:\n    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36  \nGot:\n    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36\n**********************************************************************\n1 item had failures:\n   1 of  43 in sage.symbolic.expression.Expression.expand\n    [2941 tests, 1 failure, 43.02 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2021-04-12T21:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447750",
    "user": "@vbraun"
}
```

On 32-bit:

```
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4882, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36  
Got:
    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36
**********************************************************************
1 item had failures:
   1 of  43 in sage.symbolic.expression.Expression.expand
    [2941 tests, 1 failure, 43.02 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_447751.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-12T21:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447751",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_447752.json:
```json
{
    "body": "This is a known bug on 32-bit.  (See #31585.)  In commit [96b0f8b](https://git.sagemath.org/sage.git/commit/?id=96b0f8bd3c791f533989d92d026e9558fa880a5c) of ticket #31479, I added a `# 32-bit # known bug` tag to this line of the output. (And the tag shows up in the branch of this ticket, even though it's not in the expected output of the failed doctest.) Was that the wrong thing to do? I don't know much about doctesting and I couldn't find any examples to emulate in the sage source code.\n\nHow are we supposed to handle the doctest in this situation where 32-bit gives a wrong answer? (64-bit works correctly.)",
    "created_at": "2021-04-17T03:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447752",
    "user": "@DaveWitteMorris"
}
```

This is a known bug on 32-bit.  (See #31585.)  In commit [96b0f8b](https://git.sagemath.org/sage.git/commit/?id=96b0f8bd3c791f533989d92d026e9558fa880a5c) of ticket #31479, I added a `# 32-bit # known bug` tag to this line of the output. (And the tag shows up in the branch of this ticket, even though it's not in the expected output of the failed doctest.) Was that the wrong thing to do? I don't know much about doctesting and I couldn't find any examples to emulate in the sage source code.

How are we supposed to handle the doctest in this situation where 32-bit gives a wrong answer? (64-bit works correctly.)



---

archive/issue_comments_447753.json:
```json
{
    "body": "Sorry, it looks like I lost this commit when I rebased #31479.  It's not in 9.3.rc3 as far as I can see.",
    "created_at": "2021-04-17T03:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447753",
    "user": "@mkoeppe"
}
```

Sorry, it looks like I lost this commit when I rebased #31479.  It's not in 9.3.rc3 as far as I can see.



---

archive/issue_comments_447754.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-17T07:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447754",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_447755.json:
```json
{
    "body": "Somehow the branches of #31479 and #31554 were switched.\n\nAnyway here's the rebase of what's missing in 9.3.rc3...",
    "created_at": "2021-04-17T07:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447755",
    "user": "@mkoeppe"
}
```

Somehow the branches of #31479 and #31554 were switched.

Anyway here's the rebase of what's missing in 9.3.rc3...



---

archive/issue_comments_447756.json:
```json
{
    "body": "I have put the branch on the new ticket #31679 now to clean up the confusion.",
    "created_at": "2021-04-17T18:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447756",
    "user": "@mkoeppe"
}
```

I have put the branch on the new ticket #31679 now to clean up the confusion.



---

archive/issue_comments_447757.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-17T18:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447757",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_447758.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-18T05:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447758",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_447759.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2021-04-18T05:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447759",
    "user": "@DaveWitteMorris"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_447760.json:
```json
{
    "body": "The branch has been moved to #31679, so this ticket can be closed as a duplicate.",
    "created_at": "2021-04-18T05:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447760",
    "user": "@DaveWitteMorris"
}
```

The branch has been moved to #31679, so this ticket can be closed as a duplicate.



---

archive/issue_comments_447761.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-06-24T20:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31317",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31317#issuecomment-447761",
    "user": "@mkoeppe"
}
```

Resolution: invalid
