# Issue 14883: Fix doctest doctests in git layout.

Issue created by migration from Trac.

Original creator: robertwb

Original creation time: 2013-08-29 06:19:17

sage -t --long src/sage/doctest/control.py
**********************************************************************
File "src/sage/doctest/control.py", line 145, in sage.doctest.control.skipdir
Failed example:
    skipdir(os.path.join(SAGE_ROOT, "devel", "sagenb", "sagenb", "data"))
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/doctest/control.py", line 431, in sage.doctest.control.DocTestController.add_files
Failed example:
    DC.add_files()
Exception raised:
    Traceback (most recent call last):
      File "/Users/robertwb/sage/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 479, in _run
        self.execute(example, compiled, test.globs)
      File "/Users/robertwb/sage/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 838, in execute
        exec compiled in globs
      File "<doctest sage.doctest.control.DocTestController.add_files[10]>", line 1, in <module>
        DC.add_files()
      File "/Users/robertwb/sage/sage-git/local/lib/python2.7/site-packages/sage/doctest/control.py", line 455, in add_files
        from sage.misc.hg import hg_sage
    ImportError: No module named hg
**********************************************************************
2 items had failures:
   1 of  16 in sage.doctest.control.DocTestController.add_files
   1 of   4 in sage.doctest.control.skipdir
    [162 tests, 2 failures, 2.48 s]


---

Comment by robertwb created at 2013-08-29 06:28:36

Changing status from new to needs_review.


---

Comment by SimonKing created at 2013-08-29 11:30:25

Trying to accomplish my first git review...

I see that you replace calls to hg_sage by rather "explicit" calls to `subprocess`, such as

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 9c0ed75..fa35315 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
`@``@` -453,28 +453,23 `@``@` class DocTestController(SageObject):
             self.files.extend(glob(opj(SAGE_SRC, 'doc', '[a-z][a-z]')))
             self.options.sagenb = True
         elif self.options.new:
-            # Get all files changed in the working repo, as well as all
-            # files in the top Mercurial queue patch.
-            from sage.misc.hg import hg_sage
-            out, err = hg_sage('status --rev qtip^', interactive=False, debug=False)
-            if not err:
-                qtop = hg_sage('qtop', interactive=False, debug=False)[0].strip()
-                self.log("Doctesting files in mq patch " + repr(qtop))
-            else:  # Probably mq isn't used
-                out, err = hg_sage('status', interactive=False, debug=False)
-                if not err:
-                    self.log("Doctesting files changed since last hg commit")
-                else:
-                    raise RuntimeError("failed to run hg status:\n" + err)
-
-            for X in out.split('\n'):
-                tup = X.split()
-                if len(tup) != 2: continue
-                c, filename = tup
-                if c in ['M','A']:
-                    filename = opj(SAGE_SRC, filename)
-                    if not skipfile(filename):
-                        self.files.append(filename)
+            # Get all files changed in the working repo.
+            import subprocess
+            change = subprocess.check_output(["git",
+                                              "--git-dir=" + SAGE_ROOT + "/.git",
+                                              "--work-tree=" + SAGE_ROOT,
+                                              "status",
+                                              "--porcelain"])
+            self.log("Doctesting files changed since last git commit")
+            for line in change.split("\n"):
+                if not line:
+                    continue
+                data = line.strip().split(' ')
+                status, filename = data[0], data[-1]
+                if (set(status).issubset("MARCU")
+                    and filename.startswith("src/sage")
+                    and (filename.endswith(".py") or filename.endswith(".pyx"))):
+                    self.files.append(filename)
         if self.options.sagenb:
             if not self.options.all:
                 self.log("Doctesting the Sage notebook.")
```


Out of interest: Is "git_sage" already in the making? I.e., will it soon be possible to get the status by doing `git_sage("status")`?


---

Comment by SimonKing created at 2013-08-29 11:33:30

And question to you (Robert) as the author of the patchbot (if I am not mistaken on the authorship): Why is the patchbot stating:

```
git_branch: 	None
```

and thus is not running tests on your branch?


---

Comment by SimonKing created at 2013-08-29 11:59:51

Talking about doc tests: They are not finished on my laptop, yet. But I already got one error:

```
sage -t src/sage/doctest/forker.py
**********************************************************************
File "src/sage/doctest/forker.py", line 82, in sage.doctest.forker.init_sage
Failed example:
    print PrettyPrinter(settings={'wrap_line':True}).doprint(s)
Expected:
     29    28    27    26    25    24    23    22    21    20    19    18    17
    x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   +
    <BLANKLINE>
     16    15    14    13    12    11    10    9    8    7    6    5    4    3
    x   + x   + x   + x   + x   + x   + x   + x  + x  + x  + x  + x  + x  + x  + x
    <BLANKLINE>
    2
      + x
Got:
     29    28    27    26    25    24    23    22    21    20    19    18    17    16    15    14    13    12    11    10    9    8    7    6    5    4    3    2    
    x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x   + x  + x  + x  + x  + x  + x  + x  + x  + x
**********************************************************************
1 item had failures:
   1 of  14 in sage.doctest.forker.init_sage
    [436 tests, 1 failure, 18.51 s]
```

So, the problem is just wrong line break.

And now the real problem starts, namely the reviewing problem: If I understood correctly, you did two commits (`Fix --new option for doctests.` and `Fix doctest doctest due to directory restructure.`) here. Has this doctest error been introduced by your two commits, or by a "dependency"---and what is a "dependency", anyway???


---

Comment by SimonKing created at 2013-08-29 12:14:21

Fortunately there is "git blame". The doctest that is now failing was last edited by Volker, see #14266. But I suppose it used to _not_ fail. Hence, I suppose that the reason for the failure is on a different ticket...


---

Comment by SimonKing created at 2013-08-29 13:02:42

`make ptest` gives me the following:

```
sage -t src/sage/doctest/forker.py  # 1 doctest failed
sage -t src/sage/misc/ascii_art.py  # 1 doctest failed
sage -t src/sage/dev/git_interface.py  # 10 doctests failed
sage -t src/sage/dev/sagedev.py  # 6 doctests failed
```

Has this ticket been supposed to fix all doctests?


---

Comment by robertwb created at 2013-08-29 22:32:03

It fixes the tests caused by "sage --testall" Hopefully we haven't introduced more breakage since then...but these at least should go on even if there's more work to do.

The sage dev scripts will provide some of this, but (by design) refuse to run in doctest mode.  When I started working on this I was in a branch that didn't even have dev scripts, but the subprocess option wasn't that bad so I left it.


---

Comment by SimonKing created at 2013-08-30 20:26:12

For the record: Here is the "background noise", i.e., the errors with "vanilla" public/sage-git/master, on my desktop computer.

```
sage -t --long src/sage/interfaces/maxima_abstract.py  # 2 doctests failed
sage -t --long src/sage/geometry/lattice_polytope.py  # 1 doctest failed
sage -t --long src/sage/doctest/control.py  # 1 doctest failed
sage -t --long src/sage/interfaces/interface.py  # 1 doctest failed
sage -t --long src/sage/dev/config.py  # 52 doctests failed
sage -t --long src/sage/dev/cmd_line_interface.py  # 22 doctests failed
sage -t --long src/sage/dev/git_interface.py  # 210 doctests failed
sage -t --long src/sage/dev/sagedev_wrapper.py  # 11 doctests failed
sage -t --long src/sage/dev/sagedev.py  # 571 doctests failed
sage -t --long src/sage/dev/test/config.py  # 2 doctests failed
sage -t --long src/sage/dev/test/sagedev.py  # 10 doctests failed
sage -t --long src/sage/dev/test/trac_interface.py  # 15 doctests failed
sage -t --long src/sage/dev/test/trac_server.py  # 2 doctests failed
sage -t --long src/sage/dev/test/server_proxy.py  # 61 doctests failed
sage -t --long src/sage/dev/test/user_interface.py  # 13 doctests failed
sage -t --long src/sage/dev/user_interface.py  # 25 doctests failed
sage -t --long src/sage/dev/trac_interface.py  # 113 doctests failed
```


For the record: I am a shocked that the soon-to-be fundament of sage development is broken to such extent. I am now trying to see whether the findings on my laptop can be confirmed on the desktop, namely that much less tests are failing with your patch/branch.

Question: Is the aim of this ticket to fix _all_ tests?


---

Comment by SimonKing created at 2013-08-30 20:35:00

I am working on my desktop because my laptop is broken. Question, Robert: While trying to use the dev scripts, I found a bug. Namely: I forgot to set up my git (e.g., I didn't store e-mail and real name). This should result in an error being raised. However, I get this traceback:

```
[git] git config user.name
Traceback (most recent call last):
  File "/mnt/local/king/SAGE/GIT/sage/src/bin/sage-dev", line 330, in <module>
    parser.run()
  File "/mnt/local/king/SAGE/GIT/sage/src/bin/sage-dev", line 322, in run
    method(*args,**kwds)
  File "/mnt/local/king/SAGE/GIT/sage/local/lib/python2.7/site-packages/sage/dev/sagedev_wrapper.py", line 140, in wrapped
    return f(*args, **kwargs)
  File "/mnt/local/king/SAGE/GIT/sage/local/lib/python2.7/site-packages/sage/dev/sagedev.py", line 518, in switch_ticket
    branch = self._new_local_branch_for_ticket(ticket)
  File "/mnt/local/king/SAGE/GIT/sage/local/lib/python2.7/site-packages/sage/dev...
...
  File "/mnt/local/king/SAGE/GIT/sage/local/lib/python2.7/site-packages/sage/dev/git_interface.py", line 358, in _check_user_email
    self._UI.normal("No real name has been set for git. This name shows up as the author for any commits you contribute to sage.")
AttributeError: 'CmdLineInterface' object has no attribute 'normal'
```


Is this bug already tracked/known to the sage-git people? I think I am currently not really able to create a ticket properly, with a slow internet connection and no usable laptop.


---

Comment by robertwb created at 2013-08-30 21:08:47

Replying to [comment:11 SimonKing]:
> I am working on my desktop because my laptop is broken. Question, Robert: While trying to use the dev scripts, I found a bug. Namely: I forgot to set up my git (e.g., I didn't store e-mail and real name). This should result in an error being raised. However, I get this traceback:
> ...
> Is this bug already tracked/known to the sage-git people? I think I am currently not really able to create a ticket properly, with a slow internet connection and no usable laptop.

I don't know; wouldn't hurt pinging the sage-git list.


---

Comment by robertwb created at 2013-08-30 21:12:07

Replying to [comment:10 SimonKing]:
> For the record: Here is the "background noise", i.e., the errors with "vanilla" public/sage-git/master, on my desktop computer.
> ...
> For the record: I am a shocked that the soon-to-be fundament of sage development is broken to such extent. 

I just ran the tests myself, got 79 files failing. Count me shocked as well.

> I am now trying to see whether the findings on my laptop can be confirmed on the desktop, namely that much less tests are failing with your patch/branch.
> 
> Question: Is the aim of this ticket to fix _all_ tests?

At this point, no, it's just to fix those two (which were the only ones on the github build_system branch). Looks like there's lots of further work to do.


---

Comment by SimonKing created at 2013-08-30 21:50:26

Replying to [comment:13 robertwb]:
> Replying to [comment:10 SimonKing]:
> > For the record: Here is the "background noise", i.e., the errors with "vanilla" public/sage-git/master, on my desktop computer.
> > ...
> > For the record: I am a shocked that the soon-to-be fundament of sage development is broken to such extent. 
> 
> I just ran the tests myself, got 79 files failing. Count me shocked as well.

Really?? So, why is the number of failing files not the same as what I got? This makes things even worse, I'd say!


---

Comment by git created at 2013-09-01 08:02:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:


---

Comment by SimonKing created at 2013-09-01 14:13:06

Replying to [comment:16 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:
> ||6912669||Fix --new option for doctests.||
> ||98d0840||Fix doctest doctest due to directory restructure.||

First problem: How do I update? `sage -dev switch_ticket 15120`? Or `git pull trac` if I am already in your branch?

Second problem: I get these errors in your branch.

```
sage -t --long src/sage/dev/sagedev.py  # 6 doctests failed
sage -t --long src/sage/interfaces/maxima_abstract.py  # 1 doctest failed
sage -t --long src/doc/en/constructions/plotting.rst  # 2 doctests failed
sage -t --long src/sage/dev/git_interface.py  # 10 doctests failed
sage -t --long src/sage/doctest/control.py  # 2 doctests failed
sage -t --long src/sage/dev/trac_interface.py  # 1 doctest failed
```

Why is this a problem, git-wise? Well, I learnt on sage-git that pulling your branch means I get something that is based on an _old_ version of the "master" branch, i.e., a version of "master" that is not as terribly broken as the version mentioned in comment:10 and comment:13 - but still there are so many errors.


---

Comment by SimonKing created at 2013-09-01 14:15:26

Ouch. I am sorry, disregard my previous commit. I just did `git branch` and found

```
king`@`mpc622:/mnt/local/king/SAGE/GIT/sage$ git branch
* master
  public/sage-git/master
```

So, as it seems, I am _not_ in your branch.

Doing `sage -dev switch 15120` now...


---

Comment by vbraun created at 2013-09-15 15:56:02

Your changeset:6912669 has some weird changes to `.gitignore`. I've reverted that. The rest looks good to me and fixes the remaining doctest failures.


---

Comment by git created at 2013-09-15 16:00:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2013-09-15 16:37:06

Sorry for my lack of knowledge on git. What I did: ./sage -dev switch-ticket 15120, followed by "make". Afterwards, ./sage -dev did not work (so, I assume that the development scripts are in the master branch, but this ticket relies on a version of the master branch that predates the development scripts; correct?). Since I still found myself on commit 6912669, I did git pull, followed by git checkout e11727c. git log told me that now everything seems ok, I see Volker's recent addition on top of Robert's changes. So, I am now running make ptest.

But what I don't understand is this:

```
$ git branch -v
* (no branch)            e11727c revert the change to .gitignore
  master                 1456c52 Merge branch 'ticket/14482' into public/sage-git/master
  public/sage-git/master cf14c84 [behind 578] Merge branch 'ticket/14482' into public/sage-git/master
  ticket/15120           6912669 Fix --new option for doctests.
```


How can I make the branch ticket/15120 point to commit e11727c?


---

Comment by vbraun created at 2013-09-15 16:52:14

First of all, its perfectly fine to be in detached head mode. Especially if you don't want to make further commits on top of the given commit. You are just not in a branch, so what?

But, to answer your question: just delete the old branch and make a new one with your chosen head:

```
git branch -D ticket/15120
git checkout -b ticket/15120 HEAD
```

Alternatively, don't enter detached head mode to start with:

```
git checkout ticket/15120
git pull trac u/vbraun/ticket/15120
```



---

Comment by SimonKing created at 2013-09-15 18:09:15

Volker, thank you for your hints on making my git repository nicer.

Here are the errors that I still get:

```
sage -t src/sage/tests/cmdline.py  # 3 doctests failed
sage -t src/sage/interfaces/r.py  # 183 doctests failed
sage -t src/sage/interfaces/expect.py  # 7 doctests failed
sage -t src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t src/sage/misc/interpreter.py  # 4 doctests failed
sage -t src/doc/en/prep/Quickstarts/Statistics-and-Distributions.rst  # 6 doctests failed
sage -t src/sage/interfaces/interface.py  # 4 doctests failed
sage -t local/lib/python2.7/site-packages/sagenb-0.10.7.2-py2.7.egg/sagenb/misc/support.py  # 1 doctest failed
sage -t src/sage/stats/r.py  # 1 doctest failed
```

In comment:19, you state that it "fixes the remaining doctest failures"---after merging the current state of the master, or how? I did not merge the current master.


---

Comment by vbraun created at 2013-09-15 21:02:55

That's what I did, I merged the current master (`public/sage-git/master `), then ran the doctests, and then threw away the merge commit. All tests passed after the merge. Since there is no merge conflict there is no point in me pushing the merge, the release manager will do that when the ticket is merged.


---

Comment by vbraun created at 2013-09-22 20:59:09

I guess nobody dares to review the obvious revert of the gitignore change, fine. I'll do it myself then :P


---

Comment by vbraun created at 2013-09-22 20:59:09

Changing status from needs_review to positive_review.


---

Comment by ohanar created at 2013-09-22 23:16:58

I've merged this into the build_system branch at #14480, so I'm marking
this as a duplicate so that we can close this ticket now.

Robert: the build_system branch should now have all doctests pass, so you shouldn't need to maintain a separate branch for the patchbot.


---

Comment by jdemeyer created at 2013-10-05 09:45:31

Resolution: duplicate
