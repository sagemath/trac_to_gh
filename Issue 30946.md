# Issue 30946: Fix scipy for MacOS 11 (Big Sur)

Issue created by migration from https://trac.sagemath.org/ticket/31183

Original creator: jhpalmieri

Original creation time: 2021-01-04 20:46:15

`scipy` currently fails to build on the latest Mac OS, Big Sur.


---

Comment by jhpalmieri created at 2021-01-04 20:47:52

One option seems to be: if running Big Sur (i.e., if `MACOSX_VERSION` is "20"), then set `MACOSX_DEPLOYMENT_TARGET=11.0` in the `spkg-install.in` script. See #30651 for some discussion.


---

Comment by jhpalmieri created at 2021-01-04 23:19:19

Here is a branch to try out.


---

Comment by jhpalmieri created at 2021-01-05 00:52:29

New commits:


---

Comment by @zlscherr created at 2021-01-05 01:00:55

Do you know at what point in the build process the variable MACOSX_VERSION gets set? I just checked out the ticket and ran

./configure\\
make scipy-clean\\
make scipy

but it fails because MACOSX_VERSION isn't picked up.  I'd like to test the ticket but I'd rather not have to rebuild sage from scratch.


---

Comment by @zlscherr created at 2021-01-05 01:28:13

I just saw your other ticket, I see that on my system MACOSX_VERSION never gets set.


---

Comment by @zlscherr created at 2021-01-06 17:01:59

looks good to me.


---

Comment by jhpalmieri created at 2021-01-06 18:15:42

I'll mark it ready for review. I wish there were an upstream fix, but I couldn't find one.


---

Comment by jhpalmieri created at 2021-01-06 18:15:42

Changing status from new to needs_review.


---

Comment by @zlscherr created at 2021-01-06 19:55:23

Yea, I'm not really sure what is going on with gcc/homebrew.  A few days ago when I looked at the formula it seemed that it was applying a patch for MACOSX_DEPLOYMENT_TARGET=11 on intel based Macs, but when I checked again today I see that the patch is only applied on arm based Macs.

It feels like this is a problem homebrew should be able to fix, which in turn would allow scipy to compile without any problems.


---

Comment by mkoeppe created at 2021-01-06 19:55:44

Shouldn't the branch of #31186 be merged in?


---

Comment by @zlscherr created at 2021-01-07 22:03:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-01-08 18:59:07

Replying to [comment:10 mkoeppe]:
> Shouldn't the branch of #31186 be merged in?

I never know the right way to handle this. What works best for the release manager? Do the patchbots pay attention to the dependencies field? If they touched the same code and so one had to be merged first, it would be clear what to do.


---

Comment by mkoeppe created at 2021-01-08 19:12:30

Replying to [comment:12 jhpalmieri]:
> Do the patchbots pay attention to the dependencies field? 

No, the patchbots only merge the branch into the current beta. Only Volker's release management scripts read the dependencies field.

It's not important for the present ticket because you have tested it sufficiently on your machines. But in general, for the purpose of portability testing with GH Actions, we need branches that have merged the branches of the dependencies.


---

Comment by @zlscherr created at 2021-01-08 20:29:19

Is it also worthwhile to add Matthias's numpy patch as a dependency?


---

Comment by jhpalmieri created at 2021-01-09 04:14:51

Replying to [comment:14 gh-zlscherr]:
> Is it also worthwhile to add Matthias's numpy patch as a dependency?

Good idea, but that branch has already been merged, so I think it would be superfluous.


---

Comment by vbraun created at 2021-01-24 10:37:58

Resolution: fixed


---

Comment by @zlscherr created at 2021-01-25 17:26:44

Just wanted to point out that Homebrew gcc updated today and I think the MACOSX_DEPLOYMENT_TARGET issue for gfortran has been fixed.
