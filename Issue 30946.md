# Issue 30946: Fix scipy for MacOS 11 (Big Sur)

archive/issues_030946.json:
```json
{
    "body": "`scipy` currently fails to build on the latest Mac OS, Big Sur.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31183\n\n",
    "created_at": "2021-01-04T20:46:15Z",
    "labels": [
        "packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Fix scipy for MacOS 11 (Big Sur)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30946",
    "user": "jhpalmieri"
}
```
`scipy` currently fails to build on the latest Mac OS, Big Sur.

Issue created by migration from https://trac.sagemath.org/ticket/31183





---

archive/issue_comments_442030.json:
```json
{
    "body": "One option seems to be: if running Big Sur (i.e., if `MACOSX_VERSION` is \"20\"), then set `MACOSX_DEPLOYMENT_TARGET=11.0` in the `spkg-install.in` script. See #30651 for some discussion.",
    "created_at": "2021-01-04T20:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442030",
    "user": "jhpalmieri"
}
```

One option seems to be: if running Big Sur (i.e., if `MACOSX_VERSION` is "20"), then set `MACOSX_DEPLOYMENT_TARGET=11.0` in the `spkg-install.in` script. See #30651 for some discussion.



---

archive/issue_comments_442031.json:
```json
{
    "body": "Here is a branch to try out.",
    "created_at": "2021-01-04T23:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442031",
    "user": "jhpalmieri"
}
```

Here is a branch to try out.



---

archive/issue_comments_442032.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-05T00:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442032",
    "user": "jhpalmieri"
}
```

New commits:



---

archive/issue_comments_442033.json:
```json
{
    "body": "Do you know at what point in the build process the variable MACOSX_VERSION gets set? I just checked out the ticket and ran\n\n./configure\\\\\nmake scipy-clean\\\\\nmake scipy\n\nbut it fails because MACOSX_VERSION isn't picked up.  I'd like to test the ticket but I'd rather not have to rebuild sage from scratch.",
    "created_at": "2021-01-05T01:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442033",
    "user": "@zlscherr"
}
```

Do you know at what point in the build process the variable MACOSX_VERSION gets set? I just checked out the ticket and ran

./configure\\
make scipy-clean\\
make scipy

but it fails because MACOSX_VERSION isn't picked up.  I'd like to test the ticket but I'd rather not have to rebuild sage from scratch.



---

archive/issue_comments_442034.json:
```json
{
    "body": "I just saw your other ticket, I see that on my system MACOSX_VERSION never gets set.",
    "created_at": "2021-01-05T01:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442034",
    "user": "@zlscherr"
}
```

I just saw your other ticket, I see that on my system MACOSX_VERSION never gets set.



---

archive/issue_comments_442035.json:
```json
{
    "body": "looks good to me.",
    "created_at": "2021-01-06T17:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442035",
    "user": "@zlscherr"
}
```

looks good to me.



---

archive/issue_comments_442036.json:
```json
{
    "body": "I'll mark it ready for review. I wish there were an upstream fix, but I couldn't find one.",
    "created_at": "2021-01-06T18:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442036",
    "user": "jhpalmieri"
}
```

I'll mark it ready for review. I wish there were an upstream fix, but I couldn't find one.



---

archive/issue_comments_442037.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-06T18:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442037",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442038.json:
```json
{
    "body": "Yea, I'm not really sure what is going on with gcc/homebrew.  A few days ago when I looked at the formula it seemed that it was applying a patch for MACOSX_DEPLOYMENT_TARGET=11 on intel based Macs, but when I checked again today I see that the patch is only applied on arm based Macs.\n\nIt feels like this is a problem homebrew should be able to fix, which in turn would allow scipy to compile without any problems.",
    "created_at": "2021-01-06T19:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442038",
    "user": "@zlscherr"
}
```

Yea, I'm not really sure what is going on with gcc/homebrew.  A few days ago when I looked at the formula it seemed that it was applying a patch for MACOSX_DEPLOYMENT_TARGET=11 on intel based Macs, but when I checked again today I see that the patch is only applied on arm based Macs.

It feels like this is a problem homebrew should be able to fix, which in turn would allow scipy to compile without any problems.



---

archive/issue_comments_442039.json:
```json
{
    "body": "Shouldn't the branch of #31186 be merged in?",
    "created_at": "2021-01-06T19:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442039",
    "user": "mkoeppe"
}
```

Shouldn't the branch of #31186 be merged in?



---

archive/issue_comments_442040.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-07T22:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442040",
    "user": "@zlscherr"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442041.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> Shouldn't the branch of #31186 be merged in?\n\nI never know the right way to handle this. What works best for the release manager? Do the patchbots pay attention to the dependencies field? If they touched the same code and so one had to be merged first, it would be clear what to do.",
    "created_at": "2021-01-08T18:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442041",
    "user": "jhpalmieri"
}
```

Replying to [comment:10 mkoeppe]:
> Shouldn't the branch of #31186 be merged in?

I never know the right way to handle this. What works best for the release manager? Do the patchbots pay attention to the dependencies field? If they touched the same code and so one had to be merged first, it would be clear what to do.



---

archive/issue_comments_442042.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> Do the patchbots pay attention to the dependencies field? \n\nNo, the patchbots only merge the branch into the current beta. Only Volker's release management scripts read the dependencies field.\n\nIt's not important for the present ticket because you have tested it sufficiently on your machines. But in general, for the purpose of portability testing with GH Actions, we need branches that have merged the branches of the dependencies.",
    "created_at": "2021-01-08T19:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442042",
    "user": "mkoeppe"
}
```

Replying to [comment:12 jhpalmieri]:
> Do the patchbots pay attention to the dependencies field? 

No, the patchbots only merge the branch into the current beta. Only Volker's release management scripts read the dependencies field.

It's not important for the present ticket because you have tested it sufficiently on your machines. But in general, for the purpose of portability testing with GH Actions, we need branches that have merged the branches of the dependencies.



---

archive/issue_comments_442043.json:
```json
{
    "body": "Is it also worthwhile to add Matthias's numpy patch as a dependency?",
    "created_at": "2021-01-08T20:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442043",
    "user": "@zlscherr"
}
```

Is it also worthwhile to add Matthias's numpy patch as a dependency?



---

archive/issue_comments_442044.json:
```json
{
    "body": "Replying to [comment:14 gh-zlscherr]:\n> Is it also worthwhile to add Matthias's numpy patch as a dependency?\n\nGood idea, but that branch has already been merged, so I think it would be superfluous.",
    "created_at": "2021-01-09T04:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442044",
    "user": "jhpalmieri"
}
```

Replying to [comment:14 gh-zlscherr]:
> Is it also worthwhile to add Matthias's numpy patch as a dependency?

Good idea, but that branch has already been merged, so I think it would be superfluous.



---

archive/issue_comments_442045.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442045",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_442046.json:
```json
{
    "body": "Just wanted to point out that Homebrew gcc updated today and I think the MACOSX_DEPLOYMENT_TARGET issue for gfortran has been fixed.",
    "created_at": "2021-01-25T17:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30946#issuecomment-442046",
    "user": "@zlscherr"
}
```

Just wanted to point out that Homebrew gcc updated today and I think the MACOSX_DEPLOYMENT_TARGET issue for gfortran has been fixed.
