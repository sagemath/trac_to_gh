# Issue 28804: at ./bootstrap time, generate src/requirements.txt, src/constraints.txt, src/setup.cfg [install_requires] from build/pkgs

Issue created by migration from https://trac.sagemath.org/ticket/29041

Original creator: mkoeppe

Original creation time: 2020-01-18 21:43:50

CC:  slabbe dimpase embray vbraun fbissey thansen @tobiasdiez

https://pip.pypa.io/en/stable/user_guide/#requirements-files

This is another step toward #21507 - Task ticket: Make sagelib a pip-installable Python source package, listed on PyPI


---

Comment by mkoeppe created at 2020-01-19 01:07:30

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-19 01:07:30

This is what it could look like - just for a small handful of packages for now
----
New commits:


---

Comment by mkoeppe created at 2020-01-19 01:22:14

The `apt-get` line in the install manual could be generated in the same way.


---

Comment by mkoeppe created at 2020-01-20 15:02:42

Replying to [comment:3 mkoeppe]:
> The `apt-get` line in the install manual could be generated in the same way.
This is #29053.


---

Comment by dimpase created at 2020-01-21 23:39:32

I see that only few packages, e.g. pillow, are mentioned in the branch. Are they there as an example?


---

Comment by mkoeppe created at 2020-01-21 23:45:42

Yes, it's an initial example. More can be added on this ticket and/or on follow up tickets.

It may be the most efficient to first put this infrastructure (and the one for Debian) in place and then do invidual packages one by one to determine useful version bounds.


---

Comment by dimpase created at 2020-01-21 23:51:16

how is it going to play out with version constraints in spkg-configure.m4 files?


---

Comment by mkoeppe created at 2020-01-21 23:56:20

So far there are no `spkg-configure.m4` files for any Python packages, and I would hope there will be no need for them.


---

Comment by mkoeppe created at 2020-01-21 23:59:03

Basically `sagelib-install-requires.txt` will play the same role for Python packages as `spkg-configure.m4` does for non-Python packages, 
and likewise `sagelib-requirements.txt` : `package-version.txt`.


---

Comment by mkoeppe created at 2020-01-31 14:04:34

`@`embray If you have time - this ticket is waiting for review.


---

Comment by embray created at 2020-02-05 11:50:06

Similar to what I wrote on #26964, I don't think this should be done in the `bootstrap` script.  I don't want this script growing too far beyond its core purpose, which is simply to bootstrap the `configure` script.

This could be done by `configure` instead, using say a `requirements.txt.in`.


---

Comment by embray created at 2020-02-05 11:50:06

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-02-05 13:50:51

See my comments on #26964.


---

Comment by mkoeppe created at 2020-02-05 18:45:24

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-02-22 23:21:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-22 23:22:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-02 01:41:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-06 16:54:43

Needs review


---

Comment by mkoeppe created at 2020-03-15 17:10:03

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2020-09-16 08:50:32

Another approach would be to maintain an independent pipfile/requirements.txt in src/ and have automatic checks to make sure that the sage packages provide the required packages with a suitable version.

Reason: I feel like sage-lib should be independent of sage-distribution as much as possible.

More practical reason: pipenv works very nicely on Windows, and my hope is to use it without having to use `sage make` beforehand. So one simply clones the code, starts the virtual env with pipenv and gets an editiable install of sage for easy development. But for this the pipfile needs to be there without running the bootstrap command. (The alternative would be to rewrite the bootstrap cmd in a OS-independent way, say using powershell.)


---

Comment by mkoeppe created at 2020-09-16 17:07:46

Replying to [comment:30 gh-tobiasdiez]:
> Another approach would be to maintain an independent pipfile/requirements.txt in src/ and have automatic checks to make sure that the sage packages provide the required packages with a suitable version.
> 
> Reason: I feel like sage-lib should be independent of sage-distribution as much as possible.

I think the versions given by sage-the-distribution (`build/pkgs/*/package-version.txt`) should be considered as pinned versions, and information such as `requirements.txt` or `Pipfile`/`Pipfile.lock` should come from there in some way.

The allowed version ranges are currently not encoded anywhere. For non-Python packages have `spkg-configure.m4` (#27330), but this is obviously the wrong mechanism for Python packages.  setuptools has them in `setup.cfg [install_requires]`. 

I think I agree with you that this information does not necessarily have to be generated from (new) files in `build/pkgs/` but could be put directly into `src/`, such as `src/setup.cfg`. 


> More practical reason: pipenv works very nicely on Windows, and my hope is to use it without having to use `sage make` beforehand. So one simply clones the code, starts the virtual env with pipenv and gets an editiable install of sage for easy development.

I think some steps are missing here - we don't have a native Windows build of many packages that Sage depends on. But I agree, after modularization (#29705) we should aim for getting a native Windows build of a Sage core at least.

> But for this the pipfile needs to be there without running the bootstrap command. (The alternative would be to rewrite the bootstrap cmd in a OS-independent way, say using powershell.) 

Note that we have the `bootstrap -d` mechanism, which downloads a tarball of the files created by `bootstrap`.  This is how most users and developers get these files. We could look into creating a powershell version of `bootstrap -d`.


---

Comment by @tobiasdiez created at 2020-09-28 10:38:37

There is also https://pypi.org/project/pipenv-to-requirements/ to generate the requirements file from a pipfile.


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-12 21:05:13

Rewriting tools used in the bootstrap phase in Python would also be useful for developing on Windows


---

Comment by dimpase created at 2020-12-12 22:51:10

hmm, what is so problematic about Windows here? Even if one talks about native, non-cygwin, it is still perfectly possible to run bash etc.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
