# Issue 8567: Specify the location of iconv for 'gd'

Issue created by migration from https://trac.sagemath.org/ticket/8567

Original creator: drkirkby

Original creation time: 2010-03-20 14:21:49

Assignee: GeorgSWeber

CC:  kcrisman

Since iconv was added to Sage (#8432) as a standard package (needing due to someone updating R without checking it fully), there have been some problems on Fedora and OpenSuse which look to be related to problems building gd when there are two copies of iconv to be found on the system. Since there is an option to specify the location of the iconv package in gd's configure script, this is probably worth doing, though it needs checking carefully. 

Dave


---

Comment by jsp created at 2010-03-20 16:29:22

--with-libiconv-prefix=SAGE_LOCAL

does not work for me on Fedora 12 64 bit.



```
It was created by GD configure 2.0.35, which was
generated by GNU Autoconf 2.61.  Invocation command line was

  $ ./configure --prefix=/home/jaap/downloads/sage-4.3.4.rc0/local --without-jpeg --with-libiconv-prefix=/home/jaap/downloads/sage-4.3.4.rc0/local --without-x --with-zlib=/home/jaap/downloads/sage-4.3.4.rc0/local --with-freetype=/home/jaap/downloads/sage-4.3.4.rc0/local --without-xpm

```



```
gcc -fPIC -g -I/home/jaap/downloads/sage-4.3.4.rc0/local/include -I/home/jaap/downloads/sage-4.3.4.rc0/local/include/freetype2/ -Wl,--rpath -Wl,/home/jaap/downloads/sage-4.3.4.rc0/local/lib -o .libs/annotate annotate.o  -L/home/jaap/downloads/sage-4.3.4.rc0/local/lib ./.libs/libgd.so -lfontconfig /home/jaap/downloads/sage-4.3.4.rc0/local/lib/libfreetype.so /home/jaap/downloads/sage-4.3.4.rc0/local/lib/libpng12.so -lz -lm -Wl,--rpath -Wl,/home/jaap/downloads/sage-4.3.4.rc0/local/lib
./.libs/libgd.so: undefined reference to `libiconv'
./.libs/libgd.so: undefined reference to `libiconv_close'
./.libs/libgd.so: undefined reference to `libiconv_open'
collect2: ld returned 1 exit status

```



Jaap


---

Comment by jsp created at 2010-03-20 16:41:07

moving /usr/bin/iconv and /usr/include/iconv.h out of the way made it possible to build
gd

So nothing wrong with the libiconv in SAGE_LOCAL

Jaap


---

Comment by hivert created at 2010-03-20 17:12:02

Replying to [ticket:8567 drkirkby]:
> Since iconv was added to Sage (#8432) as a standard package (needing due to someone updating R without checking it fully), there have been some problems on Fedora and OpenSuse which look to be related to problems building gd when there are two copies of iconv to be found on the system. 

First of all I have the same problem on Gentoo. Ther is also a report of someone having the same problem on Mandriva.

I manage to get it work by the following workaround:
I replaced

```
$MAKE
}}} 
by
{{{
LIBICONV="$SAGE_LOCAL"/lib/libiconv.so $MAKE
}}}
in spkg-install. I've no idea how robust this workaround is. I posted a spkg with the fix.

Florent


---

Comment by jhpalmieri created at 2010-03-20 17:13:58

By the way, in spkg-install, I think it should say "--with-x=no" rather than "--without-x", and the same for jpeg and xpm.


---

Comment by hivert created at 2010-03-20 17:34:55

Replying to [comment:3 hivert]:
> First of all I have the same problem on Gentoo. Ther is also a report of someone having the same problem on Mandriva.
> 
> I manage to get it work by the following workaround:
> I replaced
> {{{
> $MAKE
> }}} 
> by
> {{{
> LIBICONV="$SAGE_LOCAL"/lib/libiconv.so $MAKE
> }}}
> in spkg-install. I've no idea how robust this workaround is. I posted a spkg with the fix.

Sorry ! This spkg is completely broken... I'm trying to put a working one.

Florent


---

Comment by jsp created at 2010-03-20 17:38:46

Don't put an spkg as attachment! Please give a link to the spkg.

Jaap


---

Comment by hivert created at 2010-03-20 18:15:23

Replying to [comment:6 jsp]:
> Don't put an spkg as attachment! Please give a link to the spkg.
> 
> Jaap

Oops sorry ! My workaround does work actually. I find out that python distutils have the same problems much later...


---

Comment by jhpalmieri created at 2010-03-20 18:22:39

This doesn't help on these systems (output from uname -a):

```
Linux eno 2.6.31.12-174.2.22.fc12.x86_64 #1 SMP Fri Feb 19 18:55:03 UTC 2010 x86_64 x86_64 x86_64 GNU/Linux
Linux lena 2.6.31.12-174.2.19.fc12.x86_64 #1 SMP Thu Feb 11 07:07:16 UTC 2010 x86_64 x86_64 x86_64 GNU/Linux
```

I also don't know why it's about 50% bigger than the previous spkg.


---

Comment by jsp created at 2010-03-20 19:46:46

In Fedora 12 x86_64 the installation of libiconv is not complete:



```
[root@vrede jaap]# find /usr/bin -name "*iconv*"
/usr/bin/iconv.bak
/usr/bin/piconv
[root@vrede jaap]# find /usr/include -name "*iconv*"
/usr/include/evolution-data-server-2.28/camel/camel-iconv.h
/usr/include/evolution-data-server-2.28/libedataserver/e-iconv.h
/usr/include/Qt3Support/q3iconview.h
/usr/include/c++/4.4.3/gnu/gcj/convert/Output_iconv.h
/usr/include/c++/4.4.3/gnu/gcj/convert/Input_iconv.h
/usr/include/gtk-2.0/gtk/gtkiconview.h
/usr/include/Qt/q3iconview.h
/usr/include/xulrunner-sdk-1.9.1/system_wrappers_js/iconv.h
/usr/include/xulrunner-sdk-1.9.1/system_wrappers/iconv.h
/usr/include/iconv.h.bak
[root@vrede jaap]# find /usr/lib -name "*iconv*"
/usr/lib/ruby/1.8/xsd/iconvcharset.rb
[root@vrede jaap]# 

```


Jaap


---

Comment by hivert created at 2010-03-20 23:00:57

I maybe manage to have something working by a hack. Could someone try the following spkg:
http://sage.math.washington.edu/home/hivert/spkg/gd-2.0.35.p4.spkg


---

Comment by jhpalmieri created at 2010-03-20 23:14:35

That appears to work on the two systems I mentioned before.  I'll know for sure when a full Sage build is completed...


---

Comment by drkirkby created at 2010-03-20 23:29:48

Replying to [comment:3 hivert]:
> Replying to [ticket:8567 drkirkby]:
> > Since iconv was added to Sage (#8432) as a standard package (needing due to someone updating R without checking it fully), there have been some problems on Fedora and OpenSuse which look to be related to problems building gd when there are two copies of iconv to be found on the system. 
> 
> First of all I have the same problem on Gentoo. Ther is also a report of someone having the same problem on Mandriva.
> 
> I manage to get it work by the following workaround:
> I replaced
> {{{
> $MAKE
> }}} 
> by
> {{{
> LIBICONV="$SAGE_LOCAL"/lib/libiconv.so $MAKE
> }}}
> in spkg-install. I've no idea how robust this workaround is. I posted a spkg with the fix.
> 
> Florent

I've got no idea if setting LIBICOV shoudl be set, but if it is, the way to do it should be:

```
LIBICONV="$SAGE_LOCAL/lib/libiconv.so"
```


and not


```
LIBICONV="$SAGE_LOCAL"/lib/libiconv.so
```


Dave


---

Comment by drkirkby created at 2010-03-20 23:31:41

Replying to [comment:1 jsp]:
>   --with-libiconv-prefix=SAGE_LOCAL
> 
> does not work for me on Fedora 12 64 bit.

> Jaap
> 

Jaap, 

is that a typo in the trac ticket, or was it in the package? There should be a $ sign in front if SAGE_LOCAL.


---

Comment by drkirkby created at 2010-03-21 00:13:42

If this gets too much of a mess, we could consider creating a ticket to get the R package reverted to the older version. I've cc'ed Karl-Dieter Crisman who updated R, whilst ignoring the warning from the configure script and not testing on Solaris. 

Hopefully iconv can be sorted out, but if it can't be done properly, then reverting the R version is always an option, then iconv will not be needed. We could change iconv's spkg-install to simply exit with an exit code of 0. That would make it relatively easy to do, whilst leaving iconv in Sage to allow it to be sorted out properly prior to updating R. 

Dave


---

Comment by drkirkby created at 2010-03-21 00:13:42

Changing assignee from GeorgSWeber to drkirkby.


---

Comment by jhpalmieri created at 2010-03-21 01:12:09

For me, the Sage build completed, but the documentation won't build because Sage doesn't start successfully:

```
Traceback (most recent call last):
  File "/home/palmieri/lena/sage-4.3.4.alpha1/local/bin/sphinx-build", line 6, in <module>
    import sage.all
  File "/home/palmieri/lena/sage-4.3.4.alpha1/local/lib/python2.6/site-packages/sage/all.py", line 73, in <module>
    from sage.matrix.all     import *
  File "/home/palmieri/lena/sage-4.3.4.alpha1/local/lib/python2.6/site-packages/sage/matrix/all.py", line 1, in <module>
    from matrix_space import MatrixSpace, is_MatrixSpace
  File "/home/palmieri/lena/sage-4.3.4.alpha1/local/lib/python2.6/site-packages/sage/matrix/matrix_space.py", line 40, in <module>
    import matrix_mod2_dense
ImportError: /home/palmieri/lena/sage-4.3.4.alpha1/local/lib/libgd.so.2: undefined symbol: libiconv
```

Running

```
export LIBICONV="$SAGE_LOCAL/lib/libiconv.so"
```

right before running Sage doesn't help.


---

Comment by drkirkby created at 2010-03-21 02:05:44

Replying to [comment:2 jsp]:
> moving /usr/bin/iconv and /usr/include/iconv.h out of the way made it possible to build
> gd
> 
> So nothing wrong with the libiconv in SAGE_LOCAL
> 
> Jaap
> 

I had a discussion with a libtool developer about a similar issue once before. He said it is wrong to have two copies of a library, so the problem may be more fundamental. However, it is strange gd ignores the option to look for iconv in $SAGE_LOCAL. 

One disadvantage of reverting R and not installing iconv is that iconv is needed to build gd on Cygwin, and there is effort into porting Sage to Cygwin. 

We could consider only installing iconv on Solaris and Cygwin, though I'm tempted to suggest reverting R and getting the problem solved properly at a later date, rather than a hack now. 

Dave


---

Comment by hivert created at 2010-03-21 09:39:40

Replying to [comment:15 jhpalmieri]:
> For me, the Sage build completed, but the documentation won't build because Sage doesn't start successfully:

I got the same behavior on openSuSE 11.1 and Gentoo 1.12.9 both x86_64. The build appears to be complete but sage itself is broken.

I don't know what to do and I've no more time to investigate. My vote is to revert R, remove gd and make as soon as possible a fix release until this is sorted out. We can't seriously make a release which is broken on half the distro.


---

Comment by jsp created at 2010-03-21 10:41:44

Replying to [comment:16 drkirkby]:

> I had a discussion with a libtool developer about a similar issue once before. He said it is wrong to have two copies of a library, so the problem may be more fundamental. However, it is strange gd ignores the option to look for iconv in $SAGE_LOCAL. 
> 

I'm not so sure anymore I didn't make another typo in spkg-install.

I'll try again.

Jaap


---

Comment by drkirkby created at 2010-03-21 12:26:48

Another way to solve the fallout from updating R, will probably be to add


```
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
  exit 0
fi
```


to the top of the *iconv* spkg-install file. That's probably the simplest hack. This is untested and I don't have time to do this until around 2100 GMT today, so if someone beats me to it, go ahead and try it. *Make sure it is tested on both Solaris and Linux. It should build iconv on Solaris, but not on Linux*

Dave


---

Comment by jsp created at 2010-03-21 12:31:52

About iconv(): according to the man pages the function is part of glibc


```
VERSIONS
       This function is available in glibc since version 2.1.

CONFORMING TO
       POSIX.1-2001.

SEE ALSO
       iconv_close(3), iconv_open(3)


```


So for most systems there is no need to have a local libiconv!
Let's say only Solaris and Cygwin.

Jaap


---

Comment by jsp created at 2010-03-21 12:46:01

Replying to [comment:19 drkirkby]:
> Another way to solve the fallout from updating R, will probably be to add
> 
> {{{
> if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
>   exit 0
> fi
> }}}
> 

This probably will cause trouble on Open Solaris.

Jaap


---

Comment by GeorgSWeber created at 2010-03-21 13:03:05

Replying to [comment:19 drkirkby]:
> Another way to solve the fallout from updating R, will probably be to add
> 
> {{{
> if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
>   exit 0
> fi
> }}}
> 
> to the top of the *iconv* spkg-install file. That's probably the simplest hack. This is untested and I don't have time to do this until around 2100 GMT today, so if someone beats me to it, go ahead and try it. *Make sure it is tested on both Solaris and Linux. It should build iconv on Solaris, but not on Linux*
> 
> Dave 

Yes, I definitely prefer this way, too. The OpenSolaris topic may be solved later (what does $UNAME give there as output?), and it might be nice to remove any leftovers in "$SAGE_ROOT/bin/" from earlier (especially v3.4.3) Sage installs. Which might be tricky in a "Sage upgrade" use case. But never mind, the road to go is clear now!

Cheers,
Georg


---

Comment by jsp created at 2010-03-21 13:16:16

Replying to [comment:22 GeorgSWeber]:
> Replying to [comment:19 drkirkby]:
> > Another way to solve the fallout from updating R, will probably be to add
> > 
> > {{{
> > if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
> >   exit 0
> > fi
> > }}}
> > 

> 
> Yes, I definitely prefer this way, too. The OpenSolaris topic may be solved later (what does $UNAME give there as output?)

SunOS

Removing local/bin/iconv, local/lib/libiconv.* and local/include/iconv.h made the
gd spkg work on Fedora 12.

Jaap


---

Comment by drkirkby created at 2010-03-21 14:18:34

Jaap, 

I don't have time to test it now (really am tied up), but if you can test on OpenSolaris, then make a decision whether iconv needs installing or not. 


```
drkirkby@kestrel:~$ uname -r
5.10
```


on Solaris 10, and 


```
drkirkby@hawk:~$ uname -r
5.11
```


on OpenSolaris (aka Solaris 11). So just put an additional clause if needed. 

The -r option to uname is POSIX, so we can rely on that. Don't use 'uname -p' since

 * The i386 processor is used on Solaris 10 too. 
 * -p is not a POSIX option to uname, so can cause hassles on other systems. 

Also worth checking, in preference to this are whether the version of 'gd' in Sage is old and furthermore the 'gd' developers have fixed the bug that prevents '--with-libiconv-prefix' working properly. If so, consider updating gd. 

Had R been properly tested, none of this would have been necessary. 

When I wrote the iconv package, it clears out debris, like libraries and binaries, so there should be no need to do that again - just make sure the cleaning up is done before exiting. 

Since Jaap and I are looking to port Sage to OpenSolaris, we are not keen to introduce more problems for the future. Let's sort it out now. 

Dave


---

Comment by jsp created at 2010-03-21 18:06:03

Replying to [comment:24 drkirkby]:
> Jaap, 
> 
> I don't have time to test it now (really am tied up), but if you can test on OpenSolaris, then make a decision whether iconv needs installing or not. 
> 

Opensolaris has it's own iconv included in glibc.


> on OpenSolaris (aka Solaris 11). So just put an additional clause if needed. 
> 

Yes we should put an extra test in

> The -r option to uname is POSIX, so we can rely on that. Don't use 'uname -p' since
> 

Ok.

>  * The i386 processor is used on Solaris 10 too. 
>  * -p is not a POSIX option to uname, so can cause hassles on other systems. 
> 
> Also worth checking, in preference to this are whether the version of 'gd' in Sage is old and furthermore the 'gd' developers have fixed the bug that prevents '--with-libiconv-prefix' working properly. If so, consider updating gd. 
> 

Let's go for the proposed option and leave alone the gd package for the moment.

> Had R been properly tested, none of this would have been necessary. 
> 

You are repeating your self :-)!

My proposal is you update the iconv spkg and I and evt. others review it.

I think we can wait some more hours.

Jaap


---

Comment by jhpalmieri created at 2010-03-21 18:26:01

Replying to [comment:19 drkirkby]:
> Another way to solve the fallout from updating R, will probably be to add
> 

```
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
  exit 0
fi
```

> 
> to the top of the *iconv* spkg-install file. 

Informally (that is, I threw together a quick spkg), this works on at least one of the linux boxes I had troubles with before, and it also works on sage.math.  I haven't tested it on Solaris, and I probably won't have time to; I don't have access to a Windows/Cygwin machine.  I would suggest that the spkg-install file actually say 

```
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] ; then
  echo "Not installing iconv -- on systems other than Solaris and Cygwin, use the system's iconv"
  exit 0
fi
```

Or something like that -- I'm not sure exactly what the message should say.


---

Comment by hivert created at 2010-03-21 18:56:24

Replying to [comment:26 jhpalmieri]:
> Replying to [comment:19 drkirkby]:
> > Another way to solve the fallout from updating R, will probably be to add
> > 

```
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] then ; 
  exit 0
fi
```

The ";" should be before "then"..
.


```
if [ "x$UNAME" != xSunOS ] && [ "x$UNAME" != xCYGWIN ] ; then
  echo "Not installing iconv -- on systems other than Solaris and Cygwin, use the system's iconv"
  exit 0
fi
```

> Or something like that -- I'm not sure exactly what the message should say.

I'm trying this on gentoo and it seems to work... I'm waiting for the build to finish.

Florent


---

Comment by drkirkby created at 2010-03-21 19:07:21

I've change the title and description and are in the process of creating a package for others to review.


---

Comment by drkirkby created at 2010-03-21 19:38:59

I've stuck a package here: 

http://sage.math.washington.edu/home/kirkby/iconv/iconv-1.13.1.p0.spkg


---

Comment by jsp created at 2010-03-21 19:41:30

Replying to [comment:29 drkirkby]:
> I've stuck a package here: 
> 
> http://sage.math.washington.edu/home/kirkby/iconv/iconv-1.13.1.p0.spkg
> 

I'll try it asap.

Jaap


---

Comment by drkirkby created at 2010-03-21 19:44:14

Mercurial patch to ensure iconv builds on Solaris and Cygwin only


---

Comment by drkirkby created at 2010-03-21 19:47:32

Changing status from new to needs_review.


---

Attachment

I've not tested this extensively, but it builds on Solaris and hopefully does not on Linux. I don't have time to do much testing, so others can. 

I don't have a Cygwin system set up.


---

Comment by jsp created at 2010-03-21 19:57:02

************
Removing old iconv files if they exist
iconv will not be installed, as it is only installed on
Solaris and Cygwin - see:
http://trac.sagemath.org/sage_trac/ticket/8567

real	0m0.078

```
gcc version 4.4.3 20100127 (Red Hat 4.4.3-4) (GCC) 
****************************************s
user	0m0.008s
sys	0m0.015s
Successfully installed iconv-1.13.1.p0

```




```
echo "Removing old iconv files if they exist"
# If iconv is updated, please double-check these are still necessary
# and that there are no extra files added.

rm -f $SAGE_LOCAL/bin/iconv  $SAGE_LOCAL/lib/charset.alias
rm -f $SAGE_LOCAL/lib/*libiconv*  $SAGE_LOCAL/lib/libcharset*
rm -f $SAGE_LOCAL/include/iconv.h  $SAGE_LOCAL/include/libcharset.h
rm -f $SAGE_LOCAL/include/localcharset.h
rm -rf  $SAGE_LOCAL/share/doc/libiconv
rm -f $SAGE_LOCAL/share/man/man1/iconv* $SAGE_LOCAL/share/man/man3/iconv*


```


This looks ok for me on Fedora (Linux in general?)

The Opensolaris issue is not resolved, but I think this deserves a positive review.

Jaap


---

Comment by hivert created at 2010-03-21 20:07:39

With the spkg here, from a fresh Sage source:
 - iconv build is successfully skipped,
 - gd is successfully build
on openSuSE 11.1 and Gentoo 1.12.9. I'm waiting the whole build to finish, but it should be ok... I'll then agree with Jaap on positive review.

Thanks


---

Comment by jsp created at 2010-03-21 20:13:07

Replying to [comment:34 hivert]:
> With the spkg here, from a fresh Sage source:
>  - iconv build is successfully skipped,
>  - gd is successfully build
> on openSuSE 11.1 and Gentoo 1.12.9. I'm waiting the whole build to finish, but it should be ok... I'll then agree with Jaap on positive review.
> 
> Thanks

My build finished successful, so let's do it! I leave it to you to give the positive review.

Jaap


---

Comment by hivert created at 2010-03-21 21:42:28

Replying to [comment:35 jsp]:
> My build finished successful, so let's do it! I leave it to you to give the positive review.

Mine too on openSuSE and gentoo. I'm ready to give positive review but should it be tested on Cygwin ? Unfortunately, I've no access to this kind of machine.

Cheers,

Florent


---

Comment by jsp created at 2010-03-21 21:46:07

Replying to [comment:36 hivert]:
> Replying to [comment:35 jsp]:
> > My build finished successful, so let's do it! I leave it to you to give the positive review.
> 
> Mine too on openSuSE and gentoo. I'm ready to give positive review but should it be tested on Cygwin ? Unfortunately, I've no access to this kind of machine.
> 
> Cheers,
> 
> Florent

Please do! There is no change in SunOS and Cygwin. In both cases iconv spkg will be build as before.

Jaap


---

Comment by hivert created at 2010-03-21 21:50:53

Changing status from needs_review to positive_review.


---

Comment by was created at 2010-03-29 22:08:20

Resolution: fixed


---

Comment by was created at 2010-03-29 22:08:20

Merged into sage-4.3.5.


---

Comment by bascorp2 created at 2010-05-26 08:43:15

[deleted spam]
