# Issue 17919: XCode 6.3 broken

Issue created by migration from https://trac.sagemath.org/ticket/18156

Original creator: vbraun

Original creation time: 2015-04-10 20:09:23

CC:  dimpase

http://stackoverflow.com/questions/29529455/missing-c-header-debug-after-updating-osx-command-line-tools-6-3

Even if you hack in the missing(?) `__debug` header, the gcc bootstrap in Sage will fail.


---

Comment by buck created at 2015-04-20 16:11:05

I didn't run into this. Was it because I wasn't doing a debug build?


---

Comment by vbraun created at 2015-04-20 18:13:04

This is without doing anything special. It might only be triggered if you only have command line tools without the gui xcode part. Though with the gui xcode stuff you just hit other bugs.


---

Comment by jhpalmieri created at 2015-04-22 23:34:54

Xcode 6.3.1 was released, but gcc still won't build for me. (This is with both the gui part and the command line tools installed.) In particular, the bootstrap fails.


---

Comment by fbissey created at 2015-04-23 23:36:17

Just tried a clean with sources that I currently have around on my mac (6.6.beta5) and it failed to build gcc too, not during what I would call bootstraping, but I am guessing that's what you are talking about because of the message.

```
Comparing stages 2 and 3
warning: gcc/cc1-checksum.o differs
warning: gcc/cc1plus-checksum.o differs
Bootstrap comparison failure!
gcc/asan.o differs
gcc/attribs.o differs
gcc/bitmap.o differs
gcc/c/c-decl.o differs
gcc/cfg.o differs
gcc/coverage.o differs
gcc/cp/class.o differs
gcc/cp/semantics.o differs
gcc/cp/tree.o differs
gcc/dse.o differs
gcc/dwarf2out.o differs
gcc/except.o differs
gcc/fortran/trans-common.o differs
gcc/ggc-common.o differs
gcc/ipa-profile.o differs
gcc/ira-color.o differs
gcc/ira-costs.o differs
gcc/loop-unroll.o differs
gcc/lto-streamer-in.o differs
gcc/lto-streamer-out.o differs
gcc/passes.o differs
gcc/plugin.o differs
gcc/postreload-gcse.o differs
gcc/statistics.o differs
gcc/trans-mem.o differs
gcc/tree-cfg.o differs
gcc/tree-eh.o differs
gcc/tree-ssa-ccp.o differs
gcc/tree-ssa-coalesce.o differs
gcc/tree-ssa-dom.o differs
gcc/tree-ssa-live.o differs
gcc/tree-ssa-loop-ivopts.o differs
gcc/tree-ssa-phiopt.o differs
gcc/tree-ssa-pre.o differs
gcc/tree-ssa-reassoc.o differs
gcc/tree-ssa-threadupdate.o differs
gcc/tree-ssa-uncprop.o differs
gcc/tree-vectorizer.o differs
gcc/valtrack.o differs
gcc/vtable-verify.o differs
make[5]: *** [compare] Error 1
make[4]: *** [stage3-bubble] Error 2
make[3]: *** [all] Error 2
```

Since when is a difference between stage 2 and stage 3 an automatic failure?


---

Comment by vbraun created at 2015-04-23 23:38:45

I've seen exactly the same when bootstrapping gcc with Xcode 6.3.

There is a workaround at https://github.com/Homebrew/homebrew/pull/38596


---

Comment by fbissey created at 2015-04-24 12:48:01

Replying to [comment:5 vbraun]:
> I've seen exactly the same when bootstrapping gcc with Xcode 6.3.
> 
> There is a workaround at https://github.com/Homebrew/homebrew/pull/38596

Yes that works. I added to `GCC_CONFIG` in the block for `darwin-14` and it did go through.


---

Comment by jdemeyer created at 2015-04-24 15:20:23

Replying to [comment:4 fbissey]:
> Since when is a difference between stage 2 and stage 3 an automatic failure?
Since always that I can remember...


---

Comment by jhpalmieri created at 2015-04-24 16:59:50

It works for me, too. With only the 6.3.1 command line tools installed (not the gui Xcode app), gcc fails without the workaround, builds with it. `R` fails (#18254), so if I also fake the installation of `R` and `rpy2` by touching the appropriate files in `local/var/lib/sage/installed`, the rest of Sage builds and passes most tests. The only failures are related to the absence of `R` and `rpy2`.

For the record, I used this change:

```diff
diff --git a/build/pkgs/gcc/spkg-install b/build/pkgs/gcc/spkg-install
index 54ec8a5..72ad913 100755
--- a/build/pkgs/gcc/spkg-install
+++ b/build/pkgs/gcc/spkg-install
@@ -79,6 +79,9 @@ if { uname -sr | grep 'Darwin 14\.' ;} &>/dev/null; then
     else
         echo "Warning: header /usr/include/dispatch/object.h not found, not applying fix."
     fi
+    # Use 'bootstrap-debug' build configuration to force stripping of object
+    # files prior to comparison during bootstrap (broken by Xcode 6.3).
+    GCC_CONFIGURE="--with-build-config=bootstrap-debug $GCC_CONFIGURE"
 fi
 
 # On OSX: isl/cloog libraries are almost certainly from Homebrew and won't work
```



---

Comment by dimpase created at 2015-04-27 10:29:32

Replying to [comment:8 jhpalmieri]:
> It works for me, too. With only the 6.3.1 command line tools installed (not the gui Xcode app), gcc fails without the workaround, builds with it. `R` fails (#18254), so if I also fake the installation of `R` and `rpy2` by touching the appropriate files in `local/var/lib/sage/installed`, the rest of Sage builds and passes most tests. The only failures are related to the absence of `R` and `rpy2`.
> 
> For the record, I used this change:
> {{{
> #!diff
> diff --git a/build/pkgs/gcc/spkg-install b/build/pkgs/gcc/spkg-install
> index 54ec8a5..72ad913 100755
> --- a/build/pkgs/gcc/spkg-install
> +++ b/build/pkgs/gcc/spkg-install
> `@``@` -79,6 +79,9 `@``@` if { uname -sr | grep 'Darwin 14\.' ;} &>/dev/null; then
>      else
>          echo "Warning: header /usr/include/dispatch/object.h not found, not applying fix."
>      fi
> +    # Use 'bootstrap-debug' build configuration to force stripping of object
> +    # files prior to comparison during bootstrap (broken by Xcode 6.3).
> +    GCC_CONFIGURE="--with-build-config=bootstrap-debug $GCC_CONFIGURE"
>  fi
>  
>  # On OSX: isl/cloog libraries are almost certainly from Homebrew and won't work
> }}}

should we check for the version of Xcode, too?
(this patch is not needed on Xcode <= 6.2)


---

Comment by jhpalmieri created at 2015-04-27 15:11:19

Replying to [comment:10 dimpase]:
> should we check for the version of Xcode, too?
> (this patch is not needed on Xcode <= 6.2)

Probably. Do you know a good way to do that? (It would probably be best, in fact, to check for the missing feature rather than a specific version number.)


---

Comment by dimpase created at 2015-04-27 15:55:05

Replying to [comment:11 jhpalmieri]:
> Replying to [comment:10 dimpase]:
> > should we check for the version of Xcode, too?
> > (this patch is not needed on Xcode <= 6.2)
> 
> Probably. Do you know a good way to do that? 

```
xcodebuild -version | grep XCode
```

will output something like

```
XCode a.b.c
```

So this is just a bit of shell scripting. If you like I can do this.


> (It would probably be best, in fact, to check for the missing feature rather than a specific version number.)
well, this sounds like adding a check to gcc configure script; while doable, it does not seem like worth the effort to me.


---

Comment by jhpalmieri created at 2015-04-27 17:39:30

Unfortunately this won't work. If you just have the command-line tools installed, not Xcode.app, you will see

```
$ xcodebuild -version
xcode-select: error: tool 'xcodebuild' requires Xcode, but active developer directory '/Library/Developer/CommandLineTools' is a command line tools instance
```

The command `xcode-select -version` seems to output

```
xcode-select version 2339.
```

for both 6.2 and 6.3.1. I tried looking for the string "6.3.1" in the command-line tools directory, but couldn't find anything, nor did I find any obviously useful differences between the directories for 6.2 and 6.3.1 (not that I really know what I'm looking for). They have different versions of git, so we could look at something like

```
$ `xcode-select -p`/usr/bin/git --version
```

but this is pretty indirect.


---

Comment by jhpalmieri created at 2015-04-27 18:38:09

We could do the same but with `gcc`:

```
$ `xcode-select -p`/usr/bin/gcc --version 2> /dev/null | grep 'Apple LLVM version'
Apple LLVM version 6.0 (clang-600.0.57) (based on LLVM 3.5svn)
```

With Xcode 6.2, we get "Apple LLVM version 6.0", and with Xcode 6.3.1, we get 6.1.0.


---

Comment by buck created at 2015-04-27 21:09:07

Is there any drawback to doing this invariantly, without regard fire xcode version? If not, the special case is undesirable. It creates new edge cases for bugs for users and testers.


---

Comment by jhpalmieri created at 2015-04-27 21:41:11

Replying to [comment:15 buck]:
> Is there any drawback to doing this invariantly, without regard fire xcode version?

Do you mean always using `GCC_CONFIGURE="--with-build-config=bootstrap-debug $GCC_CONFIGURE"` on OS X?


---

Comment by fbissey created at 2015-04-27 22:01:43

Like buck I am all to keep it simple. We already have a few blanket statements for 10.10, we should just add it there. I am expecting the percentage of people staying behind to be low. You need a specific reason not to upgrade rather than the reverse (although I have to agree that apple continuously breaking things is a good motivation).


---

Comment by buck created at 2015-04-27 23:49:24

I actually meant for all OSX, as jhp was asking.

Putting as much configuration outside of if-statements as possible means less edges to the state space; it makes it more likely that everyone can reproduce the same set of bugs.


---

Comment by dimpase created at 2015-04-28 03:35:13

Replying to [comment:18 buck]:
> I actually meant for all OSX, as jhp was asking.
> 
> Putting as much configuration outside of if-statements as possible means less edges to the state space; it makes it more likely that everyone can reproduce the same set of bugs.

indeed, particularly given Apple's non-support of anything older than OSX 10.10, I see the point; it could also happen that they eventually push the same broken llvm version into XCode for older OSX versions...


---

Comment by buck created at 2015-05-02 14:46:39

New commits:


---

Comment by buck created at 2015-05-02 14:46:39

Changing status from new to needs_review.


---

Comment by dimpase created at 2015-05-02 16:27:40

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2015-05-02 16:27:40

LGTM


---

Comment by vbraun created at 2015-05-02 19:28:30

Resolution: fixed
