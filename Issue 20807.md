# Issue 20807: wrong cross-referencing in modindex of documentation

archive/issues_020807.json:
```json
{
    "body": "CC:  paulmasson embray jdemeyer hivert egourgoulhon slelievre\n\nThe Sphinx-generated documentation has index files for modules. E.g. looking at http://doc.sagemath.org/html/en/a_tour_of_sage/py-modindex.html\n\nChecking upon the first link in this list, it points to a non-existing page. It seems like as if sphinx doesn't correctly cross link to a sibling. I.e. instead of `/html/en/a_tour_of_sage/...`\n\nhttp://doc.sagemath.org/html/en/a_tour_of_sage/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb\n\nit should be `/html/en/reference/...`\n\nhttp://doc.sagemath.org/html/en/reference/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb\n\nIssue created by migration from https://trac.sagemath.org/ticket/21044\n\n",
    "created_at": "2016-07-18T08:31:55Z",
    "labels": [
        "documentation",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "wrong cross-referencing in modindex of documentation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20807",
    "user": "schilly"
}
```
CC:  paulmasson embray jdemeyer hivert egourgoulhon slelievre

The Sphinx-generated documentation has index files for modules. E.g. looking at http://doc.sagemath.org/html/en/a_tour_of_sage/py-modindex.html

Checking upon the first link in this list, it points to a non-existing page. It seems like as if sphinx doesn't correctly cross link to a sibling. I.e. instead of `/html/en/a_tour_of_sage/...`

http://doc.sagemath.org/html/en/a_tour_of_sage/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb

it should be `/html/en/reference/...`

http://doc.sagemath.org/html/en/reference/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb

Issue created by migration from https://trac.sagemath.org/ticket/21044





---

archive/issue_comments_287465.json:
```json
{
    "body": "As I found [on the mailing list](https://groups.google.com/d/msg/sage-devel/3nl4vQWgWog/qI562OupBAAJ), I encountered this problem in the doctests, with an incorrect link being generated for `sage.rings.padics.tutorial`.\n\nThis behavior can be explained in part by [this comment](https://github.com/sphinx-doc/sphinx/blob/211fd352ae80f5c901b5c539a7c86348e8941094/sphinx/ext/intersphinx.py#L315) in the `sphinx.ext.intersphinx` source:\n\n\n```\n        # Duplicate values in different inventories will shadow each\n        # other; which one will override which can vary between builds\n        # since they are specified using an unordered dict.  To make\n        # it more consistent, we sort the named inventories and then\n        # add the unnamed inventories last.  This means that the\n        # unnamed inventories will shadow the named ones but the named\n        # ones can still be accessed when the name is specified.\n```\n\n\nIn my specific case, entries for `sage.rings.padics.tutorial` are showing up in the `objects.inv` for each of \n\n\n```\n/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plotting\n/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/padics\n/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plot3d\t\n```\n\n\nSince these are stored as keys in a dict the order can nondeterministic.  In my case `plot3d` ends up being last.\n\nWhat's still mysterious is why `sage.rings.padics.tutorials` would even have reference in the plotting or plot3d docs' objects.inv.  Neither of those documents even reference it.",
    "created_at": "2016-07-27T08:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287465",
    "user": "embray"
}
```

As I found [on the mailing list](https://groups.google.com/d/msg/sage-devel/3nl4vQWgWog/qI562OupBAAJ), I encountered this problem in the doctests, with an incorrect link being generated for `sage.rings.padics.tutorial`.

This behavior can be explained in part by [this comment](https://github.com/sphinx-doc/sphinx/blob/211fd352ae80f5c901b5c539a7c86348e8941094/sphinx/ext/intersphinx.py#L315) in the `sphinx.ext.intersphinx` source:


```
        # Duplicate values in different inventories will shadow each
        # other; which one will override which can vary between builds
        # since they are specified using an unordered dict.  To make
        # it more consistent, we sort the named inventories and then
        # add the unnamed inventories last.  This means that the
        # unnamed inventories will shadow the named ones but the named
        # ones can still be accessed when the name is specified.
```


In my specific case, entries for `sage.rings.padics.tutorial` are showing up in the `objects.inv` for each of 


```
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plotting
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/padics
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plot3d	
```


Since these are stored as keys in a dict the order can nondeterministic.  In my case `plot3d` ends up being last.

What's still mysterious is why `sage.rings.padics.tutorials` would even have reference in the plotting or plot3d docs' objects.inv.  Neither of those documents even reference it.



---

archive/issue_comments_287466.json:
```json
{
    "body": "Incidentally when I run my serial docs build, `plot3d` and `plotting` are built immediately after `padics`.\n\nIf I understand the build system right, however, each sub-document should be built in its own sphinx environment.  Yet it seems as if there's some \"leaking\" between the environments during the initial pass, and this shouldn't happen.",
    "created_at": "2016-07-27T11:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287466",
    "user": "embray"
}
```

Incidentally when I run my serial docs build, `plot3d` and `plotting` are built immediately after `padics`.

If I understand the build system right, however, each sub-document should be built in its own sphinx environment.  Yet it seems as if there's some "leaking" between the environments during the initial pass, and this shouldn't happen.



---

archive/issue_comments_287467.json:
```json
{
    "body": "> \"leaking\" between the environments ...\n\noh, good point! that could explain why those wrong links show up at all. my wild guess: sphinx generates \"temporary\" files to cache some data-structures. on the next pass, sphinx doesn't clean up but somehow loads and reuses these caches. Maybe it's already enough to use `find -cmin -5` or so to check recently modified files to pinpoint if/where such suspicious cache files are?",
    "created_at": "2016-07-27T12:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287467",
    "user": "schilly"
}
```

> "leaking" between the environments ...

oh, good point! that could explain why those wrong links show up at all. my wild guess: sphinx generates "temporary" files to cache some data-structures. on the next pass, sphinx doesn't clean up but somehow loads and reuses these caches. Maybe it's already enough to use `find -cmin -5` or so to check recently modified files to pinpoint if/where such suspicious cache files are?



---

archive/issue_comments_287468.json:
```json
{
    "body": "It's also resulting in huge `objects.inv` inventories for relatively small documents, because all these labels and references are being carried from one environment to the next.  \n\nIt could also be the reason for some other issues I've had (for which it seems I haven't posted a ticket) with duplicate labels between some documents.  The duplicate labels really shouldn't matter as long as they're not within the same document.",
    "created_at": "2016-07-28T08:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287468",
    "user": "embray"
}
```

It's also resulting in huge `objects.inv` inventories for relatively small documents, because all these labels and references are being carried from one environment to the next.  

It could also be the reason for some other issues I've had (for which it seems I haven't posted a ticket) with duplicate labels between some documents.  The duplicate labels really shouldn't matter as long as they're not within the same document.



---

archive/issue_comments_287469.json:
```json
{
    "body": "Ah, I've found it.  This is a bug in Sphinx.  A nasty case of \"`dict.copy()` is a *shallow* copy\"...",
    "created_at": "2016-07-28T09:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287469",
    "user": "embray"
}
```

Ah, I've found it.  This is a bug in Sphinx.  A nasty case of "`dict.copy()` is a *shallow* copy"...



---

archive/issue_comments_287470.json:
```json
{
    "body": "Reported upstream: https://github.com/sphinx-doc/sphinx/pull/2816\n\nI have a fix in the sage end (via monkey patching) that I'm testing now.",
    "created_at": "2016-07-28T09:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287470",
    "user": "embray"
}
```

Reported upstream: https://github.com/sphinx-doc/sphinx/pull/2816

I have a fix in the sage end (via monkey patching) that I'm testing now.



---

archive/issue_comments_287471.json:
```json
{
    "body": "Here's a workaround for this bug in the meantime.  It's ugly, but that's to be expected.  I've had this patch in my working branch for some time now and it has been well-tested.\n----\nNew commits:",
    "created_at": "2016-08-19T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287471",
    "user": "embray"
}
```

Here's a workaround for this bug in the meantime.  It's ugly, but that's to be expected.  I've had this patch in my working branch for some time now and it has been well-tested.
----
New commits:



---

archive/issue_comments_287472.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-19T10:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287472",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_287473.json:
```json
{
    "body": "Also a nice side-effect is that it results in smaller `objects.inv` files, which were previously *full* of unnecessary duplicates.",
    "created_at": "2016-08-19T10:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287473",
    "user": "embray"
}
```

Also a nice side-effect is that it results in smaller `objects.inv` files, which were previously *full* of unnecessary duplicates.



---

archive/issue_comments_287474.json:
```json
{
    "body": "The fix will be upstream in Sphinx 1.4.6, though that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.",
    "created_at": "2016-08-24T09:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287474",
    "user": "embray"
}
```

The fix will be upstream in Sphinx 1.4.6, though that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.



---

archive/issue_comments_287475.json:
```json
{
    "body": "After building Sage and the documentation with this branch, I randomly tested links in `py-modindex.html` files and didn't find any bad links. Needless to say, there is now no such file in either `html/en/a_tour_of_sage` as reported above, or in `html/en/thematic_tutorials` as currently appears in Google's webmaster tools.\n\nI don't know enough about this part of Sage to comment on whether this is the best way to fix the problem, but it certainly does appear to deal with the issue. This should really get into 7.4 so that the next version of the documentation will look better to Google. What else needs to be tested for that to happen?",
    "created_at": "2016-09-22T01:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287475",
    "user": "paulmasson"
}
```

After building Sage and the documentation with this branch, I randomly tested links in `py-modindex.html` files and didn't find any bad links. Needless to say, there is now no such file in either `html/en/a_tour_of_sage` as reported above, or in `html/en/thematic_tutorials` as currently appears in Google's webmaster tools.

I don't know enough about this part of Sage to comment on whether this is the best way to fix the problem, but it certainly does appear to deal with the issue. This should really get into 7.4 so that the next version of the documentation will look better to Google. What else needs to be tested for that to happen?



---

archive/issue_comments_287476.json:
```json
{
    "body": "In addition to fixing the specific issue in the ticket description, this fixes many other problems with building the docs in a single process that arose due to labels being shared between documents, resulting in \"duplicate label\" errors and similar.",
    "created_at": "2016-09-22T16:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287476",
    "user": "embray"
}
```

In addition to fixing the specific issue in the ticket description, this fixes many other problems with building the docs in a single process that arose due to labels being shared between documents, resulting in "duplicate label" errors and similar.



---

archive/issue_comments_287477.json:
```json
{
    "body": "If there are no objections from other potential reviewers, setting this to positive review.",
    "created_at": "2016-09-23T19:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287477",
    "user": "paulmasson"
}
```

If there are no objections from other potential reviewers, setting this to positive review.



---

archive/issue_comments_287478.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-23T19:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287478",
    "user": "paulmasson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_287479.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-03T17:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287479",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_287480.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.\n\nWhy not? Did you actually try it?",
    "created_at": "2016-10-18T14:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287480",
    "user": "jdemeyer"
}
```

Replying to [comment:12 embray]:
> that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.

Why not? Did you actually try it?



---

archive/issue_comments_287481.json:
```json
{
    "body": "I don't know why I wrote that 3 months ago.  Last I recall I wasn't sure who was working on what w.r.t. Sphinx support or what the progress was on that.",
    "created_at": "2016-11-07T11:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287481",
    "user": "embray"
}
```

I don't know why I wrote that 3 months ago.  Last I recall I wasn't sure who was working on what w.r.t. Sphinx support or what the progress was on that.



---

archive/issue_comments_287482.json:
```json
{
    "body": "Note: I will revert this in #22252.",
    "created_at": "2017-03-10T10:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287482",
    "user": "jdemeyer"
}
```

Note: I will revert this in #22252.



---

archive/issue_comments_287483.json:
```json
{
    "body": "Sounds good--thanks!",
    "created_at": "2017-03-14T15:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20807#issuecomment-287483",
    "user": "embray"
}
```

Sounds good--thanks!
