# Issue 20807: wrong cross-referencing in modindex of documentation

Issue created by migration from https://trac.sagemath.org/ticket/21044

Original creator: schilly

Original creation time: 2016-07-18 08:31:55

CC:  paulmasson embray jdemeyer hivert egourgoulhon slelievre

The Sphinx-generated documentation has index files for modules. E.g. looking at http://doc.sagemath.org/html/en/a_tour_of_sage/py-modindex.html

Checking upon the first link in this list, it points to a non-existing page. It seems like as if sphinx doesn't correctly cross link to a sibling. I.e. instead of `/html/en/a_tour_of_sage/...`

http://doc.sagemath.org/html/en/a_tour_of_sage/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb

it should be `/html/en/reference/...`

http://doc.sagemath.org/html/en/reference/algebras/sage/algebras/affine_nil_temperley_lieb.html#module-sage.algebras.affine_nil_temperley_lieb


---

Comment by embray created at 2016-07-27 08:01:08

As I found [on the mailing list](https://groups.google.com/d/msg/sage-devel/3nl4vQWgWog/qI562OupBAAJ), I encountered this problem in the doctests, with an incorrect link being generated for `sage.rings.padics.tutorial`.

This behavior can be explained in part by [this comment](https://github.com/sphinx-doc/sphinx/blob/211fd352ae80f5c901b5c539a7c86348e8941094/sphinx/ext/intersphinx.py#L315) in the `sphinx.ext.intersphinx` source:


```
        # Duplicate values in different inventories will shadow each
        # other; which one will override which can vary between builds
        # since they are specified using an unordered dict.  To make
        # it more consistent, we sort the named inventories and then
        # add the unnamed inventories last.  This means that the
        # unnamed inventories will shadow the named ones but the named
        # ones can still be accessed when the name is specified.
```


In my specific case, entries for `sage.rings.padics.tutorial` are showing up in the `objects.inv` for each of 


```
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plotting
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/padics
/home/embray/src/sagemath/sage-cygwin/local/share/doc/sage/html/en/reference/plot3d	
```


Since these are stored as keys in a dict the order can nondeterministic.  In my case `plot3d` ends up being last.

What's still mysterious is why `sage.rings.padics.tutorials` would even have reference in the plotting or plot3d docs' objects.inv.  Neither of those documents even reference it.


---

Comment by embray created at 2016-07-27 11:54:45

Incidentally when I run my serial docs build, `plot3d` and `plotting` are built immediately after `padics`.

If I understand the build system right, however, each sub-document should be built in its own sphinx environment.  Yet it seems as if there's some "leaking" between the environments during the initial pass, and this shouldn't happen.


---

Comment by schilly created at 2016-07-27 12:29:51

> "leaking" between the environments ...

oh, good point! that could explain why those wrong links show up at all. my wild guess: sphinx generates "temporary" files to cache some data-structures. on the next pass, sphinx doesn't clean up but somehow loads and reuses these caches. Maybe it's already enough to use `find -cmin -5` or so to check recently modified files to pinpoint if/where such suspicious cache files are?


---

Comment by embray created at 2016-07-28 08:41:55

It's also resulting in huge `objects.inv` inventories for relatively small documents, because all these labels and references are being carried from one environment to the next.  

It could also be the reason for some other issues I've had (for which it seems I haven't posted a ticket) with duplicate labels between some documents.  The duplicate labels really shouldn't matter as long as they're not within the same document.


---

Comment by embray created at 2016-07-28 09:36:45

Ah, I've found it.  This is a bug in Sphinx.  A nasty case of "`dict.copy()` is a _shallow_ copy"...


---

Comment by embray created at 2016-07-28 09:57:43

Reported upstream: https://github.com/sphinx-doc/sphinx/pull/2816

I have a fix in the sage end (via monkey patching) that I'm testing now.


---

Comment by embray created at 2016-08-19 10:25:09

Here's a workaround for this bug in the meantime.  It's ugly, but that's to be expected.  I've had this patch in my working branch for some time now and it has been well-tested.
----
New commits:


---

Comment by embray created at 2016-08-19 10:25:09

Changing status from new to needs_review.


---

Comment by embray created at 2016-08-19 10:26:00

Also a nice side-effect is that it results in smaller `objects.inv` files, which were previously _full_ of unnecessary duplicates.


---

Comment by embray created at 2016-08-24 09:11:00

The fix will be upstream in Sphinx 1.4.6, though that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.


---

Comment by paulmasson created at 2016-09-22 01:22:03

After building Sage and the documentation with this branch, I randomly tested links in `py-modindex.html` files and didn't find any bad links. Needless to say, there is now no such file in either `html/en/a_tour_of_sage` as reported above, or in `html/en/thematic_tutorials` as currently appears in Google's webmaster tools.

I don't know enough about this part of Sage to comment on whether this is the best way to fix the problem, but it certainly does appear to deal with the issue. This should really get into 7.4 so that the next version of the documentation will look better to Google. What else needs to be tested for that to happen?


---

Comment by embray created at 2016-09-22 16:27:52

In addition to fixing the specific issue in the ticket description, this fixes many other problems with building the docs in a single process that arose due to labels being shared between documents, resulting in "duplicate label" errors and similar.


---

Comment by paulmasson created at 2016-09-23 19:23:15

If there are no objections from other potential reviewers, setting this to positive review.


---

Comment by paulmasson created at 2016-09-23 19:23:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-03 17:42:04

Resolution: fixed


---

Comment by jdemeyer created at 2016-10-18 14:54:59

Replying to [comment:12 embray]:
> that doesn't do us any immediate good since we're a ways from being able to upgrade Sphinx IIUC.

Why not? Did you actually try it?


---

Comment by embray created at 2016-11-07 11:14:36

I don't know why I wrote that 3 months ago.  Last I recall I wasn't sure who was working on what w.r.t. Sphinx support or what the progress was on that.


---

Comment by jdemeyer created at 2017-03-10 10:50:24

Note: I will revert this in #22252.


---

Comment by embray created at 2017-03-14 15:02:20

Sounds good--thanks!
