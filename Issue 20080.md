# Issue 20080: bug in Permutations_msetk cardinality

Issue created by migration from https://trac.sagemath.org/ticket/20317

Original creator: vdelecroix

Original creation time: 2016-03-29 13:55:06

CC:  tscrim vdelecroix vklein

Keywords: bug


```
sage: P = Permutations([1,1,1,2,2,2,3,3,3], 3)
sage: P.cardinality()
1680
sage: _ = P.list()
sage: P.cardinality()
27
```


See the original report on [this sage-support thread](https://groups.google.com/forum/#!topic/sage-support/rowWX-_gzFo)


---

Comment by tscrim created at 2016-03-29 15:51:50

This seems to be a problem of it inheriting the `cardinality` from `Permutations_mset`. The simple fix is to just have

```python
def cardinality(self):
    return len(self.list())
```

Or does anyone know of a easy-ish formula?


---

Comment by vdelecroix created at 2016-03-29 15:55:45

Replying to [comment:1 tscrim]:
> This seems to be a problem of it inheriting the `cardinality` from `Permutations_mset`.

It is.

> The simple fix is to just have
> {{{#!python
> def cardinality(self):
>     return len(self.list())
> }}}
> Or does anyone know of a easy-ish formula?

I don't understand why there are two classes at all. `Permutations_mset(ms)` is a shortcut for `Permutations_msetk(ms, len(ms))`.


---

Comment by tscrim created at 2016-03-29 16:02:51

Replying to [comment:2 vdelecroix]:
> I don't understand why there are two classes at all. `Permutations_mset(ms)` is a shortcut for `Permutations_msetk(ms, len(ms))`.

I don't see anything like that in the code. Or do you mean there should be? I think there should be 2 classes, as the general `Permutations_mset` can have faster iteration, a dedicated `cardinality` method, and easier/faster containment checking. Although I am thinking the better approach would be to have a common ABC for `P_mset` and `P_msetk` as basically every method of the former is overwritten by the latter.


---

Comment by vdelecroix created at 2016-03-29 16:10:03

Replying to [comment:3 tscrim]:
> Replying to [comment:2 vdelecroix]:
> > I don't understand why there are two classes at all. `Permutations_mset(ms)` is a shortcut for `Permutations_msetk(ms, len(ms))`.
> 
> I don't see anything like that in the code.

Me neither. Replace shortcut by "the same mathematical set".

On the other hand `P_msetk` is a union of `P_mset` over the submultiset of fixed size.

> Or do you mean there should be? I think there should be 2 classes, as the general `Permutations_mset` can have faster iteration, a dedicated `cardinality` method, and easier/faster containment checking. Although I am thinking the better approach would be to have a common ABC for `P_mset` and `P_msetk` as basically every method of the former is overwritten by the latter.

Adding a third class to "simplify" the inheritance!?

The `_k` suffix in the name of classes is very confusing:
- `Subsets_s(s)` is the union of the `Subsets_sk(s, k)`
- `Permutations_n(n)` is the same thing as `Permutations_nk(n, n)`


---

Comment by chapoton created at 2020-05-18 12:29:05

Here is a bugfix, plus using libgap instead of gap
----
New commits:


---

Comment by chapoton created at 2020-05-18 12:29:05

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-05-18 12:48:57

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-05-18 12:48:57

I think this will work for now. Thanks.


---

Comment by mantepse created at 2020-05-18 13:09:25

I shouldn't be doing this...

(and I am guessing that the part to obtain the multiplicities, which I stole from `Permutations_mset.cardinality` is not ideal)


```
def cardinality(self):
    """
    
    EXAMPLES::

        sage: M = [randint(1, 4) for k in range(20)]
        sage: P = Permutations(M, 5)
        sage: len(list(P)) == c(P)
        True
    """
    lmset = list(self.mset)
    mset_list = [lmset.index(x) for x in lmset]
    d = {}
    for i in mset_list:
        d[i] = d.get(i, 0) + 1

    M = list(d.values())
    s = 0
    for m in IntegerVectors(self._k, len(M), outer=M):
        s += multinomial(m)
    return s
```



---

Comment by vbraun created at 2020-05-26 21:49:50

Resolution: fixed
