# Issue 30112: Downgrade broken optional packages to experimental for Sage 9.2

archive/issues_030112.json:
```json
{
    "body": "CC:  jhpalmieri dimpase slelievre simonking\n\nsee:\n- #29900 Meta-ticket: Fix optional and experimental packages for Sage 9.2\n\nIssue created by migration from https://trac.sagemath.org/ticket/30349\n\n",
    "created_at": "2020-08-13T14:48:19Z",
    "labels": [
        "packages: optional",
        "critical",
        "bug"
    ],
    "title": "Downgrade broken optional packages to experimental for Sage 9.2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30112",
    "user": "mkoeppe"
}
```
CC:  jhpalmieri dimpase slelievre simonking

see:
- #29900 Meta-ticket: Fix optional and experimental packages for Sage 9.2

Issue created by migration from https://trac.sagemath.org/ticket/30349





---

archive/issue_comments_428145.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-09-03T02:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428145",
    "user": "mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_428146.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2020-09-08T07:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428146",
    "user": "vbraun"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_428147.json:
```json
{
    "body": "I'd say a broken optional package is by definition not a blocker...",
    "created_at": "2020-09-08T07:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428147",
    "user": "vbraun"
}
```

I'd say a broken optional package is by definition not a blocker...



---

archive/issue_comments_428148.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-09-09T15:35:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428148",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_428149.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-15T03:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428149",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_428150.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-10-15T03:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428150",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_428151.json:
```json
{
    "body": "Simon, what is the current status of your package?",
    "created_at": "2020-10-15T08:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428151",
    "user": "dimpase"
}
```

Simon, what is the current status of your package?



---

archive/issue_comments_428152.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> Simon, what is the current status of your package?\n\nI thought that it works. As far as I recall, when I last checked, it did.\n\nAnyway, I plan to give a talk on the package during the next SageDays, so, I am motivated to fix it. Can you tell me what problems arose?",
    "created_at": "2020-10-15T08:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428152",
    "user": "SimonKing"
}
```

Replying to [comment:7 dimpase]:
> Simon, what is the current status of your package?

I thought that it works. As far as I recall, when I last checked, it did.

Anyway, I plan to give a talk on the package during the next SageDays, so, I am motivated to fix it. Can you tell me what problems arose?



---

archive/issue_comments_428153.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n> Replying to [comment:7 dimpase]:\n> > Simon, what is the current status of your package?\n> \n> I thought that it works. As far as I recall, when I last checked, it did.\n> \n> Anyway, I plan to give a talk on the package during the next SageDays, so, I am motivated to fix it. Can you tell me what problems arose?\n\nPS: By \"my package\", I refer to p_group_cohomology. There is \"my other package\", namely SharedMeatAxe, which is supposed to work and has recently also been fixed on cygwin (see #29152",
    "created_at": "2020-10-15T08:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428153",
    "user": "SimonKing"
}
```

Replying to [comment:8 SimonKing]:
> Replying to [comment:7 dimpase]:
> > Simon, what is the current status of your package?
> 
> I thought that it works. As far as I recall, when I last checked, it did.
> 
> Anyway, I plan to give a talk on the package during the next SageDays, so, I am motivated to fix it. Can you tell me what problems arose?

PS: By "my package", I refer to p_group_cohomology. There is "my other package", namely SharedMeatAxe, which is supposed to work and has recently also been fixed on cygwin (see #29152



---

archive/issue_comments_428154.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-10-15T11:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428154",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_428155.json:
```json
{
    "body": "Here are results of a local run, with 9.2.beta14 - that's newer than this ticket, but a bit older than the current rc - they match errors seen in the logs in the ticket description.\nThey appear to be a result of GAP files installed in a weird place, namely:\n\n`$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n\nrather than `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`. So I see\n\n```\nsage -t --random-seed=0 src/sage/tests/modular_group_cohomology.py\n**********************************************************************\nFile \"src/sage/tests/modular_group_cohomology.py\", line 10, in sage.tests.modular_group_cohomology\nFailed example:\n    from pGroupCohomology import CohomologyRing   # optional - p_group_cohomology\nException raised:\n    Traceback (most recent call last):\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py\", line 720, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py\", line 1145, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.modular_group_cohomology[0]>\", line 1, in <module>\n        from pGroupCohomology import CohomologyRing   # optional - p_group_cohomology\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/__init__.py\", line 2466, in <module>\n        from pGroupCohomology.factory import CohomologyRing\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/factory.py\", line 43, in <module>\n        from pGroupCohomology.auxiliaries import coho_options, coho_logger, safe_save, _gap_reset_random_seed, gap, singular, Failure\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/auxiliaries.py\", line 411, in <module>\n        gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))\n      File \"sage/libs/gap/element.pyx\", line 2525, in sage.libs.gap.element.GapElement_Function.__call__ (build/cythonized/sage/libs/gap/element.c:19780)\n        sig_on()\n    sage.libs.gap.util.GAPError: Error, file \"/home/scratch2/dimpase/sage/sage/local/share/sage/ext/gap/modular_cohomology/GapMaxels.g\" must exist and be readable\n```\n\n\n(and more failing tests due to this, as you imagine)\nSo the package looks for its GAP files in `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n\nPerhaps Matthias knows the reason for this.",
    "created_at": "2020-10-15T11:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428155",
    "user": "dimpase"
}
```

Here are results of a local run, with 9.2.beta14 - that's newer than this ticket, but a bit older than the current rc - they match errors seen in the logs in the ticket description.
They appear to be a result of GAP files installed in a weird place, namely:

`$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`

rather than `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`. So I see

```
sage -t --random-seed=0 src/sage/tests/modular_group_cohomology.py
**********************************************************************
File "src/sage/tests/modular_group_cohomology.py", line 10, in sage.tests.modular_group_cohomology
Failed example:
    from pGroupCohomology import CohomologyRing   # optional - p_group_cohomology
Exception raised:
    Traceback (most recent call last):
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.modular_group_cohomology[0]>", line 1, in <module>
        from pGroupCohomology import CohomologyRing   # optional - p_group_cohomology
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/__init__.py", line 2466, in <module>
        from pGroupCohomology.factory import CohomologyRing
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/factory.py", line 43, in <module>
        from pGroupCohomology.auxiliaries import coho_options, coho_logger, safe_save, _gap_reset_random_seed, gap, singular, Failure
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/pGroupCohomology/auxiliaries.py", line 411, in <module>
        gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))
      File "sage/libs/gap/element.pyx", line 2525, in sage.libs.gap.element.GapElement_Function.__call__ (build/cythonized/sage/libs/gap/element.c:19780)
        sig_on()
    sage.libs.gap.util.GAPError: Error, file "/home/scratch2/dimpase/sage/sage/local/share/sage/ext/gap/modular_cohomology/GapMaxels.g" must exist and be readable
```


(and more failing tests due to this, as you imagine)
So the package looks for its GAP files in `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`

Perhaps Matthias knows the reason for this.



---

archive/issue_comments_428156.json:
```json
{
    "body": "It might be due to the packages now being built using Python wheels, and everything in the package goes to the `site-packages/` of the Python, rather than to the local GAP.",
    "created_at": "2020-10-15T11:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428156",
    "user": "dimpase"
}
```

It might be due to the packages now being built using Python wheels, and everything in the package goes to the `site-packages/` of the Python, rather than to the local GAP.



---

archive/issue_comments_428157.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> It might be due to the packages now being built using Python wheels, and everything in the package goes to the `site-packages/` of the Python, rather than to the local GAP.\n\nProbably.\n\nSo, tell me: is there an environment variable or a Sage variable that provides the location of GAP's package data?\n\nSince this is an actual bug: Should it be fixed here (although this ticket is about downgrading several packages rather then fixing them) or on a new ticket?",
    "created_at": "2020-10-15T12:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428157",
    "user": "SimonKing"
}
```

Replying to [comment:11 dimpase]:
> It might be due to the packages now being built using Python wheels, and everything in the package goes to the `site-packages/` of the Python, rather than to the local GAP.

Probably.

So, tell me: is there an environment variable or a Sage variable that provides the location of GAP's package data?

Since this is an actual bug: Should it be fixed here (although this ticket is about downgrading several packages rather then fixing them) or on a new ticket?



---

archive/issue_comments_428158.json:
```json
{
    "body": "Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.",
    "created_at": "2020-10-15T12:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428158",
    "user": "SimonKing"
}
```

Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.



---

archive/issue_comments_428159.json:
```json
{
    "body": "PS:\n\nReplying to [comment:10 dimpase]:\n> They appear to be a result of GAP files installed in a weird place, namely:\n> \n> `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n\nIt is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,\"sage\",\"ext\",\"gap\",\"modular_cohomology\")`)\n\nSo, if I understand correctly what the error says, GAP does indeed try to find the GAP code in that folder, and the real question is why the code hasn't been installed there during package installation.",
    "created_at": "2020-10-15T12:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428159",
    "user": "SimonKing"
}
```

PS:

Replying to [comment:10 dimpase]:
> They appear to be a result of GAP files installed in a weird place, namely:
> 
> `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`

It is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")`)

So, if I understand correctly what the error says, GAP does indeed try to find the GAP code in that folder, and the real question is why the code hasn't been installed there during package installation.



---

archive/issue_comments_428160.json:
```json
{
    "body": "Replying to [comment:14 SimonKing]:\n> Replying to [comment:10 dimpase]:\n> > They appear to be a result of GAP files installed in a weird place, namely:\n> > \n> > `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n> \n> It is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,\"sage\",\"ext\",\"gap\",\"modular_cohomology\")`)\n\nI stand corrected: There are some places in the file auxiliaries.py, something like `gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))`. However, `$SAGE_SHARE` used only once in the path.\n\nA clean solution would be to have a Sage or an environment variable giving the location of code of Gap extensions.",
    "created_at": "2020-10-15T13:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428160",
    "user": "SimonKing"
}
```

Replying to [comment:14 SimonKing]:
> Replying to [comment:10 dimpase]:
> > They appear to be a result of GAP files installed in a weird place, namely:
> > 
> > `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`
> 
> It is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")`)

I stand corrected: There are some places in the file auxiliaries.py, something like `gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))`. However, `$SAGE_SHARE` used only once in the path.

A clean solution would be to have a Sage or an environment variable giving the location of code of Gap extensions.



---

archive/issue_comments_428161.json:
```json
{
    "body": "For `p_group_cohomology`, see ticket #28711",
    "created_at": "2020-10-15T16:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428161",
    "user": "mkoeppe"
}
```

For `p_group_cohomology`, see ticket #28711



---

archive/issue_comments_428162.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> For `p_group_cohomology`, see ticket #28711\n\nOK, I'll post fixes there.",
    "created_at": "2020-10-15T16:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428162",
    "user": "SimonKing"
}
```

Replying to [comment:16 mkoeppe]:
> For `p_group_cohomology`, see ticket #28711

OK, I'll post fixes there.



---

archive/issue_comments_428163.json:
```json
{
    "body": "Replying to [comment:15 SimonKing]:\n> Replying to [comment:14 SimonKing]:\n> > Replying to [comment:10 dimpase]:\n> > > They appear to be a result of GAP files installed in a weird place, namely:\n> > > \n> > > `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n> > \n> > It is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,\"sage\",\"ext\",\"gap\",\"modular_cohomology\")`)\n> \n> I stand corrected: There are some places in the file auxiliaries.py, something like `gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))`. However, `$SAGE_SHARE` used only once in the path.\n> \n> A clean solution would be to have a Sage or an environment variable giving the location of code of Gap extensions.\n\nYou can call GAP and examine `GAPInfo.RootPaths`. When looking for a package, GAP appends `pkg/` to each directory in this list, cf. `9.2 GAP Root Directories` in its manual.\n\nIMHO, Python wheels are build to be relocateable, so it's futile to try to install GAP\ndata via setup.py. I'd say, install a GAP package separately, not from `setup.py` from `spkg-install`.  By the way, GAP now has its own package manager. Maybe you can use it (https://github.com/gap-packages/PackageManager) - it's in `gap_packages`, I think.",
    "created_at": "2020-10-15T16:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428163",
    "user": "dimpase"
}
```

Replying to [comment:15 SimonKing]:
> Replying to [comment:14 SimonKing]:
> > Replying to [comment:10 dimpase]:
> > > They appear to be a result of GAP files installed in a weird place, namely:
> > > 
> > > `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`
> > 
> > It is indeed weird that $SAGE_LOCAL appears twice in this path. In the sources, if I see that correctly, this path appears only once, namely setup.py (`data_files=[(os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")`)
> 
> I stand corrected: There are some places in the file auxiliaries.py, something like `gap.Read(os.path.join(SAGE_SHARE,'sage','ext','gap','modular_cohomology','GapMaxels.g'))`. However, `$SAGE_SHARE` used only once in the path.
> 
> A clean solution would be to have a Sage or an environment variable giving the location of code of Gap extensions.

You can call GAP and examine `GAPInfo.RootPaths`. When looking for a package, GAP appends `pkg/` to each directory in this list, cf. `9.2 GAP Root Directories` in its manual.

IMHO, Python wheels are build to be relocateable, so it's futile to try to install GAP
data via setup.py. I'd say, install a GAP package separately, not from `setup.py` from `spkg-install`.  By the way, GAP now has its own package manager. Maybe you can use it (https://github.com/gap-packages/PackageManager) - it's in `gap_packages`, I think.



---

archive/issue_comments_428164.json:
```json
{
    "body": "Replying to [comment:13 SimonKing]:\n> Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.\n\nYes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.",
    "created_at": "2020-10-15T21:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428164",
    "user": "mkoeppe"
}
```

Replying to [comment:13 SimonKing]:
> Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.

Yes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.



---

archive/issue_comments_428165.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> Here are results of a local run, with 9.2.beta14 - that's newer than this ticket, but a bit older than the current rc - they match errors seen in the logs in the ticket description.\n> They appear to be a result of GAP files installed in a weird place, namely:\n> \n> `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`\n> \n> rather than `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`. So I see\n\nNote that apparently `$SAGE_LOCAL/share/sage` is no more, it ceased to exist, it is an ex-folder.",
    "created_at": "2020-10-15T21:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428165",
    "user": "SimonKing"
}
```

Replying to [comment:10 dimpase]:
> Here are results of a local run, with 9.2.beta14 - that's newer than this ticket, but a bit older than the current rc - they match errors seen in the logs in the ticket description.
> They appear to be a result of GAP files installed in a weird place, namely:
> 
> `$SAGE_LOCAL/lib/python3.7/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`
> 
> rather than `$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology/`. So I see

Note that apparently `$SAGE_LOCAL/share/sage` is no more, it ceased to exist, it is an ex-folder.



---

archive/issue_comments_428166.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> Replying to [comment:13 SimonKing]:\n> > Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.\n> \n> Yes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.\n\nCan you elaborate? At some point in the past, I suggested to change the p_group_cohomology spkg as follows:\n\n- Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.\n- Its .c files should remain an spkg, that also is the dependency of the optional extension modules.\n- I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology\n\nDo you suggest this, or something else?\n\nIt used to be a problem that the documentation of the optional Cython modules would not be built. Is there a way around?\n\nEDIT: Is it possible to advise Sage's test suite to only run the tests of a particular file if a certain optional package is installed? Or is it still only possible for individual tests? I'd find it extremely awkward to mark each individual doctest as `# optional: p_group_cohomology`.",
    "created_at": "2020-10-15T21:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428166",
    "user": "SimonKing"
}
```

Replying to [comment:19 mkoeppe]:
> Replying to [comment:13 SimonKing]:
> > Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.
> 
> Yes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.

Can you elaborate? At some point in the past, I suggested to change the p_group_cohomology spkg as follows:

- Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.
- Its .c files should remain an spkg, that also is the dependency of the optional extension modules.
- I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology

Do you suggest this, or something else?

It used to be a problem that the documentation of the optional Cython modules would not be built. Is there a way around?

EDIT: Is it possible to advise Sage's test suite to only run the tests of a particular file if a certain optional package is installed? Or is it still only possible for individual tests? I'd find it extremely awkward to mark each individual doctest as `# optional: p_group_cohomology`.



---

archive/issue_comments_428167.json:
```json
{
    "body": "Replying to [comment:21 SimonKing]:\n> Replying to [comment:19 mkoeppe]:\n> > Replying to [comment:13 SimonKing]:\n> > > Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.\n> > \n> > Yes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.\n> \n> Can you elaborate? At some point in the past, I suggested to change the p_group_cohomology spkg as follows:\n> \n> - Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.\n\nYes\n\n> - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.\n\nYes, in particular if that C library can also be used outside of Sage...\n\n> - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology\n\nYou could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.\n\nOr, if you want to ship it with sagelib, then (as I commented in #28711) these files should be put alongside the Python modules.  sagelib and other Python packages have no business writing into $SAGE_LOCAL.",
    "created_at": "2020-10-15T22:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428167",
    "user": "mkoeppe"
}
```

Replying to [comment:21 SimonKing]:
> Replying to [comment:19 mkoeppe]:
> > Replying to [comment:13 SimonKing]:
> > > Really unfortunate that the Cython code of p_group_cohomology has not been made optional Cython files in the Sage library, because then it would be easy to fix without upgrading the upstream source ball.
> > 
> > Yes, I would hope that we can make this improvement to the source structure in Sage 9.3. Similar to what has been done in the 9.2 cycle with `giacpy_sage` and `sage_brial`.
> 
> Can you elaborate? At some point in the past, I suggested to change the p_group_cohomology spkg as follows:
> 
> - Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.

Yes

> - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.

Yes, in particular if that C library can also be used outside of Sage...

> - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology

You could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.

Or, if you want to ship it with sagelib, then (as I commented in #28711) these files should be put alongside the Python modules.  sagelib and other Python packages have no business writing into $SAGE_LOCAL.



---

archive/issue_comments_428168.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> > - Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.\n> \n> Yes\n\nOK, that was what I have suggested in the past, but what was refused by other developers.\n\nCrucial point, from my point of view: Documentation and doc tests, as explained in my other posts. Are these problems of optional extension modules solved?\n\n> > - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.\n> \n> Yes, in particular if that C library can also be used outside of Sage...\n\nHow do you define \"can\"? David Green, the original author of the c-code (that originally hasn't even been a library but only a couple of executables) has used them via command line, but I think he is the only one who ever did.\n\nI'd say: I do not intend to ever publish the c-code outside of the Sage ecosystem.\n\n> > - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology\n> \n> You could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.\n\nThat's what is currently happening.\n\n> Or, if you want to ship it with sagelib, \n\nI don't.\n\n> then (as I commented in #28711) these files should be put alongside the Python modules.  sagelib and other Python packages have no business writing into $SAGE_LOCAL.",
    "created_at": "2020-10-15T22:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428168",
    "user": "SimonKing"
}
```

Replying to [comment:22 mkoeppe]:
> > - Its Python and Cython code should go into the Sage library, the Cython files being optional extension modules.
> 
> Yes

OK, that was what I have suggested in the past, but what was refused by other developers.

Crucial point, from my point of view: Documentation and doc tests, as explained in my other posts. Are these problems of optional extension modules solved?

> > - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.
> 
> Yes, in particular if that C library can also be used outside of Sage...

How do you define "can"? David Green, the original author of the c-code (that originally hasn't even been a library but only a couple of executables) has used them via command line, but I think he is the only one who ever did.

I'd say: I do not intend to ever publish the c-code outside of the Sage ecosystem.

> > - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology
> 
> You could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.

That's what is currently happening.

> Or, if you want to ship it with sagelib, 

I don't.

> then (as I commented in #28711) these files should be put alongside the Python modules.  sagelib and other Python packages have no business writing into $SAGE_LOCAL.



---

archive/issue_comments_428169.json:
```json
{
    "body": "Replying to [comment:23 SimonKing]:\n> Replying to [comment:22 mkoeppe]:\n> > > - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.\n> > \n> > Yes, in particular if that C library can also be used outside of Sage...\n> \n> How do you define \"can\"? David Green, the original author of the c-code (that originally hasn't even been a library but only a couple of executables) has used them via command line, but I think he is the only one who ever did.\n\nThis version of \"can\" is good enough.\n\n> I'd say: I do not intend to ever publish the c-code outside of the Sage ecosystem.\n> \n> > > - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology\n> > \n> > You could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.\n> \n> That's what is currently happening.\n\nAs long as you build this library using standard tools (preferably autotools) instead of Sage-specific scripts, and the C library does not depend on the Sage library, this is all fine.",
    "created_at": "2020-10-16T00:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428169",
    "user": "mkoeppe"
}
```

Replying to [comment:23 SimonKing]:
> Replying to [comment:22 mkoeppe]:
> > > - Its .c files should remain an spkg, that also is the dependency of the optional extension modules.
> > 
> > Yes, in particular if that C library can also be used outside of Sage...
> 
> How do you define "can"? David Green, the original author of the c-code (that originally hasn't even been a library but only a couple of executables) has used them via command line, but I think he is the only one who ever did.

This version of "can" is good enough.

> I'd say: I do not intend to ever publish the c-code outside of the Sage ecosystem.
> 
> > > - I now suggest, as SAGE_LOCAL/share/sage has gone, to keep the .g files in the package, but install them into SAGE_LOCAL/share/p_group_cohomology
> > 
> > You could either ship them with that spkg that provides the C library and then install it in `SAGE_LOCAL/share/p_group_cohomology` (or, more precisely, in the configured install prefix of your C library.
> 
> That's what is currently happening.

As long as you build this library using standard tools (preferably autotools) instead of Sage-specific scripts, and the C library does not depend on the Sage library, this is all fine.



---

archive/issue_comments_428170.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-10-16T01:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428170",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_428171.json:
```json
{
    "body": "In any case, I don't think it's realistic to fix these issues in Sage 9.2.\nSo let's use the present ticket to update the type of these two packages.",
    "created_at": "2020-10-16T01:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428171",
    "user": "mkoeppe"
}
```

In any case, I don't think it's realistic to fix these issues in Sage 9.2.
So let's use the present ticket to update the type of these two packages.



---

archive/issue_comments_428172.json:
```json
{
    "body": "I think a hotfix for p_group_cohomology, to install GAP files into the right place, using SAGE_LOCAL, despite being blasphemy in the Temple of Python, can be done very quickly.\n\nJust add `sdh_install` call to `spkg-install`, which will put them where the package expects.",
    "created_at": "2020-10-16T13:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428172",
    "user": "dimpase"
}
```

I think a hotfix for p_group_cohomology, to install GAP files into the right place, using SAGE_LOCAL, despite being blasphemy in the Temple of Python, can be done very quickly.

Just add `sdh_install` call to `spkg-install`, which will put them where the package expects.



---

archive/issue_comments_428173.json:
```json
{
    "body": "after doing `ln -sf $SAGE_LOCAL/lib/python3.8/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology $SAGE_LOCAL/share/sage/ext/gap/modular_cohomology`\n(if it's python3.X, there should be python3.X there)\n\nGAP files load, but Singular do not load\n\n```\n    sage.interfaces.singular.SingularError: Singular error:\n       ? cannot open dickson.lib\n       ? error occurred in or before STDIN line 15: `LIB \"dickson.lib\";`\n```\n\nSo this is a similar to GAP files problem, only with Singular...",
    "created_at": "2020-10-16T13:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428173",
    "user": "dimpase"
}
```

after doing `ln -sf $SAGE_LOCAL/lib/python3.8/site-packages/$SAGE_LOCAL/share/sage/ext/gap/modular_cohomology $SAGE_LOCAL/share/sage/ext/gap/modular_cohomology`
(if it's python3.X, there should be python3.X there)

GAP files load, but Singular do not load

```
    sage.interfaces.singular.SingularError: Singular error:
       ? cannot open dickson.lib
       ? error occurred in or before STDIN line 15: `LIB "dickson.lib";`
```

So this is a similar to GAP files problem, only with Singular...



---

archive/issue_comments_428174.json:
```json
{
    "body": "Replying to [comment:26 dimpase]:\n> I think a hotfix for p_group_cohomology, to install GAP files into the right place, using SAGE_LOCAL, despite being blasphemy in the Temple of Python, can be done very quickly.\n> \n> Just add `sdh_install` call to `spkg-install`, which will put them where the package expects.\n\nSee my comment 39 at #28711: Apparently Sage prepends the absolute path `os.path.join(SAGE_SHARE,\"sage\",\"ext\",\"gap\",\"modular_cohomology\")` with $SAGE_DESTDIR. Same problem with the Singular LIB.\n\nSo, I guess the real hotfix is to tell me: How should I provide a RELATIVE path in which to install the GAP respectively Singular code? Would it just work to write\n\n```python\n  data_files=[ ( os.path.join( \"share\", \"gap\", \"pkg\", \"modular_cohomology\" ),\n                 [ os.path.join( \"pGroupCohomology\", \"GapMaxels.g\" ),\n                   os.path.join( \"pGroupCohomology\", \"GapMB.g\" ),\n                   os.path.join( \"pGroupCohomology\", \"GapSgs.g\" ) ] ),\n               ( os.path.join( \"share\", \"singular\", \"LIB\" ),\n                 [ os.path.join( \"pGroupCohomology\",\"dickson.lib\" ) ] ) ]\n```\n\n?\n\nEDIT: I'd also need to change the places in `auxiliaries.py`, because currently the install path for the GAP helpers is SAGE_SHARE/sage/ext/gap/modular_cohomology, not SAGE_SHARE/gap/pkg/modular_cohomology. But SAGE_SHARE/sage has gone.",
    "created_at": "2020-10-16T14:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428174",
    "user": "SimonKing"
}
```

Replying to [comment:26 dimpase]:
> I think a hotfix for p_group_cohomology, to install GAP files into the right place, using SAGE_LOCAL, despite being blasphemy in the Temple of Python, can be done very quickly.
> 
> Just add `sdh_install` call to `spkg-install`, which will put them where the package expects.

See my comment 39 at #28711: Apparently Sage prepends the absolute path `os.path.join(SAGE_SHARE,"sage","ext","gap","modular_cohomology")` with $SAGE_DESTDIR. Same problem with the Singular LIB.

So, I guess the real hotfix is to tell me: How should I provide a RELATIVE path in which to install the GAP respectively Singular code? Would it just work to write

```python
  data_files=[ ( os.path.join( "share", "gap", "pkg", "modular_cohomology" ),
                 [ os.path.join( "pGroupCohomology", "GapMaxels.g" ),
                   os.path.join( "pGroupCohomology", "GapMB.g" ),
                   os.path.join( "pGroupCohomology", "GapSgs.g" ) ] ),
               ( os.path.join( "share", "singular", "LIB" ),
                 [ os.path.join( "pGroupCohomology","dickson.lib" ) ] ) ]
```

?

EDIT: I'd also need to change the places in `auxiliaries.py`, because currently the install path for the GAP helpers is SAGE_SHARE/sage/ext/gap/modular_cohomology, not SAGE_SHARE/gap/pkg/modular_cohomology. But SAGE_SHARE/sage has gone.



---

archive/issue_comments_428175.json:
```json
{
    "body": "can we get p_group_cohomology off the branch here?",
    "created_at": "2020-10-20T15:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428175",
    "user": "dimpase"
}
```

can we get p_group_cohomology off the branch here?



---

archive/issue_comments_428176.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-20T16:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428176",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_428177.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-20T16:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428177",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_428178.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-10-20T16:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428178",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_428179.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-20T16:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428179",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_428180.json:
```json
{
    "body": "ok",
    "created_at": "2020-10-20T16:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428180",
    "user": "dimpase"
}
```

ok



---

archive/issue_comments_428181.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-01T00:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30112#issuecomment-428181",
    "user": "vbraun"
}
```

Resolution: fixed
