# Issue 34502: get rif of some usage of "long" python2 type in pyx files

Issue created by migration from https://trac.sagemath.org/ticket/34739

Original creator: chapoton

Original creation time: 2022-11-10 13:23:09

CC:  vbraun




---

Comment by chapoton created at 2022-11-10 13:25:12

Changing status from new to needs_review.


---

Comment by chapoton created at 2022-11-10 13:25:12

New commits:


---

Comment by git created at 2022-11-10 17:25:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-11-10 17:26:26

New commits:


---

Comment by jhpalmieri created at 2022-11-11 03:00:59

Sorry, wrong ticket.


---

Comment by git created at 2022-11-11 07:25:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-11-11 07:30:32

Or this

```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,7 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```

?


---

Comment by dcoudert created at 2022-11-11 09:41:26

This change is not correct in `src/sage/rings/polynomial/plural.pyx`: extra `)`

```diff
+            raise NotImplementedError(f"not able to interpret {element)}"
```



---

Comment by klee created at 2022-11-11 11:19:41


```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,10 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        try:
+            exp = GEx(<long>x)
+        except OverflowError:
+            exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```

fixes the failing doctest, but introduces (or reveals?) a Heisenbug:

```
sage -t --warn-long 64.8 --random-seed=209400216403961693791706262075210533242 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
```



---

Comment by klee created at 2022-11-11 11:28:15

The Heisenbug might not be a bug as Vtilde is a random line bundle. I invited an expert.


---

Comment by klee created at 2022-11-11 14:14:15

The Heisenbug has been tracked in #32773. So the failed doctest is not related with this ticket.


---

Comment by git created at 2022-11-11 16:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-11-11 19:25:34

all lights are green now


---

Comment by klee created at 2022-11-11 23:24:10

Why `GEx(<int>x)` rather than `GEx(<long>x)`? GEx seems to accept C long type. C long is better than C int. No?


---

Comment by git created at 2022-11-12 08:34:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-11-12 11:41:15

ok, done. If I understand correctly `<long>` is not a python type but a C type, right ?


---

Comment by chapoton created at 2022-11-12 12:15:22

green lights again


---

Comment by klee created at 2022-11-12 12:24:36

I looked into pynac code, and became confident that the code I suggested is right. The cython code first tries to make GEx (ginac ex) object holding C long data, then in the case of overflow exception, (eventually) make GEx object holding the original python int object.

Otherwise LGTM.


---

Comment by klee created at 2022-11-12 12:24:36

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-11-12 12:27:07

Replying to [comment:16 Frédéric Chapoton]:
> ok, done. If I understand correctly `<long>` is not a python type but a C type, right?

Right. We are juggling with "python2 int", "python2 long", "python3 int", "C int", "C long" :)


---

Comment by vbraun created at 2022-11-20 12:13:25

Resolution: fixed
