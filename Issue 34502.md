# Issue 34502: get rif of some usage of "long" python2 type in pyx files

archive/issues_034502.json:
```json
{
    "body": "CC:  @vbraun\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34739\n\n",
    "created_at": "2022-11-10T13:23:09Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "get rif of some usage of \"long\" python2 type in pyx files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34502",
    "user": "@fchapoton"
}
```
CC:  @vbraun



Issue created by migration from https://trac.sagemath.org/ticket/34739





---

archive/issue_comments_488487.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-10T13:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488487",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_488488.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-10T13:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488488",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_488489.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-10T17:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488489",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488490.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-10T17:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488490",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_488491.json:
```json
{
    "body": "Sorry, wrong ticket.",
    "created_at": "2022-11-11T03:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488491",
    "user": "@jhpalmieri"
}
```

Sorry, wrong ticket.



---

archive/issue_comments_488492.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-11T07:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488492",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488493.json:
```json
{
    "body": "Or this\n\n```diff\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -13724,7 +13724,7 @@ cpdef new_Expression(parent, x):\n             return NaN\n         exp = x\n     elif isinstance(x, int):\n-        exp = GEx(<long>x)\n+        exp = x\n     elif x is infinity:\n         return new_Expression_from_GEx(parent, g_Infinity)\n     elif x is minus_infinity:\n```\n\n?",
    "created_at": "2022-11-11T07:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488493",
    "user": "@kwankyu"
}
```

Or this

```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,7 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```

?



---

archive/issue_comments_488494.json:
```json
{
    "body": "This change is not correct in `src/sage/rings/polynomial/plural.pyx`: extra `)`\n\n```diff\n+            raise NotImplementedError(f\"not able to interpret {element)}\"\n```\n",
    "created_at": "2022-11-11T09:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488494",
    "user": "@dcoudert"
}
```

This change is not correct in `src/sage/rings/polynomial/plural.pyx`: extra `)`

```diff
+            raise NotImplementedError(f"not able to interpret {element)}"
```




---

archive/issue_comments_488495.json:
```json
{
    "body": "\n```diff\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -13724,7 +13724,10 @@ cpdef new_Expression(parent, x):\n             return NaN\n         exp = x\n     elif isinstance(x, int):\n-        exp = GEx(<long>x)\n+        try:\n+            exp = GEx(<long>x)\n+        except OverflowError:\n+            exp = x\n     elif x is infinity:\n         return new_Expression_from_GEx(parent, g_Infinity)\n     elif x is minus_infinity:\n```\n\nfixes the failing doctest, but introduces (or reveals?) a Heisenbug:\n\n```\nsage -t --warn-long 64.8 --random-seed=209400216403961693791706262075210533242 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n**********************************************************************\n```\n",
    "created_at": "2022-11-11T11:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488495",
    "user": "@kwankyu"
}
```


```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,10 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        try:
+            exp = GEx(<long>x)
+        except OverflowError:
+            exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```

fixes the failing doctest, but introduces (or reveals?) a Heisenbug:

```
sage -t --warn-long 64.8 --random-seed=209400216403961693791706262075210533242 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
```




---

archive/issue_comments_488496.json:
```json
{
    "body": "The Heisenbug might not be a bug as Vtilde is a random line bundle. I invited an expert.",
    "created_at": "2022-11-11T11:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488496",
    "user": "@kwankyu"
}
```

The Heisenbug might not be a bug as Vtilde is a random line bundle. I invited an expert.



---

archive/issue_comments_488497.json:
```json
{
    "body": "The Heisenbug has been tracked in #32773. So the failed doctest is not related with this ticket.",
    "created_at": "2022-11-11T14:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488497",
    "user": "@kwankyu"
}
```

The Heisenbug has been tracked in #32773. So the failed doctest is not related with this ticket.



---

archive/issue_comments_488498.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-11T16:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488498",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488499.json:
```json
{
    "body": "all lights are green now",
    "created_at": "2022-11-11T19:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488499",
    "user": "@fchapoton"
}
```

all lights are green now



---

archive/issue_comments_488500.json:
```json
{
    "body": "Why `GEx(<int>x)` rather than `GEx(<long>x)`? GEx seems to accept C long type. C long is better than C int. No?",
    "created_at": "2022-11-11T23:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488500",
    "user": "@kwankyu"
}
```

Why `GEx(<int>x)` rather than `GEx(<long>x)`? GEx seems to accept C long type. C long is better than C int. No?



---

archive/issue_comments_488501.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-12T08:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488501",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488502.json:
```json
{
    "body": "ok, done. If I understand correctly `<long>` is not a python type but a C type, right ?",
    "created_at": "2022-11-12T11:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488502",
    "user": "@fchapoton"
}
```

ok, done. If I understand correctly `<long>` is not a python type but a C type, right ?



---

archive/issue_comments_488503.json:
```json
{
    "body": "green lights again",
    "created_at": "2022-11-12T12:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488503",
    "user": "@fchapoton"
}
```

green lights again



---

archive/issue_comments_488504.json:
```json
{
    "body": "I looked into pynac code, and became confident that the code I suggested is right. The cython code first tries to make GEx (ginac ex) object holding C long data, then in the case of overflow exception, (eventually) make GEx object holding the original python int object.\n\nOtherwise LGTM.",
    "created_at": "2022-11-12T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488504",
    "user": "@kwankyu"
}
```

I looked into pynac code, and became confident that the code I suggested is right. The cython code first tries to make GEx (ginac ex) object holding C long data, then in the case of overflow exception, (eventually) make GEx object holding the original python int object.

Otherwise LGTM.



---

archive/issue_comments_488505.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-12T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488505",
    "user": "@kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488506.json:
```json
{
    "body": "Replying to [comment:16 Fr\u00e9d\u00e9ric Chapoton]:\n> ok, done. If I understand correctly `<long>` is not a python type but a C type, right?\n\nRight. We are juggling with \"python2 int\", \"python2 long\", \"python3 int\", \"C int\", \"C long\" :)",
    "created_at": "2022-11-12T12:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488506",
    "user": "@kwankyu"
}
```

Replying to [comment:16 Frédéric Chapoton]:
> ok, done. If I understand correctly `<long>` is not a python type but a C type, right?

Right. We are juggling with "python2 int", "python2 long", "python3 int", "C int", "C long" :)



---

archive/issue_comments_488507.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-11-20T12:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-488507",
    "user": "@vbraun"
}
```

Resolution: fixed
