# Issue 34502: get rid of some usage of "long" python2 type in pyx files

archive/issues_034502.json:
```json
{
    "body": "CC:  @vbraun\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34739\n\n",
    "closed_at": "2022-11-20T12:13:25Z",
    "created_at": "2022-11-10T13:23:09Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "get rid of some usage of \"long\" python2 type in pyx files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34502",
    "user": "https://github.com/fchapoton"
}
```
CC:  @vbraun



Issue created by migration from https://trac.sagemath.org/ticket/34739





---

archive/issue_comments_487887.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-10T13:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487887",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_487888.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-10T13:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487888",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_487889.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-10T17:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487890.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-10T17:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487890",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_487891.json:
```json
{
    "body": "Sorry, wrong ticket.",
    "created_at": "2022-11-11T03:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487891",
    "user": "https://github.com/jhpalmieri"
}
```

Sorry, wrong ticket.



---

archive/issue_comments_487892.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-11T07:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487892",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487893.json:
```json
{
    "body": "Or this\n\n```diff\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -13724,7 +13724,7 @@ cpdef new_Expression(parent, x):\n             return NaN\n         exp = x\n     elif isinstance(x, int):\n-        exp = GEx(<long>x)\n+        exp = x\n     elif x is infinity:\n         return new_Expression_from_GEx(parent, g_Infinity)\n     elif x is minus_infinity:\n```\n?",
    "created_at": "2022-11-11T07:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487893",
    "user": "https://github.com/kwankyu"
}
```

Or this

```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,7 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```
?



---

archive/issue_comments_487894.json:
```json
{
    "body": "This change is not correct in `src/sage/rings/polynomial/plural.pyx`: extra `)`\n\n```diff\n+            raise NotImplementedError(f\"not able to interpret {element)}\"\n```",
    "created_at": "2022-11-11T09:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487894",
    "user": "https://github.com/dcoudert"
}
```

This change is not correct in `src/sage/rings/polynomial/plural.pyx`: extra `)`

```diff
+            raise NotImplementedError(f"not able to interpret {element)}"
```



---

archive/issue_comments_487895.json:
```json
{
    "body": "```diff\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -13724,7 +13724,10 @@ cpdef new_Expression(parent, x):\n             return NaN\n         exp = x\n     elif isinstance(x, int):\n-        exp = GEx(<long>x)\n+        try:\n+            exp = GEx(<long>x)\n+        except OverflowError:\n+            exp = x\n     elif x is infinity:\n         return new_Expression_from_GEx(parent, g_Infinity)\n     elif x is minus_infinity:\n```\nfixes the failing doctest, but introduces (or reveals?) a Heisenbug:\n\n```\nsage -t --warn-long 64.8 --random-seed=209400216403961693791706262075210533242 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n**********************************************************************\n```",
    "created_at": "2022-11-11T11:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487895",
    "user": "https://github.com/kwankyu"
}
```

```diff
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -13724,7 +13724,10 @@ cpdef new_Expression(parent, x):
             return NaN
         exp = x
     elif isinstance(x, int):
-        exp = GEx(<long>x)
+        try:
+            exp = GEx(<long>x)
+        except OverflowError:
+            exp = x
     elif x is infinity:
         return new_Expression_from_GEx(parent, g_Infinity)
     elif x is minus_infinity:
```
fixes the failing doctest, but introduces (or reveals?) a Heisenbug:

```
sage -t --warn-long 64.8 --random-seed=209400216403961693791706262075210533242 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
```



---

archive/issue_comments_487896.json:
```json
{
    "body": "The Heisenbug might not be a bug as Vtilde is a random line bundle. I invited an expert.",
    "created_at": "2022-11-11T11:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487896",
    "user": "https://github.com/kwankyu"
}
```

The Heisenbug might not be a bug as Vtilde is a random line bundle. I invited an expert.



---

archive/issue_comments_487897.json:
```json
{
    "body": "The Heisenbug has been tracked in #32773. So the failed doctest is not related with this ticket.",
    "created_at": "2022-11-11T14:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487897",
    "user": "https://github.com/kwankyu"
}
```

The Heisenbug has been tracked in #32773. So the failed doctest is not related with this ticket.



---

archive/issue_comments_487898.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-11T16:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487898",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487899.json:
```json
{
    "body": "all lights are green now",
    "created_at": "2022-11-11T19:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487899",
    "user": "https://github.com/fchapoton"
}
```

all lights are green now



---

archive/issue_comments_487900.json:
```json
{
    "body": "Why `GEx(<int>x)` rather than `GEx(<long>x)`? GEx seems to accept C long type. C long is better than C int. No?",
    "created_at": "2022-11-11T23:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487900",
    "user": "https://github.com/kwankyu"
}
```

Why `GEx(<int>x)` rather than `GEx(<long>x)`? GEx seems to accept C long type. C long is better than C int. No?



---

archive/issue_comments_487901.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-12T08:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487901",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487902.json:
```json
{
    "body": "ok, done. If I understand correctly `<long>` is not a python type but a C type, right ?",
    "created_at": "2022-11-12T11:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487902",
    "user": "https://github.com/fchapoton"
}
```

ok, done. If I understand correctly `<long>` is not a python type but a C type, right ?



---

archive/issue_comments_487903.json:
```json
{
    "body": "green lights again",
    "created_at": "2022-11-12T12:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487903",
    "user": "https://github.com/fchapoton"
}
```

green lights again



---

archive/issue_comments_487904.json:
```json
{
    "body": "I looked into pynac code, and became confident that the code I suggested is right. The cython code first tries to make GEx (ginac ex) object holding C long data, then in the case of overflow exception, (eventually) make GEx object holding the original python int object.\n\nOtherwise LGTM.",
    "created_at": "2022-11-12T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487904",
    "user": "https://github.com/kwankyu"
}
```

I looked into pynac code, and became confident that the code I suggested is right. The cython code first tries to make GEx (ginac ex) object holding C long data, then in the case of overflow exception, (eventually) make GEx object holding the original python int object.

Otherwise LGTM.



---

archive/issue_comments_487905.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-12T12:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487905",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_487906.json:
```json
{
    "body": "Replying to [comment:16 Fr\u00e9d\u00e9ric Chapoton]:\n> ok, done. If I understand correctly `<long>` is not a python type but a C type, right?\n\n\nRight. We are juggling with \"python2 int\", \"python2 long\", \"python3 int\", \"C int\", \"C long\" :)",
    "created_at": "2022-11-12T12:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487906",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:16 Frédéric Chapoton]:
> ok, done. If I understand correctly `<long>` is not a python type but a C type, right?


Right. We are juggling with "python2 int", "python2 long", "python3 int", "C int", "C long" :)



---

archive/issue_events_089792.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-11-20T12:13:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34502#event-89792"
}
```



---

archive/issue_comments_487907.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-11-20T12:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34502",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34502#issuecomment-487907",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
