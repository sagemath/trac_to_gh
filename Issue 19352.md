# Issue 19352: Upgrade MPIR to 2.7.1

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-11-16 12:27:23

CC:  leif pipedream




---

Comment by jdemeyer created at 2015-11-17 08:43:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-11-17 08:43:53

New commits:


---

Comment by fbissey created at 2015-11-17 10:32:12

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-11-17 10:32:12

lgtm.


---

Comment by vbraun created at 2015-11-18 14:32:40

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-11-18 14:32:40

causes some segfaults in libgmp on Debian and some Ubuntu versions:
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/220/steps/shell_4/logs/stdio
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2064%20bit%29%20incremental/builds/190/steps/shell_4/logs/stdio
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2032%20bit%29%20incremental/builds/218/steps/shell_4/logs/stdio
* http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2064%20bit%29%20incremental/builds/204/steps/shell_4/logs/stdio


---

Comment by jdemeyer created at 2015-11-18 14:58:50

Can I get access to that machine?


---

Comment by vbraun created at 2015-11-19 03:50:32

PS: There were also a whole bunch of different failures on ARM:
 http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/320/steps/shell_4/logs/stdio


---

Comment by jdemeyer created at 2015-11-19 07:15:51

First thing to try is to check with a clean build (after `make distclean`) to check if it might be a dependency issue.

Second thing to check is a different version of GCC.


---

Comment by leif created at 2015-11-19 07:36:48

Replying to [comment:5 vbraun]:
> causes some segfaults in libgmp on Debian and some Ubuntu versions:
> * http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/220/steps/shell_4/logs/stdio


```
/mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.so.16(__gmpn_sub_n+0x30)[0xf64f0e58]
------------------------------------------------------------------------
Attaching gdb to process id 5890.
Unable to start gdb (not installed?)

GDB is not installed.
Install the gdb spkg (sage -i gdb) for enhanced tracebacks.
```

;-)


---

Comment by leif created at 2015-11-19 09:27:52

Does MPIR's test suite at all pass on that machine?  (Haswell in 32-bit mode; `x86/nehalem` for MPIR)


---

Comment by leif created at 2015-11-19 09:59:55

Replying to [comment:10 leif]:
> {{{
> .../sage_git/build/local/lib/libgmp.so.16(__gmpn_sub_n+0x30)[0xf64f0e58]
> }}}

AFAICT, `libgmp.so.16` is MPIR 2.7.*0*, whereas -- for whatever reason ;-) -- MPIR 2.7.1 is `libgmp.so.10`_[_`.6.1`_]_.  (The latter may clash with GMP 6.0.0 btw.)

So probably you should follow Jeroen's advise to [first] try a clean build.


---

Comment by leif created at 2015-11-19 10:16:40

In fact, we have

```
...
Build succeeded.
Removing old GMP/MPIR headers...
Not removing old GMP/MPIR shared libraries, as other libraries
and executables might still refer to them:
-rw-r--r-- 1 buildbot buildbot 3418848 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.a
lrwxrwxrwx 1 buildbot buildbot      16 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.so -> libgmp.so.16.0.0
lrwxrwxrwx 1 buildbot buildbot      16 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.so.16 -> libgmp.so.16.0.0
-rwxr-xr-x 1 buildbot buildbot 1949983 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.so.16.0.0
-rw-r--r-- 1 buildbot buildbot  343410 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmpxx.a
lrwxrwxrwx 1 buildbot buildbot      17 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmpxx.so -> libgmpxx.so.8.0.0
lrwxrwxrwx 1 buildbot buildbot      17 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmpxx.so.8 -> libgmpxx.so.8.0.0
-rwxr-xr-x 1 buildbot buildbot  195794 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmpxx.so.8.0.0
-rw-r--r-- 1 buildbot buildbot 3418848 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.a
lrwxrwxrwx 1 buildbot buildbot      17 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.so -> libmpir.so.16.0.0
lrwxrwxrwx 1 buildbot buildbot      17 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.so.16 -> libmpir.so.16.0.0
-rwxr-xr-x 1 buildbot buildbot 1949983 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.so.16.0.0
-rw-r--r-- 1 buildbot buildbot  343410 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpirxx.a
lrwxrwxrwx 1 buildbot buildbot      18 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpirxx.so -> libmpirxx.so.8.0.0
lrwxrwxrwx 1 buildbot buildbot      18 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpirxx.so.8 -> libmpirxx.so.8.0.0
-rwxr-xr-x 1 buildbot buildbot  195794 Nov 16 09:47 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpirxx.so.8.0.0
(Libraries with the same version number will get updated though.)
Now installing MPIR...
...
libtool: install: /usr/bin/install -c .libs/libmpir.so.10.6.1 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.so.10.6.1
libtool: install: (cd /mnt/highperf/buildbot/slave/sage_git/build/local/lib && { ln -s -f libmpir.so.10.6.1 libmpir.so.10 || { rm -f libmpir.so.10 && ln -s libmpir.so.10.6.1 libmpir.so.10; }; })
libtool: install: (cd /mnt/highperf/buildbot/slave/sage_git/build/local/lib && { ln -s -f libmpir.so.10.6.1 libmpir.so || { rm -f libmpir.so && ln -s libmpir.so.10.6.1 libmpir.so; }; })
libtool: install: /usr/bin/install -c .libs/libmpir.lai /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libmpir.la
libtool: install: /usr/bin/install -c .libs/libgmp.so.10.6.1 /mnt/highperf/buildbot/slave/sage_git/build/local/lib/libgmp.so.10.6.1
libtool: install: (cd /mnt/highperf/buildbot/slave/sage_git/build/local/lib && { ln -s -f libgmp.so.10.6.1 libgmp.so.10 || { rm -f libgmp.so.10 && ln -s libgmp.so.10.6.1 libgmp.so.10; }; })
libtool: install: (cd /mnt/highperf/buildbot/slave/sage_git/build/local/lib && { ln -s -f libgmp.so.10.6.1 libgmp.so || { rm -f libgmp.so && ln -s libgmp.so.10.6.1 libgmp.so; }; })
...
```

so it's definitely a dependency issue.


---

Comment by leif created at 2015-11-19 12:26:59

P.S.:  _Part of_ the weird `.so` versioning (2.7.0 vs. 2.7.1) is due to superfluous trailing whitespace in `Makefile.am`, causing wrong arguments to libtool (corrected for libgmp in 2.7.1, but not libgmpxx).


---

Comment by jdemeyer created at 2015-11-19 12:37:13

If it really is a dependency issue, I don't understand why not all buildbots have the same problem.


---

Comment by leif created at 2015-11-19 13:05:16

Replying to [comment:15 jdemeyer]:
> If it really is a dependency issue, I don't understand why not all buildbots have the same problem.

Luck perhaps.  And I'm not sure how `local/lib/` will look after another run of `ldconfig`...


---

Comment by leif created at 2015-11-19 13:19:58

It seems the last rebuilds of extension modules were only triggered by updates of NTL files.  ([http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20(Debian%207%2032%20bit)%20incremental/builds/220/steps/compile/logs/sage](http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20(Debian%207%2032%20bit)%20incremental/builds/220/steps/compile/logs/sage))


---

Comment by jdemeyer created at 2015-11-19 15:02:33

Yes, some Sage library files still link to the old library:

```
$ ldd local/lib/python2.7/site-packages/sage/ext/interrupt/interrupt.so
        linux-vdso.so.1 (0x00007fff7a9fe000)
        libpari-gmp-2.8.so.0 => /usr/local/src/sage-config/local/lib/libpari-gmp-2.8.so.0 (0x00007fd474f7d000)
        libgmp.so.16 => /usr/local/src/sage-config/local/lib/libgmp.so.16 (0x00007fd474d05000)
        libpython2.7.so.1.0 => /usr/local/src/sage-config/local/lib/libpython2.7.so.1.0 (0x00007fd4748fa000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd4746a9000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fd474300000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fd474012000)
        libgmp.so.10 => /usr/local/src/sage-config/local/lib/libgmp.so.10 (0x00007fd473d9d000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007fd473b98000)
        libutil.so.1 => /lib64/libutil.so.1 (0x00007fd473995000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fd475a29000)
```



---

Comment by jdemeyer created at 2015-11-19 15:03:12

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-11-19 15:04:16

Volker, will your release-management script not merge positively reviewed tickets depending on a non-merged ticket?


---

Comment by vbraun created at 2015-11-19 15:12:19

yes


---

Comment by leif created at 2015-11-19 15:14:36

In principle, `LIBGMPXX_LT_REVISION` should get fixed as well.

(In 2.7.1, we still end up with `-version-info 8:1 :4`, which leads to `libgmpxx.so.8.0.1`.)


---

Comment by vbraun created at 2015-11-19 15:16:10

Replying to [comment:22 leif]:
> In principle, `LIBGMPXX_LT_REVISION` should get fixed as well.

Doesn't really matter for Sage, but if you can send upstream a patch that would be great.


---

Comment by wbhart created at 2015-11-20 17:07:04

I propose to reissue MPIR-2.7.1 with fixed .so version numbering. 

LIBGMP_LT_CURRENT = 22
LIBGMP_LT_REVISION = 1
LIBGMP_LT_AGE = 6

LIBGMPXX_LT_CURRENT = 12
LIBGMPXX_LT_REVISION = 1
LIBGMPXX_LT_AGE = 4

which (I have checked) leads to 16.6.1 and 8.4.1.

Is this ok with everyone?


---

Comment by leif created at 2015-11-20 17:57:25

Replying to [comment:24 wbhart]:
> I propose to reissue MPIR-2.7.1 with fixed .so version numbering. 
> 
> LIBGMP_LT_CURRENT = 22
> LIBGMP_LT_REVISION = 1
> LIBGMP_LT_AGE = 6
> 
> LIBGMPXX_LT_CURRENT = 12
> LIBGMPXX_LT_REVISION = 1
> LIBGMPXX_LT_AGE = 4
> 
> which (I have checked) leads to 16.6.1 and 8.4.1.
> 
> Is this ok with everyone?

To avoid a "downgrade" compared to 2.7.0's mistaken version numbers I guess.

I'd of course prefer fixing those of 2.7.0... B)




While you're at it, some of the confusion presumably arose from the use of periods instead of colons (libtool syntax) in the version table, starting with MPIR 2.1.2 and on:

```
#	  GMP	   -version-info
#       release   libgmp  libgmpxx libmp
#        2.0.x      -        -       -
#        3.0      3:0:0      -     3:0:0
#        3.0.1    3:1:0      -     3:0:0
#        3.1      4:0:1      -     4:0:1
#        3.1.1    4:1:1      -     4:1:1
#        4.0      5:0:2    3:0:0   4:2:1
#        4.0.1    5:1:2    3:1:0   4:3:1
#        4.1      6:0:3    3:2:0   4:4:1
#        4.1.1    6:1:3    3:3:0   4:5:1
#        4.1.2    6:2:3    3:4:0   4:6:1
#        4.1.3    6:3:3    3:5:0   4:7:1
#        4.1.4    6:3:3    3:5:0   4:7:1	WRONG, same as 4.1.3!
#        4.2      6:0:3    3:2:0   4:4:1	REALLY WRONG, same as 4.1!
#        4.2.1    7:1:4    4:1:1   4:10:1
#
#	  MPIR	   -version-info
#       release   libgmp  libgmpxx libmp
#	0.9.0	7:1:4	4:1:1	4:10:1   WRONG, same as GMP 4.2.1
#	1.0.0	7:2:4	4:2:1	4:11:1
#	1.1.0	7:3:4	4:3:1	4:12:1
#	1.2.0	7:4:4	4:4:1	4:13:1
#	1.3.0	8:0:0	4:5:1	4:14:1 
#	1.3.1	8:1:0	4:6:1	0:0:0
#	2.0.0	9:2:0	4:7:1
#	2.1.0	10:0:1	4:8:1
#	2.1.1	10:1:2	4:9:2
#	2.1.2	10.2.2	4.10.2
#	2.1.3	10.3.2	4.11.2
#	2.1.4	10.4.2	4.12.2
#	2.2.0	10.5.2	4.13.2
#	2.2.1	10.6.3	4.14.3
#	2.3.0	10.7.3	4.15.3
#	2.3.1	10.8.3	4.16.3
#	2.4.0   11.0.4  4.17.3
#	2.5.0	11.1.4	4.18.3
#	2.5.1	11.2.4	4.19.3
#	2.5.2	11.3.4	4.20.3
#	2.6.0   11.0.5  4.21.3               Clearly wrong!!
#       2.7.0   16.0.6  8.0.4                Attempt to correct wrt all prev 
#       2.7.1   16.1.6  8.1.4
#
# Starting at 3:0:0 is a slight abuse of the versioning system, but it
# ensures we're past soname libgmp.so.2, which was used on Debian GNU/Linux
# packages of gmp 2.  Pretend gmp 2 was 2:0:0, so the interface changes for
# gmp 3 mean 3:0:0 is right.
#
# We interpret "implementation changed" in item "1." above as meaning any
# release, ie. the REVISION is incremented every time (if nothing else).
# Even if we thought the code generated will be identical on all systems,
# it's still good to get the shared library filename (like
# libgmpxx.so.3.0.4) incrementing, to make it clear which GMP it's from.
```

You could also add an extra column for the _resulting library version_ (in period notation).


---

Comment by wbhart created at 2015-11-20 18:01:18

Yeah, fixing 2.7.0 is obviously not possible. It's too widely deployed. It wouldn't fix it for us anyway. We can't even tell where it is picking up the broken GMP/MPIR from.

As for periods vs colons, I'm not sure what you mean. These are comments aren't they? Or are you telling me libtool actually reads the comments?

Another massive facepalm if so.


---

Comment by leif created at 2015-11-20 18:15:23

Replying to [comment:26 wbhart]:
> Yeah, fixing 2.7.0 is obviously not possible. It's too widely deployed. It wouldn't fix it for us anyway. We can't even tell where it is picking up the broken GMP/MPIR from.

`sudo invent time machine`


> As for periods vs colons, I'm not sure what you mean. These are comments aren't they? Or are you telling me libtool actually reads the comments?

Nope, but the ordinary (human) reader is tempted to interpret "22.1.6" as the effective library version, as opposed to "22:1:6", which in contrast clearly(?) indicates a libtool CURRENT:REVISION:AGE tuple, the parameter passed to it, which the table is supposed to reflect or document.


---

Comment by wbhart created at 2015-11-20 18:21:12

Replying to [comment:27 leif]:
> Replying to [comment:26 wbhart]:
> > Yeah, fixing 2.7.0 is obviously not possible. It's too widely deployed. It wouldn't fix it for us anyway. We can't even tell where it is picking up the broken GMP/MPIR from.
> 
> `sudo invent time machine`

`sudo invent wave-motion gun`

> 
> 
> > As for periods vs colons, I'm not sure what you mean. These are comments aren't they? Or are you telling me libtool actually reads the comments?
> 
> Nope, but the ordinary (human) reader is tempted to interpret "22.1.6" as the effective library version, as opposed to "22:1:6", which in contrast clearly(?) indicates a libtool CURRENT:REVISION:AGE tuple, the parameter passed to it, which the table is supposed to reflect or document.
> 

Ok, well I fixed this in the _repo_ by replacing all the dots with assorted punctuation :p.

I'm going to push the fixed 2.7.1 which I had already prepared, to the website now.


---

Comment by leif created at 2015-11-20 18:26:38

Replying to [comment:28 wbhart]:
> Replying to [comment:27 leif]:
> > Replying to [comment:26 wbhart]:
> > > Yeah, fixing 2.7.0 is obviously not possible. It's too widely deployed. It wouldn't fix it for us anyway. We can't even tell where it is picking up the broken GMP/MPIR from.
> > 
> > `sudo invent time machine`
> 
> `sudo invent wave-motion gun`

[What if?](https://what-if.xkcd.com/87/)


---

Comment by jdemeyer created at 2015-11-21 08:22:09

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-11-21 15:04:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-11-21 15:05:00

Changing status from needs_work to needs_review.


---

Comment by leif created at 2015-11-21 16:52:44

Replying to [comment:18 jdemeyer]:
> Yes, some Sage library files still link to the old library:
> {{{
> $ ldd local/lib/python2.7/site-packages/sage/ext/interrupt/interrupt.so
>         linux-vdso.so.1 (0x00007fff7a9fe000)
>         libpari-gmp-2.8.so.0 => /usr/local/src/sage-config/local/lib/libpari-gmp-2.8.so.0 (0x00007fd474f7d000)
>         libgmp.so.16 => /usr/local/src/sage-config/local/lib/libgmp.so.16 (0x00007fd474d05000)
>         libpython2.7.so.1.0 => /usr/local/src/sage-config/local/lib/libpython2.7.so.1.0 (0x00007fd4748fa000)
>         libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fd4746a9000)
>         libc.so.6 => /lib64/libc.so.6 (0x00007fd474300000)
>         libm.so.6 => /lib64/libm.so.6 (0x00007fd474012000)
>         libgmp.so.10 => /usr/local/src/sage-config/local/lib/libgmp.so.10 (0x00007fd473d9d000)
>         libdl.so.2 => /lib64/libdl.so.2 (0x00007fd473b98000)
>         libutil.so.1 => /lib64/libutil.so.1 (0x00007fd473995000)
>         /lib64/ld-linux-x86-64.so.2 (0x00007fd475a29000)
> }}}

Just for reference:  This is fixed by #19610 (`interrupt.so` will no longer get linked to PARI nor GMP, so it doesn't have to depend on MPIR/GMP either).


---

Comment by leif created at 2015-11-22 00:40:32

Do we really want to remove the test for #19280 in favour of not patching MPIR?

Could we alternatively add a test to the Sage library?


---

Comment by leif created at 2015-11-22 00:40:32

Set assignee to leif.


---

Comment by leif created at 2015-11-22 00:40:47

Remove assignee leif.


---

Comment by leif created at 2015-11-22 01:19:43

Otherwise positive review (modulo #19610 which needs review/info and the previous failures on ARM I cannot check -- I think the buildbot will try again).

Since the major `.so` version of MPIR 2.7.2 is now the same as that of MPIR 2.7.0, this ticket does not really depend on #19610 (nor #19606) anymore.

I also noticed a minor flaw in `spkg-install` w.r.t. the allegedly empty `CXXFLAGS` used, but it's unrelated (I think) to and IMHO beyond the scope of this ticket.


---

Comment by leif created at 2015-11-22 01:19:43

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-11-22 10:41:47

Replying to [comment:37 leif]:
> Since the major `.so` version of MPIR 2.7.2 is now the same as that of MPIR 2.7.0, this ticket does not really depend on #19610 (nor #19606) anymore.

Are you sure about this? The version number still changed, why does it matter which part of the version number changed?


---

Comment by leif created at 2015-11-22 12:14:12

Replying to [comment:38 jdemeyer]:
> Replying to [comment:37 leif]:
> > Since the major `.so` version of MPIR 2.7.2 is now the same as that of MPIR 2.7.0, this ticket does not really depend on #19610 (nor #19606) anymore.
> 
> Are you sure about this? The version number still changed, why does it matter which part of the version number changed?

Because the "major" `.so` version number (and only that) is part of the `soname`, in this case `libgmp.so.16` (for both MPIR 2.7.0, our current version, and MPIR 2.7.2; MPIR 2.7.1 did have `libgmp.so.10`, causing all that trouble -- in conjunction with overlinking _and_ missing dependencies).


---

Comment by vbraun created at 2015-11-23 06:34:16

Resolution: fixed


---

Comment by leif created at 2015-11-23 06:50:05

Replying to [comment:37 leif]:
> Otherwise positive review (modulo #19610 which needs review/info and the previous failures on ARM I cannot check -- I think the buildbot will try again).

Yep, there's now a successful build on ARM with MPIR 2.7.2:

[http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20(Ubuntu%2012.10)%20incremental/builds/325](http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20(Ubuntu%2012.10)%20incremental/builds/325)


---

Comment by jdemeyer created at 2015-11-23 06:59:46

Replying to [comment:39 leif]:
> Because the "major" `.so` version number (and only that) is part of the `soname`

OK, makes sense.
