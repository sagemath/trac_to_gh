# Issue 30533: cython_aliases: Use ecl-config to determine compiler/linker flags for ecl

Issue created by migration from https://trac.sagemath.org/ticket/30770

Original creator: mkoeppe

Original creation time: 2020-10-15 03:25:08

CC:  dimpase mjo @spaghettisalat jhpalmieri @tobiasdiez isuruf fbissey arojas


```
$ ecl-config --help
Usage: /usr/local/bin/ecl-config [OPTIONS] [LIBS]
Options: 
	[--cflags]
	[--libs|--ldflags]
Libs:
	cmp
```



---

Comment by mkoeppe created at 2020-11-01 16:35:49

Ideally, of course, ecl would install a pkg-config module...


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by @tobiasdiez created at 2021-01-11 14:53:19

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2021-01-11 14:53:19

The following is working for me (in the context of #30371).
----
New commits:


---

Comment by mkoeppe created at 2021-01-11 17:13:40

Following the conventions of autoconf, this variable should be called `ECL_CONFIG`, not `ECL_CONFIG_PATH`


---

Comment by git created at 2021-01-12 12:14:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-01-12 12:28:00

Replying to [comment:7 mkoeppe]:
> Following the conventions of autoconf, this variable should be called `ECL_CONFIG`, not `ECL_CONFIG_PATH`

I'm not sure if one should follow the autoconf conventions here since the variable is (right now) only used in python scripts, but I've renamed it anyway.


---

Comment by mkoeppe created at 2021-01-12 17:13:11

`capture_output` is not available on Python 3.6 - see #30758


---

Comment by mkoeppe created at 2021-01-12 23:16:31

I think it's better to make the simple change of the code as in https://git.sagemath.org/sage.git/commit?id=a569b88f02ab4dfdd8eec6e8ad0472f1f537d2c8
instead of deferring this ticket until after we drop support for python 3.6


---

Comment by dimpase created at 2021-01-13 14:29:47

I have yet to see a system that ships patched ECL, allowing one to build Maxima in Sage, etc.


---

Comment by @tobiasdiez created at 2021-01-13 14:49:38

I use this ticket successfully in #30371 to build sage in a new python virtual environment using sage's ecl precisely because the system ecl is not working.


---

Comment by mkoeppe created at 2021-01-13 17:44:48

Replying to [comment:13 dimpase]:
> I have yet to see a system that ships patched ECL, allowing one to build Maxima in Sage, etc.
Surely distributions that ship sage must have a suitable package: conda, arch, ...?


---

Comment by arojas created at 2021-01-13 21:00:15


```
@@ -203,6 +204,7 @@ var('MAXIMA_FAS')
 var('SAGE_NAUTY_BINS_PREFIX',        '')
 var('ARB_LIBRARY',                   'arb')
 var('CBLAS_PC_MODULES',              'cblas:openblas:blas')
+var('ECL_CONFIG')
 
 # misc
 var('SAGE_BANNER', '')
```


Please add a fallback here, otherwise this will break distro packaging without sage_conf


---

Comment by arojas created at 2021-01-13 21:02:37

Given that sage's maxima is patched to install a fas module in ecl's tree, how is this supposed to work with a system ecl?


---

Comment by mkoeppe created at 2021-01-13 21:14:18

I think we can change our maxima installation to use a different installation directoery and then pass the full path using the existing variable `sage.env.MAXIMA_FAS`


---

Comment by mkoeppe created at 2021-01-13 23:51:14

Replying to [comment:17 arojas]:
> {{{
> `@``@` -203,6 +204,7 `@``@` var('MAXIMA_FAS')
>  var('SAGE_NAUTY_BINS_PREFIX',        '')
>  var('ARB_LIBRARY',                   'arb')
>  var('CBLAS_PC_MODULES',              'cblas:openblas:blas')
> +var('ECL_CONFIG')
>  
>  # misc
>  var('SAGE_BANNER', '')
> }}}
> 
> Please add a fallback here, otherwise this will break distro packaging without sage_conf

I agree, this should fall back to just `'ecl-config'`


---

Comment by @tobiasdiez created at 2021-01-14 09:15:27

Good catch, I've now added a fallback!


---

Comment by git created at 2021-01-14 09:15:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-15 14:16:57

#30551 is for 9.4, why is this one still for 9.3 ? (I'd rather switch #30551 to 9.3, though)


---

Comment by @tobiasdiez created at 2021-01-15 14:26:56

I've put #30551 now to 9.3 since I agree it would be convenient to drop python 3.6 support soon. Matthias, please feel free to put both tickets onto 9.4 if you strongly feel that 3.6 still needs to be supported.


---

Comment by mkoeppe created at 2021-01-15 17:46:44

Let's please not use a ticket like this where we know exactly how to write python 3.6 conforming code to force a decision that needs proper discussion in #30551.


---

Comment by mkoeppe created at 2021-01-15 17:46:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-01-15 17:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-15 17:51:44

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-01-16 04:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-16 10:19:10

Replying to [comment:28 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[31f1bbb](https://git.sagemath.org/sage.git/commit/?id=31f1bbba244263160e887613b34111bc3a20d4f4)||`Also use universal_newlines instead of text, for python 3.6 compatibility`||

Why do you push Python-3.6-needed changes to a ticket that depends on #30551 ?
It just makes no sense to me.


---

Comment by mkoeppe created at 2021-01-16 16:34:51

Thanks. I forgot to remove the dependency.


---

Comment by mkoeppe created at 2021-01-16 18:32:51

Replying to [comment:18 arojas]:
> Given that sage's maxima is patched to install a fas module in ecl's tree, how is this supposed to work with a system ecl?

Where do distributions install compiled common lisp libraries?


---

Comment by fbissey created at 2021-01-16 19:57:35

Replying to [comment:31 mkoeppe]:
> Replying to [comment:18 arojas]:
> > Given that sage's maxima is patched to install a fas module in ecl's tree, how is this supposed to work with a system ecl?
> 
> Where do distributions install compiled common lisp libraries?
Gentoo does it in `/usr/lib64/ecl-20.4.24` - as can be seen it is versioned. This is the place where ecl put a lot of its own libraries. It is determined by running the following ecl lisp formula, which I believe is the same in vanilla sage.

```
ecl -eval "(princ (SI:GET-LIBRARY-PATHNAME))" -eval "(quit)"
```

It could be interesting to know other, or how to set other, paths to install .fas files for ecl.


---

Comment by @spaghettisalat created at 2021-01-17 19:10:37

Replying to [comment:32 fbissey]:
> Replying to [comment:31 mkoeppe]:
> > Replying to [comment:18 arojas]:
> > > Given that sage's maxima is patched to install a fas module in ecl's tree, how is this supposed to work with a system ecl?
> > 
> > Where do distributions install compiled common lisp libraries?
> Gentoo does it in `/usr/lib64/ecl-20.4.24` - as can be seen it is versioned. This is the place where ecl put a lot of its own libraries. It is determined by running the following ecl lisp formula, which I believe is the same in vanilla sage.
> {{{
> ecl -eval "(princ (SI:GET-LIBRARY-PATHNAME))" -eval "(quit)"
> }}}
> It could be interesting to know other, or how to set other, paths to install .fas files for ecl. 

There is no universally agreed place to put .fas files, after all you can just use `(load "/wherever/whatever.fas")` to load them from any place you like. But `/usr/lib64/ecl-20.4.24` makes the most sense for libraries useable for multiple projects and also allows you to call `(require :whatever)` to use the fas in ECL. On the other hand, if the .fas file is only useable for a single project, I would rather put it in `/usr/lib64/some-other-project/` and explicitely load it from there.


---

Comment by fbissey created at 2021-01-17 19:14:23

This is extremely interesting, how would you load a .fas from an arbitrary location?


---

Comment by @spaghettisalat created at 2021-01-17 19:19:06

Replying to [comment:35 fbissey]:
> This is extremely interesting, how would you load a .fas from an arbitrary location?

As I said, you just call `(load "/path/to/lib.fas")`. This is a standard common lisp function for loading compiled code or source code into the running image, much like `dlopen` loads a shared library in C.


---

Comment by git created at 2021-01-19 16:32:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-19 21:31:38

Let's continue the discussion on Maxima FASL installation in #29617 (spkg-configure.m4 and distros/ information for ecl)

The present ticket is about the parameters for compiling the `sage.libs.ecl` extension. Needs review


---

Comment by mkoeppe created at 2021-02-02 21:04:14

Let's please get this in


---

Comment by mkoeppe created at 2021-02-02 21:04:14

Changing priority from major to critical.


---

Comment by dimpase created at 2021-02-03 00:38:12

lgtm


---

Comment by dimpase created at 2021-02-03 00:38:12

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2021-02-03 09:21:05

Thanks!


---

Comment by vbraun created at 2021-02-20 10:46:49

Resolution: fixed


---

Comment by mkoeppe created at 2022-05-05 17:18:04

Follow up in #33803
