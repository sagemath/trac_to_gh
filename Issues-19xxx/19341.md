# Issue 19341: Cleaning/Fix in combinat/matrices/hadamard_matrix

archive/issues_019104.json:
```json
{
    "body": "As the title says. Generalizes the existing constructions, and fixes a bug in normalised_hadamard.\n\nNathann\n\nCC:  @dimpase\n\nBranch/Commit: 11590100b6520e833cf8de16732d85407d836214\n\nReviewer: Dima Pasechnik\n\nAuthor: Nathann Cohen\n\nDependencies: #19340\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19341\n\n",
    "closed_at": "2015-10-16T08:22:17Z",
    "created_at": "2015-10-03T21:50:07Z",
    "labels": [
        "component: combinatorial designs"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Cleaning/Fix in combinat/matrices/hadamard_matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19341",
    "user": "https://github.com/nathanncohen"
}
```
As the title says. Generalizes the existing constructions, and fixes a bug in normalised_hadamard.

Nathann

CC:  @dimpase

Branch/Commit: 11590100b6520e833cf8de16732d85407d836214

Reviewer: Dima Pasechnik

Author: Nathann Cohen

Dependencies: #19340

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19341





---

archive/issue_comments_278927.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-03T21:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278927",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278928.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2015-10-03T21:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278928",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_278929.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-10-03T22:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278929",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_278930.json:
```json
{
    "body": "<a id='comment:3'></a>I pushed a branch at u/vdelecroix/19340 with one commit which creates a function hadamard_matrix_flint using flint.",
    "created_at": "2015-10-04T23:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278930",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>I pushed a branch at u/vdelecroix/19340 with one commit which creates a function hadamard_matrix_flint using flint.



---

archive/issue_comments_278931.json:
```json
{
    "body": "<a id='comment:4'></a>Then you will also have ton integrate it into `hadamard_matrix` if you want it to be merged with this branch. You can then write a doctest to compare it with the 'current' (i.e. after this branch) implementation of the paley matrices, which should be correct (but slower) now.\n\nNathann",
    "created_at": "2015-10-05T07:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278931",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>Then you will also have ton integrate it into `hadamard_matrix` if you want it to be merged with this branch. You can then write a doctest to compare it with the 'current' (i.e. after this branch) implementation of the paley matrices, which should be correct (but slower) now.

Nathann



---

archive/issue_comments_278932.json:
```json
{
    "body": "<a id='comment:5'></a>please don't use the coersion, unless really needed:\n\n```\nsage: # your implementation:\nsage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')\n5 loops, best of 3: 269 ms per loop\nsage: # a direct one:\nsage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')\n25 loops, best of 3: 27.9 ms per loop\n```\n(this timing is for `p=3^5`)",
    "created_at": "2015-10-14T18:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278932",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>please don't use the coersion, unless really needed:

```
sage: # your implementation:
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')
5 loops, best of 3: 269 ms per loop
sage: # a direct one:
sage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')
25 loops, best of 3: 27.9 ms per loop
```
(this timing is for `p=3^5`)



---

archive/issue_comments_278933.json:
```json
{
    "body": "<a id='comment:6'></a>How am I supposed to write it instead?",
    "created_at": "2015-10-14T18:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278933",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>How am I supposed to write it instead?



---

archive/issue_comments_278934.json:
```json
{
    "body": "<a id='comment:7'></a>`O_o`\n\nReally?... That's only because of float->ZZ ? `O_o`",
    "created_at": "2015-10-14T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278934",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>`O_o`

Really?... That's only because of float->ZZ ? `O_o`



---

archive/issue_comments_278935.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 ncohen]:\n> How am I supposed to write it instead?\n\n{{{\n1 if (x-y).is_square() else -1\n}}}\ninstead of \n\n```\n2*((x-y).is_square()-.5)\n```\n\nmuch more readable too... ;-)",
    "created_at": "2015-10-14T18:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278935",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:6 ncohen]:
> How am I supposed to write it instead?

{{{
1 if (x-y).is_square() else -1
}}}
instead of 

```
2*((x-y).is_square()-.5)
```

much more readable too... ;-)



---

archive/issue_comments_278936.json:
```json
{
    "body": "<a id='comment:9'></a>What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`",
    "created_at": "2015-10-14T18:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278936",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:9'></a>What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`



---

archive/issue_comments_278937.json:
```json
{
    "body": "<a id='comment:10'></a>Anyway. You are right. But I really did not expect such a diffrence `O_o`\n\nNathann",
    "created_at": "2015-10-14T18:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278937",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>Anyway. You are right. But I really did not expect such a diffrence `O_o`

Nathann



---

archive/issue_comments_278938.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 ncohen]:\n> What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`\n\n\n`python_digesting_a_rabbit`\n\nwell, there is also a float involved...",
    "created_at": "2015-10-14T18:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278938",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>Replying to [comment:9 ncohen]:
> What the hell. Just because I multiply a bool with an integer? What kind of language is that `O_o`


`python_digesting_a_rabbit`

well, there is also a float involved...



---

archive/issue_comments_278939.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-14T18:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278939",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278940.json:
```json
{
    "body": "<a id='comment:13'></a>why are there tests marked `# random` ?",
    "created_at": "2015-10-14T18:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278940",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>why are there tests marked `# random` ?



---

archive/issue_comments_278941.json:
```json
{
    "body": "<a id='comment:14'></a>by the way, `bool` is only a smaller part of the slowness:\n\n```\nsage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')\n25 loops, best of 3: 27.9 ms per loop\nsage: timeit('matrix(ZZ, [[2*((x-y).is_square()-5) for x in K_list] for y in K_list])')\n5 loops, best of 3: 57.1 ms per loop\nsage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')\n5 loops, best of 3: 265 ms per loop\n```\nappearance of `float` causes most of the slowness.",
    "created_at": "2015-10-14T18:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278941",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>by the way, `bool` is only a smaller part of the slowness:

```
sage: timeit('matrix(ZZ, [[1 if (x-y).is_square() else -1 for x in K_list] for y in K_list])')
25 loops, best of 3: 27.9 ms per loop
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-5) for x in K_list] for y in K_list])')
5 loops, best of 3: 57.1 ms per loop
sage: timeit('matrix(ZZ, [[2*((x-y).is_square()-.5) for x in K_list] for y in K_list])')
5 loops, best of 3: 265 ms per loop
```
appearance of `float` causes most of the slowness.



---

archive/issue_comments_278942.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 dimpase]:\n> why are there tests marked `# random` ?\n\n\nthe only possible source of randomness here I can imagine is in the construction of\nthe finite fields. But if you add `conway=True` then it's deterministic for sure, for Conway polynomial is unique for any given order...",
    "created_at": "2015-10-14T18:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278942",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>Replying to [comment:13 dimpase]:
> why are there tests marked `# random` ?


the only possible source of randomness here I can imagine is in the construction of
the finite fields. But if you add `conway=True` then it's deterministic for sure, for Conway polynomial is unique for any given order...



---

archive/issue_comments_278943.json:
```json
{
    "body": "<a id='comment:16'></a>The random is indeed caused by the finite field, and the order in which the elements are enumerated. Also these functions are now tested heavily, so whatever is returned by those functions should be what the user expects.",
    "created_at": "2015-10-14T19:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278943",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>The random is indeed caused by the finite field, and the order in which the elements are enumerated. Also these functions are now tested heavily, so whatever is returned by those functions should be what the user expects.



---

archive/issue_comments_278944.json:
```json
{
    "body": "<a id='comment:17'></a>OK, let's deal with FLINT matrices on another ticket.",
    "created_at": "2015-10-14T19:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278944",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>OK, let's deal with FLINT matrices on another ticket.



---

archive/issue_comments_278945.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-10-14T19:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278945",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_278946.json:
```json
{
    "body": "<a id='comment:18'></a>Yep. At least it is correct now.\n\nThanks,\n\nNathann",
    "created_at": "2015-10-15T06:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278946",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:18'></a>Yep. At least it is correct now.

Thanks,

Nathann



---

archive/issue_comments_278947.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-10-16T08:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19341#issuecomment-278947",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_053527.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-10-16T08:22:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19341",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19341#event-53527"
}
```
