# Issue 19641: Remove (DY)LD_LIBRARY_PATH

archive/issues_019404.json:
```json
{
    "body": "In principle, we just have to compile Sage with\n\n```\nLDFLAGS=-Wl,-rpath,$SAGE_LOCAL/lib\n```\nto use rpath instead of LD_LIBRARY_PATH\n\nUsing #19467 this will work with binary distribution\n\nBenefits to Sage:\n* Only Sage binaries will see the rpath setting, removing all library conflicts\n* Works on OSX 10.11\n\nCC:  @jdemeyer @kiwifb @nbruin\n\nBranch/Commit: 0a890f7cf3a40cae574a5b40dbe83d405115d4cb\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Volker Braun\n\nDependencies: #19640, #19699\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19641\n\n",
    "closed_at": "2015-12-22T19:50:46Z",
    "created_at": "2015-11-29T13:03:15Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Remove (DY)LD_LIBRARY_PATH",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19641",
    "user": "https://github.com/vbraun"
}
```
In principle, we just have to compile Sage with

```
LDFLAGS=-Wl,-rpath,$SAGE_LOCAL/lib
```
to use rpath instead of LD_LIBRARY_PATH

Using #19467 this will work with binary distribution

Benefits to Sage:
* Only Sage binaries will see the rpath setting, removing all library conflicts
* Works on OSX 10.11

CC:  @jdemeyer @kiwifb @nbruin

Branch/Commit: 0a890f7cf3a40cae574a5b40dbe83d405115d4cb

Reviewer: Fran√ßois Bissey

Author: Volker Braun

Dependencies: #19640, #19699

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19641





---

archive/issue_comments_266454.json:
```json
{
    "body": "<a id='comment:2'></a>With the attached branch I can build Sage and all tests pass except three using the quadratic sieve (build/pkgs/flintqs). Which is no surprise if you look at its build \"system\".\n\n---\nNew commits:",
    "created_at": "2015-11-29T21:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266454",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>With the attached branch I can build Sage and all tests pass except three using the quadratic sieve (build/pkgs/flintqs). Which is no surprise if you look at its build "system".

---
New commits:



---

archive/issue_comments_266455.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-11-30T09:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266455",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_266456.json:
```json
{
    "body": "<a id='comment:4'></a>Fixing `flintqs` should be trivial, there is one makefile for `SAGE64` and one used otherwise - and for the record that's the diff between the two\n\n```\n--- makefile.osx64\t2009-01-21 03:11:18.000000000 +1300\n+++ makefile.sage\t2007-05-06 11:00:10.000000000 +1200\n@@ -27,8 +27,8 @@\n BIN  = QuadraticSieve QuadraticSieve.exe\n #CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O2\n #CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O3\n-CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2 -m64\n-CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3 -m64\n+CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2\n+CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3\n RM = rm -f\n \n .PHONY: all clean clean-custom\n@@ -39,7 +39,7 @@\n \t${RM} $(OBJ) $(BIN)\n \n $(BIN): $(OBJ)\n-\t$(CPP) -ansi -m64 $(LINKOBJ) -o \"QuadraticSieve\" $(LIBS)\n+\t$(CPP) -ansi $(LINKOBJ) -o \"QuadraticSieve\" $(LIBS)\n \n ModuloArith.o: ModuloArith.cpp\n \t$(CPP) -ansi -c ModuloArith.cpp -o ModuloArith.o $(CXXFLAGS)\n```\nAnyway `$(LDFLAGS)` can be easily added to the line building `QuadraticSieve` in both (if really necessary).",
    "created_at": "2015-11-30T09:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266456",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>Fixing `flintqs` should be trivial, there is one makefile for `SAGE64` and one used otherwise - and for the record that's the diff between the two

```
--- makefile.osx64	2009-01-21 03:11:18.000000000 +1300
+++ makefile.sage	2007-05-06 11:00:10.000000000 +1200
@@ -27,8 +27,8 @@
 BIN  = QuadraticSieve QuadraticSieve.exe
 #CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O2
 #CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -march=athlon-xp -fomit-frame-pointer -O3
-CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2 -m64
-CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3 -m64
+CXXFLAGS = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O2
+CXXFLAGS2 = $(CXXINCS) -Wall -Wno-sign-compare -fomit-frame-pointer -O3
 RM = rm -f
 
 .PHONY: all clean clean-custom
@@ -39,7 +39,7 @@
 	${RM} $(OBJ) $(BIN)
 
 $(BIN): $(OBJ)
-	$(CPP) -ansi -m64 $(LINKOBJ) -o "QuadraticSieve" $(LIBS)
+	$(CPP) -ansi $(LINKOBJ) -o "QuadraticSieve" $(LIBS)
 
 ModuloArith.o: ModuloArith.cpp
 	$(CPP) -ansi -c ModuloArith.cpp -o ModuloArith.o $(CXXFLAGS)
```
Anyway `$(LDFLAGS)` can be easily added to the line building `QuadraticSieve` in both (if really necessary).



---

archive/issue_comments_266457.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-13T13:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266457",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_266458.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-17T23:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266458",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_266459.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-17T23:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266459",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_266460.json:
```json
{
    "body": "<a id='comment:7'></a>With #19699 Sage builds and all doctests pass",
    "created_at": "2015-12-17T23:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266460",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>With #19699 Sage builds and all doctests pass



---

archive/issue_comments_266461.json:
```json
{
    "body": "<a id='comment:8'></a>Fine with me.",
    "created_at": "2015-12-17T23:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266461",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>Fine with me.



---

archive/issue_comments_266462.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-18T15:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266462",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266463.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                          |                                                |\n> |------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n> |[ab27029](http://git.sagemath.org/sage.git/commit/?id=ab27029135636709b3cecd3d4576c97101e6ca65)|`OSX ld only understands the older rpath syntax`|\n\n\nMinor, but is there a reason not to use\n\n```sh\nLDFLAGS=\"-Wl,-rpath,$SAGE_LOCAL/lib $LDFLAGS\"\n```\n?\n\n(That's the only difference to `-Xlinker` where every argument has to be passed separately.)",
    "created_at": "2015-12-18T17:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266463",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:10'></a>Replying to [comment:9 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                          |                                                |
> |------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
> |[ab27029](http://git.sagemath.org/sage.git/commit/?id=ab27029135636709b3cecd3d4576c97101e6ca65)|`OSX ld only understands the older rpath syntax`|


Minor, but is there a reason not to use

```sh
LDFLAGS="-Wl,-rpath,$SAGE_LOCAL/lib $LDFLAGS"
```
?

(That's the only difference to `-Xlinker` where every argument has to be passed separately.)



---

archive/issue_comments_266464.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-18T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266465.json:
```json
{
    "body": "<a id='comment:12'></a>I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.",
    "created_at": "2015-12-18T17:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266465",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.



---

archive/issue_comments_266466.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 vbraun]:\n> I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.\n\n\nHmmm, a regression?  (cf. #12759)",
    "created_at": "2015-12-18T19:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266466",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>Replying to [comment:12 vbraun]:
> I noticed already that maxima can't handle the two-argument version of sending the linker args, so we'll have to use this syntax.


Hmmm, a regression?  (cf. #12759)



---

archive/issue_comments_266467.json:
```json
{
    "body": "<a id='comment:14'></a>Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)",
    "created_at": "2015-12-18T19:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266467",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)



---

archive/issue_comments_266468.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 vbraun]:\n> Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)\n\n\n? I don't recall myself, but two people claimed it got fixed upstream (in 5.29.1 and later).\n\n(And unsetting `LDFLAGS` in Maxima's `spkg-install` used to work because ECL's were used by Maxima anyway, assuming the settings are the same of course.)",
    "created_at": "2015-12-18T19:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266468",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>Replying to [comment:14 vbraun]:
> Looks more like it has always been that way. Unsetting LDFLAGS doesn't really fix the issue (cf. #12759)


? I don't recall myself, but two people claimed it got fixed upstream (in 5.29.1 and later).

(And unsetting `LDFLAGS` in Maxima's `spkg-install` used to work because ECL's were used by Maxima anyway, assuming the settings are the same of course.)



---

archive/issue_comments_266469.json:
```json
{
    "body": "<a id='comment:16'></a>Works on OSX now",
    "created_at": "2015-12-18T21:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266469",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Works on OSX now



---

archive/issue_comments_266470.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T00:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266470",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266471.json:
```json
{
    "body": "<a id='comment:18'></a>Bootstrapping gcc fails with \n\n```\n/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/gcc-4.9.2.p1/gcc-build/./gcc/cc1: error while loading shared libraries: libmpc.so.3: cannot open shared object file: No such file or directory\n```\nshould be fixed now",
    "created_at": "2015-12-20T00:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266471",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Bootstrapping gcc fails with 

```
/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/gcc-4.9.2.p1/gcc-build/./gcc/cc1: error while loading shared libraries: libmpc.so.3: cannot open shared object file: No such file or directory
```
should be fixed now



---

archive/issue_comments_266472.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T11:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266472",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266473.json:
```json
{
    "body": "<a id='comment:20'></a>Of course using with-stage1-ldflags then fails in stage2; Correct solution from https://gcc.gnu.org/ml/gcc/2008-09/msg00214.html",
    "created_at": "2015-12-20T14:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266473",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>Of course using with-stage1-ldflags then fails in stage2; Correct solution from https://gcc.gnu.org/ml/gcc/2008-09/msg00214.html



---

archive/issue_comments_266474.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-21T08:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266474",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266475.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-21T12:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266475",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266476.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-21T19:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266477.json:
```json
{
    "body": "<a id='comment:24'></a>Now works on all buildbot machines",
    "created_at": "2015-12-22T08:39:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266477",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>Now works on all buildbot machines



---

archive/issue_events_053970.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-12-22T19:50:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19641#event-53970"
}
```



---

archive/issue_comments_266478.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-22T19:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19641",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19641#issuecomment-266478",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
