# Issue 19585: Improve efficiency of calling GAP functions

archive/issues_019348.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nWhen calling a GAP function, the current code outputs its result twice for each call - first time when the function is called, and once again when checking whether the function actually returned something. Then, when the result is actually needed, it is once again read from the variable storing it.\n\nThis ticket removes the first two outputs, thus greatly speeding up the (still slow) GAP interface. The first output is dealt with by `;;`, which suppresses outputting the result, but not any explicitly printed output (which is caught when the function doesn't actually return anything). The second output, which would be printed and compared with the marker, is now stored in an auxiliary variable, which is then compared with the marker using GAP's `IsIdenticalObj` function (which will also give the correct result in the unlikely case when the function returns `\"__SAGE_LAST__\"`, except in the even more unlikely case when it returns the marker object itself).\n\nThe speedup achieved by this fix can be quite dramatic. For example, calling `A.conjugacy_classes_subgroups()` for a permutation group `A` of order 2000 took about 20 seconds on my laptop, but this is now cut down to under 10 seconds (which is still slower than it needs to be, IMO).\n\nCC:  @vbraun @nathanncohen @dimpase\n\nComponent: **interfaces**\n\nKeywords: **GAP functions interface**\n\nAuthor: **Jano\u0161 Vidali**\n\nBranch: **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**\n\nReviewer: **Travis Scrimshaw**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/19585_\n\n",
    "closed_at": "2015-11-28T13:46:05Z",
    "created_at": "2015-11-14T12:40:22Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.10",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Improve efficiency of calling GAP functions",
    "type": "issue",
    "updated_at": "2015-11-28T14:05:30Z",
    "url": "https://github.com/sagemath/sage/issues/19585",
    "user": "https://github.com/jaanos"
}
```
<div id="comment:0"></div>

When calling a GAP function, the current code outputs its result twice for each call - first time when the function is called, and once again when checking whether the function actually returned something. Then, when the result is actually needed, it is once again read from the variable storing it.

This ticket removes the first two outputs, thus greatly speeding up the (still slow) GAP interface. The first output is dealt with by `;;`, which suppresses outputting the result, but not any explicitly printed output (which is caught when the function doesn't actually return anything). The second output, which would be printed and compared with the marker, is now stored in an auxiliary variable, which is then compared with the marker using GAP's `IsIdenticalObj` function (which will also give the correct result in the unlikely case when the function returns `"__SAGE_LAST__"`, except in the even more unlikely case when it returns the marker object itself).

The speedup achieved by this fix can be quite dramatic. For example, calling `A.conjugacy_classes_subgroups()` for a permutation group `A` of order 2000 took about 20 seconds on my laptop, but this is now cut down to under 10 seconds (which is still slower than it needs to be, IMO).

CC:  @vbraun @nathanncohen @dimpase

Component: **interfaces**

Keywords: **GAP functions interface**

Author: **Janoš Vidali**

Branch: **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**

Reviewer: **Travis Scrimshaw**

_Issue created by migration from https://trac.sagemath.org/ticket/19585_





---

archive/issue_events_274927.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-14T12:40:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "milestone_number": null,
    "milestone_title": "sage-6.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274927"
}
```



---

archive/issue_events_274928.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-14T12:40:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274928"
}
```



---

archive/issue_comments_278940.json:
```json
{
    "body": "Branch: **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)**",
    "created_at": "2015-11-14T12:42:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278940",
    "user": "https://github.com/jaanos"
}
```

Branch: **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)**



---

archive/issue_events_274929.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-14T13:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274929"
}
```



---

archive/issue_comments_278941.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n+When calling a GAP function, the current code outputs its result twice for each call - first time when the function is called, and once again when checking whether the function actually returned something. Then, when the result is actually needed, it is once again read from the variable storing it.\n \n+This ticket removes the first two outputs, thus greatly speeding up the (still slow) GAP interface. The first output is dealt with by `;;`, which suppresses outputting the result, but not any explicitly printed output (which is caught when the function doesn't actually return anything). The second output, which would be printed and compared with the marker, is now stored in an auxiliary variable, which is then compared with the marker using GAP's `IsIdenticalObj` function (which will also give the correct result in the unlikely case when the function returns `\"__SAGE_LAST__\"`, except in the even more unlikely case when it returns the marker object itself).\n+\n+The speedup achieved by this fix can be quite dramatic. For example, calling `A.conjugacy_classes_subgroups()` for a permutation group `A` of order 2000 took about 20 seconds on my laptop, but this is now cut down to under 10 seconds (which is still slower than it needs to be, IMO).\n``````\n",
    "created_at": "2015-11-14T13:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278941",
    "user": "https://github.com/jaanos"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,5 @@
+When calling a GAP function, the current code outputs its result twice for each call - first time when the function is called, and once again when checking whether the function actually returned something. Then, when the result is actually needed, it is once again read from the variable storing it.
 
+This ticket removes the first two outputs, thus greatly speeding up the (still slow) GAP interface. The first output is dealt with by `;;`, which suppresses outputting the result, but not any explicitly printed output (which is caught when the function doesn't actually return anything). The second output, which would be printed and compared with the marker, is now stored in an auxiliary variable, which is then compared with the marker using GAP's `IsIdenticalObj` function (which will also give the correct result in the unlikely case when the function returns `"__SAGE_LAST__"`, except in the even more unlikely case when it returns the marker object itself).
+
+The speedup achieved by this fix can be quite dramatic. For example, calling `A.conjugacy_classes_subgroups()` for a permutation group `A` of order 2000 took about 20 seconds on my laptop, but this is now cut down to under 10 seconds (which is still slower than it needs to be, IMO).
``````




---

archive/issue_comments_278942.json:
```json
{
    "body": "Author: **Jano\u0161 Vidali**",
    "created_at": "2015-11-14T13:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278942",
    "user": "https://github.com/jaanos"
}
```

Author: **Janoš Vidali**



---

archive/issue_comments_278943.json:
```json
{
    "body": "Commit: **[`62bd571`](https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278)**",
    "created_at": "2015-11-14T13:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278943",
    "user": "https://github.com/jaanos"
}
```

Commit: **[`62bd571`](https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278)**



---

archive/issue_events_274930.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-14T13:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274930"
}
```



---

archive/issue_events_274931.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-14T13:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274931"
}
```



---

archive/issue_comments_278944.json:
```json
{
    "body": "Changed keywords from none to **GAP functions interface**",
    "created_at": "2015-11-14T13:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278944",
    "user": "https://github.com/jaanos"
}
```

Changed keywords from none to **GAP functions interface**



---

archive/issue_comments_278945.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278\"><code>62bd571</code></a></td><td><code>Flip the switch from \"magic\" to \"more magic\":)</code></td></tr></table>\n",
    "created_at": "2015-11-14T13:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278945",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278"><code>62bd571</code></a></td><td><code>Flip the switch from "magic" to "more magic":)</code></td></tr></table>




---

archive/issue_comments_278946.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis does not appear to be a universal speedup. With branch:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 432 ms, sys: 44 ms, total: 476 ms\nWall time: 507 ms\n\nsage: P = groups.matrix.GL(3, 3)\nsage: %timeit P.conjugacy_classes_representatives()\n1000 loops, best of 3: 1.08 ms per loop\n\nsage: P = groups.permutation.Suzuki(8)\nsage: P.cardinality()\n29120\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 115 ms, sys: 10.3 ms, total: 125 ms\nWall time: 296 ms\n```\nvs before:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 368 ms, sys: 40.4 ms, total: 408 ms\nWall time: 436 ms\n\nsage: P = groups.matrix.GL(3, 3)\nsage: %timeit P.conjugacy_classes_representatives()\n1000 loops, best of 3: 1.02 ms per loop\n\nsage: P = groups.permutation.Suzuki(8)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 139 ms, sys: 121 \u00b5s, total: 139 ms\nWall time: 264 ms\n```\n(For these timings, I ran it 10 times and took the best.)\n\nPerhaps this change is asymptotically better. Could you post the group(s) you are using to test this?",
    "created_at": "2015-11-14T16:13:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278946",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3" align="right">comment:3</div>

This does not appear to be a universal speedup. With branch:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 432 ms, sys: 44 ms, total: 476 ms
Wall time: 507 ms

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
1000 loops, best of 3: 1.08 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: P.cardinality()
29120
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 115 ms, sys: 10.3 ms, total: 125 ms
Wall time: 296 ms
```
vs before:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 368 ms, sys: 40.4 ms, total: 408 ms
Wall time: 436 ms

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
1000 loops, best of 3: 1.02 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 139 ms, sys: 121 µs, total: 139 ms
Wall time: 264 ms
```
(For these timings, I ran it 10 times and took the best.)

Perhaps this change is asymptotically better. Could you post the group(s) you are using to test this?



---

archive/issue_comments_278947.json:
```json
{
    "body": "Cubic vertex-transitive graph of order 1000, #3",
    "created_at": "2015-11-14T19:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278947",
    "user": "https://github.com/jaanos"
}
```

Cubic vertex-transitive graph of order 1000, #3



---

archive/issue_comments_278948.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAttachment: **[cvt-n1000i3.s6.gz](https://github.com/sagemath/sage/files/ticket19585/cvt-n1000i3.s6.gz)**\n\nI have attached the sparse6 string of a graph the automorphism group of which I was working with. I guess the problem here is that the domain is very large (unlike the cases above), so actually printing and reading the result is what takes most time, rather than the computation itself.",
    "created_at": "2015-11-14T19:30:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278948",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:5" align="right">comment:5</div>

Attachment: **[cvt-n1000i3.s6.gz](https://github.com/sagemath/sage/files/ticket19585/cvt-n1000i3.s6.gz)**

I have attached the sparse6 string of a graph the automorphism group of which I was working with. I guess the problem here is that the domain is very large (unlike the cases above), so actually printing and reading the result is what takes most time, rather than the computation itself.



---

archive/issue_comments_278949.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI suspect the reason we are seeing a slowdown in these smaller function calls is because of the extra GAP call:\n\n```python\nif self.eval('IsIdenticalObj(__SAGE_VAL__, __SAGE_LAST__)') != 'true':\n```\nI think we could probably just check if `res` is non-empty:\n\n```python\nself.eval('__SAGE_LAST__ := \"__SAGE_LAST__\";;')\nres = self.eval(\"%s(%s);;\"%(function, \",\".join([s.name() for s in args]+\n                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))\nif not res: # No printing was done\n    if self.eval('IsIdenticalObj(last, __SAGE_LAST__)') != 'true':\n        return self.new('last2')\nelse:\n    if res.strip():\n        from sage.interfaces.expect import AsciiArtString\n        return AsciiArtString(res)\n```",
    "created_at": "2015-11-15T00:17:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278949",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">comment:6</div>

I suspect the reason we are seeing a slowdown in these smaller function calls is because of the extra GAP call:

```python
if self.eval('IsIdenticalObj(__SAGE_VAL__, __SAGE_LAST__)') != 'true':
```
I think we could probably just check if `res` is non-empty:

```python
self.eval('__SAGE_LAST__ := "__SAGE_LAST__";;')
res = self.eval("%s(%s);;"%(function, ",".join([s.name() for s in args]+
                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))
if not res: # No printing was done
    if self.eval('IsIdenticalObj(last, __SAGE_LAST__)') != 'true':
        return self.new('last2')
else:
    if res.strip():
        from sage.interfaces.expect import AsciiArtString
        return AsciiArtString(res)
```



---

archive/issue_comments_278950.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nBy the way, apart from the result the last call, `last`, GAP stores results of two previous calls, in `last2` and in `last3`.\nIt looks like using these might avoid doing an extra GAP call...\n(`IsIdenticalObject` is not cheap in GAP)",
    "created_at": "2015-11-15T00:41:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278950",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

By the way, apart from the result the last call, `last`, GAP stores results of two previous calls, in `last2` and in `last3`.
It looks like using these might avoid doing an extra GAP call...
(`IsIdenticalObject` is not cheap in GAP)



---

archive/issue_comments_278951.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHere is the above tweak (which I did some editing to) that has about a %1 slowdown of the current Sage version but doesn't do the extra printing.\n\nIs `IsIdenticalObject` really that expensive in GAP? It seems like it would be the equivalent of `is`, and so it should be fast...\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c\"><code>48409b0</code></a></td><td><code>Reducing the number of function calls to GAP.</code></td></tr></table>\n",
    "created_at": "2015-11-15T01:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278951",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">comment:8</div>

Here is the above tweak (which I did some editing to) that has about a %1 slowdown of the current Sage version but doesn't do the extra printing.

Is `IsIdenticalObject` really that expensive in GAP? It seems like it would be the equivalent of `is`, and so it should be fast...

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c"><code>48409b0</code></a></td><td><code>Reducing the number of function calls to GAP.</code></td></tr></table>




---

archive/issue_comments_278952.json:
```json
{
    "body": "Changed commit from **[`62bd571`](https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278)** to **[`48409b0`](https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c)**",
    "created_at": "2015-11-15T01:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278952",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`62bd571`](https://github.com/sagemath/sagetrac-mirror/commit/62bd5710559065d03a64aed7b8611cdc6842b278)** to **[`48409b0`](https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c)**



---

archive/issue_comments_278953.json:
```json
{
    "body": "Changed branch from **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)** to **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)**",
    "created_at": "2015-11-15T01:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278953",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)** to **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)**



---

archive/issue_comments_278954.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).",
    "created_at": "2015-11-15T10:31:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278954",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:9" align="right">comment:9</div>

I think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).



---

archive/issue_comments_278955.json:
```json
{
    "body": "Changed branch from **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)** to **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)**",
    "created_at": "2015-11-15T11:08:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278955",
    "user": "https://github.com/jaanos"
}
```

Changed branch from **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)** to **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)**



---

archive/issue_comments_278956.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI have removed the check for empty output. Since most functions we call will return a value and not print anything, there is actually one check less in these cases.\n\nAs far as `IsIdenticalObj` is concerned, it surprises me too that it should not be cheap. I don't suppose that `=` is actually cheaper?\n\nActually, what we could do is cut the number of times `eval` is called, by simply running the three GAP commands in one `eval`. I'll try that, and if there is any speedup from doing that, I'll push the change to this ticket.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc\"><code>46f1391</code></a></td><td><code>Call IsIdenticalObj even when there is some output, to prevent ignoring the returned value when there is printed output</code></td></tr></table>\n",
    "created_at": "2015-11-15T11:21:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278956",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:11" align="right">comment:11</div>

I have removed the check for empty output. Since most functions we call will return a value and not print anything, there is actually one check less in these cases.

As far as `IsIdenticalObj` is concerned, it surprises me too that it should not be cheap. I don't suppose that `=` is actually cheaper?

Actually, what we could do is cut the number of times `eval` is called, by simply running the three GAP commands in one `eval`. I'll try that, and if there is any speedup from doing that, I'll push the change to this ticket.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc"><code>46f1391</code></a></td><td><code>Call IsIdenticalObj even when there is some output, to prevent ignoring the returned value when there is printed output</code></td></tr></table>




---

archive/issue_comments_278957.json:
```json
{
    "body": "Changed commit from **[`48409b0`](https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c)** to **[`46f1391`](https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc)**",
    "created_at": "2015-11-15T11:21:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278957",
    "user": "https://github.com/jaanos"
}
```

Changed commit from **[`48409b0`](https://github.com/sagemath/sagetrac-mirror/commit/48409b03cc37684677c441eddc6ae54584cdd13c)** to **[`46f1391`](https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc)**



---

archive/issue_comments_278958.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jaanos](#comment%3A9):\n> I think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).\n\nThis is the current behavior in Sage, so it's not really a problem. However, with our current approach, we could print out any non-trivial print statements along with functions that print and give outputs.\n\nAlthough I think we do need 2 function calls, where the second one is the current call to `IsIdenticalObject`.",
    "created_at": "2015-11-15T14:28:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278958",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jaanos](#comment%3A9):
> I think we have a problem now... what if the function does print something, but also returns a value? Then we should catch the value, not the printed output (which is most likely some kind of warning).

This is the current behavior in Sage, so it's not really a problem. However, with our current approach, we could print out any non-trivial print statements along with functions that print and give outputs.

Although I think we do need 2 function calls, where the second one is the current call to `IsIdenticalObject`.



---

archive/issue_comments_278959.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nHi!\n\nI've tried a few alternatives. First of all, for reference, the timings on my laptop with the develop branch (i.e., 6.10.beta4):\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 944 ms, sys: 64 ms, total: 1.01 s\nWall time: 1.33 s\n\nsage: P = groups.matrix.GL(3, 3)\nsage: %timeit P.conjugacy_classes_representatives()\n100 loops, best of 3: 3.26 ms per loop\n\nsage: P = groups.permutation.Suzuki(8)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 300 ms, sys: 40 ms, total: 340 ms\nWall time: 421 ms\n```\n\nWith the current branch, there is a small slowdown when there wasn't much output to cut, as expected:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 1.08 s, sys: 120 ms, total: 1.2 s\nWall time: 1.42 s\n\nsage: P = groups.matrix.GL(3, 3)\nsage: %timeit P.conjugacy_classes_representatives()\n100 loops, best of 3: 3.31 ms per loop\n\nsage: P = groups.permutation.Suzuki(8)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 220 ms, sys: 40 ms, total: 260 ms\nWall time: 343 ms\n```\n\nI've tried removing `IsIdenticalObj`:\n\n```python\nmarker1 = '\"__SAGE_LAST1__\"'\nmarker2 = '\"__SAGE_LAST2__\"'\nself.eval('__SAGE_LAST1__ := %s;;' % marker1)\nself.eval('__SAGE_LAST2__ := %s;;' % marker2)\nres = self.eval(\"%s(%s);;\"%(function, \",\".join([s.name() for s in args]+\n                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))\nif self.eval('last2') == marker2:\n    return self.new('last2')\nelse:\n    ...\n```\nBut it seems that `IsIdenticalObj` isn't that expensive after all:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 1.08 s, sys: 132 ms, total: 1.22 s\nWall time: 1.5 s\n\nsage: P = groups.matrix.GL(3, 3)\nsage: %timeit P.conjugacy_classes_representatives()\n100 loops, best of 3: 3.27 ms per loop\n\nsage: P = groups.permutation.Suzuki(8)\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 240 ms, sys: 28 ms, total: 268 ms\nWall time: 371 ms\n```\n\nI've also tried making all calls in a single `eval`, but it seems that `last` doesn't work when used in a file. So it will probably be best to keep the latest version with `IsIdenticalObj`.\n\nJano\u0161",
    "created_at": "2015-11-15T17:48:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278959",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:13" align="right">comment:13</div>

Hi!

I've tried a few alternatives. First of all, for reference, the timings on my laptop with the develop branch (i.e., 6.10.beta4):

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 944 ms, sys: 64 ms, total: 1.01 s
Wall time: 1.33 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.26 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 300 ms, sys: 40 ms, total: 340 ms
Wall time: 421 ms
```

With the current branch, there is a small slowdown when there wasn't much output to cut, as expected:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 1.08 s, sys: 120 ms, total: 1.2 s
Wall time: 1.42 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.31 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 220 ms, sys: 40 ms, total: 260 ms
Wall time: 343 ms
```

I've tried removing `IsIdenticalObj`:

```python
marker1 = '"__SAGE_LAST1__"'
marker2 = '"__SAGE_LAST2__"'
self.eval('__SAGE_LAST1__ := %s;;' % marker1)
self.eval('__SAGE_LAST2__ := %s;;' % marker2)
res = self.eval("%s(%s);;"%(function, ",".join([s.name() for s in args]+
                ['%s=%s'%(key,value.name()) for key, value in kwds.items()])))
if self.eval('last2') == marker2:
    return self.new('last2')
else:
    ...
```
But it seems that `IsIdenticalObj` isn't that expensive after all:

```
sage: P = groups.permutation.Symmetric(7)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 1.08 s, sys: 132 ms, total: 1.22 s
Wall time: 1.5 s

sage: P = groups.matrix.GL(3, 3)
sage: %timeit P.conjugacy_classes_representatives()
100 loops, best of 3: 3.27 ms per loop

sage: P = groups.permutation.Suzuki(8)
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 240 ms, sys: 28 ms, total: 268 ms
Wall time: 371 ms
```

I've also tried making all calls in a single `eval`, but it seems that `last` doesn't work when used in a file. So it will probably be best to keep the latest version with `IsIdenticalObj`.

Janoš



---

archive/issue_comments_278960.json:
```json
{
    "body": "Changed commit from **[`46f1391`](https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc)** to **[`f599265`](https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9)**",
    "created_at": "2015-11-15T18:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278960",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`46f1391`](https://github.com/sagemath/sagetrac-mirror/commit/46f1391fd13052e8c684ed3e96434143a58860dc)** to **[`f599265`](https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9)**



---

archive/issue_comments_278961.json:
```json
{
    "body": "Changed branch from **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)** to **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)**",
    "created_at": "2015-11-15T18:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278961",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)** to **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)**



---

archive/issue_comments_278962.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2015-11-15T18:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278962",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_278963.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nBy combining the two commands, I get a net speedup:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %timeit P.conjugacy_classes_subgroups()\n1 loops, best of 3: 390 ms per loop\nsage: P = groups.permutation.Symmetric(2)\nsage: %timeit P.conjugacy_classes_subgroups()\n100 loops, best of 3: 7.87 ms per loop\n```\nvs current `develop`:\n\n```\nsage: P = groups.permutation.Symmetric(7)\nsage: %timeit P.conjugacy_classes_subgroups()\n1 loops, best of 3: 403 ms per loop\nsage: P = groups.permutation.Symmetric(2)\nsage: %timeit P.conjugacy_classes_subgroups()\n100 loops, best of 3: 8.08 ms per loop\n```\nI think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9\"><code>f599265</code></a></td><td><code>Combining the two commands for more speed.</code></td></tr></table>\n",
    "created_at": "2015-11-15T18:41:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278963",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">comment:14</div>

By combining the two commands, I get a net speedup:

```
sage: P = groups.permutation.Symmetric(7)
sage: %timeit P.conjugacy_classes_subgroups()
1 loops, best of 3: 390 ms per loop
sage: P = groups.permutation.Symmetric(2)
sage: %timeit P.conjugacy_classes_subgroups()
100 loops, best of 3: 7.87 ms per loop
```
vs current `develop`:

```
sage: P = groups.permutation.Symmetric(7)
sage: %timeit P.conjugacy_classes_subgroups()
1 loops, best of 3: 403 ms per loop
sage: P = groups.permutation.Symmetric(2)
sage: %timeit P.conjugacy_classes_subgroups()
100 loops, best of 3: 8.08 ms per loop
```
I think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9"><code>f599265</code></a></td><td><code>Combining the two commands for more speed.</code></td></tr></table>




---

archive/issue_comments_278964.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nFor solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!",
    "created_at": "2015-11-15T19:20:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278964",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

For solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!



---

archive/issue_comments_278965.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@nbruin](#comment%3A15):\n> For solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!\n\ninterestingly, libGAP is quite slow here.\n\n```\nsage: %time S = P.conjugacy_classes_subgroups()\nCPU times: user 143 ms, sys: 24 ms, total: 167 ms\nWall time: 181 ms\nsage: P = libgap.SuzukiGroup(libgap.IsPermGroup,8)\nsage: %time S=P.ConjugacyClassesSubgroups()\nCPU times: user 220 ms, sys: 0 ns, total: 220 ms\nWall time: 220 ms\n```\n\nI guess there handling of `P` and `S` on the Sage side is not optimal...",
    "created_at": "2015-11-15T20:25:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278965",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@nbruin](#comment%3A15):
> For solving your original problem: if communication is a bottleneck, then using libGap will probably give you the best improvements. That said, improvements in expect interfaces are of course welcome, so thanks!

interestingly, libGAP is quite slow here.

```
sage: %time S = P.conjugacy_classes_subgroups()
CPU times: user 143 ms, sys: 24 ms, total: 167 ms
Wall time: 181 ms
sage: P = libgap.SuzukiGroup(libgap.IsPermGroup,8)
sage: %time S=P.ConjugacyClassesSubgroups()
CPU times: user 220 ms, sys: 0 ns, total: 220 ms
Wall time: 220 ms
```

I guess there handling of `P` and `S` on the Sage side is not optimal...



---

archive/issue_comments_278966.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@dimpase](#comment%3A16):\n> interestingly, libGAP is quite slow here.\n\n...\n> I guess there handling of `P` and `S` on the Sage side is not optimal... \n\nThat is one possibility. It could also be that libGap gets compiled with different optimization settings and/or that the memory manager underneath is different and affects execution. It could really be worthwhile if someone knowledgeable about libGap would run some of these examples through a profiler (gperftool perhaps?) and compare the execution profiles between Gap and libGap.",
    "created_at": "2015-11-15T21:22:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278966",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@dimpase](#comment%3A16):
> interestingly, libGAP is quite slow here.

...
> I guess there handling of `P` and `S` on the Sage side is not optimal... 

That is one possibility. It could also be that libGap gets compiled with different optimization settings and/or that the memory manager underneath is different and affects execution. It could really be worthwhile if someone knowledgeable about libGap would run some of these examples through a profiler (gperftool perhaps?) and compare the execution profiles between Gap and libGap.



---

archive/issue_comments_278967.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nHi!\n\n> I think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.\n\nThat seems like a good idea, however it fails for longer commands, when a file is used to communicate with GAP (as I said, `last` doesn't seem to work in this case). Maybe we could check the length of the command, and then decide how many `eval`s we do based on that (really short cases can be handled with a single `eval`).\n\nJano\u0161",
    "created_at": "2015-11-15T21:47:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278967",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:18" align="right">comment:18</div>

Hi!

> I think we need to mitigate then number of `eval` calls that get made more so than doing the check in Sage. So if you're happy with my last change, then I'm okay with setting this to positive review.

That seems like a good idea, however it fails for longer commands, when a file is used to communicate with GAP (as I said, `last` doesn't seem to work in this case). Maybe we could check the length of the command, and then decide how many `eval`s we do based on that (really short cases can be handled with a single `eval`).

Janoš



---

archive/issue_comments_278968.json:
```json
{
    "body": "Changed branch from **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)** to **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)**",
    "created_at": "2015-11-15T23:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278968",
    "user": "https://github.com/jaanos"
}
```

Changed branch from **[u/tscrim/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/improve_calling_gap_function-19585)** to **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)**



---

archive/issue_comments_278969.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nHello again!\n\nOK, I added the check for overlong function calls, and it doesn't seem to affect runnning times. Such calls would probably never happen, but we can simulate one with something like\n\n```python\ngap.function_call(\"ConjugacyClassesSubgroups\", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_very_very_very_long_name'))\n```\nWithout the latest commit, this would return a wrong result.\n\nI have also experimented with also making the check for identical objects in the same `eval` if the function call was short enough, but this invariably caused slowdowns.\n\nJano\u0161\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105\"><code>1408680</code></a></td><td><code>Check if command is too long for combining</code></td></tr></table>\n",
    "created_at": "2015-11-15T23:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278969",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:20" align="right">comment:20</div>

Hello again!

OK, I added the check for overlong function calls, and it doesn't seem to affect runnning times. Such calls would probably never happen, but we can simulate one with something like

```python
gap.function_call("ConjugacyClassesSubgroups", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_very_very_very_long_name'))
```
Without the latest commit, this would return a wrong result.

I have also experimented with also making the check for identical objects in the same `eval` if the function call was short enough, but this invariably caused slowdowns.

Janoš

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105"><code>1408680</code></a></td><td><code>Check if command is too long for combining</code></td></tr></table>




---

archive/issue_comments_278970.json:
```json
{
    "body": "Changed commit from **[`f599265`](https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9)** to **[`1408680`](https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105)**",
    "created_at": "2015-11-15T23:35:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278970",
    "user": "https://github.com/jaanos"
}
```

Changed commit from **[`f599265`](https://github.com/sagemath/sagetrac-mirror/commit/f59926575333e34976901f92c1f070e0c168a0b9)** to **[`1408680`](https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105)**



---

archive/issue_comments_278971.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI'm not quite sure why my version didn't work; I'm sure it has something to do with how the pexpect interfaces work. However I confirm we need this change. Could you add a doctest for the long commands? With that, then you can set a positive review on my behalf.",
    "created_at": "2015-11-16T03:55:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278971",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:21" align="right">comment:21</div>

I'm not quite sure why my version didn't work; I'm sure it has something to do with how the pexpect interfaces work. However I confirm we need this change. Could you add a doctest for the long commands? With that, then you can set a positive review on my behalf.



---

archive/issue_comments_278972.json:
```json
{
    "body": "Changed commit from **[`1408680`](https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105)** to **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)**",
    "created_at": "2015-11-16T11:49:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278972",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1408680`](https://github.com/sagemath/sagetrac-mirror/commit/1408680266b88585fa6cb15780e8c8dfce415105)** to **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)**



---

archive/issue_comments_278973.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c\"><code>086af29</code></a></td><td><code>Add doctests for function_call</code></td></tr></table>\n",
    "created_at": "2015-11-16T11:49:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278973",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c"><code>086af29</code></a></td><td><code>Add doctests for function_call</code></td></tr></table>




---

archive/issue_events_274932.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-16T11:59:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274932"
}
```



---

archive/issue_events_274933.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-16T11:59:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274933"
}
```



---

archive/issue_comments_278974.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI've added the doctest. However, now doctesting fails on a seemingly unrelated issue:\n\n```\nsage -t src/sage/interfaces/gap.py\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 1001, in sage.interfaces.gap.GapElement_generic.bool\nFailed example:\n    gap('false').bool()\nExpected:\n    False\nGot:\n    True\n**********************************************************************\n```\nThis doesn't happen on the develop branch, and not even with the last commit. It seems that the failure has to do with the overlong variable name being reused:\n\n```python\nsage: gap.function_call(\"ConjugacyClassesSubgroups\", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'))\n[ ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),Group( [ () ] )), \n  ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),SymmetricGroup( [ 1 .. 2 ] )) ]\nsage: F = gap('false')\nsage: F.bool()\nTrue\nsage: F.name()\n'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'\nsage: F = gap('false')\nsage: F.bool()\nFalse\nsage: F.name()\n'$sage1'\n```\nWill look into it.",
    "created_at": "2015-11-16T11:59:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278974",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:23" align="right">comment:23</div>

I've added the doctest. However, now doctesting fails on a seemingly unrelated issue:

```
sage -t src/sage/interfaces/gap.py
**********************************************************************
File "src/sage/interfaces/gap.py", line 1001, in sage.interfaces.gap.GapElement_generic.bool
Failed example:
    gap('false').bool()
Expected:
    False
Got:
    True
**********************************************************************
```
This doesn't happen on the develop branch, and not even with the last commit. It seems that the failure has to do with the overlong variable name being reused:

```python
sage: gap.function_call("ConjugacyClassesSubgroups", sage.interfaces.gap.GapElement(gap, 'SymmetricGroup(2)', name = 'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'))
[ ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),Group( [ () ] )), 
  ConjugacyClassSubgroups(SymmetricGroup( [ 1 .. 2 ] ),SymmetricGroup( [ 1 .. 2 ] )) ]
sage: F = gap('false')
sage: F.bool()
True
sage: F.name()
'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'
sage: F = gap('false')
sage: F.bool()
False
sage: F.name()
'$sage1'
```
Will look into it.



---

archive/issue_comments_278975.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d\"><code>31a173b</code></a></td><td><code>Properly handle long variable names</code></td></tr></table>\n",
    "created_at": "2015-11-16T12:32:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278975",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:24"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d"><code>31a173b</code></a></td><td><code>Properly handle long variable names</code></td></tr></table>




---

archive/issue_comments_278976.json:
```json
{
    "body": "Changed commit from **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)** to **[`31a173b`](https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d)**",
    "created_at": "2015-11-16T12:32:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278976",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)** to **[`31a173b`](https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d)**



---

archive/issue_comments_278977.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nOK, I had to make sure that getting variables with long names is properly handled. As it is, it is possible that `eval`s with commands a bit longer than the cutoff are made directly to GAP instead of with a temporary file (due to the `Print()` being wrapped around the variable name), but this shouldn't be a problem.\n\nI am setting this back to \"needs review\" due to this additional changes.\n\nJano\u0161",
    "created_at": "2015-11-16T12:38:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278977",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:25" align="right">comment:25</div>

OK, I had to make sure that getting variables with long names is properly handled. As it is, it is possible that `eval`s with commands a bit longer than the cutoff are made directly to GAP instead of with a temporary file (due to the `Print()` being wrapped around the variable name), but this shouldn't be a problem.

I am setting this back to "needs review" due to this additional changes.

Janoš



---

archive/issue_events_274934.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-16T12:38:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274934"
}
```



---

archive/issue_events_274935.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-16T12:38:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274935"
}
```



---

archive/issue_comments_278978.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nWhile in principle, I think these recent changes are okay, could someone else double-check that we want to do things this way?\n\nAs for the current code, I would change:\n\n```diff\n-        if isinstance(self._name, six.string_types) and parent._eval_using_file_cutoff and \\\n-           parent._eval_using_file_cutoff < len(self._name):\n-            self._get_using_file = True\n+        self._get_using_file = (isinstance(self._name, six.string_types)\n+                                and parent._eval_using_file_cutoff\n+                                and parent._eval_using_file_cutoff < len(self._name))\n```\nso we don't have to do a `try/except` block:\n\n```diff\n         if use_file is None:\n-            try:\n-                use_file = self._get_using_file\n-            except AttributeError:\n-                use_file = False\n+            use_file = self._get_using_file\n```",
    "created_at": "2015-11-17T18:14:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278978",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:26" align="right">comment:26</div>

While in principle, I think these recent changes are okay, could someone else double-check that we want to do things this way?

As for the current code, I would change:

```diff
-        if isinstance(self._name, six.string_types) and parent._eval_using_file_cutoff and \
-           parent._eval_using_file_cutoff < len(self._name):
-            self._get_using_file = True
+        self._get_using_file = (isinstance(self._name, six.string_types)
+                                and parent._eval_using_file_cutoff
+                                and parent._eval_using_file_cutoff < len(self._name))
```
so we don't have to do a `try/except` block:

```diff
         if use_file is None:
-            try:
-                use_file = self._get_using_file
-            except AttributeError:
-                use_file = False
+            use_file = self._get_using_file
```



---

archive/issue_comments_278979.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI agree with the change.\n\nBy the way, earlier in `Expect.__init__`, `_get_using_file` is set if the *value* is too long - I don't see how that helps (except when `is_name == True`, but the new code also covers this case). So we can probably remove that piece of code, too.\n\nOn the other hand, this comment\n\n```python\n# idea: Joe Wetherell -- try to find out if the output\n# is too long and if so get it using file, otherwise\n# don't.\n```\nmakes me wonder whether `_get_using_file == True` was meant that fetching the result would be done using a temporary file (rather than using one to communicate the variable name). But of course, a long command may give a very short answer, and the output of a short command may be very long, so this isn't something that can be decided here. Also, the only `get_using_file` methods apart from the new one in `gap.py` are the generic one in `interface.py` (which simply calls `get`), and one in `lie.py` which raises a `NotImplementedError`. So we're probably safe redefining the meaning, if that's what's happening here.",
    "created_at": "2015-11-17T19:20:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278979",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:27" align="right">comment:27</div>

I agree with the change.

By the way, earlier in `Expect.__init__`, `_get_using_file` is set if the *value* is too long - I don't see how that helps (except when `is_name == True`, but the new code also covers this case). So we can probably remove that piece of code, too.

On the other hand, this comment

```python
# idea: Joe Wetherell -- try to find out if the output
# is too long and if so get it using file, otherwise
# don't.
```
makes me wonder whether `_get_using_file == True` was meant that fetching the result would be done using a temporary file (rather than using one to communicate the variable name). But of course, a long command may give a very short answer, and the output of a short command may be very long, so this isn't something that can be decided here. Also, the only `get_using_file` methods apart from the new one in `gap.py` are the generic one in `interface.py` (which simply calls `get`), and one in `lie.py` which raises a `NotImplementedError`. So we're probably safe redefining the meaning, if that's what's happening here.



---

archive/issue_events_274936.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-19T23:49:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274936"
}
```



---

archive/issue_events_274937.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-19T23:49:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274937"
}
```



---

archive/issue_comments_278980.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nHello everybody!\n\nIt turns out that we still have some issues here.\n\nFirstly, GAP function calls don't actually work when done through a temporary file, nor does getting a variable (which is essentially a `Print` call). The reason for this is that when `_eval_line_using_file` is called, it first looks for a `:=` token - if there is one, all is well; but since we are relying on `last`, we don't have one, and a `Print()` is wrapped around our function call. If the function actually returns a value, this gives an impression of working, since the correct result is printed - but we get an `AsciiArtString` instead of a `GapElement`. When the function does not return a value, the situation is even worse, since printing the result of a function which does not return a result results in an error (which is silently suppressed, and an empty string is returned).\n\nNow, it seems that we can't really solve this problem, since `last` is not updated when commands are read from a file. So I'd suggest this is how we deal with it:\n* If the command is short, evaluate it directly (one or two `eval`s, as in the latest commit).\n* If the command is long, we assign its result to a variable. This will of course cause an error if the function does not return a value - but such functions are few and it is much more likely that a (long) function does return a value.\n* When getting a variable, we make a direct call to `Expect._eval_line_using_file` if a file should be needed to avoid having two `Print`s and hence an error.\n\nThis problem has existed before this ticket was opened, so the cases when a temporary file is used are marginal at best. If you think it is OK, I can implement the above solution (or maybe someone else can do it, since I'll probably be busy in the following days).\n\nSecondly, `get_using_file` is indeed meant to use a file to read the results. So the code regarding `_get_using_file` should probably be left as it is (of course we can always set `_get_using_file`, so we don't need `try`/`except` blocks to check it), although the length of the input may be a poor predictor of the length of the output. Now, we should check whether getting with a file is actually faster with GAP than directly reading the output.\n\nJano\u0161",
    "created_at": "2015-11-19T23:49:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278980",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:28" align="right">comment:28</div>

Hello everybody!

It turns out that we still have some issues here.

Firstly, GAP function calls don't actually work when done through a temporary file, nor does getting a variable (which is essentially a `Print` call). The reason for this is that when `_eval_line_using_file` is called, it first looks for a `:=` token - if there is one, all is well; but since we are relying on `last`, we don't have one, and a `Print()` is wrapped around our function call. If the function actually returns a value, this gives an impression of working, since the correct result is printed - but we get an `AsciiArtString` instead of a `GapElement`. When the function does not return a value, the situation is even worse, since printing the result of a function which does not return a result results in an error (which is silently suppressed, and an empty string is returned).

Now, it seems that we can't really solve this problem, since `last` is not updated when commands are read from a file. So I'd suggest this is how we deal with it:
* If the command is short, evaluate it directly (one or two `eval`s, as in the latest commit).
* If the command is long, we assign its result to a variable. This will of course cause an error if the function does not return a value - but such functions are few and it is much more likely that a (long) function does return a value.
* When getting a variable, we make a direct call to `Expect._eval_line_using_file` if a file should be needed to avoid having two `Print`s and hence an error.

This problem has existed before this ticket was opened, so the cases when a temporary file is used are marginal at best. If you think it is OK, I can implement the above solution (or maybe someone else can do it, since I'll probably be busy in the following days).

Secondly, `get_using_file` is indeed meant to use a file to read the results. So the code regarding `_get_using_file` should probably be left as it is (of course we can always set `_get_using_file`, so we don't need `try`/`except` blocks to check it), although the length of the input may be a poor predictor of the length of the output. Now, we should check whether getting with a file is actually faster with GAP than directly reading the output.

Janoš



---

archive/issue_comments_278981.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nJust to confirm, all of the issues you noted are there before this change. If so, then let us open up a follow-up ticket for these issues and get this into Sage as is. We don't need to fix everything all in one ticket.",
    "created_at": "2015-11-20T18:38:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278981",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:29" align="right">comment:29</div>

Just to confirm, all of the issues you noted are there before this change. If so, then let us open up a follow-up ticket for these issues and get this into Sage as is. We don't need to fix everything all in one ticket.



---

archive/issue_comments_278982.json:
```json
{
    "body": "Changed branch from **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)** to **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)**",
    "created_at": "2015-11-20T21:33:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278982",
    "user": "https://github.com/jaanos"
}
```

Changed branch from **[u/jaanos/improve_calling_gap_function-19585](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_calling_gap_function-19585)** to **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)**



---

archive/issue_events_274938.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-20T21:40:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274938"
}
```



---

archive/issue_events_274939.json:
```json
{
    "actor": "https://github.com/jaanos",
    "created_at": "2015-11-20T21:40:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274939"
}
```



---

archive/issue_comments_278983.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nOK, I have removed the latest commit since it introduces some unneeded and erroneous code. Now we're back to where we've been at comment [comment:23], with a doctest failing. I'll open a new ticket shortly addressing this problem.",
    "created_at": "2015-11-20T21:40:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278983",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:31" align="right">comment:31</div>

OK, I have removed the latest commit since it introduces some unneeded and erroneous code. Now we're back to where we've been at comment [comment:23], with a doctest failing. I'll open a new ticket shortly addressing this problem.



---

archive/issue_comments_278984.json:
```json
{
    "body": "Changed commit from **[`31a173b`](https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d)** to **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)**",
    "created_at": "2015-11-20T21:40:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278984",
    "user": "https://github.com/jaanos"
}
```

Changed commit from **[`31a173b`](https://github.com/sagemath/sagetrac-mirror/commit/31a173bccd732cb8d8b656d6882dcec074a87b7d)** to **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)**



---

archive/issue_comments_278985.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThe other ticket is #19607, and I don't have the technical knowledge of that part of Sage to do a good review of that.\n\nHowever I have figured out the problem with [comment:23](#comment%3A23), and it is essentially what you wrote in [comment:28](#comment%3A28). I added the following right at the offending doctest:\n\n```\nsage: x.str()   # This is why it is returning True\n''\nsage: x._name   # Because this is making use the file\n'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'\nsage: gap(x._name)   # At least the variable is stored and retrieved correctly...\nfalse\n```\nSo we could likely to suppress this by doing another test with a shorter name being passed. I'm guessing we are somehow recycling variable names in the session, and we either shouldn't or will actually have to handle long variable names before this can get merged (possibly both too). I'm okay with suppressing with a note in the doctest referencing this issue. Anyone familiar with the interface have a better idea of what is going on?",
    "created_at": "2015-11-26T00:35:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278985",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:32" align="right">comment:32</div>

The other ticket is #19607, and I don't have the technical knowledge of that part of Sage to do a good review of that.

However I have figured out the problem with [comment:23](#comment%3A23), and it is essentially what you wrote in [comment:28](#comment%3A28). I added the following right at the offending doctest:

```
sage: x.str()   # This is why it is returning True
''
sage: x._name   # Because this is making use the file
'a_variable_with_a_name_so_very_very_very_long_that_even_by_itself_will_make_expect_use_a_file'
sage: gap(x._name)   # At least the variable is stored and retrieved correctly...
false
```
So we could likely to suppress this by doing another test with a shorter name being passed. I'm guessing we are somehow recycling variable names in the session, and we either shouldn't or will actually have to handle long variable names before this can get merged (possibly both too). I'm okay with suppressing with a note in the doctest referencing this issue. Anyone familiar with the interface have a better idea of what is going on?



---

archive/issue_comments_278986.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nIndeed, variable names are being recycled, so simply doing another test with a shorter variable name will probably result in another doctest failing (and even if it doesn't, it may in the future). So I guess the right thing to do would be to do the long variable name doctests in a separate GAP session.",
    "created_at": "2015-11-26T11:50:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278986",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:33" align="right">comment:33</div>

Indeed, variable names are being recycled, so simply doing another test with a shorter variable name will probably result in another doctest failing (and even if it doesn't, it may in the future). So I guess the right thing to do would be to do the long variable name doctests in a separate GAP session.



---

archive/issue_comments_278987.json:
```json
{
    "body": "Changed commit from **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)** to **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**",
    "created_at": "2015-11-26T12:21:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278987",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`086af29`](https://github.com/sagemath/sagetrac-mirror/commit/086af29b0632d16e097da3f042a7656417fa517c)** to **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**



---

archive/issue_comments_278988.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef\"><code>5fba891</code></a></td><td><code>Fix the doctests so that long variable names are only used in a separate GAP session</code></td></tr></table>\n",
    "created_at": "2015-11-26T12:21:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278988",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef"><code>5fba891</code></a></td><td><code>Fix the doctests so that long variable names are only used in a separate GAP session</code></td></tr></table>




---

archive/issue_comments_278989.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nOK, done. Can anyone look at #19607? (I have included the latest commit there to avoid conflicts.",
    "created_at": "2015-11-26T12:53:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278989",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:35" align="right">comment:35</div>

OK, done. Can anyone look at #19607? (I have included the latest commit there to avoid conflicts.



---

archive/issue_comments_278990.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nOkay, LGTM. Thanks.",
    "created_at": "2015-11-27T02:52:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278990",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:36" align="right">comment:36</div>

Okay, LGTM. Thanks.



---

archive/issue_events_274940.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2015-11-27T02:52:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274940"
}
```



---

archive/issue_events_274941.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2015-11-27T02:52:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274941"
}
```



---

archive/issue_comments_278991.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nI see that this has now been merged into the `develop` branch. Thanks everyone!",
    "created_at": "2015-11-28T09:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278991",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:37" align="right">comment:37</div>

I see that this has now been merged into the `develop` branch. Thanks everyone!



---

archive/issue_comments_278992.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI hope that you are wrong, as otherwise the ticket should be marked as 'closed'.",
    "created_at": "2015-11-28T09:22:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278992",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:38" align="right">comment:38</div>

I hope that you are wrong, as otherwise the ticket should be marked as 'closed'.



---

archive/issue_comments_278993.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nYes, I'd expect it to be marked as closed too, but I see that it has been merged (just missing the latest beta, though):\n\nhttps://github.com/vbraun/sage/commits/develop\n\nThe other three tickets merged after the latest beta are still 'positive_review', too.",
    "created_at": "2015-11-28T11:36:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278993",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:39" align="right">comment:39</div>

Yes, I'd expect it to be marked as closed too, but I see that it has been merged (just missing the latest beta, though):

https://github.com/vbraun/sage/commits/develop

The other three tickets merged after the latest beta are still 'positive_review', too.



---

archive/issue_comments_278994.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nOh I see. That's the repository that Volker uses to work on the betas, but that's not released yet. Several commits below the one of this ticket, you see the 'Updated Sage version' commit that marks where the last release goes.\n\nNathann",
    "created_at": "2015-11-28T11:40:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278994",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:40" align="right">comment:40</div>

Oh I see. That's the repository that Volker uses to work on the betas, but that's not released yet. Several commits below the one of this ticket, you see the 'Updated Sage version' commit that marks where the last release goes.

Nathann



---

archive/issue_comments_278995.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nYou shouldn't be looking at my repo, that is just what is being tested on the buildbot. Just because its being tested doesn't mean that its ever going to be merged ;-)",
    "created_at": "2015-11-28T12:01:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278995",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:41" align="right">comment:41</div>

You shouldn't be looking at my repo, that is just what is being tested on the buildbot. Just because its being tested doesn't mean that its ever going to be merged ;-)



---

archive/issue_comments_278996.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nOh, I see:) Thanks for the clarification.",
    "created_at": "2015-11-28T13:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278996",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:42" align="right">comment:42</div>

Oh, I see:) Thanks for the clarification.



---

archive/issue_events_274942.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-28T13:46:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274942"
}
```



---

archive/issue_events_274943.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5e4378ca6b11398d95abdd81b35ae9d799027a6e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-11-28T13:46:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19585#event-274943"
}
```



---

archive/issue_comments_278997.json:
```json
{
    "body": "Changed branch from **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)** to **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**",
    "created_at": "2015-11-28T13:46:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278997",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jaanos/improve_efficiency_of_calling_gap_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/jaanos/improve_efficiency_of_calling_gap_functions)** to **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)**



---

archive/issue_comments_278998.json:
```json
{
    "body": "Changed commit from **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)** to none",
    "created_at": "2015-11-28T14:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278998",
    "user": "https://github.com/jaanos"
}
```

Changed commit from **[`5fba891`](https://github.com/sagemath/sagetrac-mirror/commit/5fba891a391e2b345842bf07e1be5b8d91283fef)** to none



---

archive/issue_comments_278999.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nOK, now it really is merged:) Thanks again!",
    "created_at": "2015-11-28T14:05:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19585",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19585#issuecomment-278999",
    "user": "https://github.com/jaanos"
}
```

<div id="comment:44" align="right">comment:44</div>

OK, now it really is merged:) Thanks again!
