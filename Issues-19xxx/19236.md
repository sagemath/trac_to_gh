# Issue 19236: Lock mirror_list file in MirrorList.__init__

archive/issues_018999.json:
```json
{
    "body": "When building in parallel and the local `mirror_list` file is not up-to-date, running `make` will start updating the `mirror_list` many times in parallel. Solve this by locking the `mirror_list` file. This will also fix potential race conditions in reading/writing the `mirror_list` file.\n\n**CC:**  @vbraun\n\n**Branch/Commit:** [1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)\n\n**Reviewer:** Volker Braun\n\n**Author:** Jeroen Demeyer\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19236\n\n",
    "closed_at": "2015-09-18T19:10:37Z",
    "created_at": "2015-09-18T07:42:14Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Lock mirror_list file in MirrorList.__init__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19236",
    "user": "https://github.com/jdemeyer"
}
```
When building in parallel and the local `mirror_list` file is not up-to-date, running `make` will start updating the `mirror_list` many times in parallel. Solve this by locking the `mirror_list` file. This will also fix potential race conditions in reading/writing the `mirror_list` file.

**CC:**  @vbraun

**Branch/Commit:** [1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)

**Reviewer:** Volker Braun

**Author:** Jeroen Demeyer

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/19236





---

archive/issue_comments_347374.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__)",
    "created_at": "2015-09-18T09:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347374",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__)



---

archive/issue_comments_347375.json:
```json
{
    "body": "<a id='comment:2'></a>\nNot all network file systems support locking, in which case this will fail with ENOLCK. E.g. nfs, depending on version & configuration. \n\nThe most portable solution would be https://github.com/openstack/pylockfile/blob/master/lockfile/mkdirlockfile.py\n\nJust ignoring ENOLCK is probably good enough.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e\">541fd96</a></td><td><code>Lock the mirror_list file</code></td></tr></table>\n",
    "created_at": "2015-09-18T10:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347375",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
Not all network file systems support locking, in which case this will fail with ENOLCK. E.g. nfs, depending on version & configuration. 

The most portable solution would be https://github.com/openstack/pylockfile/blob/master/lockfile/mkdirlockfile.py

Just ignoring ENOLCK is probably good enough.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e">541fd96</a></td><td><code>Lock the mirror_list file</code></td></tr></table>




---

archive/issue_comments_347376.json:
```json
{
    "body": "**Commit:** [541fd96f35f145fc0707b1537adcb3151db3fd1e](https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e)",
    "created_at": "2015-09-18T10:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347376",
    "user": "https://github.com/vbraun"
}
```

**Commit:** [541fd96f35f145fc0707b1537adcb3151db3fd1e](https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e)



---

archive/issue_comments_347377.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [vbraun](#comment%3A2):\n> Not all network file systems support locking, in which case this will fail with ENOLCK. E.g. nfs, depending on version & configuration.\n\n\nOn museum kernels maybe :-)",
    "created_at": "2015-09-18T10:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347377",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Replying to [vbraun](#comment%3A2):
> Not all network file systems support locking, in which case this will fail with ENOLCK. E.g. nfs, depending on version & configuration.


On museum kernels maybe :-)



---

archive/issue_comments_347378.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939\">c624b3a</a></td><td><code>Wrap locking in a try/except statement</code></td></tr></table>\n",
    "created_at": "2015-09-18T10:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939">c624b3a</a></td><td><code>Wrap locking in a try/except statement</code></td></tr></table>




---

archive/issue_comments_347379.json:
```json
{
    "body": "**Changing commit** from \"[541fd96f35f145fc0707b1537adcb3151db3fd1e](https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e)\" to \"[c624b3a97056098b2ba86bbdf035b3a91d441939](https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939)\".",
    "created_at": "2015-09-18T10:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[541fd96f35f145fc0707b1537adcb3151db3fd1e](https://github.com/sagemath/sagetrac-mirror/commit/541fd96f35f145fc0707b1537adcb3151db3fd1e)" to "[c624b3a97056098b2ba86bbdf035b3a91d441939](https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939)".



---

archive/issue_comments_347380.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6\">1b0e767</a></td><td><code>Wrap all file operations inside \"with\" statement</code></td></tr></table>\n",
    "created_at": "2015-09-18T10:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6">1b0e767</a></td><td><code>Wrap all file operations inside "with" statement</code></td></tr></table>




---

archive/issue_comments_347381.json:
```json
{
    "body": "**Changing commit** from \"[c624b3a97056098b2ba86bbdf035b3a91d441939](https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939)\" to \"[1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)\".",
    "created_at": "2015-09-18T10:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347381",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[c624b3a97056098b2ba86bbdf035b3a91d441939](https://github.com/sagemath/sagetrac-mirror/commit/c624b3a97056098b2ba86bbdf035b3a91d441939)" to "[1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)".



---

archive/issue_comments_347382.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2015-09-18T11:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347382",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_347383.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2015-09-18T12:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347383",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_347384.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2015-09-18T12:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347384",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_347385.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2015-09-18T19:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347385",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_060675.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-18T19:10:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19236#event-60675"
}
```



---

archive/issue_comments_347386.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__)\" to \"[1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)\".",
    "created_at": "2015-09-18T19:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19236#issuecomment-347386",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/lock_mirror_list_file_in_mirrorlist___init__)" to "[1b0e76717e250fef5db10e13689427005f1db2f6](https://github.com/sagemath/sagetrac-mirror/commit/1b0e76717e250fef5db10e13689427005f1db2f6)".
