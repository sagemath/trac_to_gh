# Issue 19523: Raise an error when constraints are added to the wrong MILP

archive/issues_019286.json:
```json
{
    "body": "```\nsage: p = MixedIntegerLinearProgram(solver=\"glpk\")\nsage: q = MixedIntegerLinearProgram(solver=\"glpk\")\nsage: q.add_constraint(p[0] <= 1)\n---------------------------------------------------------------------------\nGLPKError                                 Traceback (most recent call last)\n...\nGLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length \nError detected in file glpapi01.c at line 760\n```\nBefore #19525, this would instead crash Sage. A crash still happens with COIN (#20360).\n\nThis ticket is to actually fix the error completely or give a better error message.\n\nAnd low-level error message with the PPL and InteractiveLP (#20296 ) backends.\n\nThe CVX backend silently adds a new variable that is accessible only to the backend:.\n\n```\nsage: sage: default_mip_solver(\"cvxopt\")\nsage: sage: p = MixedIntegerLinearProgram()\nsage: sage: q = MixedIntegerLinearProgram()\nsage: sage: q.add_constraint(p[0] <= 1)\nsage: q.number_of_variables()\n1\n```\n\nCC:  @yuan-zhou\n\nIssue created by migration from https://trac.sagemath.org/ticket/19523\n\n",
    "created_at": "2015-11-04T16:10:26Z",
    "labels": [
        "component: linear programming",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Raise an error when constraints are added to the wrong MILP",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19523",
    "user": "https://github.com/jdemeyer"
}
```
```
sage: p = MixedIntegerLinearProgram(solver="glpk")
sage: q = MixedIntegerLinearProgram(solver="glpk")
sage: q.add_constraint(p[0] <= 1)
---------------------------------------------------------------------------
GLPKError                                 Traceback (most recent call last)
...
GLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length 
Error detected in file glpapi01.c at line 760
```
Before #19525, this would instead crash Sage. A crash still happens with COIN (#20360).

This ticket is to actually fix the error completely or give a better error message.

And low-level error message with the PPL and InteractiveLP (#20296 ) backends.

The CVX backend silently adds a new variable that is accessible only to the backend:.

```
sage: sage: default_mip_solver("cvxopt")
sage: sage: p = MixedIntegerLinearProgram()
sage: sage: q = MixedIntegerLinearProgram()
sage: sage: q.add_constraint(p[0] <= 1)
sage: q.number_of_variables()
1
```

CC:  @yuan-zhou

Issue created by migration from https://trac.sagemath.org/ticket/19523





---

archive/issue_comments_264538.json:
```json
{
    "body": "<a id='comment:4'></a>While `MIPVariable` objects know which MIP they belong to,\ntheir \"components\" gotten by `p[0]` etc. are elements of `LinearFunctionsParent(base_ring)`, and do not remember their MIP (nor even their name).\nSo with the current design it does not seem possible to catch the error of adding constraints to the wrong MIP. \nSo unfortunately only lower-level error checking, catching out-of-bounds indices, is possible.",
    "created_at": "2016-03-31T02:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264538",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>While `MIPVariable` objects know which MIP they belong to,
their "components" gotten by `p[0]` etc. are elements of `LinearFunctionsParent(base_ring)`, and do not remember their MIP (nor even their name).
So with the current design it does not seem possible to catch the error of adding constraints to the wrong MIP. 
So unfortunately only lower-level error checking, catching out-of-bounds indices, is possible.



---

archive/issue_comments_264539.json:
```json
{
    "body": "<a id='comment:6'></a>Given that `p[0]` is just a linear function, it would make the most sense if `q.add_constraint(p[0] <= 1)` would simply work, not give an error message.",
    "created_at": "2016-03-31T06:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264539",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Given that `p[0]` is just a linear function, it would make the most sense if `q.add_constraint(p[0] <= 1)` would simply work, not give an error message.



---

archive/issue_comments_264540.json:
```json
{
    "body": "<a id='comment:7'></a>No, q has no variables at this point.",
    "created_at": "2016-03-31T06:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264540",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>No, q has no variables at this point.



---

archive/issue_comments_264541.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:\n> No, q has no variables at this point.\n\n\nThat's exactly my point: the variables should be added by `q.add_constraint()`.",
    "created_at": "2016-03-31T07:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264541",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:
> No, q has no variables at this point.


That's exactly my point: the variables should be added by `q.add_constraint()`.



---

archive/issue_comments_264542.json:
```json
{
    "body": "<a id='comment:9'></a>I'm not sure that this would be a good interface. It would allow to add variables, but only variables with default settings (continuous, lower bound 0, no upper bound, no name). \nI think it's better to raise an error, which could help spot programming mistakes -- at least when there's a dimension mismatch between the two problems. \nThis bound checking should be done by the backends -- see #10232.",
    "created_at": "2016-03-31T20:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264542",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>I'm not sure that this would be a good interface. It would allow to add variables, but only variables with default settings (continuous, lower bound 0, no upper bound, no name). 
I think it's better to raise an error, which could help spot programming mistakes -- at least when there's a dimension mismatch between the two problems. 
This bound checking should be done by the backends -- see #10232.



---

archive/issue_comments_264543.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 mkoeppe]:\n> at least when there's a dimension mismatch between the two problems.\n\n\nNo. It should be always an error, or never an error. If it's only an error \"when there's a dimension mismatch between the two problems\", that will be more confusing than either extreme.",
    "created_at": "2016-04-01T19:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264543",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Replying to [comment:9 mkoeppe]:
> at least when there's a dimension mismatch between the two problems.


No. It should be always an error, or never an error. If it's only an error "when there's a dimension mismatch between the two problems", that will be more confusing than either extreme.



---

archive/issue_comments_264544.json:
```json
{
    "body": "<a id='comment:11'></a>Then I strongly prefer to always raise an error in this situation. This requires changes to `LinearFunction` (a class that is I think only used in the context of `MixedIntegerLinearProgram`), so that it remembers the MIP that it relates to.\n\nThe mapping from MIP variables (and their indexed components) to integer indices (designating backend columns) is determined dynamically, adding a backend column when a MIP variable component is accessed.\nBecause of this there's simply no good way to write correct code that interchanges MIP variables between two `MixedIntegerLinearProgram`s, or to use `LinearFunction`s directly somehow (without referring to the correct MIP's variables).",
    "created_at": "2016-04-01T22:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264544",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Then I strongly prefer to always raise an error in this situation. This requires changes to `LinearFunction` (a class that is I think only used in the context of `MixedIntegerLinearProgram`), so that it remembers the MIP that it relates to.

The mapping from MIP variables (and their indexed components) to integer indices (designating backend columns) is determined dynamically, adding a backend column when a MIP variable component is accessed.
Because of this there's simply no good way to write correct code that interchanges MIP variables between two `MixedIntegerLinearProgram`s, or to use `LinearFunction`s directly somehow (without referring to the correct MIP's variables).



---

archive/issue_comments_264545.json:
```json
{
    "body": "<a id='comment:13'></a>Since the crashes are now on separate tickets, I have changed the title of this ticket.",
    "created_at": "2016-04-05T21:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264545",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Since the crashes are now on separate tickets, I have changed the title of this ticket.



---

archive/issue_comments_264546.json:
```json
{
    "body": "<a id='comment:14'></a>See also #15159, which raises a similar question when `q` started out as a copy of `p`.",
    "created_at": "2016-04-17T00:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264546",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>See also #15159, which raises a similar question when `q` started out as a copy of `p`.



---

archive/issue_comments_264547.json:
```json
{
    "body": "<a id='comment:15'></a>A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.",
    "created_at": "2016-06-27T03:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264547",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.



---

archive/issue_events_053793.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-06-27T03:16:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19523#event-53793"
}
```



---

archive/issue_comments_264548.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:15 mkoeppe]:\n> A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.\n\nIn contrast the example in the ticket description, no error is raised in the following examples, which is very confusing. \n\n```\nsage: p = MixedIntegerLinearProgram(solver=\"glpk\")                              \nsage: q = MixedIntegerLinearProgram(solver=\"glpk\")                              \nsage: v = q.new_variable()                                                      \nsage: q.add_constraint(v[0] <= 1)\n```\n\nand \n\n```\nsage: p = MixedIntegerLinearProgram(solver='InteractiveLP')                     \nsage: v = p.new_variable()                                                      \nsage: x,y = v[0], v[1]                                                          \nsage: pp = MixedIntegerLinearProgram(solver='InteractiveLP')                    \nsage: vv = pp.new_variable()                                                    \nsage: xx,yy = vv[0], vv[1]                                                      \nsage: p.add_constraint(x + y, max = 10)                                         \nsage: p.add_constraint(xx + 3*yy, max = 15)                                     \nsage: p.set_objective(x + 3*y)                                                  \nsage: p.solve()                                                                 \n15\nsage: p.show()                                                                  \nMaximization:\n  x1 + 3 x2 \n\nConstraints:\n  x1 + x2 <= 10\n  x1 + 3 x2 <= 15\nVariables:\n  x1 = x_0 is a continuous variable (min=-oo, max=+oo)\n  x2 = x_1 is a continuous variable (min=-oo, max=+oo)\n```\n\nIt would be nice to have `LinearFunctionsParent` etc. remember its MIP.",
    "created_at": "2021-02-01T04:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19523#issuecomment-264548",
    "user": "https://github.com/yuan-zhou"
}
```

<a id='comment:19'></a>Replying to [comment:15 mkoeppe]:
> A solution could be to change `LinearFunctionsParent` etc. so that it not only has remembers the `base_ring` but also the MIP.

In contrast the example in the ticket description, no error is raised in the following examples, which is very confusing. 

```
sage: p = MixedIntegerLinearProgram(solver="glpk")                              
sage: q = MixedIntegerLinearProgram(solver="glpk")                              
sage: v = q.new_variable()                                                      
sage: q.add_constraint(v[0] <= 1)
```

and 

```
sage: p = MixedIntegerLinearProgram(solver='InteractiveLP')                     
sage: v = p.new_variable()                                                      
sage: x,y = v[0], v[1]                                                          
sage: pp = MixedIntegerLinearProgram(solver='InteractiveLP')                    
sage: vv = pp.new_variable()                                                    
sage: xx,yy = vv[0], vv[1]                                                      
sage: p.add_constraint(x + y, max = 10)                                         
sage: p.add_constraint(xx + 3*yy, max = 15)                                     
sage: p.set_objective(x + 3*y)                                                  
sage: p.solve()                                                                 
15
sage: p.show()                                                                  
Maximization:
  x1 + 3 x2 

Constraints:
  x1 + x2 <= 10
  x1 + 3 x2 <= 15
Variables:
  x1 = x_0 is a continuous variable (min=-oo, max=+oo)
  x2 = x_1 is a continuous variable (min=-oo, max=+oo)
```

It would be nice to have `LinearFunctionsParent` etc. remember its MIP.
