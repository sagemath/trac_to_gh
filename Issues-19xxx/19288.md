# Issue 19288: Make real/complex number field embeddings more accurate

archive/issues_019051.json:
```json
{
    "body": "We should detect and work around this catastrophic cancellation:\n\n```\nsage: K.<a> = NumberField(x^2-x-104)\nsage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152\nsage: [v(D) for v in K.embeddings(RR)]\n[0.000000000000000, -9.70868378243995e40]\n```\n\nThis is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.\n\nNote: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.\n\nNote 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.\n\n**CC:**  @JohnCremona @jdemeyer\n\n**Branch:** [u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate)\n\n**Commit:** [9f802de8a19c1bbddec08689a75c42eb8d43c7d0](https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0)\n\n**Author:** Jeroen Demeyer\n\n**Dependencies:** #19330, #19361, #19362, #19356\n\nIssue created by migration from https://trac.sagemath.org/ticket/19288\n\n",
    "created_at": "2015-09-24T21:03:17Z",
    "labels": [
        "component: number fields",
        "minor",
        "enhancement",
        "needs work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.9",
    "title": "Make real/complex number field embeddings more accurate",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/19288",
    "user": "https://github.com/pjbruin"
}
```
We should detect and work around this catastrophic cancellation:

```
sage: K.<a> = NumberField(x^2-x-104)
sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152
sage: [v(D) for v in K.embeddings(RR)]
[0.000000000000000, -9.70868378243995e40]
```

This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.

Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.

Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.

**CC:**  @JohnCremona @jdemeyer

**Branch:** [u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate)

**Commit:** [9f802de8a19c1bbddec08689a75c42eb8d43c7d0](https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0)

**Author:** Jeroen Demeyer

**Dependencies:** #19330, #19361, #19362, #19356

Issue created by migration from https://trac.sagemath.org/ticket/19288





---

archive/issue_comments_276027.json:
```json
{
    "body": "**Dependencies:** #19276",
    "created_at": "2015-09-24T21:12:26Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276027",
    "user": "https://github.com/pjbruin"
}
```

**Dependencies:** #19276



---

archive/issue_comments_276028.json:
```json
{
    "body": "<a id='comment:2'></a>\nI don't see the point of adding a method to compute `log |emb(x)|` in a special way. Why not just fix `emb(x)` itself?",
    "created_at": "2015-09-25T08:28:21Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276028",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
I don't see the point of adding a method to compute `log |emb(x)|` in a special way. Why not just fix `emb(x)` itself?



---

archive/issue_comments_276029.json:
```json
{
    "body": "**Changing dependencies** from \"#19276\" to \"\".",
    "created_at": "2015-09-25T18:55:30Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276029",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#19276" to "".



---

archive/issue_comments_276030.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis is independent of #19276.",
    "created_at": "2015-09-25T18:55:30Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276030",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
This is independent of #19276.



---

archive/issue_comments_276031.json:
```json
{
    "body": "<a id='comment:4'></a>\nHere is a concrete proposal:\n\nsubclass `NumberFieldHomomorphism_im_gens` with a new class `NumberFieldRealComplexEmbedding` for embeddings of number fields into `RR` or `CC`. The implementation can be close to [comment:12:ticket:19276] but more efficient.",
    "created_at": "2015-09-25T19:11:02Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Here is a concrete proposal:

subclass `NumberFieldHomomorphism_im_gens` with a new class `NumberFieldRealComplexEmbedding` for embeddings of number fields into `RR` or `CC`. The implementation can be close to [comment:12:ticket:19276] but more efficient.



---

archive/issue_comments_276032.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2015-10-01T11:46:44Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276032",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_276033.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-It would be useful to have a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` returns log |emb(x)|, increasing the precision of emb as needed, and raises an error if x = 0.\n+\n``````\n",
    "created_at": "2015-10-01T11:46:44Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276033",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-It would be useful to have a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` returns log |emb(x)|, increasing the precision of emb as needed, and raises an error if x = 0.
+
``````




---

archive/issue_events_173659.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-01T11:46:44Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "rename": {
        "from": "Method logabs() for number field elements",
        "to": "Make real/complex number field embeddings more accurate"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173659"
}
```



---

archive/issue_comments_276034.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,8 @@\n+We should detect and work around this catastrophic cancellation:\n \n+```\n+sage: K.<a> = NumberField(x^2-x-104)\n+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152\n+sage: [v(D) for v in K.embeddings(RR)]\n+[0.000000000000000, -9.70868378243995e40]\n+```\n``````\n",
    "created_at": "2015-10-01T12:03:29Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276034",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,8 @@
+We should detect and work around this catastrophic cancellation:
 
+```
+sage: K.<a> = NumberField(x^2-x-104)
+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152
+sage: [v(D) for v in K.embeddings(RR)]
+[0.000000000000000, -9.70868378243995e40]
+```
``````




---

archive/issue_comments_276035.json:
```json
{
    "body": "<a id='comment:7'></a>\nI don't completely agree with re-purposing this ticket.  In my opinion a method `logabs()` would still be useful.  It should implement *x* \u21a6 log |*x*|<sub>v</sub> for any place *v*: either an Archimedean place defined by a real or complex embedding, or a non-Archimedean place defined by a prime ideal of the ring of integers.  For Archimedean places it would do this by simply computing the embedding to sufficient precision and then taking the logarithm of the absolute value.  For non-Archimedean places it should return `-x.valuation(p) * RR(p.norm()).log()`, which would presumably be more efficient than `RR(p.norm()^-x.valuation(p)).log()`.\n\nAnyway, I'm not going to do that now, so I don't mind too much if this becomes the ticket for fixing the accuracy of real/complex embeddings.  Still, I would be in favour of having a `logabs()` method at some point (on a different ticket).",
    "created_at": "2015-10-01T13:26:02Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276035",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>
I don't completely agree with re-purposing this ticket.  In my opinion a method `logabs()` would still be useful.  It should implement *x* â†¦ log |*x*|<sub>v</sub> for any place *v*: either an Archimedean place defined by a real or complex embedding, or a non-Archimedean place defined by a prime ideal of the ring of integers.  For Archimedean places it would do this by simply computing the embedding to sufficient precision and then taking the logarithm of the absolute value.  For non-Archimedean places it should return `-x.valuation(p) * RR(p.norm()).log()`, which would presumably be more efficient than `RR(p.norm()^-x.valuation(p)).log()`.

Anyway, I'm not going to do that now, so I don't mind too much if this becomes the ticket for fixing the accuracy of real/complex embeddings.  Still, I would be in favour of having a `logabs()` method at some point (on a different ticket).



---

archive/issue_comments_276036.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [pbruin](#comment%3A7):\n> In my opinion a method `logabs()` would still be useful.\n\n\nOK, fine. However, since I thought the motivation for this was to fix #19276, I decided to re-purpose this ticket with a different fix for #19276.",
    "created_at": "2015-10-01T13:33:01Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276036",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Replying to [pbruin](#comment%3A7):
> In my opinion a method `logabs()` would still be useful.


OK, fine. However, since I thought the motivation for this was to fix #19276, I decided to re-purpose this ticket with a different fix for #19276.



---

archive/issue_comments_276037.json:
```json
{
    "body": "**Dependencies:** #19330",
    "created_at": "2015-10-01T21:43:47Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276037",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #19330



---

archive/issue_comments_276038.json:
```json
{
    "body": "**Changing dependencies** from \"#19330\" to \"#19330, #19333\".",
    "created_at": "2015-10-02T09:10:05Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276038",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#19330" to "#19330, #19333".



---

archive/issue_comments_276039.json:
```json
{
    "body": "**Changing dependencies** from \"#19330, #19333\" to \"#19330\".",
    "created_at": "2015-10-02T11:38:40Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276039",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#19330, #19333" to "#19330".



---

archive/issue_comments_276040.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate)",
    "created_at": "2015-10-02T13:10:06Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276040",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate)



---

archive/issue_events_173660.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-02T13:17:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173660"
}
```



---

archive/issue_comments_276041.json:
```json
{
    "body": "<a id='comment:13'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/048b036934efaefb3a4c38b8a5d0b90ff25dc995\">048b036</a></td><td><code>Implement conversion of interval fields to real/complex fields</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/752c401b852050c48186439a727040e3d81d90be\">752c401</a></td><td><code>Use the new conversions in qqbar</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c\">ceac430</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>\n",
    "created_at": "2015-10-02T13:17:48Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276041",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/048b036934efaefb3a4c38b8a5d0b90ff25dc995">048b036</a></td><td><code>Implement conversion of interval fields to real/complex fields</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/752c401b852050c48186439a727040e3d81d90be">752c401</a></td><td><code>Use the new conversions in qqbar</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c">ceac430</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>




---

archive/issue_comments_276042.json:
```json
{
    "body": "**Commit:** [ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c](https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c)",
    "created_at": "2015-10-02T13:17:48Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276042",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c](https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c)



---

archive/issue_comments_276043.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,3 +6,9 @@\n sage: [v(D) for v in K.embeddings(RR)]\n [0.000000000000000, -9.70868378243995e40]\n ```\n+\n+This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.\n+\n+Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.\n+\n+Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.\n``````\n",
    "created_at": "2015-10-02T13:25:20Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276043",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,3 +6,9 @@
 sage: [v(D) for v in K.embeddings(RR)]
 [0.000000000000000, -9.70868378243995e40]
 ```
+
+This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.
+
+Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.
+
+Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.
``````




---

archive/issue_comments_276044.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7\">8f0d8ae</a></td><td><code>Fix for old pickles</code></td></tr></table>\n",
    "created_at": "2015-10-02T13:34:03Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276044",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7">8f0d8ae</a></td><td><code>Fix for old pickles</code></td></tr></table>




---

archive/issue_comments_276045.json:
```json
{
    "body": "**Changing commit** from \"[ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c](https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c)\" to \"[8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7](https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7)\".",
    "created_at": "2015-10-02T13:34:03Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276045",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c](https://github.com/sagemath/sagetrac-mirror/commit/ceac4303d2c1c3a6feaf4a7508e25d79d2dc578c)" to "[8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7](https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7)".



---

archive/issue_comments_276046.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034\">a987fd2</a></td><td><code>Minor fixes</code></td></tr></table>\n",
    "created_at": "2015-10-04T10:48:19Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276046",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034">a987fd2</a></td><td><code>Minor fixes</code></td></tr></table>




---

archive/issue_comments_276047.json:
```json
{
    "body": "**Changing commit** from \"[8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7](https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7)\" to \"[a987fd28c715d09ac3373710120bb8cec5bf4034](https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034)\".",
    "created_at": "2015-10-04T10:48:19Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7](https://github.com/sagemath/sagetrac-mirror/commit/8f0d8ae7bbf19aa9bffc8a5fb43868811e8157f7)" to "[a987fd28c715d09ac3373710120bb8cec5bf4034](https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034)".



---

archive/issue_comments_276048.json:
```json
{
    "body": "<a id='comment:17'></a>\nThanks for all the great work on this which I have not been able to follow as I was at a workshop last week.\nI think there will be other places where this functionality will be useful -- for examples, computation of periods and elliptic logs, where the result depends on an embedding and what is stored is an embedding into AA or QQbar, only converted to a RealField or ComplexField with some precision when needed.",
    "created_at": "2015-10-04T15:18:42Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276048",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>
Thanks for all the great work on this which I have not been able to follow as I was at a workshop last week.
I think there will be other places where this functionality will be useful -- for examples, computation of periods and elliptic logs, where the result depends on an embedding and what is stored is an embedding into AA or QQbar, only converted to a RealField or ComplexField with some precision when needed.



---

archive/issue_comments_276049.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0\">5356407</a></td><td><code>Add doctests for __init__</code></td></tr></table>\n",
    "created_at": "2015-10-05T06:11:25Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276049",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0">5356407</a></td><td><code>Add doctests for __init__</code></td></tr></table>




---

archive/issue_comments_276050.json:
```json
{
    "body": "**Changing commit** from \"[a987fd28c715d09ac3373710120bb8cec5bf4034](https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034)\" to \"[53564075548514297b7dc8ceee5768cdd47eaab0](https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0)\".",
    "created_at": "2015-10-05T06:11:25Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a987fd28c715d09ac3373710120bb8cec5bf4034](https://github.com/sagemath/sagetrac-mirror/commit/a987fd28c715d09ac3373710120bb8cec5bf4034)" to "[53564075548514297b7dc8ceee5768cdd47eaab0](https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0)".



---

archive/issue_comments_276051.json:
```json
{
    "body": "<a id='comment:19'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a\">43ce520</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>\n",
    "created_at": "2015-10-05T15:28:15Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276051",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a">43ce520</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>




---

archive/issue_comments_276052.json:
```json
{
    "body": "**Changing commit** from \"[53564075548514297b7dc8ceee5768cdd47eaab0](https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0)\" to \"[43ce520bb6c486d5660ebf531aefae960de4921a](https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a)\".",
    "created_at": "2015-10-05T15:28:15Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276052",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[53564075548514297b7dc8ceee5768cdd47eaab0](https://github.com/sagemath/sagetrac-mirror/commit/53564075548514297b7dc8ceee5768cdd47eaab0)" to "[43ce520bb6c486d5660ebf531aefae960de4921a](https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a)".



---

archive/issue_comments_276053.json:
```json
{
    "body": "<a id='comment:20'></a>\nI moved part of this branch to #19351 and squashed the commits.",
    "created_at": "2015-10-05T15:28:57Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276053",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
I moved part of this branch to #19351 and squashed the commits.



---

archive/issue_events_173661.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-06T11:27:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173661"
}
```



---

archive/issue_events_173662.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-06T11:27:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173662"
}
```



---

archive/issue_comments_276054.json:
```json
{
    "body": "**Changing dependencies** from \"#19330\" to \"#19330, #19361, #19362, #19356\".",
    "created_at": "2015-10-06T11:27:43Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276054",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#19330" to "#19330, #19361, #19362, #19356".



---

archive/issue_comments_276055.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2049f5a4f3143479395827f1ab82c0a0b39089bc\">2049f5a</a></td><td><code>Move refine_root() to refine_root.pyx</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b34e49f73e7a0889d87aa43b26709c14e9b7492\">3b34e49</a></td><td><code>Improve refine_root()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41aaf04d4d6dd021a53038c9410f568cc8977958\">41aaf04</a></td><td><code>Allow approximate root in polynomial_root()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b1a5c59019196536760aef7ffb0a465ecfb2c515\">b1a5c59</a></td><td><code>Merge commit '41aaf04d4d6dd021a53038c9410f568cc8977958' into HEAD</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0\">9f802de</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>\n",
    "created_at": "2015-10-06T11:49:50Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276055",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2049f5a4f3143479395827f1ab82c0a0b39089bc">2049f5a</a></td><td><code>Move refine_root() to refine_root.pyx</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b34e49f73e7a0889d87aa43b26709c14e9b7492">3b34e49</a></td><td><code>Improve refine_root()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41aaf04d4d6dd021a53038c9410f568cc8977958">41aaf04</a></td><td><code>Allow approximate root in polynomial_root()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b1a5c59019196536760aef7ffb0a465ecfb2c515">b1a5c59</a></td><td><code>Merge commit '41aaf04d4d6dd021a53038c9410f568cc8977958' into HEAD</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0">9f802de</a></td><td><code>Make real/complex number field embeddings more accurate</code></td></tr></table>




---

archive/issue_comments_276056.json:
```json
{
    "body": "**Changing commit** from \"[43ce520bb6c486d5660ebf531aefae960de4921a](https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a)\" to \"[9f802de8a19c1bbddec08689a75c42eb8d43c7d0](https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0)\".",
    "created_at": "2015-10-06T11:49:50Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276056",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[43ce520bb6c486d5660ebf531aefae960de4921a](https://github.com/sagemath/sagetrac-mirror/commit/43ce520bb6c486d5660ebf531aefae960de4921a)" to "[9f802de8a19c1bbddec08689a75c42eb8d43c7d0](https://github.com/sagemath/sagetrac-mirror/commit/9f802de8a19c1bbddec08689a75c42eb8d43c7d0)".



---

archive/issue_comments_276057.json:
```json
{
    "body": "<a id='comment:23'></a>\nAgain simplified by moving some changes to #19356.",
    "created_at": "2015-10-06T11:50:42Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276057",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
Again simplified by moving some changes to #19356.



---

archive/issue_events_173663.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-06T12:04:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173663"
}
```



---

archive/issue_events_173664.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-10-06T12:04:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173664"
}
```



---

archive/issue_comments_276058.json:
```json
{
    "body": "<a id='comment:25'></a>\nDoes this really depend on #19362, which needs work?\nI would be really interested in having this improved functionality and would be willing to review the ticket (but #19362 seems a bit tricky as jdemeyer wrote that he does not remember what exactly needs to be done...).",
    "created_at": "2016-06-22T18:37:55Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276058",
    "user": "https://trac.sagemath.org/admin/accounts/users/ehlen"
}
```

<a id='comment:25'></a>
Does this really depend on #19362, which needs work?
I would be really interested in having this improved functionality and would be willing to review the ticket (but #19362 seems a bit tricky as jdemeyer wrote that he does not remember what exactly needs to be done...).



---

archive/issue_comments_276059.json:
```json
{
    "body": "<a id='comment:26'></a>\nAt least some of the commits on this ticket come from #19362 (in the sense that they are there too), but I don't see why that necessarily means that this ticket needs to wait for that one.  As long as all the changes in all the commits here are ok!\nI started all this with #19276, which thankfully was fixed and merged independently.  This and #19362 is one of those cases where well-meaning people wanted to make something perfect and not just good enough.",
    "created_at": "2016-06-22T22:23:34Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276059",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:26'></a>
At least some of the commits on this ticket come from #19362 (in the sense that they are there too), but I don't see why that necessarily means that this ticket needs to wait for that one.  As long as all the changes in all the commits here are ok!
I started all this with #19276, which thankfully was fixed and merged independently.  This and #19362 is one of those cases where well-meaning people wanted to make something perfect and not just good enough.



---

archive/issue_events_173665.json:
```json
{
    "actor": "https://github.com/cheuberg",
    "created_at": "2017-01-08T06:38:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173665"
}
```



---

archive/issue_events_173666.json:
```json
{
    "actor": "https://github.com/cheuberg",
    "created_at": "2017-01-08T06:38:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19288#event-173666"
}
```



---

archive/issue_comments_276060.json:
```json
{
    "body": "<a id='comment:27'></a>\ndoes not merge with 7.5.rc2",
    "created_at": "2017-01-08T06:38:04Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276060",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:27'></a>
does not merge with 7.5.rc2



---

archive/issue_comments_276061.json:
```json
{
    "body": "<a id='comment:28'></a>\nIt is a pity that this ticket and the related #19362 have been abandoned, since the issues they are trying to solve still cause problems: see #29666 which I have fixed using a different approach.  Perhaps the approach used there is more generally applicable, so for the record I'll say something about it here.\n\nRight now if you define an embedding (real, say) of a number field with some precision using K.embeddings(RealField(prec)) and then use the embedding to map individual number field elements, the images you get are in RealField(prec)  but can be very far from the correct values.  Instead you can get an accurate value by using refine_embedding (as it is in Sage 9.1.rc anyway) to refine the embedding to precision Infinity, which embedds into AA (or Qbar for a complex embedding), use that to map individual elements and then push them into RealField(prec) afterwards.  This seems to work pretty well and is robust, though of course it will be slower, thgough as long as the only operations you do on AA elements are +,-,* and not division, so testing for 0 is not required, that should not be a problem.",
    "created_at": "2020-05-11T11:17:58Z",
    "issue": "https://github.com/sagemath/sage/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19288#issuecomment-276061",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:28'></a>
It is a pity that this ticket and the related #19362 have been abandoned, since the issues they are trying to solve still cause problems: see #29666 which I have fixed using a different approach.  Perhaps the approach used there is more generally applicable, so for the record I'll say something about it here.

Right now if you define an embedding (real, say) of a number field with some precision using K.embeddings(RealField(prec)) and then use the embedding to map individual number field elements, the images you get are in RealField(prec)  but can be very far from the correct values.  Instead you can get an accurate value by using refine_embedding (as it is in Sage 9.1.rc anyway) to refine the embedding to precision Infinity, which embedds into AA (or Qbar for a complex embedding), use that to map individual elements and then push them into RealField(prec) afterwards.  This seems to work pretty well and is robust, though of course it will be slower, thgough as long as the only operations you do on AA elements are +,-,* and not division, so testing for 0 is not required, that should not be a problem.
