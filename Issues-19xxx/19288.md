# Issue 19288: Make real/complex number field embeddings more accurate

archive/issues_019051.json:
```json
{
    "body": "We should detect and work around this catastrophic cancellation:\n\n```\nsage: K.<a> = NumberField(x^2-x-104)\nsage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152\nsage: [v(D) for v in K.embeddings(RR)]\n[0.000000000000000, -9.70868378243995e40]\n```\n\nThis is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.\n\nNote: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.\n\nNote 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.\n\nCC:  @JohnCremona @jdemeyer\n\nAuthor: Jeroen Demeyer\n\nBranch: u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate\n\nStatus: needs_work\n\nDependencies: #19330, #19361, #19362, #19356\n\nCommit: 9f802de8a19c1bbddec08689a75c42eb8d43c7d0\n\nIssue created by migration from https://trac.sagemath.org/ticket/19288\n\n",
    "created_at": "2015-09-24T21:03:17Z",
    "labels": [
        "component: number fields",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Make real/complex number field embeddings more accurate",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19288",
    "user": "https://github.com/pjbruin"
}
```
We should detect and work around this catastrophic cancellation:

```
sage: K.<a> = NumberField(x^2-x-104)
sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152
sage: [v(D) for v in K.embeddings(RR)]
[0.000000000000000, -9.70868378243995e40]
```

This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.

Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.

Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.

CC:  @JohnCremona @jdemeyer

Author: Jeroen Demeyer

Branch: u/jdemeyer/make_real_complex_number_field_embeddings_more_accurate

Status: needs_work

Dependencies: #19330, #19361, #19362, #19356

Commit: 9f802de8a19c1bbddec08689a75c42eb8d43c7d0

Issue created by migration from https://trac.sagemath.org/ticket/19288





---

archive/issue_comments_278006.json:
```json
{
    "body": "<a id='comment:2'></a>I don't see the point of adding a method to compute `log |emb(x)|` in a special way. Why not just fix `emb(x)` itself?",
    "created_at": "2015-09-25T08:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278006",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>I don't see the point of adding a method to compute `log |emb(x)|` in a special way. Why not just fix `emb(x)` itself?



---

archive/issue_comments_278007.json:
```json
{
    "body": "<a id='comment:3'></a>This is independent of #19276.",
    "created_at": "2015-09-25T18:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278007",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>This is independent of #19276.



---

archive/issue_comments_278008.json:
```json
{
    "body": "<a id='comment:4'></a>Here is a concrete proposal:\n\nsubclass `NumberFieldHomomorphism_im_gens` with a new class `NumberFieldRealComplexEmbedding` for embeddings of number fields into `RR` or `CC`. The implementation can be close to [comment:12:ticket:19276] but more efficient.",
    "created_at": "2015-09-25T19:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278008",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Here is a concrete proposal:

subclass `NumberFieldHomomorphism_im_gens` with a new class `NumberFieldRealComplexEmbedding` for embeddings of number fields into `RR` or `CC`. The implementation can be close to [comment:12:ticket:19276] but more efficient.



---

archive/issue_comments_278009.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-It would be useful to have a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` returns log |emb(x)|, increasing the precision of emb as needed, and raises an error if x = 0.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2015-10-01T11:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278009",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-It would be useful to have a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` returns log |emb(x)|, increasing the precision of emb as needed, and raises an error if x = 0.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_278010.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n+We should detect and work around this catastrophic cancellation:\n \n+```\n+sage: K.<a> = NumberField(x^2-x-104)\n+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152\n+sage: [v(D) for v in K.embeddings(RR)]\n+[0.000000000000000, -9.70868378243995e40]\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2015-10-01T12:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278010",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,11 @@
+We should detect and work around this catastrophic cancellation:
 
+```
+sage: K.<a> = NumberField(x^2-x-104)
+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152
+sage: [v(D) for v in K.embeddings(RR)]
+[0.000000000000000, -9.70868378243995e40]
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_278011.json:
```json
{
    "body": "<a id='comment:7'></a>I don't completely agree with re-purposing this ticket.  In my opinion a method `logabs()` would still be useful.  It should implement *x* \u21a6 log |*x*|<sub>v</sub> for any place *v*: either an Archimedean place defined by a real or complex embedding, or a non-Archimedean place defined by a prime ideal of the ring of integers.  For Archimedean places it would do this by simply computing the embedding to sufficient precision and then taking the logarithm of the absolute value.  For non-Archimedean places it should return `-x.valuation(p) * RR(p.norm()).log()`, which would presumably be more efficient than `RR(p.norm()^-x.valuation(p)).log()`.\n\nAnyway, I'm not going to do that now, so I don't mind too much if this becomes the ticket for fixing the accuracy of real/complex embeddings.  Still, I would be in favour of having a `logabs()` method at some point (on a different ticket).",
    "created_at": "2015-10-01T13:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278011",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>I don't completely agree with re-purposing this ticket.  In my opinion a method `logabs()` would still be useful.  It should implement *x* â†¦ log |*x*|<sub>v</sub> for any place *v*: either an Archimedean place defined by a real or complex embedding, or a non-Archimedean place defined by a prime ideal of the ring of integers.  For Archimedean places it would do this by simply computing the embedding to sufficient precision and then taking the logarithm of the absolute value.  For non-Archimedean places it should return `-x.valuation(p) * RR(p.norm()).log()`, which would presumably be more efficient than `RR(p.norm()^-x.valuation(p)).log()`.

Anyway, I'm not going to do that now, so I don't mind too much if this becomes the ticket for fixing the accuracy of real/complex embeddings.  Still, I would be in favour of having a `logabs()` method at some point (on a different ticket).



---

archive/issue_comments_278012.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 pbruin]:\n> In my opinion a method `logabs()` would still be useful.\n\n\nOK, fine. However, since I thought the motivation for this was to fix #19276, I decided to re-purpose this ticket with a different fix for #19276.",
    "created_at": "2015-10-01T13:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278012",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 pbruin]:
> In my opinion a method `logabs()` would still be useful.


OK, fine. However, since I thought the motivation for this was to fix #19276, I decided to re-purpose this ticket with a different fix for #19276.



---

archive/issue_comments_278013.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-02T13:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278013",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278014.json:
```json
{
    "body": "<a id='comment:13'></a>New commits:",
    "created_at": "2015-10-02T13:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278014",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>New commits:



---

archive/issue_comments_278015.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,17 @@\n+We should detect and work around this catastrophic cancellation:\n \n+```\n+sage: K.<a> = NumberField(x^2-x-104)\n+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152\n+sage: [v(D) for v in K.embeddings(RR)]\n+[0.000000000000000, -9.70868378243995e40]\n+```\n+\n+This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.\n+\n+Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.\n+\n+Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.\n \n Comment: 1\n \n``````\n",
    "created_at": "2015-10-02T13:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278015",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,17 @@
+We should detect and work around this catastrophic cancellation:
 
+```
+sage: K.<a> = NumberField(x^2-x-104)
+sage: D = -4754362903238080086532729679384769785488*a - 46166237460580684378417136025570042177152
+sage: [v(D) for v in K.embeddings(RR)]
+[0.000000000000000, -9.70868378243995e40]
+```
+
+This is fixed by adding a new class `NumberFieldComplexEmbedding` (and also `NumberFieldRealEmbedding`) which automatically increases the precision when computing the image.
+
+Note: I also do some minor clean-up in this branch, like removing redundant methods (defined more than once in the same class) and cleaning up some imports.
+
+Note 2: When most of this patch was already written, I discovered there is a `NumberFieldEmbedding` in `src/sage/rings/number_field/number_field_morphisms.pyx` which seems to have the same purpose as my new class. I propose to deal with this redundancy later.
 
 Comment: 1
 
``````




---

archive/issue_comments_278016.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-02T13:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278017.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-04T10:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278017",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278018.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks for all the great work on this which I have not been able to follow as I was at a workshop last week.\nI think there will be other places where this functionality will be useful -- for examples, computation of periods and elliptic logs, where the result depends on an embedding and what is stored is an embedding into AA or QQbar, only converted to a RealField or ComplexField with some precision when needed.",
    "created_at": "2015-10-04T15:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278018",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>Thanks for all the great work on this which I have not been able to follow as I was at a workshop last week.
I think there will be other places where this functionality will be useful -- for examples, computation of periods and elliptic logs, where the result depends on an embedding and what is stored is an embedding into AA or QQbar, only converted to a RealField or ComplexField with some precision when needed.



---

archive/issue_comments_278019.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-05T06:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278019",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278020.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-10-05T15:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278020",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_278021.json:
```json
{
    "body": "<a id='comment:20'></a>I moved part of this branch to #19351 and squashed the commits.",
    "created_at": "2015-10-05T15:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278021",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>I moved part of this branch to #19351 and squashed the commits.



---

archive/issue_comments_278022.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-10-06T11:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278022",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_278023.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-10-06T11:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278023",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_278024.json:
```json
{
    "body": "<a id='comment:23'></a>Again simplified by moving some changes to #19356.",
    "created_at": "2015-10-06T11:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278024",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Again simplified by moving some changes to #19356.



---

archive/issue_comments_278025.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-10-06T12:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278025",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_278026.json:
```json
{
    "body": "<a id='comment:25'></a>Does this really depend on #19362, which needs work?\nI would be really interested in having this improved functionality and would be willing to review the ticket (but #19362 seems a bit tricky as jdemeyer wrote that he does not remember what exactly needs to be done...).",
    "created_at": "2016-06-22T18:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278026",
    "user": "https://trac.sagemath.org/admin/accounts/users/ehlen"
}
```

<a id='comment:25'></a>Does this really depend on #19362, which needs work?
I would be really interested in having this improved functionality and would be willing to review the ticket (but #19362 seems a bit tricky as jdemeyer wrote that he does not remember what exactly needs to be done...).



---

archive/issue_comments_278027.json:
```json
{
    "body": "<a id='comment:26'></a>At least some of the commits on this ticket come from #19362 (in the sense that they are there too), but I don't see why that necessarily means that this ticket needs to wait for that one.  As long as all the changes in all the commits here are ok!\nI started all this with #19276, which thankfully was fixed and merged independently.  This and #19362 is one of those cases where well-meaning people wanted to make something perfect and not just good enough.",
    "created_at": "2016-06-22T22:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278027",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:26'></a>At least some of the commits on this ticket come from #19362 (in the sense that they are there too), but I don't see why that necessarily means that this ticket needs to wait for that one.  As long as all the changes in all the commits here are ok!
I started all this with #19276, which thankfully was fixed and merged independently.  This and #19362 is one of those cases where well-meaning people wanted to make something perfect and not just good enough.



---

archive/issue_comments_278028.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-08T06:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278028",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_278029.json:
```json
{
    "body": "<a id='comment:27'></a>does not merge with 7.5.rc2",
    "created_at": "2017-01-08T06:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278029",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:27'></a>does not merge with 7.5.rc2



---

archive/issue_comments_278030.json:
```json
{
    "body": "<a id='comment:28'></a>It is a pity that this ticket and the related #19362 have been abandoned, since the issues they are trying to solve still cause problems: see #29666 which I have fixed using a different approach.  Perhaps the approach used there is more generally applicable, so for the record I'll say something about it here.\n\nRight now if you define an embedding (real, say) of a number field with some precision using K.embeddings(RealField(prec)) and then use the embedding to map individual number field elements, the images you get are in RealField(prec)  but can be very far from the correct values.  Instead you can get an accurate value by using refine_embedding (as it is in Sage 9.1.rc anyway) to refine the embedding to precision Infinity, which embedds into AA (or Qbar for a complex embedding), use that to map individual elements and then push them into RealField(prec) afterwards.  This seems to work pretty well and is robust, though of course it will be slower, thgough as long as the only operations you do on AA elements are +,-,* and not division, so testing for 0 is not required, that should not be a problem.",
    "created_at": "2020-05-11T11:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19288",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19288#issuecomment-278030",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:28'></a>It is a pity that this ticket and the related #19362 have been abandoned, since the issues they are trying to solve still cause problems: see #29666 which I have fixed using a different approach.  Perhaps the approach used there is more generally applicable, so for the record I'll say something about it here.

Right now if you define an embedding (real, say) of a number field with some precision using K.embeddings(RealField(prec)) and then use the embedding to map individual number field elements, the images you get are in RealField(prec)  but can be very far from the correct values.  Instead you can get an accurate value by using refine_embedding (as it is in Sage 9.1.rc anyway) to refine the embedding to precision Infinity, which embedds into AA (or Qbar for a complex embedding), use that to map individual elements and then push them into RealField(prec) afterwards.  This seems to work pretty well and is robust, though of course it will be slower, thgough as long as the only operations you do on AA elements are +,-,* and not division, so testing for 0 is not required, that should not be a problem.
