# Issue 19797: Disallow automatic abs() simplifications resulting non-real expressions

archive/issues_019560.json:
```json
{
    "body": "Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:\n\n```\nsage: abs(x^2)\nx*conjugate(x)\nsage: abs(x)^2\nx*conjugate(x)\n```\n\nIn the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n\nThis causes the following doctest failure:\n\n```\nsage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 11105, in sage.symbolic.expression.Expression._plot_fast_callable\nFailed example:\n    plot(s)\nExpected:\n    Graphics object consisting of 1 graphics primitive\nGot:\n    Graphics object consisting of 0 graphics primitives\n**********************************************************************\n```\n\nSee https://github.com/pynac/pynac/issues/117\n\nCC:  @rwst\n\nUpstream: Reported upstream. Developers acknowledge bug.\n\nReviewer: Jeroen Demeyer\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/19797\n\n",
    "closed_at": "2016-01-03T20:28:33Z",
    "created_at": "2015-12-29T10:15:31Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Disallow automatic abs() simplifications resulting non-real expressions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19797",
    "user": "https://github.com/jdemeyer"
}
```
Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:

```
sage: abs(x^2)
x*conjugate(x)
sage: abs(x)^2
x*conjugate(x)
```

In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.

This causes the following doctest failure:

```
sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 11105, in sage.symbolic.expression.Expression._plot_fast_callable
Failed example:
    plot(s)
Expected:
    Graphics object consisting of 1 graphics primitive
Got:
    Graphics object consisting of 0 graphics primitives
**********************************************************************
```

See https://github.com/pynac/pynac/issues/117

CC:  @rwst

Upstream: Reported upstream. Developers acknowledge bug.

Reviewer: Jeroen Demeyer

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/19797





---

archive/issue_comments_356257.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/19797\"",
    "created_at": "2015-12-29T12:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356257",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/19797"



---

archive/issue_comments_356258.json:
```json
{
    "body": "<a id='comment:2'></a>Isn't this sacrificing a lot of numerical performance? At least IEEE 754-2008 contains fused multiply-add.\n\nThe doctest is\n\n```\n            sage: x = var('x', domain='real')\n            sage: s = abs((1+I*x)^4); s\n            (I*x + 1)^2*(-I*x + 1)^2\n            sage: s._plot_fast_callable(x)\n            <sage.ext.interpreters.wrapper_py.Wrapper_py object at ...>\n            sage: s._plot_fast_callable(x)(10)\n            10201\n            sage: abs((I*10+1)^4)\n            10201\n            sage: plot(s)\n            Graphics object consisting of 1 graphics primitive\n```\nIsn't the real problem that abs does not default to `hold=True`\n\n```\nsage: ((1+I*x)^4).abs()\n(I*x + 1)^2*(-I*x + 1)^2\n```\nso something that ought to be manifestly real is not. Compare:\n\n```\nsage: abs((1+I*x)^4)._plot_fast_callable(x)(RDF(10))\n10201.00000000001\nsage: type(_)\n<type 'sage.rings.complex_double.ComplexDoubleElement'>\n```\nvs.\n\n```\nsage: ((1+I*x)^4).abs(hold=True)._plot_fast_callable(x)(RDF(10))\n10201.000000000005\nsage: type(_)\n<type 'sage.rings.real_double.RealDoubleElement'>\n```\n\n---\nNew commits:",
    "created_at": "2015-12-29T16:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356258",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>Isn't this sacrificing a lot of numerical performance? At least IEEE 754-2008 contains fused multiply-add.

The doctest is

```
            sage: x = var('x', domain='real')
            sage: s = abs((1+I*x)^4); s
            (I*x + 1)^2*(-I*x + 1)^2
            sage: s._plot_fast_callable(x)
            <sage.ext.interpreters.wrapper_py.Wrapper_py object at ...>
            sage: s._plot_fast_callable(x)(10)
            10201
            sage: abs((I*10+1)^4)
            10201
            sage: plot(s)
            Graphics object consisting of 1 graphics primitive
```
Isn't the real problem that abs does not default to `hold=True`

```
sage: ((1+I*x)^4).abs()
(I*x + 1)^2*(-I*x + 1)^2
```
so something that ought to be manifestly real is not. Compare:

```
sage: abs((1+I*x)^4)._plot_fast_callable(x)(RDF(10))
10201.00000000001
sage: type(_)
<type 'sage.rings.complex_double.ComplexDoubleElement'>
```
vs.

```
sage: ((1+I*x)^4).abs(hold=True)._plot_fast_callable(x)(RDF(10))
10201.000000000005
sage: type(_)
<type 'sage.rings.real_double.RealDoubleElement'>
```

---
New commits:



---

archive/issue_comments_356259.json:
```json
{
    "body": "Changing commit from \"\" to \"694feb2d71ebf521cf5f32dba69e0406d16e9f11\"",
    "created_at": "2015-12-29T16:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356259",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "" to "694feb2d71ebf521cf5f32dba69e0406d16e9f11"



---

archive/issue_comments_356260.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [vbraun](#comment%3A2):\n> Isn't this sacrificing a lot of numerical performance?\n\n\nI have no idea but I doubt it. For example, Intel architectures added this instruction only very recently.",
    "created_at": "2015-12-29T21:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356260",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Replying to [vbraun](#comment%3A2):
> Isn't this sacrificing a lot of numerical performance?


I have no idea but I doubt it. For example, Intel architectures added this instruction only very recently.



---

archive/issue_comments_356261.json:
```json
{
    "body": "<a id='comment:4'></a>Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.",
    "created_at": "2015-12-29T21:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356261",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.



---

archive/issue_comments_356262.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [vbraun](#comment%3A4):\n> Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.\n\n\nI would say that *at least in the specific case of complex multiplication*, the use of FMA instructions is wrong.",
    "created_at": "2015-12-29T22:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356262",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [vbraun](#comment%3A4):
> Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.


I would say that *at least in the specific case of complex multiplication*, the use of FMA instructions is wrong.



---

archive/issue_comments_356263.json:
```json
{
    "body": "<a id='comment:6'></a>Alternatively, we could probably play some tricks with `volatile` to fix complex multiplication.",
    "created_at": "2015-12-29T22:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356263",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Alternatively, we could probably play some tricks with `volatile` to fix complex multiplication.



---

archive/issue_comments_356264.json:
```json
{
    "body": "<a id='comment:7'></a>So the question is: Should we guarantee that `x*x.conj()` has no numerical noise as imaginary part.\n\nI'm not sure. \n* Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up, though thats being retired now. \n* Blas are more than happy to use FMA, so //if// we make guarantees for scalars then they'll most likely be broken by diagonal matrices, say. \n\nWhat I am pretty sure about is: multiplying `x*x.conj()` as complex numbers is a bad way of evaluating the absolute value. Fast callables using abs should return real and not complex values. And for that we need to hold abs. At which point the issue of the numerical noise in the imaginary part is pretty meaningless.",
    "created_at": "2015-12-30T00:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356264",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>So the question is: Should we guarantee that `x*x.conj()` has no numerical noise as imaginary part.

I'm not sure. 
* Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up, though thats being retired now. 
* Blas are more than happy to use FMA, so //if// we make guarantees for scalars then they'll most likely be broken by diagonal matrices, say. 

What I am pretty sure about is: multiplying `x*x.conj()` as complex numbers is a bad way of evaluating the absolute value. Fast callables using abs should return real and not complex values. And for that we need to hold abs. At which point the issue of the numerical noise in the imaginary part is pretty meaningless.



---

archive/issue_comments_356265.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [vbraun](#comment%3A2):\n> {{{\n>             sage: x = var('x', domain='real')\n>             sage: s = abs((1+I*x)^4); s\n>             (I*x + 1)^2*(-I*x + 1)^2\n> }}}\n> Isn't the real problem that abs does not default to `hold=True`\n\nMaybe it's better to expand automatically if the result contains `I`. Automatic expansion also resolved a similar problem in #18952\n\n```\nsage: x = var('x', domain='real')\nsage: ((1+I*x)^4).abs().expand()\nx^4 + 2*x^2 + 1\n```\n> so something that ought to be manifestly real is not.\n\nIt is but only when expanded.",
    "created_at": "2015-12-30T06:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356265",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>Replying to [vbraun](#comment%3A2):
> {{{
>             sage: x = var('x', domain='real')
>             sage: s = abs((1+I*x)^4); s
>             (I*x + 1)^2*(-I*x + 1)^2
> }}}
> Isn't the real problem that abs does not default to `hold=True`

Maybe it's better to expand automatically if the result contains `I`. Automatic expansion also resolved a similar problem in #18952

```
sage: x = var('x', domain='real')
sage: ((1+I*x)^4).abs().expand()
x^4 + 2*x^2 + 1
```
> so something that ought to be manifestly real is not.

It is but only when expanded.



---

archive/issue_comments_356266.json:
```json
{
    "body": "<a id='comment:9'></a>> Maybe it's better to expand automatically if the result contains `I`.\n\nAlso only if the result is not of form `abs(...)`",
    "created_at": "2015-12-30T09:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356266",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>> Maybe it's better to expand automatically if the result contains `I`.

Also only if the result is not of form `abs(...)`



---

archive/issue_comments_356267.json:
```json
{
    "body": "<a id='comment:10'></a>And not of the form `1+abs(...)` and so on\n\nAutomatically expanding isn't good enough either in general:\n\n```\nsage: x = var('x', domain='real')\nsage: ((exp(I*x)+exp(-I*x))^4).abs().expand()\ne^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6\n```",
    "created_at": "2015-12-30T09:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356267",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>And not of the form `1+abs(...)` and so on

Automatically expanding isn't good enough either in general:

```
sage: x = var('x', domain='real')
sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()
e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6
```



---

archive/issue_comments_356268.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. Developers acknowledge bug.\"",
    "created_at": "2015-12-30T09:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356268",
    "user": "https://github.com/rwst"
}
```

Changing upstream from "N/A" to "Reported upstream. Developers acknowledge bug."



---

archive/issue_comments_356269.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,3 +20,4 @@\n     Graphics object consisting of 0 graphics primitives\n **********************************************************************\n ```\n+See https://github.com/pynac/pynac/issues/117\n``````\n",
    "created_at": "2015-12-30T09:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356269",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,3 +20,4 @@
     Graphics object consisting of 0 graphics primitives
 **********************************************************************
 ```
+See https://github.com/pynac/pynac/issues/117
``````




---

archive/issue_comments_356270.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [vbraun](#comment%3A7):\n> * Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up\n\n\nWith x87, it is reasonable to assume that the whole imaginary part will be evaluated with 80 bits, so there won't be numerical noise either (see also the successful i386 buildbot reports).",
    "created_at": "2015-12-30T09:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356270",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [vbraun](#comment%3A7):
> * Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up


With x87, it is reasonable to assume that the whole imaginary part will be evaluated with 80 bits, so there won't be numerical noise either (see also the successful i386 buildbot reports).



---

archive/issue_comments_356271.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [vbraun](#comment%3A10):\n> And not of the form `1+abs(...)` and so on\n\nThis can be fixed in `GiNaC::abs_eval()`\n\n> Automatically expanding isn't good enough either in general:\n> \n> ```\n> sage: x = var('x', domain='real')\n> sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()\n> e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6\n> ```\n\nWhy not? This is real as well and could be rewritten as a sum of trig function expressions.",
    "created_at": "2015-12-30T09:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356271",
    "user": "https://github.com/rwst"
}
```

<a id='comment:13'></a>Replying to [vbraun](#comment%3A10):
> And not of the form `1+abs(...)` and so on

This can be fixed in `GiNaC::abs_eval()`

> Automatically expanding isn't good enough either in general:
> 
> ```
> sage: x = var('x', domain='real')
> sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()
> e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6
> ```

Why not? This is real as well and could be rewritten as a sum of trig function expressions.



---

archive/issue_comments_356272.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [rws](#comment%3A13):\n> This is real as well and could be rewritten as a sum of trig function expressions.\n\n\nVolker's point is about being \"manifestly\" real, which means: an expression which will always give a real result when evaluated, even if sub-expressions introduce numerical noise.\n\nAn expression like\n\n```\ne^(4*I*x) + e^(-4*I*x)\n```\nis not manifestly real, since there is no guarantee that the imaginary parts of the two terms will *exactly* cancel out.",
    "created_at": "2015-12-30T09:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356272",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [rws](#comment%3A13):
> This is real as well and could be rewritten as a sum of trig function expressions.


Volker's point is about being "manifestly" real, which means: an expression which will always give a real result when evaluated, even if sub-expressions introduce numerical noise.

An expression like

```
e^(4*I*x) + e^(-4*I*x)
```
is not manifestly real, since there is no guarantee that the imaginary parts of the two terms will *exactly* cancel out.



---

archive/issue_comments_356273.json:
```json
{
    "body": "<a id='comment:15'></a>Well then, exclude functions in the treewalk in the search for `I`. Treewalks are very fast in comparison to other Pynac operations, and those are only a small fraction when compared to what Python costs.",
    "created_at": "2015-12-30T09:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356273",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>Well then, exclude functions in the treewalk in the search for `I`. Treewalks are very fast in comparison to other Pynac operations, and those are only a small fraction when compared to what Python costs.



---

archive/issue_comments_356274.json:
```json
{
    "body": "<a id='comment:16'></a>Its not just that there is no guarantee against numerical noise in the imaginary part of `exp(I*x)+exp(-I*x)`, the return type of the fast callable also changes from real to complex (comment:2). The symbolic expression containing abs() should only do automatic simplifications that are again manifestly real.\n\n* Expanding polynomials over QQ[I] is safe, and that is the only safe case I can think of\n\n* Transcendental functions are not safe\n\n* Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe\n\nThoughts?",
    "created_at": "2015-12-30T10:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356274",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:16'></a>Its not just that there is no guarantee against numerical noise in the imaginary part of `exp(I*x)+exp(-I*x)`, the return type of the fast callable also changes from real to complex (comment:2). The symbolic expression containing abs() should only do automatic simplifications that are again manifestly real.

* Expanding polynomials over QQ[I] is safe, and that is the only safe case I can think of

* Transcendental functions are not safe

* Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe

Thoughts?



---

archive/issue_comments_356275.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [vbraun](#comment%3A16):\n> * Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe\n \nIs this decidable without expansion? Simply weeding out rational exponents will make `(I<sup>(5/4))*(I</sup>(3/4))` a false negative. OTOH first expanding then checking would be costly.\n\nIf so, I no longer think it useful.",
    "created_at": "2015-12-30T16:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356275",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>Replying to [vbraun](#comment%3A16):
> * Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe
 
Is this decidable without expansion? Simply weeding out rational exponents will make `(I<sup>(5/4))*(I</sup>(3/4))` a false negative. OTOH first expanding then checking would be costly.

If so, I no longer think it useful.



---

archive/issue_comments_356276.json:
```json
{
    "body": "<a id='comment:18'></a>So, you're proposing to always hold `abs()` and probably have a keyword for `x*conjugate(x)` output?",
    "created_at": "2015-12-30T16:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356276",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>So, you're proposing to always hold `abs()` and probably have a keyword for `x*conjugate(x)` output?



---

archive/issue_comments_356277.json:
```json
{
    "body": "<a id='comment:19'></a>Even with expansion I think it can be difficult to tell if a radical is real or not; Cardano's formula which can't be written in real radicals even if the roots are real comes to mind.\n\nOf course it **is** possible to decide if a radical is real or not, for example using QQbar.\n\nCan't we just `abs(hold=True)` by default? You can always simplify or set `hold=False` if you don't want that.",
    "created_at": "2015-12-30T16:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356277",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>Even with expansion I think it can be difficult to tell if a radical is real or not; Cardano's formula which can't be written in real radicals even if the roots are real comes to mind.

Of course it **is** possible to decide if a radical is real or not, for example using QQbar.

Can't we just `abs(hold=True)` by default? You can always simplify or set `hold=False` if you don't want that.



---

archive/issue_comments_356278.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [vbraun](#comment%3A19):\n> Can't we just `abs(hold=True)` by default?\n\n\nWe could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...",
    "created_at": "2015-12-30T22:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356278",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [vbraun](#comment%3A19):
> Can't we just `abs(hold=True)` by default?


We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...



---

archive/issue_comments_356279.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A20):\n> Replying to [vbraun](#comment%3A19):\n> > Can't we just `abs(hold=True)` by default?\n\n> \n> We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...\n\nI get only two fails in `functions/`, `symbolic/`, `calculus/`, `doc/` if I outcomment this snippet in Pynac which is responsible for the specific behaviour:\nhttps://github.com/pynac/pynac/blob/master/ginac/inifcns.cpp#L253",
    "created_at": "2015-12-31T07:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356279",
    "user": "https://github.com/rwst"
}
```

<a id='comment:21'></a>Replying to [jdemeyer](#comment%3A20):
> Replying to [vbraun](#comment%3A19):
> > Can't we just `abs(hold=True)` by default?

> 
> We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...

I get only two fails in `functions/`, `symbolic/`, `calculus/`, `doc/` if I outcomment this snippet in Pynac which is responsible for the specific behaviour:
https://github.com/pynac/pynac/blob/master/ginac/inifcns.cpp#L253



---

archive/issue_comments_356280.json:
```json
{
    "body": "<a id='comment:22'></a>So the result is arrived at by two code parts: first `abs` of real power (or power of positive) is rewritten as power of `abs` and, second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.",
    "created_at": "2015-12-31T07:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356280",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>So the result is arrived at by two code parts: first `abs` of real power (or power of positive) is rewritten as power of `abs` and, second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.



---

archive/issue_comments_356281.json:
```json
{
    "body": "<a id='comment:23'></a>So I'll just disable the `abs(ex<sup>real)-->abs(ex)</sup>real` part in that Pynac ticket if there are no objections.",
    "created_at": "2015-12-31T08:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356281",
    "user": "https://github.com/rwst"
}
```

<a id='comment:23'></a>So I'll just disable the `abs(ex<sup>real)-->abs(ex)</sup>real` part in that Pynac ticket if there are no objections.



---

archive/issue_comments_356282.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [rws](#comment%3A22):\n> second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.\n\n\nIt's really this second part which is problematic.",
    "created_at": "2015-12-31T09:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356282",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [rws](#comment%3A22):
> second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.


It's really this second part which is problematic.



---

archive/issue_comments_356283.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,12 +1,13 @@\n-The following can happen on some hardware architectures due to fused multiply-add instructions:\n+Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:\n \n ```\n-sage: x = CDF(0.99, 0.2)\n-sage: x * x.conj()\n-1.0201 + 1.1102230246251575e-19*I\n+sage: abs(x^2)\n+x*conjugate(x)\n ```\n \n-It's annoying because it causes doctest failures, for example\n+In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n+\n+This causes the following doctest failure:\n \n ```\n sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx\n@@ -20,4 +21,5 @@\n     Graphics object consisting of 0 graphics primitives\n **********************************************************************\n ```\n+\n See https://github.com/pynac/pynac/issues/117\n``````\n",
    "created_at": "2015-12-31T09:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356283",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,12 +1,13 @@
-The following can happen on some hardware architectures due to fused multiply-add instructions:
+Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:
 
 ```
-sage: x = CDF(0.99, 0.2)
-sage: x * x.conj()
-1.0201 + 1.1102230246251575e-19*I
+sage: abs(x^2)
+x*conjugate(x)
 ```
 
-It's annoying because it causes doctest failures, for example
+In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
+
+This causes the following doctest failure:
 
 ```
 sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx
@@ -20,4 +21,5 @@
     Graphics object consisting of 0 graphics primitives
 **********************************************************************
 ```
+
 See https://github.com/pynac/pynac/issues/117
``````




---

archive/issue_comments_356284.json:
```json
{
    "body": "Changing dependencies from \"#19796\" to \"\"",
    "created_at": "2015-12-31T09:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356284",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#19796" to ""



---

archive/issue_comments_356285.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n x*conjugate(x)\n ```\n \n-In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n+In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n \n This causes the following doctest failure:\n \n``````\n",
    "created_at": "2015-12-31T09:03:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356285",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,7 @@
 x*conjugate(x)
 ```
 
-In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
+In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
 
 This causes the following doctest failure:
 
``````




---

archive/issue_comments_356286.json:
```json
{
    "body": "<a id='comment:27'></a>The simplification `abs(ex<sup>real)-->abs(ex)</sup>real` is safe since the result is still manifestly real.",
    "created_at": "2015-12-31T09:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356286",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>The simplification `abs(ex<sup>real)-->abs(ex)</sup>real` is safe since the result is still manifestly real.



---

archive/issue_comments_356287.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,6 +2,8 @@\n \n ```\n sage: abs(x^2)\n+x*conjugate(x)\n+sage: abs(x)^2\n x*conjugate(x)\n ```\n \n``````\n",
    "created_at": "2015-12-31T09:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356287",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,6 +2,8 @@
 
 ```
 sage: abs(x^2)
+x*conjugate(x)
+sage: abs(x)^2
 x*conjugate(x)
 ```
 
``````




---

archive/issue_comments_356288.json:
```json
{
    "body": "<a id='comment:28'></a>This was introduced with pynac-0.3.9.2 from GiNaC. I'll revert it for pynac-0.5.4.",
    "created_at": "2015-12-31T09:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356288",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>This was introduced with pynac-0.3.9.2 from GiNaC. I'll revert it for pynac-0.5.4.



---

archive/issue_comments_356289.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356289",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_356290.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356290",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_356291.json:
```json
{
    "body": "<a id='comment:29'></a>\"Duplicate\" of #19819.",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356291",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>"Duplicate" of #19819.



---

archive/issue_events_054192.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-03T12:37:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19797#event-54192"
}
```



---

archive/issue_comments_356292.json:
```json
{
    "body": "Changing author from \"Jeroen Demeyer\" to \"\"",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356292",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Jeroen Demeyer" to ""



---

archive/issue_comments_356293.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/19797\" to \"\"",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356293",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/jdemeyer/ticket/19797" to ""



---

archive/issue_comments_356294.json:
```json
{
    "body": "Changing commit from \"694feb2d71ebf521cf5f32dba69e0406d16e9f11\" to \"\"",
    "created_at": "2016-01-03T12:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356294",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "694feb2d71ebf521cf5f32dba69e0406d16e9f11" to ""



---

archive/issue_comments_356295.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-03T12:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356295",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_356296.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2016-01-03T20:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19797#issuecomment-356296",
    "user": "https://github.com/vbraun"
}
```

Resolution: duplicate



---

archive/issue_events_054193.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-03T20:28:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19797",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19797#event-54193"
}
```
