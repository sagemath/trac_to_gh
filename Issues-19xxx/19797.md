# Issue 19797: Disallow automatic abs() simplifications resulting non-real expressions

archive/issues_019560.json:
```json
{
    "assignees": [],
    "body": "Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:\n\n```\nsage: abs(x^2)\nx*conjugate(x)\nsage: abs(x)^2\nx*conjugate(x)\n```\n\nIn the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n\nThis causes the following doctest failure:\n\n```\nsage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 11105, in sage.symbolic.expression.Expression._plot_fast_callable\nFailed example:\n    plot(s)\nExpected:\n    Graphics object consisting of 1 graphics primitive\nGot:\n    Graphics object consisting of 0 graphics primitives\n**********************************************************************\n```\n\nSee https://github.com/pynac/pynac/issues/117\n\nCC:  @rwst\n\nUpstream: **Reported upstream. Developers acknowledge bug.**\n\nReviewer: **Jeroen Demeyer**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/19797_\n\n",
    "closed_at": "2016-01-03T20:28:33Z",
    "created_at": "2015-12-29T10:15:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Disallow automatic abs() simplifications resulting non-real expressions",
    "type": "issue",
    "updated_at": "2016-01-03T20:28:33Z",
    "url": "https://github.com/sagemath/sage/issues/19797",
    "user": "https://github.com/jdemeyer"
}
```
Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:

```
sage: abs(x^2)
x*conjugate(x)
sage: abs(x)^2
x*conjugate(x)
```

In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.

This causes the following doctest failure:

```
sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 11105, in sage.symbolic.expression.Expression._plot_fast_callable
Failed example:
    plot(s)
Expected:
    Graphics object consisting of 1 graphics primitive
Got:
    Graphics object consisting of 0 graphics primitives
**********************************************************************
```

See https://github.com/pynac/pynac/issues/117

CC:  @rwst

Upstream: **Reported upstream. Developers acknowledge bug.**

Reviewer: **Jeroen Demeyer**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/19797_





---

archive/issue_events_277489.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-29T10:15:31Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "milestone_number": null,
    "milestone_title": "sage-7.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277489"
}
```



---

archive/issue_events_277490.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-29T10:15:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277490"
}
```



---

archive/issue_events_277491.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-29T10:15:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277491"
}
```



---

archive/issue_events_277492.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-29T10:15:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277492"
}
```



---

archive/issue_comments_282845.json:
```json
{
    "body": "Branch: **[u/jdemeyer/ticket/19797](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/19797)**",
    "created_at": "2015-12-29T12:44:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282845",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/ticket/19797](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/19797)**



---

archive/issue_comments_282846.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIsn't this sacrificing a lot of numerical performance? At least IEEE 754-2008 contains fused multiply-add.\n\nThe doctest is\n\n```\n            sage: x = var('x', domain='real')\n            sage: s = abs((1+I*x)^4); s\n            (I*x + 1)^2*(-I*x + 1)^2\n            sage: s._plot_fast_callable(x)\n            <sage.ext.interpreters.wrapper_py.Wrapper_py object at ...>\n            sage: s._plot_fast_callable(x)(10)\n            10201\n            sage: abs((I*10+1)^4)\n            10201\n            sage: plot(s)\n            Graphics object consisting of 1 graphics primitive\n```\nIsn't the real problem that abs does not default to `hold=True`\n\n```\nsage: ((1+I*x)^4).abs()\n(I*x + 1)^2*(-I*x + 1)^2\n```\nso something that ought to be manifestly real is not. Compare:\n\n```\nsage: abs((1+I*x)^4)._plot_fast_callable(x)(RDF(10))\n10201.00000000001\nsage: type(_)\n<type 'sage.rings.complex_double.ComplexDoubleElement'>\n```\nvs.\n\n```\nsage: ((1+I*x)^4).abs(hold=True)._plot_fast_callable(x)(RDF(10))\n10201.000000000005\nsage: type(_)\n<type 'sage.rings.real_double.RealDoubleElement'>\n```\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e4686731d4d1acb1f75b223a0e855bff1c3b8561\"><code>e468673</code></a></td><td><code>Simplify build of interpreters by skipping header files</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11\"><code>694feb2</code></a></td><td><code>Build GSL in IEEE 754 compliant mode</code></td></tr></table>\n",
    "created_at": "2015-12-29T16:33:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282846",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2" align="right">comment:2</div>

Isn't this sacrificing a lot of numerical performance? At least IEEE 754-2008 contains fused multiply-add.

The doctest is

```
            sage: x = var('x', domain='real')
            sage: s = abs((1+I*x)^4); s
            (I*x + 1)^2*(-I*x + 1)^2
            sage: s._plot_fast_callable(x)
            <sage.ext.interpreters.wrapper_py.Wrapper_py object at ...>
            sage: s._plot_fast_callable(x)(10)
            10201
            sage: abs((I*10+1)^4)
            10201
            sage: plot(s)
            Graphics object consisting of 1 graphics primitive
```
Isn't the real problem that abs does not default to `hold=True`

```
sage: ((1+I*x)^4).abs()
(I*x + 1)^2*(-I*x + 1)^2
```
so something that ought to be manifestly real is not. Compare:

```
sage: abs((1+I*x)^4)._plot_fast_callable(x)(RDF(10))
10201.00000000001
sage: type(_)
<type 'sage.rings.complex_double.ComplexDoubleElement'>
```
vs.

```
sage: ((1+I*x)^4).abs(hold=True)._plot_fast_callable(x)(RDF(10))
10201.000000000005
sage: type(_)
<type 'sage.rings.real_double.RealDoubleElement'>
```

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e4686731d4d1acb1f75b223a0e855bff1c3b8561"><code>e468673</code></a></td><td><code>Simplify build of interpreters by skipping header files</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11"><code>694feb2</code></a></td><td><code>Build GSL in IEEE 754 compliant mode</code></td></tr></table>




---

archive/issue_comments_282847.json:
```json
{
    "body": "Commit: **[`694feb2`](https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11)**",
    "created_at": "2015-12-29T16:33:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282847",
    "user": "https://github.com/vbraun"
}
```

Commit: **[`694feb2`](https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11)**



---

archive/issue_comments_282848.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@vbraun](#comment:2):\n> Isn't this sacrificing a lot of numerical performance?\n\nI have no idea but I doubt it. For example, Intel architectures added this instruction only very recently.",
    "created_at": "2015-12-29T21:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282848",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@vbraun](#comment:2):
> Isn't this sacrificing a lot of numerical performance?

I have no idea but I doubt it. For example, Intel architectures added this instruction only very recently.



---

archive/issue_comments_282849.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nYes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.",
    "created_at": "2015-12-29T21:57:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282849",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.



---

archive/issue_comments_282850.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@vbraun](#comment:4):\n> Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.\n\nI would say that *at least in the specific case of complex multiplication*, the use of FMA instructions is wrong.",
    "created_at": "2015-12-29T22:16:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282850",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@vbraun](#comment:4):
> Yes but CPU's haven't seen any general speedups recently, either. Only more specialized instructions, and if you don't use them then you are not participating in progress.

I would say that *at least in the specific case of complex multiplication*, the use of FMA instructions is wrong.



---

archive/issue_comments_282851.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAlternatively, we could probably play some tricks with `volatile` to fix complex multiplication.",
    "created_at": "2015-12-29T22:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282851",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Alternatively, we could probably play some tricks with `volatile` to fix complex multiplication.



---

archive/issue_comments_282852.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nSo the question is: Should we guarantee that `x*x.conj()` has no numerical noise as imaginary part.\n\nI'm not sure. \n* Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up, though thats being retired now. \n* Blas are more than happy to use FMA, so *if* we make guarantees for scalars then they'll most likely be broken by diagonal matrices, say. \n\nWhat I am pretty sure about is: multiplying `x*x.conj()` as complex numbers is a bad way of evaluating the absolute value. Fast callables using abs should return real and not complex values. And for that we need to hold abs. At which point the issue of the numerical noise in the imaginary part is pretty meaningless.",
    "created_at": "2015-12-30T00:17:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282852",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

So the question is: Should we guarantee that `x*x.conj()` has no numerical noise as imaginary part.

I'm not sure. 
* Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up, though thats being retired now. 
* Blas are more than happy to use FMA, so *if* we make guarantees for scalars then they'll most likely be broken by diagonal matrices, say. 

What I am pretty sure about is: multiplying `x*x.conj()` as complex numbers is a bad way of evaluating the absolute value. Fast callables using abs should return real and not complex values. And for that we need to hold abs. At which point the issue of the numerical noise in the imaginary part is pretty meaningless.



---

archive/issue_comments_282853.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@vbraun](#comment:2):\n> \n> ```\n>             sage: x = var('x', domain='real')\n>             sage: s = abs((1+I*x)^4); s\n>             (I*x + 1)^2*(-I*x + 1)^2\n> ```\n> Isn't the real problem that abs does not default to `hold=True`\n\nMaybe it's better to expand automatically if the result contains `I`. Automatic expansion also resolved a similar problem in #18952\n\n```\nsage: x = var('x', domain='real')\nsage: ((1+I*x)^4).abs().expand()\nx^4 + 2*x^2 + 1\n```\n> so something that ought to be manifestly real is not.\n\nIt is but only when expanded.",
    "created_at": "2015-12-30T06:08:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282853",
    "user": "https://github.com/rwst"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@vbraun](#comment:2):
> 
> ```
>             sage: x = var('x', domain='real')
>             sage: s = abs((1+I*x)^4); s
>             (I*x + 1)^2*(-I*x + 1)^2
> ```
> Isn't the real problem that abs does not default to `hold=True`

Maybe it's better to expand automatically if the result contains `I`. Automatic expansion also resolved a similar problem in #18952

```
sage: x = var('x', domain='real')
sage: ((1+I*x)^4).abs().expand()
x^4 + 2*x^2 + 1
```
> so something that ought to be manifestly real is not.

It is but only when expanded.



---

archive/issue_comments_282854.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\n> Maybe it's better to expand automatically if the result contains `I`.\n\nAlso only if the result is not of form `abs(...)`",
    "created_at": "2015-12-30T09:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282854",
    "user": "https://github.com/rwst"
}
```

<div id="comment:9" align="right">comment:9</div>

> Maybe it's better to expand automatically if the result contains `I`.

Also only if the result is not of form `abs(...)`



---

archive/issue_comments_282855.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nAnd not of the form `1+abs(...)` and so on\n\nAutomatically expanding isn't good enough either in general:\n\n```\nsage: x = var('x', domain='real')\nsage: ((exp(I*x)+exp(-I*x))^4).abs().expand()\ne^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6\n```",
    "created_at": "2015-12-30T09:11:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282855",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

And not of the form `1+abs(...)` and so on

Automatically expanding isn't good enough either in general:

```
sage: x = var('x', domain='real')
sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()
e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6
```



---

archive/issue_comments_282856.json:
```json
{
    "body": "Upstream: **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2015-12-30T09:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282856",
    "user": "https://github.com/rwst"
}
```

Upstream: **Reported upstream. Developers acknowledge bug.**



---

archive/issue_comments_282857.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,3 +20,4 @@\n     Graphics object consisting of 0 graphics primitives\n **********************************************************************\n ```\n+See https://github.com/pynac/pynac/issues/117\n``````\n",
    "created_at": "2015-12-30T09:23:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282857",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,3 +20,4 @@
     Graphics object consisting of 0 graphics primitives
 **********************************************************************
 ```
+See https://github.com/pynac/pynac/issues/117
``````




---

archive/issue_comments_282858.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@vbraun](#comment:7):\n> * Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up\n\nWith x87, it is reasonable to assume that the whole imaginary part will be evaluated with 80 bits, so there won't be numerical noise either (see also the successful i386 buildbot reports).",
    "created_at": "2015-12-30T09:27:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282858",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@vbraun](#comment:7):
> * Even besides FMA there is always the possibility of 80-bit x87 instructions messing things up

With x87, it is reasonable to assume that the whole imaginary part will be evaluated with 80 bits, so there won't be numerical noise either (see also the successful i386 buildbot reports).



---

archive/issue_comments_282859.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment:10):\n> And not of the form `1+abs(...)` and so on\n\nThis can be fixed in `GiNaC::abs_eval()`\n\n> Automatically expanding isn't good enough either in general:\n> \n> ```\n> sage: x = var('x', domain='real')\n> sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()\n> e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6\n> ```\n\nWhy not? This is real as well and could be rewritten as a sum of trig function expressions.",
    "created_at": "2015-12-30T09:29:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282859",
    "user": "https://github.com/rwst"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment:10):
> And not of the form `1+abs(...)` and so on

This can be fixed in `GiNaC::abs_eval()`

> Automatically expanding isn't good enough either in general:
> 
> ```
> sage: x = var('x', domain='real')
> sage: ((exp(I*x)+exp(-I*x))^4).abs().expand()
> e^(4*I*x) + 4*e^(2*I*x) + 4*e^(-2*I*x) + e^(-4*I*x) + 6
> ```

Why not? This is real as well and could be rewritten as a sum of trig function expressions.



---

archive/issue_comments_282860.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@rwst](#comment:13):\n> This is real as well and could be rewritten as a sum of trig function expressions.\n\nVolker's point is about being \"manifestly\" real, which means: an expression which will always give a real result when evaluated, even if sub-expressions introduce numerical noise.\n\nAn expression like\n\n```\ne^(4*I*x) + e^(-4*I*x)\n```\nis not manifestly real, since there is no guarantee that the imaginary parts of the two terms will *exactly* cancel out.",
    "created_at": "2015-12-30T09:35:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282860",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@rwst](#comment:13):
> This is real as well and could be rewritten as a sum of trig function expressions.

Volker's point is about being "manifestly" real, which means: an expression which will always give a real result when evaluated, even if sub-expressions introduce numerical noise.

An expression like

```
e^(4*I*x) + e^(-4*I*x)
```
is not manifestly real, since there is no guarantee that the imaginary parts of the two terms will *exactly* cancel out.



---

archive/issue_comments_282861.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nWell then, exclude functions in the treewalk in the search for `I`. Treewalks are very fast in comparison to other Pynac operations, and those are only a small fraction when compared to what Python costs.",
    "created_at": "2015-12-30T09:43:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282861",
    "user": "https://github.com/rwst"
}
```

<div id="comment:15" align="right">comment:15</div>

Well then, exclude functions in the treewalk in the search for `I`. Treewalks are very fast in comparison to other Pynac operations, and those are only a small fraction when compared to what Python costs.



---

archive/issue_comments_282862.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nIts not just that there is no guarantee against numerical noise in the imaginary part of `exp(I*x)+exp(-I*x)`, the return type of the fast callable also changes from real to complex (comment:2). The symbolic expression containing abs() should only do automatic simplifications that are again manifestly real.\n\n* Expanding polynomials over QQ[I] is safe, and that is the only safe case I can think of\n\n* Transcendental functions are not safe\n\n* Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe\n\nThoughts?",
    "created_at": "2015-12-30T10:02:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282862",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

Its not just that there is no guarantee against numerical noise in the imaginary part of `exp(I*x)+exp(-I*x)`, the return type of the fast callable also changes from real to complex (comment:2). The symbolic expression containing abs() should only do automatic simplifications that are again manifestly real.

* Expanding polynomials over QQ[I] is safe, and that is the only safe case I can think of

* Transcendental functions are not safe

* Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe

Thoughts?



---

archive/issue_comments_282863.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment:16):\n> * Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe\n\nIs this decidable without expansion? Simply weeding out rational exponents will make `(I<sup>(5/4))*(I</sup>(3/4))` a false negative. OTOH first expanding then checking would be costly.\n\nIf so, I no longer think it useful.",
    "created_at": "2015-12-30T16:08:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282863",
    "user": "https://github.com/rwst"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment:16):
> * Expanding polynomials whose coefficients are radical expressions over QQ[I] are not safe

Is this decidable without expansion? Simply weeding out rational exponents will make `(I<sup>(5/4))*(I</sup>(3/4))` a false negative. OTOH first expanding then checking would be costly.

If so, I no longer think it useful.



---

archive/issue_comments_282864.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nSo, you're proposing to always hold `abs()` and probably have a keyword for `x*conjugate(x)` output?",
    "created_at": "2015-12-30T16:36:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282864",
    "user": "https://github.com/rwst"
}
```

<div id="comment:18" align="right">comment:18</div>

So, you're proposing to always hold `abs()` and probably have a keyword for `x*conjugate(x)` output?



---

archive/issue_comments_282865.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nEven with expansion I think it can be difficult to tell if a radical is real or not; Cardano's formula which can't be written in real radicals even if the roots are real comes to mind.\n\nOf course it **is** possible to decide if a radical is real or not, for example using QQbar.\n\nCan't we just `abs(hold=True)` by default? You can always simplify or set `hold=False` if you don't want that.",
    "created_at": "2015-12-30T16:43:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282865",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

Even with expansion I think it can be difficult to tell if a radical is real or not; Cardano's formula which can't be written in real radicals even if the roots are real comes to mind.

Of course it **is** possible to decide if a radical is real or not, for example using QQbar.

Can't we just `abs(hold=True)` by default? You can always simplify or set `hold=False` if you don't want that.



---

archive/issue_comments_282866.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@vbraun](#comment:19):\n> Can't we just `abs(hold=True)` by default?\n\nWe could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...",
    "created_at": "2015-12-30T22:42:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282866",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@vbraun](#comment:19):
> Can't we just `abs(hold=True)` by default?

We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...



---

archive/issue_comments_282867.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@jdemeyer](#comment:20):\n> Replying to [@vbraun](#comment:19):\n> > Can't we just `abs(hold=True)` by default?\n\n> \n> We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...\n\nI get only two fails in `functions/`, `symbolic/`, `calculus/`, `doc/` if I outcomment this snippet in Pynac which is responsible for the specific behaviour:\nhttps://github.com/pynac/pynac/blob/master/ginac/inifcns.cpp#L253",
    "created_at": "2015-12-31T07:22:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282867",
    "user": "https://github.com/rwst"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@jdemeyer](#comment:20):
> Replying to [@vbraun](#comment:19):
> > Can't we just `abs(hold=True)` by default?

> 
> We could certainly do that as a stopgap-style solution. However, this is certainly going to break some doctests...

I get only two fails in `functions/`, `symbolic/`, `calculus/`, `doc/` if I outcomment this snippet in Pynac which is responsible for the specific behaviour:
https://github.com/pynac/pynac/blob/master/ginac/inifcns.cpp#L253



---

archive/issue_comments_282868.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSo the result is arrived at by two code parts: first `abs` of real power (or power of positive) is rewritten as power of `abs` and, second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.",
    "created_at": "2015-12-31T07:37:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282868",
    "user": "https://github.com/rwst"
}
```

<div id="comment:22" align="right">comment:22</div>

So the result is arrived at by two code parts: first `abs` of real power (or power of positive) is rewritten as power of `abs` and, second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.



---

archive/issue_comments_282869.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nSo I'll just disable the `abs(ex<sup>real)-->abs(ex)</sup>real` part in that Pynac ticket if there are no objections.",
    "created_at": "2015-12-31T08:26:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282869",
    "user": "https://github.com/rwst"
}
```

<div id="comment:23" align="right">comment:23</div>

So I'll just disable the `abs(ex<sup>real)-->abs(ex)</sup>real` part in that Pynac ticket if there are no objections.



---

archive/issue_comments_282870.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@rwst](#comment:22):\n> second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.\n\nIt's really this second part which is problematic.",
    "created_at": "2015-12-31T09:01:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282870",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@rwst](#comment:22):
> second, even power of `abs(x)` is rewritten as `x*x.conj()` to the half power.

It's really this second part which is problematic.



---

archive/issue_comments_282871.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,12 +1,13 @@\n-The following can happen on some hardware architectures due to fused multiply-add instructions:\n+Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:\n \n ```\n-sage: x = CDF(0.99, 0.2)\n-sage: x * x.conj()\n-1.0201 + 1.1102230246251575e-19*I\n+sage: abs(x^2)\n+x*conjugate(x)\n ```\n \n-It's annoying because it causes doctest failures, for example\n+In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n+\n+This causes the following doctest failure:\n \n ```\n sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx\n@@ -20,4 +21,5 @@\n     Graphics object consisting of 0 graphics primitives\n **********************************************************************\n ```\n+\n See https://github.com/pynac/pynac/issues/117\n``````\n",
    "created_at": "2015-12-31T09:01:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282871",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,12 +1,13 @@
-The following can happen on some hardware architectures due to fused multiply-add instructions:
+Calling `abs()` on certain expressions can yield something which is not guaranteed to be evaluated as a real number:
 
 ```
-sage: x = CDF(0.99, 0.2)
-sage: x * x.conj()
-1.0201 + 1.1102230246251575e-19*I
+sage: abs(x^2)
+x*conjugate(x)
 ```
 
-It's annoying because it causes doctest failures, for example
+In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
+
+This causes the following doctest failure:
 
 ```
 sage -t --long --warn-long 62.3 src/sage/symbolic/expression.pyx
@@ -20,4 +21,5 @@
     Graphics object consisting of 0 graphics primitives
 **********************************************************************
 ```
+
 See https://github.com/pynac/pynac/issues/117
``````




---

archive/issue_events_277493.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-31T09:01:04Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "title_is": "Disallow automatic abs() simplifications resulting non-real expressions",
    "title_was": "Build GSL in IEEE 754 compliant mode",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277493"
}
```



---

archive/issue_comments_282872.json:
```json
{
    "body": "Changed dependencies from **#19796** to none",
    "created_at": "2015-12-31T09:03:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282872",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#19796** to none



---

archive/issue_comments_282873.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n x*conjugate(x)\n ```\n \n-In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n+In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.\n \n This causes the following doctest failure:\n \n``````\n",
    "created_at": "2015-12-31T09:03:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282873",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,7 +5,7 @@
 x*conjugate(x)
 ```
 
-In the presence of numerical noise, the expression `x*conjugate(x)` can actually a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
+In the presence of numerical noise, the expression `x*conjugate(x)` can have a non-zero imaginary part. And even if there is no noise, the type would be wrong: complex instead of real.
 
 This causes the following doctest failure:
 
``````




---

archive/issue_comments_282874.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThe simplification `abs(ex<sup>real)-->abs(ex)</sup>real` is safe since the result is still manifestly real.",
    "created_at": "2015-12-31T09:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282874",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

The simplification `abs(ex<sup>real)-->abs(ex)</sup>real` is safe since the result is still manifestly real.



---

archive/issue_comments_282875.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,6 +2,8 @@\n \n ```\n sage: abs(x^2)\n+x*conjugate(x)\n+sage: abs(x)^2\n x*conjugate(x)\n ```\n \n``````\n",
    "created_at": "2015-12-31T09:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282875",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,6 +2,8 @@
 
 ```
 sage: abs(x^2)
+x*conjugate(x)
+sage: abs(x)^2
 x*conjugate(x)
 ```
 
``````




---

archive/issue_comments_282876.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThis was introduced with pynac-0.3.9.2 from GiNaC. I'll revert it for pynac-0.5.4.",
    "created_at": "2015-12-31T09:29:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282876",
    "user": "https://github.com/rwst"
}
```

<div id="comment:28" align="right">comment:28</div>

This was introduced with pynac-0.3.9.2 from GiNaC. I'll revert it for pynac-0.5.4.



---

archive/issue_comments_282877.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2016-01-03T12:37:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282877",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_277494.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-03T12:37:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277494"
}
```



---

archive/issue_comments_282878.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n\"Duplicate\" of #19819.",
    "created_at": "2016-01-03T12:37:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282878",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

"Duplicate" of #19819.



---

archive/issue_events_277495.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-03T12:37:07Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "milestone_number": null,
    "milestone_title": "sage-7.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277495"
}
```



---

archive/issue_comments_282879.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to none",
    "created_at": "2016-01-03T12:37:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282879",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Jeroen Demeyer** to none



---

archive/issue_comments_282880.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/19797](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/19797)** to none",
    "created_at": "2016-01-03T12:37:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282880",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/jdemeyer/ticket/19797](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/19797)** to none



---

archive/issue_comments_282881.json:
```json
{
    "body": "Changed commit from **[`694feb2`](https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11)** to none",
    "created_at": "2016-01-03T12:37:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19797#issuecomment-282881",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`694feb2`](https://github.com/sagemath/sagetrac-mirror/commit/694feb2d71ebf521cf5f32dba69e0406d16e9f11)** to none



---

archive/issue_events_277496.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-03T12:37:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277496"
}
```



---

archive/issue_events_277497.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-03T12:37:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277497"
}
```



---

archive/issue_events_277498.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-03T20:28:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277498"
}
```



---

archive/issue_events_277499.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-03T20:28:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277499"
}
```



---

archive/issue_events_277500.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-03T20:28:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277500"
}
```



---

archive/issue_events_277501.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-03T20:28:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/19797",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19797#event-277501"
}
```
