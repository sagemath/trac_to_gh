# Issue 19488: Random failure in AffineCrystalFromClassicalElement.__cmp__

archive/issues_019251.json:
```json
{
    "body": "Random failure, here on OSX:\n\n```\nsage -t --long src/sage/combinat/crystals/affine.py\n**********************************************************************\nFile \"src/sage/combinat/crystals/affine.py\", line 574, in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__\nFailed example:\n    cmp(b,1)\nExpected:\n    -1\nGot:\n    1\n**********************************************************************\n1 item had failures:\n   1 of   7 in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__\n```\n\nCC:  @tscrim\n\nKeywords: random_fail\n\nReviewer: Travis Scrimshaw, Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton, Travis Scrimshaw\n\nBranch: ebcd19f0d1d8f8f2f89ed22666143a7f3ea5de15\n\nCommit: ebcd19f0d1d8f8f2f89ed22666143a7f3ea5de15\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19488\n\n",
    "closed_at": "2016-09-04T00:14:00Z",
    "created_at": "2015-10-27T20:12:34Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Random failure in AffineCrystalFromClassicalElement.__cmp__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19488",
    "user": "https://github.com/vbraun"
}
```
Random failure, here on OSX:

```
sage -t --long src/sage/combinat/crystals/affine.py
**********************************************************************
File "src/sage/combinat/crystals/affine.py", line 574, in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__
Failed example:
    cmp(b,1)
Expected:
    -1
Got:
    1
**********************************************************************
1 item had failures:
   1 of   7 in sage.combinat.crystals.affine.AffineCrystalFromClassicalElement.__cmp__
```

CC:  @tscrim

Keywords: random_fail

Reviewer: Travis Scrimshaw, Frédéric Chapoton

Author: Frédéric Chapoton, Travis Scrimshaw

Branch: ebcd19f0d1d8f8f2f89ed22666143a7f3ea5de15

Commit: ebcd19f0d1d8f8f2f89ed22666143a7f3ea5de15

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19488





---

archive/issue_comments_263872.json:
```json
{
    "body": "<a id='comment:1'></a>This looks like something that is going to be introduced by the `__hash__` people on #19016. This doctest does not exist currently in Sage.",
    "created_at": "2015-10-27T20:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263872",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>This looks like something that is going to be introduced by the `__hash__` people on #19016. This doctest does not exist currently in Sage.



---

archive/issue_comments_263873.json:
```json
{
    "body": "<a id='comment:2'></a>I tried to make a branch using the brand new possibilities of \"richcmp(x,y,op)\". (see #21128)\n\nI am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.\n\nTravis, what do you think ?\n\n---\nNew commits:",
    "created_at": "2016-08-18T19:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263873",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>I tried to make a branch using the brand new possibilities of "richcmp(x,y,op)". (see #21128)

I am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.

Travis, what do you think ?

---
New commits:



---

archive/issue_comments_263874.json:
```json
{
    "body": "<a id='comment:3'></a>I am pretty sure this is not correct:\n\n```python\nif parent(self) is not parent(other):\n    return NotImplemented\n```\nYou need to check if the comparison is `!=` as otherwise you would have `1 == b` and `1 != b` both return `False`.\n\nCould you also elaborate more on what you mean by this?\n\n> I am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.",
    "created_at": "2016-08-18T22:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263874",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>I am pretty sure this is not correct:

```python
if parent(self) is not parent(other):
    return NotImplemented
```
You need to check if the comparison is `!=` as otherwise you would have `1 == b` and `1 != b` both return `False`.

Could you also elaborate more on what you mean by this?

> I am a bit disappointed by the results of comparison with op in `<,>,>=,<=`.



---

archive/issue_comments_263875.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-19T07:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263876.json:
```json
{
    "body": "<a id='comment:5'></a>I have replace `__richcmp__` by `_richcmp_`, for which one can assume that\narguments have the same parents. Now one gets\n\n```\nsage: b==1\nFalse\nsage: b!=1\nTrue\n```\nBut\n\n```\nsage: cmp(b,c)\n-1\nsage: cmp(c,b)\n1\nsage: c<b\nFalse\nsage: b<c\nFalse\n```\nMaybe for coherence we will need to apply the same treatment to all crystals ?",
    "created_at": "2016-08-19T07:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263876",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>I have replace `__richcmp__` by `_richcmp_`, for which one can assume that
arguments have the same parents. Now one gets

```
sage: b==1
False
sage: b!=1
True
```
But

```
sage: cmp(b,c)
-1
sage: cmp(c,b)
1
sage: c<b
False
sage: b<c
False
```
Maybe for coherence we will need to apply the same treatment to all crystals ?



---

archive/issue_events_053752.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-08-19T07:57:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19488#event-53752"
}
```



---

archive/issue_comments_263877.json:
```json
{
    "body": "<a id='comment:7'></a>You forget that if cmp does not error out, then it forces some total ordering (probably memory location), so that behavior is consistent with this. I don't think at this point we need to doing anything elsewhere.",
    "created_at": "2016-08-19T08:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263877",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>You forget that if cmp does not error out, then it forces some total ordering (probably memory location), so that behavior is consistent with this. I don't think at this point we need to doing anything elsewhere.



---

archive/issue_comments_263878.json:
```json
{
    "body": "<a id='comment:8'></a>This is really puzzling to me (on this branch):\n\n```\nsage: b<c\nFalse\nsage: cmp(b,c)\n-1\nsage: b._richcmp_(c,0)\nTrue\nsage: b.__cmp__(c)\n-1\n\n```\nwhat is the first line doing, if not calling either cmp or `__cmp__` or rich comparison ?",
    "created_at": "2016-08-19T10:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263878",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>This is really puzzling to me (on this branch):

```
sage: b<c
False
sage: cmp(b,c)
-1
sage: b._richcmp_(c,0)
True
sage: b.__cmp__(c)
-1

```
what is the first line doing, if not calling either cmp or `__cmp__` or rich comparison ?



---

archive/issue_comments_263879.json:
```json
{
    "body": "<a id='comment:9'></a>This branch triggers failing doctests in other crystals, as I was expecting:\n\n```\nsage -t --long src/sage/categories/regular_crystals.py  # 3 doctests failed\nsage -t --long src/sage/combinat/crystals/subcrystal.py  # 6 doctests failed\n```",
    "created_at": "2016-08-19T12:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263879",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>This branch triggers failing doctests in other crystals, as I was expecting:

```
sage -t --long src/sage/categories/regular_crystals.py  # 3 doctests failed
sage -t --long src/sage/combinat/crystals/subcrystal.py  # 6 doctests failed
```



---

archive/issue_comments_263880.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-26T13:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263880",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263881.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-27T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263881",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_263882.json:
```json
{
    "body": "<a id='comment:11'></a>I traced the problem down to `ElementWrapper` defining a `__richcmp__`. So I changed that to `_richcmp_` and fixed a few trivial doctest failures. Now off to the patchbot.\n\n---\nNew commits:",
    "created_at": "2016-08-27T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263882",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>I traced the problem down to `ElementWrapper` defining a `__richcmp__`. So I changed that to `_richcmp_` and fixed a few trivial doctest failures. Now off to the patchbot.

---
New commits:



---

archive/issue_comments_263883.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-27T11:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263883",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263884.json:
```json
{
    "body": "<a id='comment:13'></a>I modified 3 failing doctests, there just remains one in pickling.",
    "created_at": "2016-08-27T11:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263884",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>I modified 3 failing doctests, there just remains one in pickling.



---

archive/issue_comments_263885.json:
```json
{
    "body": "<a id='comment:14'></a>So the problem with the pickling and `_richcmp_` has to do with equality versus identical parents. The parents are equal but not identical. This causes problems for `__richcmp__`, where it relies on parents being identical. It then creates an element wrapping an element of the test parent.\n\nWe can either implement the following the test parent to fix the doctest:\n\n```sage\n    def _element_constructor_(self, x):\n        if isinstance(x, ElementWrapper):\n            if x.parent() == self:\n                return self.element_class(self, x.value)\n        return Parent._element_constructor_(self, x)\n\n    def _an_element_(self):\n        return self.element_class(self, \"_an_element_\")\n```\nThe other way is to override `__richcmp__` for `ElementWrapper` to handle when parents are equal but not identical.\n\nI'm thinking the latter option is the way to go forward as it is backwards compatible.",
    "created_at": "2016-08-27T16:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263885",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>So the problem with the pickling and `_richcmp_` has to do with equality versus identical parents. The parents are equal but not identical. This causes problems for `__richcmp__`, where it relies on parents being identical. It then creates an element wrapping an element of the test parent.

We can either implement the following the test parent to fix the doctest:

```sage
    def _element_constructor_(self, x):
        if isinstance(x, ElementWrapper):
            if x.parent() == self:
                return self.element_class(self, x.value)
        return Parent._element_constructor_(self, x)

    def _an_element_(self):
        return self.element_class(self, "_an_element_")
```
The other way is to override `__richcmp__` for `ElementWrapper` to handle when parents are equal but not identical.

I'm thinking the latter option is the way to go forward as it is backwards compatible.



---

archive/issue_comments_263886.json:
```json
{
    "body": "<a id='comment:15'></a>I am sorry, but I am not quite able to follow your reasoning. If you feel you have a reasonable solution, please proceed.",
    "created_at": "2016-08-29T19:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263886",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>I am sorry, but I am not quite able to follow your reasoning. If you feel you have a reasonable solution, please proceed.



---

archive/issue_comments_263887.json:
```json
{
    "body": "<a id='comment:16'></a>The problem is\n\n```sage\nsage: TestParent4() == TestParent4()\nTrue\nsage: TestParent4() is TestParent4()\n```\nSo picking creates a new equal-but-not-identical parent. Thus there is a canonical coercion map that calls the `_element_constructor_`, which simply wraps the element (the result is a wrapped element of a wrapped element). If the parents were identical, then *no* map would be applied (this is a shortcut of the coercion model), and so the values would simply be compared as normal.\n\nTL;DR, yes, I have a very reasonable solution.",
    "created_at": "2016-08-29T19:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263887",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>The problem is

```sage
sage: TestParent4() == TestParent4()
True
sage: TestParent4() is TestParent4()
```
So picking creates a new equal-but-not-identical parent. Thus there is a canonical coercion map that calls the `_element_constructor_`, which simply wraps the element (the result is a wrapped element of a wrapped element). If the parents were identical, then *no* map would be applied (this is a shortcut of the coercion model), and so the values would simply be compared as normal.

TL;DR, yes, I have a very reasonable solution.



---

archive/issue_comments_263888.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-29T19:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263888",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263889.json:
```json
{
    "body": "<a id='comment:18'></a>patchbot is green.",
    "created_at": "2016-09-01T04:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263889",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>patchbot is green.



---

archive/issue_comments_263890.json:
```json
{
    "body": "<a id='comment:19'></a>Just to be sure, `__richcmp__` will be called first, is this right ?\n\nAnd why do these two richcmp methods do not use self as first parameter ?",
    "created_at": "2016-09-01T07:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263890",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:19'></a>Just to be sure, `__richcmp__` will be called first, is this right ?

And why do these two richcmp methods do not use self as first parameter ?



---

archive/issue_comments_263891.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 chapoton]:\n> Just to be sure, `__richcmp__` will be called first, is this right ?\n\n\nYes. `__richcmp__` is called by Python, whereas `_richcmp_` is the Sage version that is called from `__richcmp__`.\n\n> And why do these two richcmp methods do not use self as first parameter ?\n\n\nSo `self` is known to Cython to be an `ElementWrapper` for speed for `_richcmp_` (or so I've been told). For `__richcmp__`, it was a result of copy/paste and laziness. I'm okay with changing both of them.",
    "created_at": "2016-09-01T13:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263891",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Replying to [comment:19 chapoton]:
> Just to be sure, `__richcmp__` will be called first, is this right ?


Yes. `__richcmp__` is called by Python, whereas `_richcmp_` is the Sage version that is called from `__richcmp__`.

> And why do these two richcmp methods do not use self as first parameter ?


So `self` is known to Cython to be an `ElementWrapper` for speed for `_richcmp_` (or so I've been told). For `__richcmp__`, it was a result of copy/paste and laziness. I'm okay with changing both of them.



---

archive/issue_comments_263892.json:
```json
{
    "body": "<a id='comment:21'></a>oh, well. I am happy enough with the current state, let us move to something else.\n\nDo you think we should give the same treatment to other crystals ?",
    "created_at": "2016-09-01T15:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263892",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>oh, well. I am happy enough with the current state, let us move to something else.

Do you think we should give the same treatment to other crystals ?



---

archive/issue_comments_263893.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-01T15:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263893",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_263894.json:
```json
{
    "body": "<a id='comment:22'></a>We can if you want, but it will be a low priority for me for the next week.",
    "created_at": "2016-09-01T15:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263894",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>We can if you want, but it will be a low priority for me for the next week.



---

archive/issue_events_053753.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-09-04T00:14:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19488#event-53753"
}
```



---

archive/issue_comments_263895.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-04T00:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19488",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19488#issuecomment-263895",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
