# Issue 19229: Bug in elliptic curve Galois Representation

archive/issues_018992.json:
```json
{
    "body": "```\nsage: K.<a> = NumberField(x^2-x+1)\nsage: E = EllipticCurve([a+1,1,1,0,0])\nsage: C = E.isogeny_class()\n...\nValueError: 0 is not prime.\n```\nis caused by\n\n```\nsage: from sage.schemes.elliptic_curves.isogeny_class import possible_isogeny_degrees\nsage: possible_isogeny_degrees(E)                                                                      \n[0]\n```\nand in turn by\n\n```\nsage: EG = E.galois_representation()\nsage: EG.reducible_primes()\n[0]\n```\n\nAccording to the documentation for the last function it should return [0] if and only if E has CM, which is does not:\n\n```\nsage: E.has_cm()\nFalse\nsage: E.j_invariant().is_integral()\nFalse\n```\n(CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)\n\n\nKeywords: Galois representations\n\nBranch/Commit: 8680baa2190b4ba4c183ac1a44ce4a619e731256\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: John Cremona\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19229\n\n",
    "closed_at": "2016-02-10T08:20:59Z",
    "created_at": "2015-09-17T16:06:10Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Bug in elliptic curve Galois Representation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19229",
    "user": "https://github.com/JohnCremona"
}
```
```
sage: K.<a> = NumberField(x^2-x+1)
sage: E = EllipticCurve([a+1,1,1,0,0])
sage: C = E.isogeny_class()
...
ValueError: 0 is not prime.
```
is caused by

```
sage: from sage.schemes.elliptic_curves.isogeny_class import possible_isogeny_degrees
sage: possible_isogeny_degrees(E)                                                                      
[0]
```
and in turn by

```
sage: EG = E.galois_representation()
sage: EG.reducible_primes()
[0]
```

According to the documentation for the last function it should return [0] if and only if E has CM, which is does not:

```
sage: E.has_cm()
False
sage: E.j_invariant().is_integral()
False
```
(CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)


Keywords: Galois representations

Branch/Commit: 8680baa2190b4ba4c183ac1a44ce4a619e731256

Reviewer: Frédéric Chapoton

Author: John Cremona

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19229





---

archive/issue_comments_277245.json:
```json
{
    "body": "<a id='comment:1'></a>Tracked down to {{{_semistable_reducible_primes()}} in line 801:\n\n```\nF = NumberField(y**2 - a, 'a')\n```\nwhere a is an integer, but then the code base-changes the base field to this field Q(sqrt(a)), and there is a problem since 'a' is the name of K's generator.  This causes a ValueError which is caught in the wrong place in lines 292-4:\n\n```\n        try:\n            bad_primes = _semistable_reducible_primes(E)\n        except ValueError:\n            return [0]\n```\n\nI will fix this by putting in a test for CM much earlier (which did not exist when this code was written).  Also when constructing F we can make sure that the name of iots generator is not the same as that of K.",
    "created_at": "2015-09-17T16:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277245",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:1'></a>Tracked down to {{{_semistable_reducible_primes()}} in line 801:

```
F = NumberField(y**2 - a, 'a')
```
where a is an integer, but then the code base-changes the base field to this field Q(sqrt(a)), and there is a problem since 'a' is the name of K's generator.  This causes a ValueError which is caught in the wrong place in lines 292-4:

```
        try:
            bad_primes = _semistable_reducible_primes(E)
        except ValueError:
            return [0]
```

I will fix this by putting in a test for CM much earlier (which did not exist when this code was written).  Also when constructing F we can make sure that the name of iots generator is not the same as that of K.



---

archive/issue_comments_277246.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n \\`\\`\\`\n sage: K.<a> = NumberField(x^2-x+1)\n sage: E = EllipticCurve([a+1,1,1,0,0])\n-sage: C = IsogenyClass_EC_NumberField(E)\n+sage: C = E.isogeny_class(E)\n ...\n ValueError: 0 is not prime.\n \\`\\`\\`\n@@ -30,6 +30,7 @@\n \\`\\`\\`\n (CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)\n \n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/19229\n```\n",
    "created_at": "2015-09-18T10:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277246",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,7 +1,7 @@
 \`\`\`
 sage: K.<a> = NumberField(x^2-x+1)
 sage: E = EllipticCurve([a+1,1,1,0,0])
-sage: C = IsogenyClass_EC_NumberField(E)
+sage: C = E.isogeny_class(E)
 ...
 ValueError: 0 is not prime.
 \`\`\`
@@ -30,6 +30,7 @@
 \`\`\`
 (CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)
 
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/19229
```




---

archive/issue_comments_277247.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2015-09-18T10:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277247",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_277248.json:
```json
{
    "body": "<a id='comment:4'></a>Fixed as follows: on construction of the GaloisRepresentation object the CM status of the elliptic curve is assessed and cached.  This enables some cleaning of the code later where we never have to rely on the raising of exceptions to catch situations which only happen in the CM case.  This does not in itself fix the bug, we just get a different error, so the second fix is to make the variable name of a number field constructed on one function not clash.\n\nAppropriate doctests added here and in the docstring for E.isogeny_class().",
    "created_at": "2015-09-18T10:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277248",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:4'></a>Fixed as follows: on construction of the GaloisRepresentation object the CM status of the elliptic curve is assessed and cached.  This enables some cleaning of the code later where we never have to rely on the raising of exceptions to catch situations which only happen in the CM case.  This does not in itself fix the bug, we just get a different error, so the second fix is to make the variable name of a number field constructed on one function not clash.

Appropriate doctests added here and in the docstring for E.isogeny_class().



---

archive/issue_comments_277249.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-18T10:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277249",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_277250.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,34 @@\n+\\`\\`\\`\n+sage: K.<a> = NumberField(x^2-x+1)\n+sage: E = EllipticCurve([a+1,1,1,0,0])\n+sage: C = E.isogeny_class()\n+...\n+ValueError: 0 is not prime.\n+\\`\\`\\`\n+is caused by\n+\n+\\`\\`\\`\n+sage: from sage.schemes.elliptic_curves.isogeny_class import possible_isogeny_degrees\n+sage: possible_isogeny_degrees(E)                                                                      \n+[0]\n+\\`\\`\\`\n+and in turn by\n+\n+\\`\\`\\`\n+sage: EG = E.galois_representation()\n+sage: EG.reducible_primes()\n+[0]\n+\\`\\`\\`\n+\n+According to the documentation for the last function it should return [0] if and only if E has CM, which is does not:\n+\n+\\`\\`\\`\n+sage: E.has_cm()\n+False\n+sage: E.j_invariant().is_integral()\n+False\n+\\`\\`\\`\n+(CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)\n \n \n Comment: 1\n```\n",
    "created_at": "2015-09-18T10:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277250",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,34 @@
+\`\`\`
+sage: K.<a> = NumberField(x^2-x+1)
+sage: E = EllipticCurve([a+1,1,1,0,0])
+sage: C = E.isogeny_class()
+...
+ValueError: 0 is not prime.
+\`\`\`
+is caused by
+
+\`\`\`
+sage: from sage.schemes.elliptic_curves.isogeny_class import possible_isogeny_degrees
+sage: possible_isogeny_degrees(E)                                                                      
+[0]
+\`\`\`
+and in turn by
+
+\`\`\`
+sage: EG = E.galois_representation()
+sage: EG.reducible_primes()
+[0]
+\`\`\`
+
+According to the documentation for the last function it should return [0] if and only if E has CM, which is does not:
+
+\`\`\`
+sage: E.has_cm()
+False
+sage: E.j_invariant().is_integral()
+False
+\`\`\`
+(CM curves certainly have integral j-invariant, so you don't need to trust the is_cm() method to believe that!)
 
 
 Comment: 1
```




---

archive/issue_comments_277251.json:
```json
{
    "body": "<a id='comment:6'></a>Anyone out there?",
    "created_at": "2015-12-08T17:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277251",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:6'></a>Anyone out there?



---

archive/issue_comments_277252.json:
```json
{
    "body": "<a id='comment:7'></a>What's the point of this \"poor man's caching\", why not use `cached_method`?\n\n```diff\n+        self._has_cm = E.has_cm()\n+        self._has_rational_cm = E.has_rational_cm()\n```\n\nThere seems to be an indentation problem with\n\n```diff\n+ # ramified primes\n```\n\nFunny spacing:\n\n```diff\n+ if E .has_bad_reduction(P):\n```",
    "created_at": "2015-12-08T20:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277252",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>What's the point of this "poor man's caching", why not use `cached_method`?

```diff
+        self._has_cm = E.has_cm()
+        self._has_rational_cm = E.has_rational_cm()
```

There seems to be an indentation problem with

```diff
+ # ramified primes
```

Funny spacing:

```diff
+ if E .has_bad_reduction(P):
```



---

archive/issue_comments_277253.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:\n> What's the point of this \"poor man's caching\", why not use `cached_method`?\n> \n> ```\n> #!diff\n> +        self._has_cm = E.has_cm()\n> +        self._has_rational_cm = E.has_rational_cm()\n> ```\n\n\nNo reason, but that is how it was, and this is a bug fix.\n\n> \n> There seems to be an indentation problem with\n> \n> ```\n> #!diff\n> + # ramified primes\n> ```\n> \n> Funny spacing:\n> \n> ```\n> #!diff\n> + if E .has_bad_reduction(P):\n> ```\n\n\n\nI will look at those.",
    "created_at": "2015-12-09T09:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277253",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:
> What's the point of this "poor man's caching", why not use `cached_method`?
> 
> ```
> #!diff
> +        self._has_cm = E.has_cm()
> +        self._has_rational_cm = E.has_rational_cm()
> ```


No reason, but that is how it was, and this is a bug fix.

> 
> There seems to be an indentation problem with
> 
> ```
> #!diff
> + # ramified primes
> ```
> 
> Funny spacing:
> 
> ```
> #!diff
> + if E .has_bad_reduction(P):
> ```



I will look at those.



---

archive/issue_comments_277254.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-09T10:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277254",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277255.json:
```json
{
    "body": "<a id='comment:10'></a>I merged with current beta, fixed the two spacing issues, made 3 methods into cached_methods as suggested.  I also tidied up imports in ell_number_field.\n\nPlease re-review!",
    "created_at": "2015-12-09T10:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277255",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:10'></a>I merged with current beta, fixed the two spacing issues, made 3 methods into cached_methods as suggested.  I also tidied up imports in ell_number_field.

Please re-review!



---

archive/issue_comments_277256.json:
```json
{
    "body": "<a id='comment:11'></a>Did you do something while committing? I see you added files `src/sage/schemes/hyperelliptic_curves/hypellfrob.cpp` and `src/sage/schemes/toric/divisor_class.c`\n\nI recommend to fix this using `--amend` to make sure these added files don't appear in the git history at all.",
    "created_at": "2015-12-09T15:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277256",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Did you do something while committing? I see you added files `src/sage/schemes/hyperelliptic_curves/hypellfrob.cpp` and `src/sage/schemes/toric/divisor_class.c`

I recommend to fix this using `--amend` to make sure these added files don't appear in the git history at all.



---

archive/issue_events_053353.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-12-09T15:03:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "milestone": "sage-6.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19229#event-53353"
}
```



---

archive/issue_comments_277257.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-09T15:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277257",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277258.json:
```json
{
    "body": "<a id='comment:12'></a>That was a mistake.  git is showing up hundreds of .c, .cpp, .h files which makes \"git status\" hard to read and I added some files by mistake *but then thought that I had removed them again*.  What a pain.  I'll fix it.",
    "created_at": "2015-12-09T15:39:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277258",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:12'></a>That was a mistake.  git is showing up hundreds of .c, .cpp, .h files which makes "git status" hard to read and I added some files by mistake *but then thought that I had removed them again*.  What a pain.  I'll fix it.



---

archive/issue_comments_277259.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 cremona]:\n> git is showing up hundreds of .c, .cpp, .h files which makes \"git status\" hard to read\n\n\nThis isn't supposed to be like that. Do yourself a favour and remove those files.",
    "created_at": "2015-12-09T15:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277259",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 cremona]:
> git is showing up hundreds of .c, .cpp, .h files which makes "git status" hard to read


This isn't supposed to be like that. Do yourself a favour and remove those files.



---

archive/issue_comments_277260.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-09T15:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277260",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_277261.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-12-09T15:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277261",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277262.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 jdemeyer]:\n> Replying to [comment:12 cremona]:\n> > git is showing up hundreds of .c, .cpp, .h files which makes \"git status\" hard to read\n\n> \n> This isn't supposed to be like that. Do yourself a favour and remove those files.\n\n\nAny idea how they got there?  None have anything to do with anything I have done.  I presume a simple rm (not git) will suffice?\n\nI fixed the commit...",
    "created_at": "2015-12-09T15:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277262",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 cremona]:
> > git is showing up hundreds of .c, .cpp, .h files which makes "git status" hard to read

> 
> This isn't supposed to be like that. Do yourself a favour and remove those files.


Any idea how they got there?  None have anything to do with anything I have done.  I presume a simple rm (not git) will suffice?

I fixed the commit...



---

archive/issue_comments_277263.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 cremona]:\n> Any idea how they got there?\n\n\nWell, they are quite old. Note the header:\n\n```\n/* Generated by Cython 0.20.1 on Fri May 2 15:58:45 2014 */\n```\n\nI guess you don't remember what you were doing with your Sage installation that day.\n\nI wouldn't think about it too much. Just delete those files.",
    "created_at": "2015-12-09T16:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277263",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:15 cremona]:
> Any idea how they got there?


Well, they are quite old. Note the header:

```
/* Generated by Cython 0.20.1 on Fri May 2 15:58:45 2014 */
```

I guess you don't remember what you were doing with your Sage installation that day.

I wouldn't think about it too much. Just delete those files.



---

archive/issue_comments_277264.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-12-12T19:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277264",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277265.json:
```json
{
    "body": "<a id='comment:17'></a>Obvious question: what is the performance impact of the earlier CM checks? It seems that the old code was careful to postpone CM checks.\n\nAll the methods where you added a check for CM should have a doctest for the case when there is no CM. Many don't have such a doctest.\n\nLike I said before, this should be replaced by real caching (you implemented the caching, but forgot to remove this part):\n\n```diff\n+        self._has_cm = E.has_cm()\n+        self._has_rational_cm = E.has_rational_cm()\n```\n\nI think this comment is not very clear:\n\n```diff\n+        # See #19229: can cause problems if this name is 'a' but it has to be something!\n+        F = NumberField(y**2 - a, 'grnf_a')\n```",
    "created_at": "2015-12-12T19:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277265",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Obvious question: what is the performance impact of the earlier CM checks? It seems that the old code was careful to postpone CM checks.

All the methods where you added a check for CM should have a doctest for the case when there is no CM. Many don't have such a doctest.

Like I said before, this should be replaced by real caching (you implemented the caching, but forgot to remove this part):

```diff
+        self._has_cm = E.has_cm()
+        self._has_rational_cm = E.has_rational_cm()
```

I think this comment is not very clear:

```diff
+        # See #19229: can cause problems if this name is 'a' but it has to be something!
+        F = NumberField(y**2 - a, 'grnf_a')
```



---

archive/issue_comments_277266.json:
```json
{
    "body": "<a id='comment:18'></a>Just a question (not something to do for this ticket): did you ever consider computing the CM discriminant using the period lattice? If you have a sufficiently good (I guess this is the hard part) approximation to \u03c4, you can compute its minimal polynomial A \u03c4<sup>2</sup> + B \u03c4 + C and from that the discriminant.",
    "created_at": "2015-12-13T11:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277266",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Just a question (not something to do for this ticket): did you ever consider computing the CM discriminant using the period lattice? If you have a sufficiently good (I guess this is the hard part) approximation to τ, you can compute its minimal polynomial A τ<sup>2</sup> + B τ + C and from that the discriminant.



---

archive/issue_comments_277267.json:
```json
{
    "body": "<a id='comment:19'></a>In `src/sage/schemes/elliptic_curves/ell_number_field.py`, there are two lines\n\n```\n         \"\"\"\n```\nindented by **9** spaced instead of 8.",
    "created_at": "2015-12-13T12:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277267",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>In `src/sage/schemes/elliptic_curves/ell_number_field.py`, there are two lines

```
         """
```
indented by **9** spaced instead of 8.



---

archive/issue_comments_277268.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:17 jdemeyer]:\n> Obvious question: what is the performance impact of the earlier CM checks? It seems that the old code was careful to postpone CM checks.\n\n\nGood question.  When the code was first written there was no CM check available, so the presence of CM was detected indirectly; not that for CM curves the output will always be trivial.  So I thought it simpler to put the CM check in early.  On the other hand, whil it is often easy to see that a curve does *not* have CM (e.g. if j is not an algebraic integer), proving that it does have CM is harder.  So perhaps it was better to discover the presence of CM the old way.  I will investigate that.\n\n> \n> All the methods where you added a check for CM should have a doctest for the case when there is no CM. Many don't have such a doctest.\n\n\nOK.\n\n> \n> Like I said before, this should be replaced by real caching (you implemented the caching, but forgot to remove this part):\n> \n> ```\n> #!diff\n> +        self._has_cm = E.has_cm()\n> +        self._has_rational_cm = E.has_rational_cm()\n> ```\n\n\nTo be fixed.\n\n> \n> I think this comment is not very clear:\n> \n> ```\n> #!diff\n> +        # See #19229: can cause problems if this name is 'a' but it has to be something!\n> +        F = NumberField(y**2 - a, 'grnf_a')\n> ```\n\n\nI'll explain here and also make the comment clearer.  The original bug was only triggered when the base field already had 'a' as the name for its generator.  Here we need to construct a number field and so we need a name which must not be a name used before in a similar context.  So I cam up with such a name (I think grnfstands for \"Galois Rep Number Field\").",
    "created_at": "2015-12-14T20:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277268",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:20'></a>Replying to [comment:17 jdemeyer]:
> Obvious question: what is the performance impact of the earlier CM checks? It seems that the old code was careful to postpone CM checks.


Good question.  When the code was first written there was no CM check available, so the presence of CM was detected indirectly; not that for CM curves the output will always be trivial.  So I thought it simpler to put the CM check in early.  On the other hand, whil it is often easy to see that a curve does *not* have CM (e.g. if j is not an algebraic integer), proving that it does have CM is harder.  So perhaps it was better to discover the presence of CM the old way.  I will investigate that.

> 
> All the methods where you added a check for CM should have a doctest for the case when there is no CM. Many don't have such a doctest.


OK.

> 
> Like I said before, this should be replaced by real caching (you implemented the caching, but forgot to remove this part):
> 
> ```
> #!diff
> +        self._has_cm = E.has_cm()
> +        self._has_rational_cm = E.has_rational_cm()
> ```


To be fixed.

> 
> I think this comment is not very clear:
> 
> ```
> #!diff
> +        # See #19229: can cause problems if this name is 'a' but it has to be something!
> +        F = NumberField(y**2 - a, 'grnf_a')
> ```


I'll explain here and also make the comment clearer.  The original bug was only triggered when the base field already had 'a' as the name for its generator.  Here we need to construct a number field and so we need a name which must not be a name used before in a similar context.  So I cam up with such a name (I think grnfstands for "Galois Rep Number Field").



---

archive/issue_comments_277269.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:18 jdemeyer]:\n> Just a question (not something to do for this ticket): did you ever consider computing the CM discriminant using the period lattice? If you have a sufficiently good (I guess this is the hard part) approximation to \u03c4, you can compute its minimal polynomial A \u03c4<sup>2</sup> + B \u03c4 + C and from that the discriminant.\n\n\nInteresting idea.  Note that the existing code involves computing Hilbert Class Polynomials which does something similar.  We can get tau to high precision easily since there is such a fast convergence for the periods.  But some care would be needed to make this rigorous.\n\nImproving the detection of CM would certainly be useful.",
    "created_at": "2015-12-14T20:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277269",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:21'></a>Replying to [comment:18 jdemeyer]:
> Just a question (not something to do for this ticket): did you ever consider computing the CM discriminant using the period lattice? If you have a sufficiently good (I guess this is the hard part) approximation to τ, you can compute its minimal polynomial A τ<sup>2</sup> + B τ + C and from that the discriminant.


Interesting idea.  Note that the existing code involves computing Hilbert Class Polynomials which does something similar.  We can get tau to high precision easily since there is such a fast convergence for the periods.  But some care would be needed to make this rigorous.

Improving the detection of CM would certainly be useful.



---

archive/issue_comments_277270.json:
```json
{
    "body": "<a id='comment:22'></a>The new commit addresses the caching issue and the testing of the CM special cases.  I also improved CM detection simply by caching the relevant functions.  Testing whether one algebraic integer j of degree h is CM involves computing the quadratic orders of class number h: this is now cached so only done once for each h;  and then computing the Hilbert class polynomials for each of these: now also cached, so as soon as a non-CM j of degree h is tested then testing any others of the same degree is no harder than checking whether its absolute minimal polynomial is in a cached list.\n\nPushing the new commit once tests have completed.",
    "created_at": "2015-12-29T17:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277270",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:22'></a>The new commit addresses the caching issue and the testing of the CM special cases.  I also improved CM detection simply by caching the relevant functions.  Testing whether one algebraic integer j of degree h is CM involves computing the quadratic orders of class number h: this is now cached so only done once for each h;  and then computing the Hilbert class polynomials for each of these: now also cached, so as soon as a non-CM j of degree h is tested then testing any others of the same degree is no harder than checking whether its absolute minimal polynomial is in a cached list.

Pushing the new commit once tests have completed.



---

archive/issue_comments_277271.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-29T18:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277272.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-04T14:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277272",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277273.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-02-03T07:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277273",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_277274.json:
```json
{
    "body": "<a id='comment:25'></a>does no longer apply.",
    "created_at": "2016-02-03T07:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277274",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:25'></a>does no longer apply.



---

archive/issue_comments_277275.json:
```json
{
    "body": "<a id='comment:26'></a>Dammit, I thought this was merged ages ago.  So I'll fix it -- I am using it every day!",
    "created_at": "2016-02-03T08:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277275",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:26'></a>Dammit, I thought this was merged ages ago.  So I'll fix it -- I am using it every day!



---

archive/issue_comments_277276.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-04T14:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277276",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277277.json:
```json
{
    "body": "<a id='comment:28'></a>OK, I merged into 7.0.beta1 and make some import adjustments so it now works.\n\n---\nNew commits:",
    "created_at": "2016-02-04T14:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277277",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:28'></a>OK, I merged into 7.0.beta1 and make some import adjustments so it now works.

---
New commits:



---

archive/issue_comments_277278.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-02-04T14:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277278",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_277279.json:
```json
{
    "body": "<a id='comment:29'></a>two failing doctests !",
    "created_at": "2016-02-04T16:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277279",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>two failing doctests !



---

archive/issue_comments_277280.json:
```json
{
    "body": "<a id='comment:30'></a>I can guess which ones wince I noticed that there are two which sometoimes do work and sometimes do not.  Since you do not tell me, I guess that these are the 2 6x6 matrices for the CM isogeny class example with class number 6.\n\nIn my defence, I can assure you that on my machine the tests *did* pass before I uploaded the branch....",
    "created_at": "2016-02-04T17:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277280",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:30'></a>I can guess which ones wince I noticed that there are two which sometoimes do work and sometimes do not.  Since you do not tell me, I guess that these are the 2 6x6 matrices for the CM isogeny class example with class number 6.

In my defence, I can assure you that on my machine the tests *did* pass before I uploaded the branch....



---

archive/issue_comments_277281.json:
```json
{
    "body": "<a id='comment:31'></a>To know the failing doctest, you have to click on the patchbot icon (currently yellow with a question mark) at the top right of this page. \n\nThen click on the \"shortlog\" link of the next-to-last report by \"poseidon\" patchbot.\n\nThis is indeed a 6*6 matrix of numbers and a 6*6 matrix of lists.",
    "created_at": "2016-02-04T19:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277281",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:31'></a>To know the failing doctest, you have to click on the patchbot icon (currently yellow with a question mark) at the top right of this page. 

Then click on the "shortlog" link of the next-to-last report by "poseidon" patchbot.

This is indeed a 6*6 matrix of numbers and a 6*6 matrix of lists.



---

archive/issue_comments_277282.json:
```json
{
    "body": "<a id='comment:32'></a>Yes that is the thing I was expecting.  Note that there is another bot on which the test passes.  It's something nondeterministic in how I sort the curves in an isogeny class.",
    "created_at": "2016-02-04T19:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277282",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:32'></a>Yes that is the thing I was expecting.  Note that there is another bot on which the test passes.  It's something nondeterministic in how I sort the curves in an isogeny class.



---

archive/issue_comments_277283.json:
```json
{
    "body": "<a id='comment:33'></a>By the, this (sometimes) failing doctest has nothing whatsoever to do with the changes on this ticket, but there is some randomness creeping into the sorting of curves.",
    "created_at": "2016-02-04T20:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277283",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:33'></a>By the, this (sometimes) failing doctest has nothing whatsoever to do with the changes on this ticket, but there is some randomness creeping into the sorting of curves.



---

archive/issue_comments_277284.json:
```json
{
    "body": "<a id='comment:34'></a>I have found a typo (several times):\n\n```\ninfintely many primes\n```\nOtherwise looks good to me (but I am no expert)",
    "created_at": "2016-02-04T20:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277284",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:34'></a>I have found a typo (several times):

```
infintely many primes
```
Otherwise looks good to me (but I am no expert)



---

archive/issue_events_053354.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-02-04T20:56:44Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "milestone": "sage-6.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19229#event-53354"
}
```



---

archive/issue_events_053355.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-02-04T20:56:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "milestone": "sage-7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19229#event-53355"
}
```



---

archive/issue_comments_277285.json:
```json
{
    "body": "<a id='comment:36'></a>Would people be bothered if I marked the two strange doctests as \"random\" for the time being?  Otherwise this sorting issue is delaying the merging of a genuine bug-fix.  I have a strong personal incentive to get the sorting issue dealt with, but that should not be on this ticket anyway.\n\nI plan to update the branch accordingly.",
    "created_at": "2016-02-09T14:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277285",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:36'></a>Would people be bothered if I marked the two strange doctests as "random" for the time being?  Otherwise this sorting issue is delaying the merging of a genuine bug-fix.  I have a strong personal incentive to get the sorting issue dealt with, but that should not be on this ticket anyway.

I plan to update the branch accordingly.



---

archive/issue_comments_277286.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:36 cremona]:\n> Would people be bothered if I marked the two strange doctests as \"random\" for the time being?\n\n\nWith proper documentation and a reference to the discussion, no problem.",
    "created_at": "2016-02-09T14:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277286",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Replying to [comment:36 cremona]:
> Would people be bothered if I marked the two strange doctests as "random" for the time being?


With proper documentation and a reference to the discussion, no problem.



---

archive/issue_comments_277287.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:\n> Replying to [comment:36 cremona]:\n> > Would people be bothered if I marked the two strange doctests as \"random\" for the time being?\n\n> \n> With proper documentation and a reference to the discussion, no problem.\n\n\nOK, I'll see if I can meet your high standards or \"proper\"!\n\nI corrected all occurrences of \"infintely\" also (2 here, but a few a other places).",
    "created_at": "2016-02-09T16:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277287",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:38'></a>Replying to [comment:37 jdemeyer]:
> Replying to [comment:36 cremona]:
> > Would people be bothered if I marked the two strange doctests as "random" for the time being?

> 
> With proper documentation and a reference to the discussion, no problem.


OK, I'll see if I can meet your high standards or "proper"!

I corrected all occurrences of "infintely" also (2 here, but a few a other places).



---

archive/issue_comments_277288.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-09T16:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_277289.json:
```json
{
    "body": "<a id='comment:40'></a>I opened a new ticket #20028 for the issue of sorting number field elements.  Th ebranch now marks thoe tests as #random and refers to the discussion on this ticket.\n\n---\nNew commits:",
    "created_at": "2016-02-09T16:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277289",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:40'></a>I opened a new ticket #20028 for the issue of sorting number field elements.  Th ebranch now marks thoe tests as #random and refers to the discussion on this ticket.

---
New commits:



---

archive/issue_comments_277290.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-02-09T21:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277290",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_277291.json:
```json
{
    "body": "<a id='comment:41'></a>ok, good enough for me",
    "created_at": "2016-02-09T21:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277291",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:41'></a>ok, good enough for me



---

archive/issue_events_053356.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-02-10T08:20:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19229#event-53356"
}
```



---

archive/issue_comments_277292.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-02-10T08:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19229#issuecomment-277292",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
