# Issue 19077: Greatly speed up equality check of equal graphs

archive/issues_018840.json:
```json
{
    "body": "The current code goes over all vertex pairs and checks existence of all possible edges, which is extremely inefficient for, say, posets, whose graphs are far from complete. This is a big problem when mixed with unique representation of finite posets.\n\nSo let's iterate over edges directly.\n\n**CC:**  @fchapoton @nathanncohen\n\n**Branch/Commit:** [959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)\n\n**Reviewer:** Jori M\u00e4ntysalo, Nathann Cohen\n\n**Author:** Andrey Novoseltsev\n\nIssue created by migration from https://trac.sagemath.org/ticket/19077\n\n",
    "closed_at": "2015-08-26T03:00:12Z",
    "created_at": "2015-08-24T01:04:58Z",
    "labels": [
        "component: graph theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Greatly speed up equality check of equal graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19077",
    "user": "https://github.com/novoselt"
}
```
The current code goes over all vertex pairs and checks existence of all possible edges, which is extremely inefficient for, say, posets, whose graphs are far from complete. This is a big problem when mixed with unique representation of finite posets.

So let's iterate over edges directly.

**CC:**  @fchapoton @nathanncohen

**Branch/Commit:** [959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)

**Reviewer:** Jori M채ntysalo, Nathann Cohen

**Author:** Andrey Novoseltsev

Issue created by migration from https://trac.sagemath.org/ticket/19077





---

archive/issue_comments_273204.json:
```json
{
    "body": "**Branch:** [u/novoselt/graph_eq](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/graph_eq)",
    "created_at": "2015-08-24T03:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273204",
    "user": "https://github.com/novoselt"
}
```

**Branch:** [u/novoselt/graph_eq](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/graph_eq)



---

archive/issue_comments_273205.json:
```json
{
    "body": "<a id='comment:2'></a>\nI've run into this problem while profiling code I am working on (face lattice posets for reflexive polytopes). First run:\n\n```\n 13550671 function calls (13542023 primitive calls) in 73.684 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n     4319   10.815    0.003   66.951    0.016 hasse_diagram.py:24(Hasse_diagram_from_incidences)\n    21595    7.663    0.000   25.948    0.001 digraph.py:468(__init__)\n  1510140    6.001    0.000    7.231    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}\n   148526    4.442    0.000    6.108    0.000 lattice_polytope.py:527(__eq__)\n     4319    3.730    0.001   73.397    0.017 lattice_polytope.py:1822(face_lattice)\n17276/12957    3.532    0.000   20.710    0.002 generic_graph.py:19289(relabel)\n    17276    3.364    0.000   10.626    0.001 generic_graph.py:9865(add_edges)\n   946746    2.268    0.000    2.268    0.000 {hash}\n  1765714    2.156    0.000    2.156    0.000 toric_lattice.py:922(ambient_module)\n  1397396    2.030    0.000    2.030    0.000 {method 'intersection' of 'frozenset' objects}\n```\nsecond run recreating the same posets:\n\n```\n 58955399 function calls in 216.966 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n  9250954   46.562    0.000   63.004    0.000 lattice_polytope.py:527(__eq__)\n 13056672   43.472    0.000  101.665    0.000 {method 'has_edge' of 'sage.graphs.base.static_sparse_backend.StaticSparseBackend' objects}\n 13056672   38.784    0.000  140.449    0.000 generic_graph.py:10290(has_edge)\n     4319   23.099    0.005  166.699    0.039 generic_graph.py:392(__eq__)\n  9320064   11.157    0.000   11.157    0.000 {isinstance}\n     4319   10.888    0.003  210.421    0.049 hasse_diagram.py:24(Hasse_diagram_from_incidences)\n  4996396    6.084    0.000    6.084    0.000 toric_lattice.py:922(ambient_module)\n     4319    3.726    0.001  216.860    0.050 lattice_polytope.py:1822(face_lattice)\n     8638    3.073    0.000   11.644    0.001 digraph.py:468(__init__)\n   604056    2.673    0.000    3.296    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}\n     8638    2.391    0.000    6.914    0.001 generic_graph.py:19295(relabel)\n   807792    2.049    0.000    2.049    0.000 {hash}\n  1397396    2.013    0.000    2.013    0.000 {method 'intersection' of 'frozenset' objects}\n```\nafter my change the second run becomes\n\n```\n13591197 function calls in 61.236 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n     4319   10.819    0.003   54.643    0.013 hasse_diagram.py:24(Hasse_diagram_from_incidences)\n   939270    5.871    0.000    8.093    0.000 lattice_polytope.py:527(__eq__)\n     4319    3.766    0.001   61.136    0.014 lattice_polytope.py:1822(face_lattice)\n     8638    3.065    0.000   11.563    0.001 digraph.py:468(__init__)\n   604056    2.653    0.000    3.282    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}\n     8638    2.366    0.000    6.870    0.001 generic_graph.py:19289(relabel)\n   807792    2.045    0.000    2.045    0.000 {hash}\n  1397396    2.007    0.000    2.007    0.000 {method 'intersection' of 'frozenset' objects}\n   302028    1.833    0.000    5.092    0.000 {method 'has_edge' of 'sage.graphs.base.static_sparse_backend.StaticSparseBackend' objects}\n  1436908    1.760    0.000    1.760    0.000 toric_lattice.py:922(ambient_module)\n```\nso there is actually speed gain due to posets being stored...\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef\">6e83ae0</a></td><td><code>Speed up equality check of graphs with no multiple edges.</code></td></tr></table>\n",
    "created_at": "2015-08-24T03:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273205",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>
I've run into this problem while profiling code I am working on (face lattice posets for reflexive polytopes). First run:

```
 13550671 function calls (13542023 primitive calls) in 73.684 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     4319   10.815    0.003   66.951    0.016 hasse_diagram.py:24(Hasse_diagram_from_incidences)
    21595    7.663    0.000   25.948    0.001 digraph.py:468(__init__)
  1510140    6.001    0.000    7.231    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}
   148526    4.442    0.000    6.108    0.000 lattice_polytope.py:527(__eq__)
     4319    3.730    0.001   73.397    0.017 lattice_polytope.py:1822(face_lattice)
17276/12957    3.532    0.000   20.710    0.002 generic_graph.py:19289(relabel)
    17276    3.364    0.000   10.626    0.001 generic_graph.py:9865(add_edges)
   946746    2.268    0.000    2.268    0.000 {hash}
  1765714    2.156    0.000    2.156    0.000 toric_lattice.py:922(ambient_module)
  1397396    2.030    0.000    2.030    0.000 {method 'intersection' of 'frozenset' objects}
```
second run recreating the same posets:

```
 58955399 function calls in 216.966 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  9250954   46.562    0.000   63.004    0.000 lattice_polytope.py:527(__eq__)
 13056672   43.472    0.000  101.665    0.000 {method 'has_edge' of 'sage.graphs.base.static_sparse_backend.StaticSparseBackend' objects}
 13056672   38.784    0.000  140.449    0.000 generic_graph.py:10290(has_edge)
     4319   23.099    0.005  166.699    0.039 generic_graph.py:392(__eq__)
  9320064   11.157    0.000   11.157    0.000 {isinstance}
     4319   10.888    0.003  210.421    0.049 hasse_diagram.py:24(Hasse_diagram_from_incidences)
  4996396    6.084    0.000    6.084    0.000 toric_lattice.py:922(ambient_module)
     4319    3.726    0.001  216.860    0.050 lattice_polytope.py:1822(face_lattice)
     8638    3.073    0.000   11.644    0.001 digraph.py:468(__init__)
   604056    2.673    0.000    3.296    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}
     8638    2.391    0.000    6.914    0.001 generic_graph.py:19295(relabel)
   807792    2.049    0.000    2.049    0.000 {hash}
  1397396    2.013    0.000    2.013    0.000 {method 'intersection' of 'frozenset' objects}
```
after my change the second run becomes

```
13591197 function calls in 61.236 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     4319   10.819    0.003   54.643    0.013 hasse_diagram.py:24(Hasse_diagram_from_incidences)
   939270    5.871    0.000    8.093    0.000 lattice_polytope.py:527(__eq__)
     4319    3.766    0.001   61.136    0.014 lattice_polytope.py:1822(face_lattice)
     8638    3.065    0.000   11.563    0.001 digraph.py:468(__init__)
   604056    2.653    0.000    3.282    0.000 {method 'add_edge' of 'sage.graphs.base.sparse_graph.SparseGraphBackend' objects}
     8638    2.366    0.000    6.870    0.001 generic_graph.py:19289(relabel)
   807792    2.045    0.000    2.045    0.000 {hash}
  1397396    2.007    0.000    2.007    0.000 {method 'intersection' of 'frozenset' objects}
   302028    1.833    0.000    5.092    0.000 {method 'has_edge' of 'sage.graphs.base.static_sparse_backend.StaticSparseBackend' objects}
  1436908    1.760    0.000    1.760    0.000 toric_lattice.py:922(ambient_module)
```
so there is actually speed gain due to posets being stored...

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef">6e83ae0</a></td><td><code>Speed up equality check of graphs with no multiple edges.</code></td></tr></table>




---

archive/issue_comments_273206.json:
```json
{
    "body": "**Commit:** [6e83ae06e04597ddcf92cd981f4f690c4b57deef](https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef)",
    "created_at": "2015-08-24T03:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273206",
    "user": "https://github.com/novoselt"
}
```

**Commit:** [6e83ae06e04597ddcf92cd981f4f690c4b57deef](https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef)



---

archive/issue_comments_273207.json:
```json
{
    "body": "**Author:** Andrey Novoseltsev",
    "created_at": "2015-08-24T03:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273207",
    "user": "https://github.com/novoselt"
}
```

**Author:** Andrey Novoseltsev



---

archive/issue_events_175059.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-08-24T03:19:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19077#event-175059"
}
```



---

archive/issue_comments_273208.json:
```json
{
    "body": "<a id='comment:4'></a>\nI can review this.\n\nJust a side note: why test `self.weighted() != other.weighted()` is after `any(x not in other for x in self)`? Seems unlogical exception to rule of having most easy tests first.",
    "created_at": "2015-08-24T05:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273208",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:4'></a>
I can review this.

Just a side note: why test `self.weighted() != other.weighted()` is after `any(x not in other for x in self)`? Seems unlogical exception to rule of having most easy tests first.



---

archive/issue_comments_273209.json:
```json
{
    "body": "**Reviewer:** Jori M\u00e4ntysalo",
    "created_at": "2015-08-24T05:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273209",
    "user": "https://github.com/jm58660"
}
```

**Reviewer:** Jori M채ntysalo



---

archive/issue_comments_273210.json:
```json
{
    "body": "<a id='comment:5'></a>\nSpeedup confirmed. After `P7 = Posets(7).list()` the command `P=Posets.ChainPoset(7)` took about 635 microseconds, after this patch it takes about 540 microseconds. I ran the test on i5-3470 @ 3.20GHz.\n\nYou can mark this as positive_review. Or if you want, check my comment above.",
    "created_at": "2015-08-24T06:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273210",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:5'></a>
Speedup confirmed. After `P7 = Posets(7).list()` the command `P=Posets.ChainPoset(7)` took about 635 microseconds, after this patch it takes about 540 microseconds. I ran the test on i5-3470 @ 3.20GHz.

You can mark this as positive_review. Or if you want, check my comment above.



---

archive/issue_comments_273211.json:
```json
{
    "body": "<a id='comment:6'></a>\nJust a note: if you ever want more speed than that for posets, it is possible to get it. Posets are stored internally as 'static sparse graphs', and that can be done in linear time (~m) instead of ~mlog(n) here.\n\nThat speedup with be small, however, compared to this one.\n\nNathann",
    "created_at": "2015-08-24T08:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273211",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>
Just a note: if you ever want more speed than that for posets, it is possible to get it. Posets are stored internally as 'static sparse graphs', and that can be done in linear time (~m) instead of ~mlog(n) here.

That speedup with be small, however, compared to this one.

Nathann



---

archive/issue_comments_273212.json:
```json
{
    "body": "<a id='comment:7'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2\">536c481</a></td><td><code>Further clean up of graph equality.</code></td></tr></table>\n",
    "created_at": "2015-08-24T15:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273212",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2">536c481</a></td><td><code>Further clean up of graph equality.</code></td></tr></table>




---

archive/issue_comments_273213.json:
```json
{
    "body": "**Changing commit** from \"[6e83ae06e04597ddcf92cd981f4f690c4b57deef](https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef)\" to \"[536c4817a1a8521c49255b75c6a6b475d10e38d2](https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2)\".",
    "created_at": "2015-08-24T15:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273213",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[6e83ae06e04597ddcf92cd981f4f690c4b57deef](https://github.com/sagemath/sagetrac-mirror/commit/6e83ae06e04597ddcf92cd981f4f690c4b57deef)" to "[536c4817a1a8521c49255b75c6a6b475d10e38d2](https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2)".



---

archive/issue_comments_273214.json:
```json
{
    "body": "<a id='comment:8'></a>\nThanks for taking a look! Went over the rest of the code without changing the logic.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2\">536c481</a></td><td><code>Further clean up of graph equality.</code></td></tr></table>\n",
    "created_at": "2015-08-24T15:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273214",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:8'></a>
Thanks for taking a look! Went over the rest of the code without changing the logic.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2">536c481</a></td><td><code>Further clean up of graph equality.</code></td></tr></table>




---

archive/issue_comments_273215.json:
```json
{
    "body": "<a id='comment:9'></a>\nYou build a list of booleans that you do not need ... And if you use iterators, you will build an iterator that you do not need either.\n\nTechnically (though you did not introduce it) comparing labels by sorting lists if wrong, as you cannot suppose that the labels are TOTALLY ordered. Should be a set comparison instead.\n\nNathann",
    "created_at": "2015-08-24T16:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273215",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:9'></a>
You build a list of booleans that you do not need ... And if you use iterators, you will build an iterator that you do not need either.

Technically (though you did not introduce it) comparing labels by sorting lists if wrong, as you cannot suppose that the labels are TOTALLY ordered. Should be a set comparison instead.

Nathann



---

archive/issue_comments_273216.json:
```json
{
    "body": "**Changing commit** from \"[536c4817a1a8521c49255b75c6a6b475d10e38d2](https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2)\" to \"[f2a826c5f5b28ab793d1eb750a87d91f9bafbb96](https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96)\".",
    "created_at": "2015-08-24T17:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273216",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[536c4817a1a8521c49255b75c6a6b475d10e38d2](https://github.com/sagemath/sagetrac-mirror/commit/536c4817a1a8521c49255b75c6a6b475d10e38d2)" to "[f2a826c5f5b28ab793d1eb750a87d91f9bafbb96](https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96)".



---

archive/issue_comments_273217.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96\">f2a826c</a></td><td><code>Don't rely on label sorting in graph __eq__</code></td></tr></table>\n",
    "created_at": "2015-08-24T17:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273217",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96">f2a826c</a></td><td><code>Don't rely on label sorting in graph __eq__</code></td></tr></table>




---

archive/issue_comments_273218.json:
```json
{
    "body": "<a id='comment:11'></a>\nGood points!\n\nThe new version goes through edges of self and throws away edges of other. Since edges have some canonical order, I assume that it should be relatively fast (i.e. we usually will remove the first element) and technically should work for all cases, but the original change avoids creating lists of edges.",
    "created_at": "2015-08-24T17:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273218",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:11'></a>
Good points!

The new version goes through edges of self and throws away edges of other. Since edges have some canonical order, I assume that it should be relatively fast (i.e. we usually will remove the first element) and technically should work for all cases, but the original change avoids creating lists of edges.



---

archive/issue_comments_273219.json:
```json
{
    "body": "<a id='comment:12'></a>\n> The new version goes through edges of self and throws away edges of other. Since edges have some canonical order, I assume that it should be relatively fast (i.e. we usually will remove the first element) and technically should work for all cases, but the original change avoids creating lists of edges.\n\n\nI have to say that I do not like this `list.remove` thing at all. I added a commit at `public/19077`, what do you think?\n\nNathann",
    "created_at": "2015-08-24T19:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273219",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>
> The new version goes through edges of self and throws away edges of other. Since edges have some canonical order, I assume that it should be relatively fast (i.e. we usually will remove the first element) and technically should work for all cases, but the original change avoids creating lists of edges.


I have to say that I do not like this `list.remove` thing at all. I added a commit at `public/19077`, what do you think?

Nathann



---

archive/issue_comments_273220.json:
```json
{
    "body": "<a id='comment:13'></a>\nYou've changed the meaning: `labels=self._weighted and other._weighted` is consistent with the documentation, while `labels=self._weighted` is not.\n\nRegarding the multi-edge check: what I have tried to do was avoiding `sorted` since you have pointed out that labels may not be sortable. I don't see any real alternative to doing what I've done then.",
    "created_at": "2015-08-24T19:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273220",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:13'></a>
You've changed the meaning: `labels=self._weighted and other._weighted` is consistent with the documentation, while `labels=self._weighted` is not.

Regarding the multi-edge check: what I have tried to do was avoiding `sorted` since you have pointed out that labels may not be sortable. I don't see any real alternative to doing what I've done then.



---

archive/issue_comments_273221.json:
```json
{
    "body": "<a id='comment:14'></a>\n> You've changed the meaning: `labels=self._weighted and other._weighted` is consistent with the documentation, while `labels=self._weighted` is not.\n\n\nI did that because it is tested several lines above that `self.weighted() == other.weighted()`.\n\n> Regarding the multi-edge check: what I have tried to do was avoiding `sorted` since you have pointed out that labels may not be sortable. I don't see any real alternative to doing what I've done then.\n\n\nOh. I see. Well, then if you want to compare lists like that, then it can be done on the lists of labels directly, instead of the lists of all edges.\n\nNathann",
    "created_at": "2015-08-24T20:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273221",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:14'></a>
> You've changed the meaning: `labels=self._weighted and other._weighted` is consistent with the documentation, while `labels=self._weighted` is not.


I did that because it is tested several lines above that `self.weighted() == other.weighted()`.

> Regarding the multi-edge check: what I have tried to do was avoiding `sorted` since you have pointed out that labels may not be sortable. I don't see any real alternative to doing what I've done then.


Oh. I see. Well, then if you want to compare lists like that, then it can be done on the lists of labels directly, instead of the lists of all edges.

Nathann



---

archive/issue_comments_273222.json:
```json
{
    "body": "<a id='comment:15'></a>\nI've started writing it down, but can't help liking my last variant more as it is shorter and cleaner. What exactly is gained if we do the same thing for the list of labels of each edge? It seems to me that only some memory efficiency since the list of edges will not be created all at once. But given that we already have graphs in place, it does not seem like a total waste of memory.\n\nSo I propose merging the current brunch as an improvement over what used to be.",
    "created_at": "2015-08-24T22:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273222",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:15'></a>
I've started writing it down, but can't help liking my last variant more as it is shorter and cleaner. What exactly is gained if we do the same thing for the list of labels of each edge? It seems to me that only some memory efficiency since the list of edges will not be created all at once. But given that we already have graphs in place, it does not seem like a total waste of memory.

So I propose merging the current brunch as an improvement over what used to be.



---

archive/issue_comments_273223.json:
```json
{
    "body": "<a id='comment:16'></a>\n> What exactly is gained if we do the same thing for the list of labels of each edge? It seems to me that only some memory efficiency since the list of edges will not be created all at once. But given that we already have graphs in place, it does not seem like a total waste of memory.\n\n\nA graph, in the case of Poset, is stored as a 'static sparse graph', i.e. as a int array in order to save as much ram as possible. First, consider that calling `.edges()` may (in theory) require an amount of memory compared to which the original graph itself is negligible, as it would store it as a Python lis of pairs.\n\nThen, `.edges()` sorts its output (that's not necessarily a good idea, I know).\n\nStill, in theory, the result of `G.edges` cannot be assumed to be unique on two graphs which are equal. This, because sorting pairs requires sorting vertices, and that vertices need not be totally ordered. \n\nSo, in theory, there is nothing at all that can lead to think that what you algorithm does is not *totally awful*, i.e. a complexity of `m^2` comparisons between vertices (i.e. find m times an edge in a list of size m).\n\nIf you insist on changing the way labels are tested for equality in this ticket, and if we do not plan to require labels to be hashable in order to test equality between two graphs (which would let us compare sets instead of lists), then for this reason I think that it would be better to use this 'set equality without hashing' through lists that you use, but to use it on labels instead of using it on the whole list of edges.\n\nIn the 'easy case' where the graph is simple but is declared in Sage as a multigraph, this algorithm would, at least, offer similar performance as the one defined on simple graphs.\n\nNathann",
    "created_at": "2015-08-25T06:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273223",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>
> What exactly is gained if we do the same thing for the list of labels of each edge? It seems to me that only some memory efficiency since the list of edges will not be created all at once. But given that we already have graphs in place, it does not seem like a total waste of memory.


A graph, in the case of Poset, is stored as a 'static sparse graph', i.e. as a int array in order to save as much ram as possible. First, consider that calling `.edges()` may (in theory) require an amount of memory compared to which the original graph itself is negligible, as it would store it as a Python lis of pairs.

Then, `.edges()` sorts its output (that's not necessarily a good idea, I know).

Still, in theory, the result of `G.edges` cannot be assumed to be unique on two graphs which are equal. This, because sorting pairs requires sorting vertices, and that vertices need not be totally ordered. 

So, in theory, there is nothing at all that can lead to think that what you algorithm does is not *totally awful*, i.e. a complexity of `m^2` comparisons between vertices (i.e. find m times an edge in a list of size m).

If you insist on changing the way labels are tested for equality in this ticket, and if we do not plan to require labels to be hashable in order to test equality between two graphs (which would let us compare sets instead of lists), then for this reason I think that it would be better to use this 'set equality without hashing' through lists that you use, but to use it on labels instead of using it on the whole list of edges.

In the 'easy case' where the graph is simple but is declared in Sage as a multigraph, this algorithm would, at least, offer similar performance as the one defined on simple graphs.

Nathann



---

archive/issue_comments_273224.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e96b20cf61f0e4e9d6405a89313045c06dc29cef\">e96b20c</a></td><td><code>trac #19077: Equality test for multigraphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7\">959c85d</a></td><td><code>Compare labels edge by edge without relying on total order.</code></td></tr></table>\n",
    "created_at": "2015-08-25T15:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e96b20cf61f0e4e9d6405a89313045c06dc29cef">e96b20c</a></td><td><code>trac #19077: Equality test for multigraphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7">959c85d</a></td><td><code>Compare labels edge by edge without relying on total order.</code></td></tr></table>




---

archive/issue_comments_273225.json:
```json
{
    "body": "**Changing commit** from \"[f2a826c5f5b28ab793d1eb750a87d91f9bafbb96](https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96)\" to \"[959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)\".",
    "created_at": "2015-08-25T15:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f2a826c5f5b28ab793d1eb750a87d91f9bafbb96](https://github.com/sagemath/sagetrac-mirror/commit/f2a826c5f5b28ab793d1eb750a87d91f9bafbb96)" to "[959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)".



---

archive/issue_comments_273226.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The current code goes over all vertex pairs and checks existence of all possible edges, which is extremely inefficient for, say, posets, whose graphs are far from complete. This is a big problem when mixed with unique representation of finite posets.\n \n-So let's iterate over edges directly. Multiple edges are trickier and are not dealt with here.\n+So let's iterate over edges directly.\n``````\n",
    "created_at": "2015-08-25T15:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273226",
    "user": "https://github.com/novoselt"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The current code goes over all vertex pairs and checks existence of all possible edges, which is extremely inefficient for, say, posets, whose graphs are far from complete. This is a big problem when mixed with unique representation of finite posets.
 
-So let's iterate over edges directly. Multiple edges are trickier and are not dealt with here.
+So let's iterate over edges directly.
``````




---

archive/issue_comments_273227.json:
```json
{
    "body": "<a id='comment:18'></a>\nOK - no more long lists and no relying on sorting but doing it in case it helps. I guess complexity is now like `pairs_of_connected_vertices * number_of_labels_per_pair * log(number_of_labels_per_pair)` when there is order and without taking log when there is not.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e96b20cf61f0e4e9d6405a89313045c06dc29cef\">e96b20c</a></td><td><code>trac #19077: Equality test for multigraphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7\">959c85d</a></td><td><code>Compare labels edge by edge without relying on total order.</code></td></tr></table>\n",
    "created_at": "2015-08-25T15:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273227",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:18'></a>
OK - no more long lists and no relying on sorting but doing it in case it helps. I guess complexity is now like `pairs_of_connected_vertices * number_of_labels_per_pair * log(number_of_labels_per_pair)` when there is order and without taking log when there is not.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e96b20cf61f0e4e9d6405a89313045c06dc29cef">e96b20c</a></td><td><code>trac #19077: Equality test for multigraphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7">959c85d</a></td><td><code>Compare labels edge by edge without relying on total order.</code></td></tr></table>




---

archive/issue_comments_273228.json:
```json
{
    "body": "<a id='comment:19'></a>\nHello !\n\nI agree with the new version of the code. I would have prefered if you had left it where it was, i.e. indented after a 'else'. I consider it a matter of \"personal taste\", and I believe that it is 'better manners' not to force your own taste on what was there before you arrived. Not very important.\n\nBesides this, I agree with your code so you can consider it positively reviewed (let's way for the patchbot's green light, just in case).\n\nThanks,\n\nNathann",
    "created_at": "2015-08-25T16:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273228",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:19'></a>
Hello !

I agree with the new version of the code. I would have prefered if you had left it where it was, i.e. indented after a 'else'. I consider it a matter of "personal taste", and I believe that it is 'better manners' not to force your own taste on what was there before you arrived. Not very important.

Besides this, I agree with your code so you can consider it positively reviewed (let's way for the patchbot's green light, just in case).

Thanks,

Nathann



---

archive/issue_comments_273229.json:
```json
{
    "body": "<a id='comment:20'></a>\nRan `make ptestlong` with no issues. Thanks for reviewing and I'll work on improving my manners ;-)",
    "created_at": "2015-08-25T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273229",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:20'></a>
Ran `make ptestlong` with no issues. Thanks for reviewing and I'll work on improving my manners ;-)



---

archive/issue_events_175060.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-08-25T19:39:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19077#event-175060"
}
```



---

archive/issue_events_175061.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-08-25T19:39:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19077#event-175061"
}
```



---

archive/issue_comments_273230.json:
```json
{
    "body": "**Changing reviewer** from \"Jori M\u00e4ntysalo\" to \"Jori M\u00e4ntysalo, Nathann Cohen\".",
    "created_at": "2015-08-25T19:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273230",
    "user": "https://github.com/novoselt"
}
```

**Changing reviewer** from "Jori M채ntysalo" to "Jori M채ntysalo, Nathann Cohen".



---

archive/issue_comments_273231.json:
```json
{
    "body": "<a id='comment:21'></a>\nOkayyyy. Thanks for the code! And if you ever see graph equality reaching the top of the screen when you profile poset code, remember that some more can be saved there.\n\nThough of course, removing this 'UniqueRepresentation' inheritance would mean that there is no need to call `Graph.__eq__` anymore when a poset is created `:-P`\n\nNathann",
    "created_at": "2015-08-25T20:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273231",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:21'></a>
Okayyyy. Thanks for the code! And if you ever see graph equality reaching the top of the screen when you profile poset code, remember that some more can be saved there.

Though of course, removing this 'UniqueRepresentation' inheritance would mean that there is no need to call `Graph.__eq__` anymore when a poset is created `:-P`

Nathann



---

archive/issue_events_175062.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-08-26T03:00:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19077#event-175062"
}
```



---

archive/issue_events_175063.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-08-26T03:00:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19077#event-175063"
}
```



---

archive/issue_comments_273232.json:
```json
{
    "body": "**Changing branch** from \"[u/novoselt/graph_eq](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/graph_eq)\" to \"[959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)\".",
    "created_at": "2015-08-26T03:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19077#issuecomment-273232",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/novoselt/graph_eq](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/graph_eq)" to "[959c85d02f96b679a1bc082543359554d496eeb7](https://github.com/sagemath/sagetrac-mirror/commit/959c85d02f96b679a1bc082543359554d496eeb7)".
