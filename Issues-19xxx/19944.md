# Issue 19944: number_field_elements_from_algebraics should create embedded number field elements

archive/issues_019944.json:
```json
{
    "body": "CC:  @vbraun @gagern @videlec tmonteil @jjermann @staroste @jplab @mo271 @yuan-zhou @JohnCremona @tscrim\n\nKeywords: IMA-PolyGeom\n\nThis is a follow-up on #17830 and #18819.\n\n#17830 made this possible:\n\n```\nsage: x = polygen(ZZ)\nsage: K.<cbrt2> = NumberField(x^3 - 2, embedding=AA.polynomial_root(x^3-2, RIF(0,3)))\nsage: 6064/4813 < cbrt2 < 90325/71691\nTrue\n```\n\nBut if one uses `number_field_elements_from_algebraics`, one gets only non-embedded number field elements:\n\n```\nsage: x = polygen(ZZ)\nsage: K, cbrt2, hom = number_field_elements_from_algebraics(AA.polynomial_root(x^3-2, RIF(0,3)))\nsage: 6064/4813 < cbrt2 < 90325/71691\nFalse            # (an perhaps an error in Python 3?)\n```\n\nThis ticket adds an option `embedded` to create embedded number field elements.\n\n```\nsage: x = polygen(ZZ)\nsage: K, cbrt2, hom = number_field_elements_from_algebraics(AA.polynomial_root(x^3-2, RIF(0,3)), embedded=True)\nsage: 6064/4813 < cbrt2 < 90325/71691\nTrue\n```\n\nTODECIDE:\n\n- Close ticket #5355?\n\nIssue created by migration from https://trac.sagemath.org/ticket/20181\n\n",
    "closed_at": "2019-04-29T12:35:34Z",
    "created_at": "2016-03-09T03:17:39Z",
    "labels": [
        "component: number fields",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "number_field_elements_from_algebraics should create embedded number field elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19944",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @vbraun @gagern @videlec tmonteil @jjermann @staroste @jplab @mo271 @yuan-zhou @JohnCremona @tscrim

Keywords: IMA-PolyGeom

This is a follow-up on #17830 and #18819.

#17830 made this possible:

```
sage: x = polygen(ZZ)
sage: K.<cbrt2> = NumberField(x^3 - 2, embedding=AA.polynomial_root(x^3-2, RIF(0,3)))
sage: 6064/4813 < cbrt2 < 90325/71691
True
```

But if one uses `number_field_elements_from_algebraics`, one gets only non-embedded number field elements:

```
sage: x = polygen(ZZ)
sage: K, cbrt2, hom = number_field_elements_from_algebraics(AA.polynomial_root(x^3-2, RIF(0,3)))
sage: 6064/4813 < cbrt2 < 90325/71691
False            # (an perhaps an error in Python 3?)
```

This ticket adds an option `embedded` to create embedded number field elements.

```
sage: x = polygen(ZZ)
sage: K, cbrt2, hom = number_field_elements_from_algebraics(AA.polynomial_root(x^3-2, RIF(0,3)), embedded=True)
sage: 6064/4813 < cbrt2 < 90325/71691
True
```

TODECIDE:

- Close ticket #5355?

Issue created by migration from https://trac.sagemath.org/ticket/20181





---

archive/issue_comments_274135.json:
```json
{
    "body": "While looking at related tickets, I noticed the very old ticket #5355, which should be closed I think.",
    "created_at": "2016-03-09T03:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274135",
    "user": "https://github.com/mkoeppe"
}
```

While looking at related tickets, I noticed the very old ticket #5355, which should be closed I think.



---

archive/issue_comments_274136.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2018-04-05T22:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274136",
    "user": "https://github.com/jplab"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_274137.json:
```json
{
    "body": "Here is a first version. Comments are welcome.\n\nOne question is whether `RealIntervalField` is the right choice?\n\n---\nNew commits:",
    "created_at": "2018-04-05T22:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274137",
    "user": "https://github.com/jplab"
}
```

Here is a first version. Comments are welcome.

One question is whether `RealIntervalField` is the right choice?

---
New commits:



---

archive/issue_comments_274138.json:
```json
{
    "body": "Maybe it would be nice to also add the optional parameter to the method `as_number_field_element` as well...",
    "created_at": "2018-04-05T23:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274138",
    "user": "https://github.com/jplab"
}
```

Maybe it would be nice to also add the optional parameter to the method `as_number_field_element` as well...



---

archive/issue_comments_274139.json:
```json
{
    "body": "The following should work but it does not:\n\n```\nsage: UCF = UniversalCyclotomicField()\nsage: E = UCF.gen(5)\nsage: my_nums = [-52*E - 136*E^2 - 136*E^3 - 52*E^4, -66*E - 168*E^2 - 168*E^3 - 66*E^4, -46*E - 114*E^2 - 114*E^3 - 46*E^4, -24*E - 58*E^2 - 58*E\n....: ^3 - 24*E^4, sqrt(2)]\nsage: [n(_) for _ in my_nums]\n[187.914855054991 - 8.67361737988404e-18*I,\n 231.039466852489 - 1.04083408558608e-17*I,\n 156.026311234993 - 8.67361737988404e-18*I,\n 79.0131556174964 - 4.33680868994202e-18*I,\n 1.41421356237310]\nsage: res = number_field_elements_from_algebraics(my_nums,embedded=True)\nTraceback (most recent call last):\n...\nTypeError: unable to convert -0.4370160244488211? - 1.344997023927915?*I to real interval\n```\n\nThe choice of root shoould always be made real...",
    "created_at": "2018-04-05T23:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274139",
    "user": "https://github.com/jplab"
}
```

The following should work but it does not:

```
sage: UCF = UniversalCyclotomicField()
sage: E = UCF.gen(5)
sage: my_nums = [-52*E - 136*E^2 - 136*E^3 - 52*E^4, -66*E - 168*E^2 - 168*E^3 - 66*E^4, -46*E - 114*E^2 - 114*E^3 - 46*E^4, -24*E - 58*E^2 - 58*E
....: ^3 - 24*E^4, sqrt(2)]
sage: [n(_) for _ in my_nums]
[187.914855054991 - 8.67361737988404e-18*I,
 231.039466852489 - 1.04083408558608e-17*I,
 156.026311234993 - 8.67361737988404e-18*I,
 79.0131556174964 - 4.33680868994202e-18*I,
 1.41421356237310]
sage: res = number_field_elements_from_algebraics(my_nums,embedded=True)
Traceback (most recent call last):
...
TypeError: unable to convert -0.4370160244488211? - 1.344997023927915?*I to real interval
```

The choice of root shoould always be made real...



---

archive/issue_comments_274140.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-06T16:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274140",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274141.json:
```json
{
    "body": "It is now possible to get this:\n\n```\nsage: UCF = UniversalCyclotomicField()\nsage: E = UCF.gen(5)\nsage: L.<b> = NumberField(x^2-189*x+16, embedding=200)\nsage: my_nums = [-52*E - 136*E^2 - 136*E^3 - 52*E^4, L.gen()._algebraic_(AA),sqrt(2)]\nsage: aa_my_nums = [AA(_) for _ in my_nums]\nsage: res = number_field_elements_from_algebraics(aa_my_nums,embedded=True)\nsage: res\n(Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921,\n [2310/26212773509*a^7 - 185432947/78638320527*a^5 + 1652517502195/78638320527*a^3 - 4904676315215467/78638320527*a + 94,\n  -1238/2803377488467023*a^7 + 185460719/11213509953868092*a^5 - 2754936849443/11213509953868092*a^3 + 8180694680816975/3737836651289364*a + 189/2,\n  -1979/1887160880826*a^7 + 26472586/943580440413*a^5 - 235822245043/943580440413*a^3 + 466325019915415/629053626942*a],\n Ring morphism:\n   From: Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921\n   To:   Algebraic Real Field\n   Defn: a |--> 96.9475535136628?)\nsage: res[0].gen_embedding()\n96.9475535136628?\nsage: res = number_field_elements_from_algebraics(aa_my_nums,embedded=False)\nsage: res[0].gen_embedding()  # Nothing is returned(!?!?!)\nsage:\n```\n\nPerhaps it would be nice to say that there is no embedding instead of returning nothing?",
    "created_at": "2018-04-06T16:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274141",
    "user": "https://github.com/jplab"
}
```

It is now possible to get this:

```
sage: UCF = UniversalCyclotomicField()
sage: E = UCF.gen(5)
sage: L.<b> = NumberField(x^2-189*x+16, embedding=200)
sage: my_nums = [-52*E - 136*E^2 - 136*E^3 - 52*E^4, L.gen()._algebraic_(AA),sqrt(2)]
sage: aa_my_nums = [AA(_) for _ in my_nums]
sage: res = number_field_elements_from_algebraics(aa_my_nums,embedded=True)
sage: res
(Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921,
 [2310/26212773509*a^7 - 185432947/78638320527*a^5 + 1652517502195/78638320527*a^3 - 4904676315215467/78638320527*a + 94,
  -1238/2803377488467023*a^7 + 185460719/11213509953868092*a^5 - 2754936849443/11213509953868092*a^3 + 8180694680816975/3737836651289364*a + 189/2,
  -1979/1887160880826*a^7 + 26472586/943580440413*a^5 - 235822245043/943580440413*a^3 + 466325019915415/629053626942*a],
 Ring morphism:
   From: Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921
   To:   Algebraic Real Field
   Defn: a |--> 96.9475535136628?)
sage: res[0].gen_embedding()
96.9475535136628?
sage: res = number_field_elements_from_algebraics(aa_my_nums,embedded=False)
sage: res[0].gen_embedding()  # Nothing is returned(!?!?!)
sage:
```

Perhaps it would be nice to say that there is no embedding instead of returning nothing?



---

archive/issue_comments_274142.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-04-06T17:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274142",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_274143.json:
```json
{
    "body": "The returned morphism is not able to convert the elements.\n\n```\nsage: res[2](my_nums[0])\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-8-74370e91d982> in <module>()\n----> 1 res[Integer(2)](my_nums[Integer(0)])\n\n/Users/mkoeppe/s/sage/some-sage-install-prefix/lib/python2.7/site-packages/sage/categories/map.pyx in sage.categories.map.Map.__call__ (build/cythonized/sage/categories/map.c:6978)()\n    781                 x = D(x)\n    782             except (TypeError, NotImplementedError):\n--> 783                 raise TypeError(\"%s fails to convert into the map's domain %s, but a `pushforward` method is not properly implemented\" % (x, D))\n    784         else:\n    785             x = converter(x)\n\nTypeError: -52*E(5) - 136*E(5)^2 - 136*E(5)^3 - 52*E(5)^4 fails to convert into the map's domain Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921, but a `pushforward` method is not properly implemented\n```\n\nEdit: I withdraw this comment; I misremembered what `hom` is supposed to do.",
    "created_at": "2018-04-06T22:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274143",
    "user": "https://github.com/mkoeppe"
}
```

The returned morphism is not able to convert the elements.

```
sage: res[2](my_nums[0])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-8-74370e91d982> in <module>()
----> 1 res[Integer(2)](my_nums[Integer(0)])

/Users/mkoeppe/s/sage/some-sage-install-prefix/lib/python2.7/site-packages/sage/categories/map.pyx in sage.categories.map.Map.__call__ (build/cythonized/sage/categories/map.c:6978)()
    781                 x = D(x)
    782             except (TypeError, NotImplementedError):
--> 783                 raise TypeError("%s fails to convert into the map's domain %s, but a `pushforward` method is not properly implemented" % (x, D))
    784         else:
    785             x = converter(x)

TypeError: -52*E(5) - 136*E(5)^2 - 136*E(5)^3 - 52*E(5)^4 fails to convert into the map's domain Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921, but a `pushforward` method is not properly implemented
```

Edit: I withdraw this comment; I misremembered what `hom` is supposed to do.



---

archive/issue_comments_274144.json:
```json
{
    "body": "Two quick comments:\n* you may want to pathc `as_number_field_element()` too,\n* don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...)",
    "created_at": "2018-04-07T08:02:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274144",
    "user": "https://github.com/mezzarobba"
}
```

Two quick comments:
* you may want to pathc `as_number_field_element()` too,
* don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...)



---

archive/issue_comments_274145.json:
```json
{
    "body": "Replying to [comment:13 mmezzarobba]:\n> Two quick comments:\n> * you may want to pathc `as_number_field_element()` too,\n> * don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...)\n\n\nYes, that sounds very reasonable. I will do that, along with fixing what mkoeppe mentionned above.",
    "created_at": "2018-04-07T13:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274145",
    "user": "https://github.com/jplab"
}
```

Replying to [comment:13 mmezzarobba]:
> Two quick comments:
> * you may want to pathc `as_number_field_element()` too,
> * don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...)


Yes, that sounds very reasonable. I will do that, along with fixing what mkoeppe mentionned above.



---

archive/issue_comments_274146.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-07T21:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274146",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_274147.json:
```json
{
    "body": "Doesn't always seem to give real embeddings:\n\n```\nsage: x = polygen(ZZ); elts = number_field_elements_from_algebraics([sqrt(2), AA.polynomial_root(x^3-2, RIF(0,3))], embedded=True)[1]\nsage: [AA(y) for y in elts]\n...\nTypeError: unable to convert -0.561231024154687? - 0.9720806486198328?*I to real interval\n```",
    "created_at": "2018-04-08T00:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274147",
    "user": "https://github.com/mkoeppe"
}
```

Doesn't always seem to give real embeddings:

```
sage: x = polygen(ZZ); elts = number_field_elements_from_algebraics([sqrt(2), AA.polynomial_root(x^3-2, RIF(0,3))], embedded=True)[1]
sage: [AA(y) for y in elts]
...
TypeError: unable to convert -0.561231024154687? - 0.9720806486198328?*I to real interval
```



---

archive/issue_comments_274148.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> The returned morphism is not able to convert the elements.\n> \n> ```\n> sage: res[2](my_nums[0])\n> ---------------------------------------------------------------------------\n> TypeError                                 Traceback (most recent call last)\n> <ipython-input-8-74370e91d982> in <module>()\n> ----> 1 res[Integer(2)](my_nums[Integer(0)])\n> \n> /Users/mkoeppe/s/sage/some-sage-install-prefix/lib/python2.7/site-packages/sage/categories/map.pyx in sage.categories.map.Map.__call__ (build/cythonized/sage/categories/map.c:6978)()\n>     781                 x = D(x)\n>     782             except (TypeError, NotImplementedError):\n> --> 783                 raise TypeError(\"%s fails to convert into the map's domain %s, but a `pushforward` method is not properly implemented\" % (x, D))\n>     784         else:\n>     785             x = converter(x)\n> \n> TypeError: -52*E(5) - 136*E(5)^2 - 136*E(5)^3 - 52*E(5)^4 fails to convert into the map's domain Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921, but a `pushforward` method is not properly implemented\n> ```\n\n\nThe homomorphism goes the other way around... Thanks to Moritz for noticing that.",
    "created_at": "2018-04-08T21:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274148",
    "user": "https://github.com/jplab"
}
```

Replying to [comment:12 mkoeppe]:
> The returned morphism is not able to convert the elements.
> 
> ```
> sage: res[2](my_nums[0])
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> <ipython-input-8-74370e91d982> in <module>()
> ----> 1 res[Integer(2)](my_nums[Integer(0)])
> 
> /Users/mkoeppe/s/sage/some-sage-install-prefix/lib/python2.7/site-packages/sage/categories/map.pyx in sage.categories.map.Map.__call__ (build/cythonized/sage/categories/map.c:6978)()
>     781                 x = D(x)
>     782             except (TypeError, NotImplementedError):
> --> 783                 raise TypeError("%s fails to convert into the map's domain %s, but a `pushforward` method is not properly implemented" % (x, D))
>     784         else:
>     785             x = converter(x)
> 
> TypeError: -52*E(5) - 136*E(5)^2 - 136*E(5)^3 - 52*E(5)^4 fails to convert into the map's domain Number Field in a with defining polynomial y^8 - 35670*y^6 + 476899047*y^4 - 2832410271650*y^2 + 6305298701739921, but a `pushforward` method is not properly implemented
> ```


The homomorphism goes the other way around... Thanks to Moritz for noticing that.



---

archive/issue_comments_274149.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-08T22:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274149",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274150.json:
```json
{
    "body": "Okay. I added some tests and now it seems to work.\n\nWith the current commit, I have one failing doctest for which I do not know what to do:\n\n```\nFile \"qqbar.py\", line 2098, in sage.rings.qqbar.number_field_elements_from_algebraics\nFailed example:\n    number_field_elements_from_algebraics(rt2c)\nExpected:\n    (Number Field in a with defining polynomial y^4 + 2*y^2 + 4, 1/2*a^3, Ring morphism:\n        From: Number Field in a with defining polynomial y^4 + 2*y^2 + 4\n        To:   Algebraic Field\n        Defn: a |--> -0.7071067811865475? - 1.224744871391589?*I)\nGot:\n    (Number Field in a with defining polynomial y^2 - 2, a, Ring morphism:\n       From: Number Field in a with defining polynomial y^2 - 2\n       To:   Algebraic Real Field\n       Defn: a |--> 1.414213562373095?)\n```\n\nThis is in the tests section and the explanation given is exactly a situation that we have to outsmart when we want to be able to accept cyclotomic fields elements to be parsed to real embedded number fields.\n\nIt seems to me that the proposed code improves the situation as Sage now recognize that it is a real number... I can not see a reason right now to go against that. Am I missing something?",
    "created_at": "2018-04-08T22:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274150",
    "user": "https://github.com/jplab"
}
```

Okay. I added some tests and now it seems to work.

With the current commit, I have one failing doctest for which I do not know what to do:

```
File "qqbar.py", line 2098, in sage.rings.qqbar.number_field_elements_from_algebraics
Failed example:
    number_field_elements_from_algebraics(rt2c)
Expected:
    (Number Field in a with defining polynomial y^4 + 2*y^2 + 4, 1/2*a^3, Ring morphism:
        From: Number Field in a with defining polynomial y^4 + 2*y^2 + 4
        To:   Algebraic Field
        Defn: a |--> -0.7071067811865475? - 1.224744871391589?*I)
Got:
    (Number Field in a with defining polynomial y^2 - 2, a, Ring morphism:
       From: Number Field in a with defining polynomial y^2 - 2
       To:   Algebraic Real Field
       Defn: a |--> 1.414213562373095?)
```

This is in the tests section and the explanation given is exactly a situation that we have to outsmart when we want to be able to accept cyclotomic fields elements to be parsed to real embedded number fields.

It seems to me that the proposed code improves the situation as Sage now recognize that it is a real number... I can not see a reason right now to go against that. Am I missing something?



---

archive/issue_comments_274151.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-09T16:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274151",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274152.json:
```json
{
    "body": "Changing keywords from \"\" to \"IMA-PolyGeom\".",
    "created_at": "2018-04-10T23:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274152",
    "user": "https://github.com/jplab"
}
```

Changing keywords from "" to "IMA-PolyGeom".



---

archive/issue_events_054841.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-04-13T15:50:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54841"
}
```



---

archive/issue_comments_274153.json:
```json
{
    "body": "Modifying the test in comment 19 looks OK to me, but perhaps John can confirm I'm not missing anything...",
    "created_at": "2018-04-13T16:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274153",
    "user": "https://github.com/dimpase"
}
```

Modifying the test in comment 19 looks OK to me, but perhaps John can confirm I'm not missing anything...



---

archive/issue_comments_274154.json:
```json
{
    "body": "You should just go on and fix the doctest, I think.",
    "created_at": "2018-04-15T19:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274154",
    "user": "https://github.com/fchapoton"
}
```

You should just go on and fix the doctest, I think.



---

archive/issue_comments_274155.json:
```json
{
    "body": "`as_number_field_element` needs to pass on its new arguments, and corresponding doctests should be added.",
    "created_at": "2018-04-16T09:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274155",
    "user": "https://github.com/mkoeppe"
}
```

`as_number_field_element` needs to pass on its new arguments, and corresponding doctests should be added.



---

archive/issue_comments_274156.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-16T09:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274156",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_274157.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-15T06:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274157",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274158.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-15T06:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274158",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274159.json:
```json
{
    "body": "... still needs a corresponding doctest",
    "created_at": "2018-09-15T06:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274159",
    "user": "https://github.com/mkoeppe"
}
```

... still needs a corresponding doctest



---

archive/issue_comments_274160.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-16T00:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274160",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274161.json:
```json
{
    "body": "I've added some doctests, but the implementation needs more work as there are failures.",
    "created_at": "2018-09-16T00:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274161",
    "user": "https://github.com/mkoeppe"
}
```

I've added some doctests, but the implementation needs more work as there are failures.



---

archive/issue_events_054842.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2018-09-16T00:26:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54842"
}
```



---

archive/issue_events_054843.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2018-09-16T00:26:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54843"
}
```



---

archive/issue_comments_274162.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-16T00:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274162",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274163.json:
```json
{
    "body": "Replying to [comment:23 dimpase]:\n> Modifying the test in comment 19 looks OK to me, but perhaps John can confirm I'm not missing anything...\n\n\nThe context of this doctest suggested that it should be marked `# random`, which I did in 2eb3320.",
    "created_at": "2018-09-16T00:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274163",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:23 dimpase]:
> Modifying the test in comment 19 looks OK to me, but perhaps John can confirm I'm not missing anything...


The context of this doctest suggested that it should be marked `# random`, which I did in 2eb3320.



---

archive/issue_comments_274164.json:
```json
{
    "body": "Ready for re-review?\n\nSome quick comments. It is considered a bad practice to have bare `except:` statements. It is probably sufficient to catch `ValueError` and `TypeError`. Also, the standard doc format for `INPUT:` would be\n\n```\n    - ``numbers`` -- a number or list of numbers\n\n    - ``minimal`` -- boolean (default: ``False``); whether to minimize the\n      degree of the extension\n\n    - ``same_field`` -- boolean (default: ``False``); see below\n\n    - ``embedded`` -- boolean (default: ``False``); whether to make the\n      :func:`NumberField` embedded\n\n    - ``prec`` -- integer (default: ``53``); the number of bit of precision for\n      the embedding\n```\n\n```\n        - ``minimal`` -- boolean (default: ``False``); whether to minimize the\n          degree of the extension\n\n        - ``embedded`` -- boolean (default: ``False``); whether to make the\n          :func:`NumberField` embedded\n    \n        - ``prec`` -- integer (default: ``53``); the number of bit of precision for\n          the embedding\n```",
    "created_at": "2018-09-16T00:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274164",
    "user": "https://github.com/tscrim"
}
```

Ready for re-review?

Some quick comments. It is considered a bad practice to have bare `except:` statements. It is probably sufficient to catch `ValueError` and `TypeError`. Also, the standard doc format for `INPUT:` would be

```
    - ``numbers`` -- a number or list of numbers

    - ``minimal`` -- boolean (default: ``False``); whether to minimize the
      degree of the extension

    - ``same_field`` -- boolean (default: ``False``); see below

    - ``embedded`` -- boolean (default: ``False``); whether to make the
      :func:`NumberField` embedded

    - ``prec`` -- integer (default: ``53``); the number of bit of precision for
      the embedding
```

```
        - ``minimal`` -- boolean (default: ``False``); whether to minimize the
          degree of the extension

        - ``embedded`` -- boolean (default: ``False``); whether to make the
          :func:`NumberField` embedded
    
        - ``prec`` -- integer (default: ``53``); the number of bit of precision for
          the embedding
```



---

archive/issue_comments_274165.json:
```json
{
    "body": "Not ready for review; this needs more work -- see the failing doctests that I added in 41b1142.",
    "created_at": "2018-09-16T01:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274165",
    "user": "https://github.com/mkoeppe"
}
```

Not ready for review; this needs more work -- see the failing doctests that I added in 41b1142.



---

archive/issue_comments_274166.json:
```json
{
    "body": "Replying to [comment:35 mkoeppe]:\n> Not ready for review; this needs more work -- see the failing doctests that I added in 41b1142.\n\n\nFor reference: These are the doctest failures. \n\n```\n$ sage -t src/sage/rings/qqbar.py \ntoo many failed tests, not using stored timings\nRunning doctests with ID 2018-09-27-16-59-10-65572ec7.\nUsing --optional=4ti2,bliss,ccache,dochtml,gdb,latte_int,lidia,lrslib,mpir,normaliz,notedown,pandoc_attributes,pynormaliz,pyqnormaliz,python2,rst2ipynb,sage\nDoctesting 1 file.\nsage -t src/sage/rings/qqbar.py\n**********************************************************************\nFile \"src/sage/rings/qqbar.py\", line 3696, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element\nFailed example:\n    elt == rt\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/rings/qqbar.py\", line 3698, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element\nFailed example:\n    AA(elt)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 659, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1070, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element[12]>\", line 1, in <module>\n        AA(elt)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)\n        return C._element_constructor(x)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 738, in _element_constructor_\n        return x._algebraic_(AA)\n      File \"sage/rings/number_field/number_field_element.pyx\", line 2709, in sage.rings.number_field.number_field_element.NumberFieldElement._algebraic_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:26930)\n        emb = refine_embedding(emb, infinity)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.py\", line 11329, in refine_embedding\n        diffs = [(RC(ee(K.gen()))-old_root).abs() for ee in elist]\n      File \"sage/rings/real_mpfi.pyx\", line 699, in sage.rings.real_mpfi.RealIntervalField_class.__call__ (build/cythonized/sage/rings/real_mpfi.c:6094)\n        return Parent.__call__(self, x)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5999)\n        cdef Element e = method(C)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 4007, in interval\n        raise TypeError(\"unable to convert {} to real interval\".format(self))\n    TypeError: unable to convert -2.618826569900552? - 0.2237500597843041?*I to real interval\n**********************************************************************\nFile \"src/sage/rings/qqbar.py\", line 3700, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element\nFailed example:\n    RR(elt)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 659, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1070, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element[13]>\", line 1, in <module>\n        RR(elt)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5993)\n        cdef Element e = method(C)\n      File \"sage/rings/number_field/number_field_element.pyx\", line 1802, in sage.rings.number_field.number_field_element.NumberFieldElement._mpfr_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:19625)\n        return R(R.complex_field()(self))\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 381, in __call__\n        return Parent.__call__(self, x)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)\n        return C._element_constructor(x)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 423, in _element_constructor_\n        return ComplexNumber(self, x)\n      File \"sage/rings/complex_number.pyx\", line 200, in sage.rings.complex_number.ComplexNumber.__init__ (build/cythonized/sage/rings/complex_number.c:4535)\n        rr = R(real)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5993)\n        cdef Element e = method(C)\n      File \"sage/rings/number_field/number_field_element.pyx\", line 1802, in sage.rings.number_field.number_field_element.NumberFieldElement._mpfr_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:19625)\n        return R(R.complex_field()(self))\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 381, in __call__\n        return Parent.__call__(self, x)\n      File \"sage/structure/parent.pyx\", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)\n.....................\n      File \"sage/categories/map.pyx\", line 176, in sage.categories.map.Map.__copy__ (build/cythonized/sage/categories/map.c:4133)\n        cdef Map out = Element.__copy__(self)\n      File \"sage/structure/element.pyx\", line 605, in sage.structure.element.Element.__copy__ (build/cythonized/sage/structure/element.c:5273)\n        D = self.__dict__\n      File \"sage/structure/element.pyx\", line 493, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4550)\n        return self.getattr_from_category(name)\n      File \"sage/structure/element.pyx\", line 506, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4659)\n        return getattr_from_other_class(self, cls, name)\n      File \"sage/cpython/getattr.pyx\", line 386, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2428)\n        if isinstance(self, cls):\n    RuntimeError: maximum recursion depth exceeded while calling a Python object\n**********************************************************************\n1 item had failures:\n   3 of  21 in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element\n    [1438 tests, 3 failures, 14.69 s]\n----------------------------------------------------------------------\nsage -t src/sage/rings/qqbar.py  # 3 doctests failed\n----------------------------------------------------------------------\n```\nFor the infinite recursion in the last failure, perhaps could someone experienced with the Sage coercion system help?",
    "created_at": "2018-09-28T00:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274166",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:35 mkoeppe]:
> Not ready for review; this needs more work -- see the failing doctests that I added in 41b1142.


For reference: These are the doctest failures. 

```
$ sage -t src/sage/rings/qqbar.py 
too many failed tests, not using stored timings
Running doctests with ID 2018-09-27-16-59-10-65572ec7.
Using --optional=4ti2,bliss,ccache,dochtml,gdb,latte_int,lidia,lrslib,mpir,normaliz,notedown,pandoc_attributes,pynormaliz,pyqnormaliz,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t src/sage/rings/qqbar.py
**********************************************************************
File "src/sage/rings/qqbar.py", line 3696, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element
Failed example:
    elt == rt
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/rings/qqbar.py", line 3698, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element
Failed example:
    AA(elt)
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element[12]>", line 1, in <module>
        AA(elt)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)
        return C._element_constructor(x)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 738, in _element_constructor_
        return x._algebraic_(AA)
      File "sage/rings/number_field/number_field_element.pyx", line 2709, in sage.rings.number_field.number_field_element.NumberFieldElement._algebraic_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:26930)
        emb = refine_embedding(emb, infinity)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.py", line 11329, in refine_embedding
        diffs = [(RC(ee(K.gen()))-old_root).abs() for ee in elist]
      File "sage/rings/real_mpfi.pyx", line 699, in sage.rings.real_mpfi.RealIntervalField_class.__call__ (build/cythonized/sage/rings/real_mpfi.c:6094)
        return Parent.__call__(self, x)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5999)
        cdef Element e = method(C)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 4007, in interval
        raise TypeError("unable to convert {} to real interval".format(self))
    TypeError: unable to convert -2.618826569900552? - 0.2237500597843041?*I to real interval
**********************************************************************
File "src/sage/rings/qqbar.py", line 3700, in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element
Failed example:
    RR(elt)
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element[13]>", line 1, in <module>
        RR(elt)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5993)
        cdef Element e = method(C)
      File "sage/rings/number_field/number_field_element.pyx", line 1802, in sage.rings.number_field.number_field_element.NumberFieldElement._mpfr_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:19625)
        return R(R.complex_field()(self))
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py", line 381, in __call__
        return Parent.__call__(self, x)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)
        return C._element_constructor(x)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py", line 423, in _element_constructor_
        return ComplexNumber(self, x)
      File "sage/rings/complex_number.pyx", line 200, in sage.rings.complex_number.ComplexNumber.__init__ (build/cythonized/sage/rings/complex_number.c:4535)
        rr = R(real)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 271, in sage.structure.coerce_maps.NamedConvertMap._call_ (build/cythonized/sage/structure/coerce_maps.c:5993)
        cdef Element e = method(C)
      File "sage/rings/number_field/number_field_element.pyx", line 1802, in sage.rings.number_field.number_field_element.NumberFieldElement._mpfr_ (build/cythonized/sage/rings/number_field/number_field_element.cpp:19625)
        return R(R.complex_field()(self))
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-clean/local/lib/python2.7/site-packages/sage/rings/complex_field.py", line 381, in __call__
        return Parent.__call__(self, x)
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)
.....................
      File "sage/categories/map.pyx", line 176, in sage.categories.map.Map.__copy__ (build/cythonized/sage/categories/map.c:4133)
        cdef Map out = Element.__copy__(self)
      File "sage/structure/element.pyx", line 605, in sage.structure.element.Element.__copy__ (build/cythonized/sage/structure/element.c:5273)
        D = self.__dict__
      File "sage/structure/element.pyx", line 493, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4550)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 506, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4659)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 386, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2428)
        if isinstance(self, cls):
    RuntimeError: maximum recursion depth exceeded while calling a Python object
**********************************************************************
1 item had failures:
   3 of  21 in sage.rings.qqbar.AlgebraicNumber_base.as_number_field_element
    [1438 tests, 3 failures, 14.69 s]
----------------------------------------------------------------------
sage -t src/sage/rings/qqbar.py  # 3 doctests failed
----------------------------------------------------------------------
```
For the infinite recursion in the last failure, perhaps could someone experienced with the Sage coercion system help?



---

archive/issue_comments_274167.json:
```json
{
    "body": "So I think I know what is going wrong. The issue is that there is no coercion from `RIF -> RR`; it goes the other way around. So with these changes, I can avoid the infinite recursion with `RR(elt)`, but I get other failures:\n\n```diff\ndiff --git a/src/sage/rings/qqbar.py b/src/sage/rings/qqbar.py\nindex b32aa1a..7453d89 100644\n--- a/src/sage/rings/qqbar.py\n+++ b/src/sage/rings/qqbar.py\n@@ -2197,10 +2197,11 @@ def number_field_elements_from_algebraics(numbers, minimal=False, same_field=False, embedded=False, prec=53):\n \n     # Make the numbers have a real root\n     real_numbers = []\n+    from sage.rings.real_mpfr import RealField\n     for v in numbers:\n         if v._exact_field().is_complex() and real_case:\n             # the number comes from a complex algebraic number field\n-            embedded_rt = v.interval_fast(RealIntervalField(prec))\n+            embedded_rt = v.interval_fast(RealField(prec))\n             root = ANRoot(v.minpoly(), embedded_rt)\n             real_nf = NumberField(v.minpoly(),'a')\n             new_ef = AlgebraicGenerator(real_nf, root)\n@@ -2223,10 +2224,9 @@ def number_field_elements_from_algebraics(numbers, minimal=False, same_field=False, embedded=False, prec=53):\n     if fld is not QQ and embedded:\n         assert real_case\n         exact_generator = hom(fld.gen(0))\n-        embedding_field = RealIntervalField(prec)\n+        embedding_field = RealField(prec)\n         embedded_gen = embedding_field(exact_generator)\n         embedded_field = NumberField(fld.defining_polynomial(),fld.variable_name(),embedding=embedded_gen)\n-        \n         inter_hom = fld.hom([embedded_field.gen(0)])\n         nums = map(inter_hom, nums)\n         hom = embedded_field.hom([gen.root_as_algebraic()])\n```\nNote that with your current branch, the replacement of the `RR(elt)` by `RIF(elt)` works.\n\nThe reason you get the infinite recursion is somewhere in the number field coercion (conversion?)( code, it is trying to construct a complex number, which then tries to create the `RR`, but it cannot do that, so it tried to construct a number field element, and hence the cycle. Or something like that. The reason it normally doesn't cycle is because it separately knows how to get the the information it needs (if it even falls into this cycle). I don't completely understand the mechanism, but this is what the traceback is suggesting to me.",
    "created_at": "2018-09-28T23:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274167",
    "user": "https://github.com/tscrim"
}
```

So I think I know what is going wrong. The issue is that there is no coercion from `RIF -> RR`; it goes the other way around. So with these changes, I can avoid the infinite recursion with `RR(elt)`, but I get other failures:

```diff
diff --git a/src/sage/rings/qqbar.py b/src/sage/rings/qqbar.py
index b32aa1a..7453d89 100644
--- a/src/sage/rings/qqbar.py
+++ b/src/sage/rings/qqbar.py
@@ -2197,10 +2197,11 @@ def number_field_elements_from_algebraics(numbers, minimal=False, same_field=False, embedded=False, prec=53):
 
     # Make the numbers have a real root
     real_numbers = []
+    from sage.rings.real_mpfr import RealField
     for v in numbers:
         if v._exact_field().is_complex() and real_case:
             # the number comes from a complex algebraic number field
-            embedded_rt = v.interval_fast(RealIntervalField(prec))
+            embedded_rt = v.interval_fast(RealField(prec))
             root = ANRoot(v.minpoly(), embedded_rt)
             real_nf = NumberField(v.minpoly(),'a')
             new_ef = AlgebraicGenerator(real_nf, root)
@@ -2223,10 +2224,9 @@ def number_field_elements_from_algebraics(numbers, minimal=False, same_field=False, embedded=False, prec=53):
     if fld is not QQ and embedded:
         assert real_case
         exact_generator = hom(fld.gen(0))
-        embedding_field = RealIntervalField(prec)
+        embedding_field = RealField(prec)
         embedded_gen = embedding_field(exact_generator)
         embedded_field = NumberField(fld.defining_polynomial(),fld.variable_name(),embedding=embedded_gen)
-        
         inter_hom = fld.hom([embedded_field.gen(0)])
         nums = map(inter_hom, nums)
         hom = embedded_field.hom([gen.root_as_algebraic()])
```
Note that with your current branch, the replacement of the `RR(elt)` by `RIF(elt)` works.

The reason you get the infinite recursion is somewhere in the number field coercion (conversion?)( code, it is trying to construct a complex number, which then tries to create the `RR`, but it cannot do that, so it tried to construct a number field element, and hence the cycle. Or something like that. The reason it normally doesn't cycle is because it separately knows how to get the the information it needs (if it even falls into this cycle). I don't completely understand the mechanism, but this is what the traceback is suggesting to me.



---

archive/issue_comments_274168.json:
```json
{
    "body": "Replying to [comment:37 tscrim]:\n> So I think I know what is going wrong. The issue is that there is no coercion from `RIF -> RR`; it goes the other way around.\n\n\nNote that #15114 is for removing this coercion, but is currently blocked by more or less the same issues with comparisons between elements of different parents that need to be solved for the Python\u00a03 transition.",
    "created_at": "2018-09-29T07:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274168",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:37 tscrim]:
> So I think I know what is going wrong. The issue is that there is no coercion from `RIF -> RR`; it goes the other way around.


Note that #15114 is for removing this coercion, but is currently blocked by more or less the same issues with comparisons between elements of different parents that need to be solved for the Python3 transition.



---

archive/issue_comments_274169.json:
```json
{
    "body": "Just as a summary here are things that need to be done (maybe some of them are already done):\n\n- you may want to patch `as_number_field_element()` too,\n- don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...) \n- Fix doctest in File \"qqbar.py\", line 2098, in sage.rings.qqbar.number_field_elements_from_algebraics\n- `as_number_field_element` needs to pass on its new arguments, and corresponding doctests should be added. \n- Fix Comment 34 and Comment 36.",
    "created_at": "2019-03-14T09:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274169",
    "user": "https://github.com/jplab"
}
```

Just as a summary here are things that need to be done (maybe some of them are already done):

- you may want to patch `as_number_field_element()` too,
- don't forget to add tests covering the case where some or all of the elements are rationals or elements of quadratic extensions (rationals, quadratic number field elements and higher-degree number field elements don't have exactly the same interface...) 
- Fix doctest in File "qqbar.py", line 2098, in sage.rings.qqbar.number_field_elements_from_algebraics
- `as_number_field_element` needs to pass on its new arguments, and corresponding doctests should be added. 
- Fix Comment 34 and Comment 36.



---

archive/issue_comments_274170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-17T07:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274170",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274171.json:
```json
{
    "body": "New commits:\n|                                                                                                                                          |                                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|\n|[5793bcf](https://git.sagemath.org/sage.git/commit?id=5793bcfce6f66f5740fce05c4d89c1587eaee872)|`Merge branch 'public/algnum_to_numberfield' of trac.sagemath.org:sage into 20181`|\n---\nNew commits:",
    "created_at": "2019-04-17T07:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274171",
    "user": "https://github.com/jplab"
}
```

New commits:
|                                                                                                                                          |                                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|[5793bcf](https://git.sagemath.org/sage.git/commit?id=5793bcfce6f66f5740fce05c4d89c1587eaee872)|`Merge branch 'public/algnum_to_numberfield' of trac.sagemath.org:sage into 20181`|
---
New commits:



---

archive/issue_events_054844.json:
```json
{
    "actor": "https://github.com/jplab",
    "created_at": "2019-04-17T07:42:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54844"
}
```



---

archive/issue_events_054845.json:
```json
{
    "actor": "https://github.com/jplab",
    "created_at": "2019-04-17T07:42:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54845"
}
```



---

archive/issue_comments_274172.json:
```json
{
    "body": "While rereading the docstring, I realized that it is quite confusing. Especially the following lines:\n\n```\n2154     Note that for the first example, where \\sage does not realize that \n2155     the number is real, we get a homomorphism to ``QQbar``; but with\n2156     ``minimal=True``, we get a homomorphism to ``AA``.  If we specify\n2157     both ``minimal=True`` and ``same_field=True``, we get a second\n2158     degree extension (minimal) that maps back to ``QQbar``.\n```",
    "created_at": "2019-04-17T08:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274172",
    "user": "https://github.com/jplab"
}
```

While rereading the docstring, I realized that it is quite confusing. Especially the following lines:

```
2154     Note that for the first example, where \sage does not realize that 
2155     the number is real, we get a homomorphism to ``QQbar``; but with
2156     ``minimal=True``, we get a homomorphism to ``AA``.  If we specify
2157     both ``minimal=True`` and ``same_field=True``, we get a second
2158     degree extension (minimal) that maps back to ``QQbar``.
```



---

archive/issue_comments_274173.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T08:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274173",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274174.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T12:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274174",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274175.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T12:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274175",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274176.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T13:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274176",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274177.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-22T13:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274177",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274178.json:
```json
{
    "body": "I deleted an old comment that should have been deleted in 2010 from ticket #9343.\n\nIt now looks ready for review.",
    "created_at": "2019-04-22T13:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274178",
    "user": "https://github.com/jplab"
}
```

I deleted an old comment that should have been deleted in 2010 from ticket #9343.

It now looks ready for review.



---

archive/issue_comments_274179.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-22T17:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274179",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274180.json:
```json
{
    "body": "Looks good to me and works well within #25097.\nBut it would be good if another reviewer could take a look as well.",
    "created_at": "2019-04-23T21:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274180",
    "user": "https://github.com/mkoeppe"
}
```

Looks good to me and works well within #25097.
But it would be good if another reviewer could take a look as well.



---

archive/issue_comments_274181.json:
```json
{
    "body": "It would be great is a semi-full-time number theorist looks into this...",
    "created_at": "2019-04-24T10:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274181",
    "user": "https://github.com/dimpase"
}
```

It would be great is a semi-full-time number theorist looks into this...



---

archive/issue_comments_274182.json:
```json
{
    "body": "I almost never use embedded number fields (instead I make explicit embeddings into RR or CC as needed), but this all looks reasonable and there is a lot of new documentation and examples, which is good.  So OK from me.",
    "created_at": "2019-04-24T18:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274182",
    "user": "https://github.com/JohnCremona"
}
```

I almost never use embedded number fields (instead I make explicit embeddings into RR or CC as needed), but this all looks reasonable and there is a lot of new documentation and examples, which is good.  So OK from me.



---

archive/issue_comments_274183.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-24T18:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274183",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_054846.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-29T12:35:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19944#event-54846"
}
```



---

archive/issue_comments_274184.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-29T12:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274184",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_274185.json:
```json
{
    "body": "you used \"map\" in a way that is not compatible with py3, please review the fix in #27767",
    "created_at": "2019-05-04T18:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19944#issuecomment-274185",
    "user": "https://github.com/fchapoton"
}
```

you used "map" in a way that is not compatible with py3, please review the fix in #27767
