# Issue 19945: Fix Rational.__pow__

archive/issues_019708.json:
```json
{
    "body": "The following is unexpected:\n\n```\nsage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ); (1/2)^n\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-18-784db7f7676d> in <module>()\n----> 1 A = AsymptoticRing('QQ^n * n^QQ', ZZ, names=('n',)); (n,) = A._first_ngens(1); (Integer(1)/Integer(2))**n\n\n/usr/local/src/sage-config/src/sage/rings/rational.pyx in sage.rings.rational.Rational.__pow__ (build/cythonized/sage/rings/rational.c:23638)()\n   2549 \n   2550             if isinstance(n, Element):\n-> 2551                 return (<Element>n)._parent(self)**n\n   2552             try:\n   2553                 return n.parent()(self)**n\n\n/usr/local/src/sage-config/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9529)()\n    916         if mor is not None:\n    917             if no_extra_args:\n--> 918                 return mor._call_(x)\n    919             else:\n    920                 return mor._call_with_args(x, args, kwds)\n\n/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4978)()\n    153                 print(type(C), C)\n    154                 print(type(C._element_constructor), C._element_constructor)\n--> 155             raise\n    156 \n    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):\n\n/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4846)()\n    148         cdef Parent C = self._codomain\n    149         try:\n--> 150             return C._element_constructor(x)\n    151         except Exception:\n    152             if print_warnings:\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/asymptotic_ring.pyc in _element_constructor_(self, data, simplify, convert)\n   3891             return result\n   3892 \n-> 3893         return self.create_summand('exact', data)\n   3894 \n   3895 \n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/asymptotic_ring.pyc in create_summand(self, type, data, **kwds)\n   4335 \n   4336         try:\n-> 4337             return self(TM(data, **kwds), simplify=False, convert=False)\n   4338         except ZeroCoefficientError:\n   4339             return self.zero()\n\n/usr/local/src/sage-config/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9529)()\n    916         if mor is not None:\n    917             if no_extra_args:\n--> 918                 return mor._call_(x)\n    919             else:\n    920                 return mor._call_with_args(x, args, kwds)\n\n/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4978)()\n    153                 print(type(C), C)\n    154                 print(type(C._element_constructor), C._element_constructor)\n--> 155             raise\n    156 \n    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):\n\n/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4846)()\n    148         cdef Parent C = self._codomain\n    149         try:\n--> 150             return C._element_constructor(x)\n    151         except Exception:\n    152             if print_warnings:\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/term_monoid.pyc in _element_constructor_(self, data, coefficient)\n   1670         except ValueError as e:\n   1671             raise combine_exceptions(\n-> 1672                 ValueError('%s is not in %s.' % (data, self)), e)\n   1673 \n   1674         return self._create_element_(growth, coefficient)\n\nValueError: 1/2 is not in Exact Term Monoid QQ^n * n^QQ with coefficients in Integer Ring.\n> *previous* ValueError: Factor 1/2 of 1/2 is neither a coefficient (in Integer Ring) nor growth (in Growth Group QQ^n * n^QQ).\n```\n\nCC:  @dkrenn @behackl\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nBranch: 5706029d8199f2e7d0e66ba84f19a44f3336e04c\n\nCommit: 5706029d8199f2e7d0e66ba84f19a44f3336e04c\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19945\n\n",
    "closed_at": "2018-12-01T13:43:40Z",
    "created_at": "2016-01-23T05:08:54Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Fix Rational.__pow__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19945",
    "user": "https://github.com/cheuberg"
}
```
The following is unexpected:

```
sage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ); (1/2)^n
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-18-784db7f7676d> in <module>()
----> 1 A = AsymptoticRing('QQ^n * n^QQ', ZZ, names=('n',)); (n,) = A._first_ngens(1); (Integer(1)/Integer(2))**n

/usr/local/src/sage-config/src/sage/rings/rational.pyx in sage.rings.rational.Rational.__pow__ (build/cythonized/sage/rings/rational.c:23638)()
   2549 
   2550             if isinstance(n, Element):
-> 2551                 return (<Element>n)._parent(self)**n
   2552             try:
   2553                 return n.parent()(self)**n

/usr/local/src/sage-config/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9529)()
    916         if mor is not None:
    917             if no_extra_args:
--> 918                 return mor._call_(x)
    919             else:
    920                 return mor._call_with_args(x, args, kwds)

/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4978)()
    153                 print(type(C), C)
    154                 print(type(C._element_constructor), C._element_constructor)
--> 155             raise
    156 
    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4846)()
    148         cdef Parent C = self._codomain
    149         try:
--> 150             return C._element_constructor(x)
    151         except Exception:
    152             if print_warnings:

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/asymptotic_ring.pyc in _element_constructor_(self, data, simplify, convert)
   3891             return result
   3892 
-> 3893         return self.create_summand('exact', data)
   3894 
   3895 

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/asymptotic_ring.pyc in create_summand(self, type, data, **kwds)
   4335 
   4336         try:
-> 4337             return self(TM(data, **kwds), simplify=False, convert=False)
   4338         except ZeroCoefficientError:
   4339             return self.zero()

/usr/local/src/sage-config/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9529)()
    916         if mor is not None:
    917             if no_extra_args:
--> 918                 return mor._call_(x)
    919             else:
    920                 return mor._call_with_args(x, args, kwds)

/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4978)()
    153                 print(type(C), C)
    154                 print(type(C._element_constructor), C._element_constructor)
--> 155             raise
    156 
    157     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/usr/local/src/sage-config/src/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4846)()
    148         cdef Parent C = self._codomain
    149         try:
--> 150             return C._element_constructor(x)
    151         except Exception:
    152             if print_warnings:

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/asymptotic/term_monoid.pyc in _element_constructor_(self, data, coefficient)
   1670         except ValueError as e:
   1671             raise combine_exceptions(
-> 1672                 ValueError('%s is not in %s.' % (data, self)), e)
   1673 
   1674         return self._create_element_(growth, coefficient)

ValueError: 1/2 is not in Exact Term Monoid QQ^n * n^QQ with coefficients in Integer Ring.
> *previous* ValueError: Factor 1/2 of 1/2 is neither a coefficient (in Integer Ring) nor growth (in Growth Group QQ^n * n^QQ).
```

CC:  @dkrenn @behackl

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Branch: 5706029d8199f2e7d0e66ba84f19a44f3336e04c

Commit: 5706029d8199f2e7d0e66ba84f19a44f3336e04c

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19945





---

archive/issue_comments_270612.json:
```json
{
    "body": "<a id='comment:1'></a>\n```\nsage: A.<n> = AsymptoticRing('QQ^n*n^QQ', QQ)\nsage: (1/2)^n\n(1/2)^n\n```\ndoes work.",
    "created_at": "2016-01-23T06:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270612",
    "user": "https://github.com/cheuberg"
}
```

<a id='comment:1'></a>
```
sage: A.<n> = AsymptoticRing('QQ^n*n^QQ', QQ)
sage: (1/2)^n
(1/2)^n
```
does work.



---

archive/issue_comments_270613.json:
```json
{
    "body": "Replying to [ticket:19945 cheuberg]:\n> {{{\n> sage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ)\n> sage: (1/2)^n\n> }}}\n\n\nThe problem is that `(1/2)^n` calls `__pow__` of the rational `1/2`. This tries `A(1/2)^n`, which fails since `1/2` is not in `A`. This also explains why it works with coefficient ring `QQ` as in [comment:1 comment:1].\n\nAs a workaround you can use\n\n```\nsage: n.rpow(1/2)\n```",
    "created_at": "2016-01-25T18:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270613",
    "user": "https://github.com/dkrenn"
}
```

Replying to [ticket:19945 cheuberg]:
> {{{
> sage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ)
> sage: (1/2)^n
> }}}


The problem is that `(1/2)^n` calls `__pow__` of the rational `1/2`. This tries `A(1/2)^n`, which fails since `1/2` is not in `A`. This also explains why it works with coefficient ring `QQ` as in [comment:1 comment:1].

As a workaround you can use

```
sage: n.rpow(1/2)
```



---

archive/issue_comments_270614.json:
```json
{
    "body": "<a id='comment:3'></a>Documented at #19961.",
    "created_at": "2016-01-26T08:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270614",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:3'></a>Documented at #19961.



---

archive/issue_comments_270615.json:
```json
{
    "body": "Changing component from asymptotic expansions to basic arithmetic.",
    "created_at": "2018-01-08T09:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270615",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from asymptotic expansions to basic arithmetic.



---

archive/issue_comments_270616.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-08T10:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270616",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270617.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-08T10:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270617",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270618.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-08T10:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270618",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270619.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-01-08T10:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270619",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270620.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-21T12:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270620",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_270621.json:
```json
{
    "body": "<a id='comment:11'></a>\n```\nsage -t --long --warn-long 63.9 src/sage/rings/rational.pyx\n**********************************************************************\nFile \"src/sage/rings/rational.pyx\", line 302, in sage.rings.rational.rational_power_parts\nFailed example:\n    (-1)^(-1/3)\nExpected:\n    -(-1)^(2/3)\nGot:\n    -1.0*(-1)^(2/3)\n**********************************************************************\n```",
    "created_at": "2018-02-21T12:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270621",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:11'></a>
```
sage -t --long --warn-long 63.9 src/sage/rings/rational.pyx
**********************************************************************
File "src/sage/rings/rational.pyx", line 302, in sage.rings.rational.rational_power_parts
Failed example:
    (-1)^(-1/3)
Expected:
    -(-1)^(2/3)
Got:
    -1.0*(-1)^(2/3)
**********************************************************************
```



---

archive/issue_comments_270622.json:
```json
{
    "body": "<a id='comment:12'></a>Seriously? How did that happen?",
    "created_at": "2018-02-21T12:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270622",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Seriously? How did that happen?



---

archive/issue_comments_270623.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:\n> Seriously? How did that happen?\n\n\nNo idea. I just thought I would review this ticket, merged your branch in the current `develop`, and ran the test suite.",
    "created_at": "2018-02-21T13:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270623",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:
> Seriously? How did that happen?


No idea. I just thought I would review this ticket, merged your branch in the current `develop`, and ran the test suite.



---

archive/issue_comments_270624.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-11-26T12:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270624",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270625.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-11-26T12:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_events_054446.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-11-26T12:26:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19945#event-54446"
}
```



---

archive/issue_comments_270626.json:
```json
{
    "body": "<a id='comment:17'></a>Rebased to 8.5.beta5.",
    "created_at": "2018-11-26T12:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270626",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Rebased to 8.5.beta5.



---

archive/issue_comments_270627.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-26T12:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270627",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_270628.json:
```json
{
    "body": "<a id='comment:18'></a>In general, this LGTM. Have you run any timings to see if there is any change for **Q**<sup>**Z**</sup>, **Q**<sup>**Q**</sup>, and **Z**<sup>**Q**</sup>? Since these are common operations and they now go through the coercion framework (if I understand everything correctly), I want to make sure they are not (significantly) affected.",
    "created_at": "2018-11-27T03:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270628",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>In general, this LGTM. Have you run any timings to see if there is any change for **Q**<sup>**Z**</sup>, **Q**<sup>**Q**</sup>, and **Z**<sup>**Q**</sup>? Since these are common operations and they now go through the coercion framework (if I understand everything correctly), I want to make sure they are not (significantly) affected.



---

archive/issue_comments_270629.json:
```json
{
    "body": "<a id='comment:19'></a>I did some timings with mixed results:\n\n1. `QQ^ZZ` became slower by a factor 1.4 (404ns to 575ns). This is because of the overhead of `IntegerPowAction` and it's really hard to avoid this slow-down. It's also a large relative slow-down because the actual powering is very fast.\n\n2. The old code optimized the case of powering to a rational integer (an element of `QQ` with denominator 1). The new code doesn't, leading to a slow-down for `QQ^QQ` with integral exponent.\n\n3. `QQ^QQ` is faster if the exponent is not a rational integer.\n\n4. `ZZ^QQ` simply delegates to `QQ^QQ` (this code is not changed), so speed gains/losses are similar to the `QQ^QQ` case.\n\nI'm not entirely sure whether I should implement a special case for powering to a rational integer. Is this case common enough to warrant the extra code?\n\nI also noticed that #24500 gives an additional slight slow-down for `QQ^ZZ` (about 5%). This is because powering is always a right action, so the problem that #24500 fixes does not occur for `IntegerPowAction`.",
    "created_at": "2018-11-27T11:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270629",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>I did some timings with mixed results:

1. `QQ^ZZ` became slower by a factor 1.4 (404ns to 575ns). This is because of the overhead of `IntegerPowAction` and it's really hard to avoid this slow-down. It's also a large relative slow-down because the actual powering is very fast.

2. The old code optimized the case of powering to a rational integer (an element of `QQ` with denominator 1). The new code doesn't, leading to a slow-down for `QQ^QQ` with integral exponent.

3. `QQ^QQ` is faster if the exponent is not a rational integer.

4. `ZZ^QQ` simply delegates to `QQ^QQ` (this code is not changed), so speed gains/losses are similar to the `QQ^QQ` case.

I'm not entirely sure whether I should implement a special case for powering to a rational integer. Is this case common enough to warrant the extra code?

I also noticed that #24500 gives an additional slight slow-down for `QQ^ZZ` (about 5%). This is because powering is always a right action, so the problem that #24500 fixes does not occur for `IntegerPowAction`.



---

archive/issue_comments_270630.json:
```json
{
    "body": "<a id='comment:20'></a>#26775 should solve most of the slow-down for `QQ^ZZ`.",
    "created_at": "2018-11-27T11:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270630",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>#26775 should solve most of the slow-down for `QQ^ZZ`.



---

archive/issue_comments_270631.json:
```json
{
    "body": "<a id='comment:21'></a>Never mind, my analysis at #26775 was wrong.\n\nStill, there is something strange with benchmarks: without changing any code, the old code slowed down from 404ns to 446ns and the new code (on top of #24500) sped up from about 600ns to 515ns. So without really changing anything (but recompiling the new code), I now have a slow-down of a factor only 1.15 for `QQ^ZZ`. Benchmarks are a strange thing...",
    "created_at": "2018-11-27T11:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270631",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Never mind, my analysis at #26775 was wrong.

Still, there is something strange with benchmarks: without changing any code, the old code slowed down from 404ns to 446ns and the new code (on top of #24500) sped up from about 600ns to 515ns. So without really changing anything (but recompiling the new code), I now have a slow-down of a factor only 1.15 for `QQ^ZZ`. Benchmarks are a strange thing...



---

archive/issue_comments_270632.json:
```json
{
    "body": "<a id='comment:22'></a>The wildly differing timings must be something like a memory layout/cache issue.\n\nAnyway, for `QQ^ZZ`, I give the best timings for\n\n```\nsage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)\n```\n\nVanilla 8.5.beta5:\n\n```\n100000 loops, best of 20: 397 ns per loop\n```\n\nWith #19945:\n\n```\n100000 loops, best of 20: 512 ns per loop\n```\n\nWith #24500 and #19945:\n\n```\n100000 loops, best of 20: 509 ns per loop\n```",
    "created_at": "2018-11-27T11:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270632",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>The wildly differing timings must be something like a memory layout/cache issue.

Anyway, for `QQ^ZZ`, I give the best timings for

```
sage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)
```

Vanilla 8.5.beta5:

```
100000 loops, best of 20: 397 ns per loop
```

With #19945:

```
100000 loops, best of 20: 512 ns per loop
```

With #24500 and #19945:

```
100000 loops, best of 20: 509 ns per loop
```



---

archive/issue_comments_270633.json:
```json
{
    "body": "<a id='comment:23'></a>Most of the slowdown in this ticket is due to\n\n```\nsage: g = coercion_model.get_action; args = (QQ, ZZ, operator.pow)\nsage: timeit('g(*args)', repeat=20, number=100000)\n100000 loops, best of 20: 133 ns per loop\n```",
    "created_at": "2018-11-27T11:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270633",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>Most of the slowdown in this ticket is due to

```
sage: g = coercion_model.get_action; args = (QQ, ZZ, operator.pow)
sage: timeit('g(*args)', repeat=20, number=100000)
100000 loops, best of 20: 133 ns per loop
```



---

archive/issue_comments_270634.json:
```json
{
    "body": "<a id='comment:24'></a>That is what I expected. I was wondering if we wanted to special case such things to avoid going through the coercion framework. I also think it is worthwhile to special case rational powers that are integers.",
    "created_at": "2018-11-27T12:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270634",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>That is what I expected. I was wondering if we wanted to special case such things to avoid going through the coercion framework. I also think it is worthwhile to special case rational powers that are integers.



---

archive/issue_comments_270635.json:
```json
{
    "body": "<a id='comment:25'></a>#26776 should gain about 20ns.",
    "created_at": "2018-11-27T12:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270635",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>#26776 should gain about 20ns.



---

archive/issue_comments_270636.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:24 tscrim]:\n> I was wondering if we wanted to special case such things to avoid going through the coercion framework.\n\n\nMore useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.",
    "created_at": "2018-11-28T15:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270636",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:24 tscrim]:
> I was wondering if we wanted to special case such things to avoid going through the coercion framework.


More useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.



---

archive/issue_comments_270637.json:
```json
{
    "body": "<a id='comment:27'></a>With #26776 + #19945:\n\n```\nsage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)\n100000 loops, best of 20: 479 ns per loop\n```",
    "created_at": "2018-11-28T15:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270637",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>With #26776 + #19945:

```
sage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)
100000 loops, best of 20: 479 ns per loop
```



---

archive/issue_comments_270638.json:
```json
{
    "body": "<a id='comment:28'></a>With the improvements from #26776, the slow-down is \"only\" 20%.",
    "created_at": "2018-11-28T20:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270638",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>With the improvements from #26776, the slow-down is "only" 20%.



---

archive/issue_comments_270639.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:26 jdemeyer]:\n> Replying to [comment:24 tscrim]:\n> > I was wondering if we wanted to special case such things to avoid going through the coercion framework.\n\n> \n> More useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.\n\n\nI thought we already had some special casing for this with `IntegerPowAction`?\n\nIMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that. However, I don't know how often this occurs in practice. My gut tells me that exponentiation of rationals is usually not a bottleneck in most computations, so I might be being too precious here.",
    "created_at": "2018-11-29T00:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270639",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:29'></a>Replying to [comment:26 jdemeyer]:
> Replying to [comment:24 tscrim]:
> > I was wondering if we wanted to special case such things to avoid going through the coercion framework.

> 
> More useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.


I thought we already had some special casing for this with `IntegerPowAction`?

IMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that. However, I don't know how often this occurs in practice. My gut tells me that exponentiation of rationals is usually not a bottleneck in most computations, so I might be being too precious here.



---

archive/issue_comments_270640.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 tscrim]:\n> I thought we already had some special casing for this with `IntegerPowAction`?\n\n\nNo, we don't. It's just an ordinary action.\n\n> IMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that.\n\n\nSure, I'll do that.",
    "created_at": "2018-11-29T06:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270640",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Replying to [comment:29 tscrim]:
> I thought we already had some special casing for this with `IntegerPowAction`?


No, we don't. It's just an ordinary action.

> IMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that.


Sure, I'll do that.



---

archive/issue_comments_270641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-29T06:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270641",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_270642.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-11-29T12:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_270643.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-29T12:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270643",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_270644.json:
```json
{
    "body": "<a id='comment:33'></a>I optimized powering by rational integers, which is now much faster than before.",
    "created_at": "2018-11-29T12:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270644",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>I optimized powering by rational integers, which is now much faster than before.



---

archive/issue_comments_270645.json:
```json
{
    "body": "<a id='comment:34'></a>Thank you and also for doing the initial timings as well. When the patchbot comes back green, you can set this to a positive review.",
    "created_at": "2018-11-29T13:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270645",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:34'></a>Thank you and also for doing the initial timings as well. When the patchbot comes back green, you can set this to a positive review.



---

archive/issue_comments_270646.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-29T16:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270646",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_054447.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-01T13:43:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19945#event-54447"
}
```



---

archive/issue_comments_270647.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-01T13:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19945",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19945#issuecomment-270647",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
