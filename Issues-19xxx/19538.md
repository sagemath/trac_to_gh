# Issue 19538: Fix LaurentPolynomialRing coercion issues

archive/issues_019301.json:
```json
{
    "body": "`LaurentPolynomialRing` has some issues when trying to compare elements from different rings:\n\n```\nsage: L1 = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\nsage: L2 = LaurentPolynomialRing(ZZ, 'y0,y1,y2')\nsage: L2.gen(0) in L1\nFalse\nsage: L1(L2.gen(0))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: tuple key must have same length as ngens\n```\n\nThe corresponding code for `PolynomialRing` yields\n\n```\nsage: P1 = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\nsage: P2 = PolynomialRing(ZZ, 'y0,y1,y2')\nsage: P2.gen(0) in P1\nTrue\nsage: P1(P2.gen(0))\ny0\n```\n\n\nThis patch should fix them. In the process it also changes this somewhat weird behaviour:\n\n```\nsage: L = LaurentPolynomialRing(ZZ, 'x', 4)\nsage: R = LaurentPolynomialRing(ZZ, 'x3,x2,t,s')\nsage: R.inject_variables()\nDefining x3, x2, t, s\nsage: L(x3)\nx0\nsage: L(t)\nx2\n```\n\nNOTE: This behaviour still survives in `PolynomialRing`\n\n\n**CC:**  drupel @tscrim\n\n**Branch/Commit:** [a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)\n\n**Reviewer:** Dylan Rupel\n\n**Author:** Salvatore Stella\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19538\n\n",
    "closed_at": "2016-08-19T22:45:15Z",
    "created_at": "2015-11-06T15:28:48Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Fix LaurentPolynomialRing coercion issues",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19538",
    "user": "https://github.com/etn40ff"
}
```
`LaurentPolynomialRing` has some issues when trying to compare elements from different rings:

```
sage: L1 = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
sage: L2 = LaurentPolynomialRing(ZZ, 'y0,y1,y2')
sage: L2.gen(0) in L1
False
sage: L1(L2.gen(0))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: tuple key must have same length as ngens
```

The corresponding code for `PolynomialRing` yields

```
sage: P1 = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
sage: P2 = PolynomialRing(ZZ, 'y0,y1,y2')
sage: P2.gen(0) in P1
True
sage: P1(P2.gen(0))
y0
```


This patch should fix them. In the process it also changes this somewhat weird behaviour:

```
sage: L = LaurentPolynomialRing(ZZ, 'x', 4)
sage: R = LaurentPolynomialRing(ZZ, 'x3,x2,t,s')
sage: R.inject_variables()
Defining x3, x2, t, s
sage: L(x3)
x0
sage: L(t)
x2
```

NOTE: This behaviour still survives in `PolynomialRing`


**CC:**  drupel @tscrim

**Branch/Commit:** [a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)

**Reviewer:** Dylan Rupel

**Author:** Salvatore Stella

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/19538





---

archive/issue_comments_353956.json:
```json
{
    "body": "**Branch:** [u/etn40ff/sub_laurent_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/sub_laurent_poly)",
    "created_at": "2015-11-06T15:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353956",
    "user": "https://github.com/etn40ff"
}
```

**Branch:** [u/etn40ff/sub_laurent_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/sub_laurent_poly)



---

archive/issue_comments_353957.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,26 @@\n+`LaurentPolynomialRing` has some issues when trying to compare elements from different rings:\n \n+```\n+sage: L = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\n+sage: P = LaurentPolynomialRing(ZZ, 'y0,y1,y2')\n+sage: P.inject_variables()\n+Defining y0, y1, y2\n+sage: y0 in L\n+False\n+```\n+\n+This patch should fix them. In the process it also changes this somewhat weird behaviour:\n+\n+```\n+sage: L = LaurentPolynomialRing(ZZ, 'x', 4)\n+sage: R = LaurentPolynomialRing(ZZ, 'x3,x2,t,s')\n+sage: R.inject_variables()\n+Defining x3, x2, t, s\n+sage: L(x3)\n+x0\n+sage: L(t)\n+x2\n+```\n+\n+NOTE: This behaviour still survives in `PolynomialRing`\n+\n``````\n",
    "created_at": "2015-11-06T15:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353957",
    "user": "https://github.com/etn40ff"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,26 @@
+`LaurentPolynomialRing` has some issues when trying to compare elements from different rings:
 
+```
+sage: L = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
+sage: P = LaurentPolynomialRing(ZZ, 'y0,y1,y2')
+sage: P.inject_variables()
+Defining y0, y1, y2
+sage: y0 in L
+False
+```
+
+This patch should fix them. In the process it also changes this somewhat weird behaviour:
+
+```
+sage: L = LaurentPolynomialRing(ZZ, 'x', 4)
+sage: R = LaurentPolynomialRing(ZZ, 'x3,x2,t,s')
+sage: R.inject_variables()
+Defining x3, x2, t, s
+sage: L(x3)
+x0
+sage: L(t)
+x2
+```
+
+NOTE: This behaviour still survives in `PolynomialRing`
+
``````




---

archive/issue_comments_353958.json:
```json
{
    "body": "**Author:** Salvatore Stella",
    "created_at": "2015-11-06T15:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353958",
    "user": "https://github.com/etn40ff"
}
```

**Author:** Salvatore Stella



---

archive/issue_comments_353959.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2015-11-06T15:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353959",
    "user": "https://github.com/etn40ff"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_353960.json:
```json
{
    "body": "**Commit:** [94635cc51e5ff4c02f13b6c7a65d944c07783374](https://github.com/sagemath/sagetrac-mirror/commit/94635cc51e5ff4c02f13b6c7a65d944c07783374)",
    "created_at": "2015-11-06T15:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353960",
    "user": "https://github.com/etn40ff"
}
```

**Commit:** [94635cc51e5ff4c02f13b6c7a65d944c07783374](https://github.com/sagemath/sagetrac-mirror/commit/94635cc51e5ff4c02f13b6c7a65d944c07783374)



---

archive/issue_events_061164.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "rename": {
        "from": "Fix LaurentPolynomialRing cohercion issues",
        "to": "Fix LaurentPolynomialRing coercion issues"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19538#event-61164"
}
```



---

archive/issue_comments_353961.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf\">cca7f1e</a></td><td><code>Fix coercion for LaurentPolynomialRing</code></td></tr></table>\n",
    "created_at": "2015-11-06T16:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353961",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf">cca7f1e</a></td><td><code>Fix coercion for LaurentPolynomialRing</code></td></tr></table>




---

archive/issue_comments_353962.json:
```json
{
    "body": "**Changing commit** from \"[94635cc51e5ff4c02f13b6c7a65d944c07783374](https://github.com/sagemath/sagetrac-mirror/commit/94635cc51e5ff4c02f13b6c7a65d944c07783374)\" to \"[cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf](https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf)\".",
    "created_at": "2015-11-06T16:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[94635cc51e5ff4c02f13b6c7a65d944c07783374](https://github.com/sagemath/sagetrac-mirror/commit/94635cc51e5ff4c02f13b6c7a65d944c07783374)" to "[cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf](https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf)".



---

archive/issue_comments_353963.json:
```json
{
    "body": "**Changing branch** from \"[u/etn40ff/sub_laurent_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/sub_laurent_poly)\" to \"[u/etn40ff/19358](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/19358)\".",
    "created_at": "2015-11-06T18:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353963",
    "user": "https://github.com/etn40ff"
}
```

**Changing branch** from "[u/etn40ff/sub_laurent_poly](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/sub_laurent_poly)" to "[u/etn40ff/19358](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/19358)".



---

archive/issue_comments_353964.json:
```json
{
    "body": "**Changing commit** from \"[cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf](https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf)\" to \"[76ac4339b195762106d406516400f8468de844ef](https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef)\".",
    "created_at": "2015-11-06T18:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353964",
    "user": "https://github.com/etn40ff"
}
```

**Changing commit** from "[cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf](https://github.com/sagemath/sagetrac-mirror/commit/cca7f1e6bf7b4a456ba7e527693f48297b9ca9cf)" to "[76ac4339b195762106d406516400f8468de844ef](https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef)".



---

archive/issue_comments_353965.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c784bce5c0a3823443b0033bf424f954d94810fa\">c784bce</a></td><td><code>Fix coercion for LaurentPolynomialRing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef\">76ac433</a></td><td><code>Improved doctest</code></td></tr></table>\n",
    "created_at": "2015-11-06T18:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353965",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c784bce5c0a3823443b0033bf424f954d94810fa">c784bce</a></td><td><code>Fix coercion for LaurentPolynomialRing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef">76ac433</a></td><td><code>Improved doctest</code></td></tr></table>




---

archive/issue_comments_353966.json:
```json
{
    "body": "<a id='comment:5'></a>\n* Is `x.parent().gens()` guaranteed to always come in the same order?\n* You use `x.parent().gens()` and also `parent`. Please use the better of the two always\n* Have you done some timing tests whether this slows down stuff?",
    "created_at": "2016-04-05T16:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353966",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:5'></a>
* Is `x.parent().gens()` guaranteed to always come in the same order?
* You use `x.parent().gens()` and also `parent`. Please use the better of the two always
* Have you done some timing tests whether this slows down stuff?



---

archive/issue_comments_353967.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith respect to the second point (conversion) the behavior should be the same as in `PolynomialRing`. Having two different conversion conventions is more confusing than having a \"bad\" one.",
    "created_at": "2016-04-05T17:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353967",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
With respect to the second point (conversion) the behavior should be the same as in `PolynomialRing`. Having two different conversion conventions is more confusing than having a "bad" one.



---

archive/issue_comments_353968.json:
```json
{
    "body": "<a id='comment:7'></a>\n`@`stumpc5\n\n- `x.parent().gens()` should return `x.parent()._gens` which is a tuple\n  so the order should be fixed.\n\n- `x.parent().gens()` and also `parent` are in general different, the\n  whole purpose of this patch is to make sure that, when they differ, some\n  natural coercion can still be implemented.\n\n- I did not run precise tests but I expect the new version to be slower than the\n  old one (maybe even significantly slower); the point though is that the\n  current version is not working as it should. I could make a much faster\n  function that returns some hardcoded nonsense but it would clearly not be the\n  right function. More seriously I should run some benchmark, any idea on which?\n\n@videlec\n\nI agree that the behaviour of `LaurentPolynomialRing` and that of\n`PolynomialRing` should be the same. The point is that currently they are\nnot.\n\nFor example the same code in the ticket description evaluates to\n\n```\nsage: L = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\nsage: P = PolynomialRing(ZZ, 'y0,y1,y2')\nsage: P.inject_variables()\nDefining y0, y1, y2\nsage: y0 in L\nTrue\nsage: L = PolynomialRing(ZZ, 'x', 4)\nsage: R = PolynomialRing(ZZ, 'x3,x2,t,s')\nsage: R.inject_variables()\nDefining x3, x2, t, s\nsage: L(x3)\nx0\nsage: L(t)\nx2\n```\n\nI do not know how to fix the first issue in the ticket description while leaving the second one as is. This patch just exchange one inconsistent behavior for another. Any Idea on how to deal with this in a more elegant/consistent/efficient way is extremely welcome.",
    "created_at": "2016-04-05T22:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353968",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:7'></a>
`@`stumpc5

- `x.parent().gens()` should return `x.parent()._gens` which is a tuple
  so the order should be fixed.

- `x.parent().gens()` and also `parent` are in general different, the
  whole purpose of this patch is to make sure that, when they differ, some
  natural coercion can still be implemented.

- I did not run precise tests but I expect the new version to be slower than the
  old one (maybe even significantly slower); the point though is that the
  current version is not working as it should. I could make a much faster
  function that returns some hardcoded nonsense but it would clearly not be the
  right function. More seriously I should run some benchmark, any idea on which?

@videlec

I agree that the behaviour of `LaurentPolynomialRing` and that of
`PolynomialRing` should be the same. The point is that currently they are
not.

For example the same code in the ticket description evaluates to

```
sage: L = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
sage: P = PolynomialRing(ZZ, 'y0,y1,y2')
sage: P.inject_variables()
Defining y0, y1, y2
sage: y0 in L
True
sage: L = PolynomialRing(ZZ, 'x', 4)
sage: R = PolynomialRing(ZZ, 'x3,x2,t,s')
sage: R.inject_variables()
Defining x3, x2, t, s
sage: L(x3)
x0
sage: L(t)
x2
```

I do not know how to fix the first issue in the ticket description while leaving the second one as is. This patch just exchange one inconsistent behavior for another. Any Idea on how to deal with this in a more elegant/consistent/efficient way is extremely welcome.



---

archive/issue_comments_353969.json:
```json
{
    "body": "<a id='comment:8'></a>\nUnless I did a mistake, the conversion rules are the same for `PolynomialRing` and `LaurentPolynomialRing` (but the semantic of the operation `in` is not as you noticed). The rules are as follows for a map `R -> S`:\n1. if the variables of `R` are included in the variables of `S` then the map `R -> S` is given by names of variables\n2. else if `R` has less or equal variables than `S`  then the map `R -> S` is given by the order of the variable\n3. else if some variable of `R` are present in `S` then there is a partial map considered\n4. otherwise an error is raised\n\n```\nsage: R1 = PolynomialRing(ZZ, 'x,y')\nsage: R2 = PolynomialRing(ZZ, 'x,t')\nsage: R3 = PolynomialRing(ZZ, 't,x')\nsage: R4 = PolynomialRing(ZZ, 'x,t,y')\nsage: map(R4, R1.gens()) # rule 1\n[x, y]\nsage: map(R4, R3.gens()) # rule 1\n[t, x]\nsage: map(R2, R1.gens())  # rule 2\n[x, t]\nsage: map(R1, R2.gens())  # rule 2\n[x, y]\nsage: R1(R4('y')) # rule 3\ny\nsage: R1(R4('t')) # rule 4\nTraceback (most recent call last):\n...\nTypeError: Could not find a mapping of the passed element to this ring.\n```\nThese rules should not change. You can have a look at the implementation of `_element_constructor_` for polynomial rings.",
    "created_at": "2016-04-06T00:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353969",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>
Unless I did a mistake, the conversion rules are the same for `PolynomialRing` and `LaurentPolynomialRing` (but the semantic of the operation `in` is not as you noticed). The rules are as follows for a map `R -> S`:
1. if the variables of `R` are included in the variables of `S` then the map `R -> S` is given by names of variables
2. else if `R` has less or equal variables than `S`  then the map `R -> S` is given by the order of the variable
3. else if some variable of `R` are present in `S` then there is a partial map considered
4. otherwise an error is raised

```
sage: R1 = PolynomialRing(ZZ, 'x,y')
sage: R2 = PolynomialRing(ZZ, 'x,t')
sage: R3 = PolynomialRing(ZZ, 't,x')
sage: R4 = PolynomialRing(ZZ, 'x,t,y')
sage: map(R4, R1.gens()) # rule 1
[x, y]
sage: map(R4, R3.gens()) # rule 1
[t, x]
sage: map(R2, R1.gens())  # rule 2
[x, t]
sage: map(R1, R2.gens())  # rule 2
[x, y]
sage: R1(R4('y')) # rule 3
y
sage: R1(R4('t')) # rule 4
Traceback (most recent call last):
...
TypeError: Could not find a mapping of the passed element to this ring.
```
These rules should not change. You can have a look at the implementation of `_element_constructor_` for polynomial rings.



---

archive/issue_comments_353970.json:
```json
{
    "body": "<a id='comment:9'></a>\nWhen I do the very same on `LaurentPolynomialRing`, I get into trouble, so I don't understand what you mean by \"the conversion rules are the same for `PolynomialRing` and `LaurentPolynomialRing`\", see\n\n```\nsage: R1 = LaurentPolynomialRing(ZZ, 'x,y')\nsage: R2 = LaurentPolynomialRing(ZZ, 'x,t')\nsage: R3 = LaurentPolynomialRing(ZZ, 't,x')\nsage: R4 = LaurentPolynomialRing(ZZ, 'x,t,y')\nsage: map(R4, R1.gens()) # rule 1            \n---------------------------------------------------------------------------\n...\nTypeError: tuple key must have same length as ngens\nsage: map(R4, R3.gens()) # rule 1            \n---------------------------------------------------------------------------\n...\nTypeError: tuple key must have same length as ngens\nsage: map(R1, R2.gens())  # rule 2           \n[x, y]\nsage: map(R2, R1.gens())  # rule 2           \n[x, t]\nsage: R1(R4('y')) # rule 3                   \n---------------------------------------------------------------------------\n...\nTypeError: tuple key must have same length as ngens\nsage: R1(R4('t')) # rule 4                   \n---------------------------------------------------------------------------\n...\nTypeError: tuple key must have same length as ngens\n```\nIs that behaviour what you expected?",
    "created_at": "2016-04-06T07:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353970",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:9'></a>
When I do the very same on `LaurentPolynomialRing`, I get into trouble, so I don't understand what you mean by "the conversion rules are the same for `PolynomialRing` and `LaurentPolynomialRing`", see

```
sage: R1 = LaurentPolynomialRing(ZZ, 'x,y')
sage: R2 = LaurentPolynomialRing(ZZ, 'x,t')
sage: R3 = LaurentPolynomialRing(ZZ, 't,x')
sage: R4 = LaurentPolynomialRing(ZZ, 'x,t,y')
sage: map(R4, R1.gens()) # rule 1            
---------------------------------------------------------------------------
...
TypeError: tuple key must have same length as ngens
sage: map(R4, R3.gens()) # rule 1            
---------------------------------------------------------------------------
...
TypeError: tuple key must have same length as ngens
sage: map(R1, R2.gens())  # rule 2           
[x, y]
sage: map(R2, R1.gens())  # rule 2           
[x, t]
sage: R1(R4('y')) # rule 3                   
---------------------------------------------------------------------------
...
TypeError: tuple key must have same length as ngens
sage: R1(R4('t')) # rule 4                   
---------------------------------------------------------------------------
...
TypeError: tuple key must have same length as ngens
```
Is that behaviour what you expected?



---

archive/issue_comments_353971.json:
```json
{
    "body": "<a id='comment:10'></a>\nI am not really happy about the formulation of rule 2. What I mean by this is\nthat I find this example extremely confusing because it maps `y` to `x`\nand `t` to `y`\n\n```\nsage: R1 = PolynomialRing(ZZ, 'x,y')\nsage: R5 = PolynomialRing(ZZ, 'y,t')\nsage: map(R1, R5.gens())  # rule 2\n[x, y]\n```\n\nWhat is the rationale behind it?",
    "created_at": "2016-04-06T08:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353971",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:10'></a>
I am not really happy about the formulation of rule 2. What I mean by this is
that I find this example extremely confusing because it maps `y` to `x`
and `t` to `y`

```
sage: R1 = PolynomialRing(ZZ, 'x,y')
sage: R5 = PolynomialRing(ZZ, 'y,t')
sage: map(R1, R5.gens())  # rule 2
[x, y]
```

What is the rationale behind it?



---

archive/issue_comments_353972.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [etn40ff](#comment%3A10):\n> I am not really happy about the formulation of rule 2. What I mean by this is\n> that I find this example extremely confusing because it maps `y` to `x`\n> and `t` to `y`\n> \n> ```\n> sage: R1 = PolynomialRing(ZZ, 'x,y')\n> sage: R5 = PolynomialRing(ZZ, 'y,t')\n> sage: map(R1, R5.gens())  # rule 2\n> [x, y]\n> ```\n> \n> What is the rationale behind it?\n\n\nI would say: \"A map between two rings is always better than a partial map\". Whatever you think it is how it works in Sage. If you want to change it you should ask more opinions on [sage-devel](https://groups.google.com/forum/#!forum/sage-devel).\n\nOne possibility would be to modify the rule 2 in the following form\n\n2'. else if `R` has less or equal variables than `S` then the map `R -> S` is given by a mapping of the variables of `R` into `S` first trying to match names and then in variable order.\n\nBut as I said, the place to discuss it is sage-devel and not a ticket.",
    "created_at": "2016-04-08T14:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353972",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Replying to [etn40ff](#comment%3A10):
> I am not really happy about the formulation of rule 2. What I mean by this is
> that I find this example extremely confusing because it maps `y` to `x`
> and `t` to `y`
> 
> ```
> sage: R1 = PolynomialRing(ZZ, 'x,y')
> sage: R5 = PolynomialRing(ZZ, 'y,t')
> sage: map(R1, R5.gens())  # rule 2
> [x, y]
> ```
> 
> What is the rationale behind it?


I would say: "A map between two rings is always better than a partial map". Whatever you think it is how it works in Sage. If you want to change it you should ask more opinions on [sage-devel](https://groups.google.com/forum/#!forum/sage-devel).

One possibility would be to modify the rule 2 in the following form

2'. else if `R` has less or equal variables than `S` then the map `R -> S` is given by a mapping of the variables of `R` into `S` first trying to match names and then in variable order.

But as I said, the place to discuss it is sage-devel and not a ticket.



---

archive/issue_comments_353973.json:
```json
{
    "body": "<a id='comment:12'></a>\nWriting to the mailing list seems the best option here; I will do so shortly.\nThanks for the advice\n\nBTW: I think the bug description is describing the wrong issue so I will change it before writing to the list",
    "created_at": "2016-04-08T21:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353973",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:12'></a>
Writing to the mailing list seems the best option here; I will do so shortly.
Thanks for the advice

BTW: I think the bug description is describing the wrong issue so I will change it before writing to the list



---

archive/issue_comments_353974.json:
```json
{
    "body": "<a id='comment:13'></a>\nLet me just add that we really should be consistent between laurent polynomials and ordinary polynomials.",
    "created_at": "2016-04-08T21:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353974",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Let me just add that we really should be consistent between laurent polynomials and ordinary polynomials.



---

archive/issue_comments_353975.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,13 +1,28 @@\n `LaurentPolynomialRing` has some issues when trying to compare elements from different rings:\n \n ```\n-sage: L = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\n-sage: P = LaurentPolynomialRing(ZZ, 'y0,y1,y2')\n-sage: P.inject_variables()\n-Defining y0, y1, y2\n-sage: y0 in L\n+sage: L1 = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\n+sage: L2 = LaurentPolynomialRing(ZZ, 'y0,y1,y2')\n+sage: L2.gen(0) in L1\n False\n+sage: L1(L2.gen(0))\n+---------------------------------------------------------------------------\n+TypeError                                 Traceback (most recent call last)\n+...\n+TypeError: tuple key must have same length as ngens\n ```\n+\n+The corresponding code for `PolynomialRing` yields\n+\n+```\n+sage: P1 = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')\n+sage: P2 = PolynomialRing(ZZ, 'y0,y1,y2')\n+sage: P2.gen(0) in P1\n+True\n+sage: P1(P2.gen(0))\n+y0\n+```\n+\n \n This patch should fix them. In the process it also changes this somewhat weird behaviour:\n \n``````\n",
    "created_at": "2016-04-08T22:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353975",
    "user": "https://github.com/etn40ff"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,13 +1,28 @@
 `LaurentPolynomialRing` has some issues when trying to compare elements from different rings:
 
 ```
-sage: L = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
-sage: P = LaurentPolynomialRing(ZZ, 'y0,y1,y2')
-sage: P.inject_variables()
-Defining y0, y1, y2
-sage: y0 in L
+sage: L1 = LaurentPolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
+sage: L2 = LaurentPolynomialRing(ZZ, 'y0,y1,y2')
+sage: L2.gen(0) in L1
 False
+sage: L1(L2.gen(0))
+---------------------------------------------------------------------------
+TypeError                                 Traceback (most recent call last)
+...
+TypeError: tuple key must have same length as ngens
 ```
+
+The corresponding code for `PolynomialRing` yields
+
+```
+sage: P1 = PolynomialRing(ZZ, 'x0,x1,x2,y0,y1,y2')
+sage: P2 = PolynomialRing(ZZ, 'y0,y1,y2')
+sage: P2.gen(0) in P1
+True
+sage: P1(P2.gen(0))
+y0
+```
+
 
 This patch should fix them. In the process it also changes this somewhat weird behaviour:
 
``````




---

archive/issue_comments_353976.json:
```json
{
    "body": "<a id='comment:15'></a>\nRelated (I think) tickets: #5225, #16447, #10575.",
    "created_at": "2016-04-13T14:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353976",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:15'></a>
Related (I think) tickets: #5225, #16447, #10575.



---

archive/issue_comments_353977.json:
```json
{
    "body": "<a id='comment:16'></a>\nJust to ping everyone on this, here is another issue with coercion on `LaurentPolynomialRing`\n\n```\nsage: R = LaurentPolynomialRing(QQ,'x',2)\nsage: S = LaurentPolynomialRing(QQ,'x',3)\nsage: f = S.coerce_map_from(R)\nsage: f\nConversion via `_element_constructor_` map:\n  From: Multivariate Laurent Polynomial Ring in x0, x1 over Rational Field\n  To:   Multivariate Laurent Polynomial Ring in x0, x1, x2 over Rational Field\nsage: f(R.gen(0))\nTraceback (most recent call last):\n...\nTypeError: tuple key must have same length as ngens\n```\n\nOf course this work as expected on `PolynomialRing`",
    "created_at": "2016-08-06T15:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353977",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:16'></a>
Just to ping everyone on this, here is another issue with coercion on `LaurentPolynomialRing`

```
sage: R = LaurentPolynomialRing(QQ,'x',2)
sage: S = LaurentPolynomialRing(QQ,'x',3)
sage: f = S.coerce_map_from(R)
sage: f
Conversion via `_element_constructor_` map:
  From: Multivariate Laurent Polynomial Ring in x0, x1 over Rational Field
  To:   Multivariate Laurent Polynomial Ring in x0, x1, x2 over Rational Field
sage: f(R.gen(0))
Traceback (most recent call last):
...
TypeError: tuple key must have same length as ngens
```

Of course this work as expected on `PolynomialRing`



---

archive/issue_comments_353978.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5b7e7f187c43b1fe5206daa1a52d073010d1426c\">5b7e7f1</a></td><td><code>Merge branch 'u/etn40ff/19358' of git://trac.sagemath.org/sage into HEAD</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776\">a1b0b8d</a></td><td><code>Now only making the minimum changes to fix coercions</code></td></tr></table>\n",
    "created_at": "2016-08-06T18:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5b7e7f187c43b1fe5206daa1a52d073010d1426c">5b7e7f1</a></td><td><code>Merge branch 'u/etn40ff/19358' of git://trac.sagemath.org/sage into HEAD</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776">a1b0b8d</a></td><td><code>Now only making the minimum changes to fix coercions</code></td></tr></table>




---

archive/issue_comments_353979.json:
```json
{
    "body": "**Changing commit** from \"[76ac4339b195762106d406516400f8468de844ef](https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef)\" to \"[a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)\".",
    "created_at": "2016-08-06T18:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[76ac4339b195762106d406516400f8468de844ef](https://github.com/sagemath/sagetrac-mirror/commit/76ac4339b195762106d406516400f8468de844ef)" to "[a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)".



---

archive/issue_comments_353980.json:
```json
{
    "body": "<a id='comment:18'></a>\nDear All,\n\nas requested by vdelecroix I posted a question on sage-devel about this issue;\nVolker's reply was this:\n\n```\n   Let me try to summarize the expected behavior: If there is a coercion\n   of the base rings, then there should be a coercion to the (laurent)\n   polynomial ring with additional variables. The variables in the\n   different rings are identified using their name (and not index in\n   gens() or any other rule).\u00c2\n   sage: cm = get_coercion_model()\n   sage: R.<x> = QQ[]\n   sage: S.<x,t> = QQ[]\n   sage: cm.explain(R, S, operator.add)\n   Coercion on left operand via\n       Conversion map:\n         From: Univariate Polynomial Ring in x over Rational Field\n         To:   Multivariate Polynomial Ring in x, t over Rational\n   Field\n   Arithmetic performed after coercions.\n   Result lives in Multivariate Polynomial Ring in x, t over Rational\n   Field\n   Multivariate Polynomial Ring in x, t over Rational Field\n   No coercion if variable names are not strict subsets:\n   sage: T.<x,y> = QQ[]\n   sage: cm.explain(T, S, operator.add)\n   Unknown result parent.\n   But explicit conversion can still work, e.g. by falling back to the\n   index in gens():\n   sage: T(S.gen(0))\n   x\n   sage: T(S.gen(1))\n   y\n\n```\n\nAccordingly I modified this patch so that it only changes the old behaviour when trying to map a laurent polynomial `x` into a ring containing all the variables of `x.parent()`\n\nAfter the patch the behaviour is \n\n```\nsage: R = LaurentPolynomialRing(QQ,'x2,x0')\nsage: S = LaurentPolynomialRing(QQ,'x',3)\nsage: f = S.coerce_map_from(R)\nsage: f(R.gen(0) + R.gen(1)^2)\nx0^2 + x2\nsage: T = LaurentPolynomialRing(QQ,'x2,x0,t')\nsage: S.has_coerce_map_from(T)\nFalse\nsage: S(T.gen(0))\nx0\n```\n\nCould you please test this?",
    "created_at": "2016-08-06T18:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353980",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:18'></a>
Dear All,

as requested by vdelecroix I posted a question on sage-devel about this issue;
Volker's reply was this:

```
   Let me try to summarize the expected behavior: If there is a coercion
   of the base rings, then there should be a coercion to the (laurent)
   polynomial ring with additional variables. The variables in the
   different rings are identified using their name (and not index in
   gens() or any other rule).Ã‚
   sage: cm = get_coercion_model()
   sage: R.<x> = QQ[]
   sage: S.<x,t> = QQ[]
   sage: cm.explain(R, S, operator.add)
   Coercion on left operand via
       Conversion map:
         From: Univariate Polynomial Ring in x over Rational Field
         To:   Multivariate Polynomial Ring in x, t over Rational
   Field
   Arithmetic performed after coercions.
   Result lives in Multivariate Polynomial Ring in x, t over Rational
   Field
   Multivariate Polynomial Ring in x, t over Rational Field
   No coercion if variable names are not strict subsets:
   sage: T.<x,y> = QQ[]
   sage: cm.explain(T, S, operator.add)
   Unknown result parent.
   But explicit conversion can still work, e.g. by falling back to the
   index in gens():
   sage: T(S.gen(0))
   x
   sage: T(S.gen(1))
   y

```

Accordingly I modified this patch so that it only changes the old behaviour when trying to map a laurent polynomial `x` into a ring containing all the variables of `x.parent()`

After the patch the behaviour is 

```
sage: R = LaurentPolynomialRing(QQ,'x2,x0')
sage: S = LaurentPolynomialRing(QQ,'x',3)
sage: f = S.coerce_map_from(R)
sage: f(R.gen(0) + R.gen(1)^2)
x0^2 + x2
sage: T = LaurentPolynomialRing(QQ,'x2,x0,t')
sage: S.has_coerce_map_from(T)
False
sage: S(T.gen(0))
x0
```

Could you please test this?



---

archive/issue_comments_353981.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2016-08-15T02:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353981",
    "user": "https://trac.sagemath.org/admin/accounts/users/drupel"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_353982.json:
```json
{
    "body": "**Reviewer:** drupel",
    "created_at": "2016-08-15T02:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353982",
    "user": "https://trac.sagemath.org/admin/accounts/users/drupel"
}
```

**Reviewer:** drupel



---

archive/issue_comments_353983.json:
```json
{
    "body": "<a id='comment:19'></a>\nThe behavior of `LaurentPolynomialRing` coercions and conversions now conforms with the Sage standard as specified by Volker.  I am changing to positive review.",
    "created_at": "2016-08-15T02:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353983",
    "user": "https://trac.sagemath.org/admin/accounts/users/drupel"
}
```

<a id='comment:19'></a>
The behavior of `LaurentPolynomialRing` coercions and conversions now conforms with the Sage standard as specified by Volker.  I am changing to positive review.



---

archive/issue_comments_353984.json:
```json
{
    "body": "<a id='comment:20'></a>\nThe reviewer name should be your real name",
    "created_at": "2016-08-15T19:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353984",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
The reviewer name should be your real name



---

archive/issue_comments_353985.json:
```json
{
    "body": "**Changing status** from positive_review to needs_info.",
    "created_at": "2016-08-15T19:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353985",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_info.



---

archive/issue_comments_353986.json:
```json
{
    "body": "**Changing reviewer** from \"drupel\" to \"Dylan Rupel\".",
    "created_at": "2016-08-15T19:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353986",
    "user": "https://trac.sagemath.org/admin/accounts/users/drupel"
}
```

**Changing reviewer** from "drupel" to "Dylan Rupel".



---

archive/issue_comments_353987.json:
```json
{
    "body": "**Changing status** from needs_info to positive_review.",
    "created_at": "2016-08-15T19:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353987",
    "user": "https://trac.sagemath.org/admin/accounts/users/drupel"
}
```

**Changing status** from needs_info to positive_review.



---

archive/issue_events_061165.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-19T22:45:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19538#event-61165"
}
```



---

archive/issue_comments_353988.json:
```json
{
    "body": "**Changing branch** from \"[u/etn40ff/19358](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/19358)\" to \"[a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)\".",
    "created_at": "2016-08-19T22:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353988",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/etn40ff/19358](https://github.com/sagemath/sagetrac-mirror/tree/u/etn40ff/19358)" to "[a1b0b8d5369562bd122032af825bcdbd82ccb776](https://github.com/sagemath/sagetrac-mirror/commit/a1b0b8d5369562bd122032af825bcdbd82ccb776)".



---

archive/issue_comments_353989.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2016-08-19T22:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19538",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19538#issuecomment-353989",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed
