# Issue 19473: FiniteDimensionalAlgebra.is_unitary is not sufficient

archive/issues_019236.json:
```json
{
    "body": "Here is the semigroup algebra (over `QQ`) of the semigroup with two elements whose product is given by `x*y == y`:\n\n```\nsage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0],[1,0]]), Matrix([[0,1],[0,1]])])\nsage: for x in A.basis():\n    for y in A.basis():\n        print x*y == y\n....:         \nTrue\nTrue\nTrue\nTrue\n```\n\nSage claims that it is unitary:\n\n```\nsage: A.is_unitary()\nTrue\n```\nbased on the following wrong concept:\n\n```\n        .. NOTE::\n\n            If a finite-dimensional algebra over a field admits a left identity,\n            then this is the unique left identity, and it is also a\n            right identity.\n```\n\nOn a slightly related note, the `table` method on `FiniteDimensionalAlgebra` returns mutable matrices, and mutating them corrupts the algebra.\n\nCC:  sage-combinat @tscrim @nthiery\n\nKeywords: finite-dimensional algebra, linear algebra\n\nBranch/Commit: 366feaedc2e28d1fc8d03380970883f644abd5de\n\nReviewer: Darij Grinberg, Travis Scrimshaw\n\nAuthor: Peter Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19473\n\n",
    "closed_at": "2015-11-01T19:31:54Z",
    "created_at": "2015-10-24T20:01:08Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "FiniteDimensionalAlgebra.is_unitary is not sufficient",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19473",
    "user": "https://github.com/darijgr"
}
```
Here is the semigroup algebra (over `QQ`) of the semigroup with two elements whose product is given by `x*y == y`:

```
sage: A = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0],[1,0]]), Matrix([[0,1],[0,1]])])
sage: for x in A.basis():
    for y in A.basis():
        print x*y == y
....:         
True
True
True
True
```

Sage claims that it is unitary:

```
sage: A.is_unitary()
True
```
based on the following wrong concept:

```
        .. NOTE::

            If a finite-dimensional algebra over a field admits a left identity,
            then this is the unique left identity, and it is also a
            right identity.
```

On a slightly related note, the `table` method on `FiniteDimensionalAlgebra` returns mutable matrices, and mutating them corrupts the algebra.

CC:  sage-combinat @tscrim @nthiery

Keywords: finite-dimensional algebra, linear algebra

Branch/Commit: 366feaedc2e28d1fc8d03380970883f644abd5de

Reviewer: Darij Grinberg, Travis Scrimshaw

Author: Peter Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19473





---

archive/issue_comments_348910.json:
```json
{
    "body": "Changing commit from \"\" to \"376152ea6bd6616b9b47b184b5e4c508c4850f86\"",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348910",
    "user": "https://github.com/darijgr"
}
```

Changing commit from "" to "376152ea6bd6616b9b47b184b5e4c508c4850f86"



---

archive/issue_comments_348911.json:
```json
{
    "body": "Changing work_issues from \"\" to \"check that it works (my sage is still compiling); test for speed regressions\"",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348911",
    "user": "https://github.com/darijgr"
}
```

Changing work_issues from "" to "check that it works (my sage is still compiling); test for speed regressions"



---

archive/issue_comments_348912.json:
```json
{
    "body": "Changing branch from \"\" to \"public/ticket/19473\"",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348912",
    "user": "https://github.com/darijgr"
}
```

Changing branch from "" to "public/ticket/19473"



---

archive/issue_comments_348913.json:
```json
{
    "body": "Changing author from \"\" to \"Darij Grinberg\"",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348913",
    "user": "https://github.com/darijgr"
}
```

Changing author from "" to "Darij Grinberg"



---

archive/issue_comments_348914.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                         |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|\n|[ef3c7fc](http://git.sagemath.org/sage.git/commit/?id=ef3c7fc75422eee4f8b2226b335e8ffada4c07ba)|`is_unitary method fixed`|\n|[376152e](http://git.sagemath.org/sage.git/commit/?id=376152ea6bd6616b9b47b184b5e4c508c4850f86)|`mutability of table fixed`|",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348914",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                         |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|
|[ef3c7fc](http://git.sagemath.org/sage.git/commit/?id=ef3c7fc75422eee4f8b2226b335e8ffada4c07ba)|`is_unitary method fixed`|
|[376152e](http://git.sagemath.org/sage.git/commit/?id=376152ea6bd6616b9b47b184b5e4c508c4850f86)|`mutability of table fixed`|



---

archive/issue_comments_348915.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-27T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348915",
    "user": "https://github.com/darijgr"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348916.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe wrong claim \"If a finite-dimensional algebra over a field admits a left identity, then this is the unique left identity, and it is also a right identity\" is my fault (introduced in trac_12141_finite_algebras.patch\u200b at #12141).  I have no idea what I was thinking...\n\nAbout the mutability: can't we just make the matrices in the table immutable using the `set_immutable()` method?",
    "created_at": "2015-10-27T17:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348916",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:2'></a>
The wrong claim "If a finite-dimensional algebra over a field admits a left identity, then this is the unique left identity, and it is also a right identity" is my fault (introduced in trac_12141_finite_algebras.patchâ€‹ at #12141).  I have no idea what I was thinking...

About the mutability: can't we just make the matrices in the table immutable using the `set_immutable()` method?



---

archive/issue_comments_348917.json:
```json
{
    "body": "<a id='comment:3'></a>\nMaybe (I don't see a downside to this, but I know little of matrices in Sage...). But we'd have to make the list immutable too.",
    "created_at": "2015-10-27T17:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348917",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:3'></a>
Maybe (I don't see a downside to this, but I know little of matrices in Sage...). But we'd have to make the list immutable too.



---

archive/issue_comments_348918.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [darij](#comment%3A3):\n> Maybe (I don't see a downside to this, but I know little of matrices in Sage...).\n\nAs far as I know there is no downside, but I'm not an expert either.\n> But we'd have to make the list immutable too.\n\nInstead of a list, we could return a tuple (or an immutable sequence).",
    "created_at": "2015-10-27T17:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348918",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:4'></a>
Replying to [darij](#comment%3A3):
> Maybe (I don't see a downside to this, but I know little of matrices in Sage...).

As far as I know there is no downside, but I'm not an expert either.
> But we'd have to make the list immutable too.

Instead of a list, we could return a tuple (or an immutable sequence).



---

archive/issue_comments_348919.json:
```json
{
    "body": "<a id='comment:5'></a>\nI would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.\n\nWe also need to fix the category, which is wrong for non-associative, non-unital cases.",
    "created_at": "2015-10-27T17:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348919",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.

We also need to fix the category, which is wrong for non-associative, non-unital cases.



---

archive/issue_comments_348920.json:
```json
{
    "body": "<a id='comment:6'></a>\nOK, feel free to rollback my 2nd commit, which as I see just now is broken anyway. I'm all for immutability, though I am not sure if we want `UniqueRepresentation` (didn't we agree at some point that it is a pain in the ass?).",
    "created_at": "2015-10-27T17:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348920",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:6'></a>
OK, feel free to rollback my 2nd commit, which as I see just now is broken anyway. I'm all for immutability, though I am not sure if we want `UniqueRepresentation` (didn't we agree at some point that it is a pain in the ass?).



---

archive/issue_comments_348921.json:
```json
{
    "body": "<a id='comment:7'></a>\nSome things with `UniqueRepresentation` are annoying, but overall that isn't so big here IMO. Here's my proposal with `UniqueRepresentation` and also changing the default category to be `MagmaticAlgebras`. I would like to check during construction if the algebra is associative/unital/commutative but this is too expensive. Also refining the category after the fact can lead to subtle bugs, mainly the elements don't know the could have more methods from the refined category. So I'm leaving it to the user to pass the correct category (but I left the `assume_associative`).\n\n---\nNew commits:\n|                                                                                                                                          |                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[6fa53aa](http://git.sagemath.org/sage.git/commit/?id=6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7)|`Adding UniqueRepresentation behavior.`|",
    "created_at": "2015-10-27T20:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348921",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
Some things with `UniqueRepresentation` are annoying, but overall that isn't so big here IMO. Here's my proposal with `UniqueRepresentation` and also changing the default category to be `MagmaticAlgebras`. I would like to check during construction if the algebra is associative/unital/commutative but this is too expensive. Also refining the category after the fact can lead to subtle bugs, mainly the elements don't know the could have more methods from the refined category. So I'm leaving it to the user to pass the correct category (but I left the `assume_associative`).

---
New commits:
|                                                                                                                                          |                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[6fa53aa](http://git.sagemath.org/sage.git/commit/?id=6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7)|`Adding UniqueRepresentation behavior.`|



---

archive/issue_comments_348922.json:
```json
{
    "body": "Changing commit from \"376152ea6bd6616b9b47b184b5e4c508c4850f86\" to \"6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7\"",
    "created_at": "2015-10-27T20:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348922",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "376152ea6bd6616b9b47b184b5e4c508c4850f86" to "6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7"



---

archive/issue_comments_348923.json:
```json
{
    "body": "Changing branch from \"public/ticket/19473\" to \"public/algebra/finite_dim_algebra_fixes-19473\"",
    "created_at": "2015-10-27T20:41:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348923",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "public/ticket/19473" to "public/algebra/finite_dim_algebra_fixes-19473"



---

archive/issue_comments_348924.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2015-10-27T20:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348924",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_348925.json:
```json
{
    "body": "Changing author from \"Darij Grinberg\" to \"Darij Grinberg, Travis Scrimshaw\"",
    "created_at": "2015-10-27T20:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348925",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Darij Grinberg" to "Darij Grinberg, Travis Scrimshaw"



---

archive/issue_comments_348926.json:
```json
{
    "body": "<a id='comment:8'></a>\nBTW, the previous branch had doctest failures noted on the patchbot.",
    "created_at": "2015-10-27T20:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348926",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
BTW, the previous branch had doctest failures noted on the patchbot.



---

archive/issue_comments_348927.json:
```json
{
    "body": "Changing work_issues from \"check that it works (my sage is still compiling); test for speed regressions\" to \"\"",
    "created_at": "2015-10-27T20:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348927",
    "user": "https://github.com/tscrim"
}
```

Changing work_issues from "check that it works (my sage is still compiling); test for speed regressions" to ""



---

archive/issue_comments_348928.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[0cfe036](http://git.sagemath.org/sage.git/commit/?id=0cfe0366fc527d2f692c835be3d40f60aa61c471)|`Adding UniqueRepresentation behavior.`|",
    "created_at": "2015-10-27T21:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348928",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[0cfe036](http://git.sagemath.org/sage.git/commit/?id=0cfe0366fc527d2f692c835be3d40f60aa61c471)|`Adding UniqueRepresentation behavior.`|



---

archive/issue_comments_348929.json:
```json
{
    "body": "Changing commit from \"6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7\" to \"0cfe0366fc527d2f692c835be3d40f60aa61c471\"",
    "created_at": "2015-10-27T21:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348929",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6fa53aad0a3faf6304a8dea0f5cc92f7009f41f7" to "0cfe0366fc527d2f692c835be3d40f60aa61c471"



---

archive/issue_comments_348930.json:
```json
{
    "body": "<a id='comment:10'></a>\nActually my fix for the unitality assumed associativity. I need to fix it again to work in the magmatic case...",
    "created_at": "2015-10-28T00:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348930",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:10'></a>
Actually my fix for the unitality assumed associativity. I need to fix it again to work in the magmatic case...



---

archive/issue_comments_348931.json:
```json
{
    "body": "<a id='comment:11'></a>\nOK, now I am lost. `FiniteDimensionalAlgebra` inherits from `Algebra`, which in turn inherits from `Ring`. The test suite of `Ring` has associativity, which makes me suspect that rings are supposed to be associative. But the design of `FiniteDimensionalAlgebra` makes it clear that associativity is optional, and the docstrings contain examples of non-associative algebras (which still pass their test suites since `some_element` returns just a 1-element list). So should they be associative or not?",
    "created_at": "2015-10-28T00:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348931",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:11'></a>
OK, now I am lost. `FiniteDimensionalAlgebra` inherits from `Algebra`, which in turn inherits from `Ring`. The test suite of `Ring` has associativity, which makes me suspect that rings are supposed to be associative. But the design of `FiniteDimensionalAlgebra` makes it clear that associativity is optional, and the docstrings contain examples of non-associative algebras (which still pass their test suites since `some_element` returns just a 1-element list). So should they be associative or not?



---

archive/issue_comments_348932.json:
```json
{
    "body": "Changing work_issues from \"\" to \"clear up associativity requirement; if necessary, change superclass and is_unitary method\"",
    "created_at": "2015-10-28T00:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348932",
    "user": "https://github.com/darijgr"
}
```

Changing work_issues from "" to "clear up associativity requirement; if necessary, change superclass and is_unitary method"



---

archive/issue_comments_348933.json:
```json
{
    "body": "<a id='comment:12'></a>\nFrom what I see, there are no additional tests in `Ring`. Instead these come from the category of `Rings`, which is not in the supercategories. However I think we are okay because the class doesn't necessarily assume the parent is associative and unital.",
    "created_at": "2015-10-28T03:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348933",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
From what I see, there are no additional tests in `Ring`. Instead these come from the category of `Rings`, which is not in the supercategories. However I think we are okay because the class doesn't necessarily assume the parent is associative and unital.



---

archive/issue_comments_348934.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tscrim](#comment%3A5):\n> I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.\n\nHow does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?\n> We also need to fix the category, which is wrong for non-associative, non-unital cases.\n\nI agree.  It is unfortunate that refining the category after initialisation is possibly problematic.",
    "created_at": "2015-10-28T08:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348934",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
Replying to [tscrim](#comment%3A5):
> I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.

How does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?
> We also need to fix the category, which is wrong for non-associative, non-unital cases.

I agree.  It is unfortunate that refining the category after initialisation is possibly problematic.



---

archive/issue_comments_348935.json:
```json
{
    "body": "<a id='comment:14'></a>\nHere is Johan Bosman's implementation of `is_unitary()` from #12141 before my wrong rewrite (and after some editing and simplification):\n\n```python\n@cached_method\ndef is_unitary(self):\n    \"\"\"\n    Return True if ``self`` is unitary.\n\n    EXAMPLES::\n\n        sage: B = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0],[0,1]]), Matrix([[0,1],[-1,0]])])\n        sage: B.is_unitary()\n        True\n        sage: C = FiniteDimensionalAlgebra(QQ, [Matrix([[0,0],[0,0]]), Matrix([[0,0],[0,0]])])\n        sage: C.is_unitary()\n        False\n    \"\"\"\n    n = self._degree\n    k = self.base_ring()\n    if n == 0:\n        self._one = vector(k, [])\n        return True\n    B1 = reduce(lambda x, y: x.augment(y),\n                self._table, Matrix(k, n, 0))\n    B2 = reduce(lambda x, y: x.augment(y),\n                self.left_table(), Matrix(k, n, 0))\n    # This is the vector obtained by concatenating the rows of the\n    # n times n identity matrix:\n    v = vector(k, (n - 1) * ([1] + n * [0]) + [1])\n    try:\n        sol1 = B1.solve_left(v)\n        sol2 = B2.solve_left(v)\n    except ValueError:\n        return False\n    if sol1 == sol2:\n        self._one = sol1\n        return True\n    else:\n        return False\n```\nIf this is correct, we can just re-use it.",
    "created_at": "2015-10-28T09:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348935",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:14'></a>
Here is Johan Bosman's implementation of `is_unitary()` from #12141 before my wrong rewrite (and after some editing and simplification):

```python
@cached_method
def is_unitary(self):
    """
    Return True if ``self`` is unitary.

    EXAMPLES::

        sage: B = FiniteDimensionalAlgebra(QQ, [Matrix([[1,0],[0,1]]), Matrix([[0,1],[-1,0]])])
        sage: B.is_unitary()
        True
        sage: C = FiniteDimensionalAlgebra(QQ, [Matrix([[0,0],[0,0]]), Matrix([[0,0],[0,0]])])
        sage: C.is_unitary()
        False
    """
    n = self._degree
    k = self.base_ring()
    if n == 0:
        self._one = vector(k, [])
        return True
    B1 = reduce(lambda x, y: x.augment(y),
                self._table, Matrix(k, n, 0))
    B2 = reduce(lambda x, y: x.augment(y),
                self.left_table(), Matrix(k, n, 0))
    # This is the vector obtained by concatenating the rows of the
    # n times n identity matrix:
    v = vector(k, (n - 1) * ([1] + n * [0]) + [1])
    try:
        sol1 = B1.solve_left(v)
        sol2 = B2.solve_left(v)
    except ValueError:
        return False
    if sol1 == sol2:
        self._one = sol1
        return True
    else:
        return False
```
If this is correct, we can just re-use it.



---

archive/issue_comments_348936.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [pbruin](#comment%3A13):\n> Replying to [tscrim](#comment%3A5):\n> > I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.\n\n> How does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?\n\nWe can separate off the table issues into a separate ticket, that is okay with me. Want me to do that?\n\n> > We also need to fix the category, which is wrong for non-associative, non-unital cases.\n\n> I agree.  It is unfortunate that refining the category after initialisation is possibly problematic.\n\nThe other option would be to add boolean parameters that do checks in the initialization (which would require some minor refactoring if we wanted to go the `UniqueRepresentaion` route and would mean we do that on this ticket).",
    "created_at": "2015-10-28T13:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348936",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>
Replying to [pbruin](#comment%3A13):
> Replying to [tscrim](#comment%3A5):
> > I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.

> How does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?

We can separate off the table issues into a separate ticket, that is okay with me. Want me to do that?

> > We also need to fix the category, which is wrong for non-associative, non-unital cases.

> I agree.  It is unfortunate that refining the category after initialisation is possibly problematic.

The other option would be to add boolean parameters that do checks in the initialization (which would require some minor refactoring if we wanted to go the `UniqueRepresentaion` route and would mean we do that on this ticket).



---

archive/issue_comments_348937.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [tscrim](#comment%3A15):\n> Replying to [pbruin](#comment%3A13):\n> > Replying to [tscrim](#comment%3A5):\n> > > I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.\n\n> > How does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?\n> \n> We can separate off the table issues into a separate ticket, that is okay with me. Want me to do that?\n> > > We also need to fix the category, which is wrong for non-associative, non-unital cases.\n\n> > I agree.  It is unfortunate that refining the category after initialisation is possibly problematic.\n> \n> The other option would be to add boolean parameters that do checks in the initialization (which would require some minor refactoring if we wanted to go the `UniqueRepresentaion` route and would mean we do that on this ticket).\n\nIt seems to me that there are four mostly independent issues:\n1. the wrong `is_unitary()` method;\n2. the fact that the multiplication table is mutable;\n3. determining the correct category;\n4. implementing unique representation.\nWe could possibly fix issue 2 on this ticket (assuming it just takes a few lines), but also doing 3 and 4 on this ticket would be way too much in my opinion.  I would prefer just solving issue 1 on this ticket and opening separate tickets (possibly with dependencies) for issues 2, 3 and 4.",
    "created_at": "2015-10-28T13:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348937",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:16'></a>
Replying to [tscrim](#comment%3A15):
> Replying to [pbruin](#comment%3A13):
> > Replying to [tscrim](#comment%3A5):
> > > I would get rid of the `copy` attribute, instead make this a `UniqueRepresentation` (or perhaps a `UniqueFactory` so we can better control the cache key), and make the table a tuple of immutable matrices that gets set by the `__classcall_private__`.

> > How does introducing `UniqueRepresentation` help in solving this ticket?  Wouldn't it be better to do that on a separate ticket?
> 
> We can separate off the table issues into a separate ticket, that is okay with me. Want me to do that?
> > > We also need to fix the category, which is wrong for non-associative, non-unital cases.

> > I agree.  It is unfortunate that refining the category after initialisation is possibly problematic.
> 
> The other option would be to add boolean parameters that do checks in the initialization (which would require some minor refactoring if we wanted to go the `UniqueRepresentaion` route and would mean we do that on this ticket).

It seems to me that there are four mostly independent issues:
1. the wrong `is_unitary()` method;
2. the fact that the multiplication table is mutable;
3. determining the correct category;
4. implementing unique representation.
We could possibly fix issue 2 on this ticket (assuming it just takes a few lines), but also doing 3 and 4 on this ticket would be way too much in my opinion.  I would prefer just solving issue 1 on this ticket and opening separate tickets (possibly with dependencies) for issues 2, 3 and 4.



---

archive/issue_comments_348938.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [pbruin](#comment%3A16):\n> It seems to me that there are four mostly independent issues:\n> 1. the wrong `is_unitary()` method;\n> 2. the fact that the multiplication table is mutable;\n> 3. determining the correct category;\n> 4. implementing unique representation.\n> We could possibly fix issue 2 on this ticket (assuming it just takes a few lines), but also doing 3 and 4 on this ticket would be way too much in my opinion.  I would prefer just solving issue 1 on this ticket and opening separate tickets (possibly with dependencies) for issues 2, 3 and 4.\n\n\nThen let us just fix 1 here and use the changes on the current branch as a followup ticket.",
    "created_at": "2015-10-28T14:43:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348938",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>
Replying to [pbruin](#comment%3A16):
> It seems to me that there are four mostly independent issues:
> 1. the wrong `is_unitary()` method;
> 2. the fact that the multiplication table is mutable;
> 3. determining the correct category;
> 4. implementing unique representation.
> We could possibly fix issue 2 on this ticket (assuming it just takes a few lines), but also doing 3 and 4 on this ticket would be way too much in my opinion.  I would prefer just solving issue 1 on this ticket and opening separate tickets (possibly with dependencies) for issues 2, 3 and 4.


Then let us just fix 1 here and use the changes on the current branch as a followup ticket.



---

archive/issue_comments_348939.json:
```json
{
    "body": "<a id='comment:18'></a>\n+1 for splitting 1&2 | 3&4. This is particularly helpful to me, as I am fairly sure I can review 1&2, but probably not 3&4 these days.\n\nJohan Bosman's approach looks correct (mathematically -- haven't checked the programming). It isn't even necessary to check that the two identities are equal, since their existence already yields their equality.",
    "created_at": "2015-10-28T14:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348939",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:18'></a>
+1 for splitting 1&2 | 3&4. This is particularly helpful to me, as I am fairly sure I can review 1&2, but probably not 3&4 these days.

Johan Bosman's approach looks correct (mathematically -- haven't checked the programming). It isn't even necessary to check that the two identities are equal, since their existence already yields their equality.



---

archive/issue_comments_348940.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [darij](#comment%3A18):\n> Johan Bosman's approach looks correct (mathematically -- haven't checked the programming). It isn't even necessary to check that the two identities are equal, since their existence already yields their equality.\n\nIndeed, I have now also convinced myself of this.  This means that we can replace\n\n```python\n    if sol1 == sol2:\n        self._one = sol1\n        return True\n    else:\n        return False\n```\nby\n\n```python\n    assert sol1 == sol2\n    return True\n```\n(note that at this point the fact that `sol1` and `sol2` have been computed implies that left and right identity elements exist).",
    "created_at": "2015-10-28T15:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348940",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>
Replying to [darij](#comment%3A18):
> Johan Bosman's approach looks correct (mathematically -- haven't checked the programming). It isn't even necessary to check that the two identities are equal, since their existence already yields their equality.

Indeed, I have now also convinced myself of this.  This means that we can replace

```python
    if sol1 == sol2:
        self._one = sol1
        return True
    else:
        return False
```
by

```python
    assert sol1 == sol2
    return True
```
(note that at this point the fact that `sol1` and `sol2` have been computed implies that left and right identity elements exist).



---

archive/issue_comments_348941.json:
```json
{
    "body": "<a id='comment:20'></a>\nOne more thing. The definition\n\n```\nv = vector(k, (n - 1) * ([1] + n * [0]) + [1])\n```\nof `v` is one step back from the currently present definition\n\n```\nv = vector(Matrix.identity(k, n).list())\n```\nbecause it is far better for the entries of `v` to be defined as the zero/one elements of `R` rather than the ints `0` and `1`. There are, after all, rings whose zero/one elements are distinct from `0` and `1`. (So far we probably don't have fields like that, but it could be imaginable. More importantly, coercions like `R(0)` take time, particularly when they are cast on each entry of the vector separately.",
    "created_at": "2015-10-28T17:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348941",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:20'></a>
One more thing. The definition

```
v = vector(k, (n - 1) * ([1] + n * [0]) + [1])
```
of `v` is one step back from the currently present definition

```
v = vector(Matrix.identity(k, n).list())
```
because it is far better for the entries of `v` to be defined as the zero/one elements of `R` rather than the ints `0` and `1`. There are, after all, rings whose zero/one elements are distinct from `0` and `1`. (So far we probably don't have fields like that, but it could be imaginable. More importantly, coercions like `R(0)` take time, particularly when they are cast on each entry of the vector separately.



---

archive/issue_comments_348942.json:
```json
{
    "body": "Changing author from \"Darij Grinberg, Travis Scrimshaw\" to \"Peter Bruin\"",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348942",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Darij Grinberg, Travis Scrimshaw" to "Peter Bruin"



---

archive/issue_comments_348943.json:
```json
{
    "body": "<a id='comment:21'></a>\nOkay, here is 1. The rest will be handled on #19507.\n\n---\nNew commits:\n|                                                                                                                                          |                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[9dd11b2](http://git.sagemath.org/sage.git/commit/?id=9dd11b272861e5e7c50c04d44364452d71359b8d)|`Fixing is_unitary for FiniteDimensionalAlgebra.`|",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348943",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>
Okay, here is 1. The rest will be handled on #19507.

---
New commits:
|                                                                                                                                          |                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[9dd11b2](http://git.sagemath.org/sage.git/commit/?id=9dd11b272861e5e7c50c04d44364452d71359b8d)|`Fixing is_unitary for FiniteDimensionalAlgebra.`|



---

archive/issue_comments_348944.json:
```json
{
    "body": "Changing work_issues from \"clear up associativity requirement; if necessary, change superclass and is_unitary method\" to \"\"",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348944",
    "user": "https://github.com/tscrim"
}
```

Changing work_issues from "clear up associativity requirement; if necessary, change superclass and is_unitary method" to ""



---

archive/issue_comments_348945.json:
```json
{
    "body": "Changing branch from \"public/algebra/finite_dim_algebra_fixes-19473\" to \"public/algebras/unitary_fd_algerba-19473\"",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348945",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "public/algebra/finite_dim_algebra_fixes-19473" to "public/algebras/unitary_fd_algerba-19473"



---

archive/issue_comments_348946.json:
```json
{
    "body": "Changing reviewer from \"Travis Scrimshaw\" to \"Darij Grinberg, Travis Scrimshaw\"",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348946",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "Travis Scrimshaw" to "Darij Grinberg, Travis Scrimshaw"



---

archive/issue_comments_348947.json:
```json
{
    "body": "Changing commit from \"0cfe0366fc527d2f692c835be3d40f60aa61c471\" to \"9dd11b272861e5e7c50c04d44364452d71359b8d\"",
    "created_at": "2015-10-31T15:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348947",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "0cfe0366fc527d2f692c835be3d40f60aa61c471" to "9dd11b272861e5e7c50c04d44364452d71359b8d"



---

archive/issue_comments_348948.json:
```json
{
    "body": "Changing commit from \"9dd11b272861e5e7c50c04d44364452d71359b8d\" to \"366feaedc2e28d1fc8d03380970883f644abd5de\"",
    "created_at": "2015-10-31T23:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348948",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9dd11b272861e5e7c50c04d44364452d71359b8d" to "366feaedc2e28d1fc8d03380970883f644abd5de"



---

archive/issue_comments_348949.json:
```json
{
    "body": "<a id='comment:22'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|\n|[366feae](http://git.sagemath.org/sage.git/commit/?id=366feaedc2e28d1fc8d03380970883f644abd5de)|`non-associative doctests`|",
    "created_at": "2015-10-31T23:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348949",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                          |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------|
|[366feae](http://git.sagemath.org/sage.git/commit/?id=366feaedc2e28d1fc8d03380970883f644abd5de)|`non-associative doctests`|



---

archive/issue_comments_348950.json:
```json
{
    "body": "<a id='comment:23'></a>\nLGTM, but I've added some doctests to make sure this doesn't regress. Positive review, if you agree.",
    "created_at": "2015-10-31T23:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348950",
    "user": "https://github.com/darijgr"
}
```

<a id='comment:23'></a>
LGTM, but I've added some doctests to make sure this doesn't regress. Positive review, if you agree.



---

archive/issue_comments_348951.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-01T01:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348951",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348952.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-01T19:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348952",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_348953.json:
```json
{
    "body": "Changing branch from \"public/algebras/unitary_fd_algerba-19473\" to \"366feaedc2e28d1fc8d03380970883f644abd5de\"",
    "created_at": "2015-11-01T19:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19473#issuecomment-348953",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/algebras/unitary_fd_algerba-19473" to "366feaedc2e28d1fc8d03380970883f644abd5de"



---

archive/issue_events_053734.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-01T19:31:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19473",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19473#event-53734"
}
```
