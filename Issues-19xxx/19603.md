# Issue 19603: Quotient of incompatible lattices

archive/issues_019366.json:
```json
{
    "body": "CC:  @novoselt\n\nThe `quotient` method of toric lattices accepts a sublattice and should check that the argument is in fact a sublattice. According to the documentation,\n\n```\n   INPUT:\n\n   * \"sub\" -- sublattice of self;\n\n   * \"check\" -- (default: True) whether or not to check that \"sub\"\n     is a valid sublattice.\n```\n\nHowever, it is possible to take the quotient of a lattice `N` with a sublattice of `M` that is not compatible:\n\n```\nsage: K = Cone([(1,0,0),(0,1,0)])\nsage: K.lattice()\n3-d lattice N\nsage: K.orthogonal_sublattice()\nSublattice <M(0, 0, 1)>\nsage: K.lattice().quotient(K.orthogonal_sublattice())\n2-d lattice, quotient of 3-d lattice N by Free module of degree 3 and rank 1 over Integer Ring\nEchelon basis matrix:\n[0 0 1]\n```\n\nThis should raise an error instead.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19603\n\n",
    "closed_at": "2015-11-23T06:34:12Z",
    "created_at": "2015-11-19T22:18:28Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Quotient of incompatible lattices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19603",
    "user": "https://github.com/orlitzky"
}
```
CC:  @novoselt

The `quotient` method of toric lattices accepts a sublattice and should check that the argument is in fact a sublattice. According to the documentation,

```
   INPUT:

   * "sub" -- sublattice of self;

   * "check" -- (default: True) whether or not to check that "sub"
     is a valid sublattice.
```

However, it is possible to take the quotient of a lattice `N` with a sublattice of `M` that is not compatible:

```
sage: K = Cone([(1,0,0),(0,1,0)])
sage: K.lattice()
3-d lattice N
sage: K.orthogonal_sublattice()
Sublattice <M(0, 0, 1)>
sage: K.lattice().quotient(K.orthogonal_sublattice())
2-d lattice, quotient of 3-d lattice N by Free module of degree 3 and rank 1 over Integer Ring
Echelon basis matrix:
[0 0 1]
```

This should raise an error instead.

Issue created by migration from https://trac.sagemath.org/ticket/19603





---

archive/issue_comments_265773.json:
```json
{
    "body": "Looking into it, what probably should raise an exception is\n\n```\nsage: K.lattice().submodule(K.orthogonal_sublattice())\nFree module of degree 3 and rank 1 over Integer Ring\nEchelon basis matrix:\n[0 0 1]\n```\nwhile taking quotients of toric lattices by \"generic\" vectors and modules is OK.",
    "created_at": "2015-11-20T00:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265773",
    "user": "https://github.com/novoselt"
}
```

Looking into it, what probably should raise an exception is

```
sage: K.lattice().submodule(K.orthogonal_sublattice())
Free module of degree 3 and rank 1 over Integer Ring
Echelon basis matrix:
[0 0 1]
```
while taking quotients of toric lattices by "generic" vectors and modules is OK.



---

archive/issue_comments_265774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-20T00:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265774",
    "user": "https://github.com/novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_265775.json:
```json
{
    "body": "Found a typo in doctests along the way!\n\n---\nNew commits:",
    "created_at": "2015-11-20T00:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265775",
    "user": "https://github.com/novoselt"
}
```

Found a typo in doctests along the way!

---
New commits:



---

archive/issue_comments_265776.json:
```json
{
    "body": "I added some tests/examples to the `quotient` method but noticed something strange when I went to do the same for the `ToricLattice_quotient` class. The code in the class calls `submodule()` which is where the error is expected to occur:\n\n```\nif check:\n    try:\n        W = V.submodule(W)\n    except (TypeError, ArithmeticError):\n        raise ArithmeticError(\"W must be a sublattice of V\")\n```\n\nBut the `submodule()` method isn't throwing one of those two errors -- it's throwing a `ValueError`. The result is that the user sees the exception thrown from `submodule()` and not the (nicer) error from the quotient class:\n\n```\nsage: from sage.geometry.toric_lattice import ToricLattice_quotient\nsage: N = ToricLattice(3)\nsage: M = ToricLattice(3, name='M')\nsage: ToricLattice_quotient(N,M)\n...\nValueError: M(1, 0, 0) can not generate a sublattice of 3-d lattice N\n```\n\nFor the wishlist, it might help to report something other than the variable names in the `ToricLattice_quotient` error message. So instead of,\n\n```\nArithmeticError: W must be a sublattice of V\n```\n\nit could be,\n\n```\nArithmeticError: 3-d lattice M must be a sublattice of 3-d lattice N\n```\n\nbut I realize that's hard to do if the user passes in weirder objects. We could get part of the way there by checking that `V` is in fact a lattice before doing the `submodule()` check. That way `V` will print nicely, and even if the user passes in something stupid it would read alright:\n\n```\nArithmeticError: Petersen graph: Graph on 10 vertices is not a sublattice of 3-d lattice N\n```\n\n---\nNew commits:",
    "created_at": "2015-11-20T21:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265776",
    "user": "https://github.com/orlitzky"
}
```

I added some tests/examples to the `quotient` method but noticed something strange when I went to do the same for the `ToricLattice_quotient` class. The code in the class calls `submodule()` which is where the error is expected to occur:

```
if check:
    try:
        W = V.submodule(W)
    except (TypeError, ArithmeticError):
        raise ArithmeticError("W must be a sublattice of V")
```

But the `submodule()` method isn't throwing one of those two errors -- it's throwing a `ValueError`. The result is that the user sees the exception thrown from `submodule()` and not the (nicer) error from the quotient class:

```
sage: from sage.geometry.toric_lattice import ToricLattice_quotient
sage: N = ToricLattice(3)
sage: M = ToricLattice(3, name='M')
sage: ToricLattice_quotient(N,M)
...
ValueError: M(1, 0, 0) can not generate a sublattice of 3-d lattice N
```

For the wishlist, it might help to report something other than the variable names in the `ToricLattice_quotient` error message. So instead of,

```
ArithmeticError: W must be a sublattice of V
```

it could be,

```
ArithmeticError: 3-d lattice M must be a sublattice of 3-d lattice N
```

but I realize that's hard to do if the user passes in weirder objects. We could get part of the way there by checking that `V` is in fact a lattice before doing the `submodule()` check. That way `V` will print nicely, and even if the user passes in something stupid it would read alright:

```
ArithmeticError: Petersen graph: Graph on 10 vertices is not a sublattice of 3-d lattice N
```

---
New commits:



---

archive/issue_comments_265777.json:
```json
{
    "body": "In general it is a bit discouraged to include bad arguments into error messages because the code may be catching exceptions do deal with them, but formatting detailed error messages takes time (although we have some lazy strings, if I recall correctly).\n\nThese particular classes are derived from general free modules and then I tried to do the minimum possible changes to get custom output and handle different/dual lattices. It is probably a waste of effort to perfect one particular aspect of them instead of thinking of improving the overall design first ;-) So I am in favour of merging things as they are now (together with your commits) since it is an improvement.",
    "created_at": "2015-11-21T04:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265777",
    "user": "https://github.com/novoselt"
}
```

In general it is a bit discouraged to include bad arguments into error messages because the code may be catching exceptions do deal with them, but formatting detailed error messages takes time (although we have some lazy strings, if I recall correctly).

These particular classes are derived from general free modules and then I tried to do the minimum possible changes to get custom output and handle different/dual lattices. It is probably a waste of effort to perfect one particular aspect of them instead of thinking of improving the overall design first ;-) So I am in favour of merging things as they are now (together with your commits) since it is an improvement.



---

archive/issue_comments_265778.json:
```json
{
    "body": "There was formatting error in my commit caught by the patchbot - hopefully everything is OK now.\n\n---\nNew commits:",
    "created_at": "2015-11-21T04:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265778",
    "user": "https://github.com/novoselt"
}
```

There was formatting error in my commit caught by the patchbot - hopefully everything is OK now.

---
New commits:



---

archive/issue_comments_265779.json:
```json
{
    "body": "That's OK, I didn't have my hopes up for the error message.\n\nMy other concern was basically that this branch looked unreachable,\n\n```\ntry:\n    W = V.submodule(W)\nexcept (TypeError, ArithmeticError):\n    raise ArithmeticError(\"W must be a sublattice of V\")\n```\n\nbecause the error that gets thrown in `submodule()` is a `ValueError`. But I see that I was wrong, and I added the doctest once I figured out how to cause that `ArithmeticError`.\n\nPositive review otherwise.\n\n---\nNew commits:",
    "created_at": "2015-11-21T13:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265779",
    "user": "https://github.com/orlitzky"
}
```

That's OK, I didn't have my hopes up for the error message.

My other concern was basically that this branch looked unreachable,

```
try:
    W = V.submodule(W)
except (TypeError, ArithmeticError):
    raise ArithmeticError("W must be a sublattice of V")
```

because the error that gets thrown in `submodule()` is a `ValueError`. But I see that I was wrong, and I added the doctest once I figured out how to cause that `ArithmeticError`.

Positive review otherwise.

---
New commits:



---

archive/issue_comments_265780.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-22T01:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265780",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_265781.json:
```json
{
    "body": "That branch is probably due to copy-pasting from general span modules. Thanks for the review!",
    "created_at": "2015-11-22T01:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265781",
    "user": "https://github.com/novoselt"
}
```

That branch is probably due to copy-pasting from general span modules. Thanks for the review!



---

archive/issue_events_053910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-23T06:34:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19603#event-53910"
}
```



---

archive/issue_comments_265782.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-23T06:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19603",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19603#issuecomment-265782",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
