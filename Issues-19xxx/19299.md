# Issue 19299: product of elements of a cartesian products is very slow

archive/issues_019062.json:
```json
{
    "body": "As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow\n\n```\nsage: X = cartesian_product([IntegerModRing(2)] * 8)\nsage: A = X.addition_table() # very very long\n```\nOne problem is the default implementation of `cartesian_factors` for element of such product provided by `sage.categories.sets_cat`\n\n```\ndef cartesian_factors(self):\n   # TODO: optimize\n   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())\n```\nAn other one is that `OperationTable` is using a lookup in a tuple with `.index()` rather than using a hash table (e.g. with a `dict`). We fix those two issues and obtain a dramatic speedup:\n\nBefore\n\n```\nsage: X = cartesian_product([IntegerModRing(2)] * 8)\nsage: %time A = X.addition_table()\nCPU times: user 12.4 s, sys: 32 ms, total: 12.5 s\nWall time: 12.4 s\n```\nAfter\n\n```\nsage: X = cartesian_product([IntegerModRing(2)] * 8)\nsage: %time A = X.addition_table()\nCPU times: user 644 ms, sys: 48 ms, total: 692 ms\nWall time: 604 ms\n```\n\nCC:  @nathanncohen\n\nBranch/Commit: 954c0d03b85680cb45534ddb7a920aa4ab451357\n\nReviewer: Nathann Cohen\n\nAuthor: Vincent Delecroix\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19299\n\n",
    "closed_at": "2015-10-12T07:15:49Z",
    "created_at": "2015-09-28T13:17:33Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "product of elements of a cartesian products is very slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19299",
    "user": "https://github.com/videlec"
}
```
As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow

```
sage: X = cartesian_product([IntegerModRing(2)] * 8)
sage: A = X.addition_table() # very very long
```
One problem is the default implementation of `cartesian_factors` for element of such product provided by `sage.categories.sets_cat`

```
def cartesian_factors(self):
   # TODO: optimize
   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())
```
An other one is that `OperationTable` is using a lookup in a tuple with `.index()` rather than using a hash table (e.g. with a `dict`). We fix those two issues and obtain a dramatic speedup:

Before

```
sage: X = cartesian_product([IntegerModRing(2)] * 8)
sage: %time A = X.addition_table()
CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s
Wall time: 12.4 s
```
After

```
sage: X = cartesian_product([IntegerModRing(2)] * 8)
sage: %time A = X.addition_table()
CPU times: user 644 ms, sys: 48 ms, total: 692 ms
Wall time: 604 ms
```

CC:  @nathanncohen

Branch/Commit: 954c0d03b85680cb45534ddb7a920aa4ab451357

Reviewer: Nathann Cohen

Author: Vincent Delecroix

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19299





---

archive/issue_comments_278235.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2015-09-28T13:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278235",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_278236.json:
```json
{
    "body": "<a id='comment:2'></a>I am still annoyed that `%prun` returns that most time is taken by the `index` method of tuple... which has no reason to be used.",
    "created_at": "2015-09-28T13:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278236",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>I am still annoyed that `%prun` returns that most time is taken by the `index` method of tuple... which has no reason to be used.



---

archive/issue_comments_278237.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-28T13:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278238.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-28T13:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278238",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278239.json:
```json
{
    "body": "<a id='comment:4'></a>Nathann,\n\nCould you see if this is enough speedup for your purpose?\n\nVincent",
    "created_at": "2015-09-28T13:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278239",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>Nathann,

Could you see if this is enough speedup for your purpose?

Vincent



---

archive/issue_comments_278240.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -12,6 +12,23 @@\n    return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())\n \\`\\`\\`\n \n+\n+Before\n+\n+\\`\\`\\`\n+sage: %time A = X.addition_table()\n+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s\n+Wall time: 12.4 s\n+\\`\\`\\`\n+After\n+\n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: %time A = X.addition_table()\n+CPU times: user 644 ms, sys: 48 ms, total: 692 ms\n+Wall time: 604 ms\n+\\`\\`\\`\n+\n Author: Vincent Delecroix\n \n Comment: 1\n```\n",
    "created_at": "2015-09-28T13:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278240",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -12,6 +12,23 @@
    return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())
 \`\`\`
 
+
+Before
+
+\`\`\`
+sage: %time A = X.addition_table()
+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s
+Wall time: 12.4 s
+\`\`\`
+After
+
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: %time A = X.addition_table()
+CPU times: user 644 ms, sys: 48 ms, total: 692 ms
+Wall time: 604 ms
+\`\`\`
+
 Author: Vincent Delecroix
 
 Comment: 1
```




---

archive/issue_comments_278241.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow\n \n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: A = X.addition_table() # very very long\n+\\`\\`\\`\n+One problem is the default implementation of \\`cartesian_factors\\` for element of such product provided by \\`sage.categories.sets_cat\\`\n+\n+\\`\\`\\`\n+def cartesian_factors(self):\n+   # TODO: optimize\n+   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())\n+\\`\\`\\`\n+\n+\n+Before\n+\n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: %time A = X.addition_table()\n+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s\n+Wall time: 12.4 s\n+\\`\\`\\`\n+After\n+\n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: %time A = X.addition_table()\n+CPU times: user 644 ms, sys: 48 ms, total: 692 ms\n+Wall time: 604 ms\n+\\`\\`\\`\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-09-28T13:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278241",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow
 
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: A = X.addition_table() # very very long
+\`\`\`
+One problem is the default implementation of \`cartesian_factors\` for element of such product provided by \`sage.categories.sets_cat\`
+
+\`\`\`
+def cartesian_factors(self):
+   # TODO: optimize
+   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())
+\`\`\`
+
+
+Before
+
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: %time A = X.addition_table()
+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s
+Wall time: 12.4 s
+\`\`\`
+After
+
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: %time A = X.addition_table()
+CPU times: user 644 ms, sys: 48 ms, total: 692 ms
+Wall time: 604 ms
+\`\`\`
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_278242.json:
```json
{
    "body": "<a id='comment:7'></a>Hello !\n\nThe speedup is cool indeed, thanks! My constructions are still very slow but while I was trying to figure out why exactly I noticed that `Graph.complement` was rather slow too. I'll finish that and get back to the constructions, to this patch and to my slow code.\n\nNathann",
    "created_at": "2015-09-28T13:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278242",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>Hello !

The speedup is cool indeed, thanks! My constructions are still very slow but while I was trying to figure out why exactly I noticed that `Graph.complement` was rather slow too. I'll finish that and get back to the constructions, to this patch and to my slow code.

Nathann



---

archive/issue_comments_278243.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow\n \n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: A = X.addition_table() # very very long\n+\\`\\`\\`\n+One problem is the default implementation of \\`cartesian_factors\\` for element of such product provided by \\`sage.categories.sets_cat\\`\n+\n+\\`\\`\\`\n+def cartesian_factors(self):\n+   # TODO: optimize\n+   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())\n+\\`\\`\\`\n+An other one is that \\`OperationTable\\` is using a lookup in a tuple with \\`.index()\\` rather than using a hash table (e.g. with a \\`dict\\`). We fix those two issues and obtain a dramatic speedup:\n+\n+Before\n+\n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: %time A = X.addition_table()\n+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s\n+Wall time: 12.4 s\n+\\`\\`\\`\n+After\n+\n+\\`\\`\\`\n+sage: X = cartesian_product([IntegerModRing(2)] * 8)\n+sage: %time A = X.addition_table()\n+CPU times: user 644 ms, sys: 48 ms, total: 692 ms\n+Wall time: 604 ms\n+\\`\\`\\`\n \n Author: Vincent Delecroix\n \n```\n",
    "created_at": "2015-09-28T13:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278243",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/hbF_0XVpq_k) the product of elements of a cartesian product are very slow
 
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: A = X.addition_table() # very very long
+\`\`\`
+One problem is the default implementation of \`cartesian_factors\` for element of such product provided by \`sage.categories.sets_cat\`
+
+\`\`\`
+def cartesian_factors(self):
+   # TODO: optimize
+   return tuple(self.cartesian_projection(i) for i in self.parent()._sets_keys())
+\`\`\`
+An other one is that \`OperationTable\` is using a lookup in a tuple with \`.index()\` rather than using a hash table (e.g. with a \`dict\`). We fix those two issues and obtain a dramatic speedup:
+
+Before
+
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: %time A = X.addition_table()
+CPU times: user 12.4 s, sys: 32 ms, total: 12.5 s
+Wall time: 12.4 s
+\`\`\`
+After
+
+\`\`\`
+sage: X = cartesian_product([IntegerModRing(2)] * 8)
+sage: %time A = X.addition_table()
+CPU times: user 644 ms, sys: 48 ms, total: 692 ms
+Wall time: 604 ms
+\`\`\`
 
 Author: Vincent Delecroix
 
```




---

archive/issue_comments_278244.json:
```json
{
    "body": "<a id='comment:9'></a>Yo !\n\nMy graph generation is still slow, but 10 seconds for a 1024-nodes graph is, well, not as bad as some gap-based construction.\n\nI could save a couple of seconds on the graph side, however, but that would require some rewrite of the dense graph backend. I'll get to that.\n\nIs there any reason why you stored the dictionary as a parameter of `self`? I added a small commit on top of yours at u/ncohen/19299 which avoid lambda functions. It also removes the caching of the dictionary, but if you really think it can be useful, well, that can be reverted.\n\nThanks,\n\nNathann",
    "created_at": "2015-09-28T14:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278244",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:9'></a>Yo !

My graph generation is still slow, but 10 seconds for a 1024-nodes graph is, well, not as bad as some gap-based construction.

I could save a couple of seconds on the graph side, however, but that would require some rewrite of the dense graph backend. I'll get to that.

Is there any reason why you stored the dictionary as a parameter of `self`? I added a small commit on top of yours at u/ncohen/19299 which avoid lambda functions. It also removes the caching of the dictionary, but if you really think it can be useful, well, that can be reverted.

Thanks,

Nathann



---

archive/issue_comments_278245.json:
```json
{
    "body": "<a id='comment:10'></a>I do prefer your version!\n\nAn index attribute might be useful for the method `OperationTable.__getitem__`. But as it is not used intensively for building the table I did not touched it.\n\nVincent\n\n---\nNew commits:",
    "created_at": "2015-09-28T14:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278245",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>I do prefer your version!

An index attribute might be useful for the method `OperationTable.__getitem__`. But as it is not used intensively for building the table I did not touched it.

Vincent

---
New commits:



---

archive/issue_comments_278246.json:
```json
{
    "body": "<a id='comment:11'></a>Okayyy. Well, then if it's good for you, let it go!\n\nNathann",
    "created_at": "2015-09-28T14:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278246",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:11'></a>Okayyy. Well, then if it's good for you, let it go!

Nathann



---

archive/issue_comments_278247.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-28T14:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278247",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_278248.json:
```json
{
    "body": "<a id='comment:13'></a>There's a duplicated line `sage: A((1, 1.23)).cartesian_factors()` in the `EXAMPLE` of `cartesian_factors`, it seems.",
    "created_at": "2015-09-28T15:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278248",
    "user": "https://github.com/johanrosenkilde"
}
```

<a id='comment:13'></a>There's a duplicated line `sage: A((1, 1.23)).cartesian_factors()` in the `EXAMPLE` of `cartesian_factors`, it seems.



---

archive/issue_comments_278249.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-09-28T16:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278249",
    "user": "https://github.com/videlec"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_278250.json:
```json
{
    "body": "<a id='comment:14'></a>Indeed...",
    "created_at": "2015-09-28T16:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278250",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>Indeed...



---

archive/issue_comments_278251.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-28T18:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278251",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_278252.json:
```json
{
    "body": "<a id='comment:15'></a>New commits:",
    "created_at": "2015-09-28T18:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278252",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>New commits:



---

archive/issue_comments_278253.json:
```json
{
    "body": "<a id='comment:16'></a>The patchbot says that everything is cool, so `positive_review` again. Sorry 'bout the previous one.\n\nNathann",
    "created_at": "2015-09-28T19:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278253",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>The patchbot says that everything is cool, so `positive_review` again. Sorry 'bout the previous one.

Nathann



---

archive/issue_comments_278254.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-28T19:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278254",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_053450.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-10-12T07:15:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19299#event-53450"
}
```



---

archive/issue_comments_278255.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-10-12T07:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19299",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19299#issuecomment-278255",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
