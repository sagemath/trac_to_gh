# Issue 19526: Certain methods fail on immutable graphs

archive/issues_019289.json:
```json
{
    "body": "The following methods fail for immutable graphs:\n\n* `GenericGraph.disjoint_routed_paths`\n* `GenericGraph.genus`\n* `GenericGraph.is_circular_planar`\n* `GenericGraph.is_cut_edge`\n* `GenericGraph.is_interval`\n* `GenericGraph.layout_planar`\n* `GenericGraph.multicommodity_flow`\n* `GenericGraph.set_planar_positions`\n* `GenericGraph.steiner_tree`\n* `GenericGraph.to_simple`\n* `GenericGraph.vertex_disjoint_paths`\n* `Graph.gomory_hu_tree`\n* `Graph.is_long_antihole_free`\n* `Graph.is_long_hole_free`\n* `Graph.is_weakly_chordal`\n* `Graph.join`\n* `Graph.seidel_switching`\n* `Graph.topological_minor`\n* `Graph.tutte_polynomial`\n\nI have changed these methods (or ones they depend on) to make a copy of the appropriate (sub)graph if one is needed. To prevent making unneeded copies of (potentially large) graphs, the methods `to_directed`, `to_undirected`, `to_simple`, `subgraph`, `disjoint_union`, `union` and `join` now take an additional parameter `immutable` specifying whether the returned graph should be mutable or not (with the default `None` specifying the old behaviour, i.e. keeping the mutability of the input).\n\nA minor exception is the `subgraph` method, which would always return a mutable graph when the \"add\" algorithm was being used, but this is now made consistent with the \"delete\" algorithm and other methods.\n\nThe reason I need these methods to work on immutable graphs is that I am part of a team building a database of graphs with precomputed attributes (so the graphs being mutable would make no sense) which will be accessible through Sage - of course we still want to do stuff with the graphs that won't change them.\n\nCC:  @nathanncohen\n\nKeywords: graphs, immutable\n\nReviewer: Nathann Cohen\n\nAuthor: Jano\u0161 Vidali\n\nBranch: c5ff5104ee2671ff61fd7de36cc696265e4c4c4c\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19526\n\n",
    "closed_at": "2015-11-08T15:56:03Z",
    "created_at": "2015-11-04T17:07:23Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Certain methods fail on immutable graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19526",
    "user": "https://github.com/jaanos"
}
```
The following methods fail for immutable graphs:

* `GenericGraph.disjoint_routed_paths`
* `GenericGraph.genus`
* `GenericGraph.is_circular_planar`
* `GenericGraph.is_cut_edge`
* `GenericGraph.is_interval`
* `GenericGraph.layout_planar`
* `GenericGraph.multicommodity_flow`
* `GenericGraph.set_planar_positions`
* `GenericGraph.steiner_tree`
* `GenericGraph.to_simple`
* `GenericGraph.vertex_disjoint_paths`
* `Graph.gomory_hu_tree`
* `Graph.is_long_antihole_free`
* `Graph.is_long_hole_free`
* `Graph.is_weakly_chordal`
* `Graph.join`
* `Graph.seidel_switching`
* `Graph.topological_minor`
* `Graph.tutte_polynomial`

I have changed these methods (or ones they depend on) to make a copy of the appropriate (sub)graph if one is needed. To prevent making unneeded copies of (potentially large) graphs, the methods `to_directed`, `to_undirected`, `to_simple`, `subgraph`, `disjoint_union`, `union` and `join` now take an additional parameter `immutable` specifying whether the returned graph should be mutable or not (with the default `None` specifying the old behaviour, i.e. keeping the mutability of the input).

A minor exception is the `subgraph` method, which would always return a mutable graph when the "add" algorithm was being used, but this is now made consistent with the "delete" algorithm and other methods.

The reason I need these methods to work on immutable graphs is that I am part of a team building a database of graphs with precomputed attributes (so the graphs being mutable would make no sense) which will be accessible through Sage - of course we still want to do stuff with the graphs that won't change them.

CC:  @nathanncohen

Keywords: graphs, immutable

Reviewer: Nathann Cohen

Author: Jano≈° Vidali

Branch: c5ff5104ee2671ff61fd7de36cc696265e4c4c4c

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19526





---

archive/issue_comments_264601.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264601",
    "user": "https://github.com/jaanos"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_264602.json:
```json
{
    "body": "Changing keywords from \"\" to \"graphs, immutable\".",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264602",
    "user": "https://github.com/jaanos"
}
```

Changing keywords from "" to "graphs, immutable".



---

archive/issue_comments_264603.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264603",
    "user": "https://github.com/jaanos"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_264604.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-11-04T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264604",
    "user": "https://github.com/jaanos"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_264605.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-05T15:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264605",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_264606.json:
```json
{
    "body": "<a id='comment:3'></a>Helloooooo Janos,\n\nHere is a first-pass review.\n\n- Modification to `DiGraph.to_undirected` -- adding a `immutable` flag as you do\n  it in this function is problematic. What is the intended behavior of\n  `g.to_undirected(sparse=False,immutable=True)` ? `:-/`\n\n  This kind of compatibilities should be handled by the constructor. So, to\n  avoid to do its job again, the best is probably to give it all the arguments\n  you get and hope that it does its job.\n\n- Could you write this `is_immutable` function? Then this\n  {{{\n  +        if getattr(self, '_immutable', False):\n  +            G = copy(self)\n  +        else:\n  +            G = self\n  }}}\n  Could become\n  {{{\n  G = self.copy(immutable=False) if self.is_immutable() else self\n  }}}\n\n- I don't think it is worth testing if we work on a copy here `^^;`\n  {{{\n  -        self.add_edge(u,v,label)\n  +        if not getattr(self, '_immutable', False):\n  +            G.add_edge(u,v,label)\n  }}}\n\n- `Graph.to_directed` -- same remark as for `DiGraph.to_undirected`\n\n- Same function -- the documentation of `immutable` is not indented right. You\n  can build the doc to observe it with\n  `sage -b && sage -docbuild reference/graphs html`\n\nThanks,\n\nNathann",
    "created_at": "2015-11-05T15:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264606",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:3'></a>Helloooooo Janos,

Here is a first-pass review.

- Modification to `DiGraph.to_undirected` -- adding a `immutable` flag as you do
  it in this function is problematic. What is the intended behavior of
  `g.to_undirected(sparse=False,immutable=True)` ? `:-/`

  This kind of compatibilities should be handled by the constructor. So, to
  avoid to do its job again, the best is probably to give it all the arguments
  you get and hope that it does its job.

- Could you write this `is_immutable` function? Then this
  {{{
  +        if getattr(self, '_immutable', False):
  +            G = copy(self)
  +        else:
  +            G = self
  }}}
  Could become
  {{{
  G = self.copy(immutable=False) if self.is_immutable() else self
  }}}

- I don't think it is worth testing if we work on a copy here `^^;`
  {{{
  -        self.add_edge(u,v,label)
  +        if not getattr(self, '_immutable', False):
  +            G.add_edge(u,v,label)
  }}}

- `Graph.to_directed` -- same remark as for `DiGraph.to_undirected`

- Same function -- the documentation of `immutable` is not indented right. You
  can build the doc to observe it with
  `sage -b && sage -docbuild reference/graphs html`

Thanks,

Nathann



---

archive/issue_comments_264607.json:
```json
{
    "body": "<a id='comment:4'></a>Hi!\n\nThanks for the review. I'll implement the suggestions shortly.\n\nI guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.\n\nAs for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.\n\nWhat about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?\n\nJano\u0161",
    "created_at": "2015-11-05T19:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264607",
    "user": "https://github.com/jaanos"
}
```

<a id='comment:4'></a>Hi!

Thanks for the review. I'll implement the suggestions shortly.

I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.

As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.

What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?

Jano≈°



---

archive/issue_comments_264608.json:
```json
{
    "body": "<a id='comment:5'></a>Yooooooooooo,\n\n> I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.\n\n\nYep. And it convinces me even more that we should remove those functions totally. In another ticket, if you don't feel like doing it.\n\n> As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.\n\n\nWhat I meant is that this prameter-checking is/should be done in the constructor anyway. So let us not double this administrative code.\n\n> What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?\n\n\nYepyep, that should be good.\n\nNathann",
    "created_at": "2015-11-05T20:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264608",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>Yooooooooooo,

> I guess the right thing to do here is to remove the `immutable` flag from `to_(un)directed` in both `Graph` and `DiGraph`, and use `Graph(G)` instead of `G.to_undirected(immutable=False)`, and `DiGraph(G)` instead of `G.to_directed(immutable=False)`.


Yep. And it convinces me even more that we should remove those functions totally. In another ticket, if you don't feel like doing it.

> As for `g.to_undirected(sparse=False,immutable=True)`, there should've been a check to yield an error if this is called (instead of just returning a sparse immutable graph), but since I'm removing `immutable`, this is now a non-issue.


What I meant is that this prameter-checking is/should be done in the constructor anyway. So let us not double this administrative code.

> What about `GenericGraph.to_simple`? Since there is no corresponding constructor, it would probably be OK to have `immutable` here?


Yepyep, that should be good.

Nathann



---

archive/issue_comments_264609.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-11-06T13:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264609",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_264610.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-06T13:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264610",
    "user": "https://github.com/jaanos"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_264611.json:
```json
{
    "body": "<a id='comment:7'></a>OK, I fixed the issues. I haven't removed `to_(un)directed`, since these functions are used all over the place and I don't feel I'm in position to remove them :) (plus, I see the benefit of not creating a copy of an immutable graph when one isn't needed).",
    "created_at": "2015-11-06T13:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264611",
    "user": "https://github.com/jaanos"
}
```

<a id='comment:7'></a>OK, I fixed the issues. I haven't removed `to_(un)directed`, since these functions are used all over the place and I don't feel I'm in position to remove them :) (plus, I see the benefit of not creating a copy of an immutable graph when one isn't needed).



---

archive/issue_comments_264612.json:
```json
{
    "body": "<a id='comment:8'></a>Hellooooooooooooooo,\n\nIt all looks good, but I have one question left about this modification:\n\n```diff\n-    G = G.relabel(inplace=False) # making sure the vertices are integers\n+    if G.is_immutable():\n+        G = G.copy(immutable=False)\n+        G.relabel(inplace=True)\n+    else:\n+        G = G.relabel(inplace=False) # making sure the vertices are integers\n```\n\nWhy wouldn't you add the same argument 'immutable' to 'relabel' instead? It seems that you only want something like `G.relabel(inplace=False,immutable=False)`?..\n\nNathann",
    "created_at": "2015-11-06T14:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264612",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>Hellooooooooooooooo,

It all looks good, but I have one question left about this modification:

```diff
-    G = G.relabel(inplace=False) # making sure the vertices are integers
+    if G.is_immutable():
+        G = G.copy(immutable=False)
+        G.relabel(inplace=True)
+    else:
+        G = G.relabel(inplace=False) # making sure the vertices are integers
```

Why wouldn't you add the same argument 'immutable' to 'relabel' instead? It seems that you only want something like `G.relabel(inplace=False,immutable=False)`?..

Nathann



---

archive/issue_comments_264613.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-06T14:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264613",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_264614.json:
```json
{
    "body": "<a id='comment:9'></a>Hi!\n\nNo problem, I can do that.\n\nJano\u0161",
    "created_at": "2015-11-06T15:59:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264614",
    "user": "https://github.com/jaanos"
}
```

<a id='comment:9'></a>Hi!

No problem, I can do that.

Jano≈°



---

archive/issue_comments_264615.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-06T16:11:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264615",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_264616.json:
```json
{
    "body": "<a id='comment:11'></a>OK, here you go.",
    "created_at": "2015-11-06T16:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264616",
    "user": "https://github.com/jaanos"
}
```

<a id='comment:11'></a>OK, here you go.



---

archive/issue_comments_264617.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-06T16:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264617",
    "user": "https://github.com/jaanos"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_264618.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-07T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264618",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_264619.json:
```json
{
    "body": "<a id='comment:12'></a>WOoooooorks for me ! THanks `:-)`\n\nNathann",
    "created_at": "2015-11-07T19:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264619",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>WOoooooorks for me ! THanks `:-)`

Nathann



---

archive/issue_comments_264620.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-08T15:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264620",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_053797.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-08T15:56:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19526#event-53797"
}
```



---

archive/issue_comments_264621.json:
```json
{
    "body": "<a id='comment:14'></a>Thank you guys! I'll be back with a new ticket soon:)",
    "created_at": "2015-11-09T11:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19526",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19526#issuecomment-264621",
    "user": "https://github.com/jaanos"
}
```

<a id='comment:14'></a>Thank you guys! I'll be back with a new ticket soon:)
