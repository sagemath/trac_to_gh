# Issue 19497: Improve comparison framework

archive/issues_019260.json:
```json
{
    "body": "Completely remove `Element._richcmp` and `Element._cmp`.\n\nAdd a new method `richcmp` of the coercion model which replaces the different-parents case of `Element._richcmp`.\n\nThanks to #19016, we can remove the `__richcmp__` in padics to make them intentionally unhashable.\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nBranch: 2497282901353b174fc8d290be0532c3874d4952\n\nCommit: 2497282901353b174fc8d290be0532c3874d4952\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19497\n\n",
    "closed_at": "2015-11-06T19:04:41Z",
    "created_at": "2015-10-29T11:56:48Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Improve comparison framework",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19497",
    "user": "https://github.com/jdemeyer"
}
```
Completely remove `Element._richcmp` and `Element._cmp`.

Add a new method `richcmp` of the coercion model which replaces the different-parents case of `Element._richcmp`.

Thanks to #19016, we can remove the `__richcmp__` in padics to make them intentionally unhashable.

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Branch: 2497282901353b174fc8d290be0532c3874d4952

Commit: 2497282901353b174fc8d290be0532c3874d4952

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19497





---

archive/issue_comments_264001.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-29T16:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264001",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_264002.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2015-10-29T16:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264002",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_264003.json:
```json
{
    "body": "<a id='comment:7'></a>These are not equivalent\n\n```\n-            elif PyInt_CheckExact(right):\n+            elif isinstance(right, int):\n```\nAs far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?\n\nWhy are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`? Moreover, in the latter it is undocumented.",
    "created_at": "2015-11-03T02:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264003",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>These are not equivalent

```
-            elif PyInt_CheckExact(right):
+            elif isinstance(right, int):
```
As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?

Why are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`? Moreover, in the latter it is undocumented.



---

archive/issue_comments_264004.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 vdelecroix]:\n> Why are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`?\n\nIt needs to be in `cdef class CoercionModel` since it's the base type for `cdef class CoercionModel_cache_maps`. But the base class is never used, so it doesn't matter how I implement `richcmp()`. I just did it the way I did because it's analogous to the other methods in that base class. I also could have put `raise NotImplementedError` and it would not have made a difference.",
    "created_at": "2015-11-03T07:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264004",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 vdelecroix]:
> Why are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`?

It needs to be in `cdef class CoercionModel` since it's the base type for `cdef class CoercionModel_cache_maps`. But the base class is never used, so it doesn't matter how I implement `richcmp()`. I just did it the way I did because it's analogous to the other methods in that base class. I also could have put `raise NotImplementedError` and it would not have made a difference.



---

archive/issue_comments_264005.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:\n> These are not equivalent\n> \n> ```\n> -            elif PyInt_CheckExact(right):\n> +            elif isinstance(right, int):\n> ```\n> As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?\n\n\nFirst of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.\n\nIf you want to give positive_review to this ticket modulo this change, I'll happily change it back.",
    "created_at": "2015-11-03T07:36:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264005",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:
> These are not equivalent
> 
> ```
> -            elif PyInt_CheckExact(right):
> +            elif isinstance(right, int):
> ```
> As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?


First of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.

If you want to give positive_review to this ticket modulo this change, I'll happily change it back.



---

archive/issue_comments_264006.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:\n> Replying to [comment:7 vdelecroix]:\n> > These are not equivalent\n> > \n> > ```\n> > -            elif PyInt_CheckExact(right):\n> > +            elif isinstance(right, int):\n> > ```\n> > As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?\n\n> \n> First of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.\n\n\nPerhaps cython is smart enough to be as fast as a direct call to the C API but `PyInt_CheckExact` is faster than `PyInt_Check`... Do we really want to consider a thing inhering from `int` as an `int` in a comparison? Do you have a usecase that would help to decide?\n\nFor `CoercionModel` it is good as it is.",
    "created_at": "2015-11-04T12:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264006",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > These are not equivalent
> > 
> > ```
> > -            elif PyInt_CheckExact(right):
> > +            elif isinstance(right, int):
> > ```
> > As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?

> 
> First of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.


Perhaps cython is smart enough to be as fast as a direct call to the C API but `PyInt_CheckExact` is faster than `PyInt_Check`... Do we really want to consider a thing inhering from `int` as an `int` in a comparison? Do you have a usecase that would help to decide?

For `CoercionModel` it is good as it is.



---

archive/issue_comments_264007.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 vdelecroix]:\n> `PyInt_CheckExact` is faster than `PyInt_Check`...\n\nBoth are equally fast (and very fast).\n\n> Do we really want to consider a thing inhering from `int` as an `int` in a comparison?\n\nI guess so, since it will be converted to an `Integer` anyway by the coercion framework. So, the `instance()` check is really just a fast path for that.\n\n> Do you have a usecase that would help to decide?\n\nI don't have a particular use-case. However, given the comments above, I think that `isinstance()` is the right thing to do.",
    "created_at": "2015-11-04T13:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264007",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:10 vdelecroix]:
> `PyInt_CheckExact` is faster than `PyInt_Check`...

Both are equally fast (and very fast).

> Do we really want to consider a thing inhering from `int` as an `int` in a comparison?

I guess so, since it will be converted to an `Integer` anyway by the coercion framework. So, the `instance()` check is really just a fast path for that.

> Do you have a usecase that would help to decide?

I don't have a particular use-case. However, given the comments above, I think that `isinstance()` is the right thing to do.



---

archive/issue_comments_264008.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-05T23:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264008",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_264009.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-06T19:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19497#issuecomment-264009",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_053764.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-06T19:04:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19497",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19497#event-53764"
}
```
