# Issue 19620: fast (lazy) infinite words

archive/issues_019383.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nIn order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes\n\n- `WordDatatype_iter_char`\n- `WordDatatype_callable_char`\n- `WordDatatype_substitutive_char`\n\nAnd it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.\n\nAs a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.\n\nSome timings with the develop branch\n\n```\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**15]\nCPU times: user 1.26 s, sys: 16 ms, total: 1.27 s\nWall time: 1.23 s\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**16]\nCPU times: user 4.58 s, sys: 24 ms, total: 4.6 s\nWall time: 4.48 s\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**17]\nCPU times: user 21.7 s, sys: 28 ms, total: 21.8 s\nWall time: 21.7 s\n```\nwhile on `u/vdelecroix/19620` we have\n\n```\nsage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**20]\nCPU times: user 16 ms, sys: 0 ns, total: 16 ms\nWall time: 18.3 ms\n```\nMoreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had\n\n```\nsage: W = InfiniteWords([0,1])\nsage: w = W(lambda n: Integer(n).popcount()%2)\nsage: %time w[2**16]\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 169 \u00b5s\nsage: %timeit w[:2**16]\n10 loops, best of 3: 50.3 ms per loop\n```\nwhile on `u/vdelecroix/19620`\n\n```\nsage: W = InfiniteWords([0,1])\nsage: w = W(lambda n: Integer(n).popcount()%2)\nsage: %time w[2**16]\nCPU times: user 60 ms, sys: 12 ms, total: 72 ms\nWall time: 61.2 ms\nsage: %timeit w[:2**16]\n1000000 loops, best of 3: 913 ns per loop\n```\nNote that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.\n\nCC:  @seblabbe @mantepse\n\nComponent: **combinatorics**\n\nAuthor: **Vincent Delecroix**\n\nBranch/Commit: **[u/vdelecroix/19620](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/19620) @ [`1e506ee`](https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01)**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/19620_\n\n",
    "created_at": "2015-11-24T23:15:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "fast (lazy) infinite words",
    "type": "issue",
    "updated_at": "2022-12-29T01:34:47Z",
    "url": "https://github.com/sagemath/sage/issues/19620",
    "user": "https://github.com/videlec"
}
```
<div id="comment:0"></div>

In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes

- `WordDatatype_iter_char`
- `WordDatatype_callable_char`
- `WordDatatype_substitutive_char`

And it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.

As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.

Some timings with the develop branch

```
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**15]
CPU times: user 1.26 s, sys: 16 ms, total: 1.27 s
Wall time: 1.23 s
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**16]
CPU times: user 4.58 s, sys: 24 ms, total: 4.6 s
Wall time: 4.48 s
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**17]
CPU times: user 21.7 s, sys: 28 ms, total: 21.8 s
Wall time: 21.7 s
```
while on `u/vdelecroix/19620` we have

```
sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**20]
CPU times: user 16 ms, sys: 0 ns, total: 16 ms
Wall time: 18.3 ms
```
Moreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had

```
sage: W = InfiniteWords([0,1])
sage: w = W(lambda n: Integer(n).popcount()%2)
sage: %time w[2**16]
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 169 µs
sage: %timeit w[:2**16]
10 loops, best of 3: 50.3 ms per loop
```
while on `u/vdelecroix/19620`

```
sage: W = InfiniteWords([0,1])
sage: w = W(lambda n: Integer(n).popcount()%2)
sage: %time w[2**16]
CPU times: user 60 ms, sys: 12 ms, total: 72 ms
Wall time: 61.2 ms
sage: %timeit w[:2**16]
1000000 loops, best of 3: 913 ns per loop
```
Note that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.

CC:  @seblabbe @mantepse

Component: **combinatorics**

Author: **Vincent Delecroix**

Branch/Commit: **[u/vdelecroix/19620](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/19620) @ [`1e506ee`](https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01)**

_Issue created by migration from https://trac.sagemath.org/ticket/19620_





---

archive/issue_events_275385.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-11-24T23:15:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "milestone_number": null,
    "milestone_title": "sage-6.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275385"
}
```



---

archive/issue_events_275386.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-11-24T23:15:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275386"
}
```



---

archive/issue_events_275387.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-11-24T23:15:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275387"
}
```



---

archive/issue_events_275388.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-12-15T19:58:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275388"
}
```



---

archive/issue_comments_279839.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,42 @@\n-In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`.\n+In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes\n+\n+- `WordDatatype_iter_char`\n+- `WordDatatype_callable_char`\n+- `WordDatatype_substitutive_char`\n+\n+And it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.\n \n As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.\n \n-In order to have fast slices (i.e. with shared memory), we first need a cleanup in `words.py` (see #19619).\n+Some timings with the develop branch\n+\n+```\n+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\n+sage: %time w[2**20]\n+> 2 min (still waiting)\n+sage: %timeit w[:2**15]\n+100 loops, best of 3: 1.99 ms per loop\n+sage: %timeit w[:2**16]\n+1 loops, best of 3: 5.56 ms per loop\n+sage: %timeit w[:2**17]\n+1 loops, best of 3: 7.84 ms per loop\n+sage: %timeit w[:2**18]\n+1 loops, best of 3: 19.6 ms per loop\n+```\n+while with the uplodaded one\n+\n+```\n+sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)\n+sage: %time w[2**20]\n+CPU times: user 16 ms, sys: 0 ns, total: 16 ms\n+Wall time: 18.3 ms\n+1\n+sage: %timeit w[:2**15]\n+1000000 loops, best of 3: 905 ns per loop\n+sage: %timeit w[:2**16]\n+1000000 loops, best of 3: 907 ns per loop\n+sage: %timeit w[:2**17]\n+1000000 loops, best of 3: 910 ns per loop\n+sage: %timeit w[:2**18]\n+1000000 loops, best of 3: 909 ns per loop\n+```\n``````\n",
    "created_at": "2015-12-15T19:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279839",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,42 @@
-In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`.
+In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes
+
+- `WordDatatype_iter_char`
+- `WordDatatype_callable_char`
+- `WordDatatype_substitutive_char`
+
+And it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.
 
 As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.
 
-In order to have fast slices (i.e. with shared memory), we first need a cleanup in `words.py` (see #19619).
+Some timings with the develop branch
+
+```
+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
+sage: %time w[2**20]
+> 2 min (still waiting)
+sage: %timeit w[:2**15]
+100 loops, best of 3: 1.99 ms per loop
+sage: %timeit w[:2**16]
+1 loops, best of 3: 5.56 ms per loop
+sage: %timeit w[:2**17]
+1 loops, best of 3: 7.84 ms per loop
+sage: %timeit w[:2**18]
+1 loops, best of 3: 19.6 ms per loop
+```
+while with the uplodaded one
+
+```
+sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)
+sage: %time w[2**20]
+CPU times: user 16 ms, sys: 0 ns, total: 16 ms
+Wall time: 18.3 ms
+1
+sage: %timeit w[:2**15]
+1000000 loops, best of 3: 905 ns per loop
+sage: %timeit w[:2**16]
+1000000 loops, best of 3: 907 ns per loop
+sage: %timeit w[:2**17]
+1000000 loops, best of 3: 910 ns per loop
+sage: %timeit w[:2**18]
+1000000 loops, best of 3: 909 ns per loop
+```
``````




---

archive/issue_comments_279840.json:
```json
{
    "body": "Branch: **[u/vdelecroix/19620](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/19620)**",
    "created_at": "2015-12-15T19:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279840",
    "user": "https://github.com/videlec"
}
```

Branch: **[u/vdelecroix/19620](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/19620)**



---

archive/issue_comments_279841.json:
```json
{
    "body": "Commit: **[`064ec7b`](https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59)**",
    "created_at": "2015-12-15T19:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279841",
    "user": "https://github.com/videlec"
}
```

Commit: **[`064ec7b`](https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59)**



---

archive/issue_comments_279842.json:
```json
{
    "body": "Changed dependencies from **#19619** to none",
    "created_at": "2015-12-15T19:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279842",
    "user": "https://github.com/videlec"
}
```

Changed dependencies from **#19619** to none



---

archive/issue_events_275389.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-12-15T19:58:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "milestone_number": null,
    "milestone_title": "sage-6.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275389"
}
```



---

archive/issue_events_275390.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-12-15T19:58:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "milestone_number": null,
    "milestone_title": "sage-7.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275390"
}
```



---

archive/issue_comments_279843.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ca3edb813980105900c9eb737f5b42f8bb224785\"><code>ca3edb8</code></a></td><td><code>Trac 19620: one more indirection level</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90eedbe0151edf5deee7f282258edbc849e23b2f\"><code>90eedbe</code></a></td><td><code>Trac 19620: datatypes and classes for infinite words</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59\"><code>064ec7b</code></a></td><td><code>Trac 19620: fix cdef -> cpdef and add an example</code></td></tr></table>\n",
    "created_at": "2015-12-15T19:58:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279843",
    "user": "https://github.com/videlec"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ca3edb813980105900c9eb737f5b42f8bb224785"><code>ca3edb8</code></a></td><td><code>Trac 19620: one more indirection level</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90eedbe0151edf5deee7f282258edbc849e23b2f"><code>90eedbe</code></a></td><td><code>Trac 19620: datatypes and classes for infinite words</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59"><code>064ec7b</code></a></td><td><code>Trac 19620: fix cdef -> cpdef and add an example</code></td></tr></table>




---

archive/issue_events_275391.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-12-15T19:58:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275391"
}
```



---

archive/issue_comments_279844.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,31 +12,46 @@\n \n ```\n sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\n-sage: %time w[2**20]\n-> 2 min (still waiting)\n-sage: %timeit w[:2**15]\n-100 loops, best of 3: 1.99 ms per loop\n-sage: %timeit w[:2**16]\n-1 loops, best of 3: 5.56 ms per loop\n-sage: %timeit w[:2**17]\n-1 loops, best of 3: 7.84 ms per loop\n-sage: %timeit w[:2**18]\n-1 loops, best of 3: 19.6 ms per loop\n+sage: %time w[2**15]\n+CPU times: user 1.26 s, sys: 16 ms, total: 1.27 s\n+Wall time: 1.23 s\n+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\n+sage: %time w[2**16]\n+CPU times: user 4.58 s, sys: 24 ms, total: 4.6 s\n+Wall time: 4.48 s\n+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\n+sage: %time w[2**17]\n+CPU times: user 21.7 s, sys: 28 ms, total: 21.8 s\n+Wall time: 21.7 s\n ```\n-while with the uplodaded one\n+while on `u/vdelecroix/19620` we have\n \n ```\n sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)\n sage: %time w[2**20]\n CPU times: user 16 ms, sys: 0 ns, total: 16 ms\n Wall time: 18.3 ms\n-1\n-sage: %timeit w[:2**15]\n-1000000 loops, best of 3: 905 ns per loop\n+```\n+Moreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had\n+\n+```\n+sage: W = InfiniteWords([0,1])\n+sage: w = W(lambda n: Integer(n).popcount()%2)\n+sage: %time w[2**16]\n+CPU times: user 0 ns, sys: 0 ns, total: 0 ns\n+Wall time: 169 \u00b5s\n sage: %timeit w[:2**16]\n-1000000 loops, best of 3: 907 ns per loop\n-sage: %timeit w[:2**17]\n-1000000 loops, best of 3: 910 ns per loop\n-sage: %timeit w[:2**18]\n-1000000 loops, best of 3: 909 ns per loop\n+10 loops, best of 3: 50.3 ms per loop\n ```\n+while on `u/vdelecroix/19620`\n+\n+```\n+sage: W = InfiniteWords([0,1])\n+sage: w = W(lambda n: Integer(n).popcount()%2)\n+sage: %time w[2**16]\n+CPU times: user 60 ms, sys: 12 ms, total: 72 ms\n+Wall time: 61.2 ms\n+sage: %timeit w[:2**16]\n+1000000 loops, best of 3: 913 ns per loop\n+```\n+Note that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.\n``````\n",
    "created_at": "2015-12-15T21:21:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279844",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,31 +12,46 @@
 
 ```
 sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
-sage: %time w[2**20]
-> 2 min (still waiting)
-sage: %timeit w[:2**15]
-100 loops, best of 3: 1.99 ms per loop
-sage: %timeit w[:2**16]
-1 loops, best of 3: 5.56 ms per loop
-sage: %timeit w[:2**17]
-1 loops, best of 3: 7.84 ms per loop
-sage: %timeit w[:2**18]
-1 loops, best of 3: 19.6 ms per loop
+sage: %time w[2**15]
+CPU times: user 1.26 s, sys: 16 ms, total: 1.27 s
+Wall time: 1.23 s
+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
+sage: %time w[2**16]
+CPU times: user 4.58 s, sys: 24 ms, total: 4.6 s
+Wall time: 4.48 s
+sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
+sage: %time w[2**17]
+CPU times: user 21.7 s, sys: 28 ms, total: 21.8 s
+Wall time: 21.7 s
 ```
-while with the uplodaded one
+while on `u/vdelecroix/19620` we have
 
 ```
 sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)
 sage: %time w[2**20]
 CPU times: user 16 ms, sys: 0 ns, total: 16 ms
 Wall time: 18.3 ms
-1
-sage: %timeit w[:2**15]
-1000000 loops, best of 3: 905 ns per loop
+```
+Moreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had
+
+```
+sage: W = InfiniteWords([0,1])
+sage: w = W(lambda n: Integer(n).popcount()%2)
+sage: %time w[2**16]
+CPU times: user 0 ns, sys: 0 ns, total: 0 ns
+Wall time: 169 µs
 sage: %timeit w[:2**16]
-1000000 loops, best of 3: 907 ns per loop
-sage: %timeit w[:2**17]
-1000000 loops, best of 3: 910 ns per loop
-sage: %timeit w[:2**18]
-1000000 loops, best of 3: 909 ns per loop
+10 loops, best of 3: 50.3 ms per loop
 ```
+while on `u/vdelecroix/19620`
+
+```
+sage: W = InfiniteWords([0,1])
+sage: w = W(lambda n: Integer(n).popcount()%2)
+sage: %time w[2**16]
+CPU times: user 60 ms, sys: 12 ms, total: 72 ms
+Wall time: 61.2 ms
+sage: %timeit w[:2**16]
+1000000 loops, best of 3: 913 ns per loop
+```
+Note that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.
``````




---

archive/issue_comments_279845.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a\"><code>70d566d</code></a></td><td><code>Trac 19620: fix doctest in words.py</code></td></tr></table>\n",
    "created_at": "2015-12-16T12:36:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279845",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a"><code>70d566d</code></a></td><td><code>Trac 19620: fix doctest in words.py</code></td></tr></table>




---

archive/issue_comments_279846.json:
```json
{
    "body": "Changed commit from **[`064ec7b`](https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59)** to **[`70d566d`](https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a)**",
    "created_at": "2015-12-16T12:36:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279846",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`064ec7b`](https://github.com/sagemath/sagetrac-mirror/commit/064ec7b1f46e8b531539eab1d57fe548a80fea59)** to **[`70d566d`](https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a)**



---

archive/issue_comments_279847.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8\"><code>c0122af</code></a></td><td><code>Trac 19620: pickling support + fix slicing</code></td></tr></table>\n",
    "created_at": "2015-12-20T14:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279847",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8"><code>c0122af</code></a></td><td><code>Trac 19620: pickling support + fix slicing</code></td></tr></table>




---

archive/issue_comments_279848.json:
```json
{
    "body": "Changed commit from **[`70d566d`](https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a)** to **[`c0122af`](https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8)**",
    "created_at": "2015-12-20T14:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279848",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`70d566d`](https://github.com/sagemath/sagetrac-mirror/commit/70d566d388b1b5674ae61b76546ab0ed8c2e904a)** to **[`c0122af`](https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8)**



---

archive/issue_comments_279849.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748\"><code>3db4b43</code></a></td><td><code>Trac 19620: hash method</code></td></tr></table>\n",
    "created_at": "2015-12-20T15:16:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279849",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748"><code>3db4b43</code></a></td><td><code>Trac 19620: hash method</code></td></tr></table>




---

archive/issue_comments_279850.json:
```json
{
    "body": "Changed commit from **[`c0122af`](https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8)** to **[`3db4b43`](https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748)**",
    "created_at": "2015-12-20T15:16:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279850",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c0122af`](https://github.com/sagemath/sagetrac-mirror/commit/c0122af315943710d34b7f51f36082e768f03ad8)** to **[`3db4b43`](https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748)**



---

archive/issue_comments_279851.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe patchbot says\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 1641, in <module>\n    getattr(get_builder(name), type)()\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 302, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 513, in _wrapper\n    x.get(99999)\n  File \"/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py\", line 567, in get\n    raise self._value\nOSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.\n```",
    "created_at": "2015-12-22T21:43:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279851",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:6" align="right">comment:6</div>

The patchbot says

```
Error building the documentation.
Traceback (most recent call last):
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
OSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.
```



---

archive/issue_comments_279852.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6717944fc38e9e244a88a43cef30bb685eaea034\"><code>6717944</code></a></td><td><code>Trac 19620: merge 6.10</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01\"><code>1e506ee</code></a></td><td><code>Trac 19620: doc</code></td></tr></table>\n",
    "created_at": "2015-12-23T02:01:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279852",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6717944fc38e9e244a88a43cef30bb685eaea034"><code>6717944</code></a></td><td><code>Trac 19620: merge 6.10</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01"><code>1e506ee</code></a></td><td><code>Trac 19620: doc</code></td></tr></table>




---

archive/issue_comments_279853.json:
```json
{
    "body": "Changed commit from **[`3db4b43`](https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748)** to **[`1e506ee`](https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01)**",
    "created_at": "2015-12-23T02:01:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279853",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3db4b43`](https://github.com/sagemath/sagetrac-mirror/commit/3db4b4366fd006bf51ee3e640ab8e3b030a5d748)** to **[`1e506ee`](https://github.com/sagemath/sagetrac-mirror/commit/1e506ee2885dc086f24973db538dc4682ace1e01)**



---

archive/issue_comments_279854.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nSalut S\u00e9bastien,\n\nThanks for having a look. I fixed the issue aout the doc.",
    "created_at": "2015-12-23T02:05:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279854",
    "user": "https://github.com/videlec"
}
```

<div id="comment:8" align="right">comment:8</div>

Salut Sébastien,

Thanks for having a look. I fixed the issue aout the doc.



---

archive/issue_comments_279855.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nWow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: Word(lambda n: h[n])\nword: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...\n\n```\n\nand now apply a `lambda f: p(f)` to each \"letter\".  Is this easy to do?",
    "created_at": "2016-01-05T18:37:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279855",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:10" align="right">comment:10</div>

Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: Word(lambda n: h[n])
word: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...

```

and now apply a `lambda f: p(f)` to each "letter".  Is this easy to do?



---

archive/issue_comments_279856.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWhat is p?",
    "created_at": "2016-01-05T18:49:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279856",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

What is p?



---

archive/issue_comments_279857.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\n`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do\n\n```\nsage: w_new = Word(lambda l: p(w_old[l]))\n```\n\nPossibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.",
    "created_at": "2016-01-05T18:52:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279857",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:12" align="right">comment:12</div>

`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do

```
sage: w_new = Word(lambda l: p(w_old[l]))
```

Possibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.



---

archive/issue_comments_279858.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nYou can do that with lazy list (that are faster and avoids precomputations)\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: from itertools import count\nsage: from sage.misc.lazy_list import lazy_list\nsage: hn = lazy_list(h[n] for n in count())\nsage: phn = lazy_list(p(x) for x in hn)\nsage: hn.info()  # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn.info() # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn[2]\n1/2*p[1, 1] + 1/2*p[2]\nsage: hn.info()  # now we have 3 elts in cache\ncache length 3\nstart        0\nstop         9223372036854775807\nstep         1\n```",
    "created_at": "2016-01-05T18:59:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279858",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>

You can do that with lazy list (that are faster and avoids precomputations)

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: from itertools import count
sage: from sage.misc.lazy_list import lazy_list
sage: hn = lazy_list(h[n] for n in count())
sage: phn = lazy_list(p(x) for x in hn)
sage: hn.info()  # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn.info() # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn[2]
1/2*p[1, 1] + 1/2*p[2]
sage: hn.info()  # now we have 3 elts in cache
cache length 3
start        0
stop         9223372036854775807
step         1
```



---

archive/issue_comments_279859.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nOK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).",
    "created_at": "2016-01-05T19:10:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279859",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:14" align="right">comment:14</div>

OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).



---

archive/issue_comments_279860.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nRight. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\nNote that you can avoid precomputations with word initialization with the option `check=False`\n\n```\nsage: W = Words()\nsage: w = W(lambda n: haha[n], check=False)  # no precomputation\nsage: w[0]\nTraceback (most recent call last):\n...\nNameError: global name 'haha' is not defined\n```\nIdeally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.",
    "created_at": "2016-01-05T19:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279860",
    "user": "https://github.com/videlec"
}
```

<div id="comment:15" align="right">comment:15</div>

Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Note that you can avoid precomputations with word initialization with the option `check=False`

```
sage: W = Words()
sage: w = W(lambda n: haha[n], check=False)  # no precomputation
sage: w[0]
Traceback (most recent call last):
...
NameError: global name 'haha' is not defined
```
Ideally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.



---

archive/issue_comments_279861.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@videlec](#comment%3A15):\n> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\nYes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...",
    "created_at": "2016-01-05T19:58:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279861",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@videlec](#comment%3A15):
> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Yes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...



---

archive/issue_events_275392.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-08-21T04:57:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275392"
}
```



---

archive/issue_events_275393.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-08-21T04:57:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275393"
}
```



---

archive/issue_comments_279862.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nDoes not merge.",
    "created_at": "2016-08-21T04:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19620#issuecomment-279862",
    "user": "https://github.com/rwst"
}
```

<div id="comment:17" align="right">comment:17</div>

Does not merge.



---

archive/issue_events_275394.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:34:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/19620",
    "milestone_number": null,
    "milestone_title": "sage-7.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19620#event-275394"
}
```
