# Issue 19620: fast (lazy) infinite words

archive/issues_019383.json:
```json
{
    "body": "In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes\n\n- `WordDatatype_iter_char`\n- `WordDatatype_callable_char`\n- `WordDatatype_substitutive_char`\n\nAnd it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.\n\nAs a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.\n\nSome timings with the develop branch\n\n```\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**15]\nCPU times: user 1.26 s, sys: 16 ms, total: 1.27 s\nWall time: 1.23 s\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**16]\nCPU times: user 4.58 s, sys: 24 ms, total: 4.6 s\nWall time: 4.48 s\nsage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**17]\nCPU times: user 21.7 s, sys: 28 ms, total: 21.8 s\nWall time: 21.7 s\n```\nwhile on `u/vdelecroix/19620` we have\n\n```\nsage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)\nsage: %time w[2**20]\nCPU times: user 16 ms, sys: 0 ns, total: 16 ms\nWall time: 18.3 ms\n```\nMoreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had\n\n```\nsage: W = InfiniteWords([0,1])\nsage: w = W(lambda n: Integer(n).popcount()%2)\nsage: %time w[2**16]\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 169 \u00b5s\nsage: %timeit w[:2**16]\n10 loops, best of 3: 50.3 ms per loop\n```\nwhile on `u/vdelecroix/19620`\n\n```\nsage: W = InfiniteWords([0,1])\nsage: w = W(lambda n: Integer(n).popcount()%2)\nsage: %time w[2**16]\nCPU times: user 60 ms, sys: 12 ms, total: 72 ms\nWall time: 61.2 ms\nsage: %timeit w[:2**16]\n1000000 loops, best of 3: 913 ns per loop\n```\nNote that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.\n\nCC:  @seblabbe @mantepse\n\nAuthor: Vincent Delecroix\n\nBranch: u/vdelecroix/19620\n\nStatus: needs_work\n\nCommit: 1e506ee2885dc086f24973db538dc4682ace1e01\n\nIssue created by migration from https://trac.sagemath.org/ticket/19620\n\n",
    "created_at": "2015-11-24T23:15:39Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "fast (lazy) infinite words",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19620",
    "user": "https://github.com/videlec"
}
```
In order to have fast infinite words, we implement a new class `WordDatatype_char_infinite` that uses an `unsigned char *` as data. It lazily updates this cache on demand. The previous `WordDatatype_char` is renamed `WordDatatype_char_finite`. With this branch we have several predefined classes

- `WordDatatype_iter_char`
- `WordDatatype_callable_char`
- `WordDatatype_substitutive_char`

And it is very simple to create a new class for a word by inheritance (either in Python or Cython) from `WordDatatype_char_infinite`.

As a prerequisite, we need to add one indirection level for finite words (i.e. use an `unsigned char **` instead of an `unsigned char *`) as the data pointed by an infinite word might be reallocated.

Some timings with the develop branch

```
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**15]
CPU times: user 1.26 s, sys: 16 ms, total: 1.27 s
Wall time: 1.23 s
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**16]
CPU times: user 4.58 s, sys: 24 ms, total: 4.6 s
Wall time: 4.48 s
sage: w = WordMorphism({0: [0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**17]
CPU times: user 21.7 s, sys: 28 ms, total: 21.8 s
Wall time: 21.7 s
```
while on `u/vdelecroix/19620` we have

```
sage: w = WordMorphism({0:[0,1], 1:[0]}).fixed_point(0)
sage: %time w[2**20]
CPU times: user 16 ms, sys: 0 ns, total: 16 ms
Wall time: 18.3 ms
```
Moreover, since the finite slices now shares with the infinite words it is very fast to get the prefixes. On develop we had

```
sage: W = InfiniteWords([0,1])
sage: w = W(lambda n: Integer(n).popcount()%2)
sage: %time w[2**16]
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 169 µs
sage: %timeit w[:2**16]
10 loops, best of 3: 50.3 ms per loop
```
while on `u/vdelecroix/19620`

```
sage: W = InfiniteWords([0,1])
sage: w = W(lambda n: Integer(n).popcount()%2)
sage: %time w[2**16]
CPU times: user 60 ms, sys: 12 ms, total: 72 ms
Wall time: 61.2 ms
sage: %timeit w[:2**16]
1000000 loops, best of 3: 913 ns per loop
```
Note that however the call to `w[2**16]` is slower in the new version. The reason is that this computation actually caches **all** letters up to `w[2**16]`.

CC:  @seblabbe @mantepse

Author: Vincent Delecroix

Branch: u/vdelecroix/19620

Status: needs_work

Commit: 1e506ee2885dc086f24973db538dc4682ace1e01

Issue created by migration from https://trac.sagemath.org/ticket/19620





---

archive/issue_comments_266096.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266096",
    "user": "https://github.com/videlec"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_266097.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266097",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_266098.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-15T19:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266098",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_266099.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-16T12:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266099",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266100.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T14:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266100",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266101.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-20T15:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266102.json:
```json
{
    "body": "<a id='comment:6'></a>The patchbot says\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 1641, in <module>\n    getattr(get_builder(name), type)()\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 302, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/home/hera/sage-patchbot/src/doc/common/builder.py\", line 513, in _wrapper\n    x.get(99999)\n  File \"/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py\", line 567, in get\n    raise self._value\nOSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.\n```",
    "created_at": "2015-12-22T21:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266102",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:6'></a>The patchbot says

```
Error building the documentation.
Traceback (most recent call last):
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 302, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/hera/sage-patchbot/src/doc/common/builder.py", line 513, in _wrapper
    x.get(99999)
  File "/home/hera/sage-patchbot/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
OSError: [combinat ] docstring of sage.combinat.words.word_char.WordDatatype_char_infinite:13: WARNING: Bullet list ends without a blank line; unexpected unindent.
```



---

archive/issue_comments_266103.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-23T02:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266103",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_266104.json:
```json
{
    "body": "<a id='comment:8'></a>Salut S\u00e9bastien,\n\nThanks for having a look. I fixed the issue aout the doc.",
    "created_at": "2015-12-23T02:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266104",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Salut Sébastien,

Thanks for having a look. I fixed the issue aout the doc.



---

archive/issue_comments_266105.json:
```json
{
    "body": "<a id='comment:10'></a>Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: Word(lambda n: h[n])\nword: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...\n\n```\n\nand now apply a `lambda f: p(f)` to each \"letter\".  Is this easy to do?",
    "created_at": "2016-01-05T18:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266105",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:10'></a>Wow! this looks like a much better basis for power series, in particular for species.  A question: I'd like to do

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: Word(lambda n: h[n])
word: h[],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15],h[16],h[17],h[18],h[19],h[20],h[21],h[22],h[23],h[24],h[25],h[26],h[27],h[28],h[29],h[30],h[31],h[32],h[33],h[34],h[35],h[36],h[37],h[38],h[39],...

```

and now apply a `lambda f: p(f)` to each "letter".  Is this easy to do?



---

archive/issue_comments_266106.json:
```json
{
    "body": "<a id='comment:11'></a>What is p?",
    "created_at": "2016-01-05T18:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266106",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>What is p?



---

archive/issue_comments_266107.json:
```json
{
    "body": "<a id='comment:12'></a>`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do\n\n```\nsage: w_new = Word(lambda l: p(w_old[l]))\n```\n\nPossibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.",
    "created_at": "2016-01-05T18:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266107",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:12'></a>`p` are the powersum symmetric functions (injected into the name space by `inject_shorthands`.  However, I just realised that I asked a stupid question.  Evidently, I can simply do

```
sage: w_new = Word(lambda l: p(w_old[l]))
```

Possibly another stupid question: I did `WordOptions(truncate_length=4)`, but it seems that `Word(lambda n: f(n))` still computes many values of `f`.  I'll double check, in any case.



---

archive/issue_comments_266108.json:
```json
{
    "body": "<a id='comment:13'></a>You can do that with lazy list (that are faster and avoids precomputations)\n\n```\nsage: SymmetricFunctions(QQ).inject_shorthands()\nsage: from itertools import count\nsage: from sage.misc.lazy_list import lazy_list\nsage: hn = lazy_list(h[n] for n in count())\nsage: phn = lazy_list(p(x) for x in hn)\nsage: hn.info()  # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn.info() # 0 computation at this stage\ncache length 0\nstart        0\nstop         9223372036854775807\nstep         1\nsage: phn[2]\n1/2*p[1, 1] + 1/2*p[2]\nsage: hn.info()  # now we have 3 elts in cache\ncache length 3\nstart        0\nstop         9223372036854775807\nstep         1\n```",
    "created_at": "2016-01-05T18:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266108",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>You can do that with lazy list (that are faster and avoids precomputations)

```
sage: SymmetricFunctions(QQ).inject_shorthands()
sage: from itertools import count
sage: from sage.misc.lazy_list import lazy_list
sage: hn = lazy_list(h[n] for n in count())
sage: phn = lazy_list(p(x) for x in hn)
sage: hn.info()  # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn.info() # 0 computation at this stage
cache length 0
start        0
stop         9223372036854775807
step         1
sage: phn[2]
1/2*p[1, 1] + 1/2*p[2]
sage: hn.info()  # now we have 3 elts in cache
cache length 3
start        0
stop         9223372036854775807
step         1
```



---

archive/issue_comments_266109.json:
```json
{
    "body": "<a id='comment:14'></a>OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).",
    "created_at": "2016-01-05T19:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266109",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:14'></a>OK, well, I came here from #16137... I am confused by so many different possibilities to create something lazy.  I thought the goal was to have a single entry point (possibly with various backends).



---

archive/issue_comments_266110.json:
```json
{
    "body": "<a id='comment:15'></a>Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\nNote that you can avoid precomputations with word initialization with the option `check=False`\n\n```\nsage: W = Words()\nsage: w = W(lambda n: haha[n], check=False)  # no precomputation\nsage: w[0]\nTraceback (most recent call last):\n...\nNameError: global name 'haha' is not defined\n```\nIdeally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.",
    "created_at": "2016-01-05T19:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266110",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.

Note that you can avoid precomputations with word initialization with the option `check=False`

```
sage: W = Words()
sage: w = W(lambda n: haha[n], check=False)  # no precomputation
sage: w[0]
Traceback (most recent call last):
...
NameError: global name 'haha' is not defined
```
Ideally you should start with `W = W = Words(SymmetricFunctions(QQ))` but that ends up with `AttributeError: 'SymmetricFunctions_with_category' object has no attribute 'cardinality'`.



---

archive/issue_comments_266111.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 vdelecroix]:\n> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.\n\n\nYes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...",
    "created_at": "2016-01-05T19:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266111",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:16'></a>Replying to [comment:15 vdelecroix]:
> Right. For me a word already has some combinatorial flavour. It is already a mathematical object. The `lazy_list` would be one possible backend. An other one (which is the object of this ticket) is using a reallocable `char *`.


Yes, this makes sense to me - I just thought that #16137 is dead.  And, at least for the moment, I'm not concerned about speed but only about the interface.  There are several sage objects that seem to have similar objective but different user interface: eg. `Family`, `Sequence`.  There is also #16107...



---

archive/issue_comments_266112.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-21T04:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266112",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_266113.json:
```json
{
    "body": "<a id='comment:17'></a>Does not merge.",
    "created_at": "2016-08-21T04:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19620",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19620#issuecomment-266113",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>Does not merge.
