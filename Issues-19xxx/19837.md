# Issue 19837: QQbar cleaning 2

archive/issues_019837.json:
```json
{
    "body": "We further simplify QQbar code by:\n- using python operator to indentify binary operators instead of strings. In other words we replace `'+'` by `operator.add`, `'-'` by `operator.sub`, etc\n- writing only one function `binop` instead of `addsub` and `muldiv`.\n- removing the methods `kind`,  `is_exact`, `is_rational`, `is_field_element` of descriptors and instead use the class themselves\n- removing the method `rational_value` and directly access the `_value` attribute\n- detect unions earlier in the code to avoid constructing `ANBinaryExpr`\n\nAs a consequence of the last items, we have exactification detected earlier\n\n```\nsage: sqrt17 = QQbar(17).sqrt()\nsage: sqrt19 = QQbar(19).sqrt()\nsage: (sqrt17 + sqrt19).exactify()\nsage: sqrt17 * sqrt19 + sqrt17 - sqrt19 * sqrt17 - sqrt17\n0\n```\nInstead of `0.?e-17` on the current beta. See also the better output in doctests from the commit `7fa8ed4`.\n\nfollow up: #19955\n\nIssue created by migration from https://trac.sagemath.org/ticket/20074\n\n",
    "closed_at": "2016-03-20T23:41:36Z",
    "created_at": "2016-02-17T02:55:18Z",
    "labels": [
        "component: number fields"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "QQbar cleaning 2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19837",
    "user": "https://github.com/videlec"
}
```
We further simplify QQbar code by:
- using python operator to indentify binary operators instead of strings. In other words we replace `'+'` by `operator.add`, `'-'` by `operator.sub`, etc
- writing only one function `binop` instead of `addsub` and `muldiv`.
- removing the methods `kind`,  `is_exact`, `is_rational`, `is_field_element` of descriptors and instead use the class themselves
- removing the method `rational_value` and directly access the `_value` attribute
- detect unions earlier in the code to avoid constructing `ANBinaryExpr`

As a consequence of the last items, we have exactification detected earlier

```
sage: sqrt17 = QQbar(17).sqrt()
sage: sqrt19 = QQbar(19).sqrt()
sage: (sqrt17 + sqrt19).exactify()
sage: sqrt17 * sqrt19 + sqrt17 - sqrt19 * sqrt17 - sqrt17
0
```
Instead of `0.?e-17` on the current beta. See also the better output in doctests from the commit `7fa8ed4`.

follow up: #19955

Issue created by migration from https://trac.sagemath.org/ticket/20074





---

archive/issue_comments_272275.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2016-02-17T02:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272275",
    "user": "https://github.com/videlec"
}
```

Last 10 new commits:



---

archive/issue_comments_272276.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-02-17T02:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272276",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_272277.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-17T12:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272278.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-02-17T13:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272278",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272279.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-02-26T20:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272279",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_272280.json:
```json
{
    "body": "does not apply",
    "created_at": "2016-02-26T20:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272280",
    "user": "https://github.com/fchapoton"
}
```

does not apply



---

archive/issue_comments_272281.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-07T17:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272281",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_272282.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-03-07T17:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_272283.json:
```json
{
    "body": "For this change:\n\n```diff\n@@ -7461,14 +7076,16 @@ class ANBinaryExpr(ANDescr):\n \n             op = self._op\n \n-            if op == '+':\n+            if op is operator.add:\n                 value = left_value + right_value\n-            if op == '-':\n+            elif op is operator.sub:\n                 value = left_value - right_value\n-            if op == '*':\n+            elif op is operator.mul:\n                 value = left_value * right_value\n-            if op == '/':\n+            elif op is operator.div:\n                 value = left_value / right_value\n+            else:\n+                raise RuntimeError(\"op is {}\".format(op))\n \n             if gen.is_trivial():\n                 return ANRational(value)\n```\nIs there a reason why you did not just do `value = op(left_value, right_value)`?\n\nHave you done any speed comparisons?",
    "created_at": "2016-03-07T22:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272283",
    "user": "https://github.com/tscrim"
}
```

For this change:

```diff
@@ -7461,14 +7076,16 @@ class ANBinaryExpr(ANDescr):
 
             op = self._op
 
-            if op == '+':
+            if op is operator.add:
                 value = left_value + right_value
-            if op == '-':
+            elif op is operator.sub:
                 value = left_value - right_value
-            if op == '*':
+            elif op is operator.mul:
                 value = left_value * right_value
-            if op == '/':
+            elif op is operator.div:
                 value = left_value / right_value
+            else:
+                raise RuntimeError("op is {}".format(op))
 
             if gen.is_trivial():
                 return ANRational(value)
```
Is there a reason why you did not just do `value = op(left_value, right_value)`?

Have you done any speed comparisons?



---

archive/issue_comments_272284.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> For this change:\n> ...\n> Is there a reason why you did not just do `value = op(left_value, right_value)`?\n\n\nNope.\n\n> Have you done any speed comparisons?\n\n\nI don't think it changes anything. The code is just much simpler.",
    "created_at": "2016-03-08T01:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272284",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:10 tscrim]:
> For this change:
> ...
> Is there a reason why you did not just do `value = op(left_value, right_value)`?


Nope.

> Have you done any speed comparisons?


I don't think it changes anything. The code is just much simpler.



---

archive/issue_comments_272285.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-08T01:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272285",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_272286.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-08T13:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272287.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-08T13:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272287",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_272288.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-08T19:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272288",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_272289.json:
```json
{
    "body": "ok, looks good to me. Patchbots are happy. Let it be.",
    "created_at": "2016-03-08T19:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272289",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good to me. Patchbots are happy. Let it be.



---

archive/issue_comments_272290.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-08T23:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272290",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_272291.json:
```json
{
    "body": "Merge conflict, try the next beta...",
    "created_at": "2016-03-08T23:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272291",
    "user": "https://github.com/vbraun"
}
```

Merge conflict, try the next beta...



---

archive/issue_comments_272292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T13:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272293.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-03-11T14:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272293",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_272294.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-11T14:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272294",
    "user": "https://github.com/videlec"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_272295.json:
```json
{
    "body": "I need to fix a doctest...",
    "created_at": "2016-03-11T14:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272295",
    "user": "https://github.com/videlec"
}
```

I need to fix a doctest...



---

archive/issue_comments_272296.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T14:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272296",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_272297.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-03-11T14:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272297",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_272298.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-20T23:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19837#issuecomment-272298",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054657.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-03-20T23:41:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19837",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19837#event-54657"
}
```
