# Issue 19883: Let PARI handle its own stack

archive/issues_019646.json:
```json
{
    "body": "For historical reasons, the PARI stack is actually handled \"manually\" by Sage. The main reason was to implement auto-resizing of the stack in case a command failed due to a stack overflow. With the introduction of `parisizemax`, PARI can handle this on its own.\n\nA new patch (submitted to `pari-dev`) is added to silence PARI's warnings about the stack size.\n\nCC:  @defeo\n\nBranch/Commit: edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6\n\nUpstream: Reported upstream. No feedback yet.\n\nReviewer: Volker Braun\n\nAuthor: Jeroen Demeyer\n\nDependencies: #19933\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19883\n\n",
    "closed_at": "2016-01-24T21:48:28Z",
    "created_at": "2016-01-13T18:14:23Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Let PARI handle its own stack",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19883",
    "user": "https://github.com/jdemeyer"
}
```
For historical reasons, the PARI stack is actually handled "manually" by Sage. The main reason was to implement auto-resizing of the stack in case a command failed due to a stack overflow. With the introduction of `parisizemax`, PARI can handle this on its own.

A new patch (submitted to `pari-dev`) is added to silence PARI's warnings about the stack size.

CC:  @defeo

Branch/Commit: edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6

Upstream: Reported upstream. No feedback yet.

Reviewer: Volker Braun

Author: Jeroen Demeyer

Dependencies: #19933

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19883





---

archive/issue_comments_358177.json:
```json
{
    "body": "<a id='comment:2'></a>I started working on this some time ago, but never finished it.  In case you are interested, I just pushed my code to `u/pbruin/pari_stack`.",
    "created_at": "2016-01-13T19:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358177",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:2'></a>I started working on this some time ago, but never finished it.  In case you are interested, I just pushed my code to `u/pbruin/pari_stack`.



---

archive/issue_comments_358178.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/let_pari_handle_its_own_stack\"",
    "created_at": "2016-01-14T13:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358178",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/let_pari_handle_its_own_stack"



---

archive/issue_comments_358179.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2016-01-14T13:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358179",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_358180.json:
```json
{
    "body": "Changing commit from \"\" to \"34c272719df882e68b04500bcf78452fd198307f\"",
    "created_at": "2016-01-14T13:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358180",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "34c272719df882e68b04500bcf78452fd198307f"



---

archive/issue_comments_358181.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-14T15:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358181",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_358182.json:
```json
{
    "body": "<a id='comment:6'></a>Two small comments (no time for a complete review):\n- remove mention of the deleted `public_memory_functions.patch` in `build/pkgs/pari/patches/README.txt`\n- I think you can remove the following lines from `PariInstance.__dealloc__()`:\n\n```\n        sage_free(<void*>pari_mainstack.vbot)\n        pari_mainstack.rsize = 0\n        pari_mainstack.vsize = 0\n        pari_mainstack.bot = 0\n        pari_mainstack.vbot = 0\n        pari_mainstack.top = 0\n```",
    "created_at": "2016-01-14T16:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358182",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>Two small comments (no time for a complete review):
- remove mention of the deleted `public_memory_functions.patch` in `build/pkgs/pari/patches/README.txt`
- I think you can remove the following lines from `PariInstance.__dealloc__()`:

```
        sage_free(<void*>pari_mainstack.vbot)
        pari_mainstack.rsize = 0
        pari_mainstack.vsize = 0
        pari_mainstack.bot = 0
        pari_mainstack.vbot = 0
        pari_mainstack.top = 0
```



---

archive/issue_comments_358183.json:
```json
{
    "body": "Changing commit from \"34c272719df882e68b04500bcf78452fd198307f\" to \"47f985ec65a3da0041d27b4824db94118c67ddf1\"",
    "created_at": "2016-01-14T16:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "34c272719df882e68b04500bcf78452fd198307f" to "47f985ec65a3da0041d27b4824db94118c67ddf1"



---

archive/issue_comments_358184.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-14T16:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358185.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-14T16:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358185",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358186.json:
```json
{
    "body": "Changing commit from \"47f985ec65a3da0041d27b4824db94118c67ddf1\" to \"5bc6f271aa21be3f54b12322f7dde9b3d5b04fe9\"",
    "created_at": "2016-01-14T16:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "47f985ec65a3da0041d27b4824db94118c67ddf1" to "5bc6f271aa21be3f54b12322f7dde9b3d5b04fe9"



---

archive/issue_comments_358187.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2016-01-14T16:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358187",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "N/A" to "Reported upstream. No feedback yet."



---

archive/issue_comments_358188.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n For historical reasons, the PARI stack is actually handled \"manually\" by Sage. The main reason was to implement auto-resizing of the stack in case a command failed due to a stack overflow. With the introduction of `parisizemax`, PARI can handle this on its own.\n+\n+A new patch (submitted to `pari-dev`) is added to silence PARI's warnings about the stack size.\n``````\n",
    "created_at": "2016-01-14T16:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358188",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 For historical reasons, the PARI stack is actually handled "manually" by Sage. The main reason was to implement auto-resizing of the stack in case a command failed due to a stack overflow. With the introduction of `parisizemax`, PARI can handle this on its own.
+
+A new patch (submitted to `pari-dev`) is added to silence PARI's warnings about the stack size.
``````




---

archive/issue_comments_358189.json:
```json
{
    "body": "<a id='comment:10'></a>The following looks funny:\n\n```\nsage: pari.allocatemem(2^4, 2^64-1)\n  ***   Warning: not enough memory, new stack 9223372036854775808\n  ***   Warning: not enough memory, new stack 4611686018427387904\n  ***   Warning: not enough memory, new stack 2305843009213693952\n  ***   Warning: not enough memory, new stack 1152921504606846976\n  ***   Warning: not enough memory, new stack 576460752303423488\n  ***   Warning: not enough memory, new stack 288230376151711744\n  ***   Warning: not enough memory, new stack 144115188075855872\n  ***   Warning: not enough memory, new stack 72057594037927936\n  ***   Warning: not enough memory, new stack 36028797018963968\n  ***   Warning: not enough memory, new stack 18014398509481984\n  ***   Warning: not enough memory, new stack 9007199254740992\n  ***   Warning: not enough memory, new stack 4503599627370496\n  ***   Warning: not enough memory, new stack 2251799813685248\n  ***   Warning: not enough memory, new stack 1125899906842624\n  ***   Warning: not enough memory, new stack 562949953421312\n  ***   Warning: not enough memory, new stack 281474976710656\n  ***   Warning: not enough memory, new stack 140737488355328\n  ***   Warning: not enough memory, new stack 70368744177664\nPARI stack size set to 1024 bytes\n```\nYou may want to silence these warnings as well.  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.",
    "created_at": "2016-01-14T17:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358189",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:10'></a>The following looks funny:

```
sage: pari.allocatemem(2^4, 2^64-1)
  ***   Warning: not enough memory, new stack 9223372036854775808
  ***   Warning: not enough memory, new stack 4611686018427387904
  ***   Warning: not enough memory, new stack 2305843009213693952
  ***   Warning: not enough memory, new stack 1152921504606846976
  ***   Warning: not enough memory, new stack 576460752303423488
  ***   Warning: not enough memory, new stack 288230376151711744
  ***   Warning: not enough memory, new stack 144115188075855872
  ***   Warning: not enough memory, new stack 72057594037927936
  ***   Warning: not enough memory, new stack 36028797018963968
  ***   Warning: not enough memory, new stack 18014398509481984
  ***   Warning: not enough memory, new stack 9007199254740992
  ***   Warning: not enough memory, new stack 4503599627370496
  ***   Warning: not enough memory, new stack 2251799813685248
  ***   Warning: not enough memory, new stack 1125899906842624
  ***   Warning: not enough memory, new stack 562949953421312
  ***   Warning: not enough memory, new stack 281474976710656
  ***   Warning: not enough memory, new stack 140737488355328
  ***   Warning: not enough memory, new stack 70368744177664
PARI stack size set to 1024 bytes
```
You may want to silence these warnings as well.  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.



---

archive/issue_comments_358190.json:
```json
{
    "body": "<a id='comment:11'></a>I'm not sure what to think about the strategy to set the maximum PARI stack size to 1/4 of the maximum amount of memory that `malloc()` can allocate.  On a certain system that I use, this causes Sage to show up in `ps` or `top` as using 129 gigabytes of virtual memory (and `pari.stackmax()` returns exactly 128 gigabytes).  Of course this is harmless as long as the memory isn't actually used, but it looks/feels somewhat absurd.",
    "created_at": "2016-01-14T17:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358190",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:11'></a>I'm not sure what to think about the strategy to set the maximum PARI stack size to 1/4 of the maximum amount of memory that `malloc()` can allocate.  On a certain system that I use, this causes Sage to show up in `ps` or `top` as using 129 gigabytes of virtual memory (and `pari.stackmax()` returns exactly 128 gigabytes).  Of course this is harmless as long as the memory isn't actually used, but it looks/feels somewhat absurd.



---

archive/issue_comments_358191.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 pbruin]:\n> You may want to silence these warnings as well.\n\nI'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.\n\n>  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.\n\nSure.\n\n> On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory\n\nI don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.\n\nI also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.",
    "created_at": "2016-01-14T17:48:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358191",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:10 pbruin]:
> You may want to silence these warnings as well.

I'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.

>  I would also suggest `allocatemem()` should print both the actual and the maximum stack sizes with `silent=False`.

Sure.

> On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory

I don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.

I also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.



---

archive/issue_comments_358192.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:\n> Replying to [comment:10 pbruin]:\n> > You may want to silence these warnings as well.\n\n> I'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.\nIt's fine with me either way; it's just that `stackwarn.patch` made me think you intended to make any memory warnings only show up with `DEBUGMEM > 0`.\n> > On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory\n\n> I don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.\nThat is clear; it is more of an aesthetic issue, so to say.\n> I also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.\n\nSure, the amount in my branch was just meant to be some arbitrary default until I found a better solution (which I never got around to).  I thought about making this configurable, with some reasonable default that would be sufficient for most users.",
    "created_at": "2016-01-14T17:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358192",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>Replying to [comment:12 jdemeyer]:
> Replying to [comment:10 pbruin]:
> > You may want to silence these warnings as well.

> I'm not convinced. This is a case where you get less memory than you explicitly asked for. I think we should really display a warning in that case.
It's fine with me either way; it's just that `stackwarn.patch` made me think you intended to make any memory warnings only show up with `DEBUGMEM > 0`.
> > On a certain system that I use, this causes Sage to show up in ps or top as using 129 gigabytes of virtual memory

> I don't think that this is a problem. It's virtual and unused memory, so it shouldn't hurt at all.
That is clear; it is more of an aesthetic issue, so to say.
> I also wouldn't want to hardcode a `parisizemax` (like in your branch, you use 1G). If you have a machine with lots of RAM, you may want to actually use it.

Sure, the amount in my branch was just meant to be some arbitrary default until I found a better solution (which I never got around to).  I thought about making this configurable, with some reasonable default that would be sufficient for most users.



---

archive/issue_comments_358193.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-14T20:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358193",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358194.json:
```json
{
    "body": "Changing commit from \"5bc6f271aa21be3f54b12322f7dde9b3d5b04fe9\" to \"435a4fe79fb3b2d7a652c4d512bc6531c4762ab3\"",
    "created_at": "2016-01-14T20:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358194",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5bc6f271aa21be3f54b12322f7dde9b3d5b04fe9" to "435a4fe79fb3b2d7a652c4d512bc6531c4762ab3"



---

archive/issue_comments_358195.json:
```json
{
    "body": "<a id='comment:15'></a>How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram. \n\nThere is sage.misc.memory_info to detect ram / swap.\n\nGap uses it in sage.interfaces.gap.get_gap_memory_pool_size",
    "created_at": "2016-01-15T22:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358195",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram. 

There is sage.misc.memory_info to detect ram / swap.

Gap uses it in sage.interfaces.gap.get_gap_memory_pool_size



---

archive/issue_comments_358196.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 vbraun]:\n> How is Pari implementing this?\n\n{{{#!c\nstatic void *\npari_mainstack_malloc(size_t size)\n{\n  void *b = mmap(NULL, size, PROT_READ|PROT_WRITE,\n                             MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,-1,0);\n  return (b == MAP_FAILED) ? NULL: b;\n}\n}}}\n\nThe `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.",
    "created_at": "2016-01-16T10:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358196",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Replying to [comment:15 vbraun]:
> How is Pari implementing this?

{{{#!c
static void *
pari_mainstack_malloc(size_t size)
{
  void *b = mmap(NULL, size, PROT_READ|PROT_WRITE,
                             MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,-1,0);
  return (b == MAP_FAILED) ? NULL: b;
}
}}}

The `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.



---

archive/issue_comments_358197.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:\n> The `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.\n\nIs this flag supported on all systems?  The lines just before this function are\n\n```\n#ifndef MAP_NORESERVE\n#define MAP_NORESERVE 0\n#endif\n```",
    "created_at": "2016-01-16T19:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358197",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>Replying to [comment:16 jdemeyer]:
> The `MAP_NORESERVE` is indeed important, together with the fact that PARI tries to use a small stack if possible. The enlarged stack is only used when it's really needed.

Is this flag supported on all systems?  The lines just before this function are

```
#ifndef MAP_NORESERVE
#define MAP_NORESERVE 0
#endif
```



---

archive/issue_comments_358198.json:
```json
{
    "body": "<a id='comment:18'></a>Not every system has mmap or MAP_NORESERVE; If you don't then you clearly aren't interested in efficient use of memory so its ok to ignore.",
    "created_at": "2016-01-16T20:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358198",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Not every system has mmap or MAP_NORESERVE; If you don't then you clearly aren't interested in efficient use of memory so its ok to ignore.



---

archive/issue_comments_358199.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 vbraun]:\n> Not every system has mmap or MAP_NORESERVE\n\n\n`mmap()` is defined by POSIX, so it should be available on every system where Sage is supported.",
    "created_at": "2016-01-17T08:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358199",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Replying to [comment:18 vbraun]:
> Not every system has mmap or MAP_NORESERVE


`mmap()` is defined by POSIX, so it should be available on every system where Sage is supported.



---

archive/issue_comments_358200.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:15 vbraun]:\n> How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram.\n\n\nI don't quite get what you mean with \"reserves swap\". It reserves virtual memory, but I don't think that it allocates actual pages on the swap file. That wouldn't make sense for pages which are completely unused (never been written to nor read from). But even then, you want active processes to use RAM, not swap so I don't really see the problem.\n\nSecond, what you write is only true if your OS does not overcommit memory. At least Linux overcommits by default, such that the total amount of virtual memory you can allocate is greater than RAM + swap.\n\nSo, after thinking about this a bit more, I don't think that `MAP_NORESERVE` is actually so important. It helps by keeping more virtual memory available, but it doesn't change at all how phyisical memory (i.e. RAM) is used.",
    "created_at": "2016-01-17T08:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358200",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>Replying to [comment:15 vbraun]:
> How is Pari implementing this? In GAP its mmap **without** MAP_NORESERVE, so even if its just virtual memory it reserves swap. And if you do it often (parallel doctesting comes to mind) your swap is used up and virtual allocations suddenly are forced into ram.


I don't quite get what you mean with "reserves swap". It reserves virtual memory, but I don't think that it allocates actual pages on the swap file. That wouldn't make sense for pages which are completely unused (never been written to nor read from). But even then, you want active processes to use RAM, not swap so I don't really see the problem.

Second, what you write is only true if your OS does not overcommit memory. At least Linux overcommits by default, such that the total amount of virtual memory you can allocate is greater than RAM + swap.

So, after thinking about this a bit more, I don't think that `MAP_NORESERVE` is actually so important. It helps by keeping more virtual memory available, but it doesn't change at all how phyisical memory (i.e. RAM) is used.



---

archive/issue_comments_358201.json:
```json
{
    "body": "<a id='comment:21'></a>Calling mmap without MAP_NORESERVE does reserve first swap and then ram, this is no joke and bit us with gap. Sure overcommit helps but there is a limit to it; Really its just the final warning before the oomkiller strikes. Overcommitting is NOT a happy place to be.\n\nImho the \"try to allocate all memory\" approach has a small chance of messing things up badly. Sure it works almost all the time but some day you'll succeed, sbrk almost everything into one process, and then everybody else on the system will have a bad day. It smells of rare and undebuggable random failures.",
    "created_at": "2016-01-17T16:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358201",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>Calling mmap without MAP_NORESERVE does reserve first swap and then ram, this is no joke and bit us with gap. Sure overcommit helps but there is a limit to it; Really its just the final warning before the oomkiller strikes. Overcommitting is NOT a happy place to be.

Imho the "try to allocate all memory" approach has a small chance of messing things up badly. Sure it works almost all the time but some day you'll succeed, sbrk almost everything into one process, and then everybody else on the system will have a bad day. It smells of rare and undebuggable random failures.



---

archive/issue_comments_358202.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 vbraun]:\n> Imho the \"try to allocate all memory\" approach has a small chance of messing things up badly.\n\nI doubt it. Are there any OSes which really mess up when allocating a large amount of *unused* memory?",
    "created_at": "2016-01-17T19:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358202",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [comment:21 vbraun]:
> Imho the "try to allocate all memory" approach has a small chance of messing things up badly.

I doubt it. Are there any OSes which really mess up when allocating a large amount of *unused* memory?



---

archive/issue_comments_358203.json:
```json
{
    "body": "<a id='comment:23'></a>Malloc respects overcommit accounting, it essentially does mmap without MAP_NORESERVE (that is one of the implementations in glibc). The OS doesn't mess up, it just does what you ask it to. I.e. overcommit and, quite possibly, kill the next process that wants more memory (or just do something with his previously-malloced memory). And I really don't like my processes being killed because I'm running doctests in the background.",
    "created_at": "2016-01-17T21:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358203",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>Malloc respects overcommit accounting, it essentially does mmap without MAP_NORESERVE (that is one of the implementations in glibc). The OS doesn't mess up, it just does what you ask it to. I.e. overcommit and, quite possibly, kill the next process that wants more memory (or just do something with his previously-malloced memory). And I really don't like my processes being killed because I'm running doctests in the background.



---

archive/issue_comments_358204.json:
```json
{
    "body": "<a id='comment:24'></a>Does the OOMkiller really kick in based on *virtual memory* usage? Then you could end up in a situation where there is plenty of unused RAM but still processes would get killed. It would really surprise me if this is what actually happens.",
    "created_at": "2016-01-17T22:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358204",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Does the OOMkiller really kick in based on *virtual memory* usage? Then you could end up in a situation where there is plenty of unused RAM but still processes would get killed. It would really surprise me if this is what actually happens.



---

archive/issue_comments_358205.json:
```json
{
    "body": "<a id='comment:25'></a>Just run malloc (without free) in a for-loop, I'm pretty sure that it stops before the entire addressing space is used up. \n\nThats also a pretty weird use case, a process allocates memory but doesn't use it. Why should the virtual memory system cater to that and do all the extra accounting? If you don't need memory then don't ask for it. And in the extremely special case where you want to implement your own memory manager in user space there is still mmap(MAP_NORESERVE).",
    "created_at": "2016-01-17T23:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358205",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>Just run malloc (without free) in a for-loop, I'm pretty sure that it stops before the entire addressing space is used up. 

Thats also a pretty weird use case, a process allocates memory but doesn't use it. Why should the virtual memory system cater to that and do all the extra accounting? If you don't need memory then don't ask for it. And in the extremely special case where you want to implement your own memory manager in user space there is still mmap(MAP_NORESERVE).



---

archive/issue_comments_358206.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-18T07:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358206",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_358207.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 vbraun]:\n> Thats also a pretty weird use case, a process allocates memory but doesn't use it.\n\nThen why do you think that overcommitting was invented in the first place? Because processes often ask for more memory than they actually use.\n\nAnyway, let's stop this discussion and think about how to actually choose how much memory to allocate for the PARI stack.",
    "created_at": "2016-01-18T07:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358207",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:25 vbraun]:
> Thats also a pretty weird use case, a process allocates memory but doesn't use it.

Then why do you think that overcommitting was invented in the first place? Because processes often ask for more memory than they actually use.

Anyway, let's stop this discussion and think about how to actually choose how much memory to allocate for the PARI stack.



---

archive/issue_comments_358208.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-18T09:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358208",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358209.json:
```json
{
    "body": "Changing commit from \"435a4fe79fb3b2d7a652c4d512bc6531c4762ab3\" to \"7e4919e9778a91f8ceb65db7a0d7ff894006122f\"",
    "created_at": "2016-01-18T09:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358209",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "435a4fe79fb3b2d7a652c4d512bc6531c4762ab3" to "7e4919e9778a91f8ceb65db7a0d7ff894006122f"



---

archive/issue_comments_358210.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-18T09:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358210",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_358211.json:
```json
{
    "body": "<a id='comment:29'></a>looks good to me",
    "created_at": "2016-01-18T10:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358211",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>looks good to me



---

archive/issue_comments_358212.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2016-01-18T10:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358212",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_358213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-18T10:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358213",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358214.json:
```json
{
    "body": "<a id='comment:30'></a>Pari testsuite fails, e.g. http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/684/steps/compile/logs/pari",
    "created_at": "2016-01-20T00:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358214",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>Pari testsuite fails, e.g. http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/684/steps/compile/logs/pari



---

archive/issue_comments_358215.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-01-20T00:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358215",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_358216.json:
```json
{
    "body": "<a id='comment:31'></a>The problem is that I disabled some warnings by default but the testsuite expects those warnings. Solution: increase `debugmem` for the PARI testsuite.",
    "created_at": "2016-01-20T09:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358216",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>The problem is that I disabled some warnings by default but the testsuite expects those warnings. Solution: increase `debugmem` for the PARI testsuite.



---

archive/issue_comments_358217.json:
```json
{
    "body": "Changing commit from \"7e4919e9778a91f8ceb65db7a0d7ff894006122f\" to \"edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6\"",
    "created_at": "2016-01-20T09:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358217",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7e4919e9778a91f8ceb65db7a0d7ff894006122f" to "edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6"



---

archive/issue_comments_358218.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-20T09:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358218",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_358219.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-20T09:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358219",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_054344.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-01-20T09:35:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "milestone": "sage-7.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19883#event-54344"
}
```



---

archive/issue_comments_358220.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-20T10:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358220",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_358221.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-01-20T15:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358221",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_358222.json:
```json
{
    "body": "<a id='comment:35'></a>Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/686/steps/shell_4/logs/stdio\n\n```\nsage -t --long src/sage/doctest/test.py\n**********************************************************************\nFile \"src/sage/doctest/test.py\", line 26, in sage.doctest.test\nFailed example:\n    subprocess.call([\"sage\", \"-t\", \"--warn-long\", \"0\", \"longtime.rst\"], **kwds)  # long time\nExpected:\n    Running doctests...\n    Doctesting 1 file.\n    sage -t --warn-long 0.0 longtime.rst\n    [0 tests, ...s]\n    ----------------------------------------------------------------------\n    All tests passed!\n    ----------------------------------------------------------------------\n    ...\n    0\nGot:\n      ***   Warning: not enough memory, new stack 1152921504606846976\n      ***   Warning: not enough memory, new stack 576460752303423488\n      ***   Warning: not enough memory, new stack 288230376151711744\n      ***   Warning: not enough memory, new stack 144115188075855872\n      ***   Warning: not enough memory, new stack 72057594037927936\n      ***   Warning: not enough memory, new stack 36028797018963968\n      ***   Warning: not enough memory, new stack 18014398509481984\n      ***   Warning: not enough memory, new stack 9007199254740992\n      ***   Warning: not enough memory, new stack 4503599627370496\n      ***   Warning: not enough memory, new stack 2251799813685248\n      ***   Warning: not enough memory, new stack 1125899906842624\n      ***   Warning: not enough memory, new stack 562949953421312\n      ***   Warning: not enough memory, new stack 281474976710656\n      ***   Warning: not enough memory, new stack 140737488355328\n      ***   Warning: not enough memory, new stack 70368744177664\n    Running doctests with ID 2016-01-20-12-28-05-86bac659.\n    Git branch: develop\n    Using --optional=gcc,mpir,python2,sage\n    Doctesting 1 file.\n    sage -t --warn-long 0.0 longtime.rst\n        [0 tests, 0.00 s]\n    ----------------------------------------------------------------------\n    All tests passed!\n    ----------------------------------------------------------------------\n    Total time for all tests: 0.9 seconds\n        cpu time: 0.0 seconds\n        cumulative wall time: 0.0 seconds\n    0\n**********************************************************************\n```",
    "created_at": "2016-01-20T15:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358222",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:35'></a>Fails on OSX: http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/686/steps/shell_4/logs/stdio

```
sage -t --long src/sage/doctest/test.py
**********************************************************************
File "src/sage/doctest/test.py", line 26, in sage.doctest.test
Failed example:
    subprocess.call(["sage", "-t", "--warn-long", "0", "longtime.rst"], **kwds)  # long time
Expected:
    Running doctests...
    Doctesting 1 file.
    sage -t --warn-long 0.0 longtime.rst
    [0 tests, ...s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    ...
    0
Got:
      ***   Warning: not enough memory, new stack 1152921504606846976
      ***   Warning: not enough memory, new stack 576460752303423488
      ***   Warning: not enough memory, new stack 288230376151711744
      ***   Warning: not enough memory, new stack 144115188075855872
      ***   Warning: not enough memory, new stack 72057594037927936
      ***   Warning: not enough memory, new stack 36028797018963968
      ***   Warning: not enough memory, new stack 18014398509481984
      ***   Warning: not enough memory, new stack 9007199254740992
      ***   Warning: not enough memory, new stack 4503599627370496
      ***   Warning: not enough memory, new stack 2251799813685248
      ***   Warning: not enough memory, new stack 1125899906842624
      ***   Warning: not enough memory, new stack 562949953421312
      ***   Warning: not enough memory, new stack 281474976710656
      ***   Warning: not enough memory, new stack 140737488355328
      ***   Warning: not enough memory, new stack 70368744177664
    Running doctests with ID 2016-01-20-12-28-05-86bac659.
    Git branch: develop
    Using --optional=gcc,mpir,python2,sage
    Doctesting 1 file.
    sage -t --warn-long 0.0 longtime.rst
        [0 tests, 0.00 s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    Total time for all tests: 0.9 seconds
        cpu time: 0.0 seconds
        cumulative wall time: 0.0 seconds
    0
**********************************************************************
```



---

archive/issue_comments_358223.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#19933\"",
    "created_at": "2016-01-21T13:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358223",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#19933"



---

archive/issue_comments_358224.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-01-21T13:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358224",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_358225.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/let_pari_handle_its_own_stack\" to \"edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6\"",
    "created_at": "2016-01-24T21:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358225",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/let_pari_handle_its_own_stack" to "edf23e8643c9cbceafbb4bfd88b1edf6bb4032b6"



---

archive/issue_events_054345.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-24T21:48:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19883#event-54345"
}
```



---

archive/issue_comments_358226.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-24T21:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19883",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19883#issuecomment-358226",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
