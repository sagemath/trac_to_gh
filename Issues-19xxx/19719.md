# Issue 19719: elements of finite field algebraic closure are not hashable

archive/issues_019719.json:
```json
{
    "body": "CC:  @pjbruin jpflori\n\nWe have\n\n```\nsage: K = GF(2).algebraic_closure()\nsage: a = K.an_element()\nsage: hash(a)\nTraceback (most recent call last):\n...\nTypeError: ...\n```\nand this prevent resultant computation of bivariate polynomials\n\n```\nsage: R.<x,y> = K[]\nsage: x.resultant(y)\nTraceback (most recent call last):\n...\nTypeError: ...\n```\n\nOn the way we also provide a straightforward faster powering.\n\n---\n\nJust as a remark, the hash we had in sage-6.8 was **completely** broken\n\n```\nsage: F = GF(2).algebraic_closure()\nsage: z3 = F.gen(3)\nsage: z2 = F.gen(2)\nsage: hash(z2)\n15616093818140894\nsage: hash(z3+z2-z3)\n5386247743066594243\n```\nBut thanks to #19016 the error now shows up!\n\nIssue created by migration from https://trac.sagemath.org/ticket/19956\n\n",
    "closed_at": "2016-05-28T12:13:42Z",
    "created_at": "2016-01-24T21:41:01Z",
    "labels": [
        "component: finite rings",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "elements of finite field algebraic closure are not hashable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19719",
    "user": "https://github.com/videlec"
}
```
CC:  @pjbruin jpflori

We have

```
sage: K = GF(2).algebraic_closure()
sage: a = K.an_element()
sage: hash(a)
Traceback (most recent call last):
...
TypeError: ...
```
and this prevent resultant computation of bivariate polynomials

```
sage: R.<x,y> = K[]
sage: x.resultant(y)
Traceback (most recent call last):
...
TypeError: ...
```

On the way we also provide a straightforward faster powering.

---

Just as a remark, the hash we had in sage-6.8 was **completely** broken

```
sage: F = GF(2).algebraic_closure()
sage: z3 = F.gen(3)
sage: z2 = F.gen(2)
sage: hash(z2)
15616093818140894
sage: hash(z3+z2-z3)
5386247743066594243
```
But thanks to #19016 the error now shows up!

Issue created by migration from https://trac.sagemath.org/ticket/19956





---

archive/issue_comments_270762.json:
```json
{
    "body": "Here is a naive implementation. We need to do some kind of canonicalization to get the hash value... hence it is necessarily slow. There might be some faster option if we have more compatibility with the multiplicative generators.",
    "created_at": "2016-01-24T22:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270762",
    "user": "https://github.com/videlec"
}
```

Here is a naive implementation. We need to do some kind of canonicalization to get the hash value... hence it is necessarily slow. There might be some faster option if we have more compatibility with the multiplicative generators.



---

archive/issue_comments_270763.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-01-24T22:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270763",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_270764.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-24T22:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270764",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270765.json:
```json
{
    "body": "It would already be slightly more efficient to remove the branch and double `hash` and do something like\n\n```\nreturn hash(x) + (F.degree() - 1) * 1009\n```",
    "created_at": "2016-01-25T08:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270765",
    "user": "https://github.com/jdemeyer"
}
```

It would already be slightly more efficient to remove the branch and double `hash` and do something like

```
return hash(x) + (F.degree() - 1) * 1009
```



---

archive/issue_comments_270766.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> It would already be slightly more efficient to remove the branch and double `hash` and do something like\n> \n> ```\n> return hash(x) + (F.degree() - 1) * 1009\n> ```\n\n\nTrue for efficiency. But there will be collisions sooner. The reason is that `map(hash, GF(q))` is `[0, 1, ..., q-1]`. Maybe it was a bad choice for `GF(q)`? What about something like\n\n```\nreturn (hash(x) + deg * p1) ^ ((deg - 1) * p2)\n```\nI am not sure about the optimal size of `p1` and `p2`... But you are right anyway, I should get rid of the branch!",
    "created_at": "2016-01-25T10:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270766",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:5 jdemeyer]:
> It would already be slightly more efficient to remove the branch and double `hash` and do something like
> 
> ```
> return hash(x) + (F.degree() - 1) * 1009
> ```


True for efficiency. But there will be collisions sooner. The reason is that `map(hash, GF(q))` is `[0, 1, ..., q-1]`. Maybe it was a bad choice for `GF(q)`? What about something like

```
return (hash(x) + deg * p1) ^ ((deg - 1) * p2)
```
I am not sure about the optimal size of `p1` and `p2`... But you are right anyway, I should get rid of the branch!



---

archive/issue_comments_270767.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> {{{\n> return (hash(x) + deg * p1) ^ ((deg - 1) * p2)\n> }}}\n\n\nI don't see why that would be better than my proposal. It is more complicated, but has the same inputs...",
    "created_at": "2016-01-25T10:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270767",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 vdelecroix]:
> {{{
> return (hash(x) + deg * p1) ^ ((deg - 1) * p2)
> }}}


I don't see why that would be better than my proposal. It is more complicated, but has the same inputs...



---

archive/issue_comments_270768.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-25T10:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270769.json:
```json
{
    "body": "I followed your suggestion but with a slightly larger value for `1009`.",
    "created_at": "2016-01-25T10:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270769",
    "user": "https://github.com/videlec"
}
```

I followed your suggestion but with a slightly larger value for `1009`.



---

archive/issue_comments_270770.json:
```json
{
    "body": "Just use `hash(x) + 1500007*(F.degree() - 1)` by itself, no need for double hashing which only slows things down.",
    "created_at": "2016-01-25T10:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270770",
    "user": "https://github.com/jdemeyer"
}
```

Just use `hash(x) + 1500007*(F.degree() - 1)` by itself, no need for double hashing which only slows things down.



---

archive/issue_comments_270771.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-25T11:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270771",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270772.json:
```json
{
    "body": "How does this interact with #17569? If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.",
    "created_at": "2016-01-25T11:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270772",
    "user": "https://github.com/jdemeyer"
}
```

How does this interact with #17569? If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.



---

archive/issue_comments_270773.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> How does this interact with #17569? \n\n\nNo interaction as far as I can see.\n\n> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.\n\n\nTrue. But it is disjoint from #17569, isn't it? Even without this patch hashes are incompatible by restriction to finite fields (except the prime field). It might be tricky to provide a coherent hash that would depend on the embedding... a (far from optimal) solution for finite field could be\n\n```\ndef __hash__(self):\n    cf = self._parent.coerce_embedding()\n    if cf is not None:\n        return hash(cf(self))\n    else:\n        ... old code ...\n```\nWhat do you think? But I would consider this as disjoint from this ticket.",
    "created_at": "2016-01-25T11:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270773",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:12 jdemeyer]:
> How does this interact with #17569? 


No interaction as far as I can see.

> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.


True. But it is disjoint from #17569, isn't it? Even without this patch hashes are incompatible by restriction to finite fields (except the prime field). It might be tricky to provide a coherent hash that would depend on the embedding... a (far from optimal) solution for finite field could be

```
def __hash__(self):
    cf = self._parent.coerce_embedding()
    if cf is not None:
        return hash(cf(self))
    else:
        ... old code ...
```
What do you think? But I would consider this as disjoint from this ticket.



---

archive/issue_comments_270774.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.\n\nI am not sure that this really is a good idea: https://wiki.sagemath.org/EqualityCoercion\nIn the long run we might have to move away from our \"mathematical\" implementation of `==` but this is not the focus of this ticket.\nThe changes propose here are a clear improvement of the current situation and seem perfectly fine to me.",
    "created_at": "2016-05-27T17:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270774",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:12 jdemeyer]:
> If finite fields will now embed by default in the algebraic closure, the hashes should be preserved.

I am not sure that this really is a good idea: https://wiki.sagemath.org/EqualityCoercion
In the long run we might have to move away from our "mathematical" implementation of `==` but this is not the focus of this ticket.
The changes propose here are a clear improvement of the current situation and seem perfectly fine to me.



---

archive/issue_comments_270775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-27T17:42:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270775",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_270776.json:
```json
{
    "body": "Thanks for having a look! As a reviewer you should always\n- check the milestone\n- put your name in the \"Reviewers\" field\n(I did it here)",
    "created_at": "2016-05-27T17:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270776",
    "user": "https://github.com/videlec"
}
```

Thanks for having a look! As a reviewer you should always
- check the milestone
- put your name in the "Reviewers" field
(I did it here)



---

archive/issue_events_054470.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-05-27T17:47:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19719#event-54470"
}
```



---

archive/issue_comments_270777.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-28T12:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19719#issuecomment-270777",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_054471.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-28T12:13:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19719",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19719#event-54471"
}
```
