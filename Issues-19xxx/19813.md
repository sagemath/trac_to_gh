# Issue 19813: Sequence_generic needs to guard __iadd__, __imul__, __delitem__ if "immutable".

archive/issues_019576.json:
```json
{
    "body": "I don't even:\n\n```\nsage: b = VectorSpace(QQ,3).basis()\nsage: b += [\"Hello, world!\"]\nsage: VectorSpace(QQ,3).basis()\n[\n(1, 0, 0),\n(0, 1, 0),\n(0, 0, 1),\n'Hello, world!'\n]\n```\n\nSee also #19251.\n\nCC:  @mjungmath @tscrim\n\nAuthor: Matthias Koeppe, ...\n\nBranch: u/mkoeppe/sequence_generic_needs_to_guard_iadd__imul__delitem__delslice_if__immutable__\n\nStatus: needs_work\n\nCommit: 18bb870e917766d241121d88d137c720c216e7cf\n\nIssue created by migration from https://trac.sagemath.org/ticket/19813\n\n",
    "created_at": "2015-12-31T02:05:29Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Sequence_generic needs to guard __iadd__, __imul__, __delitem__ if \"immutable\".",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19813",
    "user": "https://github.com/orlitzky"
}
```
I don't even:

```
sage: b = VectorSpace(QQ,3).basis()
sage: b += ["Hello, world!"]
sage: VectorSpace(QQ,3).basis()
[
(1, 0, 0),
(0, 1, 0),
(0, 0, 1),
'Hello, world!'
]
```

See also #19251.

CC:  @mjungmath @tscrim

Author: Matthias Koeppe, ...

Branch: u/mkoeppe/sequence_generic_needs_to_guard_iadd__imul__delitem__delslice_if__immutable__

Status: needs_work

Commit: 18bb870e917766d241121d88d137c720c216e7cf

Issue created by migration from https://trac.sagemath.org/ticket/19813





---

archive/issue_comments_351763.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt makes sense to me that a vector basis should be mutable. For example, what if you wanted to normalize the basis, order it or replace a basis vector? The resulting contents of the instance could still be a valid basis. There could also be some abstract vector spaces whose basis vectors make sense as strings.",
    "created_at": "2015-12-31T02:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351763",
    "user": "https://trac.sagemath.org/admin/accounts/users/DayneSorvisto"
}
```

<a id='comment:1'></a>
It makes sense to me that a vector basis should be mutable. For example, what if you wanted to normalize the basis, order it or replace a basis vector? The resulting contents of the instance could still be a valid basis. There could also be some abstract vector spaces whose basis vectors make sense as strings.



---

archive/issue_comments_351764.json:
```json
{
    "body": "<a id='comment:2'></a>\nNo, this is indeed quite a bad bug, since VectorSpaces are UniqueRepresentation:\n\n```\nsage: V=VectorSpace(QQ,3)\nsage: W=VectorSpace(QQ,3)\nsage: b=V.basis()\nsage: b+=\"a\"\nsage: len(W.basis())\n4\n```\nNote that V and W are (to the user) obtained independently, so a change on one should not affect the other.\n\nAlso note that some effort is undertaken to make the thing immutable:\n\n```\nsage: b.append(\"a\")\nValueError: object is immutable; please change a copy instead.\nsage: type(b)\n<class 'sage.structure.sequence.Sequence_generic'>\nsage: b.is_mutable()\nFalse\nsage: type(b).__iadd__\n<slot wrapper '__iadd__' of 'list' objects>\n```\nSo it seems we just failed to shadow the \"__iadd__\" method.",
    "created_at": "2015-12-31T02:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351764",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
No, this is indeed quite a bad bug, since VectorSpaces are UniqueRepresentation:

```
sage: V=VectorSpace(QQ,3)
sage: W=VectorSpace(QQ,3)
sage: b=V.basis()
sage: b+="a"
sage: len(W.basis())
4
```
Note that V and W are (to the user) obtained independently, so a change on one should not affect the other.

Also note that some effort is undertaken to make the thing immutable:

```
sage: b.append("a")
ValueError: object is immutable; please change a copy instead.
sage: type(b)
<class 'sage.structure.sequence.Sequence_generic'>
sage: b.is_mutable()
False
sage: type(b).__iadd__
<slot wrapper '__iadd__' of 'list' objects>
```
So it seems we just failed to shadow the "__iadd__" method.



---

archive/issue_comments_351765.json:
```json
{
    "body": "<a id='comment:3'></a>\nIntrospection seems to indicate:\n`__iadd__`, `__imul__`,`__delitem__`,`__delslice__` should be intercepted.\nGleaned from:\n\n```\nsage: T=sage.structure.sequence.Sequence_generic\nsage: [m for m in dir(T) if str(getattr(T,m)).find(\"list\") >=0]\n```",
    "created_at": "2015-12-31T07:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351765",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>
Introspection seems to indicate:
`__iadd__`, `__imul__`,`__delitem__`,`__delslice__` should be intercepted.
Gleaned from:

```
sage: T=sage.structure.sequence.Sequence_generic
sage: [m for m in dir(T) if str(getattr(T,m)).find("list") >=0]
```



---

archive/issue_events_069438.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "rename": {
        "from": "VectorSpace basis() is mutable",
        "to": "Sequence_generic needs to guard iadd, imul, delitem, delslice if \"immutable\"."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69438"
}
```



---

archive/issue_comments_351766.json:
```json
{
    "body": "<a id='comment:4'></a>\nLooks like all Sage objects which define a '+' and can be immutable are failing. I tried matrices and graphs, and both have it.\n\nNathann",
    "created_at": "2015-12-31T09:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351766",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:4'></a>
Looks like all Sage objects which define a '+' and can be immutable are failing. I tried matrices and graphs, and both have it.

Nathann



---

archive/issue_events_069439.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-01T04:08:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69439"
}
```



---

archive/issue_comments_351767.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/sequence_generic_needs_to_guard_iadd__imul__delitem__delslice_if__immutable__\"",
    "created_at": "2021-09-01T05:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351767",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/sequence_generic_needs_to_guard_iadd__imul__delitem__delslice_if__immutable__"



---

archive/issue_comments_351768.json:
```json
{
    "body": "Changing commit from \"\" to \"4fce73d2355af3c7499bf6577c3c8b54df992bc9\"",
    "created_at": "2021-09-01T05:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "4fce73d2355af3c7499bf6577c3c8b54df992bc9"



---

archive/issue_comments_351769.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[4fce73d](https://github.com/sagemath/sagetrac-mirror/commit/4fce73d2355af3c7499bf6577c3c8b54df992bc9)|`Sequence_generic.__imul__: New`|",
    "created_at": "2021-09-01T05:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[4fce73d](https://github.com/sagemath/sagetrac-mirror/commit/4fce73d2355af3c7499bf6577c3c8b54df992bc9)|`Sequence_generic.__imul__: New`|



---

archive/issue_comments_351770.json:
```json
{
    "body": "Changing commit from \"4fce73d2355af3c7499bf6577c3c8b54df992bc9\" to \"d3bf0ac8baa69422f7d4fa1747ba2505adfc0487\"",
    "created_at": "2021-09-01T05:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351770",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4fce73d2355af3c7499bf6577c3c8b54df992bc9" to "d3bf0ac8baa69422f7d4fa1747ba2505adfc0487"



---

archive/issue_comments_351771.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|\n|[d3bf0ac](https://github.com/sagemath/sagetrac-mirror/commit/d3bf0ac8baa69422f7d4fa1747ba2505adfc0487)|`Sequence_generic.__delitem__: New`|",
    "created_at": "2021-09-01T05:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351771",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
|[d3bf0ac](https://github.com/sagemath/sagetrac-mirror/commit/d3bf0ac8baa69422f7d4fa1747ba2505adfc0487)|`Sequence_generic.__delitem__: New`|



---

archive/issue_comments_351772.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [nbruin](#comment%3A3):\n> Introspection seems to indicate:\n> `__iadd__`, `__imul__`,`__delitem__`,`__delslice__` should be intercepted.\n\n\nDone (except for `__delslice__`, which does not exist any more in Python 3).",
    "created_at": "2021-09-01T05:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351772",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Replying to [nbruin](#comment%3A3):
> Introspection seems to indicate:
> `__iadd__`, `__imul__`,`__delitem__`,`__delslice__` should be intercepted.


Done (except for `__delslice__`, which does not exist any more in Python 3).



---

archive/issue_comments_351773.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-01T05:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351773",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351774.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-09-01T05:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351774",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_events_069440.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "rename": {
        "from": "Sequence_generic needs to guard iadd, imul, delitem, delslice if \"immutable\".",
        "to": "Sequence_generic needs to guard __iadd__, __imul__, __delitem__ if \"immutable\"."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69440"
}
```



---

archive/issue_comments_351775.json:
```json
{
    "body": "<a id='comment:11'></a>\nNote that Python's semantics for `A += B` are very close to `A = A + B`. The default is really that it is the latter (and NOT that `A += B` is an error). Some mutable types change the meaning to mutating behaviour instead of binding to a fresh object. Consider this:\n\n```\nsage: t1 = (1,2,3)\nsage: t2 = t1\nsage: t2 += (4,5,6) #this binds t2 to a new tuple\nsage: t1\n(1, 2, 3)\nsage: t2\n(1, 2, 3, 4, 5, 6)\nsage: l1 = [1,2,3]\nsage: l2 = l1\nsage: l2 += [4,5,6] #this mutates the list that l2 is bound to.\nsage: l1\n[1, 2, 3, 4, 5, 6]\nsage: l2\n[1, 2, 3, 4, 5, 6]\n```",
    "created_at": "2021-09-01T06:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351775",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'></a>
Note that Python's semantics for `A += B` are very close to `A = A + B`. The default is really that it is the latter (and NOT that `A += B` is an error). Some mutable types change the meaning to mutating behaviour instead of binding to a fresh object. Consider this:

```
sage: t1 = (1,2,3)
sage: t2 = t1
sage: t2 += (4,5,6) #this binds t2 to a new tuple
sage: t1
(1, 2, 3)
sage: t2
(1, 2, 3, 4, 5, 6)
sage: l1 = [1,2,3]
sage: l2 = l1
sage: l2 += [4,5,6] #this mutates the list that l2 is bound to.
sage: l1
[1, 2, 3, 4, 5, 6]
sage: l2
[1, 2, 3, 4, 5, 6]
```



---

archive/issue_comments_351776.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [nbruin](#comment%3A11):\n> Note that Python's semantics for `A += B` are very close to `A = A + B`. The default is really that it is the latter (and NOT that `A += B` is an error). Some mutable types change the meaning to mutating behaviour instead of binding to a fresh object.\n\n\nSpecifically, in this case, the python docs (https://docs.python.org/3/library/operator.html) say that `x += y` is equivalent to `x = operator.iadd(x, y)`, and `Sequence_generic` is a subclass of `list`, which implements the in-place `iadd` via mutation.\n\nI guess we should fix the default value of `immutable` too, one way or the other:\n\n```python\nclass Sequence_generic(sage.structure.sage_object.SageObject, list):\n    \"\"\"\n    ...\n        - ``immutable`` - (default: True) whether or not this sequence is           \n          immutable\n    ...\n    \"\"\"\n    def __init__(self, x, universe=None, check=True, immutable=False,\n                 cr=False, cr_str=None, use_sage_types=False):\n```",
    "created_at": "2021-09-01T12:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351776",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>
Replying to [nbruin](#comment%3A11):
> Note that Python's semantics for `A += B` are very close to `A = A + B`. The default is really that it is the latter (and NOT that `A += B` is an error). Some mutable types change the meaning to mutating behaviour instead of binding to a fresh object.


Specifically, in this case, the python docs (https://docs.python.org/3/library/operator.html) say that `x += y` is equivalent to `x = operator.iadd(x, y)`, and `Sequence_generic` is a subclass of `list`, which implements the in-place `iadd` via mutation.

I guess we should fix the default value of `immutable` too, one way or the other:

```python
class Sequence_generic(sage.structure.sage_object.SageObject, list):
    """
    ...
        - ``immutable`` - (default: True) whether or not this sequence is           
          immutable
    ...
    """
    def __init__(self, x, universe=None, check=True, immutable=False,
                 cr=False, cr_str=None, use_sage_types=False):
```



---

archive/issue_comments_351777.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-01T18:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351777",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_351778.json:
```json
{
    "body": "<a id='comment:14'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|\n|[9ccc277](https://github.com/sagemath/sagetrac-mirror/commit/9ccc2776307346f45cd9e14eee913e0530f1527a)|`Sequence_generic.__iadd__, __imul__: If immutable, just delegate to __add__/__mul__`|",
    "created_at": "2021-09-01T18:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351778",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
|[9ccc277](https://github.com/sagemath/sagetrac-mirror/commit/9ccc2776307346f45cd9e14eee913e0530f1527a)|`Sequence_generic.__iadd__, __imul__: If immutable, just delegate to __add__/__mul__`|



---

archive/issue_comments_351779.json:
```json
{
    "body": "Changing commit from \"d3bf0ac8baa69422f7d4fa1747ba2505adfc0487\" to \"9ccc2776307346f45cd9e14eee913e0530f1527a\"",
    "created_at": "2021-09-01T18:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351779",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d3bf0ac8baa69422f7d4fa1747ba2505adfc0487" to "9ccc2776307346f45cd9e14eee913e0530f1527a"



---

archive/issue_comments_351780.json:
```json
{
    "body": "<a id='comment:15'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|\n|[607c316](https://github.com/sagemath/sagetrac-mirror/commit/607c31668853b478d858a548167cdbe46fac8074)|`Sequence: Update doc of init arguments to match implementation`|",
    "created_at": "2021-09-01T18:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351780",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
|[607c316](https://github.com/sagemath/sagetrac-mirror/commit/607c31668853b478d858a548167cdbe46fac8074)|`Sequence: Update doc of init arguments to match implementation`|



---

archive/issue_comments_351781.json:
```json
{
    "body": "Changing commit from \"9ccc2776307346f45cd9e14eee913e0530f1527a\" to \"607c31668853b478d858a548167cdbe46fac8074\"",
    "created_at": "2021-09-01T18:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351781",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9ccc2776307346f45cd9e14eee913e0530f1527a" to "607c31668853b478d858a548167cdbe46fac8074"



---

archive/issue_comments_351782.json:
```json
{
    "body": "<a id='comment:16'></a>\nThanks for the comments! Here's a better version",
    "created_at": "2021-09-01T18:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351782",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Thanks for the comments! Here's a better version



---

archive/issue_comments_351783.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-09-01T18:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351783",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351784.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe following sentence (with some fuzz) appears three times in `sequence.py`: \"A mutable sequence of elements with a common guaranteed category, which can be set immutable.\" The universe is not what can be set immutable, though; it's the sequence. I would suggest something like \"An (optionally mutable) sequence of elements with a common parent universe.\"",
    "created_at": "2021-09-01T22:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351784",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>
The following sentence (with some fuzz) appears three times in `sequence.py`: "A mutable sequence of elements with a common guaranteed category, which can be set immutable." The universe is not what can be set immutable, though; it's the sequence. I would suggest something like "An (optionally mutable) sequence of elements with a common parent universe."



---

archive/issue_comments_351785.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe delegation behavior of `iadd` and `imul` is reasonable, but I think the docs should mention that they'll give you back a copy when `immutable=True`.\n\nBut before we address **that**... there's actually another bug that the description highlights: should these methods always return another sequence? And when they do, what should its universe be? The immutable behavior now returns a list, which I personally would not expect:\n\n```python\nsage: s = Sequence([1,2], immutable=True)                                                                                                                                    \nsage: s += [3]                                                                                                                                                               \nsage: type(s)                                                                                                                                                                \n<class 'list'>\n```\n\nThe mutable behavior, on the other hand, can invalidate the universe:\n\n```python\nsage: s = Sequence([ZZ(1),ZZ(2)])                                                                                                                                            \nsage: s.universe()                                                                                                                                                           \nInteger Ring\nsage: s += [x]                                                                                                                                                               \nsage: s                                                                                                                                                                      \n[1, 2, x]\nsage: s.universe()                                                                                                                                                           \nInteger Ring\n```\n\nWe should probably think about that before worrying about the wording of the docs.",
    "created_at": "2021-09-01T22:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351785",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:18'></a>
The delegation behavior of `iadd` and `imul` is reasonable, but I think the docs should mention that they'll give you back a copy when `immutable=True`.

But before we address **that**... there's actually another bug that the description highlights: should these methods always return another sequence? And when they do, what should its universe be? The immutable behavior now returns a list, which I personally would not expect:

```python
sage: s = Sequence([1,2], immutable=True)                                                                                                                                    
sage: s += [3]                                                                                                                                                               
sage: type(s)                                                                                                                                                                
<class 'list'>
```

The mutable behavior, on the other hand, can invalidate the universe:

```python
sage: s = Sequence([ZZ(1),ZZ(2)])                                                                                                                                            
sage: s.universe()                                                                                                                                                           
Integer Ring
sage: s += [x]                                                                                                                                                               
sage: s                                                                                                                                                                      
[1, 2, x]
sage: s.universe()                                                                                                                                                           
Integer Ring
```

We should probably think about that before worrying about the wording of the docs.



---

archive/issue_comments_351786.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-01T23:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351786",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_351787.json:
```json
{
    "body": "<a id='comment:20'></a>\nRight, and also the following does not even work:\n\n```\nsage: M = Sequence([1, 2, 3], immutable=False) \nsage: M * 2\nTypeError: unbound method SageObject.category() needs an argument\n```",
    "created_at": "2021-09-02T19:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351787",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Right, and also the following does not even work:

```
sage: M = Sequence([1, 2, 3], immutable=False) 
sage: M * 2
TypeError: unbound method SageObject.category() needs an argument
```



---

archive/issue_comments_351788.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|\n|[95334bb](https://github.com/sagemath/sagetrac-mirror/commit/95334bb29be9901435e89e9df9273dfa13b9b1dc)|`Sequence_generic.__add__/__iadd__: Always create a new immutable / mutable sequence`|",
    "created_at": "2021-09-03T22:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351788",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
|[95334bb](https://github.com/sagemath/sagetrac-mirror/commit/95334bb29be9901435e89e9df9273dfa13b9b1dc)|`Sequence_generic.__add__/__iadd__: Always create a new immutable / mutable sequence`|



---

archive/issue_comments_351789.json:
```json
{
    "body": "Changing commit from \"607c31668853b478d858a548167cdbe46fac8074\" to \"95334bb29be9901435e89e9df9273dfa13b9b1dc\"",
    "created_at": "2021-09-03T22:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351789",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "607c31668853b478d858a548167cdbe46fac8074" to "95334bb29be9901435e89e9df9273dfa13b9b1dc"



---

archive/issue_comments_351790.json:
```json
{
    "body": "<a id='comment:22'></a>\nHere's another iteration for `__add__`, `__iadd__`...",
    "created_at": "2021-09-03T22:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351790",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>
Here's another iteration for `__add__`, `__iadd__`...



---

archive/issue_comments_351791.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [mkoeppe](#comment%3A22):\n> Here's another iteration for `__add__`, `__iadd__`...\n\n\nLooks good. Is `list.add(self,other)` any faster than `list(self) + list(other)`?\n\nSomething similar for multiplication would work. Finally, we should document that adding sequences will choose a new \"universe\" that encompasses both arguments, while multiplication will reuse the existing universe.",
    "created_at": "2021-09-04T13:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351791",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:23'></a>
Replying to [mkoeppe](#comment%3A22):
> Here's another iteration for `__add__`, `__iadd__`...


Looks good. Is `list.add(self,other)` any faster than `list(self) + list(other)`?

Something similar for multiplication would work. Finally, we should document that adding sequences will choose a new "universe" that encompasses both arguments, while multiplication will reuse the existing universe.



---

archive/issue_comments_351792.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [mjo](#comment%3A23):\n\n> Something similar for multiplication would work. Finally, we should document that adding sequences will choose a new \"universe\" that encompasses both arguments,\n\n\nWe should probably specify how that common parent is constructed. I suspect it should be whatever `coercion_maps(universe(seq1), universe(seq2))` comes up with. For one thing, it should not be driven by the parents of the elements (think of joining sequences of length 0).\n\nIt looks like the present version just rederives the universe from the concatenation of lists of elements. That's not what we need. Instead, we need something like:\n\n```\nL = Sequence([1/2,2,3])                                                     \nM = Sequence([x,1])                                                         \nu,v = coercion_model.coercion_maps(L.universe(),M.universe())               \nimport itertools                                                          \nLplusM = Sequence(itertools.chain(map(u,L),map(v,M)),universe=u.codomain(),check=False)                          \n```\n(A reasonable defensive programming step might be to leave check True). The sole reason for existence of Sequences is that their universe manipulations can be derived from explicit information, rather than derive it from elements. The feature that Sequence allows the universe to be not specified explicitly is only for user convenience. Any systematic use should specify the universe explicitly. That will be much faster too, because the coercion framework doesn't have to scan through individual elements.",
    "created_at": "2021-09-04T15:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351792",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:24'></a>
Replying to [mjo](#comment%3A23):

> Something similar for multiplication would work. Finally, we should document that adding sequences will choose a new "universe" that encompasses both arguments,


We should probably specify how that common parent is constructed. I suspect it should be whatever `coercion_maps(universe(seq1), universe(seq2))` comes up with. For one thing, it should not be driven by the parents of the elements (think of joining sequences of length 0).

It looks like the present version just rederives the universe from the concatenation of lists of elements. That's not what we need. Instead, we need something like:

```
L = Sequence([1/2,2,3])                                                     
M = Sequence([x,1])                                                         
u,v = coercion_model.coercion_maps(L.universe(),M.universe())               
import itertools                                                          
LplusM = Sequence(itertools.chain(map(u,L),map(v,M)),universe=u.codomain(),check=False)                          
```
(A reasonable defensive programming step might be to leave check True). The sole reason for existence of Sequences is that their universe manipulations can be derived from explicit information, rather than derive it from elements. The feature that Sequence allows the universe to be not specified explicitly is only for user convenience. Any systematic use should specify the universe explicitly. That will be much faster too, because the coercion framework doesn't have to scan through individual elements.



---

archive/issue_comments_351793.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [mjo](#comment%3A23):\n> Is `list.add(self,other)` any faster than `list(self) + list(other)`?\n\nThere is no such method",
    "created_at": "2021-09-04T17:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351793",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Replying to [mjo](#comment%3A23):
> Is `list.add(self,other)` any faster than `list(self) + list(other)`?

There is no such method



---

archive/issue_comments_351794.json:
```json
{
    "body": "Changing commit from \"95334bb29be9901435e89e9df9273dfa13b9b1dc\" to \"bb2407eec59af33bc1dc85e4e0865d896603fa44\"",
    "created_at": "2021-09-04T18:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "95334bb29be9901435e89e9df9273dfa13b9b1dc" to "bb2407eec59af33bc1dc85e4e0865d896603fa44"



---

archive/issue_comments_351795.json:
```json
{
    "body": "<a id='comment:26'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n|[bb2407e](https://github.com/sagemath/sagetrac-mirror/commit/bb2407eec59af33bc1dc85e4e0865d896603fa44)|`Sequence_generic: Remove python2-specific special methods`|",
    "created_at": "2021-09-04T18:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
|[bb2407e](https://github.com/sagemath/sagetrac-mirror/commit/bb2407eec59af33bc1dc85e4e0865d896603fa44)|`Sequence_generic: Remove python2-specific special methods`|



---

archive/issue_comments_351796.json:
```json
{
    "body": "<a id='comment:27'></a>\nThe `Sequence` constructor uses `sage.structure.element.canonical_coercion` on adjacent elements from left to right.\n\nIt could probably be simplified using `coercion_model.common_parent`, but the constructor's parameter `use_sage_types=False` and fallbacks for non-coercible inputs are a complication",
    "created_at": "2021-09-04T18:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351796",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
The `Sequence` constructor uses `sage.structure.element.canonical_coercion` on adjacent elements from left to right.

It could probably be simplified using `coercion_model.common_parent`, but the constructor's parameter `use_sage_types=False` and fallbacks for non-coercible inputs are a complication



---

archive/issue_comments_351797.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [mkoeppe](#comment%3A27):\n> The `Sequence` constructor uses `sage.structure.element.canonical_coercion` on adjacent elements from left to right.\n\n\nYes, it does that *if no universe is specified*. However, if a universe is specified, then it just coerces the elements into the universe specified. There is no \"common parent discovery\" necessary in that case anymore.\n\nI maintain that operations on sequences should *not* look at individual elements (since a sequence of length 0 does not have any), but derive the universe from the universes of the input sequences.\n\nIn particular, I think it's fine to have:\n\n```\nSequence(list1) + Sequence(list2) != Sequence(list1+list2)\n```\n(although I'm pretty sure it will actually hold anyway in most/all reasonable cases)\n\n> It could probably be simplified using `coercion_model.common_parent`, but the constructor's parameter `use_sage_types=False` and fallbacks for non-coercible inputs are a complication\n\n\nYou should be able to tell those cases from the universes of the inputs. Perhaps if one of the input universes does not play nice with `coercion_maps`, other fallbacks are necessary (and perhaps just generate an error that no common parent can be found).\n\nGiven that previously these operations just generated a list (clearly not desirable), I don't think you need to be worried about backwards compatibility. So better start out with restrictive, well-defined behaviour. It'll become more relaxed and messy by incremental patching afterwards anyway.",
    "created_at": "2021-09-04T18:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351797",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:28'></a>
Replying to [mkoeppe](#comment%3A27):
> The `Sequence` constructor uses `sage.structure.element.canonical_coercion` on adjacent elements from left to right.


Yes, it does that *if no universe is specified*. However, if a universe is specified, then it just coerces the elements into the universe specified. There is no "common parent discovery" necessary in that case anymore.

I maintain that operations on sequences should *not* look at individual elements (since a sequence of length 0 does not have any), but derive the universe from the universes of the input sequences.

In particular, I think it's fine to have:

```
Sequence(list1) + Sequence(list2) != Sequence(list1+list2)
```
(although I'm pretty sure it will actually hold anyway in most/all reasonable cases)

> It could probably be simplified using `coercion_model.common_parent`, but the constructor's parameter `use_sage_types=False` and fallbacks for non-coercible inputs are a complication


You should be able to tell those cases from the universes of the inputs. Perhaps if one of the input universes does not play nice with `coercion_maps`, other fallbacks are necessary (and perhaps just generate an error that no common parent can be found).

Given that previously these operations just generated a list (clearly not desirable), I don't think you need to be worried about backwards compatibility. So better start out with restrictive, well-defined behaviour. It'll become more relaxed and messy by incremental patching afterwards anyway.



---

archive/issue_comments_351798.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [nbruin](#comment%3A28):\n> I maintain that operations on sequences should *not* look at individual elements (since a sequence of length 0 does not have any), but derive the universe from the universes of the input sequences.\n\n\nYes, I agree with you and have been working on the implementation.",
    "created_at": "2021-09-04T18:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351798",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
Replying to [nbruin](#comment%3A28):
> I maintain that operations on sequences should *not* look at individual elements (since a sequence of length 0 does not have any), but derive the universe from the universes of the input sequences.


Yes, I agree with you and have been working on the implementation.



---

archive/issue_comments_351799.json:
```json
{
    "body": "<a id='comment:30'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|\n|[2aac258](https://github.com/sagemath/sagetrac-mirror/commit/2aac25814bb839d5a7d270dee319f25541d6bf36)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements`|",
    "created_at": "2021-09-04T18:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351799",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
|[2aac258](https://github.com/sagemath/sagetrac-mirror/commit/2aac25814bb839d5a7d270dee319f25541d6bf36)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements`|



---

archive/issue_comments_351800.json:
```json
{
    "body": "Changing commit from \"bb2407eec59af33bc1dc85e4e0865d896603fa44\" to \"2aac25814bb839d5a7d270dee319f25541d6bf36\"",
    "created_at": "2021-09-04T18:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "bb2407eec59af33bc1dc85e4e0865d896603fa44" to "2aac25814bb839d5a7d270dee319f25541d6bf36"



---

archive/issue_comments_351801.json:
```json
{
    "body": "<a id='comment:31'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|\n|[ec0615b](https://github.com/sagemath/sagetrac-mirror/commit/ec0615b49231d1c9314f24c072eccf96145051f2)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements (fixup)`|",
    "created_at": "2021-09-04T19:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351801",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
|[ec0615b](https://github.com/sagemath/sagetrac-mirror/commit/ec0615b49231d1c9314f24c072eccf96145051f2)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements (fixup)`|



---

archive/issue_comments_351802.json:
```json
{
    "body": "Changing commit from \"2aac25814bb839d5a7d270dee319f25541d6bf36\" to \"ec0615b49231d1c9314f24c072eccf96145051f2\"",
    "created_at": "2021-09-04T19:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351802",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2aac25814bb839d5a7d270dee319f25541d6bf36" to "ec0615b49231d1c9314f24c072eccf96145051f2"



---

archive/issue_comments_351803.json:
```json
{
    "body": "<a id='comment:32'></a>\nHere's a new version that implements this. I haven't tested ill-behaved elements yet.\n\nNext is to generalize the `Sequence` constructor so it can accept generators",
    "created_at": "2021-09-04T19:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351803",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
Here's a new version that implements this. I haven't tested ill-behaved elements yet.

Next is to generalize the `Sequence` constructor so it can accept generators



---

archive/issue_comments_351804.json:
```json
{
    "body": "<a id='comment:33'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|\n|[84aae71](https://github.com/sagemath/sagetrac-mirror/commit/84aae71c196de28a336b1f8606f9f378aaf9212d)|`src/sage/structure/sequence.py: Update copyright according to \"git blame -w --date=format:%Y src/sage/structure/sequence.py | sort -k2\"`|",
    "created_at": "2021-09-04T20:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351804",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
|[84aae71](https://github.com/sagemath/sagetrac-mirror/commit/84aae71c196de28a336b1f8606f9f378aaf9212d)|`src/sage/structure/sequence.py: Update copyright according to "git blame -w --date=format:%Y src/sage/structure/sequence.py | sort -k2"`|



---

archive/issue_comments_351805.json:
```json
{
    "body": "Changing commit from \"ec0615b49231d1c9314f24c072eccf96145051f2\" to \"84aae71c196de28a336b1f8606f9f378aaf9212d\"",
    "created_at": "2021-09-04T20:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351805",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ec0615b49231d1c9314f24c072eccf96145051f2" to "84aae71c196de28a336b1f8606f9f378aaf9212d"



---

archive/issue_comments_351806.json:
```json
{
    "body": "Changing commit from \"84aae71c196de28a336b1f8606f9f378aaf9212d\" to \"0c3f1185f9f70b137218765c078156a598e9d46b\"",
    "created_at": "2021-09-04T20:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351806",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "84aae71c196de28a336b1f8606f9f378aaf9212d" to "0c3f1185f9f70b137218765c078156a598e9d46b"



---

archive/issue_comments_351807.json:
```json
{
    "body": "<a id='comment:34'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|\n|[0c3f118](https://github.com/sagemath/sagetrac-mirror/commit/0c3f1185f9f70b137218765c078156a598e9d46b)|`Sequence_generic.__mul__, __rmul__, __imul__: Create sequences in the same universe, not lists`|",
    "created_at": "2021-09-04T20:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351807",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|
|[0c3f118](https://github.com/sagemath/sagetrac-mirror/commit/0c3f1185f9f70b137218765c078156a598e9d46b)|`Sequence_generic.__mul__, __rmul__, __imul__: Create sequences in the same universe, not lists`|



---

archive/issue_comments_351808.json:
```json
{
    "body": "<a id='comment:35'></a>\nGiven that you're using the coercion maps in a coercion environment, I don't think you need to copy them. Maps in the coercion system are special since they try to reference their domain and codomain weakly whenever possible, so that there's still a chance these are garbage collected (the maps are globally cached, so if this would not be done, any structure that participates in the coercion system would become immortal. Even with this hack, it's still often the case structures are unexpectedly prevented from being deleted due to the coercion system -- the implementation of maps often hold references to domain and/or codomain as well). In your case, you already know you're holding a reference to the domains.\n\nI guess there may be a very small chance that the codomain is deleted just before you can get a hold of it (but the \"copy\" does not exclude that, because the codomain could vanish between the return of coercion_maps and the invocation of \"copy\"), so you could try and look if instead of coercion_maps, there is a routine that also returns the common parent (the codomain) explicitly with a strong reference. It looks like this low-probability event has been ignored and it hasn't led to big trouble (and in any case, your \"copy\" doesn't address it any better than just capturing the codomain explicitly). If you look in `discover_coercion` you see that `Z=pushout(R,S)` constructs the common parent, but that after that, internal coercion maps from R and S into Z are computed and that, upon return, the explicit reference to Z is dropped. So I suspect that `coerce_R` and `coerce_S` could be defunct once the return has completed, but I don't think it's ever been observed to happen.\n\nIn any case, watch out that `None` as a coercion map means identity map, so `coercion_maps(ZZ,ZZ)==(None,None)`.\n\nYes, the coercion model is a nasty beast to work with and has been a source of endless memory leaks.\n\nThe warning about copying the maps internal to the coercion system is only for the case when someone wants to extract a morphism for a longer time and expects that holding on to the morphism will keep domain and codomain alive.",
    "created_at": "2021-09-04T20:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351808",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:35'></a>
Given that you're using the coercion maps in a coercion environment, I don't think you need to copy them. Maps in the coercion system are special since they try to reference their domain and codomain weakly whenever possible, so that there's still a chance these are garbage collected (the maps are globally cached, so if this would not be done, any structure that participates in the coercion system would become immortal. Even with this hack, it's still often the case structures are unexpectedly prevented from being deleted due to the coercion system -- the implementation of maps often hold references to domain and/or codomain as well). In your case, you already know you're holding a reference to the domains.

I guess there may be a very small chance that the codomain is deleted just before you can get a hold of it (but the "copy" does not exclude that, because the codomain could vanish between the return of coercion_maps and the invocation of "copy"), so you could try and look if instead of coercion_maps, there is a routine that also returns the common parent (the codomain) explicitly with a strong reference. It looks like this low-probability event has been ignored and it hasn't led to big trouble (and in any case, your "copy" doesn't address it any better than just capturing the codomain explicitly). If you look in `discover_coercion` you see that `Z=pushout(R,S)` constructs the common parent, but that after that, internal coercion maps from R and S into Z are computed and that, upon return, the explicit reference to Z is dropped. So I suspect that `coerce_R` and `coerce_S` could be defunct once the return has completed, but I don't think it's ever been observed to happen.

In any case, watch out that `None` as a coercion map means identity map, so `coercion_maps(ZZ,ZZ)==(None,None)`.

Yes, the coercion model is a nasty beast to work with and has been a source of endless memory leaks.

The warning about copying the maps internal to the coercion system is only for the case when someone wants to extract a morphism for a longer time and expects that holding on to the morphism will keep domain and codomain alive.



---

archive/issue_comments_351809.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [nbruin](#comment%3A35):\n> watch out that `None` as a coercion map means identity map, so `coercion_maps(ZZ,ZZ)==(None,None)`.\n\n\nYes, the code is handling that already",
    "created_at": "2021-09-04T20:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351809",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>
Replying to [nbruin](#comment%3A35):
> watch out that `None` as a coercion map means identity map, so `coercion_maps(ZZ,ZZ)==(None,None)`.


Yes, the code is handling that already



---

archive/issue_comments_351810.json:
```json
{
    "body": "<a id='comment:37'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|\n|[ef9a375](https://github.com/sagemath/sagetrac-mirror/commit/ef9a375f1dca6eb28ee69dcf1790df86731f6ba8)|`Sequence_generic._add: We hold strong references to domain/codomain, no need to copy the coercion map`|",
    "created_at": "2021-09-04T21:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351810",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
|[ef9a375](https://github.com/sagemath/sagetrac-mirror/commit/ef9a375f1dca6eb28ee69dcf1790df86731f6ba8)|`Sequence_generic._add: We hold strong references to domain/codomain, no need to copy the coercion map`|



---

archive/issue_comments_351811.json:
```json
{
    "body": "Changing commit from \"0c3f1185f9f70b137218765c078156a598e9d46b\" to \"ef9a375f1dca6eb28ee69dcf1790df86731f6ba8\"",
    "created_at": "2021-09-04T21:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351811",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0c3f1185f9f70b137218765c078156a598e9d46b" to "ef9a375f1dca6eb28ee69dcf1790df86731f6ba8"



---

archive/issue_comments_351812.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [nbruin](#comment%3A35):\n> Given that you're using the coercion maps in a coercion environment, I don't think you need to copy them. [...]\n\n\nThanks for the explanation, I agree.",
    "created_at": "2021-09-04T21:08:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351812",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>
Replying to [nbruin](#comment%3A35):
> Given that you're using the coercion maps in a coercion environment, I don't think you need to copy them. [...]


Thanks for the explanation, I agree.



---

archive/issue_comments_351813.json:
```json
{
    "body": "<a id='comment:39'></a>\nI think in the failing testcase of `3 * M`, `Integer.__mul__` calls `coercion_model.bin_op`, which seems to get confused by `M` being a `Parent`, not an `Element`",
    "created_at": "2021-09-04T21:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351813",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>
I think in the failing testcase of `3 * M`, `Integer.__mul__` calls `coercion_model.bin_op`, which seems to get confused by `M` being a `Parent`, not an `Element`



---

archive/issue_comments_351814.json:
```json
{
    "body": "<a id='comment:40'></a>\n(`3r * M` works.)",
    "created_at": "2021-09-04T21:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351814",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'></a>
(`3r * M` works.)



---

archive/issue_comments_351815.json:
```json
{
    "body": "Changing author from \"Matthias Koeppe\" to \"Matthias Koeppe, ...\"",
    "created_at": "2021-10-13T17:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351815",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Matthias Koeppe" to "Matthias Koeppe, ..."



---

archive/issue_comments_351816.json:
```json
{
    "body": "<a id='comment:41'></a>\nI think I need some help with this ticket",
    "created_at": "2021-10-13T17:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351816",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>
I think I need some help with this ticket



---

archive/issue_events_069441.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69441"
}
```



---

archive/issue_events_069442.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69442"
}
```



---

archive/issue_events_069443.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69443"
}
```



---

archive/issue_events_069444.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69444"
}
```



---

archive/issue_comments_351817.json:
```json
{
    "body": "<a id='comment:44'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n|                                                                                                                                           |                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|\n|[467c49c](https://github.com/sagemath/sagetrac-mirror/commit/467c49c37e12a5b0bf5c13f9664ada9f5e62870a)|`Sequence_generic.__delitem__: New`|\n|[ec47c71](https://github.com/sagemath/sagetrac-mirror/commit/ec47c71c9008d05002189215e96292f836b915d8)|`Sequence_generic.__iadd__, __imul__: If immutable, just delegate to __add__/__mul__`|\n|[d4e0e3d](https://github.com/sagemath/sagetrac-mirror/commit/d4e0e3d45e2e41fde7b3907620bfa99af8f719c5)|`Sequence: Update doc of init arguments to match implementation`|\n|[2a592f1](https://github.com/sagemath/sagetrac-mirror/commit/2a592f1e65c9a04ba6dd3b65c67fd49cb250dc37)|`Sequence_generic.__add__/__iadd__: Always create a new immutable / mutable sequence`|\n|[8daa94c](https://github.com/sagemath/sagetrac-mirror/commit/8daa94c7a971ed448fd42846112e6c78a9f06d54)|`Sequence_generic: Remove python2-specific special methods`|\n|[dd5a47f](https://github.com/sagemath/sagetrac-mirror/commit/dd5a47fba4d12664c636c30d83dc112a6b4774e9)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements`|\n|[a128950](https://github.com/sagemath/sagetrac-mirror/commit/a1289504baf0cc8929cff2b89ffe83c3de831eff)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements (fixup)`|\n|[dcdb57a](https://github.com/sagemath/sagetrac-mirror/commit/dcdb57a9f1fcc381ced97ee9c03ed24cc274efd9)|`src/sage/structure/sequence.py: Update copyright according to \"git blame -w --date=format:%Y src/sage/structure/sequence.py | sort -k2\"`|\n|[ef206b7](https://github.com/sagemath/sagetrac-mirror/commit/ef206b7b171cd2324d02ee53625a31f097359fb4)|`Sequence_generic.__mul__, __rmul__, __imul__: Create sequences in the same universe, not lists`|\n|[18bb870](https://github.com/sagemath/sagetrac-mirror/commit/18bb870e917766d241121d88d137c720c216e7cf)|`Sequence_generic._add: We hold strong references to domain/codomain, no need to copy the coercion map`|",
    "created_at": "2022-08-30T23:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351817",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
|                                                                                                                                           |                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
|[467c49c](https://github.com/sagemath/sagetrac-mirror/commit/467c49c37e12a5b0bf5c13f9664ada9f5e62870a)|`Sequence_generic.__delitem__: New`|
|[ec47c71](https://github.com/sagemath/sagetrac-mirror/commit/ec47c71c9008d05002189215e96292f836b915d8)|`Sequence_generic.__iadd__, __imul__: If immutable, just delegate to __add__/__mul__`|
|[d4e0e3d](https://github.com/sagemath/sagetrac-mirror/commit/d4e0e3d45e2e41fde7b3907620bfa99af8f719c5)|`Sequence: Update doc of init arguments to match implementation`|
|[2a592f1](https://github.com/sagemath/sagetrac-mirror/commit/2a592f1e65c9a04ba6dd3b65c67fd49cb250dc37)|`Sequence_generic.__add__/__iadd__: Always create a new immutable / mutable sequence`|
|[8daa94c](https://github.com/sagemath/sagetrac-mirror/commit/8daa94c7a971ed448fd42846112e6c78a9f06d54)|`Sequence_generic: Remove python2-specific special methods`|
|[dd5a47f](https://github.com/sagemath/sagetrac-mirror/commit/dd5a47fba4d12664c636c30d83dc112a6b4774e9)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements`|
|[a128950](https://github.com/sagemath/sagetrac-mirror/commit/a1289504baf0cc8929cff2b89ffe83c3de831eff)|`Sequence_generic.__add__, __iadd__: Compute new universe from old universes, not elements (fixup)`|
|[dcdb57a](https://github.com/sagemath/sagetrac-mirror/commit/dcdb57a9f1fcc381ced97ee9c03ed24cc274efd9)|`src/sage/structure/sequence.py: Update copyright according to "git blame -w --date=format:%Y src/sage/structure/sequence.py | sort -k2"`|
|[ef206b7](https://github.com/sagemath/sagetrac-mirror/commit/ef206b7b171cd2324d02ee53625a31f097359fb4)|`Sequence_generic.__mul__, __rmul__, __imul__: Create sequences in the same universe, not lists`|
|[18bb870](https://github.com/sagemath/sagetrac-mirror/commit/18bb870e917766d241121d88d137c720c216e7cf)|`Sequence_generic._add: We hold strong references to domain/codomain, no need to copy the coercion map`|



---

archive/issue_comments_351818.json:
```json
{
    "body": "Changing commit from \"ef9a375f1dca6eb28ee69dcf1790df86731f6ba8\" to \"18bb870e917766d241121d88d137c720c216e7cf\"",
    "created_at": "2022-08-30T23:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19813#issuecomment-351818",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ef9a375f1dca6eb28ee69dcf1790df86731f6ba8" to "18bb870e917766d241121d88d137c720c216e7cf"



---

archive/issue_events_069445.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69445"
}
```



---

archive/issue_events_069446.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19813",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19813#event-69446"
}
```
