# Issue 19810: Optimize get_key() for cached functions

archive/issues_019573.json:
```json
{
    "body": "The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.\n\nWe add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n\n**Before**:\n\n```\nsage: def f(x): return x\nsage: cf = cached_function(f)\nsage: timeit('cf(1)', number=10^6, repeat=100)\n1000000 loops, best of 100: 395 ns per loop\n```\n\n**After**:\n\n```\nsage: def f(x): return x\nsage: cf = cached_function(f)\nsage: timeit('cf(1)', number=10^6, repeat=100)\n1000000 loops, best of 100: 348 ns per loop\n```\n\nBranch/Commit: 9e41b4cc969b56768d5492cfd82f0a74b3afb829\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19810\n\n",
    "closed_at": "2016-01-06T00:01:24Z",
    "created_at": "2015-12-30T14:12:51Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Optimize get_key() for cached functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19810",
    "user": "https://github.com/jdemeyer"
}
```
The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.

We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.

**Before**:

```
sage: def f(x): return x
sage: cf = cached_function(f)
sage: timeit('cf(1)', number=10^6, repeat=100)
1000000 loops, best of 100: 395 ns per loop
```

**After**:

```
sage: def f(x): return x
sage: cf = cached_function(f)
sage: timeit('cf(1)', number=10^6, repeat=100)
1000000 loops, best of 100: 348 ns per loop
```

Branch/Commit: 9e41b4cc969b56768d5492cfd82f0a74b3afb829

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19810





---

archive/issue_comments_359827.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#19768\"",
    "created_at": "2015-12-30T14:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359827",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#19768"



---

archive/issue_events_061637.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "rename": {
        "from": "Cached function: add Cython version of get_key()",
        "to": "Further Cython optimizations and clean-up of cached functions"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19810#event-61637"
}
```



---

archive/issue_comments_359828.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.\n+1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.\n``````\n",
    "created_at": "2015-12-30T15:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359828",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.
+1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.
``````




---

archive/issue_comments_359829.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n-1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.\n+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.\n+\n+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n``````\n",
    "created_at": "2015-12-30T15:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359829",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
-1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.
+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.
+
+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
``````




---

archive/issue_events_061638.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "rename": {
        "from": "Further Cython optimizations and clean-up of cached functions",
        "to": "Optimize get_key() for cached functions"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19810#event-61638"
}
```



---

archive/issue_comments_359830.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/19810\"",
    "created_at": "2015-12-30T19:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359830",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/19810"



---

archive/issue_comments_359831.json:
```json
{
    "body": "Changing commit from \"\" to \"5935e74937021979c229e009f6b9ee64f1ec70c0\"",
    "created_at": "2015-12-30T19:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "5935e74937021979c229e009f6b9ee64f1ec70c0"



---

archive/issue_comments_359832.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[5935e74](https://github.com/sagemath/sagetrac-mirror/commit/5935e74937021979c229e009f6b9ee64f1ec70c0)|`Add get_key_args_kwds() Cython method`|",
    "created_at": "2015-12-30T19:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359832",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[5935e74](https://github.com/sagemath/sagetrac-mirror/commit/5935e74937021979c229e009f6b9ee64f1ec70c0)|`Add get_key_args_kwds() Cython method`|



---

archive/issue_comments_359833.json:
```json
{
    "body": "Changing dependencies from \"#19768\" to \"\"",
    "created_at": "2015-12-30T19:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359833",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#19768" to ""



---

archive/issue_comments_359834.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-30T19:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359834",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_359835.json:
```json
{
    "body": "<a id='comment:8'></a>\nDo we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?\n\nI noticed this one:\n\n```\n-        new = lambda x: not has_key(get_key(*x[0],**x[1]))\n+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))\n         arglist = filter(new, map(normalize_input, arglist))\n```\nWriting that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.",
    "created_at": "2015-12-30T20:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359835",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>
Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?

I noticed this one:

```
-        new = lambda x: not has_key(get_key(*x[0],**x[1]))
+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))
         arglist = filter(new, map(normalize_input, arglist))
```
Writing that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.



---

archive/issue_comments_359836.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [nbruin](#comment%3A8):\n> Do we have figures on what kind of optimization gain is obtained by these changes?\n\nOn first sight, not very much compared to the overhead of cached functions (less than I hoped).\n\n> Or are we just getting the benefit of having more streamlined and hence more maintainable code?\n\nThat's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).",
    "created_at": "2015-12-30T21:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359836",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [nbruin](#comment%3A8):
> Do we have figures on what kind of optimization gain is obtained by these changes?

On first sight, not very much compared to the overhead of cached functions (less than I hoped).

> Or are we just getting the benefit of having more streamlined and hence more maintainable code?

That's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).



---

archive/issue_comments_359837.json:
```json
{
    "body": "Changing commit from \"5935e74937021979c229e009f6b9ee64f1ec70c0\" to \"9e41b4cc969b56768d5492cfd82f0a74b3afb829\"",
    "created_at": "2015-12-31T08:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5935e74937021979c229e009f6b9ee64f1ec70c0" to "9e41b4cc969b56768d5492cfd82f0a74b3afb829"



---

archive/issue_comments_359838.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|\n|[9e41b4c](https://github.com/sagemath/sagetrac-mirror/commit/9e41b4cc969b56768d5492cfd82f0a74b3afb829)|`Optimize precompute()`|",
    "created_at": "2015-12-31T08:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                       |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|
|[9e41b4c](https://github.com/sagemath/sagetrac-mirror/commit/9e41b4cc969b56768d5492cfd82f0a74b3afb829)|`Optimize precompute()`|



---

archive/issue_comments_359839.json:
```json
{
    "body": "<a id='comment:11'></a>\nThe speed gain is about 12% for a function with 1 argument.",
    "created_at": "2015-12-31T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359839",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
The speed gain is about 12% for a function with 1 argument.



---

archive/issue_comments_359840.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,21 @@\n The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.\n \n We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n+\n+**Before**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 395 ns per loop\n+```\n+\n+**After**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 348 ns per loop\n+```\n``````\n",
    "created_at": "2015-12-31T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359840",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,21 @@
 The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.
 
 We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
+
+**Before**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 395 ns per loop
+```
+
+**After**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 348 ns per loop
+```
``````




---

archive/issue_comments_359841.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.\n+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.\n \n We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n \n``````\n",
    "created_at": "2015-12-31T10:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359841",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.
+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.
 
 We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
 
``````




---

archive/issue_comments_359842.json:
```json
{
    "body": "<a id='comment:13'></a>\nOne further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.",
    "created_at": "2016-01-02T12:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359842",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
One further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.



---

archive/issue_comments_359843.json:
```json
{
    "body": "<a id='comment:14'></a>\nNils, are you planning/doing a review of this ticket?",
    "created_at": "2016-01-04T02:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359843",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>
Nils, are you planning/doing a review of this ticket?



---

archive/issue_comments_359844.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [tscrim](#comment%3A14):\n> Nils, are you planning/doing a review of this ticket?\n\nIf you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.",
    "created_at": "2016-01-04T07:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359844",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'></a>
Replying to [tscrim](#comment%3A14):
> Nils, are you planning/doing a review of this ticket?

If you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.



---

archive/issue_comments_359845.json:
```json
{
    "body": "<a id='comment:16'></a>\nOkay, thanks.\n\nThis LGTM and does net a nice little speed bump as far as I can tell.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359845",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>
Okay, thanks.

This LGTM and does net a nice little speed bump as far as I can tell.



---

archive/issue_comments_359846.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359846",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_359847.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359847",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_359848.json:
```json
{
    "body": "<a id='comment:17'></a>\nThanks!",
    "created_at": "2016-01-04T12:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359848",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Thanks!



---

archive/issue_events_061639.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-06T00:01:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19810#event-61639"
}
```



---

archive/issue_comments_359849.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-06T00:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359849",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_359850.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/ticket/19810\" to \"9e41b4cc969b56768d5492cfd82f0a74b3afb829\"",
    "created_at": "2016-01-06T00:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-359850",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/ticket/19810" to "9e41b4cc969b56768d5492cfd82f0a74b3afb829"
