# Issue 19810: Optimize get_key() for cached functions

archive/issues_019573.json:
```json
{
    "body": "The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.\n\nWe add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n\n**Before**:\n\n```\nsage: def f(x): return x\nsage: cf = cached_function(f)\nsage: timeit('cf(1)', number=10^6, repeat=100)\n1000000 loops, best of 100: 395 ns per loop\n```\n\n**After**:\n\n```\nsage: def f(x): return x\nsage: cf = cached_function(f)\nsage: timeit('cf(1)', number=10^6, repeat=100)\n1000000 loops, best of 100: 348 ns per loop\n```\n\nBranch/Commit: 9e41b4cc969b56768d5492cfd82f0a74b3afb829\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19810\n\n",
    "closed_at": "2016-01-06T00:01:24Z",
    "created_at": "2015-12-30T14:12:51Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.0",
    "title": "Optimize get_key() for cached functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19810",
    "user": "https://github.com/jdemeyer"
}
```
The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.

We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.

**Before**:

```
sage: def f(x): return x
sage: cf = cached_function(f)
sage: timeit('cf(1)', number=10^6, repeat=100)
1000000 loops, best of 100: 395 ns per loop
```

**After**:

```
sage: def f(x): return x
sage: cf = cached_function(f)
sage: timeit('cf(1)', number=10^6, repeat=100)
1000000 loops, best of 100: 348 ns per loop
```

Branch/Commit: 9e41b4cc969b56768d5492cfd82f0a74b3afb829

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19810





---

archive/issue_comments_286073.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.\n+1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2015-12-30T15:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286073",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. This should be moved to exactly one place. We also try to optimize things where applicable.
+1. The code to determine the actual key from `*args` and `**kwds` is duplicated (even with slightly different implementations!) in many methods. We add a new Cython method `get_key_args_kwds()` for this.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_286074.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.\n \n+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2015-12-30T15:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286074",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.
 
+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_286075.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-12-30T19:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286075",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_286076.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-30T19:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286076",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_286077.json:
```json
{
    "body": "<a id='comment:8'></a>Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?\n\nI noticed this one:\n\n```\n-        new = lambda x: not has_key(get_key(*x[0],**x[1]))\n+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))\n         arglist = filter(new, map(normalize_input, arglist))\n```\nWriting that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.",
    "created_at": "2015-12-30T20:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286077",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>Do we have figures on what kind of optimization gain is obtained by these changes? Or are we just getting the benefit of having more streamlined and hence more maintainable code?

I noticed this one:

```
-        new = lambda x: not has_key(get_key(*x[0],**x[1]))
+        new = lambda x: not has_key(self.get_key(*x[0],**x[1]))
         arglist = filter(new, map(normalize_input, arglist))
```
Writing that as a list comprehension should avoid an extra (expensive) python call, so should be a little faster.



---

archive/issue_comments_286078.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 nbruin]:\n> Do we have figures on what kind of optimization gain is obtained by these changes?\n\nOn first sight, not very much compared to the overhead of cached functions (less than I hoped).\n\n> Or are we just getting the benefit of having more streamlined and hence more maintainable code?\n\nThat's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).",
    "created_at": "2015-12-30T21:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286078",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:8 nbruin]:
> Do we have figures on what kind of optimization gain is obtained by these changes?

On first sight, not very much compared to the overhead of cached functions (less than I hoped).

> Or are we just getting the benefit of having more streamlined and hence more maintainable code?

That's an additional advantage. Cached functions need a big cleanup, and this ticket is part of that (I already did #19695 and #19768 earlier).



---

archive/issue_comments_286079.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-31T08:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_286080.json:
```json
{
    "body": "<a id='comment:11'></a>The speed gain is about 12% for a function with 1 argument.",
    "created_at": "2015-12-31T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286080",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>The speed gain is about 12% for a function with 1 argument.



---

archive/issue_comments_286081.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.\n \n+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n+\n+**Before**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 395 ns per loop\n+```\n+\n+**After**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 348 ns per loop\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2015-12-31T10:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286081",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,24 @@
+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection.
 
+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
+
+**Before**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 395 ns per loop
+```
+
+**After**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 348 ns per loop
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_286082.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.\n \n+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.\n+\n+**Before**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 395 ns per loop\n+```\n+\n+**After**:\n+\n+```\n+sage: def f(x): return x\n+sage: cf = cached_function(f)\n+sage: timeit('cf(1)', number=10^6, repeat=100)\n+1000000 loops, best of 100: 348 ns per loop\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2015-12-31T10:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286082",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,24 @@
+The code to determine the actual key from `*args` and `**kwds` for cached functions is duplicated (even with slightly different implementations!) in many methods. There is also a lot of indirection and Python calls.
 
+We add a new Cython method `get_key_args_kwds()` to solve this problem and do a lot of optimizations.
+
+**Before**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 395 ns per loop
+```
+
+**After**:
+
+```
+sage: def f(x): return x
+sage: cf = cached_function(f)
+sage: timeit('cf(1)', number=10^6, repeat=100)
+1000000 loops, best of 100: 348 ns per loop
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_286083.json:
```json
{
    "body": "<a id='comment:13'></a>One further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.",
    "created_at": "2016-01-02T12:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286083",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>One further remark: I think that there should be a separate class for a cached method *bound* to a class. This could simplify the code even further. I didn't do that on this ticket since there are already enough changes here.



---

archive/issue_comments_286084.json:
```json
{
    "body": "<a id='comment:14'></a>Nils, are you planning/doing a review of this ticket?",
    "created_at": "2016-01-04T02:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286084",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Nils, are you planning/doing a review of this ticket?



---

archive/issue_comments_286085.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 tscrim]:\n> Nils, are you planning/doing a review of this ticket?\n\nIf you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.",
    "created_at": "2016-01-04T07:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286085",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'></a>Replying to [comment:14 tscrim]:
> Nils, are you planning/doing a review of this ticket?

If you're willing to do it, please go ahead. If not, I might try, but not in the next couple of days.



---

archive/issue_comments_286086.json:
```json
{
    "body": "<a id='comment:16'></a>Okay, thanks.\n\nThis LGTM and does net a nice little speed bump as far as I can tell.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286086",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Okay, thanks.

This LGTM and does net a nice little speed bump as far as I can tell.



---

archive/issue_comments_286087.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-04T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286087",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_286088.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks!",
    "created_at": "2016-01-04T12:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286088",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Thanks!



---

archive/issue_events_054208.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-06T00:01:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19810#event-54208"
}
```



---

archive/issue_comments_286089.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-06T00:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19810#issuecomment-286089",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
