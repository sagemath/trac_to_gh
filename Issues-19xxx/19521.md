# Issue 19521: wrong inverse action when using ConstructionFunctor.coercion_reversed

archive/issues_019284.json:
```json
{
    "body": "```\nsage: Q.<y> = SR.subring(no_variables=True)[[]]\nsage: (y / 1).parent()\nUnivariate Polynomial Ring in x over Symbolic Ring\n```\nbut the result should be\n\n```\nUnivariate Polynomial Ring in x over Symbolic Constants Subring\n```\nsince there is a coercion from the integer ring to the symbolc constants subring.\n\nThis is because the attrirute `coercion_reversed` of `ConstructionFunctor` is not taken into account.\n\nReviewer: Benjamin Hackl\n\nAuthor: Daniel Krenn\n\nBranch: 867d6d3cc606f4c291bc9098e490366160b40f42\n\nDependencies: #19259\n\nCommit: 867d6d3cc606f4c291bc9098e490366160b40f42\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19521\n\n",
    "closed_at": "2016-01-24T21:48:30Z",
    "created_at": "2015-11-04T15:21:56Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "wrong inverse action when using ConstructionFunctor.coercion_reversed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19521",
    "user": "https://github.com/dkrenn"
}
```
```
sage: Q.<y> = SR.subring(no_variables=True)[[]]
sage: (y / 1).parent()
Univariate Polynomial Ring in x over Symbolic Ring
```
but the result should be

```
Univariate Polynomial Ring in x over Symbolic Constants Subring
```
since there is a coercion from the integer ring to the symbolc constants subring.

This is because the attrirute `coercion_reversed` of `ConstructionFunctor` is not taken into account.

Reviewer: Benjamin Hackl

Author: Daniel Krenn

Branch: 867d6d3cc606f4c291bc9098e490366160b40f42

Dependencies: #19259

Commit: 867d6d3cc606f4c291bc9098e490366160b40f42

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19521





---

archive/issue_comments_264503.json:
```json
{
    "body": "<a id='comment:1'></a>BTW: For some reason it works (partially) for polynomial rings:\n\n```\n     sage: R.<x> = SR.subring(no_variables=True)[]\n     sage: (x / 1).parent()\n     Univariate Polynomial Ring in x over Symbolic Constants Subring\n```\nbut\n\n```\n     sage: cm = sage.structure.element.get_coercion_model()\n     sage: cm.explain(x, 1, operator.div)\n     Action discovered.\n        Right inverse action by Symbolic Ring on Univariate Polynomial Ring in x over Symbolic Constants Subring\n        with precomposition on right by Conversion map:\n          From: Integer Ring\n          To:   Symbolic Ring\n    Result lives in Univariate Polynomial Ring in x over Symbolic Ring\n    Univariate Polynomial Ring in x over Symbolic Ring\n```\n\nAt one point this should be investigated, but probably on a different ticket.",
    "created_at": "2015-11-04T15:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264503",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:1'></a>BTW: For some reason it works (partially) for polynomial rings:

```
     sage: R.<x> = SR.subring(no_variables=True)[]
     sage: (x / 1).parent()
     Univariate Polynomial Ring in x over Symbolic Constants Subring
```
but

```
     sage: cm = sage.structure.element.get_coercion_model()
     sage: cm.explain(x, 1, operator.div)
     Action discovered.
        Right inverse action by Symbolic Ring on Univariate Polynomial Ring in x over Symbolic Constants Subring
        with precomposition on right by Conversion map:
          From: Integer Ring
          To:   Symbolic Ring
    Result lives in Univariate Polynomial Ring in x over Symbolic Ring
    Univariate Polynomial Ring in x over Symbolic Ring
```

At one point this should be investigated, but probably on a different ticket.



---

archive/issue_comments_264504.json:
```json
{
    "body": "<a id='comment:4'></a>Branch should fix this; still need to run a `make ptestlong`; will do this soon...\n\n---\nLast 10 new commits:",
    "created_at": "2015-11-04T16:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264504",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:4'></a>Branch should fix this; still need to run a `make ptestlong`; will do this soon...

---
Last 10 new commits:



---

archive/issue_comments_264505.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 dkrenn]:\n> Branch should fix this; still need to run a `make ptestlong`; will do this soon...\n\n\nPassed. So I set it to needs review.",
    "created_at": "2015-11-05T01:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264505",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:5'></a>Replying to [comment:4 dkrenn]:
> Branch should fix this; still need to run a `make ptestlong`; will do this soon...


Passed. So I set it to needs review.



---

archive/issue_comments_264506.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-05T01:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264506",
    "user": "https://github.com/dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_264507.json:
```json
{
    "body": "<a id='comment:6'></a>Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.\n\nI think I understand your fix as well as the strategy behind it, and I am willing to give this a `positive_review` (i.e. everything LGTM). However, I'd rather be sure:\n\nIn principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?\n\nFor example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?\n\nAlso, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.\n\n---\nNew commits:",
    "created_at": "2016-01-24T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264507",
    "user": "https://github.com/behackl"
}
```

<a id='comment:6'></a>Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.

I think I understand your fix as well as the strategy behind it, and I am willing to give this a `positive_review` (i.e. everything LGTM). However, I'd rather be sure:

In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?

For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?

Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.

---
New commits:



---

archive/issue_comments_264508.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 behackl]:\n> Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.\n\n\nThanks.\n\n> In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?\n> \n> For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?\n\n\nCorrect.\n\n> Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.\n\n\nOk.",
    "created_at": "2016-01-24T07:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264508",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:7'></a>Replying to [comment:6 behackl]:
> Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.


Thanks.

> In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?
> 
> For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?


Correct.

> Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.


Ok.



---

archive/issue_comments_264509.json:
```json
{
    "body": "<a id='comment:8'></a>... alright. Passes `ptestlong` and does what it should -> `positive_review`.",
    "created_at": "2016-01-24T08:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264509",
    "user": "https://github.com/behackl"
}
```

<a id='comment:8'></a>... alright. Passes `ptestlong` and does what it should -> `positive_review`.



---

archive/issue_comments_264510.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-24T08:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264510",
    "user": "https://github.com/behackl"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_264511.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-24T21:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-264511",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_053791.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-24T21:48:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19521#event-53791"
}
```
