# Issue 19521: wrong inverse action when using ConstructionFunctor.coercion_reversed

archive/issues_019284.json:
```json
{
    "body": "\n```\nsage: Q.<y> = SR.subring(no_variables=True)[[]]\nsage: (y / 1).parent()\nUnivariate Polynomial Ring in x over Symbolic Ring\n```\nbut the result should be\n\n```\nUnivariate Polynomial Ring in x over Symbolic Constants Subring\n```\nsince there is a coercion from the integer ring to the symbolc constants subring.\n\nThis is because the attrirute `coercion_reversed` of `ConstructionFunctor` is not taken into account.\n\nBranch/Commit: 867d6d3cc606f4c291bc9098e490366160b40f42\n\nReviewer: Benjamin Hackl\n\nAuthor: Daniel Krenn\n\nDependencies: #19259\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19521\n\n",
    "closed_at": "2016-01-24T21:48:30Z",
    "created_at": "2015-11-04T15:21:56Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "wrong inverse action when using ConstructionFunctor.coercion_reversed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19521",
    "user": "https://github.com/dkrenn"
}
```

```
sage: Q.<y> = SR.subring(no_variables=True)[[]]
sage: (y / 1).parent()
Univariate Polynomial Ring in x over Symbolic Ring
```
but the result should be

```
Univariate Polynomial Ring in x over Symbolic Constants Subring
```
since there is a coercion from the integer ring to the symbolc constants subring.

This is because the attrirute `coercion_reversed` of `ConstructionFunctor` is not taken into account.

Branch/Commit: 867d6d3cc606f4c291bc9098e490366160b40f42

Reviewer: Benjamin Hackl

Author: Daniel Krenn

Dependencies: #19259

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19521





---

archive/issue_comments_350190.json:
```json
{
    "body": "<a id='comment:1'></a>\nBTW: For some reason it works (partially) for polynomial rings:\n\n```\n     sage: R.<x> = SR.subring(no_variables=True)[]\n     sage: (x / 1).parent()\n     Univariate Polynomial Ring in x over Symbolic Constants Subring\n```\nbut\n\n```\n     sage: cm = sage.structure.element.get_coercion_model()\n     sage: cm.explain(x, 1, operator.div)\n     Action discovered.\n        Right inverse action by Symbolic Ring on Univariate Polynomial Ring in x over Symbolic Constants Subring\n        with precomposition on right by Conversion map:\n          From: Integer Ring\n          To:   Symbolic Ring\n    Result lives in Univariate Polynomial Ring in x over Symbolic Ring\n    Univariate Polynomial Ring in x over Symbolic Ring\n```\n\nAt one point this should be investigated, but probably on a different ticket.",
    "created_at": "2015-11-04T15:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350190",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:1'></a>
BTW: For some reason it works (partially) for polynomial rings:

```
     sage: R.<x> = SR.subring(no_variables=True)[]
     sage: (x / 1).parent()
     Univariate Polynomial Ring in x over Symbolic Constants Subring
```
but

```
     sage: cm = sage.structure.element.get_coercion_model()
     sage: cm.explain(x, 1, operator.div)
     Action discovered.
        Right inverse action by Symbolic Ring on Univariate Polynomial Ring in x over Symbolic Constants Subring
        with precomposition on right by Conversion map:
          From: Integer Ring
          To:   Symbolic Ring
    Result lives in Univariate Polynomial Ring in x over Symbolic Ring
    Univariate Polynomial Ring in x over Symbolic Ring
```

At one point this should be investigated, but probably on a different ticket.



---

archive/issue_comments_350191.json:
```json
{
    "body": "Changing author from \"\" to \"Daniel Krenn\"",
    "created_at": "2015-11-04T15:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350191",
    "user": "https://github.com/dkrenn"
}
```

Changing author from "" to "Daniel Krenn"



---

archive/issue_comments_350192.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#19259\"",
    "created_at": "2015-11-04T15:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350192",
    "user": "https://github.com/dkrenn"
}
```

Changing dependencies from "" to "#19259"



---

archive/issue_comments_350193.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dkrenn/coerce/inverse-action\"",
    "created_at": "2015-11-04T16:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350193",
    "user": "https://github.com/dkrenn"
}
```

Changing branch from "" to "u/dkrenn/coerce/inverse-action"



---

archive/issue_comments_350194.json:
```json
{
    "body": "Changing commit from \"\" to \"563845928f4cfacb54f46156e59c12ffa46dbdab\"",
    "created_at": "2015-11-04T16:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350194",
    "user": "https://github.com/dkrenn"
}
```

Changing commit from "" to "563845928f4cfacb54f46156e59c12ffa46dbdab"



---

archive/issue_comments_350195.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch should fix this; still need to run a `make ptestlong`; will do this soon...\n\n---\nLast 10 new commits:\n|                                                                                                                                          |                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------|\n|[fb2885c](http://git.sagemath.org/sage.git/commit/?id=fb2885ca9a15adc71844a06beb3a0c2cdcfc06d3)|`subring in index.rst`|\n|[eab9513](http://git.sagemath.org/sage.git/commit/?id=eab9513b0b035e6cebf4b7bf6374c15d3f270788)|`simplify a doctest`|\n|[23352b2](http://git.sagemath.org/sage.git/commit/?id=23352b23af092225d157a7089ab0913c5002c8ef)|`change ValueError to TypeError to make everything work with SR as it should`|\n|[2d8b7c4](http://git.sagemath.org/sage.git/commit/?id=2d8b7c4a0545513d3360738c6182daf0c3275246)|`typo in docstring`|\n|[15ec40e](http://git.sagemath.org/sage.git/commit/?id=15ec40ee05d97d4c669b59101bb91ab6020ecb99)|`docstring of SR.subring`|\n|[7938d95](http://git.sagemath.org/sage.git/commit/?id=7938d95efbba4282216166d9ba200e1552a9b21f)|`module description of subring`|\n|[852959a](http://git.sagemath.org/sage.git/commit/?id=852959a8bec1f6da8c5a2f0d69edb8b23b9d0c59)|`rename only_constants --> no_variables`|\n|[e4837e9](http://git.sagemath.org/sage.git/commit/?id=e4837e9b4f2e9edff62ae0bb192a406c44cba561)|`correct parent of result of an_element`|\n|[6e5a098](http://git.sagemath.org/sage.git/commit/?id=6e5a098cc6cce8d67bd795067f1e0f9b688cf303)|`Merge branch 'u/dkrenn/symbolic-subring' of trac.sagemath.org:sage into coerce/inverse-action`|\n|[5638459](http://git.sagemath.org/sage.git/commit/?id=563845928f4cfacb54f46156e59c12ffa46dbdab)|`#19521: use coercion_reversed in InverseAction`|",
    "created_at": "2015-11-04T16:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350195",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:4'></a>
Branch should fix this; still need to run a `make ptestlong`; will do this soon...

---
Last 10 new commits:
|                                                                                                                                          |                      |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------|
|[fb2885c](http://git.sagemath.org/sage.git/commit/?id=fb2885ca9a15adc71844a06beb3a0c2cdcfc06d3)|`subring in index.rst`|
|[eab9513](http://git.sagemath.org/sage.git/commit/?id=eab9513b0b035e6cebf4b7bf6374c15d3f270788)|`simplify a doctest`|
|[23352b2](http://git.sagemath.org/sage.git/commit/?id=23352b23af092225d157a7089ab0913c5002c8ef)|`change ValueError to TypeError to make everything work with SR as it should`|
|[2d8b7c4](http://git.sagemath.org/sage.git/commit/?id=2d8b7c4a0545513d3360738c6182daf0c3275246)|`typo in docstring`|
|[15ec40e](http://git.sagemath.org/sage.git/commit/?id=15ec40ee05d97d4c669b59101bb91ab6020ecb99)|`docstring of SR.subring`|
|[7938d95](http://git.sagemath.org/sage.git/commit/?id=7938d95efbba4282216166d9ba200e1552a9b21f)|`module description of subring`|
|[852959a](http://git.sagemath.org/sage.git/commit/?id=852959a8bec1f6da8c5a2f0d69edb8b23b9d0c59)|`rename only_constants --> no_variables`|
|[e4837e9](http://git.sagemath.org/sage.git/commit/?id=e4837e9b4f2e9edff62ae0bb192a406c44cba561)|`correct parent of result of an_element`|
|[6e5a098](http://git.sagemath.org/sage.git/commit/?id=6e5a098cc6cce8d67bd795067f1e0f9b688cf303)|`Merge branch 'u/dkrenn/symbolic-subring' of trac.sagemath.org:sage into coerce/inverse-action`|
|[5638459](http://git.sagemath.org/sage.git/commit/?id=563845928f4cfacb54f46156e59c12ffa46dbdab)|`#19521: use coercion_reversed in InverseAction`|



---

archive/issue_comments_350196.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [dkrenn](#comment%3A4):\n> Branch should fix this; still need to run a `make ptestlong`; will do this soon...\n\n\nPassed. So I set it to needs review.",
    "created_at": "2015-11-05T01:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350196",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:5'></a>
Replying to [dkrenn](#comment%3A4):
> Branch should fix this; still need to run a `make ptestlong`; will do this soon...


Passed. So I set it to needs review.



---

archive/issue_comments_350197.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-05T01:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350197",
    "user": "https://github.com/dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_350198.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Benjamin Hackl\"",
    "created_at": "2016-01-24T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350198",
    "user": "https://github.com/behackl"
}
```

Changing reviewer from "" to "Benjamin Hackl"



---

archive/issue_comments_350199.json:
```json
{
    "body": "Changing commit from \"563845928f4cfacb54f46156e59c12ffa46dbdab\" to \"867d6d3cc606f4c291bc9098e490366160b40f42\"",
    "created_at": "2016-01-24T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350199",
    "user": "https://github.com/behackl"
}
```

Changing commit from "563845928f4cfacb54f46156e59c12ffa46dbdab" to "867d6d3cc606f4c291bc9098e490366160b40f42"



---

archive/issue_comments_350200.json:
```json
{
    "body": "Changing branch from \"u/dkrenn/coerce/inverse-action\" to \"u/behackl/coercion/inverse-action\"",
    "created_at": "2016-01-24T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350200",
    "user": "https://github.com/behackl"
}
```

Changing branch from "u/dkrenn/coerce/inverse-action" to "u/behackl/coercion/inverse-action"



---

archive/issue_comments_350201.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.\n\nI think I understand your fix as well as the strategy behind it, and I am willing to give this a `positive_review` (i.e. everything LGTM). However, I'd rather be sure:\n\nIn principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?\n\nFor example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?\n\nAlso, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.\n\n---\nNew commits:\n|                                                                                                                                          |                                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[ff99c7f](http://git.sagemath.org/sage.git/commit/?id=ff99c7f211725817f213257d2edfad01acfabdc2)|`Trac #19259: change to has_valid_variable`|\n|[581f315](http://git.sagemath.org/sage.git/commit/?id=581f3157f57c8b38390cf515e065cf62eacec306)|`Trac #19259: check validity of variables`|\n|[c9b2428](http://git.sagemath.org/sage.git/commit/?id=c9b24288c1222beb5d436fedd9cda144d89b10b4)|`improve language`|\n|[05dc834](http://git.sagemath.org/sage.git/commit/?id=05dc8345c3cc09a083bd588366793149daa1d6ab)|`misc. changes, indentation, line breaks`|\n|[8cc884a](http://git.sagemath.org/sage.git/commit/?id=8cc884a527e7d72fe125509c8f1cfa556ee83773)|`fix merge of functors`|\n|[aeae8f3](http://git.sagemath.org/sage.git/commit/?id=aeae8f3358607c5081e72470b66672765e42ecb3)|`Merge tag '7.0' into symbolics/symbolic-subring`|\n|[c4a0e22](http://git.sagemath.org/sage.git/commit/?id=c4a0e226b7fa34959d990be3bb768d270fd7f9a5)|`merge accepting and rejecting functors in all cases`|\n|[d376b10](http://git.sagemath.org/sage.git/commit/?id=d376b1022bc5f7aa5b8ffbb422cfe0bfa0d951d5)|`revert changes to merge of functors`|\n|[867d6d3](http://git.sagemath.org/sage.git/commit/?id=867d6d3cc606f4c291bc9098e490366160b40f42)|`Merge branch 'u/behackl/symbolics/symbolic-subring' of git://trac.sagemath.org/sage into coercion/inverse-action`|",
    "created_at": "2016-01-24T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350201",
    "user": "https://github.com/behackl"
}
```

<a id='comment:6'></a>
Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.

I think I understand your fix as well as the strategy behind it, and I am willing to give this a `positive_review` (i.e. everything LGTM). However, I'd rather be sure:

In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?

For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?

Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.

---
New commits:
|                                                                                                                                          |                                           |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[ff99c7f](http://git.sagemath.org/sage.git/commit/?id=ff99c7f211725817f213257d2edfad01acfabdc2)|`Trac #19259: change to has_valid_variable`|
|[581f315](http://git.sagemath.org/sage.git/commit/?id=581f3157f57c8b38390cf515e065cf62eacec306)|`Trac #19259: check validity of variables`|
|[c9b2428](http://git.sagemath.org/sage.git/commit/?id=c9b24288c1222beb5d436fedd9cda144d89b10b4)|`improve language`|
|[05dc834](http://git.sagemath.org/sage.git/commit/?id=05dc8345c3cc09a083bd588366793149daa1d6ab)|`misc. changes, indentation, line breaks`|
|[8cc884a](http://git.sagemath.org/sage.git/commit/?id=8cc884a527e7d72fe125509c8f1cfa556ee83773)|`fix merge of functors`|
|[aeae8f3](http://git.sagemath.org/sage.git/commit/?id=aeae8f3358607c5081e72470b66672765e42ecb3)|`Merge tag '7.0' into symbolics/symbolic-subring`|
|[c4a0e22](http://git.sagemath.org/sage.git/commit/?id=c4a0e226b7fa34959d990be3bb768d270fd7f9a5)|`merge accepting and rejecting functors in all cases`|
|[d376b10](http://git.sagemath.org/sage.git/commit/?id=d376b1022bc5f7aa5b8ffbb422cfe0bfa0d951d5)|`revert changes to merge of functors`|
|[867d6d3](http://git.sagemath.org/sage.git/commit/?id=867d6d3cc606f4c291bc9098e490366160b40f42)|`Merge branch 'u/behackl/symbolics/symbolic-subring' of git://trac.sagemath.org/sage into coercion/inverse-action`|



---

archive/issue_comments_350202.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [behackl](#comment%3A6):\n> Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.\n\n\nThanks.\n\n> In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?\n> \n> For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?\n\n\nCorrect.\n\n> Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.\n\n\nOk.",
    "created_at": "2016-01-24T07:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350202",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:7'></a>
Replying to [behackl](#comment%3A6):
> Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.


Thanks.

> In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?
> 
> For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?


Correct.

> Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.


Ok.



---

archive/issue_comments_350203.json:
```json
{
    "body": "<a id='comment:8'></a>\n... alright. Passes `ptestlong` and does what it should -> `positive_review`.",
    "created_at": "2016-01-24T08:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350203",
    "user": "https://github.com/behackl"
}
```

<a id='comment:8'></a>
... alright. Passes `ptestlong` and does what it should -> `positive_review`.



---

archive/issue_comments_350204.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-01-24T08:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350204",
    "user": "https://github.com/behackl"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_350205.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-01-24T21:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350205",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_350206.json:
```json
{
    "body": "Changing branch from \"u/behackl/coercion/inverse-action\" to \"867d6d3cc606f4c291bc9098e490366160b40f42\"",
    "created_at": "2016-01-24T21:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19521#issuecomment-350206",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/behackl/coercion/inverse-action" to "867d6d3cc606f4c291bc9098e490366160b40f42"



---

archive/issue_events_053791.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-01-24T21:48:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19521",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19521#event-53791"
}
```
