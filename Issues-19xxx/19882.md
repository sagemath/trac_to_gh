# Issue 19882: Let "make doc" always work.

archive/issues_019645.json:
```json
{
    "body": "As requested in #18464. Currently `make doc` can fail when some previous documentation was built.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19882\n\n",
    "closed_at": "2017-12-12T08:23:33Z",
    "created_at": "2016-01-13T17:39:04Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Let \"make doc\" always work.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19882",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
As requested in #18464. Currently `make doc` can fail when some previous documentation was built.



Issue created by migration from https://trac.sagemath.org/ticket/19882





---

archive/issue_comments_269680.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-13T17:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269680",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_269681.json:
```json
{
    "body": "The proposed fix is to just let the `doc` target depend on `doc-clean`. Perhaps is there a lighter solution ?\n\n---\nNew commits:",
    "created_at": "2016-01-13T17:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269681",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

The proposed fix is to just let the `doc` target depend on `doc-clean`. Perhaps is there a lighter solution ?

---
New commits:



---

archive/issue_comments_269682.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-01-13T18:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269682",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_269683.json:
```json
{
    "body": "No, this would force the doc to be rebuilt everytime you run `make`.",
    "created_at": "2016-01-13T18:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269683",
    "user": "https://github.com/jdemeyer"
}
```

No, this would force the doc to be rebuilt everytime you run `make`.



---

archive/issue_comments_269684.json:
```json
{
    "body": "So, what should be done ?",
    "created_at": "2016-01-13T18:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269684",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

So, what should be done ?



---

archive/issue_comments_269685.json:
```json
{
    "body": "Figure out **why** the docbuilder sometimes fails and fix that.",
    "created_at": "2016-01-13T18:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269685",
    "user": "https://github.com/jdemeyer"
}
```

Figure out **why** the docbuilder sometimes fails and fix that.



---

archive/issue_comments_269686.json:
```json
{
    "body": "Do we have ideas why? If a `.py` or `.pyx` file is present in one branch and not in another, this confuses the docbuilder. What else goes wrong?",
    "created_at": "2016-01-13T21:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269686",
    "user": "https://github.com/jhpalmieri"
}
```

Do we have ideas why? If a `.py` or `.pyx` file is present in one branch and not in another, this confuses the docbuilder. What else goes wrong?



---

archive/issue_comments_269687.json:
```json
{
    "body": "Replying to [comment:4 tmonteil]:\n> So, what should be done ?\n\n\nAs quick fix, the following might work:\n\n1. try to build the documentation normally.\n2. if that fails, run `make doc-clean` and rebuild the documentation.\n\nStep 1 is crucial to avoid a lot of needless rebuilds of the documentation.",
    "created_at": "2016-01-14T22:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269687",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 tmonteil]:
> So, what should be done ?


As quick fix, the following might work:

1. try to build the documentation normally.
2. if that fails, run `make doc-clean` and rebuild the documentation.

Step 1 is crucial to avoid a lot of needless rebuilds of the documentation.



---

archive/issue_comments_269688.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-15T17:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269688",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269689.json:
```json
{
    "body": "I am wondering if the recursive call of `$(MAKE)` is a good idea (I'm not saying it's bad, I just need to think about it).",
    "created_at": "2016-01-15T17:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269689",
    "user": "https://github.com/jdemeyer"
}
```

I am wondering if the recursive call of `$(MAKE)` is a good idea (I'm not saying it's bad, I just need to think about it).



---

archive/issue_comments_269690.json:
```json
{
    "body": "The current Makefile already calls `$(MAKE)`, see e.g. in #18710:\n\n```\nbdist-clean: clean\n        $(MAKE) misc-clean\n```\n\nThat said, there is no real recursivity since the `doc` target depends on `doc-html` and `doc-clean`, and none of those depend on `doc`, so i do not see any loop possibility. I am currently doing a few tests to see how it works in various cases.",
    "created_at": "2016-01-15T19:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269690",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

The current Makefile already calls `$(MAKE)`, see e.g. in #18710:

```
bdist-clean: clean
        $(MAKE) misc-clean
```

That said, there is no real recursivity since the `doc` target depends on `doc-html` and `doc-clean`, and none of those depend on `doc`, so i do not see any loop possibility. I am currently doing a few tests to see how it works in various cases.



---

archive/issue_comments_269691.json:
```json
{
    "body": "It's problematic that `doc-html` has dependencies which also appear as dependencies of `all-sage`. So we can end up in a situation where there are two instances of `make` building the same targets.",
    "created_at": "2016-01-16T10:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269691",
    "user": "https://github.com/jdemeyer"
}
```

It's problematic that `doc-html` has dependencies which also appear as dependencies of `all-sage`. So we can end up in a situation where there are two instances of `make` building the same targets.



---

archive/issue_comments_269692.json:
```json
{
    "body": "Maybe you can solve this with an extra level of indirection:\n\n```\ndoc-html: $(DOC_DEPENDENCIES)\n    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )\n\ndocbuild-html:\n    cd ../.. && sage-logger './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\n```\n\nUgly, but I guess it would work.",
    "created_at": "2016-01-16T11:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269692",
    "user": "https://github.com/jdemeyer"
}
```

Maybe you can solve this with an extra level of indirection:

```
doc-html: $(DOC_DEPENDENCIES)
    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )

docbuild-html:
    cd ../.. && sage-logger './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```

Ugly, but I guess it would work.



---

archive/issue_comments_269693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-26T10:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269693",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269694.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-01-27T21:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269694",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_269695.json:
```json
{
    "body": "It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?",
    "created_at": "2016-01-27T21:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269695",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?



---

archive/issue_comments_269696.json:
```json
{
    "body": "Did you try `make -q` too? I am afraid that will break.",
    "created_at": "2016-01-29T07:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269696",
    "user": "https://github.com/jdemeyer"
}
```

Did you try `make -q` too? I am afraid that will break.



---

archive/issue_comments_269697.json:
```json
{
    "body": "Replying to [comment:14 tmonteil]:\n> It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?\n\n\nI would just create a dummy file with some simple doc<sup>1</sup>, build the doc, delete the file, and rebuild the doc (perhaps on a branch based on this one).\n\nAlternatively, you could create a branch where you just remove a file and try to build the doc.\n\n<sup>1</sup> - Don't forget to add an entry in the `.rst` files.",
    "created_at": "2016-01-29T15:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269697",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:14 tmonteil]:
> It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?


I would just create a dummy file with some simple doc<sup>1</sup>, build the doc, delete the file, and rebuild the doc (perhaps on a branch based on this one).

Alternatively, you could create a branch where you just remove a file and try to build the doc.

<sup>1</sup> - Don't forget to add an entry in the `.rst` files.



---

archive/issue_comments_269698.json:
```json
{
    "body": "#21378 got positive review (duplicate won't fix) saying that this ticket (#19882) is a better solution. But there was no update on #19882 since 8 months...\n\nNo later than yesterday, I run `make ptestlong` overnight to realize the day after that the doc failed and no test at all were ever made:\n\n```\n[dochtml] OSError: [homology ] Exception occurred:\n[dochtml] \n[dochtml] \n[dochtml] Note: incremental documentation builds sometimes cause spurious\n[dochtml] error messages. To be certain that these are real errors, run\n[dochtml] \"make doc-clean\" first and try again.\nMakefile:1061\u00a0: la recette pour la cible \u00ab\u00a0doc-html\u00a0\u00bb a \u00e9chou\u00e9e\n```\n\nI would like that `make ptestlong` always work...",
    "created_at": "2016-10-05T15:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269698",
    "user": "https://github.com/seblabbe"
}
```

#21378 got positive review (duplicate won't fix) saying that this ticket (#19882) is a better solution. But there was no update on #19882 since 8 months...

No later than yesterday, I run `make ptestlong` overnight to realize the day after that the doc failed and no test at all were ever made:

```
[dochtml] OSError: [homology ] Exception occurred:
[dochtml] 
[dochtml] 
[dochtml] Note: incremental documentation builds sometimes cause spurious
[dochtml] error messages. To be certain that these are real errors, run
[dochtml] "make doc-clean" first and try again.
Makefile:1061 : la recette pour la cible « doc-html » a échouée
```

I would like that `make ptestlong` always work...



---

archive/issue_comments_269699.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-10-21T08:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269699",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_269700.json:
```json
{
    "body": "Merge conflict...",
    "created_at": "2016-10-21T08:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269700",
    "user": "https://github.com/jdemeyer"
}
```

Merge conflict...



---

archive/issue_events_054340.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-10-21T08:07:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19882#event-54340"
}
```



---

archive/issue_comments_269701.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-03-10T09:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269701",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_269702.json:
```json
{
    "body": "Here is a rebased version. Unfortunately, my laptop does not have enough memory anymore to build Sage doc, so that i can not test it seriously :(",
    "created_at": "2017-03-10T09:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269702",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Here is a rebased version. Unfortunately, my laptop does not have enough memory anymore to build Sage doc, so that i can not test it seriously :(



---

archive/issue_comments_269703.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-10T09:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269703",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_269704.json:
```json
{
    "body": "I got the error\n\n```\n***********************************************\nMakefile:1093: *** missing separator.  Stop.\n```\nwith this, until I made the change\n\n```diff\ndiff --git a/build/make/deps b/build/make/deps\nindex e18fd6f..da0a4e9 100644\n--- a/build/make/deps\n+++ b/build/make/deps\n@@ -206,7 +206,7 @@ DOC_DEPENDENCIES = sagelib $(inst_sphinx) $(inst_sagenb) \\\n doc: doc-html\n \n doc-html: $(DOC_DEPENDENCIES)\n-    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )\n+       $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )\n \n docbuild-html:\n        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log\n```\n(that is, replacing spaces with a tab).",
    "created_at": "2017-03-10T18:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269704",
    "user": "https://github.com/jhpalmieri"
}
```

I got the error

```
***********************************************
Makefile:1093: *** missing separator.  Stop.
```
with this, until I made the change

```diff
diff --git a/build/make/deps b/build/make/deps
index e18fd6f..da0a4e9 100644
--- a/build/make/deps
+++ b/build/make/deps
@@ -206,7 +206,7 @@ DOC_DEPENDENCIES = sagelib $(inst_sphinx) $(inst_sagenb) \
 doc: doc-html
 
 doc-html: $(DOC_DEPENDENCIES)
-    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )
+       $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )
 
 docbuild-html:
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```
(that is, replacing spaces with a tab).



---

archive/issue_comments_269705.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-10T18:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269705",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269706.json:
```json
{
    "body": "Oops, thanks for noticing, i did a 'hand rebase', without noticing that my editor behave as for python files. Sorry.",
    "created_at": "2017-03-10T18:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269706",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Oops, thanks for noticing, i did a 'hand rebase', without noticing that my editor behave as for python files. Sorry.



---

archive/issue_comments_269707.json:
```json
{
    "body": "This works. I wish there were a less drastic solution, but let's merge it now and see if someone comes up with something better later.",
    "created_at": "2017-03-10T20:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269707",
    "user": "https://github.com/jhpalmieri"
}
```

This works. I wish there were a less drastic solution, but let's merge it now and see if someone comes up with something better later.



---

archive/issue_comments_269708.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-10T20:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269708",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_269709.json:
```json
{
    "body": "Did you check that `make -q` still works as expected?",
    "created_at": "2017-03-10T20:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269709",
    "user": "https://github.com/jdemeyer"
}
```

Did you check that `make -q` still works as expected?



---

archive/issue_comments_269710.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-03-10T20:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269710",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_269711.json:
```json
{
    "body": "No, good point.",
    "created_at": "2017-03-10T20:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269711",
    "user": "https://github.com/jhpalmieri"
}
```

No, good point.



---

archive/issue_comments_269712.json:
```json
{
    "body": "Replying to [comment:25 jdemeyer]:\n> Did you check that `make -q` still works as expected?\n\n\nI guess I don't know what you mean, now that I've tested it. With the current develop branch, if I run `make` successfully, then I see\n\n```\n$ make -q\n$ echo $?\n1\n```\nSo it doesn't work (IMHO) with the develop branch. It continues to not work with this branch. Is that working \"as expected\"?",
    "created_at": "2017-03-10T20:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269712",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:25 jdemeyer]:
> Did you check that `make -q` still works as expected?


I guess I don't know what you mean, now that I've tested it. With the current develop branch, if I run `make` successfully, then I see

```
$ make -q
$ echo $?
1
```
So it doesn't work (IMHO) with the develop branch. It continues to not work with this branch. Is that working "as expected"?



---

archive/issue_comments_269713.json:
```json
{
    "body": "Check this out for alternative solution.\n\nhttps://trac.sagemath.org/ticket/22588",
    "created_at": "2017-03-13T00:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269713",
    "user": "https://github.com/kwankyu"
}
```

Check this out for alternative solution.

https://trac.sagemath.org/ticket/22588



---

archive/issue_comments_269714.json:
```json
{
    "body": "I think that the alternate solution at #22588 and this one both have advantages. For example, if you change your version of Sphinx, you may need to delete the docs and rebuild from scratch (maybe because of the inventory files? I'm not sure). I'm not sure that #22588 will catch that. So why not use both approaches?\n\nThat said, my question above about `make -q` still remains.",
    "created_at": "2017-03-14T18:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269714",
    "user": "https://github.com/jhpalmieri"
}
```

I think that the alternate solution at #22588 and this one both have advantages. For example, if you change your version of Sphinx, you may need to delete the docs and rebuild from scratch (maybe because of the inventory files? I'm not sure). I'm not sure that #22588 will catch that. So why not use both approaches?

That said, my question above about `make -q` still remains.



---

archive/issue_comments_269715.json:
```json
{
    "body": "Jeroen: can you explain what you meant in comment:25 about `make -q`? With or without this branch, `make -q` leads to `echo $?` reporting \"1\", not \"0\". Do you object to a positive review for this?\n\n(As I said, I also think that there is reason to keep both this and #22588.)",
    "created_at": "2017-08-03T23:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269715",
    "user": "https://github.com/jhpalmieri"
}
```

Jeroen: can you explain what you meant in comment:25 about `make -q`? With or without this branch, `make -q` leads to `echo $?` reporting "1", not "0". Do you object to a positive review for this?

(As I said, I also think that there is reason to keep both this and #22588.)



---

archive/issue_comments_269716.json:
```json
{
    "body": "So what should we do here, given #22588? Close as wontfix?",
    "created_at": "2017-09-05T13:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269716",
    "user": "https://github.com/jdemeyer"
}
```

So what should we do here, given #22588? Close as wontfix?



---

archive/issue_comments_269717.json:
```json
{
    "body": "Will #22588 always work, or will the docs still fail to build some time (I guessed at one scenario in comment:29)?",
    "created_at": "2017-09-05T14:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269717",
    "user": "https://github.com/jhpalmieri"
}
```

Will #22588 always work, or will the docs still fail to build some time (I guessed at one scenario in comment:29)?



---

archive/issue_comments_269718.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> Will #22588 always work, or will the docs still fail to build some time\n\n\nThat's something to be seen I guess. The question is: if issues arise with #22588, should we try to fix those issues or should we implement the \"nuclear option\" of this ticket?",
    "created_at": "2017-09-05T14:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269718",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:32 jhpalmieri]:
> Will #22588 always work, or will the docs still fail to build some time


That's something to be seen I guess. The question is: if issues arise with #22588, should we try to fix those issues or should we implement the "nuclear option" of this ticket?



---

archive/issue_comments_269719.json:
```json
{
    "body": "I don't have strong feelings about it. Since it took so long to get an attempted fix, I'm not that optimistic that future problems will be dealt with, but I don't mind closing this and seeing what happens.",
    "created_at": "2017-09-05T15:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269719",
    "user": "https://github.com/jhpalmieri"
}
```

I don't have strong feelings about it. Since it took so long to get an attempted fix, I'm not that optimistic that future problems will be dealt with, but I don't mind closing this and seeing what happens.



---

archive/issue_comments_269720.json:
```json
{
    "body": "Now with #22588, I hope that the doc builder is reliable.  I mean: if doc build fails, then the reason is genuine, that is, there is a problem with the doc source, and doc build would fail even after doc-clean. Then the solution of this ticket is actually just to delay the time to recognize the problem of the doc source.  \n\nBut time will tell whether I am just too optimistic..",
    "created_at": "2017-09-05T15:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269720",
    "user": "https://github.com/kwankyu"
}
```

Now with #22588, I hope that the doc builder is reliable.  I mean: if doc build fails, then the reason is genuine, that is, there is a problem with the doc source, and doc build would fail even after doc-clean. Then the solution of this ticket is actually just to delay the time to recognize the problem of the doc source.  

But time will tell whether I am just too optimistic..



---

archive/issue_comments_269721.json:
```json
{
    "body": "I just did an incremental build from 8.1.beta3 to 8.1.beta4 and got\n\n```\n[dochtml] Building reference manual, first pass.\n[dochtml] \n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n[dochtml]     \"__main__\", fname, loader, pkg_name)\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py\", line 72, in _run_code\n[dochtml]     exec code in run_globals\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 1675, in main\n[dochtml]     builder()\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 310, in _wrapper\n[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 505, in _wrapper\n[dochtml]     build_many(build_ref_doc, L)\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 246, in build_many\n[dochtml]     ret = x.get(99999)\n[dochtml]   File \"/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/multiprocessing/pool.py\", line 567, in get\n[dochtml]     raise self._value\n[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'\n[dochtml] \n[dochtml] Note: incremental documentation builds sometimes cause spurious\n[dochtml] error messages. To be certain that these are real errors, run\n[dochtml] \"make doc-clean\" first and try again.\n```",
    "created_at": "2017-09-06T01:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269721",
    "user": "https://github.com/jhpalmieri"
}
```

I just did an incremental build from 8.1.beta3 to 8.1.beta4 and got

```
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml]     builder()
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 246, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'
[dochtml] 
[dochtml] Note: incremental documentation builds sometimes cause spurious
[dochtml] error messages. To be certain that these are real errors, run
[dochtml] "make doc-clean" first and try again.
```



---

archive/issue_comments_269722.json:
```json
{
    "body": "And this seems to be repeatable for me: I switched back to 8.1.beta3, did `make doc-clean; make`, and then when I tried to build 8.1.beta4, same error.",
    "created_at": "2017-09-06T04:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269722",
    "user": "https://github.com/jhpalmieri"
}
```

And this seems to be repeatable for me: I switched back to 8.1.beta3, did `make doc-clean; make`, and then when I tried to build 8.1.beta4, same error.



---

archive/issue_comments_269723.json:
```json
{
    "body": "Replying to [comment:36 jhpalmieri]:\n> `[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'`\n\n\nThis is very likely due to the Sphinx upgrade #23023. It makes sense to require a complete rebuild of the docs when changing Sphinx versions. This should be automated, just like we automatically re-cythonize the Sage library whenever the Cython version changes.",
    "created_at": "2017-09-06T11:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269723",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:36 jhpalmieri]:
> `[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'`


This is very likely due to the Sphinx upgrade #23023. It makes sense to require a complete rebuild of the docs when changing Sphinx versions. This should be automated, just like we automatically re-cythonize the Sage library whenever the Cython version changes.



---

archive/issue_comments_269724.json:
```json
{
    "body": "We could delete the docs in the Sphinx `spkg-install` script. We used to do this, but then at some point (#11665) we decided to try to keep the old docs.",
    "created_at": "2017-09-07T15:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269724",
    "user": "https://github.com/jhpalmieri"
}
```

We could delete the docs in the Sphinx `spkg-install` script. We used to do this, but then at some point (#11665) we decided to try to keep the old docs.



---

archive/issue_comments_269725.json:
```json
{
    "body": "For example like this:\n\n```diff\ndiff --git a/build/pkgs/sphinx/spkg-install b/build/pkgs/sphinx/spkg-install\nindex 200965b566..05085aaa79 100644\n--- a/build/pkgs/sphinx/spkg-install\n+++ b/build/pkgs/sphinx/spkg-install\n@@ -23,6 +23,12 @@ $PIP_INSTALL .\n success 'Error installing Sphinx'\n echo\n \n+echo \"A new version of Sphinx was installed, so deleting old Sage documentation output...\"\n+echo \"Removing \\\"$SAGE_DOC\\\"...\"\n+rm -rf \"$SAGE_DOC\"\n+success 'Error removing the old documentation'\n+echo\n+\n cd \"$CUR\"\n echo \"Creating grammar pickle...\"\n sage-python23 create_grammar_pickle.py\n```",
    "created_at": "2017-09-07T17:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269725",
    "user": "https://github.com/jhpalmieri"
}
```

For example like this:

```diff
diff --git a/build/pkgs/sphinx/spkg-install b/build/pkgs/sphinx/spkg-install
index 200965b566..05085aaa79 100644
--- a/build/pkgs/sphinx/spkg-install
+++ b/build/pkgs/sphinx/spkg-install
@@ -23,6 +23,12 @@ $PIP_INSTALL .
 success 'Error installing Sphinx'
 echo
 
+echo "A new version of Sphinx was installed, so deleting old Sage documentation output..."
+echo "Removing \"$SAGE_DOC\"..."
+rm -rf "$SAGE_DOC"
+success 'Error removing the old documentation'
+echo
+
 cd "$CUR"
 echo "Creating grammar pickle..."
 sage-python23 create_grammar_pickle.py
```



---

archive/issue_comments_269726.json:
```json
{
    "body": "If this is a good idea, we can do it here or open another ticket.",
    "created_at": "2017-09-07T17:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269726",
    "user": "https://github.com/jhpalmieri"
}
```

If this is a good idea, we can do it here or open another ticket.



---

archive/issue_comments_269727.json:
```json
{
    "body": "I like the principle, but not the approach of using the Sphinx installer to remove the docs. It goes against seperation of concerns. Better would be to implement this in the docbuilder: find out the timestamp or version of the installed Sphinx and then take action.",
    "created_at": "2017-09-08T07:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269727",
    "user": "https://github.com/jdemeyer"
}
```

I like the principle, but not the approach of using the Sphinx installer to remove the docs. It goes against seperation of concerns. Better would be to implement this in the docbuilder: find out the timestamp or version of the installed Sphinx and then take action.



---

archive/issue_comments_269728.json:
```json
{
    "body": "See #23803",
    "created_at": "2017-09-08T07:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269728",
    "user": "https://github.com/jdemeyer"
}
```

See #23803



---

archive/issue_comments_269729.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-09-08T18:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269729",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_events_054341.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2017-09-08T18:39:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19882#event-54341"
}
```



---

archive/issue_events_054342.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2017-09-08T18:39:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19882#event-54342"
}
```



---

archive/issue_comments_269730.json:
```json
{
    "body": "Okay, let's close this.",
    "created_at": "2017-09-08T18:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269730",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, let's close this.



---

archive/issue_comments_269731.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-31T10:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269731",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_054343.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-12-12T08:23:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19882#event-54343"
}
```



---

archive/issue_comments_269732.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-12-12T08:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19882",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19882#issuecomment-269732",
    "user": "https://github.com/embray"
}
```

Resolution: wontfix
