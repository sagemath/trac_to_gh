# Issue 19172: More capable method `valuation` for polynomials

archive/issues_018935.json:
```json
{
    "body": "This ticket aims at improving the method `valuation` for polynomials in two ways:\n\n1. The method `valuation` for dense polynomials can be called in the following ways:\n   * Without argument, return the largest power of the variable that divides the input polynomial.\n   * With a polynomial (with the same parent) as argument, return the largest power of this polynomial which divides the input polynomial.\n\n   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the coefficients. This is consistent with PARI.\n\n2. The method `valuation` for sparse polynomials is much less capable than the method for dense polynomials. I propose to have the same behaviors in both cases.\n\nDepends on #19171\n\n**Keywords:** polynomial\n\n**Branch:** [u/roed/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/t19172_valuation)\n\n**Commit:** [aa040dca8974d3ae8c50d1694957fee0d2c6b0d4](https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4)\n\n**Work Issues:** Rebase\n\n**Author:** Bruno Grenet\n\nIssue created by migration from https://trac.sagemath.org/ticket/19172\n\n",
    "created_at": "2015-09-09T09:33:30Z",
    "labels": [
        "component: commutative algebra",
        "enhancement",
        "needs work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.1",
    "title": "More capable method `valuation` for polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/19172",
    "user": "https://github.com/bgrenet"
}
```
This ticket aims at improving the method `valuation` for polynomials in two ways:

1. The method `valuation` for dense polynomials can be called in the following ways:
   * Without argument, return the largest power of the variable that divides the input polynomial.
   * With a polynomial (with the same parent) as argument, return the largest power of this polynomial which divides the input polynomial.

   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the coefficients. This is consistent with PARI.

2. The method `valuation` for sparse polynomials is much less capable than the method for dense polynomials. I propose to have the same behaviors in both cases.

Depends on #19171

**Keywords:** polynomial

**Branch:** [u/roed/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/t19172_valuation)

**Commit:** [aa040dca8974d3ae8c50d1694957fee0d2c6b0d4](https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4)

**Work Issues:** Rebase

**Author:** Bruno Grenet

Issue created by migration from https://trac.sagemath.org/ticket/19172





---

archive/issue_comments_273865.json:
```json
{
    "body": "**Branch:** [u/bruno/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/t19172_valuation)",
    "created_at": "2015-10-12T12:42:56Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273865",
    "user": "https://github.com/bgrenet"
}
```

**Branch:** [u/bruno/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/t19172_valuation)



---

archive/issue_comments_273866.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a189c7bdc29953d6ada184f7b0db503c6da4677\">9a189c7</a></td><td><code>#19171: New method divides</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/62df3272f47b0cea860ab090a2a730bf033afc06\">62df327</a></td><td><code>#19172: Improve valuation for dense polynomials</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/66709eb884fcd888b059aa5fa0a221d95c20cbc0\">66709eb</a></td><td><code>#19172: Improve valuation for sparse polynomials</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d\">992ee7a</a></td><td><code>#19172: Add valuation for multipolynomials</code></td></tr></table>\n",
    "created_at": "2016-06-10T13:44:23Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a189c7bdc29953d6ada184f7b0db503c6da4677">9a189c7</a></td><td><code>#19171: New method divides</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/62df3272f47b0cea860ab090a2a730bf033afc06">62df327</a></td><td><code>#19172: Improve valuation for dense polynomials</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/66709eb884fcd888b059aa5fa0a221d95c20cbc0">66709eb</a></td><td><code>#19172: Improve valuation for sparse polynomials</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d">992ee7a</a></td><td><code>#19172: Add valuation for multipolynomials</code></td></tr></table>




---

archive/issue_comments_273867.json:
```json
{
    "body": "**Commit:** [992ee7afc702ca261d25706efb103db27518483d](https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d)",
    "created_at": "2016-06-10T13:44:23Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [992ee7afc702ca261d25706efb103db27518483d](https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d)



---

archive/issue_comments_273868.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d03a75e648111aa38b0059e571f9536b6f5c2152\">d03a75e</a></td><td><code>#19171: New method divides</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ac43c02c86eb8884bc3d7fa4013f78aef1e34803\">ac43c02</a></td><td><code>19171: Use coerce_binop</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0906dfd9801e14acab59d28999fe1778d3cc018d\">0906dfd</a></td><td><code>19171: Add more involved example + move a line</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/04b0032caff9204e2c3f7529ae6e56b8a98a2b1e\">04b0032</a></td><td><code>Merge branch 'develop' into 19171_divides_poly</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f85a7e06a7591101005f5e61fff674033344e103\">f85a7e0</a></td><td><code>19171: conflict resolution</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a0a5badfad9472555eb9b66776ae99ba99416047\">a0a5bad</a></td><td><code>Merge branch 'u/bruno/t19171_divides_poly' of git://trac.sagemath.org/sage into 19171_divides_poly</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559\">9a548ad</a></td><td><code>Merge branch '19171_divides_poly' into 19172_valuation</code></td></tr></table>\n",
    "created_at": "2017-07-25T14:18:35Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d03a75e648111aa38b0059e571f9536b6f5c2152">d03a75e</a></td><td><code>#19171: New method divides</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ac43c02c86eb8884bc3d7fa4013f78aef1e34803">ac43c02</a></td><td><code>19171: Use coerce_binop</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0906dfd9801e14acab59d28999fe1778d3cc018d">0906dfd</a></td><td><code>19171: Add more involved example + move a line</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/04b0032caff9204e2c3f7529ae6e56b8a98a2b1e">04b0032</a></td><td><code>Merge branch 'develop' into 19171_divides_poly</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f85a7e06a7591101005f5e61fff674033344e103">f85a7e0</a></td><td><code>19171: conflict resolution</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a0a5badfad9472555eb9b66776ae99ba99416047">a0a5bad</a></td><td><code>Merge branch 'u/bruno/t19171_divides_poly' of git://trac.sagemath.org/sage into 19171_divides_poly</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559">9a548ad</a></td><td><code>Merge branch '19171_divides_poly' into 19172_valuation</code></td></tr></table>




---

archive/issue_comments_273869.json:
```json
{
    "body": "**Changing commit** from \"[992ee7afc702ca261d25706efb103db27518483d](https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d)\" to \"[9a548adcf9a998a78254ba98df730b1311e9d559](https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559)\".",
    "created_at": "2017-07-25T14:18:35Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[992ee7afc702ca261d25706efb103db27518483d](https://github.com/sagemath/sagetrac-mirror/commit/992ee7afc702ca261d25706efb103db27518483d)" to "[9a548adcf9a998a78254ba98df730b1311e9d559](https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559)".



---

archive/issue_events_172688.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2017-07-25T14:18:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172688"
}
```



---

archive/issue_comments_273870.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"polynomial\".",
    "created_at": "2017-07-25T14:19:15Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273870",
    "user": "https://github.com/bgrenet"
}
```

**Changing keywords** from "" to "polynomial".



---

archive/issue_events_172689.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2017-07-25T14:19:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "milestone": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172689"
}
```



---

archive/issue_events_172690.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2017-07-25T14:19:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172690"
}
```



---

archive/issue_comments_273871.json:
```json
{
    "body": "<a id='comment:6'></a>\n\n```\nsage: R.<x,y,z> = ZZ[]\nsage: p = 4*x*y + z^2 - 9*x + 39*z\nsage: p.valuation(-2)\n...\nValueError: You can only compute the valuation with respect to a integer larger than 1.\n```\n\n```\nsage: R.<x,y,z> = QQ[]\nsage: p = 4*x*y + z^2 - 9*x + 39*z\nsage: p.valuation(1/2)\n...\nTypeError: no conversion of this rational to integer\n```",
    "created_at": "2017-07-27T10:11:36Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273871",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:6'></a>

```
sage: R.<x,y,z> = ZZ[]
sage: p = 4*x*y + z^2 - 9*x + 39*z
sage: p.valuation(-2)
...
ValueError: You can only compute the valuation with respect to a integer larger than 1.
```

```
sage: R.<x,y,z> = QQ[]
sage: p = 4*x*y + z^2 - 9*x + 39*z
sage: p.valuation(1/2)
...
TypeError: no conversion of this rational to integer
```



---

archive/issue_comments_273872.json:
```json
{
    "body": "<a id='comment:7'></a>\nI would be tempted to simplify the version in `multi_polynomial.pyx` roughly as follows (not tested!):\n\n```\n        if arg is None:\n            ex = self.exponents()\n            return tuple(min(e[i] for e in ex) for i in range(self.nvariables()))\n\n        arg = self.parent().coerce(arg)\n\n        if arg.is_constant():\n            arg = arg.constant_coefficient()\n            return min(c.valuation(arg) for c in self.coefficients())\n\n        try:\n            ind = self.parent().gens().index(arg)\n        except ValueError:\n            pass\n        else:\n            return min(e[ind] for e in self.exponents())\n\n        if arg.nvariables() == 1:\n            return self.polynomial(arg.variable(0)).valuation()\n\n        k = 0\n        tmp = arg\n        while tmp.divides(self):\n            k += 1\n            tmp *= arg\n        return k\n```\n\nAlso, I wonder if actually performing the exact division (and replacing self with the quotient) at each loop turn wouldn't be better, but this is generic code any case, I don't think that it matters much.",
    "created_at": "2017-07-27T14:04:46Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273872",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
I would be tempted to simplify the version in `multi_polynomial.pyx` roughly as follows (not tested!):

```
        if arg is None:
            ex = self.exponents()
            return tuple(min(e[i] for e in ex) for i in range(self.nvariables()))

        arg = self.parent().coerce(arg)

        if arg.is_constant():
            arg = arg.constant_coefficient()
            return min(c.valuation(arg) for c in self.coefficients())

        try:
            ind = self.parent().gens().index(arg)
        except ValueError:
            pass
        else:
            return min(e[ind] for e in self.exponents())

        if arg.nvariables() == 1:
            return self.polynomial(arg.variable(0)).valuation()

        k = 0
        tmp = arg
        while tmp.divides(self):
            k += 1
            tmp *= arg
        return k
```

Also, I wonder if actually performing the exact division (and replacing self with the quotient) at each loop turn wouldn't be better, but this is generic code any case, I don't think that it matters much.



---

archive/issue_comments_273873.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe pyflakes plugin rightfully complains about the fact that in this changeset\n\n```diff\n@@ -200,9 +200,17 @@ class Polynomial_generic_sparse(Polynomial):\n             sage: R(0).valuation()\n             +Infinity\n         \"\"\"\n-        if not self.__coeffs:\n+        if not self:\n             return infinity\n-        return ZZ(min(self.__coeffs))\n+\n+        if p is infinity:\n+            return -self.degree()\n+\n+        if p is None:\n+            c = self.__coeffs.keys()\n+            return ZZ(min(self.__coeffs.keys()))\n+\n+        return Polynomial.valuation(self, p)\n \n```\nthe variable `c` is defined but not used. In fact, the corresponding line can just be deleted. I can do it as a reviewer patch. Since the tests pass for the patchbots, I can then see if I give it a positive review (need to look more closely at the code first).",
    "created_at": "2019-07-26T08:04:36Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273873",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
The pyflakes plugin rightfully complains about the fact that in this changeset

```diff
@@ -200,9 +200,17 @@ class Polynomial_generic_sparse(Polynomial):
             sage: R(0).valuation()
             +Infinity
         """
-        if not self.__coeffs:
+        if not self:
             return infinity
-        return ZZ(min(self.__coeffs))
+
+        if p is infinity:
+            return -self.degree()
+
+        if p is None:
+            c = self.__coeffs.keys()
+            return ZZ(min(self.__coeffs.keys()))
+
+        return Polynomial.valuation(self, p)
 
```
the variable `c` is defined but not used. In fact, the corresponding line can just be deleted. I can do it as a reviewer patch. Since the tests pass for the patchbots, I can then see if I give it a positive review (need to look more closely at the code first).



---

archive/issue_comments_273874.json:
```json
{
    "body": "<a id='comment:9'></a>\nAlso I was told by Vincent Delecroix that it would be better (since this is a rather old ticket based on a very old branch) to rebase it on top of the latest develop (not merging develop, he said).",
    "created_at": "2019-07-26T08:14:51Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273874",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Also I was told by Vincent Delecroix that it would be better (since this is a rather old ticket based on a very old branch) to rebase it on top of the latest develop (not merging develop, he said).



---

archive/issue_comments_273875.json:
```json
{
    "body": "<a id='comment:10'></a>\nThe first commit that is shown for the branch of this ticket is named `#19171: New method divides`.\n\nDo I understand correctly that this commit was originally intended for #19171, but didn't get merged after all? So, my review will about this one as well.\n\nEDIT: It is rather strange that the topic of #19171 was \"Add a method 'divide' to Polynomial\", and the commit adding the \"New method divides\" was not merged.",
    "created_at": "2019-07-26T08:24:48Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273875",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
The first commit that is shown for the branch of this ticket is named `#19171: New method divides`.

Do I understand correctly that this commit was originally intended for #19171, but didn't get merged after all? So, my review will about this one as well.

EDIT: It is rather strange that the topic of #19171 was "Add a method 'divide' to Polynomial", and the commit adding the "New method divides" was not merged.



---

archive/issue_comments_273876.json:
```json
{
    "body": "<a id='comment:11'></a>\nNot good. When trying to rebase on top of develop, there is a merge conflict with the commit from #19171",
    "created_at": "2019-07-26T08:33:24Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273876",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
Not good. When trying to rebase on top of develop, there is a merge conflict with the commit from #19171



---

archive/issue_comments_273877.json:
```json
{
    "body": "<a id='comment:12'></a>\nWhat I am trying now is whether the suspicious commit is needed at all.",
    "created_at": "2019-07-26T09:23:52Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273877",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>
What I am trying now is whether the suspicious commit is needed at all.



---

archive/issue_events_172691.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-07-26T09:35:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172691"
}
```



---

archive/issue_events_172692.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-07-26T09:35:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172692"
}
```



---

archive/issue_comments_273878.json:
```json
{
    "body": "**Work Issues:** Rebase",
    "created_at": "2019-07-26T09:35:06Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273878",
    "user": "https://github.com/simon-king-jena"
}
```

**Work Issues:** Rebase



---

archive/issue_comments_273879.json:
```json
{
    "body": "<a id='comment:13'></a>\nSorry, it gets too complicated. Leaving out the [commit named \"#19171: New method divides\"](https://github.com/sagemath/sagetrac-mirror/commit/9a189c7bdc29953d6ada184f7b0db503c6da4677) didn't solve the problem, as the second commit didn't merge either.\n\nSo, I think I will not continue to try and rebase it, and I'd appreciate if the author did.",
    "created_at": "2019-07-26T09:35:06Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273879",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Sorry, it gets too complicated. Leaving out the [commit named "#19171: New method divides"](https://github.com/sagemath/sagetrac-mirror/commit/9a189c7bdc29953d6ada184f7b0db503c6da4677) didn't solve the problem, as the second commit didn't merge either.

So, I think I will not continue to try and rebase it, and I'd appreciate if the author did.



---

archive/issue_comments_273880.json:
```json
{
    "body": "<a id='comment:14'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/71e424ba0331b826f7b44d09b3d444d8ecd6511f\">71e424b</a></td><td><code>19172: Improve valuation for dense polynomials</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/693f229214381be08d177c18bb9ff21cd70858c7\">693f229</a></td><td><code>19172: Improve valuation for sparse polynomials</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9\">3318489</a></td><td><code>#19172: Add valuation for multipolynomials</code></td></tr></table>\n",
    "created_at": "2019-08-21T12:22:32Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273880",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/71e424ba0331b826f7b44d09b3d444d8ecd6511f">71e424b</a></td><td><code>19172: Improve valuation for dense polynomials</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/693f229214381be08d177c18bb9ff21cd70858c7">693f229</a></td><td><code>19172: Improve valuation for sparse polynomials</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9">3318489</a></td><td><code>#19172: Add valuation for multipolynomials</code></td></tr></table>




---

archive/issue_comments_273881.json:
```json
{
    "body": "**Changing commit** from \"[9a548adcf9a998a78254ba98df730b1311e9d559](https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559)\" to \"[331848976b65c64ca362aca5babcb18e24db9dd9](https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9)\".",
    "created_at": "2019-08-21T12:22:32Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273881",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9a548adcf9a998a78254ba98df730b1311e9d559](https://github.com/sagemath/sagetrac-mirror/commit/9a548adcf9a998a78254ba98df730b1311e9d559)" to "[331848976b65c64ca362aca5babcb18e24db9dd9](https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9)".



---

archive/issue_events_172693.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2019-08-21T12:28:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172693"
}
```



---

archive/issue_events_172694.json:
```json
{
    "actor": "https://github.com/bgrenet",
    "created_at": "2019-08-21T12:28:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172694"
}
```



---

archive/issue_comments_273882.json:
```json
{
    "body": "<a id='comment:15'></a>\nHi Simon, I've rebased on develop. It should be OK now.",
    "created_at": "2019-08-21T12:28:15Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273882",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:15'></a>
Hi Simon, I've rebased on develop. It should be OK now.



---

archive/issue_comments_273883.json:
```json
{
    "body": "Replying to [ticket:19172 bruno]:\n>   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.\n\nI don't understand what that specification means. Valuation has two arguments, namely `self` and `arg` resp. `p`. So, if the argument (`p`?) is an element of the base ring of \"the parent\" (the parent of `self`?) then it returns the minimum of the valuations of the arguments (i.e., of `self` and of `p` --- but with respect to what shall the valuation of `self` be taken? And what do you do if the base ring of the parent does not support a valuation, so that the valuation of `p` is not defined?).\nI am sure you mean something else, but this is what I understood from your specification.",
    "created_at": "2019-08-21T13:00:44Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273883",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [ticket:19172 bruno]:
>   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.

I don't understand what that specification means. Valuation has two arguments, namely `self` and `arg` resp. `p`. So, if the argument (`p`?) is an element of the base ring of "the parent" (the parent of `self`?) then it returns the minimum of the valuations of the arguments (i.e., of `self` and of `p` --- but with respect to what shall the valuation of `self` be taken? And what do you do if the base ring of the parent does not support a valuation, so that the valuation of `p` is not defined?).
I am sure you mean something else, but this is what I understood from your specification.



---

archive/issue_comments_273884.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,6 +4,6 @@\n    * Without argument, return the largest power of the variable that divides the input polynomial.\n    * With a polynomial (with the same parent) as argument, return the largest power of this polynomial which divides the input polynomial.\n \n-   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.\n+   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the coefficients. This is consistent with PARI.\n \n 2. The method `valuation` for sparse polynomials is much less capable than the method for dense polynomials. I propose to have the same behaviors in both cases.\n``````\n",
    "created_at": "2019-08-21T13:47:07Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273884",
    "user": "https://github.com/bgrenet"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,6 +4,6 @@
    * Without argument, return the largest power of the variable that divides the input polynomial.
    * With a polynomial (with the same parent) as argument, return the largest power of this polynomial which divides the input polynomial.
 
-   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.
+   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the coefficients. This is consistent with PARI.
 
 2. The method `valuation` for sparse polynomials is much less capable than the method for dense polynomials. I propose to have the same behaviors in both cases.
``````




---

archive/issue_comments_273885.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [SimonKing](#comment%3A16):\n> Replying to [ticket:19172 bruno]:\n> >   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.\n\n> \n> I don't understand what that specification means. Valuation has two arguments, namely `self` and `arg` resp. `p`. So, if the argument (`p`?) is an element of the base ring of \"the parent\" (the parent of `self`?) then it returns the minimum of the valuations of the arguments (i.e., of `self` and of `p` --- but with respect to what shall the valuation of `self` be taken? And what do you do if the base ring of the parent does not support a valuation, so that the valuation of `p` is not defined?).\n> I am sure you mean something else, but this is what I understood from your specification.\n>  \n\nThere was a typo: I meant \"it returns the minimum of the valuations of the coefficients.\" So it means that if `self` is a polynomial over a ring `R` and `p` is an element of `R`, `self.valuation(p)` computes for each coefficient of `self` its valuation with respect to `p` and returns the minimum of these values. This is very convenient when working over `QQ['x']['y']` and asking the valuation with respect to `'x'`, or even over `ZZ['x']` and asking for the valuation with respect to any prime number.\n\nOf course, this implies that the base ring must have a method `valuation`. The ticket is rather old so I don't have everything fresh in my memory, but do we have examples of rings that do not have such a method?",
    "created_at": "2019-08-21T13:47:07Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273885",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:17'></a>
Replying to [SimonKing](#comment%3A16):
> Replying to [ticket:19172 bruno]:
> >   I propose to allow another possible argument: If the argument is an element of the base ring of the parent, it returns the minimum of the valuations of the arguments. This is consistent with PARI.

> 
> I don't understand what that specification means. Valuation has two arguments, namely `self` and `arg` resp. `p`. So, if the argument (`p`?) is an element of the base ring of "the parent" (the parent of `self`?) then it returns the minimum of the valuations of the arguments (i.e., of `self` and of `p` --- but with respect to what shall the valuation of `self` be taken? And what do you do if the base ring of the parent does not support a valuation, so that the valuation of `p` is not defined?).
> I am sure you mean something else, but this is what I understood from your specification.
>  

There was a typo: I meant "it returns the minimum of the valuations of the coefficients." So it means that if `self` is a polynomial over a ring `R` and `p` is an element of `R`, `self.valuation(p)` computes for each coefficient of `self` its valuation with respect to `p` and returns the minimum of these values. This is very convenient when working over `QQ['x']['y']` and asking the valuation with respect to `'x'`, or even over `ZZ['x']` and asking for the valuation with respect to any prime number.

Of course, this implies that the base ring must have a method `valuation`. The ticket is rather old so I don't have everything fresh in my memory, but do we have examples of rings that do not have such a method?



---

archive/issue_comments_273886.json:
```json
{
    "body": "**Changing branch** from \"[u/bruno/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/t19172_valuation)\" to \"[u/roed/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/t19172_valuation)\".",
    "created_at": "2021-05-12T20:56:09Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273886",
    "user": "https://github.com/roed314"
}
```

**Changing branch** from "[u/bruno/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/t19172_valuation)" to "[u/roed/t19172_valuation](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/t19172_valuation)".



---

archive/issue_comments_273887.json:
```json
{
    "body": "<a id='comment:19'></a>\nIf you wanted to do some micro-optimizations, you can do:\n\n```diff\n               raise NotImplementedError\n \n+       P = parent(p) # the function from sage.structure.element is faster\n+\n-       if is_FractionField(p.parent()):\n+       if is_FractionField(P):\n             if p.denominator().is_unit():\n                 p = p.numerator()\n+                P = parent(p)\n             else:\n                 raise TypeError(\"The denominator should be a unit.\")\n \n-        if self.base_ring().has_coerce_map_from(p.parent()):\n-            return min(c.valuation(p) for c in self.coefficients())\n+        if self._parent._base.has_coerce_map_from(P):\n+            return min(self.get_unsafe(k).valuation(p)\n+                       for k in range(self.degree()+1)\n+                       if self.get_unsafe(k))\n \n-        elif self.parent().has_coerce_map_from(p.parent()):\n-            p = self.parent().coerce(p)\n+        elif self._parent.has_coerce_map_from(P):\n+            p = self._parent.coerce(p)\n             k = 0\n             while p.divides(self):\n                 k += 1\n-                self = self.__floordiv__(p)\n+                self = self._floordiv_(p)  # Same parent\n```\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9e7c501967751cd83e16c1476725734cb9a9c0b6\">9e7c501</a></td><td><code>Merge branch 'u/bruno/t19172_valuation' of git://trac.sagemath.org/sage into t/19172/valuation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259\">fddb76a</a></td><td><code>Add a few more tests, fix plugin errors</code></td></tr></table>\n",
    "created_at": "2021-05-13T02:59:04Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273887",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>
If you wanted to do some micro-optimizations, you can do:

```diff
               raise NotImplementedError
 
+       P = parent(p) # the function from sage.structure.element is faster
+
-       if is_FractionField(p.parent()):
+       if is_FractionField(P):
             if p.denominator().is_unit():
                 p = p.numerator()
+                P = parent(p)
             else:
                 raise TypeError("The denominator should be a unit.")
 
-        if self.base_ring().has_coerce_map_from(p.parent()):
-            return min(c.valuation(p) for c in self.coefficients())
+        if self._parent._base.has_coerce_map_from(P):
+            return min(self.get_unsafe(k).valuation(p)
+                       for k in range(self.degree()+1)
+                       if self.get_unsafe(k))
 
-        elif self.parent().has_coerce_map_from(p.parent()):
-            p = self.parent().coerce(p)
+        elif self._parent.has_coerce_map_from(P):
+            p = self._parent.coerce(p)
             k = 0
             while p.divides(self):
                 k += 1
-                self = self.__floordiv__(p)
+                self = self._floordiv_(p)  # Same parent
```

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9e7c501967751cd83e16c1476725734cb9a9c0b6">9e7c501</a></td><td><code>Merge branch 'u/bruno/t19172_valuation' of git://trac.sagemath.org/sage into t/19172/valuation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259">fddb76a</a></td><td><code>Add a few more tests, fix plugin errors</code></td></tr></table>




---

archive/issue_comments_273888.json:
```json
{
    "body": "**Changing commit** from \"[331848976b65c64ca362aca5babcb18e24db9dd9](https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9)\" to \"[fddb76a98ebac152e332dbf79774410ecd86e259](https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259)\".",
    "created_at": "2021-05-13T02:59:04Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273888",
    "user": "https://github.com/tscrim"
}
```

**Changing commit** from "[331848976b65c64ca362aca5babcb18e24db9dd9](https://github.com/sagemath/sagetrac-mirror/commit/331848976b65c64ca362aca5babcb18e24db9dd9)" to "[fddb76a98ebac152e332dbf79774410ecd86e259](https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259)".



---

archive/issue_comments_273889.json:
```json
{
    "body": "<a id='comment:20'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4\">aa040dc</a></td><td><code>Incorporate Travis' suggestions</code></td></tr></table>\n",
    "created_at": "2021-05-13T04:22:46Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4">aa040dc</a></td><td><code>Incorporate Travis' suggestions</code></td></tr></table>




---

archive/issue_comments_273890.json:
```json
{
    "body": "**Changing commit** from \"[fddb76a98ebac152e332dbf79774410ecd86e259](https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259)\" to \"[aa040dca8974d3ae8c50d1694957fee0d2c6b0d4](https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4)\".",
    "created_at": "2021-05-13T04:22:46Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[fddb76a98ebac152e332dbf79774410ecd86e259](https://github.com/sagemath/sagetrac-mirror/commit/fddb76a98ebac152e332dbf79774410ecd86e259)" to "[aa040dca8974d3ae8c50d1694957fee0d2c6b0d4](https://github.com/sagemath/sagetrac-mirror/commit/aa040dca8974d3ae8c50d1694957fee0d2c6b0d4)".



---

archive/issue_events_172695.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-16T21:18:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172695"
}
```



---

archive/issue_events_172696.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-16T21:18:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/19172#event-172696"
}
```



---

archive/issue_comments_273891.json:
```json
{
    "body": "<a id='comment:21'></a>\nWhat is intended for the corner cases\n\n```\nsage: ZZ['x'].gen().valuation(1)\nsage: ZZ['x'].zero().valuation(0)\nsage: ZZ['x'].zero().valuation(1)\n```\n(the code is not careful enough: min of empty sequence or infinite loop)\n\nThe above must appear in doctests.",
    "created_at": "2021-05-16T21:18:57Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273891",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>
What is intended for the corner cases

```
sage: ZZ['x'].gen().valuation(1)
sage: ZZ['x'].zero().valuation(0)
sage: ZZ['x'].zero().valuation(1)
```
(the code is not careful enough: min of empty sequence or infinite loop)

The above must appear in doctests.



---

archive/issue_comments_273892.json:
```json
{
    "body": "<a id='comment:22'></a>\nThe following `if arg not in self.parent()` is not a good idea as the method `__contains__` is not supposed to be useful in any meaningful way. You could replace the whole block\n\n```\n        if arg not in self.parent():\n            if self.parent().has_coerce_map_from(arg.parent()):\n                arg = self.parent()(arg)\n            else:\n                raise TypeError(\"The parent of the polynomial {} is not {}\".format(arg,self.parent()))\n```\nby the one line\n\n```\narg = self.parent().coerce(arg)\n```",
    "created_at": "2021-05-16T21:20:50Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273892",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>
The following `if arg not in self.parent()` is not a good idea as the method `__contains__` is not supposed to be useful in any meaningful way. You could replace the whole block

```
        if arg not in self.parent():
            if self.parent().has_coerce_map_from(arg.parent()):
                arg = self.parent()(arg)
            else:
                raise TypeError("The parent of the polynomial {} is not {}".format(arg,self.parent()))
```
by the one line

```
arg = self.parent().coerce(arg)
```



---

archive/issue_comments_273893.json:
```json
{
    "body": "<a id='comment:23'></a>\nSimilarly, `if arg in self.base_ring():` is not good\n\n```\nsage: QQ.one() in ZZ\nTrue\n```",
    "created_at": "2021-05-16T21:21:31Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273893",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>
Similarly, `if arg in self.base_ring():` is not good

```
sage: QQ.one() in ZZ
True
```



---

archive/issue_comments_273894.json:
```json
{
    "body": "<a id='comment:24'></a>\nFor multivariate polynomials why not use the simpler template\n\n```\nif arg is None:\n   ...\n\narg = parent.coerce(arg)\nif arg.is_zero():\n    ...\nelif self.is_zero():\n    ...\nelif arg.is_constant():\n    ...\nelif arg.is_generator():\n    ...\n# etc \n```",
    "created_at": "2021-05-16T21:27:40Z",
    "issue": "https://github.com/sagemath/sage/issues/19172",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/19172#issuecomment-273894",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>
For multivariate polynomials why not use the simpler template

```
if arg is None:
   ...

arg = parent.coerce(arg)
if arg.is_zero():
    ...
elif self.is_zero():
    ...
elif arg.is_constant():
    ...
elif arg.is_generator():
    ...
# etc 
```
