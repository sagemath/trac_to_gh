# Issue 19597: General code cleanup: avoid code like x.__eq__(y)

archive/issues_019360.json:
```json
{
    "body": "Replace code of the form\n\n```\nx.__eq__(y)\nx.__len__()\nx.__getitem__(y)\nx.__contains__(y)\n...\n```\nby\n\n```\nx == y\nlen(x)\nx[y]\ny in x\n...\n```\nbecause the latter are more efficient.\n\nThe obvious exceptions are `super()` calls and `Class.__method__(...)` calls.\n\nIn a few cases, we reorganize the code to avoid special functions/methods altogether:\n1. for `__repr__()`, we instead change `%s` to `%r` for `%`-formatting and `{}` to `{!r}` for `.format()`.\n2. certain calls to `__iter__()` can be changed to a simple list comprehension.\n3. there are subtle differences between `x.__eq__(y)` and `x == y` and in certain technical cases they do matter.\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nBranch: 4a950ac85c2e083d93b2f5037b2c8ed329c25bea\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/19597\n\n",
    "closed_at": "2015-11-30T23:09:34Z",
    "created_at": "2015-11-18T13:34:19Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "General code cleanup: avoid code like x.__eq__(y)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19597",
    "user": "https://github.com/jdemeyer"
}
```
Replace code of the form

```
x.__eq__(y)
x.__len__()
x.__getitem__(y)
x.__contains__(y)
...
```
by

```
x == y
len(x)
x[y]
y in x
...
```
because the latter are more efficient.

The obvious exceptions are `super()` calls and `Class.__method__(...)` calls.

In a few cases, we reorganize the code to avoid special functions/methods altogether:
1. for `__repr__()`, we instead change `%s` to `%r` for `%`-formatting and `{}` to `{!r}` for `.format()`.
2. certain calls to `__iter__()` can be changed to a simple list comprehension.
3. there are subtle differences between `x.__eq__(y)` and `x == y` and in certain technical cases they do matter.

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Branch: 4a950ac85c2e083d93b2f5037b2c8ed329c25bea

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/19597





---

archive/issue_comments_265705.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-11-19T02:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265705",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_265706.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-11-19T02:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265706",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_265707.json:
```json
{
    "body": "<a id='comment:9'></a>Could you comment more on this two changes\n\n```diff\ndiff --git a/src/sage/coding/codecan/codecan.pyx b/src/sage/coding/codecan/codecan.pyx\nindex 4d092d1..7b0bec3 100644\n--- a/src/sage/coding/codecan/codecan.pyx\n+++ b/src/sage/coding/codecan/codecan.pyx\n@@ -803,7 +803,6 @@ cdef class PartitionRefinementLinearCode(PartitionRefinement_generic):\n         self._hyp_refine_vals_scratch = <long *> sage_malloc(\n                             self._hyp_part.degree * sizeof(long))\n         if self._hyp_refine_vals_scratch is NULL:\n-            self.__dealloc__()\n             raise MemoryError('allocating PartitionRefinementLinearCode')\n \n         self._hyp_refine_vals = _BestValStore(self._hyp_part.degree)\n```\n\n\n```diff\ndiff --git a/src/sage/combinat/crystals/tensor_product.py b/src/sage/combinat/crystals/tensor_product.py\nindex 9596832..f3d277b 100644\n--- a/src/sage/combinat/crystals/tensor_product.py\n+++ b/src/sage/combinat/crystals/tensor_product.py\n\n@@ -199,9 +199,7 @@ class ImmutableListWithParent(CombinatorialElement):\n             sage: m <= n\n             True\n         \"\"\"\n-        if self == other:\n-            return True\n-        return self.__lt__(other)\n+        return self == other or self.__lt__(other)\n \n     def __gt__(self, other):\n\n@@ -237,9 +235,7 @@ class ImmutableListWithParent(CombinatorialElement):\n             sage: m >= n\n             False\n         \"\"\"\n-        if self == other:\n-            return True\n-        return self.__gt__(other)\n+        return self == other or self.__gt__(other)\n \n     def sibling(self, l):\n```\n\nMore comments:\n\n`combinat/root_system/weyl_characters.py`: a very strange way to compute powers `self * self ** (n-1)`. I guess that generic power would be better here!\n\n`groups/perm_gps/permgroup.py`: Is there any difference between `list(L)` and `[x for x in L]`? As far as I understand `list` is smarter and call for `__len__` to allocate directly the right amount of memory. Whereas the second uses `.append`.",
    "created_at": "2015-11-23T15:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265707",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>Could you comment more on this two changes

```diff
diff --git a/src/sage/coding/codecan/codecan.pyx b/src/sage/coding/codecan/codecan.pyx
index 4d092d1..7b0bec3 100644
--- a/src/sage/coding/codecan/codecan.pyx
+++ b/src/sage/coding/codecan/codecan.pyx
@@ -803,7 +803,6 @@ cdef class PartitionRefinementLinearCode(PartitionRefinement_generic):
         self._hyp_refine_vals_scratch = <long *> sage_malloc(
                             self._hyp_part.degree * sizeof(long))
         if self._hyp_refine_vals_scratch is NULL:
-            self.__dealloc__()
             raise MemoryError('allocating PartitionRefinementLinearCode')
 
         self._hyp_refine_vals = _BestValStore(self._hyp_part.degree)
```


```diff
diff --git a/src/sage/combinat/crystals/tensor_product.py b/src/sage/combinat/crystals/tensor_product.py
index 9596832..f3d277b 100644
--- a/src/sage/combinat/crystals/tensor_product.py
+++ b/src/sage/combinat/crystals/tensor_product.py

@@ -199,9 +199,7 @@ class ImmutableListWithParent(CombinatorialElement):
             sage: m <= n
             True
         """
-        if self == other:
-            return True
-        return self.__lt__(other)
+        return self == other or self.__lt__(other)
 
     def __gt__(self, other):

@@ -237,9 +235,7 @@ class ImmutableListWithParent(CombinatorialElement):
             sage: m >= n
             False
         """
-        if self == other:
-            return True
-        return self.__gt__(other)
+        return self == other or self.__gt__(other)
 
     def sibling(self, l):
```

More comments:

`combinat/root_system/weyl_characters.py`: a very strange way to compute powers `self * self ** (n-1)`. I guess that generic power would be better here!

`groups/perm_gps/permgroup.py`: Is there any difference between `list(L)` and `[x for x in L]`? As far as I understand `list` is smarter and call for `__len__` to allocate directly the right amount of memory. Whereas the second uses `.append`.



---

archive/issue_comments_265708.json:
```json
{
    "body": "<a id='comment:10'></a>About `__dealloc__`: there is no `__dealloc__` method, it's a \"fake\" Cython method just like `__cinit__`. It's just not possible to call it.\n\nIn `src/sage/combinat/crystals/tensor_product.py`, you are probably wondering why I still use `__lt__` instead of `<` for example. That's because the `__lt__` method can return `NotImplemented`. In this case, the output of `x < y` is not the same as `x.__lt__(y)`.",
    "created_at": "2015-11-29T11:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265708",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>About `__dealloc__`: there is no `__dealloc__` method, it's a "fake" Cython method just like `__cinit__`. It's just not possible to call it.

In `src/sage/combinat/crystals/tensor_product.py`, you are probably wondering why I still use `__lt__` instead of `<` for example. That's because the `__lt__` method can return `NotImplemented`. In this case, the output of `x < y` is not the same as `x.__lt__(y)`.



---

archive/issue_comments_265709.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 vdelecroix]:\n> `groups/perm_gps/permgroup.py`: Is there any difference between `list(L)` and `[x for x in L]`? As far as I understand `list` is smarter and call for `__len__` to allocate directly the right amount of memory. Whereas the second uses `.append`.\n\n\nThat's true in general, however: there is no `__len__` implemented in this case. There is a generic `__len__` coming from `Parent` but that calls `len(self.list())` which would lead to an infinite loop. So I think that `[x for x in L]` is the most efficient way to create the list here.\n\nThat's probably also the reason the old code was written like `list(self.__iter__())` and not `list(self)`.",
    "created_at": "2015-11-29T11:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265709",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:9 vdelecroix]:
> `groups/perm_gps/permgroup.py`: Is there any difference between `list(L)` and `[x for x in L]`? As far as I understand `list` is smarter and call for `__len__` to allocate directly the right amount of memory. Whereas the second uses `.append`.


That's true in general, however: there is no `__len__` implemented in this case. There is a generic `__len__` coming from `Parent` but that calls `len(self.list())` which would lead to an infinite loop. So I think that `[x for x in L]` is the most efficient way to create the list here.

That's probably also the reason the old code was written like `list(self.__iter__())` and not `list(self)`.



---

archive/issue_comments_265710.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 jdemeyer]:\n> In `src/sage/combinat/crystals/tensor_product.py`, you are probably wondering why I still use `__lt__` instead of `<` for example. That's because the `__lt__` method can return `NotImplemented`. In this case, the output of `x < y` is not the same as `x.__lt__(y)`.\n\n\nLet me also mention that this is the only place in Sage where a comparison method `__lt__`, `__gt__`, `__le__` or `__ge__` returns `NotImplemented`.\n\nIn `src/sage/combinat/words/abstract_word.py`, there is an `__eq__` which can return `NotImplemented`, but I don't think there is a problem there: I believe calling `self == other` in `__ne__` is still the right thing to do.\n\nAnd there are several other places where a `__richcmp__` can return `NotImplemented` but those are not affected by this ticket.",
    "created_at": "2015-11-29T11:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265710",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:10 jdemeyer]:
> In `src/sage/combinat/crystals/tensor_product.py`, you are probably wondering why I still use `__lt__` instead of `<` for example. That's because the `__lt__` method can return `NotImplemented`. In this case, the output of `x < y` is not the same as `x.__lt__(y)`.


Let me also mention that this is the only place in Sage where a comparison method `__lt__`, `__gt__`, `__le__` or `__ge__` returns `NotImplemented`.

In `src/sage/combinat/words/abstract_word.py`, there is an `__eq__` which can return `NotImplemented`, but I don't think there is a problem there: I believe calling `self == other` in `__ne__` is still the right thing to do.

And there are several other places where a `__richcmp__` can return `NotImplemented` but those are not affected by this ticket.



---

archive/issue_comments_265711.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:9 vdelecroix]:\n> `combinat/root_system/weyl_characters.py`: a very strange way to compute powers `self * self ** (n-1)`. I guess that generic power would be better here!\n\n\nIt's apparently intentional. The doc says that it's more efficient to compute `a*(a*(a*a))` than `(a*a)*(a*a)`. Still, I can change the code to use a loop instead of recursion.",
    "created_at": "2015-11-29T11:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265711",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:9 vdelecroix]:
> `combinat/root_system/weyl_characters.py`: a very strange way to compute powers `self * self ** (n-1)`. I guess that generic power would be better here!


It's apparently intentional. The doc says that it's more efficient to compute `a*(a*(a*a))` than `(a*a)*(a*a)`. Still, I can change the code to use a loop instead of recursion.



---

archive/issue_comments_265712.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-29T11:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_265713.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-29T14:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265713",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_053901.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-11-30T23:09:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19597#event-53901"
}
```



---

archive/issue_comments_265714.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-30T23:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265714",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_265715.json:
```json
{
    "body": "<a id='comment:17'></a>that was a bit too quick, and broke some optional doctests, see\nhttps://groups.google.com/d/msg/sage-release/rLaGmnQ-FgY/mR91V4K0BAAJ",
    "created_at": "2015-12-16T09:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265715",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>that was a bit too quick, and broke some optional doctests, see
https://groups.google.com/d/msg/sage-release/rLaGmnQ-FgY/mR91V4K0BAAJ



---

archive/issue_comments_265716.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 dimpase]:\n> that was a bit too quick, and broke some optional doctests\n\nWell, there wasn't a single non-optional doctest for `str(<libgap object>)`.\n\nThe issue is fixed at #19733 and needs review.",
    "created_at": "2015-12-16T09:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19597#issuecomment-265716",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:17 dimpase]:
> that was a bit too quick, and broke some optional doctests

Well, there wasn't a single non-optional doctest for `str(<libgap object>)`.

The issue is fixed at #19733 and needs review.
