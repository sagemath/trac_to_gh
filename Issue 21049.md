# Issue 21049: Improve printing of FDerivative by adapting the appropriate hook in PyNaC

Issue created by migration from https://trac.sagemath.org/ticket/21286

Original creator: nbruin

Original creation time: 2016-08-18 20:06:25

CC:  rws bpage egourgoulhon

As Bill Page points out on:

https://github.com/pynac/pynac/issues/187

PyNaC does provide a special hook for printing FDerivative expressions. The relevant routine py_print_fderivative lives in
src/sage/symbolic/pynac.pyx, on line 583 (or thereabouts).

It look likes an expression `D[*params](f)(*args)` would get printed using a call of the form

```
py_print_fderivative(<id of f>,params,args)
```

so we'd have enough information to decide if `args` consist of distinct simple variables, in which case we could print it as

```
diff(f(*args),[args[i] for i in params])
```

or something nicer.


---

Comment by nbruin created at 2016-08-18 21:34:07

After finally tracking down where the hook for this exists, the actual change only requires a few lines. With the attached POC branch:

```
sage: var('x,y'); function('f')
sage: diff(f(y,x),x, y)
diff(f(y, x), y, x)
sage: diff(f(x+y,x-y),x,y)
D[0, 0](f)(x + y, x - y) - D[1, 1](f)(x + y, x - y)
```

so we get more intuitive printing when argument positions are easily determined by variable names, and revert to unambiguous notation if not. For univariate we do have:

```
sage: diff(f(sin(x)),x)
cos(x)*diff(f(sin(x)), sin(x))
```

of course, actual printing styles can be adapted.
----
New commits:


---

Comment by git created at 2016-08-30 00:54:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2016-08-30 00:59:21

OK, I think this is a reasonable start that's ready to be merged. In many common cases, expressions containing an FDerivative operator will be printed in a way that's valid input (an appropriate "diff" expression). The latex should look nice in those cases as well.

Other options can be tried and bikeshedded later on follow-up tickets. This at least should alleviate the worst complaints about printing derivatives.


---

Comment by nbruin created at 2016-08-30 00:59:21

Changing status from new to needs_review.


---

Comment by bpage created at 2016-08-30 02:10:47

Thank you!  I checked out this ticket and am just starting to look at it... already I like it. Great work.


---

Comment by egourgoulhon created at 2016-08-30 13:10:21

I also gave a look at it; it looks very good (in particular I've checked the LaTeX output in this [jupyter notebook](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/test_derivative_print.ipynb)). Thanks for this improvement!
There remains to replace \partial by \mathrm{d} in the LaTeX output for the univariate case, but this might be deferred to some follow-up ticket. 

A question: shouldn't the change be documentated by some doctest in `src/sage/symbolic/pynac.pyx`?


---

Comment by rws created at 2016-08-30 15:33:20

Changing status from needs_review to positive_review.


---

Comment by rws created at 2016-08-30 15:33:20

Replying to [comment:11 egourgoulhon]:
> A question: shouldn't the change be documentated by some doctest in `src/sage/symbolic/pynac.pyx`?

The changed doctests with the new output suffice absolutely.

As the output is deemed satisfactory by reviewers, the `pynac.pyx` looks good, and `make ptestlong` passes, I'll set positive now. Thanks for the work.


---

Comment by nbruin created at 2016-08-30 16:29:51

Thanks for the quick review. Once this is merged, we can close #6344 and possibly some other tickets.

Concerning printing a "\mathrm{d}" rather than "\partial": yes, I think that's a nice refinement to make in a follow-up ticket. That might also be a place to start thinking about when function names can be safely put in the numerator and whether such behaviour should be subject to some global state.


---

Comment by egourgoulhon created at 2016-08-31 10:02:26

Have you noticed that the patchbot `next_method` plugin failed on `src/sage/symbolic/pynac.pyx`? Probably the builtin function `next` should be used instead of `.next()` in line 653.


---

Comment by egourgoulhon created at 2016-08-31 10:02:26

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2016-08-31 14:30:28

While I doubt it will make a difference, it would be good to check that there are no conflicts with #21369.


---

Comment by git created at 2016-08-31 15:40:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2016-08-31 15:41:33

Changing status from needs_work to positive_review.


---

Comment by nbruin created at 2016-08-31 15:41:33

OK, let's see if this fares better.


---

Comment by egourgoulhon created at 2016-08-31 20:16:50

Replying to [comment:18 nbruin]:
> OK, let's see if this fares better.
Thanks for the changes!


---

Comment by vbraun created at 2016-09-04 00:13:53

Resolution: fixed


---

Comment by bpage created at 2016-09-04 01:33:20

Excellent. Thanks.
