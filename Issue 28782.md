# Issue 28782: Make patch to pillow more robust (do not depend on "Py_MACOS_SYSROOT")

archive/issues_028782.json:
```json
{
    "body": "CC:  @dimpase @embray @vbraun @jhpalmieri\n\nThis patch was introduced in #27631 \"patch pythons to allow MacOS builds without `/usr/include`\"\nand is now causing errors in #27754 \"Upgrade: Python 3.8.x\" and #27824 \"`spkg-configure.m4` for `python3`\".\n\nIssue created by migration from https://trac.sagemath.org/ticket/29019\n\n",
    "created_at": "2020-01-15T18:38:38Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Make patch to pillow more robust (do not depend on \"Py_MACOS_SYSROOT\")",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28782",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @embray @vbraun @jhpalmieri

This patch was introduced in #27631 "patch pythons to allow MacOS builds without `/usr/include`"
and is now causing errors in #27754 "Upgrade: Python 3.8.x" and #27824 "`spkg-configure.m4` for `python3`".

Issue created by migration from https://trac.sagemath.org/ticket/29019





---

archive/issue_comments_406104.json:
```json
{
    "body": "Dima, could you look into this?",
    "created_at": "2020-01-15T19:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406104",
    "user": "https://github.com/mkoeppe"
}
```

Dima, could you look into this?



---

archive/issue_comments_406105.json:
```json
{
    "body": "please see #27754#comment:65\n\nUnless I get access to one of these new MacOS boxes with that `/usr/include`-less Xcode, I can't really be of much help.",
    "created_at": "2020-01-15T19:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406105",
    "user": "https://github.com/dimpase"
}
```

please see #27754#comment:65

Unless I get access to one of these new MacOS boxes with that `/usr/include`-less Xcode, I can't really be of much help.



---

archive/issue_comments_406106.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-15T19:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406106",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_406107.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-15T19:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406107",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406108.json:
```json
{
    "body": "Thanks for providing context on that ticket.",
    "created_at": "2020-01-15T19:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406108",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for providing context on that ticket.



---

archive/issue_comments_406109.json:
```json
{
    "body": "With this ticket merged,  #27824 gets one step further and now hits the zlib problem also mentioned in the python 3.8 upgrade ticket #27754.",
    "created_at": "2020-01-15T20:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406109",
    "user": "https://github.com/mkoeppe"
}
```

With this ticket merged,  #27824 gets one step further and now hits the zlib problem also mentioned in the python 3.8 upgrade ticket #27754.



---

archive/issue_comments_406110.json:
```json
{
    "body": "We should probably patch out the entire horrible library discovery code from pillow's setup.py (https://github.com/python-pillow/Pillow/blob/master/setup.py)",
    "created_at": "2020-01-15T20:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406110",
    "user": "https://github.com/mkoeppe"
}
```

We should probably patch out the entire horrible library discovery code from pillow's setup.py (https://github.com/python-pillow/Pillow/blob/master/setup.py)



---

archive/issue_comments_406111.json:
```json
{
    "body": "Upstream issue for zlib on mac: https://github.com/python-pillow/Pillow/issues/3438",
    "created_at": "2020-01-15T20:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406111",
    "user": "https://github.com/mkoeppe"
}
```

Upstream issue for zlib on mac: https://github.com/python-pillow/Pillow/issues/3438



---

archive/issue_comments_406112.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T20:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406112",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406113.json:
```json
{
    "body": "This now compiles OK for me on macOS with #27824, after commenting out `MACOSX_DEPLOYMENT_TARGET` business from `sage-env`.",
    "created_at": "2020-01-15T20:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406113",
    "user": "https://github.com/mkoeppe"
}
```

This now compiles OK for me on macOS with #27824, after commenting out `MACOSX_DEPLOYMENT_TARGET` business from `sage-env`.



---

archive/issue_comments_406114.json:
```json
{
    "body": "Ready for review.",
    "created_at": "2020-01-15T20:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406114",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review.



---

archive/issue_comments_406115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-16T19:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406115",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406116.json:
```json
{
    "body": "This looks good to me, also works with Python 3.8 (#27754), where the patch setting `Py_MACOS_SYSROOT` is removed.",
    "created_at": "2020-01-16T19:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406116",
    "user": "https://github.com/jhpalmieri"
}
```

This looks good to me, also works with Python 3.8 (#27754), where the patch setting `Py_MACOS_SYSROOT` is removed.



---

archive/issue_comments_406117.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-01-16T19:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406117",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_406118.json:
```json
{
    "body": "Would there be any advantage to submitting this patch upstream?  It seems reasonable to me.",
    "created_at": "2020-01-17T14:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406118",
    "user": "https://github.com/embray"
}
```

Would there be any advantage to submitting this patch upstream?  It seems reasonable to me.



---

archive/issue_comments_406119.json:
```json
{
    "body": "Upstream is already aware of the issue (see comment 8), and we only have a workaround for us, not a general patch suitable for upstream.",
    "created_at": "2020-01-17T14:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406119",
    "user": "https://github.com/mkoeppe"
}
```

Upstream is already aware of the issue (see comment 8), and we only have a workaround for us, not a general patch suitable for upstream.



---

archive/issue_events_026625.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-01-20T21:17:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28782#event-26625"
}
```



---

archive/issue_comments_406120.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-20T21:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28782",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28782#issuecomment-406120",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
