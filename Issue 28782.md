# Issue 28782: Make patch to pillow more robust (do not depend on "Py_MACOS_SYSROOT")

Issue created by migration from https://trac.sagemath.org/ticket/29019

Original creator: mkoeppe

Original creation time: 2020-01-15 18:38:38

CC:  dimpase embray vbraun jhpalmieri

This patch was introduced in #27631 "patch pythons to allow MacOS builds without `/usr/include`"
and is now causing errors in #27754 "Upgrade: Python 3.8.x" and #27824 "`spkg-configure.m4` for `python3`".


---

Comment by mkoeppe created at 2020-01-15 19:10:11

Dima, could you look into this?


---

Comment by dimpase created at 2020-01-15 19:53:21

please see #27754#comment:65

Unless I get access to one of these new MacOS boxes with that `/usr/include`-less Xcode, I can't really be of much help.


---

Comment by mkoeppe created at 2020-01-15 19:57:48

New commits:


---

Comment by mkoeppe created at 2020-01-15 19:57:48

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-15 19:58:08

Thanks for providing context on that ticket.


---

Comment by mkoeppe created at 2020-01-15 20:06:32

With this ticket merged,  #27824 gets one step further and now hits the zlib problem also mentioned in the python 3.8 upgrade ticket #27754.


---

Comment by mkoeppe created at 2020-01-15 20:12:51

We should probably patch out the entire horrible library discovery code from pillow's setup.py (https://github.com/python-pillow/Pillow/blob/master/setup.py)


---

Comment by mkoeppe created at 2020-01-15 20:24:40

Upstream issue for zlib on mac: https://github.com/python-pillow/Pillow/issues/3438


---

Comment by git created at 2020-01-15 20:33:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-15 20:56:17

This now compiles OK for me on macOS with #27824, after commenting out `MACOSX_DEPLOYMENT_TARGET` business from `sage-env`.


---

Comment by mkoeppe created at 2020-01-15 20:56:29

Ready for review.


---

Comment by jhpalmieri created at 2020-01-16 19:19:48

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-01-16 19:19:48

This looks good to me, also works with Python 3.8 (#27754), where the patch setting `Py_MACOS_SYSROOT` is removed.


---

Comment by mkoeppe created at 2020-01-16 19:21:49

Thank you!


---

Comment by embray created at 2020-01-17 14:15:17

Would there be any advantage to submitting this patch upstream?  It seems reasonable to me.


---

Comment by mkoeppe created at 2020-01-17 14:49:38

Upstream is already aware of the issue (see comment 8), and we only have a workaround for us, not a general patch suitable for upstream.


---

Comment by vbraun created at 2020-01-20 21:17:58

Resolution: fixed
