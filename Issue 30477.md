# Issue 30477: Tensor Arithmetics on Minimal Amount of Domains

Issue created by migration from https://trac.sagemath.org/ticket/30714

Original creator: @mjungmath

Original creation time: 2020-10-03 21:55:06

CC:  egourgoulhon tscrim mkoeppe

If I get the code correctly, operations between two tensor fields on non-parallelizable manifolds are performed as follows:

1. get common domains from the `_restrictions` dictionary,
2. perform the corresponding operation on each of those domains.

However, in most cases not all domains are necessary to fully determine the result. It is enough to find a minimal set of common domains which cover the manifold and perform the computation on those. The wanted restrictions of the result can then be computed on demand.

Allow me an example:


```
sage: M = Manifold(2, 'S^2') # the 2-dimensional sphere S^2
sage: U = M.open_subset('U') # complement of the North pole
sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
sage: V = M.open_subset('V') # complement of the South pole
sage: c_uv.<u,v> = V.chart() # stereographic coordinates from the South pole
sage: M.declare_union(U,V)   # S^2 is the union of U and V
sage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),
....:                                intersection_name='W',
....:                                restrictions1=x^2+y^2!=0,
....:                                restrictions2=u^2+v^2!=0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: W = U.intersection(V)
sage: eU = c_xy.frame()
sage: eV = c_uv.frame()
sage: v = M.vector_field(name='v')
sage: v[eU,:] = [1, -2]
sage: v.add_comp_by_continuation(eV, W, chart=c_uv)
sage: v._restrictions
{Open subset U of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset U of the 2-dimensional differentiable manifold S^2,
 Open subset W of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset W of the 2-dimensional differentiable manifold S^2,
 Open subset V of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset V of the 2-dimensional differentiable manifold S^2}
```


Now, if you add `v` and another vector field defined similarly, the addition would be performed on `U`, `V` and `W`. Even though the computation on `W` is not necessary.


---

Comment by mkoeppe created at 2020-10-03 22:54:44

This is an NP-hard optimization problem.


---

Comment by egourgoulhon created at 2020-10-04 08:04:10

Maybe one shall introduce the concept of "top restrictions", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.


---

Comment by @mjungmath created at 2020-10-04 08:26:58

Replying to [comment:1 mkoeppe]:
> This is an NP-hard optimization problem.

I'm sorry, I don't know what you mean. Can you explain please?


---

Comment by @mjungmath created at 2020-10-04 08:45:53

Just for the records, I have introduced a method called `_get_min_covering` for characteristic forms and orientations (you can find it in `manifold.py`), which returns the minimal amount of objects necessary to cover the manifold. Maybe this is something we can use? I don't know how speedy it is compared to the computational cost we might save.


---

Comment by @mjungmath created at 2020-10-04 08:50:22

Replying to [comment:2 egourgoulhon]:
> Maybe one shall introduce the concept of "top restrictions", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.

This sounds like a great idea to me. I'm eager to hear what Matthias and Travis think about it.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by @mjungmath created at 2021-05-01 10:17:13

Possibly related: #31740, #31703.


---

Comment by mkoeppe created at 2021-05-03 15:35:45

A first step in line with #31740 could be to introduce methods `TensorField.restriction_digraph`, `.restriction_poset` etc. in analogy to `ManifoldSubset.subset_{digraph,subset}` (most recent version in #31736).
A generator of the top elements of the poset then comes for free - see #31766.


---

Comment by @mjungmath created at 2021-05-03 15:45:24

Perhaps it is a good idea to implement that behavior into sheaves (#31703) first and then wrap this over tensors and vb sections etc.
