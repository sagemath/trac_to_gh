# Issue 30477: Tensor Arithmetics on Minimal Amount of Domains

archive/issues_030477.json:
```json
{
    "body": "CC:  egourgoulhon tscrim mkoeppe\n\nIf I get the code correctly, operations between two tensor fields on non-parallelizable manifolds are performed as follows:\n\n1. get common domains from the `_restrictions` dictionary,\n2. perform the corresponding operation on each of those domains.\n\nHowever, in most cases not all domains are necessary to fully determine the result. It is enough to find a minimal set of common domains which cover the manifold and perform the computation on those. The wanted restrictions of the result can then be computed on demand.\n\nAllow me an example:\n\n\n```\nsage: M = Manifold(2, 'S^2') # the 2-dimensional sphere S^2\nsage: U = M.open_subset('U') # complement of the North pole\nsage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole\nsage: V = M.open_subset('V') # complement of the South pole\nsage: c_uv.<u,v> = V.chart() # stereographic coordinates from the South pole\nsage: M.declare_union(U,V)   # S^2 is the union of U and V\nsage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),\n....:                                intersection_name='W',\n....:                                restrictions1=x^2+y^2!=0,\n....:                                restrictions2=u^2+v^2!=0)\nsage: uv_to_xy = xy_to_uv.inverse()\nsage: W = U.intersection(V)\nsage: eU = c_xy.frame()\nsage: eV = c_uv.frame()\nsage: v = M.vector_field(name='v')\nsage: v[eU,:] = [1, -2]\nsage: v.add_comp_by_continuation(eV, W, chart=c_uv)\nsage: v._restrictions\n{Open subset U of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset U of the 2-dimensional differentiable manifold S^2,\n Open subset W of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset W of the 2-dimensional differentiable manifold S^2,\n Open subset V of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset V of the 2-dimensional differentiable manifold S^2}\n```\n\n\nNow, if you add `v` and another vector field defined similarly, the addition would be performed on `U`, `V` and `W`. Even though the computation on `W` is not necessary.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30714\n\n",
    "created_at": "2020-10-03T21:55:06Z",
    "labels": [
        "manifolds",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Tensor Arithmetics on Minimal Amount of Domains",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30477",
    "user": "@mjungmath"
}
```
CC:  egourgoulhon tscrim mkoeppe

If I get the code correctly, operations between two tensor fields on non-parallelizable manifolds are performed as follows:

1. get common domains from the `_restrictions` dictionary,
2. perform the corresponding operation on each of those domains.

However, in most cases not all domains are necessary to fully determine the result. It is enough to find a minimal set of common domains which cover the manifold and perform the computation on those. The wanted restrictions of the result can then be computed on demand.

Allow me an example:


```
sage: M = Manifold(2, 'S^2') # the 2-dimensional sphere S^2
sage: U = M.open_subset('U') # complement of the North pole
sage: c_xy.<x,y> = U.chart() # stereographic coordinates from the North pole
sage: V = M.open_subset('V') # complement of the South pole
sage: c_uv.<u,v> = V.chart() # stereographic coordinates from the South pole
sage: M.declare_union(U,V)   # S^2 is the union of U and V
sage: xy_to_uv = c_xy.transition_map(c_uv, (x/(x^2+y^2), y/(x^2+y^2)),
....:                                intersection_name='W',
....:                                restrictions1=x^2+y^2!=0,
....:                                restrictions2=u^2+v^2!=0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: W = U.intersection(V)
sage: eU = c_xy.frame()
sage: eV = c_uv.frame()
sage: v = M.vector_field(name='v')
sage: v[eU,:] = [1, -2]
sage: v.add_comp_by_continuation(eV, W, chart=c_uv)
sage: v._restrictions
{Open subset U of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset U of the 2-dimensional differentiable manifold S^2,
 Open subset W of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset W of the 2-dimensional differentiable manifold S^2,
 Open subset V of the 2-dimensional differentiable manifold S^2: Vector field v on the Open subset V of the 2-dimensional differentiable manifold S^2}
```


Now, if you add `v` and another vector field defined similarly, the addition would be performed on `U`, `V` and `W`. Even though the computation on `W` is not necessary.

Issue created by migration from https://trac.sagemath.org/ticket/30714





---

archive/issue_comments_434967.json:
```json
{
    "body": "This is an NP-hard optimization problem.",
    "created_at": "2020-10-03T22:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434967",
    "user": "mkoeppe"
}
```

This is an NP-hard optimization problem.



---

archive/issue_comments_434968.json:
```json
{
    "body": "Maybe one shall introduce the concept of \"top restrictions\", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.",
    "created_at": "2020-10-04T08:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434968",
    "user": "egourgoulhon"
}
```

Maybe one shall introduce the concept of "top restrictions", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.



---

archive/issue_comments_434969.json:
```json
{
    "body": "Replying to [comment:1 mkoeppe]:\n> This is an NP-hard optimization problem.\n\nI'm sorry, I don't know what you mean. Can you explain please?",
    "created_at": "2020-10-04T08:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434969",
    "user": "@mjungmath"
}
```

Replying to [comment:1 mkoeppe]:
> This is an NP-hard optimization problem.

I'm sorry, I don't know what you mean. Can you explain please?



---

archive/issue_comments_434970.json:
```json
{
    "body": "Just for the records, I have introduced a method called `_get_min_covering` for characteristic forms and orientations (you can find it in `manifold.py`), which returns the minimal amount of objects necessary to cover the manifold. Maybe this is something we can use? I don't know how speedy it is compared to the computational cost we might save.",
    "created_at": "2020-10-04T08:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434970",
    "user": "@mjungmath"
}
```

Just for the records, I have introduced a method called `_get_min_covering` for characteristic forms and orientations (you can find it in `manifold.py`), which returns the minimal amount of objects necessary to cover the manifold. Maybe this is something we can use? I don't know how speedy it is compared to the computational cost we might save.



---

archive/issue_comments_434971.json:
```json
{
    "body": "Replying to [comment:2 egourgoulhon]:\n> Maybe one shall introduce the concept of \"top restrictions\", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.\n\nThis sounds like a great idea to me. I'm eager to hear what Matthias and Travis think about it.",
    "created_at": "2020-10-04T08:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434971",
    "user": "@mjungmath"
}
```

Replying to [comment:2 egourgoulhon]:
> Maybe one shall introduce the concept of "top restrictions", i.e. restrictions that are not restrictions of a larger restriction on a parallelizable domain (there are already similar concepts in `TopologicalManifold._top_charts` and `DifferentiableManifold._top_frames`). Then the method `TensorField._common_subdomains()`, which is invoked by `_add_()`, could deal only with these top restrictions.

This sounds like a great idea to me. I'm eager to hear what Matthias and Travis think about it.



---

archive/issue_comments_434972.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434972",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_434973.json:
```json
{
    "body": "Possibly related: #31740, #31703.",
    "created_at": "2021-05-01T10:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434973",
    "user": "@mjungmath"
}
```

Possibly related: #31740, #31703.



---

archive/issue_comments_434974.json:
```json
{
    "body": "A first step in line with #31740 could be to introduce methods `TensorField.restriction_digraph`, `.restriction_poset` etc. in analogy to `ManifoldSubset.subset_{digraph,subset}` (most recent version in #31736).\nA generator of the top elements of the poset then comes for free - see #31766.",
    "created_at": "2021-05-03T15:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434974",
    "user": "mkoeppe"
}
```

A first step in line with #31740 could be to introduce methods `TensorField.restriction_digraph`, `.restriction_poset` etc. in analogy to `ManifoldSubset.subset_{digraph,subset}` (most recent version in #31736).
A generator of the top elements of the poset then comes for free - see #31766.



---

archive/issue_comments_434975.json:
```json
{
    "body": "Perhaps it is a good idea to implement that behavior into sheaves (#31703) first and then wrap this over tensors and vb sections etc.",
    "created_at": "2021-05-03T15:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30477#issuecomment-434975",
    "user": "@mjungmath"
}
```

Perhaps it is a good idea to implement that behavior into sheaves (#31703) first and then wrap this over tensors and vb sections etc.
