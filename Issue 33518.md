# Issue 33518: GH Actions (macos): Fix test of optional/experimental packages

Issue created by migration from https://trac.sagemath.org/ticket/33755

Original creator: mkoeppe

Original creation time: 2022-04-25 05:11:51

CC:  jhpalmieri @kliem dimpase

These tests are currently not being run because of a bug in the script - see  https://github.com/sagemath/sage/runs/6085026418?check_suite_focus=true:

```
Run case "2-optional-0-o" in
  case "2-optional-0-o" in
[...]
    2-optional*)     export TARGETS_PRE="build/make/Makefile" TARGETS="build/make/Makefile"
                     targets_pattern="2-optional-0-o"
                     targets_pattern="${targets_pattern#2-optional-}"
                     export TARGETS_OPTIONAL=$( echo $(export PATH=build/bin:$PATH && (for a in spkg-install.in spkg-install requirements.txt; do sage-package list :optional: --has-file $a --no-file huge --no-file has_nonfree_dependencies; done) | grep -v ^_ | grep -v sagemath_doc | grep '^[]' ) )
                     ;;
[...]
  esac
  MAKE="make -j12" tox -e $TOX_ENV -- SAGE_NUM_THREADS=4 $TARGETS

grep: brackets ([ ]) not balanced
```




---

Comment by mkoeppe created at 2022-04-25 05:16:16

Last touched in #33140, #29919


---

Comment by mkoeppe created at 2022-04-25 05:22:21

New commits:


---

Comment by mkoeppe created at 2022-04-25 05:24:12

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-04-25 18:04:35

The tests run now, needs review.


---

Comment by dimpase created at 2022-04-29 08:21:27

I see

```
Run brew install tox
==> Downloading https://ghcr.io/v2/homebrew/core/six/manifests/1.16.0_2-1
curl: (22) The requested URL returned error: 503 
Error: tox: Failed to download resource "six_bottle_manifest"
Download failed: https://ghcr.io/v2/homebrew/core/six/manifests/1.16.0_2-1
Error: Process completed with exit code 1.
```


Trying to open this URL in browser gives

```
{"errors":[{"code":"UNAUTHORIZED","message":"authentication required"}]}
```


By the way, there is also something wrong with "Build and Test" in the badge in the ticket description.


---

Comment by mkoeppe created at 2022-05-03 00:35:58

These are likely just intermittent problems.


---

Comment by dimpase created at 2022-05-03 08:20:37

Strangely, I cannot download `https://ghcr.io/v2/homebrew/core/six/manifests/1.16.0_2-1` with `wget` or browser, but `brew install six` works.


---

Comment by dimpase created at 2022-05-03 10:37:32

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-05-03 10:37:32

lgtm otherwise


---

Comment by mkoeppe created at 2022-05-03 15:09:12

Thanks!


---

Comment by mkoeppe created at 2022-05-07 18:35:50

Changing priority from major to blocker.


---

Comment by vbraun created at 2022-05-12 21:42:30

Resolution: fixed
