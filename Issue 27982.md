# Issue 27982: patch pynac's rational and integer hash function

Issue created by migration from https://trac.sagemath.org/ticket/28219

Original creator: @mwageringel

Original creation time: 2019-07-20 22:26:56

The implementation of Pynac's `_mpz_pythonhash` and `_mpq_pythonhash` in `ginac/numeric.cpp` for integers and rationals in `SR` used to agree with the hash implementations in Sage. Since the implementations in Sage have changed, Pynac needs to be updated.

This fails with Python 2 and 3:

```
sage: hash(-1/3) == hash(SR(-1/3))
False
```


This only fails with Python 3:

```
sage: hash(2^64-1) == hash(SR(2^64-1))
False
```



---

Comment by @mwageringel created at 2019-07-20 22:58:02

Here is a tentative patch I would like to get tested. The implementation is taken directly from `sage.libs.gmp.pylong.mpz_pythonhash`. The only difference is in how the final mapping from `-1` to `-2` is applied. It is important that `_mpq_pythonhash` obtains the hash values for numerator and denominator before this mapping is applied, as that is what happens in Sage.
----
New commits:


---

Comment by @mwageringel created at 2019-07-20 22:58:02

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-07-24 17:05:30

The tests pass. Upstream PR: https://github.com/pynac/pynac/pull/344


---

Comment by rws created at 2019-07-25 13:10:30

Merged. It will be in the next release which I'll put in an update ticket soon. Thanks!


---

Comment by @mwageringel created at 2019-07-25 16:32:54

Thank you. I will then remove the patch from this ticket, but will keep the new doctest so that it gets added to Sage.


---

Comment by @mwageringel created at 2019-07-25 16:32:54

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2019-08-06 19:53:07

If a new release of pynac will take a while, we can add the patch here and then remove it when a new pynac appears. This would fix one of the few remaining Python 3 problems. Any ideas when a new release will be available?


---

Comment by jhpalmieri created at 2019-08-26 03:38:50

I propose merging this ticket now, so that we can fix this doctest. This would make immediate progress on Python 3. Opinions?


---

Comment by @mwageringel created at 2019-08-26 18:36:41

That would be fine by me.


---

Comment by jhpalmieri created at 2019-08-26 18:43:32

Changing status from needs_work to positive_review.


---

Comment by rws created at 2019-08-27 13:35:49

See #28412.


---

Comment by rws created at 2019-08-27 13:37:43

Back from positive, to avoid conflicts with #28412.


---

Comment by rws created at 2019-08-27 13:37:43

Changing status from positive_review to needs_review.


---

Comment by @mwageringel created at 2019-08-27 18:10:42

I have removed the patch from the branch, but kept the new doctest. This needs review again.
----
New commits:


---

Comment by jhpalmieri created at 2019-08-27 18:32:29

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-08-27 18:32:29

With #28412, all tests pass with Python 2, and with Python 3 the new test passes, and no new failures occur.


---

Comment by vbraun created at 2019-09-05 21:33:18

Resolution: fixed
