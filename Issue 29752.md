# Issue 29752: fix random test failures in PSage interface

Issue created by migration from https://trac.sagemath.org/ticket/29989

Original creator: @mwageringel

Original creation time: 2020-06-25 17:32:13

CC:  chapoton @kliem

The doctests of the PSage interface sometimes fail when the garbage collector runs. This ticket fixes that.


```
sage: PSage().__del__()
deleting
---------------------------------------------------------------------------
...
AttributeError: type object 'Sage' has no attribute '__del__'
```



```
sage -t --long src/sage/interfaces/psage.py
**********************************************************************
File "src/sage/interfaces/psage.py", line 75, in sage.interfaces.psage.PSage._repr_
Failed example:
    PSage()                                   # indirect doctest
Expected:
    A running non-blocking (parallel) instance of Sage (number ...)
Got:
    deleting
    kill -9 3190048
    deleting
    kill -9 3190075
    deleting
    kill -9 3190084
    A running non-blocking (parallel) instance of Sage (number 3)
```



---

Comment by @mwageringel created at 2020-06-25 17:44:00

New commits:


---

Comment by @mwageringel created at 2020-06-25 17:44:00

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-06-28 18:55:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-07-05 18:10:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2020-07-05 18:17:00

I have removed the print statements from the `__del__` method, as they lead to unpredictable test failures due to garbage collecting and are generally not needed.


---

Comment by @mwageringel created at 2020-07-05 18:17:00

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2020-07-15 20:26:00

The bot is green. Could you give this a review please?


---

Comment by @kliem created at 2020-08-14 05:23:30

Is it acceptable, when the garbage collector runs in those cases?

I don't know much of the history of sage, but this code is back from 2006 and maybe too old to care about stable doctest. So it might be fine to delete those `print` messages (looks to me like they where changed only to make them work with python3).


---

Comment by @mwageringel created at 2020-08-14 08:08:55

Yes, once an object falls out of use, it should be fine to garbage collect it. It is not possible (nor needed) to control when this happens. During the doctest run of that file, multiple instances of `PSage` are created, so they quickly fall out of use.

The `print` messages look to me like a remnant from developing that code – they are not at all informative – so probably this just has not been changed because this is rarely used. A plain `print` should never be used for something like this.

Since recently, this issue frequently occurs on the patchbots.


---

Comment by @kliem created at 2020-08-14 09:37:21

Ok. LGTM.


---

Comment by @kliem created at 2020-08-14 09:37:21

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-08-14 09:37:47

I have noticed this failure somewhere.


---

Comment by @mwageringel created at 2020-08-14 09:39:18

Thank you.


---

Comment by @kliem created at 2020-08-15 08:13:37

Changing priority from major to critical.


---

Comment by @kliem created at 2020-08-15 08:13:37

This is annoying and a tiny fix.


---

Comment by vbraun created at 2020-08-16 22:33:21

Resolution: fixed


---

Comment by vbraun created at 2020-09-27 09:06:14

This ticket causes a race with deleting the directory, see #30671
