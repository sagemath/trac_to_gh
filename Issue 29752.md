# Issue 29752: fix random test failures in PSage interface

archive/issues_029752.json:
```json
{
    "body": "CC:  chapoton @kliem\n\nThe doctests of the PSage interface sometimes fail when the garbage collector runs. This ticket fixes that.\n\n\n```\nsage: PSage().__del__()\ndeleting\n---------------------------------------------------------------------------\n...\nAttributeError: type object 'Sage' has no attribute '__del__'\n```\n\n\n\n```\nsage -t --long src/sage/interfaces/psage.py\n**********************************************************************\nFile \"src/sage/interfaces/psage.py\", line 75, in sage.interfaces.psage.PSage._repr_\nFailed example:\n    PSage()                                   # indirect doctest\nExpected:\n    A running non-blocking (parallel) instance of Sage (number ...)\nGot:\n    deleting\n    kill -9 3190048\n    deleting\n    kill -9 3190075\n    deleting\n    kill -9 3190084\n    A running non-blocking (parallel) instance of Sage (number 3)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29989\n\n",
    "created_at": "2020-06-25T17:32:13Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "fix random test failures in PSage interface",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29752",
    "user": "@mwageringel"
}
```
CC:  chapoton @kliem

The doctests of the PSage interface sometimes fail when the garbage collector runs. This ticket fixes that.


```
sage: PSage().__del__()
deleting
---------------------------------------------------------------------------
...
AttributeError: type object 'Sage' has no attribute '__del__'
```



```
sage -t --long src/sage/interfaces/psage.py
**********************************************************************
File "src/sage/interfaces/psage.py", line 75, in sage.interfaces.psage.PSage._repr_
Failed example:
    PSage()                                   # indirect doctest
Expected:
    A running non-blocking (parallel) instance of Sage (number ...)
Got:
    deleting
    kill -9 3190048
    deleting
    kill -9 3190075
    deleting
    kill -9 3190084
    A running non-blocking (parallel) instance of Sage (number 3)
```


Issue created by migration from https://trac.sagemath.org/ticket/29989





---

archive/issue_comments_422648.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-25T17:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422648",
    "user": "@mwageringel"
}
```

New commits:



---

archive/issue_comments_422649.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-25T17:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422649",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422650.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-06-28T18:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422650",
    "user": "@mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_422651.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-07-05T18:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422651",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422652.json:
```json
{
    "body": "I have removed the print statements from the `__del__` method, as they lead to unpredictable test failures due to garbage collecting and are generally not needed.",
    "created_at": "2020-07-05T18:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422652",
    "user": "@mwageringel"
}
```

I have removed the print statements from the `__del__` method, as they lead to unpredictable test failures due to garbage collecting and are generally not needed.



---

archive/issue_comments_422653.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-05T18:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422653",
    "user": "@mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_422654.json:
```json
{
    "body": "The bot is green. Could you give this a review please?",
    "created_at": "2020-07-15T20:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422654",
    "user": "@mwageringel"
}
```

The bot is green. Could you give this a review please?



---

archive/issue_comments_422655.json:
```json
{
    "body": "Is it acceptable, when the garbage collector runs in those cases?\n\nI don't know much of the history of sage, but this code is back from 2006 and maybe too old to care about stable doctest. So it might be fine to delete those `print` messages (looks to me like they where changed only to make them work with python3).",
    "created_at": "2020-08-14T05:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422655",
    "user": "@kliem"
}
```

Is it acceptable, when the garbage collector runs in those cases?

I don't know much of the history of sage, but this code is back from 2006 and maybe too old to care about stable doctest. So it might be fine to delete those `print` messages (looks to me like they where changed only to make them work with python3).



---

archive/issue_comments_422656.json:
```json
{
    "body": "Yes, once an object falls out of use, it should be fine to garbage collect it. It is not possible (nor needed) to control when this happens. During the doctest run of that file, multiple instances of `PSage` are created, so they quickly fall out of use.\n\nThe `print` messages look to me like a remnant from developing that code \u2013 they are not at all informative \u2013 so probably this just has not been changed because this is rarely used. A plain `print` should never be used for something like this.\n\nSince recently, this issue frequently occurs on the patchbots.",
    "created_at": "2020-08-14T08:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422656",
    "user": "@mwageringel"
}
```

Yes, once an object falls out of use, it should be fine to garbage collect it. It is not possible (nor needed) to control when this happens. During the doctest run of that file, multiple instances of `PSage` are created, so they quickly fall out of use.

The `print` messages look to me like a remnant from developing that code – they are not at all informative – so probably this just has not been changed because this is rarely used. A plain `print` should never be used for something like this.

Since recently, this issue frequently occurs on the patchbots.



---

archive/issue_comments_422657.json:
```json
{
    "body": "Ok. LGTM.",
    "created_at": "2020-08-14T09:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422657",
    "user": "@kliem"
}
```

Ok. LGTM.



---

archive/issue_comments_422658.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-14T09:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422658",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422659.json:
```json
{
    "body": "I have noticed this failure somewhere.",
    "created_at": "2020-08-14T09:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422659",
    "user": "@kliem"
}
```

I have noticed this failure somewhere.



---

archive/issue_comments_422660.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-08-14T09:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422660",
    "user": "@mwageringel"
}
```

Thank you.



---

archive/issue_comments_422661.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-08-15T08:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422661",
    "user": "@kliem"
}
```

Changing priority from major to critical.



---

archive/issue_comments_422662.json:
```json
{
    "body": "This is annoying and a tiny fix.",
    "created_at": "2020-08-15T08:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422662",
    "user": "@kliem"
}
```

This is annoying and a tiny fix.



---

archive/issue_comments_422663.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-16T22:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422663",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_422664.json:
```json
{
    "body": "This ticket causes a race with deleting the directory, see #30671",
    "created_at": "2020-09-27T09:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29752#issuecomment-422664",
    "user": "vbraun"
}
```

This ticket causes a race with deleting the directory, see #30671
