# Issue 30001: Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic

archive/issues_030001.json:
```json
{
    "body": "CC:  @tscrim\n\nAs a follow up of #16351, we integrate the class `RecursivelyEnumeratedSet_forest` as a subclass of `RecursivelyEnumeratedSet_generic` implementing the following change:\n\n\n```diff\n-class RecursivelyEnumeratedSet_forest(Parent):\n+class RecursivelyEnumeratedSet_forest(RecursivelyEnumeratedSet_generic):\n```\n\n\nand consequential changes.\n\nI was hoping this to be enough to activate few methods like `to_digraph` from the generic class that I like to use but are currently not available for the forest type. But unfortunately, the implementation of breadth first search for forest type does not yet take into account the `max_depth` argument. That will be dealt in another ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30238\n\n",
    "created_at": "2020-07-28T12:38:13Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30001",
    "user": "https://github.com/seblabbe"
}
```
CC:  @tscrim

As a follow up of #16351, we integrate the class `RecursivelyEnumeratedSet_forest` as a subclass of `RecursivelyEnumeratedSet_generic` implementing the following change:


```diff
-class RecursivelyEnumeratedSet_forest(Parent):
+class RecursivelyEnumeratedSet_forest(RecursivelyEnumeratedSet_generic):
```


and consequential changes.

I was hoping this to be enough to activate few methods like `to_digraph` from the generic class that I like to use but are currently not available for the forest type. But unfortunately, the implementation of breadth first search for forest type does not yet take into account the `max_depth` argument. That will be dealt in another ticket.

Issue created by migration from https://trac.sagemath.org/ticket/30238





---

archive/issue_comments_425855.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-28T12:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425855",
    "user": "https://github.com/seblabbe"
}
```

New commits:



---

archive/issue_comments_425856.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-28T12:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425856",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_425857.json:
```json
{
    "body": "Note: I am changing the ordering of the input of the init method of `RecursivelyEnumeratedSet_forest` to match the one of `RecursivelyEnumeratedSet_generic`. This might break code using `RecursivelyEnumeratedSet_forest` if such code exists. One option is to make this ticket less intrusive by preserving the previous ordering for the init of `RecursivelyEnumeratedSet_forest`.\n\nThis is transparent for the code based on the function `RecursivelyEnumeratedSet`. The problem was only if people were using directly `RecursivelyEnumeratedSet_forest`.",
    "created_at": "2020-07-28T12:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425857",
    "user": "https://github.com/seblabbe"
}
```

Note: I am changing the ordering of the input of the init method of `RecursivelyEnumeratedSet_forest` to match the one of `RecursivelyEnumeratedSet_generic`. This might break code using `RecursivelyEnumeratedSet_forest` if such code exists. One option is to make this ticket less intrusive by preserving the previous ordering for the init of `RecursivelyEnumeratedSet_forest`.

This is transparent for the code based on the function `RecursivelyEnumeratedSet`. The problem was only if people were using directly `RecursivelyEnumeratedSet_forest`.



---

archive/issue_comments_425858.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-28T16:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425858",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_425859.json:
```json
{
    "body": "patchbot indicates doctest failures",
    "created_at": "2020-07-28T16:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425859",
    "user": "https://github.com/mkoeppe"
}
```

patchbot indicates doctest failures



---

archive/issue_comments_425860.json:
```json
{
    "body": "ok, I will work on that.",
    "created_at": "2020-07-29T21:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425860",
    "user": "https://github.com/seblabbe"
}
```

ok, I will work on that.



---

archive/issue_comments_425861.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T09:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425861",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425862.json:
```json
{
    "body": "I am changing the status to needs review just to see what the patchbot says. Locally, I still have at least the following issues, but I did not tested the whole library.\n\n\n```\n----------------------------------------------------------------------\nsage -t --random-seed=0 combinat/subsets_pairwise.py  # 1 doctest failed\nsage -t --random-seed=0 combinat/posets/hasse_diagram.py  # 2 doctests failed\n----------------------------------------------------------------------   \n```\n",
    "created_at": "2020-07-30T09:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425862",
    "user": "https://github.com/seblabbe"
}
```

I am changing the status to needs review just to see what the patchbot says. Locally, I still have at least the following issues, but I did not tested the whole library.


```
----------------------------------------------------------------------
sage -t --random-seed=0 combinat/subsets_pairwise.py  # 1 doctest failed
sage -t --random-seed=0 combinat/posets/hasse_diagram.py  # 2 doctests failed
----------------------------------------------------------------------   
```




---

archive/issue_comments_425863.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-30T09:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425863",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_425864.json:
```json
{
    "body": "I will need help to fix the above issue. Here is how to reproduce the error:\n\n\n```\nsage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets\nsage: def predicate(x,y): return gcd(x,y) == 1\nsage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P\nAn enumerated set with a forest structure\nsage: import __main__; __main__.predicate = predicate\nsage: TestSuite(P).run()\nFailure in _test_pickling:\n...\nTraceback (most recent call last):\n...\nTypeError: classname(=PairwiseCompatibleSubsets_with_category) does not start \nwith RecursivelyEnumeratedSet but \nisinstance(self, RecursivelyEnumeratedSet_generic) returns True\n------------------------------------------------------------\nThe following tests failed: _test_pickling\n```\n\n\nThis is due to the fact that a `__reduce__` method exists in the class `RecursivelyEnumeratedSet_generic` which is now used by `RecursivelyEnumeratedSet_forest`. But the current `__reduce__` method is not able to detect properly that self is an instance of `RecursivelyEnumeratedSet_forest` when the class is a class derivated from `RecursivelyEnumeratedSet_forest`. Testing `classname.startswith('RecursivelyEnumeratedSet_forest')` just does not work if the class name is `PairwiseCompatibleSubsets_with_category` for instance.\n\nReplacing the code based on the name of the class by `hasattr(self, 'map_reduce')` or more naturally by ` isinstance(self, RecursivelyEnumeratedSet_forest)` does not work because it gives a `maximum recursion depth exceeded` error:\n\n\n```diff\ndiff --git a/src/sage/sets/recursively_enumerated_set.pyx b/src/sage/sets/recursively_enumerated_set.pyx\nindex 2ca2dde..b2f5455 100644\n--- a/src/sage/sets/recursively_enumerated_set.pyx\n+++ b/src/sage/sets/recursively_enumerated_set.pyx\n@@ -539,6 +539,14 @@ cdef class RecursivelyEnumeratedSet_generic(Parent):\n             struct = 'forest'\n         elif classname.startswith('RecursivelyEnumeratedSet_generic'):\n             struct = None\n+        # this creates the following error\n+        # RecursionError: maximum recursion depth exceeded while calling a Python object\n+        #elif hasattr(self, 'map_reduce'):\n+        #    struct = 'forest'\n+        # this creates the following error\n+        # RecursionError: maximum recursion depth exceeded while calling a Python object\n+        #elif isinstance(self, RecursivelyEnumeratedSet_forest):\n+        #    struct = 'forest'\n         else:\n             A = isinstance(self, RecursivelyEnumeratedSet_generic)\n             raise TypeError(\"classname(={}) does not start with\"\n```\n\n\nI guess that code is based on `classname` to avoid that `RecursionError`. But I don't understand where the `RecursionError` comes from. Travis do you know?",
    "created_at": "2020-07-30T11:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425864",
    "user": "https://github.com/seblabbe"
}
```

I will need help to fix the above issue. Here is how to reproduce the error:


```
sage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets
sage: def predicate(x,y): return gcd(x,y) == 1
sage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P
An enumerated set with a forest structure
sage: import __main__; __main__.predicate = predicate
sage: TestSuite(P).run()
Failure in _test_pickling:
...
Traceback (most recent call last):
...
TypeError: classname(=PairwiseCompatibleSubsets_with_category) does not start 
with RecursivelyEnumeratedSet but 
isinstance(self, RecursivelyEnumeratedSet_generic) returns True
------------------------------------------------------------
The following tests failed: _test_pickling
```


This is due to the fact that a `__reduce__` method exists in the class `RecursivelyEnumeratedSet_generic` which is now used by `RecursivelyEnumeratedSet_forest`. But the current `__reduce__` method is not able to detect properly that self is an instance of `RecursivelyEnumeratedSet_forest` when the class is a class derivated from `RecursivelyEnumeratedSet_forest`. Testing `classname.startswith('RecursivelyEnumeratedSet_forest')` just does not work if the class name is `PairwiseCompatibleSubsets_with_category` for instance.

Replacing the code based on the name of the class by `hasattr(self, 'map_reduce')` or more naturally by ` isinstance(self, RecursivelyEnumeratedSet_forest)` does not work because it gives a `maximum recursion depth exceeded` error:


```diff
diff --git a/src/sage/sets/recursively_enumerated_set.pyx b/src/sage/sets/recursively_enumerated_set.pyx
index 2ca2dde..b2f5455 100644
--- a/src/sage/sets/recursively_enumerated_set.pyx
+++ b/src/sage/sets/recursively_enumerated_set.pyx
@@ -539,6 +539,14 @@ cdef class RecursivelyEnumeratedSet_generic(Parent):
             struct = 'forest'
         elif classname.startswith('RecursivelyEnumeratedSet_generic'):
             struct = None
+        # this creates the following error
+        # RecursionError: maximum recursion depth exceeded while calling a Python object
+        #elif hasattr(self, 'map_reduce'):
+        #    struct = 'forest'
+        # this creates the following error
+        # RecursionError: maximum recursion depth exceeded while calling a Python object
+        #elif isinstance(self, RecursivelyEnumeratedSet_forest):
+        #    struct = 'forest'
         else:
             A = isinstance(self, RecursivelyEnumeratedSet_generic)
             raise TypeError("classname(={}) does not start with"
```


I guess that code is based on `classname` to avoid that `RecursionError`. But I don't understand where the `RecursionError` comes from. Travis do you know?



---

archive/issue_comments_425865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-30T12:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425866.json:
```json
{
    "body": "I updated `__reduce__` to use `isinstance` instead which is more robust.\n\nThe next step is to fix the following Recursion error which I still do not understand:\n\n\n```\nsage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets\nsage: def predicate(x,y): return gcd(x,y) == 1\nsage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P\nAn enumerated set with a forest structure\nsage: dumps(P)\nTraceback (most recent call last):\n...\nRecursionError: maximum recursion depth exceeded while calling a Python object\n```\n",
    "created_at": "2020-07-30T12:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425866",
    "user": "https://github.com/seblabbe"
}
```

I updated `__reduce__` to use `isinstance` instead which is more robust.

The next step is to fix the following Recursion error which I still do not understand:


```
sage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets
sage: def predicate(x,y): return gcd(x,y) == 1
sage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P
An enumerated set with a forest structure
sage: dumps(P)
Traceback (most recent call last):
...
RecursionError: maximum recursion depth exceeded while calling a Python object
```




---

archive/issue_comments_425867.json:
```json
{
    "body": "It appears that the error comes from the reduction of the `.post_process`. When the latter is a method then there is a recursive call. A minimal example is\n\n```\nsage: class A: \n....:     def a(self): pass \n....:     def __reduce__(self): \n....:         return (A, (self.a,))                                                                                                                                                                                 \nsage: import pickle                                                                                                                                                                                                 \nsage: pickle.dumps(A())                                                                                                                                                                                             \n---------------------------------------------------------------------------\nRecursionError                            Traceback (most recent call last)\n<ipython-input-4-c96af998f575> in <module>\n----> 1 pickle.dumps(A())\n\nRecursionError: maximum recursion depth exceeded\n```\n",
    "created_at": "2020-07-30T22:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425867",
    "user": "https://github.com/videlec"
}
```

It appears that the error comes from the reduction of the `.post_process`. When the latter is a method then there is a recursive call. A minimal example is

```
sage: class A: 
....:     def a(self): pass 
....:     def __reduce__(self): 
....:         return (A, (self.a,))                                                                                                                                                                                 
sage: import pickle                                                                                                                                                                                                 
sage: pickle.dumps(A())                                                                                                                                                                                             
---------------------------------------------------------------------------
RecursionError                            Traceback (most recent call last)
<ipython-input-4-c96af998f575> in <module>
----> 1 pickle.dumps(A())

RecursionError: maximum recursion depth exceeded
```




---

archive/issue_comments_425868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-31T09:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425869.json:
```json
{
    "body": "Thank you Vincent. So, I managed to fix the Recursion error. Now, the same doctests fail for a different reason. I will work on that later.\n\nOne feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?",
    "created_at": "2020-07-31T09:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425869",
    "user": "https://github.com/seblabbe"
}
```

Thank you Vincent. So, I managed to fix the Recursion error. Now, the same doctests fail for a different reason. I will work on that later.

One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?



---

archive/issue_comments_425870.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-31T09:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425870",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_425871.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-31T15:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425871",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425872.json:
```json
{
    "body": "Replying to [comment:12 slabbe]:\n> One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?\n\nMy guess is so that it pickles well when used to build other objects; e.g., as the basis for a `CombinatorialFreeModule`.",
    "created_at": "2020-08-02T03:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425872",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:12 slabbe]:
> One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?

My guess is so that it pickles well when used to build other objects; e.g., as the basis for a `CombinatorialFreeModule`.



---

archive/issue_comments_425873.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425873",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_425874.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30001#issuecomment-425874",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
