# Issue 31960: MixedIntegerLinearProgram: fix tests of binary variables in sage.graphs

Issue created by migration from https://trac.sagemath.org/ticket/32197

Original creator: dcoudert

Original creation time: 2021-07-13 17:04:24

CC:  mkoeppe tscrim dimpase @davewittemorris slabbe

Introduce a helper function to convert inexact 0/1 value to boolean and use it in sage.graphs.


---

Comment by dcoudert created at 2021-07-13 17:08:16

If you agree with this solution, I will use it everywhere in sage.graphs
----
New commits:


---

Comment by dcoudert created at 2021-07-13 17:08:16

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-07-13 17:56:41

I would suggest to distinguish two cases explicitly:

a) if it is known that in an exact LP/MIP computation, the value would be either 0 or 1, then:
   {{{
   if abs(value) < tolerance:
       return False
   if abs(value - 1) < tolerance:
       return True
   raise RuntimeError("integrality tolerance exceeded - modeling error or numerical difficulties?")
   }}}

b) if in an exact computation, the value would be either 0, 1, or a fractional value, a separate helper function should be used in order to distinguish these three outcomes. This is a typical situation in iterative rounding algorithms.


The default tolerances for the two cases a) and b) could be chosen quite differently.


---

Comment by dcoudert created at 2021-07-13 21:49:13

For case b), I'm not sure of what to return when the expected value is fractional. The value itself or something else ? Also, how to name this function ?


---

Comment by mkoeppe created at 2021-07-13 22:17:20

For case b), maybe just two functions `is_zero`, `is_one`; or perhaps in some cases a function like this would be useful?

```
def group_by_zero_fractional_one_value(mapping, tolerance):
    return ({ index: value 
              for index, value in mapping.items() 
              if abs(value) < tolerance },
            ...)
```



By the way, I don't like the idea of having such helper functions in `sage.numerical.mip`, in particular defining there a default for the tolerance. The default is really application-specific, so the helper function should go somewhere in `sage.graphs`.


---

Comment by dimpase created at 2021-07-13 22:57:44

I think this opens a can of bugs. If you want an exact value 0/1, use binary variables, not floats.


---

Comment by mkoeppe created at 2021-07-13 23:01:59

"this" being exactly?


---

Comment by dcoudert created at 2021-07-14 10:55:49

The problem is that the backends return values of type double even for binary variables. Should we patch the backends ? add a method like `get_cast_values` that casts the values to the type of the variable ?


---

Comment by mkoeppe created at 2021-07-14 16:24:20

Definitely does not belong into the backends. This is an application-specific fix. See #30635#comment:31

If you really want to put a solution into `sage.numerical.mip`, it should go into the frontend (`MixedIntegerLinearProgram.get_values`) and be enabled explicitly and per instance of `MIPVariable`. New keyword arguments for `MixedIntegerLinearProgram.new_variable`, perhaps `convert_to=bool`, `convert_tolerance` (without default) could enable this behavior.


---

Comment by dcoudert created at 2021-07-14 18:02:50

Could this be a better proposal ?
----
New commits:


---

Comment by mkoeppe created at 2021-07-14 19:00:44

I don't like keying this behavior to the declared type of a MIP variable (binary or integer). Using LP and MIP models in which integrality of variable values is implied by the structure of the model is a central modeling technique. For example, in single-commodity network flow models with integer data, expert modelers would not use integer variables, so that a pure LP solver can be used. Integrality is automatic because of the structure of the model.


---

Comment by dcoudert created at 2021-07-14 19:11:00

The idea here is that the user can choose between the previous method (``get_values``) returning double values or this new method (``get_converted_values``) which tries to cast to declared type.
However, I'm not sure it can help solving the issue with glpk


---

Comment by mkoeppe created at 2021-07-14 19:22:33

Replying to [comment:11 dcoudert]:
> The idea here is that the user can choose between the previous method (``get_values``) returning double values or this new method (``get_converted_values``) which tries to cast to declared type.

Yes, this is what I was referring to.

The point is that users need to be able to do this conversion with error checking even for certain variables that are NOT declared as integer/binary to the solver.


---

Comment by dimpase created at 2021-07-15 11:47:08

Replying to [comment:10 mkoeppe]:
> I don't like keying this behavior to the declared type of a MIP variable (binary or integer). Using LP and MIP models in which integrality of variable values is implied by the structure of the model is a central modeling technique. For example, in single-commodity network flow models with integer data, expert modelers would not use integer variables, so that a pure LP solver can be used. Integrality is automatic because of the structure of the model.

Integer structure of the polyhedron might be automatic, but the objective function might be non-integer. Then with floating point YMMV.


---

Comment by mkoeppe created at 2021-07-15 16:22:54

Replying to [comment:13 dimpase]:
> Integer structure of the polyhedron might be automatic, but the objective function might be non-integer. 

Outside of the scope of this ticket.


---

Comment by git created at 2021-07-15 16:35:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2021-07-15 16:52:35

> The point is that users need to be able to do this conversion with error checking even for certain variables that are NOT declared as integer/binary to the solver.

In this case, we can have a hidden function in mip to convert the values of a variable to bool and another to convert to integer (both with tolerance). But this should be accessible to experts only. Is it what you expect ?


---

Comment by mkoeppe created at 2021-07-15 17:42:56

Here's a proposed interface:

```
    def get_values(self, *lists, convert=None, tolerance=None):
        r"""
        Return values found by the previous call to ``solve()``.

        INPUT:

        - ``*lists`` -- any instance of ``MIPVariable`` (or one of its elements),
          or lists of them.

        - ``convert`` -- ``None`` (default), ``ZZ``, ``bool``, or ``True``.

          - if ``convert=None``, return all variable values as elements of the
            :meth:`base_ring`.

          - if ``convert=ZZ``, convert all variable values from the :meth:`base_ring`
            by rounding to the nearest integer.

          - if ``convert=bool``, convert all variable values from the :meth:`base_ring`
            by rounding to 0/1 and converting to ``bool``.

          - if ``convert=True``, use ``ZZ`` for MIP variables declared integer or binary
            and ``None`` for all other variables.

        - ``tolerance`` -- nonnegative real number.  Required if ``convert`` is
          not ``None``.  If the variable value differs from the nearest integer by
          more than ``tolerance``, raise a ``RuntimeError``.

```

Simpler than what I suggested in comment 8 above and more discoverable than putting this in a separate method.


---

Comment by mkoeppe created at 2021-07-15 18:12:42

In fact, I would suggest to make it an error to pass `tolerance=0` when `base_ring` is not an exact ring.


---

Comment by git created at 2021-07-15 18:47:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-15 19:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-15 20:04:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-15 21:13:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-15 21:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-15 21:24:04

Here's a new version, please take a look


---

Comment by git created at 2021-07-15 21:25:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-15 21:43:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2021-07-15 21:49:09

I like it !

May be we should change the title of the ticket and let other corrections in sage.graphs for other tickets.


---

Comment by git created at 2021-07-15 22:01:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-15 22:01:58

Replying to [comment:28 dcoudert]:
> I like it !
> 
> May be we should change the title of the ticket and let other corrections in sage.graphs for other tickets.

Good idea, let's keep just the one example application.


---

Comment by git created at 2021-07-15 22:06:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-15 22:07:40

The other helper functions will also need docstrings (and tests)


---

Comment by git created at 2021-07-16 00:18:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-16 00:18:21

Ready for review


---

Comment by git created at 2021-07-16 06:45:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2021-07-16 06:57:08

Shouldn't we do something like that to avoid errors on 32 bits machines ?

```diff
-            RuntimeError: variable x_1 exceeds integrality tolerance 0.0100000000000000
+            RuntimeError: variable x_1 exceeds integrality tolerance 0.0100...
```

and may be also for numbers like `5.333333333333333`


---

Comment by mkoeppe created at 2021-07-16 07:06:40

Sure, go ahead, it's fine with me to use some `...`


---

Comment by git created at 2021-07-16 07:12:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2021-07-16 07:14:02

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2021-07-16 07:14:02

For me, this is now good to go.


---

Comment by mkoeppe created at 2021-07-16 07:19:55

Great, thanks.


---

Comment by vbraun created at 2021-07-25 13:26:47

Resolution: fixed
