# Issue 12566: Singular fails to build with LTO

Issue created by migration from https://trac.sagemath.org/ticket/12738

Original creator: SimonKing

Original creation time: 2012-03-23 20:31:27

Assignee: tbd

CC:  leif ncohen malb

Keywords: singular lto gcc

I took sage-5.0.beta9, replaced the ppl package by the one from #12672, added the cloog-ppl package from #12666, replaced the glpk package by the one from #12703, added a new libelf spkg, added the mpc and gcc spkgs from #12369 and modified the gcc spkg such that the gcc is built with support of loop optimization (graphite) and lto.

Then, I tried to build Sage with rather high optimization:

```
king@mpc622:/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/spkg$ echo $CFLAGS
-O3 -march=native -floop-interchange -floop-strip-mine -floop-block -fno-strict-aliasing -flto
king@mpc622:/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/spkg$ echo $CXXFLAGS
-O3 -march=native -floop-interchange -floop-strip-mine -floop-block -fno-strict-aliasing -flto
king@mpc622:/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/spkg$ echo $LDFLAGS
-flto
```


Moreover, I attempted to build parallely (four threads).

However, Singular failed to build. Note that dropping -flto would enable to build Singular. Hence, the problem really seems to be -flto, whereas `make -j4` and `-march=native` and `-floop*` seems to be fine.

It seems to me that LDFLAGS is not correctly passed. Namely, in the [install log](http://boxen.math.washington.edu/home/SimonKing/SAGE/install_logs/singular-3-1-3-3.p6.log), I read

```
g++ -O3 -march=native -floop-interchange -floop-strip-mine -floop-block -fno-strict-aliasing -flto -O2 -g -fPIC -pipe  -fno-implicit-templates -I. -I.. -I/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.bet
a9/local  -I/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/local/include -I/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/local/include -I/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta9/local/include   -DNDEBUG -DOM_NDEBUG -Dx86_64_Linux -DHAVE_CONFIG_H -fpic -DPIC -Dp_Procs_FieldQ -c p_Procs_Lib.cc -o p_Procs_Lib_FieldQ.dl_o
```

but

```
ld -shared -o p_Procs_FieldQ.sog p_Procs_Lib_FieldQ.dl_og
...
ld -shared -o p_Procs_FieldQ.so p_Procs_Lib_FieldQ.dl_o
```


Moreover, I see that libfac/Makefile.dist defines LDFLAGS empty

```
  LDFLAGS=
```

and defines

```
  LD = g++ $(ALLFLAGS)
```

where LDFLAGS does not appear in the definition of ALLFLAGS.


---

Comment by SimonKing created at 2012-03-23 20:38:04

Cc to Martin, because I suppose he knows a lot about the Singular spkg...


---

Comment by SimonKing created at 2012-03-23 20:48:35

Leif said at #12703: "Btw., parts of Singular still seem to disrespect CXXFLAGS, i.e., some C++ sources are compiled only using CPPFLAGS." However, adding CPPFLAGS did not help.


---

Comment by SimonKing created at 2012-03-24 11:12:23

See #12741: There is a similar problem with R.


---

Comment by leif created at 2012-03-24 11:32:39

To me this all smells more like a problem with the GCC setup (i.e., the Sage GCC spkg), as I don't have any problems compiling Sage 5.0beta{8,9} (with some spkgs replaced, see `sage-release`) with GCC 4.6.3 and `-flto` (as well as Graphite loop optimization) enabled.


---

Comment by SimonKing created at 2012-03-24 11:53:01

Replying to [comment:5 leif]:
> To me this all smells more like a problem with the GCC setup (i.e., the Sage GCC spkg)

Then it would probably be fair to say that it is a problem with how I modified the GCC spkg, so that it supports graphite and lto in the first place. The diff with respect to the spkg from #12369 is

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -82,6 +82,8 @@
 ../src/configure \
     --prefix="$SAGE_LOCAL" \
     --with-local-prefix="$SAGE_LOCAL" \
+    --with-cloog="$SAGE_LOCAL" --with-ppl="$SAGE_LOCAL" \
+    --enable-lto \
     --with-gmp="$SAGE_LOCAL" --with-mpfr="$SAGE_LOCAL" --with-mpc="$SAGE_LOCAL" \
     --with-system-zlib \
     --disable-multilib \
```


And of course I also added a libelf spkg (not published yet, but it is just upstream sources) and a cloog-ppl spkg (#12666).

Just for the record: Singular does build with the gcc from the modified spkg, as soon as one drops -flto, while -floop* is fine.


---

Comment by leif created at 2012-03-25 01:01:23

Furthermore (this is Sage 5.0.beta10, which doesn't matter here, GCC 4.6.3, but with binutils 2.22, and `LDFLAGS="-flto -fuse-linker-plugin"`):


```
lto1: internal compiler error: in lto_varpool_replace_node, at lto-symtab.c:304
Please submit a full bug report,
with preprocessed source if appropriate.
See <http://gcc.gnu.org/bugs.html> for instructions.
lto-wrapper: g++-4.6.3 returned 1 exit status
/usr/local/bin/ld: lto-wrapper failed
collect2: ld returned 1 exit status
make[4]: *** [Singular] Error 1
make[4]: Leaving directory `/data/leif/Sage/sage-5.0.beta10-gcc-4.6.3-LTO/spkg/build/singular-3-1-3-3.p6/src/Singular'
make[3]: *** [install] Error 1
make[3]: Leaving directory `/data/leif/Sage/sage-5.0.beta10-gcc-4.6.3-LTO/spkg/build/singular-3-1-3-3.p6/src'
make[2]: *** [/data/leif/Sage/sage-5.0.beta10-gcc-4.6.3-LTO/local/bin/Singular-3-1-3] Error 2
make[2]: Leaving directory `/data/leif/Sage/sage-5.0.beta10-gcc-4.6.3-LTO/spkg/build/singular-3-1-3-3.p6/src'
Unable to build Singular.
```


But this _might_ simply be a hidden "no space left on device" error, as `/tmp` is currently on my almost full root partition -- will retry later...


---

Comment by leif created at 2012-03-25 01:06:33

Ooops, somehow forgot to hit the submit button...

Replying to [comment:7 leif]:
> Furthermore (this is Sage 5.0.beta10, which doesn't matter here, GCC 4.6.3, but with binutils 2.22, and `LDFLAGS="-flto -fuse-linker-plugin"`):
> 
> {{{
> lto1: internal compiler error: in lto_varpool_replace_node, at lto-symtab.c:304
> ...
> }}}
> 
> But this _might_ simply be a hidden "no space left on device" error, as `/tmp` is currently on my almost full root partition -- will retry later...

Nope, it was not.  But I can currently get around that bug by omitting `-fuse-linker-plugin` from `LDFLAGS`.


---

Comment by SimonKing created at 2012-03-25 07:16:29

Hi! With the new setting (i.e., with a binutils-2.22.spkg), I seemingly get exactly the same problem as you:

```
iplib.cc:68:14: Warnung: Typ von »yylp_errlist« passt nicht zur ursprünglichen Deklaration [standardmäßig aktiviert]
libparse.l:63:13: Anmerkung: vorher hier deklariert
lto1: interner Compiler-Fehler: in lto_varpool_replace_node, bei lto-symtab.c:304
Bitte senden Sie einen vollständigen Fehlerbericht auf Englisch ein;
bearbeiten Sie die Quellen zunächst mit einem Präprozessor, wenn es
dienlich ist.
Fehler in der deutschen Übersetzung sind an translation-team-de@lists.sourceforge.net zu melden.

Gehen Sie gemäß den Hinweisen in <http://gcc.gnu.org/bugs.html> vor.
lto-wrapper: g++ gab Ende-Status 1 zurück
/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta10/local/lib/gcc/x86_64-unknown-linux-gnu/4.6.3/../../../../x86_64-unknown-linux-gnu/bin/ld: lto-wrapper failed
collect2: ld gab 1 als Ende-Status zurück
make[4]: *** [Singular] Fehler 1
make[4]: Leaving directory `/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta10/spkg/build/singular-3-1-3-3.p6/src/Singular'
make[3]: *** [install] Fehler 1
make[3]: Leaving directory `/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta10/spkg/build/singular-3-1-3-3.p6/src'
make[2]: *** [/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta10/local/bin/Singular-3-1-3] Fehler 2
make[2]: Leaving directory `/mnt/local/king/SAGE/testinggcc/lto/sage-5.0.beta10/spkg/build/singular-3-1-3-3.p6/src'
Unable to build Singular.
```


I am now trying to drop `-fuse-linker-plugin`


---

Comment by SimonKing created at 2012-03-25 07:49:06

I tried to drop -fuse-linker-plugin from LDFLAGS, but it didn't help. I tried to drop it from both LDFLAGS and C(XX)FLAGS, but it didn't help either. The [install log](http://boxen.math.washington.edu/home/SimonKing/SAGE/install_logs/singular_lto.log) should contain all three failing sessions, I don't know if there is any visible difference between the three.


---

Comment by leif created at 2012-03-25 09:14:55

Replying to [comment:10 SimonKing]:
> I tried to drop -fuse-linker-plugin from LDFLAGS, but it didn't help.

That only worked for me because I had built GCC 4.6.3 with older binutils, in particular GNU `ld` 2.20.*.

(If a plugin-capable linker is present during the build of GCC, you later don't have to specify `-fuse-linker-plugin` at all.)


---

Comment by SimonKing created at 2012-03-25 09:25:40

In the ticket description, I mentioned that the user-defined LDFLAGS is overridden in libfac/Makefile.dist. So, I commented out the line in which that happens. Keeping my fingers crossed that it solves the problem...


---

Comment by SimonKing created at 2012-03-25 09:27:42

Just as I wrote the previous comment, building Singular failed again, with the same error `in lto_varpool_replace_node, bei lto-symtab.c:304`.


---

Comment by leif created at 2012-03-25 09:29:10

Replying to [comment:13 SimonKing]:
> Just as I wrote the previous comment, building Singular failed again, with the same error `in lto_varpool_replace_node, bei lto-symtab.c:304`.

As expected... :-(


---

Comment by SimonKing created at 2012-03-25 09:32:08

Replying to [comment:14 leif]:
> Replying to [comment:13 SimonKing]:
> > Just as I wrote the previous comment, building Singular failed again, with the same error `in lto_varpool_replace_node, bei lto-symtab.c:304`.
> 
> As expected... :-(

Why expected? I thought that the problem is that Singular does not take LDFLAGS into account!


---

Comment by leif created at 2012-03-25 09:54:03

Replying to [comment:15 SimonKing]:
> Replying to [comment:14 leif]:
> > Replying to [comment:13 SimonKing]:
> > > Just as I wrote the previous comment, building Singular failed again, with the same error `in lto_varpool_replace_node, bei lto-symtab.c:304`.
> > 
> > As expected... :-(
> 
> Why expected? I thought that the problem is that Singular does not take LDFLAGS into account!

Because dropping `-flto` shouldn't have any effect except that LTO simply won't happen.

Of course there are some other effects, e.g. regarding the size of the object files (and of course compile time), depending on _where_ you drop it, if not everywhere.

`-flto` _during compilation_ just prepares the generated object files for LTO (i.e., adds the extra information needed later); `-flto` during the link phase then triggers LTO.  If some object files or libraries lack the special sections needed, they're just excluded from LTO, as there's no information available on them.  This is very similar to compiling with `-g`, and later using the debugger.


---

Comment by SimonKing created at 2012-03-25 10:12:59

Replying to [comment:16 leif]:
> Replying to [comment:15 SimonKing]:
> > Replying to [comment:14 leif]:
> > > Replying to [comment:13 SimonKing]:
> > > > Just as I wrote the previous comment, building Singular failed again, with the same error `in lto_varpool_replace_node, bei lto-symtab.c:304`.
> > > 
> > > As expected... :-(
> > 
> > Why expected? I thought that the problem is that Singular does not take LDFLAGS into account!
> 
> Because dropping `-flto` shouldn't have any effect except that LTO simply won't happen.

I was not talking about "dropping -flto" but about modifying the Singular sources such that LDFLAGS is not overridden.


---

Comment by leif created at 2012-03-25 10:16:05

To be more precise:

 * Singular dropping / ignoring `*FLAGS` (in this case, `-flto`, or `LDFLAGS` _from compiler link commands_) isn't nice, likewise ignoring `CXXFLAGS` in some compile commands, and should probably get fixed and reported upstream, but _should *not break* the build_ (at least not if only `-flto` isn't passed to the compiler).

 * The error we get with LTO (when enabled during the link phase), which makes the build _fail_, is a *GCC bug*, and should get reported GCC upstream.


---

Comment by SimonKing created at 2012-03-25 10:28:31

Replying to [comment:18 leif]:
>  * The error we get with LTO (when enabled during the link phase), which makes the build _fail_, is a *GCC bug*, and should get reported GCC upstream.

OK. Can you do that? Because apparently the gcc spkg was automatically building a "localized" version, such that the error messages are German, but they ask for a report in English.


---

Comment by leif created at 2012-03-25 19:51:02

Just successfully built Singular (3-1-3-3.p6) with GCC *4.7.0* and LTO enabled. :-)


---

Comment by SimonKing created at 2012-03-25 20:04:00

Replying to [comment:20 leif]:
> Just successfully built Singular (3-1-3-3.p6) with GCC *4.7.0* and LTO enabled. :-)

Congrats. I just failed to build Maxima with GCC 4.6.3 and LTO enabled. Interestingly, maxima has not been a problem with -flto (if I remember correctly), but now I had -flto -fuse-linker-plugin.


---

Comment by leif created at 2012-03-25 21:47:10

Replying to [comment:21 SimonKing]:
> Replying to [comment:20 leif]:
> > Just successfully built Singular (3-1-3-3.p6) with GCC *4.7.0* and LTO enabled. :-)
> 
> Congrats. I just failed to build Maxima with GCC 4.6.3 and LTO enabled. Interestingly, maxima has not been a problem with -flto (if I remember correctly), but now I had -flto -fuse-linker-plugin.

See [comment:ticket:12741:10 my comment] at #12741.  I've also posted to sage-release, and do have an spkg fixing this: :-)

[maxima-5.26.0.p1.spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/maxima-5.26.0.p1.spkg) (Changes not yet committed due to lacking ticket number, haven't yet opened one for that.)


---

Comment by leif created at 2012-04-08 00:59:46

Replying to [comment:22 leif]:
> Replying to [comment:21 SimonKing]:
> > Replying to [comment:20 leif]:
> > > Just successfully built Singular (3-1-3-3.p6) with GCC *4.7.0* and LTO enabled. :-)
> > 
> > Congrats. I just failed to build Maxima with GCC 4.6.3 and LTO enabled. Interestingly, maxima has not been a problem with -flto (if I remember correctly), but now I had -flto -fuse-linker-plugin.
> 
> See [comment:ticket:12741:10 my comment] at #12741.  I've also posted to sage-release, and do have an spkg fixing this: :-)
> 
> [maxima-5.26.0.p1.spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/maxima-5.26.0.p1.spkg) (Changes not yet committed due to lacking ticket number, haven't yet opened one for that.)

Oh, forgot: This is now #12759 (changes committed, needing review :P ).


---

Comment by leif created at 2013-06-13 15:18:47

Is this still an issue (with Singular 3-1-5, newer GCC versions...)?


---

Comment by leif created at 2013-06-13 15:18:47

Changing status from new to needs_info.


---

Comment by mkoeppe created at 2021-09-10 06:48:03

outdated, should close


---

Comment by mkoeppe created at 2021-09-10 06:48:03

Changing status from needs_info to needs_review.


---

Comment by mjo created at 2021-09-18 10:59:28

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-18 17:51:47

Resolution: invalid
