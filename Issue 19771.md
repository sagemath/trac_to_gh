# Issue 19771: Implement non-recursive iterator for compositions

Issue created by migration from https://trac.sagemath.org/ticket/20008

Original creator: tscrim

Original creation time: 2016-02-04 00:53:13

Assignee: sage-combinat

CC:  sage-combinat darij chapoton nthiery vdelecroix

Keywords: iterator

Compositions currently uses a recursive iterator, which also has extra overhead of converting between the element classes. 


---

Comment by tscrim created at 2016-02-04 00:53:45

Changing status from new to needs_review.


---

Comment by git created at 2016-02-04 00:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-02-04 03:20:39

Some timings with the current branch:

```
sage: C = Compositions(5)
sage: %timeit for x in C: pass
The slowest run took 8.30 times longer than the fastest. This could mean that an intermediate result is being cached
10000 loops, best of 3: 34.9 µs per loop
sage: C = Compositions(10)
sage: %timeit for x in C: pass
1000 loops, best of 3: 1.1 ms per loop
sage: C = Compositions(20)
sage: %timeit for x in C: pass
1 loops, best of 3: 1.18 s per loop
```

versus the old version:

```
sage: C = Compositions(5)
sage: %timeit for x in C: pass
The slowest run took 10.67 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 187 µs per loop
sage: C = Compositions(10)
sage: %timeit for x in C: pass
100 loops, best of 3: 9.11 ms per loop
sage: C = Compositions(20)
sage: %timeit for x in C: pass
1 loops, best of 3: 15.7 s per loop
```

Also, the old version instantly fails for large `n` because of the recursion:

```
sage: C = Compositions(1000)
sage: for x in C: pass
...
RuntimeError: maximum recursion depth exceeded in cmp
```



---

Comment by darij created at 2016-02-04 22:40:59

Grammar error in doc.

More importantly, though, I'm not sure I understand the algorithm. Why does it not decrement `s` in the `s > n` case? What is the logic behind the algorithm anyway?


---

Comment by tscrim created at 2016-02-04 22:59:14

Replying to [comment:5 darij]:
> Grammar error in doc.
> 
> More importantly, though, I'm not sure I understand the algorithm. Why does it not decrement `s` in the `s > n` case?

Actually, that case never happens unless `n < 0`. So that could be removed.

> What is the logic behind the algorithm anyway?

The idea is to find the lex smallest composition by adding a box each step. If we have a composition of `n`, then yield and remove the last column and add a box to the new final column. Otherwise add a box to the end. Hmmm....implementing it directly from that would probably be a little cleaner since `cur` would always be a valid partition. Let me change that now.


---

Comment by git created at 2016-02-04 23:03:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-02-04 23:04:22

Replying to [comment:6 tscrim]:
> Replying to [comment:5 darij]:
> > Grammar error in doc.

How about this?

> > What is the logic behind the algorithm anyway?
> 
> The idea is to find the lex smallest composition by adding a box each step. If we have a composition of `n`, then yield and remove the last column and add a box to the new final column. Otherwise add a box to the end. Hmmm....implementing it directly from that would probably be a little cleaner since `cur` would always be a valid partition. Let me change that now.

Actually, now I remember why I did it how it is, so I wouldn't have to check that `cur` is non-empty when I did my backtracking.


---

Comment by darij created at 2016-02-04 23:21:34

LGTM! This is actually a nice lexicographic iterator over all compositions of size `\leq n`.

If you doctest sage/combinat  (this iterator is used a lot, and who knows what could happen), feel free to set this to positive review.


---

Comment by nthiery created at 2016-02-05 08:55:40

Hi!

Thanks Travis; the timing is indeed way better.

Vincent, what do you think? This looks like a step in our general direction of splitting:

- a lowlevel library of super-fast itertools style iterators producing plain data structures
- higher level layer views, with all the Parent, Element goodies.

I haven't followed much the progress in this direction. But I am wondering whether we want to go further (here or in a later ticket) by moving the iterator in a separate Cython file possibly using C-level data structure like vector<int> or ClonableIntArray.

The other thing is that the algorithm here is exactly that of IntegerListLex, with in principle, the same complexity. Of course the later has overhead since it needs to handle all the additional constraints. Yet it would reduce code bloat to focus on optimizing/cythonizing IntegerListLex rather than having a bunch of non cythonized (by lack of manpower) python methods for special cases.

Cheers,


---

Comment by tscrim created at 2016-02-05 17:51:14

I'm wondering how much we could get by going one step further and moving `IntegerListsLex` to a small standalone C/C++ library, where we can really get to low-level optimizations. Although I see some technical challenges with this; in particular, taking functions as input and the lambda functions involved with the current implementation. Perhaps Cython will be sufficient.

I agree that this would further benefit from cythonization/C-ifying. Right now we don't have a set place upon where we can put these functions. I also do not see them as code bloat because to really optimize `IntegerListsLex`, we will almost certainly have specialized implementations for special cases to avoid overhead of the general case. (This implementation can be easily tweaked to cover a number of other cases, but would likely have bad performance in general.)

However, I think we should do all of these things on a separate ticket(s), which is why I'm setting this to a positive review given [comment:9 Darij's comment] and the green patchbot. Feel free to set it back if you disagree. Yet +1 to adding a common place/library for all of these iterator functions (and their cython/C versions).


---

Comment by tscrim created at 2016-02-05 17:51:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-02-06 10:28:58

Resolution: fixed
