# Issue 25277: Add is_square method to LaurentPolynomial_mpair class

Issue created by migration from Trac.

Original creator: vklein

Original creation time: 2018-06-05 15:58:04

CC:  vklein tscrim

Add an is_square instance method to LaurentPolynomial_mpair class.

This ticket is a prerequisite for #24677.


---

Comment by vdelecroix created at 2018-08-23 02:53:42

New commits:


---

Comment by git created at 2018-08-23 03:24:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-08-23 03:25:49

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-08-23 07:42:14

Overall looks good, but I have a few comments:

- `if len(V) == 0:` -> `if not V:` as the latter is faster.
- Do you really want to raise a `RuntimeError` if there is no section for `nth_root`? If it is something that should be true, then it should be an `assert`. Otherwise it I think should be a `ValueError`, maybe an `ArithmeticError` or `NotImplementedError`. `RuntimeError` seems to indicate that there is a more serious problem. Does this also break code that could (in theory) have been working before?
- It might be a good idea to store the `phi.section()` in a variable so the function does not have to be called twice, which might create 2 different sections (where you only need one).
- I would move the `return` statement outside of the `try`-`except` block in `is_square` as that is not what the block is for.


---

Comment by vdelecroix created at 2018-08-23 13:04:11

Replying to [comment:7 tscrim]:
> Overall looks good, but I have a few comments:
> 
> - `if len(V) == 0:` -> `if not V:` as the latter is faster.

Agreed, but the time is not at all spent there...

> - Do you really want to raise a `RuntimeError` if there is no section for `nth_root`? If it is something that should be true, then it should be an `assert`. Otherwise it I think should be a `ValueError`, maybe an `ArithmeticError` or `NotImplementedError`. `RuntimeError` seems to indicate that there is a more serious problem. Does this also break code that could (in theory) have been working before?

I stumbled on this when I had to add manually the section for the identity morphism. Let me put an assert.

> - It might be a good idea to store the `phi.section()` in a variable so the function does not have to be called twice, which might create 2 different sections (where you only need one).

I thought they would be cached. No hurt in storing it.

> - I would move the `return` statement outside of the `try`-`except` block in `is_square` as that is not what the block is for.

All right.


---

Comment by git created at 2018-08-23 13:10:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-08-23 13:10:39

done in 60dd2df


---

Comment by vdelecroix created at 2018-08-23 16:59:48

Trivial fixes needed (see patchbot report)

```
sage -t --long src/sage/modular/modform_hecketriangle/graded_ring_element.py
**********************************************************************
File "src/sage/modular/modform_hecketriangle/graded_ring_element.py", line 1007, in sage.modular.modform_hecketriangle.graded_ring_element.?.sqrt
Failed example:
    sqrt(E2^2)
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: is_square() not implemented for elements of Multivariate Polynomial Ring in x, y, z, d over Integer Ring
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 614, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1025, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.modform_hecketriangle.graded_ring_element.?.sqrt[2]>", line 1, in <module>
        sqrt(E2**Integer(2))
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/functions/other.py", line 880, in sqrt
        return x.sqrt(*args, **kwds)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modular/modform_hecketriangle/graded_ring_element.py", line 1016, in sqrt
        return self.parent()(res).reduce()
      File "sage/structure/parent.pyx", line 921, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)
        return C._element_constructor(x)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modular/modform_hecketriangle/abstract_space.py", line 280, in _element_constructor_
        return self.element_class(self, el)
      File "sage/misc/classcall_metaclass.pyx", line 329, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1640)
        return cls.classcall(cls, *args, **kwds)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modular/modform_hecketriangle/graded_ring_element.py", line 75, in __classcall__
        return super(FormsRingElement,cls).__classcall__(cls, parent, rat)
      File "sage/misc/cachefunc.pyx", line 1005, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6301)
        w = self.f(*args, **kwds)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1026, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 496, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2090)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/modular/modform_hecketriangle/element.py", line 76, in __init__
        raise ValueError("{} does not correspond to an element of {}.".format(rat, parent))
    ValueError: z does not correspond to an element of QuasiModularForms(n=3, k=4, ep=1) over Integer Ring.
**********************************************************************
1 item had failures:
   1 of   4 in sage.modular.modform_hecketriangle.graded_ring_element.?.sqrt
    [671 tests, 1 failure, 32.29 s]
sage -t --long src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 2441, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__
Failed example:
    u^(1/2)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: (u)^(1/2) does not lie in Multivariate Polynomial Ring
    in u, v over Rational Field
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 614, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1025, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__[8]>", line 1, in <module>
        u**(Integer(1)/Integer(2))
      File "sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 2497, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__ (build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:25276)
        return self.nth_root(den) ** num
      File "sage/rings/polynomial/multi_polynomial.pyx", line 2017, in sage.rings.polynomial.multi_polynomial.MPolynomial.nth_root (build/cythonized/sage/rings/polynomial/multi_polynomial.c:22552)
        root = pU.nth_root(n)
      File "sage/rings/polynomial/polynomial_element.pyx", line 9882, in sage.rings.polynomial.polynomial_element.Polynomial.nth_root (build/cythonized/sage/rings/polynomial/polynomial_element.c:90652)
        raise ValueError("not a %s power"%Integer(n).ordinal_str())
    ValueError: not a 2nd power
**********************************************************************
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 2465, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__
Failed example:
    (R^2 + 3)^(1/2)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: (R^2 + 3)^(1/2) does not lie in
    Multivariate Polynomial Ring in R, S over Integer Ring
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 614, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1025, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__[16]>", line 1, in <module>
        (R**Integer(2) + Integer(3))**(Integer(1)/Integer(2))
      File "sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 2497, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__ (build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:25276)
        return self.nth_root(den) ** num
      File "sage/rings/polynomial/multi_polynomial.pyx", line 2017, in sage.rings.polynomial.multi_polynomial.MPolynomial.nth_root (build/cythonized/sage/rings/polynomial/multi_polynomial.c:22552)
        root = pU.nth_root(n)
      File "sage/rings/polynomial/polynomial_element.pyx", line 9894, in sage.rings.polynomial.polynomial_element.Polynomial.nth_root (build/cythonized/sage/rings/polynomial/polynomial_element.c:90962)
        start = S(self.get_unsafe(0).nth_root(n))
      File "sage/rings/integer.pyx", line 2329, in sage.rings.integer.Integer.nth_root (build/cythonized/sage/rings/integer.c:15646)
        raise ValueError("%s is not a %s power" % (self,
    ValueError: 3 is not a 2nd power
**********************************************************************
1 item had failures:
   2 of  22 in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__
    [1088 tests, 2 failures, 3.38 s]
----------------------------------------------------------------------
sage -t --long src/sage/modular/modform_hecketriangle/graded_ring_element.py  # 1 doctest failed
sage -t --long src/sage/rings/polynomial/multi_polynomial_libsingular.pyx  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vdelecroix created at 2018-08-23 16:59:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-08-23 17:17:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-08-23 17:17:34

needs review again!


---

Comment by vdelecroix created at 2018-08-23 17:17:34

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-08-23 22:47:14

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-08-23 22:47:14

Thank you. LGTM.


---

Comment by vbraun created at 2018-08-26 09:38:04

Resolution: fixed


---

Comment by vbraun created at 2018-08-28 23:08:22

Segfaults on linux 32-bit:

```
sage: ETuple([0,3,12]).escalar_div(3) ## line 1566 ##
(0, 1, 4)
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 1568 ##
------------------------------------------------------------------------
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x51a2)[0xf68fb1a2]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x524c)[0xf68fb24c]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x8690)[0xf68fe690]
linux-gate.so.1(__kernel_sigreturn+0x0)[0xf7754cb0]
linux-gate.so.1(__kernel_vsyscall+0x9)[0xf7754c99]
/lib/i386-linux-gnu/libc.so.6(gsignal+0xb0)[0xf7322dd0]
/lib/i386-linux-gnu/libc.so.6(abort+0x157)[0xf7324297]
/lib/i386-linux-gnu/libc.so.6(+0x6738f)[0xf735e38f]
/lib/i386-linux-gnu/libc.so.6(+0x6dfc7)[0xf7364fc7]
/lib/i386-linux-gnu/libc.so.6(+0x6e806)[0xf7365806]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/polynomial/polydict.so(+0x5741)[0xd0cba741]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x7f8ea)[0xf75ae8ea]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyDict_SetItem+0x68)[0xf75b0568]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(_PyObject_GenericSetAttrWithDict+0xd1)[0xf75b6591]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_GenericSetAttr+0x22)[0xf75b6722]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_SetAttr+0x88)[0xf75b5f68]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x238d)[0xf761c13d]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x6b071)[0xf759a071]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x4860a)[0xf757760a]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x4c)[0xf761976c]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8f99)[0xf7622d49]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x2e)[0xf7623f1e]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7395)[0xf7621145]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x6b071)[0xf759a071]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x4860a)[0xf757760a]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0xa8cad)[0xf75d7cad]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5c30)[0xf761f9e0]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7179)[0xf7620f29]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x6b071)[0xf759a071]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0x4860a)[0xf757760a]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0xa9115)[0xf75d8115]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(+0xa59e9)[0xf75d49e9]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyObject_Call+0x4d)[0xf75656cd]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5c30)[0xf761f9e0]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7179)[0xf7620f29]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x7077)[0xf7620e27]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7fe)[0xf7623dae]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x2e)[0xf7623f1e]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0x77)[0xf76474b7]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xdd)[0xf7648a1d]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyRun_AnyFileExFlags+0x67)[0xf7649147]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(Py_Main+0xcfd)[0xf766006d]
/home/buildbot/slave/sage_git/build/local/bin/python2(main+0x27)[0x5656a617]
/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf6)[0xf730f286]
/home/buildbot/slave/sage_git/build/local/bin/python2(+0x655)[0x5656a655]
------------------------------------------------------------------------
Attaching gdb to process id 8519.
Cannot find gdb installed
GDB is not installed.
Install gdb for enhanced tracebacks.
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
**********************************************************************
----------------------------------------------------------------------
sage -t --long src/sage/rings/polynomial/polydict.pyx  # Killed due to abort
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-08-28 23:08:22

Changing status from closed to new.


---

Comment by vbraun created at 2018-08-28 23:08:22

Resolution changed from fixed to 


---

Comment by vdelecroix created at 2018-08-29 03:39:48

I am very sorry about that. Nothing to do with 32 bits. I messed up with memory allocation...
----
New commits:


---

Comment by vdelecroix created at 2018-08-29 03:39:48

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-08-29 04:44:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-30 22:24:57

Resolution: fixed
