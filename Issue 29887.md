# Issue 29887: spkg-configure for "jupyter"

archive/issues_029887.json:
```json
{
    "body": "CC:  dimpase nbruin slelievre paulmasson fbissey charpent jhpalmieri @thierry-freebsd @sheerluck nthiery\n\nFrom dimpase https://groups.google.com/d/msg/sage-devel/mWTD0_iBwKc/4eKjmINXAQAJ:\n\nswitch to external jupyter - there is  no reason for\nSage to supply anything but the jupyter kernel...\n\nIssue created by migration from https://trac.sagemath.org/ticket/30124\n\n",
    "created_at": "2020-07-12T18:53:56Z",
    "labels": [
        "build: configure",
        "major",
        "enhancement"
    ],
    "title": "spkg-configure for \"jupyter\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29887",
    "user": "mkoeppe"
}
```
CC:  dimpase nbruin slelievre paulmasson fbissey charpent jhpalmieri @thierry-freebsd @sheerluck nthiery

From dimpase https://groups.google.com/d/msg/sage-devel/mWTD0_iBwKc/4eKjmINXAQAJ:

switch to external jupyter - there is  no reason for
Sage to supply anything but the jupyter kernel...

Issue created by migration from https://trac.sagemath.org/ticket/30124





---

archive/issue_comments_424571.json:
```json
{
    "body": "This code from `src/sage/repl/ipython_kernel/install.py` of course needs updating so that we can install the kernel outside of the Sage venv:\n\n```\n        if prefix is None:\n            from sys import prefix\n        jupyter_dir = os.path.join(prefix, \"share\", \"jupyter\")\n        self.nbextensions_dir = os.path.join(jupyter_dir, \"nbextensions\")\n        self.kernel_dir = os.path.join(jupyter_dir, \"kernels\", self.identifier())\n        self._mkdirs()\n```\n",
    "created_at": "2020-08-04T03:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424571",
    "user": "mkoeppe"
}
```

This code from `src/sage/repl/ipython_kernel/install.py` of course needs updating so that we can install the kernel outside of the Sage venv:

```
        if prefix is None:
            from sys import prefix
        jupyter_dir = os.path.join(prefix, "share", "jupyter")
        self.nbextensions_dir = os.path.join(jupyter_dir, "nbextensions")
        self.kernel_dir = os.path.join(jupyter_dir, "kernels", self.identifier())
        self._mkdirs()
```




---

archive/issue_comments_424572.json:
```json
{
    "body": "That implies that we will have to ask a `jupyter` that is in the `PATH` to tell us about its installation `PATH`. \n\nIf we just call `jupyter kernelspec install` then it will install in a user location for a system wide jupyter (`~/.local/share/jupyter/kernels` on linux), for a sage jupyter it will probably go to the sage install (`{sys.prefix}/share/jupyter/kernels` on linux/OS X). But for distro it will become problematic straight away since you install in a stage before merging in the system tree. It is possible to pass a `--prefix` but this is not the same as `DESTDIR` which would be the useful thing for distros.",
    "created_at": "2020-08-05T21:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424572",
    "user": "fbissey"
}
```

That implies that we will have to ask a `jupyter` that is in the `PATH` to tell us about its installation `PATH`. 

If we just call `jupyter kernelspec install` then it will install in a user location for a system wide jupyter (`~/.local/share/jupyter/kernels` on linux), for a sage jupyter it will probably go to the sage install (`{sys.prefix}/share/jupyter/kernels` on linux/OS X). But for distro it will become problematic straight away since you install in a stage before merging in the system tree. It is possible to pass a `--prefix` but this is not the same as `DESTDIR` which would be the useful thing for distros.



---

archive/issue_comments_424573.json:
```json
{
    "body": "I think we will only need the following changes to `sagelib`:\n- remove the call to `sage.repl.ipython_kernel.install` from the installation steps done by sagelib's `setup.py` -- it is not compatible with modern python packaging methods anyway\n- add a `console_script` that installs a kernel spec (using `sage.repl.ipython_kernel.install`), call it `sage-kernel` (interface similar to: https://ipython.readthedocs.io/en/stable/install/kernel_install.html)\n- Change `sage-notebook` (which implements `sage -n`) to a shell script that invokes the correct jupyter (from system if installed in system, from SAGE_LOCAL if installed there)\n\nCalling `sage-kernel` would be done by sage-the-distribution (perhaps in `build/pkgs/sagelib/spkg-install`), and likewise by distribution packagers' scripts.",
    "created_at": "2020-08-05T23:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424573",
    "user": "mkoeppe"
}
```

I think we will only need the following changes to `sagelib`:
- remove the call to `sage.repl.ipython_kernel.install` from the installation steps done by sagelib's `setup.py` -- it is not compatible with modern python packaging methods anyway
- add a `console_script` that installs a kernel spec (using `sage.repl.ipython_kernel.install`), call it `sage-kernel` (interface similar to: https://ipython.readthedocs.io/en/stable/install/kernel_install.html)
- Change `sage-notebook` (which implements `sage -n`) to a shell script that invokes the correct jupyter (from system if installed in system, from SAGE_LOCAL if installed there)

Calling `sage-kernel` would be done by sage-the-distribution (perhaps in `build/pkgs/sagelib/spkg-install`), and likewise by distribution packagers' scripts.



---

archive/issue_comments_424574.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> I think we will only need the following changes to `sagelib`: ... Calling `sage-kernel` would be done by sage-the-distribution (perhaps in `build/pkgs/sagelib/spkg-install`)\n\nI'll do the first two items in #30298",
    "created_at": "2020-08-06T01:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424574",
    "user": "mkoeppe"
}
```

Replying to [comment:7 mkoeppe]:
> I think we will only need the following changes to `sagelib`: ... Calling `sage-kernel` would be done by sage-the-distribution (perhaps in `build/pkgs/sagelib/spkg-install`)

I'll do the first two items in #30298



---

archive/issue_comments_424575.json:
```json
{
    "body": "I have changed the plan a bit, see #30298 and #30299.",
    "created_at": "2020-08-06T02:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424575",
    "user": "mkoeppe"
}
```

I have changed the plan a bit, see #30298 and #30299.



---

archive/issue_comments_424576.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-07T21:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424576",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_424577.json:
```json
{
    "body": "If we attempt to automatically install the Sage jupyter kernel into the system jupyter, for example using `jupyter kernelspec install --user` as explained in #30476, we should think about how to disambiguate the kernels when working with multiple Sage installations.",
    "created_at": "2020-11-12T18:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424577",
    "user": "mkoeppe"
}
```

If we attempt to automatically install the Sage jupyter kernel into the system jupyter, for example using `jupyter kernelspec install --user` as explained in #30476, we should think about how to disambiguate the kernels when working with multiple Sage installations.



---

archive/issue_comments_424578.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424578",
    "user": "mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_424579.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424579",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_424580.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29887",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29887#issuecomment-424580",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
