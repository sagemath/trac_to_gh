# Issue 30281: eigenvectors over QQbar are incorrectly conjugated

Issue created by migration from https://trac.sagemath.org/ticket/30518

Original creator: @mwageringel

Original creation time: 2020-09-06 15:55:35

CC:  vdelecroix

In the following example from [devel](https://groups.google.com/g/sage-devel/c/9Ss98-XKR9c), the eigenvectors of a matrix over `QuadraticField(-1)` are computed in two ways, one of which incorrectly returns the conjugate of some eigenvectors.

By converting the matrix to `QQbar` first:

```
sage: K.<i> = QuadraticField(-1)
sage: m = matrix(K, 4, [2,4*i,-i,0, -4*i,2,-1,0, 2*i,-2,0,0, 4*i+4, 4*i-4,1-i,-2])
sage: sorted([(e, matrix.column(vs)) for e, vs, _ in m.change_ring(QQbar).eigenvectors_right()])
[(
    [  1   0]
    [1*I   0]
    [  0   0]
-2, [  0   1]
),
 (
                      [           1.000000000000000? + 0.?e-16*I]
                      [           0.?e-16 - 1.000000000000000?*I]
                      [           0.?e-16 - 6.605551275463989?*I]
-0.6055512754639893?, [1.000000000000000? + 1.000000000000000?*I]
),
 (
                    [           1.000000000000000? + 0.?e-17*I]
                    [           0.?e-17 - 1.000000000000000?*I]
                    [          0.?e-17 + 0.6055512754639893?*I]
6.605551275463989?, [1.000000000000000? + 1.000000000000000?*I]
)]
```


Supposedly, this result is correct. In contrast, computing the eigenvectors directly, without first converting to `QQbar`, leads to some eigenvectors getting conjugated:


```
sage: sorted([(QQbar(e), matrix.column(QQbar, vs)) for e, vs, _ in m.eigenvectors_right()])
[(
    [1 0]
    [I 0]
    [0 0]
-2, [0 1]
),
 (
                      [                                        1]
                      [           0.?e-54 + 1.000000000000000?*I]
                      [           0.?e-53 + 6.605551275463989?*I]
-0.6055512754639893?, [1.000000000000000? - 1.000000000000000?*I]
),
 (
                    [                                        1]
                    [           0.?e-53 + 1.000000000000000?*I]
                    [          0.?e-52 - 0.6055512754639893?*I]
6.605551275463989?, [1.000000000000000? - 1.000000000000000?*I]
)]
```


Note that the `QuadraticField` constructor automatically sets an embedding.

```
sage: K.coerce_embedding()
Generic morphism:
  From: Number Field in i with defining polynomial x^2 + 1 with i = 1*I
  To:   Complex Lazy Field
  Defn: i -> 1*I
```



---

Comment by slelievre created at 2021-03-24 21:38:11

Possibly related:

- #31551: Incorrect conversion from ℚ[-i] to SR


---

Comment by mmezzarobba created at 2021-03-25 09:30:05

Replying to [comment:1 slelievre]:
> Possibly related:
> 
> - #31551: Incorrect conversion from ℚ[-i] to SR

Unlike #31551, this happens with Sage 9.2 too. (The root cause may nevertheless be the same.)


---

Comment by mmezzarobba created at 2021-03-25 10:17:46

The fix now at #31551 does not solve this issue.


---

Comment by vdelecroix created at 2021-03-25 12:11:12

I think this is better illustrated with

```
sage: for e, vs, _ in m.change_ring(QQbar).eigenvectors_right():
....:     for v in vs:
....:         print(m*v == e*v)
True
True
True
True
sage: for e, vs, _ in m.eigenvectors_right():
....:     for v in vs:
....:         print(m*v == e*v)
True
True
False
False
```



---

Comment by vdelecroix created at 2021-03-25 12:30:55

The problem somehow comes from line 6638 in `matrix2.pyx`

```
m = hom(eigval.parent(), e.parent(), e)
```

What happens here is that the eigenvalue is quadratic over `QQ` (not over the base field `QQ[i]`) and that the above code does not construct the embedding that preserves the one of the base field. This can be reproduced as follows

```
sage: K.<i> = QuadraticField(-1)
sage: L = K.extension(x^2 - 6*x - 4, 'a1')
sage: eigval = L.gen()
sage: eigval_conj = eigval.galois_conjugates(QQbar)
sage: f0 = hom(eigval.parent(), QQbar, eigval_conj[0])
sage: f1 = hom(eigval.parent(), QQbar, eigval_conj[1])
sage: f0(i)  # wrong embedding!!
0.?e-54 - 1.000000000000000?*I
sage: f1(i)  # wrong embedding!!
0.?e-54 - 1.000000000000000?*I
```



---

Comment by vdelecroix created at 2021-03-25 12:37:12

Could be fixed by

```
sage: H = Hom(eigval.parent(), QQbar)
sage: f0 = H(eigval_conj[0], base_map=QQbar.coerce_map_from(K))
sage: f0(i)
0.?e-54 + 1.000000000000000?*I
```

But maybe hom should consider the embedding of the base by default when it exists?


---

Comment by vdelecroix created at 2021-03-25 12:43:40

New commits:


---

Comment by vdelecroix created at 2021-03-25 12:43:40

Changing status from new to needs_review.


---

Comment by git created at 2021-03-25 12:44:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2021-03-25 12:49:52

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2021-03-25 12:49:52

This is actually only a "partial" fix. It solves the following (that also used to fail)

```
sage: K.<i> = QuadraticField(-1, embedding=QQbar.gen())
sage: m = matrix(K, 4, [2,4*i,-i,0, -4*i,2,-1,0, 2*i,-2,0,0, 4*i+4, 4*i-4,1-i,-2])
sage: for e, vs, _ in m.eigenvectors_right():
....:     for v in vs:
....:         print(m*v == e*v)
True
True
True
True
```

But since

```
sage: K.<i> = QuadraticField(-1)                                                   
sage: QQbar.coerce_map_from(K) is None
True
```

the original example of the ticket is not solved.


---

Comment by vdelecroix created at 2021-03-25 12:52:56

As a start, you can review #31558.


---

Comment by slelievre created at 2021-04-08 09:07:51

Not fixed in Sage 9.3.rc2, in which #31551 and #31558 were merged.


---

Comment by vdelecroix created at 2021-04-08 09:15:53

Replying to [comment:13 slelievre]:
> Not fixed in Sage 9.3.rc2, in which #31551 and #31558 were merged.

See [comment:10].


---

Comment by vdelecroix created at 2021-04-08 09:40:37

To my mind, the following should raise an error

```
sage: K.<i> = QuadraticField(-1)
sage: QQbar(i)
```

(as there is no specified embedding in QQbar)


---

Comment by vdelecroix created at 2021-04-08 12:04:09

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2021-04-08 12:04:09

New commits:


---

Comment by vdelecroix created at 2021-04-08 14:39:42

patchbot is green! please review.


---

Comment by mmezzarobba created at 2021-04-08 14:50:37

But `QuadraticField(-1)` has a `coerce_embedding` into `CC`. So it seems to me that the issue with the original example is that the conversion to `QQbar` ignores the embedding. If it did not do that, the conversion could be declared as a coercion, even if with the `coerce_embedding` going to `CC`.


---

Comment by vdelecroix created at 2021-04-08 15:03:38

To my mind, the way number fields handle their coercions is far beyond the scope of this ticket. Even though I definitely agree that it is problematic. As soon as `QQbar.has_coerce_map_from(K)` answers `True` the eigenvalue/eigenvector code will work.

The minimal fix I provided turns wrong answers to errors. Together with #31551 and #31558, wrong answers are turned into right answers  when coerce embeddings to the algebraic closure are available.


---

Comment by mmezzarobba created at 2021-04-09 08:25:26

Ok, I tried to fix the problematic conversion and make it a coercion in #31628. You can set the present ticket to positive_review on my behalf if you want, or merge in my branch and adapt the tests.


---

Comment by vdelecroix created at 2021-04-09 10:40:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-09 10:56:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2021-04-09 10:56:42

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2021-04-09 11:03:28

Actually, some of my changes made sense (were more generic, only relying on the existence of algebraic closure and not assuming that it was QQbar). I opened #31631.


---

Comment by mmezzarobba created at 2021-04-09 11:21:47

I am not sure I understand: do you want to drop your original fix (0b387f7) from this ticket and recycle it in #31631? That's fine with me, but we could also keep 0b387f7 and just update it to use number fields with no complex embedding.


---

Comment by vdelecroix created at 2021-04-09 15:02:36

I want to drop it here (since it is not necessary anymore). However, going through `.algebraic_closure` (instead of hard coding `QQbar`) and checking coercion to the algebraic closure make sense. The reason why I opened #31631. I also would like to add examples related to finite field, reason why I opened an independent ticket.


---

Comment by mmezzarobba created at 2021-04-10 09:33:51

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2021-04-10 09:34:02

Ok, thanks!


---

Comment by mkoeppe created at 2021-04-18 16:13:17

Changing priority from major to blocker.


---

Comment by slelievre created at 2021-04-24 13:52:05

Does the fix here provide inspiration for these somewhat similar issues?

- [sage-support, 2021-03, NumberFieldEmbedding gets confused with relative number fields](https://groups.google.com/g/sage-support/c/tRRJ-yEPLu4/m/49UuX8i1BQAJ)
- #22008: complex_embedding on relative number fields
  is inconsistent with the base field
- #17524: polynomial for relative number field elements


---

Comment by vbraun created at 2021-04-25 12:14:07

Resolution: fixed


---

Comment by vbraun created at 2021-04-25 20:23:17

Resolution changed from fixed to 


---

Comment by vbraun created at 2021-04-25 20:23:17

Changing status from closed to new.


---

Comment by vdelecroix created at 2021-04-25 21:00:32

(back to needs review as its dependency has been hopefully fixed)
----
New commits:


---

Comment by vdelecroix created at 2021-04-25 21:00:32

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2021-04-26 16:46:15

Move to positive review since its dependency has been fixed.


---

Comment by vdelecroix created at 2021-04-26 16:46:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-04-29 21:06:01

Resolution: fixed
