# Issue 13265: Clean up SIGALRM handling in p_iter_fork

archive/issues_013265.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  simonking\n\n`sage.parallel.use_fork.p_iter_fork` uses SIGALRM for timeouts to kill workers that are taking too long. It could be that the use of signals there isn't as robust as it could be. Perhaps clean it up?\n\nIssue created by migration from https://trac.sagemath.org/ticket/13437\n\n",
    "created_at": "2012-09-07T04:32:54Z",
    "labels": [
        "component: performance",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Clean up SIGALRM handling in p_iter_fork",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13265",
    "user": "https://github.com/nbruin"
}
```
Assignee: tbd

CC:  simonking

`sage.parallel.use_fork.p_iter_fork` uses SIGALRM for timeouts to kill workers that are taking too long. It could be that the use of signals there isn't as robust as it could be. Perhaps clean it up?

Issue created by migration from https://trac.sagemath.org/ticket/13437





---

archive/issue_comments_162387.json:
```json
{
    "body": "Attachment [trac_13437-sigalrm.patch](tarball://root/attachments/some-uuid/ticket13437/trac_13437-sigalrm.patch) by @nbruin created at 2012-09-07 04:35:34\n\nFirst try at cleaner use of signal.alarm",
    "created_at": "2012-09-07T04:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162387",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_13437-sigalrm.patch](tarball://root/attachments/some-uuid/ticket13437/trac_13437-sigalrm.patch) by @nbruin created at 2012-09-07 04:35:34

First try at cleaner use of signal.alarm



---

archive/issue_comments_162388.json:
```json
{
    "body": "This patch seems to solve the issue found with #715+#11521 on bsd.math (which is OS X on Intel chips, IIRC).",
    "created_at": "2012-09-07T07:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162388",
    "user": "https://github.com/simon-king-jena"
}
```

This patch seems to solve the issue found with #715+#11521 on bsd.math (which is OS X on Intel chips, IIRC).



---

archive/issue_comments_162389.json:
```json
{
    "body": "No, it only makes the problem vanish in an interactive gdb'ed session. In the doctest, I still get:\n\n```\nbash-3.2$ ../../sage -t sage/misc/cachefunc.pyx\nsage -t  \"devel/sage-main/sage/misc/cachefunc.pyx\"          \nThe doctested process was killed by signal 11\n         [19.9 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"devel/sage-main/sage/misc/cachefunc.pyx\" # Killed/crashed\nTotal time for all tests: 19.9 seconds\nbash-3.2$ hg qa\ntrac_715_combined.patch\ntrac_715_local_refcache.patch\ntrac_715_safer.patch\ntrac_715_specification.patch\ntrac_11521_homset_weakcache_combined.patch\ntrac_11521_callback.patch\ntrac_13437-sigalrm.patch\n```\n",
    "created_at": "2012-09-07T07:51:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162389",
    "user": "https://github.com/simon-king-jena"
}
```

No, it only makes the problem vanish in an interactive gdb'ed session. In the doctest, I still get:

```
bash-3.2$ ../../sage -t sage/misc/cachefunc.pyx
sage -t  "devel/sage-main/sage/misc/cachefunc.pyx"          
The doctested process was killed by signal 11
         [19.9 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage-main/sage/misc/cachefunc.pyx" # Killed/crashed
Total time for all tests: 19.9 seconds
bash-3.2$ hg qa
trac_715_combined.patch
trac_715_local_refcache.patch
trac_715_safer.patch
trac_715_specification.patch
trac_11521_homset_weakcache_combined.patch
trac_11521_callback.patch
trac_13437-sigalrm.patch
```




---

archive/issue_comments_162390.json:
```json
{
    "body": "That's not too surprising. A SEGV is quite different from an EINTR and with what we know now, it is not so far fetched that under GDB's control, the occurrence of EINTRs is a little different. I think there is merit to the proposed patch here for general reasons.\n\nFor your SEGV problem: just dig into sage-doctest and extract the ....py file that gets run to test the doctests. That likely still triggers the SEGV and then you can run that file under other controls and/or with instrumentation. At least it'll get the doctest pipes out of your way. It's also a good way to see that doctests are run in a different environment than interactive sage use.",
    "created_at": "2012-09-07T08:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162390",
    "user": "https://github.com/nbruin"
}
```

That's not too surprising. A SEGV is quite different from an EINTR and with what we know now, it is not so far fetched that under GDB's control, the occurrence of EINTRs is a little different. I think there is merit to the proposed patch here for general reasons.

For your SEGV problem: just dig into sage-doctest and extract the ....py file that gets run to test the doctests. That likely still triggers the SEGV and then you can run that file under other controls and/or with instrumentation. At least it'll get the doctest pipes out of your way. It's also a good way to see that doctests are run in a different environment than interactive sage use.



---

archive/issue_comments_162391.json:
```json
{
    "body": "Attachment [13437_ALRM_no_interrupt.patch](tarball://root/attachments/some-uuid/ticket13437/13437_ALRM_no_interrupt.patch) by @jdemeyer created at 2012-09-07 09:24:06",
    "created_at": "2012-09-07T09:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162391",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13437_ALRM_no_interrupt.patch](tarball://root/attachments/some-uuid/ticket13437/13437_ALRM_no_interrupt.patch) by @jdemeyer created at 2012-09-07 09:24:06



---

archive/issue_comments_162392.json:
```json
{
    "body": "Apply [attachment:13437_ALRM_no_interrupt.patch] and call\n\n```\nsage.ext.c_lib.SIGALRM_set_interruptible(0)\n```\n\n**after every call** to `signal.signal(SIGALRM,...)` to disable the interrupting of system calls due to `SIGALRM` (not sure whether you want this, though).",
    "created_at": "2012-09-07T09:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162392",
    "user": "https://github.com/jdemeyer"
}
```

Apply [attachment:13437_ALRM_no_interrupt.patch] and call

```
sage.ext.c_lib.SIGALRM_set_interruptible(0)
```

**after every call** to `signal.signal(SIGALRM,...)` to disable the interrupting of system calls due to `SIGALRM` (not sure whether you want this, though).



---

archive/issue_comments_162393.json:
```json
{
    "body": "Actually, there is a Python interface for this: [http://docs.python.org/library/signal.html#signal.siginterrupt](http://docs.python.org/library/signal.html#signal.siginterrupt)",
    "created_at": "2012-09-07T09:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162393",
    "user": "https://github.com/jdemeyer"
}
```

Actually, there is a Python interface for this: [http://docs.python.org/library/signal.html#signal.siginterrupt](http://docs.python.org/library/signal.html#signal.siginterrupt)



---

archive/issue_comments_162394.json:
```json
{
    "body": "Did the #715 bug ever appear on a non-OSX system?",
    "created_at": "2012-09-07T09:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162394",
    "user": "https://github.com/jdemeyer"
}
```

Did the #715 bug ever appear on a non-OSX system?



---

archive/issue_comments_162395.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Did the #715 bug ever appear on a non-OSX system?\n\nYes and no. First of all, I have never seen the bug with #715 alone.\n\n* On bsd.math, there is the signal 11 issue with #715 plus #11521 (which are supposed to be merged together anyway), in sage/misc/cachefunc.pyx\n* On [Volker's patchbot](http://patchbot.sagemath.org/log/13370/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-08-27%2023:35:38%20+0100), a signal 11 arose with an earlier version of #13370 (which depends on #11521). The error was with sage/rings/polynomial/polynomial_real_mpfr_dense.pyx.\n* With #12876 (which depends on #11521 as well), there is a signal 11 in sage/rings/polynomial/infinite_polynomial_ring.py, again on [Volker's patchbot](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-09-03%2013:32:42%20+0100), and also on [sagepad.org](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.4.6-2.fc17.x86_64/sagepad.org/2012-09-02%2002:07:43%20+0200)",
    "created_at": "2012-09-07T11:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162395",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:7 jdemeyer]:
> Did the #715 bug ever appear on a non-OSX system?

Yes and no. First of all, I have never seen the bug with #715 alone.

* On bsd.math, there is the signal 11 issue with #715 plus #11521 (which are supposed to be merged together anyway), in sage/misc/cachefunc.pyx
* On [Volker's patchbot](http://patchbot.sagemath.org/log/13370/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-08-27%2023:35:38%20+0100), a signal 11 arose with an earlier version of #13370 (which depends on #11521). The error was with sage/rings/polynomial/polynomial_real_mpfr_dense.pyx.
* With #12876 (which depends on #11521 as well), there is a signal 11 in sage/rings/polynomial/infinite_polynomial_ring.py, again on [Volker's patchbot](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-09-03%2013:32:42%20+0100), and also on [sagepad.org](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.4.6-2.fc17.x86_64/sagepad.org/2012-09-02%2002:07:43%20+0200)



---

archive/issue_comments_162396.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n>  * On bsd.math, there is the signal 11 issue with #715 plus #11521 (which are supposed to be merged together anyway), in sage/misc/cachefunc.pyx\n>  * On [Volker's patchbot](http://patchbot.sagemath.org/log/13370/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-08-27%2023:35:38%20+0100), a signal 11 arose with an earlier version of #13370 (which depends on #11521). The error was with sage/rings/polynomial/polynomial_real_mpfr_dense.pyx.\n>  * With #12876 (which depends on #11521 as well), there is a signal 11 in sage/rings/polynomial/infinite_polynomial_ring.py, again on [Volker's patchbot](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-09-03%2013:32:42%20+0100), and also on [sagepad.org](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.4.6-2.fc17.x86_64/sagepad.org/2012-09-02%2002:07:43%20+0200)\n\nIs there any reason to assume that these 3 failures are related?  Since the doctest failures are in different files, I would guess that we're seeing 3 different bugs.",
    "created_at": "2012-09-07T11:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162396",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 SimonKing]:
>  * On bsd.math, there is the signal 11 issue with #715 plus #11521 (which are supposed to be merged together anyway), in sage/misc/cachefunc.pyx
>  * On [Volker's patchbot](http://patchbot.sagemath.org/log/13370/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-08-27%2023:35:38%20+0100), a signal 11 arose with an earlier version of #13370 (which depends on #11521). The error was with sage/rings/polynomial/polynomial_real_mpfr_dense.pyx.
>  * With #12876 (which depends on #11521 as well), there is a signal 11 in sage/rings/polynomial/infinite_polynomial_ring.py, again on [Volker's patchbot](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.5.2-3.fc17.x86_64/volker-desktop.stp.dias.ie/2012-09-03%2013:32:42%20+0100), and also on [sagepad.org](http://patchbot.sagemath.org/log/12876/Fedora/17/x86_64/3.4.6-2.fc17.x86_64/sagepad.org/2012-09-02%2002:07:43%20+0200)

Is there any reason to assume that these 3 failures are related?  Since the doctest failures are in different files, I would guess that we're seeing 3 different bugs.



---

archive/issue_comments_162397.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Is there any reason to assume that these 3 failures are related?  Since the doctest failures are in different files, I would guess that we're seeing 3 different bugs.\n\nI can't tell. I have no access to a machine where these errors occur, nobody has ever produced a backtrace of it, and I even don't know in what test in each file the error occurs, what happens with gdb, what happens verbose, etc.\nThe three errors just \"look\" the same, in the sense of the doctester reports the same problem. That's why I think that the underlying problem could be the same.",
    "created_at": "2012-09-07T12:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162397",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:9 jdemeyer]:
> Is there any reason to assume that these 3 failures are related?  Since the doctest failures are in different files, I would guess that we're seeing 3 different bugs.

I can't tell. I have no access to a machine where these errors occur, nobody has ever produced a backtrace of it, and I even don't know in what test in each file the error occurs, what happens with gdb, what happens verbose, etc.
The three errors just "look" the same, in the sense of the doctester reports the same problem. That's why I think that the underlying problem could be the same.



---

archive/issue_comments_162398.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> Apply [attachment:13437_ALRM_no_interrupt.patch] and call\n> {{{\n> sage.ext.c_lib.SIGALRM_set_interruptible(0)\n> }}}\n> **after every call** to `signal.signal(SIGALRM,...)` to disable the interrupting of system calls due to `SIGALRM` (not sure whether you want this, though).\n\nI applied the patch and changed sage/parallel/use_fork.py as follows (this should cover all instances of `signal.signal(SIGALRM,...)` in that file):\n\n```\ndiff --git a/sage/parallel/use_fork.py b/sage/parallel/use_fork.py\n--- a/sage/parallel/use_fork.py\n+++ b/sage/parallel/use_fork.py\n@@ -11,6 +11,8 @@\n #                  http://www.gnu.org/licenses/\n ################################################################################\n \n+from sage.ext.c_lib import SIGALRM_set_interruptible\n+\n class p_iter_fork:\n     \"\"\"\n     A parallel iterator implemented using ``fork()``.\n@@ -105,6 +107,7 @@\n \n         #and install our handler (saving the old one!)\n         sigalrm_orig=signal.signal(signal.SIGALRM,my_alrm_handler)\n+        SIGALRM_set_interruptible(0)\n         try:\n             while len(v) > 0 or len(workers) > 0:\n                 # Spawn up to n subprocesses\n@@ -179,6 +182,7 @@\n \n         finally:\n             signal.signal(signal.SIGALRM,sigalrm_orig) #restore original SIGALRM handler\n+            SIGALRM_set_interruptible(0)\n             # Clean up all temporary files.\n             try:\n                 for X in os.listdir(dir):\n```\n\n\nHowever, the signal 11 problem persists.",
    "created_at": "2012-09-07T12:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162398",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 jdemeyer]:
> Apply [attachment:13437_ALRM_no_interrupt.patch] and call
> {{{
> sage.ext.c_lib.SIGALRM_set_interruptible(0)
> }}}
> **after every call** to `signal.signal(SIGALRM,...)` to disable the interrupting of system calls due to `SIGALRM` (not sure whether you want this, though).

I applied the patch and changed sage/parallel/use_fork.py as follows (this should cover all instances of `signal.signal(SIGALRM,...)` in that file):

```
diff --git a/sage/parallel/use_fork.py b/sage/parallel/use_fork.py
--- a/sage/parallel/use_fork.py
+++ b/sage/parallel/use_fork.py
@@ -11,6 +11,8 @@
 #                  http://www.gnu.org/licenses/
 ################################################################################
 
+from sage.ext.c_lib import SIGALRM_set_interruptible
+
 class p_iter_fork:
     """
     A parallel iterator implemented using ``fork()``.
@@ -105,6 +107,7 @@
 
         #and install our handler (saving the old one!)
         sigalrm_orig=signal.signal(signal.SIGALRM,my_alrm_handler)
+        SIGALRM_set_interruptible(0)
         try:
             while len(v) > 0 or len(workers) > 0:
                 # Spawn up to n subprocesses
@@ -179,6 +182,7 @@
 
         finally:
             signal.signal(signal.SIGALRM,sigalrm_orig) #restore original SIGALRM handler
+            SIGALRM_set_interruptible(0)
             # Clean up all temporary files.
             try:
                 for X in os.listdir(dir):
```


However, the signal 11 problem persists.



---

archive/issue_comments_162399.json:
```json
{
    "body": "PS: I meant to say that I had applied *both* patches plus the diff given in my previous post.",
    "created_at": "2012-09-07T12:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162399",
    "user": "https://github.com/simon-king-jena"
}
```

PS: I meant to say that I had applied *both* patches plus the diff given in my previous post.



---

archive/issue_comments_162400.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> PS: I meant to say that I had applied *both* patches plus the diff given in my previous post.\n\nThe whole point of setting an alarm here is to interrupt a system call. Sage's default SIGALRM handler exits. So once we're not interested in alarms anymore, we should make sure we cancel any that we may have scheduled -- not that they get ignored.\n\nIt's mildly interesting to see that on at least one system, apparently a SIGALRM did trigger an unexpected system call termination. The `sigalrm.patch` changes two things: The type of exception that is caught (was a `RuntimeError` raised by the signal handler, now an `OSError` raised by python upon receiving an `EINTR` in os.wait) and the scheduling of alarms. Either one could have an effect, but note that it's quite likely that the observed differences in behaviour are almost certainly due to gdb's interference.",
    "created_at": "2012-09-07T16:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162400",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:12 SimonKing]:
> PS: I meant to say that I had applied *both* patches plus the diff given in my previous post.

The whole point of setting an alarm here is to interrupt a system call. Sage's default SIGALRM handler exits. So once we're not interested in alarms anymore, we should make sure we cancel any that we may have scheduled -- not that they get ignored.

It's mildly interesting to see that on at least one system, apparently a SIGALRM did trigger an unexpected system call termination. The `sigalrm.patch` changes two things: The type of exception that is caught (was a `RuntimeError` raised by the signal handler, now an `OSError` raised by python upon receiving an `EINTR` in os.wait) and the scheduling of alarms. Either one could have an effect, but note that it's quite likely that the observed differences in behaviour are almost certainly due to gdb's interference.



---

archive/issue_comments_162401.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-15T13:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162401",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162402.json:
```json
{
    "body": "What exactly is the problem that this ticket is trying to fix? Because there is no longer a problem with #715 + #11521. There is also #13311 which changes the working of `alarm()`.\n\nProposal: close this as invalid. But if the problem can be more clearly stated and still persists with #13311, go ahead.",
    "created_at": "2013-05-15T13:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162402",
    "user": "https://github.com/jdemeyer"
}
```

What exactly is the problem that this ticket is trying to fix? Because there is no longer a problem with #715 + #11521. There is also #13311 which changes the working of `alarm()`.

Proposal: close this as invalid. But if the problem can be more clearly stated and still persists with #13311, go ahead.



---

archive/issue_events_037325.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-15T13:42:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13265#event-37325"
}
```



---

archive/issue_events_037326.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-22T09:10:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13265#event-37326"
}
```



---

archive/issue_comments_162403.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2013-05-22T09:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13265#issuecomment-162403",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: invalid
