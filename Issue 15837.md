# Issue 15837: Python 3 preparation: The metaclass syntax has changed in Py

Issue created by migration from https://trac.sagemath.org/ticket/16074

Original creator: wluebbe

Original creation time: 2014-04-07 08:50:31

CC:  tscrim jdemeyer

Keywords: python3

The tool 2to3 changes the code to the new Py3 syntax. 


But the code has to depend on the Python version!

There are 30 effected modules. 

This ticket is tracked as a dependency of meta-ticket ticket:16052.


---

Comment by jdemeyer created at 2016-05-02 13:35:05

Changing component from distribution to python3.


---

Comment by chapoton created at 2017-02-28 21:20:32

first half in #22474 (combinat folder)


---

Comment by chapoton created at 2017-03-01 08:14:20

another easy step in #22479

then there remains more difficult cases


---

Comment by jdemeyer created at 2017-03-07 10:59:28

Cython files: #22537


---

Comment by chapoton created at 2017-04-06 11:56:34

`@`tscrim: I have not been able to fix the use of metaclass in 

```
* src/sage/algebras/clifford_algebra.py
* src/sage/algebras/commutative_dga.py
* src/sage/modular/modform_hecketriangle/graded_ring_element.py
```

The expected python3 replacement is

```
from six import add_metaclass

@add_metaclass(name_of_metaclass)
class something
```

But this does not work for the three mentioned files.


---

Comment by jdemeyer created at 2017-04-06 11:59:36

For reference, can you at least push the non-working branch?


---

Comment by chapoton created at 2017-04-06 12:02:21

here it is
----
New commits:


---

Comment by chapoton created at 2017-04-06 12:03:29

failing as follows

```
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/algebras/clifford_algebra.py", line 2163, in <module>
    class ExteriorAlgebraDifferential(ModuleMorphismByLinearity, UniqueRepresentation):
TypeError: Error when calling the metaclass bases
    metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
```



---

Comment by tscrim created at 2017-04-06 22:01:01

``@`add_metaclass` probably does something with the metaclass. Unless it is because of our heirarchy of metaclass...but I doubt it is that. It might be a decorator that needs to be added to the subclasses as well.


---

Comment by jdemeyer created at 2017-04-07 07:27:23

The problem is the decorator, because it works in 2 steps:

1. The class is created the usual way.

2. The decorator modifies the class to have a new metaclass.

The problem is that step 1. already fails, so the decorator cannot do anything.


---

Comment by jdemeyer created at 2017-04-07 08:11:56

I'll look into this.


---

Comment by jdemeyer created at 2017-04-07 08:23:54

Replying to [comment:8 chapoton]:
> `@`tscrim: I have not been able to fix the use of metaclass in 
> {{{
> * src/sage/algebras/clifford_algebra.py
> * src/sage/algebras/commutative_dga.py
> * src/sage/modular/modform_hecketriangle/graded_ring_element.py
> }}}

There are some other files with `__metaclass__`, such as `src/sage/structure/unique_representation.py`. Should I try to fix these on this ticket too or is there a different ticket?


---

Comment by chapoton created at 2017-04-07 08:25:54

Please fix the metaclass issue in all places where you can. There is no other ticket. I only listed the algebraic use cases. The rest is more like "sage infrastructure".


---

Comment by jdemeyer created at 2017-04-07 09:48:36

Hmm, I agree that it's not easy :-) I'm making some progress, but I'm not quite there yet.


---

Comment by git created at 2017-04-07 09:58:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-04-11 11:54:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-04-11 11:56:04

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-04-11 11:59:09

Done. The main effort here is fixing `sage.misc.six.with_metaclass` (the first of 3 commits).

After this ticket, there is no remaining Sage code using `__metaclass__`. Some doctests still use `__metaclass__`, but I suggest to fix that later.


---

Comment by tscrim created at 2017-04-11 15:40:49

I don't agree with this change (and subsequent changes from this):

```diff
diff --git a/src/sage/misc/six.py b/src/sage/misc/six.py
index 8273d91..5f03a96 100644
--- a/src/sage/misc/six.py
+++ b/src/sage/misc/six.py
@@ -8,7 +8,7 @@ from __future__ import absolute_import
 from six import *
 
 
-def with_metaclass(meta, *bases):
+def with_metaclass(*args):
     """
     Create a base class with a metaclass.
 
```

as later we require the first argument to be the meta class. So if someone happened to pass nothing, it would get an error message starting much later in the code. IMO, it also obfuscates the code a little bit too.


---

Comment by git created at 2017-04-12 07:53:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-04-12 07:54:47

Replying to [comment:22 tscrim]:
> I don't agree with this change

Fixed.


---

Comment by jdemeyer created at 2017-04-13 08:22:01

I wanted to submit these fixes to `with_metaclass` upstream to `six`. However, when looking at the original `six` code, I understood what was going wrong and it is really simple.

I also realized that it was #18503 which is the cause for the metaclass breakage. In other words, #18503 did the wrong thing and actually made everything more complicated.

It turns out that #18503 can be fixed in a much simpler way, see https://github.com/benjaminp/six/pull/191 and then this issue (#16074) simply does not occur.


---

Comment by jdemeyer created at 2017-04-13 08:24:02

That being said, I think the current solution on this ticket is structurally better than upstream's `with_metaclass`: upstream is overriding `__new__` with `__call__` which is a bit fishy. Instead, I am overriding `__call__` with `__call__` which makes more sense.


---

Comment by tscrim created at 2017-04-14 05:57:43

Makes sense to me. It's somewhat less pretty than the decorator, but this works for now and gets us closer to Python3.


---

Comment by tscrim created at 2017-04-14 05:57:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-14 19:56:17

Resolution: fixed
