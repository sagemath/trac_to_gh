# Issue 27391: py3: fix doctest with igraph

archive/issues_027391.json:
```json
{
    "body": "CC:  @dimpase\n\nKeywords: py3, graph\n\nordering issue\n\nIssue created by migration from https://trac.sagemath.org/ticket/27628\n\n",
    "created_at": "2019-04-09T12:03:26Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "py3: fix doctest with igraph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27391",
    "user": "@dcoudert"
}
```
CC:  @dimpase

Keywords: py3, graph

ordering issue

Issue created by migration from https://trac.sagemath.org/ticket/27628





---

archive/issue_comments_386036.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-04-09T12:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386036",
    "user": "@dcoudert"
}
```

New commits:



---

archive/issue_comments_386037.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-09T12:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386037",
    "user": "@dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386038.json:
```json
{
    "body": "ok, looks good enough",
    "created_at": "2019-04-09T12:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386038",
    "user": "@fchapoton"
}
```

ok, looks good enough



---

archive/issue_comments_386039.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-09T12:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386039",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386040.json:
```json
{
    "body": "Thank you Frederic for this super fast review ;)",
    "created_at": "2019-04-09T12:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386040",
    "user": "@dcoudert"
}
```

Thank you Frederic for this super fast review ;)



---

archive/issue_comments_386041.json:
```json
{
    "body": "There are a couple of failures of teh sort\n\n```\n**********************************************************************\nFile \"src/sage/graphs/generic_graph.py\", line 9581, in sage.graphs.generic_graph.GenericGraph.?\nFailed example:\n    G.pagerank(algorithm=\"igraph\")\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.generic_graph.GenericGraph.?[10]>\", line 1, in <module>\n        G.pagerank(algorithm=\"igraph\")\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 9668, in pagerank\n        raise PackageNotFoundError(\"igraph\")\n    PackageNotFoundError: the package 'igraph' was not found. You can install it by running 'sage -i igraph' in a shell\n**********************************************************************\n```\n",
    "created_at": "2019-04-11T15:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386041",
    "user": "@vbraun"
}
```

There are a couple of failures of teh sort

```
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 9581, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    G.pagerank(algorithm="igraph")
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.generic_graph.GenericGraph.?[10]>", line 1, in <module>
        G.pagerank(algorithm="igraph")
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 9668, in pagerank
        raise PackageNotFoundError("igraph")
    PackageNotFoundError: the package 'igraph' was not found. You can install it by running 'sage -i igraph' in a shell
**********************************************************************
```




---

archive/issue_comments_386042.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-11T15:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386042",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_386043.json:
```json
{
    "body": "It's not due to this ticket (nothing to do with `pagerank`) but to #27480 which adds `pagerank`. We forgot to tag doctests as `# optional - python_igraph`, and I believe it's too late so we must wait for next beta, right ?",
    "created_at": "2019-04-12T11:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386043",
    "user": "@dcoudert"
}
```

It's not due to this ticket (nothing to do with `pagerank`) but to #27480 which adds `pagerank`. We forgot to tag doctests as `# optional - python_igraph`, and I believe it's too late so we must wait for next beta, right ?



---

archive/issue_comments_386044.json:
```json
{
    "body": "Can we set this ticket back to positive review ?",
    "created_at": "2019-04-14T16:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386044",
    "user": "@dcoudert"
}
```

Can we set this ticket back to positive review ?



---

archive/issue_comments_386045.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-14T16:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386045",
    "user": "@dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_386046.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-20T12:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386046",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_386047.json:
```json
{
    "body": "I changed the way we check if igraph is installed to avoid a pyflakes error.",
    "created_at": "2019-04-20T12:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386047",
    "user": "@dcoudert"
}
```

I changed the way we check if igraph is installed to avoid a pyflakes error.



---

archive/issue_comments_386048.json:
```json
{
    "body": "looks good to me.",
    "created_at": "2019-04-23T17:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386048",
    "user": "@dimpase"
}
```

looks good to me.



---

archive/issue_comments_386049.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-23T17:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386049",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386050.json:
```json
{
    "body": "Well, let's do a follow up ticket since this is getting merged properly right now. Please refrain to introduce anymore call to `is_package_installed`, especially when checking for a python package. There is a proper python way to do this, like in the other sections of code using `igraph`- from `sage/graphs/digraph.py` line 693 onward\n\n```\n            try:\n                import igraph\n            except ImportError:\n                raise ImportError(...)\n```\n\nreplacing the `ImportError(...)` with `PackageNotFoundError` is acceptable.\n\n`is_package_installed` is a big problem for sage-on-distro and it is a filthy quick and dirty hack that shouldn't ever have been included.",
    "created_at": "2019-04-27T08:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386050",
    "user": "@kiwifb"
}
```

Well, let's do a follow up ticket since this is getting merged properly right now. Please refrain to introduce anymore call to `is_package_installed`, especially when checking for a python package. There is a proper python way to do this, like in the other sections of code using `igraph`- from `sage/graphs/digraph.py` line 693 onward

```
            try:
                import igraph
            except ImportError:
                raise ImportError(...)
```

replacing the `ImportError(...)` with `PackageNotFoundError` is acceptable.

`is_package_installed` is a big problem for sage-on-distro and it is a filthy quick and dirty hack that shouldn't ever have been included.



---

archive/issue_comments_386051.json:
```json
{
    "body": "how about a ticket for getting rid of `is_package_installed()`? Or at least making sure it's not used on importable things? \n\nI wonder what pyflakes error one sees on a seemingly good try/except.",
    "created_at": "2019-04-27T08:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386051",
    "user": "@dimpase"
}
```

how about a ticket for getting rid of `is_package_installed()`? Or at least making sure it's not used on importable things? 

I wonder what pyflakes error one sees on a seemingly good try/except.



---

archive/issue_comments_386052.json:
```json
{
    "body": "It is already on its way out. The only place it is not replaced by feature or something else at runtime is in `sage/databases/cremona.py` and there is a ticket for that. \n\nIt is currently impossible to totally remove it. doctesting with `--option=all` relies on it (or other features of `packages.py` which is just as bad) :( and building with some optional package still depends on it look in `sage_setup/optional_extension.py `. In both case replacement are not easy.",
    "created_at": "2019-04-27T08:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386052",
    "user": "@kiwifb"
}
```

It is already on its way out. The only place it is not replaced by feature or something else at runtime is in `sage/databases/cremona.py` and there is a ticket for that. 

It is currently impossible to totally remove it. doctesting with `--option=all` relies on it (or other features of `packages.py` which is just as bad) :( and building with some optional package still depends on it look in `sage_setup/optional_extension.py `. In both case replacement are not easy.



---

archive/issue_comments_386053.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-27T17:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386053",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_386054.json:
```json
{
    "body": "There is an issue with igraph on the arando patchbot with 8.8.b4 and 8.8.b5:\n\n```\n**********************************************************************\nFile \"src/sage/graphs/generic_graph.py\", line 9663, in sage.graphs.generic_graph.GenericGraph.?\nFailed example:\n    G.pagerank(alpha=0.50, algorithm=\"igraph\")  # optional - python_igraph\nExpected:\n    {0: 0.25, 1: 0.25, 2: 0.24999999999999997, 3: 0.24999999999999997}\nGot:\n    {0: 0.25, 1: 0.25, 2: 0.25, 3: 0.25}\n**********************************************************************\n1 item had failures:\n   1 of 860 in sage.graphs.generic_graph.GenericGraph.?\n    [3497 tests, 1 failure, 50.96 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/graphs/generic_graph.py  # 1 doctest failed\n```\n",
    "created_at": "2019-05-11T16:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386054",
    "user": "@fchapoton"
}
```

There is an issue with igraph on the arando patchbot with 8.8.b4 and 8.8.b5:

```
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 9663, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    G.pagerank(alpha=0.50, algorithm="igraph")  # optional - python_igraph
Expected:
    {0: 0.25, 1: 0.25, 2: 0.24999999999999997, 3: 0.24999999999999997}
Got:
    {0: 0.25, 1: 0.25, 2: 0.25, 3: 0.25}
**********************************************************************
1 item had failures:
   1 of 860 in sage.graphs.generic_graph.GenericGraph.?
    [3497 tests, 1 failure, 50.96 s]
----------------------------------------------------------------------
sage -t --long src/sage/graphs/generic_graph.py  # 1 doctest failed
```




---

archive/issue_comments_386055.json:
```json
{
    "body": "one can use a tag like `# abs tol 1e-12` and make the data \n\n```\n    {0: 0.25, 1: 0.25, 2: 0.25, 3: 0.25}\n```\n",
    "created_at": "2019-05-11T21:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386055",
    "user": "@dimpase"
}
```

one can use a tag like `# abs tol 1e-12` and make the data 

```
    {0: 0.25, 1: 0.25, 2: 0.25, 3: 0.25}
```




---

archive/issue_comments_386056.json:
```json
{
    "body": "it's what we do in #27811 ;)",
    "created_at": "2019-05-11T22:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27391",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27391#issuecomment-386056",
    "user": "@dcoudert"
}
```

it's what we do in #27811 ;)
