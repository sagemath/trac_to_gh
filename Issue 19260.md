# Issue 19260: Improve comparison framework

Issue created by migration from https://trac.sagemath.org/ticket/19497

Original creator: jdemeyer

Original creation time: 2015-10-29 11:56:48

Completely remove `Element._richcmp`. Instead, add new a function (not a method of `Element`!) `coerce_richcmp()` which replaces the different-parents case of `_richcmp`.


---

Comment by jdemeyer created at 2015-10-29 16:57:38

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-10-29 16:57:38

New commits:


---

Comment by vdelecroix created at 2015-11-03 02:17:38

These are not equivalent

```
-            elif PyInt_CheckExact(right):
+            elif isinstance(right, int):
```

As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?

Why are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`? Moreover, in the latter it is undocumented.


---

Comment by jdemeyer created at 2015-11-03 07:13:53

Replying to [comment:7 vdelecroix]:
> Why are there both a `richcmp` in `class CoercionModel_cache_maps` and `class CoercionModel`?
It needs to be in `cdef class CoercionModel` since it's the base type for `cdef class CoercionModel_cache_maps`. But the base class is never used, so it doesn't matter how I implement `richcmp()`. I just did it the way I did because it's analogous to the other methods in that base class. I also could have put `raise NotImplementedError` and it would not have made a difference.


---

Comment by jdemeyer created at 2015-11-03 07:36:44

Replying to [comment:7 vdelecroix]:
> These are not equivalent
> {{{
> -            elif PyInt_CheckExact(right):
> +            elif isinstance(right, int):
> }}}
> As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?

First of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.

If you want to give positive_review to this ticket modulo this change, I'll happily change it back.


---

Comment by vdelecroix created at 2015-11-04 12:50:05

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > These are not equivalent
> > {{{
> > -            elif PyInt_CheckExact(right):
> > +            elif isinstance(right, int):
> > }}}
> > As far as I understand, `PyInt_Check` is equivalent to `isinstance(., int)` and `PyInt_CheckExact` is equivalent to `type(.) is int`. Why did you change them in this ticket?
> 
> First of all, it's cleaner to write pure Python code than using Python C/API calls (and in this case, it's equally fast). The reason I chose `isinstance(...)` instead of `type(...) is ...` is simply because the former is usually the right thing to do. In Python, checking equality of types is not normally done.

Perhaps cython is smart enough to be as fast as a direct call to the C API but `PyInt_CheckExact` is faster than `PyInt_Check`... Do we really want to consider a thing inhering from `int` as an `int` in a comparison? Do you have a usecase that would help to decide?

For `CoercionModel` it is good as it is.


---

Comment by jdemeyer created at 2015-11-04 13:22:42

Replying to [comment:10 vdelecroix]:
> `PyInt_CheckExact` is faster than `PyInt_Check`...
Both are equally fast (and very fast).

> Do we really want to consider a thing inhering from `int` as an `int` in a comparison?
I guess so, since it will be converted to an `Integer` anyway by the coercion framework. So, the `instance()` check is really just a fast path for that.

> Do you have a usecase that would help to decide?
I don't have a particular use-case. However, given the comments above, I think that `isinstance()` is the right thing to do.


---

Comment by vdelecroix created at 2015-11-05 23:34:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-06 19:04:41

Resolution: fixed
