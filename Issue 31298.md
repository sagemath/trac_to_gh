# Issue 31298: New make targets "sagelib-sdist", "sage_docbuild-sdist", ... and "sagelib-tox-...", ...

Issue created by migration from https://trac.sagemath.org/ticket/31535

Original creator: mkoeppe

Original creation time: 2021-03-22 03:00:14

CC:  jhpalmieri dimpase @kliem mjo @tobiasdiez

For all script packages `SPKG` that have an embedded source tree -- currently `sagelib`, `sage_docbuild`, `sage_sws2rst` -- we add new targets:

- `SPKG-sdist` (which makes an sdist via the `spkg-src` script)
- `SPKG-tox`   (which calls `tox` in the package's source tree)
- `SPKG-tox-%` (which calls `tox -e %` in the package's source tree)

The new `SPKG-tox-%` targets are particularly useful for invoking them within the portability tests of the top-level `tox`:
- `$ TARGETS_PRE=config.status tox -e docker-ubuntu-focal-standard -- sage_docbuild-tox` invokes the tox testing of the `sage_docbuild` distribution
- `$ EXTRA_CONFIGURE_ARGS="--disable-notebook" tox -e docker-ubuntu-focal-standard -- build sagelib-tox-python-sagewheels-nopypi` builds (in a Docker container) the Sage distribution (without Jupyter notebook) and then invokes the tox testing of sagelib (added in #30913) in a venv populated using the wheels
- `$ EXTRA_CONFIGURE_ARGS="--disable-notebook" TARGETS_PRE=config.status tox -e local-homebrew-macos-maximal -- build-local sagelib-tox-python-sitepackages-nopypi` (added in #30913) builds the non-Python parts of the Sage distribution on top of Homebrew, using a virtual environment that uses homebrew's Python packages


---

Comment by mkoeppe created at 2021-03-22 03:03:30

New commits:


---

Comment by mkoeppe created at 2021-03-22 03:03:30

Changing status from new to needs_review.


---

Comment by git created at 2021-03-22 04:01:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-22 19:54:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-27 05:13:55

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-10-16 20:44:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-10-16 20:45:53

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-10-16 20:57:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-16 20:58:10

Reduced the scope of the ticket


---

Comment by mjo created at 2021-12-01 12:12:07

I've tried to test these locally but I always get some complaint about `sage_setup.py`. For example,


```
$ EXTRA_CONFIGURE_ARGS="--without-system-python3" tox -e local-direct -- build sagelib-tox-python-sagewheels
```


This proceeded to build everything inside of `.tox/local-direct`, but then...



```
cd '/home/mjo/src/sage.git/build/pkgs/sagelib/src' && export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin:/usr/lib/llvm/12/bin:/home/mjo/bin:/home/mjo/bin" && SAGE_SPKG_WHEELS=/home/mjo/src/sage.git/.tox/local-direct/local/var/lib/sage/wheels tox -v -v -v -e python-sagewheels
using tox.ini: /home/mjo/src/sage.git/pkgs/sagemath-standard/tox.ini (pid 12133)
  removing /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/log
using tox-3.24.4 from /usr/lib/python3.9/site-packages/tox/__init__.py (pid 12133)
GLOB start: packaging 
GLOB sdist-make: /home/mjo/src/sage.git/pkgs/sagemath-standard/setup.py
[12140] /home/mjo/src/sage.git/pkgs/sagemath-standard$ /usr/bin/python3.9 setup.py sdist --formats=zip --dist-dir /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/dist >.tox/log/GLOB-0.log
ERROR: invocation failed (exit code 1), logfile: /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/log/GLOB-0.log
================================== log start ===================================
Traceback (most recent call last):
  File "/home/mjo/src/sage.git/pkgs/sagemath-standard/setup.py", line 31, in <module>
    from sage_setup.excepthook import excepthook
ModuleNotFoundError: No module named 'sage_setup'

=================================== log end ====================================
ERROR: FAIL could not package project - v = InvocationError('/usr/bin/python3.9 setup.py sdist --formats=zip --dist-dir /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/dist', 1)
make[1]: *** [Makefile:2798: sagelib-tox-python-sagewheels] Error 2
make[1]: Leaving directory '/home/mjo/src/sage.git/build/make'

real	0m4.988s
user	0m1.223s
sys	0m0.145s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make sagelib-tox-python-sagewheels'):

It is safe to delete any log files and build directories, but they
contain information that is helpful for debugging build problems.
WARNING: If you now run 'make' again, the build directory of the
same version of the package will, by default, be deleted. Set the
environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

make: *** [Makefile:39: sagelib-tox-python-sagewheels] Error 1
ERROR: InvocationError for command /bin/bash -c 'export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin:/usr/lib/llvm/12/bin:/home/mjo/bin:/home/mjo/bin && : &&  case "" in 1|y*|Y*);; *) ./bootstrap ;; esac &&  : &&  case "" in 1|y*|Y*);; *) ./configure --prefix=/home/mjo/src/sage.git/.tox/local-direct/local --enable-experimental-packages --enable-download-from-upstream-url  --with-system-python3=yes  --without-system-python3 ;; esac &&  case "build sagelib-tox-python-sagewheels" in  bash)    bash -i; exit ;;  config*) ;;  *)       make -k V=0 base-toolchain ;;  esac &&  make -k V=0 SAGE_CHECK=warn SAGE_CHECK_PACKAGES="!cython,!r,!python3,!gap,!cysignals,!linbox,!git,!ppl,!cmake,!rpy2,!sage_sws2rst"  build sagelib-tox-python-sagewheels && ( [ -z "" ] || make -k V=0 SAGE_CHECK=warn SAGE_CHECK_PACKAGES="!cython,!r,!python3,!gap,!cysignals,!linbox,!git,!ppl,!cmake,!rpy2,!sage_sws2rst"  || echo "(error ignored)" ) ' (exited with code 2)
__________________________________________________________________________________ summary __________________________________________________________________________________
ERROR:   local-direct: commands failed
```


Is that expected (did I construct my example wrong?)


---

Comment by git created at 2021-12-01 17:35:01

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-12-01 17:36:43

Should be better with this branch


---

Comment by mkoeppe created at 2021-12-01 17:36:55

(needs `./bootstrap`)


---

Comment by mjo created at 2021-12-03 21:30:54

I just noticed these as well, probably from an empty `$CC --version` in sage_setup. No idea if they're new, I probably just happened to be looking in the right place at exactly the right time:


```
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Running command /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/python-s\
agewheels-nopypi/bin/python /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/\
python-sagewheels-nopypi/lib/python3.9/site-packages/pip/_vendor/pep517/in_proc\
ess/_in_process.py prepare_metadata_for_build_wheel /tmp/tmphl6_9kin
    /bin/sh: 1: --version: not found
```



```
  Building wheel for sagemath-standard (PEP 517): started
  Running command /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/python-sag\
ewheels-nopypi/bin/python /home/mjo/src/sage.git/pkgs/sagemath-standard/.tox/py\
thon-sagewheels-nopypi/lib/python3.9/site-packages/pip/_vendor/pep517/in_proces\
s/_in_process.py build_wheel /tmp/tmpqovldekw
  /bin/sh: 1: --version: not found
```



---

Comment by mkoeppe created at 2021-12-04 00:08:06

Yes, this is #30876


---

Comment by mjo created at 2021-12-04 01:29:16

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2021-12-04 01:29:16

Looking better now; regardless, the `Makefile` targets themselves are working as intended.


---

Comment by mkoeppe created at 2021-12-04 01:39:04

Thanks!


---

Comment by vbraun created at 2021-12-23 20:26:10

Resolution: fixed
