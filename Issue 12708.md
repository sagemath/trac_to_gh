# Issue 12708: Inconsistent domain, codomain and parent in EllipticCurveIsogeny

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2012-04-25 14:10:45

Assignee: was

CC:  sage-combinat pbruin defeo sbesnier

In the following example, the domain and codomain of phi does not match with that of its parent::


```
    sage: sage: E = EllipticCurve(j=GF(7)(0))
    sage: phi = EllipticCurveIsogeny(E, [E(0), E((0,1)), E((0,-1))])
    sage: phi.parent()
    Set of Morphisms from Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7 to Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7 in Category of hom sets in Category of Schemes
    sage: phi.parent().domain()
    Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
    sage: phi.domain()
    Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
    sage: phi.parent().codomain()
    Abelian group of points on Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
    sage: phi.codomain()
    Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7
```



---

Comment by davidloeffler created at 2013-07-25 17:32:38

Changing component from number theory to elliptic curves.


---

Comment by davidloeffler created at 2013-07-25 17:32:38

Changing assignee from was to cremona.


---

Comment by cremona created at 2014-04-07 20:08:29

I have used elliptic curve isogenies a huge amount and this has never bothered me, presumably because it never occurred to me to ask for the parent of an isogeny.  If anyone wants to change this without breaking anything they are welcome, but I don't care very much.


---

Comment by pbruin created at 2014-04-08 00:22:34

Changing priority from major to minor.


---

Comment by pbruin created at 2014-04-08 00:22:34

It should be very easy to fix in principle:

```diff
diff --git a/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py b/src/sage/schemes/e
index 5cdbbdf..a729d3a 100644
--- a/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py
+++ b/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py
`@``@` -1322,12 +1322,9 `@``@` class EllipticCurveIsogeny(Morphism):
         self._codomain = self.__E2
 
         # sets up the parent
-        parent = homset.Hom(self.__E1(0).parent(), self.__E2(0).parent())
+        parent = homset.Hom(self.__E1, self.__E2)
         Morphism.__init__(self, parent)
 
-        return
-
-
     # initializes the base field
     def __init_algebraic_structs(self, E):
         r"""
```

The only problem is that this breaks testing for equality of isogenies, due to #11474.  Suppose `E -> E1` is an isogeny and `E2` is an elliptic curve that is equal but not _identical_ to `E1`.  Then `Hom(E, E1)` and `Hom(E, E2)` will also be equal but not identical; since the coercion model assumes uniqueness of parents, it will never regard corresponding elements of `Hom(E, E1)` and `Hom(E, E2)` as equal.

For some reason the Hom sets between the groups of points, on the other hand, _are_ identical, which explains why equality testing currently is not broken.


---

Comment by sbesnier created at 2014-04-25 09:09:09

New commits:


---

Comment by sbesnier created at 2014-04-25 09:12:12

I've also make some modifications in order to make the composition working (essentially, remove the overload of `_composition_').


---

Comment by sbesnier created at 2014-04-25 10:00:11

Changing status from new to needs_review.


---

Comment by defeo created at 2014-04-25 14:55:39

Changing status from needs_review to needs_work.


---

Comment by defeo created at 2014-04-25 14:55:39

Wow. It's so cool to be finally able to compose isogenies!

There's various doctests failing in `ell_curve_isogeny.py`. Most of them are because of #11474, so they should be ok once that one's fixed. However there's one weird failure, not sure if it depends on #11474 too:


```
File "src/sage/schemes/elliptic_curves/ell_curve_isogeny.py", line 945, in sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny._call_
Failed example:
    phi(E(15,20), output_base_ring=GF(23^2,'alpha'))
Exception raised:
    Traceback (most recent call last):
      File "/home/dfl/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/dfl/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny._call_[6]>", line 1, in <module>
        phi(E(Integer(15),Integer(20)), output_base_ring=GF(Integer(23)**Integer(2),'alpha'))
      File "map.pyx", line 764, in sage.categories.map.Map.__call__ (sage/categories/map.c:5434)
      File "map.pyx", line 797, in sage.categories.map.Map._call_with_args (sage/categories/map.c:5698)
    NotImplementedError: _call_with_args not overridden to accept arguments for <class 'sage.schemes.elliptic_curves.ell_curve_isogeny.EllipticCurveIsogeny'>
```



---

Comment by sbesnier created at 2014-04-25 15:04:40

Oh I think I'm responsible for that. I've brutally renamed "!__call!__" to "_call_". I try to look at this.


---

Comment by git created at 2014-04-25 17:37:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by sbesnier created at 2014-04-25 17:39:39

Changing status from needs_work to needs_review.


---

Comment by sbesnier created at 2014-04-25 17:49:46

I've moved the "weird failure" reported at the comment 12 in #16238. Currently, the only failures on doctests depend on #11474.

It's one of the first time I use git and I had to change the history of the branch because of bad manipulations. I hope it won't bother anybody... Promise I won't do that again!


---

Comment by pbruin created at 2014-04-25 23:00:23

Replying to [comment:10 sbesnier]:
> I've also make some modifications in order to make the composition working (essentially, remove the overload of `_composition_').
This looks good to me overall.  The main thing I am wondering about is if it wouldn't make sense to keep the current version of `_composition_` (raise a `NotImplementedError`) until we have real composition of isogenies.  What I mean is that with your change, we just get a "formal" composition of two isogenies.  Although this may be good enough for some applications, what we really want is to compute the actual polynomials defining the composed isogeny.  From that perspective I wouldn't say that removing the method "makes composition work".

The question is whether it is worth having a "formal" composition in the (hopefully short!) time interval until we have "flesh-and-blood" composition of isogenies.  In other words, wouldn't it be reasonable to just make the following doctest change instead of removing the `_composition_()` method?

```diff
diff --git a/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py b/src/sage/schemes/elliptic_
curves/ell_curve_isogeny.py
index 101b81e..8b18590 100644
--- a/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py
+++ b/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py
`@``@` -3342,21 +3301,12 `@``@` class EllipticCurveIsogeny(Morphism):
             ...
             NotImplementedError

-        The following should test that :meth:`_composition_` is called
-        upon a product. However phi is currently improperly
-        constructed (see :trac:`12880`), which triggers an assertion
-        failure before the actual call ::
+        The following tests that :meth:`_composition_` is called upon
+        a product (see :trac:`12880`)::

             sage: phi*phi
             Traceback (most recent call last):
             ...
-            TypeError: Elliptic Curve defined by y^2 = x^3 + 1 over Finite Field of size 7 is not in Category of hom sets in Category of Schemes
-
-        Here would be the desired output::
-
-            sage: phi*phi            # not tested
-            Traceback (most recent call last):
-            ...
             NotImplementedError
         """
         raise NotImplementedError
```


Another small request: would it be possible to keep the doctests of `domain()` and `codomain()` and move them to another place, instead of deleting them together with the methods?


---

Comment by pbruin created at 2014-04-25 23:24:05

Alternatively, instead of the `NotImplementedError`, we could temporarily "implement" `_composition_()` as

```
return super(EllipticCurveIsogeny, self)._composition_(self, right, homset)`
```

This just calls the method of the superclass and hence is practically the same as deleting the method, but it makes it clearer where the "real" `_composition_()` will have to be implemented.


---

Comment by pbruin created at 2014-04-25 23:26:22

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2014-04-25 23:26:22

One last thing: whatever the fate of `_composition_()`, can we at least keep the doctests for that method too?


---

Comment by pbruin created at 2014-04-25 23:30:43

By the way, there is a "wishlist" ticket at #7368 that also includes composition of isogenies.  I think we should open a separate ticket for composition, since we are obviously not going to do all of #7368 at the same time.


---

Comment by defeo created at 2014-04-26 00:08:03

> This looks good to me overall.  The main thing I am wondering about is if it wouldn't make sense to keep the current version of `_composition_` (raise a `NotImplementedError`) until we have real composition of isogenies.  What I mean is that with your change, we just get a "formal" composition of two isogenies.  Although this may be good enough for some applications, what we really want is to compute the actual polynomials defining the composed isogeny.  From that perspective I wouldn't say that removing the method "makes composition work".

I'd rather say the opposite. There are applications where formal composition is the desired result.

Formal composition is essentially free, while "flesh-and-blood" composition may be expensive (exponential in the length of the chain). There are cryptosystems that exploit this fact, Sage should make it easy to implement them in a few lines of code.

I'm more in favour of using formal composition by default, and having a method (`.normalize()`, maybe?) to compute the "flesh-and-blood" version. Subsidiary question : what should equality do in this case?

> I think we should open a separate ticket for composition, since we are obviously not going to do all of #7368 at the same time. 

Agreed. It would be a better place to continue this discussion.


---

Comment by sbesnier created at 2014-04-26 20:44:04

I've corrected the things pointed by Peter (essentially, doctests).I've made a "push" but it doesnt seem to appear here...

Edit: hum... I think I have to update the "commit" attribute of the ticket, but it always fails. The new commit is : 73d99af403e760801ae2576dfbb6f7629d629f30, it's visible from sage.git : http://git.sagemath.org/sage.git/commit/?id=73d99af403e760801ae2576dfbb6f7629d629f30

What am I doing wrong?


---

Comment by sbesnier created at 2014-04-26 20:44:04

Changing status from needs_work to needs_review.


---

Comment by sbesnier created at 2014-04-26 21:52:24

New commits:


---

Comment by sbesnier created at 2014-04-26 22:10:52

New commits:


---

Comment by defeo created at 2014-04-26 22:45:06

> Edit: hum... I think I have to update the "commit" attribute of the ticket, but it always fails. The new commit is : 73d99af403e760801ae2576dfbb6f7629d629f30, it's visible from sage.git : http://git.sagemath.org/sage.git/commit/?id=73d99af403e760801ae2576dfbb6f7629d629f30

The 'commit' field is not meant to be edited manually. Changing it has no effect.

There are two similarly named branches on trac: `u/sbesnier/ticket/12880` and `u/sbesnier/ticket12880`. Maybe you wanted the second one (change the 'branch' field in this case).


---

Comment by sbesnier created at 2014-04-26 22:46:35

New commits:


---

Comment by pbruin created at 2014-04-28 11:23:55

A few small stylistic comments about docstrings:
- To refer to Trac tickets, use the syntax `:trac:`12880`` (in the HTML documentation, this is expanded to "Trac ticket 12880" and becomes a link).
- Usually `TESTS:` or `TESTS::` is kept on a line by itself and, if relevant, there is a separate line of explanation referring to the specific issue, i.e. one of the following:

```
TESTS::

    sage: 2 + 2
    4

----

TESTS:

Check that `2 + 2 = 4` (see :trac:`12880`)::

    sage: 2 + 2
    4
```

- In English, unlike in French, there is no space before the punctuation marks : ; ? !


---

Comment by git created at 2014-04-28 11:52:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-07-16 21:41:28

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-07-16 21:41:28

I'm happy with this and it passes all tests (when the dependencies are merged, of course).  The reviewer patch just fixes a trivial merge conflict and whitespace.


---

Comment by pbruin created at 2014-07-16 21:41:28

Changing keywords from "" to "isogeny".


---

Comment by vbraun created at 2014-07-17 13:57:30

Resolution: fixed
