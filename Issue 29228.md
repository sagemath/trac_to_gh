# Issue 29228: asymptotics: sign error in cohomology decomposition

archive/issues_029228.json:
```json
{
    "body": "CC:  @dkrenn araichev @cheuberg @behackl @antonio-rojas\n\nThis ticket fixes a sign error in the method `cohomology_decomposition` in `asymptotics_multivariate_generating_functions.py`. This problem currently blocks the upgrade of Singular [ticket:25993#comment:62].\n\nThe method `cohomology_decomposition` of `FractionWithFactoredDenominator` computes a cohomologous form in which each factor in the denominator appears to the power of at most one. The implementation very closely follows the proof of [AY1983, Theorem 17.4](https://doc.sagemath.org/html/en/reference/references/index.html#ay1983).\n\nThe sign error arises as follows. In equation (17.11), the form is written in coordinates\n\n```\ndz_{j_1} \u2227 \u2026 \u2227 dz_{j_m} \u2227 dz_1 \u2227 \u2026 [j_1,\u2026,j_m] \u2026 \u2227 dz_n\n```\nso that the indices `j_1,\u2026,j_m` appear before the other indices, and therefore the parity sign `\u03b5[J]` of the permutation that sorts the `j_1,\u2026,j_m` to the front appears in this equation.\n\nThe computation in Sage however represents the form as `dz_1 \u2227 \u2026 \u2227 dz_n` without permuting \u2013 after all, it takes the sum of multiple such terms \u2013 and therefore the parity sign should not be used in this computation, but currently it is. (In the implemetation, `[z_1,\u2026,z_n]` is called `X`.)\n\nAn example that fails:\n\n```\nsage: from sage.rings.asymptotic.asymptotics_multivariate_generating_functions import FractionWithFactoredDenominatorRing\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: FFPD = FractionWithFactoredDenominatorRing(R)\nsage: p = 1\nsage: qs = [(x*y - 1, 1), (x**2 + y**2 - 1, 2)]\nsage: f = FFPD(p, qs)\nsage: f.cohomology_decomposition()\n(0, []) + (4/3*x*y + 4/3, [(x^2 + y^2 - 1, 1)]) + (1/3, [(x*y - 1, 1), (x^2 + y^2 - 1, 1)])\n```\n\nOne can check using pen and paper that the correct result in this case would be:\n\n```\n(0, []) + (-4/3*x*y, [(x^2 + y^2 - 1, 1)]) + (1/3, [(x*y - 1, 1), (x^2 + y^2 - 1, 1)])\n```\n\n(Though note that the result depends on the concrete choice of Nullstellensatz representatives in the call to `lift()`.)\n\nIn particular this ticket solves the problem mentioned in [ticket:25993#comment:62] that the `relative_error` does not become small when Singular 4.1.2p4 chooses different representatives in the call to `lift()`.\n\nThe internally used function `permutation_sign` is not needed anymore and therefore deprecated.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29465\n\n",
    "closed_at": "2020-04-09T22:44:13Z",
    "created_at": "2020-04-04T20:16:14Z",
    "labels": [
        "component: asymptotic expansions",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "asymptotics: sign error in cohomology decomposition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29228",
    "user": "https://github.com/mwageringel"
}
```
CC:  @dkrenn araichev @cheuberg @behackl @antonio-rojas

This ticket fixes a sign error in the method `cohomology_decomposition` in `asymptotics_multivariate_generating_functions.py`. This problem currently blocks the upgrade of Singular [ticket:25993#comment:62].

The method `cohomology_decomposition` of `FractionWithFactoredDenominator` computes a cohomologous form in which each factor in the denominator appears to the power of at most one. The implementation very closely follows the proof of [AY1983, Theorem 17.4](https://doc.sagemath.org/html/en/reference/references/index.html#ay1983).

The sign error arises as follows. In equation (17.11), the form is written in coordinates

```
dz_{j_1} ∧ … ∧ dz_{j_m} ∧ dz_1 ∧ … [j_1,…,j_m] … ∧ dz_n
```
so that the indices `j_1,…,j_m` appear before the other indices, and therefore the parity sign `ε[J]` of the permutation that sorts the `j_1,…,j_m` to the front appears in this equation.

The computation in Sage however represents the form as `dz_1 ∧ … ∧ dz_n` without permuting – after all, it takes the sum of multiple such terms – and therefore the parity sign should not be used in this computation, but currently it is. (In the implemetation, `[z_1,…,z_n]` is called `X`.)

An example that fails:

```
sage: from sage.rings.asymptotic.asymptotics_multivariate_generating_functions import FractionWithFactoredDenominatorRing
sage: R.<x,y> = PolynomialRing(QQ)
sage: FFPD = FractionWithFactoredDenominatorRing(R)
sage: p = 1
sage: qs = [(x*y - 1, 1), (x**2 + y**2 - 1, 2)]
sage: f = FFPD(p, qs)
sage: f.cohomology_decomposition()
(0, []) + (4/3*x*y + 4/3, [(x^2 + y^2 - 1, 1)]) + (1/3, [(x*y - 1, 1), (x^2 + y^2 - 1, 1)])
```

One can check using pen and paper that the correct result in this case would be:

```
(0, []) + (-4/3*x*y, [(x^2 + y^2 - 1, 1)]) + (1/3, [(x*y - 1, 1), (x^2 + y^2 - 1, 1)])
```

(Though note that the result depends on the concrete choice of Nullstellensatz representatives in the call to `lift()`.)

In particular this ticket solves the problem mentioned in [ticket:25993#comment:62] that the `relative_error` does not become small when Singular 4.1.2p4 chooses different representatives in the call to `lift()`.

The internally used function `permutation_sign` is not needed anymore and therefore deprecated.


Issue created by migration from https://trac.sagemath.org/ticket/29465





---

archive/issue_comments_413773.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-04-04T20:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413773",
    "user": "https://github.com/mwageringel"
}
```

New commits:



---

archive/issue_comments_413774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-04T20:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413774",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_413775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-05T08:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413775",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_413776.json:
```json
{
    "body": "Wow, you have been digging deep! Do you by any chance have an e-copy of [AY1983]?\n\nBy the way, is there a meausure-theoretic meaning to these differential forms, in the sense that they might be approximating integration over a semialgebraic (?) set determined by the demoninator w.r.t. to the density specified by the numerator?\n\nAt least this is that case if the denominator is a product of linear functions.\n(there, the linear functions correspond to vertices of a polyhedron, and the integration\nis over this polyhedron, with piecewise-polynomial denisties).",
    "created_at": "2020-04-05T08:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413776",
    "user": "https://github.com/dimpase"
}
```

Wow, you have been digging deep! Do you by any chance have an e-copy of [AY1983]?

By the way, is there a meausure-theoretic meaning to these differential forms, in the sense that they might be approximating integration over a semialgebraic (?) set determined by the demoninator w.r.t. to the density specified by the numerator?

At least this is that case if the denominator is a product of linear functions.
(there, the linear functions correspond to vertices of a polyhedron, and the integration
is over this polyhedron, with piecewise-polynomial denisties).



---

archive/issue_comments_413777.json:
```json
{
    "body": "Thank you for the review.\n\nReplying to [comment:2 dimpase]:\n> Do you by any chance have an e-copy of [AY1983]?\n\n\nSorry, I don't.\n\n> By the way, is there a meausure-theoretic meaning to these differential forms, in the sense that they might be approximating integration over a semialgebraic (?) set determined by the demoninator w.r.t. to the density specified by the numerator?\n> \n> At least this is that case if the denominator is a product of linear functions.\n> (there, the linear functions correspond to vertices of a polyhedron, and the integration\n> is over this polyhedron, with piecewise-polynomial denisties).\n\n\nI wish I could answer this question. It is something I would be interested in myself as well.",
    "created_at": "2020-04-05T12:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413777",
    "user": "https://github.com/mwageringel"
}
```

Thank you for the review.

Replying to [comment:2 dimpase]:
> Do you by any chance have an e-copy of [AY1983]?


Sorry, I don't.

> By the way, is there a meausure-theoretic meaning to these differential forms, in the sense that they might be approximating integration over a semialgebraic (?) set determined by the demoninator w.r.t. to the density specified by the numerator?
> 
> At least this is that case if the denominator is a product of linear functions.
> (there, the linear functions correspond to vertices of a polyhedron, and the integration
> is over this polyhedron, with piecewise-polynomial denisties).


I wish I could answer this question. It is something I would be interested in myself as well.



---

archive/issue_events_075099.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-09T22:44:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29228#event-75099"
}
```



---

archive/issue_comments_413778.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-09T22:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29228#issuecomment-413778",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
