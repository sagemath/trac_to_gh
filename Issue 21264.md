# Issue 21264: Allow SAGE_LOCAL to be customized

archive/issues_021264.json:
```json
{
    "body": "CC:  @mkoeppe\n\nSee #21479 for the rationale.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21501\n\n",
    "created_at": "2016-09-15T11:07:50Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Allow SAGE_LOCAL to be customized",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21264",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @mkoeppe

See #21479 for the rationale.

Issue created by migration from https://trac.sagemath.org/ticket/21501





---

archive/issue_comments_294740.json:
```json
{
    "body": "that seems to make sense. but it's dangerous really. SAGE_LOCAL is an internal directory and an implementation detail currently.\n\nif you expose this, users will start expecting stuff in SAGE_LOCAL created by the build process. an ideal build process does not (will not/should not) use SAGE_LOCAL. any transition to fixing this will heavily interfere with user experience (only if they override SAGE_LOCAL, of course).\n\nok, now i explained why \"set prefix==SAGE_LOCAL\" is probably not a good idea. and here, an alternative, \"expose SAGE_LOCAL\", appears to be much worse... hmm\n\nthere's a problem here. can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?\n\nthanks",
    "created_at": "2016-09-15T11:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294740",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

that seems to make sense. but it's dangerous really. SAGE_LOCAL is an internal directory and an implementation detail currently.

if you expose this, users will start expecting stuff in SAGE_LOCAL created by the build process. an ideal build process does not (will not/should not) use SAGE_LOCAL. any transition to fixing this will heavily interfere with user experience (only if they override SAGE_LOCAL, of course).

ok, now i explained why "set prefix==SAGE_LOCAL" is probably not a good idea. and here, an alternative, "expose SAGE_LOCAL", appears to be much worse... hmm

there's a problem here. can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?

thanks



---

archive/issue_comments_294741.json:
```json
{
    "body": "Replying to [comment:1 felixs]:\n> SAGE_LOCAL is an internal directory and an implementation detail currently.\n\nI am not changing that. I still consider it an implementation detail.\n\n> can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?\n\nI am allowing Sage to be installed in a custom directory, which is not `$SAGE_ROOT/local`.",
    "created_at": "2016-09-15T13:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294741",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 felixs]:
> SAGE_LOCAL is an internal directory and an implementation detail currently.

I am not changing that. I still consider it an implementation detail.

> can you please give some more insight on what you are trying to achieve with the customized SAGE_LOCAL?

I am allowing Sage to be installed in a custom directory, which is not `$SAGE_ROOT/local`.



---

archive/issue_comments_294742.json:
```json
{
    "body": "> I am allowing Sage to be installed in a custom directory,\n\nSAGE_LOCAL cannot be the installation directory *and* an implementation detail.\n\nbut you seem to have your own definition for both these terms, rendering this discussion pointless.",
    "created_at": "2016-09-15T13:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294742",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

> I am allowing Sage to be installed in a custom directory,

SAGE_LOCAL cannot be the installation directory *and* an implementation detail.

but you seem to have your own definition for both these terms, rendering this discussion pointless.



---

archive/issue_comments_294743.json:
```json
{
    "body": "Replying to [comment:3 felixs]:\n> > I am allowing Sage to be installed in a custom directory,\n> \n> SAGE_LOCAL cannot be the installation directory *and* an implementation detail.\n\nThe current reality is that `$SAGE_LOCAL` is the installation directory and an implementation detail. So I am really not changing that.",
    "created_at": "2016-09-15T15:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294743",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 felixs]:
> > I am allowing Sage to be installed in a custom directory,
> 
> SAGE_LOCAL cannot be the installation directory *and* an implementation detail.

The current reality is that `$SAGE_LOCAL` is the installation directory and an implementation detail. So I am really not changing that.



---

archive/issue_comments_294744.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> The current reality\n\nyou put \"Allow SAGE_LOCAL to be customized\" into the title. this (to me) implies that SAGE_LOCAL would become a user controlled variable (see above). i hope not! but is it really your intent?\n\ni figured, that maybe/actually/hopefully you want to introduce prefix (defaulting to $(builddir)/local), then set SAGE_LOCAL=prefix. then do some modifications so the rest of dist can cope with it.\n\nabout the title... what about \"implement pretend-prefix using SAGE_LOCAL\" or \"use SAGE_LOCAL to implement pretend-prefix\"? (yes, \"pretend\", because it will look like prefix to the user, while the build process will still write to it).",
    "created_at": "2016-09-15T16:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294744",
    "user": "https://trac.sagemath.org/admin/accounts/users/felixs"
}
```

Replying to [comment:4 jdemeyer]:
> The current reality

you put "Allow SAGE_LOCAL to be customized" into the title. this (to me) implies that SAGE_LOCAL would become a user controlled variable (see above). i hope not! but is it really your intent?

i figured, that maybe/actually/hopefully you want to introduce prefix (defaulting to $(builddir)/local), then set SAGE_LOCAL=prefix. then do some modifications so the rest of dist can cope with it.

about the title... what about "implement pretend-prefix using SAGE_LOCAL" or "use SAGE_LOCAL to implement pretend-prefix"? (yes, "pretend", because it will look like prefix to the user, while the build process will still write to it).



---

archive/issue_comments_294745.json:
```json
{
    "body": "Jeroen, are you working on this? \nWhich changes should go into this ticket, and which changes into #21479?",
    "created_at": "2016-09-15T16:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294745",
    "user": "https://github.com/mkoeppe"
}
```

Jeroen, are you working on this? 
Which changes should go into this ticket, and which changes into #21479?



---

archive/issue_comments_294746.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Jeroen, are you working on this?\n\nYes.\n\n> Which changes should go into this ticket, and which changes into #21479?\n\nMy idea is that this ticket simply allows `SAGE_LOCAL` to be set to a different directory and that #21479 implements the `./configure` logic to automatically set `SAGE_LOCAL` to the `--prefix` given.",
    "created_at": "2016-09-15T16:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294746",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 mkoeppe]:
> Jeroen, are you working on this?

Yes.

> Which changes should go into this ticket, and which changes into #21479?

My idea is that this ticket simply allows `SAGE_LOCAL` to be set to a different directory and that #21479 implements the `./configure` logic to automatically set `SAGE_LOCAL` to the `--prefix` given.



---

archive/issue_comments_294747.json:
```json
{
    "body": "OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?",
    "created_at": "2016-09-15T16:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294747",
    "user": "https://github.com/mkoeppe"
}
```

OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?



---

archive/issue_comments_294748.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?\n\nYes.",
    "created_at": "2016-09-15T17:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294748",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 mkoeppe]:
> OK, great. I assume that you can test #21501 separately by just setting an environment variable, so #21501 should be a prereq of #21479, correct?

Yes.



---

archive/issue_comments_294749.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-09-15T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294749",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_294750.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-15T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294750",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_294751.json:
```json
{
    "body": "\n```diff\n--- a/build/pkgs/autotools/spkg-write-makefile\n+++ b/build/pkgs/autotools/spkg-write-makefile\n@@ -45,8 +45,8 @@ source version-list\n # Extract upstream autotools tarball\n cd \"$SAGE_ROOT\"\n PKG=autotools-`cat build/pkgs/autotools/package-version.txt`\n-mkdir -p local/var/tmp/sage\n-cd \"$SAGE_ROOT/local/var/tmp/sage\"\n+mkdir -p \"$SAGE_LOCAL/tmp/sage\"\n+cd \"$SAGE_LOCAL/tmp/sage\"\n tar xjf \"$SAGE_ROOT/upstream/$PKG.tar.bz2\"\n cd $PKG\n```\n\nWas dropping \"var\" intentional?",
    "created_at": "2016-09-15T21:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294751",
    "user": "https://github.com/mkoeppe"
}
```


```diff
--- a/build/pkgs/autotools/spkg-write-makefile
+++ b/build/pkgs/autotools/spkg-write-makefile
@@ -45,8 +45,8 @@ source version-list
 # Extract upstream autotools tarball
 cd "$SAGE_ROOT"
 PKG=autotools-`cat build/pkgs/autotools/package-version.txt`
-mkdir -p local/var/tmp/sage
-cd "$SAGE_ROOT/local/var/tmp/sage"
+mkdir -p "$SAGE_LOCAL/tmp/sage"
+cd "$SAGE_LOCAL/tmp/sage"
 tar xjf "$SAGE_ROOT/upstream/$PKG.tar.bz2"
 cd $PKG
```

Was dropping "var" intentional?



---

archive/issue_comments_294752.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> Was dropping \"var\" intentional?\n\nYes, it was. This is a really temporary directory. So it should be `tmp`, not `var/tmp`.",
    "created_at": "2016-09-16T05:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294752",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 mkoeppe]:
> Was dropping "var" intentional?

Yes, it was. This is a really temporary directory. So it should be `tmp`, not `var/tmp`.



---

archive/issue_comments_294753.json:
```json
{
    "body": "It seems a bit unusual, I don't think there's such a thing as a tmp directory other than `/tmp` or more precisely, whatever `mktemp(1)` provides.\n\nBut I don't insist. It's just a maintenance script for autotools, after all.",
    "created_at": "2016-09-16T06:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294753",
    "user": "https://github.com/mkoeppe"
}
```

It seems a bit unusual, I don't think there's such a thing as a tmp directory other than `/tmp` or more precisely, whatever `mktemp(1)` provides.

But I don't insist. It's just a maintenance script for autotools, after all.



---

archive/issue_comments_294754.json:
```json
{
    "body": "In any case, I have installed Sage with this patch to a custom `$SAGE_LOCAL` directory and all doctests pass. I also tested the command line, SageNB and the Jupyter notebook.",
    "created_at": "2016-09-16T07:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294754",
    "user": "https://github.com/jdemeyer"
}
```

In any case, I have installed Sage with this patch to a custom `$SAGE_LOCAL` directory and all doctests pass. I also tested the command line, SageNB and the Jupyter notebook.



---

archive/issue_comments_294755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-16T07:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294755",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_294756.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-17T20:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294756",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_294757.json:
```json
{
    "body": "Interesting and I see Volker already merged it. Guys, I am expecting the link `src/doc/common/themes/sage/static/thebe.js` which is pointing to `../../../../../../local/share/thebe/thebe.js` to be dangling for you. I have no solution for you, I usually deal with those at the package manager level. Although in that particular case I just added `thebe.js` to the source in place.",
    "created_at": "2016-09-17T20:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294757",
    "user": "https://github.com/kiwifb"
}
```

Interesting and I see Volker already merged it. Guys, I am expecting the link `src/doc/common/themes/sage/static/thebe.js` which is pointing to `../../../../../../local/share/thebe/thebe.js` to be dangling for you. I have no solution for you, I usually deal with those at the package manager level. Although in that particular case I just added `thebe.js` to the source in place.



---

archive/issue_comments_294758.json:
```json
{
    "body": "Oh, there's a symbolic link in our sources?",
    "created_at": "2016-09-18T05:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294758",
    "user": "https://github.com/mkoeppe"
}
```

Oh, there's a symbolic link in our sources?



---

archive/issue_comments_294759.json:
```json
{
    "body": "I've created #21527 for this and other cleanup issues for this patch.",
    "created_at": "2016-09-18T05:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294759",
    "user": "https://github.com/mkoeppe"
}
```

I've created #21527 for this and other cleanup issues for this patch.



---

archive/issue_comments_294760.json:
```json
{
    "body": "This didn't exist when this ticket was created:\n\n```\n$ ls src/doc/common/themes/sage/static/thebe.js\nls: cannot access src/doc/common/themes/sage/static/thebe.js: No such file or directory\n```\n",
    "created_at": "2016-09-18T10:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21264",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21264#issuecomment-294760",
    "user": "https://github.com/jdemeyer"
}
```

This didn't exist when this ticket was created:

```
$ ls src/doc/common/themes/sage/static/thebe.js
ls: cannot access src/doc/common/themes/sage/static/thebe.js: No such file or directory
```

