# Issue 17350: ToricLattice: fix use of span() and span_of_basis()

Issue created by migration from https://trac.sagemath.org/ticket/17587

Original creator: jdemeyer

Original creation time: 2015-01-05 18:41:05

CC:  vbraun novoselt

The methods `span` and `span_of_basis` of `ToricLattice_generic` should work when given a `base_ring` and such a `base_ring` must be given whenever the elements of the basis are not integers.

This is needed in preparation of #17585, where

```
sage: N = ToricLattice(3)
sage: Ns = N.span_of_basis([(1,2,3)])
sage: Ns.span_of_basis([(2,4,0)])
Sublattice <N(2, 4, 0)>
sage: Ns.span_of_basis([(1/5,2/5,0), (1/7,1/7,0)])
```

will become an error, since the ring is assumed to be `ZZ` but the elements are actually rationals.


---

Comment by jdemeyer created at 2015-01-05 18:58:01

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-01-05 18:58:01

New commits:


---

Comment by novoselt created at 2015-01-05 19:07:55

Changing status from needs_review to needs_info.


---

Comment by novoselt created at 2015-01-05 19:07:55

Why QQ was added in the last line? It seems to me that a saturated sublattice should be constructed there, without any fractional generators.


---

Comment by jdemeyer created at 2015-01-05 22:37:27

Replying to [comment:4 novoselt]:
> Why QQ was added in the last line? It seems to me that a saturated sublattice should be constructed there, without any fractional generators.

I don't completely understand what you mean, but the problem is that `base_cone_preimg` can have coefficients in `QQ`. So either we add `QQ` there, or we change the `span()` method to not default to `ZZ`.


---

Comment by novoselt created at 2015-01-05 22:58:02

But the module is over ZZ for the sake of using saturation, which works differently for QQ:

```
sage: M = ZZ^3
sage: M.span_of_basis([(1,1/2,1/3)])
Free module of degree 3 and rank 1 over Integer Ring
User basis matrix:
[  1 1/2 1/3]
sage: _.saturation()
Free module of degree 3 and rank 1 over Integer Ring
Echelon basis matrix:
[6 3 2]
sage: M.span_of_basis([(1,1/2,1/3)], QQ)
Vector space of degree 3 and dimension 1 over Rational Field
User basis matrix:
[  1 1/2 1/3]
sage: _.saturation()
Vector space of degree 3 and dimension 1 over Rational Field
User basis matrix:
[  1 1/2 1/3]
```



---

Comment by git created at 2015-01-06 08:23:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-01-06 08:24:37

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2015-01-06 08:24:37

I think this is a better solution then.


---

Comment by git created at 2015-01-06 08:27:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2015-01-07 20:43:09

I don't think such complications are necessary and what exactly is the point of this ticket? The example from the descriptions currently gives

```
sage: sage: N = ToricLattice(3)
sage: sage: Ns = N.span_of_basis([(1,2,3)])
sage: sage: Ns.span_of_basis([(1/5,2/5,0), (1/7,1/7,0)])
Sublattice <(1/5, 2/5, 0), (1/7, 1/7, 0)>
```

and perhaps this can be claimed as a bug unrelated to any coming changes - there is nothing wrong with the span call on fractional vectors, but calling it a sublattice is strange/wrong (even if it looks to me that I am the one who allowed it). The solution should be, I think: try to return a sublattice and if it does not work because given vectors are not integral or a different ring is requested - return a free module with the same dimension etc.

In particular there will be no need to mess with the morphism code at all.

It is a bit unfortunate that we have

```
sage: N.change_ring(QQ) is N.dual().change_ring(QQ)
True
```

but fixing it is quite a bit of work, since basically I want named modules which are isomorphic but have no canonical isomorphism, as it is the case with ``N`` and ``N.dual()``.


---

Comment by jdemeyer created at 2015-01-07 21:42:26

Replying to [comment:10 novoselt]:
> I don't think such complications are necessary and what exactly is the point of this ticket? The example from the descriptions currently gives
> {{{
> sage: sage: N = ToricLattice(3)
> sage: sage: Ns = N.span_of_basis([(1,2,3)])
> sage: sage: Ns.span_of_basis([(1/5,2/5,0), (1/7,1/7,0)])
> Sublattice <(1/5, 2/5, 0), (1/7, 1/7, 0)>
> }}}
> and perhaps this can be claimed as a bug unrelated to any coming changes - there is nothing wrong with the span call on fractional vectors, but calling it a sublattice is strange/wrong (even if it looks to me that I am the one who allowed it).
What's wrong is this:

```
sage: N = ToricLattice(3)
sage: Ns = N.span_of_basis([(1,2,3)])
sage: M1 = Ns.span_of_basis([(1,2,0), (1,1,0)])
sage: type(M1.basis()[0])
<type 'sage.geometry.toric_lattice_element.ToricLatticeElement'>
sage: M2 = Ns.span_of_basis([(1/5,2/5,0), (1/7,1/7,0)])
sage: type(M2.basis()[0])
<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>
```

You have a `ToricLattice_generic`, but the basis consists simply of rational vectors, having nothing to do with lattices. The fact that this does _not_ raise an exception is a bug which I'm fixing in #17585: if `ToricLattice_generic` states `Element = ToricLatticeElement`, the module code shouldn't change this.

> The solution should be, I think: try to return a sublattice and if it does not work because given vectors are not integral or a different ring is requested - return a free module with the same dimension etc.
That _could_ be a solution, but I prefer to be explicit. With my solution, you at least know and expect that the result won't be a toric lattice.


---

Comment by novoselt created at 2015-01-07 22:47:23

The span of given vectors over given field should either exist or not, and what it is should not depend on some strange keyword parameter whose existence is impossible to guess (and documenting them is not quite a solution - who will read `span` documentation for each class they use???

Toric lattices were designed to implement "named" copies of `ZZ^n` and their sublattices and (free) quotients. `Sublattice <(1/5, 2/5, 0), (1/7, 1/7, 0)>` or some generic toric lattice on these vectors most probably just should not exist.


---

Comment by novoselt created at 2015-01-07 22:48:20

Volker, do you have any preferences about it?


---

Comment by vbraun created at 2015-01-08 00:13:39

Whats the question?
* If possible then `M.span()` should raise an error if the given vectors do not lie in `M`
* I don't mind a shortcut `M.span(..., base_ring=QQ)` for `M.change_ring(QQ).span(...)`.


---

Comment by novoselt created at 2015-01-08 00:24:27

Replying to [comment:14 vbraun]:
> Whats the question?
> * If possible then `M.span()` should raise an error if the given vectors do not lie in `M`
> * I don't mind a shortcut `M.span(..., base_ring=QQ)` for `M.change_ring(QQ).span(...)`.

My objection is to `toric` in `M.span(..., toric=True/False)` as obscure.

Whether it is OK to call `M.span(...)` for vectors not in `M` but in `M.change_ring(QQ)` is a more general question. Certainly it should be possible to make a module of integral combinations of rational vectors. The question is what should be the interface for it.


---

Comment by vbraun created at 2015-01-08 01:09:38

Oh ok, I don't like the toric=True option either. 

Can we (easily) change the toric code so that we don't have to rely on `M_ZZ.span(QQ-vectors)` at all?


---

Comment by novoselt created at 2015-01-08 01:13:46

I think so - for the morphism code we care about directions only, as we are taking saturation in the end. A call to `normalize_rays` should work there without much performance loss. Will try to write a patch tomorrow - got to catch a bus!


---

Comment by jdemeyer created at 2015-01-08 08:06:36

Replying to [comment:12 novoselt]:
> `Sublattice <(1/5, 2/5, 0), (1/7, 1/7, 0)>` or some generic toric lattice on these vectors most probably just should not exist.
After #17585 it won't exist anymore.


---

Comment by jdemeyer created at 2015-01-08 20:52:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-01-08 20:52:44

The commit just points to

```
commit 9e13c1b5422e475827e3c3d3a5daf61a4b0ebc57
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Mon Jan 5 22:57:05 2015 +0100

    Updated Sage version to 6.5.beta5
```



---

Comment by git created at 2015-01-08 21:08:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2015-01-08 21:11:36

Yes, I forgot to commit, but then though of a simpler way. Basically, I just create now generic module instead of a toric sublattice when generators are not integral. This is in line with how other `span` methods work and hopefully will be sufficient for the switch you are working on.


---

Comment by novoselt created at 2015-01-09 05:17:48

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-01-21 16:31:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-01-21 16:31:49

I don't really like the solution, but it works and that suffices for me.


---

Comment by novoselt created at 2015-01-21 18:46:46

What exactly is the problem? I see two:
 1. `N.span` works at all for elements that do not generate a submodule of `N`.
 2. `N.span` for a toric lattice returns a non-toric thing.
But 1 is the way Sage works, so if it is changed it is better be changed everywhere and it will break a lot of user code too. As for 2 - writing custom classes for `N \otimes QQ` and its submodule would be useful, but is not the top priority for me personally and we managed to go a long way in toric stuff without implementing it...


---

Comment by jdemeyer created at 2015-01-21 19:11:15

Replying to [comment:26 novoselt]:
> What exactly is the problem?
Mainly the fact that the difference between returning a toric lattice and a free module is done very implicitly. In particular, there is no way to force the returning of a free module (as opposed to a toric lattice).

Sage is supposed to have the philosophy that the _type_ of the output should only depend on the _type_ of the input, not the _values_ of the input.


---

Comment by novoselt created at 2015-01-21 19:18:03

In what situations will you **want** a non-toric output from a toric span? The reason for its current presence at all is that we don't have a toric implementation for the ambient vector space. One it is implemented, there will be no non-toric output at all. A technically clean resolution to it meanwhile is to raise `NotImplementedError` for some input, but I'd rather not.


---

Comment by jdemeyer created at 2015-01-21 19:26:56

Replying to [comment:28 novoselt]:
> In what situations will you **want** a non-toric output from a toric span?
I have no idea, I don't use this code, I only created this ticket because it broke #17585.


---

Comment by vbraun created at 2015-01-23 23:42:20

Author name is missing


---

Comment by vbraun created at 2015-01-23 23:42:20

Changing status from positive_review to needs_work.


---

Comment by novoselt created at 2015-01-23 23:51:17

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-01-24 13:18:59

Resolution: fixed
