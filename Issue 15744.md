# Issue 15744: Python 3 preparation: Adapt dict-methods keys(), items(), values() etc.

Issue created by migration from Trac.

Original creator: wluebbe

Original creation time: 2014-03-20 15:11:46

CC:  embray jdemeyer fbissey tscrim jhpalmieri vklein

Keywords: python3

Python 3 introduces new dict-methods and changes the behavior of existing. 


Changes according to `lib2to3/fixes/fix_dict.py`:

```
d.keys() -> list(d.keys())
d.items() -> list(d.items())
d.values() -> list(d.values())

d.iterkeys() -> iter(d.keys())
d.iteritems() -> iter(d.items())
d.itervalues() -> iter(d.values())

d.viewkeys() -> d.keys()
d.viewitems() -> d.items()
d.viewvalues() -> d.values()
```

**TODO**: Clarify whether some generated changes need modifications to avoid unnecessary wrappings with list().

This ticket is tracked as a dependency of meta-ticket ticket:15980.


---

Comment by wluebbe created at 2014-03-31 20:52:03

Here are the (approximate) numbers for the dict-methods in the Sage .py modules:
No .**view**xxxx() were found
|              ||                      ||                      |
|--------------||----------------------||----------------------|
|              ||   case: .xxxx()      ||   case: .iterxxxx()  |
|xxxx (method) | nbr lines | nbr calls | nbr lines | nbr calls |
|keys()        | 414       | 430       | 19        | 19        |
|values()      | 216       | 216       | 15        | 15        |
|items()       | 284       | 330       | 293       | 295       |
The effect of 2to3 fix_dict is:
* `d.xxxx()` is converted to `list(d.xxxx())`.
  * For Py2.7 the original code gives a list.
    
The converted code gives also a list.
    
//But the converted code performs an EXTRA dictionary copy! //
  * For Py3.3 the original code would be a view (not a list) and therefor **different** from the Py2.7 behavior.
    
The converted code gives a list (as in Py 2.7 for both code variants).

* `d.iterxxxx()` is converted to `iter(d.xxxx())`.
  * For Py2.7 the original code gives an iterator.
    
The converted code results in an iterator - 
    
//but this iterator is created ON TOP of the list returned by d.xxxx().//
  * For Py3.3 the original code is **not excepted**.
    
The converted code gives an iterator on a view (and is similar to the iterators in Py 2.7 for both code variants).

In summary
* the original code in Py 2.7 //is equivalent to// 
* the converted code in Py 2.7 //is equivalent to//  
* the converted code in Py 3.3
In both cases (.xxxx() and .iterxxxx()) the converted code suffers an overhead in Py2.7!


The `six` library module offers a solution without this overhead: it defines 3 new **functions**: `iterkeys(d), itervalues(d), iteritems(d)`. In Py2.7 they are implemented by `d.iterkeys(), d.itervalues(), d.iteritems()` and in Py3.3 by `d.keys(), d.values(), d.items()`. 

The catch is that the code must be manually modified (use the new functions in place of the old dictinary methods) - and the module `six` must be imported.

What to do?
* The approaches (2to3 and six) could be combined. 
* And in some places/contexts the wrapping `list(d.xxxx())` could be removed manually when a list is not required.
* Another option is sometimes to use `key in d` together with `d[key]` as appropriate.
  This code has the same behavior in Py2.7 and Py3.3. But manual code change is required

There is no undisputed **best** solution :-(

Suggestions are welcome!


---

Comment by wluebbe created at 2014-04-01 14:07:39

If you have been wondering (like me) why 2to3 maps `d.iteritems()` to `iter(d.items())` and what is means in Py3, then you may benefit from this entry in  [stackoverflow](http://stackoverflow.com/questions/3616721/iterating-over-dictionary-items-values-keys-in-python-3).


---

Comment by ohanar created at 2014-04-03 14:44:23

I would personally move this to stage 2, since most likely we will want to use some sort of compatibility library for at least some instances (and I don't want to make a choice now of which library we will use).


---

Comment by jdemeyer created at 2016-05-02 13:33:40

Changing component from distribution to python3.


---

Comment by chapoton created at 2016-08-23 07:27:55

for some work on keys() and iterkeys(), see tickets #21304, #21296, #21266


---

Comment by chapoton created at 2016-08-23 08:06:28

For some work on itervalues, see #21310 and #21320


---

Comment by chapoton created at 2017-02-03 13:08:29

see #22298 for some work on iteritems


---

Comment by chapoton created at 2017-03-01 21:01:07

after #22485, there should remain no .view* and no .iter*.


---

Comment by chapoton created at 2017-09-11 15:17:43

Now we face the issue that `.keys()[0]`, `.items()[0]` and so on are not allowed.

First ticket for .items in #23824


---

Comment by chapoton created at 2017-09-12 06:25:18

next step in #23831


---

Comment by chapoton created at 2017-10-19 19:23:38

next in #24068 for .values()[something]


---

Comment by chapoton created at 2017-10-30 15:41:28

next in #24126 for some remaining .keys()[something]


---

Comment by chapoton created at 2017-10-31 13:03:29

Sigh.. it seems that we will also need to get rid of iteritems and the like in pyx files (python3-built-sage traceback):

```
sage: v=vector([1,0,2])
sage: list(v.iteritems())
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-29-e4acb1d548e2> in <module>()
----> 1 list(v.iteritems())

/home/chapoton/sage3/src/sage/modules/free_module_element.pyx in sage.modules.free_module_element.FreeModuleElement.iteritems (build/cythonized/sage/modules/free_module_element.c:12200)()

AttributeError: 'dict' object has no attribute 'iteritems'
```



---

Comment by jdemeyer created at 2017-10-31 13:39:42

Follow-up: #24134


---

Comment by chapoton created at 2017-11-09 17:46:07

next step in #24181


---

Comment by chapoton created at 2017-11-16 13:05:48

next step in #24224


---

Comment by chapoton created at 2017-12-20 13:23:19

next in #24407


---

Comment by chapoton created at 2018-04-29 13:23:02

next in #25259


---

Comment by chapoton created at 2019-06-02 16:44:19

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-06-02 16:44:19

I propose to close this one also. Agreed ?


---

Comment by vklein created at 2019-06-03 15:47:18

Yes i agree. I don't think this meta-ticket is needed anymore.


---

Comment by jhpalmieri created at 2019-06-03 17:17:16

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-04 09:09:27

Resolution: fixed
