# Issue 15744: Python 3 preparation: Adapt dict-methods keys(), items(), values() etc.

archive/issues_015744.json:
```json
{
    "body": "CC:  @embray @jdemeyer @kiwifb @tscrim @jhpalmieri @vinklein\n\nKeywords: python3\n\nPython 3 introduces new dict-methods and changes the behavior of existing. \n\n\nChanges according to `lib2to3/fixes/fix_dict.py`:\n\n```\nd.keys() -> list(d.keys())\nd.items() -> list(d.items())\nd.values() -> list(d.values())\n\nd.iterkeys() -> iter(d.keys())\nd.iteritems() -> iter(d.items())\nd.itervalues() -> iter(d.values())\n\nd.viewkeys() -> d.keys()\nd.viewitems() -> d.items()\nd.viewvalues() -> d.values()\n```\n\n**TODO**: Clarify whether some generated changes need modifications to avoid unnecessary wrappings with list().\n\nThis ticket is tracked as a dependency of meta-ticket ticket:15980.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15981\n\n",
    "created_at": "2014-03-20T15:11:46Z",
    "labels": [
        "component: distribution"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Python 3 preparation: Adapt dict-methods keys(), items(), values() etc.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15744",
    "user": "https://github.com/wluebbe"
}
```
CC:  @embray @jdemeyer @kiwifb @tscrim @jhpalmieri @vinklein

Keywords: python3

Python 3 introduces new dict-methods and changes the behavior of existing. 


Changes according to `lib2to3/fixes/fix_dict.py`:

```
d.keys() -> list(d.keys())
d.items() -> list(d.items())
d.values() -> list(d.values())

d.iterkeys() -> iter(d.keys())
d.iteritems() -> iter(d.items())
d.itervalues() -> iter(d.values())

d.viewkeys() -> d.keys()
d.viewitems() -> d.items()
d.viewvalues() -> d.values()
```

**TODO**: Clarify whether some generated changes need modifications to avoid unnecessary wrappings with list().

This ticket is tracked as a dependency of meta-ticket ticket:15980.

Issue created by migration from https://trac.sagemath.org/ticket/15981





---

archive/issue_comments_203554.json:
```json
{
    "body": "Here are the (approximate) numbers for the dict-methods in the Sage .py modules:\nNo .**view**xxxx() were found\n|              ||                      ||                      |\n|--------------||----------------------||----------------------|\n|              ||   case: .xxxx()      ||   case: .iterxxxx()  |\n|xxxx (method) | nbr lines | nbr calls | nbr lines | nbr calls |\n|keys()        | 414       | 430       | 19        | 19        |\n|values()      | 216       | 216       | 15        | 15        |\n|items()       | 284       | 330       | 293       | 295       |\nThe effect of 2to3 fix_dict is:\n* `d.xxxx()` is converted to `list(d.xxxx())`.\n  * For Py2.7 the original code gives a list.\n    \nThe converted code gives also a list.\n    \n//But the converted code performs an EXTRA dictionary copy! //\n* For Py3.3 the original code would be a view (not a list) and therefor **different** from the Py2.7 behavior.\n    \nThe converted code gives a list (as in Py 2.7 for both code variants).\n\n* `d.iterxxxx()` is converted to `iter(d.xxxx())`.\n  * For Py2.7 the original code gives an iterator.\n    \nThe converted code results in an iterator - \n    \n//but this iterator is created ON TOP of the list returned by d.xxxx().//\n* For Py3.3 the original code is **not excepted**.\n    \nThe converted code gives an iterator on a view (and is similar to the iterators in Py 2.7 for both code variants).\n\nIn summary\n* the original code in Py 2.7 //is equivalent to// \n* the converted code in Py 2.7 //is equivalent to//  \n* the converted code in Py 3.3\nIn both cases (.xxxx() and .iterxxxx()) the converted code suffers an overhead in Py2.7!\n\n\nThe `six` library module offers a solution without this overhead: it defines 3 new **functions**: `iterkeys(d), itervalues(d), iteritems(d)`. In Py2.7 they are implemented by `d.iterkeys(), d.itervalues(), d.iteritems()` and in Py3.3 by `d.keys(), d.values(), d.items()`. \n\nThe catch is that the code must be manually modified (use the new functions in place of the old dictinary methods) - and the module `six` must be imported.\n\nWhat to do?\n* The approaches (2to3 and six) could be combined. \n* And in some places/contexts the wrapping `list(d.xxxx())` could be removed manually when a list is not required.\n* Another option is sometimes to use `key in d` together with `d[key]` as appropriate.\n  This code has the same behavior in Py2.7 and Py3.3. But manual code change is required\n\nThere is no undisputed **best** solution :-(\n\nSuggestions are welcome!",
    "created_at": "2014-03-31T20:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203554",
    "user": "https://github.com/wluebbe"
}
```

Here are the (approximate) numbers for the dict-methods in the Sage .py modules:
No .**view**xxxx() were found
|              ||                      ||                      |
|--------------||----------------------||----------------------|
|              ||   case: .xxxx()      ||   case: .iterxxxx()  |
|xxxx (method) | nbr lines | nbr calls | nbr lines | nbr calls |
|keys()        | 414       | 430       | 19        | 19        |
|values()      | 216       | 216       | 15        | 15        |
|items()       | 284       | 330       | 293       | 295       |
The effect of 2to3 fix_dict is:
* `d.xxxx()` is converted to `list(d.xxxx())`.
  * For Py2.7 the original code gives a list.
    
The converted code gives also a list.
    
//But the converted code performs an EXTRA dictionary copy! //
* For Py3.3 the original code would be a view (not a list) and therefor **different** from the Py2.7 behavior.
    
The converted code gives a list (as in Py 2.7 for both code variants).

* `d.iterxxxx()` is converted to `iter(d.xxxx())`.
  * For Py2.7 the original code gives an iterator.
    
The converted code results in an iterator - 
    
//but this iterator is created ON TOP of the list returned by d.xxxx().//
* For Py3.3 the original code is **not excepted**.
    
The converted code gives an iterator on a view (and is similar to the iterators in Py 2.7 for both code variants).

In summary
* the original code in Py 2.7 //is equivalent to// 
* the converted code in Py 2.7 //is equivalent to//  
* the converted code in Py 3.3
In both cases (.xxxx() and .iterxxxx()) the converted code suffers an overhead in Py2.7!


The `six` library module offers a solution without this overhead: it defines 3 new **functions**: `iterkeys(d), itervalues(d), iteritems(d)`. In Py2.7 they are implemented by `d.iterkeys(), d.itervalues(), d.iteritems()` and in Py3.3 by `d.keys(), d.values(), d.items()`. 

The catch is that the code must be manually modified (use the new functions in place of the old dictinary methods) - and the module `six` must be imported.

What to do?
* The approaches (2to3 and six) could be combined. 
* And in some places/contexts the wrapping `list(d.xxxx())` could be removed manually when a list is not required.
* Another option is sometimes to use `key in d` together with `d[key]` as appropriate.
  This code has the same behavior in Py2.7 and Py3.3. But manual code change is required

There is no undisputed **best** solution :-(

Suggestions are welcome!



---

archive/issue_comments_203555.json:
```json
{
    "body": "If you have been wondering (like me) why 2to3 maps `d.iteritems()` to `iter(d.items())` and what is means in Py3, then you may benefit from this entry in  [stackoverflow](http://stackoverflow.com/questions/3616721/iterating-over-dictionary-items-values-keys-in-python-3).",
    "created_at": "2014-04-01T14:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203555",
    "user": "https://github.com/wluebbe"
}
```

If you have been wondering (like me) why 2to3 maps `d.iteritems()` to `iter(d.items())` and what is means in Py3, then you may benefit from this entry in  [stackoverflow](http://stackoverflow.com/questions/3616721/iterating-over-dictionary-items-values-keys-in-python-3).



---

archive/issue_comments_203556.json:
```json
{
    "body": "I would personally move this to stage 2, since most likely we will want to use some sort of compatibility library for at least some instances (and I don't want to make a choice now of which library we will use).",
    "created_at": "2014-04-03T14:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203556",
    "user": "https://github.com/ohanar"
}
```

I would personally move this to stage 2, since most likely we will want to use some sort of compatibility library for at least some instances (and I don't want to make a choice now of which library we will use).



---

archive/issue_comments_203557.json:
```json
{
    "body": "Changing component from distribution to python3.",
    "created_at": "2016-05-02T13:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203557",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from distribution to python3.



---

archive/issue_comments_203558.json:
```json
{
    "body": "for some work on keys() and iterkeys(), see tickets #21304, #21296, #21266",
    "created_at": "2016-08-23T07:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203558",
    "user": "https://github.com/fchapoton"
}
```

for some work on keys() and iterkeys(), see tickets #21304, #21296, #21266



---

archive/issue_comments_203559.json:
```json
{
    "body": "For some work on itervalues, see #21310 and #21320",
    "created_at": "2016-08-23T08:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203559",
    "user": "https://github.com/fchapoton"
}
```

For some work on itervalues, see #21310 and #21320



---

archive/issue_comments_203560.json:
```json
{
    "body": "see #22298 for some work on iteritems",
    "created_at": "2017-02-03T13:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203560",
    "user": "https://github.com/fchapoton"
}
```

see #22298 for some work on iteritems



---

archive/issue_comments_203561.json:
```json
{
    "body": "after #22485, there should remain no .view* and no .iter*.",
    "created_at": "2017-03-01T21:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203561",
    "user": "https://github.com/fchapoton"
}
```

after #22485, there should remain no .view* and no .iter*.



---

archive/issue_comments_203562.json:
```json
{
    "body": "Now we face the issue that `.keys()[0]`, `.items()[0]` and so on are not allowed.\n\nFirst ticket for .items in #23824",
    "created_at": "2017-09-11T15:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203562",
    "user": "https://github.com/fchapoton"
}
```

Now we face the issue that `.keys()[0]`, `.items()[0]` and so on are not allowed.

First ticket for .items in #23824



---

archive/issue_comments_203563.json:
```json
{
    "body": "next step in #23831",
    "created_at": "2017-09-12T06:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203563",
    "user": "https://github.com/fchapoton"
}
```

next step in #23831



---

archive/issue_comments_203564.json:
```json
{
    "body": "next in #24068 for .values()[something]",
    "created_at": "2017-10-19T19:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203564",
    "user": "https://github.com/fchapoton"
}
```

next in #24068 for .values()[something]



---

archive/issue_comments_203565.json:
```json
{
    "body": "next in #24126 for some remaining .keys()[something]",
    "created_at": "2017-10-30T15:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203565",
    "user": "https://github.com/fchapoton"
}
```

next in #24126 for some remaining .keys()[something]



---

archive/issue_comments_203566.json:
```json
{
    "body": "Sigh.. it seems that we will also need to get rid of iteritems and the like in pyx files (python3-built-sage traceback):\n\n```\nsage: v=vector([1,0,2])\nsage: list(v.iteritems())\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-29-e4acb1d548e2> in <module>()\n----> 1 list(v.iteritems())\n\n/home/chapoton/sage3/src/sage/modules/free_module_element.pyx in sage.modules.free_module_element.FreeModuleElement.iteritems (build/cythonized/sage/modules/free_module_element.c:12200)()\n\nAttributeError: 'dict' object has no attribute 'iteritems'\n```\n",
    "created_at": "2017-10-31T13:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203566",
    "user": "https://github.com/fchapoton"
}
```

Sigh.. it seems that we will also need to get rid of iteritems and the like in pyx files (python3-built-sage traceback):

```
sage: v=vector([1,0,2])
sage: list(v.iteritems())
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-29-e4acb1d548e2> in <module>()
----> 1 list(v.iteritems())

/home/chapoton/sage3/src/sage/modules/free_module_element.pyx in sage.modules.free_module_element.FreeModuleElement.iteritems (build/cythonized/sage/modules/free_module_element.c:12200)()

AttributeError: 'dict' object has no attribute 'iteritems'
```




---

archive/issue_comments_203567.json:
```json
{
    "body": "Follow-up: #24134",
    "created_at": "2017-10-31T13:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203567",
    "user": "https://github.com/jdemeyer"
}
```

Follow-up: #24134



---

archive/issue_comments_203568.json:
```json
{
    "body": "next step in #24181",
    "created_at": "2017-11-09T17:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203568",
    "user": "https://github.com/fchapoton"
}
```

next step in #24181



---

archive/issue_comments_203569.json:
```json
{
    "body": "next step in #24224",
    "created_at": "2017-11-16T13:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203569",
    "user": "https://github.com/fchapoton"
}
```

next step in #24224



---

archive/issue_comments_203570.json:
```json
{
    "body": "next in #24407",
    "created_at": "2017-12-20T13:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203570",
    "user": "https://github.com/fchapoton"
}
```

next in #24407



---

archive/issue_comments_203571.json:
```json
{
    "body": "next in #25259",
    "created_at": "2018-04-29T13:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203571",
    "user": "https://github.com/fchapoton"
}
```

next in #25259



---

archive/issue_comments_203572.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-02T16:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203572",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203573.json:
```json
{
    "body": "I propose to close this one also. Agreed ?",
    "created_at": "2019-06-02T16:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203573",
    "user": "https://github.com/fchapoton"
}
```

I propose to close this one also. Agreed ?



---

archive/issue_comments_203574.json:
```json
{
    "body": "Yes i agree. I don't think this meta-ticket is needed anymore.",
    "created_at": "2019-06-03T15:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203574",
    "user": "https://github.com/vinklein"
}
```

Yes i agree. I don't think this meta-ticket is needed anymore.



---

archive/issue_comments_203575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-03T17:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203575",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203576.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-04T09:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15744#issuecomment-203576",
    "user": "https://github.com/fchapoton"
}
```

Resolution: fixed



---

archive/issue_events_015353.json:
```json
{
    "actor": "@fchapoton",
    "created_at": "2019-06-04T09:09:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15744",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15744#event-15353"
}
```
