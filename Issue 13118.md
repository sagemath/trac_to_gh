# Issue 13118: Upgrade MPC to version 1.0

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-07-25 13:54:56

Assignee: tbd

CC:  jpflori zimmerma

Currently, Sage uses a development version of MPC (stable 0.9 had build issues on certain platforms).

Upgrade to the just-released MPC-1.0: [http://www.multiprecision.org/index.php?prog=mpc](http://www.multiprecision.org/index.php?prog=mpc)

At the same time, why not import `MPComplexField` by default and add MPC to the reference manual.


---

Comment by leif created at 2012-07-25 15:00:33

FWIW, MPFR 3.1.1 has also recently been released.  (Don't know whether there's already a ticket to upgrade to that version.)


---

Comment by jdemeyer created at 2012-07-27 11:54:45

Changing status from new to needs_review.


---

Comment by leif created at 2012-07-27 13:29:24

`s/Gnu Mpc/GNU MPC/` in `SPKG.txt` ;-)  (The original has small caps.)

For consistency, I wouldn't remove the error check and message in `spkg-check`.

I also wouldn't comment out the patch loop; in case there are no patches, simply no patch should get applied, without raising an error message (either because `patches/` doesn't exist, or because there's no patch in `patches/` such that `../patches/*.patch` "expands" to itself).  Otherwise we uselessly keep creating and deleting directories, and commenting code out or reversing that each time patches again appear or all previous patches vanish.  Prepending

```sh
ls ../patches/*.patch &>/dev/null &&
```

to the `for` loop should be sufficient.


---

Comment by jdemeyer created at 2012-07-27 13:54:14

leif, I made some minor corrections you suggested.  I changed the patch loop to:

```sh
# Apply patches.  See SPKG.txt for information about what each patch
# does.
for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue
    patch -p1 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done
```



---

Comment by jdemeyer created at 2012-07-27 14:01:00

I also changed the developer documentation to change the "patch loop" as I did for MPC.


---

Comment by leif created at 2012-07-27 14:06:07

Oh, just reviewed the previous patch to the Sage library, which looked good except that you removed the formulas for the conjugate and the square of a complex number ;-), and some instances of `self` not typeset monospaced.


---

Comment by leif created at 2012-07-27 14:25:14

Replying to [comment:9 jdemeyer]:
> I also changed the developer documentation to change the "patch loop" as I did for MPC.

Is that the only change you made to the Sage library patch?  (It should better be a separate patch.)

I'd rather use `[ -f "$patch" ]` instead of `[ -r "$patch" ]`.

While you're at it, `$SAGE_ROOT` should be quoted in the Developer Guide's template.


---

Comment by jdemeyer created at 2012-07-27 14:40:13

Replying to [comment:11 leif]:
> I'd rather use `[ -f "$patch" ]` instead of `[ -r "$patch" ]`.
Actually I like `-r`, because like this one can intentionally disable a patch by `chmod`ing it `000`.


---

Comment by leif created at 2012-07-27 14:51:55

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 leif]:
> > I'd rather use `[ -f "$patch" ]` instead of `[ -r "$patch" ]`.
> Actually I like `-r`, because like this one can intentionally disable a patch by `chmod`ing it `000`.

I was thinking of the same, but it's also a potential pitfall I think, and not very appropriate from an educational perspective... (unless you add a comment on that; people might think `-r` tests for a *r*egular file, and `[ -r <some directory> ]` is usually true as well).

----


```
...
checking for CC and CFLAGS in gmp.h... yes CC=gcc-4.7.0 -std=gnu99 CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS
checking for CC=gcc-4.7.0 -std=gnu99 and CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS... yes
checking for gcc... (cached) gcc
checking whether we are using the GNU C compiler... (cached) yes
checking whether gcc accepts -g... (cached) yes
checking for gcc option to accept ISO C89... (cached) none needed
checking dependency style of gcc... (cached) gcc3
checking how to print strings... printf
checking for a sed that does not truncate output... (cached) /bin/sed
checking for fgrep... /bin/grep -F
checking for ld used by gcc... ld
checking if the linker (ld) is GNU ld... yes
checking for BSD- or MS-compatible name lister (nm)... /usr/local/bin/nm -B
checking the name lister (/usr/local/bin/nm -B) interface... BSD nm
checking whether ln -s works... yes
checking the maximum length of command line arguments... 1572864
checking whether the shell understands some XSI constructs... yes
checking whether the shell understands "+="... yes
checking how to convert x86_64-unknown-linux-gnu file names to x86_64-unknown-linux-gnu format... func_convert_file_noop
checking how to convert x86_64-unknown-linux-gnu file names to toolchain format... func_convert_file_noop
checking for ld option to reload object files... -r
checking for objdump... objdump
checking how to recognize dependent libraries... pass_all
checking for dlltool... dlltool
checking how to associate runtime and link libraries... printf %s\n
checking for archiver `@`FILE support... no
checking for strip... strip
checking for ranlib... ranlib
checking command to parse /usr/local/bin/nm -B output from gcc object... failed
checking for sysroot... no
checking for mt... mt
checking if mt is a manifest tool... no
checking how to run the C preprocessor... cpp-4.7.0
checking for ANSI C header files... no
checking for sys/types.h... no
checking for sys/stat.h... no
checking for stdlib.h... no
checking for string.h... no
checking for memory.h... no
checking for strings.h... no
checking for inttypes.h... no
checking for stdint.h... no
checking for unistd.h... no
checking for dlfcn.h... no
checking for objdir... .libs
checking if gcc supports -fno-rtti -fno-exceptions... no
checking for gcc option to produce PIC... -fPIC -DPIC
checking if gcc PIC flag -fPIC -DPIC works... no
checking if gcc static flag -static works... no
checking if gcc supports -c -o file.o... no
checking if gcc supports -c -o file.o... (cached) no
checking if we can lock with hard links... yes
checking whether the gcc linker (ld) supports shared libraries... yes
checking whether -lc should be explicitly linked in... 
checking dynamic linker characteristics... GNU/Linux ld.so
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
checking for gmp.h... no
configure: error: gmp.h cannot be found or is unusable.
Error configuring MPC.

real	0m7.518s
user	0m0.780s
sys	0m0.700s
************************************************************************
Error installing package mpc-1.0
************************************************************************
```


Ooops!?

(`$SAGE_LOCAL/include/gmp.h` is of course present and sane as well, as you can also see since MPC found `__GMP_CC` and `__GMP_CFLAGS`.)


---

Comment by leif created at 2012-07-27 14:57:12

Replying to [comment:13 leif]:
> {{{
> ************************************************************************
> Error installing package mpc-1.0
> ************************************************************************
> }}}
> 
> Ooops!?
> 
> (`$SAGE_LOCAL/include/gmp.h` is of course present and sane as well, as you can also see since MPC found `__GMP_CC` and `__GMP_CFLAGS`.)

... and my environment and my Sage installation are sane; just successfully reinstalled the previous MPC spkg.


---

Comment by leif created at 2012-07-27 15:04:41

Despite looking for GMP's `CC`, upstream's `configure` apparently uses `gcc` in almost all tests (which is GCC 4.4.3, and which e.g. doesn't understand `-march=btver1` from GMP's/MPIR's  `CFLAGS`)!


---

Comment by jdemeyer created at 2012-07-27 15:05:55

Replying to [comment:15 leif]:
> Despite looking for GMP's `CC`, upstream's `configure` apparently uses `gcc` in almost all tests (which is GCC 4.4.3, and which e.g. doesn't understand `-march=btver1` from GMP's/MPIR's  `CFLAGS`)!

Really?  Could you attach the config.log from mpc-1.0?


---

Comment by leif created at 2012-07-27 15:32:56

Not clear to me what's causing this; the change to `configure.ac` looks harmless, but they're also using newer autotools.


```diff

--- mpc-1.0.0dev1126.p1/src/configure.ac	2012-02-21 15:21:29.000000000 +0100
+++ mpc-1.0/src/configure.ac	2012-07-19 14:33:51.000000000 +0200
`@``@` -1,4 +1,4 `@``@`
-# Copyright (C) 2008, 2009, 2010, 2011 INRIA
+# Copyright (C) 2008, 2009, 2010, 2011, 2012 INRIA
 #
 # This file is part of GNU MPC.
 #
`@``@` -20,16 +20,23 `@``@`
 # Process this file with autoconf to produce a configure script.
 
 AC_PREREQ(2.61)
-AC_INIT(mpc, 1.0.0dev, mpc-discuss`@`lists.gforge.inria.fr)
+AC_INIT(mpc, 1.0, mpc-discuss`@`lists.gforge.inria.fr)
 AC_CONFIG_SRCDIR([src/mpc-impl.h])
 AC_CONFIG_HEADER([config.h])
 
 AM_INIT_AUTOMAKE([1.9 -Wall -Werror])
 AM_MAINTAINER_MODE
 
+USER_CC=$CC
+USER_CFLAGS=$CFLAGS
+
+# automake 1.12 seems to require this, but automake 1.11 doesn't recognize it
+m4_ifdef([AM_PROG_AR], [AM_PROG_AR])
+
 AC_CANONICAL_HOST
 AC_CONFIG_MACRO_DIR([m4])
 
+
 # Extra arguments to configure
 AC_ARG_WITH([mpfr_include],
             [AC_HELP_STRING([--with-mpfr-include=DIR],
`@``@` -96,7 +103,7 `@``@`
 # at http://lists.gforge.inria.fr/pipermail/mpc-discuss/2012-January/001056.html
 AC_PROG_EGREP
 AC_PROG_SED
-if test -z "$CC" && test -z "$CFLAGS"; then
+if test -z "$USER_CC" && test -z "$USER_CFLAGS"; then
    MPC_GMP_CC_CFLAGS
 fi
 
`@``@` -105,7 +112,7 `@``@`
 AC_LANG(C)
 
 # Set up LibTool
-AC_PROG_LIBTOOL
+LT_INIT
 
```



---

Comment by leif created at 2012-07-27 15:41:20

`config.log` from MPC 1.0 spkg showing use of `gcc` instead of `gmp.h`'s CC


---

Attachment

Replying to [comment:16 jdemeyer]:
> Could you attach the config.log from mpc-1.0?

Did so.  Quite long; the relevant parts seem

```
configure:2930: checking for gcc
configure:2946: found /usr/bin/gcc
configure:2957: result: gcc
configure:3186: checking for C compiler version
configure:3195: gcc --version >&5
gcc (Ubuntu 4.4.3-4ubuntu5.1) 4.4.3
Copyright (C) 2009 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

configure:3206: $? = 0

...

configure:4394: checking for CC and CFLAGS in gmp.h
configure:4420: result: yes CC=gcc-4.7.0 -std=gnu99 CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS
configure:4426: checking for CC=gcc-4.7.0 -std=gnu99 and CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS
configure:4430: result: yes
configure:4493: checking for gcc
configure:4520: result: gcc
configure:4749: checking for C compiler version
configure:4758: gcc --version >&5
gcc (Ubuntu 4.4.3-4ubuntu5.1) 4.4.3
Copyright (C) 2009 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

configure:4769: $? = 0

```


Somehow the settings from `gmp.h` don't get "propagated".


---

Comment by leif created at 2012-07-27 16:05:30

Interestingly, similar happens if I unset `CC`, `CPP`, `CFLAGS` and `CPPFLAGS`:  While `configure` definitely uses the `CFLAGS` from `gmp.h`, it doesn't use the `CC` setting.

Apparently because of inappropriate caching:

```
...
checking for CC and CFLAGS in gmp.h... yes CC=gcc-4.7.0 -std=gnu99 CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS
checking for CC=gcc-4.7.0 -std=gnu99 and CFLAGS=-O2 -m64 -march=btver1 -mtune=btver1  -g -march=native -O3 -fno-strict-aliasing -DHONORS_CFLAGS... yes
checking for gcc... (cached) gcc
...
```



---

Comment by jdemeyer created at 2012-07-27 16:53:02

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-07-27 16:53:02

I can confirm the regression regarding `$CC`.


---

Comment by leif created at 2012-07-27 17:57:56

Obviously the `CC` from `gmp.h` gets overwritten with `$ac_cv_prog_CC` (determined earlier), but I don't know the proper way to avoid that.  (One could of course "manually" unset it in the `MPC_GMP_CC_CFLAG` macro from `mpc.m4`, or set it to the new value if appropriate, but that appears very hackish to me.  There must be some other way to update or invalidate cached variables I think, but so far I haven't found one.)

The cause of the regression seems to simply be the use of newer autotools (generating a `configure` script that now checks for the compiler _before_ `MPC_GMP_CC_CFLAG` is called).


---

Comment by leif created at 2012-07-27 19:54:35

Replying to [comment:21 leif]:
> The cause of the regression seems to simply be the use of newer autotools (generating a `configure` script that now checks for the compiler _before_ `MPC_GMP_CC_CFLAG` is called).

Not really, or at least not directly.  The culprit is `AM_PROG_AR`, which pulls in a lot of crap, or more precisely triggers the compiler tests too early.

If I move

```
# automake 1.12 seems to require this, but automake 1.11 doesn't recognize it
m4_ifdef([AM_PROG_AR], [AM_PROG_AR])
```

past the call to `MPC_GMP_CC_CFLAGS`, the spkg installs and passes its test suite.


---

Comment by leif created at 2012-07-27 20:02:05

P.S.:

Since I don't have Automake 1.12 installed, perhaps someone else should `autoreconf` the spkg; patching `configure` IMHO doesn't make much sense.

Anybody going to report this upstream?  Paul...? :P


---

Attachment

"Upstream" patch to `configure.ac` to fix `CC` not being taken from `gmp.h`.


---

Comment by leif created at 2012-07-27 20:29:42

I've attached a patch to `src/configure.ac`.


---

Comment by leif created at 2012-07-27 21:22:07

Replying to [comment:23 leif]:
> Since I don't have Automake 1.12 installed, perhaps someone else should `autoreconf` the spkg; patching `configure` IMHO doesn't make much sense.
> 
> Anybody going to report this upstream?

Ok, [reported upstream](https://gforge.inria.fr/tracker/?func=detail&group_id=131&aid=14669&atid=607) (patch included).


---

Comment by leif created at 2012-07-27 21:46:39

Replying to [comment:25 leif]:
> Ok, [reported upstream](https://gforge.inria.fr/tracker/?func=detail&group_id=131&aid=14669&atid=607) (patch included).


```
Comment By: Andreas Enge (enge)
Date: 2012-07-27 21:39

Message:
I confirm the problem and admit I tested only the propagation of the CFLAGS, which seems to work. This part of the configuration is really tricky.

Thanks for working this out. I applied the patch to the trunk and the 1.0 branch. A bug fix release 1.0.1 is planned for the end of August.
```


That's quick... :-)


---

Comment by jdemeyer created at 2012-08-01 14:16:12

Patch for the Sage library


---

Attachment

Patch for the mpc spkg, for review only


---

Comment by jdemeyer created at 2012-08-01 14:19:46

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-08-12 18:44:34

Tested on the buildbots, no problems.


---

Comment by vbraun created at 2012-08-12 19:10:12

Looks good to me.


---

Comment by vbraun created at 2012-08-12 19:10:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-08-14 07:05:10

Resolution: fixed


---

Comment by jdemeyer created at 2012-09-07 07:32:18

MPC-1.0.1 just got released.
