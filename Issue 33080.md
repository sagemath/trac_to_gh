# Issue 33080: Unify computation of number of parallel jobs

Issue created by migration from https://trac.sagemath.org/ticket/33317

Original creator: @tobiasdiez

Original creation time: 2022-02-09 13:39:53

CC:  mkoeppe jhpalmieri tscrim nthiery chapoton

Currently, the number of jobs used for parallel operations is re-computed and set in various places. In this ticket, we unify this to one central place in `sage.env`, which is then reused across the whole infrastructure. The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. This can probably be improved as well, but we leave it for a follow-up ticket.

Changes in detail:
- Remove SAGE_NUM_THREADS_PARALLEL since it was only used for the docbuild.
- Introduce the method `thread_count` in `sage.env` that based on the environment variable `SAGE_NUM_THREADS` and the number of CPUs computes the number of parallel jobs sage should use.
- Use this method (or its cached value `THREAD_COUNT`) everywhere where previously `SAGE_NUM_THREADS` has been used.
- Remove a few places that also calculated the number of CPUs or number of parallel jobs.
- In particular, remove the computation of the number of threads to use in the make files. This is now exclusively handled through `sage.env`.
- Don't specify `SAGE_NUM_THREADS` on CI, but let this be calculated using the number of CPUs available.


---

Comment by @tobiasdiez created at 2022-02-09 13:41:14

Changing status from new to needs_review.


---

Comment by git created at 2022-02-09 15:05:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-02-09 16:46:37

Does this duplicate #30639? If so, let's close #30639, since there is no branch there.


---

Comment by jhpalmieri created at 2022-02-09 16:50:01

If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.


---

Comment by @tobiasdiez created at 2022-02-09 17:24:16

Replying to [comment:3 jhpalmieri]:
> Does this duplicate #30639? If so, let's close #30639, since there is no branch there.

Yes, removing `src/bin/sage-num-threads.py` is indeed done as part of this ticket. Thanks for pointing this out.


---

Comment by @tobiasdiez created at 2022-02-09 17:32:33

Replying to [comment:4 jhpalmieri]:
> If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.


Yes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). People in a shared environment can still overwrite this of course. But if you think another default is more reasonable, this can be easily changed.


---

Comment by mkoeppe created at 2022-02-09 17:49:25

ALL_CAPS variables in `sage.env` should be strings, not integers.
Is it really necessary to introduce `THREAD_COUNT` as a variable? Having a function that returns this value should be enough.


---

Comment by mkoeppe created at 2022-02-09 17:52:42

Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`.


---

Comment by mkoeppe created at 2022-02-09 17:56:08

Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
Please don't delete this.


---

Comment by mkoeppe created at 2022-02-09 17:56:55

Replying to [ticket:33317 gh-tobiasdiez]:
> The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. 

... no, that's not what it does


---

Comment by jhpalmieri created at 2022-02-09 18:27:58

Replying to [comment:6 gh-tobiasdiez]:
> Replying to [comment:4 jhpalmieri]:
> > If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.
> 
> 
> Yes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). **People in a shared environment can still overwrite this of course.**

I'm concerned with mathematicians not knowing that they should change it and so accidentally overloading a system. We should not rely on users knowing what they're doing.


---

Comment by slelievre created at 2022-02-09 19:33:02

Replying to [comment:11 jhpalmieri]:
> I'm concerned with mathematicians not knowing that they
> should change it and so accidentally overloading a system.
> We should not rely on users knowing what they're doing.

+1

Users who need speed will figure out how to change
a low default to something higher.

They can set the number of threads to use
for parallel computations in their `init.sage`.


---

Comment by tscrim created at 2022-02-10 00:12:52

Replying to [comment:12 slelievre]:
> Replying to [comment:11 jhpalmieri]:
> > I'm concerned with mathematicians not knowing that they
> > should change it and so accidentally overloading a system.
> > We should not rely on users knowing what they're doing.
> 
> +1
> 
> Users who need speed will figure out how to change
> a low default to something higher.
> 
> They can set the number of threads to use
> for parallel computations in their `init.sage`.

+1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.


---

Comment by @tobiasdiez created at 2022-02-10 23:29:13

Replying to [comment:8 mkoeppe]:
> Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. 

I took the `cpu_count` function from python as a blueprint, but can change the naming of course if you think `num_threads` is easier / more common.


---

Comment by @tobiasdiez created at 2022-02-10 23:30:03

Replying to [comment:9 mkoeppe]:
> Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
> Please don't delete this.

I didn't delete this script, but only the one in src/bin.


---

Comment by @tobiasdiez created at 2022-02-10 23:41:44

Replying to [comment:13 tscrim]:
> Replying to [comment:12 slelievre]:
> > Replying to [comment:11 jhpalmieri]:
> > > I'm concerned with mathematicians not knowing that they
> > > should change it and so accidentally overloading a system.
> > > We should not rely on users knowing what they're doing.
> > 
> > +1
> > 
> > Users who need speed will figure out how to change
> > a low default to something higher.
> > 
> > They can set the number of threads to use
> > for parallel computations in their `init.sage`.
> 
> +1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.


I think you misunderstood me. I didn't change the user-facing multiprocessing for calculation, i.e. what `ncpus` in `sage/parallel` returns (at least if I don't overlook something). This still first returns `SAGE_NUM_THREADS` if set, and only as a fallback uses the number of cores. What I changed was that other parallel processes follow the same strategy. This change should only impact devs that compile sage and run doctests. I'm not sure if it really makes sense to be more strict there than with user-facing calculations. I would expect that devs have more knowledge that they might need to restrict parallel computations in order to not negatively impact their system.

Anyway, if the special treatment of compilation and doctests is indeed preferred, what would be a good default? No parallelization at all if the user doesn't specify SAGE_NUM_THREADS?


---

Comment by mkoeppe created at 2022-02-10 23:56:51

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:9 mkoeppe]:
> > Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
> > Please don't delete this.
> 
> I didn't delete this script, but only the one in src/bin.

You deleted its use in `build/make/install`


---

Comment by mkoeppe created at 2022-02-10 23:58:58

Replying to [comment:14 gh-tobiasdiez]:
> Replying to [comment:8 mkoeppe]:
> > Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. 
> 
> I [...] can change the naming of course 

Yes, please change it back.


---

Comment by mkoeppe created at 2022-02-11 23:16:05

Changing status from needs_review to needs_work.
