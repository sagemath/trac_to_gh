# Issue 33080: Unify computation of number of parallel jobs

archive/issues_033080.json:
```json
{
    "body": "CC:  mkoeppe jhpalmieri tscrim nthiery chapoton\n\nCurrently, the number of jobs used for parallel operations is re-computed and set in various places. In this ticket, we unify this to one central place in `sage.env`, which is then reused across the whole infrastructure. The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. This can probably be improved as well, but we leave it for a follow-up ticket.\n\nChanges in detail:\n- Remove SAGE_NUM_THREADS_PARALLEL since it was only used for the docbuild.\n- Introduce the method `thread_count` in `sage.env` that based on the environment variable `SAGE_NUM_THREADS` and the number of CPUs computes the number of parallel jobs sage should use.\n- Use this method (or its cached value `THREAD_COUNT`) everywhere where previously `SAGE_NUM_THREADS` has been used.\n- Remove a few places that also calculated the number of CPUs or number of parallel jobs.\n- In particular, remove the computation of the number of threads to use in the make files. This is now exclusively handled through `sage.env`.\n- Don't specify `SAGE_NUM_THREADS` on CI, but let this be calculated using the number of CPUs available.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33317\n\n",
    "created_at": "2022-02-09T13:39:53Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Unify computation of number of parallel jobs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33080",
    "user": "@tobiasdiez"
}
```
CC:  mkoeppe jhpalmieri tscrim nthiery chapoton

Currently, the number of jobs used for parallel operations is re-computed and set in various places. In this ticket, we unify this to one central place in `sage.env`, which is then reused across the whole infrastructure. The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. This can probably be improved as well, but we leave it for a follow-up ticket.

Changes in detail:
- Remove SAGE_NUM_THREADS_PARALLEL since it was only used for the docbuild.
- Introduce the method `thread_count` in `sage.env` that based on the environment variable `SAGE_NUM_THREADS` and the number of CPUs computes the number of parallel jobs sage should use.
- Use this method (or its cached value `THREAD_COUNT`) everywhere where previously `SAGE_NUM_THREADS` has been used.
- Remove a few places that also calculated the number of CPUs or number of parallel jobs.
- In particular, remove the computation of the number of threads to use in the make files. This is now exclusively handled through `sage.env`.
- Don't specify `SAGE_NUM_THREADS` on CI, but let this be calculated using the number of CPUs available.

Issue created by migration from https://trac.sagemath.org/ticket/33317





---

archive/issue_comments_471558.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-09T13:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471558",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471559.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-09T15:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471559",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471560.json:
```json
{
    "body": "Does this duplicate #30639? If so, let's close #30639, since there is no branch there.",
    "created_at": "2022-02-09T16:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471560",
    "user": "jhpalmieri"
}
```

Does this duplicate #30639? If so, let's close #30639, since there is no branch there.



---

archive/issue_comments_471561.json:
```json
{
    "body": "If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.",
    "created_at": "2022-02-09T16:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471561",
    "user": "jhpalmieri"
}
```

If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.



---

archive/issue_comments_471562.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> Does this duplicate #30639? If so, let's close #30639, since there is no branch there.\n\nYes, removing `src/bin/sage-num-threads.py` is indeed done as part of this ticket. Thanks for pointing this out.",
    "created_at": "2022-02-09T17:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471562",
    "user": "@tobiasdiez"
}
```

Replying to [comment:3 jhpalmieri]:
> Does this duplicate #30639? If so, let's close #30639, since there is no branch there.

Yes, removing `src/bin/sage-num-threads.py` is indeed done as part of this ticket. Thanks for pointing this out.



---

archive/issue_comments_471563.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.\n\n\nYes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). People in a shared environment can still overwrite this of course. But if you think another default is more reasonable, this can be easily changed.",
    "created_at": "2022-02-09T17:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471563",
    "user": "@tobiasdiez"
}
```

Replying to [comment:4 jhpalmieri]:
> If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.


Yes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). People in a shared environment can still overwrite this of course. But if you think another default is more reasonable, this can be easily changed.



---

archive/issue_comments_471564.json:
```json
{
    "body": "ALL_CAPS variables in `sage.env` should be strings, not integers.\nIs it really necessary to introduce `THREAD_COUNT` as a variable? Having a function that returns this value should be enough.",
    "created_at": "2022-02-09T17:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471564",
    "user": "mkoeppe"
}
```

ALL_CAPS variables in `sage.env` should be strings, not integers.
Is it really necessary to introduce `THREAD_COUNT` as a variable? Having a function that returns this value should be enough.



---

archive/issue_comments_471565.json:
```json
{
    "body": "Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`.",
    "created_at": "2022-02-09T17:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471565",
    "user": "mkoeppe"
}
```

Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`.



---

archive/issue_comments_471566.json:
```json
{
    "body": "Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.\nPlease don't delete this.",
    "created_at": "2022-02-09T17:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471566",
    "user": "mkoeppe"
}
```

Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
Please don't delete this.



---

archive/issue_comments_471567.json:
```json
{
    "body": "Replying to [ticket:33317 gh-tobiasdiez]:\n> The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. \n\n... no, that's not what it does",
    "created_at": "2022-02-09T17:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471567",
    "user": "mkoeppe"
}
```

Replying to [ticket:33317 gh-tobiasdiez]:
> The only exception is the script `build/bin/sage-build-num-threads` which is only needed in the build of the `sage-conf` package. 

... no, that's not what it does



---

archive/issue_comments_471568.json:
```json
{
    "body": "Replying to [comment:6 gh-tobiasdiez]:\n> Replying to [comment:4 jhpalmieri]:\n> > If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.\n> \n> \n> Yes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). **People in a shared environment can still overwrite this of course.**\n\nI'm concerned with mathematicians not knowing that they should change it and so accidentally overloading a system. We should not rely on users knowing what they're doing.",
    "created_at": "2022-02-09T18:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471568",
    "user": "jhpalmieri"
}
```

Replying to [comment:6 gh-tobiasdiez]:
> Replying to [comment:4 jhpalmieri]:
> > If I'm reading the old code right, the default number of threads was 2, but you've changed it to 10. At least one reason to keep the default low was for the case of shared machines, where a single user should only use many cores at a time intentionally.
> 
> 
> Yes, you are right. Some of the defaults changed as part of this refactoring since the defaults used where not homogeneous. Personally, I would say that we should try to use a high parallelization as the default, because most systems today have more than 8 cores (especially developer machines). **People in a shared environment can still overwrite this of course.**

I'm concerned with mathematicians not knowing that they should change it and so accidentally overloading a system. We should not rely on users knowing what they're doing.



---

archive/issue_comments_471569.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> I'm concerned with mathematicians not knowing that they\n> should change it and so accidentally overloading a system.\n> We should not rely on users knowing what they're doing.\n\n+1\n\nUsers who need speed will figure out how to change\na low default to something higher.\n\nThey can set the number of threads to use\nfor parallel computations in their `init.sage`.",
    "created_at": "2022-02-09T19:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471569",
    "user": "slelievre"
}
```

Replying to [comment:11 jhpalmieri]:
> I'm concerned with mathematicians not knowing that they
> should change it and so accidentally overloading a system.
> We should not rely on users knowing what they're doing.

+1

Users who need speed will figure out how to change
a low default to something higher.

They can set the number of threads to use
for parallel computations in their `init.sage`.



---

archive/issue_comments_471570.json:
```json
{
    "body": "Replying to [comment:12 slelievre]:\n> Replying to [comment:11 jhpalmieri]:\n> > I'm concerned with mathematicians not knowing that they\n> > should change it and so accidentally overloading a system.\n> > We should not rely on users knowing what they're doing.\n> \n> +1\n> \n> Users who need speed will figure out how to change\n> a low default to something higher.\n> \n> They can set the number of threads to use\n> for parallel computations in their `init.sage`.\n\n+1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.",
    "created_at": "2022-02-10T00:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471570",
    "user": "tscrim"
}
```

Replying to [comment:12 slelievre]:
> Replying to [comment:11 jhpalmieri]:
> > I'm concerned with mathematicians not knowing that they
> > should change it and so accidentally overloading a system.
> > We should not rely on users knowing what they're doing.
> 
> +1
> 
> Users who need speed will figure out how to change
> a low default to something higher.
> 
> They can set the number of threads to use
> for parallel computations in their `init.sage`.

+1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.



---

archive/issue_comments_471571.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. \n\nI took the `cpu_count` function from python as a blueprint, but can change the naming of course if you think `num_threads` is easier / more common.",
    "created_at": "2022-02-10T23:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471571",
    "user": "@tobiasdiez"
}
```

Replying to [comment:8 mkoeppe]:
> Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. 

I took the `cpu_count` function from python as a blueprint, but can change the naming of course if you think `num_threads` is easier / more common.



---

archive/issue_comments_471572.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.\n> Please don't delete this.\n\nI didn't delete this script, but only the one in src/bin.",
    "created_at": "2022-02-10T23:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471572",
    "user": "@tobiasdiez"
}
```

Replying to [comment:9 mkoeppe]:
> Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
> Please don't delete this.

I didn't delete this script, but only the one in src/bin.



---

archive/issue_comments_471573.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> Replying to [comment:12 slelievre]:\n> > Replying to [comment:11 jhpalmieri]:\n> > > I'm concerned with mathematicians not knowing that they\n> > > should change it and so accidentally overloading a system.\n> > > We should not rely on users knowing what they're doing.\n> > \n> > +1\n> > \n> > Users who need speed will figure out how to change\n> > a low default to something higher.\n> > \n> > They can set the number of threads to use\n> > for parallel computations in their `init.sage`.\n> \n> +1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.\n\n\nI think you misunderstood me. I didn't change the user-facing multiprocessing for calculation, i.e. what `ncpus` in `sage/parallel` returns (at least if I don't overlook something). This still first returns `SAGE_NUM_THREADS` if set, and only as a fallback uses the number of cores. What I changed was that other parallel processes follow the same strategy. This change should only impact devs that compile sage and run doctests. I'm not sure if it really makes sense to be more strict there than with user-facing calculations. I would expect that devs have more knowledge that they might need to restrict parallel computations in order to not negatively impact their system.\n\nAnyway, if the special treatment of compilation and doctests is indeed preferred, what would be a good default? No parallelization at all if the user doesn't specify SAGE_NUM_THREADS?",
    "created_at": "2022-02-10T23:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471573",
    "user": "@tobiasdiez"
}
```

Replying to [comment:13 tscrim]:
> Replying to [comment:12 slelievre]:
> > Replying to [comment:11 jhpalmieri]:
> > > I'm concerned with mathematicians not knowing that they
> > > should change it and so accidentally overloading a system.
> > > We should not rely on users knowing what they're doing.
> > 
> > +1
> > 
> > Users who need speed will figure out how to change
> > a low default to something higher.
> > 
> > They can set the number of threads to use
> > for parallel computations in their `init.sage`.
> 
> +1 as well. We could very likely upset a sysadmin, especially with such a change where even a more knowledgeable user might not be paying so close attention to the Sage development cycle.


I think you misunderstood me. I didn't change the user-facing multiprocessing for calculation, i.e. what `ncpus` in `sage/parallel` returns (at least if I don't overlook something). This still first returns `SAGE_NUM_THREADS` if set, and only as a fallback uses the number of cores. What I changed was that other parallel processes follow the same strategy. This change should only impact devs that compile sage and run doctests. I'm not sure if it really makes sense to be more strict there than with user-facing calculations. I would expect that devs have more knowledge that they might need to restrict parallel computations in order to not negatively impact their system.

Anyway, if the special treatment of compilation and doctests is indeed preferred, what would be a good default? No parallelization at all if the user doesn't specify SAGE_NUM_THREADS?



---

archive/issue_comments_471574.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> Replying to [comment:9 mkoeppe]:\n> > Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.\n> > Please don't delete this.\n> \n> I didn't delete this script, but only the one in src/bin.\n\nYou deleted its use in `build/make/install`",
    "created_at": "2022-02-10T23:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471574",
    "user": "mkoeppe"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> Replying to [comment:9 mkoeppe]:
> > Also, the point of `build/bin/sage-build-num-threads` (called in build/make/install) is that it initializes the number of threads in a build context based on the user's use of `make -jNUM`.
> > Please don't delete this.
> 
> I didn't delete this script, but only the one in src/bin.

You deleted its use in `build/make/install`



---

archive/issue_comments_471575.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> Replying to [comment:8 mkoeppe]:\n> > Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. \n> \n> I [...] can change the naming of course \n\nYes, please change it back.",
    "created_at": "2022-02-10T23:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471575",
    "user": "mkoeppe"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> Replying to [comment:8 mkoeppe]:
> > Also, I don't see why the words `num_threads` (which developers are familiar with) should be replaced by `thread_count`. 
> 
> I [...] can change the naming of course 

Yes, please change it back.



---

archive/issue_comments_471576.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-11T23:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33080#issuecomment-471576",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.
