# Issue 33364: Documentation: Add 'furo' theme

Issue created by migration from https://trac.sagemath.org/ticket/33601

Original creator: @tobiasdiez

Original creation time: 2022-03-30 12:44:25

CC:  klee strogdon ​schilly mkoeppe

As discussed in #33309#comment:28, we add Furo (https://pradyunsg.me/furo/) as a possible theme for the documentation.
After gaining some experience with it, the goal would be to make it the default theme for sage's docs.

To test, run

```
./sage -pip install furo
./sage --docbuild developer html
```



---

Comment by @tobiasdiez created at 2022-03-30 12:44:39

There are still some problems with the reference and tutorial (something with static directories that are not found, any help appreciated), but the developer doc seems to work fine already. Feedback welcome!

Question: Is it correct that one has to add each dependency in the dependency tree as a sage package?


---

Comment by git created at 2022-03-30 13:55:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-30 16:28:02

Replying to [comment:1 gh-tobiasdiez]:
> Question: Is it correct that one has to add each dependency in the dependency tree as a sage package?

Yes if you make `furo` a "normal" package as in your current branch.
You can avoid it by making it a "pip" package instead.
https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types


---

Comment by git created at 2022-03-30 18:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-30 18:55:04

Replying to [comment:3 mkoeppe]:
> Replying to [comment:1 gh-tobiasdiez]:
> > Question: Is it correct that one has to add each dependency in the dependency tree as a sage package?
> 
> Yes if you make `furo` a "normal" package as in your current branch.
> You can avoid it by making it a "pip" package instead.
> https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types

Okay thanks. From the docs it was not clear to me when to choice pip packages over normal ones. I made furo now a pip package and it seems to work. 

I've also activated for the doc build github action, so it be visible there in a couple of hours.


---

Comment by mkoeppe created at 2022-03-30 19:43:45

I think it would be better to configure the theme explicitly instead of activating it whenever the package is installed. See #33320#comment:44


---

Comment by git created at 2022-03-30 20:19:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-30 20:20:52

All dependencies of `furo` (https://github.com/pradyunsg/furo/blob/main/pyproject.toml#L18 and https://github.com/pradyunsg/sphinx-theme-builder/blob/main/pyproject.toml#L16) for which we have SPKGs need to be listed in `dependencies`. This is so that there is not a race between installing a package with our tools and the automatic installation of dependencies by pip.


---

Comment by git created at 2022-03-30 21:18:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-30 23:18:09

That seems to work more or less:
https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/reference/
https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/tutorial/

I would propose that anyone interested can scroll around on these pages and then we can collect things that are not yet working as expected (and decide if they should be handled as part of this ticket or in followups).


---

Comment by @tobiasdiez created at 2022-04-01 16:25:06

After merging #33616 and #33608 this is now working well for me. Ready for review.


---

Comment by @tobiasdiez created at 2022-04-01 16:25:06

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-04-01 16:33:38

Replying to [comment:9 mkoeppe]:
> All dependencies of `furo` (https://github.com/pradyunsg/furo/blob/main/pyproject.toml#L18 and https://github.com/pradyunsg/sphinx-theme-builder/blob/main/pyproject.toml#L16) for which we have SPKGs need to be listed in `dependencies`. This is so that there is not a race between installing a package with our tools and the automatic installation of dependencies by pip.

I've added the dependencies from furo. Does the sphinx-theme-builder dependencies have to be really added? For me it downloads a wheel for furo, so build dependencies are ignored.


---

Comment by git created at 2022-04-01 16:34:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-05 00:44:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-04-27 16:25:05

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2022-04-27 16:27:29

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-04-27 16:27:29

Merged latest version of develop + dependencies, so should be ready for review now.


---

Comment by klee created at 2022-04-28 00:51:47

This seems to force furo theme when the optional furo package is installed.

Wouldn't it be possible to make it such that `sage --doc-build --theme=furo` works so that we can choose either `furo` or `classic` (default `classic` yet)?  



```diff
diff --git a/build/pkgs/furo/SPKG.rst b/build/pkgs/furo/SPKG.rst
index ebbd1bba23..e5a4894fab 100644
--- a/build/pkgs/furo/SPKG.rst
+++ b/build/pkgs/furo/SPKG.rst
@@ -1,5 +1,5 @@
-furo: A clean customisable Sphinx documentation theme.
-======================================================
+furo: A clean customisable Sphinx documentation theme
+=====================================================
 
 Description
 -----------
```



---

Comment by klee created at 2022-04-28 02:29:47

It looks very nice. 

I noticed that the top navigation bar of the classic theme is missing. Could it be added here?


---

Comment by mkoeppe created at 2022-04-28 18:01:06

Replying to [comment:22 klee]:
> This seems to force furo theme when the optional furo package is installed.
> 
> Wouldn't it be possible to make it such that `sage --doc-build --theme=furo` works so that we can choose either `furo` or `classic` (default `classic` yet)?  

I'm not sure if this complexity is needed. We can just expand the scope of the ticket to make furo the new theme (hence furo will have to be a standard package). People can already look at the product thanks to Tobias's deployment script - there's no need for people to try it out by compiling it themselves. 

So I'd suggest to just announce it for discussion on sage-devel to gauge people's opinion on it and then to make a decision.


---

Comment by mkoeppe created at 2022-04-28 18:04:59

A minor issue: The big logo in the side bar should link to the top of the Sage manuals, not the root of the current document


---

Comment by @tobiasdiez created at 2022-04-28 21:46:05

Replying to [comment:23 klee]:
> I noticed that the top navigation bar of the classic theme is missing. Could it be added here?

A header/top navigation bar is not supported by furo out of the box. One could overwrite one of the theme templates to add a header, but this is not going to be easy as furo already shows a header on smaller screens/mobile devices.

One of furo's design principles is to show the users location in the docs using the sidebar. There one could add captions to group documents and show a deeper toctree, see eg "Development" and collapse sidebar elements at https://pradyunsg.me/furo/customisation/logo/.


---

Comment by @tobiasdiez created at 2022-04-28 21:49:20

Replying to [comment:24 mkoeppe]:
> Replying to [comment:22 klee]:
> > This seems to force furo theme when the optional furo package is installed.
> > 
> > Wouldn't it be possible to make it such that `sage --doc-build --theme=furo` works so that we can choose either `furo` or `classic` (default `classic` yet)?  
> 
> I'm not sure if this complexity is needed. We can just expand the scope of the ticket to make furo the new theme (hence furo will have to be a standard package). People can already look at the product thanks to Tobias's deployment script - there's no need for people to try it out by compiling it themselves. 
> 
> So I'd suggest to just announce it for discussion on sage-devel to gauge people's opinion on it and then to make a decision.
> 

I agree that a theme selector is probably not needed. On the other hand, there are still some minor issues with how sage is displayed in the furo theme (e.g. more toctrees need to be modified/added). So I would propose to use furo on the dev preview for one release cycle and only then make it a standard package (except of course the issues are fixed very quickly and there are no new ones popping up).


---

Comment by @tobiasdiez created at 2022-04-28 22:06:01

Replying to [comment:25 mkoeppe]:
> A minor issue: The big logo in the side bar should link to the top of the Sage manuals, not the root of the current document

I think this is not possible at the moment. Furo always links to [root_doc](https://www.sphinx-doc.org/en/master/usage/configuration.html#confval-root_doc), which is also responsible for the toctree shown in the sidebar and thus cannot easily be changed. I'll open an feature request at furo.


---

Comment by git created at 2022-04-28 22:10:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-28 22:48:49

Replying to [comment:28 gh-tobiasdiez]:
> Replying to [comment:25 mkoeppe]:
> > A minor issue: The big logo in the side bar should link to the top of the Sage manuals, not the root of the current document
> 
> I think this is not possible at the moment. Furo always links to [root_doc](https://www.sphinx-doc.org/en/master/usage/configuration.html#confval-root_doc)

Well, we can just post-process the output...


---

Comment by klee created at 2022-04-29 01:31:54

Replying to [comment:28 gh-tobiasdiez]:
> Replying to [comment:25 mkoeppe]:
> > A minor issue: The big logo in the side bar should link to the top of the Sage manuals, not the root of the current document
> 
> I think this is not possible at the moment. Furo always links to [root_doc](https://www.sphinx-doc.org/en/master/usage/configuration.html#confval-root_doc), which is also responsible for the toctree shown in the sidebar and thus cannot easily be changed. I'll open an feature request at furo.

Before furo could replace the current sage-classic theme completely, it should have all functions of the current theme. At present, it has problems in navigating through all sage documentation through the sidebar (that takes the function of the top navigation bar of sage-classic) and the logo. There are other problems and more may be found later. 

I guess these problems would be difficult to solve without customizing the furo theme for sage. If so (and the license permits), then we should have `src/doc/common/themes/sage-furo` along with the current `sage-classic`. Then it is only natural that we have a configuration option to choose a theme among them. Eventually, when we are comfortable with the new theme, we can change the default theme.


---

Comment by @tobiasdiez created at 2022-04-30 20:56:17

Furo is open source so we can easily contribute features that we need so that also other developers could profit from it. In this way, we also don't create issues with maintaining customized theme templates and keeping them up-to-date with upstream changes.

I think the `--theme=furo` switch would make sense if we intend to support multiple themes in the future (or for a longer time), but as it currently looks like furo is mostly compatible with our needs and thus can be the default for the github action as of 9.7 and then go live with 9.8 (or 9.7 depending on the state) in my opinion.


---

Comment by mkoeppe created at 2022-04-30 20:58:19

Replying to [comment:33 gh-tobiasdiez]:
> if we intend to support multiple themes in the future

I wouldn't know for what purpose.


---

Comment by mkoeppe created at 2022-04-30 20:59:09

Replying to [comment:33 gh-tobiasdiez]:
> Furo is open source so we can easily contribute features that we need so that also other developers could profit from it.

+1, do you plan to work on it?


---

Comment by klee created at 2022-04-30 22:53:37

Replying to [comment:33 gh-tobiasdiez]:
> Furo is open source so we can easily contribute features that we need so that also other developers could profit from it. In this way, we also don't create issues with maintaining customized theme templates and keeping them up-to-date with upstream changes.

I agree with that, of course. It would be ideal if furo is customizable for all our needs. Then we don't need to keep multiple themes.   
 
> but as it currently looks like furo is mostly compatible with our needs and thus can be the default for the github action as of 9.7 and then go live with 9.8 (or 9.7 depending on the state) in my opinion. 

Okay. That would be nice. If furo is completely compatible with our needs, then the final step would be to remove sage-classic.


---

Comment by @tobiasdiez created at 2022-05-01 11:47:06

Replying to [comment:35 mkoeppe]:
> Replying to [comment:33 gh-tobiasdiez]:
> > Furo is open source so we can easily contribute features that we need so that also other developers could profit from it.
> 
> +1, do you plan to work on it?

Yes, at least the logo link seems to be a relatively easy localized change.


---

Comment by @tobiasdiez created at 2022-05-01 11:48:22

Something else missing / to be done as part of this ticket?


---

Comment by mkoeppe created at 2022-05-01 16:21:17

comment:24


---

Comment by klee created at 2022-05-01 19:24:21

Replying to [comment:38 gh-tobiasdiez]:
> Something else missing / to be done as part of this ticket?

Please add how to remove furo and return to the old theme in the description.


---

Comment by klee created at 2022-05-01 19:37:00

Please add #33763 as a dependency.


---

Comment by git created at 2022-05-02 14:48:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2022-05-02 14:50:24

Replying to [comment:40 klee]:
> Replying to [comment:38 gh-tobiasdiez]:
> > Something else missing / to be done as part of this ticket?
> 
> Please add how to remove furo and return to the old theme in the description.

Done


---

Comment by @tobiasdiez created at 2022-05-02 14:51:15

Replying to [comment:41 klee]:
> Please add #33763 as a dependency. 

Done by merging the latest version of #25833.


---

Comment by klee created at 2022-05-03 04:33:56

Thanks!

The following do not belong to this ticket strictly speaking, but are too trivial changes for a separate ticket. I would appreciate it if you make them here.   


```diff
diff --git a/build/pkgs/mathjax/SPKG.rst b/build/pkgs/mathjax/SPKG.rst
index de7b4baa3f..8d15488027 100644
--- a/build/pkgs/mathjax/SPKG.rst
+++ b/build/pkgs/mathjax/SPKG.rst
@@ -13,7 +13,6 @@ License
 
 Apache License, version 2.0
 
-
 Upstream Contact
 ----------------
 
@@ -22,16 +21,9 @@ Home page: https://www.mathjax.org/
 Dependencies
 ------------
 
-None
-
-
 Special Update/Build Instructions
 ---------------------------------
 
-None
-
-
 Patches
 -------
 
-None.
```



---

Comment by klee created at 2022-05-03 05:49:02

Replying to [comment:45 gh-tobiasdiez]:
> Replying to [comment:41 klee]:
> > Please add #33763 as a dependency. 
> 
> Done by merging the latest version of #25833.

Okay. But the gist of #33763 is to deprecate `src/sage/docs/conf.py` and to use `src/sage_docbuild/conf.py` instead. Hence your changes to `src/sage/docs/conf.py` should now be applied to `src/sage_docbuild/conf.py`. Unfortunately the automatic merge of Git failed in this, and the theme doesn't change. You have to make manual changes...


---

Comment by klee created at 2022-05-03 06:03:12

Replying to [comment:47 klee]:
> Unfortunately the automatic merge of Git failed in this

Technically the automatic merge didn't fail because I kept the file and the content of `src/sage/docs/conf.py` to prevent merge failures. Now I am not sure if I did a right thing...


---

Comment by mkoeppe created at 2022-05-03 06:07:16

Yes, it would have been better to just do `from sage_docbuild.conf import *` in the old file.


---

Comment by klee created at 2022-05-03 06:15:03

Replying to [comment:49 mkoeppe]:
> Yes, it would have been better to just do `from sage_docbuild.conf import *` in the old file.

Would it be acceptable to do this here? That is, removing all content and leaving the deprecation and the above import statement.


---

Comment by mkoeppe created at 2022-05-03 06:39:35

Sure, why not


---

Comment by klee created at 2022-05-03 06:46:02

Replying to [comment:51 mkoeppe]:
> Sure, why not

Okay. Please Tobias.


---

Comment by git created at 2022-05-08 09:06:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-08 09:10:26

Replying to [comment:52 klee]:
> Replying to [comment:51 mkoeppe]:
> > Sure, why not
> 
> Okay. Please Tobias. 

Done (if I understood it correctly).


---

Comment by klee created at 2022-05-09 04:04:10

Replying to [comment:54 gh-tobiasdiez]:
> Replying to [comment:52 klee]:
> > Replying to [comment:51 mkoeppe]:
> > > Sure, why not
> > 
> > Okay. Please Tobias. 
> 
> Done (if I understood it correctly).

Correct. Thanks.

Now the sage logo (at upper left corner) does not appear in furo theme.


---

Comment by @tobiasdiez created at 2022-05-09 11:42:31

It shows correctly in the online version: https://171d2c983650a7762b8006698dcbfd00b37e5939--sagemath-tobias.netlify.app/reference/


---

Comment by klee created at 2022-05-10 00:43:09

Okay. At least the optional furo package works. Minor problems with the furo theme could be tackled in later tickets.


---

Comment by klee created at 2022-05-10 00:43:09

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-05-10 18:33:17

Thanks for the review! I've opened #33833 to keep track of the remaining issues.


---

Comment by vbraun created at 2022-05-22 16:32:52

Merge failure on top of:

054e8ed8d9 Trac #33316: Drop support for GCC < 6.3 in Sage 9.7

fa3b529c41 Trac #25833: Upgrade to MathJax 3 and configure Sage

e2ebf445d0 Trac #33825: Use pytest-xdist to run pytest in parallel

b4009625f3 Trac #33824: make gens and orbits of PermutationGroup immutable

af23627f18 Trac #33809: some pathlib in combinat and groups

955b5d994c Trac #33803: Fixes for the distributions sagemath-objects, sagemath-categories

3e6b41f7d6 Trac #33799: Replace SAGE_TMP in doctests of sage.misc.{persist,ostools}, sage.doctest, sage.repl

a3fd7185e3 Trac #33797: sage.misc.temporary_file: Remove use of SAGE_TMP

2ca053010a Trac #33794: modules/fp_graded/morphism.py test failure

7037fba482 Trac #33793: sage.misc.cython: Replace use of SPYX_TMP by a new cached function in sage.misc.temporary_file

d1152701c4 Trac #33787: Installation manual: Update section "system-wide install"

0ae55652cf Trac #33782: ci-cygwin: Update python version

833f53d1cc Trac #33779: Remove use of SAGE_TMP in sage.interfaces.latte

b376a8d71c Trac #33771: SSLContext needs an argument

df168c8112 Trac #33763: Refactor src/sage/docs

9597eafded Trac #33748: make accessing coefficients of finite-field elements easier

f02236f5b6 Trac #33744: Compute bases/circuits in MatroidUnion

8943dc07fc Trac #33743: Faster random tree generator

773ec37bec Trac #33740: Add conda dev environment

5e65c16108 Trac #33734: variety() for polynomial systems over ℚ using msolve

8e7dcca8d3 Trac #33733: allow to use flint for Stirling numbers

6f4efb0bf3 Updated [SageMath](SageMath) version to 9.7.beta0



merge was not clean: conflicts in .vscode/settings.json


---

Comment by vbraun created at 2022-05-22 16:32:52

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-05-25 20:26:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-25 20:27:20

Merged #33740 to resolve merge conflict


---

Comment by mkoeppe created at 2022-05-25 20:27:20

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-05-29 11:29:11

Resolution: fixed
