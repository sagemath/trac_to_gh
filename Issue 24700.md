# Issue 24700: @parallel only uses one thread if SAGE_NUM_THREADS is not set; ncpus is wrong.

Issue created by migration from Trac.

Original creator: msaaltink

Original creation time: 2018-03-09 16:05:04

CC:  jdemeyer hivert mmancini @lerouxje

Some recent change - possibly #23713 - has changed the behaviour of `@`parallel.  Now, unless I set SAGE_NUM_THREADS, my parallel functions only use 1 thread.  Previously they used as many threads as I have cpus, which seems like a much nicer default.

Running sage 8.2beta5 with SAGE_NUM_THREADS unset in my environment gives this:

```
sage: os.environ["SAGE_NUM_THREADS"]
'1'
```

As a result, ncpus is wrong

```
sage: sage.parallel.ncpus.ncpus()
1
```

The correct answer here should be 4 (on my test machine):

```
sage: os.sysconf("SC_NPROCESSORS_ONLN")
4
```




---

Comment by egourgoulhon created at 2018-05-26 13:41:24

I confirm the bug and could trace it down to some changes between Sage 8.1.beta5 and 8.1.beta8. On my computer (Intel Core i7-6700HQ), with Sage 8.1.beta5 and all previous versions:

```
sage: from sage.parallel.ncpus import ncpus
sage: ncpus()
8
```

while with Sage 8.1.beta8 and all versions above:

```
sage: from sage.parallel.ncpus import ncpus
sage: ncpus()
1
```

So yes, a very probable culprit is #23713, which has been merged in Sage 8.1.beta8.

A consequence of this is the follwing bug reported at
https://ask.sagemath.org/question/42439/parallel-how-to-use-all-cpus/


---

Comment by jdemeyer created at 2018-05-26 21:08:11

The change in #23713 was certainly meant as feature.

The problem is that it's very hard to figure out a good default that works for everybody (from single users on desktop machines to server farms). One could argue that using 1 processor by default makes sense because that way ``@`parallel` is transparent unless you explicitly ask for multiple processors (in other words: it makes it possible to do multiprocessing but doesn't force it). So instead you should just explicitly specify the number of processors that you want.

I'm happy to continue this discussion on sage-devel if needed.


---

Comment by egourgoulhon created at 2018-05-27 08:15:26

Replying to [comment:3 jdemeyer]:
> The change in #23713 was certainly meant as feature.
> 

If it is a feature, then the documentation of `ncpus()` must be updated, making some reference to `SAGE_NUM_THREADS`. The current docstring says:

```
Detects the number of effective CPUs in the system.
```


> The problem is that it's very hard to figure out a good default that works for everybody (from single users on desktop machines to server farms). One could argue that using 1 processor by default makes sense because that way ``@`parallel` is transparent unless you explicitly ask for multiple processors (in other words: it makes it possible to do multiprocessing but doesn't force it). So instead you should just explicitly specify the number of processors that you want.
> 
> I'm happy to continue this discussion on sage-devel if needed.

Yes please. 
For instance, it would be convenient to have a replacement for the old `ncpus()`, i.e. a function that does return the total number of CPUs on the computer. In the present stage, all the code that does that (starting at line 56 of `src/sage/parallel/ncpus.py`) seems unreachable: starting a sage session sets the environment variable `SAGE_NUM_THREADS` to 1, so that `ncpus()` is basically equivalent to `return 1`.


---

Comment by mmancini created at 2018-05-28 08:04:38

For coherence with the must used threads library (openmp) the number of "available" threads should be set to the maximum available on the machine (which turns to be the consistent with old behavior) ant he function sage.parallel.ncpus.ncpus, coherently with its definition, return this value.
This "avalable" value is assumed also the default for parallelism. 
In the other hand, if parallelism is not invoked explicitly sage will we use only a processus.    

As in openmp, the user could redefine the default value (ncpus) for parallelism defining a environment variable : SAGE_NUM_THREADS (like OMP_NUM_THREADS).

The actual behavior which sets ncpus = 1 is if not a bug, a no desired behavior and should be corrected.


---

Comment by saraedum created at 2018-07-05 18:30:47

See #25779 for a duplicate.

I think `ncpus()` should return the number of cores (maybe unless overwritten by some environment variable) because that's what the name implies. I don't have a very strong opinion on how ``@`parallel` should work exactly but I feel that "1" is a poor default for most of our casual users. I personally liked the "min(8,cores)" logic that I think was taking place before. In any case, ``@`parallel` should certainly mention `SAGE_NUM_THREADS` in its documentation.

Btw, you can set `SAGE_NUM_THREADS=0` to get the old behaviour back, I think.


---

Comment by saraedum created at 2018-07-05 18:32:15

I volunteer to fix this. But what should the new behaviour be?


---

Comment by saraedum created at 2018-07-05 18:32:15

Changing status from new to needs_info.


---

Comment by egourgoulhon created at 2018-07-05 19:20:06

Replying to [comment:9 saraedum]:
> I volunteer to fix this. 

Very good!

>But what should the new behaviour be?

I think it's worth asking the question on sage-devel list.


---

Comment by slelievre created at 2019-06-03 05:49:25

Relevant / related discussions:

- [sage-devel, 2018-07, How parallel should `@`parallel be?](https://groups.google.com/d/topic/sage-devel/z45LTwQWxTc/discussion)
- [sage-devel, 2019-03, How would you like your parallel linear algebra?](https://groups.google.com/d/topic/sage-devel/ZNcijpPhWuc/discussion)


---

Comment by slabbe created at 2020-03-10 11:34:11

> I personally liked the "min(8,cores)" logic that I think was taking place before.

+1 from me for having `npcus()` return `min(8, cores)`


---

Comment by edgarcosta created at 2021-05-11 02:41:14

I think `ncpus()` should return the number of cores, just like https://docs.python.org/3/library/multiprocessing.html#multiprocessing.cpu_count

And by default `@`parallel should use all of them, just like OpenMP.

I honestly don't understand what is the point of returning something else.
If the sage community thinks that sage in its own routines should do something different, then write those limitations into sage's source code but don't change default behavior of a tool to make that happen.
Makes much more sense to see in sage's source code 

```
`@`parallel(ncpus=internal_sage_ncpus())
```

than the user having to always remember to do

```
import multiprocessing
`@`parallel(ncpus=multiprocessing.cpu_count())
```



For last, in case of server farms, if a sysadmin thinks that a user shouldn't use all the cores available by default, then it is his job to set the correct defaults, e.g., via environment variables,  that guides the user to the desired usage, just like one does in HPC servers.


---

Comment by slelievre created at 2021-05-11 10:15:15

Or endow `ncpus` with a keyword argument `max=None`, allowing `ncpus(max=8)`.
