# Issue 16366: permanental_minor_vector

Issue created by migration from https://trac.sagemath.org/ticket/16603

Original creator: pernici

Original creation time: 2014-07-01 18:24:37

CC:  ncohen jsp

ADD DESCRIPTION
  added function `permanental_minor_vector`, which computes the
  the polynomial of the sums of the permanental minors in an efficient
  way, see http://arxiv.org/abs/1406.5337

  As a benchmark, consider
  http://www.jaapspies.nl/mathfiles/dancing.sage
  on my computer `dance(10)` took 3 hours using sage-6.2, 0.08 seconds
  with this patch.

  In the case of banded matrices, the speedup is greater, since
  for fixed bandwidth the new algorithm is polynomial; here is a permanent
  which cannot be computed with sage-6.2

  sage: from sage.matrix.matrix_misc import permanental_minor_vector
  sage: n, w = 100, 5
  sage: m = matrix([[i*j + 1 if abs(i-j) <= w else 0
  ....:   for i in range(n)] for j in range(n)])
  sage: time p = permanental_minor_vector(m, 1)
  CPU times: user 1.11 s, sys: 20 ms, total: 1.13 s
  Wall time: 1.07 s


priority:  major
type:      enhancement
component: linear algebra


---

Comment by git created at 2014-07-01 20:38:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by chapoton created at 2014-10-31 19:35:58

I have had a quick look and made a review patch. You need to document the auxiliary function.
----
New commits:


---

Comment by pernici created at 2014-11-06 10:08:41

I made a commit in which I documented the auxiliary function, but by mistake I committed it
to u/pernici/ticket/16603 instead of public/ticket/16603
----
New commits:


---

Comment by chapoton created at 2014-11-28 17:18:59

Do you want this to be reviewed ? If yes, please turn it into "needs review".


---

Comment by pernici created at 2014-11-28 17:40:52

Replying to [comment:11 chapoton]:
> Do you want this to be reviewed ? If yes, please turn it into "needs review".

How do I turn it into "needs review" ?


---

Comment by chapoton created at 2014-11-28 20:11:24

Changing status from new to needs_review.


---

Comment by chapoton created at 2014-11-28 20:11:24

Click on "Modify ticket", then on the button "needs review". I did it for you.


---

Comment by vdelecroix created at 2014-12-06 21:09:40

Hello,

This code is very cool! You can have a look at my branch `u/vdelecroix/16603` where I provide two commits that I describe below.

- I edited a bit the code, I hope it is cleaner (and actually also a bit faster)

- Please, could you fill the section `ALGORITHM` of `permanental_minor_vector`. It would be nice to have here a rough description of the algorithm.

- I edited a lot the documentation. First of all the file `matrix_misc.py` was not part of the matrix documentation! After my commits it is. If you compile the documentation (with either `make doc` or `sage -docbuild reference html`) then you will see the result in the section `Matrices and Spaces of Matrices` -> `Miscellaneous matrix functions`. I changed the name `_prm_mul` to `prm_mul` in order to make it appear in the documentation.

- Currently the situtation for benchmarks is unfair:
   - the code of Jaap Spies to compute the permanent and the permanent minors can be optimized a lot!
   - your code is in Python while Jaap's one is in Cython

- As you mentioned this algorithm can be used in several contexts. It would be nice to have some methods (of graphs and matrices) that call it. But if you prefer, we can do it in a further ticket.

Vincent


---

Comment by vdelecroix created at 2014-12-06 21:09:40

Changing status from needs_review to needs_work.


---

Comment by pernici created at 2014-12-07 09:18:53

Hello,
  how can I access your branch u/vdelecroix/16603 ?


---

Comment by vdelecroix created at 2014-12-07 11:16:34

Replying to [comment:15 pernici]:
> Hello,
>   how can I access your branch u/vdelecroix/16603 ?

How do you do with your branch ` u/pernici/ticket/16603`? All users have write access to `public/*` and `u/username/*` and read access everywhere. Just do in the Sage root:

```
$ git fetch trac u/vdelecroix/16603
$ git checkout -b 16603_vincent_branch FETCH_HEAD
```

The first command download my two commits. The special temporary branch `FETCH_HEAD` is a pointer to the last commit. The second command creates a new branch called `16603_vincent_branch` and move to it.

You can then merge these commits (if you like them) in your branch with

```
$ git checkout my_original_branch
$ git merge 16603_vincent_branch
```


Is that clear enough?

Vincent


---

Comment by pernici created at 2014-12-07 12:08:14

Previously I used ./sage -dev checkout --ticket 16603
Following your instructions I got your branch; thanks.


---

Comment by vdelecroix created at 2014-12-07 14:00:58

Replying to [comment:17 pernici]:
> Previously I used ./sage -dev checkout --ticket 16603
> Following your instructions I got your branch; thanks.

I see. The `sage -dev` commands are a bit outdated (and give you much less freedom). You might better use `git` or the enhanced `git trac` that Volker Braun wrote. Have a look at [the documentation](http://sagemath.org/doc/developer/).


---

Comment by vdelecroix created at 2014-12-07 19:02:09

I rewrote the description (formatting the code).


---

Comment by git created at 2014-12-09 13:11:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-12-09 17:53:23

Hello,

I will push several commits in a minute on my branch `u/vdelecroix/16603`. Again you are free to use/discuss/reject them. I discuss the most important changes below.

Change in your original code and documentation:

- I changed your initial function into `permanental_minor_polynomial`. It looks more natural as it is what you compute... I moved the part of the code that makes it a list in `matrix.rook_vector`

- I added a keyword `var` (as it is the case for `matrix.charpoly` for example) and change the argument name from `m` to `A` (since A is used in the docstring)

- I optimized a bit the method `prm_mul` (it was possible to remove the loop computing `exp`) and introduced the list `vars_to_do` inplace of the set `done_vars`.

- Sometimes it might happen that some coefficient of the partial product become zero. I added a test in `prm_mul`. If you think this is not worth it, I can revert that change.

- Again, I edited a lot the documentation of `permanental_minor_polynomial`. Please reread carefully, I tried to make it more understandable but I might have made many mistakes.

- Do you know an adaptation of your method to compute only a specific permanental minor? (I guess that to compute the `k`-th permanental minor it is just enough to ignore the terms `t<sup>l</sup>` with `l > k`)

Methods of matrices:

- does your algorithm have a name? I used Butera-Pernici (see the item just below, it has some importance).

- To allow the computation using your algorith, I made changes in `matrix.permanental_minor` and `matrix.permanent`. After my commits you can do

```
sage: m = matrix(ZZ,4,4,range(16))
sage: m.permanent(algorithm="Ryser")
22432
sage: m.permanent(algorithm="ButeraPernici")
22432
```

  it will be easier to make benchmarks (but I repeat that right now it is not fair for both, see also #17457).

- Right now, in all methods except `matrix.rook_vector`, the default choice for algorithm is Ryser (what was before). Where do you think we should put yours in first?

- why `matrix.rook_vector` is only defined for {0,1} matrices... it is well defined for any matrix, isn't it?

- possibly we can add a method `matrix.permanental_minor_polynomial` but it will overlap a lot with rook vector. I am not sure what to do as these methods are very specific to matrix combinatorics. Perhaps you have a better overview than me on that.

Despite this big list of remarks, I am sure this is not far for being ready for integration! This is a really nice piece of work.

Vincent


---

Comment by vdelecroix created at 2014-12-09 18:00:34

changes pushed on `u/vdelecroix/16603`.


---

Comment by vdelecroix created at 2014-12-09 18:00:34

Changing status from needs_work to needs_info.


---

Comment by git created at 2014-12-15 11:46:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pernici created at 2014-12-15 12:00:31

Hello Vincent,

> Do you know an adaptation of your method to compute only a specific permanental minor? (I guess that to compute the k-th permanental minor it is just enough to ignore the terms t<sup>l</sup> with l > k)

I adapted the algorithm to compute fastly k-th permanental minor for small `k`;
testing on `A = matrix(n, k, range(n)` using this algorithm
`A.permanent_minor(k)` is faster for `2 <= k <= n-2

>does your algorithm have a name? I used Butera-Pernici (see the item just below, it has some importance).

No, it did not have a name.
> Right now, in all methods except matrix.rook_vector, the default choice for algorithm is Ryser (what was before). Where do you think we should put yours in first?

In the example above, for n x n matrices in `permanental_minor`
the Ryser algorithm is generally faster for `k=n` (permanent), slightly faster for
`k=1,n-1`; maybe one could make a default option which uses the Ryser
algorithm in those cases, the new algorithm in the other cases.

> why matrix.rook_vector is only defined for {0,1} matrices... it is well defined for any matrix, isn't it? 

Usually `rook vector` is defined only on {0,1} matrices; I added the "Godsil" algorithm which
is faster than the "Ryser" algorithm.


---

Comment by pernici created at 2014-12-17 18:30:34

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2014-12-18 23:23:23

Hello,

I really think that the documentation is half of a software: it provides specification of functions and help the user to orient himself/herself. Next time you implement a function in Sage pay attention that your new functionality is referenced from other part of the code and that it also make references to relevant functions. There is a lot of possibilities for organization of the documentation (see the [section "Docstring" of the developer guide](http://sagemath.org/doc/developer/coding_basics.html#docstring-markup-with-rest-and-sphinx)).

I was not happy with the current behavior and documentation of `rook_vector` and `permanental_minor` (these methods should work for rectangular matrices whatever their shape). I guess that this is my last commit for that ticket. Just have a look and if you agree we can set the ticket to positive review.

Next step would be optimisation of Ryser algorithm: #17457.

Vincent
----
New commits:


---

Comment by pernici created at 2015-01-08 12:28:11

Hello,
I added the ``matching_polynomial`` method to the ``BipartiteGraph`` class, so one can optionally
use the "rook" algorithm.
Now ``rook_vector`` is much faster when the matrix is made mostly of ones.
I fixed a couple of bugs and added documentation.

A simple optimization I did not include here is the one in case of matrices which can be put in block form
permuting rows and columns. I did not include it because it does not seem to be a commonly occurring
case. The same optimization can be used in the computation of determinants of large matrices of this kind.
Do you think that it is worth opening a ticket on it, or is it too obvious and useless?

Sooner or later I will open a ticket for a faster algorithm for the matching polynomial of graphs (non bipartite).
----
New commits:


---

Comment by vdelecroix created at 2015-01-09 09:22:05

Hello,

First of all, there is already a lot of material on this ticket. It would be good to stop here and open tickets for new features (please put me on cc on them).

I push a commit as I do not like the `complement` keyword that sounds like you want the rook vector of the complement matrix. I replaced it with `use_complement`. I know that it is different from the specification for `BipartiteGraphs` but it fits with `IndependentSets`

```
sage: from sage.graphs.independent_sets import IndependentSets
sage: I = IndependentSets(graphs.GridGraph((5,5)))
sage: I.cardinality()
55447
sage: I = IndependentSets(graphs.GridGraph((5,5)), complement=True)
sage: I.cardinality()
66
```

Nevertheless, I kept the keyword `complement` to do the following as it is very useful

```
sage: identity_matrix(6).rook_vector(complement=True)
[1, 30, 315, 1420, 2715, 1854, 265]
```


Vincent
----
New commits:


---

Comment by pernici created at 2015-01-12 11:43:02

Hello,
I made one more small change.
Thank you for reviewing and improving the code and documentation.
----
New commits:


---

Comment by vdelecroix created at 2015-01-12 14:18:50

Hello,

Let us stop there with positive review! If you want to go any further open a new ticket (and please put me in cc).

Vincent


---

Comment by vdelecroix created at 2015-01-12 14:18:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-12 18:46:49

Doctest failure in src/sage/misc/sagedoc.py


---

Comment by vbraun created at 2015-01-12 18:46:49

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2015-01-12 19:54:26

Funny! Done...
----
New commits:


---

Comment by vdelecroix created at 2015-01-12 19:54:26

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-01-12 19:54:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-13 11:04:48

Resolution: fixed
