# Issue 13336: Automatically detect and test optional dependencies.

Issue created by migration from Trac.

Original creator: robertwb

Original creation time: 2012-09-27 09:20:00

Assignee: mvngu

CC:  jhpalmieri iandrus slelievre




---

Comment by jdemeyer created at 2012-09-27 09:27:40

Checking just for the existence of `gcc` is insufficient, you would have a lot of false positives with missing/broken assemblers/linkers...  You actually need to compile something, preferably a shared library.


---

Comment by jdemeyer created at 2012-09-27 09:30:11

For the internet test: could you use `www.sagemath.org` instead of `173.194.33.3`.  In any case, an IP address is bad because
 1. you don't test DNS, which is required.
 1. it can change.


---

Comment by jdemeyer created at 2012-09-27 09:31:51

Also please add a check for `g++` and `gfortran`.


---

Comment by jdemeyer created at 2012-09-27 09:44:45

Instead of relying on `which`, simply execute the command and catch `OSError`.


---

Comment by jdemeyer created at 2012-09-27 09:55:45

Command lines for `gcc`, `g++`, `gfortran` compiling a shared library from `/dev/null`:

```
gcc -shared -fpic -x c /dev/null -o /dev/null
g++ -shared -fpic -x c++ /dev/null -o /dev/null
gfortran -cpp -ffree-form -shared -fpic -x f95 /dev/null -o /dev/null
```


I have no idea how to do any of this with other compilers such as `clang`.


---

Comment by jdemeyer created at 2012-09-27 09:58:07

I think it would be good to implement either caching or lazy evaluation (only check when actually encountering `# optional - foo`).  Otherwise, somebody with a slow internet connection could see a substantial time added to every doctest run.


---

Comment by jdemeyer created at 2012-09-27 10:11:59

For programs like `magma`, does Sage require a specific version?  If so, you should check for that version.


---

Comment by robertwb created at 2012-09-28 07:26:47

I would be surprised if many people that have gcc have a broken gcc, but it couldn't hurt to check (and g++, etc.) Same with internet--it's rare for people to be connected but not be able to resolve DNS. (If this is lazy, latency less of an issue.)

Good points. I'll refactor this to make things lazy and otherwise improve the patch.


---

Attachment

Apply only 13540-optional-tests.2.patch


---

Comment by robertwb created at 2012-10-09 07:57:40

Changing status from new to needs_review.


---

Comment by robertwb created at 2012-10-24 06:48:22

Apply 13540-optional-tests.2.patch to sage-local repo.


---

Comment by vbraun created at 2012-12-20 15:11:06

The patch is great but a great number of the `# optional - internet` doctests fail because they haven't been doctested in a while... Any opinion on how to proceeed?


---

Attachment


---

Comment by leif created at 2012-12-30 02:43:47

IMHO we shouldn't hardcode the names of the executables (`gcc`, `g++`, `gfortran` etc.), but respect for example `CC`, `CXX`, `FC`/`F77`/`F95`.

(Also wonder whether "`# optional - gcc`" really means GCC, or _some_ C compiler, perhaps at least capable of compiling Cython-generated code.)


---

Comment by leif created at 2012-12-30 02:55:00

Replying to [comment:15 leif]:
> IMHO we shouldn't hardcode the names of the executables (`gcc`, `g++`, `gfortran` etc.), but respect for example `CC`, `CXX`, `FC`/`F77`/`F95`.

As an alternative, we *might* put their settings "during build" (whatever that means) into dummy/wrapper scripts in `$SAGE_LOCAL/bin/`.  (I don't really have an opion on that, but tend to be against such.  It might be convenient to "ordinary" users, or perhaps for automated testing, but annoying or confusing to developers.)


---

Comment by robertwb created at 2012-12-30 04:33:46

For all intents and purposes, at the moment, gcc really means gcc. And building a Cython extension with a different compiler than Python was compiled with (and the relevant libraries, for C++ in particular) gets really messy. 

In any case, the point of this ticket is to introduce a framework that lets us test optional doctests automatically, as they the current setup means they're never tested and so quickly broken. We could do something more sophisticated with CC, etc. but gcc, at the very least, provides a common enough dependency to actually exercise this code for most (probably all) developers (and it's not near as brittle as others).


---

Comment by leif created at 2012-12-30 05:21:34

Replying to [comment:17 robertwb]:
> For all intents and purposes, at the moment, gcc really means gcc. And building a Cython extension with a different compiler than Python was compiled with (and the relevant libraries, for C++ in particular) gets really messy.

We might then even use Python's / distutils' settings for testing tool availability (although there's no variable for the Fortran compiler AFAIK).  Not sure what to do with bdists (in case they don't contain a pre-built GCC as well).




> In any case, the point of this ticket is to introduce a framework that lets us test optional doctests automatically, as they the current setup means they're never tested and so quickly broken. We could do something more sophisticated with CC, etc. but gcc, at the very least, provides a common enough dependency to actually exercise this code for most (probably all) developers (and it's not near as brittle as others).

Yes.  Nevertheless, I don't think I'm the only one that almost always sets `CC`, `CXX` etc., in order to use _different versions of GCC_.

Support for other compilers (e.g. `clang`), probably also flags to pass, is certainly out of the scope of this ticket.  (It would be convenient to have something like `config.status`, i.e., a mechanism for storing and restoring the build environment, and/or also a "`.sagerc`" local / specific to the _Sage installation_, one overriding the other...)


---

Comment by jdemeyer created at 2012-12-30 08:02:25

How is this supposed to interact with the `--optional` and `--only-optional` command line options? I have a hard time understanding the new code.


---

Comment by roed created at 2013-03-28 23:12:40

Changing component from doctest to doctest framework.


---

Comment by jdemeyer created at 2013-03-29 01:44:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-03-29 01:44:14

This would obviously need to be rebased to #12415.


---

Comment by ncohen created at 2013-08-02 09:48:01

(just to follow what's happening. This ticket would be a nice change indeed `O_o`)


---

Comment by leif created at 2014-05-17 22:12:05

Magma doctest failures now get fixed at #16322.


---

Comment by ncohen created at 2015-05-31 08:40:28

Hello everybody,

A branch that does that has been created at #18558 (needs review)

Nathann


---

Comment by klee created at 2016-04-27 04:26:59

This is now  "duplicate/wontfix" as the replacement #20182 is now merged.


---

Comment by klee created at 2016-04-27 04:26:59

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2016-08-29 08:42:20

Is this ticket solved by the other tickets mentioned in the last comments?
Does any comment in the discussion beg for a follow-up ticket?


---

Comment by klee created at 2016-08-29 08:52:47

Replying to [comment:30 slelievre]:
> Is this ticket solved by the other tickets mentioned in the last comments?

Yes.

> Does any comment in the discussion beg for a follow-up ticket?

I don't think so. Most of the comments in this discussion are 4 years old, and so perhaps invalid now.


---

Comment by slelievre created at 2016-08-29 10:27:18

Changing status from needs_review to positive_review.


---

Comment by leif created at 2016-08-29 16:10:19

4-year old => invalid

ROFL.


---

Comment by embray created at 2016-08-30 13:32:25

Resolution: wontfix


---

Comment by embray created at 2016-08-30 13:32:25

Determined to be invalid/duplicate/wontfix (closing as "wontfix" as a catch-all resolution).
