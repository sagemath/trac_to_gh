# Issue 12423: eigenmatrix of complex floating-point matrix is wrong

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2012-02-26 19:18:38

Assignee: jason, was

CC:  rbeezer slelievre

Keywords: eigenmatrix, CDF


```
sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1], [1, 1, 1, 1, -1, -1, 1, -3], [-1, 3, -1, -1, 1, 1, -1, -1], [-1, -1, -1, 3, 1, 1, -1, -1], [1, 1, -3, 1, -1, -1, 1, 1], [1, 1, 1, 1, -1, -1, -3, 1], [3, -1, -1, -1, 1, 1, -1, -1], [1, 1, 1, 1, 3, -1, 1, 1]])
sage: d, p = m.eigenmatrix_left()
sage: (p[1] * m)[0] / p[1][0]
1.2360679775 - 3.80422606518*I
sage: d[1][1]
1.2360679775 + 3.80422606518*I
```

Sage seems to return the complex conjugate of `d` or something of the sort. Perhaps `d` is simply wrongly permuted (but real eigenvalues seem to be correct).

`p.inverse() * d * p` should be at least approximately equal to `m`.

This was reported on [the public bug reports from the notebook interface](https://spreadsheets.google.com/pub?key=pCwvGVwSMxTzT6E2xNdo5fA) by <david+bugs`@`madore.org> on 1/24/2012.


---

Comment by dsm created at 2012-05-27 23:44:16

Somewhat smaller example, and evidence that something's wrong in RDF too:


```

sage: M = [[1,-1],[1, 1]]
sage: rings = SR, ZZ, QQ, RDF, CDF
sage: for ring in rings:
....:     m = Matrix(ring, M)
....:     d, p = m.left_eigenmatrix()
....:     print m- (~p)*d*p
....: 
[0 0]
[0 0]
[0 0]
[0 0]
[0 0]
[0 0]
[ 0.0 -2.0]
[ 2.0  0.0]
[2.22044604925e-16 + 1.96068977308e-16*I              -2.0 - 2.22044604925e-16*I]
[              2.0 + 8.14867788484e-17*I                      -2.22044604925e-16]

```



---

Comment by dsm created at 2012-05-27 23:47:13

[Of course even if m is over RDF d and p can be over CDF.]


---

Comment by rbeezer created at 2012-05-28 03:06:15

Appears the computed results in both of the above examples are correct for the *transpose* of the matrix.  Digging deeper.......


---

Comment by rbeezer created at 2012-05-28 03:06:15

Changing keywords from "eigenmatrix, CDF" to "eigenmatrix, CDF, sd40.5".


---

Comment by rbeezer created at 2012-05-28 03:06:50

Changing keywords from "eigenmatrix, CDF, sd40.5" to "eigenmatrix CDF sd40.5".


---

Comment by dkrenn created at 2015-04-16 20:32:45

Still getting

```
sage: norm(p.inverse() * d * p - m)
7.608452130361234
```

on Sage 6.6.

FYI, doing the same but over QQbar gives `1.3060006046871026e-37`.


---

Comment by @shashwat1002 created at 2022-02-12 19:33:56

I think this is no longer a problem 


```
sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1], [1, 1, 1, 1, -1, -1, 1, -3], [-1, 3, -1, -1, 1, 1, -1, -1], [-1, -1, -1, 3, 1, 1, -1, -1], [1, 1, -3, 1, -1, -1, 1, 1], [1, 1, 1, 1, -1, -1, -3, 1], [3, -1, -1, -1, 1, 1, -1, -1], [1, 1, 1, 1, 3, -1, 1, 1]])
sage: d, p = m.eigenmatrix_left()
sage: norm(p.inverse() * d * p - m)
8.505150621424852e-15
```



The answer for the norm is now close enough to `0` so probably the underlying issue has been resolved.


---

Comment by @shashwat1002 created at 2022-02-12 19:34:13

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-02-12 23:05:49

Could a doctest be added for that?


---

Comment by slelievre created at 2022-02-12 23:05:49

Changing status from needs_review to needs_info.


---

Comment by @shashwat1002 created at 2022-02-13 07:46:37

Changing status from needs_info to needs_review.


---

Comment by @shashwat1002 created at 2022-02-13 07:46:37

New commits:


---

Comment by @shashwat1002 created at 2022-02-13 07:49:02

Replying to [comment:14 slelievre]:
> Could a doctest be added for that?

Just added 

The doctest tests if it is within 10^(-12) 

That precision has been chosen arbitrarily. 

I hope this suffices.


---

Comment by slelievre created at 2022-02-13 10:55:16

Currently your commit looks like this
(where `_` indicates trailing whitespace):


```diff
$ git show
commit d1ed045943d68...
Author: ...
Date:   ...

    Trac #12595: elgennmatrix of complex floating-point matrix

    Add doctest to demonstrate that the issue is already resolved

diff --git a/src/sage/matrix/matrix2.pyx b/src/sage/matrix/matrix2.pyx
index 7c5cd644d4..3ed18eb108 100644
--- a/src/sage/matrix/matrix2.pyx
+++ b/src/sage/matrix/matrix2.pyx
`@``@` -6936,6 +6936,14 `@``@` cdef class Matrix(Matrix1):
             Traceback (most recent call last):
             ...
             RuntimeError: failed to compute eigenvectors for eigenvalue ..., check eigenvectors_left() for partial results
+________
+        The following example shows that :trac:`12595` has been resolved_
+____________
+            sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1], [1, 1, 1, 1, -1, -1, 1, -3], [-1, 3, -1, -1, 1, 1, -1, -1], [-1, -1, -1, 3, 1, 1, -1, -1], [1, 1, -3, 1, -1, -1, 1, 1], [1, 1, 1, 1, -1, -1, -3, 1], [3, -1, -1, -1, 1, 1, -1, -1], [1, 1, 1, 1, 3, -1, 1, 1]])
+            sage: d, p = m.eigenmatrix_left()
+            sage: norm(p.inverse() * d * p - m) < 10^(-12)
+            True
+
         """
         from sage.misc.flatten import flatten
         from sage.matrix.constructor import diagonal_matrix, matrix
```


Comments:

- the commit message has "elgenmatrix" for "eigenmatrix"
- several lines have trailing white space, please remove it
- remove the blank line at the end of the docstring,
  between the test and the closing `"""`
- the line "The following ... resolved" should end with `::`
  to actually get tested
- please use `1e-12` instead of `10^-12` here
- the example input could be wrapped as follows


```diff
            sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1],
            ....:                     [1, 1, 1, 1, -1, -1, 1, -3],
            ....:                     [-1, 3, -1, -1, 1, 1, -1, -1],
            ....:                     [-1, -1, -1, 3, 1, 1, -1, -1],
            ....:                     [1, 1, -3, 1, -1, -1, 1, 1],
            ....:                     [1, 1, 1, 1, -1, -1, -3, 1],
            ....:                     [3, -1, -1, -1, 1, 1, -1, -1],
            ....:                     [1, 1, 1, 1, 3, -1, 1, 1]])
```


- Finally, I think splitting the last input line as follows
  would make the test even clearer:


```
            sage: mm = p.inverse() * d * p  # equals `m` up to numerical noise
            sage: (mm - m).norm() < 1e-12
```


Can you take all these comments into account and send a new commit?
You can force-push to replace the previous commit.


---

Comment by git created at 2022-02-13 14:45:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @shashwat1002 created at 2022-02-13 14:46:14

Replying to [comment:17 slelievre]:
> Currently your commit looks like this
> (where `_` indicates trailing whitespace):
> 
> {{{#!diff
> $ git show
> commit d1ed045943d68...
> Author: ...
> Date:   ...
> 
>     Trac #12595: elgennmatrix of complex floating-point matrix
> 
>     Add doctest to demonstrate that the issue is already resolved
> 
> diff --git a/src/sage/matrix/matrix2.pyx b/src/sage/matrix/matrix2.pyx
> index 7c5cd644d4..3ed18eb108 100644
> --- a/src/sage/matrix/matrix2.pyx
> +++ b/src/sage/matrix/matrix2.pyx
> `@``@` -6936,6 +6936,14 `@``@` cdef class Matrix(Matrix1):
>              Traceback (most recent call last):
>              ...
>              RuntimeError: failed to compute eigenvectors for eigenvalue ..., check eigenvectors_left() for partial results
> +________
> +        The following example shows that :trac:`12595` has been resolved_
> +____________
> +            sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1], [1, 1, 1, 1, -1, -1, 1, -3], [-1, 3, -1, -1, 1, 1, -1, -1], [-1, -1, -1, 3, 1, 1, -1, -1], [1, 1, -3, 1, -1, -1, 1, 1], [1, 1, 1, 1, -1, -1, -3, 1], [3, -1, -1, -1, 1, 1, -1, -1], [1, 1, 1, 1, 3, -1, 1, 1]])
> +            sage: d, p = m.eigenmatrix_left()
> +            sage: norm(p.inverse() * d * p - m) < 10^(-12)
> +            True
> +
>          """
>          from sage.misc.flatten import flatten
>          from sage.matrix.constructor import diagonal_matrix, matrix
> }}}
> 
> Comments:
> 
> - the commit message has "elgenmatrix" for "eigenmatrix"
> - several lines have trailing white space, please remove it
> - remove the blank line at the end of the docstring,
>   between the test and the closing `"""`
> - the line "The following ... resolved" should end with `::`
>   to actually get tested
> - please use `1e-12` instead of `10^-12` here
> - the example input could be wrapped as follows
> 
> {{{#!diff
>             sage: m = Matrix(CDF, 8, [[-1, -1, -1, -1, 1, -3, -1, -1],
>             ....:                     [1, 1, 1, 1, -1, -1, 1, -3],
>             ....:                     [-1, 3, -1, -1, 1, 1, -1, -1],
>             ....:                     [-1, -1, -1, 3, 1, 1, -1, -1],
>             ....:                     [1, 1, -3, 1, -1, -1, 1, 1],
>             ....:                     [1, 1, 1, 1, -1, -1, -3, 1],
>             ....:                     [3, -1, -1, -1, 1, 1, -1, -1],
>             ....:                     [1, 1, 1, 1, 3, -1, 1, 1]])
> }}}
> 
> - Finally, I think splitting the last input line as follows
>   would make the test even clearer:
> 
> {{{
>             sage: mm = p.inverse() * d * p  # equals `m` up to numerical noise
>             sage: (mm - m).norm() < 1e-12
> }}}
> 
> Can you take all these comments into account and send a new commit?
> You can force-push to replace the previous commit.


Just did, please check :)


---

Comment by slelievre created at 2022-02-13 16:01:24

Please

- remove trailing whitespace in the definition of `m`,
- remove blank line between definition of `m` and of `d, p`
- put two spaces before `#` for the inline comment


---

Comment by git created at 2022-02-13 16:48:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @shashwat1002 created at 2022-02-13 16:49:19

Replying to [comment:20 slelievre]:
> Please
> 
> - remove trailing whitespace in the definition of `m`,
> - remove blank line between definition of `m` and of `d, p`
> - put two spaces before `#` for the inline comment

I have dealt with the white discrepancies. 

Please check :)


---

Comment by slelievre created at 2022-02-13 21:56:52

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-02-13 21:56:52

Looks good to me.


---

Comment by vbraun created at 2022-02-20 13:27:58

Resolution: fixed
