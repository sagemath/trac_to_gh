# Issue 24718: py3: miscellaneous fixes related to __func__

Issue created by migration from https://trac.sagemath.org/ticket/24955

Original creator: embray

Original creation time: 2018-03-12 11:05:06

I don't think any of these fixes are in any other ticket yet but I need to double-check.

This fixes issues related to the fact that on Python 2 looking up a method on a class returns an "unbound method" object, whereas on Python 3 it just returns the bare function object.


---

Comment by embray created at 2018-03-12 11:07:10

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-03-12 19:33:55

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-12 19:33:55

This has been fixed in #24728:

```
            # TODO: There is a bug in how the cyfunction type's __get__
            # works on Python 3--it should not return an instancemethod
            # on the class
```



---

Comment by embray created at 2018-03-13 14:19:48

Oh, great.  I take it that fix will be included in Cython 0.28 as well?  In that case I'll just remove that note, and I think maybe the test right before it requires updating as well.


---

Comment by jdemeyer created at 2018-03-13 14:24:59

Replying to [comment:3 embray]:
> Oh, great.  I take it that fix will be included in Cython 0.28 as well?

Yes.


---

Comment by git created at 2018-03-26 10:55:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-26 10:58:38

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-03-27 00:09:25

Failures according to the patchbot:

```
----------------------------------------------------------------------
sage -t --long src/sage/algebras/nil_coxeter_algebra.py  # 2 doctests failed
sage -t --long src/sage/interacts/test_jupyter.rst  # 1 doctest failed
sage -t --long src/sage/combinat/k_tableau.py  # 2 doctests failed
sage -t --long src/sage/combinat/sf/sf.py  # 23 doctests failed
sage -t --long src/sage/combinat/sf/llt.py  # 1 doctest failed
sage -t --long src/sage/combinat/sf/k_dual.py  # 123 doctests failed
sage -t --long src/sage/combinat/sf/new_kschur.py  # 121 doctests failed
sage -t --long src/sage/monoids/automatic_semigroup.py  # 1 doctest failed
sage -t --long src/sage/tests/book_schilling_zabrocki_kschur_primer.py  # 51 doctests failed
----------------------------------------------------------------------
```

From looking at the patch, I expected these failures. Python sees it as a type-mismatch.


---

Comment by tscrim created at 2018-03-27 00:09:25

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-27 07:53:07

Personally, I think it would be better to rewrite that code to not rely on `__func__` in the first place.


---

Comment by embray created at 2018-03-27 08:59:31

Oh weird, this ticket is now missing other changes I made that are definitely necessary to work on both Python 2 and 3.  I don't know where they went because I remember making them just a couple weeks ago.  For cross-compatibility it works best to use `six.get_unbound_function`.

I don't know how you would "rewrite that code to not rely on `__func__` in the first place".  I did think of refactoring this stuff out to a mix-in class; is that what you mean?


---

Comment by embray created at 2018-03-27 09:02:16

Weird; I definitely fixed this "correctly" a week or two ago, but now I can't find it any of my local or remote branches.


---

Comment by git created at 2018-04-03 08:48:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-04-15 07:21:17

is this back to "needs_review" ?


---

Comment by embray created at 2018-04-16 07:46:30

Sure, thought it seemed like maybe Jeroen had something else in mind, though it wasn't clear what.  But this does fix the problem.


---

Comment by embray created at 2018-04-16 07:46:30

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-04-16 11:44:22

ok


---

Comment by jdemeyer created at 2018-04-16 11:47:40

I am experimenting with a more proper solution for `ParentMethods` in #25179.


---

Comment by chapoton created at 2018-04-16 12:23:53

Do you object to a positive review here ?


---

Comment by jdemeyer created at 2018-04-16 12:56:00

See also #25181.


---

Comment by jdemeyer created at 2018-04-16 12:56:53

Replying to [comment:16 chapoton]:
> Do you object to a positive review here ?

Yes because #25179 and #25181 might be better. At least the solution here should be compared to the solution in those other tickets.


---

Comment by jdemeyer created at 2018-05-17 10:09:03

The certainly conflicts with #25179.


---

Comment by jdemeyer created at 2018-05-17 10:09:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-05-17 16:09:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-17 16:10:32

Rebased on top of / using #25179.


---

Comment by embray created at 2018-05-17 16:10:32

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-01 11:21:57

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-06-01 11:21:57

This triggers many failing doctests, see patchbots.


---

Comment by chapoton created at 2018-07-05 06:40:00

what is the status of this one ?


---

Comment by jdemeyer created at 2018-07-05 08:19:10

I would like to deal with src/sage/categories/unital_algebras.py on #25181.


---

Comment by tscrim created at 2018-07-05 23:53:23

Replying to [comment:27 jdemeyer]:
> I would like to deal with src/sage/categories/unital_algebras.py on #25181.

Which I plan to talk with Nicolas about at SageDays`@`ICERM in ~3 weeks.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by git created at 2018-09-06 14:20:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-06 14:22:16

Rebased this.  I think the fix in `sage.categories.magmas` is still relevant.  The other change in `unital_algebras` is some leftover whitespace cleanup from when there were some more relevant changes to that module in this ticket that are no longer needed.


---

Comment by embray created at 2018-09-06 14:22:16

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-09-06 19:18:45

Looks good to me, but I would prefer to wait for Jeroen's approval..


---

Comment by jdemeyer created at 2018-09-06 19:22:28

Can we avoid using `inspect.isfunction` for purposes unrelated to introspection? Or at least justify that `inspect.isfunction` call?


---

Comment by jdemeyer created at 2018-09-06 19:22:28

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-09-07 12:17:35

Hmm, I agree, in retrospect.  I think for this particular case it's good enough just to ensure that it's not `None`.


---

Comment by chapoton created at 2018-09-12 12:15:11

Will this be a fix for #26206 ?


---

Comment by embray created at 2018-09-12 14:26:43

I don't know, but probably.  Have you tried?

My python3 branch, which has this fix already merged in, gives


```
$ ./sage -t src/sage/rings/polynomial/cyclotomic.pyx
too many failed tests, not using stored timings
Running doctests with ID 2018-09-12-14-25-40-607f4567.
Git branch: python3
Using --optional=dochtml,meataxe,memlimit,mpir,python2,sage
Doctesting 1 file.
sage -t src/sage/rings/polynomial/cyclotomic.pyx
    [34 tests, 1.39 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 1.4 seconds
    cumulative wall time: 1.4 seconds
```



---

Comment by chapoton created at 2018-09-12 14:30:13

Yes, I just tried and this does the job. So please try to move on here.


---

Comment by embray created at 2018-09-12 14:33:36

If it's urgent you're welcome to take it over yourself.  I agree with Jeroen's concern that there's probably no need to use `inspect.isfunction` here (I don't agree necessarily that the `inspect` module should _only_ be used for introspection, but I also know he's concerned that this won't work for CyFunctions).


---

Comment by chapoton created at 2018-09-12 14:38:14

I already tried and failed..


---

Comment by chapoton created at 2018-09-15 19:59:23

To be more precise, I tried to replace "inspect.isfunction(...)" by "... is not None" and it did not work. What would be the correct way ?


---

Comment by embray created at 2018-09-18 17:16:13

Sorry, yeah, `is not None` was bad advice.  I don't know what I was thinking when I wrote that.


---

Comment by git created at 2018-09-18 17:20:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-18 17:22:51

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-09-18 17:22:51

I think this is the correct intent here.


---

Comment by chapoton created at 2018-09-18 19:31:49

seems to trigger *a lot* of failing doctests:

```
sage -t --long src/sage/categories/coxeter_groups.py  # 99 doctests failed
sage -t --long src/sage/categories/complex_reflection_or_generalized_coxeter_groups.py  # 27 doctests failed
sage -t --long src/sage/categories/examples/finite_weyl_groups.py  # 7 doctests failed
sage -t --long src/sage/categories/finite_weyl_groups.py  # 1 doctest failed
sage -t --long src/sage/combinat/sf/new_kschur.py  # Killed due to segmentation fault
```



---

Comment by chapoton created at 2018-09-19 07:41:22

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-09-19 10:57:20

Indeed, I must still be missing something (I ran a few tests that suggest this worked, but I wasn't entirely sure all the possible situations where this would come up, so just seeing these test failures helps).


---

Comment by embray created at 2018-09-19 12:12:16

oops, I just have a spurious `not` for some reason.  It should be


```python
if isinstance(C_mul_func, AbstractMethod):
    return
```


not _not isinstance_...


---

Comment by git created at 2018-09-19 12:19:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-09-19 12:19:19

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-09-19 15:06:26

Looks good to me.

`@`jdemeyer, do you agree ?

EDIT: This should have high priority, as it may fix a lot of doctests..


---

Comment by embray created at 2018-09-20 11:56:05

Note: If you believe this patch is useful you can always merge it locally...


---

Comment by chapoton created at 2018-09-20 18:29:57

ok, let me set this to positive.


---

Comment by chapoton created at 2018-09-20 18:29:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-09-22 10:22:43

Resolution: fixed
