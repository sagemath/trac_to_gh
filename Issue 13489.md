# Issue 13489: Upgrade matplotlib to 1.2.0

Issue created by migration from Trac.

Original creator: jason

Original creation time: 2012-11-09 08:02:42

Assignee: jason, was

CC:  kcrisman jpflori

Matplotlib 1.2.0 was released today.  Here's an updated spkg.


---

Comment by jason created at 2012-11-09 08:06:22

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-11-10 19:59:40

I'm trying this out. A few quick comments:

- In SPKG.txt, the line `=== matplotlib-1.1.0 (Jason Grout, 09 Nov 2012) ===` should say `1.2.0`.
- The file `patches/mkdir-race-condition.patch` should be removed from the repository (according to `hg status`, the repo is not clean right now).
- I'm getting doctest failures in the plot directory:

```
The following tests failed:

	sage -t  devel/sage-main/sage/plot/colors.py # 8 doctests failed
	sage -t  devel/sage-main/sage/plot/graphics.py # 1 doctests failed
	sage -t  devel/sage-main/sage/plot/plot.py # 2 doctests failed
	sage -t  devel/sage-main/sage/plot/plot3d/plot_field3d.py # 1 doctests failed
```

 The ones in colors.py are all of the form

```
    sage: get_cmap('jet')
Expected:
    <matplotlib.colors.LinearSegmentedColormap instance at 0x...>
Got:
    <matplotlib.colors.LinearSegmentedColormap object at 0x11103e8d0>
```

 and the ones in graphics.py are similar. These are easy to fix, of course. Other failures:

```
File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.4.rc4-IPYTHON/devel/sage-main/sage/plot/plot.py", line 1176:
    sage: len((q1).matplotlib().axes[0].legend().texts) # used to raise AttributeError
Expected:
    1
Got:
    2
**********************************************************************
File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/sage-5.4.rc4-IPYTHON/devel/sage-main/sage/plot/plot.py", line 1186:
    sage: len(p1.matplotlib().axes[0].legend().texts)
Expected:
    1
Got:
    3
```

 Why is this failing now? Was there a change in the format of the legend? The error in plot_field3d.py is `ValueError: Colormap red is not recognized`. I don't know what to do about this one. I haven't run full doctests, just on the plot directory. I'll let you know if I find anything else.


---

Comment by jason created at 2012-11-10 22:50:21

Changing status from needs_review to needs_work.


---

Comment by jason created at 2012-11-10 22:50:21

Wow, sorry, that was really sloppy on my part.  This is definitely needs work right now.


---

Comment by jason created at 2012-11-10 22:53:42

Those printing issues are weird.  I wonder if that's from the upgrade to IPython 0.13.1?


---

Comment by jason created at 2012-11-10 22:57:37

I've uploaded a new spkg that should fix the two issues with the spkg.


---

Comment by jhpalmieri created at 2012-11-11 02:02:55

I think I get the printing issues with both the old and the new IPython. See /scratch/palmieri/sage-5.4.rc4-13693/ on sage.math for a build with a stock 5.4.rc4 plus this spkg.


---

Comment by ddrake created at 2013-03-02 23:30:13

I hope we can get this into Sage -- version 1.2 has [support for PGF/TikZ output](http://matplotlib.org/users/whats_new.html#pgf-tikz-backend) which opens up some pretty amazing opportunities with SageTeX. (Not that I will have time to implement that in the near future, but getting this upgrade in is a necessary first step.)


---

Comment by kcrisman created at 2013-03-03 01:01:33

See also [streamplots](http://matplotlib.org/users/whats_new.html#streamplot) - for #10775.


---

Comment by fbissey created at 2013-03-03 02:25:01

Definitely would be nice. I had seen the  failures before in sage-on-gentoo before forcing 1.1.0. I will see if I can dedicate some time to it this week.


---

Comment by jhpalmieri created at 2013-03-05 20:07:05

Regarding the failures: I can easily fix all of them except the ones in plot.py:

```
        sage: q1 = plot([sin(x), tan(x)], legend_label='trig')
        sage: len(q1.matplotlib().axes[0].legend().texts) # used to raise AttributeError
        1

    ::

    Make sure that we don't get multiple legend labels for plot segments
    (:trac:`11998`)::

        sage: p1 = plot(1/(x^2-1),(x,-2,2),legend_label="foo",detect_poles=True)
        sage: len(p1.matplotlib().axes[0].legend().texts)
        1
```

For the first one (`q1`), with the new spkg there are two legend labels ("trig" and "None"), where there used to be just one. For `p1`, there are now three labels, in direct contradiction of the text. It looks like the picture at #11998, except the labels are "None", "None", and "foo". I don't know how to fix these. See my patch for the other fixes.


---

Comment by jpflori created at 2013-03-28 20:47:13

I was just doing the same thing this evening to try random Cygwin stuff.

I guess we should look for 1.2.1.


---

Comment by jpflori created at 2013-03-28 21:37:36

Updated spkg at:
http://boxen.math.washington.edu/home/jpflori/matplotlib-1.2.1.spkg


---

Comment by jpflori created at 2013-03-28 21:48:30

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-03-28 21:48:30

Not sure if it's the update wihch changed something but I have no failures in plot.py on my 5.9.beta1 install.

I'm putting this back to needs_review though I could not run "make ptestlong" yet cause the install I have access to is kind of borken because of ATLAS black magic.


---

Comment by jhpalmieri created at 2013-03-28 23:07:00

Replying to [comment:16 jpflori]:
> Not sure if it's the update wihch changed something but I have no failures in plot.py on my 5.9.beta1 install.

Same for me, too. I'll try `make ptestlong` on a few machines to see what happens.


---

Comment by jason created at 2013-03-28 23:13:43

Has anyone manually checked the images connected to the failing doctests from before, just to make sure we're not missing a problem?


---

Comment by jpflori created at 2013-03-28 23:18:37

I had a look at the q1 one to spot the problem but it looked fine (blue sine and other curve, axes, little box with a blue segment and trig, no None anywhere) and was confused and then indeed there was no failing doctest.


---

Comment by jhpalmieri created at 2013-03-29 03:40:34

I also looked at the examples by hand, and they looked fine (as opposed to with the 1.2.0 spkg). `make ptestlong` passed on two platforms: boxen.math.washington.edu and an OS X 10.8.3 machine.

So I'm happy with the spkg. If people are happy with my patch, can we give this a positive review?


---

Comment by fbissey created at 2013-04-05 09:22:59

I think the patch is all fine. I had to check if it was the intended behavior for plot_field3d.py (monochrome 3d field, I guess it can be useful sometimes).


---

Comment by fbissey created at 2013-04-05 09:31:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-05 09:39:12

I'm assuming the patch should be applied...


---

Comment by fbissey created at 2013-04-05 09:44:19

Yes I should have done the clean up of the description.


---

Comment by jdemeyer created at 2013-04-08 07:13:17

This is very wrong and should be fixed:

```
        assert(cm is not None) 
    except (TypeError, AssertionError, ValueError): 
```

`AssertionError` should _never_ be handled in an exception block, unless you have very good reasons to do so. The obvious solution is replacing `assert()` by something else.

I know this problem isn't caused by this patch, but since it is easy to fix, you should fix it.


---

Comment by jdemeyer created at 2013-04-08 07:14:44

For example, you could do:

```
try:
    cm = get_cmap(colors)
except (TypeError, ValueError):
    cm = None
if cm is None:
    ...
```



---

Comment by jdemeyer created at 2013-04-08 12:33:09

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2013-04-08 19:00:57

Okay, here's a new version of the patch. The only change is this:

```diff
diff --git a/sage/plot/plot3d/plot_field3d.py b/sage/plot/plot3d/plot_field3d.py
--- a/sage/plot/plot3d/plot_field3d.py
+++ b/sage/plot/plot3d/plot_field3d.py
`@``@` -72,8 +72,9 `@``@`
     try:
         from matplotlib.cm import get_cmap
         cm = get_cmap(colors)
-        assert(cm is not None)
-    except (TypeError, AssertionError, ValueError):
+    except (TypeError, ValueError):
+        cm = None
+    if cm is None:
         if isinstance(colors, (list, tuple)):
             from matplotlib.colors import LinearSegmentedColormap
             cm = LinearSegmentedColormap.from_list('mymap',colors)
```



---

Comment by jhpalmieri created at 2013-04-08 19:00:57

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-04-08 19:01:13

fixes for failures except for plot.py


---

Attachment

I'm going to restore the positive review, also; you can view my change as a positive review of Jeroen's suggestion...


---

Comment by jhpalmieri created at 2013-04-08 19:02:10

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-13 13:49:04

Resolution: fixed


---

Comment by nthiery created at 2013-05-06 16:28:05

As a followup: the new version of matplotlib seems to be causing an issue with saving graphs in pdf. See:

https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/6l9Z4y5rCuM
