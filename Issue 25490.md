# Issue 25490: Prevent giac from giving localized output

archive/issues_025490.json:
```json
{
    "body": "CC:  jdemeyer chapoton tmonteil slelievre vdelecroix\n\nRunning the tests in a system with Spanish locale gives some failures, such as\n\n```\nFile \"src/sage/calculus/calculus.py\", line 1506, in sage.calculus.calculus.laplace\nFailed example:\n    laplace(t^n, t, s, algorithm='giac')\nExpected:\n    laplace(t^n, t, s)\nGot:\n    integrar(t^n*e^(-s*t), t, 0, +Infinity)\n```\n\n\nThis is caused by giac returning localized output depending on the system locale.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25727\n\n",
    "created_at": "2018-07-01T10:59:38Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "Prevent giac from giving localized output",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25490",
    "user": "arojas"
}
```
CC:  jdemeyer chapoton tmonteil slelievre vdelecroix

Running the tests in a system with Spanish locale gives some failures, such as

```
File "src/sage/calculus/calculus.py", line 1506, in sage.calculus.calculus.laplace
Failed example:
    laplace(t^n, t, s, algorithm='giac')
Expected:
    laplace(t^n, t, s)
Got:
    integrar(t^n*e^(-s*t), t, 0, +Infinity)
```


This is caused by giac returning localized output depending on the system locale.

Issue created by migration from https://trac.sagemath.org/ticket/25727





---

archive/issue_comments_359585.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-01T11:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359585",
    "user": "arojas"
}
```

New commits:



---

archive/issue_comments_359586.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-01T11:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359586",
    "user": "arojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_359587.json:
```json
{
    "body": "The fix makes sense, but wouldn't it be better to add to *all* interfaces? Say in `src/sage/interfaces/expect.py` around line 480.",
    "created_at": "2018-07-01T14:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359587",
    "user": "jdemeyer"
}
```

The fix makes sense, but wouldn't it be better to add to *all* interfaces? Say in `src/sage/interfaces/expect.py` around line 480.



---

archive/issue_comments_359588.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-01T19:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359588",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_359589.json:
```json
{
    "body": "Anything else needed here? There are still a few spurious doctest failures on systems with Spanish locale in 8.4, would be good to get this in.",
    "created_at": "2018-10-20T18:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359589",
    "user": "arojas"
}
```

Anything else needed here? There are still a few spurious doctest failures on systems with Spanish locale in 8.4, would be good to get this in.



---

archive/issue_comments_359590.json:
```json
{
    "body": "This became a much bigger problem now that #27958 is in and some integrals are computed using giac. For instance, this doesn't work in 8.9.beta4 with LANG=es_ES:\n\n\n```\nsage: integrate(exp(-x^2)*log(x), x)\nintegrar(e^(-x^2)*log(x), x)\n```\n\n\nas opposed to the expected\n\n\n```\n1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)\n```\n",
    "created_at": "2019-07-31T06:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359590",
    "user": "arojas"
}
```

This became a much bigger problem now that #27958 is in and some integrals are computed using giac. For instance, this doesn't work in 8.9.beta4 with LANG=es_ES:


```
sage: integrate(exp(-x^2)*log(x), x)
integrar(e^(-x^2)*log(x), x)
```


as opposed to the expected


```
1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
```




---

archive/issue_comments_359591.json:
```json
{
    "body": "This seems to be the right fix in the case of giac, because giac apparently reads the `LANG` environment variable directly to choose the names used in its output instead of calling `setlocale()`. However, with other interfaces, setting `LANG=C` may not be enough (I expect), because the user may have set `LC_MESSAGES`, which takes priority over `LANG`. So I think you probably should set `LC_ALL` (or maybe just `LC_MESSAGES` and `LC_NUMERIC`?) in addition to `LANG`.",
    "created_at": "2019-08-21T08:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359591",
    "user": "mmezzarobba"
}
```

This seems to be the right fix in the case of giac, because giac apparently reads the `LANG` environment variable directly to choose the names used in its output instead of calling `setlocale()`. However, with other interfaces, setting `LANG=C` may not be enough (I expect), because the user may have set `LC_MESSAGES`, which takes priority over `LANG`. So I think you probably should set `LC_ALL` (or maybe just `LC_MESSAGES` and `LC_NUMERIC`?) in addition to `LANG`.



---

archive/issue_comments_359592.json:
```json
{
    "body": "Replying to [comment:7 mmezzarobba]:\n> This seems to be the right fix in the case of giac, because giac apparently reads the `LANG` environment variable directly to choose the names used in its output instead of calling `setlocale()`. However, with other interfaces, setting `LANG=C` may not be enough (I expect), because the user may have set `LC_MESSAGES`, which takes priority over `LANG`. So I think you probably should set `LC_ALL` (or maybe just `LC_MESSAGES` and `LC_NUMERIC`?) in addition to `LANG`.\n\nAre you aware of any other interface affected by this? This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES. I'd rather not risk running into potential unexpected side effects of modifying additional env variables.",
    "created_at": "2019-08-25T09:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359592",
    "user": "arojas"
}
```

Replying to [comment:7 mmezzarobba]:
> This seems to be the right fix in the case of giac, because giac apparently reads the `LANG` environment variable directly to choose the names used in its output instead of calling `setlocale()`. However, with other interfaces, setting `LANG=C` may not be enough (I expect), because the user may have set `LC_MESSAGES`, which takes priority over `LANG`. So I think you probably should set `LC_ALL` (or maybe just `LC_MESSAGES` and `LC_NUMERIC`?) in addition to `LANG`.

Are you aware of any other interface affected by this? This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES. I'd rather not risk running into potential unexpected side effects of modifying additional env variables.



---

archive/issue_comments_359593.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2019-08-25T09:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359593",
    "user": "arojas"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_359594.json:
```json
{
    "body": "setting as blocker as per comment:6",
    "created_at": "2019-08-25T09:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359594",
    "user": "arojas"
}
```

setting as blocker as per comment:6



---

archive/issue_comments_359595.json:
```json
{
    "body": "Replying to [comment:8 arojas]:\n> Are you aware of any other interface affected by this?\n\nNo.\n\n> This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES.\n\nBut then your original version that only applied to the giac interface makes more sense to me.",
    "created_at": "2019-08-25T09:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359595",
    "user": "mmezzarobba"
}
```

Replying to [comment:8 arojas]:
> Are you aware of any other interface affected by this?

No.

> This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES.

But then your original version that only applied to the giac interface makes more sense to me.



---

archive/issue_comments_359596.json:
```json
{
    "body": "Replying to [comment:10 mmezzarobba]:\n> > This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES.\n> \n> But then your original version that only applied to the giac interface makes more sense to me.\n\nYes, you have a point there. jdemeyer: should I revert back to the original commit or extend it to LC_ALL?",
    "created_at": "2019-08-25T09:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359596",
    "user": "arojas"
}
```

Replying to [comment:10 mmezzarobba]:
> > This branch is meant to fix a very concrete issue with giac, perhaps it can be extended in the future if some other interfaces are found to misbehave with non-English LC_MESSAGES.
> 
> But then your original version that only applied to the giac interface makes more sense to me.

Yes, you have a point there. jdemeyer: should I revert back to the original commit or extend it to LC_ALL?



---

archive/issue_comments_359597.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-27T07:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359597",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_359598.json:
```json
{
    "body": "Replying to [comment:11 arojas]:\n> Yes, you have a point there. jdemeyer: should I revert back to the original commit or extend it to LC_ALL?\n\nSince Jeroen seems to be busy with other things, I took the liberty of reverting the branch to the version dealing only with giac and giving the ticket positive review. Please feel free to undo that if you disagree!",
    "created_at": "2019-08-27T07:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359598",
    "user": "mmezzarobba"
}
```

Replying to [comment:11 arojas]:
> Yes, you have a point there. jdemeyer: should I revert back to the original commit or extend it to LC_ALL?

Since Jeroen seems to be busy with other things, I took the liberty of reverting the branch to the version dealing only with giac and giving the ticket positive review. Please feel free to undo that if you disagree!



---

archive/issue_comments_359599.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-28T19:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25490#issuecomment-359599",
    "user": "vbraun"
}
```

Resolution: fixed
