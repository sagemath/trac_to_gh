# Issue 32295: remove gcc and gfortran spkgs

Issue created by migration from https://trac.sagemath.org/ticket/32532

Original creator: dimpase

Original creation time: 2021-09-18 14:12:42

CC:  mkoeppe vbraun mjo jhpalmieri

This is a followup to #32060. Building gcc from source is very hard, and unnecessary for any platform Sage supports now. 

Same applies to gfortran, with macOS being an exception - there is no (g)fortran coming from the system.

So we need such an easy to install replacement (as opposed to ones provided by Conda, Homebrew, MacPorts, etc. which come as a part of a complete distro).

There are standalone distributions of gfortran for macOS, by the gfortran maintainer of the Homebrew package. To me this offers a way to entirety remove gcc and gfortran spkgs from Sage.

​https://github.com/fxcoudert/gfortran-for-macOS

other Fortran possibilities are various closed source offers, e.g. from Intel and NAG,
as well as open-source flang, etc.


---

Comment by dimpase created at 2021-09-18 14:14:31

Dima's original ticket description:

This is a followup to #32060. Building gcc from source is very hard, and unnecessary for any platform Sage supports now. 

Same applies to gfortran, with macOS being an exception - there is no (g)fortran coming from the system.

So we need such an easy to install replacement, e.g. one provided by Conda, Homebrew, MacPorts, etc.

Should the need arise for something more isolated, (hopefully not), there are experimental standalone distributions of gfortran for macOS, by the gfortran maintainer of the Homebrew package. This offers a way to entirety remove gcc and gfortran spkgs from Sage. 

​https://github.com/fxcoudert/gfortran-for-macOS - specifically, 
https://github.com/fxcoudert/gfortran-for-macOS/releases/tag/11.2-bigsur-intel
provides a signed and notarized installed of gcc 11.1 to `/usr/local` (I tested it, it works)

Other Fortran possibilities are various closed source offers, e.g. from Intel and NAG,
as well as open-source flang, etc.


---

Comment by mkoeppe created at 2021-09-18 16:14:14

There are no build problems with gfortran - #32060#comment:36


---

Comment by dimpase created at 2021-09-18 22:50:21

yet, building gfortran is useless waste of resources - it takes a lot of time, etc.


---

Comment by mkoeppe created at 2021-09-18 23:12:26

Removing it puts a fresh obstacle in the way of pip-installability -- no, thanks.


---

Comment by jhpalmieri created at 2021-09-19 00:24:46

Since removing gfortran is controversial, please drop the idea or discuss on sage-devel. It should not be settled here.


---

Comment by dimpase created at 2021-09-19 04:42:39

Replying to [comment:6 mkoeppe]:
> Removing it puts a fresh obstacle in the way of pip-installability -- no, thanks.
> 
how come removing gcc spkg does not create such an obstacle, whereas it does for gfortran?

Besides, if you need to build gcc in order to build gfortran, the latter cannot be counted as unproblematic.


---

Comment by dimpase created at 2021-09-19 16:29:12

still needs adding some Fortran to CI for the minimal macOS configuration.
----
Last 10 new commits:


---

Comment by dimpase created at 2021-09-19 16:30:23

also, CI tests for obsolete gcc-4 based distros are gone, about time.


---

Comment by mkoeppe created at 2021-09-19 16:43:50

Replying to [comment:8 dimpase]:
> how come removing gcc spkg does not create such an obstacle, whereas it does for gfortran?

Python dev environments have a gcc. If they don't, we can't help them anyway.

Python dev environments don't have gfortran. gfortran is not pip-installable. The few Python packages that use gfortran have high-quality deployments of wheels to PyPI, which are widely used. 

Sage does not (yet?) have a working strategy that would enable us to use wheels from PyPI. The first step to pip-installability in #29039 builds everything from source.

> Besides, if you need to build gcc in order to build gfortran, the latter cannot be counted as unproblematic.

Come again? No, we don't do that on any platform.


---

Comment by dimpase created at 2021-09-19 17:08:14

Replying to [comment:11 mkoeppe]:
> Replying to [comment:8 dimpase]:
> > how come removing gcc spkg does not create such an obstacle, whereas it does for gfortran?
> 
> Python dev environments have a gcc. If they don't, we can't help them anyway.
> 
> Python dev environments don't have gfortran. gfortran is not pip-installable. 

gcc is not pip-installable, either. The only scenario where developers have no Fortran, but "gcc" (for some value of "gcc", e.g. Apple clang) is on macOS, as far as I know.
On macOS they'd have to help themselves by installing (g, or some other)fortran in some way.

Needless to say, we should test that this is feasible without using !Homebrew/Conda/macports,
say with the gfortran installer linked in the ticket description.


> The few Python packages that use gfortran have high-quality deployments of wheels to PyPI, which are widely used. 
> 
> Sage does not (yet?) have a working strategy that would enable us to use wheels from PyPI. The first step to pip-installability in #29039 builds everything from source.

OK, and this setting will need a Fortran compiler in addition to a C/C++ compiler.
Why is it an extra obstacle? It's an improvement, as it makes building a lot quicker.

> 
> > Besides, if you need to build gcc in order to build gfortran, the latter cannot be counted as unproblematic.
> 
> Come again? No, we don't do that on any platform.
on gcc-4-based platforms we build gcc+gfortran, no?
(well, I am not worried about this obsolete case)


---

Comment by mkoeppe created at 2021-09-19 17:12:49

Replying to [comment:12 dimpase]:
> Replying to [comment:11 mkoeppe]:
> > Replying to [comment:8 dimpase]:
> > > how come removing gcc spkg does not create such an obstacle, whereas it does for gfortran?
> > 
> > Python dev environments have a gcc. If they don't, we can't help them anyway.
> > 
> > Python dev environments don't have gfortran. gfortran is not pip-installable. 
> 
> gcc is not pip-installable, either. 

Please... I just explained it. 

"Python dev environments have a gcc". Why? Because lots of Python packages need a working C/C++ compiler.

I explained why the gfortran situation is different.


---

Comment by dimpase created at 2021-09-19 17:26:22

Replying to [comment:13 mkoeppe]:
> Replying to [comment:12 dimpase]:
> > Replying to [comment:11 mkoeppe]:
> > > Replying to [comment:8 dimpase]:
> > > > how come removing gcc spkg does not create such an obstacle, whereas it does for gfortran?
> > > 
> > > Python dev environments have a gcc. If they don't, we can't help them anyway.
> > > 
> > > Python dev environments don't have gfortran. gfortran is not pip-installable. 
> > 
> > gcc is not pip-installable, either. 
> 
> Please... I just explained it. 
> 
> "Python dev environments have a gcc". Why? Because lots of Python packages need a working C/C++ compiler.
> 
> I explained why the gfortran situation is different.

It's not different, as Fortran compilers are easy to come by these days.

The philosophy of this ticket is that we should cut our losses we had while trying to vendor everything imaginable, spending human resources on thankless tasks such as vendoring gcc/gfortran,
something that 99.9% of Sage users don't care about.


---

Comment by mkoeppe created at 2021-09-19 17:30:11

-1 on creating new real problems in order to fix imaginary problems.


---

Comment by dimpase created at 2021-09-19 17:38:03

Replying to [comment:15 mkoeppe]:
> -1 on creating new real problems in order to fix imaginary problems.

No Python project I know vendors compilers. Lack  of developer time is very real problem, and you keep perpetuating this problem
by refusing to shed the ballast.


---

Comment by dimpase created at 2021-09-23 09:55:45

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-09-23 09:55:45

I did a run on [GitHub](GitHub) Actions: https://github.com/dimpase/sagetrac-mirror/actions/runs/1258945033
(our macOS actions are broken, so no surprise it's not working there)


---

Comment by mkoeppe created at 2021-09-23 13:24:43

Let's please drop this.


---

Comment by dimpase created at 2021-09-23 13:28:00

you have not explained why it should be dropped, and what kind of difficulty it'd present if it were merged.


---

Comment by jhpalmieri created at 2021-09-23 16:54:27

Changing status from needs_review to needs_info.


---

Comment by jhpalmieri created at 2021-09-23 16:54:27

Take the discussion to sage-devel.


---

Comment by @dimpase created at 2022-09-19 20:54:47

given that M1 cannot use Sage's gcc/gfortran, perhaps it's high time to move here?


---

Comment by mkoeppe created at 2022-09-19 21:00:50

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2022-09-19 21:00:50

Time for "wontfix"


---

Comment by dimpase created at 2022-09-20 06:10:53

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2022-09-20 06:10:53

Huh? If we support platforms on which a package doesn't work, it can't be standard,or even optional.

either go forward with this ticket and remove it,or make it experimental.


---

Comment by jhpalmieri created at 2022-09-21 17:44:42

#33816 allows the `gfortran` package to build on M1/M2.


---

Comment by jhpalmieri created at 2022-09-21 17:46:04

As far as OS X is concerned, we could drop the `gcc` package. I don't know if that would create issues on other platforms, but we could ask on `sage-devel`.


---

Comment by mkoeppe created at 2022-09-21 18:13:04

I think it makes sense to downgrade the `gcc` package to "experimental", which would reflect the fact that we no longer test `gcc_spkg` configurations on our CI.


---

Comment by jhpalmieri created at 2022-09-21 18:31:41

For what it's worth, it took about 10 minutes for `gfortran` to build on two different machines, one m2 (9 minutes), one Intel (11 minutes). So it's long but faster than `sagelib` and not much slower than `scipy`. It's much faster than building Sage's `gcc` used to be, if I remember correctly.


---

Comment by dimpase created at 2022-09-23 13:42:41

Replying to [comment:30 Matthias Köppe]:
> I think it makes sense to downgrade the `gcc` package to "experimental", which would reflect the fact that we no longer test `gcc_spkg` configurations on our CI.

downgrading to experimental means inevitable bitrot - happening already, right? If noone uses it in practice, I see no point in keeping it, however quick it can be built.


---

Comment by jhpalmieri created at 2022-09-23 18:54:06

Replying to [comment:32 Dima Pasechnik]:
> Replying to [comment:30 Matthias Köppe]:
> > I think it makes sense to downgrade the `gcc` package to "experimental", which would reflect the fact that we no longer test `gcc_spkg` configurations on our CI.
> 
> downgrading to experimental means inevitable bitrot - happening already, right? If noone uses it in practice, I see no point in keeping it, however quick it can be built.

Our experimental packages are a mess in general, so our `gcc` package would fit right in, the more bitrot the better. I also don't object to removing it altogether — I don't really care one way or the other. But I think we should keep `gfortran` since it builds on a range of platforms and serves a purpose, at least on OS X.


---

Comment by dimpase created at 2022-09-24 10:30:56

removing gcc package, while retaining gfortran package, would be a step in right direction. Would we like to proceed with this? 

It'd certainly simplify the convoluted build logic of potentially having two C compilers around, and lead to less reports of build failures.


---

Comment by dimpase created at 2022-10-09 08:38:06

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2022-10-09 08:38:06

New commits:


---

Comment by mkoeppe created at 2022-10-09 16:36:50

Replying to [comment:30 Matthias Köppe]:
> I think it makes sense to downgrade the `gcc` package to "experimental"

I withdraw this suggestion. Since gcc is a prerequisite of standard packages, it cannot be anything but standard. Likewise for gfortran.


---

Comment by mkoeppe created at 2022-10-09 16:37:17

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2022-10-09 16:51:43

The question is whether it should be viewed as a prerequisite, something that Sage should not at all be responsible for installing. `gfortran` is not directly available on OS X, so I can see why we would keep that, but `gcc` is not so clear. I am not up to date on linux distributions; are there distributions that we support that do not provide a sufficiently current `gcc`?


---

Comment by jhpalmieri created at 2022-10-09 16:53:03

Also, I think our `gcc` package currently fails to build to M1/M2. Is the work involved to fix it worth the effort?


---

Comment by mkoeppe created at 2022-10-09 17:12:22

Replying to [comment:42 John Palmieri]:
> I am not up to date on linux distributions; are there distributions that we support that do not provide a sufficiently current `gcc`? 

I think by definition we only support distributions that provide a suitable gcc.

But keeping `gcc` costs us nothing, given that its build script is shared with `gfortran` and we promise nothing about it other than providing it as a last resort for users as described https://trac.sagemath.org/wiki/ReleaseTours/sage-9.8#SupportforGCC8droppedC17featuresnowavailable.


---

Comment by mkoeppe created at 2022-10-09 17:13:34

Replying to [comment:43 John Palmieri]:
> I think our `gcc` package currently fails to build to M1/M2. Is the work involved to fix it worth the effort?

I don't know a use case for `gcc` on macOS, so I don't plan to work on it.


---

Comment by dimpase created at 2022-10-09 21:39:46

As we don't have gcc working on macOS, it cannot be a standard package. Therefore the only logical step is to remove it (convert to a script package, maybe, or not even this).


---

Comment by dimpase created at 2022-10-10 11:51:32

Replying to [comment:40 Matthias Köppe]:
> Replying to [comment:30 Matthias Köppe]:
> > I think it makes sense to downgrade the `gcc` package to "experimental"
> 
> I withdraw this suggestion. Since gcc is a prerequisite of standard packages, it cannot be anything but standard. 

I went to check, and there is no `gcc` in `build/pkgs/*/dependencies`. Thus I don't understand this remark.
(It does pop up in the (dreadful) `*toochain*` targets in `build/make/Makefile.in`, but this is it) 


> Likewise for gfortran.

OK, we can keep `gfortran` standard for the time being.


---

Comment by mkoeppe created at 2022-10-10 22:05:09

Replying to [comment:47 Dima Pasechnik]:
> Since gcc is a prerequisite of standard packages, it cannot be anything but standard. 
> 
> I went to check, and there is no `gcc` in `build/pkgs/*/dependencies`. Thus I don't understand this remark.
> (It does pop up in the (dreadful) `*toochain*` targets in `build/make/Makefile.in`, but this is it) 

Ah, this is a common confusion. `gcc` is a standard package - in this case the word is *spelled* "standard" but it's pronounced "base". I think this complicated situation is due to the 1918 spelling reform.


---

Comment by dimpase created at 2022-10-11 08:03:18

The only purpose served by our `gcc` package since quite a while is to complicate the build system, and occasionally trip up people who end up trying and failing to build it.

While you might have a sentimental attachment to it, there is no point in having it in the system.
Let us remove it. It is useless on macOS, and on Linux there is an abundant supply of options to have a modern enough gcc one way or another.


---

Comment by dimpase created at 2022-11-17 09:27:59

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-11-17 09:32:51

the branch still does not do what's advertised in Summary, but I'd like to hear a go ahead first.


---

Comment by mkoeppe created at 2022-11-17 17:22:39

-1
