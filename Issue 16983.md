# Issue 16983: Minimal bindings for acb_mat in the optional arb package

Issue created by migration from https://trac.sagemath.org/ticket/17220

Original creator: cheuberg

Original creation time: 2014-10-25 14:54:16

CC:  alina fredrik.johansson ktkohl skropf jdemeyer mmezzarobba

Keywords: arb, acb_mat, complex intervals, matrix

As a follow-up to #17194 and #17218, where the `arb` and `acb` types of the Arb library have been wrapped, this wraps the `acb_mat` type for matrices over complex balls.


---

Comment by cheuberg created at 2014-10-25 14:58:06

Last 10 new commits:


---

Comment by cheuberg created at 2014-10-25 14:58:06

Changing status from new to needs_review.


---

Comment by cheuberg created at 2015-02-06 09:33:38

The modifications made in #17194 will have to be made here, too, once #17194 is in final form.


---

Comment by cheuberg created at 2015-02-06 09:33:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-20 18:28:52

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-02-24 18:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-28 08:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-02-28 08:16:07

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-02-28 08:16:07

Changing keywords from "arb, acb_mat, complex intervals, matrix" to "arb, acb_mat, complex balls, matrix".


---

Comment by git created at 2015-03-01 12:00:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-17 06:28:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-24 17:50:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-25 09:00:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-11 10:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-11 10:16:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-30 10:04:12

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by cheuberg created at 2015-10-30 10:14:51

Changing status from needs_review to needs_info.


---

Comment by cheuberg created at 2015-10-30 10:14:51

I merged #18546 and #19063 as these tickets have been closed.

There is the following problem: #19063 uses the `experimental` decorator on `ComplexBallField.__init__`. On the other hand, `CBF` is defined in that module, which calls the constructor of `ComplexBallField`.

Here, in `matrix.py` I need to import `ComplexBallField` in order to check whether the ring is a complex ball field. This immediately triggers the `experimental` warning even if no `ComplexBallField` is constructed explicitly, because `CBF` is constructed.

I see four options:
1. remove the `experimental` warning in `ComplexBallField` now.
2. remove the `experimental` warning in `ComplexBallField` once #19152 is merged
3. move `CBF = ComplexBallField()` to a separate module, e.g. `sage.rings.complex_ball_acb_default` and replace all lines `from sage.rings.complex_ball_acb import CBF` by `from sage.rings.complex_ball_acb_default import CBF` and undo this change once the `experimental` warning disappears
4. fix doctests in 252 other modules whenever a matrix is constructed which falls back to the generic implementation.

Suggestions?


---

Comment by mmezzarobba created at 2015-10-30 12:35:12

Replying to [comment:15 cheuberg]:
> 1. remove the `experimental` warning in `ComplexBallField` now.
> 2. remove the `experimental` warning in `ComplexBallField` once #19152 is merged
> 3. move `CBF = ComplexBallField()` to a separate module, e.g. `sage.rings.complex_ball_acb_default` and replace all lines `from sage.rings.complex_ball_acb import CBF` by `from sage.rings.complex_ball_acb_default import CBF` and undo this change once the `experimental` warning disappears
> 4. fix doctests in 252 other modules whenever a matrix is constructed which falls back to the generic implementation.

My preference goes to option 2.


---

Comment by cheuberg created at 2015-10-30 13:23:09

Replying to [comment:16 mmezzarobba]:
> My preference goes to option 2.

ok. I'll try to review #19152 soon.


---

Comment by cheuberg created at 2015-10-30 13:23:09

Changing status from needs_info to needs_work.


---

Comment by mmezzarobba created at 2015-11-27 08:38:33

I can try to do something for this ticket next week—assuming #19152 is merged by then—, but I may not be able to review it by myself as I know little about Sage matrices.


---

Comment by git created at 2015-11-27 11:51:16

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by cheuberg created at 2015-11-27 11:53:31

trac's automerge fails for unknown reasons; merges cleanly with develop.


---

Comment by cheuberg created at 2015-11-27 11:53:31

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-11-28 04:49:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-28 05:11:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-11-29 09:50:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-11-29 11:05:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-11-29 11:05:05

Move `arb` types to `sage/libs/arb/types.pxd`


---

Comment by jdemeyer created at 2015-11-29 11:08:38

In `src/sage/matrix/matrix_complex_ball_dense.pxd`, replace

```
from sage.libs.arb.acb_mat cimport acb_mat_t
```

by

```
from sage.libs.arb.types cimport acb_mat_t
```



---

Comment by git created at 2015-11-29 11:29:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-11-29 11:31:30

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-11-29 11:31:30

Replying to [comment:24 jdemeyer]:
> Move `arb` types to `sage/libs/arb/types.pxd`
done.
Replying to [comment:25 jdemeyer]:
> In `src/sage/matrix/matrix_complex_ball_dense.pxd`, replace
> {{{
> from sage.libs.arb.acb_mat cimport acb_mat_t
> }}}
> by
> {{{
> from sage.libs.arb.types cimport acb_mat_t
> }}}
done.


---

Comment by mmezzarobba created at 2015-12-03 16:47:36

Hello,

So I had a look and added a few reviewer patches with minor changes. Two questions:
- are the functions `matrix_to_acb_mat` & co really useful?
- your `__init__` deviates a little bit from the logic in `Matrix_generic_dense.__init__`, so that for example the following no longer works, is that intentional?

```
sage: Pol.<x> = QQ[]
sage: pol = 1 + x + x^2
sage: Mat = MatrixSpace(CBF, 3, 1)
sage: Mat(pol)
[1.000000000000000]
[1.000000000000000]
[1.000000000000000]
```

----
New commits:


---

Comment by mmezzarobba created at 2015-12-03 16:49:15

Changing status from needs_review to needs_info.


---

Comment by cheuberg created at 2015-12-05 07:28:57

Hello,

Replying to [comment:28 mmezzarobba]:
> So I had a look and added a few reviewer patches with minor changes.

Thank you. I added one more minor commit on top of it (changing the title in the documentation for consistency with `real_arb` and `complex_arb`.

> Two questions:
> - are the functions `matrix_to_acb_mat` & co really useful?

I use them in #17222: there, the time critical part does not use the full coercion model, but just a C array of `acb_mat_t`. Thus it is convenient there to be able to convert a matrix of `CIF`s to an `acb_mat_t` directly instead of having it converted by a call to `matrix(CBF, ...)` and then copying the resulting `acb_mat_t`. The same in the converse direction.

I see three options:
- keeping it the way it is now
- removing these functions here and doing (minimal) overhead in #17222 when initializing the computations there by calling `matrix(CBF, ...)`
- rewriting #17222 to use complex balls instead of complex intervals throughout (that was not an option in October 2014 when I wrote that code, because complex balls were not yet really implemented).

> - your `__init__` deviates a little bit from the logic in `Matrix_generic_dense.__init__`, so that for example the following no longer works, is that intentional?
> {{{
> sage: Pol.<x> = QQ[]
> sage: pol = 1 + x + x^2
> sage: Mat = MatrixSpace(CBF, 3, 1)
> sage: Mat(pol)
> [1.000000000000000]
> [1.000000000000000]
> [1.000000000000000]
> }}}
This is a consequence of following advice on [sage-devel](https://groups.google.com/d/msg/sage-devel/kZX_Rh_V5vE/uSH6-sTpP0wJ). Indeed, 

```
sage: Pol.<x> = ZZ[]
sage: pol = 1 + x + x^2
sage: Mat = MatrixSpace(ZZ, 3, 1)
sage: Mat(pol)
[1.000000000000000]
[1.000000000000000]
[1.000000000000000]
```

does not work, either. BTW, most but not all of the cython oddities you fixed in your commits here have been fixed in the integer matrices in the meantime, however, the `for i from 0 <= i < self._nrows` are still there.
----
New commits:


---

Comment by mmezzarobba created at 2015-12-07 15:55:39

Replying to [comment:31 cheuberg]:
> Thus it is convenient there to be able to convert a matrix of CIFs to an acb_mat_t directly instead of having it converted by a call to matrix(CBF, ...) and then copying the resulting acb_mat_t. 

(It doesn't really matter, but I'm not sure I understand what you are saying: why do you need to copy the `acb_mat_t`?)

> I see three options:
> - keeping it the way it is now
> - removing these functions here and doing (minimal) overhead in #17222 when initializing the computations there by calling `matrix(CBF, ...)`
> - rewriting #17222 to use complex balls instead of complex intervals throughout (that was not an option in October 2014 when I wrote that code, because complex balls were not yet really implemented).

How problematic is the overhead? Anyway, all three options sound reasonable to me. I guess using complex balls everywhere would be best, but it all depends how much work you are willing to invest in #17222. If speed is critical, though, you may want to avoid going through a list representation in `acb_mat_to_matrix` (and create a new matrix over `CIF` to write into using `_set_unsafe` instead).

Also, a 4th option would simply be to move this piece of code to #17222 and decide there.

> > - your `__init__` deviates a little bit from the logic in `Matrix_generic_dense.__init__`, so that for example the following no longer works, is that intentional?
> > {{{
> > sage: Pol.<x> = QQ[]
> > sage: pol = 1 + x + x^2
> > sage: Mat = MatrixSpace(CBF, 3, 1)
> > sage: Mat(pol)
> > [1.000000000000000]
> > [1.000000000000000]
> > [1.000000000000000]
> > }}}
> This is a consequence of following advice on [sage-devel](https://groups.google.com/d/msg/sage-devel/kZX_Rh_V5vE/uSH6-sTpP0wJ). Indeed, 
> {{{
> sage: Pol.<x> = ZZ[]
> sage: pol = 1 + x + x^2
> sage: Mat = MatrixSpace(ZZ, 3, 1)
> sage: Mat(pol)
> [1.000000000000000]
> [1.000000000000000]
> [1.000000000000000]
> }}}
> does not work, either.

I'd say this is a weakness of the implementation over the integers, and it would be better to be compatible with the generic case. What do you think? BTW, changing it also would make it possible to call `Matrix_complex_ball_dense` directly to convert a matrix over `CIF` to one over `CBF`, reducing the overhead you were worrying about a little.

And one more thing I missed on first reading: I don't understand the part that says “`copy` - ignored (since complex balls are immutable)” in the docstring of `__init__`. Based on the code and documentation of `MatrixSpace.matrix()`, it seems to me that this parameter is supposed to control whether the matrix itself—not its entries—is copied.


---

Comment by git created at 2015-12-08 17:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-12-08 17:34:36

Replying to [comment:32 mmezzarobba]:
> Replying to [comment:31 cheuberg]:
> > Thus it is convenient there to be able to convert a matrix of CIFs to an acb_mat_t directly instead of having it converted by a call to matrix(CBF, ...) and then copying the resulting acb_mat_t. 
> 
> (It doesn't really matter, but I'm not sure I understand what you are saying: why do you need to copy the `acb_mat_t`?)

I have a `acb_mat_t[10]`. In order to fill that array, I have to copy from Sage objects.

> 
> > I see three options:
> > - keeping it the way it is now
> > - removing these functions here and doing (minimal) overhead in #17222 when initializing the computations there by calling `matrix(CBF, ...)`
> > - rewriting #17222 to use complex balls instead of complex intervals throughout (that was not an option in October 2014 when I wrote that code, because complex balls were not yet really implemented).
> 
> How problematic is the overhead? Anyway, all three options sound reasonable to me. I guess using complex balls everywhere would be best, but it all depends how much work you are willing to invest in #17222. If speed is critical, though, you may want to avoid going through a list representation in `acb_mat_to_matrix` (and create a new matrix over `CIF` to write into using `_set_unsafe` instead).

The overhead is not problematic, it is only at initialization.
> Also, a 4th option would simply be to move this piece of code to #17222 and decide there.

sounds reasonable. Code is removed here.
 
> > > - your `__init__` deviates a little bit from the logic in `Matrix_generic_dense.__init__`, so that for example the following no longer works, is that intentional?
> > > {{{
> > > sage: Pol.<x> = QQ[]
> > > sage: pol = 1 + x + x^2
> > > sage: Mat = MatrixSpace(CBF, 3, 1)
> > > sage: Mat(pol)
> > > [1.000000000000000]
> > > [1.000000000000000]
> > > [1.000000000000000]
> > > }}}
> > This is a consequence of following advice on [sage-devel](https://groups.google.com/d/msg/sage-devel/kZX_Rh_V5vE/uSH6-sTpP0wJ). Indeed, 
> > {{{
> > sage: Pol.<x> = ZZ[]
> > sage: pol = 1 + x + x^2
> > sage: Mat = MatrixSpace(ZZ, 3, 1)
> > sage: Mat(pol)
> > [1.000000000000000]
> > [1.000000000000000]
> > [1.000000000000000]
> > }}}
> > does not work, either.
> 
> I'd say this is a weakness of the implementation over the integers, and it would be better to be compatible with the generic case. What do you think? BTW, changing it also would make it possible to call `Matrix_complex_ball_dense` directly to convert a matrix over `CIF` to one over `CBF`, reducing the overhead you were worrying about a little.

fixed. Do you want to open a ticket for integer matrices?

> And one more thing I missed on first reading: I don't understand the part that says “`copy` - ignored (since complex balls are immutable)” in the docstring of `__init__`. Based on the code and documentation of `MatrixSpace.matrix()`, it seems to me that this parameter is supposed to control whether the matrix itself—not its entries—is copied.

I do not know how to implement `copy=False`. I do not think that it can be done as in `matrix_generic_dense` because we have a somewhat specialized data structure here. Thus I still ignore `copy`, but tried to rewrite the documentation.


---

Comment by cheuberg created at 2015-12-08 17:34:36

Changing status from needs_info to needs_review.


---

Comment by mmezzarobba created at 2015-12-14 16:44:34

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2015-12-14 16:44:34

The branch merges correctly in spite of the red link, and looks good to me.

Replying to [comment:34 cheuberg]:
> > > > - your `__init__` deviates a little bit from the logic in `Matrix_generic_dense.__init__`, so that for example the following no longer works, is that intentional?
[...]
> fixed. Do you want to open a ticket for integer matrices?

Thanks. I've opened #19700 for the other cases.

> > And one more thing I missed on first reading: I don't understand the part that says “`copy` - ignored (since complex balls are immutable)” in the docstring of `__init__`. Based on the code and documentation of `MatrixSpace.matrix()`, it seems to me that this parameter is supposed to control whether the matrix itself—not its entries—is copied.
> 
> I do not know how to implement `copy=False`. I do not think that it can be done as in `matrix_generic_dense` because we have a somewhat specialized data structure here. Thus I still ignore `copy`, but tried to rewrite the documentation.

Yes, I agree it is fine to always perform the copy.


---

Comment by mmezzarobba created at 2015-12-20 10:46:16

Changing status from positive_review to needs_info.


---

Comment by mmezzarobba created at 2015-12-20 10:46:16

Hmm, wait, it looks like in some circumstances multiplying matrices over CBF no longer works!


---

Comment by mmezzarobba created at 2015-12-20 11:17:31

Indeed: I don't know how I missed that while reviewing the ticket, but apparently one can in fact not provide a “level-1” implementation only, because neither `Matrix` nor `Matrix_dense` provides a default implementation of `_multiply_classical` (even though `docs.py` claims implementing it is optional)!


---

Comment by mmezzarobba created at 2015-12-20 11:17:31

Changing status from needs_info to needs_work.


---

Comment by mmezzarobba created at 2015-12-20 13:00:18

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2015-12-20 13:00:18

Should be okay with #19751.
----
New commits:


---

Comment by git created at 2016-03-23 20:05:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2016-04-06 08:46:53

Just to clarify, I think this ticket is good to go if someone reviews the small changes I made in the last few commits (and the dependency, which is 10 lines of code).


---

Comment by fredrik.johansson created at 2016-04-07 13:51:56

Nitpick: it is claimed that a matrix can have up to `2^{64}-1` rows or columns, but the limit is technically `2^{63}-1` since a signed integer is used (and in practice, much less, since that much memory couldn't be addressed).

Other than that, it looks ok to me.


---

Comment by fredrik.johansson created at 2016-04-07 13:51:56

Changing status from needs_review to positive_review.


---

Comment by git created at 2016-04-07 14:33:54

Changing status from positive_review to needs_review.


---

Comment by git created at 2016-04-07 14:33:54

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mmezzarobba created at 2016-04-07 14:37:02

Replying to [comment:41 fredrik.johansson]:
> Nitpick: it is claimed that a matrix can have up to `2^{64}-1` rows or columns, but the limit is technically `2^{63}-1` since a signed integer is used (and in practice, much less, since that much memory couldn't be addressed).

Fixed (for a definition of 64-bit machines that goes a little bit beyond current architectures ;-))

> Other than that, it looks ok to me.

Thanks!


---

Comment by mmezzarobba created at 2016-04-07 14:37:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-04-08 22:40:18

Resolution: fixed
