# Issue 27783: configure check for zlib and libzma can leave bogus compiler flags

archive/issues_027783.json:
```json
{
    "body": "CC:  @dimpase @isuruf\n\nThe `AX_CHECK_ZLIB` macro (and by extension the `AX_CHECK_LIBLZMA` macro which is just a copy of it) has an annoyance where if it detects a system zlib, it will *permanently* (i.e. for the remainder of the configure script) set some variables like `CPPFLAGS=-I${ZLIB_HOME}/include`.\n\nSo if this sets `CPPFLAGS=-I$/usr/include` this will be added to all checks for the rest of the configure script, and break some.\n\nThis particularly created bugs when building in a conda build environment as pointed out by Isuru.  \n\nWe could work around this in a number of ways, such as modifying those macros, or even possibly just putting some `AC_PUSH/POP_LANG` around it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28020\n\n",
    "created_at": "2019-06-19T17:07:59Z",
    "labels": [
        "build: configure",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "configure check for zlib and libzma can leave bogus compiler flags",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27783",
    "user": "@embray"
}
```
CC:  @dimpase @isuruf

The `AX_CHECK_ZLIB` macro (and by extension the `AX_CHECK_LIBLZMA` macro which is just a copy of it) has an annoyance where if it detects a system zlib, it will *permanently* (i.e. for the remainder of the configure script) set some variables like `CPPFLAGS=-I${ZLIB_HOME}/include`.

So if this sets `CPPFLAGS=-I$/usr/include` this will be added to all checks for the rest of the configure script, and break some.

This particularly created bugs when building in a conda build environment as pointed out by Isuru.  

We could work around this in a number of ways, such as modifying those macros, or even possibly just putting some `AC_PUSH/POP_LANG` around it.

Issue created by migration from https://trac.sagemath.org/ticket/28020





---

archive/issue_comments_392486.json:
```json
{
    "body": "well, yes, I agree, many of our m4 solutions aren't meant to work in such a setting, and these `AX_` and other net-lifted macros we use aren't often very good pieces of code, either.",
    "created_at": "2019-06-19T17:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392486",
    "user": "@dimpase"
}
```

well, yes, I agree, many of our m4 solutions aren't meant to work in such a setting, and these `AX_` and other net-lifted macros we use aren't often very good pieces of code, either.



---

archive/issue_comments_392487.json:
```json
{
    "body": "Changing keywords from \"\" to \"days101, flags\".",
    "created_at": "2019-06-19T21:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392487",
    "user": "@slel"
}
```

Changing keywords from "" to "days101, flags".



---

archive/issue_comments_392488.json:
```json
{
    "body": "It would be good to understand the underlying issue of conda better. Does it refer to building with conda-supplied compiler, with a custom configuration for include (and library, I guess) paths? (Which, I suppose, can be broken by pre-pending stuff to `CPPFLAGS` and other similar variables).",
    "created_at": "2019-06-20T08:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392488",
    "user": "@dimpase"
}
```

It would be good to understand the underlying issue of conda better. Does it refer to building with conda-supplied compiler, with a custom configuration for include (and library, I guess) paths? (Which, I suppose, can be broken by pre-pending stuff to `CPPFLAGS` and other similar variables).



---

archive/issue_comments_392489.json:
```json
{
    "body": "Conda supplied compiler comes with a sysroot in `$PREFIX/x86_64-conda_cos6-linux-gnu` which contains system headers and libraries from CentOS 6 and the compiler doesn't look in `/usr` unless explicitly told to do so. When `-I/usr/include` is added to `CPPFLAGS`, it brings in headers from the system that the compiler runs on which results in errors.",
    "created_at": "2019-06-20T08:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392489",
    "user": "@isuruf"
}
```

Conda supplied compiler comes with a sysroot in `$PREFIX/x86_64-conda_cos6-linux-gnu` which contains system headers and libraries from CentOS 6 and the compiler doesn't look in `/usr` unless explicitly told to do so. When `-I/usr/include` is added to `CPPFLAGS`, it brings in headers from the system that the compiler runs on which results in errors.



---

archive/issue_comments_392490.json:
```json
{
    "body": "Thanks. What are the steps to reproduce this?\nSay, I have a conda installation, and I want to build Sage under conda.\n\nDo I just do `conda activate` and proceed as if it's a \"normal\" system?",
    "created_at": "2019-06-20T10:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392490",
    "user": "@dimpase"
}
```

Thanks. What are the steps to reproduce this?
Say, I have a conda installation, and I want to build Sage under conda.

Do I just do `conda activate` and proceed as if it's a "normal" system?



---

archive/issue_comments_392491.json:
```json
{
    "body": "To clarify, although I don't know exactly the steps to reproduce it, I was able to sit with Isuru here at Cernay and see for myself that it was happening.\n\nI later modified the configure script directly to try to trace in what places `CFLAGS` and/or `LDFLAGS` were being modified and not restored, and I tracked it down to zlib; and indeed looking at the code you can see that it is doing that in some cases.\n\nWe confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.",
    "created_at": "2019-06-20T10:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392491",
    "user": "@embray"
}
```

To clarify, although I don't know exactly the steps to reproduce it, I was able to sit with Isuru here at Cernay and see for myself that it was happening.

I later modified the configure script directly to try to trace in what places `CFLAGS` and/or `LDFLAGS` were being modified and not restored, and I tracked it down to zlib; and indeed looking at the code you can see that it is doing that in some cases.

We confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.



---

archive/issue_comments_392492.json:
```json
{
    "body": "Replying to [comment:6 embray]:\n> We confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.\n\nWhich, I think Isuru noted, is okay because the sage package for conda is patching sage to not install any spkgs in the first place, of course.\n\nBut it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).",
    "created_at": "2019-06-20T10:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392492",
    "user": "@embray"
}
```

Replying to [comment:6 embray]:
> We confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.

Which, I think Isuru noted, is okay because the sage package for conda is patching sage to not install any spkgs in the first place, of course.

But it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).



---

archive/issue_comments_392493.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> But it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).\n\nIt doesn't fail configure, it just makes sage not use other packages in conda afterwards. This issue doesn't prevent building sage with conda=build, but is an issue with using conda dependencies to build sage outside of conda-build.",
    "created_at": "2019-06-20T11:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392493",
    "user": "@isuruf"
}
```

Replying to [comment:7 embray]:
> But it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).

It doesn't fail configure, it just makes sage not use other packages in conda afterwards. This issue doesn't prevent building sage with conda=build, but is an issue with using conda dependencies to build sage outside of conda-build.



---

archive/issue_comments_392494.json:
```json
{
    "body": "If I give `--with-zlib=$PREFIX --with-lzma=$PREFIX` then everything is fine. Issue is that `ax_check_zlib.m4` has a hardcoded list of places to check which includes `/usr`.",
    "created_at": "2019-08-02T21:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392494",
    "user": "@isuruf"
}
```

If I give `--with-zlib=$PREFIX --with-lzma=$PREFIX` then everything is fine. Issue is that `ax_check_zlib.m4` has a hardcoded list of places to check which includes `/usr`.



---

archive/issue_comments_392495.json:
```json
{
    "body": "yep, I agree that some of these ax_ macros are not very good, and should be improved.",
    "created_at": "2019-08-02T21:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392495",
    "user": "@dimpase"
}
```

yep, I agree that some of these ax_ macros are not very good, and should be improved.



---

archive/issue_comments_392496.json:
```json
{
    "body": "I can still try to fix this, if no one else does.  We vendor those macros in the first place and are free to modify them as we please.",
    "created_at": "2019-08-12T12:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392496",
    "user": "@embray"
}
```

I can still try to fix this, if no one else does.  We vendor those macros in the first place and are free to modify them as we please.



---

archive/issue_comments_392497.json:
```json
{
    "body": "this week I might only have time in the evening, otherwise single parent mode during school vacation",
    "created_at": "2019-08-12T12:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392497",
    "user": "@dimpase"
}
```

this week I might only have time in the evening, otherwise single parent mode during school vacation



---

archive/issue_comments_392498.json:
```json
{
    "body": "After more carefully reviewing `AX_CHECK_ZLIB` and friends, my conclusion was that they're not really adding anything helpful for how we are using them for Sage.  So the best solution I found was to gut them for the bits that are useful and toss the rest.\n\nWhat do you think?\n----\nNew commits:",
    "created_at": "2019-08-14T09:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392498",
    "user": "@embray"
}
```

After more carefully reviewing `AX_CHECK_ZLIB` and friends, my conclusion was that they're not really adding anything helpful for how we are using them for Sage.  So the best solution I found was to gut them for the bits that are useful and toss the rest.

What do you think?
----
New commits:



---

archive/issue_comments_392499.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-14T09:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392499",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_392500.json:
```json
{
    "body": "I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.",
    "created_at": "2019-08-14T11:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392500",
    "user": "@dimpase"
}
```

I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.



---

archive/issue_comments_392501.json:
```json
{
    "body": "Replying to [comment:15 dimpase]:\n> I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.\n\nI don't think so--that's only the default behavior if action-if-found is not specified. In this case it is.  I'll double-check that though.",
    "created_at": "2019-08-14T12:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392501",
    "user": "@embray"
}
```

Replying to [comment:15 dimpase]:
> I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.

I don't think so--that's only the default behavior if action-if-found is not specified. In this case it is.  I'll double-check that though.



---

archive/issue_comments_392502.json:
```json
{
    "body": "oops, sorry, your're right, it's OK, I mixed up AC_CHECK_LIB and AC_SEARCH_LIBS.\n\nI'll let Isuru do the final check.",
    "created_at": "2019-08-14T15:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392502",
    "user": "@dimpase"
}
```

oops, sorry, your're right, it's OK, I mixed up AC_CHECK_LIB and AC_SEARCH_LIBS.

I'll let Isuru do the final check.



---

archive/issue_comments_392503.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-14T15:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392503",
    "user": "@isuruf"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392504.json:
```json
{
    "body": "Works for me. The original errors are gone now.",
    "created_at": "2019-08-14T15:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392504",
    "user": "@isuruf"
}
```

Works for me. The original errors are gone now.



---

archive/issue_comments_392505.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-15T20:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27783",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27783#issuecomment-392505",
    "user": "@vbraun"
}
```

Resolution: fixed
