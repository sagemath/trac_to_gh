# Issue 27783: configure check for zlib and libzma can leave bogus compiler flags

Issue created by migration from https://trac.sagemath.org/ticket/28020

Original creator: embray

Original creation time: 2019-06-19 17:07:59

CC:  dimpase isuruf

The `AX_CHECK_ZLIB` macro (and by extension the `AX_CHECK_LIBLZMA` macro which is just a copy of it) has an annoyance where if it detects a system zlib, it will _permanently_ (i.e. for the remainder of the configure script) set some variables like `CPPFLAGS=-I${ZLIB_HOME}/include`.

So if this sets `CPPFLAGS=-I$/usr/include` this will be added to all checks for the rest of the configure script, and break some.

This particularly created bugs when building in a conda build environment as pointed out by Isuru.  

We could work around this in a number of ways, such as modifying those macros, or even possibly just putting some `AC_PUSH/POP_LANG` around it.


---

Comment by dimpase created at 2019-06-19 17:30:36

well, yes, I agree, many of our m4 solutions aren't meant to work in such a setting, and these `AX_` and other net-lifted macros we use aren't often very good pieces of code, either.


---

Comment by slelievre created at 2019-06-19 21:52:57

Changing keywords from "" to "days101, flags".


---

Comment by dimpase created at 2019-06-20 08:36:34

It would be good to understand the underlying issue of conda better. Does it refer to building with conda-supplied compiler, with a custom configuration for include (and library, I guess) paths? (Which, I suppose, can be broken by pre-pending stuff to `CPPFLAGS` and other similar variables).


---

Comment by isuruf created at 2019-06-20 08:44:44

Conda supplied compiler comes with a sysroot in `$PREFIX/x86_64-conda_cos6-linux-gnu` which contains system headers and libraries from CentOS 6 and the compiler doesn't look in `/usr` unless explicitly told to do so. When `-I/usr/include` is added to `CPPFLAGS`, it brings in headers from the system that the compiler runs on which results in errors.


---

Comment by dimpase created at 2019-06-20 10:03:10

Thanks. What are the steps to reproduce this?
Say, I have a conda installation, and I want to build Sage under conda.

Do I just do `conda activate` and proceed as if it's a "normal" system?


---

Comment by embray created at 2019-06-20 10:17:47

To clarify, although I don't know exactly the steps to reproduce it, I was able to sit with Isuru here at Cernay and see for myself that it was happening.

I later modified the configure script directly to try to trace in what places `CFLAGS` and/or `LDFLAGS` were being modified and not restored, and I tracked it down to zlib; and indeed looking at the code you can see that it is doing that in some cases.

We confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.


---

Comment by embray created at 2019-06-20 10:19:11

Replying to [comment:6 embray]:
> We confirmed that passing `--with-system-zlib=no` and `--with-system-xz=no` alleviated the problem.

Which, I think Isuru noted, is okay because the sage package for conda is patching sage to not install any spkgs in the first place, of course.

But it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).


---

Comment by isuruf created at 2019-06-20 11:12:17

Replying to [comment:7 embray]:
> But it's still necessary to run Sage's `configure`, and this problem causes `configure` to fail (since it leads to other library detections erroring out in unexpected ways).

It doesn't fail configure, it just makes sage not use other packages in conda afterwards. This issue doesn't prevent building sage with conda=build, but is an issue with using conda dependencies to build sage outside of conda-build.


---

Comment by isuruf created at 2019-08-02 21:06:07

If I give `--with-zlib=$PREFIX --with-lzma=$PREFIX` then everything is fine. Issue is that `ax_check_zlib.m4` has a hardcoded list of places to check which includes `/usr`.


---

Comment by dimpase created at 2019-08-02 21:30:02

yep, I agree that some of these ax_ macros are not very good, and should be improved.


---

Comment by embray created at 2019-08-12 12:33:47

I can still try to fix this, if no one else does.  We vendor those macros in the first place and are free to modify them as we please.


---

Comment by dimpase created at 2019-08-12 12:46:17

this week I might only have time in the evening, otherwise single parent mode during school vacation


---

Comment by embray created at 2019-08-14 09:30:32

After more carefully reviewing `AX_CHECK_ZLIB` and friends, my conclusion was that they're not really adding anything helpful for how we are using them for Sage.  So the best solution I found was to gut them for the bits that are useful and toss the rest.

What do you think?
----
New commits:


---

Comment by embray created at 2019-08-14 09:30:32

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-08-14 11:55:03

I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.


---

Comment by embray created at 2019-08-14 12:29:10

Replying to [comment:15 dimpase]:
> I think you need to nest AC_CHECK_HEADER and AC_CHECK_LIB to prevent extra stuff added to LIBS if there is no header found.

I don't think so--that's only the default behavior if action-if-found is not specified. In this case it is.  I'll double-check that though.


---

Comment by dimpase created at 2019-08-14 15:39:23

oops, sorry, your're right, it's OK, I mixed up AC_CHECK_LIB and AC_SEARCH_LIBS.

I'll let Isuru do the final check.


---

Comment by isuruf created at 2019-08-14 15:45:29

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2019-08-14 15:45:29

Works for me. The original errors are gone now.


---

Comment by vbraun created at 2019-08-15 20:30:24

Resolution: fixed
