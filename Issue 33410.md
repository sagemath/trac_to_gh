# Issue 33410: Fix test failure with pari 2.13.4

archive/issues_033410.json:
```json
{
    "body": "CC:  mkoeppe fbissey tornaria\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33647\n\n",
    "created_at": "2022-04-05T21:40:55Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "Fix test failure with pari 2.13.4",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33410",
    "user": "arojas"
}
```
CC:  mkoeppe fbissey tornaria



Issue created by migration from https://trac.sagemath.org/ticket/33647





---

archive/issue_comments_475634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-05T21:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475634",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_475635.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2022-04-05T21:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475635",
    "user": "arojas"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_comments_475636.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-04-05T21:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475636",
    "user": "arojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_475637.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-05T21:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475637",
    "user": "arojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_475638.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-06T01:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475638",
    "user": "tornaria"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_475639.json:
```json
{
    "body": "LGTM.\n\nTested both pari-2.13.3 (before updating) and with the updated 2.13.4.",
    "created_at": "2022-04-06T01:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475639",
    "user": "tornaria"
}
```

LGTM.

Tested both pari-2.13.3 (before updating) and with the updated 2.13.4.



---

archive/issue_comments_475640.json:
```json
{
    "body": "The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.\n\nI feel fixing the doctest that way is just brushing the issue under the carpet.",
    "created_at": "2022-04-06T02:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475640",
    "user": "fbissey"
}
```

The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.

I feel fixing the doctest that way is just brushing the issue under the carpet.



---

archive/issue_comments_475641.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.\n> \n> I feel fixing the doctest that way is just brushing the issue under the carpet.\n\nIt seems to me the most precise answer possible is the one given by pari 2.13.4. It all boils down to\n\n```\n? (x+O(x^8))^2\n%1 = x^2 + O(x^9)\n```\n\nwhich was already giving that answer in 2.13.3.\n\nSince the taylor expansion of `cosh(x)` starts with `1 + 1/2*x^2 + ...` this is really correct.\n\nIndeed, even in 2.13.3:\n\n```\n? subst(cosh(x), x, x+O(x^8))\n%2 = 1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)\n```\n\n\nA more explicit alternative could be to use something like:\n\n```\nsage: pari('x+O(x^8)').cosh() + pari('O(x^8)')\n1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)\n```\n",
    "created_at": "2022-04-06T03:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475641",
    "user": "tornaria"
}
```

Replying to [comment:5 fbissey]:
> The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.
> 
> I feel fixing the doctest that way is just brushing the issue under the carpet.

It seems to me the most precise answer possible is the one given by pari 2.13.4. It all boils down to

```
? (x+O(x^8))^2
%1 = x^2 + O(x^9)
```

which was already giving that answer in 2.13.3.

Since the taylor expansion of `cosh(x)` starts with `1 + 1/2*x^2 + ...` this is really correct.

Indeed, even in 2.13.3:

```
? subst(cosh(x), x, x+O(x^8))
%2 = 1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)
```


A more explicit alternative could be to use something like:

```
sage: pari('x+O(x^8)').cosh() + pari('O(x^8)')
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
```




---

archive/issue_comments_475642.json:
```json
{
    "body": "What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like\n\n```\na_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)\n```\n\nThis is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.",
    "created_at": "2022-04-06T04:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475642",
    "user": "fbissey"
}
```

What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like

```
a_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)
```

This is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.



---

archive/issue_comments_475643.json:
```json
{
    "body": "As long as you don't define your power series as an element of a fixed-precision ring, pari has no way to know which answer you expect, and giving the best possible approximation is a valid (and, from my point of view, preferable) option.\n\nIn any case, this test is explicitly testing the pari interface. From sage we have two options, IMO: we accept whatever answer pari gives (as long as it is correct), or we stop testing the pari interface altogether. Any further discussion about which answer is more appropriate belongs upstream.",
    "created_at": "2022-04-06T07:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475643",
    "user": "arojas"
}
```

As long as you don't define your power series as an element of a fixed-precision ring, pari has no way to know which answer you expect, and giving the best possible approximation is a valid (and, from my point of view, preferable) option.

In any case, this test is explicitly testing the pari interface. From sage we have two options, IMO: we accept whatever answer pari gives (as long as it is correct), or we stop testing the pari interface altogether. Any further discussion about which answer is more appropriate belongs upstream.



---

archive/issue_comments_475644.json:
```json
{
    "body": "I won't argue more. My point has been understood and I'll accept the counterpoints in that case.",
    "created_at": "2022-04-06T08:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475644",
    "user": "fbissey"
}
```

I won't argue more. My point has been understood and I'll accept the counterpoints in that case.



---

archive/issue_comments_475645.json:
```json
{
    "body": "Replying to [comment:7 fbissey]:\n> What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like\n> {{{\n> a_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)\n> }}}\n> This is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.\n\nIf you want to explicitly truncate a power series to `O(x^8)`, you add `pari(O(x^8))` to it. That was my \nsuggestion above:\n\n```\nsage: pari('x+O(x^8)').cosh() + pari('O(x^8)')\n1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)\n```\n\n\nNote also that\n\n```\nsage: A = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)')\nsage: B = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)')\nsage: A == B\nTrue\n```\n\nSo really, the two answers are \"the same\" in a sense.\n\nIn pari, the explicit goal is to give the most precise answer that is possible, in that sense the former behaviour was a \"bug\" (in fact, `cos(x+O(x^8))` was already giving an `O(x^9)` answer, so the bug was particular to cosh).\n\nIn fact in sage the same is (sometimes) true:\n\n```\nsage: x = PowerSeriesRing(ZZ, 'x').0\nsage: x + O(x^8)\nx + O(x^8)\nsage: (x + O(x^8))^2\nx^2 + O(x^9)\n```\n\n\nHowever\n\n```\nsage: cosh(x+O(x^8))\n1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)\nsage: cos(x+O(x^8))\n1 - 1/2*x^2 + 1/24*x^4 - 1/720*x^6 + O(x^8)\n```\n",
    "created_at": "2022-04-06T12:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475645",
    "user": "tornaria"
}
```

Replying to [comment:7 fbissey]:
> What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like
> {{{
> a_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)
> }}}
> This is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.

If you want to explicitly truncate a power series to `O(x^8)`, you add `pari(O(x^8))` to it. That was my 
suggestion above:

```
sage: pari('x+O(x^8)').cosh() + pari('O(x^8)')
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
```


Note also that

```
sage: A = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)')
sage: B = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)')
sage: A == B
True
```

So really, the two answers are "the same" in a sense.

In pari, the explicit goal is to give the most precise answer that is possible, in that sense the former behaviour was a "bug" (in fact, `cos(x+O(x^8))` was already giving an `O(x^9)` answer, so the bug was particular to cosh).

In fact in sage the same is (sometimes) true:

```
sage: x = PowerSeriesRing(ZZ, 'x').0
sage: x + O(x^8)
x + O(x^8)
sage: (x + O(x^8))^2
x^2 + O(x^9)
```


However

```
sage: cosh(x+O(x^8))
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
sage: cos(x+O(x^8))
1 - 1/2*x^2 + 1/24*x^4 - 1/720*x^6 + O(x^8)
```




---

archive/issue_comments_475646.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-10T13:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33410",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33410#issuecomment-475646",
    "user": "vbraun"
}
```

Resolution: fixed
