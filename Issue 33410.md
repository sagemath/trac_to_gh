# Issue 33410: Fix test failure with pari 2.13.4

Issue created by migration from https://trac.sagemath.org/ticket/33647

Original creator: arojas

Original creation time: 2022-04-05 21:40:55

CC:  mkoeppe fbissey tornaria




---

Comment by git created at 2022-04-05 21:42:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-04-05 21:45:10

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by arojas created at 2022-04-05 21:45:10

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2022-04-05 21:45:10

Changing status from new to needs_review.


---

Comment by tornaria created at 2022-04-06 01:59:38

Changing status from needs_review to positive_review.


---

Comment by tornaria created at 2022-04-06 01:59:38

LGTM.

Tested both pari-2.13.3 (before updating) and with the updated 2.13.4.


---

Comment by fbissey created at 2022-04-06 02:07:35

The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.

I feel fixing the doctest that way is just brushing the issue under the carpet.


---

Comment by tornaria created at 2022-04-06 03:30:20

Replying to [comment:5 fbissey]:
> The branch will definitely fix the doctest but I am a bit unhappy with this in general. My problem is that it looks like `pari` changed how it is handling series. I would consider it important to know if I get an answer that is `O(x^8)` or `O(x^9)`, here it seems how you get that level has changed. Either sage's interface should follow or getting an answer in `O(x^9)` like here could be a bug upstream.
> 
> I feel fixing the doctest that way is just brushing the issue under the carpet.

It seems to me the most precise answer possible is the one given by pari 2.13.4. It all boils down to

```
? (x+O(x^8))^2
%1 = x^2 + O(x^9)
```

which was already giving that answer in 2.13.3.

Since the taylor expansion of `cosh(x)` starts with `1 + 1/2*x^2 + ...` this is really correct.

Indeed, even in 2.13.3:

```
? subst(cosh(x), x, x+O(x^8))
%2 = 1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)
```


A more explicit alternative could be to use something like:

```
sage: pari('x+O(x^8)').cosh() + pari('O(x^8)')
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
```



---

Comment by fbissey created at 2022-04-06 04:18:25

What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like

```
a_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)
```

This is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.


---

Comment by arojas created at 2022-04-06 07:39:37

As long as you don't define your power series as an element of a fixed-precision ring, pari has no way to know which answer you expect, and giving the best possible approximation is a valid (and, from my point of view, preferable) option.

In any case, this test is explicitly testing the pari interface. From sage we have two options, IMO: we accept whatever answer pari gives (as long as it is correct), or we stop testing the pari interface altogether. Any further discussion about which answer is more appropriate belongs upstream.


---

Comment by fbissey created at 2022-04-06 08:22:58

I won't argue more. My point has been understood and I'll accept the counterpoints in that case.


---

Comment by tornaria created at 2022-04-06 12:56:57

Replying to [comment:7 fbissey]:
> What I am trying to say, and I may be wrong, is that the sage syntax suggests I want an answer that is the correct expansion up to `O(x^8)`, so something like
> {{{
> a_0 + a_1*x + a_2*x^2 + ... + a_7*x^7 + O(x^8)
> }}}
> This is the answer up to the order I requested. I am not interested in what is in `O(x^8)` and do not wish it to be calculated. If I am off and you want `a_8*x^8` then the previous answer was wrong.

If you want to explicitly truncate a power series to `O(x^8)`, you add `pari(O(x^8))` to it. That was my 
suggestion above:

```
sage: pari('x+O(x^8)').cosh() + pari('O(x^8)')
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
```


Note also that

```
sage: A = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + 1/40320*x^8 + O(x^9)')
sage: B = pari('1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)')
sage: A == B
True
```

So really, the two answers are "the same" in a sense.

In pari, the explicit goal is to give the most precise answer that is possible, in that sense the former behaviour was a "bug" (in fact, `cos(x+O(x^8))` was already giving an `O(x^9)` answer, so the bug was particular to cosh).

In fact in sage the same is (sometimes) true:

```
sage: x = PowerSeriesRing(ZZ, 'x').0
sage: x + O(x^8)
x + O(x^8)
sage: (x + O(x^8))^2
x^2 + O(x^9)
```


However

```
sage: cosh(x+O(x^8))
1 + 1/2*x^2 + 1/24*x^4 + 1/720*x^6 + O(x^8)
sage: cos(x+O(x^8))
1 - 1/2*x^2 + 1/24*x^4 - 1/720*x^6 + O(x^8)
```



---

Comment by vbraun created at 2022-04-10 13:12:26

Resolution: fixed
