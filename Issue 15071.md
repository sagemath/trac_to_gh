# Issue 15071: init.sage file is not read when starting the notebook

archive/issues_015071.json:
```json
{
    "body": "CC:  @vbraun @ppurka @novoselt\n\nSee http://ask.sagemath.org/question/3084/notebook-and-initsage. This problem seems to have been introduced in #14523.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15308\n\n",
    "created_at": "2013-10-19T22:28:52Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "init.sage file is not read when starting the notebook",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15071",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @vbraun @ppurka @novoselt

See http://ask.sagemath.org/question/3084/notebook-and-initsage. This problem seems to have been introduced in #14523.

Issue created by migration from https://trac.sagemath.org/ticket/15308





---

archive/issue_comments_192769.json:
```json
{
    "body": "An example of output caused by this bug is:\n\nTraceback (most recent call last):    #The OrthogonalCurvilinearOutput.sage file will output the coefficients and differential operators defined \n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmpPnuBJt/___code___.py\", line 7, in <module>\n    attach('CartesianCoord.sage')\n  File \"lazy_import.pyx\", line 358, in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:3000)\n  File \"/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/attached_files.py\", line 344, in attach\n    load(filename, globals(), attach=True)\n  File \"/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/preparser.py\", line 1769, in load\n    execfile(preparse_file_named(fpath), globals)\n  File \"/home/sagedev/.sage/temp/ubuntu/18360/CartesianCoord.sage6m7Baj.py\", line 18, in <module>\n    var('q_1,q_2,q_3,x_1,x_2,x_3')\nNameError: name 'var' is not defined",
    "created_at": "2014-05-19T01:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192769",
    "user": "https://trac.sagemath.org/admin/accounts/users/RJBarker"
}
```

An example of output caused by this bug is:

Traceback (most recent call last):    #The OrthogonalCurvilinearOutput.sage file will output the coefficients and differential operators defined 
  File "", line 1, in <module>
    
  File "/tmp/tmpPnuBJt/___code___.py", line 7, in <module>
    attach('CartesianCoord.sage')
  File "lazy_import.pyx", line 358, in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:3000)
  File "/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/attached_files.py", line 344, in attach
    load(filename, globals(), attach=True)
  File "/home/sagedev/sage/local/lib/python2.7/site-packages/sage/misc/preparser.py", line 1769, in load
    execfile(preparse_file_named(fpath), globals)
  File "/home/sagedev/.sage/temp/ubuntu/18360/CartesianCoord.sage6m7Baj.py", line 18, in <module>
    var('q_1,q_2,q_3,x_1,x_2,x_3')
NameError: name 'var' is not defined



---

archive/issue_comments_192770.json:
```json
{
    "body": "Afaik attach doesn't work on the notebook.\n\nYour problem seems to be that `init.sage` is evaluated before Sage is started. A workaround might be to use a `.py` file starting with `from sage.all import *`",
    "created_at": "2014-05-19T10:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192770",
    "user": "https://github.com/vbraun"
}
```

Afaik attach doesn't work on the notebook.

Your problem seems to be that `init.sage` is evaluated before Sage is started. A workaround might be to use a `.py` file starting with `from sage.all import *`



---

archive/issue_comments_192771.json:
```json
{
    "body": "Changing component from misc to notebook.",
    "created_at": "2014-10-24T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192771",
    "user": "https://github.com/kcrisman"
}
```

Changing component from misc to notebook.



---

archive/issue_comments_192772.json:
```json
{
    "body": "Upstream at https://github.com/sagemath/sagenb/issues/251 though I'm not sure if it's identical to the init.sage issue.",
    "created_at": "2014-10-24T13:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192772",
    "user": "https://github.com/kcrisman"
}
```

Upstream at https://github.com/sagemath/sagenb/issues/251 though I'm not sure if it's identical to the init.sage issue.



---

archive/issue_comments_192773.json:
```json
{
    "body": "I appear to have a fix upstream; comments welcome there.  Somehow the change in #14523 in the definition of `attach` from \n\n```\n    import preparser \n        for filename in files: \n        preparser.load(filename, globals(), attach=True) \n```\n\nto\n\n```\n    try:\n        ipy = get_ipython()\n    except NameError:\n        ipy = None\n    global attached\n    for filename in files:\n        if ipy:\n            code = load_wrap(filename, attach=True)\n            ipy.run_cell(code)\n        else:\n            load(filename, globals(), attach=True)\n```\n\ndid this.  Probably that should really be fixed in Sage, but I don't want to mess around with two fixes.\n\nCan anyone think of why either adding that global (which one would think wouldn't clobber `all` globals, such as `Integer`?) or having the command-line code would be a problem?  Really, neither one should in principle cause a problem.  But it does.",
    "created_at": "2014-12-03T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192773",
    "user": "https://github.com/kcrisman"
}
```

I appear to have a fix upstream; comments welcome there.  Somehow the change in #14523 in the definition of `attach` from 

```
    import preparser 
        for filename in files: 
        preparser.load(filename, globals(), attach=True) 
```

to

```
    try:
        ipy = get_ipython()
    except NameError:
        ipy = None
    global attached
    for filename in files:
        if ipy:
            code = load_wrap(filename, attach=True)
            ipy.run_cell(code)
        else:
            load(filename, globals(), attach=True)
```

did this.  Probably that should really be fixed in Sage, but I don't want to mess around with two fixes.

Can anyone think of why either adding that global (which one would think wouldn't clobber `all` globals, such as `Integer`?) or having the command-line code would be a problem?  Really, neither one should in principle cause a problem.  But it does.



---

archive/issue_comments_192774.json:
```json
{
    "body": "Indeed, a little more testing shows that `globals()` is definitely not the usual Sage globals at that point - it is just the globals for that module, including the things that were imported like `os` and the builtins.  E.g.\n\n```\n'{\\'load\\': <function load at 0x1054cc488>, \\'load_attach_path\\': <function load_attach_path at 0x110d99e60>, \\'reload_attached_files_if_modified\\': <function reload_attached_files_if_modified at 0x110d9f2a8>, ...\n \\'__doc__\\': \\'\\\\nKeep track of attached files\\\\n\\\\nTESTS::\\\\n\\\\n    sage: attach(\\\\\\'http://wstein.org/loadtest.py\\\\\\')\\\\n    Traceback (most recent call last):\\\\n    ...\\\\n    ...\n \\'load_wrap\\': <function load_wrap at 0x1054cc500>, \\'load_attach_mode\\': <function load_attach_mode at 0x110d99de8>, \n\\'__builtins__\\': {\\'bytearray\\': <type \\'bytearray\\'>, \\'IndexError\\': <type \\'exceptions.IndexError\\'>, ...}, \n...\n\\'os\\': <module \\'os\\' from \\'/Users/.../sage/local/lib/python/os.pyc\\'>, \\'modified_file_iterator\\': <function modified_file_iterator at 0x110d9f230>}'\n```\n\nZoinks!",
    "created_at": "2014-12-03T18:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192774",
    "user": "https://github.com/kcrisman"
}
```

Indeed, a little more testing shows that `globals()` is definitely not the usual Sage globals at that point - it is just the globals for that module, including the things that were imported like `os` and the builtins.  E.g.

```
'{\'load\': <function load at 0x1054cc488>, \'load_attach_path\': <function load_attach_path at 0x110d99e60>, \'reload_attached_files_if_modified\': <function reload_attached_files_if_modified at 0x110d9f2a8>, ...
 \'__doc__\': \'\\nKeep track of attached files\\n\\nTESTS::\\n\\n    sage: attach(\\\'http://wstein.org/loadtest.py\\\')\\n    Traceback (most recent call last):\\n    ...\\n    ...
 \'load_wrap\': <function load_wrap at 0x1054cc500>, \'load_attach_mode\': <function load_attach_mode at 0x110d99de8>, 
\'__builtins__\': {\'bytearray\': <type \'bytearray\'>, \'IndexError\': <type \'exceptions.IndexError\'>, ...}, 
...
\'os\': <module \'os\' from \'/Users/.../sage/local/lib/python/os.pyc\'>, \'modified_file_iterator\': <function modified_file_iterator at 0x110d9f230>}'
```

Zoinks!



---

archive/issue_comments_192775.json:
```json
{
    "body": "From [the Python doc](https://docs.python.org/2/library/functions.html):\n> Remember that at module level, globals and locals are the same dictionary.\nBut on the other hand nothing really changed.  Except maybe that it was in a Cython file, and now is in a Python file?",
    "created_at": "2014-12-03T19:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192775",
    "user": "https://github.com/kcrisman"
}
```

From [the Python doc](https://docs.python.org/2/library/functions.html):
> Remember that at module level, globals and locals are the same dictionary.
But on the other hand nothing really changed.  Except maybe that it was in a Cython file, and now is in a Python file?



---

archive/issue_comments_192776.json:
```json
{
    "body": "Fix upstream at https://github.com/sagemath/sagenb/pull/267",
    "created_at": "2014-12-10T17:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192776",
    "user": "https://github.com/kcrisman"
}
```

Fix upstream at https://github.com/sagemath/sagenb/pull/267



---

archive/issue_comments_192777.json:
```json
{
    "body": "This is 100% ready to go, just need a reviewer upstream!",
    "created_at": "2014-12-17T21:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192777",
    "user": "https://github.com/kcrisman"
}
```

This is 100% ready to go, just need a reviewer upstream!



---

archive/issue_comments_192778.json:
```json
{
    "body": "This was fixed and is now in a merged package.",
    "created_at": "2015-02-12T15:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192778",
    "user": "https://github.com/kcrisman"
}
```

This was fixed and is now in a merged package.



---

archive/issue_comments_192779.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-12T15:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192779",
    "user": "https://github.com/kcrisman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192780.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-12T15:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192780",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_014754.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-12T21:17:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15071#event-14754"
}
```



---

archive/issue_comments_192781.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-12T21:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15071#issuecomment-192781",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
