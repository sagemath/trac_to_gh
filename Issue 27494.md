# Issue 27494: upgrade normaliz to 3.7.2, pynormaliz to 2.2

Issue created by migration from https://trac.sagemath.org/ticket/27731

Original creator: mkoeppe

Original creation time: 2019-04-26 13:50:30

CC:  winfried jipilab @sebasguts mkoeppe vdelecroix tscrim

Another update of normaliz, pynormaliz.

Tarballs - see wget commands below.

-------------------------------------------------

Step by step instructions if you want to try it out

1. Go to the Sage source tree and pull the branch associated to this ticket

2. Get the tarballs and put them in the `upstream` repository

```
$ wget -P upstream https://github.com/Normaliz/Normaliz/releases/download/v3.7.2/normaliz-3.7.2.tar.gz
$ wget -P upstream https://files.pythonhosted.org/packages/6e/65/a11dbd54e8be7fe6bb1d41fa68cb03902f6066016757123c6c3ade1202fe/PyNormaliz-2.2.tar.gz
```


3. Compile and install everything

```
$ sage -i pynormaliz
```


4. Run make

```
$ make build
```



---

Comment by mkoeppe created at 2019-04-26 14:55:04

New commits:


---

Comment by mkoeppe created at 2019-04-26 14:55:04

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-04-26 14:58:22

Hi,

What is the point of having several open tickets concerning Normaliz/PyNormaliz upgrade? You want the job of the release manager to become a nightmare? If Normaliz/PyNormaliz are not mature you should not have set anything to needs review in the first place. Also, you are shipping a beta version of e-antic which is not nice either.


---

Comment by mkoeppe created at 2019-04-26 15:14:58

3.7.1/2.1 are stable and an improvement over the existing versions in sage. The ticket #27682 is positively reviewed already, and per release manager, positively reviewed tickets are not to be modified further.


---

Comment by vdelecroix created at 2019-04-26 22:12:53

`PyNormaliz` provides a test suite, there should be a `spkg-check`.


---

Comment by vdelecroix created at 2019-04-26 22:12:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-04-27 07:18:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-27 07:22:48

PyNormaliz test suite currently fails with the e-antic bug-fix release 0.1.3b0 that we have in #27682.


---

Comment by git created at 2019-05-01 11:15:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-01 11:20:41

Changing type from enhancement to defect.


---

Comment by mkoeppe created at 2019-05-01 11:20:41

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-05-01 17:37:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-05-02 17:07:12

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-05-02 17:07:12

With Sage built with Python3

```
sage -t --long polyhedron/backend_normaliz.py
**********************************************************************
File "polyhedron/backend_normaliz.py", line 497, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._normaliz_format
Failed example:
    P = Polyhedron(vertices=[[0, 0], [0, 1], [1, 0]], # indirect doctest; optional - pynormaliz
                   backend='normaliz', verbose=True)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._normaliz_format[0]>", line 2, in <module>
        backend='normaliz', verbose=True)
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3690)
        return self.get_object()(*args, **kwds)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/constructor.py", line 604, in Polyhedron
        return parent(Vrep, Hrep, convert=convert, verbose=verbose)
      File "sage/structure/parent.pyx", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9224)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 181, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5074)
        raise
      File "sage/structure/coerce_maps.pyx", line 176, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4962)
        return C._element_constructor(x, *args, **kwds)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/parent.py", line 517, in _element_constructor_
        return self.element_class(self, Vrep, Hrep, **kwds)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 156, in __init__
        Polyhedron_base.__init__(self, parent, Vrep, Hrep, **kwds)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 124, in __init__
        self._init_from_Vrepresentation(vertices, rays, lines, **kwds)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 263, in _init_from_Vrepresentation
        self._init_from_normaliz_data(data, verbose=verbose)
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 201, in _init_from_normaliz_data
        print(self._normaliz_format(data), end='')
      File "/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 511, in _normaliz_format
        for key, value in data.iteritems():
    AttributeError: 'dict' object has no attribute 'iteritems'
**********************************************************************
```



---

Comment by git created at 2019-05-03 10:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-03 10:14:19

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2019-05-03 10:15:39

(The canonicalization of the output files is a good idea anyway and takes care of differences in dictionary orders between py2 and py3.)


---

Comment by jipilab created at 2019-05-03 14:32:14

Compiles cleanly on debian.

Running tests using `pynormaliz` in the folder `src/sage/geometry/polyhedron`:

```
$ sage -t *.py
Using --optional=bliss,dochtml,e_antic,gfortran,lrslib,memlimit,mpir,ninja_build,normaliz,pynormaliz,python2,sage,topcom
Doctesting 25 files.
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


and without:


```
$ sage -t *.py --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,python2,sage,topcom
Using --optional=bliss,dochtml,gfortran,lrslib,memlimit,mpir,ninja_build,python2,sage,topcom
Doctesting 25 files.
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by jipilab created at 2019-05-05 11:34:18

Merge conflict with the new beta.


---

Comment by git created at 2019-05-07 11:41:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-07 11:46:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-08 19:31:18

Needs review again!


---

Comment by vdelecroix created at 2019-05-08 20:13:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-14 12:37:21

Resolution: fixed


---

Comment by slabbe created at 2019-05-23 19:13:49

As I reported on [sage-release for 8.8.beta6](https://groups.google.com/d/msg/sage-release/CHxw0WQQLpE/D_jWIruEBQAJ), I get troubles installing pynormaliz.

Is this normal doctor?


---

Comment by vdelecroix created at 2019-05-23 19:15:56

Replying to [comment:27 slabbe]:
> As I reported on [sage-release for 8.8.beta6](https://groups.google.com/d/msg/sage-release/CHxw0WQQLpE/D_jWIruEBQAJ), I get troubles installing pynormaliz.
> 
> Is this normal doctor?

Could you check whether there is a config.log in

/home/slabbe/GitBox/sage/local/var/tmp/sage/build/pynormaliz-2.5

and if so attach it.


---

Comment by slabbe created at 2019-05-23 20:27:05

No config.log:


```
$ ls /home/slabbe/GitBox/sage/local/var/tmp/sage/build/pynormaliz-2.5
checksums.ini  package-version.txt  spkg-install  src
dependencies   spkg-check           SPKG.txt      type
```



---

Comment by mkoeppe created at 2019-05-23 20:32:45

It would of course be in the src subdirectory.


---

Comment by slabbe created at 2019-05-23 20:34:29

The complete pynormaliz-2.5.log file is pasted on [framabin here](https://framabin.org/p/?a648d45c0650b5cd#6Z9TY9HfEOFxlM5mHck+Hk1/17KgtcFqn8XFEy3vq9M=)

In particular, there is this line:


```
    configure: error: source directory already configured; run "make distclean" there first
```


Maybe this has to do with the fact that my brother asked me to [try to test this ticket](https://trac.sagemath.org/ticket/24905#comment:54) one month ago where I installed a previous version of those packages?


---

Comment by slabbe created at 2019-05-23 20:38:29

Replying to [comment:30 mkoeppe]:
> It would of course be in the src subdirectory.

No config.log file in the src directory, but there is a config.py.in:


```bash
$ cd /home/slabbe/GitBox/sage/local/var/tmp/sage/build/pynormaliz-2.5/src
$ ls
config.py.in  doc       m4                  PyNormaliz.py  setup.py
configure     examples  NormalizModule.cpp  Readme.md      tests
COPYING       GPLv2     PKG-INFO            setup.cfg
$ cat config.py.in 
# Configuration variables
ENFNORMALIZ=@ENFNORMALIZ@
```



---

Comment by vdelecroix created at 2019-05-23 20:46:42

Replying to [comment:31 slabbe]:
> The complete pynormaliz-2.5.log file is pasted on [framabin here](https://framabin.org/p/?a648d45c0650b5cd#6Z9TY9HfEOFxlM5mHck+Hk1/17KgtcFqn8XFEy3vq9M=)

I noticed. And this is not what I asked for.


---

Comment by vdelecroix created at 2019-05-23 20:49:03

Replying to [comment:32 slabbe]:
> Replying to [comment:30 mkoeppe]:
> > It would of course be in the src subdirectory.
> 
> No config.log file in the src directory, but there is a config.py.in:
> 
> {{{
> #!bash
> $ cd /home/slabbe/GitBox/sage/local/var/tmp/sage/build/pynormaliz-2.5/src
> $ ls
> config.py.in  doc       m4                  PyNormaliz.py  setup.py
> configure     examples  NormalizModule.cpp  Readme.md      tests
> COPYING       GPLv2     PKG-INFO            setup.cfg
> $ cat config.py.in 
> # Configuration variables
> ENFNORMALIZ=`@`ENFNORMALIZ`@`
> }}}

That is to be expected. The `setup.py` script calls `$ sh configure` that creates the `config.py` from the template file `config.py.in`. In your situation, the process get stuck at the `$ sh configure` call (as you `pynormaliz-2.5.log` already mentioned).

Do you have `sh` installed?

BTW: we should not discuss this on this close ticket... could you open a thread on sage-devel or so.


---

Comment by slabbe created at 2019-05-23 20:56:30

> BTW: we should not discuss this on this close ticket... could you open a thread on sage-devel or so.

OK, let's continue here: https://groups.google.com/d/msg/sage-devel/2virhaHdt1k/nK-AtlByBAAJ


---

Comment by mkoeppe created at 2019-06-02 22:44:29

Follow-up in #27920.
