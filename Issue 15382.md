# Issue 15382: Pickling of immutable graphs

archive/issues_015382.json:
```json
{
    "body": "CC:  simonking\n\nBefore\n\n```\nsage: g=Graph(graphs.PetersenGraph(),immutable=True)\nsage: g == loads(dumps(g))\n...\nTypeError: __cinit__() takes exactly 1 positional argument (0 given)\n```\n\n\nAfter\n\n```\nsage: g=Graph(graphs.PetersenGraph(),immutable=True)\nsage: g == loads(dumps(g))\nTrue\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15619\n\n",
    "created_at": "2014-01-02T10:31:12Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Pickling of immutable graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15382",
    "user": "https://github.com/nathanncohen"
}
```
CC:  simonking

Before

```
sage: g=Graph(graphs.PetersenGraph(),immutable=True)
sage: g == loads(dumps(g))
...
TypeError: __cinit__() takes exactly 1 positional argument (0 given)
```


After

```
sage: g=Graph(graphs.PetersenGraph(),immutable=True)
sage: g == loads(dumps(g))
True
```


Issue created by migration from https://trac.sagemath.org/ticket/15619





---

archive/issue_comments_198169.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-02T10:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198169",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_198170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-02T10:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198170",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198171.json:
```json
{
    "body": "I am not convinced that creating a graph in order to pickle a backend is the best possible solution. So, I'll do some further experiments with a reduce method for graphs---no need for you to worry about it at this point...",
    "created_at": "2014-01-02T10:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198171",
    "user": "https://github.com/simon-king-jena"
}
```

I am not convinced that creating a graph in order to pickle a backend is the best possible solution. So, I'll do some further experiments with a reduce method for graphs---no need for you to worry about it at this point...



---

archive/issue_comments_198172.json:
```json
{
    "body": "Of course not, it is indeed ugly code, and my point is that I write ugly code because I am forced by a machine to write code for which I have no personal use `:-P`\n\nYet it passes those stupid tests, and for this I am grateful. Right now I am fighting with \"Poset.promotion\", and I have noooooooo idea on earth of where the broken doctests are coming from `O_o`\n\nNathann",
    "created_at": "2014-01-02T10:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198172",
    "user": "https://github.com/nathanncohen"
}
```

Of course not, it is indeed ugly code, and my point is that I write ugly code because I am forced by a machine to write code for which I have no personal use `:-P`

Yet it passes those stupid tests, and for this I am grateful. Right now I am fighting with "Poset.promotion", and I have noooooooo idea on earth of where the broken doctests are coming from `O_o`

Nathann



---

archive/issue_comments_198173.json:
```json
{
    "body": "It does minimize the amount of code necessary for such a function, though. And clear code is good by itself `:-P`\n\nNathann",
    "created_at": "2014-01-02T11:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198173",
    "user": "https://github.com/nathanncohen"
}
```

It does minimize the amount of code necessary for such a function, though. And clear code is good by itself `:-P`

Nathann



---

archive/issue_comments_198174.json:
```json
{
    "body": "Replying to [comment:4 ncohen]:\n> Of course not, it is indeed ugly code, and my point is that I write ugly code because I am forced by a machine to write code for which I have no personal use `:-P`\n\nSage is a community project after all.",
    "created_at": "2014-01-02T11:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198174",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:4 ncohen]:
> Of course not, it is indeed ugly code, and my point is that I write ugly code because I am forced by a machine to write code for which I have no personal use `:-P`

Sage is a community project after all.



---

archive/issue_comments_198175.json:
```json
{
    "body": "I don't see the relationship `O_o`",
    "created_at": "2014-01-02T11:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198175",
    "user": "https://github.com/nathanncohen"
}
```

I don't see the relationship `O_o`



---

archive/issue_comments_198176.json:
```json
{
    "body": "What do you think about the following way to pickle generic graphs?\n\n```\n    def __reduce__(self):\n        # copy the dict\n        D = dict(self.__dict__.iteritems())\n        # remove something that may not be picklable\n        try:\n            del D['_backend']\n        except KeyError:\n            pass\n        return type(self), (self.edges(),), D\n```\n\nIs this elegant enough for you? Additional bait: We may even remove the existing `__reduce__` methods of the other backends `;-)`",
    "created_at": "2014-01-02T11:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198176",
    "user": "https://github.com/simon-king-jena"
}
```

What do you think about the following way to pickle generic graphs?

```
    def __reduce__(self):
        # copy the dict
        D = dict(self.__dict__.iteritems())
        # remove something that may not be picklable
        try:
            del D['_backend']
        except KeyError:
            pass
        return type(self), (self.edges(),), D
```

Is this elegant enough for you? Additional bait: We may even remove the existing `__reduce__` methods of the other backends `;-)`



---

archive/issue_comments_198177.json:
```json
{
    "body": "PS: With the above `__reduce__` method put into sage.graphs.generic_graph.py, one has\n\n```\nsage: G = graphs.PetersenGraph()\nsage: g = G.copy(data_structure='static_sparse')\nsage: loads(dumps(g))\nGraph on 10 vertices\nsage: g == _\nTrue\n```\n",
    "created_at": "2014-01-02T11:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198177",
    "user": "https://github.com/simon-king-jena"
}
```

PS: With the above `__reduce__` method put into sage.graphs.generic_graph.py, one has

```
sage: G = graphs.PetersenGraph()
sage: g = G.copy(data_structure='static_sparse')
sage: loads(dumps(g))
Graph on 10 vertices
sage: g == _
True
```




---

archive/issue_comments_198178.json:
```json
{
    "body": "Some little timing:\n\nYour way of pickling:\n\n```\nsage: G = graphs.PetersenGraph()\nsage: g = G.copy(data_structure='static_sparse')\nsage: %timeit h = loads(dumps(g))\n1000 loops, best of 3: 1.11 ms per loop\n```\n\n\nMy way of pickling:\n\n```\nsage: G = graphs.PetersenGraph()\nsage: g = G.copy(data_structure='static_sparse')\nsage: %timeit h = loads(dumps(g))\n1000 loops, best of 3: 493 us per loop\n```\n\n`:-P`",
    "created_at": "2014-01-02T11:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198178",
    "user": "https://github.com/simon-king-jena"
}
```

Some little timing:

Your way of pickling:

```
sage: G = graphs.PetersenGraph()
sage: g = G.copy(data_structure='static_sparse')
sage: %timeit h = loads(dumps(g))
1000 loops, best of 3: 1.11 ms per loop
```


My way of pickling:

```
sage: G = graphs.PetersenGraph()
sage: g = G.copy(data_structure='static_sparse')
sage: %timeit h = loads(dumps(g))
1000 loops, best of 3: 493 us per loop
```

`:-P`



---

archive/issue_comments_198179.json:
```json
{
    "body": "On the other hand, I think I did something severely wrong:\n\n```\nsage:  h = loads(dumps(g))\nsage: type(h._backend)\n<class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>\n```\n\nBad. So, it doesn't work in the way I thought...",
    "created_at": "2014-01-02T11:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198179",
    "user": "https://github.com/simon-king-jena"
}
```

On the other hand, I think I did something severely wrong:

```
sage:  h = loads(dumps(g))
sage: type(h._backend)
<class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
```

Bad. So, it doesn't work in the way I thought...



---

archive/issue_comments_198180.json:
```json
{
    "body": "Would it be possible to let the static graph backend `__init__` accept a list of edges rather than a graph? Then, your `__reduce__` method could be simplified (and actually it seems odd that the creation of a graph *backend* needs a graph!).",
    "created_at": "2014-01-02T12:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198180",
    "user": "https://github.com/simon-king-jena"
}
```

Would it be possible to let the static graph backend `__init__` accept a list of edges rather than a graph? Then, your `__reduce__` method could be simplified (and actually it seems odd that the creation of a graph *backend* needs a graph!).



---

archive/issue_comments_198181.json:
```json
{
    "body": "Hm. I tried to understand what happens when one creates a static sparse backend.\n\nI always thought that one needs a backend to implement a graph. But in fact `__init__` and `__cinit__` and `init_short_digraph` (which are all involved in the creation of a static sparse backend) rely on the input being a graph. `:-/`",
    "created_at": "2014-01-02T12:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198181",
    "user": "https://github.com/simon-king-jena"
}
```

Hm. I tried to understand what happens when one creates a static sparse backend.

I always thought that one needs a backend to implement a graph. But in fact `__init__` and `__cinit__` and `init_short_digraph` (which are all involved in the creation of a static sparse backend) rely on the input being a graph. `:-/`



---

archive/issue_comments_198182.json:
```json
{
    "body": "Well, that can be changed too at some point if it is really needed (I would personally hate to change all this code just because the guy who implemented TestSuite decide for everybody that all the graphs classes HE tested should be picklable), but building a graph is not such a trivial matter. Because you have labels of not, because you have multiple edges or not, because the labels can be integers, have labels, because you can have loops, because they can be oriented or not.\n\nI mean, that's actually a lot of stuff, and it's not funny to implement it so many times in the code. It's already *VERY* messy in the `Graph`/`DiGraph` constructors.\n\nHonestly, I don't think pickling really needs any amount of efficient code. So as we are just implementing it to make the testsuite happy, and unless you want to mess with all this code just because of that, let's use it. It's short and it works. It's bad code of course, because pickling is bad work. It's a generic way to store data, that should work regardless of what the data is. It's like XML. Saving data is not something that should be done without *knowing* what the data is. If you want to write generic code for this, it will end up being bad code.\n\nAnyway. The only problem I would like to see solved is to have Posets use a static data structure. That would make them both faster and lighter. And I think something should be done about the time complexity of the `Graph`/`DiGraph` constructor too.\n\nLet's move on. Can you help me with this promotion bug ? I have no idea of how it should be solved, and it seems to be the last step before having the Posets use a static backend.\n\nNathann",
    "created_at": "2014-01-02T12:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198182",
    "user": "https://github.com/nathanncohen"
}
```

Well, that can be changed too at some point if it is really needed (I would personally hate to change all this code just because the guy who implemented TestSuite decide for everybody that all the graphs classes HE tested should be picklable), but building a graph is not such a trivial matter. Because you have labels of not, because you have multiple edges or not, because the labels can be integers, have labels, because you can have loops, because they can be oriented or not.

I mean, that's actually a lot of stuff, and it's not funny to implement it so many times in the code. It's already *VERY* messy in the `Graph`/`DiGraph` constructors.

Honestly, I don't think pickling really needs any amount of efficient code. So as we are just implementing it to make the testsuite happy, and unless you want to mess with all this code just because of that, let's use it. It's short and it works. It's bad code of course, because pickling is bad work. It's a generic way to store data, that should work regardless of what the data is. It's like XML. Saving data is not something that should be done without *knowing* what the data is. If you want to write generic code for this, it will end up being bad code.

Anyway. The only problem I would like to see solved is to have Posets use a static data structure. That would make them both faster and lighter. And I think something should be done about the time complexity of the `Graph`/`DiGraph` constructor too.

Let's move on. Can you help me with this promotion bug ? I have no idea of how it should be solved, and it seems to be the last step before having the Posets use a static backend.

Nathann



---

archive/issue_comments_198183.json:
```json
{
    "body": "Replying to [comment:14 ncohen]:\n> but building a graph is not such a trivial matter. Because you have labels of not, because you have multiple edges or not, because the labels can be integers, have labels, because you can have loops, because they can be oriented or not.\n\nRight. This is in fact a strong argument for implementing the pickling in the way you did. All these optional arguments of `(Di)Graph.__init__` are a mess.\n\n> Honestly, I don't think pickling really needs any amount of efficient code.\n\nThat's a valid point, too. Efficient pickling mainly plays a role if *copying* is implemented by pickling, since this may happen interactively and frequently. But we have a separate and hopefully efficient implementation of `__copy__`, and thus `__reduce__` is really only involved when people want to store a poset (and hence, an immutable graph, and thus, a static sparse backend) into a file. So, spending some milli seconds seems acceptable.\n\n> So as we are just implementing it to make the testsuite happy, and unless you want to mess with all this code just because of that, let's use it. It's short and it works. It's bad code of course, because pickling is bad work. It's a generic way to store data, that should work regardless of what the data is. It's like XML. Saving data is not something that should be done without *knowing* what the data is.\n\nCareful! You are just arguing that the person who knows the data structure best (i.e., you) is responsible for making pickling work `:-)`\n\n> If you want to write generic code for this, it will end up being bad code.\n\nCorrect. Sometimes generic code just works, but in some cases `__reduce__` needs to be provided. Wonderful that Python is object oriented and lets us do such things...\n\n> Anyway. The only problem I would like to see solved is to have Posets use a static data structure. That would make them both faster and lighter. And I think something should be done about the time complexity of the `Graph`/`DiGraph` constructor too.\n\nHere or on a different ticket?\n\n> Let's move on. Can you help me with this promotion bug ?\n\nOK. So, I'll review your pickling approach, and in the meantime you point me to your branch for \"making posets use immutable graphs\", so that I can test the promotion bug.",
    "created_at": "2014-01-02T13:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198183",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:14 ncohen]:
> but building a graph is not such a trivial matter. Because you have labels of not, because you have multiple edges or not, because the labels can be integers, have labels, because you can have loops, because they can be oriented or not.

Right. This is in fact a strong argument for implementing the pickling in the way you did. All these optional arguments of `(Di)Graph.__init__` are a mess.

> Honestly, I don't think pickling really needs any amount of efficient code.

That's a valid point, too. Efficient pickling mainly plays a role if *copying* is implemented by pickling, since this may happen interactively and frequently. But we have a separate and hopefully efficient implementation of `__copy__`, and thus `__reduce__` is really only involved when people want to store a poset (and hence, an immutable graph, and thus, a static sparse backend) into a file. So, spending some milli seconds seems acceptable.

> So as we are just implementing it to make the testsuite happy, and unless you want to mess with all this code just because of that, let's use it. It's short and it works. It's bad code of course, because pickling is bad work. It's a generic way to store data, that should work regardless of what the data is. It's like XML. Saving data is not something that should be done without *knowing* what the data is.

Careful! You are just arguing that the person who knows the data structure best (i.e., you) is responsible for making pickling work `:-)`

> If you want to write generic code for this, it will end up being bad code.

Correct. Sometimes generic code just works, but in some cases `__reduce__` needs to be provided. Wonderful that Python is object oriented and lets us do such things...

> Anyway. The only problem I would like to see solved is to have Posets use a static data structure. That would make them both faster and lighter. And I think something should be done about the time complexity of the `Graph`/`DiGraph` constructor too.

Here or on a different ticket?

> Let's move on. Can you help me with this promotion bug ?

OK. So, I'll review your pickling approach, and in the meantime you point me to your branch for "making posets use immutable graphs", so that I can test the promotion bug.



---

archive/issue_comments_198184.json:
```json
{
    "body": "Just for completeness: It would also be possible to say \"graphs do not want being pickled\", which would force all structures that use graphs to implement their own pickling by storing the defining data of the graphs they use, rather than storing these graphs directly.\n\nHence, one could provide Poset with a custom `__reduce__` method that just stores the list of edges of the graph, rather than the graph itself. However, I think in the long run it would be better if graphs knew how to save themselves.",
    "created_at": "2014-01-02T13:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198184",
    "user": "https://github.com/simon-king-jena"
}
```

Just for completeness: It would also be possible to say "graphs do not want being pickled", which would force all structures that use graphs to implement their own pickling by storing the defining data of the graphs they use, rather than storing these graphs directly.

Hence, one could provide Poset with a custom `__reduce__` method that just stores the list of edges of the graph, rather than the graph itself. However, I think in the long run it would be better if graphs knew how to save themselves.



---

archive/issue_comments_198185.json:
```json
{
    "body": "Well. So what do we do with this commit ? Is it good for you ? And more importantly, what do we do with this bug in `linear_extensions.py` in the u/ncohen/tmp branch ? `:-/`\n\nNathann",
    "created_at": "2014-01-02T13:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198185",
    "user": "https://github.com/nathanncohen"
}
```

Well. So what do we do with this commit ? Is it good for you ? And more importantly, what do we do with this bug in `linear_extensions.py` in the u/ncohen/tmp branch ? `:-/`

Nathann



---

archive/issue_comments_198186.json:
```json
{
    "body": "This one seems to be the underlying reason for the problems with posets:\n\n```\nsage: uc = [[2,3], [], [1], [1], [1], [3,4]]\nsage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]), data_structure=\"static_sparse\")\nsage: loads(dumps(D)) == D\nFalse\n```\n",
    "created_at": "2014-01-02T19:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198186",
    "user": "https://github.com/simon-king-jena"
}
```

This one seems to be the underlying reason for the problems with posets:

```
sage: uc = [[2,3], [], [1], [1], [1], [3,4]]
sage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]), data_structure="static_sparse")
sage: loads(dumps(D)) == D
False
```




---

archive/issue_comments_198187.json:
```json
{
    "body": "The pickling result is in fact seriously wrong:\n\n```\nsage: d = loads(dumps(D))\nsage: d.edges()\n[(0, 2, None), (0, 3, None)]\nsage: D.edges()\n[(0, 2, None),\n (0, 3, None),\n (2, 1, None),\n (3, 1, None),\n (4, 1, None),\n (5, 3, None),\n (5, 4, None)]\n```\n",
    "created_at": "2014-01-02T19:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198187",
    "user": "https://github.com/simon-king-jena"
}
```

The pickling result is in fact seriously wrong:

```
sage: d = loads(dumps(D))
sage: d.edges()
[(0, 2, None), (0, 3, None)]
sage: D.edges()
[(0, 2, None),
 (0, 3, None),
 (2, 1, None),
 (3, 1, None),
 (4, 1, None),
 (5, 3, None),
 (5, 4, None)]
```




---

archive/issue_comments_198188.json:
```json
{
    "body": "Indeed the error occurs when constructing the graph used to pickle the graph backend:\n\n```\nsage: constructor = DiGraph\nsage: self = D._backend\nsage: G.add_vertices(self.iterator_verts(None))\nsage: G\nDigraph on 6 vertices\nsage: G.vertices()\n[0, 1, 2, 3, 4, 5]\nsage: D.vertices()\n[0, 1, 2, 3, 4, 5]\nsage: G.add_edges(list(self.iterator_edges(self.iterator_verts(None),1)))\nsage: G.edges()\n[(0, 2, None), (0, 3, None)]\n```\n\nBug in `iterator_edges`? Then you should thank the guy who invented the `TestSuite`, since it helped you uncover a bug in a method you probably care about (namely iteration over edges).",
    "created_at": "2014-01-02T19:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198188",
    "user": "https://github.com/simon-king-jena"
}
```

Indeed the error occurs when constructing the graph used to pickle the graph backend:

```
sage: constructor = DiGraph
sage: self = D._backend
sage: G.add_vertices(self.iterator_verts(None))
sage: G
Digraph on 6 vertices
sage: G.vertices()
[0, 1, 2, 3, 4, 5]
sage: D.vertices()
[0, 1, 2, 3, 4, 5]
sage: G.add_edges(list(self.iterator_edges(self.iterator_verts(None),1)))
sage: G.edges()
[(0, 2, None), (0, 3, None)]
```

Bug in `iterator_edges`? Then you should thank the guy who invented the `TestSuite`, since it helped you uncover a bug in a method you probably care about (namely iteration over edges).



---

archive/issue_comments_198189.json:
```json
{
    "body": "In pure form, the failing example is\n\n```\nsage: uc = [[2,3], [], [1], [1], [1], [3,4]]\nsage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]), data_structure=\"static_sparse\")\nsage: list(D._backend.iterator_edges(D.vertices(), True))\n[(0, 2, None), (0, 3, None)]\n```\n",
    "created_at": "2014-01-02T19:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198189",
    "user": "https://github.com/simon-king-jena"
}
```

In pure form, the failing example is

```
sage: uc = [[2,3], [], [1], [1], [1], [3,4]]
sage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]), data_structure="static_sparse")
sage: list(D._backend.iterator_edges(D.vertices(), True))
[(0, 2, None), (0, 3, None)]
```




---

archive/issue_comments_198190.json:
```json
{
    "body": "Ahahah. You are oversimplying things. It's good that we found a bug. But that does not justify all at once the principle of testsuites and its use. \n\nI'm trying to fix that. It's weird, if you use `iterator_out_edges` instead there is no problem anymore `O_o`\n\nNathann",
    "created_at": "2014-01-02T19:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198190",
    "user": "https://github.com/nathanncohen"
}
```

Ahahah. You are oversimplying things. It's good that we found a bug. But that does not justify all at once the principle of testsuites and its use. 

I'm trying to fix that. It's weird, if you use `iterator_out_edges` instead there is no problem anymore `O_o`

Nathann



---

archive/issue_comments_198191.json:
```json
{
    "body": "(by the way, `D.show` fails `:-P`)",
    "created_at": "2014-01-02T19:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198191",
    "user": "https://github.com/nathanncohen"
}
```

(by the way, `D.show` fails `:-P`)



---

archive/issue_comments_198192.json:
```json
{
    "body": "Oh. Well, it is not really a bug. It's just that `iterator_edges` is not meant for digraphs `O_o`\n\nNathann",
    "created_at": "2014-01-02T19:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198192",
    "user": "https://github.com/nathanncohen"
}
```

Oh. Well, it is not really a bug. It's just that `iterator_edges` is not meant for digraphs `O_o`

Nathann



---

archive/issue_comments_198193.json:
```json
{
    "body": "Did you find a place in the code that call the backend's `iterator_edges` functions ?\n\nNathann",
    "created_at": "2014-01-02T19:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198193",
    "user": "https://github.com/nathanncohen"
}
```

Did you find a place in the code that call the backend's `iterator_edges` functions ?

Nathann



---

archive/issue_comments_198194.json:
```json
{
    "body": "I mean... For a DiGraph. I should probably add an exception there when this function is used with a digraph, but it is clearly meant for undirected graphs only.\n\n\n```\n\t\tif j < i and j in vertices:\n                    continue\n```\n\n\nIt only outputs an edge once `:-P`\n\nNathann",
    "created_at": "2014-01-02T19:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198194",
    "user": "https://github.com/nathanncohen"
}
```

I mean... For a DiGraph. I should probably add an exception there when this function is used with a digraph, but it is clearly meant for undirected graphs only.


```
		if j < i and j in vertices:
                    continue
```


It only outputs an edge once `:-P`

Nathann



---

archive/issue_comments_198195.json:
```json
{
    "body": "I just added an exception to this method when it is used on undirected graphs, and it looks like the only code that calls this method on undirected graphs is .... the hash function `:-PPPPPPPPP`\n\nNathann",
    "created_at": "2014-01-02T20:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198195",
    "user": "https://github.com/nathanncohen"
}
```

I just added an exception to this method when it is used on undirected graphs, and it looks like the only code that calls this method on undirected graphs is .... the hash function `:-PPPPPPPPP`

Nathann



---

archive/issue_comments_198196.json:
```json
{
    "body": "Replying to [comment:24 ncohen]:\n> Oh. Well, it is not really a bug. It's just that `iterator_edges` is not meant for digraphs `O_o`\n\nIs this documented? If it *is* documented, then it is not a bug. But then, its use in `__reduce__` should be replaced by something that works.",
    "created_at": "2014-01-02T20:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198196",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:24 ncohen]:
> Oh. Well, it is not really a bug. It's just that `iterator_edges` is not meant for digraphs `O_o`

Is this documented? If it *is* documented, then it is not a bug. But then, its use in `__reduce__` should be replaced by something that works.



---

archive/issue_comments_198197.json:
```json
{
    "body": "What I just said doesn't make sense... `T_T`\n\nStill, the only exceptions I see happen with hashs...\n\nNathann",
    "created_at": "2014-01-02T20:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198197",
    "user": "https://github.com/nathanncohen"
}
```

What I just said doesn't make sense... `T_T`

Still, the only exceptions I see happen with hashs...

Nathann



---

archive/issue_comments_198198.json:
```json
{
    "body": "Replying to [comment:27 ncohen]:\n> I just added an exception to this method when it is used on undirected graphs, and it looks like the only code that calls this method on undirected graphs is .... the hash function `:-PPPPPPPPP`\n\nAhm... Does it *work* for undirected graphs or does it *not* work for undirected graphs? In your previous post, I understood that it is wrong to have it on a digraph.",
    "created_at": "2014-01-02T20:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198198",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:27 ncohen]:
> I just added an exception to this method when it is used on undirected graphs, and it looks like the only code that calls this method on undirected graphs is .... the hash function `:-PPPPPPPPP`

Ahm... Does it *work* for undirected graphs or does it *not* work for undirected graphs? In your previous post, I understood that it is wrong to have it on a digraph.



---

archive/issue_comments_198199.json:
```json
{
    "body": "It is not meant to be used on digraphs. It works on graphs : it just returns an edge i,j if i<j. Otherwise it is skipped. If we don't do that every undirected edge is returned twice. It's clearly meant for undirected graphs `O_o`\n\nNathann",
    "created_at": "2014-01-02T20:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198199",
    "user": "https://github.com/nathanncohen"
}
```

It is not meant to be used on digraphs. It works on graphs : it just returns an edge i,j if i<j. Otherwise it is skipped. If we don't do that every undirected edge is returned twice. It's clearly meant for undirected graphs `O_o`

Nathann



---

archive/issue_comments_198200.json:
```json
{
    "body": "Replying to [comment:31 ncohen]:\n> It is not meant to be used on digraphs. It works on graphs : it just returns an edge i,j if i<j. Otherwise it is skipped. If we don't do that every undirected edge is returned twice. It's clearly meant for undirected graphs `O_o`\n\n\nWould it be difficult to make it work on digraphs? After all, the backend knows whether it is directed, and thus one could make it so that the \"i<j\" test is only applied in the undirected case.",
    "created_at": "2014-01-02T20:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198200",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:31 ncohen]:
> It is not meant to be used on digraphs. It works on graphs : it just returns an edge i,j if i<j. Otherwise it is skipped. If we don't do that every undirected edge is returned twice. It's clearly meant for undirected graphs `O_o`


Would it be difficult to make it work on digraphs? After all, the backend knows whether it is directed, and thus one could make it so that the "i<j" test is only applied in the undirected case.



---

archive/issue_comments_198201.json:
```json
{
    "body": "Okay I'm stupid. I hadn't noticed I used this in `__reduce__`. Totally my mystake. I'm going to fix this and see how it works out. Should make a hell of a difference.\n\nNathann",
    "created_at": "2014-01-02T20:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198201",
    "user": "https://github.com/nathanncohen"
}
```

Okay I'm stupid. I hadn't noticed I used this in `__reduce__`. Totally my mystake. I'm going to fix this and see how it works out. Should make a hell of a difference.

Nathann



---

archive/issue_comments_198202.json:
```json
{
    "body": "Wait a minute. I am about to push a fix to iterator_edges, that makes it work on digraphs and would thus also fix the pickling problem.",
    "created_at": "2014-01-02T20:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198202",
    "user": "https://github.com/simon-king-jena"
}
```

Wait a minute. I am about to push a fix to iterator_edges, that makes it work on digraphs and would thus also fix the pickling problem.



---

archive/issue_comments_198203.json:
```json
{
    "body": "No, please. We need to discuss what the function should return before anything. I don't find any good answer for that. Short of a thing so ugly it should not be implemented `:-P`\n\nNathann",
    "created_at": "2014-01-02T20:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198203",
    "user": "https://github.com/nathanncohen"
}
```

No, please. We need to discuss what the function should return before anything. I don't find any good answer for that. Short of a thing so ugly it should not be implemented `:-P`

Nathann



---

archive/issue_comments_198204.json:
```json
{
    "body": "Okay, replacing `iterator_edges` by `iterator_out_edges` in the `__reduce__` function of the static sparse backend fixes the pickling-related problems. Some other weird bugs remain in the poset/ folder though `T_T`\n\nNathann",
    "created_at": "2014-01-02T20:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198204",
    "user": "https://github.com/nathanncohen"
}
```

Okay, replacing `iterator_edges` by `iterator_out_edges` in the `__reduce__` function of the static sparse backend fixes the pickling-related problems. Some other weird bugs remain in the poset/ folder though `T_T`

Nathann



---

archive/issue_comments_198205.json:
```json
{
    "body": "Replying to [comment:35 ncohen]:\n> No, please. We need to discuss what the function should return before anything. I don't find any good answer for that. Short of a thing so ugly it should not be implemented `:-P`\n\nI was in the process of pushing, now I have interrupted it. I don't know if this has worked or if my commit has already been posted.\n\nBut why would you hesitate to make `iterator_edges` work on digraphs?",
    "created_at": "2014-01-02T20:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198205",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:35 ncohen]:
> No, please. We need to discuss what the function should return before anything. I don't find any good answer for that. Short of a thing so ugly it should not be implemented `:-P`

I was in the process of pushing, now I have interrupted it. I don't know if this has worked or if my commit has already been posted.

But why would you hesitate to make `iterator_edges` work on digraphs?



---

archive/issue_comments_198206.json:
```json
{
    "body": "It looks like it hasn't been posted.\n\nI hesitate because I don't think there is a good definition of what it should output. Let's try it this way : tell me what you wanted it to output and I will give you the graph which I think make it a bad definition. If I find no graph then we will implement it `:-P`\n\nNathann",
    "created_at": "2014-01-02T20:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198206",
    "user": "https://github.com/nathanncohen"
}
```

It looks like it hasn't been posted.

I hesitate because I don't think there is a good definition of what it should output. Let's try it this way : tell me what you wanted it to output and I will give you the graph which I think make it a bad definition. If I find no graph then we will implement it `:-P`

Nathann



---

archive/issue_comments_198207.json:
```json
{
    "body": "Replying to [comment:35 ncohen]:\n> No, please. We need to discuss what the function should return before anything. I don't find any good answer for that.\n\nWell, of course it should return an iterator over the edges of the digraph. What else should it do?",
    "created_at": "2014-01-02T20:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198207",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:35 ncohen]:
> No, please. We need to discuss what the function should return before anything. I don't find any good answer for that.

Well, of course it should return an iterator over the edges of the digraph. What else should it do?



---

archive/issue_comments_198208.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-02T20:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198208",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198209.json:
```json
{
    "body": "> Well, of course it should return an iterator over the edges of the digraph. What else should it do?\n\n`O_o`\n\nWhat about the `vertices` argument ?\n\nNathann\n----\nNew commits:",
    "created_at": "2014-01-02T20:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198209",
    "user": "https://github.com/nathanncohen"
}
```

> Well, of course it should return an iterator over the edges of the digraph. What else should it do?

`O_o`

What about the `vertices` argument ?

Nathann
----
New commits:



---

archive/issue_comments_198210.json:
```json
{
    "body": "Replying to [comment:38 ncohen]:\n> It looks like it hasn't been posted.\n> \n> I hesitate because I don't think there is a good definition of what it should output. Let's try it this way : tell me what you wanted it to output\n\nFor example (this is the doctest of my not-posted commit):\n\n```\nsage: uc = [[2,3], [], [1], [1], [1], [3,4]]\nsage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]))\nsage: G = Graph(dict([[i,uc[i]] for i in range(len(uc))]))\nsage: from sage.graphs.base.static_sparse_backend import StaticSparseBackend\nsage: d = StaticSparseBackend(D)\nsage: g = StaticSparseBackend(G)\nsage: list(d.iterator_edges(d.iterator_verts(None), False))\n[(0, 2), (0, 3), (2, 1), (3, 1), (4, 1), (5, 3), (5, 4)]\nsage: list(g.iterator_edges(g.iterator_verts(None), False))\n[(0, 2), (0, 3), (1, 2), (1, 3), (1, 4), (3, 5), (4, 5)]\n```\n",
    "created_at": "2014-01-02T20:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198210",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:38 ncohen]:
> It looks like it hasn't been posted.
> 
> I hesitate because I don't think there is a good definition of what it should output. Let's try it this way : tell me what you wanted it to output

For example (this is the doctest of my not-posted commit):

```
sage: uc = [[2,3], [], [1], [1], [1], [3,4]]
sage: D = DiGraph(dict([[i,uc[i]] for i in range(len(uc))]))
sage: G = Graph(dict([[i,uc[i]] for i in range(len(uc))]))
sage: from sage.graphs.base.static_sparse_backend import StaticSparseBackend
sage: d = StaticSparseBackend(D)
sage: g = StaticSparseBackend(G)
sage: list(d.iterator_edges(d.iterator_verts(None), False))
[(0, 2), (0, 3), (2, 1), (3, 1), (4, 1), (5, 3), (5, 4)]
sage: list(g.iterator_edges(g.iterator_verts(None), False))
[(0, 2), (0, 3), (1, 2), (1, 3), (1, 4), (3, 5), (4, 5)]
```




---

archive/issue_comments_198211.json:
```json
{
    "body": "Replying to [comment:41 ncohen]:\n> What about the `vertices` argument ?\n\nAhaha, you mean whether it is supposed to be the in or out vertices of the edges being returned?",
    "created_at": "2014-01-02T20:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198211",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:41 ncohen]:
> What about the `vertices` argument ?

Ahaha, you mean whether it is supposed to be the in or out vertices of the edges being returned?



---

archive/issue_comments_198212.json:
```json
{
    "body": "Yep. You can make it the in-edges, or the out-edges. And both definitions are bad. Or you can make it the sum of both. But then you would return twice the edges that links two vertices of your set `vertices`. Unless you look for them and remove them before returning them. And this I think is ugly. What do you think ? `:-P`\n\nBy the way the commit I just uploaded does not work. Sorry for that. I'll fix it in a second.\n\nNathann",
    "created_at": "2014-01-02T20:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198212",
    "user": "https://github.com/nathanncohen"
}
```

Yep. You can make it the in-edges, or the out-edges. And both definitions are bad. Or you can make it the sum of both. But then you would return twice the edges that links two vertices of your set `vertices`. Unless you look for them and remove them before returning them. And this I think is ugly. What do you think ? `:-P`

By the way the commit I just uploaded does not work. Sorry for that. I'll fix it in a second.

Nathann



---

archive/issue_comments_198213.json:
```json
{
    "body": "Replying to [comment:44 ncohen]:\n> Yep. You can make it the in-edges, or the out-edges. And both definitions are bad. Or you can \n> make it the sum of both. But then you would return twice the edges that links two vertices of \n> your set `vertices`. Unless you look for them and remove them before returning them. And this I \n> think is ugly. What do you think ?\n\nAgreed.\n\n> By the way the commit I just uploaded does not work. Sorry for that. I'll fix it in a second.\n\nAgreed (it is self._directed, not self.directed).",
    "created_at": "2014-01-02T20:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198213",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:44 ncohen]:
> Yep. You can make it the in-edges, or the out-edges. And both definitions are bad. Or you can 
> make it the sum of both. But then you would return twice the edges that links two vertices of 
> your set `vertices`. Unless you look for them and remove them before returning them. And this I 
> think is ugly. What do you think ?

Agreed.

> By the way the commit I just uploaded does not work. Sorry for that. I'll fix it in a second.

Agreed (it is self._directed, not self.directed).



---

archive/issue_comments_198214.json:
```json
{
    "body": "Okayokay, I just fixed this `_directed`, what's left seems to work.\n\nThe funny thing is that the only code that actually tests this pickling stuff is the poset code... So this can only be tested seriously with static graph backends for posets `^^;`\n\nNathann",
    "created_at": "2014-01-02T20:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198214",
    "user": "https://github.com/nathanncohen"
}
```

Okayokay, I just fixed this `_directed`, what's left seems to work.

The funny thing is that the only code that actually tests this pickling stuff is the poset code... So this can only be tested seriously with static graph backends for posets `^^;`

Nathann



---

archive/issue_comments_198215.json:
```json
{
    "body": "Okay, I just updated it. It worked with the other flag because I added this variable while working on the poset stuff. That's part of what I will have to clean before sending this other patch `^^;`\n\nAnyway, this one looks good.\n\nNathann",
    "created_at": "2014-01-02T20:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198215",
    "user": "https://github.com/nathanncohen"
}
```

Okay, I just updated it. It worked with the other flag because I added this variable while working on the poset stuff. That's part of what I will have to clean before sending this other patch `^^;`

Anyway, this one looks good.

Nathann



---

archive/issue_comments_198216.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-01-02T20:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198216",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_198217.json:
```json
{
    "body": "Replying to [comment:46 ncohen]:\n> The funny thing is that the only code that actually tests this pickling stuff is the poset code... So this can only be tested seriously with static graph backends for posets `^^;`\n\nIf I recall correctly, in the \"good old days\" (before we had posets), the doctest coverage script was checking in each file whether it contains a \"loads(dumps(bla)) == bla\" test. So, people did want to pickle stuff even before some guy came up with category testsuites.\n\nBy the way, if you want that static graphs aren't just tested via posets, then you should provide a category of graphs! Its testsuite would automatically test whether pickling works `:-p`.\n----\nNew commits:",
    "created_at": "2014-01-02T20:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198217",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:46 ncohen]:
> The funny thing is that the only code that actually tests this pickling stuff is the poset code... So this can only be tested seriously with static graph backends for posets `^^;`

If I recall correctly, in the "good old days" (before we had posets), the doctest coverage script was checking in each file whether it contains a "loads(dumps(bla)) == bla" test. So, people did want to pickle stuff even before some guy came up with category testsuites.

By the way, if you want that static graphs aren't just tested via posets, then you should provide a category of graphs! Its testsuite would automatically test whether pickling works `:-p`.
----
New commits:



---

archive/issue_comments_198218.json:
```json
{
    "body": "Thank you for the fix! I'll review it then and add a few tests.",
    "created_at": "2014-01-02T20:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198218",
    "user": "https://github.com/simon-king-jena"
}
```

Thank you for the fix! I'll review it then and add a few tests.



---

archive/issue_comments_198219.json:
```json
{
    "body": "> If I recall correctly, in the \"good old days\" (before we had posets), the doctest coverage script was checking in each file whether it contains a \"loads(dumps(bla)) == bla\" test. So, people did want to pickle stuff even before some guy came up with category testsuites.\n\nI blame those who carry on as much as those who initiate it `:-P`\n>\n> By the way, if you want that static graphs aren't just tested via posets, then you should provide a category of graphs! Its testsuite would automatically test whether pickling works `:-p`.\n\nAhahahah. Over my dead body. I have been debugging code for two full evenings because people decided I should only implement picklable graphs, and this is because I try to fix combinat's hack of immutable posets. And that's not even the end of it. So let's make that clear : over my dead body `:-P`\n\nAnd there are still broken doctests in the combinat/poset/ folder now. I just updated the u/ncohen/tmp branch with this commit.\n\nNathann",
    "created_at": "2014-01-02T20:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198219",
    "user": "https://github.com/nathanncohen"
}
```

> If I recall correctly, in the "good old days" (before we had posets), the doctest coverage script was checking in each file whether it contains a "loads(dumps(bla)) == bla" test. So, people did want to pickle stuff even before some guy came up with category testsuites.

I blame those who carry on as much as those who initiate it `:-P`
>
> By the way, if you want that static graphs aren't just tested via posets, then you should provide a category of graphs! Its testsuite would automatically test whether pickling works `:-p`.

Ahahahah. Over my dead body. I have been debugging code for two full evenings because people decided I should only implement picklable graphs, and this is because I try to fix combinat's hack of immutable posets. And that's not even the end of it. So let's make that clear : over my dead body `:-P`

And there are still broken doctests in the combinat/poset/ folder now. I just updated the u/ncohen/tmp branch with this commit.

Nathann



---

archive/issue_comments_198220.json:
```json
{
    "body": "This being said, thank you for your help with this. It was driving me crazy. Actually the other bugs from combinat/poset in the u/ncohen/tmp branch are still driving me crazy `T_T`",
    "created_at": "2014-01-02T20:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198220",
    "user": "https://github.com/nathanncohen"
}
```

This being said, thank you for your help with this. It was driving me crazy. Actually the other bugs from combinat/poset in the u/ncohen/tmp branch are still driving me crazy `T_T`



---

archive/issue_comments_198221.json:
```json
{
    "body": "Hmmmm... Looks like the `StaticSparseBackend` has a working `relabel` function `:-PPPPPPPP`\n\nNathann",
    "created_at": "2014-01-02T21:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198221",
    "user": "https://github.com/nathanncohen"
}
```

Hmmmm... Looks like the `StaticSparseBackend` has a working `relabel` function `:-PPPPPPPP`

Nathann



---

archive/issue_comments_198222.json:
```json
{
    "body": "Annnnnnnnnd with this all tests pass.. WUUUUUHUUUUUUUUUUUUUUUUUUUUUUUU !! `O_O_O`\n\nNathann",
    "created_at": "2014-01-02T21:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198222",
    "user": "https://github.com/nathanncohen"
}
```

Annnnnnnnnd with this all tests pass.. WUUUUUHUUUUUUUUUUUUUUUUUUUUUUUU !! `O_O_O`

Nathann



---

archive/issue_comments_198223.json:
```json
{
    "body": "#15623 makes Posets use immutable graphs. Cool, isn't it ? `:-PPP`\n\nNathann",
    "created_at": "2014-01-02T21:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198223",
    "user": "https://github.com/nathanncohen"
}
```

#15623 makes Posets use immutable graphs. Cool, isn't it ? `:-PPP`

Nathann



---

archive/issue_comments_198224.json:
```json
{
    "body": "Replying to [comment:54 ncohen]:\n> Hmmmm... Looks like the `StaticSparseBackend` has a working `relabel` function `:-PPPPPPPP`\n\nOuch. But you take care of this in #15622, right?\n\nApart from this: All doctests pass, and the code looks fine to me. In a review commit, I'll add some tests for issues we discussed here.",
    "created_at": "2014-01-02T22:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198224",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:54 ncohen]:
> Hmmmm... Looks like the `StaticSparseBackend` has a working `relabel` function `:-PPPPPPPP`

Ouch. But you take care of this in #15622, right?

Apart from this: All doctests pass, and the code looks fine to me. In a review commit, I'll add some tests for issues we discussed here.



---

archive/issue_comments_198225.json:
```json
{
    "body": "Indeed, indeed !\n\nNathann",
    "created_at": "2014-01-03T08:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198225",
    "user": "https://github.com/nathanncohen"
}
```

Indeed, indeed !

Nathann



---

archive/issue_comments_198226.json:
```json
{
    "body": "Right now I am testing whether everything keeps working after merging my review patch from #15603.",
    "created_at": "2014-01-03T11:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198226",
    "user": "https://github.com/simon-king-jena"
}
```

Right now I am testing whether everything keeps working after merging my review patch from #15603.



---

archive/issue_comments_198227.json:
```json
{
    "body": "I am not sure if pushing my changes properly worked (apparently I needed to manually set the commit I added). Anyway, if you like my review commit, then it is a positive review.",
    "created_at": "2014-01-03T12:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198227",
    "user": "https://github.com/simon-king-jena"
}
```

I am not sure if pushing my changes properly worked (apparently I needed to manually set the commit I added). Anyway, if you like my review commit, then it is a positive review.



---

archive/issue_comments_198228.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-03T12:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198228",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198229.json:
```json
{
    "body": "Argggggggg sorry. I just noticed that there is a problem with this code. It does not handle multiple edges and loops correctly.\n\nI HAAAAAAAAAAAAAAAAAAAAATE THESE THINGS.\n\n\n```\nsage: g = Graph(multiedges = True)\nsage: g.add_edges(graphs.PetersenGraph().edges())\nsage: g.add_edges(graphs.PetersenGraph().edges())\nsage: gi = g.copy(immutable=True)\nsage: loads(dumps(gi))\nMulti-graph on 10 vertices\nsage: loads(dumps(gi)) == gi\nFalse\nsage: gi.size()             \n30\nsage: loads(dumps(gi)).size()\n15\n```\n\n\nI will add a commit to this one within 10 minutes. Need to write it first `>_<`\n\nNathann",
    "created_at": "2014-01-03T12:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198229",
    "user": "https://github.com/nathanncohen"
}
```

Argggggggg sorry. I just noticed that there is a problem with this code. It does not handle multiple edges and loops correctly.

I HAAAAAAAAAAAAAAAAAAAAATE THESE THINGS.


```
sage: g = Graph(multiedges = True)
sage: g.add_edges(graphs.PetersenGraph().edges())
sage: g.add_edges(graphs.PetersenGraph().edges())
sage: gi = g.copy(immutable=True)
sage: loads(dumps(gi))
Multi-graph on 10 vertices
sage: loads(dumps(gi)) == gi
False
sage: gi.size()             
30
sage: loads(dumps(gi)).size()
15
```


I will add a commit to this one within 10 minutes. Need to write it first `>_<`

Nathann



---

archive/issue_comments_198230.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-01-03T13:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198230",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_198231.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-01-03T13:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198231",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198232.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-01-03T13:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_198233.json:
```json
{
    "body": "Done. tested on the most ugly graphs I could build.\n\nI hate multigraphs. I hate loops. I hate labels.\n\nNathann",
    "created_at": "2014-01-03T13:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198233",
    "user": "https://github.com/nathanncohen"
}
```

Done. tested on the most ugly graphs I could build.

I hate multigraphs. I hate loops. I hate labels.

Nathann



---

archive/issue_comments_198234.json:
```json
{
    "body": "Helloooo Simon ! Is this one good for you ? It depends on a patch with `positive_review`, and a patch with `positive_review` depends on it, but it still unchecked `:-P`\n\nNathann",
    "created_at": "2014-01-04T09:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198234",
    "user": "https://github.com/nathanncohen"
}
```

Helloooo Simon ! Is this one good for you ? It depends on a patch with `positive_review`, and a patch with `positive_review` depends on it, but it still unchecked `:-P`

Nathann



---

archive/issue_comments_198235.json:
```json
{
    "body": "The solution seems logical to me (to the extent that multigraphs with labels and loops can be \"logical\"...), and the example is carefully chosen to cover all cases (including isolated vertices). Hence, if the doctests pass (I'll know in about one hour) then I'll give it a positive review.",
    "created_at": "2014-01-04T19:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198235",
    "user": "https://github.com/simon-king-jena"
}
```

The solution seems logical to me (to the extent that multigraphs with labels and loops can be "logical"...), and the example is carefully chosen to cover all cases (including isolated vertices). Hence, if the doctests pass (I'll know in about one hour) then I'll give it a positive review.



---

archive/issue_comments_198236.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-04T20:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198236",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198237.json:
```json
{
    "body": "\n```\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 3981.0 seconds\n    cpu time: 6195.0 seconds\n    cumulative wall time: 7673.1 seconds\n```\n\nOK, a bit more than an hour.\n\nAccording to the previous comment, this is a positive review.",
    "created_at": "2014-01-04T20:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198237",
    "user": "https://github.com/simon-king-jena"
}
```


```
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3981.0 seconds
    cpu time: 6195.0 seconds
    cumulative wall time: 7673.1 seconds
```

OK, a bit more than an hour.

According to the previous comment, this is a positive review.



---

archive/issue_comments_198238.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-01-05T02:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15382",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15382#issuecomment-198238",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
