# Issue 13167: wrapper_*.pyx fail to build on Cygwin

archive/issues_013167.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  dimpase\n\nSame problem as in #13336 with _ _ imp _ _ problems.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13339\n\n",
    "created_at": "2012-08-04T21:04:10Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "title": "wrapper_*.pyx fail to build on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13167",
    "user": "jpflori"
}
```
Assignee: tbd

CC:  dimpase

Same problem as in #13336 with _ _ imp _ _ problems.

Issue created by migration from https://trac.sagemath.org/ticket/13339





---

archive/issue_comments_160686.json:
```json
{
    "body": "here a fix will be a bit more involved. What happens is that `ext/interpreters/wrapper/wrapper_rdf.c`, which is Cython-autogenerated from the .pyx file, which in turn is generated by `ext/gen_interpreters.py`, has the line\n\n```\n __PYX_EXTERN_C DL_IMPORT(double) interp_rdf(double *, double *, PyObject **, double *, int *);\n```\n\nwhich should be \n\n```\n __PYX_EXTERN_C double interp_rdf(double *, double *, PyObject **, double *, int *);\n```\n\n\nAnd the same holds for `ext/interpreters/wrapper/wrapper_cdf.c` (and `ext/interpreters/wrapper/wrapper_rr.c`, `..._py.c`, `..._el.c`), just replace `rdf` (resp. `rr`, etc.) by `cdf` in every place above.\n\nAfter I do the corresponding changes in these C files, ./sage -b completes. \n\n-------------------------------------\n\nNow the attempt to start Sage ends with \n\n```\nTraceback (most recent call last):\n  File \"/home/Dima/sage-5.2.rc1/local/bin/sage-ipython\", line 18, in <module>\n    import IPython\nImportError: No module named IPython\n```\n\n(which is OK, I just have to run `make build`).",
    "created_at": "2012-08-05T05:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160686",
    "user": "dimpase"
}
```

here a fix will be a bit more involved. What happens is that `ext/interpreters/wrapper/wrapper_rdf.c`, which is Cython-autogenerated from the .pyx file, which in turn is generated by `ext/gen_interpreters.py`, has the line

```
 __PYX_EXTERN_C DL_IMPORT(double) interp_rdf(double *, double *, PyObject **, double *, int *);
```

which should be 

```
 __PYX_EXTERN_C double interp_rdf(double *, double *, PyObject **, double *, int *);
```


And the same holds for `ext/interpreters/wrapper/wrapper_cdf.c` (and `ext/interpreters/wrapper/wrapper_rr.c`, `..._py.c`, `..._el.c`), just replace `rdf` (resp. `rr`, etc.) by `cdf` in every place above.

After I do the corresponding changes in these C files, ./sage -b completes. 

-------------------------------------

Now the attempt to start Sage ends with 

```
Traceback (most recent call last):
  File "/home/Dima/sage-5.2.rc1/local/bin/sage-ipython", line 18, in <module>
    import IPython
ImportError: No module named IPython
```

(which is OK, I just have to run `make build`).



---

archive/issue_comments_160687.json:
```json
{
    "body": "I've already a fix which consists in generating h files for the interp_*.c files which get included in wrapper_*.c files and avoid the Cython/import/_ _ imp _ _ stuff as desrcibed in the [CygwinPort](CygwinPort) page, I'll post it a little later.\n\nThe IPython stuff was expected IIRC.\nI'll confirm that later as well, but were closing to finishing the build and starting Sage.",
    "created_at": "2012-08-05T07:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160687",
    "user": "jpflori"
}
```

I've already a fix which consists in generating h files for the interp_*.c files which get included in wrapper_*.c files and avoid the Cython/import/_ _ imp _ _ stuff as desrcibed in the [CygwinPort](CygwinPort) page, I'll post it a little later.

The IPython stuff was expected IIRC.
I'll confirm that later as well, but were closing to finishing the build and starting Sage.



---

archive/issue_comments_160688.json:
```json
{
    "body": "Replying to [comment:2 jpflori]:\n\n> The IPython stuff was expected IIRC.\nSure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know).",
    "created_at": "2012-08-05T08:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160688",
    "user": "dimpase"
}
```

Replying to [comment:2 jpflori]:

> The IPython stuff was expected IIRC.
Sure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know).



---

archive/issue_comments_160689.json:
```json
{
    "body": "and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.\n\nProbably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/`",
    "created_at": "2012-08-05T08:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160689",
    "user": "dimpase"
}
```

and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.

Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/`



---

archive/issue_comments_160690.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> Replying to [comment:2 jpflori]:\n> \n> > The IPython stuff was expected IIRC.\n> Sure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know). \nOh yeah I now remember about that problem.\nWe used to create a symlink from gap to gap.exe (or conversely) but my Cygwin was making the name conversion automatically and the symlink creation failed.\n\nAnyway, let's create another ticket for that.\nNot sure if the trick must be completely discrded or tthe error ignored if it fails.\n\nThis is now #13341.",
    "created_at": "2012-08-05T09:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160690",
    "user": "jpflori"
}
```

Replying to [comment:3 dimpase]:
> Replying to [comment:2 jpflori]:
> 
> > The IPython stuff was expected IIRC.
> Sure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know). 
Oh yeah I now remember about that problem.
We used to create a symlink from gap to gap.exe (or conversely) but my Cygwin was making the name conversion automatically and the symlink creation failed.

Anyway, let's create another ticket for that.
Not sure if the trick must be completely discrded or tthe error ignored if it fails.

This is now #13341.



---

archive/issue_comments_160691.json:
```json
{
    "body": "Replying to [comment:4 dimpase]:\n> and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.\n> \n> Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` \nI don't think I got that one with 5.1.rc1.\nSo either its a new problem, or I somehow got through it.\nI'll confirm when I'm getting there.",
    "created_at": "2012-08-05T09:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160691",
    "user": "jpflori"
}
```

Replying to [comment:4 dimpase]:
> and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.
> 
> Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` 
I don't think I got that one with 5.1.rc1.
So either its a new problem, or I somehow got through it.
I'll confirm when I'm getting there.



---

archive/issue_comments_160692.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-05T09:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160692",
    "user": "jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160693.json:
```json
{
    "body": "Please be aware that I also fixed all the EXAMPLES block with this patch.\n\nAnd I did not have the chance to test the doctests yet.",
    "created_at": "2012-08-05T09:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160693",
    "user": "jpflori"
}
```

Please be aware that I also fixed all the EXAMPLES block with this patch.

And I did not have the chance to test the doctests yet.



---

archive/issue_comments_160694.json:
```json
{
    "body": "Replying to [comment:6 jpflori]:\n> Replying to [comment:4 dimpase]:\n> > and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.\n> > \n> > Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` \n> I don't think I got that one with 5.1.rc1.\n> So either its a new problem, or I somehow got through it.\n> I'll confirm when I'm getting there.\nThis is indeed an issue with the new sage notebook.\nWouldn't you mind opening a ticket and posting an update spkg?",
    "created_at": "2012-08-05T10:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160694",
    "user": "jpflori"
}
```

Replying to [comment:6 jpflori]:
> Replying to [comment:4 dimpase]:
> > and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.
> > 
> > Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` 
> I don't think I got that one with 5.1.rc1.
> So either its a new problem, or I somehow got through it.
> I'll confirm when I'm getting there.
This is indeed an issue with the new sage notebook.
Wouldn't you mind opening a ticket and posting an update spkg?



---

archive/issue_comments_160695.json:
```json
{
    "body": "Replying to [comment:10 jpflori]:\n> \n> This is indeed an issue with the new sage notebook.\n> Wouldn't you mind opening a ticket and posting an update spkg?\nI got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.",
    "created_at": "2012-08-05T13:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160695",
    "user": "dimpase"
}
```

Replying to [comment:10 jpflori]:
> 
> This is indeed an issue with the new sage notebook.
> Wouldn't you mind opening a ticket and posting an update spkg?
I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.



---

archive/issue_comments_160696.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> Replying to [comment:10 jpflori]:\n> > \n> > This is indeed an issue with the new sage notebook.\n> > Wouldn't you mind opening a ticket and posting an update spkg?\n> I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.\nI've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.\n\nYou can test it at http://perso.telecom-paristech.fr/~flori/sage/sagenb-0.9.1.p0.spkg\nAs I'm not sure whether there's a special procedure for updating the sagenb spkg, nothing is committed yet and no ticket created.",
    "created_at": "2012-08-05T15:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160696",
    "user": "jpflori"
}
```

Replying to [comment:11 dimpase]:
> Replying to [comment:10 jpflori]:
> > 
> > This is indeed an issue with the new sage notebook.
> > Wouldn't you mind opening a ticket and posting an update spkg?
> I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.
I've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.

You can test it at http://perso.telecom-paristech.fr/~flori/sage/sagenb-0.9.1.p0.spkg
As I'm not sure whether there's a special procedure for updating the sagenb spkg, nothing is committed yet and no ticket created.



---

archive/issue_comments_160697.json:
```json
{
    "body": "Replying to [comment:12 jpflori]:\n> Replying to [comment:11 dimpase]:\n> > Replying to [comment:10 jpflori]:\n> > > \n> > > This is indeed an issue with the new sage notebook.\n> > > Wouldn't you mind opening a ticket and posting an update spkg?\n> > I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.\n> I've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.\n\nThat's a fix, but not a proper cure to the problem. See #13344.\nIt's a bug somewhere else. That `crypto.lib` does not belong there at all!",
    "created_at": "2012-08-05T16:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160697",
    "user": "dimpase"
}
```

Replying to [comment:12 jpflori]:
> Replying to [comment:11 dimpase]:
> > Replying to [comment:10 jpflori]:
> > > 
> > > This is indeed an issue with the new sage notebook.
> > > Wouldn't you mind opening a ticket and posting an update spkg?
> > I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.
> I've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.

That's a fix, but not a proper cure to the problem. See #13344.
It's a bug somewhere else. That `crypto.lib` does not belong there at all!



---

archive/issue_comments_160698.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-08-12T03:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160698",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_160699.json:
```json
{
    "body": "I tried this on (upgraded from Sage 5.2) Sage 5.3.rc0 (on x86_64 Ubuntu 12.04), and got\n\n```\nsage -t  --long -force_lib devel/sage/sage/ext/gen_interpreters.py\n**********************************************************************\nFile \"/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py\", line 2530:\n    sage: print interp.h_header\nExpected:\n    #include <mpfr.h>\nGot:\n    <BLANKLINE>\n    #include <mpfr.h>\n    <BLANKLINE>\n    extern int rr_py_call_helper(PyObject*, PyObject*, int, mpfr_t*, mpfr_t*);\n    <BLANKLINE>\n**********************************************************************\nFile \"/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py\", line 3353:\n    sage: print rdf_interp_h\nExpected:\n    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */\n    #include <Python.h>\nGot:\n    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */\n    #include <Python.h>\n    <BLANKLINE>\n    #include <gsl/gsl_math.h>\n    <BLANKLINE>\n    double interp_rdf(double* args,\n            double* constants,\n            PyObject** py_constants,\n            double* stack,\n            int* code);\n    <BLANKLINE>\n... and more similar failures in this file, 5 in total...\n }}}\n\nPlease have a look.",
    "created_at": "2012-08-12T03:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160699",
    "user": "dimpase"
}
```

I tried this on (upgraded from Sage 5.2) Sage 5.3.rc0 (on x86_64 Ubuntu 12.04), and got

```
sage -t  --long -force_lib devel/sage/sage/ext/gen_interpreters.py
**********************************************************************
File "/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py", line 2530:
    sage: print interp.h_header
Expected:
    #include <mpfr.h>
Got:
    <BLANKLINE>
    #include <mpfr.h>
    <BLANKLINE>
    extern int rr_py_call_helper(PyObject*, PyObject*, int, mpfr_t*, mpfr_t*);
    <BLANKLINE>
**********************************************************************
File "/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py", line 3353:
    sage: print rdf_interp_h
Expected:
    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */
    #include <Python.h>
Got:
    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */
    #include <Python.h>
    <BLANKLINE>
    #include <gsl/gsl_math.h>
    <BLANKLINE>
    double interp_rdf(double* args,
            double* constants,
            PyObject** py_constants,
            double* stack,
            int* code);
    <BLANKLINE>
... and more similar failures in this file, 5 in total...
 }}}

Please have a look.



---

archive/issue_comments_160700.json:
```json
{
    "body": "My bad, I rewrote the doctests by hand and did not actually test them...\nThe fixes should be trivial, I'll have a look next week.",
    "created_at": "2012-08-17T12:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160700",
    "user": "jpflori"
}
```

My bad, I rewrote the doctests by hand and did not actually test them...
The fixes should be trivial, I'll have a look next week.



---

archive/issue_comments_160701.json:
```json
{
    "body": "Attachment\n\nThe new patch has correct BLANKLINE tags in the doctests and passes them on Linux with Sage-5.3.beta2.",
    "created_at": "2012-08-20T11:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160701",
    "user": "jpflori"
}
```

Attachment

The new patch has correct BLANKLINE tags in the doctests and passes them on Linux with Sage-5.3.beta2.



---

archive/issue_comments_160702.json:
```json
{
    "body": "Changing keywords from \"\" to \"cygwin\".",
    "created_at": "2012-08-20T11:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160702",
    "user": "jpflori"
}
```

Changing keywords from "" to "cygwin".



---

archive/issue_comments_160703.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-08-20T11:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160703",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_160704.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-08-20T15:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160704",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160705.json:
```json
{
    "body": "looks and works good. Positive review.",
    "created_at": "2012-08-20T15:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160705",
    "user": "dimpase"
}
```

looks and works good. Positive review.



---

archive/issue_comments_160706.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-23T12:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13167#issuecomment-160706",
    "user": "jdemeyer"
}
```

Resolution: fixed
