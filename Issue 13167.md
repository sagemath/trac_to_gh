# Issue 13167: wrapper_*.pyx fail to build on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/13339

Original creator: jpflori

Original creation time: 2012-08-04 21:04:10

Assignee: tbd

CC:  dimpase

Same problem as in #13336 with _ _ imp _ _ problems.


---

Comment by dimpase created at 2012-08-05 05:55:59

here a fix will be a bit more involved. What happens is that `ext/interpreters/wrapper/wrapper_rdf.c`, which is Cython-autogenerated from the .pyx file, which in turn is generated by `ext/gen_interpreters.py`, has the line

```
 __PYX_EXTERN_C DL_IMPORT(double) interp_rdf(double *, double *, PyObject **, double *, int *);
```

which should be 

```
 __PYX_EXTERN_C double interp_rdf(double *, double *, PyObject **, double *, int *);
```


And the same holds for `ext/interpreters/wrapper/wrapper_cdf.c` (and `ext/interpreters/wrapper/wrapper_rr.c`, `..._py.c`, `..._el.c`), just replace `rdf` (resp. `rr`, etc.) by `cdf` in every place above.

After I do the corresponding changes in these C files, ./sage -b completes. 

-------------------------------------

Now the attempt to start Sage ends with 

```
Traceback (most recent call last):
  File "/home/Dima/sage-5.2.rc1/local/bin/sage-ipython", line 18, in <module>
    import IPython
ImportError: No module named IPython
```

(which is OK, I just have to run `make build`).


---

Comment by jpflori created at 2012-08-05 07:55:37

I've already a fix which consists in generating h files for the interp_*.c files which get included in wrapper_*.c files and avoid the Cython/import/_ _ imp _ _ stuff as desrcibed in the [CygwinPort](CygwinPort) page, I'll post it a little later.

The IPython stuff was expected IIRC.
I'll confirm that later as well, but were closing to finishing the build and starting Sage.


---

Comment by dimpase created at 2012-08-05 08:03:10

Replying to [comment:2 jpflori]:

> The IPython stuff was expected IIRC.
Sure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know).


---

Comment by dimpase created at 2012-08-05 08:24:01

and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.

Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/`


---

Comment by jpflori created at 2012-08-05 09:38:05

Replying to [comment:3 dimpase]:
> Replying to [comment:2 jpflori]:
> 
> > The IPython stuff was expected IIRC.
> Sure. By the way, I just encountered a GAP-specific problem (some `ln` hack, no longer needed, fails), which is easy to fix, but needs a new spkg. Have you dealt with this too? Or it worked for you without a problem? (In case, I can open a ticket for this and post a new spkg, just let me know). 
Oh yeah I now remember about that problem.
We used to create a symlink from gap to gap.exe (or conversely) but my Cygwin was making the name conversion automatically and the symlink creation failed.

Anyway, let's create another ticket for that.
Not sure if the trick must be completely discrded or tthe error ignored if it fails.

This is now #13341.


---

Comment by jpflori created at 2012-08-05 09:39:02

Replying to [comment:4 dimpase]:
> and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.
> 
> Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` 
I don't think I got that one with 5.1.rc1.
So either its a new problem, or I somehow got through it.
I'll confirm when I'm getting there.


---

Comment by jpflori created at 2012-08-05 09:41:00

Changing status from new to needs_review.


---

Comment by jpflori created at 2012-08-05 09:42:41

Please be aware that I also fixed all the EXAMPLES block with this patch.

And I did not have the chance to test the doctests yet.


---

Comment by jpflori created at 2012-08-05 10:20:13

Replying to [comment:6 jpflori]:
> Replying to [comment:4 dimpase]:
> > and one more trivial stop: I got `SAGELOCAL/lib/crypto.lib` file, from PARI or Singular, or at least it an ASCII file with crypto-related code written in one of these languages, and it stopped PyOpen-ssl  thing to install properly. Removing the file fixed the problem.
> > 
> > Probably there is a CYGWIN-only script somewhere that copies *.lib files to  `SAGELOCAL/lib/` 
> I don't think I got that one with 5.1.rc1.
> So either its a new problem, or I somehow got through it.
> I'll confirm when I'm getting there.
This is indeed an issue with the new sage notebook.
Wouldn't you mind opening a ticket and posting an update spkg?


---

Comment by dimpase created at 2012-08-05 13:21:13

Replying to [comment:10 jpflori]:
> 
> This is indeed an issue with the new sage notebook.
> Wouldn't you mind opening a ticket and posting an update spkg?
I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.


---

Comment by jpflori created at 2012-08-05 15:49:27

Replying to [comment:11 dimpase]:
> Replying to [comment:10 jpflori]:
> > 
> > This is indeed an issue with the new sage notebook.
> > Wouldn't you mind opening a ticket and posting an update spkg?
> I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.
I've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.

You can test it at http://perso.telecom-paristech.fr/~flori/sage/sagenb-0.9.1.p0.spkg
As I'm not sure whether there's a special procedure for updating the sagenb spkg, nothing is committed yet and no ticket created.


---

Comment by dimpase created at 2012-08-05 16:00:19

Replying to [comment:12 jpflori]:
> Replying to [comment:11 dimpase]:
> > Replying to [comment:10 jpflori]:
> > > 
> > > This is indeed an issue with the new sage notebook.
> > > Wouldn't you mind opening a ticket and posting an update spkg?
> > I got stuck with #13343 (something I knew about, but forgot). So I'll have to rebuild Sage from scratch, as moving the half-built tree to another directory doesn't seem to work well.
> I've crafted a new spkg for the crypto.lib problem, just moving it to crypto.xxx before installing pyOpenSSL and movind it back afterward.

That's a fix, but not a proper cure to the problem. See #13344.
It's a bug somewhere else. That `crypto.lib` does not belong there at all!


---

Comment by dimpase created at 2012-08-12 03:57:04

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2012-08-12 03:57:04

I tried this on (upgraded from Sage 5.2) Sage 5.3.rc0 (on x86_64 Ubuntu 12.04), and got

```
sage -t  --long -force_lib devel/sage/sage/ext/gen_interpreters.py
**********************************************************************
File "/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py", line 2530:
    sage: print interp.h_header
Expected:
    #include <mpfr.h>
Got:
    <BLANKLINE>
    #include <mpfr.h>
    <BLANKLINE>
    extern int rr_py_call_helper(PyObject*, PyObject*, int, mpfr_t*, mpfr_t*);
    <BLANKLINE>
**********************************************************************
File "/tmp/sage-5.2/devel/sage-main/sage/ext/gen_interpreters.py", line 3353:
    sage: print rdf_interp_h
Expected:
    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */
    #include <Python.h>
Got:
    /* Automatically generated by ext/gen_interpreters.py.  Do not edit! */
    #include <Python.h>
    <BLANKLINE>
    #include <gsl/gsl_math.h>
    <BLANKLINE>
    double interp_rdf(double* args,
            double* constants,
            PyObject** py_constants,
            double* stack,
            int* code);
    <BLANKLINE>
... and more similar failures in this file, 5 in total...
 }}}

Please have a look.


---

Comment by jpflori created at 2012-08-17 12:29:17

My bad, I rewrote the doctests by hand and did not actually test them...
The fixes should be trivial, I'll have a look next week.


---

Attachment

The new patch has correct BLANKLINE tags in the doctests and passes them on Linux with Sage-5.3.beta2.


---

Comment by jpflori created at 2012-08-20 11:58:21

Changing keywords from "" to "cygwin".


---

Comment by jpflori created at 2012-08-20 11:58:21

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2012-08-20 15:39:48

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2012-08-20 15:39:48

looks and works good. Positive review.


---

Comment by jdemeyer created at 2012-08-23 12:47:33

Resolution: fixed
