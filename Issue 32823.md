# Issue 32823: pytest: Declare dependencies

archive/issues_032823.json:
```json
{
    "body": "CC:  @dimpase @orlitzky\n\n... to avoid races as seen in \nhttps://github.com/mkoeppe/sage/runs/4590618592?check_suite_focus=true\n\n```\n  [pytest] error installing, exit status 1. End of log file:\n  [pytest]   Collecting pytest\n  [pytest]     Downloading pytest-6.2.5-py3-none-any.whl (280 kB)\n  [pytest]   Collecting toml\n  [pytest]     Downloading toml-0.10.2-py2.py3-none-any.whl (16 kB)\n  [pytest]   Collecting pluggy<2.0,>=0.12\n  [pytest]     Downloading pluggy-1.0.0-py2.py3-none-any.whl (13 kB)\n  [pytest]   Collecting packaging\n  [pytest]     Downloading packaging-21.3-py3-none-any.whl (40 kB)\n  [pytest]   Collecting attrs>=19.2.0\n  [pytest]     Downloading attrs-21.2.0-py2.py3-none-any.whl (53 kB)\n  [pytest]   Collecting py>=1.8.2\n  [pytest]     Downloading py-1.11.0-py2.py3-none-any.whl (98 kB)\n  [pytest]   Collecting iniconfig\n  [pytest]     Downloading iniconfig-1.1.1-py2.py3-none-any.whl (5.0 kB)\n  [pytest]   Collecting pyparsing!=3.0.5,>=2.0.2\n  [pytest]     Downloading pyparsing-3.0.6-py3-none-any.whl (97 kB)\n  [pytest]   Installing collected packages: iniconfig, toml, pyparsing, py, pluggy, attrs, packaging, pytest\n  [pytest]   ERROR: Could not install packages due to an OSError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/INSTALLERzxvc5w2o.tmp'\n  [pytest]   \n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33060\n\n",
    "created_at": "2021-12-21T16:18:20Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "pytest: Declare dependencies",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32823",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @orlitzky

... to avoid races as seen in 
https://github.com/mkoeppe/sage/runs/4590618592?check_suite_focus=true

```
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   Collecting pytest
  [pytest]     Downloading pytest-6.2.5-py3-none-any.whl (280 kB)
  [pytest]   Collecting toml
  [pytest]     Downloading toml-0.10.2-py2.py3-none-any.whl (16 kB)
  [pytest]   Collecting pluggy<2.0,>=0.12
  [pytest]     Downloading pluggy-1.0.0-py2.py3-none-any.whl (13 kB)
  [pytest]   Collecting packaging
  [pytest]     Downloading packaging-21.3-py3-none-any.whl (40 kB)
  [pytest]   Collecting attrs>=19.2.0
  [pytest]     Downloading attrs-21.2.0-py2.py3-none-any.whl (53 kB)
  [pytest]   Collecting py>=1.8.2
  [pytest]     Downloading py-1.11.0-py2.py3-none-any.whl (98 kB)
  [pytest]   Collecting iniconfig
  [pytest]     Downloading iniconfig-1.1.1-py2.py3-none-any.whl (5.0 kB)
  [pytest]   Collecting pyparsing!=3.0.5,>=2.0.2
  [pytest]     Downloading pyparsing-3.0.6-py3-none-any.whl (97 kB)
  [pytest]   Installing collected packages: iniconfig, toml, pyparsing, py, pluggy, attrs, packaging, pytest
  [pytest]   ERROR: Could not install packages due to an OSError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/INSTALLERzxvc5w2o.tmp'
  [pytest]   
```


Issue created by migration from https://trac.sagemath.org/ticket/33060





---

archive/issue_comments_467330.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467330",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_467331.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-21T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467331",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467332.json:
```json
{
    "body": "Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?\n\nIf so, do we have to worry about importlib-metadata with python-3.7?",
    "created_at": "2021-12-21T16:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467332",
    "user": "https://github.com/orlitzky"
}
```

Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?

If so, do we have to worry about importlib-metadata with python-3.7?



---

archive/issue_comments_467333.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T17:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467333",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467334.json:
```json
{
    "body": "Replying to [comment:3 mjo]:\n> Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?\n\nRather, because these are the only ones that we can control via this mechanism.\n\nIf there is another SPKG installed via `requirements.txt` that has common dependencies with `pytest`, there could still be a race.\n\n> If so, do we have to worry about importlib-metadata with python-3.7?\n\nThanks for catching this, I've added it.",
    "created_at": "2021-12-21T17:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467334",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:3 mjo]:
> Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?

Rather, because these are the only ones that we can control via this mechanism.

If there is another SPKG installed via `requirements.txt` that has common dependencies with `pytest`, there could still be a race.

> If so, do we have to worry about importlib-metadata with python-3.7?

Thanks for catching this, I've added it.



---

archive/issue_comments_467335.json:
```json
{
    "body": "Ok, LGTM.",
    "created_at": "2021-12-21T17:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467335",
    "user": "https://github.com/orlitzky"
}
```

Ok, LGTM.



---

archive/issue_comments_467336.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-21T17:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467336",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467337.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-21T17:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467337",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_467338.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-12-23T00:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467338",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_events_029745.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-28T21:15:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32823#event-29745"
}
```



---

archive/issue_comments_467339.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-28T21:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32823",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32823#issuecomment-467339",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
