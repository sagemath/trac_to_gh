# Issue 32823: pytest: Declare dependencies

Issue created by migration from https://trac.sagemath.org/ticket/33060

Original creator: mkoeppe

Original creation time: 2021-12-21 16:18:20

CC:  dimpase mjo

... to avoid races as seen in 
https://github.com/mkoeppe/sage/runs/4590618592?check_suite_focus=true

```
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   Collecting pytest
  [pytest]     Downloading pytest-6.2.5-py3-none-any.whl (280 kB)
  [pytest]   Collecting toml
  [pytest]     Downloading toml-0.10.2-py2.py3-none-any.whl (16 kB)
  [pytest]   Collecting pluggy<2.0,>=0.12
  [pytest]     Downloading pluggy-1.0.0-py2.py3-none-any.whl (13 kB)
  [pytest]   Collecting packaging
  [pytest]     Downloading packaging-21.3-py3-none-any.whl (40 kB)
  [pytest]   Collecting attrs>=19.2.0
  [pytest]     Downloading attrs-21.2.0-py2.py3-none-any.whl (53 kB)
  [pytest]   Collecting py>=1.8.2
  [pytest]     Downloading py-1.11.0-py2.py3-none-any.whl (98 kB)
  [pytest]   Collecting iniconfig
  [pytest]     Downloading iniconfig-1.1.1-py2.py3-none-any.whl (5.0 kB)
  [pytest]   Collecting pyparsing!=3.0.5,>=2.0.2
  [pytest]     Downloading pyparsing-3.0.6-py3-none-any.whl (97 kB)
  [pytest]   Installing collected packages: iniconfig, toml, pyparsing, py, pluggy, attrs, packaging, pytest
  [pytest]   ERROR: Could not install packages due to an OSError: [Errno 2] No such file or directory: '/sage/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/pyparsing-3.0.6.dist-info/INSTALLERzxvc5w2o.tmp'
  [pytest]   
```



---

Comment by mkoeppe created at 2021-12-21 16:26:42

New commits:


---

Comment by mkoeppe created at 2021-12-21 16:26:42

Changing status from new to needs_review.


---

Comment by mjo created at 2021-12-21 16:54:34

Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?

If so, do we have to worry about importlib-metadata with python-3.7?


---

Comment by git created at 2021-12-21 17:18:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-21 17:21:51

Replying to [comment:3 mjo]:
> Are we only listing the dependencies that already exist as SPKGs (i.e. skipping iniconfig) because those are the only ones that could be installing simultaneously?

Rather, because these are the only ones that we can control via this mechanism.

If there is another SPKG installed via `requirements.txt` that has common dependencies with `pytest`, there could still be a race.

> If so, do we have to worry about importlib-metadata with python-3.7?

Thanks for catching this, I've added it.


---

Comment by mjo created at 2021-12-21 17:25:29

Ok, LGTM.


---

Comment by mjo created at 2021-12-21 17:25:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-21 17:30:49

Thanks!


---

Comment by mkoeppe created at 2021-12-23 00:22:08

Changing priority from critical to blocker.


---

Comment by vbraun created at 2021-12-28 21:15:46

Resolution: fixed
