# Issue 12308: NTL segfault on OS X 10.7

archive/issues_012308.json:
```json
{
    "body": "Assignee: @williamstein\n\nOn OS X 10.7 (compiled with gcc-4.6.2, #12369), executing the following code:\n\n```\nR = Zp(5,5)\nS.<x> = R[]\nf = x^5 + 75*x^3 - 15*x^2 +125*x - 5\nW.<w> = R.ext(f)\npol = ntl.ZZ_pX([5^40,5^42,3*5^41], 5^44)\nW(pol, relprec = 0)\n```\n\ncrashes Sage:\n\n```\nProgram received signal EXC_BAD_ACCESS, Could not access memory.\nReason: KERN_INVALID_ADDRESS at address: 0x0000000300000002\n0x0000000101791ae1 in NTL::CopyPointer ()\n(gdb) bt\n#0  0x0000000101791ae1 in NTL::CopyPointer ()\n#1  0x0000000101791d46 in NTL::ZZ_pContext::restore ()\n#2  0x000000010164e1aa in ZZ_pX_conv_modulus ()\n#3  0x00000001063a1ff7 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_ZZ_pX_eis_shift_p (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:6173\n#4  0x0000000106392871 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_27PowComputer_ZZ_pX_small_Eis_eis_shift (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:12917\n#5  0x000000010638aced in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_17PowComputer_ZZ_pX_eis_shift_capdiv (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:9448\n#6  0x00000001064e0aba in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__internal_lshift (__pyx_v_self=0x10e057ef0, __pyx_v_shift=-200) at padic_ZZ_pX_CR_element.cpp:9197\n#7  0x00000001064dfd8b in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_part2 (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98) at padic_ZZ_pX_CR_element.cpp:8445\n#8  0x00000001064de4c7 in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_rel (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98, __pyx_v_ctx=0x10e078730, __pyx_v_relprec=0) at padic_ZZ_pX_CR_element.cpp:8146\n#9  0x00000001064fe4ee in __pyx_pf_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement___init__ (__pyx_v_self=0x10e057ef0, __pyx_args=0x10db23d40, __pyx_kwds=0x10da8f290) at padic_ZZ_pX_CR_element.cpp:5163\n#10 0x000000010007a1a7 in type_call ()\nPrevious frame inner to this frame (gdb could not unwind past this frame)\n(gdb)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12480\n\n",
    "created_at": "2012-02-09T10:28:49Z",
    "labels": [
        "component: interfaces",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "NTL segfault on OS X 10.7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12308",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: @williamstein

On OS X 10.7 (compiled with gcc-4.6.2, #12369), executing the following code:

```
R = Zp(5,5)
S.<x> = R[]
f = x^5 + 75*x^3 - 15*x^2 +125*x - 5
W.<w> = R.ext(f)
pol = ntl.ZZ_pX([5^40,5^42,3*5^41], 5^44)
W(pol, relprec = 0)
```

crashes Sage:

```
Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x0000000300000002
0x0000000101791ae1 in NTL::CopyPointer ()
(gdb) bt
#0  0x0000000101791ae1 in NTL::CopyPointer ()
#1  0x0000000101791d46 in NTL::ZZ_pContext::restore ()
#2  0x000000010164e1aa in ZZ_pX_conv_modulus ()
#3  0x00000001063a1ff7 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_ZZ_pX_eis_shift_p (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:6173
#4  0x0000000106392871 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_27PowComputer_ZZ_pX_small_Eis_eis_shift (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:12917
#5  0x000000010638aced in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_17PowComputer_ZZ_pX_eis_shift_capdiv (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:9448
#6  0x00000001064e0aba in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__internal_lshift (__pyx_v_self=0x10e057ef0, __pyx_v_shift=-200) at padic_ZZ_pX_CR_element.cpp:9197
#7  0x00000001064dfd8b in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_part2 (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98) at padic_ZZ_pX_CR_element.cpp:8445
#8  0x00000001064de4c7 in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_rel (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98, __pyx_v_ctx=0x10e078730, __pyx_v_relprec=0) at padic_ZZ_pX_CR_element.cpp:8146
#9  0x00000001064fe4ee in __pyx_pf_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement___init__ (__pyx_v_self=0x10e057ef0, __pyx_args=0x10db23d40, __pyx_kwds=0x10da8f290) at padic_ZZ_pX_CR_element.cpp:5163
#10 0x000000010007a1a7 in type_call ()
Previous frame inner to this frame (gdb could not unwind past this frame)
(gdb)
```


Issue created by migration from https://trac.sagemath.org/ticket/12480





---

archive/issue_comments_144604.json:
```json
{
    "body": "Attachment [12480.patch](tarball://root/attachments/some-uuid/ticket12480/12480.patch) by @williamstein created at 2012-02-09 23:40:04\n\nPositive review to the patch posted right when I write this.",
    "created_at": "2012-02-09T23:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144604",
    "user": "https://github.com/williamstein"
}
```

Attachment [12480.patch](tarball://root/attachments/some-uuid/ticket12480/12480.patch) by @williamstein created at 2012-02-09 23:40:04

Positive review to the patch posted right when I write this.



---

archive/issue_comments_144605.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-09T23:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144605",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_144606.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-09T23:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144606",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_144607.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-10T09:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144607",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_144608.json:
```json
{
    "body": "Reviewer patch fixes some documentation strings and also removes exceptions which will be ignored anyway (a cdef function can only raise exceptions if it is declared with an \"except\" value or if it returns a Python object).",
    "created_at": "2012-02-10T09:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144608",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer patch fixes some documentation strings and also removes exceptions which will be ignored anyway (a cdef function can only raise exceptions if it is declared with an "except" value or if it returns a Python object).



---

archive/issue_comments_144609.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-10T09:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144609",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144610.json:
```json
{
    "body": "William or David, could any of you please review my reviewer patch?",
    "created_at": "2012-02-11T21:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144610",
    "user": "https://github.com/jdemeyer"
}
```

William or David, could any of you please review my reviewer patch?



---

archive/issue_comments_144611.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-11T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144611",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_144612.json:
```json
{
    "body": "David and I discussed ValueError versus RuntimeError when he wrote this.  I initially suggested ValueError (as you changed it to), but he argued that this error should *never* occur, ever -- there should be no way to call this code from Python to produce this error.   I'm convinced by David.",
    "created_at": "2012-02-11T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144612",
    "user": "https://github.com/williamstein"
}
```

David and I discussed ValueError versus RuntimeError when he wrote this.  I initially suggested ValueError (as you changed it to), but he argued that this error should *never* occur, ever -- there should be no way to call this code from Python to produce this error.   I'm convinced by David.



---

archive/issue_comments_144613.json:
```json
{
    "body": "Replying to [comment:10 was]:\n> he argued that this error should *never* occur, ever\nI don't see why this is an argument for `RuntimeError` instead of `ValueError`.\n\nHow would you like `SystemError` instead?  Of all standard Python exceptions, it seems to be the closest equivalent to what you want: [http://docs.python.org/library/exceptions.html#exceptions.SystemError](http://docs.python.org/library/exceptions.html#exceptions.SystemError)",
    "created_at": "2012-02-11T23:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144613",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 was]:
> he argued that this error should *never* occur, ever
I don't see why this is an argument for `RuntimeError` instead of `ValueError`.

How would you like `SystemError` instead?  Of all standard Python exceptions, it seems to be the closest equivalent to what you want: [http://docs.python.org/library/exceptions.html#exceptions.SystemError](http://docs.python.org/library/exceptions.html#exceptions.SystemError)



---

archive/issue_comments_144614.json:
```json
{
    "body": "*** ping ***",
    "created_at": "2012-02-15T16:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144614",
    "user": "https://github.com/jdemeyer"
}
```

*** ping ***



---

archive/issue_comments_144615.json:
```json
{
    "body": "*** ahem ***",
    "created_at": "2012-03-01T17:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144615",
    "user": "https://github.com/jdemeyer"
}
```

*** ahem ***



---

archive/issue_comments_144616.json:
```json
{
    "body": "Sorry: I wasn't getting trac notifications on this ticket for some reason.\n\nThe changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.",
    "created_at": "2012-03-03T00:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144616",
    "user": "https://github.com/roed314"
}
```

Sorry: I wasn't getting trac notifications on this ticket for some reason.

The changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.



---

archive/issue_comments_144617.json:
```json
{
    "body": "Reviewer patch, apply on top of previous",
    "created_at": "2012-03-05T08:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144617",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer patch, apply on top of previous



---

archive/issue_comments_144618.json:
```json
{
    "body": "Attachment [12480_review.patch](tarball://root/attachments/some-uuid/ticket12480/12480_review.patch) by @jdemeyer created at 2012-03-05 08:43:32\n\nI kept all `raise` statements but annotated them by\n\n```\n# Exception will be ignored by Cython\n```\n",
    "created_at": "2012-03-05T08:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144618",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12480_review.patch](tarball://root/attachments/some-uuid/ticket12480/12480_review.patch) by @jdemeyer created at 2012-03-05 08:43:32

I kept all `raise` statements but annotated them by

```
# Exception will be ignored by Cython
```




---

archive/issue_comments_144619.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-05T08:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144619",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144620.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-05T18:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144620",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_144621.json:
```json
{
    "body": "Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?",
    "created_at": "2012-03-05T18:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144621",
    "user": "https://github.com/roed314"
}
```

Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?



---

archive/issue_comments_144622.json:
```json
{
    "body": "Replying to [comment:16 roed]:\n> Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?\nI don't plan to deal with this code, so go ahead.",
    "created_at": "2012-03-05T20:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144622",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 roed]:
> Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?
I don't plan to deal with this code, so go ahead.



---

archive/issue_comments_144623.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-13T08:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144623",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_144624.json:
```json
{
    "body": "Replying to [comment:14 roed]:\n> The changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.\nDoes this refer to how Cython used to work? Does it make sense to add an `except NULL` to the function definition now? I stumbled upon this while working on #13591.",
    "created_at": "2014-07-09T18:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12308",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12308#issuecomment-144624",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:14 roed]:
> The changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.
Does this refer to how Cython used to work? Does it make sense to add an `except NULL` to the function definition now? I stumbled upon this while working on #13591.
