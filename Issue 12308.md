# Issue 12308: NTL segfault on OS X 10.7

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-02-09 10:28:49

Assignee: was

On OS X 10.7 (compiled with gcc-4.6.2, #12369), executing the following code:

```
R = Zp(5,5)
S.<x> = R[]
f = x^5 + 75*x^3 - 15*x^2 +125*x - 5
W.<w> = R.ext(f)
pol = ntl.ZZ_pX([5^40,5^42,3*5^41], 5^44)
W(pol, relprec = 0)
```

crashes Sage:

```
Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x0000000300000002
0x0000000101791ae1 in NTL::CopyPointer ()
(gdb) bt
#0  0x0000000101791ae1 in NTL::CopyPointer ()
#1  0x0000000101791d46 in NTL::ZZ_pContext::restore ()
#2  0x000000010164e1aa in ZZ_pX_conv_modulus ()
#3  0x00000001063a1ff7 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_ZZ_pX_eis_shift_p (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:6173
#4  0x0000000106392871 in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_27PowComputer_ZZ_pX_small_Eis_eis_shift (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:12917
#5  0x000000010638aced in __pyx_f_4sage_5rings_6padics_16pow_computer_ext_17PowComputer_ZZ_pX_eis_shift_capdiv (__pyx_v_self=0x10db203f0, __pyx_v_x=0x10e057f18, __pyx_v_a=0x10e057f18, __pyx_v_n=200, __pyx_v_finalprec=0) at pow_computer_ext.cpp:9448
#6  0x00000001064e0aba in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__internal_lshift (__pyx_v_self=0x10e057ef0, __pyx_v_shift=-200) at padic_ZZ_pX_CR_element.cpp:9197
#7  0x00000001064dfd8b in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_part2 (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98) at padic_ZZ_pX_CR_element.cpp:8445
#8  0x00000001064de4c7 in __pyx_f_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement__set_from_ZZ_pX_rel (__pyx_v_self=0x10e057ef0, __pyx_v_poly=0x10e075f98, __pyx_v_ctx=0x10e078730, __pyx_v_relprec=0) at padic_ZZ_pX_CR_element.cpp:8146
#9  0x00000001064fe4ee in __pyx_pf_4sage_5rings_6padics_22padic_ZZ_pX_CR_element_18pAdicZZpXCRElement___init__ (__pyx_v_self=0x10e057ef0, __pyx_args=0x10db23d40, __pyx_kwds=0x10da8f290) at padic_ZZ_pX_CR_element.cpp:5163
#10 0x000000010007a1a7 in type_call ()
Previous frame inner to this frame (gdb could not unwind past this frame)
(gdb)
```



---

Attachment

Positive review to the patch posted right when I write this.


---

Comment by was created at 2012-02-09 23:40:04

Changing status from new to needs_review.


---

Comment by was created at 2012-02-09 23:40:09

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-10 09:30:48

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-02-10 09:30:48

Reviewer patch fixes some documentation strings and also removes exceptions which will be ignored anyway (a cdef function can only raise exceptions if it is declared with an "except" value or if it returns a Python object).


---

Comment by jdemeyer created at 2012-02-10 09:30:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-02-11 21:43:15

William or David, could any of you please review my reviewer patch?


---

Comment by was created at 2012-02-11 22:49:07

Changing status from needs_review to needs_work.


---

Comment by was created at 2012-02-11 22:49:07

David and I discussed ValueError versus RuntimeError when he wrote this.  I initially suggested ValueError (as you changed it to), but he argued that this error should *never* occur, ever -- there should be no way to call this code from Python to produce this error.   I'm convinced by David.


---

Comment by jdemeyer created at 2012-02-11 23:16:13

Replying to [comment:10 was]:
> he argued that this error should *never* occur, ever
I don't see why this is an argument for `RuntimeError` instead of `ValueError`.

How would you like `SystemError` instead?  Of all standard Python exceptions, it seems to be the closest equivalent to what you want: [http://docs.python.org/library/exceptions.html#exceptions.SystemError](http://docs.python.org/library/exceptions.html#exceptions.SystemError)


---

Comment by jdemeyer created at 2012-02-15 16:34:03

** ping **


---

Comment by jdemeyer created at 2012-03-01 17:12:01

** ahem **


---

Comment by roed created at 2012-03-03 00:04:54

Sorry: I wasn't getting trac notifications on this ticket for some reason.

The changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.


---

Comment by jdemeyer created at 2012-03-05 08:41:35

Reviewer patch, apply on top of previous


---

Attachment

I kept all `raise` statements but annotated them by

```
# Exception will be ignored by Cython
```



---

Comment by jdemeyer created at 2012-03-05 08:43:32

Changing status from needs_work to needs_review.


---

Comment by roed created at 2012-03-05 18:50:40

Changing status from needs_review to positive_review.


---

Comment by roed created at 2012-03-05 18:50:40

Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?


---

Comment by jdemeyer created at 2012-03-05 20:09:04

Replying to [comment:16 roed]:
> Looks good.  Have you created a ticket to fix these ignored exceptions, or shall I?
I don't plan to deal with this code, so go ahead.


---

Comment by jdemeyer created at 2012-03-13 08:24:05

Resolution: fixed


---

Comment by saraedum created at 2014-07-09 18:37:59

Replying to [comment:14 roed]:
> The changes look good, except the removal of the three checks for n < 0 in `pow_mpz_t_tmp` and `pow_ZZ_tmp` where a ValueError is raised.  While I understand that Cython will ignore those errors, I think the right option is to open another ticket and modify what is done, rather than just removing the checks.  With these changes it's easier for these functions to segfault on incorrect input.
Does this refer to how Cython used to work? Does it make sense to add an `except NULL` to the function definition now? I stumbled upon this while working on #13591.
