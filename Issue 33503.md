# Issue 33503: Add conda dev environment

Issue created by migration from https://trac.sagemath.org/ticket/33740

Original creator: @tobiasdiez

Original creation time: 2022-04-21 12:06:25

CC:  isuruf dimpase saraedum mkoeppe slelievre

We add a conda enviroment that is meant for development, i.e. includes tools that one probably needs while working on sage development such as linters, ssh (for contributing to trac) etc.

Moreover, we commit the auto-generated file in order to simplify the conda workflow as follows:
- install mamba/conda
- git checkout
- mamba create -n sage-dev -f src/environment-dev.yml
- conda activate sage-dev
-  ./bootstrap
- ./configure -withsomething
- pip install --no-build-isolation -v -v --editable pkgs/sage-conf pkgs/sage-setup src


---

Comment by @tobiasdiez created at 2022-04-21 12:08:43

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-04-22 00:11:56

This looks quite odd to me. 
Why can't the yml file in the branch be generated from what's already known about Conda packages?


---

Comment by mkoeppe created at 2022-04-22 00:23:34

I agree, not a good idea to treat this file different from all other of our files that are generated at bootstrap time.

Also `jupyter_sphinx` should really be added by adding a `distros/` file, not ad hoc like this.


---

Comment by @tobiasdiez created at 2022-04-22 09:09:21

Replying to [comment:2 dimpase]:
> This looks quite odd to me. 
> Why can't the yml file in the branch be generated from what's already known about Conda packages?
> 

The issue is not so much to generate the file but how it is used. Running bootstrap requires a few dependencies which however are only specified in the environment file. So its a classical chicken-egg problem. 

Currently this is resolved by requiring the developers to first create a conda env with the necessary tools for `bootstrap`, and then later update the env with all dependencies from the env file. With my proposal the overhead occurs only when dependencies are changed (which then requires to commit the changed env file). Overall this should be less work and more convenient.

> I agree, not a good idea to treat this file different from all other of our files that are generated at bootstrap time. 

The dev environment is special in this respect, since its the only file that you would possibly like to use before the bootstrap.


---

Comment by git created at 2022-04-22 10:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-22 10:12:50

Replying to [comment:3 mkoeppe]:
> Also `jupyter_sphinx` should really be added by adding a `distros/` file, not ad hoc like this.

Done.


---

Comment by dimpase created at 2022-04-22 11:10:54

ok, but please make the initial egg (say, `./bootstrap-conda-dev`) minimal - apart from m4 and other autotools, not much else is needed for `./bootstrap`.


---

Comment by @tobiasdiez created at 2022-04-22 19:39:18

Mhh, having a conda environment just for the bootstrap would also work. But then one still has to run `conda create sage-dev -f bootstrap-conda-dev.yml`, `bootstrap` and `conda sage-dev update -f environment.yml`.

Having one conda environment config containing all necessary tools for bootstrap, compiling and running sage as well as a few additional dev tools is the most convenient, don't you think so?


---

Comment by mkoeppe created at 2022-04-22 19:45:57

Replying to [comment:7 dimpase]:
> ok, but please make the initial egg (say, `./bootstrap-conda-dev`) minimal - apart from m4 and other autotools, not much else is needed for `./bootstrap`.

+1 on just splitting the generation of the yml files from `src/doc/bootstrap` (it doesn't really belong there anyway) into a new script. It won't need any of the dependencies that the full `bootstrap` has.


---

Comment by dimpase created at 2022-04-23 09:59:30

perhaps this should rather become a conda-forge package?


---

Comment by git created at 2022-04-27 17:17:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-27 17:18:12

Replying to [comment:9 mkoeppe]:
> Replying to [comment:7 dimpase]:
> > ok, but please make the initial egg (say, `./bootstrap-conda-dev`) minimal - apart from m4 and other autotools, not much else is needed for `./bootstrap`.
> 
> +1 on just splitting the generation of the yml files from `src/doc/bootstrap` (it doesn't really belong there anyway) into a new script. It won't need any of the dependencies that the full `bootstrap` has.

Like this?


---

Comment by dimpase created at 2022-04-27 17:36:46

that's much nicer, but where is the top-level invocation of `bootstrap-conda`?
Do you mean it's an alternative to `./bootstrap` ?


---

Comment by @tobiasdiez created at 2022-04-27 19:27:24

I wasn't sure about this one. The procedure now looks as follows:
- `bootstrap-conda`
- `conda create`
- `bootstrap`
- `configure`
- ...

So there is no point in invoking `bootstrap-conda` during `bootstrap`.


---

Comment by mkoeppe created at 2022-04-27 19:30:21

Still need to invoke this so that the generated files end up in the sdist.


---

Comment by mkoeppe created at 2022-04-27 19:31:30

(See the shell function `save` in `bootstrap`)


---

Comment by dimpase created at 2022-04-28 09:32:35

Replying to [comment:14 gh-tobiasdiez]:
> I wasn't sure about this one. The procedure now looks as follows:
> - `bootstrap-conda`
> - `conda create`
> - `bootstrap`
> - `configure`
> - ...
> 
> So there is no point in invoking `bootstrap-conda` during `bootstrap`.

I thought that `./bootstrap` recognises whether we're on conda, or not.
If so, it can invoke `bootstrap-conda`+`conda create`.

Otherwise, I'd like to see `./bootstrap` getting an optional argument, `conda`,
to do the calling of `bootstrap-conda`+`conda create` and then proceeding.


---

Comment by mkoeppe created at 2022-04-28 17:49:00

Replying to [comment:17 dimpase]:
> I thought that `./bootstrap` recognises whether we're on conda, or not.

Not a good idea. The output of `bootstrap` must not depend on the system configuration. It is packed into the sdist.


---

Comment by dimpase created at 2022-04-30 17:46:13

shouldn't `./bootstrap-conda` run on `#!/bin/sh`, just like `./bootstrap` ?


---

Comment by mkoeppe created at 2022-05-01 01:36:39

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-05-01 10:17:56

Replying to [comment:19 dimpase]:
> shouldn't `./bootstrap-conda` run on `#!/bin/sh`, just like `./bootstrap` ?

With `sh` the script is not working, so I took `bash` as in `doc/bootstrap`. If that needs to be changed, I need help as its beyond my basic shell script knowledge.


---

Comment by @tobiasdiez created at 2022-05-01 10:21:04

Replying to [comment:17 dimpase]:
> Otherwise, I'd like to see `./bootstrap` getting an optional argument, `conda`,
> to do the calling of `bootstrap-conda`+`conda create` and then proceeding.
> 

I like the idea to further simplify the workflow, but lets keep this ticket small and do further streamlining efforts in #33765.


---

Comment by @tobiasdiez created at 2022-05-01 10:26:27

Replying to [comment:15 mkoeppe]:
> Still need to invoke this so that the generated files end up in the sdist.

Okay, added.


---

Comment by git created at 2022-05-01 11:17:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-01 11:18:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-01 11:20:17

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-05-01 14:12:11

Replying to [comment:21 gh-tobiasdiez]:
> Replying to [comment:19 dimpase]:
> > shouldn't `./bootstrap-conda` run on `#!/bin/sh`, just like `./bootstrap` ?
> 
> With `sh` the script is not working, so I took `bash` as in `doc/bootstrap`. If that needs to be changed, I need help as its beyond my basic shell script knowledge.

did you try http://manpages.ubuntu.com/manpages/bionic/man1/checkbashisms.1.html ?


---

Comment by mkoeppe created at 2022-05-01 16:23:20

In this change:

``` 
-      $ conda create -n sage-build
+      $ conda env create --file environment.yml
       $ conda activate sage-build
```

I would suggest to keep the `-n` so that it's easy to see what needs to be changed if the user wants to use a different name


---

Comment by mkoeppe created at 2022-05-01 16:33:37

The instructions in "Using conda to provide all dependencies for the Sage library (experimental)" are missing `./bootstrap`


---

Comment by mkoeppe created at 2022-05-01 17:21:21

Also `ci-conda.yml` should be updated so it tests the updated instructions


---

Comment by @tobiasdiez created at 2022-05-02 15:02:38

Replying to [comment:28 dimpase]:
> Replying to [comment:21 gh-tobiasdiez]:
> > Replying to [comment:19 dimpase]:
> > > shouldn't `./bootstrap-conda` run on `#!/bin/sh`, just like `./bootstrap` ?
> > 
> > With `sh` the script is not working, so I took `bash` as in `doc/bootstrap`. If that needs to be changed, I need help as its beyond my basic shell script knowledge.
> 
> did you try http://manpages.ubuntu.com/manpages/bionic/man1/checkbashisms.1.html ?

It finds things of the form

```
possible bashism in ./bootstrap-conda line 25 (should be VAR="${VAR}foo"):
                    SYSTEM_PACKAGES+=" $PKG_SYSTEM_PACKAGES"
```

I would say the `+=` construction is more readable.


---

Comment by git created at 2022-05-02 15:09:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-02 15:11:01

Replying to [comment:31 mkoeppe]:
> Also `ci-conda.yml` should be updated so it tests the updated instructions

Good point, done.
https://github.com/sagemath/sagetrac-mirror/actions/runs/2258733820


---

Comment by @tobiasdiez created at 2022-05-02 15:11:16

Replying to [comment:30 mkoeppe]:
> The instructions in "Using conda to provide all dependencies for the Sage library (experimental)" are missing `./bootstrap` 

Done.


---

Comment by dimpase created at 2022-05-02 17:09:38

Replying to [comment:32 gh-tobiasdiez]:
> Replying to [comment:28 dimpase]:
> > Replying to [comment:21 gh-tobiasdiez]:
> > > Replying to [comment:19 dimpase]:
> > > > shouldn't `./bootstrap-conda` run on `#!/bin/sh`, just like `./bootstrap` ?
> > > 
> > > With `sh` the script is not working, so I took `bash` as in `doc/bootstrap`. If that needs to be changed, I need help as its beyond my basic shell script knowledge.
> > 
> > did you try http://manpages.ubuntu.com/manpages/bionic/man1/checkbashisms.1.html ?
> 
> It finds things of the form
> {{{
> possible bashism in ./bootstrap-conda line 25 (should be VAR="${VAR}foo"):
>                     SYSTEM_PACKAGES+=" $PKG_SYSTEM_PACKAGES"
> }}}
> I would say the `+=` construction is more readable.

but why do you think that `/bin/bash` is available everwhere? E.g. on macOS it is probably not the case.


>


---

Comment by @tobiasdiez created at 2022-05-02 18:45:46

I took the bash thing from the original bootstrap script https://github.com/sagemath/sagetrac-mirror/blob/develop/src/doc/bootstrap. But to be honest, I didn't have an idea what I was doing and just mixed different things from the bootstrap scripts until it was working. So I'm totally fine to change it to a more suitable version.


---

Comment by mkoeppe created at 2022-05-02 18:47:14

`git grep '#!.*bash' ` will show the variant that is in general use


---

Comment by mkoeppe created at 2022-05-02 19:23:04

Replying to [comment:34 gh-tobiasdiez]:
> Replying to [comment:31 mkoeppe]:
> > Also `ci-conda.yml` should be updated so it tests the updated instructions
> 
> Good point, done.
> https://github.com/sagemath/sagetrac-mirror/actions/runs/2258733820

It fails. I don't think the two pip command lines can be combined. 

Because of `--no-build-isolation`, the Sage library (`src`) cannot advertise its build dependency, so `pip` cannot possibly know in which order it has to install stuff.


---

Comment by mkoeppe created at 2022-05-03 15:14:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-03 22:08:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-03 22:15:12

Absolutely no, this is not an install-requires.


---

Comment by git created at 2022-05-03 23:15:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-03 23:31:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-04 09:40:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-04 09:44:29

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-05-04 09:44:29

Replying to [comment:39 mkoeppe]:
> Replying to [comment:34 gh-tobiasdiez]:
> > Replying to [comment:31 mkoeppe]:
> > > Also `ci-conda.yml` should be updated so it tests the updated instructions
> > 
> > Good point, done.
> > https://github.com/sagemath/sagetrac-mirror/actions/runs/2258733820
> 
> It fails. I don't think the two pip command lines can be combined. 
> 
> Because of `--no-build-isolation`, the Sage library (`src`) cannot advertise its build dependency, so `pip` cannot possibly know in which order it has to install stuff.

Build isolation shouldn't be an issue since this only decides if pip tries to create a temporary venv or reuses the existing one for the build env, but not what build dependencies to be installed. Could it be that there is some misconfig of the build dependencies?

Anyway, I've reverted this part and would leave it to a new ticket.


---

Comment by mkoeppe created at 2022-05-04 15:33:35

Replying to [comment:47 gh-tobiasdiez]:
> Build isolation shouldn't be an issue 

https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-no-build-isolation
"Disable isolation when building a modern source distribution. Build dependencies specified by PEP 518 must be already installed if this option is used."


---

Comment by mkoeppe created at 2022-05-04 18:22:58

comment:29


---

Comment by mkoeppe created at 2022-05-04 18:25:20

Also, in the edits of the documentation, the information on how to select a Python version have been lost


---

Comment by mkoeppe created at 2022-05-04 18:26:13

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-05-08 08:24:36

Replying to [comment:49 mkoeppe]:
> Replying to [comment:47 gh-tobiasdiez]:
> > Build isolation shouldn't be an issue 
> 
> https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-no-build-isolation
> "Disable isolation when building a modern source distribution. Build dependencies specified by PEP 518 must be already installed if this option is used."

Ahh good to know, then I've remembered it wrong. Thanks for the clarification.


---

Comment by @tobiasdiez created at 2022-05-08 08:25:50

Replying to [comment:29 mkoeppe]:
> In this change:
> {{{ 
> -      $ conda create -n sage-build
> +      $ conda env create --file environment.yml
>        $ conda activate sage-build
> }}}
> I would suggest to keep the `-n` so that it's easy to see what needs to be changed if the user wants to use a different name

Normally the user doesn't need to change the name, and if he does its easy to find on the conda docs how to do this. Thus I don't really see a point in adding an arg that is the same as the default value.


---

Comment by git created at 2022-05-08 08:39:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-08 08:39:59

Replying to [comment:51 mkoeppe]:
> Also, in the edits of the documentation, the information on how to select a Python version have been lost

Added again.


---

Comment by @tobiasdiez created at 2022-05-08 08:39:59

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-08 12:53:12

Replying to [comment:54 gh-tobiasdiez]:
> Replying to [comment:29 mkoeppe]:
> > In this change:
> > {{{ 
> > -      $ conda create -n sage-build
> > +      $ conda env create --file environment.yml
> >        $ conda activate sage-build
> > }}}
> > I would suggest to keep the `-n` so that it's easy to see what needs to be changed if the user wants to use a different name
> 
> Normally the user doesn't need to change the name

It's as normal as having a second installation in a separate directory


---

Comment by @tobiasdiez created at 2022-05-08 21:36:50

Replying to [comment:57 mkoeppe]:
> Replying to [comment:54 gh-tobiasdiez]:
> > Replying to [comment:29 mkoeppe]:
> > > In this change:
> > > {{{ 
> > > -      $ conda create -n sage-build
> > > +      $ conda env create --file environment.yml
> > >        $ conda activate sage-build
> > > }}}
> > > I would suggest to keep the `-n` so that it's easy to see what needs to be changed if the user wants to use a different name
> > 
> > Normally the user doesn't need to change the name
> 
> It's as normal as having a second installation in a separate directory

If you want to install two sages in parallel, you should also be able to find the `--name` arg of conda. But if you insist I can readd the name.


---

Comment by mkoeppe created at 2022-05-08 21:38:11

Yes please. I added it on purpose in the original version.


---

Comment by git created at 2022-05-09 11:47:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-09 11:48:12

Replying to [comment:59 mkoeppe]:
> Yes please. I added it on purpose in the original version.

okay done


---

Comment by mkoeppe created at 2022-05-09 18:31:00

Broken: https://github.com/sagemath/sagetrac-mirror/runs/6356314150


---

Comment by mkoeppe created at 2022-05-09 18:36:50

conda's `pari` is not being accepted.


---

Comment by @tobiasdiez created at 2022-05-09 21:47:46

This is not specific to this branch and also occurs for develop https://github.com/sagemath/sage/runs/6236167749?check_suite_focus=true
I've opened #33828 for this.


---

Comment by mkoeppe created at 2022-05-09 21:50:04

Thanks for checking, I agree. Then it's good to go


---

Comment by mkoeppe created at 2022-05-09 21:50:04

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-05-09 22:41:11

Thanks!


---

Comment by vbraun created at 2022-05-22 16:32:21

Resolution: fixed


---

Comment by slelievre created at 2022-06-28 17:41:17

The changes in this ticket made `./bootstrap -q` less quiet.

Before:

```
$ ./bootstrap -q
```


After:

```
$ ./bootstrap -q
./bootstrap-conda:46: generate conda enviroment files
```


Follow-up at #34097.
