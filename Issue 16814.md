# Issue 16814: Strange bug in poset show()

Issue created by migration from https://trac.sagemath.org/ticket/17051

Original creator: jmantysalo

Original creation time: 2014-09-26 21:30:55

CC:  ncohen

This seems to trigger some kind of error:


```
P1=Posets.ChainPoset(3)
P2=Posets.PentagonPoset().relabel(lambda x: x+10)
P=Poset( (P1.list()+P2.list(), P1.cover_relations()+P2.cover_relations()) )
P.show()
```


Error message is `ValueError: element (=2) not in poset`. If I change 2. line to


```
P2=Posets.ChainPoset(5).relabel(lambda x: x+10)
```


error disappears.


---

Comment by jmantysalo created at 2014-09-27 06:17:06

Is this related to #14019? You don't get same error message if you say `P.cover_relations()` and then manually make same poset. So there is something with `relabel()` happening.


---

Comment by ncohen created at 2014-09-27 10:19:35

Okay, I'll add a message in #14019, they have been wasting my time for long enough.


---

Comment by jmantysalo created at 2014-09-27 15:08:26

On discussion at #14019 tscrim wasn't sure if this relates to same relabeling thing or not. I move this to wontfix-milestone, but will not marked as positive review yet.


---

Comment by jmantysalo created at 2014-09-27 15:35:47

More about this. Problem is that `type(Posets.PentagonPoset().list()[0])` is `sage.combinat.posets.elements.FiniteLatticePoset_with_category.element_class`, whereas for example `type(Posets.RandomPoset(1,0).list()[0])` is `sage.rings.integer.Integer`. Problem can be seen for example by


```
P1=Posets.PentagonPoset()
P2=Poset({'a':['b','c']})
P=Poset( (P1.list()+P2.list(), []) )
P.show()
```



---

Comment by jmantysalo created at 2014-09-27 15:40:38

More fun:


```
x=Poset(Posets.PentagonPoset().hasse_diagram()).list()[1]
print x
print x+1
```


outputs


```
2
4
```



---

Comment by ncohen created at 2014-09-28 08:03:15

I HATE THIS CODE. You cannot for one second even trust that it does what you think it should do.

Okay, that's because there is in Poset(....) a keyword named "facade" (not how clearly it indicates what it does) that changes the type of the things inside of the poset.


```
sage: d = DiGraph({0:[1]})
sage: map(type,Poset(d))
[sage.rings.integer.Integer, sage.rings.integer.Integer]
sage: map(type,Poset(d,facade=False))
[sage.combinat.posets.elements.FinitePoset_with_category.element_class,
 sage.combinat.posets.elements.FinitePoset_with_category.element_class]
```


I had to fight a looooong time ago to obtain that facade becomes True by defaut in Posets. And now it is, but for some stupid reason the constructor of PentagonalPoset enforces facade=False. So the code should only be changed to follow the same default as the Poset constructor. Or even to remove this keyword in PentagonalPoset, or replace it with `**kwds`... Anything `-_-`

By the way: the real explanation is that the + has been changed to mean "join" or "meet". It is not had to find out: take your 'x' as you defined it and type 'x.__add__'.

Nathann


---

Comment by jmantysalo created at 2014-09-28 19:32:55

I also removed part of documentation; it seems to better suited for `is_distributive()`.
----
New commits:


---

Comment by jmantysalo created at 2014-09-28 19:32:55

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-09-28 21:15:05

The same thing happens with `DiamontPoset` just afterwards.

Nathann


---

Comment by git created at 2014-09-29 04:51:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-09-29 08:10:54

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-09-29 08:10:54

Helloooooooooooooo !

Seems good, but why did you remove that doc ? 

Also, could you mention this `n>=3` in the doc of DiamondPoset ?

Thanks,

Nathann


---

Comment by git created at 2014-09-29 11:02:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-09-29 11:05:17

Replying to [comment:14 ncohen]:

> Seems good, but why did you remove that doc ? 

I think that it was irrelevant in this context. Also note about `DiamondPoset` seems to be at wrong place inside docstring of `PentagonPoset`.

> Also, could you mention this `n>=3` in the doc of DiamondPoset ?

Done. Should have noticed this myself.


---

Comment by jmantysalo created at 2014-09-29 11:05:17

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-09-29 11:37:06

Hello !

> I think that it was irrelevant in this context. Also note about `DiamondPoset` seems to be at wrong place inside docstring of `PentagonPoset`.

Why do you think that it is irrelevant here ? It is a docstring about an object, so why don't we show its nice properties ? This sage software is all about checking on computers what we can prove on paper anyway `:-)`

Nathann


---

Comment by git created at 2014-09-29 18:45:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-09-29 18:47:26

Changing status from needs_review to needs_work.


---

Comment by jmantysalo created at 2014-09-29 18:47:26

OK, I added an example. Not the same, thought.


---

Comment by jmantysalo created at 2014-09-29 18:48:06

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-09-30 08:39:48

Hello !

I added a small commit on top of yours. What it does :

1) Remove the `"` in the first line of doc of the `PentagonPoset` constructor.

2) Improve the doc of the `facade` keyword

3) Bring the former doctest back. The point is that doctests are not only useful to the users, but also to test our own code. I can't tell you how many bugs are avoided just because there is always a doctest somewhere that tests the corner case you did not think about. If we ever change the data structure of Posets, do anything in the graphs backends, those doctests are the only way we have to make sure everything is holding together.

4) Changing the default value of facade was breaking doctests in another file, so I updated them. In order to check the doctests use `sage -b && sage -tp <num_of_cpu> -l file_or_directory`

I will also create a ticket to ask Nicolas to write some documentation about `Facade`, because right now there is none to find.

Set this ticket to `positive_review` if you agree with the changes.

Nathann


---

Comment by ncohen created at 2014-09-30 08:40:16

New commits:


---

Comment by git created at 2014-09-30 08:41:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2014-09-30 08:42:34

I had forgotten a detail: it is better to make the default value of `facade` be equal to `None`, as it means "use the same default as in `Poset()`. We should not have to repeat the default value everywhere. That's why we had the problem in the first place.

Nathann


---

Comment by ncohen created at 2014-09-30 08:44:03

(just created #17073 about the documentation of Facade)


---

Comment by jmantysalo created at 2014-09-30 10:50:50

Seems reasonable --> positive_review.


---

Comment by jmantysalo created at 2014-09-30 10:50:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-02 16:22:02

Resolution: fixed
