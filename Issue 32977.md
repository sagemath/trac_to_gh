# Issue 32977: Vélu isogeny formulas use incorrect a-invariants when pre-isomorphism is set

Issue created by migration from https://trac.sagemath.org/ticket/33214

Original creator: lorenz

Original creation time: 2022-01-22 04:24:51

CC:  cremona wuthrich defeo

With Sage 9.5.rc3:

```
sage: E = EllipticCurve(GF(71^2), [5,5])
sage: phi = E.isogeny(E.lift_x(0))
sage: E1 = E.change_weierstrass_model(9,8,7,6)
sage: phi = phi * E1.isomorphism_to(E)
sage: P = E1.lift_x(1)
sage: P in phi.domain()
True
sage: phi(P)
---------------------------------------------------------------------------

# ...

~/prg/sage/src/sage/schemes/elliptic_curves/ell_curve_isogeny.py in _call_(self, P)
   1182             outP = (tempX, tempY)
   1183
-> 1184         return self.__E2(outP)
   1185
   1186     def __getitem__(self, i):

# ...

TypeError: Coordinates [46, 3*z2 + 44, 1] do not define a point on Elliptic Curve defined by y^2 = x^3 + 5*x + 5 over Finite Field in z2 of size 71^2
```


The reason is the following code in `EllipticCurveIsogeny.__compute_via_velu()`:

```
        a1 = self.__E1.a1()
        a3 = self.__E1.a3()
```

Here, `.__E1` is the same as `.domain()`, but the Vélu formulas compute the "inner" isogeny. Thus, these should be the `a1,a3` constants of the pre-isomorphism codomain.


---

Comment by lorenz created at 2022-01-22 04:33:32

Changing status from new to needs_review.


---

Comment by lorenz created at 2022-01-22 04:33:32

New commits:


---

Comment by chapoton created at 2022-03-27 19:00:44

looks good to me, and simple enough

John or Luca, do you approve ?


---

Comment by cremona created at 2022-03-28 15:38:19

Well spotted, sounds very reasonable.  Can you add something to the doctest which makes it clear that this is correct in the example, while the same code pre-patch is not?  Some assertion which would fail before?  Perhaps composing with a dual and checking that the composite multiplies by the degree?  That way people can see that this is correct, without having to do some hard computations to verify.


---

Comment by git created at 2022-03-29 03:51:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-03-29 03:57:54

Thanks! I just added another test to verify that the rational maps of the isogeny with pre-isomorphism satisfy the (co)domain curve equations. (The rational maps are internally computed by evaluating the isogeny at a generic point, i.e., it uses the same code path that is corrected here.) Both tests fail with a current Sage and pass after this patch.


---

Comment by cremona created at 2022-03-29 09:40:53

Replying to [comment:5 lorenz]:
> Thanks! I just added another test to verify that the rational maps of the isogeny with pre-isomorphism satisfy the (co)domain curve equations. (The rational maps are internally computed by evaluating the isogeny at a generic point, i.e., it uses the same code path that is corrected here.) Both tests fail with a current Sage and pass after this patch.

That's great, just what I was suggesting.


---

Comment by cremona created at 2022-03-29 09:40:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-04-02 10:53:19

Resolution: fixed
