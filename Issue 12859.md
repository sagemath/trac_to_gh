# Issue 12859: Use cythonize() from cython for Sage module building.

archive/issues_012859.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @jdemeyer @roed314 @ohanar @ppurka @kini @mwhansen\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13031\n\n",
    "created_at": "2012-05-27T12:02:04Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Use cythonize() from cython for Sage module building.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12859",
    "user": "https://github.com/robertwb"
}
```
Assignee: GeorgSWeber

CC:  @jdemeyer @roed314 @ohanar @ppurka @kini @mwhansen



Issue created by migration from https://trac.sagemath.org/ticket/13031





---

archive/issue_comments_154384.json:
```json
{
    "body": "Attachment [13031-cythonize.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize.patch) by @robertwb created at 2012-05-27 12:02:21",
    "created_at": "2012-05-27T12:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154384",
    "user": "https://github.com/robertwb"
}
```

Attachment [13031-cythonize.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize.patch) by @robertwb created at 2012-05-27 12:02:21



---

archive/issue_comments_154385.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-27T12:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154385",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_154386.json:
```json
{
    "body": "Is the patch based against sage-5.1beta0? I upgraded a sage installation from sage-5.0rc0 to sage-5.1beta0 and it fails to apply there. I will try a sage-5.1beta0 tarball sometime later.",
    "created_at": "2012-05-27T14:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154386",
    "user": "https://github.com/ppurka"
}
```

Is the patch based against sage-5.1beta0? I upgraded a sage installation from sage-5.0rc0 to sage-5.1beta0 and it fails to apply there. I will try a sage-5.1beta0 tarball sometime later.



---

archive/issue_comments_154387.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd40.5\".",
    "created_at": "2012-05-27T23:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154387",
    "user": "https://github.com/mwhansen"
}
```

Changing keywords from "" to "sd40.5".



---

archive/issue_comments_154388.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-27T23:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154388",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154389.json:
```json
{
    "body": "Changing to needs work since -- as mentioned above -- this doesn't apply to sage-5.1.beta0:\n\n```\n\nadding 13031-cythonize.patch to series file\napplying 13031-cythonize.patch\npatching file module_list.py\nHunk #1 FAILED at 144\nHunk #3 FAILED at 223\nHunk #13 FAILED at 834\nHunk #16 FAILED at 1475\nHunk #20 succeeded at 1698 with fuzz 2 (offset 75 lines).\nHunk #21 succeeded at 1712 with fuzz 2 (offset 79 lines).\n4 out of 22 hunks FAILED -- saving rejects to file module_list.py.rej\npatching file setup.py\nHunk #1 succeeded at 17 with fuzz 2 (offset 0 lines).\nHunk #3 FAILED at 513\n1 out of 3 hunks FAILED -- saving rejects to file setup.py.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh 13031-cythonize.patch\nwstein@sage:/tmp/wstein/sage-5.1.beta0-boxen-x86_64-Linux/devel/sage/sage$ \n```\n",
    "created_at": "2012-05-27T23:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154389",
    "user": "https://github.com/williamstein"
}
```

Changing to needs work since -- as mentioned above -- this doesn't apply to sage-5.1.beta0:

```

adding 13031-cythonize.patch to series file
applying 13031-cythonize.patch
patching file module_list.py
Hunk #1 FAILED at 144
Hunk #3 FAILED at 223
Hunk #13 FAILED at 834
Hunk #16 FAILED at 1475
Hunk #20 succeeded at 1698 with fuzz 2 (offset 75 lines).
Hunk #21 succeeded at 1712 with fuzz 2 (offset 79 lines).
4 out of 22 hunks FAILED -- saving rejects to file module_list.py.rej
patching file setup.py
Hunk #1 succeeded at 17 with fuzz 2 (offset 0 lines).
Hunk #3 FAILED at 513
1 out of 3 hunks FAILED -- saving rejects to file setup.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh 13031-cythonize.patch
wstein@sage:/tmp/wstein/sage-5.1.beta0-boxen-x86_64-Linux/devel/sage/sage$ 
```




---

archive/issue_comments_154390.json:
```json
{
    "body": "Would you please make the following change:\n\n```diff\n--- a\n+++ b\n@@ -1,1 +1,5 @@\n-ext_modules = cythonize(ext_modules, exclude=exclude_modules, nthreads=nthreads, cache=os.path.join(DOT_SAGE, 'cythoncache')))\n+if 'CYCACHE_DIR' in os.environ:\n+    CYCACHE_DIR = os.environ['CYCACHE_DIR']\n+else:\n+    CYCACHE_DIR = os.path.join(DOT_SAGE,'cycache')\n+ext_modules = cythonize(ext_modules, exclude=exclude_modules, nthreads=nthreads, cache=CYCACHE_DIR))\n```\n\nThis way we can easily specify the cache directory separately from `DOT_SAGE`.",
    "created_at": "2012-05-28T02:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154390",
    "user": "https://github.com/ohanar"
}
```

Would you please make the following change:

```diff
--- a
+++ b
@@ -1,1 +1,5 @@
-ext_modules = cythonize(ext_modules, exclude=exclude_modules, nthreads=nthreads, cache=os.path.join(DOT_SAGE, 'cythoncache')))
+if 'CYCACHE_DIR' in os.environ:
+    CYCACHE_DIR = os.environ['CYCACHE_DIR']
+else:
+    CYCACHE_DIR = os.path.join(DOT_SAGE,'cycache')
+ext_modules = cythonize(ext_modules, exclude=exclude_modules, nthreads=nthreads, cache=CYCACHE_DIR))
```

This way we can easily specify the cache directory separately from `DOT_SAGE`.



---

archive/issue_comments_154391.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-29T06:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154391",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154392.json:
```json
{
    "body": "Attachment [13031-cythonize-5.1.beta1.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-5.1.beta1.patch) by @ohanar created at 2012-05-29 09:11:00",
    "created_at": "2012-05-29T09:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154392",
    "user": "https://github.com/ohanar"
}
```

Attachment [13031-cythonize-5.1.beta1.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-5.1.beta1.patch) by @ohanar created at 2012-05-29 09:11:00



---

archive/issue_comments_154393.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-06-07T11:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154393",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154394.json:
```json
{
    "body": "Attachment [13031-cythonize-5.1.beta2.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-5.1.beta2.patch) by @ohanar created at 2012-06-07 11:18:07\n\nI attached an updated patch that\n* is rebased on the final 5.1.beta2\n* fixes a `ZeroDivisionError` that was preventing documentation from building\n* more throughly cleans up `module_list.py` with the use of *s\n* does other clean up with `module_list.py` since this patch will constantly need to be rebased with each development release (may as well clean up everything while we are at it)\n\nThat said, there is still some issue with Cython's cythonize, even using the old `module_list.py` you encounter the issue:\n\n```\nsage: cython('a = 5')\nsage: a\nTraceback (most recent call last):\n...\nNameError: name 'a' is not defined\n```\n\n\nYou'll find that tons of doctests fail, and frequently they are having `NameError`s like this (although they aren't necessarily calling Sage's cython function).",
    "created_at": "2012-06-07T11:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154394",
    "user": "https://github.com/ohanar"
}
```

Attachment [13031-cythonize-5.1.beta2.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-5.1.beta2.patch) by @ohanar created at 2012-06-07 11:18:07

I attached an updated patch that
* is rebased on the final 5.1.beta2
* fixes a `ZeroDivisionError` that was preventing documentation from building
* more throughly cleans up `module_list.py` with the use of *s
* does other clean up with `module_list.py` since this patch will constantly need to be rebased with each development release (may as well clean up everything while we are at it)

That said, there is still some issue with Cython's cythonize, even using the old `module_list.py` you encounter the issue:

```
sage: cython('a = 5')
sage: a
Traceback (most recent call last):
...
NameError: name 'a' is not defined
```


You'll find that tons of doctests fail, and frequently they are having `NameError`s like this (although they aren't necessarily calling Sage's cython function).



---

archive/issue_comments_154395.json:
```json
{
    "body": "Thanks for looking at this. I fixed the patch, Sage relies on a deprecated \"feature\" of globals(). Running all tests...",
    "created_at": "2012-06-23T09:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154395",
    "user": "https://github.com/robertwb"
}
```

Thanks for looking at this. I fixed the patch, Sage relies on a deprecated "feature" of globals(). Running all tests...



---

archive/issue_comments_154396.json:
```json
{
    "body": "FYI, all tests passed for me.",
    "created_at": "2012-06-23T17:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154396",
    "user": "https://github.com/robertwb"
}
```

FYI, all tests passed for me.



---

archive/issue_comments_154397.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-06-25T03:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154397",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154398.json:
```json
{
    "body": "Ok, looks good to me and works well with 5.1.beta2, so I'm going to mark this back as needing review.\n\nAs expected, it needs to be rebased again on more recent betas, but since the changes to `module_list.py` is so massive, I'm not going to bother with rebasing until Jeroen decides which beta he would like to merge it in.\n\nFor whoever reviews this, please use 5.1.beta2 as a basis.",
    "created_at": "2012-06-25T03:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154398",
    "user": "https://github.com/ohanar"
}
```

Ok, looks good to me and works well with 5.1.beta2, so I'm going to mark this back as needing review.

As expected, it needs to be rebased again on more recent betas, but since the changes to `module_list.py` is so massive, I'm not going to bother with rebasing until Jeroen decides which beta he would like to merge it in.

For whoever reviews this, please use 5.1.beta2 as a basis.



---

archive/issue_comments_154399.json:
```json
{
    "body": "The new patch fixes an issue with `DOT_SAGE` not being defined in `setup.py`.",
    "created_at": "2012-07-01T10:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154399",
    "user": "https://github.com/ohanar"
}
```

The new patch fixes an issue with `DOT_SAGE` not being defined in `setup.py`.



---

archive/issue_comments_154400.json:
```json
{
    "body": "Rather than code like this:\n\n```\nif not os.path.exists(cache_dir): \n   os.mkdir(cache_dir) \n```\n\nyou should use `sage.misc.misc.sage_makedirs` (or copy-paste the code from there). A try-except block is safer than testing whether than the directory exists first.",
    "created_at": "2012-07-01T15:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154400",
    "user": "https://github.com/jhpalmieri"
}
```

Rather than code like this:

```
if not os.path.exists(cache_dir): 
   os.mkdir(cache_dir) 
```

you should use `sage.misc.misc.sage_makedirs` (or copy-paste the code from there). A try-except block is safer than testing whether than the directory exists first.



---

archive/issue_comments_154401.json:
```json
{
    "body": "I just rebased on 5.2.beta1 since the dependency was merged into that release. However, in the process I discovered that cycache is not ready for primetime yet:\n\n```\n$ grep 'cdef class MonoDict:' sage -R\nsage/sets/disjoint_set.c: * cdef class MonoDict:             # <<<<<<<<<<<<<<\nsage/matrix/matrix_modn_dense_float.cpp: * cdef class MonoDict:             # <<<<<<<<<<<<<<\n```\n\nNeither of these modules changed between 5.1.beta2 and 5.2.beta1, but their dependencies changed, so there is some issue with the hashing that needs to be resolved.\n\nFor now I've disabled cycache, since it will be trivial to re-add once this ticket gets merged.",
    "created_at": "2012-07-14T05:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154401",
    "user": "https://github.com/ohanar"
}
```

I just rebased on 5.2.beta1 since the dependency was merged into that release. However, in the process I discovered that cycache is not ready for primetime yet:

```
$ grep 'cdef class MonoDict:' sage -R
sage/sets/disjoint_set.c: * cdef class MonoDict:             # <<<<<<<<<<<<<<
sage/matrix/matrix_modn_dense_float.cpp: * cdef class MonoDict:             # <<<<<<<<<<<<<<
```

Neither of these modules changed between 5.1.beta2 and 5.2.beta1, but their dependencies changed, so there is some issue with the hashing that needs to be resolved.

For now I've disabled cycache, since it will be trivial to re-add once this ticket gets merged.



---

archive/issue_comments_154402.json:
```json
{
    "body": "Yes, I think it's perfectly fine to disable cycache for now to get this in (as it will then be much easier to work on). Could you expound on what the issue was though? I'm not quite following your grep is trying to show...",
    "created_at": "2012-07-14T08:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154402",
    "user": "https://github.com/robertwb"
}
```

Yes, I think it's perfectly fine to disable cycache for now to get this in (as it will then be much easier to work on). Could you expound on what the issue was though? I'm not quite following your grep is trying to show...



---

archive/issue_comments_154403.json:
```json
{
    "body": "Replying to [comment:15 robertwb]:\n> Yes, I think it's perfectly fine to disable cycache for now to get this in (as it will then be much easier to work on). Could you expound on what the issue was though? I'm not quite following your grep is trying to show...\n\nThe grep is of some cython code that existed in 5.1.beta2 in `sage/structure/coerce_dict.pxd`, that is no longer present in 5.2.beta1. However, cython detected that I had a cached version of the `disjoint_set` module (which didn't change between versions, but imports the `coerce_dict` module) and incorrectly pulls the the cached version of `disjoint_set.c` when it actually needs to rebuild it since `coerce_dict.pxd` changed (same situation for the other module in the grep).",
    "created_at": "2012-07-14T08:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154403",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:15 robertwb]:
> Yes, I think it's perfectly fine to disable cycache for now to get this in (as it will then be much easier to work on). Could you expound on what the issue was though? I'm not quite following your grep is trying to show...

The grep is of some cython code that existed in 5.1.beta2 in `sage/structure/coerce_dict.pxd`, that is no longer present in 5.2.beta1. However, cython detected that I had a cached version of the `disjoint_set` module (which didn't change between versions, but imports the `coerce_dict` module) and incorrectly pulls the the cached version of `disjoint_set.c` when it actually needs to rebuild it since `coerce_dict.pxd` changed (same situation for the other module in the grep).



---

archive/issue_comments_154404.json:
```json
{
    "body": "OK, rebased. Be nice if someone reviewed this soon.",
    "created_at": "2012-09-05T22:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154404",
    "user": "https://github.com/ohanar"
}
```

OK, rebased. Be nice if someone reviewed this soon.



---

archive/issue_comments_154405.json:
```json
{
    "body": "This probably should be rebased to #13164 and #12883.",
    "created_at": "2012-09-06T05:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154405",
    "user": "https://github.com/jdemeyer"
}
```

This probably should be rebased to #13164 and #12883.



---

archive/issue_comments_154406.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> This probably should be rebased to #13164 and #12883.\nI'll do that once they are merged. This ticket so heavily affects `module_list.py` that I would rather get this reviewed on some clean development build, and then try to figure out with you what tickets I'll need to rebase against to merge this into whatever beta you feel is appropriate. Since this has been waiting review for a bit, I rather not jump the gun and start rebasing against things that haven't been merged yet.",
    "created_at": "2012-09-06T09:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154406",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:18 jdemeyer]:
> This probably should be rebased to #13164 and #12883.
I'll do that once they are merged. This ticket so heavily affects `module_list.py` that I would rather get this reviewed on some clean development build, and then try to figure out with you what tickets I'll need to rebase against to merge this into whatever beta you feel is appropriate. Since this has been waiting review for a bit, I rather not jump the gun and start rebasing against things that haven't been merged yet.



---

archive/issue_comments_154407.json:
```json
{
    "body": "This seems to cause Sphinx problems:\n\n```\n/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.clear_mpz_globals: Could not parse cython argspec\n/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.gmp_randrange: Could not parse cython argspec\n/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.init_mpz_globals: Could not parse cython argspec\n```\n",
    "created_at": "2012-09-06T12:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154407",
    "user": "https://github.com/jdemeyer"
}
```

This seems to cause Sphinx problems:

```
/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.clear_mpz_globals: Could not parse cython argspec
/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.gmp_randrange: Could not parse cython argspec
/release/merger/sage-5.4.beta1/devel/sage/doc/en/reference/sage/modular/modform/eis_series_cython.rst:11: WARNING: error while formatting signature for sage.modular.modform.eis_series_cython.init_mpz_globals: Could not parse cython argspec
```




---

archive/issue_comments_154408.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-09-06T12:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154408",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154409.json:
```json
{
    "body": "Can you please clarify what command you ran?",
    "created_at": "2012-09-10T21:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154409",
    "user": "https://github.com/ohanar"
}
```

Can you please clarify what command you ran?



---

archive/issue_comments_154410.json:
```json
{
    "body": "Replying to [comment:21 ohanar]:\n> Can you please clarify what command you ran?\nThis is build from scratch, so it's just `make doc`.  This is probably equivalent to removing the `doc/output` directory and then doing `make doc`.",
    "created_at": "2012-09-11T06:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154410",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 ohanar]:
> Can you please clarify what command you ran?
This is build from scratch, so it's just `make doc`.  This is probably equivalent to removing the `doc/output` directory and then doing `make doc`.



---

archive/issue_comments_154411.json:
```json
{
    "body": "apply to sage library",
    "created_at": "2012-09-12T21:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154411",
    "user": "https://github.com/ohanar"
}
```

apply to sage library



---

archive/issue_comments_154412.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-09-12T21:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154412",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154413.json:
```json
{
    "body": "Attachment [trac13031.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031.patch) by @ohanar created at 2012-09-12 21:44:18\n\nOk, rebased on 5.4.beta1.\n\nThe issue with sphinx seems to be because of the python functions defined in `sage/ext/gmp.pxi`. We probably shouldn't have any python function defined in pxi files anyway (since we currently aren't checking them for coverage or anything). There are python functions in other pxi files, but they aren't causing any issues for some reason (Robert, maybe you could explain why?).\n\nAnyway, for right now I removed one of them (that wasn't being used anywhere), and I moved the other two to `sage/rings/integer.pyx` since that is where the sage library looks for them.",
    "created_at": "2012-09-12T21:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154413",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac13031.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031.patch) by @ohanar created at 2012-09-12 21:44:18

Ok, rebased on 5.4.beta1.

The issue with sphinx seems to be because of the python functions defined in `sage/ext/gmp.pxi`. We probably shouldn't have any python function defined in pxi files anyway (since we currently aren't checking them for coverage or anything). There are python functions in other pxi files, but they aren't causing any issues for some reason (Robert, maybe you could explain why?).

Anyway, for right now I removed one of them (that wasn't being used anywhere), and I moved the other two to `sage/rings/integer.pyx` since that is where the sage library looks for them.



---

archive/issue_comments_154414.json:
```json
{
    "body": "Attachment [13031-cythonize-simple.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-simple.patch) by @robertwb created at 2013-01-28 22:32:15\n\napply only this patch",
    "created_at": "2013-01-28T22:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154414",
    "user": "https://github.com/robertwb"
}
```

Attachment [13031-cythonize-simple.patch](tarball://root/attachments/some-uuid/ticket13031/13031-cythonize-simple.patch) by @robertwb created at 2013-01-28 22:32:15

apply only this patch



---

archive/issue_comments_154415.json:
```json
{
    "body": "OK, I've changed this to **only** switch to use cythonize and get rid of the sphinx errors. All the other changes make this fail to apply with each new Sage release, and it's a pain to constantly re-base. Once this is in, we can fix up the module list piecemeal and do other cleanup (though I'm unconvinced writing `os.path.join('sage','rings','padics','*.pyx')` is really preferable to `\"sage/rings/padics/*.pyx\"`) as was introduced in the latest rebase.",
    "created_at": "2013-01-28T22:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154415",
    "user": "https://github.com/robertwb"
}
```

OK, I've changed this to **only** switch to use cythonize and get rid of the sphinx errors. All the other changes make this fail to apply with each new Sage release, and it's a pain to constantly re-base. Once this is in, we can fix up the module list piecemeal and do other cleanup (though I'm unconvinced writing `os.path.join('sage','rings','padics','*.pyx')` is really preferable to `"sage/rings/padics/*.pyx"`) as was introduced in the latest rebase.



---

archive/issue_comments_154416.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-29T22:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154416",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_154417.json:
```json
{
    "body": "Everything looks good and works well.",
    "created_at": "2013-01-29T22:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154417",
    "user": "https://github.com/ohanar"
}
```

Everything looks good and works well.



---

archive/issue_comments_154418.json:
```json
{
    "body": "There is trouble with upgrading:\n\nOn rosemary (Linux RHEL 5.6 x86_64), after upgrading from sage-4.5.2, I get a failure during the installation of the Conway spkg:\n\n```\nTraceback (most recent call last):\n  File \"./spkg-install\", line 4, in <module>\n    from sage.all import save\n  File \"/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/all.py\", line 74, in <module>\n    from sage.matrix.all     import *\n  File \"/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/matrix/all.py\", line 1, in <module>\n    from matrix_space import MatrixSpace, is_MatrixSpace\n  File \"/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 33, in <module>\n    import matrix\n  File \"matrix.pyx\", line 1, in init sage.matrix.matrix (sage/matrix/matrix.c:2043)\n  File \"matrix2.pyx\", line 1, in init sage.matrix.matrix2 (sage/matrix/matrix2.c:71233)\n  File \"matrix1.pyx\", line 1, in init sage.matrix.matrix1 (sage/matrix/matrix1.c:13429)\n  File \"mutability.pxd\", line 15, in init sage.matrix.matrix0 (sage/matrix/matrix0.c:29523)\nValueError: PyCapsule_GetPointer called with invalid PyCapsule object\n```\n\n\nRunning `./sage -ba-force` fixes this.",
    "created_at": "2013-02-04T10:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154418",
    "user": "https://github.com/jdemeyer"
}
```

There is trouble with upgrading:

On rosemary (Linux RHEL 5.6 x86_64), after upgrading from sage-4.5.2, I get a failure during the installation of the Conway spkg:

```
Traceback (most recent call last):
  File "./spkg-install", line 4, in <module>
    from sage.all import save
  File "/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/all.py", line 74, in <module>
    from sage.matrix.all     import *
  File "/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/matrix/all.py", line 1, in <module>
    from matrix_space import MatrixSpace, is_MatrixSpace
  File "/home/buildbot/build/sage/rosemary-1/rosemary_upgrade_4.5.2/build/sage-5.7.beta3/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 33, in <module>
    import matrix
  File "matrix.pyx", line 1, in init sage.matrix.matrix (sage/matrix/matrix.c:2043)
  File "matrix2.pyx", line 1, in init sage.matrix.matrix2 (sage/matrix/matrix2.c:71233)
  File "matrix1.pyx", line 1, in init sage.matrix.matrix1 (sage/matrix/matrix1.c:13429)
  File "mutability.pxd", line 15, in init sage.matrix.matrix0 (sage/matrix/matrix0.c:29523)
ValueError: PyCapsule_GetPointer called with invalid PyCapsule object
```


Running `./sage -ba-force` fixes this.



---

archive/issue_comments_154419.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-02-04T10:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154419",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_154420.json:
```json
{
    "body": "Are old-style Cython modules and new-style Cython modules (made with `cythonize()`) compatible?  If yes, the problem is probably with dependency checking (some modules should be rebuilt but aren't).",
    "created_at": "2013-02-04T10:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154420",
    "user": "https://github.com/jdemeyer"
}
```

Are old-style Cython modules and new-style Cython modules (made with `cythonize()`) compatible?  If yes, the problem is probably with dependency checking (some modules should be rebuilt but aren't).



---

archive/issue_comments_154421.json:
```json
{
    "body": "Thanks to some sed magic, this is a list of modules rebuilt in sage-5.7.beta2 but which were not rebuilt with this ticket:\n\n```\nsage/combinat/words/word_datatypes.pyx\nsage/ext/interactive_constructors_c.pyx\nsage/games/sudoku_backtrack.pyx\nsage/media/channels.pyx\nsage/misc/refcount.pyx\nsage/misc/search.pyx\nsage/quadratic_forms/quadratic_form__evaluate.pyx\nsage/rings/polynomial/symmetric_reduction.pyx\nsage/structure/mutability.pyx\n```\n\n\nIn the sage-5.7.beta2 log file, there is\n\n```\nBuilding modified file sage/combinat/words/word_datatypes.pyx.\nBuilding modified file sage/ext/interactive_constructors_c.pyx.\nBuilding modified file sage/games/sudoku_backtrack.pyx.\nBuilding modified file sage/media/channels.pyx.\nBuilding modified file sage/misc/refcount.pyx.\nBuilding modified file sage/misc/search.pyx.\nBuilding modified file sage/quadratic_forms/quadratic_form__evaluate.pyx.\nBuilding modified file sage/rings/polynomial/symmetric_reduction.pyx.\nBuilding modified file sage/structure/mutability.pyx.\n```\n\n\nIn the log file with #13031, there is no mention of any of these files.",
    "created_at": "2013-02-04T11:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154421",
    "user": "https://github.com/jdemeyer"
}
```

Thanks to some sed magic, this is a list of modules rebuilt in sage-5.7.beta2 but which were not rebuilt with this ticket:

```
sage/combinat/words/word_datatypes.pyx
sage/ext/interactive_constructors_c.pyx
sage/games/sudoku_backtrack.pyx
sage/media/channels.pyx
sage/misc/refcount.pyx
sage/misc/search.pyx
sage/quadratic_forms/quadratic_form__evaluate.pyx
sage/rings/polynomial/symmetric_reduction.pyx
sage/structure/mutability.pyx
```


In the sage-5.7.beta2 log file, there is

```
Building modified file sage/combinat/words/word_datatypes.pyx.
Building modified file sage/ext/interactive_constructors_c.pyx.
Building modified file sage/games/sudoku_backtrack.pyx.
Building modified file sage/media/channels.pyx.
Building modified file sage/misc/refcount.pyx.
Building modified file sage/misc/search.pyx.
Building modified file sage/quadratic_forms/quadratic_form__evaluate.pyx.
Building modified file sage/rings/polynomial/symmetric_reduction.pyx.
Building modified file sage/structure/mutability.pyx.
```


In the log file with #13031, there is no mention of any of these files.



---

archive/issue_comments_154422.json:
```json
{
    "body": "Files related to `mutability.pyx` after building Sage with #13031:\n\n```\n-rwxr-xr-x 1 buildbot buildbot 52116 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/lib.linux-x86_64-2.7/sage/structure/mutability.so\n-rwxr-xr-x 1 buildbot buildbot 52116 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/sage/structure/mutability.so\n-rw-r--r-- 1 buildbot buildbot 68728 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/temp.linux-x86_64-2.7/sage/structure/mutability.o\n-rw-r--r-- 1 buildbot buildbot   207 2012-08-23 12:00:08.000000000 -0400 ./devel/sage-main/doc/en/reference/sage/structure/mutability.rst\n-rw-r--r-- 1 buildbot buildbot 71416 2012-08-23 11:33:21.000000000 -0400 ./devel/sage-main/sage/structure/mutability.c\n-rw-r--r-- 1 buildbot buildbot   529 2010-06-28 12:37:01.000000000 -0400 ./devel/sage-main/sage/structure/mutability.pxd\n-rw-r--r-- 1 buildbot buildbot  2062 2012-08-23 11:22:27.000000000 -0400 ./devel/sage-main/sage/structure/mutability.pyx\n```\n",
    "created_at": "2013-02-04T11:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154422",
    "user": "https://github.com/jdemeyer"
}
```

Files related to `mutability.pyx` after building Sage with #13031:

```
-rwxr-xr-x 1 buildbot buildbot 52116 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/lib.linux-x86_64-2.7/sage/structure/mutability.so
-rwxr-xr-x 1 buildbot buildbot 52116 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/sage/structure/mutability.so
-rw-r--r-- 1 buildbot buildbot 68728 2013-02-04 04:32:19.000000000 -0500 ./devel/sage-main/build/temp.linux-x86_64-2.7/sage/structure/mutability.o
-rw-r--r-- 1 buildbot buildbot   207 2012-08-23 12:00:08.000000000 -0400 ./devel/sage-main/doc/en/reference/sage/structure/mutability.rst
-rw-r--r-- 1 buildbot buildbot 71416 2012-08-23 11:33:21.000000000 -0400 ./devel/sage-main/sage/structure/mutability.c
-rw-r--r-- 1 buildbot buildbot   529 2010-06-28 12:37:01.000000000 -0400 ./devel/sage-main/sage/structure/mutability.pxd
-rw-r--r-- 1 buildbot buildbot  2062 2012-08-23 11:22:27.000000000 -0400 ./devel/sage-main/sage/structure/mutability.pyx
```




---

archive/issue_comments_154423.json:
```json
{
    "body": "The `.so` is recompiled from an old Cython C file which was\n\n```\n/* Generated by Cython 0.12.1 on Thu Aug 23 11:33:21 2012 */\n```\n\nwhile the old code would always run `cython` to re-generate the `.c` file.\n\nSounds like #4797...",
    "created_at": "2013-02-04T11:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154423",
    "user": "https://github.com/jdemeyer"
}
```

The `.so` is recompiled from an old Cython C file which was

```
/* Generated by Cython 0.12.1 on Thu Aug 23 11:33:21 2012 */
```

while the old code would always run `cython` to re-generate the `.c` file.

Sounds like #4797...



---

archive/issue_comments_154424.json:
```json
{
    "body": "Alternatively, we could also disallow upgrades from versions older than sage-4.6.  On the other hand, that would probably not be sufficient as some `.c` files generated by newer versions of Cython would need to be recreated to account for #13896 for example.",
    "created_at": "2013-02-04T12:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154424",
    "user": "https://github.com/jdemeyer"
}
```

Alternatively, we could also disallow upgrades from versions older than sage-4.6.  On the other hand, that would probably not be sufficient as some `.c` files generated by newer versions of Cython would need to be recreated to account for #13896 for example.



---

archive/issue_comments_154425.json:
```json
{
    "body": "So from what I can tell cythonize is in the right -- these files don't need to be rebuilt (they nor any of their dependencies have been changed). So it looks like it is an issue of using old cython generated code with new cython generated code.\n\nThe other potential fix for this particular issue is to remove `sage.structure.mutablity`, since nothing actually uses it (despite getting imported in a few places).",
    "created_at": "2013-03-08T23:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154425",
    "user": "https://github.com/ohanar"
}
```

So from what I can tell cythonize is in the right -- these files don't need to be rebuilt (they nor any of their dependencies have been changed). So it looks like it is an issue of using old cython generated code with new cython generated code.

The other potential fix for this particular issue is to remove `sage.structure.mutablity`, since nothing actually uses it (despite getting imported in a few places).



---

archive/issue_comments_154426.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-08T23:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154426",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154427.json:
```json
{
    "body": "remove unused mutablity code",
    "created_at": "2013-03-08T23:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154427",
    "user": "https://github.com/ohanar"
}
```

remove unused mutablity code



---

archive/issue_comments_154428.json:
```json
{
    "body": "Attachment [trac13031-mutablity.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-mutablity.patch) by @ohanar created at 2013-03-08 23:28:18",
    "created_at": "2013-03-08T23:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154428",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac13031-mutablity.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-mutablity.patch) by @ohanar created at 2013-03-08 23:28:18



---

archive/issue_comments_154429.json:
```json
{
    "body": "Replying to [comment:32 ohanar]:\n> So from what I can tell cythonize is in the right -- these files don't need to be rebuilt (they nor any of their dependencies have been changed).\nIt depends what you mean. One could argue that all Cython files should implicitly depend on the Cython program. Similar how, in an autotools build system, everything depends on `config.status` (the output of `./configure`) or similar how `SCons` and `ccache` use the compiler executable as extra dependency of all C files.",
    "created_at": "2013-03-09T09:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154429",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:32 ohanar]:
> So from what I can tell cythonize is in the right -- these files don't need to be rebuilt (they nor any of their dependencies have been changed).
It depends what you mean. One could argue that all Cython files should implicitly depend on the Cython program. Similar how, in an autotools build system, everything depends on `config.status` (the output of `./configure`) or similar how `SCons` and `ccache` use the compiler executable as extra dependency of all C files.



---

archive/issue_comments_154430.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-09T09:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154430",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154431.json:
```json
{
    "body": "Did you fix the issue of C files not being regenerated by a Cython upgrade? Because whether it's the \"fault\" of Cython or not, it needs to be fixed.",
    "created_at": "2013-03-09T09:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154431",
    "user": "https://github.com/jdemeyer"
}
```

Did you fix the issue of C files not being regenerated by a Cython upgrade? Because whether it's the "fault" of Cython or not, it needs to be fixed.



---

archive/issue_comments_154432.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> Did you fix the issue of C files not being regenerated by a Cython upgrade?\nNo, I removed the single offending orphaned code, all the other code that is not regenerated causes no issues (since they are they are isolated from all of the modified files). The proper way to have this resolved is to have Cython's dependency checking not just check the timestamp of a file but also what version of Cython was used to generate the C file -- but I would rather not have this ticket held up on a future version of Cython.\n\nFrom what I can tell, the current `DependancyTree` only works because it is finding false positives, not because it is checking the Cython version of generated files. So until I find the time to look at fixing this in Cython, I think the correct resolution is to implement #4797.",
    "created_at": "2013-03-10T01:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154432",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:36 jdemeyer]:
> Did you fix the issue of C files not being regenerated by a Cython upgrade?
No, I removed the single offending orphaned code, all the other code that is not regenerated causes no issues (since they are they are isolated from all of the modified files). The proper way to have this resolved is to have Cython's dependency checking not just check the timestamp of a file but also what version of Cython was used to generate the C file -- but I would rather not have this ticket held up on a future version of Cython.

From what I can tell, the current `DependancyTree` only works because it is finding false positives, not because it is checking the Cython version of generated files. So until I find the time to look at fixing this in Cython, I think the correct resolution is to implement #4797.



---

archive/issue_comments_154433.json:
```json
{
    "body": "Attachment [trac13031-cythonize-simple-5.8.beta4.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-simple-5.8.beta4.patch) by @robertwb created at 2013-03-10 07:56:45",
    "created_at": "2013-03-10T07:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154433",
    "user": "https://github.com/robertwb"
}
```

Attachment [trac13031-cythonize-simple-5.8.beta4.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-simple-5.8.beta4.patch) by @robertwb created at 2013-03-10 07:56:45



---

archive/issue_comments_154434.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-10T07:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154434",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154435.json:
```json
{
    "body": "Attachment [trac13031-cythonize-version.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-version.patch) by @robertwb created at 2013-03-10 07:58:37\n\nOK, I've added a bit of code to cache and check the version.",
    "created_at": "2013-03-10T07:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154435",
    "user": "https://github.com/robertwb"
}
```

Attachment [trac13031-cythonize-version.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-version.patch) by @robertwb created at 2013-03-10 07:58:37

OK, I've added a bit of code to cache and check the version.



---

archive/issue_comments_154436.json:
```json
{
    "body": "Apply only trac13031-cythonize-simple-5.8.beta4.patch trac13031-mutablity.patch trac13031-cythonize-version.patch",
    "created_at": "2013-03-10T07:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154436",
    "user": "https://github.com/robertwb"
}
```

Apply only trac13031-cythonize-simple-5.8.beta4.patch trac13031-mutablity.patch trac13031-cythonize-version.patch



---

archive/issue_comments_154437.json:
```json
{
    "body": "Replying to [comment:37 ohanar]:\n> all the other code that is not regenerated causes no issues\nReally???????????????????????????????? What about the bug that Cython-0.17.4 fixed?",
    "created_at": "2013-03-10T10:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154437",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 ohanar]:
> all the other code that is not regenerated causes no issues
Really???????????????????????????????? What about the bug that Cython-0.17.4 fixed?



---

archive/issue_comments_154438.json:
```json
{
    "body": "Replying to [comment:37 ohanar]:\n> From what I can tell, the current `DependancyTree` only works because it is finding false positives, not because it is checking the Cython version of generated files.\nTrue, but at least it works.",
    "created_at": "2013-03-10T10:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154438",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:37 ohanar]:
> From what I can tell, the current `DependancyTree` only works because it is finding false positives, not because it is checking the Cython version of generated files.
True, but at least it works.



---

archive/issue_comments_154439.json:
```json
{
    "body": "Ok, Robert's patch looks good to me.",
    "created_at": "2013-03-12T20:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154439",
    "user": "https://github.com/ohanar"
}
```

Ok, Robert's patch looks good to me.



---

archive/issue_comments_154440.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-12T20:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154440",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_154441.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-03-13T11:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154441",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_154442.json:
```json
{
    "body": "This needs to be rebased to #13432.",
    "created_at": "2013-03-13T11:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154442",
    "user": "https://github.com/jdemeyer"
}
```

This needs to be rebased to #13432.



---

archive/issue_comments_154443.json:
```json
{
    "body": "Attachment [trac13031-cythonize-simple.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-simple.patch) by @ohanar created at 2013-03-13 19:41:49\n\napply to sage library",
    "created_at": "2013-03-13T19:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154443",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac13031-cythonize-simple.patch](tarball://root/attachments/some-uuid/ticket13031/trac13031-cythonize-simple.patch) by @ohanar created at 2013-03-13 19:41:49

apply to sage library



---

archive/issue_comments_154444.json:
```json
{
    "body": "I thought I had rebased this, oh well, it should now apply cleanly on top of #13432.",
    "created_at": "2013-03-13T19:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154444",
    "user": "https://github.com/ohanar"
}
```

I thought I had rebased this, oh well, it should now apply cleanly on top of #13432.



---

archive/issue_comments_154445.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-03-13T19:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154445",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_154446.json:
```json
{
    "body": "\n```\nTraceback (most recent call last):\n  File \"./spkg-install\", line 4, in <module>\n    from sage.all import save\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/all.py\", line 80, in <module>\n    from sage.misc.all       import *         # takes a while\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/all.py\", line 83, in <module>\n    from functional import (additive_order,\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 36, in <module>\n    from sage.rings.complex_double import CDF\n  File \"complex_double.pyx\", line 91, in init sage.rings.complex_double (sage/rings/complex_double.c:16796)\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 110, in ComplexField\n    C = ComplexField_class(prec)\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/complex_field.py\", line 204, in __init__\n    self._populate_coercion_lists_(coerce_list=[complex_number.RRtoCC(self._real_field(), self)])\n  File \"complex_number.pyx\", line 2431, in sage.rings.complex_number.RRtoCC.__init__ (sage/rings/complex_number.c:15890)\n  File \"map.pyx\", line 125, in sage.categories.map.Map.__init__ (sage/categories/map.c:2478)\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/categories/homset.py\", line 263, in Hom\n    H = category.hom_category().parent_class(X, Y, category = category)\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/categories/rings.py\", line 636, in __new__\n    from sage.rings.homset import RingHomset\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/homset.py\", line 17, in <module>\n    import morphism\n  File \"morphism.pyx\", line 985, in init sage.rings.morphism (sage/rings/morphism.c:12304)\n  File \"/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/structure/all.py\", line 49, in <module>\n    from mutability  import Mutability\nImportError: No module named mutability\n```\n",
    "created_at": "2013-03-15T12:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154446",
    "user": "https://github.com/jdemeyer"
}
```


```
Traceback (most recent call last):
  File "./spkg-install", line 4, in <module>
    from sage.all import save
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/all.py", line 80, in <module>
    from sage.misc.all       import *         # takes a while
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/all.py", line 83, in <module>
    from functional import (additive_order,
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/functional.py", line 36, in <module>
    from sage.rings.complex_double import CDF
  File "complex_double.pyx", line 91, in init sage.rings.complex_double (sage/rings/complex_double.c:16796)
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/complex_field.py", line 110, in ComplexField
    C = ComplexField_class(prec)
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/complex_field.py", line 204, in __init__
    self._populate_coercion_lists_(coerce_list=[complex_number.RRtoCC(self._real_field(), self)])
  File "complex_number.pyx", line 2431, in sage.rings.complex_number.RRtoCC.__init__ (sage/rings/complex_number.c:15890)
  File "map.pyx", line 125, in sage.categories.map.Map.__init__ (sage/categories/map.c:2478)
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/categories/homset.py", line 263, in Hom
    H = category.hom_category().parent_class(X, Y, category = category)
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/categories/rings.py", line 636, in __new__
    from sage.rings.homset import RingHomset
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/rings/homset.py", line 17, in <module>
    import morphism
  File "morphism.pyx", line 985, in init sage.rings.morphism (sage/rings/morphism.c:12304)
  File "/release/merger/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/structure/all.py", line 49, in <module>
    from mutability  import Mutability
ImportError: No module named mutability
```




---

archive/issue_comments_154447.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-03-15T12:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154447",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_154448.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-15T17:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154448",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154449.json:
```json
{
    "body": "Apply only trac13031-cythonize-simple.patch and trac13031-cythonize-version.patch \n\nWe can delete mutability in a separate CL, now that we have Cython version tracking.",
    "created_at": "2013-03-15T17:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154449",
    "user": "https://github.com/robertwb"
}
```

Apply only trac13031-cythonize-simple.patch and trac13031-cythonize-version.patch 

We can delete mutability in a separate CL, now that we have Cython version tracking.



---

archive/issue_comments_154450.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-16T20:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154450",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154451.json:
```json
{
    "body": "\n```\nsage -t devel/sage/sage/misc/dev_tools.py\n**********************************************************************\nFile \"devel/sage/sage/misc/dev_tools.py\", line 145, in sage.misc.dev_tools.import_statements\nFailed example:\n    import_statements(ZZ)\nExpected:\n      ** Warning **: several names for that object: ZZ, Z\n    from sage.rings.integer_ring import ZZ\nGot:\n      ** Warning **: several names for that object: Z, ZZ\n    from sage.rings.integer_ring import Z\n**********************************************************************\nFile \"devel/sage/sage/misc/dev_tools.py\", line 158, in sage.misc.dev_tools.import_statements\nFailed example:\n    import_statements(ZZ, verbose=False)\nExpected:\n    from sage.rings.integer_ring import ZZ\nGot:\n    from sage.rings.integer_ring import Z\n**********************************************************************\n```\n",
    "created_at": "2013-03-16T20:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154451",
    "user": "https://github.com/jdemeyer"
}
```


```
sage -t devel/sage/sage/misc/dev_tools.py
**********************************************************************
File "devel/sage/sage/misc/dev_tools.py", line 145, in sage.misc.dev_tools.import_statements
Failed example:
    import_statements(ZZ)
Expected:
      ** Warning **: several names for that object: ZZ, Z
    from sage.rings.integer_ring import ZZ
Got:
      ** Warning **: several names for that object: Z, ZZ
    from sage.rings.integer_ring import Z
**********************************************************************
File "devel/sage/sage/misc/dev_tools.py", line 158, in sage.misc.dev_tools.import_statements
Failed example:
    import_statements(ZZ, verbose=False)
Expected:
    from sage.rings.integer_ring import ZZ
Got:
    from sage.rings.integer_ring import Z
**********************************************************************
```




---

archive/issue_comments_154452.json:
```json
{
    "body": "Attachment [13031-doctest-fix.patch](tarball://root/attachments/some-uuid/ticket13031/13031-doctest-fix.patch) by @robertwb created at 2013-03-17 06:32:59",
    "created_at": "2013-03-17T06:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154452",
    "user": "https://github.com/robertwb"
}
```

Attachment [13031-doctest-fix.patch](tarball://root/attachments/some-uuid/ticket13031/13031-doctest-fix.patch) by @robertwb created at 2013-03-17 06:32:59



---

archive/issue_comments_154453.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-17T06:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154453",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154454.json:
```json
{
    "body": "I think you are missing some `sys.stdout.flush()` statements in `cythonize()`, as the message\n\n```\nCythonizing sage/categories/category_singleton.pyx\n```\n\nmight come *after*\n\n```\ngcc -fno-strict-aliasing -std=gnu99 -D_XPG6 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include/csage -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/devel/sage/sage/ext -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include/python2.7 -c sage/categories/category_singleton.c -o build/temp.solaris-2.11-i86pc.32bit-2.7/sage/categories/category_singleton.o -w\n```\n\nwhich is very confusing, especially when errors occur.\n\n(there is nothing special about this file, it's just an example)",
    "created_at": "2013-03-19T09:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154454",
    "user": "https://github.com/jdemeyer"
}
```

I think you are missing some `sys.stdout.flush()` statements in `cythonize()`, as the message

```
Cythonizing sage/categories/category_singleton.pyx
```

might come *after*

```
gcc -fno-strict-aliasing -std=gnu99 -D_XPG6 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include/csage -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/devel/sage/sage/ext -I/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta1/local/include/python2.7 -c sage/categories/category_singleton.c -o build/temp.solaris-2.11-i86pc.32bit-2.7/sage/categories/category_singleton.o -w
```

which is very confusing, especially when errors occur.

(there is nothing special about this file, it's just an example)



---

archive/issue_comments_154455.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-19T09:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154455",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_154456.json:
```json
{
    "body": "https://github.com/cython/cython/commit/aeb34fe0046522bad68205129b7a5a0f6a56f0ab",
    "created_at": "2013-03-19T17:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154456",
    "user": "https://github.com/robertwb"
}
```

https://github.com/cython/cython/commit/aeb34fe0046522bad68205129b7a5a0f6a56f0ab



---

archive/issue_comments_154457.json:
```json
{
    "body": "Attachment [13031-flush.patch](tarball://root/attachments/some-uuid/ticket13031/13031-flush.patch) by @robertwb created at 2013-03-19 17:39:57",
    "created_at": "2013-03-19T17:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154457",
    "user": "https://github.com/robertwb"
}
```

Attachment [13031-flush.patch](tarball://root/attachments/some-uuid/ticket13031/13031-flush.patch) by @robertwb created at 2013-03-19 17:39:57



---

archive/issue_comments_154458.json:
```json
{
    "body": "Granted, there's no reason (other than luck) that we couldn't have hit this before just as well.",
    "created_at": "2013-03-19T17:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154458",
    "user": "https://github.com/robertwb"
}
```

Granted, there's no reason (other than luck) that we couldn't have hit this before just as well.



---

archive/issue_comments_154459.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-19T17:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154459",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_154460.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-28T04:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154460",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_154461.json:
```json
{
    "body": "The file `sage/schemes/generic/notes/divisor_stein-joyner.txt` is removed in #13062, so [attachment:13031-doctest-fix.patch] needs to be rebased.",
    "created_at": "2013-03-28T19:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154461",
    "user": "https://github.com/jdemeyer"
}
```

The file `sage/schemes/generic/notes/divisor_stein-joyner.txt` is removed in #13062, so [attachment:13031-doctest-fix.patch] needs to be rebased.



---

archive/issue_comments_154462.json:
```json
{
    "body": "Attachment [13031-doctest-fix-rebased.patch](tarball://root/attachments/some-uuid/ticket13031/13031-doctest-fix-rebased.patch) by @robertwb created at 2013-03-28 19:49:56",
    "created_at": "2013-03-28T19:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154462",
    "user": "https://github.com/robertwb"
}
```

Attachment [13031-doctest-fix-rebased.patch](tarball://root/attachments/some-uuid/ticket13031/13031-doctest-fix-rebased.patch) by @robertwb created at 2013-03-28 19:49:56



---

archive/issue_comments_154463.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-01T10:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154463",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_154464.json:
```json
{
    "body": "Robert: any plans to add the version checking upstream to `cythonize()`?",
    "created_at": "2013-04-05T10:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154464",
    "user": "https://github.com/jdemeyer"
}
```

Robert: any plans to add the version checking upstream to `cythonize()`?



---

archive/issue_comments_154465.json:
```json
{
    "body": "I just found some important bug: it seems the dependencies on the files in `c_lib/` are no longer correctly handled.\n\n```\n$ touch devel/sage/c_lib/include/interrupt.h && ./sage -b\n```\n\nshould rebuild all files depending on `interrupt.h` but this doesn't work anymore.\n\nIn sage-5.9.beta3, one gets instead lots of lines like\n\n```\nBuilding sage/libs/ecl.pyx because it depends on /mazur/release/merger/sage-5.9.beta3/local/include/csage/interrupt.h.\n```\n",
    "created_at": "2013-04-15T14:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154465",
    "user": "https://github.com/jdemeyer"
}
```

I just found some important bug: it seems the dependencies on the files in `c_lib/` are no longer correctly handled.

```
$ touch devel/sage/c_lib/include/interrupt.h && ./sage -b
```

should rebuild all files depending on `interrupt.h` but this doesn't work anymore.

In sage-5.9.beta3, one gets instead lots of lines like

```
Building sage/libs/ecl.pyx because it depends on /mazur/release/merger/sage-5.9.beta3/local/include/csage/interrupt.h.
```




---

archive/issue_comments_154466.json:
```json
{
    "body": "I'm on it.",
    "created_at": "2013-04-16T03:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154466",
    "user": "https://github.com/robertwb"
}
```

I'm on it.



---

archive/issue_comments_154467.json:
```json
{
    "body": "Any progress?",
    "created_at": "2013-04-19T08:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154467",
    "user": "https://github.com/jdemeyer"
}
```

Any progress?



---

archive/issue_comments_154468.json:
```json
{
    "body": "The fix will be in Cython 0.19.",
    "created_at": "2013-04-19T09:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154468",
    "user": "https://github.com/robertwb"
}
```

The fix will be in Cython 0.19.



---

archive/issue_comments_154469.json:
```json
{
    "body": "(We could backport it if that takes too long.)",
    "created_at": "2013-04-19T09:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154469",
    "user": "https://github.com/robertwb"
}
```

(We could backport it if that takes too long.)



---

archive/issue_comments_154470.json:
```json
{
    "body": "Thanks. Anyway, good to know it's a Cython bug, not Sage bug.",
    "created_at": "2013-04-19T10:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154470",
    "user": "https://github.com/jdemeyer"
}
```

Thanks. Anyway, good to know it's a Cython bug, not Sage bug.



---

archive/issue_comments_154471.json:
```json
{
    "body": "Proposal: unmerge this for sage-5.9, merge in again in sage-5.10 together with #14452.",
    "created_at": "2013-04-19T14:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154471",
    "user": "https://github.com/jdemeyer"
}
```

Proposal: unmerge this for sage-5.9, merge in again in sage-5.10 together with #14452.



---

archive/issue_comments_154472.json:
```json
{
    "body": "(or possibly merge #14452 in sage-5.9.rc0)",
    "created_at": "2013-04-19T14:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154472",
    "user": "https://github.com/jdemeyer"
}
```

(or possibly merge #14452 in sage-5.9.rc0)



---

archive/issue_comments_154473.json:
```json
{
    "body": "Alternative proposal: cython-0.18.p1. I really would not like to see this unmerged after it finally got in.",
    "created_at": "2013-04-19T17:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154473",
    "user": "https://github.com/robertwb"
}
```

Alternative proposal: cython-0.18.p1. I really would not like to see this unmerged after it finally got in.



---

archive/issue_comments_154474.json:
```json
{
    "body": "Given that cython-0.19 is released today and we have a workaround for the docbuilder crash at #14452, why not cython-0.19?",
    "created_at": "2013-04-19T18:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154474",
    "user": "https://github.com/jdemeyer"
}
```

Given that cython-0.19 is released today and we have a workaround for the docbuilder crash at #14452, why not cython-0.19?



---

archive/issue_comments_154475.json:
```json
{
    "body": "There are still serious problems with dependency checking: #14544",
    "created_at": "2013-05-07T12:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154475",
    "user": "https://github.com/jdemeyer"
}
```

There are still serious problems with dependency checking: #14544



---

archive/issue_comments_154476.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> There are still serious problems with dependency checking: #14544\n\nThere are also reports on sage-devel that `sage -clone` was broken in 5.9 (and later), now rebuilding the whole Sage library.  Not sure what exactly introduced that though.",
    "created_at": "2013-05-11T17:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154476",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:70 jdemeyer]:
> There are still serious problems with dependency checking: #14544

There are also reports on sage-devel that `sage -clone` was broken in 5.9 (and later), now rebuilding the whole Sage library.  Not sure what exactly introduced that though.



---

archive/issue_comments_154477.json:
```json
{
    "body": "Replying to [comment:71 leif]:\n> There are also reports on sage-devel that `sage -clone` was broken in 5.9 (and later), now rebuilding the whole Sage library.  Not sure what exactly introduced that though.\n\nLooks like just the fact that `sage-clone` doesn't copy `$SAGE_SRC/.cython_version` causes this...\n\n(where `$SAGE_SRC` is [meanwhile] `$SAGE_ROOT/devel/sage`)\n\n\n\n\nAlso (but this doesn't seem to be the cause), `sage-clone` does not (or no longer, presumably at least since a while) copy Cython-generated *header files* (`*.h`), as these do **not** contain a comment on the first line stating that they were generated by Cython, so the following doesn't work for them:\n\n```python\nprint \"Copying over all Cython auto-generated .c, .cpp and .h files...\"\ndef cpdir(src, dest):\n    if not os.path.isdir(dest):\n        return\n    for F in os.listdir(src):\n        if os.path.isdir(src + '/' + F):\n            cpdir(src + '/' + F, dest + '/' + F)\n        else:\n            ext = os.path.splitext(F)[-1]\n            if ext in ['.h', '.c', '.cpp']:\n                if 'Cython' in open(src + '/' + F).readline():\n                    os.link(src + '/' + F, dest + '/' +F)\n                    os.utime(dest + '/' +F, None)\n\ncpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))\n```\n",
    "created_at": "2013-05-11T19:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154477",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:71 leif]:
> There are also reports on sage-devel that `sage -clone` was broken in 5.9 (and later), now rebuilding the whole Sage library.  Not sure what exactly introduced that though.

Looks like just the fact that `sage-clone` doesn't copy `$SAGE_SRC/.cython_version` causes this...

(where `$SAGE_SRC` is [meanwhile] `$SAGE_ROOT/devel/sage`)




Also (but this doesn't seem to be the cause), `sage-clone` does not (or no longer, presumably at least since a while) copy Cython-generated *header files* (`*.h`), as these do **not** contain a comment on the first line stating that they were generated by Cython, so the following doesn't work for them:

```python
print "Copying over all Cython auto-generated .c, .cpp and .h files..."
def cpdir(src, dest):
    if not os.path.isdir(dest):
        return
    for F in os.listdir(src):
        if os.path.isdir(src + '/' + F):
            cpdir(src + '/' + F, dest + '/' + F)
        else:
            ext = os.path.splitext(F)[-1]
            if ext in ['.h', '.c', '.cpp']:
                if 'Cython' in open(src + '/' + F).readline():
                    os.link(src + '/' + F, dest + '/' +F)
                    os.utime(dest + '/' +F, None)

cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))
```




---

archive/issue_comments_154478.json:
```json
{
    "body": "Replying to [comment:72 leif]:\n> Also (but this doesn't seem to be the cause), `sage-clone` does not (or no longer, presumably at least since a while) copy Cython-generated *header files* (`*.h`), as these do **not** contain a comment on the first line stating that they were generated by Cython, so the following doesn't work for them:\n> {{{\n> #!python\n> print \"Copying over all Cython auto-generated .c, .cpp and .h files...\"\n> def cpdir(src, dest):\n>     if not os.path.isdir(dest):\n>         return\n>     for F in os.listdir(src):\n>         if os.path.isdir(src + '/' + F):\n>             cpdir(src + '/' + F, dest + '/' + F)\n>         else:\n>             ext = os.path.splitext(F)[-1]\n>             if ext in ['.h', '.c', '.cpp']:\n>                 if 'Cython' in open(src + '/' + F).readline():\n>                     os.link(src + '/' + F, dest + '/' +F)\n>                     os.utime(dest + '/' +F, None)\n> \n> cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))\n> }}}\n\nFurthermore, the above code doesn't copy the Cython-generated files from `devel/sage/ext/interpreters/`, so these also get rebuilt, but that goes back to at least Sage 5.8 (unless I'm missing something).\n\n\n\n\nIf I add copying `.cython_version` to `sage-clone`, besides the above-mentioned re-\"cythonizing\"[sic!], many (if not all?) Python modules get re-byte-compiled, too, for whatever reason... (This doesn't seem to be related to Cython, but maybe I'm just missing something here as well.)",
    "created_at": "2013-05-11T20:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154478",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:72 leif]:
> Also (but this doesn't seem to be the cause), `sage-clone` does not (or no longer, presumably at least since a while) copy Cython-generated *header files* (`*.h`), as these do **not** contain a comment on the first line stating that they were generated by Cython, so the following doesn't work for them:
> {{{
> #!python
> print "Copying over all Cython auto-generated .c, .cpp and .h files..."
> def cpdir(src, dest):
>     if not os.path.isdir(dest):
>         return
>     for F in os.listdir(src):
>         if os.path.isdir(src + '/' + F):
>             cpdir(src + '/' + F, dest + '/' + F)
>         else:
>             ext = os.path.splitext(F)[-1]
>             if ext in ['.h', '.c', '.cpp']:
>                 if 'Cython' in open(src + '/' + F).readline():
>                     os.link(src + '/' + F, dest + '/' +F)
>                     os.utime(dest + '/' +F, None)
> 
> cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))
> }}}

Furthermore, the above code doesn't copy the Cython-generated files from `devel/sage/ext/interpreters/`, so these also get rebuilt, but that goes back to at least Sage 5.8 (unless I'm missing something).




If I add copying `.cython_version` to `sage-clone`, besides the above-mentioned re-"cythonizing"[sic!], many (if not all?) Python modules get re-byte-compiled, too, for whatever reason... (This doesn't seem to be related to Cython, but maybe I'm just missing something here as well.)



---

archive/issue_comments_154479.json:
```json
{
    "body": "Replying to [comment:73 leif]:\n> If I add copying `.cython_version` to `sage-clone` ...\n\n\n\n```patch\ndiff --git a/sage-clone b/sage-clone\n--- a/sage-clone\n+++ b/sage-clone\n@@ -53,6 +53,10 @@\n \n cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))\n \n+if os.path.isfile('sage/.cython_version'):\n+    print \"Copying over hidden Cython version file...\"\n+    os.link('sage/.cython_version', branch+'/.cython_version')\n+\n def copy_dtree(src_dir, dest_dir):\n     src_root = os.path.abspath(src_dir)\n     dest_root = os.path.abspath(dest_dir)\n```\n",
    "created_at": "2013-05-11T20:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12859",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12859#issuecomment-154479",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:73 leif]:
> If I add copying `.cython_version` to `sage-clone` ...



```patch
diff --git a/sage-clone b/sage-clone
--- a/sage-clone
+++ b/sage-clone
@@ -53,6 +53,10 @@
 
 cpdir(os.path.abspath('sage/sage'), os.path.abspath(branch + '/sage'))
 
+if os.path.isfile('sage/.cython_version'):
+    print "Copying over hidden Cython version file..."
+    os.link('sage/.cython_version', branch+'/.cython_version')
+
 def copy_dtree(src_dir, dest_dir):
     src_root = os.path.abspath(src_dir)
     dest_root = os.path.abspath(dest_dir)
```

