# Issue 32738: Improve doctest interaction with pytest

Issue created by migration from https://trac.sagemath.org/ticket/32975

Original creator: @tobiasdiez

Original creation time: 2021-12-04 17:38:08

CC:  mkoeppe chapoton egourgoulhon tornaria

This ticket improves a few things about how doctest treats pytest.

- Introduce the option to specify in function doc `TESTS: pytest`. This marks the function as tested for the `sage-coverage` command. Sometimes (but rarely) you have private or protected methods that don't need a proper "EXAMPLES" doctest. In these cases, one can decide to either write traditional `TESTS` or use pytest to test the method. In the later case, `sage-coverage` would mark the function as not tested as it's not aware of pytest; so we have to specify explicitly that we use pytest to cover this method. One could even argue that private/protected methods shouldn't be directly tested at all as they are implementation details; but let's not open this discussion.

- Remove `_test.py` files from doctest coverage. By our convention, these are pytest files and thus almost never have (extensive) doctests.

- To make this work, existing `xyz_test.py` files that are not using pytest are renamed to `test_xyz.py`.




---

Comment by git created at 2021-12-04 17:38:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-04 17:39:10

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-21 17:51:26

It would probably be a good idea to discuss this in sage-devel at the beginning of the 9.6 development cycle


---

Comment by mkoeppe created at 2022-02-01 19:17:07

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-01 19:17:07

The testsuite failures are unreleated, but the docbuild shows an error:

```
[sagemath_doc_html-none]   File "/tmp/tmpnq9leusf-sage-git-temp-32975/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
[sagemath_doc_html-none]     raise OSError(self._error)
[sagemath_doc_html-none] OSError: WARNING: autodoc: failed to import module 'backend_test' from module 'sage.repl.rich_output'; the following exception was raised:
[sagemath_doc_html-none] 
```



---

Comment by mkoeppe created at 2022-02-01 19:18:40

Replying to [ticket:32975 gh-tobiasdiez]:
> - To make this work, existing `xyz_test.py` files that are not using pytest are renamed to `test_xyz.py`.

Normally we would have deprecation for such renames, but I think we won't need it here because these modules are only there for testing purposes and will likely not be used in user code


---

Comment by mkoeppe created at 2022-03-19 17:16:32

Changing priority from major to critical.


---

Comment by git created at 2022-03-20 12:26:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-20 12:26:53

The docs should be fixed now as well (hopefully).


---

Comment by @tobiasdiez created at 2022-03-20 12:26:53

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-20 15:44:13


```
+    # Filter pytest files which are not supposed to have doctests
+    if '_test.py' in filename:
```

I think this would be better as `filename.endswith(...)`


---

Comment by mkoeppe created at 2022-03-20 15:45:17

Also the developer's manual should probably be updated to document this.


---

Comment by mkoeppe created at 2022-03-20 16:17:37

Documentation builds now, thanks


---

Comment by git created at 2022-03-20 17:10:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-20 17:12:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-20 17:13:15

Good suggestions, now implemented, thanks.


---

Comment by mkoeppe created at 2022-03-20 18:25:30

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-20 18:37:00

Thanks!


---

Comment by dimpase created at 2022-03-21 09:47:50

Could we have an example of `TESTS: pytest` used?


---

Comment by @tobiasdiez created at 2022-03-21 10:12:08

I'd used it in https://git.sagemath.org/sage.git/commit/?id=16a08af77e3aafc65ea709ea3d3adeba188362ba, but then reverted these changes as this ticket here seemed to take longer to get merged.


---

Comment by vbraun created at 2022-03-21 23:34:53

Resolution: fixed
