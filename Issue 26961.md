# Issue 26961: Fix overflow problems for extremely large meataxe matrices

archive/issues_026961.json:
```json
{
    "body": "As observed at #27152, extremely large MeatAxe matrices seem to be problematic in several regards.\n\n```\nsage: %time M = matrix(GF(243), 2^16, 2^16)\nCPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s\nWall time: 7min 25s\nsage: M[0,0]\n0\nsage: M[2^16-1,0]\n0\nsage: M[2^16-1,2^16-1]\n0\nsage: M[2^16-1,2^16-1] = 123\nsage: M[2^16-1,2^16-1]  # wrong\n0\nsage: pickle = dumps(M)\n<segfault>\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27198\n\n",
    "created_at": "2019-02-01T13:09:23Z",
    "labels": [
        "packages: optional",
        "major",
        "bug"
    ],
    "title": "Fix overflow problems for extremely large meataxe matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26961",
    "user": "SimonKing"
}
```
As observed at #27152, extremely large MeatAxe matrices seem to be problematic in several regards.

```
sage: %time M = matrix(GF(243), 2^16, 2^16)
CPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s
Wall time: 7min 25s
sage: M[0,0]
0
sage: M[2^16-1,0]
0
sage: M[2^16-1,2^16-1]
0
sage: M[2^16-1,2^16-1] = 123
sage: M[2^16-1,2^16-1]  # wrong
0
sage: pickle = dumps(M)
<segfault>
```


Issue created by migration from https://trac.sagemath.org/ticket/27198





---

archive/issue_comments_379383.json:
```json
{
    "body": "Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.",
    "created_at": "2019-02-01T20:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379383",
    "user": "jdemeyer"
}
```

Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.



---

archive/issue_comments_379384.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.\n\nRight. I've never actually worked with matrices that big, and it could very well be that there is some kind of overflow in SharedMeatAxe. But first, I'd like to see what is the smallest example exposing the wrong item access resp. the segfault, so that it doesn't take so long time (7 minutes) for each test run.",
    "created_at": "2019-02-01T20:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379384",
    "user": "SimonKing"
}
```

Replying to [comment:1 jdemeyer]:
> Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.

Right. I've never actually worked with matrices that big, and it could very well be that there is some kind of overflow in SharedMeatAxe. But first, I'd like to see what is the smallest example exposing the wrong item access resp. the segfault, so that it doesn't take so long time (7 minutes) for each test run.



---

archive/issue_comments_379385.json:
```json
{
    "body": "Ouch, I am so stupid. I worked with a field of size `243=3^5` and was assigning the value `123`, which is divisible by 3 and thus zero. So, the item assignment probably is a non-issue.",
    "created_at": "2019-02-01T20:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379385",
    "user": "SimonKing"
}
```

Ouch, I am so stupid. I worked with a field of size `243=3^5` and was assigning the value `123`, which is divisible by 3 and thus zero. So, the item assignment probably is a non-issue.



---

archive/issue_comments_379386.json:
```json
{
    "body": "PS: I find it unlikely that the problem is upstrem. Both `__reduce__` and `mtx_unpickle` hardly call a meataxe library function. It's basically memcopy and pointer advancement. With one exception, though: The global variables `FfCurrentRowSize` and `FfCurrentRowSizeIo` are set by calling a library function. So, that could potentially go wrong upstream.\n\nWe'll see.",
    "created_at": "2019-02-01T20:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379386",
    "user": "SimonKing"
}
```

PS: I find it unlikely that the problem is upstrem. Both `__reduce__` and `mtx_unpickle` hardly call a meataxe library function. It's basically memcopy and pointer advancement. With one exception, though: The global variables `FfCurrentRowSize` and `FfCurrentRowSizeIo` are set by calling a library function. So, that could potentially go wrong upstream.

We'll see.



---

archive/issue_comments_379387.json:
```json
{
    "body": "Interestingly, allocating an empty matrix of only 1/4 of the size takes about the same time. Could that indicate a problem? Pickling of that smaller matrix fails, because Sage cannot allocate enough memory. But it doesn't crash:\n\n```\nsage: %time M = matrix(GF(243), 2^16-1, 2^16-1)\nCPU times: user 7min 33s, sys: 809 ms, total: 7min 34s\nWall time: 7min 34s\nsage: d = dumps(M)\n---------------------------------------------------------------------------\nMemoryError                               Traceback (most recent call last)\n<ipython-input-2-aaf8f192cb1c> in <module>()\n----> 1 d = dumps(M)\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4160)()\n    281         picklejar(obj)\n    282     try:\n--> 283         return obj.dumps(compress)\n    284     except (AttributeError, RuntimeError, TypeError):\n    285         return _base_dumps(obj, compress=compress)\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3638)()\n    462         \"\"\"\n    463 \n--> 464         return _base_dumps(self, compress=compress)\n    465 \n    466     #############################################################################\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:3894)()\n    254     \"\"\"\n    255 \n--> 256     gherkin = SagePickler.dumps(obj)\n    257 \n    258     if compress:\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6609)()\n    833         buf = io.BytesIO()\n    834         pickler = cls(buf, **kwargs)\n--> 835         pickler.dump(obj)\n    836         return buf.getvalue()\n    837 \n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__reduce__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:6122)()\n    531             FfSetNoc(self.Data.Noc)\n    532             pickle_size = FfCurrentRowSizeIo*self.Data.Nor\n--> 533             d = <char*>check_malloc(pickle_size)\n    534             p = self.Data.Data\n    535             x = d\n\nmemory.pxd in cysignals.memory.check_malloc (build/cythonized/sage/matrix/matrix_gfpn_dense.c:17384)()\n\nMemoryError: failed to allocate 18446744073709420545 bytes\n```\n\nI find the number of bytes-to-be-allocated interesting. It should allocate `pickle_size` bytes, and `pickle_size=FfCurrentRowSizeIo*self.Data.Nor`. We have `self.Data.Nor = 2^16-1`, and `FfCurrentRowSizeIo` should be the number of bytes needed to store one row. Since the field is relatively large, one item will be stored in a single byte, and thus I'd expect `FfCurrentRowSizeIo=2^16-1`.\n\nHence, the number of bytes to be allocated should be `4294836225 = (2<sup>16-1)</sup>2`, and that's far less than what the `__reduce__` method is trying to allocate.",
    "created_at": "2019-02-01T20:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379387",
    "user": "SimonKing"
}
```

Interestingly, allocating an empty matrix of only 1/4 of the size takes about the same time. Could that indicate a problem? Pickling of that smaller matrix fails, because Sage cannot allocate enough memory. But it doesn't crash:

```
sage: %time M = matrix(GF(243), 2^16-1, 2^16-1)
CPU times: user 7min 33s, sys: 809 ms, total: 7min 34s
Wall time: 7min 34s
sage: d = dumps(M)
---------------------------------------------------------------------------
MemoryError                               Traceback (most recent call last)
<ipython-input-2-aaf8f192cb1c> in <module>()
----> 1 d = dumps(M)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4160)()
    281         picklejar(obj)
    282     try:
--> 283         return obj.dumps(compress)
    284     except (AttributeError, RuntimeError, TypeError):
    285         return _base_dumps(obj, compress=compress)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3638)()
    462         """
    463 
--> 464         return _base_dumps(self, compress=compress)
    465 
    466     #############################################################################

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:3894)()
    254     """
    255 
--> 256     gherkin = SagePickler.dumps(obj)
    257 
    258     if compress:

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6609)()
    833         buf = io.BytesIO()
    834         pickler = cls(buf, **kwargs)
--> 835         pickler.dump(obj)
    836         return buf.getvalue()
    837 

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__reduce__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:6122)()
    531             FfSetNoc(self.Data.Noc)
    532             pickle_size = FfCurrentRowSizeIo*self.Data.Nor
--> 533             d = <char*>check_malloc(pickle_size)
    534             p = self.Data.Data
    535             x = d

memory.pxd in cysignals.memory.check_malloc (build/cythonized/sage/matrix/matrix_gfpn_dense.c:17384)()

MemoryError: failed to allocate 18446744073709420545 bytes
```

I find the number of bytes-to-be-allocated interesting. It should allocate `pickle_size` bytes, and `pickle_size=FfCurrentRowSizeIo*self.Data.Nor`. We have `self.Data.Nor = 2^16-1`, and `FfCurrentRowSizeIo` should be the number of bytes needed to store one row. Since the field is relatively large, one item will be stored in a single byte, and thus I'd expect `FfCurrentRowSizeIo=2^16-1`.

Hence, the number of bytes to be allocated should be `4294836225 = (2<sup>16-1)</sup>2`, and that's far less than what the `__reduce__` method is trying to allocate.



---

archive/issue_comments_379388.json:
```json
{
    "body": "Replying to [comment:6 SimonKing]:\n> {{{\n> MemoryError: failed to allocate 18446744073709420545 bytes\n> }}}\n> I find the number of bytes-to-be-allocated interesting.\n\nYes. As I mentioned already in #27152, there is an overflow in the line \n\n```\npickle_size = FfCurrentRowSizeIo*self.Data.Nor\n```\n",
    "created_at": "2019-02-01T20:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379388",
    "user": "jdemeyer"
}
```

Replying to [comment:6 SimonKing]:
> {{{
> MemoryError: failed to allocate 18446744073709420545 bytes
> }}}
> I find the number of bytes-to-be-allocated interesting.

Yes. As I mentioned already in #27152, there is an overflow in the line 

```
pickle_size = FfCurrentRowSizeIo*self.Data.Nor
```




---

archive/issue_comments_379389.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Yes. As I mentioned already in #27152, there is an overflow in the line \n> {{{\n> pickle_size = FfCurrentRowSizeIo*self.Data.Nor\n> }}}\n\nRight, I thought I had fixed it by using `Py_ssize_t`, but just realise that that was in a different place.",
    "created_at": "2019-02-01T21:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379389",
    "user": "SimonKing"
}
```

Replying to [comment:7 jdemeyer]:
> Yes. As I mentioned already in #27152, there is an overflow in the line 
> {{{
> pickle_size = FfCurrentRowSizeIo*self.Data.Nor
> }}}

Right, I thought I had fixed it by using `Py_ssize_t`, but just realise that that was in a different place.



---

archive/issue_comments_379390.json:
```json
{
    "body": "I don't understand what type I should use for pickle_size.\n\nWhen using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.",
    "created_at": "2019-02-01T21:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379390",
    "user": "SimonKing"
}
```

I don't understand what type I should use for pickle_size.

When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.



---

archive/issue_comments_379391.json:
```json
{
    "body": "Replying to [comment:9 SimonKing]:\n> When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.\n\nThe problem is not the assignment, the problem is the multiplication. You need to do something like\n\n```\npickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor\n```\n\n(one of the two casts should be sufficient)",
    "created_at": "2019-02-01T21:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379391",
    "user": "jdemeyer"
}
```

Replying to [comment:9 SimonKing]:
> When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.

The problem is not the assignment, the problem is the multiplication. You need to do something like

```
pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor
```

(one of the two casts should be sufficient)



---

archive/issue_comments_379392.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> Replying to [comment:9 SimonKing]:\n> > When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.\n> \n> The problem is not the assignment, the problem is the multiplication. You need to do something like\n> {{{\n> pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor\n> }}}\n> (one of the two casts should be sufficient)\n\nI see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`? That's what I am testing right now, but when you find that problematic, I could change it before posting a commit.",
    "created_at": "2019-02-01T21:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379392",
    "user": "SimonKing"
}
```

Replying to [comment:10 jdemeyer]:
> Replying to [comment:9 SimonKing]:
> > When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.
> 
> The problem is not the assignment, the problem is the multiplication. You need to do something like
> {{{
> pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor
> }}}
> (one of the two casts should be sufficient)

I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`? That's what I am testing right now, but when you find that problematic, I could change it before posting a commit.



---

archive/issue_comments_379393.json:
```json
{
    "body": "Replying to [comment:11 SimonKing]:\n> I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?\n\nIt works, but the size of data is so that my computer basically freezes.\n\nAnother question: The pickling does\n\n```\n            d = <char*>check_malloc(pickle_size)\n            p = self.Data.Data\n            x = d\n            for i in range(self.Data.Nor):\n                memcpy(x, p, FfCurrentRowSizeIo)\n                sig_check()\n                x += FfCurrentRowSizeIo\n                FfStepPtr(&p)\n```\n\nwhich is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).\n\nThen, it does\n\n```\n            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)\n            sig_free(d)\n```\n\n\nIf I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.\n\nWouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?",
    "created_at": "2019-02-01T22:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379393",
    "user": "SimonKing"
}
```

Replying to [comment:11 SimonKing]:
> I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?

It works, but the size of data is so that my computer basically freezes.

Another question: The pickling does

```
            d = <char*>check_malloc(pickle_size)
            p = self.Data.Data
            x = d
            for i in range(self.Data.Nor):
                memcpy(x, p, FfCurrentRowSizeIo)
                sig_check()
                x += FfCurrentRowSizeIo
                FfStepPtr(&p)
```

which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).

Then, it does

```
            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
            sig_free(d)
```


If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.

Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?



---

archive/issue_comments_379394.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-02T20:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379394",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379395.json:
```json
{
    "body": "The segfault / overflow seems to be gone.",
    "created_at": "2019-02-02T21:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379395",
    "user": "SimonKing"
}
```

The segfault / overflow seems to be gone.



---

archive/issue_comments_379396.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-02T21:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379396",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_379397.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n> Another question: The pickling does\n> {{{\n>             d = <char*>check_malloc(pickle_size)\n>             p = self.Data.Data\n>             x = d\n>             for i in range(self.Data.Nor):\n>                 memcpy(x, p, FfCurrentRowSizeIo)\n>                 sig_check()\n>                 x += FfCurrentRowSizeIo\n>                 FfStepPtr(&p)\n> }}}\n> which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).\n> \n> Then, it does\n> {{{\n>             pickle_str = PyBytes_FromStringAndSize(d, pickle_size)\n>             sig_free(d)\n> }}}\n> \n> If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.\n> \n> Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?\n\n\n```\ncdef bytes pickle_bytes = PyBytes_FromStringAndSize(NULL, pickle_size)\ncdef char* x = PyBytes_AS_STRING(pickle_bytes)\n```\n\nand then write into `x` as before and return `pickle_bytes` (which is a better name than `pickle_str`)",
    "created_at": "2019-02-04T09:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379397",
    "user": "jdemeyer"
}
```

Replying to [comment:12 SimonKing]:
> Another question: The pickling does
> {{{
>             d = <char*>check_malloc(pickle_size)
>             p = self.Data.Data
>             x = d
>             for i in range(self.Data.Nor):
>                 memcpy(x, p, FfCurrentRowSizeIo)
>                 sig_check()
>                 x += FfCurrentRowSizeIo
>                 FfStepPtr(&p)
> }}}
> which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).
> 
> Then, it does
> {{{
>             pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
>             sig_free(d)
> }}}
> 
> If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.
> 
> Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?


```
cdef bytes pickle_bytes = PyBytes_FromStringAndSize(NULL, pickle_size)
cdef char* x = PyBytes_AS_STRING(pickle_bytes)
```

and then write into `x` as before and return `pickle_bytes` (which is a better name than `pickle_str`)



---

archive/issue_comments_379398.json:
```json
{
    "body": "Replying to [comment:11 SimonKing]:\n> Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?\n\nTechnically, yes that would work. But I think it's worse in terms of understanding what the code does: what is the meaning (to a human) of `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo`?\n\nIt's fine for me if you use a different variable name:\n\n```\ncdef Py_ssize_t row_size = FfCurrentRowSizeIo\ncdef Py_ssize_t pickle_size = row_size * self.Data.Nor\n```\n",
    "created_at": "2019-02-04T09:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379398",
    "user": "jdemeyer"
}
```

Replying to [comment:11 SimonKing]:
> Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?

Technically, yes that would work. But I think it's worse in terms of understanding what the code does: what is the meaning (to a human) of `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo`?

It's fine for me if you use a different variable name:

```
cdef Py_ssize_t row_size = FfCurrentRowSizeIo
cdef Py_ssize_t pickle_size = row_size * self.Data.Nor
```




---

archive/issue_comments_379399.json:
```json
{
    "body": "You have\n\n```\npickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)\n```\n\ntwice. Why that?",
    "created_at": "2019-02-04T09:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379399",
    "user": "jdemeyer"
}
```

You have

```
pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)
```

twice. Why that?



---

archive/issue_comments_379400.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> You have\n> {{{\n> pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)\n> }}}\n> twice. Why that?\n\nOops. Thanks for catching it.",
    "created_at": "2019-02-04T09:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379400",
    "user": "SimonKing"
}
```

Replying to [comment:18 jdemeyer]:
> You have
> {{{
> pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)
> }}}
> twice. Why that?

Oops. Thanks for catching it.



---

archive/issue_comments_379401.json:
```json
{
    "body": "Isn't this an unused variable?\n\n```\nnor = self.Data.Nor\n```\n\n\nFor `pickled_rowsize`, I would also use `Py_ssize_t`.",
    "created_at": "2019-02-04T09:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379401",
    "user": "jdemeyer"
}
```

Isn't this an unused variable?

```
nor = self.Data.Nor
```


For `pickled_rowsize`, I would also use `Py_ssize_t`.



---

archive/issue_comments_379402.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-04T11:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379402",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_379403.json:
```json
{
    "body": "The last commit addresses your comments. Also I deal with another potential overflow, namely\n\n```diff\n-            if <size_t>pickled_rowsize == FfCurrentRowSize:\n-                memcpy(OUT.Data.Data, x, OUT.Data.RowSize*OUT.Data.Nor)\n+            if pickled_rowsize == <Py_ssize_t>FfCurrentRowSize:\n+                memcpy(OUT.Data.Data, x, <Py_ssize_t>OUT.Data.RowSize*<Py_ssize_t>OUT.Data.Nor)\n```\n",
    "created_at": "2019-02-04T11:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379403",
    "user": "SimonKing"
}
```

The last commit addresses your comments. Also I deal with another potential overflow, namely

```diff
-            if <size_t>pickled_rowsize == FfCurrentRowSize:
-                memcpy(OUT.Data.Data, x, OUT.Data.RowSize*OUT.Data.Nor)
+            if pickled_rowsize == <Py_ssize_t>FfCurrentRowSize:
+                memcpy(OUT.Data.Data, x, <Py_ssize_t>OUT.Data.RowSize*<Py_ssize_t>OUT.Data.Nor)
```




---

archive/issue_comments_379404.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379404",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_379405.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379405",
    "user": "embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_379406.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379406",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_379407.json:
```json
{
    "body": "red branch",
    "created_at": "2020-01-02T19:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379407",
    "user": "chapoton"
}
```

red branch



---

archive/issue_comments_379408.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-02T19:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379408",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_379409.json:
```json
{
    "body": "Sigh. I totally forgot about that ticket. Really unfortunate that the review wasn't finished.",
    "created_at": "2020-01-02T21:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379409",
    "user": "SimonKing"
}
```

Sigh. I totally forgot about that ticket. Really unfortunate that the review wasn't finished.



---

archive/issue_comments_379410.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-10T20:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379410",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_379411.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-01-10T20:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379411",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_379412.json:
```json
{
    "body": "I hope I succeeded in rebasing the branch. Hopefully this time it doesn't start to bit rot.",
    "created_at": "2020-01-10T20:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379412",
    "user": "SimonKing"
}
```

I hope I succeeded in rebasing the branch. Hopefully this time it doesn't start to bit rot.



---

archive/issue_comments_379413.json:
```json
{
    "body": "The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n\nAlso, why all the changes `size_t` -> `int`?",
    "created_at": "2020-01-14T16:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379413",
    "user": "tscrim"
}
```

The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.

Also, why all the changes `size_t` -> `int`?



---

archive/issue_comments_379414.json:
```json
{
    "body": "Replying to [comment:30 tscrim]:\n> The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n\nOK. I don't recall why this change was made (actually I don't recall THAT such change was made).\n\n> Also, why all the changes `size_t` -> `int`?\n\nI think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.",
    "created_at": "2020-01-14T16:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379414",
    "user": "SimonKing"
}
```

Replying to [comment:30 tscrim]:
> The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.

OK. I don't recall why this change was made (actually I don't recall THAT such change was made).

> Also, why all the changes `size_t` -> `int`?

I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.



---

archive/issue_comments_379415.json:
```json
{
    "body": "Replying to [comment:31 SimonKing]:\n> Replying to [comment:30 tscrim]:\n> > The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n> \n> OK. I don't recall why this change was made (actually I don't recall THAT such change was made).\n\nMy guess from the looks of it comes from a mistake during a merge.\n\n> > Also, why all the changes `size_t` -> `int`?\n> \n> I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.\n\nOkay. I just couldn't see anything in the comments about this, so I was curious. This change is good with me.",
    "created_at": "2020-01-14T17:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379415",
    "user": "tscrim"
}
```

Replying to [comment:31 SimonKing]:
> Replying to [comment:30 tscrim]:
> > The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.
> 
> OK. I don't recall why this change was made (actually I don't recall THAT such change was made).

My guess from the looks of it comes from a mistake during a merge.

> > Also, why all the changes `size_t` -> `int`?
> 
> I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.

Okay. I just couldn't see anything in the comments about this, so I was curious. This change is good with me.



---

archive/issue_comments_379416.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379416",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_379417.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-05-30T06:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379417",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_379418.json:
```json
{
    "body": "the wrong change from richcmp to cmp is still there",
    "created_at": "2020-05-30T06:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379418",
    "user": "chapoton"
}
```

the wrong change from richcmp to cmp is still there



---

archive/issue_comments_379419.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379419",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_379420.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26961",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26961#issuecomment-379420",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
