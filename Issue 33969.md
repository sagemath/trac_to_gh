# Issue 33969: suitesparse: Fix DESTDIR bug

archive/issues_033969.json:
```json
{
    "body": "CC:  @kiwifb\n\n(from #34203#comment:34)\n\n```\n[suitesparse-5.10.1] gcc -std=c99 -L/Users/mkoeppe/s/sage/sage-rebasing/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/local/lib  -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -dynamiclib -compatibility_version 1 -current_version 1.0.2 -Wl,-install_name -Wl,/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.dylib -shared -undefined dynamic_lookup slip_matrix_div.o slip_create_mpq_array.o SLIP_free.o SLIP_LU_factorize.o SLIP_realloc.o slip_matrix_mul.o slip_get_largest_pivot.o slip_ref_triangular_solve.o SLIP_backslash.o slip_create_mpz_array.o slip_get_nonzero_pivot.o SLIP_LU_solve.o slip_back_sub.o slip_cumsum.o slip_get_pivot.o SLIP_malloc.o slip_sparse_collapse.o SLIP_calloc.o slip_dfs.o slip_get_smallest_pivot.o SLIP_matrix_allocate.o slip_sparse_realloc.o slip_cast_array.o slip_expand_double_array.o SLIP_gmp.o SLIP_matrix_copy.o SLIP_matrix_check.o slip_cast_matrix.o slip_expand_mpfr_array.o SLIP_initialize.o SLIP_matrix_free.o slip_check_solution.o slip_expand_mpq_array.o SLIP_initialize_expert.o SLIP_matrix_nnz.o SLIP_create_default_options.o SLIP_finalize.o SLIP_LU_analysis_free.o slip_permute_x.o slip_permute_b.o slip_create_mpfr_array.o slip_forward_sub.o SLIP_LU_analyze.o slip_reach.o -o /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.0.2.dylib -lm -rpath /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -lsuitesparseconfig -lamd -lcolamd -lm -lgmp -lmpfr\n```\n\n`DESTDIR` is used twice in the `-o`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34206\n\n",
    "created_at": "2022-07-21T17:06:10Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "suitesparse: Fix DESTDIR bug",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33969",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kiwifb

(from #34203#comment:34)

```
[suitesparse-5.10.1] gcc -std=c99 -L/Users/mkoeppe/s/sage/sage-rebasing/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/local/lib  -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -dynamiclib -compatibility_version 1 -current_version 1.0.2 -Wl,-install_name -Wl,/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.dylib -shared -undefined dynamic_lookup slip_matrix_div.o slip_create_mpq_array.o SLIP_free.o SLIP_LU_factorize.o SLIP_realloc.o slip_matrix_mul.o slip_get_largest_pivot.o slip_ref_triangular_solve.o SLIP_backslash.o slip_create_mpz_array.o slip_get_nonzero_pivot.o SLIP_LU_solve.o slip_back_sub.o slip_cumsum.o slip_get_pivot.o SLIP_malloc.o slip_sparse_collapse.o SLIP_calloc.o slip_dfs.o slip_get_smallest_pivot.o SLIP_matrix_allocate.o slip_sparse_realloc.o slip_cast_array.o slip_expand_double_array.o SLIP_gmp.o SLIP_matrix_copy.o SLIP_matrix_check.o slip_cast_matrix.o slip_expand_mpfr_array.o SLIP_initialize.o SLIP_matrix_free.o slip_check_solution.o slip_expand_mpq_array.o SLIP_initialize_expert.o SLIP_matrix_nnz.o SLIP_create_default_options.o SLIP_finalize.o SLIP_LU_analysis_free.o slip_permute_x.o slip_permute_b.o slip_create_mpfr_array.o slip_forward_sub.o SLIP_LU_analyze.o slip_reach.o -o /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.0.2.dylib -lm -rpath /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -lsuitesparseconfig -lamd -lcolamd -lm -lgmp -lmpfr
```

`DESTDIR` is used twice in the `-o`.

Issue created by migration from https://trac.sagemath.org/ticket/34206





---

archive/issue_comments_481697.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-07-21T17:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481697",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_481698.json:
```json
{
    "body": "https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/86 - \"build system: Support staged installs via DESTDIR\"",
    "created_at": "2022-07-21T17:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481698",
    "user": "https://github.com/mkoeppe"
}
```

https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/86 - "build system: Support staged installs via DESTDIR"



---

archive/issue_comments_481699.json:
```json
{
    "body": "My original spkg was always a quick and dirty job. It shouldn't be a surprise that some bugs appear.",
    "created_at": "2022-07-21T21:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481699",
    "user": "https://github.com/kiwifb"
}
```

My original spkg was always a quick and dirty job. It shouldn't be a surprise that some bugs appear.



---

archive/issue_events_089240.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33969#event-89240"
}
```



---

archive/issue_comments_481700.json:
```json
{
    "body": "I guess I should have a stab at this.",
    "created_at": "2022-12-07T20:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481700",
    "user": "https://github.com/kiwifb"
}
```

I guess I should have a stab at this.



---

archive/issue_comments_481701.json:
```json
{
    "body": "Way too many things are built by default. We can split the package or at least not building the big stuff that we do not need like graphblas and mongoose which are very specialised stuff.",
    "created_at": "2022-12-07T20:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481701",
    "user": "https://github.com/kiwifb"
}
```

Way too many things are built by default. We can split the package or at least not building the big stuff that we do not need like graphblas and mongoose which are very specialised stuff.



---

archive/issue_comments_481702.json:
```json
{
    "body": "I think our optional `igraph` package uses graphblas",
    "created_at": "2022-12-07T20:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481702",
    "user": "https://github.com/mkoeppe"
}
```

I think our optional `igraph` package uses graphblas



---

archive/issue_comments_481703.json:
```json
{
    "body": "That's new and graphblas wasn't built before because I had removed all the subpackages using cmake at the time the initial suitesparse was included in sage. But if it can be used, why not.\n\nIn other news, `DESTDIR` works properly in 6.0.1 after some basic testing.",
    "created_at": "2022-12-07T20:53:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481703",
    "user": "https://github.com/kiwifb"
}
```

That's new and graphblas wasn't built before because I had removed all the subpackages using cmake at the time the initial suitesparse was included in sage. But if it can be used, why not.

In other news, `DESTDIR` works properly in 6.0.1 after some basic testing.



---

archive/issue_comments_481704.json:
```json
{
    "body": "Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.",
    "created_at": "2022-12-07T21:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481704",
    "user": "https://github.com/kiwifb"
}
```

Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.



---

archive/issue_comments_481705.json:
```json
{
    "body": "I am testing a first draft locally. The changes are big enough that none of the current patches actually apply or are meaningful. I will need your input for any tweaks you require for BLAS/LAPACK on OS X. It should be easy enough to figure out if something is needed.",
    "created_at": "2022-12-07T21:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481705",
    "user": "https://github.com/kiwifb"
}
```

I am testing a first draft locally. The changes are big enough that none of the current patches actually apply or are meaningful. I will need your input for any tweaks you require for BLAS/LAPACK on OS X. It should be easy enough to figure out if something is needed.



---

archive/issue_comments_481706.json:
```json
{
    "body": "Replying to [comment:11 Fran\u00e7ois Bissey]:\n> Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.\n\n\nSorry for the noise - looks like I misremembered",
    "created_at": "2022-12-07T22:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481706",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:11 François Bissey]:
> Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.


Sorry for the noise - looks like I misremembered



---

archive/issue_comments_481707.json:
```json
{
    "body": "Do we want to build and install static libraries?",
    "created_at": "2022-12-07T22:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481707",
    "user": "https://github.com/kiwifb"
}
```

Do we want to build and install static libraries?



---

archive/issue_comments_481708.json:
```json
{
    "body": "No, only shared",
    "created_at": "2022-12-07T22:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481708",
    "user": "https://github.com/mkoeppe"
}
```

No, only shared



---

archive/issue_comments_481709.json:
```json
{
    "body": "Ready for inspection.",
    "created_at": "2022-12-07T22:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481709",
    "user": "https://github.com/kiwifb"
}
```

Ready for inspection.



---

archive/issue_comments_481710.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-07T22:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481710",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_481711.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-12-07T22:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481711",
    "user": "https://github.com/kiwifb"
}
```

New commits:



---

archive/issue_comments_481712.json:
```json
{
    "body": "OK got the right branch name this time.",
    "created_at": "2022-12-07T22:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481712",
    "user": "https://github.com/kiwifb"
}
```

OK got the right branch name this time.



---

archive/issue_comments_481713.json:
```json
{
    "body": "Builds OK on macOS",
    "created_at": "2022-12-09T19:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481713",
    "user": "https://github.com/mkoeppe"
}
```

Builds OK on macOS



---

archive/issue_comments_481714.json:
```json
{
    "body": "However it builds against the Accelerate framework, not our openblas:\n\n```\n otool -L local/lib/libumfpack.dylib                                                                                                         git:t/34206/suitesparse6.0.1\nlocal/lib/libumfpack.dylib:\n        @rpath/libumfpack.6.dylib (compatibility version 6.0.0, current version 6.0.1)\n        @rpath/libsuitesparseconfig.6.dylib (compatibility version 6.0.0, current version 6.0.1)\n        /usr/local/opt/libomp/lib/libomp.dylib (compatibility version 5.0.0, current version 5.0.0)\n        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)\n        @rpath/libamd.3.dylib (compatibility version 3.0.0, current version 3.0.0)\n        /System/Library/Frameworks/Accelerate.framework/Versions/A/Accelerate (compatibility version 1.0.0, current version 4.0.0)\n        @rpath/libcholmod.4.dylib (compatibility version 4.0.0, current version 4.0.1)\n```",
    "created_at": "2022-12-09T19:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481714",
    "user": "https://github.com/mkoeppe"
}
```

However it builds against the Accelerate framework, not our openblas:

```
 otool -L local/lib/libumfpack.dylib                                                                                                         git:t/34206/suitesparse6.0.1
local/lib/libumfpack.dylib:
        @rpath/libumfpack.6.dylib (compatibility version 6.0.0, current version 6.0.1)
        @rpath/libsuitesparseconfig.6.dylib (compatibility version 6.0.0, current version 6.0.1)
        /usr/local/opt/libomp/lib/libomp.dylib (compatibility version 5.0.0, current version 5.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
        @rpath/libamd.3.dylib (compatibility version 3.0.0, current version 3.0.0)
        /System/Library/Frameworks/Accelerate.framework/Versions/A/Accelerate (compatibility version 1.0.0, current version 4.0.0)
        @rpath/libcholmod.4.dylib (compatibility version 4.0.0, current version 4.0.1)
```



---

archive/issue_comments_481715.json:
```json
{
    "body": "That's what I thought could happen. I think, I can make it go for openblas easily, I found the doc for it, the other day.\n\nThis is also a relatively stripped down build like boost_cropped. I probably should add a few more sub-packages if we want to really dignify it with the full \"suitesparse\" name. And I also should write a few comments.",
    "created_at": "2022-12-09T22:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481715",
    "user": "https://github.com/kiwifb"
}
```

That's what I thought could happen. I think, I can make it go for openblas easily, I found the doc for it, the other day.

This is also a relatively stripped down build like boost_cropped. I probably should add a few more sub-packages if we want to really dignify it with the full "suitesparse" name. And I also should write a few comments.



---

archive/issue_comments_481716.json:
```json
{
    "body": "And upstream is preparing 6.0.2. But the bump would be trivial on this branch.",
    "created_at": "2022-12-09T22:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481716",
    "user": "https://github.com/kiwifb"
}
```

And upstream is preparing 6.0.2. But the bump would be trivial on this branch.



---

archive/issue_comments_481717.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-09T22:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481717",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481718.json:
```json
{
    "body": "This gets openblas but not the right one on my macOS system.\n\n```\n[suitesparse-6.0.1] -- BLAS libraries:      /opt/local/lib/libopenblas.dylib \n[suitesparse-6.0.1] -- BLAS linker flags:    \n[suitesparse-6.0.1] -- LAPACK libraries:    /opt/local/lib/libopenblas.dylib;/opt/local/lib/libopenblas.dylib \n[suitesparse-6.0.1] -- LAPACK linker flags:  \n```",
    "created_at": "2022-12-10T00:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481718",
    "user": "https://github.com/mkoeppe"
}
```

This gets openblas but not the right one on my macOS system.

```
[suitesparse-6.0.1] -- BLAS libraries:      /opt/local/lib/libopenblas.dylib 
[suitesparse-6.0.1] -- BLAS linker flags:    
[suitesparse-6.0.1] -- LAPACK libraries:    /opt/local/lib/libopenblas.dylib;/opt/local/lib/libopenblas.dylib 
[suitesparse-6.0.1] -- LAPACK linker flags:  
```



---

archive/issue_comments_481719.json:
```json
{
    "body": "The following change fixes it for me:\n\n```\ndiff --git a/build/pkgs/suitesparse/spkg-build.in b/build/pkgs/suitesparse/spkg-build.in\nindex b137a5ecb9..822519b078 100644\n--- a/build/pkgs/suitesparse/spkg-build.in\n+++ b/build/pkgs/suitesparse/spkg-build.in\n@@ -11,7 +11,10 @@ for pkg in ${pkg_list}; do\n \t# Enforce usage of OpenBlas\n \t# No static libraries\n \t# Verbose builds\n-\tsdh_cmake -DBLA_VENDOR=OpenBLAS -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..\n+\tsdh_cmake -DBLA_VENDOR=OpenBLAS \\\n+                  -DBLAS_LIBRARIES=\"$(pkg-config --libs blas)\" \\\n+                  -DLAPACK_LIBRARIES=\"$(pkg-config --libs lapack)\" \\\n+                  -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..\n \t# Build\n \tsdh_make\n \tpopd\n```",
    "created_at": "2022-12-10T00:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481719",
    "user": "https://github.com/mkoeppe"
}
```

The following change fixes it for me:

```
diff --git a/build/pkgs/suitesparse/spkg-build.in b/build/pkgs/suitesparse/spkg-build.in
index b137a5ecb9..822519b078 100644
--- a/build/pkgs/suitesparse/spkg-build.in
+++ b/build/pkgs/suitesparse/spkg-build.in
@@ -11,7 +11,10 @@ for pkg in ${pkg_list}; do
 	# Enforce usage of OpenBlas
 	# No static libraries
 	# Verbose builds
-	sdh_cmake -DBLA_VENDOR=OpenBLAS -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..
+	sdh_cmake -DBLA_VENDOR=OpenBLAS \
+                  -DBLAS_LIBRARIES="$(pkg-config --libs blas)" \
+                  -DLAPACK_LIBRARIES="$(pkg-config --libs lapack)" \
+                  -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..
 	# Build
 	sdh_make
 	popd
```



---

archive/issue_comments_481720.json:
```json
{
    "body": "Yes, system wide would be picked up first without a hint. Pushing shortly.",
    "created_at": "2022-12-10T01:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481720",
    "user": "https://github.com/kiwifb"
}
```

Yes, system wide would be picked up first without a hint. Pushing shortly.



---

archive/issue_comments_481721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-10T01:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481722.json:
```json
{
    "body": "Failing on `centos-stream-9-python3.9-standard` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6192051075)\n\n```\nCMake Error at CMakeLists.txt:14 (cmake_minimum_required):\n  CMake 3.22 or higher is required.  You are running version 3.20.2\n```\nThis will need an increased lower bound for system cmake - increased from #34746, which set 3.11)",
    "created_at": "2022-12-11T00:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481722",
    "user": "https://github.com/mkoeppe"
}
```

Failing on `centos-stream-9-python3.9-standard` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6192051075)

```
CMake Error at CMakeLists.txt:14 (cmake_minimum_required):
  CMake 3.22 or higher is required.  You are running version 3.20.2
```
This will need an increased lower bound for system cmake - increased from #34746, which set 3.11)



---

archive/issue_comments_481723.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-12-11T00:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481723",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_481724.json:
```json
{
    "body": "On `debian-sid-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588473):\n\n```\n[suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:643:65: error: expected ')' before ',' token\n  [suitesparse-6.0.1]     643 |     #define SUITESPARSE_BLAS(name,NAME) SUITESPARSE_FORTRAN(name,NAME)\n  [suitesparse-6.0.1]         |                                                                 ^\n  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:676:37: note: in expansion of macro 'SUITESPARSE_BLAS'\n  [suitesparse-6.0.1]     676 | #define SUITESPARSE_LAPACK_ZLARF    SUITESPARSE_BLAS ( zlarf  , ZLAR   )\n  [suitesparse-6.0.1]         |                                     ^~~~~~~~~~~~~~~~\n  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:1434:6: note: in expansion of macro 'SUITESPARSE_LAPACK_ZLARF'\n  [suitesparse-6.0.1]    1434 | void SUITESPARSE_LAPACK_ZLARF       // apply Householder reflector\n  [suitesparse-6.0.1]         |      ^~~~~~~~~~~~~~~~~~~~~~~~\n  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1465: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_solve.c.o] Error 1\n  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1479: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_symbolic.c.o] Error 1\n  [suitesparse-6.0.1]   make[5]: Target 'CMakeFiles/cholmod.dir/build' not remade because of errors.\n```",
    "created_at": "2022-12-11T09:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481724",
    "user": "https://github.com/mkoeppe"
}
```

On `debian-sid-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588473):

```
[suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:643:65: error: expected ')' before ',' token
  [suitesparse-6.0.1]     643 |     #define SUITESPARSE_BLAS(name,NAME) SUITESPARSE_FORTRAN(name,NAME)
  [suitesparse-6.0.1]         |                                                                 ^
  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:676:37: note: in expansion of macro 'SUITESPARSE_BLAS'
  [suitesparse-6.0.1]     676 | #define SUITESPARSE_LAPACK_ZLARF    SUITESPARSE_BLAS ( zlarf  , ZLAR   )
  [suitesparse-6.0.1]         |                                     ^~~~~~~~~~~~~~~~
  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:1434:6: note: in expansion of macro 'SUITESPARSE_LAPACK_ZLARF'
  [suitesparse-6.0.1]    1434 | void SUITESPARSE_LAPACK_ZLARF       // apply Householder reflector
  [suitesparse-6.0.1]         |      ^~~~~~~~~~~~~~~~~~~~~~~~
  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1465: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_solve.c.o] Error 1
  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1479: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_symbolic.c.o] Error 1
  [suitesparse-6.0.1]   make[5]: Target 'CMakeFiles/cholmod.dir/build' not remade because of errors.
```



---

archive/issue_comments_481725.json:
```json
{
    "body": "Can't seem to see the log from that run. What compiler is sid currently using?",
    "created_at": "2022-12-11T10:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481725",
    "user": "https://github.com/kiwifb"
}
```

Can't seem to see the log from that run. What compiler is sid currently using?



---

archive/issue_comments_481726.json:
```json
{
    "body": "That's gcc 12.2.0-9.1",
    "created_at": "2022-12-11T18:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481726",
    "user": "https://github.com/mkoeppe"
}
```

That's gcc 12.2.0-9.1



---

archive/issue_comments_481727.json:
```json
{
    "body": "Same on `debian-bookworm-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588437, `docker run -it  ghcr.io/mkoeppe/sage/sage-docker-debian-bookworm-minimal-with-targets-pre:9.5-107209-g31c5448dc1-failed bash`)\nand on `ubuntu-kinetic-minimal` and `fedora-36-minimal`",
    "created_at": "2022-12-11T19:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481727",
    "user": "https://github.com/mkoeppe"
}
```

Same on `debian-bookworm-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588437, `docker run -it  ghcr.io/mkoeppe/sage/sage-docker-debian-bookworm-minimal-with-targets-pre:9.5-107209-g31c5448dc1-failed bash`)
and on `ubuntu-kinetic-minimal` and `fedora-36-minimal`



---

archive/issue_comments_481728.json:
```json
{
    "body": "I wonder if it has to do with \n\n```\n-- Detecting Fortran/C Interface\nFailed to compile\n```\nWhen cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.",
    "created_at": "2022-12-11T21:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481728",
    "user": "https://github.com/kiwifb"
}
```

I wonder if it has to do with 

```
-- Detecting Fortran/C Interface
Failed to compile
```
When cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.



---

archive/issue_comments_481729.json:
```json
{
    "body": "While it is annoying, we could turn off the bits needing blas/lapack which seem to be the one involved here. But really I suspect there is something fishy in the compiler.",
    "created_at": "2022-12-11T21:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481729",
    "user": "https://github.com/kiwifb"
}
```

While it is annoying, we could turn off the bits needing blas/lapack which seem to be the one involved here. But really I suspect there is something fishy in the compiler.



---

archive/issue_comments_481730.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-11T22:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481731.json:
```json
{
    "body": "`tox -e docker-debian-bookworm-minimal-incremental -- suitesparse` gives the same errors",
    "created_at": "2022-12-12T00:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481731",
    "user": "https://github.com/mkoeppe"
}
```

`tox -e docker-debian-bookworm-minimal-incremental -- suitesparse` gives the same errors



---

archive/issue_comments_481732.json:
```json
{
    "body": "I am running out of ideas on what can cause this. Some compiler setting is the most obvious culprit, but what would it be. Can you get access to the docker instance to fish stuff out of it?",
    "created_at": "2022-12-12T00:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481732",
    "user": "https://github.com/kiwifb"
}
```

I am running out of ideas on what can cause this. Some compiler setting is the most obvious culprit, but what would it be. Can you get access to the docker instance to fish stuff out of it?



---

archive/issue_comments_481733.json:
```json
{
    "body": "6.0.2 is just out, so I will bump that and we will see if it helps.",
    "created_at": "2022-12-12T02:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481733",
    "user": "https://github.com/kiwifb"
}
```

6.0.2 is just out, so I will bump that and we will see if it helps.



---

archive/issue_comments_481734.json:
```json
{
    "body": "I've set up a separate GH Actions test at https://github.com/mkoeppe/SuiteSparse/actions/runs/3672968344",
    "created_at": "2022-12-12T03:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481734",
    "user": "https://github.com/mkoeppe"
}
```

I've set up a separate GH Actions test at https://github.com/mkoeppe/SuiteSparse/actions/runs/3672968344



---

archive/issue_comments_481735.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-12T03:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481736.json:
```json
{
    "body": "pushed this commit to address comment:29\n\n---\nNew commits:",
    "created_at": "2022-12-12T05:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481736",
    "user": "https://github.com/mkoeppe"
}
```

pushed this commit to address comment:29

---
New commits:



---

archive/issue_comments_481737.json:
```json
{
    "body": "Forgot about doing that thanks.",
    "created_at": "2022-12-12T06:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481737",
    "user": "https://github.com/kiwifb"
}
```

Forgot about doing that thanks.



---

archive/issue_comments_481738.json:
```json
{
    "body": "Adding #34835 as it will make the test builds quicker",
    "created_at": "2022-12-12T07:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481738",
    "user": "https://github.com/mkoeppe"
}
```

Adding #34835 as it will make the test builds quicker



---

archive/issue_comments_481739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-12T07:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481740.json:
```json
{
    "body": "Replying to [comment:34 Fran\u00e7ois Bissey]:\n> I wonder if it has to do with \n> \n> ```\n> -- Detecting Fortran/C Interface\n> Failed to compile\n> ```\n> When cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.\n\n\nYes, I think that's the problem",
    "created_at": "2022-12-12T08:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481740",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:34 François Bissey]:
> I wonder if it has to do with 
> 
> ```
> -- Detecting Fortran/C Interface
> Failed to compile
> ```
> When cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.


Yes, I think that's the problem



---

archive/issue_comments_481741.json:
```json
{
    "body": "The only thing I can think about is that openblas was compiled with a different gfortran but it feels far fetched.",
    "created_at": "2022-12-12T08:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481741",
    "user": "https://github.com/kiwifb"
}
```

The only thing I can think about is that openblas was compiled with a different gfortran but it feels far fetched.



---

archive/issue_comments_481742.json:
```json
{
    "body": "In one of the failing builds, I see the following in `SuiteSparse_config/build/CMakeFiles/CMakeError.log`:\n\n```\n[100%] Linking Fortran executable FortranCInterface\nlto1: internal compiler error: compiler does not support ZSTD LTO compression\n0x9c311c lto_end_uncompression(lto_compression_stream*, lto_compression)\n\t../../src/gcc/lto-compress.cc:411\n0x9c1910 lto_get_section_data(lto_file_decl_data*, lto_section_type, char const*, int, unsigned long*, bool)\n\t../../src/gcc/lto-section-in.cc:168\n0x6929c5 lto_file_finalize\n\t../../src/gcc/lto/lto-common.cc:2264\n0x6929c5 lto_create_files_from_ids\n\t../../src/gcc/lto/lto-common.cc:2282\n0x6929c5 lto_file_read\n\t../../src/gcc/lto/lto-common.cc:2337\n0x6929c5 read_cgraph_and_symbols(unsigned int, char const**)\n\t../../src/gcc/lto/lto-common.cc:2785\n0x680312 lto_main()\n\t../../src/gcc/lto/lto.cc:626\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nPlease include the complete backtrace with any bug report.\nSee <https://gcc.gnu.org/bugs/> for instructions.\nlto-wrapper: fatal error: /sage/local/bin/gfortran returned 1 exit status\ncompilation terminated.\n```",
    "created_at": "2022-12-12T08:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481742",
    "user": "https://github.com/mkoeppe"
}
```

In one of the failing builds, I see the following in `SuiteSparse_config/build/CMakeFiles/CMakeError.log`:

```
[100%] Linking Fortran executable FortranCInterface
lto1: internal compiler error: compiler does not support ZSTD LTO compression
0x9c311c lto_end_uncompression(lto_compression_stream*, lto_compression)
	../../src/gcc/lto-compress.cc:411
0x9c1910 lto_get_section_data(lto_file_decl_data*, lto_section_type, char const*, int, unsigned long*, bool)
	../../src/gcc/lto-section-in.cc:168
0x6929c5 lto_file_finalize
	../../src/gcc/lto/lto-common.cc:2264
0x6929c5 lto_create_files_from_ids
	../../src/gcc/lto/lto-common.cc:2282
0x6929c5 lto_file_read
	../../src/gcc/lto/lto-common.cc:2337
0x6929c5 read_cgraph_and_symbols(unsigned int, char const**)
	../../src/gcc/lto/lto-common.cc:2785
0x680312 lto_main()
	../../src/gcc/lto/lto.cc:626
Please submit a full bug report, with preprocessed source (by using -freport-bug).
Please include the complete backtrace with any bug report.
See <https://gcc.gnu.org/bugs/> for instructions.
lto-wrapper: fatal error: /sage/local/bin/gfortran returned 1 exit status
compilation terminated.
```



---

archive/issue_comments_481743.json:
```json
{
    "body": "In the failing configurations, we are using system `gcc` but our own `gfortran`. This may be a mismatch between them regarding `zstd` support.",
    "created_at": "2022-12-12T08:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481743",
    "user": "https://github.com/mkoeppe"
}
```

In the failing configurations, we are using system `gcc` but our own `gfortran`. This may be a mismatch between them regarding `zstd` support.



---

archive/issue_comments_481744.json:
```json
{
    "body": "Yes, it starts making much more sense.",
    "created_at": "2022-12-12T08:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481744",
    "user": "https://github.com/kiwifb"
}
```

Yes, it starts making much more sense.



---

archive/issue_comments_481745.json:
```json
{
    "body": "But there should be other similar failures potentially - at least you would think, since this is also tested in autoconf packages as soon blas/lapack is mixed with C code.",
    "created_at": "2022-12-12T08:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481745",
    "user": "https://github.com/kiwifb"
}
```

But there should be other similar failures potentially - at least you would think, since this is also tested in autoconf packages as soon blas/lapack is mixed with C code.



---

archive/issue_comments_481746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-12T08:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481747.json:
```json
{
    "body": "Let's try this",
    "created_at": "2022-12-12T08:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481747",
    "user": "https://github.com/mkoeppe"
}
```

Let's try this



---

archive/issue_comments_481748.json:
```json
{
    "body": "If it works, I'll have to re-enable \"supernodal\" in cholmod.",
    "created_at": "2022-12-12T08:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481748",
    "user": "https://github.com/kiwifb"
}
```

If it works, I'll have to re-enable "supernodal" in cholmod.



---

archive/issue_comments_481749.json:
```json
{
    "body": "running at https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225",
    "created_at": "2022-12-12T08:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481749",
    "user": "https://github.com/mkoeppe"
}
```

running at https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225



---

archive/issue_comments_481750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-12T09:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481750",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481751.json:
```json
{
    "body": "still failing - https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225/jobs/6211825144",
    "created_at": "2022-12-12T09:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481751",
    "user": "https://github.com/mkoeppe"
}
```

still failing - https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225/jobs/6211825144



---

archive/issue_comments_481752.json:
```json
{
    "body": "in the failing build, gfortran still does not list zstd as a supported compression algorithm:\n\n```\n/sage/local/bin/gfortran -v\nUsing built-in specs.\nCOLLECT_GCC=/sage/local/bin/gfortran\nCOLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper\nTarget: x86_64-pc-linux-gnu\nConfigured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++\nThread model: posix\nSupported LTO compression algorithms: zlib\ngcc version 12.2.0 (GCC) \n```",
    "created_at": "2022-12-12T09:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481752",
    "user": "https://github.com/mkoeppe"
}
```

in the failing build, gfortran still does not list zstd as a supported compression algorithm:

```
/sage/local/bin/gfortran -v
Using built-in specs.
COLLECT_GCC=/sage/local/bin/gfortran
COLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper
Target: x86_64-pc-linux-gnu
Configured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 12.2.0 (GCC) 
```



---

archive/issue_comments_481753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-12T09:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481754.json:
```json
{
    "body": "In gentoo we just seem to do `make -C lib install`. Although there is also a `make -C lib libzstd.pc` during the build phase.",
    "created_at": "2022-12-12T09:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481754",
    "user": "https://github.com/kiwifb"
}
```

In gentoo we just seem to do `make -C lib install`. Although there is also a `make -C lib libzstd.pc` during the build phase.



---

archive/issue_comments_481755.json:
```json
{
    "body": "Installing `zstd` may not be enough, you may have to tell gcc's configure to use it `--with-zstd`. But really, we want to match the support from the host gcc. So, it may be more complicated to achieve.",
    "created_at": "2022-12-12T09:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481755",
    "user": "https://github.com/kiwifb"
}
```

Installing `zstd` may not be enough, you may have to tell gcc's configure to use it `--with-zstd`. But really, we want to match the support from the host gcc. So, it may be more complicated to achieve.



---

archive/issue_comments_481756.json:
```json
{
    "body": "gfortran is now configured correctly\n\n```\n# local/bin/gfortran -v\nUsing built-in specs.\nCOLLECT_GCC=local/bin/gfortran\nCOLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper\nTarget: x86_64-pc-linux-gnu\nConfigured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++\nThread model: posix\nSupported LTO compression algorithms: zlib zstd\ngcc version 12.2.0 (GCC) \n```",
    "created_at": "2022-12-12T10:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481756",
    "user": "https://github.com/mkoeppe"
}
```

gfortran is now configured correctly

```
# local/bin/gfortran -v
Using built-in specs.
COLLECT_GCC=local/bin/gfortran
COLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper
Target: x86_64-pc-linux-gnu
Configured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 12.2.0 (GCC) 
```



---

archive/issue_comments_481757.json:
```json
{
    "body": "Replying to [comment:62 Fran\u00e7ois Bissey]:\n> we want to match the support from the host gcc. So, it may be more complicated to achieve.\n\n\nQuite possible that this is needed, yes",
    "created_at": "2022-12-12T10:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481757",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:62 François Bissey]:
> we want to match the support from the host gcc. So, it may be more complicated to achieve.


Quite possible that this is needed, yes



---

archive/issue_comments_481758.json:
```json
{
    "body": "suitesparse still fails to build.\n\ncomment:49 has changed - getting a different error now\n\n```\n# cat SuiteSparse_config/build/CMakeFiles/CMakeError.log\nmake[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'\nmake[6]: Leaving directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'\nmake[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'\n[ 92%] Building Fortran object CMakeFiles/FortranCInterface.dir/main.F.o\n[ 94%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_sub.f.o\n[ 97%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_mod.f90.o\n[100%] Linking Fortran executable FortranCInterface\nlto1: internal compiler error: bytecode stream: expected tag LTO_function instead of LTO_eh_table\n0x9b4cc1 lto_tag_check\n\t../../src/gcc/lto-streamer.h:1028\n0x9b4cc1 input_function\n\t../../src/gcc/lto-streamer-in.cc:1361\n0x9b4cc1 lto_read_body_or_constructor\n\t../../src/gcc/lto-streamer-in.cc:1621\n0x7020ce cgraph_node::get_untransformed_body()\n\t../../src/gcc/cgraph.cc:4011\n0x70c48d cgraph_node::expand()\n\t../../src/gcc/cgraphunit.cc:1806\n0x70c48d cgraph_node::expand()\n\t../../src/gcc/cgraphunit.cc:1788\n0x70da4e expand_all_functions\n\t../../src/gcc/cgraphunit.cc:1999\n0x70da4e symbol_table::compile()\n\t../../src/gcc/cgraphunit.cc:2349\n0x680901 lto_main()\n\t../../src/gcc/lto/lto.cc:657\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nPlease include the complete backtrace with any bug report.\nSee <https://gcc.gnu.org/bugs/> for instructions.\nmake[7]: *** [/tmp/ccL3cCy7.mk:2: /tmp/cc63Hwwl.ltrans0.ltrans.o] Error 1\n```",
    "created_at": "2022-12-12T10:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481758",
    "user": "https://github.com/mkoeppe"
}
```

suitesparse still fails to build.

comment:49 has changed - getting a different error now

```
# cat SuiteSparse_config/build/CMakeFiles/CMakeError.log
make[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
make[6]: Leaving directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
make[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
[ 92%] Building Fortran object CMakeFiles/FortranCInterface.dir/main.F.o
[ 94%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_sub.f.o
[ 97%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_mod.f90.o
[100%] Linking Fortran executable FortranCInterface
lto1: internal compiler error: bytecode stream: expected tag LTO_function instead of LTO_eh_table
0x9b4cc1 lto_tag_check
	../../src/gcc/lto-streamer.h:1028
0x9b4cc1 input_function
	../../src/gcc/lto-streamer-in.cc:1361
0x9b4cc1 lto_read_body_or_constructor
	../../src/gcc/lto-streamer-in.cc:1621
0x7020ce cgraph_node::get_untransformed_body()
	../../src/gcc/cgraph.cc:4011
0x70c48d cgraph_node::expand()
	../../src/gcc/cgraphunit.cc:1806
0x70c48d cgraph_node::expand()
	../../src/gcc/cgraphunit.cc:1788
0x70da4e expand_all_functions
	../../src/gcc/cgraphunit.cc:1999
0x70da4e symbol_table::compile()
	../../src/gcc/cgraphunit.cc:2349
0x680901 lto_main()
	../../src/gcc/lto/lto.cc:657
Please submit a full bug report, with preprocessed source (by using -freport-bug).
Please include the complete backtrace with any bug report.
See <https://gcc.gnu.org/bugs/> for instructions.
make[7]: *** [/tmp/ccL3cCy7.mk:2: /tmp/cc63Hwwl.ltrans0.ltrans.o] Error 1
```



---

archive/issue_comments_481759.json:
```json
{
    "body": "This will need more work on another day",
    "created_at": "2022-12-12T10:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481759",
    "user": "https://github.com/mkoeppe"
}
```

This will need more work on another day



---

archive/issue_comments_481760.json:
```json
{
    "body": "I have given it some thoughts. bookworm and sid are the only you report failing at this stage. It looks to me that they are both using gcc-12.2.0+patches - gentoo currently similarly ship gcc-12.2.1_pre20221210, some kind of pre-release. It seems it has incompatibilities with earlier gcc/gfortran releases, at least in debian. And our gcc/gfortran is an earlier and official release. I don't see a way out of this that doesn't forbid this version of the compiler unless there are both gcc and gfortran installed.",
    "created_at": "2022-12-14T19:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481760",
    "user": "https://github.com/kiwifb"
}
```

I have given it some thoughts. bookworm and sid are the only you report failing at this stage. It looks to me that they are both using gcc-12.2.0+patches - gentoo currently similarly ship gcc-12.2.1_pre20221210, some kind of pre-release. It seems it has incompatibilities with earlier gcc/gfortran releases, at least in debian. And our gcc/gfortran is an earlier and official release. I don't see a way out of this that doesn't forbid this version of the compiler unless there are both gcc and gfortran installed.



---

archive/issue_comments_481761.json:
```json
{
    "body": "I agree, the Debian patches are likely the cause for the incompatibility. I think the LTO data comes with a version annotation, and Debian should probably have bumped the version along with their patches.\n\n(We also carry a patch, for macOS M1/M2 support, but I don't think it is the problem here.)",
    "created_at": "2022-12-14T20:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33969#issuecomment-481761",
    "user": "https://github.com/mkoeppe"
}
```

I agree, the Debian patches are likely the cause for the incompatibility. I think the LTO data comes with a version annotation, and Debian should probably have bumped the version along with their patches.

(We also carry a patch, for macOS M1/M2 support, but I don't think it is the problem here.)
