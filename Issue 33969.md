# Issue 33969: suitesparse: Fix DESTDIR bug

Issue created by migration from https://trac.sagemath.org/ticket/34206

Original creator: mkoeppe

Original creation time: 2022-07-21 17:06:10

CC:  fbissey

(from #34203#comment:34)


```
[suitesparse-5.10.1] gcc -std=c99 -L/Users/mkoeppe/s/sage/sage-rebasing/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/local/lib  -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -dynamiclib -compatibility_version 1 -current_version 1.0.2 -Wl,-install_name -Wl,/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.dylib -shared -undefined dynamic_lookup slip_matrix_div.o slip_create_mpq_array.o SLIP_free.o SLIP_LU_factorize.o SLIP_realloc.o slip_matrix_mul.o slip_get_largest_pivot.o slip_ref_triangular_solve.o SLIP_backslash.o slip_create_mpz_array.o slip_get_nonzero_pivot.o SLIP_LU_solve.o slip_back_sub.o slip_cumsum.o slip_get_pivot.o SLIP_malloc.o slip_sparse_collapse.o SLIP_calloc.o slip_dfs.o slip_get_smallest_pivot.o SLIP_matrix_allocate.o slip_sparse_realloc.o slip_cast_array.o slip_expand_double_array.o SLIP_gmp.o SLIP_matrix_copy.o SLIP_matrix_check.o slip_cast_matrix.o slip_expand_mpfr_array.o SLIP_initialize.o SLIP_matrix_free.o slip_check_solution.o slip_expand_mpq_array.o SLIP_initialize_expert.o SLIP_matrix_nnz.o SLIP_create_default_options.o SLIP_finalize.o SLIP_LU_analysis_free.o slip_permute_x.o slip_permute_b.o slip_create_mpfr_array.o slip_forward_sub.o SLIP_LU_analyze.o slip_reach.o -o /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib/libsliplu.1.0.2.dylib -lm -rpath /Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/inst/Users/mkoeppe/s/sage/sage-rebasing/local/var/tmp/sage/build/suitesparse-5.10.1/src/lib -lsuitesparseconfig -lamd -lcolamd -lm -lgmp -lmpfr
```


`DESTDIR` is used twice in the `-o`.


---

Comment by mkoeppe created at 2022-07-21 17:28:32

New commits:


---

Comment by mkoeppe created at 2022-07-21 17:47:00

https://github.com/DrTimothyAldenDavis/SuiteSparse/issues/86 - "build system: Support staged installs via DESTDIR"


---

Comment by fbissey created at 2022-07-21 21:03:01

My original spkg was always a quick and dirty job. It shouldn't be a surprise that some bugs appear.


---

Comment by fbissey created at 2022-12-07 20:08:28

I guess I should have a stab at this.


---

Comment by fbissey created at 2022-12-07 20:30:43

Way too many things are built by default. We can split the package or at least not building the big stuff that we do not need like graphblas and mongoose which are very specialised stuff.


---

Comment by mkoeppe created at 2022-12-07 20:40:48

I think our optional `igraph` package uses graphblas


---

Comment by fbissey created at 2022-12-07 20:53:32

That's new and graphblas wasn't built before because I had removed all the subpackages using cmake at the time the initial suitesparse was included in sage. But if it can be used, why not.

In other news, `DESTDIR` works properly in 6.0.1 after some basic testing.


---

Comment by fbissey created at 2022-12-07 21:06:26

Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.


---

Comment by fbissey created at 2022-12-07 21:41:37

I am testing a first draft locally. The changes are big enough that none of the current patches actually apply or are meaningful. I will need your input for any tweaks you require for BLAS/LAPACK on OS X. It should be easy enough to figure out if something is needed.


---

Comment by mkoeppe created at 2022-12-07 22:32:24

Replying to [comment:11 François Bissey]:
> Cannot see a dependency on GraphBLAS in igraph but if you can point to it, I'll certainly include it.

Sorry for the noise - looks like I misremembered


---

Comment by fbissey created at 2022-12-07 22:43:13

Do we want to build and install static libraries?


---

Comment by mkoeppe created at 2022-12-07 22:44:10

No, only shared


---

Comment by fbissey created at 2022-12-07 22:49:46

Ready for inspection.


---

Comment by fbissey created at 2022-12-07 22:49:46

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-12-07 22:50:54

New commits:


---

Comment by fbissey created at 2022-12-07 22:51:09

OK got the right branch name this time.


---

Comment by mkoeppe created at 2022-12-09 19:32:28

Builds OK on macOS


---

Comment by mkoeppe created at 2022-12-09 19:36:05

However it builds against the Accelerate framework, not our openblas:

```
 otool -L local/lib/libumfpack.dylib                                                                                                         git:t/34206/suitesparse6.0.1
local/lib/libumfpack.dylib:
        @rpath/libumfpack.6.dylib (compatibility version 6.0.0, current version 6.0.1)
        @rpath/libsuitesparseconfig.6.dylib (compatibility version 6.0.0, current version 6.0.1)
        /usr/local/opt/libomp/lib/libomp.dylib (compatibility version 5.0.0, current version 5.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
        @rpath/libamd.3.dylib (compatibility version 3.0.0, current version 3.0.0)
        /System/Library/Frameworks/Accelerate.framework/Versions/A/Accelerate (compatibility version 1.0.0, current version 4.0.0)
        @rpath/libcholmod.4.dylib (compatibility version 4.0.0, current version 4.0.1)
```



---

Comment by fbissey created at 2022-12-09 22:12:35

That's what I thought could happen. I think, I can make it go for openblas easily, I found the doc for it, the other day.

This is also a relatively stripped down build like boost_cropped. I probably should add a few more sub-packages if we want to really dignify it with the full "suitesparse" name. And I also should write a few comments.


---

Comment by fbissey created at 2022-12-09 22:18:23

And upstream is preparing 6.0.2. But the bump would be trivial on this branch.


---

Comment by git created at 2022-12-09 22:29:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-10 00:47:17

This gets openblas but not the right one on my macOS system.

```
[suitesparse-6.0.1] -- BLAS libraries:      /opt/local/lib/libopenblas.dylib 
[suitesparse-6.0.1] -- BLAS linker flags:    
[suitesparse-6.0.1] -- LAPACK libraries:    /opt/local/lib/libopenblas.dylib;/opt/local/lib/libopenblas.dylib 
[suitesparse-6.0.1] -- LAPACK linker flags:  
```



---

Comment by mkoeppe created at 2022-12-10 00:47:32

The following change fixes it for me:

```
diff --git a/build/pkgs/suitesparse/spkg-build.in b/build/pkgs/suitesparse/spkg-build.in
index b137a5ecb9..822519b078 100644
--- a/build/pkgs/suitesparse/spkg-build.in
+++ b/build/pkgs/suitesparse/spkg-build.in
@@ -11,7 +11,10 @@ for pkg in ${pkg_list}; do
 	# Enforce usage of OpenBlas
 	# No static libraries
 	# Verbose builds
-	sdh_cmake -DBLA_VENDOR=OpenBLAS -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..
+	sdh_cmake -DBLA_VENDOR=OpenBLAS \
+                  -DBLAS_LIBRARIES="$(pkg-config --libs blas)" \
+                  -DLAPACK_LIBRARIES="$(pkg-config --libs lapack)" \
+                  -DNSTATIC=ON -DCMAKE_VERBOSE_MAKEFILE=1 ..
 	# Build
 	sdh_make
 	popd
```



---

Comment by fbissey created at 2022-12-10 01:02:25

Yes, system wide would be picked up first without a hint. Pushing shortly.


---

Comment by git created at 2022-12-10 01:05:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-11 00:44:49

Failing on `centos-stream-9-python3.9-standard` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6192051075)

```
CMake Error at CMakeLists.txt:14 (cmake_minimum_required):
  CMake 3.22 or higher is required.  You are running version 3.20.2
```

This will need an increased lower bound for system cmake - increased from #34746, which set 3.11)


---

Comment by mkoeppe created at 2022-12-11 00:44:49

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-12-11 09:54:17

On `debian-sid-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588473):

```
[suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:643:65: error: expected ')' before ',' token
  [suitesparse-6.0.1]     643 |     #define SUITESPARSE_BLAS(name,NAME) SUITESPARSE_FORTRAN(name,NAME)
  [suitesparse-6.0.1]         |                                                                 ^
  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:676:37: note: in expansion of macro 'SUITESPARSE_BLAS'
  [suitesparse-6.0.1]     676 | #define SUITESPARSE_LAPACK_ZLARF    SUITESPARSE_BLAS ( zlarf  , ZLAR   )
  [suitesparse-6.0.1]         |                                     ^~~~~~~~~~~~~~~~
  [suitesparse-6.0.1]   /sage/local/var/tmp/sage/build/suitesparse-6.0.1/src/SuiteSparse_config/SuiteSparse_config.h:1434:6: note: in expansion of macro 'SUITESPARSE_LAPACK_ZLARF'
  [suitesparse-6.0.1]    1434 | void SUITESPARSE_LAPACK_ZLARF       // apply Householder reflector
  [suitesparse-6.0.1]         |      ^~~~~~~~~~~~~~~~~~~~~~~~
  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1465: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_solve.c.o] Error 1
  [suitesparse-6.0.1]   make[5]: *** [CMakeFiles/cholmod.dir/build.make:1479: CMakeFiles/cholmod.dir/Supernodal/cholmod_super_symbolic.c.o] Error 1
  [suitesparse-6.0.1]   make[5]: Target 'CMakeFiles/cholmod.dir/build' not remade because of errors.
```



---

Comment by fbissey created at 2022-12-11 10:16:38

Can't seem to see the log from that run. What compiler is sid currently using?


---

Comment by mkoeppe created at 2022-12-11 18:59:22

That's gcc 12.2.0-9.1


---

Comment by mkoeppe created at 2022-12-11 19:01:50

Same on `debian-bookworm-minimal` (https://github.com/mkoeppe/sage/actions/runs/3662737597/jobs/6200588437, `docker run -it  ghcr.io/mkoeppe/sage/sage-docker-debian-bookworm-minimal-with-targets-pre:9.5-107209-g31c5448dc1-failed bash`)
and on `ubuntu-kinetic-minimal` and `fedora-36-minimal`


---

Comment by fbissey created at 2022-12-11 21:42:24

I wonder if it has to do with 

```
-- Detecting Fortran/C Interface
Failed to compile
```

When cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.


---

Comment by fbissey created at 2022-12-11 21:47:20

While it is annoying, we could turn off the bits needing blas/lapack which seem to be the one involved here. But really I suspect there is something fishy in the compiler.


---

Comment by git created at 2022-12-11 22:17:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-12 00:20:00

`tox -e docker-debian-bookworm-minimal-incremental -- suitesparse` gives the same errors


---

Comment by fbissey created at 2022-12-12 00:31:15

I am running out of ideas on what can cause this. Some compiler setting is the most obvious culprit, but what would it be. Can you get access to the docker instance to fish stuff out of it?


---

Comment by fbissey created at 2022-12-12 02:56:24

6.0.2 is just out, so I will bump that and we will see if it helps.


---

Comment by mkoeppe created at 2022-12-12 03:51:40

I've set up a separate GH Actions test at https://github.com/mkoeppe/SuiteSparse/actions/runs/3672968344


---

Comment by git created at 2022-12-12 03:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-12 05:52:00

pushed this commit to address comment:29
----
New commits:


---

Comment by fbissey created at 2022-12-12 06:21:35

Forgot about doing that thanks.


---

Comment by mkoeppe created at 2022-12-12 07:42:58

Adding #34835 as it will make the test builds quicker


---

Comment by git created at 2022-12-12 07:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-12 08:04:53

Replying to [comment:34 François Bissey]:
> I wonder if it has to do with 
> {{{
> -- Detecting Fortran/C Interface
> Failed to compile
> }}}
> When cmake is run to configure cholmod. It looks like we are trying to mix C and Fortran and it is failing.

Yes, I think that's the problem


---

Comment by fbissey created at 2022-12-12 08:08:13

The only thing I can think about is that openblas was compiled with a different gfortran but it feels far fetched.


---

Comment by mkoeppe created at 2022-12-12 08:09:20

In one of the failing builds, I see the following in `SuiteSparse_config/build/CMakeFiles/CMakeError.log`:

```
[100%] Linking Fortran executable FortranCInterface
lto1: internal compiler error: compiler does not support ZSTD LTO compression
0x9c311c lto_end_uncompression(lto_compression_stream*, lto_compression)
	../../src/gcc/lto-compress.cc:411
0x9c1910 lto_get_section_data(lto_file_decl_data*, lto_section_type, char const*, int, unsigned long*, bool)
	../../src/gcc/lto-section-in.cc:168
0x6929c5 lto_file_finalize
	../../src/gcc/lto/lto-common.cc:2264
0x6929c5 lto_create_files_from_ids
	../../src/gcc/lto/lto-common.cc:2282
0x6929c5 lto_file_read
	../../src/gcc/lto/lto-common.cc:2337
0x6929c5 read_cgraph_and_symbols(unsigned int, char const**)
	../../src/gcc/lto/lto-common.cc:2785
0x680312 lto_main()
	../../src/gcc/lto/lto.cc:626
Please submit a full bug report, with preprocessed source (by using -freport-bug).
Please include the complete backtrace with any bug report.
See <https://gcc.gnu.org/bugs/> for instructions.
lto-wrapper: fatal error: /sage/local/bin/gfortran returned 1 exit status
compilation terminated.
```



---

Comment by mkoeppe created at 2022-12-12 08:11:20

In the failing configurations, we are using system `gcc` but our own `gfortran`. This may be a mismatch between them regarding `zstd` support.


---

Comment by fbissey created at 2022-12-12 08:15:48

Yes, it starts making much more sense.


---

Comment by fbissey created at 2022-12-12 08:17:49

But there should be other similar failures potentially - at least you would think, since this is also tested in autoconf packages as soon blas/lapack is mixed with C code.


---

Comment by git created at 2022-12-12 08:38:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-12 08:38:49

Let's try this


---

Comment by fbissey created at 2022-12-12 08:48:46

If it works, I'll have to re-enable "supernodal" in cholmod.


---

Comment by mkoeppe created at 2022-12-12 08:49:14

running at https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225


---

Comment by git created at 2022-12-12 09:18:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-12 09:25:18

still failing - https://github.com/mkoeppe/SuiteSparse/actions/runs/3674049225/jobs/6211825144


---

Comment by mkoeppe created at 2022-12-12 09:30:55

in the failing build, gfortran still does not list zstd as a supported compression algorithm:

```
/sage/local/bin/gfortran -v
Using built-in specs.
COLLECT_GCC=/sage/local/bin/gfortran
COLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper
Target: x86_64-pc-linux-gnu
Configured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 12.2.0 (GCC) 
```



---

Comment by git created at 2022-12-12 09:33:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-12-12 09:42:16

In gentoo we just seem to do `make -C lib install`. Although there is also a `make -C lib libzstd.pc` during the build phase.


---

Comment by fbissey created at 2022-12-12 09:53:31

Installing `zstd` may not be enough, you may have to tell gcc's configure to use it `--with-zstd`. But really, we want to match the support from the host gcc. So, it may be more complicated to achieve.


---

Comment by mkoeppe created at 2022-12-12 10:00:30

gfortran is now configured correctly

```
# local/bin/gfortran -v
Using built-in specs.
COLLECT_GCC=local/bin/gfortran
COLLECT_LTO_WRAPPER=/sage/local/libexec/gcc/x86_64-pc-linux-gnu/12.2.0/lto-wrapper
Target: x86_64-pc-linux-gnu
Configured with: ../src/configure --prefix=/sage/local --with-local-prefix=/sage/local --with-system-zlib --without-isl --disable-multilib --disable-nls --disable-libitm --disable-bootstrap --enable-languages=fortran --disable-darwin-at-rpath   CXX=g++
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 12.2.0 (GCC) 
```



---

Comment by mkoeppe created at 2022-12-12 10:01:49

Replying to [comment:62 François Bissey]:
> we want to match the support from the host gcc. So, it may be more complicated to achieve.

Quite possible that this is needed, yes


---

Comment by mkoeppe created at 2022-12-12 10:08:53

suitesparse still fails to build.

comment:49 has changed - getting a different error now

```
# cat SuiteSparse_config/build/CMakeFiles/CMakeError.log
make[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
make[6]: Leaving directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
make[6]: Entering directory '/sage/local/var/tmp/sage/build/suitesparse-git/src/SuiteSparse_config/build/CMakeFiles/FortranCInterface'
[ 92%] Building Fortran object CMakeFiles/FortranCInterface.dir/main.F.o
[ 94%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_sub.f.o
[ 97%] Building Fortran object CMakeFiles/FortranCInterface.dir/call_mod.f90.o
[100%] Linking Fortran executable FortranCInterface
lto1: internal compiler error: bytecode stream: expected tag LTO_function instead of LTO_eh_table
0x9b4cc1 lto_tag_check
	../../src/gcc/lto-streamer.h:1028
0x9b4cc1 input_function
	../../src/gcc/lto-streamer-in.cc:1361
0x9b4cc1 lto_read_body_or_constructor
	../../src/gcc/lto-streamer-in.cc:1621
0x7020ce cgraph_node::get_untransformed_body()
	../../src/gcc/cgraph.cc:4011
0x70c48d cgraph_node::expand()
	../../src/gcc/cgraphunit.cc:1806
0x70c48d cgraph_node::expand()
	../../src/gcc/cgraphunit.cc:1788
0x70da4e expand_all_functions
	../../src/gcc/cgraphunit.cc:1999
0x70da4e symbol_table::compile()
	../../src/gcc/cgraphunit.cc:2349
0x680901 lto_main()
	../../src/gcc/lto/lto.cc:657
Please submit a full bug report, with preprocessed source (by using -freport-bug).
Please include the complete backtrace with any bug report.
See <https://gcc.gnu.org/bugs/> for instructions.
make[7]: *** [/tmp/ccL3cCy7.mk:2: /tmp/cc63Hwwl.ltrans0.ltrans.o] Error 1
```



---

Comment by mkoeppe created at 2022-12-12 10:11:03

This will need more work on another day


---

Comment by fbissey created at 2022-12-14 19:54:53

I have given it some thoughts. bookworm and sid are the only you report failing at this stage. It looks to me that they are both using gcc-12.2.0+patches - gentoo currently similarly ship gcc-12.2.1_pre20221210, some kind of pre-release. It seems it has incompatibilities with earlier gcc/gfortran releases, at least in debian. And our gcc/gfortran is an earlier and official release. I don't see a way out of this that doesn't forbid this version of the compiler unless there are both gcc and gfortran installed.


---

Comment by mkoeppe created at 2022-12-14 20:08:56

I agree, the Debian patches are likely the cause for the incompatibility. I think the LTO data comes with a version annotation, and Debian should probably have bumped the version along with their patches.

(We also carry a patch, for macOS M1/M2 support, but I don't think it is the problem here.)
