# Issue 12568: make doesn't work properly for targets 'test' and 'micro_release'

archive/issues_012396.json:
```json
{
    "body": "I am using sage 4.8 with GNU make 3.81. When I am in `SAGE_ROOT`, if I type the commands `make test` or `make micro_release`, the shell returns an error. For `make micro_release`, the it returns the following output:\n\n```\n. local/bin/sage-env && local/bin/sage-micro_release\nlocal/bin/sage-env: 289: Bad substitution\nmkdir: cannot create directory `//matplotlib-1.0.1': Permission denied\nlocal/bin/sage-env: 475: Syntax error: \"(\" unexpected\nmake: *** [micro_release] Error 2\n```\nFor `make test`, it returns a longer output which ends with:\n\n```\n. local/bin/sage-env && sage-maketest\nlocal/bin/sage-env: 289: Bad substitution\nmkdir: cannot create directory `//matplotlib-1.0.1': Permission denied\nlocal/bin/sage-env: 475: Syntax error: \"(\" unexpected\nmake: *** [test] Error 2\n```\nThe problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.\n\nApply only [attachment:trac_12568-reviewer.patch]\n\nAssignee: GeorgSWeber\n\nKeywords: make test micro_release\n\nReviewer: Jeroen Demeyer\n\nAuthor: Itai Bar-Natan, Jean-Pierre Flori\n\nMerged: sage-5.0.beta14\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12568\n\n",
    "closed_at": "2012-04-19T06:42:16Z",
    "created_at": "2012-02-23T02:46:01Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "make doesn't work properly for targets 'test' and 'micro_release'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12568",
    "user": "https://github.com/itaibn"
}
```
I am using sage 4.8 with GNU make 3.81. When I am in `SAGE_ROOT`, if I type the commands `make test` or `make micro_release`, the shell returns an error. For `make micro_release`, the it returns the following output:

```
. local/bin/sage-env && local/bin/sage-micro_release
local/bin/sage-env: 289: Bad substitution
mkdir: cannot create directory `//matplotlib-1.0.1': Permission denied
local/bin/sage-env: 475: Syntax error: "(" unexpected
make: *** [micro_release] Error 2
```
For `make test`, it returns a longer output which ends with:

```
. local/bin/sage-env && sage-maketest
local/bin/sage-env: 289: Bad substitution
mkdir: cannot create directory `//matplotlib-1.0.1': Permission denied
local/bin/sage-env: 475: Syntax error: "(" unexpected
make: *** [test] Error 2
```
The problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.

Apply only [attachment:trac_12568-reviewer.patch]

Assignee: GeorgSWeber

Keywords: make test micro_release

Reviewer: Jeroen Demeyer

Author: Itai Bar-Natan, Jean-Pierre Flori

Merged: sage-5.0.beta14

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12568





---

archive/issue_comments_186195.json:
```json
{
    "body": "A patch which fixes the bug",
    "created_at": "2012-02-23T21:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186195",
    "user": "https://github.com/itaibn"
}
```

A patch which fixes the bug



---

archive/issue_comments_186196.json:
```json
{
    "body": "<a id='comment:1'></a>\nAttachment [12568-fix.patch](tarball://root/attachments/some-uuid/ticket12568/12568-fix.patch) by @itaibn created at 2012-02-27 22:47:32\n\nI should have done this a while ago since I already have a patch.",
    "created_at": "2012-02-27T22:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186196",
    "user": "https://github.com/itaibn"
}
```

<a id='comment:1'></a>
Attachment [12568-fix.patch](tarball://root/attachments/some-uuid/ticket12568/12568-fix.patch) by @itaibn created at 2012-02-27 22:47:32

I should have done this a while ago since I already have a patch.



---

archive/issue_comments_186197.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-27T22:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186197",
    "user": "https://github.com/itaibn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_186198.json:
```json
{
    "body": "Author: Itai Bar-Natan",
    "created_at": "2012-03-30T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186198",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Author: Itai Bar-Natan



---

archive/issue_comments_186199.json:
```json
{
    "body": "Reviewer: Jean-Pierre Flori",
    "created_at": "2012-03-30T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186199",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Reviewer: Jean-Pierre Flori



---

archive/issue_comments_186200.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-30T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186200",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186201.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-03-30T07:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186201",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_186202.json:
```json
{
    "body": "<a id='comment:3'></a>\nI was a little too fast on this.\nAre we sure that bash will be installed on every system sage supports (and is it a sage dependency) ?\nI fear that explicitely calling bash might fail even if a compatible shell is installed.\n\nI think a better solution would be modify the sage-env header to something like \"#! /usr/bin/env bash\".\nBy the way, this file should be executable.",
    "created_at": "2012-03-30T07:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186202",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:3'></a>
I was a little too fast on this.
Are we sure that bash will be installed on every system sage supports (and is it a sage dependency) ?
I fear that explicitely calling bash might fail even if a compatible shell is installed.

I think a better solution would be modify the sage-env header to something like "#! /usr/bin/env bash".
By the way, this file should be executable.



---

archive/issue_comments_186203.json:
```json
{
    "body": "<a id='comment:4'></a>\nMoreover the sage-env script is in the spkg/bin directory and not in the local/bin one (edit: this is a recent change #11073).\n\nFinally the micro_release target segfault on my machine...",
    "created_at": "2012-03-30T08:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186203",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:4'></a>
Moreover the sage-env script is in the spkg/bin directory and not in the local/bin one (edit: this is a recent change #11073).

Finally the micro_release target segfault on my machine...



---

archive/issue_comments_186204.json:
```json
{
    "body": "<a id='comment:5'></a>\nI propose to let the test target behave like the other ones, i.e. call \"sage -t ...\" (in the end it calls sage-maketest anyway, but at least sage-env is properly called by the sage script).\n\nFor the micro_release one, I'm not sure we can do much better than the solution Itai proposed without calling sage-micro_release from the sage script to properly set SAGE_ROOT (i.e. through an option or something like that).",
    "created_at": "2012-03-30T08:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186204",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:5'></a>
I propose to let the test target behave like the other ones, i.e. call "sage -t ..." (in the end it calls sage-maketest anyway, but at least sage-env is properly called by the sage script).

For the micro_release one, I'm not sure we can do much better than the solution Itai proposed without calling sage-micro_release from the sage script to properly set SAGE_ROOT (i.e. through an option or something like that).



---

archive/issue_comments_186205.json:
```json
{
    "body": "<a id='comment:6'></a>\nNot sure why make micro_release now and not before...\nIt does so while trying to strip libpython which is expected: http://trac.sagemath.org/sage_trac/ticket/11743#comment:3\n\nWhat's more mysterious is why it tries to strip libpython now.\nIt was updated to 2.7 in the 5.0 series but is still readonly.\n\nIn fact it did already segfault with 4.8.\nIt's just that because I used system atlas libs with my 4.8 install, it did fail before.",
    "created_at": "2012-03-30T09:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186205",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:6'></a>
Not sure why make micro_release now and not before...
It does so while trying to strip libpython which is expected: http://trac.sagemath.org/sage_trac/ticket/11743#comment:3

What's more mysterious is why it tries to strip libpython now.
It was updated to 2.7 in the 5.0 series but is still readonly.

In fact it did already segfault with 4.8.
It's just that because I used system atlas libs with my 4.8 install, it did fail before.



---

archive/issue_comments_186206.json:
```json
{
    "body": "<a id='comment:7'></a>\nMy bad once more.\nsage-env is only meant to be sourced (and only once) and should not be executable: #10469",
    "created_at": "2012-03-30T09:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186206",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:7'></a>
My bad once more.
sage-env is only meant to be sourced (and only once) and should not be executable: #10469



---

archive/issue_comments_186207.json:
```json
{
    "body": "<a id='comment:8'></a>\nOk here is a slightly reworked patch making the test target like the other ones.",
    "created_at": "2012-03-30T09:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186207",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:8'></a>
Ok here is a slightly reworked patch making the test target like the other ones.



---

archive/issue_comments_186208.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-30T09:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186208",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_186209.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,3 +17,5 @@\n make: *** [test] Error 2\n ```\n The problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.\n+\n+Apply only [attachment:trac_12568-reviewer.patch]\n``````\n",
    "created_at": "2012-03-30T09:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186209",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,3 +17,5 @@
 make: *** [test] Error 2
 ```
 The problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.
+
+Apply only [attachment:trac_12568-reviewer.patch]
``````




---

archive/issue_comments_186210.json:
```json
{
    "body": "<a id='comment:10'></a>\n1. Obviously, `/usr/bin/env bash` should be simply `bash`.\n\n2. Then, if you don't use `sage-maketest` anymore (which is probably a good thing), remove the `sage-maketest` script.",
    "created_at": "2012-04-13T08:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186210",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
1. Obviously, `/usr/bin/env bash` should be simply `bash`.

2. Then, if you don't use `sage-maketest` anymore (which is probably a good thing), remove the `sage-maketest` script.



---

archive/issue_comments_186211.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-13T08:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186211",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_186212.json:
```json
{
    "body": "<a id='comment:12'></a>\nI think the sage-maketest script is used when you call \"sage -testall\" which is called by some make targets so is still necessary.",
    "created_at": "2012-04-13T08:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186212",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:12'></a>
I think the sage-maketest script is used when you call "sage -testall" which is called by some make targets so is still necessary.



---

archive/issue_comments_186213.json:
```json
{
    "body": "Attachment [trac_12568-reviewer.patch](tarball://root/attachments/some-uuid/ticket12568/trac_12568-reviewer.patch) by jpflori created at 2012-04-13 08:11:48\n\nReviewer patch; rebase on 5.0 series",
    "created_at": "2012-04-13T08:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186213",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Attachment [trac_12568-reviewer.patch](tarball://root/attachments/some-uuid/ticket12568/trac_12568-reviewer.patch) by jpflori created at 2012-04-13 08:11:48

Reviewer patch; rebase on 5.0 series



---

archive/issue_comments_186214.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-13T08:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186214",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_186215.json:
```json
{
    "body": "<a id='comment:14'></a>\nIn fact the testall option is not present in the make targets, but is defined and documented by spkg/bin/sage.\nAnyway, I don't think here is the place to remove it.",
    "created_at": "2012-04-13T08:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186215",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:14'></a>
In fact the testall option is not present in the make targets, but is defined and documented by spkg/bin/sage.
Anyway, I don't think here is the place to remove it.



---

archive/issue_comments_186216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186216",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_186217.json:
```json
{
    "body": "Changing reviewer from \"Jean-Pierre Flori\" to \"Jeroen Demeyer\"",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186217",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "Jean-Pierre Flori" to "Jeroen Demeyer"



---

archive/issue_comments_186218.json:
```json
{
    "body": "Changing author from \"Itai Bar-Natan\" to \"Itai Bar-Natan, Jean-Pierre Flori\"",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186218",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Itai Bar-Natan" to "Itai Bar-Natan, Jean-Pierre Flori"



---

archive/issue_comments_186219.json:
```json
{
    "body": "<a id='comment:15'></a>\n`make micro_release` is indeed broken.  It's not surprising, as it changes the python library while `python` is running:\n\n```\nstrip \"/tmp/local/sage/local/lib/libpython2.7.so\"\nbash: line 1:  5817 Segmentation fault      local/bin/sage-micro_release\n```\nbut that's not relevant for this ticket.\n\nEverything else seems to work, so positive_review.",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186219",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
`make micro_release` is indeed broken.  It's not surprising, as it changes the python library while `python` is running:

```
strip "/tmp/local/sage/local/lib/libpython2.7.so"
bash: line 1:  5817 Segmentation fault      local/bin/sage-micro_release
```
but that's not relevant for this ticket.

Everything else seems to work, so positive_review.



---

archive/issue_events_039820.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-19T06:42:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12568#event-39820"
}
```



---

archive/issue_comments_186220.json:
```json
{
    "body": "Merged: sage-5.0.beta14",
    "created_at": "2012-04-19T06:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186220",
    "user": "https://github.com/jdemeyer"
}
```

Merged: sage-5.0.beta14



---

archive/issue_comments_186221.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-04-19T06:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12568",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12568#issuecomment-186221",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
