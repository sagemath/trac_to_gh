# Issue 12916: Dedekind-MacNeil completion of finite posets

archive/issues_012744.json:
```json
{
    "body": "The title says it all.\n\nSee also: http://en.wikipedia.org/wiki/Dedekind%E2%80%93MacNeille_completion\n\nAssignee: sage-combinat\n\nCC:  sage-combinat\n\nKeywords: poset, lattice\n\nReviewer: Nathann Cohen\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nBranch: afbafeac17420778c803e34e7ae2e3d0cbf05da6\n\nCommit: afbafeac17420778c803e34e7ae2e3d0cbf05da6\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12916\n\n",
    "closed_at": "2015-01-24T13:18:45Z",
    "created_at": "2012-05-06T18:05:41Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Dedekind-MacNeil completion of finite posets",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12916",
    "user": "https://github.com/nthiery"
}
```
The title says it all.

See also: http://en.wikipedia.org/wiki/Dedekind%E2%80%93MacNeille_completion

Assignee: sage-combinat

CC:  sage-combinat

Keywords: poset, lattice

Reviewer: Nathann Cohen

Author: Frédéric Chapoton

Branch: afbafeac17420778c803e34e7ae2e3d0cbf05da6

Commit: afbafeac17420778c803e34e7ae2e3d0cbf05da6

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12916





---

archive/issue_comments_152482.json:
```json
{
    "body": "<a id='comment:1'></a>I have made a small patch, in the sage-combinat queue, just using the naive algorithm and therefore not very efficient. Is this useful ? Should I put it here ?",
    "created_at": "2012-09-05T08:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152482",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>I have made a small patch, in the sage-combinat queue, just using the naive algorithm and therefore not very efficient. Is this useful ? Should I put it here ?



---

archive/issue_comments_152483.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 chapoton]:\n> I have made a small patch, in the sage-combinat queue, just using the naive algorithm and therefore not very efficient. Is this useful ? Should I put it here ?\n\n\nYes; I would even tend to get it into Sage as a provocation: any expert reading the code will think \"yikes, *I* can do sooo much better\". And will do it :-)",
    "created_at": "2012-09-05T10:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152483",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:2'></a>Replying to [comment:1 chapoton]:
> I have made a small patch, in the sage-combinat queue, just using the naive algorithm and therefore not very efficient. Is this useful ? Should I put it here ?


Yes; I would even tend to get it into Sage as a provocation: any expert reading the code will think "yikes, *I* can do sooo much better". And will do it :-)



---

archive/issue_comments_152484.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2012-09-06T08:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152484",
    "user": "https://github.com/fchapoton"
}
```

Changing priority from major to minor.



---

archive/issue_comments_152485.json:
```json
{
    "body": "Attachment [trac_12916_completion_by_cuts-fc.patch](tarball://root/attachments/some-uuid/ticket12916/trac_12916_completion_by_cuts-fc.patch) by @fchapoton created at 2013-07-25 15:14:05\n\na naive implementation",
    "created_at": "2013-07-25T15:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152485",
    "user": "https://github.com/fchapoton"
}
```

Attachment [trac_12916_completion_by_cuts-fc.patch](tarball://root/attachments/some-uuid/ticket12916/trac_12916_completion_by_cuts-fc.patch) by @fchapoton created at 2013-07-25 15:14:05

a naive implementation



---

archive/issue_comments_152486.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2014-01-05T10:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152486",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_152487.json:
```json
{
    "body": "Changing keywords from \"\" to \"poset, lattice\".",
    "created_at": "2014-11-23T20:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152487",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "" to "poset, lattice".



---

archive/issue_comments_152488.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-11-28T20:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152488",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_152489.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-01-17T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152489",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_152490.json:
```json
{
    "body": "<a id='comment:7'></a>> Yes; I would even tend to get it into Sage as a provocation: any expert reading the code will think \"yikes, *I* can do sooo much better\". And will do it :-)\n\n\nI am precisely the kind of guy who thought that when reading the code, and I don't appreciate at all to see that you consider it a game to make us rewrite other people's hasty code, just because we do not stand such waste of computation. My time is not cheaper than anybody else's.\n\nAbout this patch:\n\n- The name of the methods that you define is not very informative: `set_of_upper_bounds/set_of_lower_bounds` feels like you will get all `y` greater than a given `x`. It is more 'lower_bounds_of_set', but even then it feels a bit awkward. Is there a word in order theory to mean \"all elements smaller than x\" ? I can't even find a function that would return that for such a vertex `x`\n\n- Computation of the set of cuts: look at the section entitled `Constructing the set of cuts` in the Wikipedia page that you provided. They say that it is equivalent to list all antichains of the Poset, and for that there is a `.antichains_iterator` function. (I wonder how it compares with http://www.sagemath.org/doc/reference/graphs/sage/graphs/independent_sets.html, but that's another subject)\n\nNathann",
    "created_at": "2015-01-17T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152490",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>> Yes; I would even tend to get it into Sage as a provocation: any expert reading the code will think "yikes, *I* can do sooo much better". And will do it :-)


I am precisely the kind of guy who thought that when reading the code, and I don't appreciate at all to see that you consider it a game to make us rewrite other people's hasty code, just because we do not stand such waste of computation. My time is not cheaper than anybody else's.

About this patch:

- The name of the methods that you define is not very informative: `set_of_upper_bounds/set_of_lower_bounds` feels like you will get all `y` greater than a given `x`. It is more 'lower_bounds_of_set', but even then it feels a bit awkward. Is there a word in order theory to mean "all elements smaller than x" ? I can't even find a function that would return that for such a vertex `x`

- Computation of the set of cuts: look at the section entitled `Constructing the set of cuts` in the Wikipedia page that you provided. They say that it is equivalent to list all antichains of the Poset, and for that there is a `.antichains_iterator` function. (I wonder how it compares with http://www.sagemath.org/doc/reference/graphs/sage/graphs/independent_sets.html, but that's another subject)

Nathann



---

archive/issue_comments_152491.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-17T15:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152491",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152492.json:
```json
{
    "body": "<a id='comment:9'></a>Hello Nathann,\n\nthanks for the input.\n\nHere is a proposal for another algorithm, using maximal cliques of the incomparability graph of an auxiliary poset. Needs polishing. I do not know if this is faster than before, hopefully yes.",
    "created_at": "2015-01-17T15:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152492",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>Hello Nathann,

thanks for the input.

Here is a proposal for another algorithm, using maximal cliques of the incomparability graph of an auxiliary poset. Needs polishing. I do not know if this is faster than before, hopefully yes.



---

archive/issue_comments_152493.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-17T21:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152494.json:
```json
{
    "body": "<a id='comment:11'></a>Ok, needs review again, I think, but I have not done any timings.",
    "created_at": "2015-01-17T21:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152494",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>Ok, needs review again, I think, but I have not done any timings.



---

archive/issue_comments_152495.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-17T21:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152495",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_152496.json:
```json
{
    "body": "<a id='comment:12'></a>Wow! Excellent, a quite clean result `:-)`\n\nSo, about this. I have a couple of comments:\n\n- For very bad reasons, the output of `cliques_maximal` is... sorted. Which is a pure waste. If you want to avoid that you can call `IndependentSets` directly.\n\nhttp://www.sagemath.org/doc/reference/graphs/sage/graphs/independent_sets.html\n\n- The good side-effect of that is that you do not have to call 'incomparability_graph`, which would do some useless computations in your case (your poset has height two, so its 'incomparability graph' is the graph complement of its hasse diagram)\n\n- Alternatively: during the creation of the aux poset, and instead of your double loop on `u/v` with a test `u<=v`, you can do that: `g = Graph(((u,0),(v,1)) for u,v in self.cover_relations_iterator())` and then call `IndependentSet(complement=True,maximal=True)` when you compute the longest antichains. Advantages:\n\n    1) no double-loop enumerating many pairs in vain\n    2) the complement is a graph complement (and `IndependentSet` computes this complement as a dense matrix, which is also totally faster).\n\n- The auxiliary poset that you define has no reason to be a poset. I wouldn't care in general, but one of the problems with posets is that they are cached globally, and that every time you create one it will be cached/compared with posets that have been created in the past. Waste of time.\n\n- About 'Set'. Well. I just never use them whenever I can avoid it\n\n```\nsage: e=[1,2,3]\nsage: %timeit Set(e)\n10000 loops, best of 3: 26.5 \u00b5s per loop\nsage: %timeit set(e)\n1000000 loops, best of 3: 226 ns per loop\nsage: %timeit frozenset(e)\n1000000 loops, best of 3: 222 ns per loop\n```\n\n  Here I do not know, as it is not for internal use only. Do what you think is best.\n\n> Ok, needs review again, I think, but I have not done any timings.\n\n\nAbout the timings: I do not have any doubt that this algorithm is infintely faster than the previous one. It does what it should, without waste. The only possible waste of computations in your arlgorithm can be in:\n\n- The call to `cliques_maximal` (and I don't mean the sorting problem)\n\n- The construction of `Lattice` (MUCH slower than building a poset, because the creation of a lattice triggers the computation of the join/meet matrix, which is very wastefully implemented.\n\nYour implementation, however, is both short and clean. Just good work.\n\nNathann",
    "created_at": "2015-01-17T23:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152496",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:12'></a>Wow! Excellent, a quite clean result `:-)`

So, about this. I have a couple of comments:

- For very bad reasons, the output of `cliques_maximal` is... sorted. Which is a pure waste. If you want to avoid that you can call `IndependentSets` directly.

http://www.sagemath.org/doc/reference/graphs/sage/graphs/independent_sets.html

- The good side-effect of that is that you do not have to call 'incomparability_graph`, which would do some useless computations in your case (your poset has height two, so its 'incomparability graph' is the graph complement of its hasse diagram)

- Alternatively: during the creation of the aux poset, and instead of your double loop on `u/v` with a test `u<=v`, you can do that: `g = Graph(((u,0),(v,1)) for u,v in self.cover_relations_iterator())` and then call `IndependentSet(complement=True,maximal=True)` when you compute the longest antichains. Advantages:

    1) no double-loop enumerating many pairs in vain
    2) the complement is a graph complement (and `IndependentSet` computes this complement as a dense matrix, which is also totally faster).

- The auxiliary poset that you define has no reason to be a poset. I wouldn't care in general, but one of the problems with posets is that they are cached globally, and that every time you create one it will be cached/compared with posets that have been created in the past. Waste of time.

- About 'Set'. Well. I just never use them whenever I can avoid it

```
sage: e=[1,2,3]
sage: %timeit Set(e)
10000 loops, best of 3: 26.5 µs per loop
sage: %timeit set(e)
1000000 loops, best of 3: 226 ns per loop
sage: %timeit frozenset(e)
1000000 loops, best of 3: 222 ns per loop
```

  Here I do not know, as it is not for internal use only. Do what you think is best.

> Ok, needs review again, I think, but I have not done any timings.


About the timings: I do not have any doubt that this algorithm is infintely faster than the previous one. It does what it should, without waste. The only possible waste of computations in your arlgorithm can be in:

- The call to `cliques_maximal` (and I don't mean the sorting problem)

- The construction of `Lattice` (MUCH slower than building a poset, because the creation of a lattice triggers the computation of the join/meet matrix, which is very wastefully implemented.

Your implementation, however, is both short and clean. Just good work.

Nathann



---

archive/issue_comments_152497.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-18T10:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152497",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152498.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-18T10:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152498",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152499.json:
```json
{
    "body": "<a id='comment:15'></a>Ok, thanks. Here is a better version, I hope. Seems to be faster indeed.\n\nNo longer uses Poset, Set or incomparability.\n\nNow uses Graph and IndependentSets",
    "created_at": "2015-01-18T10:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152499",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>Ok, thanks. Here is a better version, I hope. Seems to be faster indeed.

No longer uses Poset, Set or incomparability.

Now uses Graph and IndependentSets



---

archive/issue_comments_152500.json:
```json
{
    "body": "<a id='comment:16'></a>Yo !\n\n> Ok, thanks. Here is a better version, I hope. Seems to be faster indeed.\n> \n> No longer uses Poset, Set or incomparability.\n> \n> Now uses Graph and IndependentSets\n\n\nPasses tests, does the job, good to go!\n\nNathann",
    "created_at": "2015-01-18T11:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152500",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:16'></a>Yo !

> Ok, thanks. Here is a better version, I hope. Seems to be faster indeed.
> 
> No longer uses Poset, Set or incomparability.
> 
> Now uses Graph and IndependentSets


Passes tests, does the job, good to go!

Nathann



---

archive/issue_comments_152501.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-18T11:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152501",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_035297.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-23T11:26:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "milestone": "sage-6.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12916#event-35297"
}
```



---

archive/issue_comments_152502.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-24T13:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12916#issuecomment-152502",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_035298.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-24T13:18:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12916",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12916#event-35298"
}
```
