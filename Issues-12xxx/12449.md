# Issue 12449: Improve the way that sage evaluates symbolic functions on basic types

archive/issues_012277.json:
```json
{
    "body": "Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n\n```\nsage: timeit('exp(6.0r)')\n625 loops, best of 3: 476 \u00b5s per loop\n```\nThis also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n\nTo fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n\nNow we have\n\n```\nsage: timeit('exp(6.0r)')\n625 loops, best of 3: 1.02 \u00b5s per loop\n```\nFor the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n\nI think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n\nFinally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n\n```\nsage: timeit('math.exp(6.0r)')\n625 loops, best of 3: 112 ns per loop\n```\nApply:\n\n* attachment:trac12449.patch\n\nAssignee: bober\n\nCC:  snark @eviatarbach\n\nKeywords: gamma function\n\nReviewer: Burcin Erocal, Jonathan Bober\n\nAuthor: Jonathan Bober, Burcin Erocal\n\nDependencies: #4498, #12507, #9130\n\nResolution: worksforme\n\nIssue created by migration from https://trac.sagemath.org/ticket/12449\n\n",
    "closed_at": "2018-08-14T17:43:26Z",
    "created_at": "2012-02-05T21:53:23Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Improve the way that sage evaluates symbolic functions on basic types",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12449",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```
Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:

```
sage: timeit('exp(6.0r)')
625 loops, best of 3: 476 µs per loop
```
This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.

To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.

Now we have

```
sage: timeit('exp(6.0r)')
625 loops, best of 3: 1.02 µs per loop
```
For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.

I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )

Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to

```
sage: timeit('math.exp(6.0r)')
625 loops, best of 3: 112 ns per loop
```
Apply:

* attachment:trac12449.patch

Assignee: bober

CC:  snark @eviatarbach

Keywords: gamma function

Reviewer: Burcin Erocal, Jonathan Bober

Author: Jonathan Bober, Burcin Erocal

Dependencies: #4498, #12507, #9130

Resolution: worksforme

Issue created by migration from https://trac.sagemath.org/ticket/12449





---

archive/issue_comments_152938.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-08T00:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152938",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_152939.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,17 +1,30 @@\n-There are numerical inaccuracies in the gamma function on python floats on some platforms. See, e.g. \n-http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c\n-\n-Also, the current implementation is slower than it should be on basic types:\n+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n \n \\`\\`\\`\n-sage: timeit('gamma(6.0r)')\n-625 loops, best of 3: 32 \u00b5s per loop\n-sage: timeit('gamma(6r)')\n-625 loops, best of 3: 44.3 \u00b5s per loop\n-sage: timeit('gamma(6.0)')\n-625 loops, best of 3: 22.9 \u00b5s per loop\n-sage: timeit('gamma(6)')\n-625 loops, best of 3: 3.29 \u00b5s per loop\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 476 \u00b5s per loop\n+\\`\\`\\`\n+\n+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n+\n+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n+\n+Now we have\n+\n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 1.02 \u00b5s per loop\n+\\`\\`\\`\n+\n+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n+\n+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n+\n+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n+\n+\\`\\`\\`\n+sage: timeit('math.exp(6.0r)')\n+625 loops, best of 3: 112 ns per loop\n \\`\\`\\`\n \n Comment: 1\n```\n",
    "created_at": "2012-02-08T00:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152939",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,17 +1,30 @@
-There are numerical inaccuracies in the gamma function on python floats on some platforms. See, e.g. 
-http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c
-
-Also, the current implementation is slower than it should be on basic types:
+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:
 
 \`\`\`
-sage: timeit('gamma(6.0r)')
-625 loops, best of 3: 32 µs per loop
-sage: timeit('gamma(6r)')
-625 loops, best of 3: 44.3 µs per loop
-sage: timeit('gamma(6.0)')
-625 loops, best of 3: 22.9 µs per loop
-sage: timeit('gamma(6)')
-625 loops, best of 3: 3.29 µs per loop
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 476 µs per loop
+\`\`\`
+
+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.
+
+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.
+
+Now we have
+
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 1.02 µs per loop
+\`\`\`
+
+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.
+
+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )
+
+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to
+
+\`\`\`
+sage: timeit('math.exp(6.0r)')
+625 loops, best of 3: 112 ns per loop
 \`\`\`
 
 Comment: 1
```




---

archive/issue_comments_152940.json:
```json
{
    "body": "Changing component from basic arithmetic to symbolics.",
    "created_at": "2012-02-08T00:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152940",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing component from basic arithmetic to symbolics.



---

archive/issue_comments_152941.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-08T12:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152941",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_152942.json:
```json
{
    "body": "<a id='comment:2'></a>Thanks for the patch. I agree that considering float and complex types separately in the fast evaluation path makes sense for speed. However, this causes inconsistencies with the results you get when a value is substituted into the expression.\n\nWe still need to modify the `py_tgamma()` function in `sage/symbolic/pynac.pyx` to fix this:\n\n```\nsage: gamma(x).subs(x=6.r)          \n120.0\n```\n\nAFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.\n\nThis would be a good occasion to merge my patch from attachment:trac_1173-move_call.patch:ticket:1173. I'll try to rebase your patch on top of that.",
    "created_at": "2012-02-08T12:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152942",
    "user": "https://github.com/burcin"
}
```

<a id='comment:2'></a>Thanks for the patch. I agree that considering float and complex types separately in the fast evaluation path makes sense for speed. However, this causes inconsistencies with the results you get when a value is substituted into the expression.

We still need to modify the `py_tgamma()` function in `sage/symbolic/pynac.pyx` to fix this:

```
sage: gamma(x).subs(x=6.r)          
120.0
```

AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.

This would be a good occasion to merge my patch from attachment:trac_1173-move_call.patch:ticket:1173. I'll try to rebase your patch on top of that.



---

archive/issue_comments_152943.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 burcin]:\n\n> AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.\n\n\nSorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.\n\nRegarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?",
    "created_at": "2012-02-08T12:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152943",
    "user": "https://github.com/burcin"
}
```

<a id='comment:3'></a>Replying to [comment:2 burcin]:

> AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.


Sorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.

Regarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?



---

archive/issue_comments_152944.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 burcin]:\n> Replying to [comment:2 burcin]:\n> \n> > AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.\n\n> \n> Sorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.\n> \n> Regarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?\n\n\nFor the gamma function, at least, python has its own implementation. Of course, that function itself might call some underlying libc functions, so maybe it won't be entirely consistent, now that I think about it.\n\nIn the bit of testing that I did, math.gamma was less accurate than tgammal on my computer, but much more accurate than gsl's gamma function.",
    "created_at": "2012-02-08T12:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152944",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:4'></a>Replying to [comment:3 burcin]:
> Replying to [comment:2 burcin]:
> 
> > AFAICT (without applying the patch and testing), attachment:12449.patch removes the `try/except` block around `return getattr(args[0], self._name)()`, disabling the call to `BuiltinFunction.__call__` later on in the function body.

> 
> Sorry. I was looking at the code after applying attachment:trac_1173-move_call.patch:ticket:1173. There is no `try/except` block in the original code.
> 
> Regarding the changes to `sage/rings/real_double.pyx`: IIRC, python's math module just calls the underlying libc functions. On ARM won't this introduce new errors?


For the gamma function, at least, python has its own implementation. Of course, that function itself might call some underlying libc functions, so maybe it won't be entirely consistent, now that I think about it.

In the bit of testing that I did, math.gamma was less accurate than tgammal on my computer, but much more accurate than gsl's gamma function.



---

archive/issue_comments_152945.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,35 @@\n+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n \n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 476 \u00b5s per loop\n+\\`\\`\\`\n+\n+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n+\n+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n+\n+Now we have\n+\n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 1.02 \u00b5s per loop\n+\\`\\`\\`\n+\n+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n+\n+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n+\n+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n+\n+\\`\\`\\`\n+sage: timeit('math.exp(6.0r)')\n+625 loops, best of 3: 112 ns per loop\n+\\`\\`\\`\n+\n+Apply:\n+- attachment:12449.patch\n+- attachment:trac_12449-py_tgamma.patch\n \n Comment: 1\n \n```\n",
    "created_at": "2012-02-13T11:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152945",
    "user": "https://github.com/burcin"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,35 @@
+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:
 
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 476 µs per loop
+\`\`\`
+
+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.
+
+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.
+
+Now we have
+
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 1.02 µs per loop
+\`\`\`
+
+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.
+
+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )
+
+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to
+
+\`\`\`
+sage: timeit('math.exp(6.0r)')
+625 loops, best of 3: 112 ns per loop
+\`\`\`
+
+Apply:
+- attachment:12449.patch
+- attachment:trac_12449-py_tgamma.patch
 
 Comment: 1
 
```




---

archive/issue_comments_152946.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-13T11:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152946",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_152947.json:
```json
{
    "body": "<a id='comment:5'></a>It turns out that Python implements the gamma function itself:\n\nhttp://hg.python.org/cpython/file/58bd6a58365d/Modules/mathmodule.c#l226\n\nI uploaded a new patch that changes `py_tgamma()` in `sage/symbolic/pynac.pyx` to use Python's gamma implementation.\n\nI give a positive review to attachment:12449.patch. If someone can review my patch we can switch this to positive review.\n\nBTW, this will fix #9162. We should close that as a duplicate.",
    "created_at": "2012-02-13T11:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152947",
    "user": "https://github.com/burcin"
}
```

<a id='comment:5'></a>It turns out that Python implements the gamma function itself:

http://hg.python.org/cpython/file/58bd6a58365d/Modules/mathmodule.c#l226

I uploaded a new patch that changes `py_tgamma()` in `sage/symbolic/pynac.pyx` to use Python's gamma implementation.

I give a positive review to attachment:12449.patch. If someone can review my patch we can switch this to positive review.

BTW, this will fix #9162. We should close that as a duplicate.



---

archive/issue_comments_152948.json:
```json
{
    "body": "<a id='comment:6'></a>I uploaded a new version of my patch since the previous function had a typo that make doctests fail.",
    "created_at": "2012-02-13T14:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152948",
    "user": "https://github.com/burcin"
}
```

<a id='comment:6'></a>I uploaded a new version of my patch since the previous function had a typo that make doctests fail.



---

archive/issue_comments_152949.json:
```json
{
    "body": "<a id='comment:7'></a>Well, I suppose that I will just go ahead and give it a positive review, since your changes are simple and orthogonal to mine (and I checked that all tests still pass on my machine). I would like to get some confirmation that this fixes things on ARM, but I suppose that we'll find that out eventually; that's a secondary point as far as this patch goes, though, so it isn't that important.",
    "created_at": "2012-02-15T06:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152949",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:7'></a>Well, I suppose that I will just go ahead and give it a positive review, since your changes are simple and orthogonal to mine (and I checked that all tests still pass on my machine). I would like to get some confirmation that this fixes things on ARM, but I suppose that we'll find that out eventually; that's a secondary point as far as this patch goes, though, so it isn't that important.



---

archive/issue_comments_152950.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-15T06:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152950",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152951.json:
```json
{
    "body": "<a id='comment:8'></a>This should be rebased to #4498 + #12507 + #9130.",
    "created_at": "2012-02-24T08:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152951",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>This should be rebased to #4498 + #12507 + #9130.



---

archive/issue_comments_152952.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-24T08:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152952",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_152953.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n \n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 476 \u00b5s per loop\n+\\`\\`\\`\n+\n+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n+\n+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n+\n+Now we have\n+\n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 1.02 \u00b5s per loop\n+\\`\\`\\`\n+\n+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n+\n+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n+\n+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n+\n+\\`\\`\\`\n+sage: timeit('math.exp(6.0r)')\n+625 loops, best of 3: 112 ns per loop\n+\\`\\`\\`\n+\n+Apply:\n+- attachment:trac_12449_rebase.patch\n \n Comment: 1\n \n```\n",
    "created_at": "2012-02-28T01:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152953",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:
 
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 476 µs per loop
+\`\`\`
+
+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.
+
+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.
+
+Now we have
+
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 1.02 µs per loop
+\`\`\`
+
+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.
+
+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )
+
+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to
+
+\`\`\`
+sage: timeit('math.exp(6.0r)')
+625 loops, best of 3: 112 ns per loop
+\`\`\`
+
+Apply:
+- attachment:trac_12449_rebase.patch
 
 Comment: 1
 
```




---

archive/issue_comments_152954.json:
```json
{
    "body": "<a id='comment:9'></a>I've attached a patch rebased to 5.0-beta5. I had no problem applying the patches, so I just made sure all tests still pass.\n\nMaybe I should just go ahead and put it back to positive review, but I'll give Burcin a day or so to take a look at it.",
    "created_at": "2012-02-28T01:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152954",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:9'></a>I've attached a patch rebased to 5.0-beta5. I had no problem applying the patches, so I just made sure all tests still pass.

Maybe I should just go ahead and put it back to positive review, but I'll give Burcin a day or so to take a look at it.



---

archive/issue_comments_152955.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-28T01:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152955",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_152956.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-28T07:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152956",
    "user": "https://github.com/burcin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152957.json:
```json
{
    "body": "<a id='comment:10'></a>Looks good to me.",
    "created_at": "2012-02-28T07:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152957",
    "user": "https://github.com/burcin"
}
```

<a id='comment:10'></a>Looks good to me.



---

archive/issue_comments_152958.json:
```json
{
    "body": "<a id='comment:11'></a>Rebasing to sage-5.0.beta5 isn't sufficient, since #9130 was only merged in sage-5.0.beta**6**.  So, this patch still needs an extra rebase.",
    "created_at": "2012-02-28T21:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152958",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Rebasing to sage-5.0.beta5 isn't sufficient, since #9130 was only merged in sage-5.0.beta**6**.  So, this patch still needs an extra rebase.



---

archive/issue_comments_152959.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-28T21:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152959",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_152960.json:
```json
{
    "body": "<a id='comment:12'></a>Oops. I guess that explains why I didn't actually need to do anything to rebase. I'll try to remember to update this later today.",
    "created_at": "2012-02-28T23:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152960",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:12'></a>Oops. I guess that explains why I didn't actually need to do anything to rebase. I'll try to remember to update this later today.



---

archive/issue_comments_152961.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n \n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 476 \u00b5s per loop\n+\\`\\`\\`\n+\n+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n+\n+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n+\n+Now we have\n+\n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 1.02 \u00b5s per loop\n+\\`\\`\\`\n+\n+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n+\n+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n+\n+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n+\n+\\`\\`\\`\n+sage: timeit('math.exp(6.0r)')\n+625 loops, best of 3: 112 ns per loop\n+\\`\\`\\`\n+\n+Apply:\n+- attachment:trac_12449_rebase_beta7.patch\n \n Comment: 1\n \n```\n",
    "created_at": "2012-03-06T07:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152961",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:
 
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 476 µs per loop
+\`\`\`
+
+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.
+
+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.
+
+Now we have
+
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 1.02 µs per loop
+\`\`\`
+
+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.
+
+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )
+
+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to
+
+\`\`\`
+sage: timeit('math.exp(6.0r)')
+625 loops, best of 3: 112 ns per loop
+\`\`\`
+
+Apply:
+- attachment:trac_12449_rebase_beta7.patch
 
 Comment: 1
 
```




---

archive/issue_comments_152962.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-03-06T07:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152962",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_152963.json:
```json
{
    "body": "<a id='comment:14'></a>Ok, now it is rebased to 5.0beta7.",
    "created_at": "2012-03-06T07:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152963",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:14'></a>Ok, now it is rebased to 5.0beta7.



---

archive/issue_comments_152964.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-03-12T12:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152964",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_152965.json:
```json
{
    "body": "<a id='comment:15'></a>There is numerical noise.  On hawk (OpenSolaris 06.2009-32):\n\n```\nsage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx\nWarning: divide by zero encountered in divide\n**********************************************************************\nFile \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx\", line 185:\n    sage: cot(complex(1,2))\nExpected:\n    (0.03279775553375259-0.9843292264581908j)\nGot:\n    (0.03279775553375261-0.9843292264581911j)\n**********************************************************************\nsage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py\nWarning: divide by zero encountered in divide\nWarning: divide by zero encountered in divide\n**********************************************************************\nFile \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py\", line 543:\n    sage: float(arccoth(2))\nExpected:\n    0.5493061443340548\nGot:\n    0.5493061443340549\n**********************************************************************\n```",
    "created_at": "2012-03-12T12:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152965",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>There is numerical noise.  On hawk (OpenSolaris 06.2009-32):

```
sage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx
Warning: divide by zero encountered in divide
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx", line 185:
    sage: cot(complex(1,2))
Expected:
    (0.03279775553375259-0.9843292264581908j)
Got:
    (0.03279775553375261-0.9843292264581911j)
**********************************************************************
sage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py
Warning: divide by zero encountered in divide
Warning: divide by zero encountered in divide
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py", line 543:
    sage: float(arccoth(2))
Expected:
    0.5493061443340548
Got:
    0.5493061443340549
**********************************************************************
```



---

archive/issue_comments_152966.json:
```json
{
    "body": "<a id='comment:16'></a>On bsd (OS X 10.6 64-bit):\n\n```\nsage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py\nWarning: divide by zero encountered in divide\nWarning: divide by zero encountered in divide\n**********************************************************************\nFile \"/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py\", line 543:\n    sage: float(arccoth(2))\nExpected:\n    0.5493061443340548\nGot:\n    0.5493061443340549\n**********************************************************************\n```",
    "created_at": "2012-03-12T13:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152966",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>On bsd (OS X 10.6 64-bit):

```
sage -t  --long -force_lib devel/sage/sage/functions/hyperbolic.py
Warning: divide by zero encountered in divide
Warning: divide by zero encountered in divide
**********************************************************************
File "/Users/buildbot/build/sage/bsd-1/bsd_64_full/build/sage-5.0.beta8/devel/sage-main/sage/functions/hyperbolic.py", line 543:
    sage: float(arccoth(2))
Expected:
    0.5493061443340548
Got:
    0.5493061443340549
**********************************************************************
```



---

archive/issue_comments_152967.json:
```json
{
    "body": "<a id='comment:17'></a>On iras (ia64):\n\n```\nsage -t  --long -force_lib devel/sage/sage/rings/arith.py\n**********************************************************************\nFile \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py\", line 3066:\n    sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```",
    "created_at": "2012-03-12T20:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152967",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>On iras (ia64):

```
sage -t  --long -force_lib devel/sage/sage/rings/arith.py
**********************************************************************
File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py", line 3066:
    sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r
Expected:
    True
Got:
    False
**********************************************************************
```



---

archive/issue_comments_152968.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 jdemeyer]:\n> On iras (ia64):\n> \n> ```\n> sage -t  --long -force_lib devel/sage/sage/rings/arith.py\n> **********************************************************************\n> File \"/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py\", line 3066:\n>     sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r\n> Expected:\n>     True\n> Got:\n>     False\n> **********************************************************************\n> ```\n\n\nThree remarks:\n1. that test is also one that is failing on ARM ; and there's a trac ticket about binomial's implementation being pretty wrong (#12448).\n2. should that test use \"#tol abs\" instead of doing the computation itself?\n3. shouldn't it be even a \"#tol rel\" ?",
    "created_at": "2012-03-13T06:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152968",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:18'></a>Replying to [comment:17 jdemeyer]:
> On iras (ia64):
> 
> ```
> sage -t  --long -force_lib devel/sage/sage/rings/arith.py
> **********************************************************************
> File "/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8/devel/sage-main/sage/rings/arith.py", line 3066:
>     sage: abs(binomial(0.5r, 5) - 0.02734375) < 1e-17r
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> ```


Three remarks:
1. that test is also one that is failing on ARM ; and there's a trac ticket about binomial's implementation being pretty wrong (#12448).
2. should that test use "#tol abs" instead of doing the computation itself?
3. shouldn't it be even a "#tol rel" ?



---

archive/issue_comments_152969.json:
```json
{
    "body": "<a id='comment:19'></a>On cicero (Linux i386):\n\n```\nsage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx\nWarning: divide by zero encountered in divide\n**********************************************************************\nFile \"/home/buildbot/build/sage/cicero-1/cicero_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx\", line 185:\n    sage: cot(complex(1,2))\nExpected:\n    (0.03279775553375259-0.9843292264581908j)\nGot:\n    (0.032797755533752596-0.9843292264581911j)\n**********************************************************************\n```",
    "created_at": "2012-03-13T12:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152969",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>On cicero (Linux i386):

```
sage -t  --long -force_lib devel/sage/sage/symbolic/function.pyx
Warning: divide by zero encountered in divide
**********************************************************************
File "/home/buildbot/build/sage/cicero-1/cicero_full/build/sage-5.0.beta8/devel/sage-main/sage/symbolic/function.pyx", line 185:
    sage: cot(complex(1,2))
Expected:
    (0.03279775553375259-0.9843292264581908j)
Got:
    (0.032797755533752596-0.9843292264581911j)
**********************************************************************
```



---

archive/issue_comments_152970.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-25T03:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152970",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_152971.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:\n \n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 476 \u00b5s per loop\n+\\`\\`\\`\n+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.\n+\n+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.\n+\n+Now we have\n+\n+\\`\\`\\`\n+sage: timeit('exp(6.0r)')\n+625 loops, best of 3: 1.02 \u00b5s per loop\n+\\`\\`\\`\n+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.\n+\n+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )\n+\n+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to\n+\n+\\`\\`\\`\n+sage: timeit('math.exp(6.0r)')\n+625 loops, best of 3: 112 ns per loop\n+\\`\\`\\`\n+Apply:\n+\n+* attachment:trac12449.patch\n \n Comment: 1\n \n```\n",
    "created_at": "2012-05-25T03:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152971",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,32 @@
+Currently when a symbolic function (e.g. gamma(), exp(), sin()) gets a python float, it passes it off to ginac, and let's ginac evaluate it. This can be very slow, e.g.:
 
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 476 µs per loop
+\`\`\`
+This also leads to possibly undesirable inconsistencies across different platforms: for example, ginac ends up calling the local libc tgammal to evaluate the gamma function, and even when this tgammal is evaluated by the same version of eglibc on two different platforms the answer varies depending on whether 80 bit doubles are available.
+
+To fix this, we make Sage check its types which correspond most closely to python type for the function that should be called, and use the functions for those types if available.
+
+Now we have
+
+\`\`\`
+sage: timeit('exp(6.0r)')
+625 loops, best of 3: 1.02 µs per loop
+\`\`\`
+For the specific case of the gamma function, the is also a change here to make RDF use python's math.gamma(). It is more accurate than gsl. It is perhaps not as accurate as eglibc's gamma(), but it should give reliable results on different platforms.
+
+I think this will fix 3 of the 4 failing numerical accuracy doctests on ARM, though the test for binomial(.5r, 5) had to be weakened slightly.  (see http://groups.google.com/group/sage-devel/browse_thread/thread/3c8c61ea113ea60c ) binomial() is currently not computed in a very good way, though, so it is reasonable to weaken this test temporarily. (see http://trac.sagemath.org/sage_trac/ticket/12448 )
+
+Finally, I'll remark that these improvements could probably be much better. The above timings should be compared to
+
+\`\`\`
+sage: timeit('math.exp(6.0r)')
+625 loops, best of 3: 112 ns per loop
+\`\`\`
+Apply:
+
+* attachment:trac12449.patch
 
 Comment: 1
 
```




---

archive/issue_comments_152972.json:
```json
{
    "body": "<a id='comment:21'></a>Ok, here is a version that should quiet those numerical errors. I'm leaving this as need review for the moment instead of putting it back to positive review in case someone wants to revisit the issue of whether or not we might want to make sure that we don't return different results on different machines.",
    "created_at": "2012-05-25T03:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152972",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:21'></a>Ok, here is a version that should quiet those numerical errors. I'm leaving this as need review for the moment instead of putting it back to positive review in case someone wants to revisit the issue of whether or not we might want to make sure that we don't return different results on different machines.



---

archive/issue_comments_152973.json:
```json
{
    "body": "<a id='comment:22'></a>I think it's better to use `RR` (= `RealField(53)`) or `CC` (=`ComplexField(53)`) instead of `RDF` or `CDF`.  That should give more consistent results.",
    "created_at": "2012-05-25T05:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152973",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>I think it's better to use `RR` (= `RealField(53)`) or `CC` (=`ComplexField(53)`) instead of `RDF` or `CDF`.  That should give more consistent results.



---

archive/issue_comments_152974.json:
```json
{
    "body": "<a id='comment:23'></a>Missing \"-\":\n\n```\n            sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 \n```",
    "created_at": "2012-05-25T17:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152974",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:23'></a>Missing "-":

```
            sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 
```



---

archive/issue_comments_152975.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 dsm]:\n> Missing \"-\":\n> \n> \n> ```\n>             sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 \n> ```\n\n\nOops. That is fixed, and the 16 is changed to a 15, since 16 is actually too large, I think. I also took the opportunity to write a better commit message. \n\nOf course, I'm still not sure if this is the right way to do things.",
    "created_at": "2012-05-27T21:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152975",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:24'></a>Replying to [comment:23 dsm]:
> Missing "-":
> 
> 
> ```
>             sage: abs(float(arccoth(2)) - 0.5493061443340548) < 1e16 
> ```


Oops. That is fixed, and the 16 is changed to a 15, since 16 is actually too large, I think. I also took the opportunity to write a better commit message. 

Of course, I'm still not sure if this is the right way to do things.



---

archive/issue_comments_152976.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-31T22:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152976",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152977.json:
```json
{
    "body": "<a id='comment:25'></a>Attachment [trac12449.patch](tarball://root/attachments/some-uuid/ticket12449/trac12449.patch) by bober created at 2012-05-31 22:28:47\n\nOk, after a brief discussion at SD 40.5 (after Jeroen went to sleep and wasn't there to complain) I'm restoring this to positive review. A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.\n\nI hope that all the tests actually pass now. Also, I've twice updated the patch to remove trailing whitespace, so I hope that I actually got it all this time.\n\n(Of course, Jeroen will still have an opportunity to object...)",
    "created_at": "2012-05-31T22:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152977",
    "user": "https://trac.sagemath.org/admin/accounts/users/bober"
}
```

<a id='comment:25'></a>Attachment [trac12449.patch](tarball://root/attachments/some-uuid/ticket12449/trac12449.patch) by bober created at 2012-05-31 22:28:47

Ok, after a brief discussion at SD 40.5 (after Jeroen went to sleep and wasn't there to complain) I'm restoring this to positive review. A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.

I hope that all the tests actually pass now. Also, I've twice updated the patch to remove trailing whitespace, so I hope that I actually got it all this time.

(Of course, Jeroen will still have an opportunity to object...)



---

archive/issue_comments_152978.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-06-01T08:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152978",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_152979.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 bober]:\n> A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.\n\n\nObviously the following comment doesn't apply then:\n\n```\n# It is more accurate than gsl's gamma function and \n# should provide consistant results across platforms. \n```\n\nAlso: you should add tests for the infinity stuff that you added.",
    "created_at": "2012-06-01T08:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152979",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>Replying to [comment:25 bober]:
> A few people seemed to agree that if a function is called on a machine floating point type then it is reasonable for it to give machine dependent answers.


Obviously the following comment doesn't apply then:

```
# It is more accurate than gsl's gamma function and 
# should provide consistant results across platforms. 
```

Also: you should add tests for the infinity stuff that you added.



---

archive/issue_comments_152980.json:
```json
{
    "body": "<a id='comment:27'></a>*** ping ***\n\nThe issues I mentioned in the last comment are fairly trivial.",
    "created_at": "2013-04-17T16:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152980",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>*** ping ***

The issues I mentioned in the last comment are fairly trivial.



---

archive/issue_events_033508.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33508"
}
```



---

archive/issue_events_033509.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33509"
}
```



---

archive/issue_events_033510.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33510"
}
```



---

archive/issue_events_033511.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33511"
}
```



---

archive/issue_events_033512.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33512"
}
```



---

archive/issue_events_033513.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33513"
}
```



---

archive/issue_events_033514.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33514"
}
```



---

archive/issue_comments_152981.json:
```json
{
    "body": "<a id='comment:33'></a>The patch actually contains code that switches FP `sage_tgamma1` from GSL to `python_gamma` which might be a good thing, but requires a separate ticket. The timings are identical, so I suspect that the implementation might be too.",
    "created_at": "2015-02-02T15:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152981",
    "user": "https://github.com/rwst"
}
```

<a id='comment:33'></a>The patch actually contains code that switches FP `sage_tgamma1` from GSL to `python_gamma` which might be a good thing, but requires a separate ticket. The timings are identical, so I suspect that the implementation might be too.



---

archive/issue_comments_152982.json:
```json
{
    "body": "<a id='comment:34'></a>`@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?",
    "created_at": "2015-02-02T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152982",
    "user": "https://github.com/rwst"
}
```

<a id='comment:34'></a>`@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?



---

archive/issue_comments_152983.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-02-02T15:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152983",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_152984.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 rws]:\n> `@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?\n\nNo, this overlaps a lot with #17130.",
    "created_at": "2015-02-02T16:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152984",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>Replying to [comment:34 rws]:
> `@`Jeroen: Is the patch still relevant after the changes you made to `BuiltinFunction.__call__`?

No, this overlaps a lot with #17130.



---

archive/issue_comments_152985.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-03-16T07:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152985",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_events_033515.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-16T07:45:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33515"
}
```



---

archive/issue_events_033516.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2018-03-16T07:45:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33516"
}
```



---

archive/issue_comments_152986.json:
```json
{
    "body": "<a id='comment:37'></a>The original issue seems resolved:\n\n```\nsage: %timeit('exp(6.0r)')\n100000000 loops, best of 3: 7.31 ns per loop\nsage: %timeit('math.exp(6.0r)')\n100000000 loops, best of 3: 7.28 ns per loop\n```",
    "created_at": "2018-03-16T07:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152986",
    "user": "https://github.com/rwst"
}
```

<a id='comment:37'></a>The original issue seems resolved:

```
sage: %timeit('exp(6.0r)')
100000000 loops, best of 3: 7.31 ns per loop
sage: %timeit('math.exp(6.0r)')
100000000 loops, best of 3: 7.28 ns per loop
```



---

archive/issue_events_033517.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-14T17:43:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12449#event-33517"
}
```



---

archive/issue_comments_152987.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2018-08-14T17:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12449#issuecomment-152987",
    "user": "https://github.com/embray"
}
```

Resolution: worksforme
