# Issue 12151: make docbuild cache corruption error message usable

archive/issues_012151.json:
```json
{
    "body": "Assignee: mvngu\n\nI ran into this, perhaps due to hitting control-c at the wrong moment:\n\n```\ndeep:d wstein$ sage -docbuild en/reference html\nTraceback (most recent call last):\n  File \"/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py\", line 1060, in <module>\n    getattr(get_builder(name), type)()\n  File \"/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py\", line 332, in _wrapper\n    inherit_prev = self.get_cache().get('option_inherited')\n  File \"cachefunc.pyx\", line 1397, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (sage/misc/cachefunc.c:7026)\n  File \"/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py\", line 383, in get_cache\n    cache = cPickle.load(file)\nEOFError\n```\n\nIt took a fair bit of cleverness to figure out what file I had to delete in order to get back to work.  Instead, we should use `try: except` and if the load fails, print the file name and suggest that the user delete it and try again.   This will be easy to implement and save people time and frustration.  Since building documentation takes a long time, it is probably not that uncommon for people to control-c out of it, perhaps at the \"wrong\" moment.  \n\nWe could also harden writing the cache file, so that it is more difficult to corrupt.  But at a bare minimum, making a better error message has to be done. \n\n---\n\nApply [attachment:trac_12323-pedantic_version.2.patch] to the main Sage library.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12323\n\n",
    "closed_at": "2012-01-21T23:38:55Z",
    "created_at": "2012-01-18T19:58:15Z",
    "labels": [
        "component: documentation",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "make docbuild cache corruption error message usable",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12151",
    "user": "https://github.com/williamstein"
}
```
Assignee: mvngu

I ran into this, perhaps due to hitting control-c at the wrong moment:

```
deep:d wstein$ sage -docbuild en/reference html
Traceback (most recent call last):
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 1060, in <module>
    getattr(get_builder(name), type)()
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 332, in _wrapper
    inherit_prev = self.get_cache().get('option_inherited')
  File "cachefunc.pyx", line 1397, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (sage/misc/cachefunc.c:7026)
  File "/Users/wstein/sage/install/sage-5.0.beta1/devel/sage/doc/common/builder.py", line 383, in get_cache
    cache = cPickle.load(file)
EOFError
```

It took a fair bit of cleverness to figure out what file I had to delete in order to get back to work.  Instead, we should use `try: except` and if the load fails, print the file name and suggest that the user delete it and try again.   This will be easy to implement and save people time and frustration.  Since building documentation takes a long time, it is probably not that uncommon for people to control-c out of it, perhaps at the "wrong" moment.  

We could also harden writing the cache file, so that it is more difficult to corrupt.  But at a bare minimum, making a better error message has to be done. 

---

Apply [attachment:trac_12323-pedantic_version.2.patch] to the main Sage library.

Issue created by migration from https://trac.sagemath.org/ticket/12323





---

archive/issue_comments_141209.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-18T20:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141209",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141210.json:
```json
{
    "body": "Attachment [trac_12323.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323.patch) by @williamstein created at 2012-01-18 20:20:45",
    "created_at": "2012-01-18T20:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141210",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12323.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323.patch) by @williamstein created at 2012-01-18 20:20:45



---

archive/issue_comments_141211.json:
```json
{
    "body": "This seems like a good idea, but why not just delete the cache file?  See the attached patch.",
    "created_at": "2012-01-19T02:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141211",
    "user": "https://github.com/jhpalmieri"
}
```

This seems like a good idea, but why not just delete the cache file?  See the attached patch.



---

archive/issue_comments_141212.json:
```json
{
    "body": "Attachment [trac_12323-delete-broken-cache.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-delete-broken-cache.patch) by @williamstein created at 2012-01-19 02:49:37\n\nI think your solution is better. Positive review.",
    "created_at": "2012-01-19T02:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141212",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12323-delete-broken-cache.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-delete-broken-cache.patch) by @williamstein created at 2012-01-19 02:49:37

I think your solution is better. Positive review.



---

archive/issue_comments_141213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-19T02:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141213",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141214.json:
```json
{
    "body": "APPLY ONLY:  trac_12323-delete-broken-cache.patch",
    "created_at": "2012-01-19T02:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141214",
    "user": "https://github.com/williamstein"
}
```

APPLY ONLY:  trac_12323-delete-broken-cache.patch



---

archive/issue_comments_141215.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-01-19T16:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141215",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_141216.json:
```json
{
    "body": "I know I'm being pedantic, but shouldn't\n\n```\nfile.close() \nlogger.debug(\"Loaded .rst file cache: %s\", filename) \nreturn cache \n```\nbe outside the try/except?",
    "created_at": "2012-01-19T16:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141216",
    "user": "https://github.com/jdemeyer"
}
```

I know I'm being pedantic, but shouldn't

```
file.close() 
logger.debug("Loaded .rst file cache: %s", filename) 
return cache 
```
be outside the try/except?



---

archive/issue_comments_141217.json:
```json
{
    "body": "What difference does it make?",
    "created_at": "2012-01-19T16:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141217",
    "user": "https://github.com/jhpalmieri"
}
```

What difference does it make?



---

archive/issue_comments_141218.json:
```json
{
    "body": "Attachment [trac_12323-pedantic_version.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-pedantic_version.patch) by @williamstein created at 2012-01-19 16:33:45\n\napply only this",
    "created_at": "2012-01-19T16:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141218",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12323-pedantic_version.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-pedantic_version.patch) by @williamstein created at 2012-01-19 16:33:45

apply only this



---

archive/issue_comments_141219.json:
```json
{
    "body": "In practice little difference, but it's considered good style to \"try\" as few as possible.  You really care about the\n\n```\ncache = cPickle.load(file)\n```\nline raising exception, not the other three lines.",
    "created_at": "2012-01-19T16:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141219",
    "user": "https://github.com/jdemeyer"
}
```

In practice little difference, but it's considered good style to "try" as few as possible.  You really care about the

```
cache = cPickle.load(file)
```
line raising exception, not the other three lines.



---

archive/issue_comments_141220.json:
```json
{
    "body": "I agree with jdemeyer, since it could mask errors.  I've attached another version of the patch.",
    "created_at": "2012-01-19T16:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141220",
    "user": "https://github.com/williamstein"
}
```

I agree with jdemeyer, since it could mask errors.  I've attached another version of the patch.



---

archive/issue_comments_141221.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-19T16:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141221",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141222.json:
```json
{
    "body": "You forgot to delete the cache file.  Was that intentional?  It seems to work this way -- I think Sphinx just overwrites the file if this function returns `{}` -- but perhaps the message should say \"Cache file '%s' is corrupted; ignoring it...\" instead of \"deleting it...\".",
    "created_at": "2012-01-19T17:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141222",
    "user": "https://github.com/jhpalmieri"
}
```

You forgot to delete the cache file.  Was that intentional?  It seems to work this way -- I think Sphinx just overwrites the file if this function returns `{}` -- but perhaps the message should say "Cache file '%s' is corrupted; ignoring it..." instead of "deleting it...".



---

archive/issue_comments_141223.json:
```json
{
    "body": "That wasn't intentional, but it makes sense to do that.  Yes, the error message has to be changed. I'm uploading a new patch.",
    "created_at": "2012-01-19T17:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141223",
    "user": "https://github.com/williamstein"
}
```

That wasn't intentional, but it makes sense to do that.  Yes, the error message has to be changed. I'm uploading a new patch.



---

archive/issue_comments_141224.json:
```json
{
    "body": "Attachment [trac_12323-pedantic_version.2.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-pedantic_version.2.patch) by @williamstein created at 2012-01-19 17:40:59",
    "created_at": "2012-01-19T17:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141224",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12323-pedantic_version.2.patch](tarball://root/attachments/some-uuid/ticket12323/trac_12323-pedantic_version.2.patch) by @williamstein created at 2012-01-19 17:40:59



---

archive/issue_comments_141225.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-19T18:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141225",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141226.json:
```json
{
    "body": "Okay, looks good to me.",
    "created_at": "2012-01-19T18:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141226",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, looks good to me.



---

archive/issue_comments_141227.json:
```json
{
    "body": "Nice illustration of try/except/else/finally :-)",
    "created_at": "2012-01-19T18:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141227",
    "user": "https://github.com/jdemeyer"
}
```

Nice illustration of try/except/else/finally :-)



---

archive/issue_comments_141228.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-21T23:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12151#issuecomment-141228",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_033000.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-21T23:38:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12151",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12151#event-33000"
}
```
