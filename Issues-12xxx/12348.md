# Issue 12348: variable ind has the wrong type in matrix indexing; and why are big sparse matrices so slow to make?

archive/issues_012176.json:
```json
{
    "body": "Oops, in the function  `def __getitem__(self, key)` in matrix0.pyx, the variable `ind` is of type int.  \n\nThis will work fine on 32-bit, but will be totally broken/buggy in subtle and surprising ways on 64-bit machines.  The type of ind should be `Py_ssize_t`, just like the type of `i`.  Nobody will notice this now, because there is some sort of massive weird inefficiency in the creation of sparse matrices (maybe the parent space has its basis constructed or something idiotic like that), which makes it impossible to make a large sparse matrix, even though this should be trivial, instant, fast, and take no memory:\n\n```\nsage: time a = matrix(QQ, 2^25, sparse=True)\nTime: CPU 5.88 s, Wall: 8.46 s\nsage: get_memory_usage()   # what ?\n3908.29296875\n```\n\nThe ind being an int was introduced in #4973.\n\n\nAssignee: jason, was\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/12348\n\n",
    "created_at": "2012-01-24T19:18:20Z",
    "labels": [
        "component: linear algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "variable ind has the wrong type in matrix indexing; and why are big sparse matrices so slow to make?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12348",
    "user": "https://github.com/williamstein"
}
```
Oops, in the function  `def __getitem__(self, key)` in matrix0.pyx, the variable `ind` is of type int.  

This will work fine on 32-bit, but will be totally broken/buggy in subtle and surprising ways on 64-bit machines.  The type of ind should be `Py_ssize_t`, just like the type of `i`.  Nobody will notice this now, because there is some sort of massive weird inefficiency in the creation of sparse matrices (maybe the parent space has its basis constructed or something idiotic like that), which makes it impossible to make a large sparse matrix, even though this should be trivial, instant, fast, and take no memory:

```
sage: time a = matrix(QQ, 2^25, sparse=True)
Time: CPU 5.88 s, Wall: 8.46 s
sage: get_memory_usage()   # what ?
3908.29296875
```

The ind being an int was introduced in #4973.


Assignee: jason, was

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/12348





---

archive/issue_comments_180073.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis is how the sparse matrix is being stored:\n\n```\n        [...]\n\n        self._matrix = <mpq_vector*> sage_malloc(parent.nrows()*sizeof(mpq_vector))\n\n        [...]\n \n        for i from 0 <= i < parent.nrows():\n            mpq_vector_init(&self._matrix[i], self._ncols, 0)\n\n```\n\nThis even introduces a subtle slowdown when the object is lost because of the deallocation, which puzzled me for some time:\n\n```\n            for i from 0 <= i < self._nrows:\n                mpq_vector_clear(&self._matrix[i])\n\n```\n\nI wonder if this is indirectly responsible for some of the surprisingly slow sparse routines.",
    "created_at": "2012-05-25T17:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12348#issuecomment-180073",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:1'></a>
This is how the sparse matrix is being stored:

```
        [...]

        self._matrix = <mpq_vector*> sage_malloc(parent.nrows()*sizeof(mpq_vector))

        [...]
 
        for i from 0 <= i < parent.nrows():
            mpq_vector_init(&self._matrix[i], self._ncols, 0)

```

This even introduces a subtle slowdown when the object is lost because of the deallocation, which puzzled me for some time:

```
            for i from 0 <= i < self._nrows:
                mpq_vector_clear(&self._matrix[i])

```

I wonder if this is indirectly responsible for some of the surprisingly slow sparse routines.



---

archive/issue_comments_180074.json:
```json
{
    "body": "<a id='comment:2'></a>\nOne solution would be to have a special case of null pointer for empty rows.  All code (e.g., echelon form) would have to be changed to take this special case into account.  That would resolve this problem. \n\nI wrote the mpq sparse matrix class for computing presentations of modular symbols spaces, and in that situation there are no zero rows, so this wasn't a problem for me.",
    "created_at": "2012-05-25T17:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12348#issuecomment-180074",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
One solution would be to have a special case of null pointer for empty rows.  All code (e.g., echelon form) would have to be changed to take this special case into account.  That would resolve this problem. 

I wrote the mpq sparse matrix class for computing presentations of modular symbols spaces, and in that situation there are no zero rows, so this wasn't a problem for me.



---

archive/issue_events_038845.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38845"
}
```



---

archive/issue_events_038846.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38846"
}
```



---

archive/issue_events_038847.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38847"
}
```



---

archive/issue_events_038848.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38848"
}
```



---

archive/issue_events_038849.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38849"
}
```



---

archive/issue_events_038850.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38850"
}
```



---

archive/issue_events_038851.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12348",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12348#event-38851"
}
```
