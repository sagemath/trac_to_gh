# Issue 12263: Unset TERM when running sage non-interactively

archive/issues_012091.json:
```json
{
    "body": "Because of either a readline or a Python bug, sometimes control characters are output by Python.  For example, on my Gentoo Linux system:\n\n```\njdemeyer@arcanis:~$ sage --python -c 'import readline' |cat -t\n^[[?1034hjdemeyer@arcanis:~$\n```\n\nThis breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.\n\nUpstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)\n\n**Apply** [attachment:12263_unset_TERM.patch] to the **scripts** repository.\n\nAssignee: @nexttime\n\nResolution: fixed\n\nAuthor: Jeroen Demeyer\n\nReviewer: Volker Braun\n\nUpstream: Workaround found; Bug reported upstream.\n\nMerged: sage-4.8.rc0\n\nIssue created by migration from https://trac.sagemath.org/ticket/12263\n\n",
    "closed_at": "2012-01-05T07:49:08Z",
    "created_at": "2012-01-04T16:48:56Z",
    "labels": [
        "component: scripts",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Unset TERM when running sage non-interactively",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12263",
    "user": "https://github.com/jdemeyer"
}
```
Because of either a readline or a Python bug, sometimes control characters are output by Python.  For example, on my Gentoo Linux system:

```
jdemeyer@arcanis:~$ sage --python -c 'import readline' |cat -t
^[[?1034hjdemeyer@arcanis:~$
```

This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.

Upstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)

**Apply** [attachment:12263_unset_TERM.patch] to the **scripts** repository.

Assignee: @nexttime

Resolution: fixed

Author: Jeroen Demeyer

Reviewer: Volker Braun

Upstream: Workaround found; Bug reported upstream.

Merged: sage-4.8.rc0

Issue created by migration from https://trac.sagemath.org/ticket/12263





---

archive/issue_comments_172415.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,6 +7,8 @@\n \n This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.\n \n+Upstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)\n+\n Author: Jeroen Demeyer\n \n Comment: 1\n``````\n",
    "created_at": "2012-01-04T16:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172415",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,6 +7,8 @@
 
 This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.
 
+Upstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)
+
 Author: Jeroen Demeyer
 
 Comment: 1
``````




---

archive/issue_comments_172416.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Workaround found; Bug reported upstream.\"",
    "created_at": "2012-01-04T16:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172416",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "N/A" to "Workaround found; Bug reported upstream."



---

archive/issue_comments_172417.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,15 @@\n+Because of either a readline or a Python bug, sometimes control characters are output by Python.  For example, on my Gentoo Linux system:\n \n+```\n+jdemeyer@arcanis:~$ sage --python -c 'import readline' |cat -t\n+^[[?1034hjdemeyer@arcanis:~$\n+```\n+\n+This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.\n+\n+Upstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)\n+\n+**Apply** [attachment:12263_unset_TERM.patch] to the **scripts** repository.\n \n Author: Jeroen Demeyer\n \n``````\n",
    "created_at": "2012-01-04T16:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172417",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,15 @@
+Because of either a readline or a Python bug, sometimes control characters are output by Python.  For example, on my Gentoo Linux system:
 
+```
+jdemeyer@arcanis:~$ sage --python -c 'import readline' |cat -t
+^[[?1034hjdemeyer@arcanis:~$
+```
+
+This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.
+
+Upstream (readline): [http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html](http://lists.gnu.org/archive/html/bug-readline/2007-08/msg00004.html)
+
+**Apply** [attachment:12263_unset_TERM.patch] to the **scripts** repository.
 
 Author: Jeroen Demeyer
 
``````




---

archive/issue_comments_172418.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-04T16:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172418",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172419.json:
```json
{
    "body": "<a id='comment:2'></a>Attachment [12263_unset_TERM.patch](tarball://root/attachments/some-uuid/ticket12263/12263_unset_TERM.patch) by @jdemeyer created at 2012-01-04 16:57:27",
    "created_at": "2012-01-04T16:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172419",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Attachment [12263_unset_TERM.patch](tarball://root/attachments/some-uuid/ticket12263/12263_unset_TERM.patch) by @jdemeyer created at 2012-01-04 16:57:27



---

archive/issue_comments_172420.json:
```json
{
    "body": "<a id='comment:3'></a>Looks good!",
    "created_at": "2012-01-04T17:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172420",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>Looks good!



---

archive/issue_comments_172421.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-04T17:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172421",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_032744.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-05T07:49:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12263#event-32744"
}
```



---

archive/issue_comments_172422.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2012-01-05T07:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172422",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_172423.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-05T07:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172423",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_172424.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.8.rc0\"",
    "created_at": "2012-01-05T07:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172424",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.8.rc0"



---

archive/issue_comments_172425.json:
```json
{
    "body": "<a id='comment:5'></a>*\"My Gentoo Linux system\"* isn't very precise.\n\nNote that (also Sage's) readline uses *some* termcap library, i.e. some \"arbitrary\" equivalent installed / found on a user's system, which apparently leads to improper output of control sequences (intended to be handled by the terminal) in some (mis-)configurations; cf. also [this Python bug report](http://mail.python.org/pipermail//new-bugs-announce/2011-October/011990.html).\n\nUnsetting `TERM` unfortunately doesn't *\"effectively disable readline\"*, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.",
    "created_at": "2012-01-06T19:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172425",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:5'></a>*"My Gentoo Linux system"* isn't very precise.

Note that (also Sage's) readline uses *some* termcap library, i.e. some "arbitrary" equivalent installed / found on a user's system, which apparently leads to improper output of control sequences (intended to be handled by the terminal) in some (mis-)configurations; cf. also [this Python bug report](http://mail.python.org/pipermail//new-bugs-announce/2011-October/011990.html).

Unsetting `TERM` unfortunately doesn't *"effectively disable readline"*, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.



---

archive/issue_comments_172426.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 leif]:\n> Unsetting `TERM` unfortunately doesn't *\"effectively disable readline\"*, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.\n\n\nI don't think that is a good solution, because we need Sage to work with `TERM` unset.  Imagine for example somebody wants to run sage from a cron script, then `TERM` would not be set.  Also, `TERM` is not set when you run something like\n\n```\nssh mysagebox \"sage script.sage\"\n```",
    "created_at": "2012-01-07T21:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172426",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [comment:5 leif]:
> Unsetting `TERM` unfortunately doesn't *"effectively disable readline"*, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.


I don't think that is a good solution, because we need Sage to work with `TERM` unset.  Imagine for example somebody wants to run sage from a cron script, then `TERM` would not be set.  Also, `TERM` is not set when you run something like

```
ssh mysagebox "sage script.sage"
```



---

archive/issue_comments_172427.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 jdemeyer]:\n> I don't think that is a good solution, because we need Sage to work with `TERM` unset.\n\n\nWell, then *someone*<sup>TM</sup> has to track down the (rare?) segfault reported at #11970... ;P",
    "created_at": "2012-01-07T21:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172427",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>Replying to [comment:6 jdemeyer]:
> I don't think that is a good solution, because we need Sage to work with `TERM` unset.


Well, then *someone*<sup>TM</sup> has to track down the (rare?) segfault reported at #11970... ;P



---

archive/issue_comments_172428.json:
```json
{
    "body": "<a id='comment:8'></a>Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.\n\nFor context, this is readline outputting the \"meta mode on\"/\"smm\" sequence to enable 8 bit mode. This is signalled by the \"km\" termcap flag, viewable using 'infocmp', where you can also directly see the \"smm\" sequence.",
    "created_at": "2012-01-14T15:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172428",
    "user": "https://github.com/wjp"
}
```

<a id='comment:8'></a>Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.

For context, this is readline outputting the "meta mode on"/"smm" sequence to enable 8 bit mode. This is signalled by the "km" termcap flag, viewable using 'infocmp', where you can also directly see the "smm" sequence.



---

archive/issue_comments_172429.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 wjp]:\n> Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.\n\n\nAre you sure there is an **environment variable** \"TERM\" in the cases you mention?  It seems to me that bash sets a non-exported variable TERM=dumb if there is no environment variable TERM.  You can see this with \"declare -p TERM\".  In a normal shell, I get for example\n\n```\n$ declare -p TERM\ndeclare -x TERM=\"xterm\"\n```\n(the -x means exported)\n\nWith a non-interactive ssh session:\n\n```\n$ ssh sage.math.washington.edu \"declare -p TERM\"\ndeclare -- TERM=\"dumb\"\n```\n(no -x, so not exported, i.e. not an environment variable)",
    "created_at": "2012-01-14T18:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12263#issuecomment-172429",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:8 wjp]:
> Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.


Are you sure there is an **environment variable** "TERM" in the cases you mention?  It seems to me that bash sets a non-exported variable TERM=dumb if there is no environment variable TERM.  You can see this with "declare -p TERM".  In a normal shell, I get for example

```
$ declare -p TERM
declare -x TERM="xterm"
```
(the -x means exported)

With a non-interactive ssh session:

```
$ ssh sage.math.washington.edu "declare -p TERM"
declare -- TERM="dumb"
```
(no -x, so not exported, i.e. not an environment variable)
