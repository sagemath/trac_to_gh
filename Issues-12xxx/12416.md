# Issue 12416: Mercurial assumes that any system with XCode *installed* will use XCode to *build* Mercurial

archive/issues_012244.json:
```json
{
    "body": "Assignee: tbd\n\nThis is an except from upstream's `setup.py`:\n\n```\nif sys.platform == 'darwin' and os.path.exists('/usr/bin/xcodebuild'):\n    # XCode 4.0 dropped support for ppc architecture, which is hardcoded in\n    # distutils.sysconfig\n    version = runcmd(['/usr/bin/xcodebuild', '-version'], {})[0].splitlines()[0]\n    # Also parse only first digit, because 3.2.1 can't be parsed nicely\n    if (version.startswith('Xcode') and\n        StrictVersion(version.split()[1]) >= StrictVersion('4.0')):\n        os.environ['ARCHFLAGS'] = '-arch i386 -arch x86_64'\n```\n\nThe `ARCHFLAGS` are passed to `gcc` during the setup of Mercurial.  This obviously breaks on a system with XCode installed, but where the \"gcc\" found in the `PATH` isn't XCode's gcc.\n\nIn later upstream releases, the last line is changed to\n\n```\nos.environ['ARCHFLAGS'] = ''\n```\n\nSo I propose to backport this change.\n\n**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mercurial-1.8.4.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mercurial-1.8.4.p0.spkg)\n\nSee #12570 for a follow-up.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12416\n\n",
    "closed_at": "2012-02-14T14:22:56Z",
    "created_at": "2012-02-02T20:44:39Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Mercurial assumes that any system with XCode *installed* will use XCode to *build* Mercurial",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12416",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: tbd

This is an except from upstream's `setup.py`:

```
if sys.platform == 'darwin' and os.path.exists('/usr/bin/xcodebuild'):
    # XCode 4.0 dropped support for ppc architecture, which is hardcoded in
    # distutils.sysconfig
    version = runcmd(['/usr/bin/xcodebuild', '-version'], {})[0].splitlines()[0]
    # Also parse only first digit, because 3.2.1 can't be parsed nicely
    if (version.startswith('Xcode') and
        StrictVersion(version.split()[1]) >= StrictVersion('4.0')):
        os.environ['ARCHFLAGS'] = '-arch i386 -arch x86_64'
```

The `ARCHFLAGS` are passed to `gcc` during the setup of Mercurial.  This obviously breaks on a system with XCode installed, but where the "gcc" found in the `PATH` isn't XCode's gcc.

In later upstream releases, the last line is changed to

```
os.environ['ARCHFLAGS'] = ''
```

So I propose to backport this change.

**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mercurial-1.8.4.p0.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mercurial-1.8.4.p0.spkg)

See #12570 for a follow-up.

Issue created by migration from https://trac.sagemath.org/ticket/12416





---

archive/issue_comments_143141.json:
```json
{
    "body": "Diff for the mercurial spkg, for review only",
    "created_at": "2012-02-02T20:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143141",
    "user": "https://github.com/jdemeyer"
}
```

Diff for the mercurial spkg, for review only



---

archive/issue_comments_143142.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-02T21:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143142",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_143143.json:
```json
{
    "body": "Attachment [mercurial-1.8.4.p0.patch](tarball://root/attachments/some-uuid/ticket12416/mercurial-1.8.4.p0.patch) by @jdemeyer created at 2012-02-02 21:00:55",
    "created_at": "2012-02-02T21:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143143",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [mercurial-1.8.4.p0.patch](tarball://root/attachments/some-uuid/ticket12416/mercurial-1.8.4.p0.patch) by @jdemeyer created at 2012-02-02 21:00:55



---

archive/issue_comments_143144.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-10T16:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143144",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_143145.json:
```json
{
    "body": "looks good, works good",
    "created_at": "2012-02-10T16:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143145",
    "user": "https://github.com/ohanar"
}
```

looks good, works good



---

archive/issue_comments_143146.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-14T14:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12416#issuecomment-143146",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_033328.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-14T14:22:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12416",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12416#event-33328"
}
```
