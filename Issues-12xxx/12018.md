# Issue 12018: sage-list-packages will fail if user can't write to SAGE_ROOT

archive/issues_011846.json:
```json
{
    "body": "As the summary says.  The script sage-list-packages writes a temporary file to\n\n```\nfile = \"%s/tmp/list\"%SAGE_ROOT\n```\nThis should use a temporary file instead.\n\n---\n\nApply [attachment:trac12018-notempfile.patch] to the scripts repo.\n\nAssignee: @nexttime\n\nReviewer: John Palmieri\n\nAuthor: R. Andrew Ohana\n\nMerged: sage-5.0.beta10\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12018\n\n",
    "closed_at": "2012-03-23T15:20:47Z",
    "created_at": "2011-11-13T00:46:36Z",
    "labels": [
        "component: scripts",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "sage-list-packages will fail if user can't write to SAGE_ROOT",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12018",
    "user": "https://github.com/jhpalmieri"
}
```
As the summary says.  The script sage-list-packages writes a temporary file to

```
file = "%s/tmp/list"%SAGE_ROOT
```
This should use a temporary file instead.

---

Apply [attachment:trac12018-notempfile.patch] to the scripts repo.

Assignee: @nexttime

Reviewer: John Palmieri

Author: R. Andrew Ohana

Merged: sage-5.0.beta10

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12018





---

archive/issue_comments_143278.json:
```json
{
    "body": "Attachment [trac_12018-tempfile.patch](tarball://root/attachments/some-uuid/ticket12018/trac_12018-tempfile.patch) by @jhpalmieri created at 2011-11-13 00:47:47",
    "created_at": "2011-11-13T00:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143278",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_12018-tempfile.patch](tarball://root/attachments/some-uuid/ticket12018/trac_12018-tempfile.patch) by @jhpalmieri created at 2011-11-13 00:47:47



---

archive/issue_comments_143279.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -4,6 +4,10 @@\n file = \"%s/tmp/list\"%SAGE_ROOT\n \\`\\`\\`\n This should use a temporary file instead.\n+\n+---\n+\n+Apply [attachment:trac_12018-tempfile.patch] to the scripts repo.\n \n Author: John Palmieri\n \n```\n",
    "created_at": "2011-11-13T00:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143279",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
```diff
--- 
+++ 
@@ -4,6 +4,10 @@
 file = "%s/tmp/list"%SAGE_ROOT
 \`\`\`
 This should use a temporary file instead.
+
+---
+
+Apply [attachment:trac_12018-tempfile.patch] to the scripts repo.
 
 Author: John Palmieri
 
```




---

archive/issue_comments_143280.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-13T00:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143280",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_143281.json:
```json
{
    "body": "<a id='comment:2'></a>I should point out that sage-list-packages is used by the commands \"sage --standard\", \"sage --optional\", and \"sage --experimental\".",
    "created_at": "2011-11-14T18:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143281",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>I should point out that sage-list-packages is used by the commands "sage --standard", "sage --optional", and "sage --experimental".



---

archive/issue_comments_143282.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n+As the summary says.  The script sage-list-packages writes a temporary file to\n \n+\\`\\`\\`\n+file = \"%s/tmp/list\"%SAGE_ROOT\n+\\`\\`\\`\n+This should use a temporary file instead.\n+\n+---\n+\n+Apply [attachment:trac_12018-tempfile.patch] OR [attachment:trac12018-notempfile.patch] to the scripts repo.\n \n Author: John Palmieri\n \n```\n",
    "created_at": "2012-02-28T22:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143282",
    "user": "https://github.com/ohanar"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,13 @@
+As the summary says.  The script sage-list-packages writes a temporary file to
 
+\`\`\`
+file = "%s/tmp/list"%SAGE_ROOT
+\`\`\`
+This should use a temporary file instead.
+
+---
+
+Apply [attachment:trac_12018-tempfile.patch] OR [attachment:trac12018-notempfile.patch] to the scripts repo.
 
 Author: John Palmieri
 
```




---

archive/issue_comments_143283.json:
```json
{
    "body": "<a id='comment:3'></a>I've added a patch that avoids the use of a tempfile and cleans up the script (`os.path` should be used instead of string arithmetic).",
    "created_at": "2012-02-28T22:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143283",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:3'></a>I've added a patch that avoids the use of a tempfile and cleans up the script (`os.path` should be used instead of string arithmetic).



---

archive/issue_comments_143284.json:
```json
{
    "body": "<a id='comment:4'></a>In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.",
    "created_at": "2012-02-28T22:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143284",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.



---

archive/issue_comments_143285.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 jhpalmieri]:\n> In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.\n\n\nGood point, it seems like the `urlparse` library is what I should have used. I'll update my patch.",
    "created_at": "2012-02-28T22:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143285",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:5'></a>Replying to [comment:4 jhpalmieri]:
> In your patch, I appreciate the use of os.path.join for local paths, but is this the right thing to do for urls? If the local system has some funny path separator, the url may be misformed.


Good point, it seems like the `urlparse` library is what I should have used. I'll update my patch.



---

archive/issue_comments_143286.json:
```json
{
    "body": "<a id='comment:6'></a>ok, patch updated",
    "created_at": "2012-02-28T23:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143286",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:6'></a>ok, patch updated



---

archive/issue_comments_143287.json:
```json
{
    "body": "<a id='comment:7'></a>I'm happy to use your approach and not to create a file.  Some more comments: I think using urlparse.urljoin will clean some things up:\n\n```diff\ndiff --git a/sage-list-packages b/sage-list-packages\n--- a/sage-list-packages\n+++ b/sage-list-packages\n@@ -11,16 +11,11 @@ if not os.environ.has_key(\"SAGE_SERVER\")\n      print \"The environment variable SAGE_SERVER must be set\"\n      sys.exit(1)\n \n-url_list = list(urlparse.urlsplit(os.environ['SAGE_SERVER']))\n-url_path = os.path.join(url_list[2], 'packages')\n-url_list[2] = urllib.pathname2url(url_path)\n-\n-PKG_SERVER = urlparse.urlunsplit(url_list)\n+PKG_SERVER = urlparse.urljoin(os.environ['SAGE_SERVER'], 'packages')\n print \"Using SAGE Server %s\"%PKG_SERVER\n \n-url_path = os.path.join(url_path, sys.argv[1], 'list')\n-url_list[2] = urllib.pathname2url(url_path)\n-url = urlparse.urlunsplit(url_list)\n+url_path = os.path.join('packages', sys.argv[1], 'list')\n+url = urlparse.urljoin(PKG_SERVER, urllib.pathname2url(url_path))\n \n try:\n      installed = set(os.listdir(os.path.join(SPKG_ROOT, 'installed')))\n```\nAlso, according to the [Python documentation](http://docs.python.org/library/urllib.html#urllib.urlopen), urllib.urlopen is deprecated in favor of urllib2.urlopen.  Maybe we should use that instead?",
    "created_at": "2012-02-29T04:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143287",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>I'm happy to use your approach and not to create a file.  Some more comments: I think using urlparse.urljoin will clean some things up:

```diff
diff --git a/sage-list-packages b/sage-list-packages
--- a/sage-list-packages
+++ b/sage-list-packages
@@ -11,16 +11,11 @@ if not os.environ.has_key("SAGE_SERVER")
      print "The environment variable SAGE_SERVER must be set"
      sys.exit(1)
 
-url_list = list(urlparse.urlsplit(os.environ['SAGE_SERVER']))
-url_path = os.path.join(url_list[2], 'packages')
-url_list[2] = urllib.pathname2url(url_path)
-
-PKG_SERVER = urlparse.urlunsplit(url_list)
+PKG_SERVER = urlparse.urljoin(os.environ['SAGE_SERVER'], 'packages')
 print "Using SAGE Server %s"%PKG_SERVER
 
-url_path = os.path.join(url_path, sys.argv[1], 'list')
-url_list[2] = urllib.pathname2url(url_path)
-url = urlparse.urlunsplit(url_list)
+url_path = os.path.join('packages', sys.argv[1], 'list')
+url = urlparse.urljoin(PKG_SERVER, urllib.pathname2url(url_path))
 
 try:
      installed = set(os.listdir(os.path.join(SPKG_ROOT, 'installed')))
```
Also, according to the [Python documentation](http://docs.python.org/library/urllib.html#urllib.urlopen), urllib.urlopen is deprecated in favor of urllib2.urlopen.  Maybe we should use that instead?



---

archive/issue_comments_143288.json:
```json
{
    "body": "<a id='comment:8'></a>Any updates on this?",
    "created_at": "2012-03-18T23:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143288",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Any updates on this?



---

archive/issue_comments_143289.json:
```json
{
    "body": "<a id='comment:9'></a>I think we should do what you suggest, sorry, got caught up in other stuff.",
    "created_at": "2012-03-18T23:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143289",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:9'></a>I think we should do what you suggest, sorry, got caught up in other stuff.



---

archive/issue_comments_143290.json:
```json
{
    "body": "patch that avoids the use of a tempfile (and uses os.path instead of string arithmetic)",
    "created_at": "2012-03-18T23:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143290",
    "user": "https://github.com/ohanar"
}
```

patch that avoids the use of a tempfile (and uses os.path instead of string arithmetic)



---

archive/issue_comments_143291.json:
```json
{
    "body": "<a id='comment:10'></a>Attachment [trac12018-notempfile.patch](tarball://root/attachments/some-uuid/ticket12018/trac12018-notempfile.patch) by @ohanar created at 2012-03-18 23:43:43\n\nok, updated",
    "created_at": "2012-03-18T23:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143291",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:10'></a>Attachment [trac12018-notempfile.patch](tarball://root/attachments/some-uuid/ticket12018/trac12018-notempfile.patch) by @ohanar created at 2012-03-18 23:43:43

ok, updated



---

archive/issue_comments_143292.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n+As the summary says.  The script sage-list-packages writes a temporary file to\n \n+\\`\\`\\`\n+file = \"%s/tmp/list\"%SAGE_ROOT\n+\\`\\`\\`\n+This should use a temporary file instead.\n+\n+---\n+\n+Apply [attachment:trac12018-notempfile.patch] to the scripts repo.\n \n Author: John Palmieri\n \n```\n",
    "created_at": "2012-03-19T17:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143292",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,13 @@
+As the summary says.  The script sage-list-packages writes a temporary file to
 
+\`\`\`
+file = "%s/tmp/list"%SAGE_ROOT
+\`\`\`
+This should use a temporary file instead.
+
+---
+
+Apply [attachment:trac12018-notempfile.patch] to the scripts repo.
 
 Author: John Palmieri
 
```




---

archive/issue_comments_143293.json:
```json
{
    "body": "<a id='comment:11'></a>Looks good to me.",
    "created_at": "2012-03-19T17:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143293",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>Looks good to me.



---

archive/issue_comments_143294.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-19T17:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143294",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_031877.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-23T15:20:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12018#event-31877"
}
```



---

archive/issue_comments_143295.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-23T15:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12018",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12018#issuecomment-143295",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
