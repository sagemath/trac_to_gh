# Issue 12614: prereq should clean up its build directory

archive/issues_012442.json:
```json
{
    "body": "The prereq \"spkg\" should clean up its build directory, just like sage-spkg does for other spkgs.\n\nApply [attachment:trac_12614-prereq.rebased.patch] to the root repo.\n\nAssignee: GeorgSWeber\n\nReviewer: Keshav Kini\n\nAuthor: John Palmieri\n\nMerged: sage-5.1.beta1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12614\n\n",
    "closed_at": "2012-05-23T21:32:15Z",
    "created_at": "2012-02-29T23:52:35Z",
    "labels": [
        "component: build",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "prereq should clean up its build directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12614",
    "user": "https://github.com/jhpalmieri"
}
```
The prereq "spkg" should clean up its build directory, just like sage-spkg does for other spkgs.

Apply [attachment:trac_12614-prereq.rebased.patch] to the root repo.

Assignee: GeorgSWeber

Reviewer: Keshav Kini

Author: John Palmieri

Merged: sage-5.1.beta1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12614





---

archive/issue_comments_181615.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-29T23:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181615",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_181616.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,3 @@\n The bzip2 and prereq \"spkgs\" should clean up their build directories, just like sage-spkg does for other spkgs. See the attached patch.\n \n+Apply [attachment:trac_12614-bzip2-prereq.patch] to the root repo.\n``````\n",
    "created_at": "2012-02-29T23:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181616",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,3 @@
 The bzip2 and prereq "spkgs" should clean up their build directories, just like sage-spkg does for other spkgs. See the attached patch.
 
+Apply [attachment:trac_12614-bzip2-prereq.patch] to the root repo.
``````




---

archive/issue_comments_181617.json:
```json
{
    "body": "<a id='comment:2'></a>I tried your patch, and it doesn't look like it works : I still have the bzip2 and prereq sources in $SAGE_ROOT/spkg/build, although they have been built long ago.\n\nWhere is $SAGE_BUILD_DIR defined?\n\nShouldn't it be $BUILD, as used in the rest of the bzip2-1.0.5-install script?\n\nAside: is it normal that neither bzip2 nor prereq prints \"Successfully installed ...\" when it succeeds, as do all other spkg?",
    "created_at": "2012-03-01T21:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181617",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:2'></a>I tried your patch, and it doesn't look like it works : I still have the bzip2 and prereq sources in $SAGE_ROOT/spkg/build, although they have been built long ago.

Where is $SAGE_BUILD_DIR defined?

Shouldn't it be $BUILD, as used in the rest of the bzip2-1.0.5-install script?

Aside: is it normal that neither bzip2 nor prereq prints "Successfully installed ..." when it succeeds, as do all other spkg?



---

archive/issue_comments_181618.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [Snark](#comment%3A2):\n> I tried your patch, and it doesn't look like it works : I still have the bzip2 and prereq sources in $SAGE_ROOT/spkg/build, although they have been built long ago.\n\n\nThe patch here will only do something when those packages are actually built.  So you could take a fresh Sage tar ball, apply this patch to the `SAGE_ROOT` directory, then type `make`. The `bzip2` and `prereq` subdirectories of `spkg/build` should be created and then deleted when those packages are successfully built.\n\nI guess you should be able to force installation of those packages in an existing Sage installation, maybe by running `sage -sh` and then `$SAGE_ROOT/spkg/base/prereq-0.9-install`, for example. That should clean up `spkg/base/prereq-0.9`.\n\n> Where is $SAGE_BUILD_DIR defined?\n> \n> Shouldn't it be $BUILD, as used in the rest of the bzip2-1.0.5-install script?\n\n\nSorry, I forgot to list #4949 as a dependency. That ticket changes `$BUILD` to `$SAGE_BUILD_DIR`.\n\n> Aside: is it normal that neither bzip2 nor prereq prints \"Successfully installed ...\" when it succeeds, as do all other spkg?\n\n\nI don't know about \"normal\". The issue is that most spkgs are installed by the script `sage-spkg`, but `prereq` and `bzip2` are not, because (for example) `sage-spkg` tries to bunzip spkgs, so we shouldn't use it on `bzip2`. The `sage-spkg` script is responsible for printing messages like this, as well as for deleting the temporary build directories, and the patch here is trying to make at least part of the installation of bzip2 and prereq act like other spkgs.",
    "created_at": "2012-03-01T23:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181618",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>Replying to [Snark](#comment%3A2):
> I tried your patch, and it doesn't look like it works : I still have the bzip2 and prereq sources in $SAGE_ROOT/spkg/build, although they have been built long ago.


The patch here will only do something when those packages are actually built.  So you could take a fresh Sage tar ball, apply this patch to the `SAGE_ROOT` directory, then type `make`. The `bzip2` and `prereq` subdirectories of `spkg/build` should be created and then deleted when those packages are successfully built.

I guess you should be able to force installation of those packages in an existing Sage installation, maybe by running `sage -sh` and then `$SAGE_ROOT/spkg/base/prereq-0.9-install`, for example. That should clean up `spkg/base/prereq-0.9`.

> Where is $SAGE_BUILD_DIR defined?
> 
> Shouldn't it be $BUILD, as used in the rest of the bzip2-1.0.5-install script?


Sorry, I forgot to list #4949 as a dependency. That ticket changes `$BUILD` to `$SAGE_BUILD_DIR`.

> Aside: is it normal that neither bzip2 nor prereq prints "Successfully installed ..." when it succeeds, as do all other spkg?


I don't know about "normal". The issue is that most spkgs are installed by the script `sage-spkg`, but `prereq` and `bzip2` are not, because (for example) `sage-spkg` tries to bunzip spkgs, so we shouldn't use it on `bzip2`. The `sage-spkg` script is responsible for printing messages like this, as well as for deleting the temporary build directories, and the patch here is trying to make at least part of the installation of bzip2 and prereq act like other spkgs.



---

archive/issue_comments_181619.json:
```json
{
    "body": "<a id='comment:4'></a>I know how to apply a patch, and I tested it on a just-untarred sage -- the fact that you forgot the patch dependency is definitely the reason why it failed. I'm not sure I'll have the time to give it another go right now.\n\nNotice that I generally untar tar.* (and spkg) files with \"tar xaf <filename>\" -- the 'a' meaning 'automatic decompression method', so I don't have to tell it what to do (no xzf, no xjf).\n\nIf that 'a' switch is available in the tar implementation of all sage platforms :\n* sage-spkg could use that switch (instead of the complicated \"bunzip2 | tar\" it uses now;\n* bzip2 could be made an almost-normal spkg, just different in that it's the only one which isn't a .tar.bz2 but a .tar.gz\n\nWouldn't that fix that bug nicely too?",
    "created_at": "2012-03-02T06:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181619",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:4'></a>I know how to apply a patch, and I tested it on a just-untarred sage -- the fact that you forgot the patch dependency is definitely the reason why it failed. I'm not sure I'll have the time to give it another go right now.

Notice that I generally untar tar.* (and spkg) files with "tar xaf <filename>" -- the 'a' meaning 'automatic decompression method', so I don't have to tell it what to do (no xzf, no xjf).

If that 'a' switch is available in the tar implementation of all sage platforms :
* sage-spkg could use that switch (instead of the complicated "bunzip2 | tar" it uses now;
* bzip2 could be made an almost-normal spkg, just different in that it's the only one which isn't a .tar.bz2 but a .tar.gz

Wouldn't that fix that bug nicely too?



---

archive/issue_comments_181620.json:
```json
{
    "body": "<a id='comment:5'></a>I'm really not sure the 'a' option is standard ; and  the might not be either, so indeed one probably has to use the bunzip2 | tar trick :-/\n\nStill, the current sage-spkg does :\n\n```\nbunzip2 -c \"$PKG_SRC\" 2>/dev/null | tar fx${UNTAR_VERBOSE} -  2>/dev/null\nif [ ! -d \"$PKG_NAME\" ]; then\n    tar fx${UNTAR_VERBOSE} \"$PKG_SRC\"\nfi\n```\n\nbut perhaps it could do :\n\n```\ntar fx${UNTAR_VERBOSE} \"$PKG_SRC\"\nif [ ! -d \"$PKG_NAME\" ]; then\n  tar fxz${UNTAR_VERBOSE} \"$PKG_SRC\"\nfi\n\nif [ ! -d \"$PKG_NAME\" ]; then\n  bunzip2 -c \"$PKG_SRC\" 2>/dev/null | tar fx${UNTAR_VERBOSE} -  2>/dev/null\nfi\n```\n\nThat way it could handle three levels of compressions -- and if bzip2 is the first package it meets, then it could handle it, and then the rest of the packages would work with the last step.",
    "created_at": "2012-03-02T07:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181620",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:5'></a>I'm really not sure the 'a' option is standard ; and  the might not be either, so indeed one probably has to use the bunzip2 | tar trick :-/

Still, the current sage-spkg does :

```
bunzip2 -c "$PKG_SRC" 2>/dev/null | tar fx${UNTAR_VERBOSE} -  2>/dev/null
if [ ! -d "$PKG_NAME" ]; then
    tar fx${UNTAR_VERBOSE} "$PKG_SRC"
fi
```

but perhaps it could do :

```
tar fx${UNTAR_VERBOSE} "$PKG_SRC"
if [ ! -d "$PKG_NAME" ]; then
  tar fxz${UNTAR_VERBOSE} "$PKG_SRC"
fi

if [ ! -d "$PKG_NAME" ]; then
  bunzip2 -c "$PKG_SRC" 2>/dev/null | tar fx${UNTAR_VERBOSE} -  2>/dev/null
fi
```

That way it could handle three levels of compressions -- and if bzip2 is the first package it meets, then it could handle it, and then the rest of the packages would work with the last step.



---

archive/issue_comments_181621.json:
```json
{
    "body": "<a id='comment:6'></a>See #12102 for the bzip2 issue.",
    "created_at": "2012-03-05T20:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181621",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>See #12102 for the bzip2 issue.



---

archive/issue_comments_181622.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-The bzip2 and prereq \"spkgs\" should clean up their build directories, just like sage-spkg does for other spkgs. See the attached patch.\n+The prereq \"spkg\" should clean up its build directory, just like sage-spkg does for other spkgs. See the attached patch.\n \n-Apply [attachment:trac_12614-bzip2-prereq.patch] to the root repo.\n+Apply [attachment:trac_12614-prereq.patch] to the root repo.\n``````\n",
    "created_at": "2012-03-05T20:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181622",
    "user": "https://github.com/jhpalmieri"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-The bzip2 and prereq "spkgs" should clean up their build directories, just like sage-spkg does for other spkgs. See the attached patch.
+The prereq "spkg" should clean up its build directory, just like sage-spkg does for other spkgs. See the attached patch.
 
-Apply [attachment:trac_12614-bzip2-prereq.patch] to the root repo.
+Apply [attachment:trac_12614-prereq.patch] to the root repo.
``````




---

archive/issue_comments_181623.json:
```json
{
    "body": "Attachment [trac_12614-prereq.rebased.patch](tarball://root/attachments/some-uuid/ticket12614/trac_12614-prereq.rebased.patch) by @kini created at 2012-05-16 01:08:08\n\napply to $SAGE_ROOT",
    "created_at": "2012-05-16T01:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181623",
    "user": "https://github.com/kini"
}
```

Attachment [trac_12614-prereq.rebased.patch](tarball://root/attachments/some-uuid/ticket12614/trac_12614-prereq.rebased.patch) by @kini created at 2012-05-16 01:08:08

apply to $SAGE_ROOT



---

archive/issue_comments_181624.json:
```json
{
    "body": "<a id='comment:7'></a>Rebased to Sage 5.0. Now testing. (Thanks to Snark for mentioning this on IRC.)",
    "created_at": "2012-05-16T01:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181624",
    "user": "https://github.com/kini"
}
```

<a id='comment:7'></a>Rebased to Sage 5.0. Now testing. (Thanks to Snark for mentioning this on IRC.)



---

archive/issue_comments_181625.json:
```json
{
    "body": "<a id='comment:8'></a>Looks good to me. Positive review!",
    "created_at": "2012-05-16T01:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181625",
    "user": "https://github.com/kini"
}
```

<a id='comment:8'></a>Looks good to me. Positive review!



---

archive/issue_comments_181626.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-16T01:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181626",
    "user": "https://github.com/kini"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_181627.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Keshav Kini\"",
    "created_at": "2012-05-16T01:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181627",
    "user": "https://github.com/kini"
}
```

Changing reviewer from "" to "Keshav Kini"



---

archive/issue_events_034179.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-16T19:35:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12614#event-34179"
}
```



---

archive/issue_comments_181628.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-The prereq \"spkg\" should clean up its build directory, just like sage-spkg does for other spkgs. See the attached patch.\n+The prereq \"spkg\" should clean up its build directory, just like sage-spkg does for other spkgs.\n \n-Apply [attachment:trac_12614-prereq.patch] to the root repo.\n+Apply [attachment:trac_12614-prereq.rebased.patch] to the root repo.\n``````\n",
    "created_at": "2012-05-16T19:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181628",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-The prereq "spkg" should clean up its build directory, just like sage-spkg does for other spkgs. See the attached patch.
+The prereq "spkg" should clean up its build directory, just like sage-spkg does for other spkgs.
 
-Apply [attachment:trac_12614-prereq.patch] to the root repo.
+Apply [attachment:trac_12614-prereq.rebased.patch] to the root repo.
``````




---

archive/issue_comments_181629.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.1.beta1\"",
    "created_at": "2012-05-23T21:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181629",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.1.beta1"



---

archive/issue_comments_181630.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-23T21:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12614#issuecomment-181630",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_034180.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-23T21:32:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12614",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12614#event-34180"
}
```
