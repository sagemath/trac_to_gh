# Issue 12509: computation of height of point on elliptic curve over Q(sqrt(5)) is WRONG

archive/issues_012337.json:
```json
{
    "assignees": [
        "https://github.com/williamstein"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nThere are evidently many examples in which computing `P.height()`, for `P` a point on an elliptic curve over Q(sqrt(5)) yields a completely wrong answer.   This is very serious, since it is a blatantly wrong mathematical answer -- raising NotImplementedError would be much better!   Here's an example that Ashwath Rabindranath (Princeton) found, where Sage and Magma do not agree.  According to BSD, Sha has order 1 using the Magma answer, and a crazy order with the Sage answer. \n\n```\nsage: K.<a> = NumberField(x^2-x-1)\nsage: v = [0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688]\nsage: E = EllipticCurve(v)\nsage: E == E.global_minimal_model()\nTrue\nsage: F.a_invariants()\n(0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688)\nsage: P = E([72*a - 509/5,  -682/25*a - 434/25])\nsage: P.height()\n1.35648516097058\nsage: Q = magma(E)(magma([P[0], P[1]]))\nsage: Q\n(1/5*(360*a - 509) : 1/25*(-682*a - 434) : 1)\nsage: Q.Height()\n1.38877711688727252538242306\n```\n\nApply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz), [attachment: trac12509-heights3.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)\n\nComponent: **elliptic curves**\n\nKeywords: **heights**\n\nStopgaps: **#12692**\n\nAuthor: **John Cremona**\n\nReviewer: **Peter Bruin, Chris Wuthrich**\n\nMerged: **sage-5.10.beta3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12509_\n\n",
    "closed_at": "2013-05-13T13:25:55Z",
    "created_at": "2012-02-15T06:22:52Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.10",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "computation of height of point on elliptic curve over Q(sqrt(5)) is WRONG",
    "type": "issue",
    "updated_at": "2013-05-13T13:25:55Z",
    "url": "https://github.com/sagemath/sage/issues/12509",
    "user": "https://github.com/williamstein"
}
```
<div id="comment:0"></div>

There are evidently many examples in which computing `P.height()`, for `P` a point on an elliptic curve over Q(sqrt(5)) yields a completely wrong answer.   This is very serious, since it is a blatantly wrong mathematical answer -- raising NotImplementedError would be much better!   Here's an example that Ashwath Rabindranath (Princeton) found, where Sage and Magma do not agree.  According to BSD, Sha has order 1 using the Magma answer, and a crazy order with the Sage answer. 

```
sage: K.<a> = NumberField(x^2-x-1)
sage: v = [0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688]
sage: E = EllipticCurve(v)
sage: E == E.global_minimal_model()
True
sage: F.a_invariants()
(0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688)
sage: P = E([72*a - 509/5,  -682/25*a - 434/25])
sage: P.height()
1.35648516097058
sage: Q = magma(E)(magma([P[0], P[1]]))
sage: Q
(1/5*(360*a - 509) : 1/25*(-682*a - 434) : 1)
sage: Q.Height()
1.38877711688727252538242306
```

Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz), [attachment: trac12509-heights3.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)

Component: **elliptic curves**

Keywords: **heights**

Stopgaps: **#12692**

Author: **John Cremona**

Reviewer: **Peter Bruin, Chris Wuthrich**

Merged: **sage-5.10.beta3**

_Issue created by migration from https://trac.sagemath.org/ticket/12509_





---

archive/issue_events_169567.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-02-15T06:22:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "milestone_number": null,
    "milestone_title": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169567"
}
```



---

archive/issue_events_169568.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-02-15T06:22:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "c: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169568"
}
```



---

archive/issue_events_169569.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-02-15T06:22:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169569"
}
```



---

archive/issue_events_169570.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-02-15T06:22:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169570"
}
```



---

archive/issue_events_169571.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-02-15T06:22:52Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "subject": "https://github.com/williamstein",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169571"
}
```



---

archive/issue_comments_138279.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI cannot remember who implemented this, but have looked at the code recently and it is using the standard Silverman algorithm.\n\nI think it is likely that there is already a ticket for this.",
    "created_at": "2012-02-15T09:24:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138279",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:1" align="right">comment:1</div>

I cannot remember who implemented this, but have looked at the code recently and it is using the standard Silverman algorithm.

I think it is likely that there is already a ticket for this.



---

archive/issue_comments_138280.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nA little `hg blame sage/schemes/elliptic_curves/ell_point.py` and `hg history sage/schemes/elliptic_curves/ell_point.py` shows that this code comes from #8496 , merged in sage-4.4.alpha1. The next change to this file happened with #8827 in a later release. I have verified that the example in the ticket gives the same result on sage-4.4, so the error has been there all along.\nNote that:\n\n```\nsage: [P.height(precision=p) for p in [53..70]]\n[1.35648516097058, 1.37988660372465, 1.392904136135677,\n 1.388358180620918, 1.390651822960756, 1.3901262440498197,\n 1.3886249896939375, 1.3887137996432686, 1.38889123047486600,\n 1.38868605331097548, 1.38879145662338488, 1.38876788728230994,\n 1.388772046900726933, 1.388778979290526601, 1.388773433409450769,\n 1.3887772462291215145, 1.3887758164353761832, 1.3887774411997285045]\n```\nso the computation is probably not really wrong. It's probably just a matter of precision estimates being off.",
    "created_at": "2012-02-16T06:52:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138280",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

A little `hg blame sage/schemes/elliptic_curves/ell_point.py` and `hg history sage/schemes/elliptic_curves/ell_point.py` shows that this code comes from #8496 , merged in sage-4.4.alpha1. The next change to this file happened with #8827 in a later release. I have verified that the example in the ticket gives the same result on sage-4.4, so the error has been there all along.
Note that:

```
sage: [P.height(precision=p) for p in [53..70]]
[1.35648516097058, 1.37988660372465, 1.392904136135677,
 1.388358180620918, 1.390651822960756, 1.3901262440498197,
 1.3886249896939375, 1.3887137996432686, 1.38889123047486600,
 1.38868605331097548, 1.38879145662338488, 1.38876788728230994,
 1.388772046900726933, 1.388778979290526601, 1.388773433409450769,
 1.3887772462291215145, 1.3887758164353761832, 1.3887774411997285045]
```
so the computation is probably not really wrong. It's probably just a matter of precision estimates being off.



---

archive/issue_comments_138281.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis is also pretty damning:\n\n```\nsage: (3*P).height()/P.height()\n9.19316602595430\nsage: (2*P).height()/P.height()\n4.09522243754782\n```\n\nMy guess is that the local contributions from the finite primes are fine (each is rational times log(p)), it's just the (two) real places.  One could compare with the real local heights as computed by Magma to verify this.",
    "created_at": "2012-02-16T12:02:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138281",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:3" align="right">comment:3</div>

This is also pretty damning:

```
sage: (3*P).height()/P.height()
9.19316602595430
sage: (2*P).height()/P.height()
4.09522243754782
```

My guess is that the local contributions from the finite primes are fine (each is rational times log(p)), it's just the (two) real places.  One could compare with the real local heights as computed by Magma to verify this.



---

archive/issue_comments_138282.json:
```json
{
    "body": "Stopgaps: **#12692**",
    "created_at": "2012-03-19T00:48:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138282",
    "user": "https://github.com/jbalakrishnan"
}
```

Stopgaps: **#12692**



---

archive/issue_comments_138283.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThis is a completely TRIVIAL thing, and I cannot understand why I did not spot this earlier.  In the example, the height is computed as the sum of archimedean and non-arch components.  The latter is log(25)/2 and is returned as such *using the python builtin log function*!  This is where the precision is lost,  Compare\n\n```\nsage: P.height()\n1.35648516097058\nsage: P.archimedian_local_height() + P.nonarchimedian_local_height()    \n1/2*log(25) - 0.2206607955468278522013468194382\nsage: RR(P.archimedian_local_height() + P.nonarchimedian_local_height())          \n1.38877711688727\n```\nand you wonder how it is possible to get this wrong:\n\n```\nsage: P.archimedian_local_height(prec=53) + P.nonarchimedian_local_height(prec=53)\n1.35648516097\n```\n\nI will make a patch now.",
    "created_at": "2013-01-08T10:23:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138283",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:5" align="right">comment:5</div>

This is a completely TRIVIAL thing, and I cannot understand why I did not spot this earlier.  In the example, the height is computed as the sum of archimedean and non-arch components.  The latter is log(25)/2 and is returned as such *using the python builtin log function*!  This is where the precision is lost,  Compare

```
sage: P.height()
1.35648516097058
sage: P.archimedian_local_height() + P.nonarchimedian_local_height()    
1/2*log(25) - 0.2206607955468278522013468194382
sage: RR(P.archimedian_local_height() + P.nonarchimedian_local_height())          
1.38877711688727
```
and you wonder how it is possible to get this wrong:

```
sage: P.archimedian_local_height(prec=53) + P.nonarchimedian_local_height(prec=53)
1.35648516097
```

I will make a patch now.



---

archive/issue_comments_138284.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI was a little hasty.  There's no problem in the non-arch local height being an exact log:\n\n```\nsage: P.nonarchimedian_local_height()\n1/2*log(25)\nsage: P.nonarchimedian_local_height(prec=53)\n1.60943791243410\nsage: RR(P.nonarchimedian_local_height())   \n1.60943791243410\n```\nis all correct.  The problem is with this:\n\n```\nsage: P.archimedian_local_height()          \n-0.2206607955468278522013468194382\nsage: P.archimedian_local_height(prec=53)\n-0.252952751464\n```\nwhere the first is correct as this shows:\n\n```\nsage: P.archimedian_local_height()+ P.nonarchimedian_local_height(prec=53)\n1.38877711688727\n```\nbut the second is not.",
    "created_at": "2013-01-08T10:30:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138284",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:6" align="right">comment:6</div>

I was a little hasty.  There's no problem in the non-arch local height being an exact log:

```
sage: P.nonarchimedian_local_height()
1/2*log(25)
sage: P.nonarchimedian_local_height(prec=53)
1.60943791243410
sage: RR(P.nonarchimedian_local_height())   
1.60943791243410
```
is all correct.  The problem is with this:

```
sage: P.archimedian_local_height()          
-0.2206607955468278522013468194382
sage: P.archimedian_local_height(prec=53)
-0.252952751464
```
where the first is correct as this shows:

```
sage: P.archimedian_local_height()+ P.nonarchimedian_local_height(prec=53)
1.38877711688727
```
but the second is not.



---

archive/issue_comments_138285.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIt seems to be a numerical stability problem.  With the same example, and using the first embedding of K, we have, first to default 53-bit precision:\n\n```\nsage: b2,b4,b6,b8\n(1.527864045, -128195.888575, -25017379.5417, -4118102250.56)\nsage: x\n-146.29844719\nsage: t\n-0.00683534254264\nsage: 1 - (b4 * t**2) - (2*b6 * t**3) - (b8 * t**4)        \n3.5527136788e-15\n```\nwhile at 100-bit precision:\n\n```\nsage: bb2,bb4,bb6,bb8                              \n(1.5278640450004206071816526625, -128195.88857503147164756896321, -2.5017379541668653550777130780e7, -4.1181022505609323099570853156e9)\nsage: xx\n-146.29844718999242907073025207\nsage: tt\n-0.0068353425426405016233236537484\nsage: 1 - (bb4 * tt**2) - (2*bb6 * tt**3) - (bb8 * tt**4)\n3.5142315895588997690642550530e-15\n```\nThis means that whenever we evaluate one of the four polynomials (which coefficients are essentially the b-invariants) at some point we may lose precision badly.\n\nOne way out would be to use a \"working precision\" higher than the requested precision.  Another would be to use algebraic values instead of approximate ones for t,z,w in the algorithm, which is likely to be slow, but I will try it.\n\nA better solution for the longer term would be to implement Mestre's AGM algorithm instead BUT this only exists at present  for real embeddings (I have worked on extending to the complex case, but that is still in progress).",
    "created_at": "2013-01-08T12:46:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138285",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:7" align="right">comment:7</div>

It seems to be a numerical stability problem.  With the same example, and using the first embedding of K, we have, first to default 53-bit precision:

```
sage: b2,b4,b6,b8
(1.527864045, -128195.888575, -25017379.5417, -4118102250.56)
sage: x
-146.29844719
sage: t
-0.00683534254264
sage: 1 - (b4 * t**2) - (2*b6 * t**3) - (b8 * t**4)        
3.5527136788e-15
```
while at 100-bit precision:

```
sage: bb2,bb4,bb6,bb8                              
(1.5278640450004206071816526625, -128195.88857503147164756896321, -2.5017379541668653550777130780e7, -4.1181022505609323099570853156e9)
sage: xx
-146.29844718999242907073025207
sage: tt
-0.0068353425426405016233236537484
sage: 1 - (bb4 * tt**2) - (2*bb6 * tt**3) - (bb8 * tt**4)
3.5142315895588997690642550530e-15
```
This means that whenever we evaluate one of the four polynomials (which coefficients are essentially the b-invariants) at some point we may lose precision badly.

One way out would be to use a "working precision" higher than the requested precision.  Another would be to use algebraic values instead of approximate ones for t,z,w in the algorithm, which is likely to be slow, but I will try it.

A better solution for the longer term would be to implement Mestre's AGM algorithm instead BUT this only exists at present  for real embeddings (I have worked on extending to the complex case, but that is still in progress).



---

archive/issue_comments_138286.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nPatch ready for review.  Basically we double the working precision while computing each archidean component of the height, and this suffices.  I had to add prec as an alias for precision for CDF (as it already was for RDF), and a couple of doctest outputs had the last digit changed by 1.  There are doctests to show that the problem is fixed.",
    "created_at": "2013-01-09T10:56:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138286",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:8" align="right">comment:8</div>

Patch ready for review.  Basically we double the working precision while computing each archidean component of the height, and this suffices.  I had to add prec as an alias for precision for CDF (as it already was for RDF), and a couple of doctest outputs had the last digit changed by 1.  There are doctests to show that the problem is fixed.



---

archive/issue_events_169572.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2013-01-09T10:58:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169572"
}
```



---

archive/issue_comments_138287.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,3 +17,5 @@\n sage: Q.Height()\n 1.38877711688727252538242306\n ```\n+\n+Apply: trac12509-heights.patch\n``````\n",
    "created_at": "2013-01-09T10:58:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138287",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,3 +17,5 @@
 sage: Q.Height()
 1.38877711688727252538242306
 ```
+
+Apply: trac12509-heights.patch
``````




---

archive/issue_comments_138288.json:
```json
{
    "body": "Changed keywords from none to **heights**",
    "created_at": "2013-01-09T10:58:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138288",
    "user": "https://github.com/JohnCremona"
}
```

Changed keywords from none to **heights**



---

archive/issue_events_169573.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2013-01-09T10:58:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "c: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169573"
}
```



---

archive/issue_events_169574.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2013-01-09T10:58:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "c: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169574"
}
```



---

archive/issue_comments_138289.json:
```json
{
    "body": "Author: **John Cremona**",
    "created_at": "2013-01-09T10:58:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138289",
    "user": "https://github.com/JohnCremona"
}
```

Author: **John Cremona**



---

archive/issue_comments_138290.json:
```json
{
    "body": "Reviewer: **Peter Bruin**",
    "created_at": "2013-01-10T15:20:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138290",
    "user": "https://github.com/pjbruin"
}
```

Reviewer: **Peter Bruin**



---

archive/issue_comments_138291.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe original precision problem seems to be solved by the patch, but there is a remaining problem if the given place `v` has lower precision than `prec` (the answer ends with a string of zeroes):\n\n```\nsage: K.<a> = NumberField(x^2-x-1)\nsage: v = [0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688]\nsage: E = EllipticCurve(v)\nsage: P = E([72*a - 509/5, -682/25*a - 434/25])\nsage: P.archimedian_local_height(v=K.places()[1],prec=1000)\n2.81105581458853745263599796447519791747641640992814370122945754557165333149900887291328934930695388487942633879651281942220091469088330120430293759305481969374444866348067978423230783846520353108644485473632812500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n```\nThe precision of `v` shouldn't influence the result, of course.\n\nAlso, the default value of `prec` used when applying Silverman's Theorem 4.2 is currently the precision of the refined place `vv`, but it suffices to take the same default precision to which the result is returned, namely the precision of `v`.\n\nI wrote a patch that fixes both issues; I am now going to test it.",
    "created_at": "2013-01-11T12:54:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138291",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:11" align="right">comment:11</div>

The original precision problem seems to be solved by the patch, but there is a remaining problem if the given place `v` has lower precision than `prec` (the answer ends with a string of zeroes):

```
sage: K.<a> = NumberField(x^2-x-1)
sage: v = [0, a + 1, 1, 28665*a - 46382, 2797026*a - 4525688]
sage: E = EllipticCurve(v)
sage: P = E([72*a - 509/5, -682/25*a - 434/25])
sage: P.archimedian_local_height(v=K.places()[1],prec=1000)
2.81105581458853745263599796447519791747641640992814370122945754557165333149900887291328934930695388487942633879651281942220091469088330120430293759305481969374444866348067978423230783846520353108644485473632812500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
```
The precision of `v` shouldn't influence the result, of course.

Also, the default value of `prec` used when applying Silverman's Theorem 4.2 is currently the precision of the refined place `vv`, but it suffices to take the same default precision to which the result is returned, namely the precision of `v`.

I wrote a patch that fixes both issues; I am now going to test it.



---

archive/issue_comments_138292.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThanks: your second point is that while we still work in double the precision, the number of terms needed can be computed from the original precision?  That makes sense.\n\nOn the second point, it is certainly possible that the user asks for two different things by using a low-precision embedding but then asking for a higher precision without refining the embedding.  I would fix this by first replacing v (if necessary) by a refinement to precision \"prec\".  Which may be what you patch does, so I should look at it.... and indeed that is what you do.\n\nThe second patch looks good to me, hope the tests pass!",
    "created_at": "2013-01-11T13:28:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138292",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:12" align="right">comment:12</div>

Thanks: your second point is that while we still work in double the precision, the number of terms needed can be computed from the original precision?  That makes sense.

On the second point, it is certainly possible that the user asks for two different things by using a low-precision embedding but then asking for a higher precision without refining the embedding.  I would fix this by first replacing v (if necessary) by a refinement to precision "prec".  Which may be what you patch does, so I should look at it.... and indeed that is what you do.

The second patch looks good to me, hope the tests pass!



---

archive/issue_comments_138293.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe tests in sage/schemes/elliptic_curves/ all pass for me, now testing the whole Sage library.\n\nIf this also succeeds, do my additional changes still allow me to give a positive review, or do we need a new reviewer?",
    "created_at": "2013-01-11T13:39:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138293",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:13" align="right">comment:13</div>

The tests in sage/schemes/elliptic_curves/ all pass for me, now testing the whole Sage library.

If this also succeeds, do my additional changes still allow me to give a positive review, or do we need a new reviewer?



---

archive/issue_comments_138294.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@pjbruin](#comment%3A13):\n> The tests in sage/schemes/elliptic_curves/ all pass for me, now testing the whole Sage library.\n> \n> If this also succeeds, do my additional changes still allow me to give a positive review, or do we need a new reviewer?\n\nMaybe, maybe not.  William?",
    "created_at": "2013-01-11T14:10:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138294",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@pjbruin](#comment%3A13):
> The tests in sage/schemes/elliptic_curves/ all pass for me, now testing the whole Sage library.
> 
> If this also succeeds, do my additional changes still allow me to give a positive review, or do we need a new reviewer?

Maybe, maybe not.  William?



---

archive/issue_comments_138295.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nOK, all tests passed.",
    "created_at": "2013-01-11T19:22:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138295",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:15" align="right">comment:15</div>

OK, all tests passed.



---

archive/issue_comments_138296.json:
```json
{
    "body": "Attachment: **[trac12509-heights2.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)**",
    "created_at": "2013-01-15T00:10:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138296",
    "user": "https://github.com/pjbruin"
}
```

Attachment: **[trac12509-heights2.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)**



---

archive/issue_comments_138297.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\ntrac12509-heights2.patch now also makes the documentation slightly more accurate",
    "created_at": "2013-01-15T00:13:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138297",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:16" align="right">comment:16</div>

trac12509-heights2.patch now also makes the documentation slightly more accurate



---

archive/issue_comments_138298.json:
```json
{
    "body": "Attachment: **[trac12509-heights.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz)**\n\nrebased to 5.9beta5",
    "created_at": "2013-04-22T13:42:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138298",
    "user": "https://github.com/JohnCremona"
}
```

Attachment: **[trac12509-heights.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz)**

rebased to 5.9beta5



---

archive/issue_comments_138299.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,4 +18,4 @@\n 1.38877711688727252538242306\n ```\n \n-Apply: trac12509-heights.patch\n+Apply: trac12509-heights.patch, trac12509-heights2.patch\n``````\n",
    "created_at": "2013-04-22T13:43:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138299",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,4 +18,4 @@
 1.38877711688727252538242306
 ```
 
-Apply: trac12509-heights.patch
+Apply: trac12509-heights.patch, trac12509-heights2.patch
``````




---

archive/issue_comments_138300.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI did a small rebase of the first patch for 5.9.beta5;  both patches still need to be applied.  We need a reviewer.",
    "created_at": "2013-04-22T13:47:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138300",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:18" align="right">comment:18</div>

I did a small rebase of the first patch for 5.9.beta5;  both patches still need to be applied.  We need a reviewer.



---

archive/issue_comments_138301.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI'm keeping myself on the reviewers list for the moment, but only for John's patch.  For the additional changes I made, someone else should probably review the whole ticket.\n\nShould I rebase my patch too?",
    "created_at": "2013-04-22T14:05:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138301",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

I'm keeping myself on the reviewers list for the moment, but only for John's patch.  For the additional changes I made, someone else should probably review the whole ticket.

Should I rebase my patch too?



---

archive/issue_comments_138302.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@pjbruin](#comment%3A19):\n> I'm keeping myself on the reviewers list for the moment, but only for John's patch.  For the additional changes I made, someone else should probably review the whole ticket.\n> \n> Should I rebase my patch too?\n\nIt's not necessary, your patch still applies OK.  (The only bit of mine which did not apply was the alias of prec=precision in sage.rings.complex_double.pyx)",
    "created_at": "2013-04-22T15:39:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138302",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@pjbruin](#comment%3A19):
> I'm keeping myself on the reviewers list for the moment, but only for John's patch.  For the additional changes I made, someone else should probably review the whole ticket.
> 
> Should I rebase my patch too?

It's not necessary, your patch still applies OK.  (The only bit of mine which did not apply was the alias of prec=precision in sage.rings.complex_double.pyx)



---

archive/issue_events_169575.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2013-05-04T19:22:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169575"
}
```



---

archive/issue_events_169576.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2013-05-04T19:22:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169576"
}
```



---

archive/issue_comments_138303.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI checked the two patches. They apply cleanly to 5.9 and the tests pass.\nAs far as I understand they do the right thing.",
    "created_at": "2013-05-04T19:22:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138303",
    "user": "https://github.com/categorie"
}
```

<div id="comment:21" align="right">comment:21</div>

I checked the two patches. They apply cleanly to 5.9 and the tests pass.
As far as I understand they do the right thing.



---

archive/issue_comments_138304.json:
```json
{
    "body": "Changed reviewer from **Peter Bruin** to **Peter Bruin, Chris Wuthrich**",
    "created_at": "2013-05-04T21:03:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138304",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Peter Bruin** to **Peter Bruin, Chris Wuthrich**



---

archive/issue_comments_138305.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,4 +18,4 @@\n 1.38877711688727252538242306\n ```\n \n-Apply: trac12509-heights.patch, trac12509-heights2.patch\n+Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)\n``````\n",
    "created_at": "2013-05-07T09:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138305",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,4 +18,4 @@
 1.38877711688727252538242306
 ```
 
-Apply: trac12509-heights.patch, trac12509-heights2.patch
+Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)
``````




---

archive/issue_comments_138306.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThere is a documentation problem:\n\n```\ndochtml.log:[plane_cur] /mazur/release/merger/sage-5.10.beta2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_point.py:docstring of sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint_number_field.archimedian_local_height:49: WARNING: Literal block expected; none found.\n```",
    "created_at": "2013-05-07T12:27:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138306",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

There is a documentation problem:

```
dochtml.log:[plane_cur] /mazur/release/merger/sage-5.10.beta2/local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/ell_point.py:docstring of sage.schemes.elliptic_curves.ell_point.EllipticCurvePoint_number_field.archimedian_local_height:49: WARNING: Literal block expected; none found.
```



---

archive/issue_events_169577.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-07T12:27:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169577"
}
```



---

archive/issue_events_169578.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-07T12:27:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169578"
}
```



---

archive/issue_comments_138307.json:
```json
{
    "body": "fix documentation syntax",
    "created_at": "2013-05-10T07:17:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138307",
    "user": "https://github.com/pjbruin"
}
```

fix documentation syntax



---

archive/issue_events_169579.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-05-10T07:17:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169579"
}
```



---

archive/issue_events_169580.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-05-10T07:17:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169580"
}
```



---

archive/issue_comments_138308.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nAttachment: **[trac12509-heights3.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)**",
    "created_at": "2013-05-10T07:17:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138308",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:25" align="right">comment:25</div>

Attachment: **[trac12509-heights3.patch.gz](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)**



---

archive/issue_comments_138309.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,4 +18,4 @@\n 1.38877711688727252538242306\n ```\n \n-Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)\n+Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz), [attachment: trac12509-heights3.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)\n``````\n",
    "created_at": "2013-05-10T07:17:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138309",
    "user": "https://github.com/pjbruin"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,4 +18,4 @@
 1.38877711688727252538242306
 ```
 
-Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz)
+Apply: [attachment: trac12509-heights.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights.patch.gz), [attachment: trac12509-heights2.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights2.patch.gz), [attachment: trac12509-heights3.patch](https://github.com/sagemath/sage/files/ticket12509/trac12509-heights3.patch.gz)
``````




---

archive/issue_events_169581.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-10T08:28:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169581"
}
```



---

archive/issue_events_169582.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-10T08:28:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169582"
}
```



---

archive/issue_events_169583.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-13T13:25:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169583"
}
```



---

archive/issue_events_169584.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-13T13:25:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12509#event-169584"
}
```



---

archive/issue_comments_138310.json:
```json
{
    "body": "Merged: **sage-5.10.beta3**",
    "created_at": "2013-05-13T13:25:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12509#issuecomment-138310",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.10.beta3**
