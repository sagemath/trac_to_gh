# Issue 12016: parallelism in Sage: just use value of 'MAKE'

archive/issues_011844.json:
```json
{
    "assignees": [],
    "body": "The various parallel aspects of Sage should be controlled by setting the `-j` (possible also `-l`) flags in `MAKE` or `MAKEFLAGS`.  That is, if `MAKE='make -j16'`, then\n\n- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.\n\n- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.\n\n- running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n\n**Testing this ticket**: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running\n\n```\nSAGE_NUM_CORES=24 make ptestlong\n```\nshould run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).\n\n**Notes**:\nWith the patches applied, building spkgs in parallel works well, except for race conditions in:\n* python (#12096)\n* singular (#12137)\n* zlib (#12138)\n* mpir (#12139)\n* atlas on Solaris (#12312)\nand a \"jobserver unavailable\" warning in:\n* ntl\n* singular (#12137)\n* rubiks\n\n**Apply**:\n1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.\n3. [and [attachment:trac_12016-scripts-ref.patch](https://github.com/sagemath/sage/files/ticket12016/a82a12f14695e0da5cbdb45c7ee3f287.patch](https://github.com/sagemath/sage/files/ticket12016/a110b2103c2a98fc81f4ba5d97144c15.patch)) to the `SCRIPTS` repository.\n4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n\nSee also: #6495 to implement the same behavior for doc building.\n\n**Assignee:** GeorgSWeber\n\n**CC:**  @jdemeyer @nexttime\n\n**Author:** John Palmieri, Jeroen Demeyer\n\n**Reviewer:** John Palmieri, Jeroen Demeyer\n\n**Merged:** sage-4.8.alpha5\n\n**Dependencies:** sage-4.8.alpha4\n\nIssue created by migration from https://trac.sagemath.org/ticket/12016\n\n",
    "closed_at": "2011-12-14T22:28:24Z",
    "created_at": "2011-11-12T20:31:32Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/critical",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "parallelism in Sage: just use value of 'MAKE'",
    "type": "issue",
    "updated_at": "2012-01-15T15:36:06Z",
    "url": "https://github.com/sagemath/sage/issues/12016",
    "user": "https://github.com/jhpalmieri"
}
```
The various parallel aspects of Sage should be controlled by setting the `-j` (possible also `-l`) flags in `MAKE` or `MAKEFLAGS`.  That is, if `MAKE='make -j16'`, then

- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.

- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.

- running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.

**Testing this ticket**: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running

```
SAGE_NUM_CORES=24 make ptestlong
```
should run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).

**Notes**:
With the patches applied, building spkgs in parallel works well, except for race conditions in:
* python (#12096)
* singular (#12137)
* zlib (#12138)
* mpir (#12139)
* atlas on Solaris (#12312)
and a "jobserver unavailable" warning in:
* ntl
* singular (#12137)
* rubiks

**Apply**:
1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.
3. [and [attachment:trac_12016-scripts-ref.patch](https://github.com/sagemath/sage/files/ticket12016/a82a12f14695e0da5cbdb45c7ee3f287.patch](https://github.com/sagemath/sage/files/ticket12016/a110b2103c2a98fc81f4ba5d97144c15.patch)) to the `SCRIPTS` repository.
4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.

See also: #6495 to implement the same behavior for doc building.

**Assignee:** GeorgSWeber

**CC:**  @jdemeyer @nexttime

**Author:** John Palmieri, Jeroen Demeyer

**Reviewer:** John Palmieri, Jeroen Demeyer

**Merged:** sage-4.8.alpha5

**Dependencies:** sage-4.8.alpha4

Issue created by migration from https://trac.sagemath.org/ticket/12016





---

archive/issue_events_137262.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-12T20:31:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137262"
}
```



---

archive/issue_events_137263.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-12T20:31:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "08517b",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137263"
}
```



---

archive/issue_events_137264.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-12T20:31:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137264"
}
```



---

archive/issue_comments_129899.json:
```json
{
    "body": "<a id='comment:1'></a>\nWe should remove `NUM_THREADS` from the top-level `Makefile`.",
    "created_at": "2011-11-14T11:50:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129899",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>
We should remove `NUM_THREADS` from the top-level `Makefile`.



---

archive/issue_comments_129900.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,3 +6,7 @@\n \n In #6495, we should implement the same behavior for doc building.\n \n+**Apply**:\n+1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.\n+2. [attachment:trac_12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.patch) to the `SCRIPTS` repository.\n+3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.\n``````\n",
    "created_at": "2011-11-14T12:37:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129900",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,3 +6,7 @@
 
 In #6495, we should implement the same behavior for doc building.
 
+**Apply**:
+1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.
+2. [attachment:trac_12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.patch) to the `SCRIPTS` repository.
+3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.
``````




---

archive/issue_comments_129901.json:
```json
{
    "body": "**Changing author** from \"John Palmieri\" to \"John Palmieri, Jeroen Demeyer\".",
    "created_at": "2011-11-14T12:37:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129901",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "John Palmieri" to "John Palmieri, Jeroen Demeyer".



---

archive/issue_comments_129902.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,9 @@\n \n - running `make` will build spkg's in parallel, using 16 processes (this was done in #11959)\n \n-- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is empty or not set, then determine the number of threads as before: `min(8, cpu_count())`.\n+- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.\n+\n+- TODO: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n \n In #6495, we should implement the same behavior for doc building.\n \n``````\n",
    "created_at": "2011-11-14T13:34:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129902",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,9 @@
 
 - running `make` will build spkg's in parallel, using 16 processes (this was done in #11959)
 
-- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is empty or not set, then determine the number of threads as before: `min(8, cpu_count())`.
+- running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.
+
+- TODO: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
 
 In #6495, we should implement the same behavior for doc building.
 
``````




---

archive/issue_comments_129903.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,5 +10,5 @@\n \n **Apply**:\n 1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.\n-2. [attachment:trac_12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.patch) to the `SCRIPTS` repository.\n+2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.\n 3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.\n``````\n",
    "created_at": "2011-11-14T13:35:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129903",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,5 +10,5 @@
 
 **Apply**:
 1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.
-2. [attachment:trac_12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.patch) to the `SCRIPTS` repository.
+2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.
 3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.
``````




---

archive/issue_comments_129904.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,10 +1,10 @@\n With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then\n \n-- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959)\n+- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  *This is standard `make` behaviour, no patches are needed.*\n \n - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.\n \n-- TODO: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n+- **TODO**: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n \n In #6495, we should implement the same behavior for doc building.\n \n``````\n",
    "created_at": "2011-11-14T13:40:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129904",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,10 +1,10 @@
 With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then
 
-- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959)
+- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  *This is standard `make` behaviour, no patches are needed.*
 
 - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.
 
-- TODO: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
+- **TODO**: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
 
 In #6495, we should implement the same behavior for doc building.
 
``````




---

archive/issue_comments_129905.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -8,6 +8,11 @@\n \n In #6495, we should implement the same behavior for doc building.\n \n+**TODO:** We should also support:\n+- `make -j16 ptestlong` (as opposed to `MAKE=\"make -j16\" make ptestlong`).  Use `MAKEFLAGS`.\n+- `make -j` (unlimited number of jobs, say set to 9999 if we really need a number).\n+- `make -j37 -j1` (last option takes precedence).\n+\n **Apply**:\n 1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.\n 2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.\n``````\n",
    "created_at": "2011-11-14T13:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129905",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -8,6 +8,11 @@
 
 In #6495, we should implement the same behavior for doc building.
 
+**TODO:** We should also support:
+- `make -j16 ptestlong` (as opposed to `MAKE="make -j16" make ptestlong`).  Use `MAKEFLAGS`.
+- `make -j` (unlimited number of jobs, say set to 9999 if we really need a number).
+- `make -j37 -j1` (last option takes precedence).
+
 **Apply**:
 1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.
 2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.
``````




---

archive/issue_comments_129906.json:
```json
{
    "body": "<a id='comment:6'></a>\nJohn, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).",
    "created_at": "2011-11-14T13:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129906",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
John, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).



---

archive/issue_comments_129907.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@jdemeyer](#comment%3A6):\n> John, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` \n\nSounds okay.\n\n> (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).\n\nIf you run \"sage -tp <files>\", should you use 1 process or more than 1?  The \"-tp\" option means \"parallel\", so perhaps the default should be more than 1 in this case.  In other cases (like docbuilding, for example), the default should be 1.",
    "created_at": "2011-11-14T21:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129907",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
Replying to [@jdemeyer](#comment%3A6):
> John, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` 

Sounds okay.

> (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).

If you run "sage -tp <files>", should you use 1 process or more than 1?  The "-tp" option means "parallel", so perhaps the default should be more than 1 in this case.  In other cases (like docbuilding, for example), the default should be 1.



---

archive/issue_comments_129908.json:
```json
{
    "body": "<a id='comment:8'></a>\nFor something like `make -j16 ptestlong`, how do we recover the number 16?  If I execute this command (with `MAKE` unset), I see\n\n```\nMAKEFLAGS= --jobserver-fds=3,4 -j\nMFLAGS=- --jobserver-fds=3,4 -j\n```\nbut I don't see \"16\" anywhere in the listing of the environment variables.",
    "created_at": "2011-11-14T21:17:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129908",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>
For something like `make -j16 ptestlong`, how do we recover the number 16?  If I execute this command (with `MAKE` unset), I see

```
MAKEFLAGS= --jobserver-fds=3,4 -j
MFLAGS=- --jobserver-fds=3,4 -j
```
but I don't see "16" anywhere in the listing of the environment variables.



---

archive/issue_comments_129909.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@jhpalmieri](#comment%3A7):\n> Replying to [@jdemeyer](#comment%3A6):\n> > John, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` \n\n> \n> Sounds okay.\n> \n> > (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).\n\n> \n> If you run \"sage -tp <files>\", should you use 1 process or more than 1?  The \"-tp\" option means \"parallel\", so perhaps the default should be more than 1 in this case.  In other cases (like docbuilding, for example), the default should be 1.\n\nSure, that is what I meant.  We should compute the value once, but in `sage -tp` we can still decide to use the number of processes.",
    "created_at": "2011-11-14T21:23:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129909",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [@jhpalmieri](#comment%3A7):
> Replying to [@jdemeyer](#comment%3A6):
> > John, with your solution there is a lot of code duplication (determining the number of threads is done in 3 places, potentially in 3 different ways).  How about having code in `sage-sage` or `sage-env` to determine the number of threads and saving it in an environment variable `SAGE_NUM_PROCESSES` 

> 
> Sounds okay.
> 
> > (which the user could set by hand; if not set, the value comes from `MAKE` or `MAKEFLAGS`; if no `-j` option is given, set to 1).

> 
> If you run "sage -tp <files>", should you use 1 process or more than 1?  The "-tp" option means "parallel", so perhaps the default should be more than 1 in this case.  In other cases (like docbuilding, for example), the default should be 1.

Sure, that is what I meant.  We should compute the value once, but in `sage -tp` we can still decide to use the number of processes.



---

archive/issue_comments_129910.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [@jhpalmieri](#comment%3A8):\n> For something like `make -j16 ptestlong`, how do we recover the number 16?  If I execute this command (with `MAKE` unset), I see\n> \n> ```\n> MAKEFLAGS= --jobserver-fds=3,4 -j\n> MFLAGS=- --jobserver-fds=3,4 -j\n> ```\n> but I don't see \"16\" anywhere in the listing of the environment variables.\n\nYou are right.  I had not tried this before.  So let's scrap that idea.",
    "created_at": "2011-11-14T21:26:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129910",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [@jhpalmieri](#comment%3A8):
> For something like `make -j16 ptestlong`, how do we recover the number 16?  If I execute this command (with `MAKE` unset), I see
> 
> ```
> MAKEFLAGS= --jobserver-fds=3,4 -j
> MFLAGS=- --jobserver-fds=3,4 -j
> ```
> but I don't see "16" anywhere in the listing of the environment variables.

You are right.  I had not tried this before.  So let's scrap that idea.



---

archive/issue_comments_129911.json:
```json
{
    "body": "**Attachment:** [trac_12016-root.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch.gz)\n\n**Attachment:** [trac_12016-sage.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch.gz)",
    "created_at": "2011-11-16T03:45:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129911",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [trac_12016-root.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch.gz)

**Attachment:** [trac_12016-sage.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch.gz)



---

archive/issue_events_137265.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2011-11-16T04:23:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137265"
}
```



---

archive/issue_comments_129912.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,16 +4,12 @@\n \n - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.\n \n-- **TODO**: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n+- running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n \n In #6495, we should implement the same behavior for doc building.\n \n-**TODO:** We should also support:\n-- `make -j16 ptestlong` (as opposed to `MAKE=\"make -j16\" make ptestlong`).  Use `MAKEFLAGS`.\n-- `make -j` (unlimited number of jobs, say set to 9999 if we really need a number).\n-- `make -j37 -j1` (last option takes precedence).\n+**Apply**:\n+1. [attachment:trac_12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch) to the `SAGE_ROOT` repository.\n+2. [attachment:trac_12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch) to the `SCRIPTS` repository.\n+3. [attachment:trac_12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch) to the Sage library.\n \n-**Apply**:\n-1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.\n-2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.\n-3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.\n``````\n",
    "created_at": "2011-11-16T04:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129912",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,16 +4,12 @@
 
 - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.
 
-- **TODO**: running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
+- running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
 
 In #6495, we should implement the same behavior for doc building.
 
-**TODO:** We should also support:
-- `make -j16 ptestlong` (as opposed to `MAKE="make -j16" make ptestlong`).  Use `MAKEFLAGS`.
-- `make -j` (unlimited number of jobs, say set to 9999 if we really need a number).
-- `make -j37 -j1` (last option takes precedence).
+**Apply**:
+1. [attachment:trac_12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch) to the `SAGE_ROOT` repository.
+2. [attachment:trac_12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch) to the `SCRIPTS` repository.
+3. [attachment:trac_12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch) to the Sage library.
 
-**Apply**:
-1. [attachment:12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.v2.patch) to the `SAGE_ROOT` repository.
-2. [attachment:12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.v2.patch) to the `SCRIPTS` repository.
-3. [attachment:12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.v2.patch) to the Sage library.
``````




---

archive/issue_comments_129913.json:
```json
{
    "body": "<a id='comment:11'></a>\nHere are new patches.  These use `SAGE_NUM_THREADS` if it is set, and otherwise try to extract a number from `MAKE`.  (My method for doing this is probably not ideal, but the options  This is done in sage-env.  Running `sage -b` should use this setting now, also.\n\nI don't know how to get the number of threads from\n\n```\nmake -j16 ptestlong\n```\nso I removed that from the \"to do\" list in the ticket description.\n\nIn the file sage-ptest, I removed the \"FIXME\" comment in\n\n```python\n    try:\n        # FIXME: Nice, but <NUMTHREADS> should immediately follow '-tp' etc.,\n        #        i.e., be the next argument. We might have file or directory\n        #        names that properly convert to an int...\n        numthreads = int(argv[1])\n        infiles = argv[2:]\n    except ValueError: # can't convert first arg to an integer: arg was probably omitted\n        numthreads = 1\n```\nThe script sage-ptest doesn't get a \"tp\" argument; it is instead called by sage-sage, and the way it is called, the first argument to sage-ptest is precisely what ever came after \"-tp\".  So I don't think anything needs fixing.  If we ever rewrite sage-sage (#21) to properly parse arguments, we can make sure that \"-tp\" has a default numerical argument of zero.",
    "created_at": "2011-11-16T04:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129913",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
Here are new patches.  These use `SAGE_NUM_THREADS` if it is set, and otherwise try to extract a number from `MAKE`.  (My method for doing this is probably not ideal, but the options  This is done in sage-env.  Running `sage -b` should use this setting now, also.

I don't know how to get the number of threads from

```
make -j16 ptestlong
```
so I removed that from the "to do" list in the ticket description.

In the file sage-ptest, I removed the "FIXME" comment in

```python
    try:
        # FIXME: Nice, but <NUMTHREADS> should immediately follow '-tp' etc.,
        #        i.e., be the next argument. We might have file or directory
        #        names that properly convert to an int...
        numthreads = int(argv[1])
        infiles = argv[2:]
    except ValueError: # can't convert first arg to an integer: arg was probably omitted
        numthreads = 1
```
The script sage-ptest doesn't get a "tp" argument; it is instead called by sage-sage, and the way it is called, the first argument to sage-ptest is precisely what ever came after "-tp".  So I don't think anything needs fixing.  If we ever rewrite sage-sage (#21) to properly parse arguments, we can make sure that "-tp" has a default numerical argument of zero.



---

archive/issue_comments_129914.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Attachment:** [trac_12016-scripts.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch.gz)\n\n1) If you are going to use the string \"auto\" for automatic, you might as well use \"infinite\" for infinite, instead of zero.\n\n1b) Alternatively: use 0 for automatic (as is sage -tp 0) and 999999 for unlimited.  This would mean less special-case code, since a value like 999999 is more than what a user would normally specify (for the forseeable future).\n\n2) In `sage-ptest`, unlimited really should be unlimited.  Not max(8, # of cpus).\n\n3) We should also do the following long-needed fix here: setting `MAKE` to `make -j16` is very standard in Sage circles, but not actually the prefered way according to the GNU make folks.  One really should use `MAKEFLAGS` instead (similar to the distinction between `CC` and `CFLAGS`).  This is why you often see an error like \"make -jN forced in sub-make.  Disabling job server mode\" (freely quoted from my mind).  So, when `MAKEFLAGS` exists, assume that make understands the flags and **do not pass flags** in `MAKE`.\n\n4) Why did you change\n\n```\nsage-build \"$@\" || exit $?\n```\nto\n\n```\nsage-build \"$@\"\n```\nin the `sage_build()` function in `sage-sage`?\n\n5) You reverted a lot of changes that I made to `doc/en/developer/doctesting.rst`. Why?  I actually **tried** all the examples in the documentation and pasted the exact output I got (on `sage.math.washington.edu`).  Surely, this is better than keeping the outdated (and in many cases totally wrong) output.\n\n\nI am planning to work further on this, so don't change any code yet.  But please give your opinion.",
    "created_at": "2011-11-21T21:41:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129914",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
**Attachment:** [trac_12016-scripts.v2.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch.gz)

1) If you are going to use the string "auto" for automatic, you might as well use "infinite" for infinite, instead of zero.

1b) Alternatively: use 0 for automatic (as is sage -tp 0) and 999999 for unlimited.  This would mean less special-case code, since a value like 999999 is more than what a user would normally specify (for the forseeable future).

2) In `sage-ptest`, unlimited really should be unlimited.  Not max(8, # of cpus).

3) We should also do the following long-needed fix here: setting `MAKE` to `make -j16` is very standard in Sage circles, but not actually the prefered way according to the GNU make folks.  One really should use `MAKEFLAGS` instead (similar to the distinction between `CC` and `CFLAGS`).  This is why you often see an error like "make -jN forced in sub-make.  Disabling job server mode" (freely quoted from my mind).  So, when `MAKEFLAGS` exists, assume that make understands the flags and **do not pass flags** in `MAKE`.

4) Why did you change

```
sage-build "$@" || exit $?
```
to

```
sage-build "$@"
```
in the `sage_build()` function in `sage-sage`?

5) You reverted a lot of changes that I made to `doc/en/developer/doctesting.rst`. Why?  I actually **tried** all the examples in the documentation and pasted the exact output I got (on `sage.math.washington.edu`).  Surely, this is better than keeping the outdated (and in many cases totally wrong) output.


I am planning to work further on this, so don't change any code yet.  But please give your opinion.



---

archive/issue_events_137266.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-21T21:41:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137266"
}
```



---

archive/issue_events_137267.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-21T21:41:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137267"
}
```



---

archive/issue_events_137268.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-11-21T21:41:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/critical",
    "label_color": "ff0000",
    "label_name": "critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137268"
}
```



---

archive/issue_comments_129915.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [@jdemeyer](#comment%3A12):\n> 1) If you are going to use the string \"auto\" for automatic, you might as well use \"infinite\" for infinite, instead of zero.\n> \n> 1b) Alternatively: use 0 for automatic (as is sage -tp 0) and 999999 for unlimited.  This would mean less special-case code, since a value like 999999 is more than what a user would normally specify (for the forseeable future).\n\nSounds good to me.\n\n> 2) In `sage-ptest`, unlimited really should be unlimited.  Not max(8, # of cpus).\n\nOkay.\n\n> 3) We should also do the following long-needed fix here: setting `MAKE` to `make -j16` is very standard in Sage circles, but not actually the prefered way according to the GNU make folks.  One really should use `MAKEFLAGS` instead (similar to the distinction between `CC` and `CFLAGS`).  This is why you often see an error like \"make -jN forced in sub-make.  Disabling job server mode\" (freely quoted from my mind).  So, when `MAKEFLAGS` exists, assume that make understands the flags and **do not pass flags** in `MAKE`.\n\nI'm willing to try that, especially if you write the patch instead of me :)\n\n> 4) Why did you change\n> \n> ```\n> sage-build \"$@\" || exit $?\n> ```\n> to\n> \n> ```\n> sage-build \"$@\"\n> ```\n> in the `sage_build()` function in `sage-sage`?\n\nThat was a mistake.\n\n> 5) You reverted a lot of changes that I made to `doc/en/developer/doctesting.rst`. Why?  I actually **tried** all the examples in the documentation and pasted the exact output I got (on `sage.math.washington.edu`).  Surely, this is better than keeping the outdated (and in many cases totally wrong) output.\n\nSome of them I disagreed with, like the complete removal of the section \"Beyond the Sage library\".  So I started from scratch, at which point I just put in the changes that I felt were relevant to the ticket or easy for me to change.  Probably I should have started with your patch and added the section (with modifications) back in.\n\nIt looks like #9739 broke doctesting of .sage files.  We should fix that (not on this ticket).",
    "created_at": "2011-11-21T22:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129915",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
Replying to [@jdemeyer](#comment%3A12):
> 1) If you are going to use the string "auto" for automatic, you might as well use "infinite" for infinite, instead of zero.
> 
> 1b) Alternatively: use 0 for automatic (as is sage -tp 0) and 999999 for unlimited.  This would mean less special-case code, since a value like 999999 is more than what a user would normally specify (for the forseeable future).

Sounds good to me.

> 2) In `sage-ptest`, unlimited really should be unlimited.  Not max(8, # of cpus).

Okay.

> 3) We should also do the following long-needed fix here: setting `MAKE` to `make -j16` is very standard in Sage circles, but not actually the prefered way according to the GNU make folks.  One really should use `MAKEFLAGS` instead (similar to the distinction between `CC` and `CFLAGS`).  This is why you often see an error like "make -jN forced in sub-make.  Disabling job server mode" (freely quoted from my mind).  So, when `MAKEFLAGS` exists, assume that make understands the flags and **do not pass flags** in `MAKE`.

I'm willing to try that, especially if you write the patch instead of me :)

> 4) Why did you change
> 
> ```
> sage-build "$@" || exit $?
> ```
> to
> 
> ```
> sage-build "$@"
> ```
> in the `sage_build()` function in `sage-sage`?

That was a mistake.

> 5) You reverted a lot of changes that I made to `doc/en/developer/doctesting.rst`. Why?  I actually **tried** all the examples in the documentation and pasted the exact output I got (on `sage.math.washington.edu`).  Surely, this is better than keeping the outdated (and in many cases totally wrong) output.

Some of them I disagreed with, like the complete removal of the section "Beyond the Sage library".  So I started from scratch, at which point I just put in the changes that I felt were relevant to the ticket or easy for me to change.  Probably I should have started with your patch and added the section (with modifications) back in.

It looks like #9739 broke doctesting of .sage files.  We should fix that (not on this ticket).



---

archive/issue_comments_129916.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@jhpalmieri](#comment%3A13):\n> It looks like #9739 broke doctesting of .sage files.  We should fix that (not on this ticket).\n\nSee #12069.",
    "created_at": "2011-11-21T22:55:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129916",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>
Replying to [@jhpalmieri](#comment%3A13):
> It looks like #9739 broke doctesting of .sage files.  We should fix that (not on this ticket).

See #12069.



---

archive/issue_comments_129917.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@jhpalmieri](#comment%3A13):\n> Some of them I disagreed with, like the complete removal of the section \"Beyond the Sage library\".\n\nI removed that because it totally didn't work.  But this is probably #12069.  How about we leave the last section of the documentation alone in this ticket but then change the documentation in #12069?",
    "created_at": "2011-11-22T13:51:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129917",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [@jhpalmieri](#comment%3A13):
> Some of them I disagreed with, like the complete removal of the section "Beyond the Sage library".

I removed that because it totally didn't work.  But this is probably #12069.  How about we leave the last section of the documentation alone in this ticket but then change the documentation in #12069?



---

archive/issue_comments_129918.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@jdemeyer](#comment%3A15):\n> Replying to [@jhpalmieri](#comment%3A13):\n> > Some of them I disagreed with, like the complete removal of the section \"Beyond the Sage library\".\n\n> I removed that because it totally didn't work.  But this is probably #12069.  How about we leave the last section of the documentation alone in this ticket but then change the documentation in #12069?\n\nOkay, sounds fine to me.",
    "created_at": "2011-11-22T19:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129918",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>
Replying to [@jdemeyer](#comment%3A15):
> Replying to [@jhpalmieri](#comment%3A13):
> > Some of them I disagreed with, like the complete removal of the section "Beyond the Sage library".

> I removed that because it totally didn't work.  But this is probably #12069.  How about we leave the last section of the documentation alone in this ticket but then change the documentation in #12069?

Okay, sounds fine to me.



---

archive/issue_comments_129919.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -9,7 +9,7 @@\n In #6495, we should implement the same behavior for doc building.\n \n **Apply**:\n-1. [attachment:trac_12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch) to the `SAGE_ROOT` repository.\n-2. [attachment:trac_12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch) to the `SCRIPTS` repository.\n-3. [attachment:trac_12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch) to the Sage library.\n+1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n+2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n+3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n \n``````\n",
    "created_at": "2011-11-29T10:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129919",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -9,7 +9,7 @@
 In #6495, we should implement the same behavior for doc building.
 
 **Apply**:
-1. [attachment:trac_12016-root.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-root.v2.patch) to the `SAGE_ROOT` repository.
-2. [attachment:trac_12016-scripts.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts.v2.patch) to the `SCRIPTS` repository.
-3. [attachment:trac_12016-sage.v2.patch](https://github.com/sagemath/sage/files/ticket12016/trac_12016-sage.v2.patch) to the Sage library.
+1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
+2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
+3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
 
``````




---

archive/issue_comments_129920.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe essence of the patch should be there.  I'm not claiming it works, I still need to test many things.",
    "created_at": "2011-11-29T10:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129920",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
The essence of the patch should be there.  I'm not claiming it works, I still need to test many things.



---

archive/issue_comments_129921.json:
```json
{
    "body": "**Changing dependencies** from \"#11969\" to \"#11969, #12096\".",
    "created_at": "2011-11-29T10:15:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129921",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#11969" to "#11969, #12096".



---

archive/issue_comments_129922.json:
```json
{
    "body": "**Changing dependencies** from \"#11969, #12096\" to \"#11969, #12096, #12098\".",
    "created_at": "2011-11-29T13:53:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129922",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#11969, #12096" to "#11969, #12096, #12098".



---

archive/issue_comments_129923.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -13,3 +13,8 @@\n 2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n 3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n \n+**Notes**:\n+With the patches applied, building spkgs in parallel works well, except for a \"jobserver unavailable\" warning in:\n+* ntl\n+* singular\n+* rubiks\n``````\n",
    "created_at": "2011-11-29T14:16:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129923",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -13,3 +13,8 @@
 2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
 3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
 
+**Notes**:
+With the patches applied, building spkgs in parallel works well, except for a "jobserver unavailable" warning in:
+* ntl
+* singular
+* rubiks
``````




---

archive/issue_comments_129924.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,8 +10,9 @@\n \n **Apply**:\n 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n-2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n-3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n+2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.\n+3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n+4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n \n **Notes**:\n With the patches applied, building spkgs in parallel works well, except for a \"jobserver unavailable\" warning in:\n``````\n",
    "created_at": "2011-11-29T14:52:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129924",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,8 +10,9 @@
 
 **Apply**:
 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
-2. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
-3. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
+2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.
+3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
+4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
 
 **Notes**:
 With the patches applied, building spkgs in parallel works well, except for a "jobserver unavailable" warning in:
``````




---

archive/issue_comments_129925.json:
```json
{
    "body": "<a id='comment:21'></a>\nIn `spkg/standard/deps`, why prefix most of the rules with \"+\"?",
    "created_at": "2011-11-29T18:16:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129925",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>
In `spkg/standard/deps`, why prefix most of the rules with "+"?



---

archive/issue_comments_129926.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [@jhpalmieri](#comment%3A21):\n> In `spkg/standard/deps`, why prefix most of the rules with \"+\"?\n\nTo mark the rule as \"recursive\", see [http://www.gnu.org/software/make/manual/make.html#Recursion](http://www.gnu.org/software/make/manual/make.html#Recursion).  Otherwise you get lots of warnings like\n\n```\nmake[2]: warning: jobserver unavailable: using -j1.  Add `+' to parent make rule.\n```",
    "created_at": "2011-11-29T18:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129926",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [@jhpalmieri](#comment%3A21):
> In `spkg/standard/deps`, why prefix most of the rules with "+"?

To mark the rule as "recursive", see [http://www.gnu.org/software/make/manual/make.html#Recursion](http://www.gnu.org/software/make/manual/make.html#Recursion).  Otherwise you get lots of warnings like

```
make[2]: warning: jobserver unavailable: using -j1.  Add `+' to parent make rule.
```



---

archive/issue_comments_129927.json:
```json
{
    "body": "**Changing dependencies** from \"#11969, #12096, #12098\" to \"sage-4.8.alpha3 + #12096\".",
    "created_at": "2011-12-02T10:33:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129927",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#11969, #12096, #12098" to "sage-4.8.alpha3 + #12096".



---

archive/issue_comments_129928.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then\n \n-- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  *This is standard `make` behaviour, no patches are needed.*\n+- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.\n \n - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.\n \n``````\n",
    "created_at": "2011-12-02T10:42:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129928",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then
 
-- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  *This is standard `make` behaviour, no patches are needed.*
+- running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.
 
 - running `make ptestlong` or `sage -tp 0 <files>` will doctest in parallel using 16 threads.  If the `-j` flag in `MAKE` is not set, then determine the number of threads as before: `min(8, cpu_count())`.
 
``````




---

archive/issue_comments_129929.json:
```json
{
    "body": "<a id='comment:25'></a>\nWith these patches applied, I often (not always) get the following doctest error in `sage0.py`:\n\n```\nsage -t  -force_lib devel/sage/sage/interfaces/sage0.py\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py\", line 448:\n    sage: F == sage0(F)._sage_()\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_20[4]>\", line 1, in <module>\n        F == sage0(F)._sage_()###line 448:\n    sage: F == sage0(F)._sage_()\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/lib/python/site-packages/sage/interfaces/sage0.py\", line 458, in _sage_\n        return load(P._local_tmpfile())\n      File \"sage_object.pyx\", line 775, in sage.structure.sage_object.load (sage/structure/sage_object.c:7937)\n    IOError: [Errno 2] No such file or directory: '/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/home/.sage//temp/sage.math.washington.edu/4956//interface//tmp5116.sobj'\n**********************************************************************\n[...]\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py\", line 547:\n    sage: sage0_version() == version()\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n[...]\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py\", line 176:\n    sage: sage0('factor(2^157-1)')\nExpected:\n    852133201 * 60726444167 * 1654058017289 * 2134387368610417\nGot:\n    <BLANKLINE>\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py\", line 178:\n    sage: print \"ignore this\";  sage0.cputime()     # random output\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_3[4]>\", line 1, in <module>\n        print \"ignore this\";  sage0.cputime()     # random output###line 178:\n    sage: print \"ignore this\";  sage0.cputime()     # random output\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/lib/python/site-packages/sage/interfaces/sage0.py\", line 185, in cputime\n        return float(s)\n    ValueError: invalid literal for float(): 852133201 * 60726444167 * 1654058017289 * 2134387368610417\n**********************************************************************\n```",
    "created_at": "2011-12-03T01:02:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129929",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
With these patches applied, I often (not always) get the following doctest error in `sage0.py`:

```
sage -t  -force_lib devel/sage/sage/interfaces/sage0.py
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py", line 448:
    sage: F == sage0(F)._sage_()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_20[4]>", line 1, in <module>
        F == sage0(F)._sage_()###line 448:
    sage: F == sage0(F)._sage_()
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/lib/python/site-packages/sage/interfaces/sage0.py", line 458, in _sage_
        return load(P._local_tmpfile())
      File "sage_object.pyx", line 775, in sage.structure.sage_object.load (sage/structure/sage_object.c:7937)
    IOError: [Errno 2] No such file or directory: '/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/home/.sage//temp/sage.math.washington.edu/4956//interface//tmp5116.sobj'
**********************************************************************
[...]
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py", line 547:
    sage: sage0_version() == version()
Expected:
    True
Got:
    False
**********************************************************************
[...]
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py", line 176:
    sage: sage0('factor(2^157-1)')
Expected:
    852133201 * 60726444167 * 1654058017289 * 2134387368610417
Got:
    <BLANKLINE>
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/devel/sage-main/sage/interfaces/sage0.py", line 178:
    sage: print "ignore this";  sage0.cputime()     # random output
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[4]>", line 1, in <module>
        print "ignore this";  sage0.cputime()     # random output###line 178:
    sage: print "ignore this";  sage0.cputime()     # random output
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha3-make-jobs/local/lib/python/site-packages/sage/interfaces/sage0.py", line 185, in cputime
        return float(s)
    ValueError: invalid literal for float(): 852133201 * 60726444167 * 1654058017289 * 2134387368610417
**********************************************************************
```



---

archive/issue_comments_129930.json:
```json
{
    "body": "**Attachment:** [12016-root.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch.gz)",
    "created_at": "2011-12-05T16:20:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129930",
    "user": "https://github.com/jdemeyer"
}
```

**Attachment:** [12016-root.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch.gz)



---

archive/issue_comments_129931.json:
```json
{
    "body": "<a id='comment:26'></a>\nI installed these patches on sage.math and set `MAKE='make -j12'`.  Then I ran `make ptestlong`, and the log file for the testing says \"Doctesting 2857 files doing 2 jobs in parallel\".  Running `./sage -tp --long ...` uses 12 threads, as it should.\n\nIf I remove the redirection of stderr to null in sage-env, when calling sage-num-threads, I see this:\n\n```\nTraceback (most recent call last):\n  File \"/mnt/usb1/scratch/palmieri/12016/test1/sage-4.8.X/local/bin/sage-num-threads.py\", line 144, in <module>\n    print \"%i %i %i\"%num_threads()\n  File \"/mnt/usb1/scratch/palmieri/12016/test1/sage-4.8.X/local/bin/sage-num-threads.py\", line 95, in num_threads\n    if MAKEFLAGS[0] != '-':\nIndexError: string index out of range\n```\nThis seems to fix the problem for me:\n\n```diff\ndiff --git a/sage-num-threads.py b/sage-num-threads.py\n--- a/sage-num-threads.py\n+++ b/sage-num-threads.py\n@@ -92,7 +92,7 @@ def num_threads():\n     try:\n         # Prepend hyphen to MAKEFLAGS if it does not start with one\n         MAKEFLAGS=os.environ[\"MAKEFLAGS\"]\n-        if MAKEFLAGS[0] != '-':\n+        if len(MAKEFLAGS) > 0 and MAKEFLAGS[0] != '-':\n             MAKEFLAGS = '-' + MAKEFLAGS\n         # In MAKEFLAGS, \"-j\" does not mean unlimited.  It probably\n         # means an inherited number of jobs, let us use 2 for safety.\n```",
    "created_at": "2011-12-07T20:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129931",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:26'></a>
I installed these patches on sage.math and set `MAKE='make -j12'`.  Then I ran `make ptestlong`, and the log file for the testing says "Doctesting 2857 files doing 2 jobs in parallel".  Running `./sage -tp --long ...` uses 12 threads, as it should.

If I remove the redirection of stderr to null in sage-env, when calling sage-num-threads, I see this:

```
Traceback (most recent call last):
  File "/mnt/usb1/scratch/palmieri/12016/test1/sage-4.8.X/local/bin/sage-num-threads.py", line 144, in <module>
    print "%i %i %i"%num_threads()
  File "/mnt/usb1/scratch/palmieri/12016/test1/sage-4.8.X/local/bin/sage-num-threads.py", line 95, in num_threads
    if MAKEFLAGS[0] != '-':
IndexError: string index out of range
```
This seems to fix the problem for me:

```diff
diff --git a/sage-num-threads.py b/sage-num-threads.py
--- a/sage-num-threads.py
+++ b/sage-num-threads.py
@@ -92,7 +92,7 @@ def num_threads():
     try:
         # Prepend hyphen to MAKEFLAGS if it does not start with one
         MAKEFLAGS=os.environ["MAKEFLAGS"]
-        if MAKEFLAGS[0] != '-':
+        if len(MAKEFLAGS) > 0 and MAKEFLAGS[0] != '-':
             MAKEFLAGS = '-' + MAKEFLAGS
         # In MAKEFLAGS, "-j" does not mean unlimited.  It probably
         # means an inherited number of jobs, let us use 2 for safety.
```



---

archive/issue_comments_129932.json:
```json
{
    "body": "<a id='comment:27'></a>\nAnother patch:\n\n```diff\n\ndiff --git a/setup.py b/setup.py\n--- a/setup.py\n+++ b/setup.py\n@@ -242,7 +242,8 @@ def execute_list_of_commands_in_parallel\n     WARNING: commands are run roughly in order, but of course successive\n     commands may be run at the same time.\n     \"\"\"\n-    print \"Execute %s commands (using %s threads)\"%(len(command_list), min(len(command_list),nthreads))\n+    nthreads = min(len(command_list),nthreads)\n+    print \"Execute %s commands (using %s threads)\"%(len(command_list), nthreads)\n     from multiprocessing import Pool\n     import twisted.persisted.styles #doing this import will allow instancemethods to be pickable\n     p = Pool(nthreads)\n```\nWithout this one, if you do `export MAKE='make -j'` and then `make ptestlong`, although it says it's using 0 threads, it actually starts up 999999 threads (to do nothing, as far as I can tell).\n\nI get lots of doctest failures and warnings using `make -j`, along the lines of `OSError: [Errno 11] Resource temporarily unavailable` and `/bin/sh: Cannot fork`, but I guess this is to be expected?  Maybe we should put some sort of cap on the number of threads to use for doctesting?",
    "created_at": "2011-12-07T22:12:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129932",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>
Another patch:

```diff

diff --git a/setup.py b/setup.py
--- a/setup.py
+++ b/setup.py
@@ -242,7 +242,8 @@ def execute_list_of_commands_in_parallel
     WARNING: commands are run roughly in order, but of course successive
     commands may be run at the same time.
     """
-    print "Execute %s commands (using %s threads)"%(len(command_list), min(len(command_list),nthreads))
+    nthreads = min(len(command_list),nthreads)
+    print "Execute %s commands (using %s threads)"%(len(command_list), nthreads)
     from multiprocessing import Pool
     import twisted.persisted.styles #doing this import will allow instancemethods to be pickable
     p = Pool(nthreads)
```
Without this one, if you do `export MAKE='make -j'` and then `make ptestlong`, although it says it's using 0 threads, it actually starts up 999999 threads (to do nothing, as far as I can tell).

I get lots of doctest failures and warnings using `make -j`, along the lines of `OSError: [Errno 11] Resource temporarily unavailable` and `/bin/sh: Cannot fork`, but I guess this is to be expected?  Maybe we should put some sort of cap on the number of threads to use for doctesting?



---

archive/issue_comments_129933.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [@jdemeyer](#comment%3A25):\n> With these patches applied, I often (not always) get the following doctest error in `sage0.py`:\n\nHow many threads were you using?  I haven't seen this recently, but I think I've seen this sort of error before unrelated to this ticket.  I'm not sure I would consider it an obstacle for this ticket.  It would be nice to track down the problem, though.",
    "created_at": "2011-12-07T22:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129933",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>
Replying to [@jdemeyer](#comment%3A25):
> With these patches applied, I often (not always) get the following doctest error in `sage0.py`:

How many threads were you using?  I haven't seen this recently, but I think I've seen this sort of error before unrelated to this ticket.  I'm not sure I would consider it an obstacle for this ticket.  It would be nice to track down the problem, though.



---

archive/issue_comments_129934.json:
```json
{
    "body": "<a id='comment:29'></a>\nThanks for the feedback, these should be easy fixes.",
    "created_at": "2011-12-07T22:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129934",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
Thanks for the feedback, these should be easy fixes.



---

archive/issue_comments_129935.json:
```json
{
    "body": "<a id='comment:30'></a>\nFor this ticket or a follow-up: it would be nice to be able to set `MAKE=make -j -l30`, for example, and have tests pass.  Building this way works, but I get lots of doctest failures as [mentioned above](https://github.com/sagemath/sage/issues/12016#comment:27).  Maybe we could read the argument for `-l` for a cap on the threads for doctesting?  Or use the number of cpus for this cap?",
    "created_at": "2011-12-08T01:37:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129935",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:30'></a>
For this ticket or a follow-up: it would be nice to be able to set `MAKE=make -j -l30`, for example, and have tests pass.  Building this way works, but I get lots of doctest failures as [mentioned above](https://github.com/sagemath/sage/issues/12016#comment:27).  Maybe we could read the argument for `-l` for a cap on the threads for doctesting?  Or use the number of cpus for this cap?



---

archive/issue_comments_129936.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [@jhpalmieri](#comment%3A30):\n> Maybe we could read the argument for `-l` for a cap on the threads for doctesting?\n\nShould be possible, in `sage-num-threads.py`.",
    "created_at": "2011-12-08T11:28:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129936",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
Replying to [@jhpalmieri](#comment%3A30):
> Maybe we could read the argument for `-l` for a cap on the threads for doctesting?

Should be possible, in `sage-num-threads.py`.



---

archive/issue_comments_129937.json:
```json
{
    "body": "<a id='comment:32'></a>\nSince ``execute_list_of_commands_in_serial`` is essentially a special case of ``execute_list_of_commands_in_parallel``, I see no reason to keep the former.",
    "created_at": "2011-12-08T17:17:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129937",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
Since ``execute_list_of_commands_in_serial`` is essentially a special case of ``execute_list_of_commands_in_parallel``, I see no reason to keep the former.



---

archive/issue_comments_129938.json:
```json
{
    "body": "**Attachment:** [12016-sage.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch.gz)",
    "created_at": "2011-12-08T17:23:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129938",
    "user": "https://github.com/jdemeyer"
}
```

**Attachment:** [12016-sage.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch.gz)



---

archive/issue_comments_129939.json:
```json
{
    "body": "<a id='comment:33'></a>\nNew patch up, implements support for \"-l\" option to make, fixes and simplifies `setup.py`.",
    "created_at": "2011-12-08T17:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129939",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
New patch up, implements support for "-l" option to make, fixes and simplifies `setup.py`.



---

archive/issue_comments_129940.json:
```json
{
    "body": "<a id='comment:34'></a>\nThis looks good to me.  Is it ready for review?  Am I allowed to review it since I wrote early drafts of some of the patches?\n\nFor a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:\n\n- zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)\n- singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)\n\n(The Sage spkg used to fail before the latest round of patches using the `-l` setting for a cap on the number of threads, and the same goes for parallel doctesting.  Setting `MAKE='make -j'` still causes these failures.  Should we just regard this setting as too dangerous, or try to stop the failures by putting a cap on the number of processes if `-j` is present but set to \"unlimited\" and `-l` is missing?)\n\nThese failures are not related to this ticket; they fail with or without the patches.  But the ticket makes it more appealing to just set `MAKE` as above.",
    "created_at": "2011-12-09T18:38:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129940",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>
This looks good to me.  Is it ready for review?  Am I allowed to review it since I wrote early drafts of some of the patches?

For a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:

- zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)
- singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)

(The Sage spkg used to fail before the latest round of patches using the `-l` setting for a cap on the number of threads, and the same goes for parallel doctesting.  Setting `MAKE='make -j'` still causes these failures.  Should we just regard this setting as too dangerous, or try to stop the failures by putting a cap on the number of processes if `-j` is present but set to "unlimited" and `-l` is missing?)

These failures are not related to this ticket; they fail with or without the patches.  But the ticket makes it more appealing to just set `MAKE` as above.



---

archive/issue_comments_129941.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,6 +7,14 @@\n - running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n \n In #6495, we should implement the same behavior for doc building.\n+\n+Concerning testing this ticket: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running\n+\n+```\n+SAGE_NUM_CORES=24 make ptestlong\n+```\n+should run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).\n+\n \n **Apply**:\n 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n``````\n",
    "created_at": "2011-12-09T20:09:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129941",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -7,6 +7,14 @@
 - running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
 
 In #6495, we should implement the same behavior for doc building.
+
+Concerning testing this ticket: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running
+
+```
+SAGE_NUM_CORES=24 make ptestlong
+```
+should run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).
+
 
 **Apply**:
 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
``````




---

archive/issue_comments_129942.json:
```json
{
    "body": "**Reviewer:** John Palmieri, Jeroen Demeyer",
    "created_at": "2011-12-09T20:09:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129942",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** John Palmieri, Jeroen Demeyer



---

archive/issue_events_137269.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-09T20:09:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137269"
}
```



---

archive/issue_events_137270.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-09T20:09:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137270"
}
```



---

archive/issue_comments_129943.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [@jhpalmieri](#comment%3A34):\n> This looks good to me.  Is it ready for review?\n\nYes, it is.  I just didn't want to put \"needs review\" because I have not really tested it.\n> Am I allowed to review it since I wrote early drafts of some of the patches?\n\nI would say yes, since I certainly looked at all your code.  So consider all your code to be positively reviewed by me.\n \n> For a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:\n\nIt **should** work.\n\n> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)\n> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)\n\nQuestion for both cases: does MAKE=\"make -jN\" work for various values of N?  Because I don't see a fundamental difference between \"make -jN\" and \"make -j -lN\".\n\n> (The Sage spkg used to fail before the latest round of patches using the `-l` setting for a cap on the number of threads, and the same goes for parallel doctesting.  Setting `MAKE='make -j'` still causes these failures.  Should we just regard this setting as too dangerous?\n\nYes.  Since \"make\" will simply run as many threads as it can, I think Sage should do the same, no matter how stupid that is.\n\nBy the way, I would really like to merge this in the sage-4.8 release, because it cleans up some stuff which will also help future tickets like #11073 (which hopefully will be merged in sage-5.0).",
    "created_at": "2011-12-09T20:09:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129943",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>
Replying to [@jhpalmieri](#comment%3A34):
> This looks good to me.  Is it ready for review?

Yes, it is.  I just didn't want to put "needs review" because I have not really tested it.
> Am I allowed to review it since I wrote early drafts of some of the patches?

I would say yes, since I certainly looked at all your code.  So consider all your code to be positively reviewed by me.
 
> For a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:

It **should** work.

> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)
> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)

Question for both cases: does MAKE="make -jN" work for various values of N?  Because I don't see a fundamental difference between "make -jN" and "make -j -lN".

> (The Sage spkg used to fail before the latest round of patches using the `-l` setting for a cap on the number of threads, and the same goes for parallel doctesting.  Setting `MAKE='make -j'` still causes these failures.  Should we just regard this setting as too dangerous?

Yes.  Since "make" will simply run as many threads as it can, I think Sage should do the same, no matter how stupid that is.

By the way, I would really like to merge this in the sage-4.8 release, because it cleans up some stuff which will also help future tickets like #11073 (which hopefully will be merged in sage-5.0).



---

archive/issue_comments_129944.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [@jhpalmieri](#comment%3A34):\n> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)\n> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)\n\nSince my patches properly implement parallel building, it also means that more packages are actually being built in parallel.  So I think we are simply triggering bugs in the various packages.  For example, I never had problems with Python before, but I did have problems with this patch (fixed in #12096).\n\nI cannot explain why \"make -j -lN\" would fail but \"make -jN\" would work.",
    "created_at": "2011-12-09T20:25:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129944",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>
Replying to [@jhpalmieri](#comment%3A34):
> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)
> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)

Since my patches properly implement parallel building, it also means that more packages are actually being built in parallel.  So I think we are simply triggering bugs in the various packages.  For example, I never had problems with Python before, but I did have problems with this patch (fixed in #12096).

I cannot explain why "make -j -lN" would fail but "make -jN" would work.



---

archive/issue_comments_129945.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [@jhpalmieri](#comment%3A34):\n> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)\n\nWell, singular is in the list of fishy packages, see the ticket description.",
    "created_at": "2011-12-09T20:26:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129945",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Replying to [@jhpalmieri](#comment%3A34):
> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)

Well, singular is in the list of fishy packages, see the ticket description.



---

archive/issue_comments_129946.json:
```json
{
    "body": "<a id='comment:38'></a>\nJust for fun, I modified `deps` so singular would build all by itself in the build process (I made it depend on linbox and scipy, so it was the last package to be built before the sage package).  Then it built fine using `make -j -l30`.",
    "created_at": "2011-12-09T21:30:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129946",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:38'></a>
Just for fun, I modified `deps` so singular would build all by itself in the build process (I made it depend on linbox and scipy, so it was the last package to be built before the sage package).  Then it built fine using `make -j -l30`.



---

archive/issue_comments_129947.json:
```json
{
    "body": "<a id='comment:39'></a>\nI think it is truly a coincidence that \"make -j -lN\" fails.  I managed to make singular fail with just \"make -jN\", hopefully fixed by #12138.",
    "created_at": "2011-12-09T23:15:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129947",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>
I think it is truly a coincidence that "make -j -lN" fails.  I managed to make singular fail with just "make -jN", hopefully fixed by #12138.



---

archive/issue_comments_129948.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [@jhpalmieri](#comment%3A34):\n> This looks good to me.  Is it ready for review?  Am I allowed to review it since I wrote early drafts of some of the patches?\n> \n> For a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:\n> \n> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)\n> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)\n\nAre these about builds of the total Sage source in which these fail, or are these separate installs like `sage -f ...`?",
    "created_at": "2011-12-09T23:19:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129948",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>
Replying to [@jhpalmieri](#comment%3A34):
> This looks good to me.  Is it ready for review?  Am I allowed to review it since I wrote early drafts of some of the patches?
> 
> For a future ticket, it would be nice if you could set `MAKE='make -j -lN'`, for some reasonable choice of `N`, and have it work.  When I try this, I have problems with the following spkgs, and I'm not sure why:
> 
> - zlib on OS X (2 cores) fails most of the time with `MAKE='make -j -l3'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/zlib-1.2.5.log)
> - singular on sage.math fails all of the time, I think, with `MAKE='make -j -l30'`. [Here's a log.](http://sage.math.washington.edu/home/palmieri/misc/singular-3-1-3-3.p1.log)

Are these about builds of the total Sage source in which these fail, or are these separate installs like `sage -f ...`?



---

archive/issue_comments_129949.json:
```json
{
    "body": "<a id='comment:41'></a>\nWhen testing with `sage -f`, the proper way to test is using\n\n```\nMAKEFLAGS=\"j50\" ./sage -f ...\n```",
    "created_at": "2011-12-09T23:22:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129949",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
When testing with `sage -f`, the proper way to test is using

```
MAKEFLAGS="j50" ./sage -f ...
```



---

archive/issue_comments_129950.json:
```json
{
    "body": "**Changing dependencies** from \"sage-4.8.alpha3 + #12096\" to \"sage-4.8.alpha3 + #12096, #12137, #12138\".",
    "created_at": "2011-12-10T00:00:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129950",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "sage-4.8.alpha3 + #12096" to "sage-4.8.alpha3 + #12096, #12137, #12138".



---

archive/issue_comments_129951.json:
```json
{
    "body": "<a id='comment:43'></a>\nIn the following lines from sage-spkg\n\n```\n# Handle -n, -t, -q options for recursive make \n# See Trac #12016. \nif echo \"$MAKE $MAKEFLAGS -$MAKEFLAGS\" |grep -e ' -[A-Za-z]*[qnt]' >/dev/null; then \n    if echo \"$MAKE $MAKEFLAGS -$MAKEFLAGS\" |grep -e ' -[A-Za-z]*q' >/dev/null; then \n        exit 1 \n    else \n        exit 0 \n    fi \nfi \n```\ndo we also need to handle the long versions? (I don't think so, but I thought I would ask.)\n\nMore importantly, on OpenSolaris, or at least on David Kirkby's machine hawk, the default 'grep' command doesn't take a `-e` option.  Can we just omit it?  The command still seems to function on sage.math, on OS X, and on OpenSolaris.",
    "created_at": "2011-12-10T04:56:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129951",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>
In the following lines from sage-spkg

```
# Handle -n, -t, -q options for recursive make 
# See Trac #12016. 
if echo "$MAKE $MAKEFLAGS -$MAKEFLAGS" |grep -e ' -[A-Za-z]*[qnt]' >/dev/null; then 
    if echo "$MAKE $MAKEFLAGS -$MAKEFLAGS" |grep -e ' -[A-Za-z]*q' >/dev/null; then 
        exit 1 
    else 
        exit 0 
    fi 
fi 
```
do we also need to handle the long versions? (I don't think so, but I thought I would ask.)

More importantly, on OpenSolaris, or at least on David Kirkby's machine hawk, the default 'grep' command doesn't take a `-e` option.  Can we just omit it?  The command still seems to function on sage.math, on OS X, and on OpenSolaris.



---

archive/issue_comments_129952.json:
```json
{
    "body": "<a id='comment:44'></a>\n> I cannot explain why \"make -j -lN\" would fail but \"make -jN\" would work.\n\nOne reason is that `make -j -lN` puts a limit on starting new processes, and that might be what's causing the problems.  I could force the old zlib spkg to fail on sage.math by running `MAKEFLAGS='j -l2' ./sage -f ...` but not with `MAKEFLAGS='j -l30' ...`.  I don't know if setting `MAKE=\"$MAKE -j1 -l` in spkg-install is the right way to fix this for problematic spkgs (like singular?), but it might be worth trying.",
    "created_at": "2011-12-10T06:48:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129952",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>
> I cannot explain why "make -j -lN" would fail but "make -jN" would work.

One reason is that `make -j -lN` puts a limit on starting new processes, and that might be what's causing the problems.  I could force the old zlib spkg to fail on sage.math by running `MAKEFLAGS='j -l2' ./sage -f ...` but not with `MAKEFLAGS='j -l30' ...`.  I don't know if setting `MAKE="$MAKE -j1 -l` in spkg-install is the right way to fix this for problematic spkgs (like singular?), but it might be worth trying.



---

archive/issue_comments_129953.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [@jhpalmieri](#comment%3A43):\n> In the following lines from sage-spkg\n> \n> ```\n> # Handle -n, -t, -q options for recursive make \n> # See Trac #12016. \n> if echo \"$MAKE $MAKEFLAGS -$MAKEFLAGS\" |grep -e ' -[A-Za-z]*[qnt]' >/dev/null; then \n>     if echo \"$MAKE $MAKEFLAGS -$MAKEFLAGS\" |grep -e ' -[A-Za-z]*q' >/dev/null; then \n>         exit 1 \n>     else \n>         exit 0 \n>     fi \n> fi \n> ```\n> do we also need to handle the long versions? (I don't think so, but I thought I would ask.)\n\nWell, this would only be needed if the user does something very silly like\n\n```\nMAKE=\"make --dry-run\" ./sage -f ...\n```\n\n> More importantly, on OpenSolaris, or at least on David Kirkby's machine hawk, the default 'grep' command doesn't take a `-e` option.  Can we just omit it?\n\nProbably yes, but it might be safer to replace the leading space by a `[ ]`.",
    "created_at": "2011-12-10T10:10:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129953",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>
Replying to [@jhpalmieri](#comment%3A43):
> In the following lines from sage-spkg
> 
> ```
> # Handle -n, -t, -q options for recursive make 
> # See Trac #12016. 
> if echo "$MAKE $MAKEFLAGS -$MAKEFLAGS" |grep -e ' -[A-Za-z]*[qnt]' >/dev/null; then 
>     if echo "$MAKE $MAKEFLAGS -$MAKEFLAGS" |grep -e ' -[A-Za-z]*q' >/dev/null; then 
>         exit 1 
>     else 
>         exit 0 
>     fi 
> fi 
> ```
> do we also need to handle the long versions? (I don't think so, but I thought I would ask.)

Well, this would only be needed if the user does something very silly like

```
MAKE="make --dry-run" ./sage -f ...
```

> More importantly, on OpenSolaris, or at least on David Kirkby's machine hawk, the default 'grep' command doesn't take a `-e` option.  Can we just omit it?

Probably yes, but it might be safer to replace the leading space by a `[ ]`.



---

archive/issue_comments_129954.json:
```json
{
    "body": "**Attachment:** [12016-scripts.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch.gz)",
    "created_at": "2011-12-10T11:00:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129954",
    "user": "https://github.com/jdemeyer"
}
```

**Attachment:** [12016-scripts.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch.gz)



---

archive/issue_comments_129955.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then\n+The various parallel aspects of Sage should be controlled by setting the `-j` (possible also `-l`) flags in `MAKE` or `MAKEFLAGS`.  That is, if `MAKE='make -j16'`, then\n \n - running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.\n \n@@ -6,15 +6,23 @@\n \n - running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.\n \n-In #6495, we should implement the same behavior for doc building.\n-\n-Concerning testing this ticket: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running\n+**Testing this ticket**: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running\n \n ```\n SAGE_NUM_CORES=24 make ptestlong\n ```\n should run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).\n \n+**Notes**:\n+With the patches applied, building spkgs in parallel works well, except for race conditions in:\n+* python (#12096)\n+* singular (#12137)\n+* zlib (#12138)\n+* mpir (#12139)\n+and a \"jobserver unavailable\" warning in:\n+* ntl\n+* singular\n+* rubiks\n \n **Apply**:\n 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n@@ -22,8 +30,4 @@\n 3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n 4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n \n-**Notes**:\n-With the patches applied, building spkgs in parallel works well, except for a \"jobserver unavailable\" warning in:\n-* ntl\n-* singular\n-* rubiks\n+See also: #6495 to implement the same behavior for doc building.\n``````\n",
    "created_at": "2011-12-10T11:14:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129955",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-With the attached patches, along with the changes from #11959, the various parallel aspects of Sage should be controlled by setting the `-j` flag in `MAKE`.  That is, if `MAKE='make -j16'`, then
+The various parallel aspects of Sage should be controlled by setting the `-j` (possible also `-l`) flags in `MAKE` or `MAKEFLAGS`.  That is, if `MAKE='make -j16'`, then
 
 - running `make` will build spkg's in parallel, using 16 processes (this was done in #11959).  This is standard `make` behaviour, but we need to patch `spkg/standard/deps` to ensure that `make` recognizes that we are doing a recursive make.
 
@@ -6,15 +6,23 @@
 
 - running `./sage -b` will build the Sage library using 16 threads. If the `-j` flag in `MAKE` is not set, then use only 1 thread.
 
-In #6495, we should implement the same behavior for doc building.
-
-Concerning testing this ticket: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running
+**Testing this ticket**: you can set the environment variable `SAGE_NUM_CORES` to the number of cores you want to pretend to have.  For example, running
 
 ```
 SAGE_NUM_CORES=24 make ptestlong
 ```
 should run 8 threads (see `sage-num-threads.py`; this is undocumented because the only purpose I see is for testing this ticket).
 
+**Notes**:
+With the patches applied, building spkgs in parallel works well, except for race conditions in:
+* python (#12096)
+* singular (#12137)
+* zlib (#12138)
+* mpir (#12139)
+and a "jobserver unavailable" warning in:
+* ntl
+* singular
+* rubiks
 
 **Apply**:
 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
@@ -22,8 +30,4 @@
 3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
 4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
 
-**Notes**:
-With the patches applied, building spkgs in parallel works well, except for a "jobserver unavailable" warning in:
-* ntl
-* singular
-* rubiks
+See also: #6495 to implement the same behavior for doc building.
``````




---

archive/issue_comments_129956.json:
```json
{
    "body": "<a id='comment:46'></a>\n**Attachment:** [12016-base.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch.gz)",
    "created_at": "2011-12-10T11:14:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129956",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>
**Attachment:** [12016-base.patch.gz](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch.gz)



---

archive/issue_comments_129957.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -21,7 +21,7 @@\n * mpir (#12139)\n and a \"jobserver unavailable\" warning in:\n * ntl\n-* singular\n+* singular (#12137)\n * rubiks\n \n **Apply**:\n``````\n",
    "created_at": "2011-12-10T12:44:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129957",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -21,7 +21,7 @@
 * mpir (#12139)
 and a "jobserver unavailable" warning in:
 * ntl
-* singular
+* singular (#12137)
 * rubiks
 
 **Apply**:
``````




---

archive/issue_comments_129958.json:
```json
{
    "body": "**Changing dependencies** from \"sage-4.8.alpha3 + #12096, #12137, #12138\" to \"sage-4.8.alpha3 + #12096, #12137, #12138, #12139\".",
    "created_at": "2011-12-10T13:33:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129958",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "sage-4.8.alpha3 + #12096, #12137, #12138" to "sage-4.8.alpha3 + #12096, #12137, #12138, #12139".



---

archive/issue_comments_129959.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -27,7 +27,7 @@\n **Apply**:\n 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.\n 2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.\n-3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.\n+3. [and [attachment:trac_12016-scripts-ref.patch](https://github.com/sagemath/sage/files/ticket12016/a82a12f14695e0da5cbdb45c7ee3f287.patch](https://github.com/sagemath/sage/files/ticket12016/a110b2103c2a98fc81f4ba5d97144c15.patch)) to the `SCRIPTS` repository.\n 4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.\n \n See also: #6495 to implement the same behavior for doc building.\n``````\n",
    "created_at": "2011-12-10T22:36:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129959",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -27,7 +27,7 @@
 **Apply**:
 1. [attachment:12016-root.patch](https://github.com/sagemath/sage/files/ticket12016/12016-root.patch) to the `SAGE_ROOT` repository.
 2. [attachment:12016-base.patch](https://github.com/sagemath/sage/files/ticket12016/12016-base.patch) to `spkg/base`.
-3. [attachment:12016-scripts.patch](https://github.com/sagemath/sage/files/ticket12016/12016-scripts.patch) to the `SCRIPTS` repository.
+3. [and [attachment:trac_12016-scripts-ref.patch](https://github.com/sagemath/sage/files/ticket12016/a82a12f14695e0da5cbdb45c7ee3f287.patch](https://github.com/sagemath/sage/files/ticket12016/a110b2103c2a98fc81f4ba5d97144c15.patch)) to the `SCRIPTS` repository.
 4. [attachment:12016-sage.patch](https://github.com/sagemath/sage/files/ticket12016/12016-sage.patch) to the Sage library.
 
 See also: #6495 to implement the same behavior for doc building.
``````




---

archive/issue_comments_129960.json:
```json
{
    "body": "<a id='comment:49'></a>\nI'm happy with this except for a few small changes I want to make in sage-num-threads.py: we should use subprocess instead of popen, since popen has been deprecated.  Also, we should catch errors if `sysctl` fails to run -- it's not present on all platforms.  Finally, we might as well search for `max-load` in addition to `load-average`.  See the referee patch.  If you're happy with that, the whole thing can get a positive review.",
    "created_at": "2011-12-10T22:36:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129960",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:49'></a>
I'm happy with this except for a few small changes I want to make in sage-num-threads.py: we should use subprocess instead of popen, since popen has been deprecated.  Also, we should catch errors if `sysctl` fails to run -- it's not present on all platforms.  Finally, we might as well search for `max-load` in addition to `load-average`.  See the referee patch.  If you're happy with that, the whole thing can get a positive review.



---

archive/issue_comments_129961.json:
```json
{
    "body": "**Attachment:** [trac_12016-scripts-ref.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts-ref.patch.gz)\n\nscripts repo",
    "created_at": "2011-12-10T22:37:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129961",
    "user": "https://github.com/jhpalmieri"
}
```

**Attachment:** [trac_12016-scripts-ref.patch.gz](https://github.com/sagemath/sage/files/ticket12016/trac_12016-scripts-ref.patch.gz)

scripts repo



---

archive/issue_comments_129962.json:
```json
{
    "body": "<a id='comment:50'></a>\nLooks good to me.\n\nI am still slightly worried about the intermittent `sage0.py` doctest failures though...",
    "created_at": "2011-12-11T11:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129962",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>
Looks good to me.

I am still slightly worried about the intermittent `sage0.py` doctest failures though...



---

archive/issue_events_137271.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-11T11:54:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137271"
}
```



---

archive/issue_events_137272.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-11T11:54:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137272"
}
```



---

archive/issue_comments_129963.json:
```json
{
    "body": "**Changing dependencies** from \"sage-4.8.alpha3 + #12096, #12137, #12138, #12139\" to \"sage-4.8.alpha4\".",
    "created_at": "2011-12-11T11:54:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129963",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "sage-4.8.alpha3 + #12096, #12137, #12138, #12139" to "sage-4.8.alpha4".



---

archive/issue_comments_129964.json:
```json
{
    "body": "**Merged:** sage-4.8.alpha5",
    "created_at": "2011-12-14T22:28:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129964",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-4.8.alpha5



---

archive/issue_events_137273.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-14T22:28:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137273"
}
```



---

archive/issue_events_137274.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-12-14T22:28:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12016#event-137274"
}
```



---

archive/issue_comments_129965.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -19,6 +19,7 @@\n * singular (#12137)\n * zlib (#12138)\n * mpir (#12139)\n+* atlas on Solaris (#12312)\n and a \"jobserver unavailable\" warning in:\n * ntl\n * singular (#12137)\n``````\n",
    "created_at": "2012-01-15T15:36:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12016#issuecomment-129965",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -19,6 +19,7 @@
 * singular (#12137)
 * zlib (#12138)
 * mpir (#12139)
+* atlas on Solaris (#12312)
 and a "jobserver unavailable" warning in:
 * ntl
 * singular (#12137)
``````

