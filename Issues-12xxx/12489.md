# Issue 12489: Fix equality of combinatorial free module on non totally ordered basis

archive/issues_012317.json:
```json
{
    "body": "The following is obviously wrong:\n\n```\nsage: F = CombinatorialFreeModule(QQ, Subsets([1,2,3]))\nsage: x = F.an_element()\nsage: x+0 == x\nFalse\nsage: x+F.zero() == x\nFalse\n```\nThe reason is\n\n```\nsage: (x+F.zero()).terms()  # random\n[2*B[{1}], 3*B[{2}], B[{}]]\nsage: x.terms()             # random\n[2*B[{1}], B[{}], 3*B[{2}]]\n```\n\nFixing equality testing also revealed a bug in sage.combinat.sf.dual: the conversion back from the dual basis did not strip cancelled terms from the dictionary. This conversion now uses dict_linear_combination which fixes the bug, factors out code and should be faster.\n\n\nSee also the possible optimization in #12508\n\nAssignee: sage-combinat\n\nCC:  sage-combinat\n\nKeywords: CombinatorialFreeModule, equality, Cernay2012\n\nResolution: fixed\n\nDependencies: #12490\n\nAuthor: Nicolas M. Thi\u00e9ry\n\nReviewer: Florent Hivert\n\nMerged: sage-5.0.beta5\n\nIssue created by migration from https://trac.sagemath.org/ticket/12489\n\n",
    "closed_at": "2012-02-22T10:46:57Z",
    "created_at": "2012-02-10T12:54:05Z",
    "labels": [
        "component: combinatorics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Fix equality of combinatorial free module on non totally ordered basis",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12489",
    "user": "https://github.com/hivert"
}
```
The following is obviously wrong:

```
sage: F = CombinatorialFreeModule(QQ, Subsets([1,2,3]))
sage: x = F.an_element()
sage: x+0 == x
False
sage: x+F.zero() == x
False
```
The reason is

```
sage: (x+F.zero()).terms()  # random
[2*B[{1}], 3*B[{2}], B[{}]]
sage: x.terms()             # random
[2*B[{1}], B[{}], 3*B[{2}]]
```

Fixing equality testing also revealed a bug in sage.combinat.sf.dual: the conversion back from the dual basis did not strip cancelled terms from the dictionary. This conversion now uses dict_linear_combination which fixes the bug, factors out code and should be faster.


See also the possible optimization in #12508

Assignee: sage-combinat

CC:  sage-combinat

Keywords: CombinatorialFreeModule, equality, Cernay2012

Resolution: fixed

Dependencies: #12490

Author: Nicolas M. Thi√©ry

Reviewer: Florent Hivert

Merged: sage-5.0.beta5

Issue created by migration from https://trac.sagemath.org/ticket/12489





---

archive/issue_comments_144766.json:
```json
{
    "body": "Changing keywords from \"CombinatorialFreeModule, equality\" to \"CombinatorialFreeModule, equality, Cernay2012\".",
    "created_at": "2012-02-10T13:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144766",
    "user": "https://github.com/hivert"
}
```

Changing keywords from "CombinatorialFreeModule, equality" to "CombinatorialFreeModule, equality, Cernay2012".



---

archive/issue_comments_144767.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-11T00:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144767",
    "user": "https://github.com/hivert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_144768.json:
```json
{
    "body": "<a id='comment:3'></a>I uploaded the patch on behalf of Nicolas and put a positive review since I'm Ok with it (the test suite is currently running). \n\nNicolas: I just put the correct trac ticket number and added one more test compared to your patch. I don't think this needs a new review.",
    "created_at": "2012-02-11T00:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144768",
    "user": "https://github.com/hivert"
}
```

<a id='comment:3'></a>I uploaded the patch on behalf of Nicolas and put a positive review since I'm Ok with it (the test suite is currently running). 

Nicolas: I just put the correct trac ticket number and added one more test compared to your patch. I don't think this needs a new review.



---

archive/issue_comments_144769.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-11T00:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144769",
    "user": "https://github.com/hivert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_144770.json:
```json
{
    "body": "<a id='comment:4'></a>+1! Thanks for the review!",
    "created_at": "2012-02-11T18:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144770",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:4'></a>+1! Thanks for the review!



---

archive/issue_comments_144771.json:
```json
{
    "body": "<a id='comment:5'></a>\n```\nsage -t --long \"devel/sage-main/sage/combinat/sf/dual.py\"\n**********************************************************************\nFile \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py\", line 33:\n    sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)\nExpected nothing\nGot:\n    Failure in _test_one:\n    Traceback (most recent call last):\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py\", line 275, in run\n        test_method(tester = tester)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py\", line 126, in _tes\nt_one\n        tester.assert_(x * one == x)\n      File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py\", line 420, in assertTrue\n        raise self.failureException(msg)\n    AssertionError: False is not true\n[...]\n```",
    "created_at": "2012-02-13T12:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144771",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
```
sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py", line 33:
    sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)
Expected nothing
Got:
    Failure in _test_one:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py", line 275, in run
        test_method(tester = tester)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py", line 126, in _tes
t_one
        tester.assert_(x * one == x)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py", line 420, in assertTrue
        raise self.failureException(msg)
    AssertionError: False is not true
[...]
```



---

archive/issue_comments_144772.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-02-13T12:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144772",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_144773.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:\n> {{{\n> sage -t --long \"devel/sage-main/sage/combinat/sf/dual.py\"\n> **********************************************************************\n> File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py\", line 33:\n>     sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)\n> Expected nothing\n> Got:\n>     Failure in _test_one:\n>     Traceback (most recent call last):\n>       File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py\", line 275, in run\n>         test_method(tester = tester)\n>       File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py\", line 126, in _tes\n> t_one\n>         tester.assert_(x * one == x)\n>       File \"/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py\", line 420, in assertTrue\n>         raise self.failureException(msg)\n>     AssertionError: False is not true\n> [...]\n> }}}\n\n\nThanks for catching that. I am working on it. First thing, I am extracting the call to _test_associativity to only set # long on it, and not on the full testsuite (otherwise I would have caught the error myself). The other thing is that the new equality test highlighted a preexisting bug: x*f.one() contains zero coefficients in its dictionary.",
    "created_at": "2012-02-13T15:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144773",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:
> {{{
> sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
> **********************************************************************
> File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/devel/sage-main/sage/combinat/sf/dual.py", line 33:
>     sage: TestSuite(f).run()  # long time (11s on sage.math, 2011)
> Expected nothing
> Got:
>     Failure in _test_one:
>     Traceback (most recent call last):
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/misc/sage_unittest.py", line 275, in run
>         test_method(tester = tester)
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python/site-packages/sage/categories/monoids.py", line 126, in _tes
> t_one
>         tester.assert_(x * one == x)
>       File "/mnt/usb1/scratch/jdemeyer/merger/sage-5.0.beta4/local/lib/python2.7/unittest/case.py", line 420, in assertTrue
>         raise self.failureException(msg)
>     AssertionError: False is not true
> [...]
> }}}


Thanks for catching that. I am working on it. First thing, I am extracting the call to _test_associativity to only set # long on it, and not on the full testsuite (otherwise I would have caught the error myself). The other thing is that the new equality test highlighted a preexisting bug: x*f.one() contains zero coefficients in its dictionary.



---

archive/issue_comments_144774.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-13T15:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144774",
    "user": "https://github.com/nthiery"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_144775.json:
```json
{
    "body": "Attachment [trac_12489-freemod_eq-nt.patch](tarball://root/attachments/some-uuid/ticket12489/trac_12489-freemod_eq-nt.patch) by @nthiery created at 2012-02-13 15:44:28",
    "created_at": "2012-02-13T15:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144775",
    "user": "https://github.com/nthiery"
}
```

Attachment [trac_12489-freemod_eq-nt.patch](tarball://root/attachments/some-uuid/ticket12489/trac_12489-freemod_eq-nt.patch) by @nthiery created at 2012-02-13 15:44:28



---

archive/issue_comments_144776.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:5 jdemeyer]:\n> {{{\n\n sage -t --long \"devel/sage-main/sage/combinat/sf/dual.py\"\n [...]\n     AssertionError: False is not true\n> }}}\n\nSorry for not catching this ealier ! I didn't launch the `-long` tests during my review.",
    "created_at": "2012-02-13T19:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144776",
    "user": "https://github.com/hivert"
}
```

<a id='comment:9'></a>Replying to [comment:5 jdemeyer]:
> {{{

 sage -t --long "devel/sage-main/sage/combinat/sf/dual.py"
 [...]
     AssertionError: False is not true
> }}}

Sorry for not catching this ealier ! I didn't launch the `-long` tests during my review.



---

archive/issue_comments_144777.json:
```json
{
    "body": "<a id='comment:10'></a>Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?\n\nFlorent",
    "created_at": "2012-02-13T19:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144777",
    "user": "https://github.com/hivert"
}
```

<a id='comment:10'></a>Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?

Florent



---

archive/issue_comments_144778.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 hivert]:\n> Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?\n\n\nYes, that's where I ran the test mentionned above. I'll put sage-combinat-commits in CC next time.",
    "created_at": "2012-02-13T22:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144778",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:11'></a>Replying to [comment:10 hivert]:
> Nicolas: using `dict_linear_combination` is clearly the good solution here. I'm testing all these and will get back to positive review if the tests pass. Do you have auto tests on sageange working the way we had on massena ?


Yes, that's where I ran the test mentionned above. I'll put sage-combinat-commits in CC next time.



---

archive/issue_comments_144779.json:
```json
{
    "body": "<a id='comment:12'></a>I put back to positive review while waiting for the result of the tests.",
    "created_at": "2012-02-14T13:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144779",
    "user": "https://github.com/hivert"
}
```

<a id='comment:12'></a>I put back to positive review while waiting for the result of the tests.



---

archive/issue_comments_144780.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-14T13:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144780",
    "user": "https://github.com/hivert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_144781.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-22T10:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12489#issuecomment-144781",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_033647.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-22T10:46:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12489",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12489#event-33647"
}
```
