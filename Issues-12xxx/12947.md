# Issue 12947: Bug in integrating x*cos(x^3)

archive/issues_012775.json:
```json
{
    "body": "From this [sage-support thread](https://groups.google.com/forum/?fromgroups#!topic/sage-support/-Dzaion3VrA):\n\n```\nsage: numerical_integral(x*cos(x^3),0,.5)\n(0.1247560409610376, 1.3850702913602309e-15)\nsage: integrate(x*cos(x^3),(x,0,1/2)).n()\n-0.0677842754623305\n```\nGiven\n\n```\nsage: integrate(x*cos(x^3),x)\n1/12*((-I*sqrt(3) - 1)*gamma(2/3, -I*x^3) + (I*sqrt(3) - 1)*gamma(2/3, I*x^3))*(x^3)^(1/3)/x\nsage: integrate(x*cos(x^3),(x,0,1/2))\n-1/3*gamma(2/3) + 1/6*gamma(2/3, -1/8*I) + 1/6*gamma(2/3, 1/8*I)\n```\nthis is probably something where Maxima is returning too many imaginary things and something isn't cancelling right either there or in Sage proper?  We've had trouble with either side of this with incomplete gamma functions before.\n\nAssignee: @burcin\n\nCC:  @orlitzky\n\nBranch/Commit: [72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)\n\nReviewer: Ralf Stephan\n\nAuthor: Peter Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12947\n\n",
    "closed_at": "2014-07-19T04:57:53Z",
    "created_at": "2012-05-14T12:33:57Z",
    "labels": [
        "component: calculus",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Bug in integrating x*cos(x^3)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12947",
    "user": "https://github.com/kcrisman"
}
```
From this [sage-support thread](https://groups.google.com/forum/?fromgroups#!topic/sage-support/-Dzaion3VrA):

```
sage: numerical_integral(x*cos(x^3),0,.5)
(0.1247560409610376, 1.3850702913602309e-15)
sage: integrate(x*cos(x^3),(x,0,1/2)).n()
-0.0677842754623305
```
Given

```
sage: integrate(x*cos(x^3),x)
1/12*((-I*sqrt(3) - 1)*gamma(2/3, -I*x^3) + (I*sqrt(3) - 1)*gamma(2/3, I*x^3))*(x^3)^(1/3)/x
sage: integrate(x*cos(x^3),(x,0,1/2))
-1/3*gamma(2/3) + 1/6*gamma(2/3, -1/8*I) + 1/6*gamma(2/3, 1/8*I)
```
this is probably something where Maxima is returning too many imaginary things and something isn't cancelling right either there or in Sage proper?  We've had trouble with either side of this with incomplete gamma functions before.

Assignee: @burcin

CC:  @orlitzky

Branch/Commit: [72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)

Reviewer: Ralf Stephan

Author: Peter Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12947





---

archive/issue_comments_195158.json:
```json
{
    "body": "<a id='comment:1'></a>\n\n```\nsage: assume(u>0)\nsage: integrate(x*cos(x^3),x,0,u)\n-1/3*gamma(2/3) + 1/6*gamma(2/3, -I*u^3) + 1/6*gamma(2/3, I*u^3)\n```\nTo compare the \"right\" answer, do \n\n```\nsage: f(u) = integrate(x*cos(x^3),x,0,u)\nsage: plot(f,(u,0,2*pi))\nsage: plot(lambda u: numerical_integral(x*cos(x^3),0,u)[0],(u,0,2*pi))\n```\nNote how they don't really look quite similar, not really a branch cut thing? Also, in Maxima\n\n```\n(%i2) display2d:false;\n(%o2) false\n(%i3) f:integrate(x*cos(x^3),x);\n(%o3) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6\n(%i5) diff(f,x);\n(%o5) (-3*%i*x*%e^(%i*x^3)/(-1)^(1/6)-3*%i*x*%e^-(%i*x^3)/(-1)^(1/6))/6\n```",
    "created_at": "2012-05-15T02:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195158",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:1'></a>

```
sage: assume(u>0)
sage: integrate(x*cos(x^3),x,0,u)
-1/3*gamma(2/3) + 1/6*gamma(2/3, -I*u^3) + 1/6*gamma(2/3, I*u^3)
```
To compare the "right" answer, do 

```
sage: f(u) = integrate(x*cos(x^3),x,0,u)
sage: plot(f,(u,0,2*pi))
sage: plot(lambda u: numerical_integral(x*cos(x^3),0,u)[0],(u,0,2*pi))
```
Note how they don't really look quite similar, not really a branch cut thing? Also, in Maxima

```
(%i2) display2d:false;
(%o2) false
(%i3) f:integrate(x*cos(x^3),x);
(%o3) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6
(%i5) diff(f,x);
(%o5) (-3*%i*x*%e^(%i*x^3)/(-1)^(1/6)-3*%i*x*%e^-(%i*x^3)/(-1)^(1/6))/6
```



---

archive/issue_comments_195159.json:
```json
{
    "body": "<a id='comment:2'></a>\nRobert Dodier of Maxima suggests the following later in the thread.\n\n```\n\n(%i5) display2d:false;\n\n(%o5) false\n(%i6) integrate(x*cos(x^3),x);\n\n(%o6) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6\n(%i7) domain:complex;\n\n(%o7) complex\n(%i8) integrate(x*cos(x^3),x);\n\n(%o8) ((sqrt(3)*%i-1)*gamma_incomplete(2/3,%i*x^3)\n       +(-sqrt(3)*%i-1)*gamma_incomplete(2/3,-%i*x^3))\n       *(x^3)^(1/3)\n       /(12*x)\n```\nBut this doesn't resolve the original issue.\n\n```\n\n(%i1) display2d:false;\n\n(%o1) false\n(%i2) integrate(x*cos(x^3),x,0,1/2);\n\n(%o2) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3\n(%i3) domain:complex;\n\n(%o3) complex\n(%i4) integrate(x*cos(x^3),x,0,1/2);\n\n(%o4) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3\n```",
    "created_at": "2012-05-15T14:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195159",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:2'></a>
Robert Dodier of Maxima suggests the following later in the thread.

```

(%i5) display2d:false;

(%o5) false
(%i6) integrate(x*cos(x^3),x);

(%o6) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6
(%i7) domain:complex;

(%o7) complex
(%i8) integrate(x*cos(x^3),x);

(%o8) ((sqrt(3)*%i-1)*gamma_incomplete(2/3,%i*x^3)
       +(-sqrt(3)*%i-1)*gamma_incomplete(2/3,-%i*x^3))
       *(x^3)^(1/3)
       /(12*x)
```
But this doesn't resolve the original issue.

```

(%i1) display2d:false;

(%o1) false
(%i2) integrate(x*cos(x^3),x,0,1/2);

(%o2) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3
(%i3) domain:complex;

(%o3) complex
(%i4) integrate(x*cos(x^3),x,0,1/2);

(%o4) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3
```



---

archive/issue_comments_195160.json:
```json
{
    "body": "<a id='comment:3'></a>\nRobert points out that in 5.27.0 this is at least a little better, though we still need to change domain.\n\n```\n\nMaxima 5.27.0 http://maxima.sourceforge.net\nusing Lisp SBCL 1.0.24\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) display2d:false;\n\n(%o1) false\n(%i2) domain:complex;\n\n(%o2) complex\n(%i3) integrate (x*cos(x^3), x, 0, 1/2); \n\n(%o3) %i*gamma_incomplete(2/3,%i/8)/(4*sqrt(3))\n -gamma_incomplete(2/3,%i/8)/12-%i*gamma_incomplete(2/3,-%i/8)/(4*sqrt(3))\n -gamma_incomplete(2/3,-%i/8)/12+gamma(2/3)/6\n(%i4) expand(float(%));\n\n(%o4) .1247560409610377\n```",
    "created_at": "2012-05-15T15:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195160",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:3'></a>
Robert points out that in 5.27.0 this is at least a little better, though we still need to change domain.

```

Maxima 5.27.0 http://maxima.sourceforge.net
using Lisp SBCL 1.0.24
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) display2d:false;

(%o1) false
(%i2) domain:complex;

(%o2) complex
(%i3) integrate (x*cos(x^3), x, 0, 1/2); 

(%o3) %i*gamma_incomplete(2/3,%i/8)/(4*sqrt(3))
 -gamma_incomplete(2/3,%i/8)/12-%i*gamma_incomplete(2/3,-%i/8)/(4*sqrt(3))
 -gamma_incomplete(2/3,-%i/8)/12+gamma(2/3)/6
(%i4) expand(float(%));

(%o4) .1247560409610377
```



---

archive/issue_comments_195161.json:
```json
{
    "body": "<a id='comment:4'></a>\nBut since we already use `domain:complex` in the initialization code for Maxima for integrals and such, presumably an upgrade would fix this?",
    "created_at": "2012-05-15T15:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195161",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>
But since we already use `domain:complex` in the initialization code for Maxima for integrals and such, presumably an upgrade would fix this?



---

archive/issue_comments_195162.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Fixed upstream, in a later stable release.\"",
    "created_at": "2012-05-15T15:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195162",
    "user": "https://github.com/kcrisman"
}
```

Changing upstream from "N/A" to "Fixed upstream, in a later stable release."



---

archive/issue_comments_195163.json:
```json
{
    "body": "<a id='comment:5'></a>\nSee my last comment on #11238 for why we can't have nice things.\n\nThat's the only real issue with maxima-5.27. Some messages are getting mangled e.g. when maxima asks us for more information, but they aren't substantial regressions.",
    "created_at": "2012-05-23T17:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195163",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:5'></a>
See my last comment on #11238 for why we can't have nice things.

That's the only real issue with maxima-5.27. Some messages are getting mangled e.g. when maxima asks us for more information, but they aren't substantial regressions.



---

archive/issue_events_041331.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41331"
}
```



---

archive/issue_events_041332.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41332"
}
```



---

archive/issue_events_041333.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41333"
}
```



---

archive/issue_events_041334.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41334"
}
```



---

archive/issue_events_041335.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41335"
}
```



---

archive/issue_comments_195164.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis seems to have been fixed some time ago; it works correctly in both Sage 5.13 and 6.2.\n\n```\nsage: integrate(x*cos(x^3),(x,0,1/2)).n()\n0.124756040961038\n```",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195164",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:9'></a>
This seems to have been fixed some time ago; it works correctly in both Sage 5.13 and 6.2.

```
sage: integrate(x*cos(x^3),(x,0,1/2)).n()
0.124756040961038
```



---

archive/issue_comments_195165.json:
```json
{
    "body": "Changing upstream from \"Fixed upstream, in a later stable release.\" to \"N/A\"",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195165",
    "user": "https://github.com/pjbruin"
}
```

Changing upstream from "Fixed upstream, in a later stable release." to "N/A"



---

archive/issue_comments_195166.json:
```json
{
    "body": "Changing work_issues from \"\" to \"add doctest\"",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195166",
    "user": "https://github.com/pjbruin"
}
```

Changing work_issues from "" to "add doctest"



---

archive/issue_comments_195167.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195167",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195168.json:
```json
{
    "body": "Changing work_issues from \"add doctest\" to \"\"",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195168",
    "user": "https://github.com/pjbruin"
}
```

Changing work_issues from "add doctest" to ""



---

archive/issue_comments_195169.json:
```json
{
    "body": "Changing branch from \"\" to \"u/pbruin/12947-maxima_integral\"",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195169",
    "user": "https://github.com/pjbruin"
}
```

Changing branch from "" to "u/pbruin/12947-maxima_integral"



---

archive/issue_comments_195170.json:
```json
{
    "body": "Changing author from \"\" to \"Peter Bruin\"",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195170",
    "user": "https://github.com/pjbruin"
}
```

Changing author from "" to "Peter Bruin"



---

archive/issue_comments_195171.json:
```json
{
    "body": "Changing commit from \"\" to \"35f60813c540f3eaabc45200f3e61f3a227ad1d2\"",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195171",
    "user": "https://github.com/pjbruin"
}
```

Changing commit from "" to "35f60813c540f3eaabc45200f3e61f3a227ad1d2"



---

archive/issue_comments_195172.json:
```json
{
    "body": "<a id='comment:11'></a>\nFunny I get:\n\n```\nFile \"src/sage/interfaces/maxima_lib.py\", line 736, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 + 2.77555756156289e-17*I\n```\nPlease set positive when you think this is resolved.",
    "created_at": "2014-05-31T08:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195172",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
Funny I get:

```
File "src/sage/interfaces/maxima_lib.py", line 736, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()
Expected:
    0.124756040961038
Got:
    0.124756040961038 + 2.77555756156289e-17*I
```
Please set positive when you think this is resolved.



---

archive/issue_comments_195173.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ralf Stephan\"",
    "created_at": "2014-05-31T08:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195173",
    "user": "https://github.com/rwst"
}
```

Changing reviewer from "" to "Ralf Stephan"



---

archive/issue_comments_195174.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|\n|[3d9a07c](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)|`Trac 12947: add tolerance to doctest`|",
    "created_at": "2014-05-31T10:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195174",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
|[3d9a07c](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)|`Trac 12947: add tolerance to doctest`|



---

archive/issue_comments_195175.json:
```json
{
    "body": "Changing commit from \"35f60813c540f3eaabc45200f3e61f3a227ad1d2\" to \"3d9a07cd45fd002020a1f67cb2394af5a38d76a0\"",
    "created_at": "2014-05-31T10:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195175",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "35f60813c540f3eaabc45200f3e61f3a227ad1d2" to "3d9a07cd45fd002020a1f67cb2394af5a38d76a0"



---

archive/issue_comments_195176.json:
```json
{
    "body": "<a id='comment:13'></a>\nOn the system I tested this on (GNU/Linux x86_64) this gives the expected answer, both with and without the Maxima upgrade of #13973.  I just checked on ARM; the first time I got the same answer as you, but then I merged this branch (did not even rebuild) and only got the expected answer from then on.  I added `# abs tol 1e-16`; can you check if this solves the problem for you?",
    "created_at": "2014-05-31T10:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195176",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
On the system I tested this on (GNU/Linux x86_64) this gives the expected answer, both with and without the Maxima upgrade of #13973.  I just checked on ARM; the first time I got the same answer as you, but then I merged this branch (did not even rebuild) and only got the expected answer from then on.  I added `# abs tol 1e-16`; can you check if this solves the problem for you?



---

archive/issue_comments_195177.json:
```json
{
    "body": "<a id='comment:14'></a>\nI would argue that the complex bit means that we are not quite ready to merge this if it happens on some platforms.  The question is whether this is a Maxima bug or a Sage/Pynac simplification bug.",
    "created_at": "2014-05-31T13:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195177",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:14'></a>
I would argue that the complex bit means that we are not quite ready to merge this if it happens on some platforms.  The question is whether this is a Maxima bug or a Sage/Pynac simplification bug.



---

archive/issue_comments_195178.json:
```json
{
    "body": "<a id='comment:15'></a>\nWould you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.",
    "created_at": "2014-05-31T13:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195178",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>
Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.



---

archive/issue_comments_195179.json:
```json
{
    "body": "<a id='comment:16'></a>\nThere are 60(!) lines in the sage code with `# abs tol` and nearly all have lower tolerance (in the sense of 'larger error')",
    "created_at": "2014-05-31T13:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195179",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>
There are 60(!) lines in the sage code with `# abs tol` and nearly all have lower tolerance (in the sense of 'larger error')



---

archive/issue_comments_195180.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe complex bit apparently comes from applying Pynac's `evalf()` to the following expression:\n\n```\nsage: e = integrate(x*cos(x^3),(x,0,1/2)); e\n1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)\nsage: e.n(53)\n0.124756040961038 + 2.77555756156289e-17*I\nsage: e._convert({'parent': CC})  # called by .n()\n0.124756040961038 + 2.77555756156289e-17*I\n```\n(This is on ARM; the imaginary part does not appear on x86_64.)\n\nThere are known precision problems in the incomplete Gamma function, so this may be related to #7099, although we only want the default 53 bits of precision here.",
    "created_at": "2014-05-31T13:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195180",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>
The complex bit apparently comes from applying Pynac's `evalf()` to the following expression:

```
sage: e = integrate(x*cos(x^3),(x,0,1/2)); e
1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)
sage: e.n(53)
0.124756040961038 + 2.77555756156289e-17*I
sage: e._convert({'parent': CC})  # called by .n()
0.124756040961038 + 2.77555756156289e-17*I
```
(This is on ARM; the imaginary part does not appear on x86_64.)

There are known precision problems in the incomplete Gamma function, so this may be related to #7099, although we only want the default 53 bits of precision here.



---

archive/issue_comments_195181.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe presence of the imaginary part does not depend on #7099.  At least on ARM it is essentially random (maybe it depends on FPU rounding flags or something similar):\n\n```\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 - 2.77555756156289e-17*I\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 - 1.38777878078145e-17*I\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 + 1.38777878078145e-17*I\n```",
    "created_at": "2014-05-31T15:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195181",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:18'></a>
The presence of the imaginary part does not depend on #7099.  At least on ARM it is essentially random (maybe it depends on FPU rounding flags or something similar):

```
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 - 2.77555756156289e-17*I
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 - 1.38777878078145e-17*I
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 + 1.38777878078145e-17*I
```



---

archive/issue_comments_195182.json:
```json
{
    "body": "<a id='comment:19'></a>\n> Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.\n\nHaha!  No, but as I said sometimes the complex bit indicates a different kind of problem, or has in the past.  Given Peter's experiment in[comment:18](#comment%3A18), though, I guess we can make that a different ticket.",
    "created_at": "2014-06-01T01:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195182",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:19'></a>
> Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.

Haha!  No, but as I said sometimes the complex bit indicates a different kind of problem, or has in the past.  Given Peter's experiment in[comment:18](#comment%3A18), though, I guess we can make that a different ticket.



---

archive/issue_comments_195183.json:
```json
{
    "body": "<a id='comment:20'></a>\nThe imaginary part turns out to be \"simply\" the fact that floating-point addition is not associative, and for some reason the terms in the expression `e` from[comment:17](#comment%3A17) are added in random order by `.n()`.\n\n```\nsage: e = integrate(x*cos(x^3),(x,0,1/2)); e\n1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)\nsage: v = [term.n() for term in e.operands()]; v\n[0.0454319516149362 + 0.166098636946833*I,\n 0.0454319516149362 - 0.166098636946833*I,\n -0.0958970927532841 + 0.0262301494946934*I,\n -0.0958970927532841 - 0.0262301494946934*I,\n 0.225686323237733]\nsage: uniq([sum(p.action(v)) for p in permutations(5)])\n[0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038 - 1.38777878078145e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 1.38777878078145e-17*I,\n 0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038 - 1.38777878078145e-17*I,\n 0.124756040961038 + 1.38777878078145e-17*I,\n 0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038]\n```\nThis gives 14 different outcomes depending on the summation order (some of the differences are hidden due to the number of digits printed).  I don't think this can be solved easily, so I propose we stick to the `# abs tol` fix.",
    "created_at": "2014-06-02T00:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195183",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:20'></a>
The imaginary part turns out to be "simply" the fact that floating-point addition is not associative, and for some reason the terms in the expression `e` from[comment:17](#comment%3A17) are added in random order by `.n()`.

```
sage: e = integrate(x*cos(x^3),(x,0,1/2)); e
1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)
sage: v = [term.n() for term in e.operands()]; v
[0.0454319516149362 + 0.166098636946833*I,
 0.0454319516149362 - 0.166098636946833*I,
 -0.0958970927532841 + 0.0262301494946934*I,
 -0.0958970927532841 - 0.0262301494946934*I,
 0.225686323237733]
sage: uniq([sum(p.action(v)) for p in permutations(5)])
[0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038 - 1.38777878078145e-17*I,
 0.124756040961038,
 0.124756040961038 + 1.38777878078145e-17*I,
 0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038 - 1.38777878078145e-17*I,
 0.124756040961038 + 1.38777878078145e-17*I,
 0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038]
```
This gives 14 different outcomes depending on the summation order (some of the differences are hidden due to the number of digits printed).  I don't think this can be solved easily, so I propose we stick to the `# abs tol` fix.



---

archive/issue_comments_195184.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|\n|[8274e47](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)|`Merge branch 'develop' into ticket/12947-numerical_integral`|",
    "created_at": "2014-06-11T22:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
|[8274e47](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)|`Merge branch 'develop' into ticket/12947-numerical_integral`|



---

archive/issue_comments_195185.json:
```json
{
    "body": "Changing commit from \"3d9a07cd45fd002020a1f67cb2394af5a38d76a0\" to \"8274e4764945e773078535aabe9f262462416e57\"",
    "created_at": "2014-06-11T22:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195185",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3d9a07cd45fd002020a1f67cb2394af5a38d76a0" to "8274e4764945e773078535aabe9f262462416e57"



---

archive/issue_comments_195186.json:
```json
{
    "body": "<a id='comment:22'></a>\nAs already said ...",
    "created_at": "2014-06-29T08:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195186",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>
As already said ...



---

archive/issue_comments_195187.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-29T08:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195187",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_195188.json:
```json
{
    "body": "<a id='comment:23'></a>\nThe `# abs tol` just changes how the floating point numbers are compared, it doesn't know about complex numbers. \n\n```\nsage -t --long src/sage/interfaces/maxima_lib.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_lib.py\", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 - 1.38777878078145e-17*I\n**********************************************************************\n```\nand on a different machine\n\n```\nsage -t --long src/sage/interfaces/maxima_lib.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_lib.py\", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 - 2.77555756156289e-17*I\n**********************************************************************\n```",
    "created_at": "2014-06-30T13:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195188",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
The `# abs tol` just changes how the floating point numbers are compared, it doesn't know about complex numbers. 

```
sage -t --long src/sage/interfaces/maxima_lib.py
**********************************************************************
File "src/sage/interfaces/maxima_lib.py", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16
Expected:
    0.124756040961038
Got:
    0.124756040961038 - 1.38777878078145e-17*I
**********************************************************************
```
and on a different machine

```
sage -t --long src/sage/interfaces/maxima_lib.py
**********************************************************************
File "src/sage/interfaces/maxima_lib.py", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16
Expected:
    0.124756040961038
Got:
    0.124756040961038 - 2.77555756156289e-17*I
**********************************************************************
```



---

archive/issue_comments_195189.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-06-30T13:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195189",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_195190.json:
```json
{
    "body": "Changing commit from \"8274e4764945e773078535aabe9f262462416e57\" to \"72706eb6697fba361e138ddaca0765f8415eb8f3\"",
    "created_at": "2014-07-18T15:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8274e4764945e773078535aabe9f262462416e57" to "72706eb6697fba361e138ddaca0765f8415eb8f3"



---

archive/issue_comments_195191.json:
```json
{
    "body": "<a id='comment:25'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[72706eb](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)|`Trac 12947: handle numerical noise correctly`|",
    "created_at": "2014-07-18T15:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[72706eb](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)|`Trac 12947: handle numerical noise correctly`|



---

archive/issue_comments_195192.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-07-18T15:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195192",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_195193.json:
```json
{
    "body": "<a id='comment:26'></a>\nThis should solve it; probably no reason to ask for another review.",
    "created_at": "2014-07-18T15:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195193",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:26'></a>
This should solve it; probably no reason to ask for another review.



---

archive/issue_comments_195194.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-07-19T04:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195194",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_195195.json:
```json
{
    "body": "Changing branch from \"u/pbruin/12947-maxima_integral\" to \"72706eb6697fba361e138ddaca0765f8415eb8f3\"",
    "created_at": "2014-07-19T04:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12947#issuecomment-195195",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/pbruin/12947-maxima_integral" to "72706eb6697fba361e138ddaca0765f8415eb8f3"



---

archive/issue_events_041336.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-19T04:57:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12947",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12947#event-41336"
}
```
