# Issue 12947: Bug in integrating x*cos(x^3)

archive/issues_012775.json:
```json
{
    "body": "From this [sage-support thread](https://groups.google.com/forum/?fromgroups#!topic/sage-support/-Dzaion3VrA):\n\n```\nsage: numerical_integral(x*cos(x^3),0,.5)\n(0.1247560409610376, 1.3850702913602309e-15)\nsage: integrate(x*cos(x^3),(x,0,1/2)).n()\n-0.0677842754623305\n```\nGiven\n\n```\nsage: integrate(x*cos(x^3),x)\n1/12*((-I*sqrt(3) - 1)*gamma(2/3, -I*x^3) + (I*sqrt(3) - 1)*gamma(2/3, I*x^3))*(x^3)^(1/3)/x\nsage: integrate(x*cos(x^3),(x,0,1/2))\n-1/3*gamma(2/3) + 1/6*gamma(2/3, -1/8*I) + 1/6*gamma(2/3, 1/8*I)\n```\nthis is probably something where Maxima is returning too many imaginary things and something isn't cancelling right either there or in Sage proper?  We've had trouble with either side of this with incomplete gamma functions before.\n\n**Assignee:** @burcin\n\n**CC:**  @orlitzky\n\n**Branch/Commit:** [72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)\n\n**Reviewer:** Ralf Stephan\n\n**Author:** Peter Bruin\n\nIssue created by migration from https://trac.sagemath.org/ticket/12947\n\n",
    "closed_at": "2014-07-19T04:57:53Z",
    "created_at": "2012-05-14T12:33:57Z",
    "labels": [
        "component: calculus",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.3",
    "title": "Bug in integrating x*cos(x^3)",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/12947",
    "user": "https://github.com/kcrisman"
}
```
From this [sage-support thread](https://groups.google.com/forum/?fromgroups#!topic/sage-support/-Dzaion3VrA):

```
sage: numerical_integral(x*cos(x^3),0,.5)
(0.1247560409610376, 1.3850702913602309e-15)
sage: integrate(x*cos(x^3),(x,0,1/2)).n()
-0.0677842754623305
```
Given

```
sage: integrate(x*cos(x^3),x)
1/12*((-I*sqrt(3) - 1)*gamma(2/3, -I*x^3) + (I*sqrt(3) - 1)*gamma(2/3, I*x^3))*(x^3)^(1/3)/x
sage: integrate(x*cos(x^3),(x,0,1/2))
-1/3*gamma(2/3) + 1/6*gamma(2/3, -1/8*I) + 1/6*gamma(2/3, 1/8*I)
```
this is probably something where Maxima is returning too many imaginary things and something isn't cancelling right either there or in Sage proper?  We've had trouble with either side of this with incomplete gamma functions before.

**Assignee:** @burcin

**CC:**  @orlitzky

**Branch/Commit:** [72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)

**Reviewer:** Ralf Stephan

**Author:** Peter Bruin

Issue created by migration from https://trac.sagemath.org/ticket/12947





---

archive/issue_comments_148973.json:
```json
{
    "body": "<a id='comment:1'></a>\n\n```\nsage: assume(u>0)\nsage: integrate(x*cos(x^3),x,0,u)\n-1/3*gamma(2/3) + 1/6*gamma(2/3, -I*u^3) + 1/6*gamma(2/3, I*u^3)\n```\nTo compare the \"right\" answer, do \n\n```\nsage: f(u) = integrate(x*cos(x^3),x,0,u)\nsage: plot(f,(u,0,2*pi))\nsage: plot(lambda u: numerical_integral(x*cos(x^3),0,u)[0],(u,0,2*pi))\n```\nNote how they don't really look quite similar, not really a branch cut thing? Also, in Maxima\n\n```\n(%i2) display2d:false;\n(%o2) false\n(%i3) f:integrate(x*cos(x^3),x);\n(%o3) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6\n(%i5) diff(f,x);\n(%o5) (-3*%i*x*%e^(%i*x^3)/(-1)^(1/6)-3*%i*x*%e^-(%i*x^3)/(-1)^(1/6))/6\n```",
    "created_at": "2012-05-15T02:30:47Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148973",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:1'></a>

```
sage: assume(u>0)
sage: integrate(x*cos(x^3),x,0,u)
-1/3*gamma(2/3) + 1/6*gamma(2/3, -I*u^3) + 1/6*gamma(2/3, I*u^3)
```
To compare the "right" answer, do 

```
sage: f(u) = integrate(x*cos(x^3),x,0,u)
sage: plot(f,(u,0,2*pi))
sage: plot(lambda u: numerical_integral(x*cos(x^3),0,u)[0],(u,0,2*pi))
```
Note how they don't really look quite similar, not really a branch cut thing? Also, in Maxima

```
(%i2) display2d:false;
(%o2) false
(%i3) f:integrate(x*cos(x^3),x);
(%o3) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6
(%i5) diff(f,x);
(%o5) (-3*%i*x*%e^(%i*x^3)/(-1)^(1/6)-3*%i*x*%e^-(%i*x^3)/(-1)^(1/6))/6
```



---

archive/issue_comments_148974.json:
```json
{
    "body": "<a id='comment:2'></a>\nRobert Dodier of Maxima suggests the following later in the thread.\n\n```\n\n(%i5) display2d:false;\n\n(%o5) false\n(%i6) integrate(x*cos(x^3),x);\n\n(%o6) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6\n(%i7) domain:complex;\n\n(%o7) complex\n(%i8) integrate(x*cos(x^3),x);\n\n(%o8) ((sqrt(3)*%i-1)*gamma_incomplete(2/3,%i*x^3)\n       +(-sqrt(3)*%i-1)*gamma_incomplete(2/3,-%i*x^3))\n       *(x^3)^(1/3)\n       /(12*x)\n```\nBut this doesn't resolve the original issue.\n\n```\n\n(%i1) display2d:false;\n\n(%o1) false\n(%i2) integrate(x*cos(x^3),x,0,1/2);\n\n(%o2) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3\n(%i3) domain:complex;\n\n(%o3) complex\n(%i4) integrate(x*cos(x^3),x,0,1/2);\n\n(%o4) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3\n```",
    "created_at": "2012-05-15T14:04:13Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148974",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:2'></a>
Robert Dodier of Maxima suggests the following later in the thread.

```

(%i5) display2d:false;

(%o5) false
(%i6) integrate(x*cos(x^3),x);

(%o6) (gamma_incomplete(2/3,%i*x^3)+gamma_incomplete(2/3,-%i*x^3))/6
(%i7) domain:complex;

(%o7) complex
(%i8) integrate(x*cos(x^3),x);

(%o8) ((sqrt(3)*%i-1)*gamma_incomplete(2/3,%i*x^3)
       +(-sqrt(3)*%i-1)*gamma_incomplete(2/3,-%i*x^3))
       *(x^3)^(1/3)
       /(12*x)
```
But this doesn't resolve the original issue.

```

(%i1) display2d:false;

(%o1) false
(%i2) integrate(x*cos(x^3),x,0,1/2);

(%o2) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3
(%i3) domain:complex;

(%o3) complex
(%i4) integrate(x*cos(x^3),x,0,1/2);

(%o4) gamma_incomplete(2/3,%i/8)/6+gamma_incomplete(2/3,-%i/8)/6-gamma(2/3)/3
```



---

archive/issue_comments_148975.json:
```json
{
    "body": "<a id='comment:3'></a>\nRobert points out that in 5.27.0 this is at least a little better, though we still need to change domain.\n\n```\n\nMaxima 5.27.0 http://maxima.sourceforge.net\nusing Lisp SBCL 1.0.24\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) display2d:false;\n\n(%o1) false\n(%i2) domain:complex;\n\n(%o2) complex\n(%i3) integrate (x*cos(x^3), x, 0, 1/2); \n\n(%o3) %i*gamma_incomplete(2/3,%i/8)/(4*sqrt(3))\n -gamma_incomplete(2/3,%i/8)/12-%i*gamma_incomplete(2/3,-%i/8)/(4*sqrt(3))\n -gamma_incomplete(2/3,-%i/8)/12+gamma(2/3)/6\n(%i4) expand(float(%));\n\n(%o4) .1247560409610377\n```",
    "created_at": "2012-05-15T15:46:01Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148975",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:3'></a>
Robert points out that in 5.27.0 this is at least a little better, though we still need to change domain.

```

Maxima 5.27.0 http://maxima.sourceforge.net
using Lisp SBCL 1.0.24
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) display2d:false;

(%o1) false
(%i2) domain:complex;

(%o2) complex
(%i3) integrate (x*cos(x^3), x, 0, 1/2); 

(%o3) %i*gamma_incomplete(2/3,%i/8)/(4*sqrt(3))
 -gamma_incomplete(2/3,%i/8)/12-%i*gamma_incomplete(2/3,-%i/8)/(4*sqrt(3))
 -gamma_incomplete(2/3,-%i/8)/12+gamma(2/3)/6
(%i4) expand(float(%));

(%o4) .1247560409610377
```



---

archive/issue_comments_148976.json:
```json
{
    "body": "<a id='comment:4'></a>\nBut since we already use `domain:complex` in the initialization code for Maxima for integrals and such, presumably an upgrade would fix this?",
    "created_at": "2012-05-15T15:50:12Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148976",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>
But since we already use `domain:complex` in the initialization code for Maxima for integrals and such, presumably an upgrade would fix this?



---

archive/issue_comments_148977.json:
```json
{
    "body": "**Upstream:** Fixed upstream, in a later stable release.",
    "created_at": "2012-05-15T15:50:12Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148977",
    "user": "https://github.com/kcrisman"
}
```

**Upstream:** Fixed upstream, in a later stable release.



---

archive/issue_comments_148978.json:
```json
{
    "body": "<a id='comment:5'></a>\nSee my last comment on #11238 for why we can't have nice things.\n\nThat's the only real issue with maxima-5.27. Some messages are getting mangled e.g. when maxima asks us for more information, but they aren't substantial regressions.",
    "created_at": "2012-05-23T17:40:09Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148978",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:5'></a>
See my last comment on #11238 for why we can't have nice things.

That's the only real issue with maxima-5.27. Some messages are getting mangled e.g. when maxima asks us for more information, but they aren't substantial regressions.



---

archive/issue_events_108423.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108423"
}
```



---

archive/issue_events_108424.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108424"
}
```



---

archive/issue_events_108425.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108425"
}
```



---

archive/issue_events_108426.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108426"
}
```



---

archive/issue_events_108427.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108427"
}
```



---

archive/issue_events_108428.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108428"
}
```



---

archive/issue_events_108429.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-30T22:49:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "trivial",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108429"
}
```



---

archive/issue_comments_148979.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis seems to have been fixed some time ago; it works correctly in both Sage 5.13 and 6.2.\n\n```\nsage: integrate(x*cos(x^3),(x,0,1/2)).n()\n0.124756040961038\n```",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148979",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:9'></a>
This seems to have been fixed some time ago; it works correctly in both Sage 5.13 and 6.2.

```
sage: integrate(x*cos(x^3),(x,0,1/2)).n()
0.124756040961038
```



---

archive/issue_comments_148980.json:
```json
{
    "body": "**Changing upstream** from \"Fixed upstream, in a later stable release.\" to \"\".",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148980",
    "user": "https://github.com/pjbruin"
}
```

**Changing upstream** from "Fixed upstream, in a later stable release." to "".



---

archive/issue_comments_148981.json:
```json
{
    "body": "**Work Issues:** add doctest",
    "created_at": "2014-05-30T22:49:36Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148981",
    "user": "https://github.com/pjbruin"
}
```

**Work Issues:** add doctest



---

archive/issue_events_108430.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-30T23:09:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108430"
}
```



---

archive/issue_comments_148982.json:
```json
{
    "body": "**Changing work issues** from \"add doctest\" to \"\".",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148982",
    "user": "https://github.com/pjbruin"
}
```

**Changing work issues** from "add doctest" to "".



---

archive/issue_comments_148983.json:
```json
{
    "body": "**Branch:** [u/pbruin/12947-maxima_integral](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12947-maxima_integral)",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148983",
    "user": "https://github.com/pjbruin"
}
```

**Branch:** [u/pbruin/12947-maxima_integral](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12947-maxima_integral)



---

archive/issue_comments_148984.json:
```json
{
    "body": "**Author:** Peter Bruin",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148984",
    "user": "https://github.com/pjbruin"
}
```

**Author:** Peter Bruin



---

archive/issue_comments_148985.json:
```json
{
    "body": "**Commit:** [35f60813c540f3eaabc45200f3e61f3a227ad1d2](https://github.com/sagemath/sagetrac-mirror/commit/35f60813c540f3eaabc45200f3e61f3a227ad1d2)",
    "created_at": "2014-05-30T23:09:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148985",
    "user": "https://github.com/pjbruin"
}
```

**Commit:** [35f60813c540f3eaabc45200f3e61f3a227ad1d2](https://github.com/sagemath/sagetrac-mirror/commit/35f60813c540f3eaabc45200f3e61f3a227ad1d2)



---

archive/issue_comments_148986.json:
```json
{
    "body": "<a id='comment:11'></a>\nFunny I get:\n\n```\nFile \"src/sage/interfaces/maxima_lib.py\", line 736, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 + 2.77555756156289e-17*I\n```\nPlease set positive when you think this is resolved.",
    "created_at": "2014-05-31T08:13:27Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148986",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
Funny I get:

```
File "src/sage/interfaces/maxima_lib.py", line 736, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()
Expected:
    0.124756040961038
Got:
    0.124756040961038 + 2.77555756156289e-17*I
```
Please set positive when you think this is resolved.



---

archive/issue_comments_148987.json:
```json
{
    "body": "**Reviewer:** Ralf Stephan",
    "created_at": "2014-05-31T08:13:27Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148987",
    "user": "https://github.com/rwst"
}
```

**Reviewer:** Ralf Stephan



---

archive/issue_comments_148988.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0\">3d9a07c</a></td><td><code>Trac 12947: add tolerance to doctest</code></td></tr></table>\n",
    "created_at": "2014-05-31T10:04:39Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0">3d9a07c</a></td><td><code>Trac 12947: add tolerance to doctest</code></td></tr></table>




---

archive/issue_comments_148989.json:
```json
{
    "body": "**Changing commit** from \"[35f60813c540f3eaabc45200f3e61f3a227ad1d2](https://github.com/sagemath/sagetrac-mirror/commit/35f60813c540f3eaabc45200f3e61f3a227ad1d2)\" to \"[3d9a07cd45fd002020a1f67cb2394af5a38d76a0](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)\".",
    "created_at": "2014-05-31T10:04:39Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[35f60813c540f3eaabc45200f3e61f3a227ad1d2](https://github.com/sagemath/sagetrac-mirror/commit/35f60813c540f3eaabc45200f3e61f3a227ad1d2)" to "[3d9a07cd45fd002020a1f67cb2394af5a38d76a0](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)".



---

archive/issue_comments_148990.json:
```json
{
    "body": "<a id='comment:13'></a>\nOn the system I tested this on (GNU/Linux x86_64) this gives the expected answer, both with and without the Maxima upgrade of #13973.  I just checked on ARM; the first time I got the same answer as you, but then I merged this branch (did not even rebuild) and only got the expected answer from then on.  I added `# abs tol 1e-16`; can you check if this solves the problem for you?",
    "created_at": "2014-05-31T10:06:08Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148990",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:13'></a>
On the system I tested this on (GNU/Linux x86_64) this gives the expected answer, both with and without the Maxima upgrade of #13973.  I just checked on ARM; the first time I got the same answer as you, but then I merged this branch (did not even rebuild) and only got the expected answer from then on.  I added `# abs tol 1e-16`; can you check if this solves the problem for you?



---

archive/issue_comments_148991.json:
```json
{
    "body": "<a id='comment:14'></a>\nI would argue that the complex bit means that we are not quite ready to merge this if it happens on some platforms.  The question is whether this is a Maxima bug or a Sage/Pynac simplification bug.",
    "created_at": "2014-05-31T13:02:26Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148991",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:14'></a>
I would argue that the complex bit means that we are not quite ready to merge this if it happens on some platforms.  The question is whether this is a Maxima bug or a Sage/Pynac simplification bug.



---

archive/issue_comments_148992.json:
```json
{
    "body": "<a id='comment:15'></a>\nWould you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.",
    "created_at": "2014-05-31T13:08:00Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148992",
    "user": "https://github.com/rwst"
}
```

<a id='comment:15'></a>
Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.



---

archive/issue_comments_148993.json:
```json
{
    "body": "<a id='comment:16'></a>\nThere are 60(!) lines in the sage code with `# abs tol` and nearly all have lower tolerance (in the sense of 'larger error')",
    "created_at": "2014-05-31T13:11:24Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148993",
    "user": "https://github.com/rwst"
}
```

<a id='comment:16'></a>
There are 60(!) lines in the sage code with `# abs tol` and nearly all have lower tolerance (in the sense of 'larger error')



---

archive/issue_comments_148994.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe complex bit apparently comes from applying Pynac's `evalf()` to the following expression:\n\n```\nsage: e = integrate(x*cos(x^3),(x,0,1/2)); e\n1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)\nsage: e.n(53)\n0.124756040961038 + 2.77555756156289e-17*I\nsage: e._convert({'parent': CC})  # called by .n()\n0.124756040961038 + 2.77555756156289e-17*I\n```\n(This is on ARM; the imaginary part does not appear on x86_64.)\n\nThere are known precision problems in the incomplete Gamma function, so this may be related to #7099, although we only want the default 53 bits of precision here.",
    "created_at": "2014-05-31T13:27:33Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148994",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>
The complex bit apparently comes from applying Pynac's `evalf()` to the following expression:

```
sage: e = integrate(x*cos(x^3),(x,0,1/2)); e
1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)
sage: e.n(53)
0.124756040961038 + 2.77555756156289e-17*I
sage: e._convert({'parent': CC})  # called by .n()
0.124756040961038 + 2.77555756156289e-17*I
```
(This is on ARM; the imaginary part does not appear on x86_64.)

There are known precision problems in the incomplete Gamma function, so this may be related to #7099, although we only want the default 53 bits of precision here.



---

archive/issue_comments_148995.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe presence of the imaginary part does not depend on #7099.  At least on ARM it is essentially random (maybe it depends on FPU rounding flags or something similar):\n\n```\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 - 2.77555756156289e-17*I\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 - 1.38777878078145e-17*I\n$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'\n0.124756040961038 + 1.38777878078145e-17*I\n```",
    "created_at": "2014-05-31T15:48:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148995",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:18'></a>
The presence of the imaginary part does not depend on #7099.  At least on ARM it is essentially random (maybe it depends on FPU rounding flags or something similar):

```
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 - 2.77555756156289e-17*I
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 - 1.38777878078145e-17*I
$ ./sage -c 'print integrate(x*cos(x^3),(x,0,1/2)).n()'
0.124756040961038 + 1.38777878078145e-17*I
```



---

archive/issue_comments_148996.json:
```json
{
    "body": "<a id='comment:19'></a>\n> Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.\n\nHaha!  No, but as I said sometimes the complex bit indicates a different kind of problem, or has in the past.  Given Peter's experiment in [comment:18](#comment%3A18), though, I guess we can make that a different ticket.",
    "created_at": "2014-06-01T01:48:35Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148996",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:19'></a>
> Would you equally mind if there is a real digit wrong in the 17-th place? Regardless, it's fine on AMD now.

Haha!  No, but as I said sometimes the complex bit indicates a different kind of problem, or has in the past.  Given Peter's experiment in [comment:18](#comment%3A18), though, I guess we can make that a different ticket.



---

archive/issue_comments_148997.json:
```json
{
    "body": "<a id='comment:20'></a>\nThe imaginary part turns out to be \"simply\" the fact that floating-point addition is not associative, and for some reason the terms in the expression `e` from [comment:17](#comment%3A17) are added in random order by `.n()`.\n\n```\nsage: e = integrate(x*cos(x^3),(x,0,1/2)); e\n1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)\nsage: v = [term.n() for term in e.operands()]; v\n[0.0454319516149362 + 0.166098636946833*I,\n 0.0454319516149362 - 0.166098636946833*I,\n -0.0958970927532841 + 0.0262301494946934*I,\n -0.0958970927532841 - 0.0262301494946934*I,\n 0.225686323237733]\nsage: uniq([sum(p.action(v)) for p in permutations(5)])\n[0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038 - 1.38777878078145e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 1.38777878078145e-17*I,\n 0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038 - 1.38777878078145e-17*I,\n 0.124756040961038 + 1.38777878078145e-17*I,\n 0.124756040961038 - 2.77555756156289e-17*I,\n 0.124756040961038 + 2.77555756156289e-17*I,\n 0.124756040961038]\n```\nThis gives 14 different outcomes depending on the summation order (some of the differences are hidden due to the number of digits printed).  I don't think this can be solved easily, so I propose we stick to the `# abs tol` fix.",
    "created_at": "2014-06-02T00:12:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148997",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:20'></a>
The imaginary part turns out to be "simply" the fact that floating-point addition is not associative, and for some reason the terms in the expression `e` from [comment:17](#comment%3A17) are added in random order by `.n()`.

```
sage: e = integrate(x*cos(x^3),(x,0,1/2)); e
1/12*I*sqrt(3)*gamma(2/3, 1/8*I) - 1/12*I*sqrt(3)*gamma(2/3, -1/8*I) - 1/12*gamma(2/3, 1/8*I) - 1/12*gamma(2/3, -1/8*I) + 1/6*gamma(2/3)
sage: v = [term.n() for term in e.operands()]; v
[0.0454319516149362 + 0.166098636946833*I,
 0.0454319516149362 - 0.166098636946833*I,
 -0.0958970927532841 + 0.0262301494946934*I,
 -0.0958970927532841 - 0.0262301494946934*I,
 0.225686323237733]
sage: uniq([sum(p.action(v)) for p in permutations(5)])
[0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038 - 1.38777878078145e-17*I,
 0.124756040961038,
 0.124756040961038 + 1.38777878078145e-17*I,
 0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038 - 1.38777878078145e-17*I,
 0.124756040961038 + 1.38777878078145e-17*I,
 0.124756040961038 - 2.77555756156289e-17*I,
 0.124756040961038 + 2.77555756156289e-17*I,
 0.124756040961038]
```
This gives 14 different outcomes depending on the summation order (some of the differences are hidden due to the number of digits printed).  I don't think this can be solved easily, so I propose we stick to the `# abs tol` fix.



---

archive/issue_comments_148998.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57\">8274e47</a></td><td><code>Merge branch 'develop' into ticket/12947-numerical_integral</code></td></tr></table>\n",
    "created_at": "2014-06-11T22:37:53Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148998",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57">8274e47</a></td><td><code>Merge branch 'develop' into ticket/12947-numerical_integral</code></td></tr></table>




---

archive/issue_comments_148999.json:
```json
{
    "body": "**Changing commit** from \"[3d9a07cd45fd002020a1f67cb2394af5a38d76a0](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)\" to \"[8274e4764945e773078535aabe9f262462416e57](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)\".",
    "created_at": "2014-06-11T22:37:53Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-148999",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[3d9a07cd45fd002020a1f67cb2394af5a38d76a0](https://github.com/sagemath/sagetrac-mirror/commit/3d9a07cd45fd002020a1f67cb2394af5a38d76a0)" to "[8274e4764945e773078535aabe9f262462416e57](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)".



---

archive/issue_comments_149000.json:
```json
{
    "body": "<a id='comment:22'></a>\nAs already said ...",
    "created_at": "2014-06-29T08:59:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149000",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>
As already said ...



---

archive/issue_events_108431.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-06-29T08:59:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108431"
}
```



---

archive/issue_events_108432.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2014-06-29T08:59:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108432"
}
```



---

archive/issue_comments_149001.json:
```json
{
    "body": "<a id='comment:23'></a>\nThe `# abs tol` just changes how the floating point numbers are compared, it doesn't know about complex numbers. \n\n```\nsage -t --long src/sage/interfaces/maxima_lib.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_lib.py\", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 - 1.38777878078145e-17*I\n**********************************************************************\n```\nand on a different machine\n\n```\nsage -t --long src/sage/interfaces/maxima_lib.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_lib.py\", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16\nExpected:\n    0.124756040961038\nGot:\n    0.124756040961038 - 2.77555756156289e-17*I\n**********************************************************************\n```",
    "created_at": "2014-06-30T13:12:23Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149001",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
The `# abs tol` just changes how the floating point numbers are compared, it doesn't know about complex numbers. 

```
sage -t --long src/sage/interfaces/maxima_lib.py
**********************************************************************
File "src/sage/interfaces/maxima_lib.py", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16
Expected:
    0.124756040961038
Got:
    0.124756040961038 - 1.38777878078145e-17*I
**********************************************************************
```
and on a different machine

```
sage -t --long src/sage/interfaces/maxima_lib.py
**********************************************************************
File "src/sage/interfaces/maxima_lib.py", line 763, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(x*cos(x^3),(x,0,1/2)).n()  # abs tol 1e-16
Expected:
    0.124756040961038
Got:
    0.124756040961038 - 2.77555756156289e-17*I
**********************************************************************
```



---

archive/issue_events_108433.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-30T13:12:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108433"
}
```



---

archive/issue_events_108434.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-30T13:12:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108434"
}
```



---

archive/issue_comments_149002.json:
```json
{
    "body": "**Changing commit** from \"[8274e4764945e773078535aabe9f262462416e57](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)\" to \"[72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)\".",
    "created_at": "2014-07-18T15:25:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8274e4764945e773078535aabe9f262462416e57](https://github.com/sagemath/sagetrac-mirror/commit/8274e4764945e773078535aabe9f262462416e57)" to "[72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)".



---

archive/issue_comments_149003.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3\">72706eb</a></td><td><code>Trac 12947: handle numerical noise correctly</code></td></tr></table>\n",
    "created_at": "2014-07-18T15:25:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149003",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3">72706eb</a></td><td><code>Trac 12947: handle numerical noise correctly</code></td></tr></table>




---

archive/issue_events_108435.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-07-18T15:29:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108435"
}
```



---

archive/issue_events_108436.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-07-18T15:29:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108436"
}
```



---

archive/issue_comments_149004.json:
```json
{
    "body": "<a id='comment:26'></a>\nThis should solve it; probably no reason to ask for another review.",
    "created_at": "2014-07-18T15:29:35Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149004",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:26'></a>
This should solve it; probably no reason to ask for another review.



---

archive/issue_comments_149005.json:
```json
{
    "body": "**Changing branch** from \"[u/pbruin/12947-maxima_integral](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12947-maxima_integral)\" to \"[72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)\".",
    "created_at": "2014-07-19T04:57:53Z",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12947#issuecomment-149005",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/pbruin/12947-maxima_integral](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12947-maxima_integral)" to "[72706eb6697fba361e138ddaca0765f8415eb8f3](https://github.com/sagemath/sagetrac-mirror/commit/72706eb6697fba361e138ddaca0765f8415eb8f3)".



---

archive/issue_events_108437.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-07-19T04:57:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108437"
}
```



---

archive/issue_events_108438.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "dc8130ad612aa9f4f9e4e60839930d52132b8ebd",
    "created_at": "2014-07-19T04:57:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12947",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12947#event-108438"
}
```
