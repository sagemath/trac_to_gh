# Issue 12830: Work around GCC 4.7.0 bug on ia64 and improve the GMP-ECM spkg

archive/issues_012658.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @hedtke justin\n\nKeywords: spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h GCC 4.7.0 ia64 Itanium bug impossible reload\n\nGCC 4.7.0 is broken on ia64 (Itanium), which also affects the GMP-ECM spkg (cf. #12751).\n\n---\n\nAdding `-march=native` to `CFLAGS` may lead to assembler errors, e.g. on MacOS X with newer GCCs on newer CPUs (e.g. such supporting AVX, which Apple's assembler currently doesn't).\n\nNewer versions of MPIR don't define `__GMP_CFLAGS` (in `gmp.h`) to a *string literal*, but instead to a *preprocessor macro* (`__MPIR_CFLAGS`), which in turn is defined to the string we want.\n\n---\n\n**New spkg:** [http://boxen.math.washington.edu/home/leif/Sage/spkgs/ecm-6.3.p7.spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/ecm-6.3.p7.spkg)\n\n**md5sum:** `a5e9a4b47d30c4aba2c77ada47579e1a  ecm-6.3.p7.spkg`\n\n\n### ecm-6.3.p7 (Leif Leonhardy, April 19th 2012)\n* #12830: Add `-m[no-]power*` to the processor-specific options recognized;\n  these are used to enable/disable specific instruction set extensions of the\n  POWER and PowerPC (PPC) CPUs. \n\n### ecm-6.3.p6 (Leif Leonhardy, April 16th 2012)\n* #12830: Add a work-around for GCC 4.7.x on ia64 (Itanium), since GMP-ECM\n  currently won't build with that and anything but `-O0` on that platform.\n* Use `\\{1,\\}` instead of `\\+` in `sed` patterns, which is more portable.\n* Also support newer system-wide MPIR installations for printing their\n  settings.\n* Use `patch` to apply patches.  Since the pre-patched `configure` in\n  `patches/` was created with a newer version of autotools (or, rather, the\n  original `configure` was created with an outdated version), the patch would\n  have been almost as large as the patched `configure` file itself.  Hence\n  I `autoreconf`ed the source tree with a patched `configure.in` (and almost\n  the latest versions of autotools), then created a patch to `configure`\n  from the resulting file(s).  Note that therefore `src/` isn't really vanilla\n  any more, although just the auto-generated files differ (which are still\n  made from vanilla upstream sources, including `configure.in`).\n  Add a \"Patches\" subsection and update \"Special Update/Build Instructions\".\n  Remove files in `patches/` from `.hgignore` (and also remove pre-patched\n  files from that directory); the patch to `configure` and the diff of\n  `configure.in` are [now] under revision control, which IMHO makes sense.\n* Beautify (and simplify) the output with respect to options passed to\n  `configure`; print the settings of a few more environment variables that\n  GMP-ECM uses (in case they're set); add some messages, also mention\n  `--enable-assert` etc. if `SAGE_DEBUG=yes`.\n* Remove unused test for GCC.\n\n### ecm-6.3.p5 (Leif Leonhardy, April 11th 2012)\n* #12830: Don't add `-march=native` if the assembler doesn't understand the\n  instructions the compiler emits with that.  (E.g. the Apple/XCode assembler\n  on Darwin doesn't yet support AVX.)\n* Fix extraction of `__GMP_CC` and `__GMP_CFLAGS` (from `gmp.h`) for newer\n  versions of MPIR, which define these to preprocessor macros rather than\n  strings.\n* Redirect warnings and error messages to `stderr`; add some messages.\n* Correct `SPKG.txt` w.r.t. applied patches.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12830\n\n",
    "closed_at": "2012-04-30T09:52:25Z",
    "created_at": "2012-04-11T11:17:35Z",
    "labels": [
        "component: packages: standard",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Work around GCC 4.7.0 bug on ia64 and improve the GMP-ECM spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12830",
    "user": "https://github.com/nexttime"
}
```
Assignee: @nexttime

CC:  @hedtke justin

Keywords: spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h GCC 4.7.0 ia64 Itanium bug impossible reload

GCC 4.7.0 is broken on ia64 (Itanium), which also affects the GMP-ECM spkg (cf. #12751).

---

Adding `-march=native` to `CFLAGS` may lead to assembler errors, e.g. on MacOS X with newer GCCs on newer CPUs (e.g. such supporting AVX, which Apple's assembler currently doesn't).

Newer versions of MPIR don't define `__GMP_CFLAGS` (in `gmp.h`) to a *string literal*, but instead to a *preprocessor macro* (`__MPIR_CFLAGS`), which in turn is defined to the string we want.

---

**New spkg:** [http://boxen.math.washington.edu/home/leif/Sage/spkgs/ecm-6.3.p7.spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/ecm-6.3.p7.spkg)

**md5sum:** `a5e9a4b47d30c4aba2c77ada47579e1a  ecm-6.3.p7.spkg`


### ecm-6.3.p7 (Leif Leonhardy, April 19th 2012)
* #12830: Add `-m[no-]power*` to the processor-specific options recognized;
  these are used to enable/disable specific instruction set extensions of the
  POWER and PowerPC (PPC) CPUs. 

### ecm-6.3.p6 (Leif Leonhardy, April 16th 2012)
* #12830: Add a work-around for GCC 4.7.x on ia64 (Itanium), since GMP-ECM
  currently won't build with that and anything but `-O0` on that platform.
* Use `\{1,\}` instead of `\+` in `sed` patterns, which is more portable.
* Also support newer system-wide MPIR installations for printing their
  settings.
* Use `patch` to apply patches.  Since the pre-patched `configure` in
  `patches/` was created with a newer version of autotools (or, rather, the
  original `configure` was created with an outdated version), the patch would
  have been almost as large as the patched `configure` file itself.  Hence
  I `autoreconf`ed the source tree with a patched `configure.in` (and almost
  the latest versions of autotools), then created a patch to `configure`
  from the resulting file(s).  Note that therefore `src/` isn't really vanilla
  any more, although just the auto-generated files differ (which are still
  made from vanilla upstream sources, including `configure.in`).
  Add a "Patches" subsection and update "Special Update/Build Instructions".
  Remove files in `patches/` from `.hgignore` (and also remove pre-patched
  files from that directory); the patch to `configure` and the diff of
  `configure.in` are [now] under revision control, which IMHO makes sense.
* Beautify (and simplify) the output with respect to options passed to
  `configure`; print the settings of a few more environment variables that
  GMP-ECM uses (in case they're set); add some messages, also mention
  `--enable-assert` etc. if `SAGE_DEBUG=yes`.
* Remove unused test for GCC.

### ecm-6.3.p5 (Leif Leonhardy, April 11th 2012)
* #12830: Don't add `-march=native` if the assembler doesn't understand the
  instructions the compiler emits with that.  (E.g. the Apple/XCode assembler
  on Darwin doesn't yet support AVX.)
* Fix extraction of `__GMP_CC` and `__GMP_CFLAGS` (from `gmp.h`) for newer
  versions of MPIR, which define these to preprocessor macros rather than
  strings.
* Redirect warnings and error messages to `stderr`; add some messages.
* Correct `SPKG.txt` w.r.t. applied patches.



Issue created by migration from https://trac.sagemath.org/ticket/12830





---

archive/issue_comments_150704.json:
```json
{
    "body": "Attachment [ecm-6.3.p4-p5.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p4-p5.diff) by @nexttime created at 2012-04-11 11:25:28\n\nDiff between the previous spkg in Sage and my new p5 spkg.  For reference / review only.",
    "created_at": "2012-04-11T11:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150704",
    "user": "https://github.com/nexttime"
}
```

Attachment [ecm-6.3.p4-p5.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p4-p5.diff) by @nexttime created at 2012-04-11 11:25:28

Diff between the previous spkg in Sage and my new p5 spkg.  For reference / review only.



---

archive/issue_comments_150705.json:
```json
{
    "body": "This new spkg (also) fixes issues (i.e., assembler errors) on MacOS X with the GCC spkg.\n\nPlease test and review!",
    "created_at": "2012-04-11T11:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150705",
    "user": "https://github.com/nexttime"
}
```

This new spkg (also) fixes issues (i.e., assembler errors) on MacOS X with the GCC spkg.

Please test and review!



---

archive/issue_comments_150706.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-11T11:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150706",
    "user": "https://github.com/nexttime"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_150707.json:
```json
{
    "body": "Instead of copying all this complicated \"detect CFLAGS from MPIR\" stuff, I propose the following: make the MPIR spkg store its $CC and $CFLAGS somewhere (say, in $SAGE_LOCAL/etc/mpirflags) and read that?  That would replace the horrible kludge we have now in this ecm spkg.",
    "created_at": "2012-04-11T11:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150707",
    "user": "https://github.com/jdemeyer"
}
```

Instead of copying all this complicated "detect CFLAGS from MPIR" stuff, I propose the following: make the MPIR spkg store its $CC and $CFLAGS somewhere (say, in $SAGE_LOCAL/etc/mpirflags) and read that?  That would replace the horrible kludge we have now in this ecm spkg.



---

archive/issue_comments_150708.json:
```json
{
    "body": "1. Remove the reading of the system GMP header, as they aren't used anyway (there is no good reason to use them anyway).\n\n   2. Remove `unset RM` which isn't needed anymore.",
    "created_at": "2012-04-11T11:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150708",
    "user": "https://github.com/jdemeyer"
}
```

1. Remove the reading of the system GMP header, as they aren't used anyway (there is no good reason to use them anyway).

   2. Remove `unset RM` which isn't needed anymore.



---

archive/issue_comments_150709.json:
```json
{
    "body": "Concerning `march=native`: what do you think about using `testcflags.sh` for this?  Let's add\n\n```\nunsigned long fancy_insns() { return (unsigned long) d; }\n```\nto the program that `testcflags.sh` uses to check flags.\n\nThen we could do something like\n\n```\nif testcflags.sh -march=native >/dev/null; then\n    CFLAGS=\"-march=native $CFLAGS\"\nelif testcflags.sh \"-march=native -mno-avx\" >/dev/null; then\n    echo >&2 \"Warning bla bla\"\n    CFLAGS=\"-march=native -mno-avx $CFLAGS\"\nfi",
    "created_at": "2012-04-11T11:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150709",
    "user": "https://github.com/jdemeyer"
}
```

Concerning `march=native`: what do you think about using `testcflags.sh` for this?  Let's add

```
unsigned long fancy_insns() { return (unsigned long) d; }
```
to the program that `testcflags.sh` uses to check flags.

Then we could do something like

```
if testcflags.sh -march=native >/dev/null; then
    CFLAGS="-march=native $CFLAGS"
elif testcflags.sh "-march=native -mno-avx" >/dev/null; then
    echo >&2 "Warning bla bla"
    CFLAGS="-march=native -mno-avx $CFLAGS"
fi



---

archive/issue_comments_150710.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Instead of copying all this complicated \"detect CFLAGS from MPIR\" stuff, I propose the following: make the MPIR spkg store its $CC and $CFLAGS somewhere (say, in $SAGE_LOCAL/etc/mpirflags) and read that?  That would replace the horrible kludge we have now in this ecm spkg.\n\n\nWell, using `gmp.h` is the documented, supposed way to do this, and compatible to GMP.\n\nExtracting the flags isn't complicated (nor a kludge); complain to the MPIR developers that they break GMP compatibility even with `--enable-gmpcompat` (as I already did).  The extra code working around this is six lines IIRC, and not really complicated.\n\n\n\n \nIf you want MPIR and GMP to store the flags elsewhere, suggest them to create a `pkg-config` file (although \"standard\" `.pc` files don't have a variable for the compiler used).\n\nWe could of course create our own in MPIR's (and GMP's) `spkg-install`, but that doesn't make much sense to me, since then again our other spkgs using the `.pc` file would depend on Sage's versions (and a recent version of Sage itself).",
    "created_at": "2012-04-11T12:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150710",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:2 jdemeyer]:
> Instead of copying all this complicated "detect CFLAGS from MPIR" stuff, I propose the following: make the MPIR spkg store its $CC and $CFLAGS somewhere (say, in $SAGE_LOCAL/etc/mpirflags) and read that?  That would replace the horrible kludge we have now in this ecm spkg.


Well, using `gmp.h` is the documented, supposed way to do this, and compatible to GMP.

Extracting the flags isn't complicated (nor a kludge); complain to the MPIR developers that they break GMP compatibility even with `--enable-gmpcompat` (as I already did).  The extra code working around this is six lines IIRC, and not really complicated.



 
If you want MPIR and GMP to store the flags elsewhere, suggest them to create a `pkg-config` file (although "standard" `.pc` files don't have a variable for the compiler used).

We could of course create our own in MPIR's (and GMP's) `spkg-install`, but that doesn't make much sense to me, since then again our other spkgs using the `.pc` file would depend on Sage's versions (and a recent version of Sage itself).



---

archive/issue_comments_150711.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n>  1. Remove the reading of the system GMP header, as they aren't used anyway (there is no good reason to use them anyway).\n\n\nIt's for informational purposes; it's not bad to compare (potentially) MPIR's flags to those of a system-wide GMP (or MPIR) installation.\n\n\n>  2. Remove `unset RM` which isn't needed anymore.\n\n\nIt doesn't hurt, and doesn't break anything.\n\nOn the contrary, removing it may break the installation of the spkg on older versions of Sage.",
    "created_at": "2012-04-11T12:39:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150711",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:3 jdemeyer]:
>  1. Remove the reading of the system GMP header, as they aren't used anyway (there is no good reason to use them anyway).


It's for informational purposes; it's not bad to compare (potentially) MPIR's flags to those of a system-wide GMP (or MPIR) installation.


>  2. Remove `unset RM` which isn't needed anymore.


It doesn't hurt, and doesn't break anything.

On the contrary, removing it may break the installation of the spkg on older versions of Sage.



---

archive/issue_comments_150712.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Concerning `march=native`: what do you think about using `testcflags.sh` for this?  Let's add\n> \n> ```\n> unsigned long fancy_insns() { return (unsigned long) d; }\n> ```\n> to the program that `testcflags.sh` uses to check flags.\n> \n> Then we could do something like\n> \n> ```\n> if testcflags.sh -march=native >/dev/null; then\n>     CFLAGS=\"-march=native $CFLAGS\"\n> elif testcflags.sh \"-march=native -mno-avx\" >/dev/null; then\n>     echo >&2 \"Warning bla bla\"\n>     CFLAGS=\"-march=native -mno-avx $CFLAGS\"\n> fi\n\n\nProbably.  Although `testcflags.sh` is currently broken... ;-)\n\nI'm not sure if we should do such a complicated test whenever some arbitrary compiler flag is to be tested.  We'd never know whether the compiler, the assembler or the linker caused an error.\n\nUsing it again requires newer versions of Sage for little reason, which I don't like in general.\n\n\n`testcflags.sh` might have an option to not use `CFLAGS` btw.; otherwise one would have to `(unset CFLAGS; testcflags.sh ...)` or specifically construct `CFLAGS` for the desired purpose.",
    "created_at": "2012-04-11T12:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150712",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:4 jdemeyer]:
> Concerning `march=native`: what do you think about using `testcflags.sh` for this?  Let's add
> 
> ```
> unsigned long fancy_insns() { return (unsigned long) d; }
> ```
> to the program that `testcflags.sh` uses to check flags.
> 
> Then we could do something like
> 
> ```
> if testcflags.sh -march=native >/dev/null; then
>     CFLAGS="-march=native $CFLAGS"
> elif testcflags.sh "-march=native -mno-avx" >/dev/null; then
>     echo >&2 "Warning bla bla"
>     CFLAGS="-march=native -mno-avx $CFLAGS"
> fi


Probably.  Although `testcflags.sh` is currently broken... ;-)

I'm not sure if we should do such a complicated test whenever some arbitrary compiler flag is to be tested.  We'd never know whether the compiler, the assembler or the linker caused an error.

Using it again requires newer versions of Sage for little reason, which I don't like in general.


`testcflags.sh` might have an option to not use `CFLAGS` btw.; otherwise one would have to `(unset CFLAGS; testcflags.sh ...)` or specifically construct `CFLAGS` for the desired purpose.



---

archive/issue_comments_150713.json:
```json
{
    "body": "Replying to [comment:7 leif]:\n> Probably.  Although `testcflags.sh` is currently broken... ;-)\n  \nIn which sense is it broken???\n\n> I'm not sure if we should do such a complicated test whenever some arbitrary compiler flag is to be tested.  We'd never know whether the compiler, the assembler or the linker caused an error.\n\nWhy does it matter whether the compiler, assembler or linker caused the problem?  What matters is that it doesn't work.\n\n> Using it again requires newer versions of Sage for little reason, which I don't like in general.\n\nThat I noticed :-)\n\nUsing `testcflags.sh` looks like the cleaner and simpler solution to me.\n\n> `testcflags.sh` might have an option to not use `CFLAGS` btw.; otherwise one would have to `(unset CFLAGS; testcflags.sh ...)` or specifically construct `CFLAGS` for the desired purpose.\n\nI think \n\n```\nCFLAGS= testcflags.sh -flag\n```\nis simple enough.",
    "created_at": "2012-04-11T13:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150713",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 leif]:
> Probably.  Although `testcflags.sh` is currently broken... ;-)
  
In which sense is it broken???

> I'm not sure if we should do such a complicated test whenever some arbitrary compiler flag is to be tested.  We'd never know whether the compiler, the assembler or the linker caused an error.

Why does it matter whether the compiler, assembler or linker caused the problem?  What matters is that it doesn't work.

> Using it again requires newer versions of Sage for little reason, which I don't like in general.

That I noticed :-)

Using `testcflags.sh` looks like the cleaner and simpler solution to me.

> `testcflags.sh` might have an option to not use `CFLAGS` btw.; otherwise one would have to `(unset CFLAGS; testcflags.sh ...)` or specifically construct `CFLAGS` for the desired purpose.

I think 

```
CFLAGS= testcflags.sh -flag
```
is simple enough.



---

archive/issue_comments_150714.json:
```json
{
    "body": "What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.  Moreover, it would ensure that we don't need to change the ECM spkg (or any other) if either Sage or MPIR changes the CFLAGS handling for MPIR.  We would only need to change the MPIR spkg.",
    "created_at": "2012-04-16T09:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150714",
    "user": "https://github.com/jdemeyer"
}
```

What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.  Moreover, it would ensure that we don't need to change the ECM spkg (or any other) if either Sage or MPIR changes the CFLAGS handling for MPIR.  We would only need to change the MPIR spkg.



---

archive/issue_comments_150715.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.\n\n\nWhy reinvent the wheel?\n\n(And reading `gmp.h` isn't complicated at all, presumably because doing so is intended...)\n\n\n\n\n> Moreover, it would ensure that we don't need to change the ECM spkg (or any other) if either Sage or MPIR changes the CFLAGS handling for MPIR.  We would only need to change the MPIR spkg.\n\n\nI don't see the point.  First of all, that would be incompatible to any other MPIR or GMP installation / package, and we'd certainly have to change all packages using such a file whenever we change \"Sage's format\" (or handling) of MPIR's flags / settings.",
    "created_at": "2012-04-16T13:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150715",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:9 jdemeyer]:
> What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.


Why reinvent the wheel?

(And reading `gmp.h` isn't complicated at all, presumably because doing so is intended...)




> Moreover, it would ensure that we don't need to change the ECM spkg (or any other) if either Sage or MPIR changes the CFLAGS handling for MPIR.  We would only need to change the MPIR spkg.


I don't see the point.  First of all, that would be incompatible to any other MPIR or GMP installation / package, and we'd certainly have to change all packages using such a file whenever we change "Sage's format" (or handling) of MPIR's flags / settings.



---

archive/issue_comments_150716.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> Replying to [comment:9 jdemeyer]:\n> > What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.\n\n> \n> Why reinvent the wheel?\n\nYou are already reinventing the wheel by manually `sed`ding the flags out of the header file, as opposed to using autoconf.  So if we reinvent the wheel, let's reinvent it as simple as possible.",
    "created_at": "2012-04-16T14:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150716",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:10 leif]:
> Replying to [comment:9 jdemeyer]:
> > What's wrong with simply storing MPIR's flags in some easy-to-read file?  That would be the most simple solution.

> 
> Why reinvent the wheel?

You are already reinventing the wheel by manually `sed`ding the flags out of the header file, as opposed to using autoconf.  So if we reinvent the wheel, let's reinvent it as simple as possible.



---

archive/issue_comments_150717.json:
```json
{
    "body": "Besides, your wheel is broken as `\\+` in `sed` scripts isn't portable.",
    "created_at": "2012-04-16T14:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150717",
    "user": "https://github.com/jdemeyer"
}
```

Besides, your wheel is broken as `\+` in `sed` scripts isn't portable.



---

archive/issue_comments_150718.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-16T14:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150718",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_150719.json:
```json
{
    "body": "Attachment [ecm-6.3.p5-p6.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p5-p6.diff) by @nexttime created at 2012-04-16 22:36:03\n\nDiff between my p5 and p6 spkgs.  For reference / review only.",
    "created_at": "2012-04-16T22:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150719",
    "user": "https://github.com/nexttime"
}
```

Attachment [ecm-6.3.p5-p6.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p5-p6.diff) by @nexttime created at 2012-04-16 22:36:03

Diff between my p5 and p6 spkgs.  For reference / review only.



---

archive/issue_comments_150720.json:
```json
{
    "body": "Attachment [ecm-6.3.p4-p6.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p4-p6.diff) by @nexttime created at 2012-04-16 22:36:51\n\nDiff between the previous spkg in Sage and my new p6 spkg.  For reference / review only.",
    "created_at": "2012-04-16T22:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150720",
    "user": "https://github.com/nexttime"
}
```

Attachment [ecm-6.3.p4-p6.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p4-p6.diff) by @nexttime created at 2012-04-16 22:36:51

Diff between the previous spkg in Sage and my new p6 spkg.  For reference / review only.



---

archive/issue_comments_150721.json:
```json
{
    "body": "Changing keywords from \"spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h\" to \"spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h GCC 4.7.0 ia64 Itanium bug impossible reload\".",
    "created_at": "2012-04-16T22:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150721",
    "user": "https://github.com/nexttime"
}
```

Changing keywords from "spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h" to "spkg -march=native assembler error Darwin MacOS __GMP_CFLAGS __MPIR_CFLAGS gmp.h GCC 4.7.0 ia64 Itanium bug impossible reload".



---

archive/issue_comments_150722.json:
```json
{
    "body": "I've made a p6 spkg with further fixes and improvements, now also working around the GCC 4.7.0 bug on ia64 (Itanium).\n\n(See attached diffs and the spkg changelog entry in the description for details.)",
    "created_at": "2012-04-16T22:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150722",
    "user": "https://github.com/nexttime"
}
```

I've made a p6 spkg with further fixes and improvements, now also working around the GCC 4.7.0 bug on ia64 (Itanium).

(See attached diffs and the spkg changelog entry in the description for details.)



---

archive/issue_comments_150723.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-16T22:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150723",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_150724.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2012-04-19T08:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150724",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_150725.json:
```json
{
    "body": "In your `case` statement:\n\n```\n-march=*|-mcpu=*|-mtune*)\n```\nadd `-mpower*` which MPIR also uses.\n\nOf course, I still think the `spkg-install` is overly complicated and re-invents too many wheels.  But since you don't want to give in, I guess I'll have to, otherwise this will never get merged.",
    "created_at": "2012-04-19T10:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150725",
    "user": "https://github.com/jdemeyer"
}
```

In your `case` statement:

```
-march=*|-mcpu=*|-mtune*)
```
add `-mpower*` which MPIR also uses.

Of course, I still think the `spkg-install` is overly complicated and re-invents too many wheels.  But since you don't want to give in, I guess I'll have to, otherwise this will never get merged.



---

archive/issue_comments_150726.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-19T13:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150726",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_150727.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> In your `case` statement:\n> \n> ```\n> -march=*|-mcpu=*|-mtune*)\n> ```\n> add `-mpower*` which MPIR also uses.\n\n\nFixed in a p7.  (I've added `-mpower*` and `-mno-power*`.)",
    "created_at": "2012-04-19T14:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150727",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:16 jdemeyer]:
> In your `case` statement:
> 
> ```
> -march=*|-mcpu=*|-mtune*)
> ```
> add `-mpower*` which MPIR also uses.


Fixed in a p7.  (I've added `-mpower*` and `-mno-power*`.)



---

archive/issue_comments_150728.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-19T14:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150728",
    "user": "https://github.com/nexttime"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_150729.json:
```json
{
    "body": "Diff between my p6 and p7 spkgs.  For reference / review only.",
    "created_at": "2012-04-19T14:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150729",
    "user": "https://github.com/nexttime"
}
```

Diff between my p6 and p7 spkgs.  For reference / review only.



---

archive/issue_comments_150730.json:
```json
{
    "body": "Attachment [ecm-6.3.p6-p7.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p6-p7.diff) by @ppurka created at 2012-04-26 08:16:52\n\nIs `egrep` available on all systems? Otherwise one can use `grep -E`.",
    "created_at": "2012-04-26T08:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150730",
    "user": "https://github.com/ppurka"
}
```

Attachment [ecm-6.3.p6-p7.diff](tarball://root/attachments/some-uuid/ticket12830/ecm-6.3.p6-p7.diff) by @ppurka created at 2012-04-26 08:16:52

Is `egrep` available on all systems? Otherwise one can use `grep -E`.



---

archive/issue_comments_150731.json:
```json
{
    "body": "Replying to [comment:20 ppurka]:\n> Is `egrep` available on all systems? Otherwise one can use `grep -E`.\n\n`egrep` is the more portable of these two: Solaris (at least some versions) does support `egrep` but not `grep -E`.",
    "created_at": "2012-04-26T08:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150731",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 ppurka]:
> Is `egrep` available on all systems? Otherwise one can use `grep -E`.

`egrep` is the more portable of these two: Solaris (at least some versions) does support `egrep` but not `grep -E`.



---

archive/issue_comments_150732.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Replying to [comment:20 ppurka]:\n> > Is `egrep` available on all systems? Otherwise one can use `grep -E`.\n\n> `egrep` is the more portable of these two: Solaris (at least some versions) does support `egrep` but not `grep -E`.\n\nAnd we do use `egrep` in a couple of other spkgs (and probably scripts, too) since quite a while by the way.\n\nIn general, the safest way would be to use some `$EGREP`, determined by Sage's `configure`, but that's a different story...",
    "created_at": "2012-04-26T11:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150732",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 ppurka]:
> > Is `egrep` available on all systems? Otherwise one can use `grep -E`.

> `egrep` is the more portable of these two: Solaris (at least some versions) does support `egrep` but not `grep -E`.

And we do use `egrep` in a couple of other spkgs (and probably scripts, too) since quite a while by the way.

In general, the safest way would be to use some `$EGREP`, determined by Sage's `configure`, but that's a different story...



---

archive/issue_comments_150733.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-26T14:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150733",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_150734.json:
```json
{
    "body": "Looks fine.\n\nIn the long run it is probably unavoidable to disable optimizations on ia64 as nobody is going to fix bugs in the itanium optimizer at this point in time.",
    "created_at": "2012-04-26T14:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150734",
    "user": "https://github.com/vbraun"
}
```

Looks fine.

In the long run it is probably unavoidable to disable optimizations on ia64 as nobody is going to fix bugs in the itanium optimizer at this point in time.



---

archive/issue_comments_150735.json:
```json
{
    "body": "As reported on https://groups.google.com/d/msg/sage-devel/F8Y6DP3eSLM/zQM7HKzLt68J, this fails on SLES10 x86_64 with \n\n```\nlibtool: compile:  gcc -DHAVE_CONFIG_H -I. -I./x86_64 \n-I/home/rajeev/bin/sage-5.0.beta14/local/include \n-I/home/rajeev/bin/sage-5.0.beta14/local/include -march=native -g -O3 \n-fPIC -MT libecm_la-mul_fft.lo -MD -MP -MF .deps/libecm_la-mul_fft.Tpo \n-c mul_fft.c -o libecm_la-mul_fft.o \n: Assembler messages: \n:16797: Error: no such instruction: `pmulld %xmm2,%xmm0' \n:1023: Error: no such instruction: `pmulld %xmm2,%xmm0' \n:608: Error: no such instruction: `pmulld %xmm2,%xmm0' \nmake[4]: *** [libecm_la-mul_fft.lo] Error 1 \n```\nThis seems to be a known feature of `gcc -march=native` sometimes emitting SSE4 asm that is not supported by the installed binutils. See also http://gcc.gnu.org/bugzilla/show_bug.cgi?id=32062",
    "created_at": "2012-04-29T17:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150735",
    "user": "https://github.com/vbraun"
}
```

As reported on https://groups.google.com/d/msg/sage-devel/F8Y6DP3eSLM/zQM7HKzLt68J, this fails on SLES10 x86_64 with 

```
libtool: compile:  gcc -DHAVE_CONFIG_H -I. -I./x86_64 
-I/home/rajeev/bin/sage-5.0.beta14/local/include 
-I/home/rajeev/bin/sage-5.0.beta14/local/include -march=native -g -O3 
-fPIC -MT libecm_la-mul_fft.lo -MD -MP -MF .deps/libecm_la-mul_fft.Tpo 
-c mul_fft.c -o libecm_la-mul_fft.o 
: Assembler messages: 
:16797: Error: no such instruction: `pmulld %xmm2,%xmm0' 
:1023: Error: no such instruction: `pmulld %xmm2,%xmm0' 
:608: Error: no such instruction: `pmulld %xmm2,%xmm0' 
make[4]: *** [libecm_la-mul_fft.lo] Error 1 
```
This seems to be a known feature of `gcc -march=native` sometimes emitting SSE4 asm that is not supported by the installed binutils. See also http://gcc.gnu.org/bugzilla/show_bug.cgi?id=32062



---

archive/issue_comments_150736.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-04-29T17:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150736",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_150737.json:
```json
{
    "body": "It seems that MPIR is quite clever about choosing `CFLAGS`.  So, as I have said before, I would simply use MPIR's `CFLAGS`.  My feeling is that we should still merge this spkg as-is in sage-5.0 and continue thinking about it for the next Sage release.",
    "created_at": "2012-04-29T20:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150737",
    "user": "https://github.com/jdemeyer"
}
```

It seems that MPIR is quite clever about choosing `CFLAGS`.  So, as I have said before, I would simply use MPIR's `CFLAGS`.  My feeling is that we should still merge this spkg as-is in sage-5.0 and continue thinking about it for the next Sage release.



---

archive/issue_comments_150738.json:
```json
{
    "body": "Replying to [comment:24 vbraun]:\n> This seems to be a known feature of `gcc -march=native` sometimes emitting SSE4 asm that is not supported by the installed binutils.\n\nI don't think that `gcc` ever checks what the assembler supports.  It just emits instructions and assumes that the assembler knows about them.",
    "created_at": "2012-04-29T21:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150738",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:24 vbraun]:
> This seems to be a known feature of `gcc -march=native` sometimes emitting SSE4 asm that is not supported by the installed binutils.

I don't think that `gcc` ever checks what the assembler supports.  It just emits instructions and assumes that the assembler knows about them.



---

archive/issue_comments_150739.json:
```json
{
    "body": "I agree, gcc just assumes that sufficiently recent binutils are installed. So we really would need to also bundle binutils and its required BFD and opcodes libraries, plus whatever else they use. It was probably a mistake to use a cutting-edge gcc binary, we should use one that is as old as possible while having all critical bugs fixed. Or have some framework for CFLAGS that is smart enough to not turn on SSE levels that the assembler does not support. \n\nI'm fine with closing this ticket and fixing the SLES problems in the next release (and on another ticket).",
    "created_at": "2012-04-30T01:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150739",
    "user": "https://github.com/vbraun"
}
```

I agree, gcc just assumes that sufficiently recent binutils are installed. So we really would need to also bundle binutils and its required BFD and opcodes libraries, plus whatever else they use. It was probably a mistake to use a cutting-edge gcc binary, we should use one that is as old as possible while having all critical bugs fixed. Or have some framework for CFLAGS that is smart enough to not turn on SSE levels that the assembler does not support. 

I'm fine with closing this ticket and fixing the SLES problems in the next release (and on another ticket).



---

archive/issue_comments_150740.json:
```json
{
    "body": "Replying to [comment:27 vbraun]:\n> we should use one that is as old as possible while having all critical bugs fixed.\n\nThat's exactly what I did :-)",
    "created_at": "2012-04-30T06:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150740",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 vbraun]:
> we should use one that is as old as possible while having all critical bugs fixed.

That's exactly what I did :-)



---

archive/issue_events_034928.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-30T09:52:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12830#event-34928"
}
```



---

archive/issue_comments_150741.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-04-30T09:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12830",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12830#issuecomment-150741",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
