# Issue 12223: the 'sage.rings.complex_mpc' optional extension is broken in sage-4.8.alpha3 and over

archive/issues_012051.json:
```json
{
    "assignees": [],
    "body": "The optional mpc package installs fine but when I execute sage -b to built the sage code I get\n\n```\nSuccessfully installed mpc-0.8.3-dev-svn793\nNow cleaning up tmp files.\nMaking Sage/Python scripts relocatable...\nFinished installing mpc-0.8.3-dev-svn793.spkg\nfbissey@QCD-nzi3 /home/work/fbissey/sandbox/sage-4.8.alpha4 $ ./sage -b\n\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n\n\nInstalling c_lib\nscons: `install' is up to date.\nUpdating Cython code....\nBuilding sage/rings/complex_mpc.pyx because it depends on /home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/mpc.h.\nExecute 1 commands (using 1 threads)\npython `which cython`  --old-style-globals --disable-function-redefinition --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage-main -o sage/rings/complex_mpc.c sage/rings/complex_mpc.pyx\nsage/rings/complex_mpc.pyx --> /home/work/fbissey/sandbox/sage-4.8.alpha4/local/lib/python2.6/site-packages//sage/rings/complex_mpc.pyx\nTime to execute 1 commands: 3.12862586975 seconds\nFinished compiling Cython code (time = 4.00216197968 seconds)\nrunning install\nrunning build\nrunning build_py\nrunning build_ext\nbuilding 'sage.rings.complex_mpc' extension\nExecute 1 commands (using 1 threads)\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/csage -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage/sage/ext -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/python2.6 -c sage/rings/complex_mpc.c -o build/temp.linux-x86_64-2.6/sage/rings/complex_mpc.o -w\nsage/rings/complex_mpc.c: In function '__pyx_pf_4sage_5rings_11complex_mpc_15MPComplexNumber_16__float__':\nsage/rings/complex_mpc.c:9720:48: error: cast specifies array type\nerror: command 'gcc' failed with exit status 1\nsage: There was an error installing modified sage library code.\n```\n\nAuthor: **Jeroen Demeyer**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nMerged: **sage-5.0.beta5**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12223_\n\n",
    "closed_at": "2012-02-22T10:45:36Z",
    "created_at": "2011-12-22T18:49:27Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.0",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "the 'sage.rings.complex_mpc' optional extension is broken in sage-4.8.alpha3 and over",
    "type": "issue",
    "updated_at": "2012-02-22T10:45:36Z",
    "url": "https://github.com/sagemath/sage/issues/12223",
    "user": "https://github.com/kiwifb"
}
```
The optional mpc package installs fine but when I execute sage -b to built the sage code I get

```
Successfully installed mpc-0.8.3-dev-svn793
Now cleaning up tmp files.
Making Sage/Python scripts relocatable...
Finished installing mpc-0.8.3-dev-svn793.spkg
fbissey@QCD-nzi3 /home/work/fbissey/sandbox/sage-4.8.alpha4 $ ./sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Building sage/rings/complex_mpc.pyx because it depends on /home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/mpc.h.
Execute 1 commands (using 1 threads)
python `which cython`  --old-style-globals --disable-function-redefinition --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage-main -o sage/rings/complex_mpc.c sage/rings/complex_mpc.pyx
sage/rings/complex_mpc.pyx --> /home/work/fbissey/sandbox/sage-4.8.alpha4/local/lib/python2.6/site-packages//sage/rings/complex_mpc.pyx
Time to execute 1 commands: 3.12862586975 seconds
Finished compiling Cython code (time = 4.00216197968 seconds)
running install
running build
running build_py
running build_ext
building 'sage.rings.complex_mpc' extension
Execute 1 commands (using 1 threads)
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/csage -I/home/work/fbissey/sandbox/sage-4.8.alpha4/devel/sage/sage/ext -I/home/work/fbissey/sandbox/sage-4.8.alpha4/local/include/python2.6 -c sage/rings/complex_mpc.c -o build/temp.linux-x86_64-2.6/sage/rings/complex_mpc.o -w
sage/rings/complex_mpc.c: In function '__pyx_pf_4sage_5rings_11complex_mpc_15MPComplexNumber_16__float__':
sage/rings/complex_mpc.c:9720:48: error: cast specifies array type
error: command 'gcc' failed with exit status 1
sage: There was an error installing modified sage library code.
```

Author: **Jeroen Demeyer**

Reviewer: **Fran√ßois Bissey**

Merged: **sage-5.0.beta5**

_Issue created by migration from https://trac.sagemath.org/ticket/12223_





---

archive/issue_events_152018.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-12-22T18:49:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152018"
}
```



---

archive/issue_events_152019.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-12-22T18:49:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "component: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152019"
}
```



---

archive/issue_events_152020.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-12-22T18:49:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152020"
}
```



---

archive/issue_events_152021.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2011-12-22T18:49:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152021"
}
```



---

archive/issue_comments_134491.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nthe faulty C code:\n\n```\n    /* \"sage/rings/complex_mpc.pyx\":1107\n *         if mpfr_zero_p(self.value.im):\n *             return mpfr_get_d(<mpfr_t> self.value.re,\\\n *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))             # <<<<<<<<<<<<<<\n *         else:\n *             raise TypeError, \"can't convert complex to float; use abs(z)\"\n */\n    __pyx_t_2 = PyFloat_FromDouble(mpfr_get_d(((mpfr_t)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->value->re), __pyx_f_4sage_5rings_11complex_mpc_rnd_re(((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexField_class *)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_base._parent)->__pyx___rnd))); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}  <=line 9720\n    __Pyx_GOTREF(__pyx_t_2);\n    __pyx_r = __pyx_t_2;\n    __pyx_t_2 = 0;\n    goto __pyx_L0;\n    goto __pyx_L5;\n  }\n  /*else*/ {\n\n    /* \"sage/rings/complex_mpc.pyx\":1109\n *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))\n *         else:\n *             raise TypeError, \"can't convert complex to float; use abs(z)\"             # <<<<<<<<<<<<<<\n *\n *     def __complex__(self):\n */\n    __Pyx_Raise(__pyx_builtin_TypeError, ((PyObject *)__pyx_kp_s_76), 0, 0);\n    {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1109; __pyx_clineno = __LINE__; goto __pyx_L1_error;}\n  }\n  __pyx_L5:;\n\n  __pyx_r = Py_None; __Pyx_INCREF(Py_None);\n  goto __pyx_L0;\n  __pyx_L1_error:;\n  __Pyx_XDECREF(__pyx_t_2);\n  __Pyx_AddTraceback(\"sage.rings.complex_mpc.MPComplexNumber.__float__\", __pyx_clineno, __pyx_lineno, __pyx_filename);\n  __pyx_r = NULL;\n  __pyx_L0:;\n  __Pyx_XGIVEREF(__pyx_r);\n  __Pyx_RefNannyFinishContext();\n  return __pyx_r;\n}\n\n```",
    "created_at": "2011-12-22T22:45:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134491",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:1" align="right">Comment 1</div>

the faulty C code:

```
    /* "sage/rings/complex_mpc.pyx":1107
 *         if mpfr_zero_p(self.value.im):
 *             return mpfr_get_d(<mpfr_t> self.value.re,\
 *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))             # <<<<<<<<<<<<<<
 *         else:
 *             raise TypeError, "can't convert complex to float; use abs(z)"
 */
    __pyx_t_2 = PyFloat_FromDouble(mpfr_get_d(((mpfr_t)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->value->re), __pyx_f_4sage_5rings_11complex_mpc_rnd_re(((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexField_class *)((struct __pyx_obj_4sage_5rings_11complex_mpc_MPComplexNumber *)__pyx_v_self)->__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_base._parent)->__pyx___rnd))); if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}  <=line 9720
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_r = __pyx_t_2;
    __pyx_t_2 = 0;
    goto __pyx_L0;
    goto __pyx_L5;
  }
  /*else*/ {

    /* "sage/rings/complex_mpc.pyx":1109
 *                                    rnd_re((<MPComplexField_class>self._parent).__rnd))
 *         else:
 *             raise TypeError, "can't convert complex to float; use abs(z)"             # <<<<<<<<<<<<<<
 *
 *     def __complex__(self):
 */
    __Pyx_Raise(__pyx_builtin_TypeError, ((PyObject *)__pyx_kp_s_76), 0, 0);
    {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1109; __pyx_clineno = __LINE__; goto __pyx_L1_error;}
  }
  __pyx_L5:;

  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_AddTraceback("sage.rings.complex_mpc.MPComplexNumber.__float__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

```



---

archive/issue_comments_134492.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nI am putting this to blocker since the spkg builds correctly and then because the extension is broken it breaks sage -b.",
    "created_at": "2012-01-25T22:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134492",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:2" align="right">Comment 2</div>

I am putting this to blocker since the spkg builds correctly and then because the extension is broken it breaks sage -b.



---

archive/issue_events_152022.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-01-25T22:08:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152022"
}
```



---

archive/issue_events_152023.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-01-25T22:08:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152023"
}
```



---

archive/issue_comments_134493.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nJust wondering: why isn't this a standard package?  I guess complex arithmetic in Sage would benefit from it.",
    "created_at": "2012-01-31T20:35:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134493",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">Comment 3</div>

Just wondering: why isn't this a standard package?  I guess complex arithmetic in Sage would benefit from it.



---

archive/issue_comments_134494.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nThere was some discussion a while back when David Kirkby put it in shape last. If I remember correctly the gist of it was that you could do complex arithmetic some other way in sage and that there wasn't much benefits from it. I would have to dig sage-devel to find it.",
    "created_at": "2012-01-31T20:50:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134494",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:4" align="right">Comment 4</div>

There was some discussion a while back when David Kirkby put it in shape last. If I remember correctly the gist of it was that you could do complex arithmetic some other way in sage and that there wasn't much benefits from it. I would have to dig sage-devel to find it.



---

archive/issue_events_152024.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-15T15:56:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152024"
}
```



---

archive/issue_comments_134495.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nAttachment: **[12223_mpc.patch.gz](https://github.com/sagemath/sage/files/ticket12223/12223_mpc.patch.gz)**",
    "created_at": "2012-02-15T15:56:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134495",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">Comment 5</div>

Attachment: **[12223_mpc.patch.gz](https://github.com/sagemath/sage/files/ticket12223/12223_mpc.patch.gz)**



---

archive/issue_comments_134496.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2012-02-15T15:56:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134496",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_134497.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -32,5 +32,3 @@\n error: command 'gcc' failed with exit status 1\n sage: There was an error installing modified sage library code.\n ```\n-I suspect the recent cython upgrade is responsible.\n-\n``````\n",
    "created_at": "2012-02-15T15:56:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134497",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -32,5 +32,3 @@
 error: command 'gcc' failed with exit status 1
 sage: There was an error installing modified sage library code.
 ```
-I suspect the recent cython upgrade is responsible.
-
``````




---

archive/issue_comments_134498.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nSee #12515 to make this a standard spkg.",
    "created_at": "2012-02-15T15:56:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134498",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">Comment 6</div>

See #12515 to make this a standard spkg.



---

archive/issue_comments_134499.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2012-02-16T02:05:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134499",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **Fran√ßois Bissey**



---

archive/issue_events_152025.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-02-16T02:05:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152025"
}
```



---

archive/issue_events_152026.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-02-16T02:05:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152026"
}
```



---

archive/issue_comments_134500.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nOk I tested the patch and it works. I am giving this a positive review.",
    "created_at": "2012-02-16T02:05:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134500",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">Comment 7</div>

Ok I tested the patch and it works. I am giving this a positive review.



---

archive/issue_events_152027.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-22T10:45:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152027"
}
```



---

archive/issue_events_152028.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-22T10:45:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12223#event-152028"
}
```



---

archive/issue_comments_134501.json:
```json
{
    "body": "Merged: **sage-5.0.beta5**",
    "created_at": "2012-02-22T10:45:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12223#issuecomment-134501",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.0.beta5**
