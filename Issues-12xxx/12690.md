# Issue 12690: Signal handling doesn't properly handle OpenMP code

archive/issues_012518.json:
```json
{
    "body": "I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:\n\n```\nsage: sage: time prime_pi(10**12)\n37607912018\nTime: CPU 1.25 s, Wall: 0.80 s\ntime prime_pi(10**12)\n^C/home/sage/5.0.beta8/local/lib/libcsage.so(print_backtrace+0x31)[0x7f9a6f5c0996]\n/home/sage/5.0.beta8/local/lib/libcsage.so(sigdie+0x14)[0x7f9a6f5c09c8]\n/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0x17d)[0x7f9a6f5c0587]\n/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_SetString+0x27)[0x7f9a74f8aad7]\n/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0xed)[0x7f9a6f5c04f7]\n/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]\n/home/sage/5.0.beta8/local/lib/libcsage.so(sage_interrupt_handler+0x48)[0x7f9a6f5c03b0]\n/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x4099)[0x7f9a4e185099]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x3fe8)[0x7f9a4e184fe8]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x5095)[0x7f9a4e186095]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x58cd)[0x7f9a4e1868cd]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x7509)[0x7f9a4e188509]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x8c38)[0x7f9a4e189c38]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(+0x4dc2b)[0x7f9a74ed6c2b]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_CallMethod+0xc1)[0x7f9a74ed6f41]\n/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZNK5GiNaC8function4evalEi+0x4ce)[0x7f9a52c15e3e]\n/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x6e)[0x7f9a52c03b4e]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(_Z16g_function_eval1jRKN5GiNaC2exEb+0xb7)[0x7f9a521da557]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(+0x21def)[0x7f9a521e1def]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x47)[0x7f9a74f740e7]\n/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x939f)[0x7f9a4e18a39f]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x3fcd)[0x7f9a74f7869d]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x57bf)[0x7f9a74f79e8f]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5dc1)[0x7f9a74f7a491]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xb0)[0x7f9a74f9db20]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xdf)[0x7f9a74f9e5bf]\n/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(Py_Main+0xb85)[0x7f9a74fb1275]\n/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9a74281fad]\npython[0x4006f1]\n\n------------------------------------------------------------------------\nAn error occured during signal handling.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/home/sage/5.0.beta8/spkg/bin/sage: line 308:  8428 Segmentation fault      (core dumped) sage-ipython \"$@\" -i\n```\n\nI've attached a patch for the sage library that demonstrates the bug.\n\n\nAssignee: @jdemeyer\n\nReviewer: Jeroen Demeyer\n\nResolution: wontfix\n\nIssue created by migration from https://trac.sagemath.org/ticket/12690\n\n",
    "closed_at": "2013-11-04T13:20:07Z",
    "created_at": "2012-03-18T23:08:07Z",
    "labels": [
        "component: c_lib",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Signal handling doesn't properly handle OpenMP code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12690",
    "user": "https://github.com/ohanar"
}
```
I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:

```
sage: sage: time prime_pi(10**12)
37607912018
Time: CPU 1.25 s, Wall: 0.80 s
time prime_pi(10**12)
^C/home/sage/5.0.beta8/local/lib/libcsage.so(print_backtrace+0x31)[0x7f9a6f5c0996]
/home/sage/5.0.beta8/local/lib/libcsage.so(sigdie+0x14)[0x7f9a6f5c09c8]
/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0x17d)[0x7f9a6f5c0587]
/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_SetString+0x27)[0x7f9a74f8aad7]
/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0xed)[0x7f9a6f5c04f7]
/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]
/home/sage/5.0.beta8/local/lib/libcsage.so(sage_interrupt_handler+0x48)[0x7f9a6f5c03b0]
/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x4099)[0x7f9a4e185099]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x3fe8)[0x7f9a4e184fe8]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x5095)[0x7f9a4e186095]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x58cd)[0x7f9a4e1868cd]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x7509)[0x7f9a4e188509]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x8c38)[0x7f9a4e189c38]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(+0x4dc2b)[0x7f9a74ed6c2b]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_CallMethod+0xc1)[0x7f9a74ed6f41]
/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZNK5GiNaC8function4evalEi+0x4ce)[0x7f9a52c15e3e]
/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x6e)[0x7f9a52c03b4e]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(_Z16g_function_eval1jRKN5GiNaC2exEb+0xb7)[0x7f9a521da557]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(+0x21def)[0x7f9a521e1def]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x47)[0x7f9a74f740e7]
/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x939f)[0x7f9a4e18a39f]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x3fcd)[0x7f9a74f7869d]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x57bf)[0x7f9a74f79e8f]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5dc1)[0x7f9a74f7a491]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xb0)[0x7f9a74f9db20]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xdf)[0x7f9a74f9e5bf]
/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(Py_Main+0xb85)[0x7f9a74fb1275]
/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9a74281fad]
python[0x4006f1]

------------------------------------------------------------------------
An error occured during signal handling.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/home/sage/5.0.beta8/spkg/bin/sage: line 308:  8428 Segmentation fault      (core dumped) sage-ipython "$@" -i
```

I've attached a patch for the sage library that demonstrates the bug.


Assignee: @jdemeyer

Reviewer: Jeroen Demeyer

Resolution: wontfix

Issue created by migration from https://trac.sagemath.org/ticket/12690





---

archive/issue_comments_157300.json:
```json
{
    "body": "Attachment [prime_pi_interrupt_error.patch](tarball://root/attachments/some-uuid/ticket12690/prime_pi_interrupt_error.patch) by @ohanar created at 2012-03-18 23:08:39\n\nprime_pi that causes the interrupt error",
    "created_at": "2012-03-18T23:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157300",
    "user": "https://github.com/ohanar"
}
```

Attachment [prime_pi_interrupt_error.patch](tarball://root/attachments/some-uuid/ticket12690/prime_pi_interrupt_error.patch) by @ohanar created at 2012-03-18 23:08:39

prime_pi that causes the interrupt error



---

archive/issue_comments_157301.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-I was playing around with the using the new prange functionality in cython and happened across this:\n+I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:\n \n \\`\\`\\`\n sage: sage: time prime_pi(10**12)\n@@ -68,6 +68,7 @@\n \n I've attached a patch to the sage library that introduces this threaded prime_pi (abet with a hack to work around a cython bug) and exposes the issue.\n \n+\n Summary: signal handling doesn't properly handle multithreaded code\n \n Issue created by migration from https://trac.sagemath.org/ticket/12690\n```\n",
    "created_at": "2012-03-18T23:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157301",
    "user": "https://github.com/ohanar"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-I was playing around with the using the new prange functionality in cython and happened across this:
+I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:
 
 \`\`\`
 sage: sage: time prime_pi(10**12)
@@ -68,6 +68,7 @@
 
 I've attached a patch to the sage library that introduces this threaded prime_pi (abet with a hack to work around a cython bug) and exposes the issue.
 
+
 Summary: signal handling doesn't properly handle multithreaded code
 
 Issue created by migration from https://trac.sagemath.org/ticket/12690
```




---

archive/issue_comments_157302.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,72 @@\n+I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:\n+\n+\\`\\`\\`\n+sage: sage: time prime_pi(10**12)\n+37607912018\n+Time: CPU 1.25 s, Wall: 0.80 s\n+time prime_pi(10**12)\n+^C/home/sage/5.0.beta8/local/lib/libcsage.so(print_backtrace+0x31)[0x7f9a6f5c0996]\n+/home/sage/5.0.beta8/local/lib/libcsage.so(sigdie+0x14)[0x7f9a6f5c09c8]\n+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0x17d)[0x7f9a6f5c0587]\n+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_SetString+0x27)[0x7f9a74f8aad7]\n+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0xed)[0x7f9a6f5c04f7]\n+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]\n+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_interrupt_handler+0x48)[0x7f9a6f5c03b0]\n+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x4099)[0x7f9a4e185099]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x3fe8)[0x7f9a4e184fe8]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x5095)[0x7f9a4e186095]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x58cd)[0x7f9a4e1868cd]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x7509)[0x7f9a4e188509]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x8c38)[0x7f9a4e189c38]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(+0x4dc2b)[0x7f9a74ed6c2b]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_CallMethod+0xc1)[0x7f9a74ed6f41]\n+/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZNK5GiNaC8function4evalEi+0x4ce)[0x7f9a52c15e3e]\n+/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x6e)[0x7f9a52c03b4e]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(_Z16g_function_eval1jRKN5GiNaC2exEb+0xb7)[0x7f9a521da557]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(+0x21def)[0x7f9a521e1def]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x47)[0x7f9a74f740e7]\n+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x939f)[0x7f9a4e18a39f]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x3fcd)[0x7f9a74f7869d]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x57bf)[0x7f9a74f79e8f]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5dc1)[0x7f9a74f7a491]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xb0)[0x7f9a74f9db20]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xdf)[0x7f9a74f9e5bf]\n+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(Py_Main+0xb85)[0x7f9a74fb1275]\n+/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9a74281fad]\n+python[0x4006f1]\n+\n+------------------------------------------------------------------------\n+An error occured during signal handling.\n+This probably occurred because a *compiled* component of Sage has a bug\n+in it and is not properly wrapped with sig_on(), sig_off(). You might\n+want to run Sage under gdb with 'sage -gdb' to debug this.\n+Sage will now terminate.\n+------------------------------------------------------------------------\n+/home/sage/5.0.beta8/spkg/bin/sage: line 308:  8428 Segmentation fault      (core dumped) sage-ipython \"$@\" -i\n+\\`\\`\\`\n+\n+I've attached a patch for the sage library that demonstrates the bug.\n \n \n Summary: signal handling doesn't properly handle multithreaded code\n```\n",
    "created_at": "2012-05-26T22:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157302",
    "user": "https://github.com/ohanar"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,72 @@
+I was playing around with the using the new prange functionality in cython and happened across this when I tried to interrupt the execution:
+
+\`\`\`
+sage: sage: time prime_pi(10**12)
+37607912018
+Time: CPU 1.25 s, Wall: 0.80 s
+time prime_pi(10**12)
+^C/home/sage/5.0.beta8/local/lib/libcsage.so(print_backtrace+0x31)[0x7f9a6f5c0996]
+/home/sage/5.0.beta8/local/lib/libcsage.so(sigdie+0x14)[0x7f9a6f5c09c8]
+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0x17d)[0x7f9a6f5c0587]
+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_SetString+0x27)[0x7f9a74f8aad7]
+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_signal_handler+0xed)[0x7f9a6f5c04f7]
+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyErr_Restore+0x4c)[0x7f9a74f8a99c]
+/home/sage/5.0.beta8/local/lib/libcsage.so(sage_interrupt_handler+0x48)[0x7f9a6f5c03b0]
+/lib64/libpthread.so.0(+0xfb80)[0x7f9a74c7bb80]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x4099)[0x7f9a4e185099]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x3fe8)[0x7f9a4e184fe8]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x5095)[0x7f9a4e186095]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x58cd)[0x7f9a4e1868cd]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x7509)[0x7f9a4e188509]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x8c38)[0x7f9a4e189c38]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(+0x4dc2b)[0x7f9a74ed6c2b]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_CallMethod+0xc1)[0x7f9a74ed6f41]
+/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZNK5GiNaC8function4evalEi+0x4ce)[0x7f9a52c15e3e]
+/home/sage/5.0.beta8/local/lib/libpynac-0.2.so.3(_ZN5GiNaC2ex20construct_from_basicERKNS_5basicE+0x6e)[0x7f9a52c03b4e]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(_Z16g_function_eval1jRKN5GiNaC2exEb+0xb7)[0x7f9a521da557]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/symbolic/function.so(+0x21def)[0x7f9a521e1def]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x47)[0x7f9a74f740e7]
+/home/sage/5.0.beta8/local/lib/python2.7/site-packages/sage/functions/prime_pi.so(+0x939f)[0x7f9a4e18a39f]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyObject_Call+0x53)[0x7f9a74ed6b53]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x3fcd)[0x7f9a74f7869d]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x57bf)[0x7f9a74f79e8f]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5dc1)[0x7f9a74f7a491]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x51f1)[0x7f9a74f798c1]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x855)[0x7f9a74f7b645]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x7f9a74f7b782]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xb0)[0x7f9a74f9db20]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0xdf)[0x7f9a74f9e5bf]
+/home/sage/5.0.beta8/local/lib/libpython2.7.so.1.0(Py_Main+0xb85)[0x7f9a74fb1275]
+/lib64/libc.so.6(__libc_start_main+0xed)[0x7f9a74281fad]
+python[0x4006f1]
+
+------------------------------------------------------------------------
+An error occured during signal handling.
+This probably occurred because a *compiled* component of Sage has a bug
+in it and is not properly wrapped with sig_on(), sig_off(). You might
+want to run Sage under gdb with 'sage -gdb' to debug this.
+Sage will now terminate.
+------------------------------------------------------------------------
+/home/sage/5.0.beta8/spkg/bin/sage: line 308:  8428 Segmentation fault      (core dumped) sage-ipython "$@" -i
+\`\`\`
+
+I've attached a patch for the sage library that demonstrates the bug.
 
 
 Summary: signal handling doesn't properly handle multithreaded code
```




---

archive/issue_events_034409.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12690#event-34409"
}
```



---

archive/issue_events_034410.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-03T22:02:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12690#event-34410"
}
```



---

archive/issue_events_034411.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-03T22:02:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12690#event-34411"
}
```



---

archive/issue_comments_157303.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-11-03T22:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157303",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157304.json:
```json
{
    "body": "<a id='comment:4'></a>Proposal: close as wontfix.\n\nThe problem is that Cython uses OpenMP. Even I could fix the signal handling code, it's not at all clear how to make OpenMP deal with this. The following makes me think that a fix is impossible:\n* [http://stackoverflow.com/questions/3914264/openmp-is-there-a-way-for-a-thread-to-terminate-all-other-parallel-threads](http://stackoverflow.com/questions/3914264/openmp-is-there-a-way-for-a-thread-to-terminate-all-other-parallel-threads)\n* [http://stackoverflow.com/questions/8482651/how-do-i-conditionally-terminate-a-parallel-region-in-openmp](http://stackoverflow.com/questions/8482651/how-do-i-conditionally-terminate-a-parallel-region-in-openmp)\n\nOpenMP simply isn't designed for this. With pthreads, it might be possible as it has clear specifications about how threads interact with signals.",
    "created_at": "2013-11-03T22:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157304",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>Proposal: close as wontfix.

The problem is that Cython uses OpenMP. Even I could fix the signal handling code, it's not at all clear how to make OpenMP deal with this. The following makes me think that a fix is impossible:
* [http://stackoverflow.com/questions/3914264/openmp-is-there-a-way-for-a-thread-to-terminate-all-other-parallel-threads](http://stackoverflow.com/questions/3914264/openmp-is-there-a-way-for-a-thread-to-terminate-all-other-parallel-threads)
* [http://stackoverflow.com/questions/8482651/how-do-i-conditionally-terminate-a-parallel-region-in-openmp](http://stackoverflow.com/questions/8482651/how-do-i-conditionally-terminate-a-parallel-region-in-openmp)

OpenMP simply isn't designed for this. With pthreads, it might be possible as it has clear specifications about how threads interact with signals.



---

archive/issue_comments_157305.json:
```json
{
    "body": "very basic code demonstrating the issue",
    "created_at": "2013-11-04T12:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157305",
    "user": "https://github.com/jdemeyer"
}
```

very basic code demonstrating the issue



---

archive/issue_comments_157306.json:
```json
{
    "body": "<a id='comment:5'></a>Attachment [dumb_code.patch](tarball://root/attachments/some-uuid/ticket12690/dumb_code.patch) by @jdemeyer created at 2013-11-04 13:19:56\n\nUsing `sig_check()` inside the loop does work:\n\n```\nfrom cython.parallel import prange\n\ninclude 'ext/interrupt.pxi'\n\ndef dumb_function():\n    cdef int i,x\n\n    while True:\n        for i in prange(1<<30,nogil=True):\n            with gil:\n                sig_check()\n            x += i\n\n    return x\n```\n\nFrom Cython's point of view, `sig_check()` simply raises an exception when an interrupt occurred, which is explicitly allowed by [http://docs.cython.org/src/userguide/parallelism.html#breaking-out-of-loops](http://docs.cython.org/src/userguide/parallelism.html#breaking-out-of-loops)\nThe worst-case overhead is one loop iteration per thread, which is optimal given the limitations of OpenMP.\n\nWe should probably declare `sig_check()` as nogil though, see #15352.",
    "created_at": "2013-11-04T13:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157306",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Attachment [dumb_code.patch](tarball://root/attachments/some-uuid/ticket12690/dumb_code.patch) by @jdemeyer created at 2013-11-04 13:19:56

Using `sig_check()` inside the loop does work:

```
from cython.parallel import prange

include 'ext/interrupt.pxi'

def dumb_function():
    cdef int i,x

    while True:
        for i in prange(1<<30,nogil=True):
            with gil:
                sig_check()
            x += i

    return x
```

From Cython's point of view, `sig_check()` simply raises an exception when an interrupt occurred, which is explicitly allowed by [http://docs.cython.org/src/userguide/parallelism.html#breaking-out-of-loops](http://docs.cython.org/src/userguide/parallelism.html#breaking-out-of-loops)
The worst-case overhead is one loop iteration per thread, which is optimal given the limitations of OpenMP.

We should probably declare `sig_check()` as nogil though, see #15352.



---

archive/issue_comments_157307.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2013-11-04T13:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12690#issuecomment-157307",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: wontfix



---

archive/issue_events_034412.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-11-04T13:20:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12690",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12690#event-34412"
}
```
