# Issue 12689: Segfault in solve_left for sparse matrices over ZZ

archive/issues_012517.json:
```json
{
    "body": "Calling solve_left on a sparse integer matrix results in an instant segfault:\n\n```\nsage: A = identity_matrix(ZZ, 2, sparse=True)\nsage: B = identity_matrix(ZZ, 2, sparse=True)\nsage: A.solve_left(B)\n/storage/masiao/sage-5.0.beta8/spkg/bin/sage: line 308:  7843 Segmentation fault      sage-ipython \"$@\" -i\n```\n\nAssignee: jason, was\n\nKeywords: segfault\n\nReviewer: Douglas McNeil\n\nAuthor: William Stein\n\nMerged: sage-5.0.beta10\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12689\n\n",
    "closed_at": "2012-03-23T15:23:35Z",
    "created_at": "2012-03-18T19:16:31Z",
    "labels": [
        "component: linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Segfault in solve_left for sparse matrices over ZZ",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12689",
    "user": "https://github.com/loefflerd"
}
```
Calling solve_left on a sparse integer matrix results in an instant segfault:

```
sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.solve_left(B)
/storage/masiao/sage-5.0.beta8/spkg/bin/sage: line 308:  7843 Segmentation fault      sage-ipython "$@" -i
```

Assignee: jason, was

Keywords: segfault

Reviewer: Douglas McNeil

Author: William Stein

Merged: sage-5.0.beta10

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12689





---

archive/issue_comments_183263.json:
```json
{
    "body": "<a id='comment:1'></a>We can push the bug a bit farther back:\n\n\n```\n\nsage: A = identity_matrix(ZZ, 2, sparse=True)\nsage: B = identity_matrix(ZZ, 2, sparse=True)\nsage: A.augment(B)\n[1 0 1 0]\n[0 1 0 1]\nsage: A.change_ring(QQ).augment(B.change_ring(QQ))\n[1 0 1 0]\n[0 1 0 1]\nsage: A.change_ring(QQ).augment(B)\n[  1   0 1/0   0]\n[  0   1   0 1/0]\n```\n\n1/0 doesn't look right..",
    "created_at": "2012-03-18T20:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183263",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:1'></a>We can push the bug a bit farther back:


```

sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.augment(B)
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B.change_ring(QQ))
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B)
[  1   0 1/0   0]
[  0   1   0 1/0]
```

1/0 doesn't look right..



---

archive/issue_comments_183264.json:
```json
{
    "body": "<a id='comment:2'></a>Ah, okay.  I think I see what's going on.  In matrix_sparse.pyx's augment:\n\n```\n\n        cdef Matrix_sparse other = right.sparse_matrix()\n\n    [...]\n\n        if not (self._base_ring is right.base_ring()):\n            right = right.change_ring(self._base_ring)\n```\n\nattemps to change the right base ring to agree, but during the insertion process, it still uses the old unchanged one:\n\n```\n        for i, j in right.nonzero_positions(copy=False):\n            Z.set_unsafe(i, j + self._ncols, other.get_unsafe(i,j))\n```\n\nIf we instead use\n\n```\n\n            other = other.change_ring(self._base_ring)\n```\n\nthen everything seems to work:\n\n```\n\nsage: z = A.change_ring(QQ).augment(B)\n[skipping debugging output]\nsage: z\n[1 0 1 0]\n[0 1 0 1]\n```\n\nand \n\n```\n\nsage: A.solve_left(B)\n[1 0]\n[0 1]\nsage: parent(_)\nFull MatrixSpace of 2 by 2 sparse matrices over Rational Field\n\n```\n\nSo I think the fix is a one-liner.  Any takers?",
    "created_at": "2012-03-18T20:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183264",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:2'></a>Ah, okay.  I think I see what's going on.  In matrix_sparse.pyx's augment:

```

        cdef Matrix_sparse other = right.sparse_matrix()

    [...]

        if not (self._base_ring is right.base_ring()):
            right = right.change_ring(self._base_ring)
```

attemps to change the right base ring to agree, but during the insertion process, it still uses the old unchanged one:

```
        for i, j in right.nonzero_positions(copy=False):
            Z.set_unsafe(i, j + self._ncols, other.get_unsafe(i,j))
```

If we instead use

```

            other = other.change_ring(self._base_ring)
```

then everything seems to work:

```

sage: z = A.change_ring(QQ).augment(B)
[skipping debugging output]
sage: z
[1 0 1 0]
[0 1 0 1]
```

and 

```

sage: A.solve_left(B)
[1 0]
[0 1]
sage: parent(_)
Full MatrixSpace of 2 by 2 sparse matrices over Rational Field

```

So I think the fix is a one-liner.  Any takers?



---

archive/issue_comments_183265.json:
```json
{
    "body": "<a id='comment:3'></a>> Any takes? \n\n\nI'll post a patch if you'll review it :-)",
    "created_at": "2012-03-18T20:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183265",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>> Any takes? 


I'll post a patch if you'll review it :-)



---

archive/issue_comments_183266.json:
```json
{
    "body": "<a id='comment:4'></a>Deal.  Should probably add tests both in augment for the incompatible-ring bug and in solve_left for the original.",
    "created_at": "2012-03-18T21:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183266",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:4'></a>Deal.  Should probably add tests both in augment for the incompatible-ring bug and in solve_left for the original.



---

archive/issue_comments_183267.json:
```json
{
    "body": "<a id='comment:5'></a>Although since uses Z._subdivide_on_augment(self, right) uses right too, maybe it's a two-liner. :^)",
    "created_at": "2012-03-18T21:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183267",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:5'></a>Although since uses Z._subdivide_on_augment(self, right) uses right too, maybe it's a two-liner. :^)



---

archive/issue_comments_183268.json:
```json
{
    "body": "Attachment [trac_12689.patch](tarball://root/attachments/some-uuid/ticket12689/trac_12689.patch) by @williamstein created at 2012-03-18 21:14:13",
    "created_at": "2012-03-18T21:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183268",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12689.patch](tarball://root/attachments/some-uuid/ticket12689/trac_12689.patch) by @williamstein created at 2012-03-18 21:14:13



---

archive/issue_comments_183269.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-18T21:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183269",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_183270.json:
```json
{
    "body": "<a id='comment:7'></a>Running test suite now, but it looks fine. Don't forget that we have the new \":trac:`12689`\" markup now, though!",
    "created_at": "2012-03-18T21:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183270",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:7'></a>Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!



---

archive/issue_comments_183271.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [dsm](#comment%3A7):\n> Running test suite now, but it looks fine. Don't forget that we have the new \":trac:`12689`\" markup now, though!\n\n\nCool.  I've never heard of it.",
    "created_at": "2012-03-18T22:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183271",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>Replying to [dsm](#comment%3A7):
> Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!


Cool.  I've never heard of it.



---

archive/issue_comments_183272.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Douglas McNeil\"",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183272",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing reviewer from "" to "Douglas McNeil"



---

archive/issue_comments_183273.json:
```json
{
    "body": "<a id='comment:9'></a>Patch applies against 5.0.beta8 (and 4.8) and runs; fixes the OP's symptom; has a doctest; doesn't introduce new doctest failures (I have quite a few on beta8 but they came before, and it works cleanly against 4.8); and it's clear what the bug was and why this patch fixes it.\n\nPositive review.",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183273",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:9'></a>Patch applies against 5.0.beta8 (and 4.8) and runs; fixes the OP's symptom; has a doctest; doesn't introduce new doctest failures (I have quite a few on beta8 but they came before, and it works cleanly against 4.8); and it's clear what the bug was and why this patch fixes it.

Positive review.



---

archive/issue_comments_183274.json:
```json
{
    "body": "Changing author from \"\" to \"William Stein\"",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183274",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing author from "" to "William Stein"



---

archive/issue_comments_183275.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183275",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_034408.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-23T15:23:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12689#event-34408"
}
```



---

archive/issue_comments_183276.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.0.beta10\"",
    "created_at": "2012-03-23T15:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183276",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.0.beta10"



---

archive/issue_comments_183277.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-23T15:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-183277",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
