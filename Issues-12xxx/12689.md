# Issue 12689: Segfault in solve_left for sparse matrices over ZZ

archive/issues_012517.json:
```json
{
    "body": "Assignee: jason, was\n\nKeywords: segfault\n\nCalling solve_left on a sparse integer matrix results in an instant segfault:\n\n```\nsage: A = identity_matrix(ZZ, 2, sparse=True)\nsage: B = identity_matrix(ZZ, 2, sparse=True)\nsage: A.solve_left(B)\n/storage/masiao/sage-5.0.beta8/spkg/bin/sage: line 308:  7843 Segmentation fault      sage-ipython \"$@\" -i\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/12689\n\n",
    "closed_at": "2012-03-23T15:23:35Z",
    "created_at": "2012-03-18T19:16:31Z",
    "labels": [
        "component: linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Segfault in solve_left for sparse matrices over ZZ",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12689",
    "user": "https://github.com/loefflerd"
}
```
Assignee: jason, was

Keywords: segfault

Calling solve_left on a sparse integer matrix results in an instant segfault:

```
sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.solve_left(B)
/storage/masiao/sage-5.0.beta8/spkg/bin/sage: line 308:  7843 Segmentation fault      sage-ipython "$@" -i
```

Issue created by migration from https://trac.sagemath.org/ticket/12689





---

archive/issue_comments_148050.json:
```json
{
    "body": "We can push the bug a bit farther back:\n\n\n```\n\nsage: A = identity_matrix(ZZ, 2, sparse=True)\nsage: B = identity_matrix(ZZ, 2, sparse=True)\nsage: A.augment(B)\n[1 0 1 0]\n[0 1 0 1]\nsage: A.change_ring(QQ).augment(B.change_ring(QQ))\n[1 0 1 0]\n[0 1 0 1]\nsage: A.change_ring(QQ).augment(B)\n[  1   0 1/0   0]\n[  0   1   0 1/0]\n```\n\n1/0 doesn't look right..",
    "created_at": "2012-03-18T20:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148050",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

We can push the bug a bit farther back:


```

sage: A = identity_matrix(ZZ, 2, sparse=True)
sage: B = identity_matrix(ZZ, 2, sparse=True)
sage: A.augment(B)
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B.change_ring(QQ))
[1 0 1 0]
[0 1 0 1]
sage: A.change_ring(QQ).augment(B)
[  1   0 1/0   0]
[  0   1   0 1/0]
```

1/0 doesn't look right..



---

archive/issue_comments_148051.json:
```json
{
    "body": "Ah, okay.  I think I see what's going on.  In matrix_sparse.pyx's augment:\n\n```\n\n        cdef Matrix_sparse other = right.sparse_matrix()\n\n    [...]\n\n        if not (self._base_ring is right.base_ring()):\n            right = right.change_ring(self._base_ring)\n```\n\nattemps to change the right base ring to agree, but during the insertion process, it still uses the old unchanged one:\n\n```\n        for i, j in right.nonzero_positions(copy=False):\n            Z.set_unsafe(i, j + self._ncols, other.get_unsafe(i,j))\n```\n\nIf we instead use\n\n```\n\n            other = other.change_ring(self._base_ring)\n```\n\nthen everything seems to work:\n\n```\n\nsage: z = A.change_ring(QQ).augment(B)\n[skipping debugging output]\nsage: z\n[1 0 1 0]\n[0 1 0 1]\n```\n\nand \n\n```\n\nsage: A.solve_left(B)\n[1 0]\n[0 1]\nsage: parent(_)\nFull MatrixSpace of 2 by 2 sparse matrices over Rational Field\n\n```\n\nSo I think the fix is a one-liner.  Any takers?",
    "created_at": "2012-03-18T20:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148051",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Ah, okay.  I think I see what's going on.  In matrix_sparse.pyx's augment:

```

        cdef Matrix_sparse other = right.sparse_matrix()

    [...]

        if not (self._base_ring is right.base_ring()):
            right = right.change_ring(self._base_ring)
```

attemps to change the right base ring to agree, but during the insertion process, it still uses the old unchanged one:

```
        for i, j in right.nonzero_positions(copy=False):
            Z.set_unsafe(i, j + self._ncols, other.get_unsafe(i,j))
```

If we instead use

```

            other = other.change_ring(self._base_ring)
```

then everything seems to work:

```

sage: z = A.change_ring(QQ).augment(B)
[skipping debugging output]
sage: z
[1 0 1 0]
[0 1 0 1]
```

and 

```

sage: A.solve_left(B)
[1 0]
[0 1]
sage: parent(_)
Full MatrixSpace of 2 by 2 sparse matrices over Rational Field

```

So I think the fix is a one-liner.  Any takers?



---

archive/issue_comments_148052.json:
```json
{
    "body": "> Any takes? \n\n\nI'll post a patch if you'll review it :-)",
    "created_at": "2012-03-18T20:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148052",
    "user": "https://github.com/williamstein"
}
```

> Any takes? 


I'll post a patch if you'll review it :-)



---

archive/issue_comments_148053.json:
```json
{
    "body": "Deal.  Should probably add tests both in augment for the incompatible-ring bug and in solve_left for the original.",
    "created_at": "2012-03-18T21:02:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148053",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Deal.  Should probably add tests both in augment for the incompatible-ring bug and in solve_left for the original.



---

archive/issue_comments_148054.json:
```json
{
    "body": "Although since uses Z._subdivide_on_augment(self, right) uses right too, maybe it's a two-liner. :^)",
    "created_at": "2012-03-18T21:06:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148054",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Although since uses Z._subdivide_on_augment(self, right) uses right too, maybe it's a two-liner. :^)



---

archive/issue_comments_148055.json:
```json
{
    "body": "Attachment [trac_12689.patch](tarball://root/attachments/some-uuid/ticket12689/trac_12689.patch) by @williamstein created at 2012-03-18 21:14:13",
    "created_at": "2012-03-18T21:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148055",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12689.patch](tarball://root/attachments/some-uuid/ticket12689/trac_12689.patch) by @williamstein created at 2012-03-18 21:14:13



---

archive/issue_comments_148056.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-18T21:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148056",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_148057.json:
```json
{
    "body": "Running test suite now, but it looks fine. Don't forget that we have the new \":trac:`12689`\" markup now, though!",
    "created_at": "2012-03-18T21:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148057",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!



---

archive/issue_comments_148058.json:
```json
{
    "body": "Replying to [comment:7 dsm]:\n> Running test suite now, but it looks fine. Don't forget that we have the new \":trac:`12689`\" markup now, though!\n\n\nCool.  I've never heard of it.",
    "created_at": "2012-03-18T22:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148058",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:7 dsm]:
> Running test suite now, but it looks fine. Don't forget that we have the new ":trac:`12689`" markup now, though!


Cool.  I've never heard of it.



---

archive/issue_comments_148059.json:
```json
{
    "body": "Patch applies against 5.0.beta8 (and 4.8) and runs; fixes the OP's symptom; has a doctest; doesn't introduce new doctest failures (I have quite a few on beta8 but they came before, and it works cleanly against 4.8); and it's clear what the bug was and why this patch fixes it.\n\nPositive review.",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148059",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Patch applies against 5.0.beta8 (and 4.8) and runs; fixes the OP's symptom; has a doctest; doesn't introduce new doctest failures (I have quite a few on beta8 but they came before, and it works cleanly against 4.8); and it's clear what the bug was and why this patch fixes it.

Positive review.



---

archive/issue_comments_148060.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-19T03:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148060",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_034408.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-23T15:23:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12689#event-34408"
}
```



---

archive/issue_comments_148061.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-23T15:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12689",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12689#issuecomment-148061",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
