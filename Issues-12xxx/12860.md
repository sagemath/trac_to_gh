# Issue 12860: Incorrect computation of maximal orders in quaternion algebras

archive/issues_012688.json:
```json
{
    "body": "The maximal_order function of QuaternionOrder can produce incorrect results.\nIt is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i<sup>2</sup> and b=j<sup>2</sup> to have a special form. Not all the necessary conditions are checked by the code.\n\nE.g. the following is obviously not an order since it contains non-integral elements:\n\n```\nsage: A.<i,j,k> = QuaternionAlgebra(17)\nsage: print A.invariants()\n(-3, -17)\nsage: R = A.maximal_order()\nsage: b = R.basis()\nsage: print b\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\nsage: b[0]*b[1]\n9/2*i\nsage: (b[0]*b[1]).reduced_norm() \n243/4\n```\n\nBut this is ok, because now the invariants are as in Pizer's paper:\n\n```\nsage: A.<i,j,k> = QuaternionAlgebra(-17,-3)\nsage: print A.maximal_order().basis()\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\n```\n\nThis could be fixed by simply swapping (i,j) in the formula depending on the invariants, but the invariants can deviate from the required form in more than one way, again possibly resulting in failure of the formula:\n\n```\nsage: A.<i,j,k> = QuaternionAlgebra(-17*9,-3)\nsage: print A.maximal_order().basis()\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\nsage: print (-1/3*j - 1/3*k).reduced_norm()\n154/3\n```\n\n(#11464 is related)\n\nAssignee: @dansme\n\nReviewer: Aly Deines\n\nAuthor: Daniel Smertnig\n\nMerged: sage-5.3.beta0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12860\n\n",
    "closed_at": "2012-08-01T12:11:19Z",
    "created_at": "2012-04-19T20:39:36Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.3",
    "title": "Incorrect computation of maximal orders in quaternion algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12860",
    "user": "https://github.com/dansme"
}
```
The maximal_order function of QuaternionOrder can produce incorrect results.
It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i<sup>2</sup> and b=j<sup>2</sup> to have a special form. Not all the necessary conditions are checked by the code.

E.g. the following is obviously not an order since it contains non-integral elements:

```
sage: A.<i,j,k> = QuaternionAlgebra(17)
sage: print A.invariants()
(-3, -17)
sage: R = A.maximal_order()
sage: b = R.basis()
sage: print b
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: b[0]*b[1]
9/2*i
sage: (b[0]*b[1]).reduced_norm() 
243/4
```

But this is ok, because now the invariants are as in Pizer's paper:

```
sage: A.<i,j,k> = QuaternionAlgebra(-17,-3)
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
```

This could be fixed by simply swapping (i,j) in the formula depending on the invariants, but the invariants can deviate from the required form in more than one way, again possibly resulting in failure of the formula:

```
sage: A.<i,j,k> = QuaternionAlgebra(-17*9,-3)
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: print (-1/3*j - 1/3*k).reduced_norm()
154/3
```

(#11464 is related)

Assignee: @dansme

Reviewer: Aly Deines

Author: Daniel Smertnig

Merged: sage-5.3.beta0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12860





---

archive/issue_comments_160991.json:
```json
{
    "body": "<a id='comment:1'></a>The patch does the following:\n\n* Move `maximal_order` from `brandt.py` to `quaternion_algebra.py`.\n\n* Fix `maximal_order` to raise a NotImplementedError if the invariants are not of the expected form\n\n* Add checks in `*__init__*` of QuaternionOrder to verify if the given basis actually is the basis of an order (this would have catched the bug earlier).\n\n* Fix all the doctests that were expecting the mathematically incorrect results.",
    "created_at": "2012-04-19T21:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160991",
    "user": "https://github.com/dansme"
}
```

<a id='comment:1'></a>The patch does the following:

* Move `maximal_order` from `brandt.py` to `quaternion_algebra.py`.

* Fix `maximal_order` to raise a NotImplementedError if the invariants are not of the expected form

* Add checks in `*__init__*` of QuaternionOrder to verify if the given basis actually is the basis of an order (this would have catched the bug earlier).

* Fix all the doctests that were expecting the mathematically incorrect results.



---

archive/issue_comments_160992.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n The maximal_order function of QuaternionOrder can produce incorrect results.\n-It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i^2 and b=j^2 to have a special form. Not all the necessary conditions are checked by the code.\n+It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i<sup>2</sup> and b=j<sup>2</sup> to have a special form. Not all the necessary conditions are checked by the code.\n \n E.g. the following is obviously not an order since it contains non-integral elements:\n \n@@ -37,8 +37,6 @@\n \n (#11464 is related)\n \n-**Patch follows.**\n-\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/12860\n``````\n",
    "created_at": "2012-04-19T21:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160992",
    "user": "https://github.com/dansme"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 The maximal_order function of QuaternionOrder can produce incorrect results.
-It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i^2 and b=j^2 to have a special form. Not all the necessary conditions are checked by the code.
+It is implemented by means of an explicit formula, which expects not just the algebra to be ramified precisely at one finite prime p and infinity, but also expect the invariants a=i<sup>2</sup> and b=j<sup>2</sup> to have a special form. Not all the necessary conditions are checked by the code.
 
 E.g. the following is obviously not an order since it contains non-integral elements:
 
@@ -37,8 +37,6 @@
 
 (#11464 is related)
 
-**Patch follows.**
-
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/12860
``````




---

archive/issue_comments_160993.json:
```json
{
    "body": "<a id='comment:2'></a>See also #12861, for a patch extending this one by a more general algorithm.",
    "created_at": "2012-04-19T22:47:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160993",
    "user": "https://github.com/dansme"
}
```

<a id='comment:2'></a>See also #12861, for a patch extending this one by a more general algorithm.



---

archive/issue_comments_160994.json:
```json
{
    "body": "<a id='comment:3'></a>New patch applies to sage-5.0.beta13 (old one conflicted with #12461)",
    "created_at": "2012-04-20T09:54:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160994",
    "user": "https://github.com/dansme"
}
```

<a id='comment:3'></a>New patch applies to sage-5.0.beta13 (old one conflicted with #12461)



---

archive/issue_comments_160995.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-21T23:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160995",
    "user": "https://github.com/adeines"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160996.json:
```json
{
    "body": "<a id='comment:4'></a>Attachment [trac_12860_quat_order.patch](tarball://root/attachments/some-uuid/ticket12860/trac_12860_quat_order.patch) by @adeines created at 2012-07-21 23:15:52\n\nThis applies to sage-5.2.rc0 and all tests pass.  \n\nThis looks good to me!",
    "created_at": "2012-07-21T23:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160996",
    "user": "https://github.com/adeines"
}
```

<a id='comment:4'></a>Attachment [trac_12860_quat_order.patch](tarball://root/attachments/some-uuid/ticket12860/trac_12860_quat_order.patch) by @adeines created at 2012-07-21 23:15:52

This applies to sage-5.2.rc0 and all tests pass.  

This looks good to me!



---

archive/issue_comments_160997.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-21T23:16:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160997",
    "user": "https://github.com/adeines"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160998.json:
```json
{
    "body": "<a id='comment:6'></a>Please fill in your real name as Author.",
    "created_at": "2012-07-27T20:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160998",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Please fill in your real name as Author.



---

archive/issue_comments_160999.json:
```json
{
    "body": "<a id='comment:7'></a>Please fill in your real name as Reviewer.",
    "created_at": "2012-07-27T20:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-160999",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Please fill in your real name as Reviewer.



---

archive/issue_comments_161000.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-01T12:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12860#issuecomment-161000",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_035042.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-01T12:11:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12860",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12860#event-35042"
}
```
