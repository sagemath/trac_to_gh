# Issue 12993: Bug in computing the rank function a poset

archive/issues_012821.json:
```json
{
    "body": "This should return True:\n\n```\nsage: P = Poset(([1,2,3,4],[[1,4],[2,3],[3,4]]), facade = True)\nsage: P.is_ranked()\nFalse\n```\n\nAnne's suggestion from this [thread](https://groups.google.com/d/topic/sage-combinat-devel/XsMrxKdvl1A/discussion) on sage-combinat-devel:\n\n    For a finite poset perhaps the easiest would be to\n\n- start with a random element in the poset, assign rank 0\n- look at all covers and cocovers and assign the rank according to the recurrence rank(x) = rank(y) + 1 if x covers y.\n- repeat with the new elements\n- if at any point an element is reached again and is assigned a different value from before, the poset is not graded; otherwise continue with new elements\n\nApply: [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)\n\n**Assignee:** sage-combinat\n\n**CC:**  sage-combinat darijgrinberg@gmail.com\n\n**Keywords:** poset, combinat\n\n**Reviewer:** Christian Stump, Franco Saliola\n\n**Author:** Darij Grinberg, Anne Schilling\n\n**Merged:** sage-5.1.beta5\n\nIssue created by migration from https://trac.sagemath.org/ticket/12993\n\n",
    "closed_at": "2012-06-18T10:25:16Z",
    "created_at": "2012-05-23T01:14:25Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.1",
    "title": "Bug in computing the rank function a poset",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/12993",
    "user": "https://github.com/saliola"
}
```
This should return True:

```
sage: P = Poset(([1,2,3,4],[[1,4],[2,3],[3,4]]), facade = True)
sage: P.is_ranked()
False
```

Anne's suggestion from this [thread](https://groups.google.com/d/topic/sage-combinat-devel/XsMrxKdvl1A/discussion) on sage-combinat-devel:

    For a finite poset perhaps the easiest would be to

- start with a random element in the poset, assign rank 0
- look at all covers and cocovers and assign the rank according to the recurrence rank(x) = rank(y) + 1 if x covers y.
- repeat with the new elements
- if at any point an element is reached again and is assigned a different value from before, the poset is not graded; otherwise continue with new elements

Apply: [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)

**Assignee:** sage-combinat

**CC:**  sage-combinat darijgrinberg@gmail.com

**Keywords:** poset, combinat

**Reviewer:** Christian Stump, Franco Saliola

**Author:** Darij Grinberg, Anne Schilling

**Merged:** sage-5.1.beta5

Issue created by migration from https://trac.sagemath.org/ticket/12993





---

archive/issue_comments_149903.json:
```json
{
    "body": "<a id='comment:1'></a>\nDarij posted a proposed function here: [http://mit.edu/~darij/www/rf.txt](http://mit.edu/~darij/www/rf.txt)",
    "created_at": "2012-05-23T01:15:22Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149903",
    "user": "https://github.com/saliola"
}
```

<a id='comment:1'></a>
Darij posted a proposed function here: [http://mit.edu/~darij/www/rf.txt](http://mit.edu/~darij/www/rf.txt)



---

archive/issue_comments_149904.json:
```json
{
    "body": "<a id='comment:2'></a>\nHello Darij,\n\nI took a quick look at your code and have a few comments.\n\n1. You should add the poset that Anne provided illustrating the bug as a doctest in the examples section. This way, it is guaranteed to work in all future versions of Sage.\n\n2. I see that you are trying to create a list of empty lists. An easier and more efficient way to do this is:\n\n   [ [] for x in range(n) ]\n\n3. I see you are using these lists to construct lists of upper and lower covers. I think you should just use the `upper_covers` and `lower_covers` methods for posets, or the `neighbors_out` `neighbours_in` methods for Hasse diagrams.\n\n4. I would probably use a dictionary for `rank_fcn` instead of a list. This way you don't have to create a list of the required length beforehand.\n\n5. Your code first creates a function and then tests it to see if it is a rank function. Is it possible to do the tests as you are creating the function so that in case the poset is not graded, then we get an error as soon as one is detected? I haven't given it much thought. Maybe it isn't as efficient?",
    "created_at": "2012-05-23T01:36:24Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149904",
    "user": "https://github.com/saliola"
}
```

<a id='comment:2'></a>
Hello Darij,

I took a quick look at your code and have a few comments.

1. You should add the poset that Anne provided illustrating the bug as a doctest in the examples section. This way, it is guaranteed to work in all future versions of Sage.

2. I see that you are trying to create a list of empty lists. An easier and more efficient way to do this is:

   [ [] for x in range(n) ]

3. I see you are using these lists to construct lists of upper and lower covers. I think you should just use the `upper_covers` and `lower_covers` methods for posets, or the `neighbors_out` `neighbours_in` methods for Hasse diagrams.

4. I would probably use a dictionary for `rank_fcn` instead of a list. This way you don't have to create a list of the required length beforehand.

5. Your code first creates a function and then tests it to see if it is a rank function. Is it possible to do the tests as you are creating the function so that in case the poset is not graded, then we get an error as soon as one is detected? I haven't given it much thought. Maybe it isn't as efficient?



---

archive/issue_comments_149905.json:
```json
{
    "body": "**Author:** Darij Grinberg, Anne Schilling",
    "created_at": "2012-05-23T18:36:57Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149905",
    "user": "https://github.com/anneschilling"
}
```

**Author:** Darij Grinberg, Anne Schilling



---

archive/issue_events_108975.json:
```json
{
    "actor": "https://github.com/anneschilling",
    "created_at": "2012-05-23T18:36:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108975"
}
```



---

archive/issue_comments_149906.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n ```\n sage: P = Poset(([1,2,3,4],[[1,4],[2,3],[3,4]]), facade = True)\n-sage: P.is_graded()\n+sage: P.is_ranked()\n False\n ```\n \n``````\n",
    "created_at": "2012-05-23T21:19:06Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149906",
    "user": "https://github.com/saliola"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 ```
 sage: P = Poset(([1,2,3,4],[[1,4],[2,3],[3,4]]), facade = True)
-sage: P.is_graded()
+sage: P.is_ranked()
 False
 ```
 
``````




---

archive/issue_events_108976.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2012-05-23T21:19:06Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "rename": {
        "from": "Bug in determining whether a poset is graded",
        "to": "Bug in computing the rank function a poset"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108976"
}
```



---

archive/issue_comments_149907.json:
```json
{
    "body": "<a id='comment:5'></a>\nHello --\n\nI pushed a new version of the algorithm that speeds quite a bit, and also modified the show method to get the grading properly. If you are fine with it, I would then finalizing the review (though it might be better if someone else looks at my algo and tries to break it).\n\nBest, Christian",
    "created_at": "2012-05-24T15:05:51Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149907",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:5'></a>
Hello --

I pushed a new version of the algorithm that speeds quite a bit, and also modified the show method to get the grading properly. If you are fine with it, I would then finalizing the review (though it might be better if someone else looks at my algo and tries to break it).

Best, Christian



---

archive/issue_comments_149908.json:
```json
{
    "body": "<a id='comment:6'></a>\nChristian, you forgot to attach your patch.",
    "created_at": "2012-05-25T13:19:15Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149908",
    "user": "https://github.com/saliola"
}
```

<a id='comment:6'></a>
Christian, you forgot to attach your patch.



---

archive/issue_comments_149909.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [@saliola](#comment%3A6):\n> Christian, you forgot to attach your patch.\n\nI uploaded the file -- actually I thought it is enough to push it to the queue so you guys can look at it...",
    "created_at": "2012-05-25T13:57:24Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149909",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:7'></a>
Replying to [@saliola](#comment%3A6):
> Christian, you forgot to attach your patch.

I uploaded the file -- actually I thought it is enough to push it to the queue so you guys can look at it...



---

archive/issue_comments_149910.json:
```json
{
    "body": "<a id='comment:8'></a>\n1. I think Darij is not yet completely configured with the sage-combinat queue.\n\n2. If you push it to the queue only, you are effectively restricting the number of people that will look at the patch. There are people that can review patches that don't use sage-combinat and some that have no intention of using sage-combinat.",
    "created_at": "2012-05-25T14:39:43Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149910",
    "user": "https://github.com/saliola"
}
```

<a id='comment:8'></a>
1. I think Darij is not yet completely configured with the sage-combinat queue.

2. If you push it to the queue only, you are effectively restricting the number of people that will look at the patch. There are people that can review patches that don't use sage-combinat and some that have no intention of using sage-combinat.



---

archive/issue_comments_149911.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [@saliola](#comment%3A8):\n> 1. I think Darij is not yet completely configured with the sage-combinat queue.\n> \n> 2. If you push it to the queue only, you are effectively restricting the number of people that will look at the patch. There are people that can review patches that don't use sage-combinat and some that have no intention of using sage-combinat.\n\nright, right, it's here now.",
    "created_at": "2012-05-25T14:58:20Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149911",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:9'></a>
Replying to [@saliola](#comment%3A8):
> 1. I think Darij is not yet completely configured with the sage-combinat queue.
> 
> 2. If you push it to the queue only, you are effectively restricting the number of people that will look at the patch. There are people that can review patches that don't use sage-combinat and some that have no intention of using sage-combinat.

right, right, it's here now.



---

archive/issue_comments_149912.json:
```json
{
    "body": "<a id='comment:10'></a>\nChristian,\n\nNice idea to use the `rank_function` for the plot method!\n\nI don't like this loop:\n\n```\n579\t                for i,j in edges:           # to find new elements, we run through all edges of the Hasse diagram\n580\t                    if i in rank_fcn:\n                            ...\n589\t                    else: \n590\t                        if j in rank_fcn:   # as above \n```\nThis means that you will be looking at edges multiple times until one of them has been assigned a rank. You are also looking at edges in other connected components. If there are several connected components, then this will take too long. For example,\n\n```\nsage: P = lambda n : Poset([range(n), [(i,i+1) for i in range(0,n,2)]])\nsage: time p = P(10000); p\nTime: CPU 2.32 s, Wall: 2.32 s\nFinite poset containing 10000 elements\nsage: time p.is_ranked()\nTrue\nTime: CPU 13.35 s, Wall: 13.36 s\n```\nWith Darij and Anne's patch, this only takes 0.99s.\n\nI'm preparing a patch right now to address this.",
    "created_at": "2012-05-25T16:30:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149912",
    "user": "https://github.com/saliola"
}
```

<a id='comment:10'></a>
Christian,

Nice idea to use the `rank_function` for the plot method!

I don't like this loop:

```
579	                for i,j in edges:           # to find new elements, we run through all edges of the Hasse diagram
580	                    if i in rank_fcn:
                            ...
589	                    else: 
590	                        if j in rank_fcn:   # as above 
```
This means that you will be looking at edges multiple times until one of them has been assigned a rank. You are also looking at edges in other connected components. If there are several connected components, then this will take too long. For example,

```
sage: P = lambda n : Poset([range(n), [(i,i+1) for i in range(0,n,2)]])
sage: time p = P(10000); p
Time: CPU 2.32 s, Wall: 2.32 s
Finite poset containing 10000 elements
sage: time p.is_ranked()
True
Time: CPU 13.35 s, Wall: 13.36 s
```
With Darij and Anne's patch, this only takes 0.99s.

I'm preparing a patch right now to address this.



---

archive/issue_comments_149913.json:
```json
{
    "body": "<a id='comment:11'></a>\n> I don't like this loop:\n> \n> ```\n> 579\t                for i,j in edges:           # to find new elements, we run through all edges of the Hasse diagram\n> 580\t                    if i in rank_fcn:\n>                             ...\n> 589\t                    else: \n> 590\t                        if j in rank_fcn:   # as above \n> ```\n> This means that you will be looking at edges multiple times until one of them has been assigned a rank. You are also looking at edges in other connected components. If there are several connected components, then this will take too long. For example,\n\nThat is right -- I first had taken the connected components into account as Darij and Anne did it, but in the examples I had it was always faster to not first compute th connected components. A second thing I had was to delete an edge after it was found to have both vertices ranked and the rank comparison tested (since we will not get any new info back from doing this test again). But also that seemed to take for small posets more time than running through all edges again and again.\n\nI guess that for larger posets, it is worth first computing the connected components (but only because that is done in the backbone of graphs and thus really fast), and also deleting edges that are not needed anymore.\n\nDo you first want me to put these things in my algo, or do you wanna do it?",
    "created_at": "2012-05-25T17:05:14Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149913",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:11'></a>
> I don't like this loop:
> 
> ```
> 579	                for i,j in edges:           # to find new elements, we run through all edges of the Hasse diagram
> 580	                    if i in rank_fcn:
>                             ...
> 589	                    else: 
> 590	                        if j in rank_fcn:   # as above 
> ```
> This means that you will be looking at edges multiple times until one of them has been assigned a rank. You are also looking at edges in other connected components. If there are several connected components, then this will take too long. For example,

That is right -- I first had taken the connected components into account as Darij and Anne did it, but in the examples I had it was always faster to not first compute th connected components. A second thing I had was to delete an edge after it was found to have both vertices ranked and the rank comparison tested (since we will not get any new info back from doing this test again). But also that seemed to take for small posets more time than running through all edges again and again.

I guess that for larger posets, it is worth first computing the connected components (but only because that is done in the backbone of graphs and thus really fast), and also deleting edges that are not needed anymore.

Do you first want me to put these things in my algo, or do you wanna do it?



---

archive/issue_comments_149914.json:
```json
{
    "body": "<a id='comment:12'></a>\nHere is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).\n\nIt looks at each edge exactly twice.\n\nI also updated the documentation for Poset.rank_function.\n\nChristian: I see you didn't run the doctests. I had to fix your attempt at using rank_function for plotting.\n\nAlso, there is a pickling error that got introduced by your patch in posets.py, but I can't replicated it from within Sage. I don't have time to debug this now, so go ahead and try to sort it out.\n\n**Edit:** Here is the doctest failure message:\n\n```\nsage -t  \"devel/sage-reviews/sage/combinat/posets/posets.py\"\n**********************************************************************\nFile \"/Users/saliola/Applications/sage-5.0/devel/sage-reviews/sage/combinat/posets/posets.py\", line 545:\n    sage: TestSuite(P).run()\nExpected nothing\nGot:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n      File \"/Users/saliola/Applications/sage-5.0/local/lib/python/site-packages/sage/misc/sage_unittest.py\", line 275, in run\n        test_method(tester = tester)\n      File \"sage_object.pyx\", line 396, in sage.structure.sage_object.SageObject._test_pickling (sage/structure/sage_object.c:3197)\n      File \"sage_object.pyx\", line 889, in sage.structure.sage_object.dumps (sage/structure/sage_object.c:9006)\n    TypeError: expected string or Unicode object, NoneType found\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\n**********************************************************************\n```",
    "created_at": "2012-05-25T17:15:36Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149914",
    "user": "https://github.com/saliola"
}
```

<a id='comment:12'></a>
Here is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).

It looks at each edge exactly twice.

I also updated the documentation for Poset.rank_function.

Christian: I see you didn't run the doctests. I had to fix your attempt at using rank_function for plotting.

Also, there is a pickling error that got introduced by your patch in posets.py, but I can't replicated it from within Sage. I don't have time to debug this now, so go ahead and try to sort it out.

**Edit:** Here is the doctest failure message:

```
sage -t  "devel/sage-reviews/sage/combinat/posets/posets.py"
**********************************************************************
File "/Users/saliola/Applications/sage-5.0/devel/sage-reviews/sage/combinat/posets/posets.py", line 545:
    sage: TestSuite(P).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/Users/saliola/Applications/sage-5.0/local/lib/python/site-packages/sage/misc/sage_unittest.py", line 275, in run
        test_method(tester = tester)
      File "sage_object.pyx", line 396, in sage.structure.sage_object.SageObject._test_pickling (sage/structure/sage_object.c:3197)
      File "sage_object.pyx", line 889, in sage.structure.sage_object.dumps (sage/structure/sage_object.c:9006)
    TypeError: expected string or Unicode object, NoneType found
    ------------------------------------------------------------
    The following tests failed: _test_pickling
**********************************************************************
```



---

archive/issue_comments_149915.json:
```json
{
    "body": "<a id='comment:13'></a>\nHi Christian and Franco,\n\nThank you for your review patches and investigating this! Franco, conversely, can I ask\nyou to push your review patch to the sage-combinat queue? That would be easier for me and we\ncan fold all patches once everyone is happy!\n\nI'll be traveling back to Davis soon (from Oberwolfach), so might not have internet in the meantime.\n\nAnne",
    "created_at": "2012-05-25T17:40:34Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149915",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:13'></a>
Hi Christian and Franco,

Thank you for your review patches and investigating this! Franco, conversely, can I ask
you to push your review patch to the sage-combinat queue? That would be easier for me and we
can fold all patches once everyone is happy!

I'll be traveling back to Davis soon (from Oberwolfach), so might not have internet in the meantime.

Anne



---

archive/issue_comments_149916.json:
```json
{
    "body": "**Reviewer:** Christian Stump, Franco Saliola",
    "created_at": "2012-05-25T17:41:26Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149916",
    "user": "https://github.com/anneschilling"
}
```

**Reviewer:** Christian Stump, Franco Saliola



---

archive/issue_comments_149917.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [@anneschilling](#comment%3A13):\n> Franco, conversely, can I ask you to push your review patch to the sage-combinat queue?\n\nI pushed it",
    "created_at": "2012-05-25T18:01:32Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149917",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:15'></a>
Replying to [@anneschilling](#comment%3A13):
> Franco, conversely, can I ask you to push your review patch to the sage-combinat queue?

I pushed it



---

archive/issue_comments_149918.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [@saliola](#comment%3A12):\n> Here is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).\n> \n> It looks at each edge exactly twice.\n\nyour code is certainly cleaner than mine was!\n\nI don't see why, but my method seems to be twice as fast for boolean lattices (tested with up to sets of size 8). I would still vote for keeping yours since you have examples where it is much faster, and the code is nicer as well.",
    "created_at": "2012-05-25T18:21:07Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149918",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:16'></a>
Replying to [@saliola](#comment%3A12):
> Here is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).
> 
> It looks at each edge exactly twice.

your code is certainly cleaner than mine was!

I don't see why, but my method seems to be twice as fast for boolean lattices (tested with up to sets of size 8). I would still vote for keeping yours since you have examples where it is much faster, and the code is nicer as well.



---

archive/issue_comments_149919.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [stumpc5](#comment%3A16):\n> Replying to [@saliola](#comment%3A12):\n> > Here is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).\n> > \n> > It looks at each edge exactly twice.\n\n> \n> your code is certainly cleaner than mine was!\n> \n> I don't see why, but my method seems to be twice as fast for boolean lattices (tested with up to sets of size 8). I would still vote for keeping yours since you have examples where it is much faster, and the code is nicer as well.\n\nThanks for pushing my patch.\n\nThe algorithm starts with some vertex, and propagates the value of the rank function along incoming *and* outgoing edges. If there is a unique minimal vertex in each connected component, then we could just use outgoing edges starting from that minimal vertex. Otherwise, we have to go backwards along some edges.",
    "created_at": "2012-05-25T21:23:23Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149919",
    "user": "https://github.com/saliola"
}
```

<a id='comment:17'></a>
Replying to [stumpc5](#comment%3A16):
> Replying to [@saliola](#comment%3A12):
> > Here is a review patch. Apply on top of Christian's review patch (which goes on top of Anne's).
> > 
> > It looks at each edge exactly twice.

> 
> your code is certainly cleaner than mine was!
> 
> I don't see why, but my method seems to be twice as fast for boolean lattices (tested with up to sets of size 8). I would still vote for keeping yours since you have examples where it is much faster, and the code is nicer as well.

Thanks for pushing my patch.

The algorithm starts with some vertex, and propagates the value of the rank function along incoming *and* outgoing edges. If there is a unique minimal vertex in each connected component, then we could just use outgoing edges starting from that minimal vertex. Otherwise, we have to go backwards along some edges.



---

archive/issue_comments_149920.json:
```json
{
    "body": "<a id='comment:18'></a>\nI just uploaded a new review patch with a small change. I changed one line:\n\n```\n    m = min(rank_fcn.values()) \n```\nto\n\n```\n    m = min(rank_fcn[j] for j in component)\n```\nin order to renormalize each connected component.\n\nI also pushed my change to the sage-combinat queue.",
    "created_at": "2012-05-25T21:28:25Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149920",
    "user": "https://github.com/saliola"
}
```

<a id='comment:18'></a>
I just uploaded a new review patch with a small change. I changed one line:

```
    m = min(rank_fcn.values()) 
```
to

```
    m = min(rank_fcn[j] for j in component)
```
in order to renormalize each connected component.

I also pushed my change to the sage-combinat queue.



---

archive/issue_comments_149921.json:
```json
{
    "body": "<a id='comment:19'></a>\nThe review patch looks good to me.\n\nAnne",
    "created_at": "2012-05-25T22:25:49Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149921",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:19'></a>
The review patch looks good to me.

Anne



---

archive/issue_comments_149922.json:
```json
{
    "body": "<a id='comment:20'></a>\nHello Anne,\n\nIs the documentation satisfactory?\n\nWe still haven't decided about \"graded\" vs \"ranked\" (whether they mean the same thing or not), but that's for another ticket. Or it can be our next \"Sage Days Discussion\". :-)",
    "created_at": "2012-05-26T12:20:54Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149922",
    "user": "https://github.com/saliola"
}
```

<a id='comment:20'></a>
Hello Anne,

Is the documentation satisfactory?

We still haven't decided about "graded" vs "ranked" (whether they mean the same thing or not), but that's for another ticket. Or it can be our next "Sage Days Discussion". :-)



---

archive/issue_comments_149923.json:
```json
{
    "body": "<a id='comment:21'></a>\nHello Franco,\n\nI had added something to the documentation of rank function (about what happens when there are several components and how the normalization works). So this is fine with me.\n\nYes, there is the issue about is_ranked versus is_graded. Perhaps we should indeed discuss this at the next Sage Days in Minneapolis. At least now Sage does what the documentation says it does! I could add a link from is_graded and is_ranked to rank_function, so that it is easier for the user to find that definition. What do you think?\n\nI could fold all three patches, add this link, post it here and on sage-combinat and you or Christian could have a final look.\n\nBest,\n\nAnne",
    "created_at": "2012-05-28T15:22:34Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149923",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:21'></a>
Hello Franco,

I had added something to the documentation of rank function (about what happens when there are several components and how the normalization works). So this is fine with me.

Yes, there is the issue about is_ranked versus is_graded. Perhaps we should indeed discuss this at the next Sage Days in Minneapolis. At least now Sage does what the documentation says it does! I could add a link from is_graded and is_ranked to rank_function, so that it is easier for the user to find that definition. What do you think?

I could fold all three patches, add this link, post it here and on sage-combinat and you or Christian could have a final look.

Best,

Anne



---

archive/issue_comments_149924.json:
```json
{
    "body": "<a id='comment:22'></a>\nHello Anne,\n\nReplying to [@anneschilling](#comment%3A21): \n> I could add a link from is_graded and is_ranked to rank_function, so that it is easier for the user to find that definition. What do you think?\n\n>\n> I could fold all three patches, add this link, post it here and on sage-combinat and you or Christian could have a final look.\n\nGreat idea. What about \"see also\" sections for is_graded and is_ranked that point to each other? Perhaps this is what you meant by \"add a link\"?\n\nFranco",
    "created_at": "2012-05-28T17:50:35Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149924",
    "user": "https://github.com/saliola"
}
```

<a id='comment:22'></a>
Hello Anne,

Replying to [@anneschilling](#comment%3A21): 
> I could add a link from is_graded and is_ranked to rank_function, so that it is easier for the user to find that definition. What do you think?

>
> I could fold all three patches, add this link, post it here and on sage-combinat and you or Christian could have a final look.

Great idea. What about "see also" sections for is_graded and is_ranked that point to each other? Perhaps this is what you meant by "add a link"?

Franco



---

archive/issue_comments_149925.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -14,3 +14,5 @@\n - look at all covers and cocovers and assign the rank according to the recurrence rank(x) = rank(y) + 1 if x covers y.\n - repeat with the new elements\n - if at any point an element is reached again and is assigned a different value from before, the poset is not graded; otherwise continue with new elements\n+\n+Apply: [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)\n``````\n",
    "created_at": "2012-05-28T21:03:28Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149925",
    "user": "https://github.com/anneschilling"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -14,3 +14,5 @@
 - look at all covers and cocovers and assign the rank according to the recurrence rank(x) = rank(y) + 1 if x covers y.
 - repeat with the new elements
 - if at any point an element is reached again and is assigned a different value from before, the poset is not graded; otherwise continue with new elements
+
+Apply: [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)
``````




---

archive/issue_comments_149926.json:
```json
{
    "body": "<a id='comment:24'></a>\nHello Franco and Christian,\n\nI folded the patches and added the links to the rank_function method from is_graded and is_ranked. However, perhaps this was premature since like Franco I get the pickling failure in the doctests which I also cannot reproduce inside sage.\n\nAny idea on how to fix this? I gues this introduced through Christian's review patch by adding the height???\n\nBest,\n\nAnne",
    "created_at": "2012-05-28T21:05:59Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149926",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:24'></a>
Hello Franco and Christian,

I folded the patches and added the links to the rank_function method from is_graded and is_ranked. However, perhaps this was premature since like Franco I get the pickling failure in the doctests which I also cannot reproduce inside sage.

Any idea on how to fix this? I gues this introduced through Christian's review patch by adding the height???

Best,

Anne



---

archive/issue_comments_149927.json:
```json
{
    "body": "<a id='comment:25'></a>\nFor the patchbot:\n\n    Apply [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)\n\n(According to the [buildbot wiki page](http://wiki.sagemath.org/buildbot), under \"Hints and tricks\", the patch list directive does not work in ticket descriptions.)",
    "created_at": "2012-05-29T15:29:17Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149927",
    "user": "https://github.com/saliola"
}
```

<a id='comment:25'></a>
For the patchbot:

    Apply [attachment:trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)

(According to the [buildbot wiki page](http://wiki.sagemath.org/buildbot), under "Hints and tricks", the patch list directive does not work in ticket descriptions.)



---

archive/issue_comments_149928.json:
```json
{
    "body": "<a id='comment:26'></a>\nHi!\n\nThe following seems the line causing the pickling failure\n\n+        rank_function = self.rank_function()\n\nSo I will remove the height function stuff that Christian added, since I have no idea how to fix this pickling failure otherwise.\n\nCould you please review the new patch?\n\nThanks,\n\nAnne",
    "created_at": "2012-06-02T01:29:04Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149928",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:26'></a>
Hi!

The following seems the line causing the pickling failure

+        rank_function = self.rank_function()

So I will remove the height function stuff that Christian added, since I have no idea how to fix this pickling failure otherwise.

Could you please review the new patch?

Thanks,

Anne



---

archive/attachments_018157.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_12993-graded_poset-folded-as.patch",
    "asset_url": "tarball://root/attachments/ticket12993/trac_12993-graded_poset-folded-as.patch",
    "created_at": "2012-06-02T01:34:50Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch",
    "user": "https://github.com/anneschilling"
}
```



---

archive/issue_comments_149929.json:
```json
{
    "body": "**Attachment:** [trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)",
    "created_at": "2012-06-02T01:34:50Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149929",
    "user": "https://github.com/anneschilling"
}
```

**Attachment:** [trac_12993-graded_poset-folded-as.patch](https://github.com/sagemath/sage/files/ticket12993/trac_12993-graded_poset-folded-as.patch)



---

archive/issue_comments_149930.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [@anneschilling](#comment%3A26):\n> Could you please review the new patch?\n\nI also don't know how to fix the pickling thing...\n\nBeside that, I give it a positive review assuming the patchbot doesn't make any trouble. Franco, do you want to have a look at the plotting issue, or should we let it go as is?",
    "created_at": "2012-06-02T09:53:48Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149930",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

<a id='comment:27'></a>
Replying to [@anneschilling](#comment%3A26):
> Could you please review the new patch?

I also don't know how to fix the pickling thing...

Beside that, I give it a positive review assuming the patchbot doesn't make any trouble. Franco, do you want to have a look at the plotting issue, or should we let it go as is?



---

archive/issue_events_108977.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2012-06-02T14:45:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108977"
}
```



---

archive/issue_events_108978.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2012-06-02T14:45:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108978"
}
```



---

archive/issue_comments_149931.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [stumpc5](#comment%3A27):\n> Franco, do you want to have a look at the plotting issue, or should we let it go as is?\n\nThat shouldn't hold back this patch. It should be another ticket **(Edit: #13079)**.\n\nApply trac_12993-graded_poset-folded-as.patch",
    "created_at": "2012-06-02T14:45:26Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149931",
    "user": "https://github.com/saliola"
}
```

<a id='comment:28'></a>
Replying to [stumpc5](#comment%3A27):
> Franco, do you want to have a look at the plotting issue, or should we let it go as is?

That shouldn't hold back this patch. It should be another ticket **(Edit: #13079)**.

Apply trac_12993-graded_poset-folded-as.patch



---

archive/issue_comments_149932.json:
```json
{
    "body": "<a id='comment:29'></a>\nThank you! I saw that you opened #13079 to work on the height function for plotting.\nChristian, in the sage-combinat queue, you can probably rename you trac_???? patch to this ticket number.\n\nAnne",
    "created_at": "2012-06-02T15:39:33Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149932",
    "user": "https://github.com/anneschilling"
}
```

<a id='comment:29'></a>
Thank you! I saw that you opened #13079 to work on the height function for plotting.
Christian, in the sage-combinat queue, you can probably rename you trac_???? patch to this ticket number.

Anne



---

archive/issue_events_108979.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-18T10:25:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108979"
}
```



---

archive/issue_events_108980.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-18T10:25:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12993#event-108980"
}
```



---

archive/issue_comments_149933.json:
```json
{
    "body": "**Merged:** sage-5.1.beta5",
    "created_at": "2012-06-18T10:25:16Z",
    "issue": "https://github.com/sagemath/sage/issues/12993",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12993#issuecomment-149933",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.1.beta5
