# Issue 12892: Toric fibration morphisms

archive/issues_012720.json:
```json
{
    "body": "This ticket provides more morphisms that are associated to toric varieties:\n* embedding of an orbit closure\n* embedding of a fiber of a toric morphism\n* pull-back of divisors\n\nUse the git branch!\n\nAssignee: @aghitza\n\nCC:  @novoselt jkeitel\n\nKeywords: sd40.5 sd53 toric\n\nBranch/Commit: b3f06ed5bb902f1f4ce0f3f11935cf62101137d0\n\nReviewer: Andrey Novoseltsev\n\nAuthor: Volker Braun\n\nDependencies: #12361, #13023, #14353\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12892\n\n",
    "closed_at": "2014-04-01T00:11:42Z",
    "created_at": "2012-04-30T21:40:05Z",
    "labels": [
        "component: algebraic geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Toric fibration morphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12892",
    "user": "https://github.com/vbraun"
}
```
This ticket provides more morphisms that are associated to toric varieties:
* embedding of an orbit closure
* embedding of a fiber of a toric morphism
* pull-back of divisors

Use the git branch!

Assignee: @aghitza

CC:  @novoselt jkeitel

Keywords: sd40.5 sd53 toric

Branch/Commit: b3f06ed5bb902f1f4ce0f3f11935cf62101137d0

Reviewer: Andrey Novoseltsev

Author: Volker Braun

Dependencies: #12361, #13023, #14353

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12892





---

archive/issue_comments_152090.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-30T21:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152090",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_152091.json:
```json
{
    "body": "<a id='comment:2'></a>This looks very cool, I plan to go over details in a couple weeks or sooner.",
    "created_at": "2012-05-02T16:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152091",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>This looks very cool, I plan to go over details in a couple weeks or sooner.



---

archive/issue_comments_152092.json:
```json
{
    "body": "<a id='comment:3'></a>In 3 weeks we can also talk about it in person in Seattle :-)",
    "created_at": "2012-05-02T17:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152092",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>In 3 weeks we can also talk about it in person in Seattle :-)



---

archive/issue_comments_152093.json:
```json
{
    "body": "<a id='comment:5'></a>I find the first patch a bit difficult to understand due to mixing several things defining the embedding: a cone and two dictionaries of rays. Also `defining_cone` argument is not documented in the constructor of the orbit morphism.\n\nOrbits are in 1:1 correspondence with cones of the original fan, so it makes perfect sense to pass this information and store it (as it is currently done in the patch).\n\nMathematically, this is all that is needed, but since we have so far issues with supporting quotient lattices and instead the fan of the orbit lives in a \"regular lattice\", we need to keep the correspondence somehow. As it is done by some matrix, perhaps that's what we need to pass to the constructor and store.\n\nInstead, the current version constructs a codomain_ray->domain_ray dictionary, it is passed to the constructor and constructor reverses it into domain_ray->codomain_index dictionary. Note that the map does not have to be one-to-one for non-simplicial fans, so this dictionary just picks some random representative for a domain ray. The choice may affect the decision on whether embedding can be realized as a polynomial map or not.\n\nI also think it is confusing to store non-primitive generators for rays and treat a ray as not found if a non-primitive generator is found. We do represent rays throughout the code just by their generators, but it is always assumed that they are normalized.\n\nAs a feature request it would be nice to have support for maps given by homogeneous polynomials in the other direction, i.e. a map from the 12 orbit of P112 to P1 can be given as (0:z1:z2) -> (z1^2:z2) and this will work for all orbits with powers corresponding to that \"non-primitivity of generators\". Or is it already implemented and I am missing something?\n\nAnyway, concretely: how about passing and storing `defining_cone` and `projection_matrix` as base pieces of data and relying on them for consecutive computations?",
    "created_at": "2012-05-24T17:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152093",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:5'></a>I find the first patch a bit difficult to understand due to mixing several things defining the embedding: a cone and two dictionaries of rays. Also `defining_cone` argument is not documented in the constructor of the orbit morphism.

Orbits are in 1:1 correspondence with cones of the original fan, so it makes perfect sense to pass this information and store it (as it is currently done in the patch).

Mathematically, this is all that is needed, but since we have so far issues with supporting quotient lattices and instead the fan of the orbit lives in a "regular lattice", we need to keep the correspondence somehow. As it is done by some matrix, perhaps that's what we need to pass to the constructor and store.

Instead, the current version constructs a codomain_ray->domain_ray dictionary, it is passed to the constructor and constructor reverses it into domain_ray->codomain_index dictionary. Note that the map does not have to be one-to-one for non-simplicial fans, so this dictionary just picks some random representative for a domain ray. The choice may affect the decision on whether embedding can be realized as a polynomial map or not.

I also think it is confusing to store non-primitive generators for rays and treat a ray as not found if a non-primitive generator is found. We do represent rays throughout the code just by their generators, but it is always assumed that they are normalized.

As a feature request it would be nice to have support for maps given by homogeneous polynomials in the other direction, i.e. a map from the 12 orbit of P112 to P1 can be given as (0:z1:z2) -> (z1^2:z2) and this will work for all orbits with powers corresponding to that "non-primitivity of generators". Or is it already implemented and I am missing something?

Anyway, concretely: how about passing and storing `defining_cone` and `projection_matrix` as base pieces of data and relying on them for consecutive computations?



---

archive/issue_comments_152094.json:
```json
{
    "body": "<a id='comment:6'></a>For the patchbot (which should read the description...)\n\nApply trac_12892_orbit_closure_morphism.patch, trac_12892_toric_morphism_fibers.patch, trac_12892_toric_morphism_divisors.patch",
    "created_at": "2012-05-24T17:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152094",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>For the patchbot (which should read the description...)

Apply trac_12892_orbit_closure_morphism.patch, trac_12892_toric_morphism_fibers.patch, trac_12892_toric_morphism_divisors.patch



---

archive/issue_comments_152095.json:
```json
{
    "body": "<a id='comment:7'></a>As discussed with Andrey, the existence of polynomial map doesn't depend on the choices made.\n\nUpdated patch to add some clarifications.",
    "created_at": "2012-05-25T03:17:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152095",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>As discussed with Andrey, the existence of polynomial map doesn't depend on the choices made.

Updated patch to add some clarifications.



---

archive/issue_comments_152096.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd40.5\".",
    "created_at": "2012-05-25T04:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152096",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "sd40.5".



---

archive/issue_comments_152097.json:
```json
{
    "body": "<a id='comment:9'></a>OK to the first patch!",
    "created_at": "2012-05-25T17:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152097",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'></a>OK to the first patch!



---

archive/issue_comments_152098.json:
```json
{
    "body": "<a id='comment:10'></a>For the second patch:\n1. `relative_star_generators` does not have INPUT/OUTPUT and in general it would be nice to have a clear description of what it does.\n2. Can we please rename `fiber` to `generic_fiber`? (I would expect that `fiber` would return a particular one based on some input.) Also - why the documentation says that it returns a connected component, isn't it unique for a generic fiber?\n3. I also got confused by `fiber_component` name thinking it computes the fiber over points corresponding to higher-dimensional cones of the codomain. After some more thinking and reading I think that it is indeed the correct name, but would be nice to describe in the documentation the structure of non-generic fibers and why it makes more sense to work with components corresponding to domain cones rather than fibers of codomain ones.\n4. `fiber_component` and `fiber_dimension` also lack INPUT/OUTPUT blocks.\n5. `SchemeMorphism_fan_fiber_toric_variety` input documentation does not match the code.\n6. Perhaps the name of the class can be changed to `..._fiber_component_...` since it does not operate with the whole fiber.\n7. \"Defined by embedding the fiber irreducible component defined by the primitive preimage cone 1-d cone of Rational polyhedral fan in 4-d lattice N.\" does not read. While I was trying to reformulate it, I became unsure of this class at all. Isn't it just about embedding a torus orbit closure into the original toric variety? I.e. the toric morphism and fibers are not important?",
    "created_at": "2012-05-27T19:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152098",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:10'></a>For the second patch:
1. `relative_star_generators` does not have INPUT/OUTPUT and in general it would be nice to have a clear description of what it does.
2. Can we please rename `fiber` to `generic_fiber`? (I would expect that `fiber` would return a particular one based on some input.) Also - why the documentation says that it returns a connected component, isn't it unique for a generic fiber?
3. I also got confused by `fiber_component` name thinking it computes the fiber over points corresponding to higher-dimensional cones of the codomain. After some more thinking and reading I think that it is indeed the correct name, but would be nice to describe in the documentation the structure of non-generic fibers and why it makes more sense to work with components corresponding to domain cones rather than fibers of codomain ones.
4. `fiber_component` and `fiber_dimension` also lack INPUT/OUTPUT blocks.
5. `SchemeMorphism_fan_fiber_toric_variety` input documentation does not match the code.
6. Perhaps the name of the class can be changed to `..._fiber_component_...` since it does not operate with the whole fiber.
7. "Defined by embedding the fiber irreducible component defined by the primitive preimage cone 1-d cone of Rational polyhedral fan in 4-d lattice N." does not read. While I was trying to reformulate it, I became unsure of this class at all. Isn't it just about embedding a torus orbit closure into the original toric variety? I.e. the toric morphism and fibers are not important?



---

archive/issue_comments_152099.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-27T20:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152099",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_152100.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-05-27T23:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152100",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_152101.json:
```json
{
    "body": "<a id='comment:12'></a>Attachment [trac_12892_orbit_closure_morphism.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_orbit_closure_morphism.patch) by @vbraun created at 2012-05-28 00:01:28\n\nI've updated the paths for #13023, and checked that all doctests pass.",
    "created_at": "2012-05-28T00:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152101",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Attachment [trac_12892_orbit_closure_morphism.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_orbit_closure_morphism.patch) by @vbraun created at 2012-05-28 00:01:28

I've updated the paths for #13023, and checked that all doctests pass.



---

archive/issue_comments_152102.json:
```json
{
    "body": "<a id='comment:13'></a>Beginning of the reviewer patch: I changed `fiber` to `fiber_generic` and want to change `fiber_component` to something more accurate since it does not necessarily return an irreducible component of a fiber, but perhaps a smaller dimensional piece. How about `fiber_orbit_closure`? That's how the documentation describes the output anyway.",
    "created_at": "2012-06-05T14:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152102",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:13'></a>Beginning of the reviewer patch: I changed `fiber` to `fiber_generic` and want to change `fiber_component` to something more accurate since it does not necessarily return an irreducible component of a fiber, but perhaps a smaller dimensional piece. How about `fiber_orbit_closure`? That's how the documentation describes the output anyway.



---

archive/issue_comments_152103.json:
```json
{
    "body": "<a id='comment:14'></a>\n```\nsage: P1 = toric_varieties.P1()\nsage: f = P1.hom(matrix([2]), P1)\nsage: f.fiber_orbit_closure(P1.fan(1)[0])\nTraceback (most recent call last):\n...\nArithmeticError: Argument gens (= [(1/2)]) does not generate a submodule of self.\n```\nThis should either give a meaningful error message or better yet just work. I'll try to take care of it.",
    "created_at": "2012-06-10T08:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152103",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:14'></a>
```
sage: P1 = toric_varieties.P1()
sage: f = P1.hom(matrix([2]), P1)
sage: f.fiber_orbit_closure(P1.fan(1)[0])
Traceback (most recent call last):
...
ArithmeticError: Argument gens (= [(1/2)]) does not generate a submodule of self.
```
This should either give a meaningful error message or better yet just work. I'll try to take care of it.



---

archive/issue_comments_152104.json:
```json
{
    "body": "<a id='comment:15'></a>The problem is of course that `z |-> z^2` has two points as the fiber over {+1}. This is called the index in Hu-Liu-Yau. So we can either\n\n a) Ignore it and just return one irreducible component\n\n b) Return a pair `(toric variety, index)` \n\n c) Return the different connected components `(fiber, fiber, ..., fiber)`. Note that the embedding map differs by some roots of unity so you may not be able to write it over QQ...",
    "created_at": "2012-06-27T14:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152104",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>The problem is of course that `z |-> z^2` has two points as the fiber over {+1}. This is called the index in Hu-Liu-Yau. So we can either

 a) Ignore it and just return one irreducible component

 b) Return a pair `(toric variety, index)` 

 c) Return the different connected components `(fiber, fiber, ..., fiber)`. Note that the embedding map differs by some roots of unity so you may not be able to write it over QQ...



---

archive/issue_comments_152105.json:
```json
{
    "body": "<a id='comment:16'></a>Yeap, I am working on it - had to brush up the math definitions and then a non-trivial random example exposed some issues with current code which I am fixing. Regarding returned values, I didn't make up my mind yet, but just ignoring other components is a bad choice, I think - even if we return only one there should be another method that will return their number (and I almost have it working, I think).",
    "created_at": "2012-06-27T16:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152105",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:16'></a>Yeap, I am working on it - had to brush up the math definitions and then a non-trivial random example exposed some issues with current code which I am fixing. Regarding returned values, I didn't make up my mind yet, but just ignoring other components is a bad choice, I think - even if we return only one there should be another method that will return their number (and I almost have it working, I think).



---

archive/issue_comments_152106.json:
```json
{
    "body": "<a id='comment:17'></a>Thinking about it, returning a pair `(fiber, index)` or perhaps a dict seems like the best choice. Having to call another method to get the index isn't easy to discover.",
    "created_at": "2012-06-28T13:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152106",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Thinking about it, returning a pair `(fiber, index)` or perhaps a dict seems like the best choice. Having to call another method to get the index isn't easy to discover.



---

archive/issue_comments_152107.json:
```json
{
    "body": "<a id='comment:18'></a>There were failures due to the switch to `PointCollection`, I've fixed them (added `__add__`).\n\nHow about the following?\n* `fiber_generic()` returns (X, N) where X is a toric variety corresponding to the kernel fan and N is the number of copies if the whole torus of the codomain is covered surjectively and 0 otherwise.\n* `fiber_component(domain_cone)` returns (X, N) where N is always some positive number of copies, since here we specify a domain cone and there are definitely some components corresponding to it, in particular `fiber_component(domain_origin)` will return the number of components of the fiber over distinguished point of the `codomain_origin`, even if `fiber_generic` returns (X, 0), meaning that over non-distinguished points there are likely empty fibers.\n* `fiber_dimension(codomain_cone)` returns -1 (or -intinity?) if the corresponding orbit of the codomain is not covered surjectively.\n* `fiber_graph(codomain_cone)` returns an empty graph is the corresponding orbit is not covered surjectively.",
    "created_at": "2012-07-19T05:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152107",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:18'></a>There were failures due to the switch to `PointCollection`, I've fixed them (added `__add__`).

How about the following?
* `fiber_generic()` returns (X, N) where X is a toric variety corresponding to the kernel fan and N is the number of copies if the whole torus of the codomain is covered surjectively and 0 otherwise.
* `fiber_component(domain_cone)` returns (X, N) where N is always some positive number of copies, since here we specify a domain cone and there are definitely some components corresponding to it, in particular `fiber_component(domain_origin)` will return the number of components of the fiber over distinguished point of the `codomain_origin`, even if `fiber_generic` returns (X, 0), meaning that over non-distinguished points there are likely empty fibers.
* `fiber_dimension(codomain_cone)` returns -1 (or -intinity?) if the corresponding orbit of the codomain is not covered surjectively.
* `fiber_graph(codomain_cone)` returns an empty graph is the corresponding orbit is not covered surjectively.



---

archive/issue_comments_152108.json:
```json
{
    "body": "Attachment [trac_12892_reviewer.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_reviewer.patch) by @novoselt created at 2012-07-19 05:22:57",
    "created_at": "2012-07-19T05:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152108",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_12892_reviewer.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_reviewer.patch) by @novoselt created at 2012-07-19 05:22:57



---

archive/issue_comments_152109.json:
```json
{
    "body": "<a id='comment:19'></a>I (still) think its unwieldy to try to support non-surjective \"fibrations\". A fibration is a surjective morphism, otherwise its useless to describe \"fibers\" fitting into some familiy parametrized by the base. Its would be much easier to just raise some error in `fiber_...()` methods if the morphism is not surjective. \n\nIt seems like there is a natural way to factor a morphism into a surjection and an injection, first map to the image fan and then embed the image in the codomain. The error raised in the `fiber_...()` methods could direct the users then to do this.",
    "created_at": "2012-07-20T03:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152109",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>I (still) think its unwieldy to try to support non-surjective "fibrations". A fibration is a surjective morphism, otherwise its useless to describe "fibers" fitting into some familiy parametrized by the base. Its would be much easier to just raise some error in `fiber_...()` methods if the morphism is not surjective. 

It seems like there is a natural way to factor a morphism into a surjection and an injection, first map to the image fan and then embed the image in the codomain. The error raised in the `fiber_...()` methods could direct the users then to do this.



---

archive/issue_comments_152110.json:
```json
{
    "body": "<a id='comment:20'></a>Well, what exactly do you mean by \"fibration\"? Fiber bundle? Fibration in the sense of `is_fibration` with all fibers having the same dimension? That excludes even blowups. Anything surjective? That excludes e.g. chart inclusion, or maps from charts of blowups into the original variety. I think for any morphism it is reasonable to look at fibers over any point of the codomain, it is just the inverse image. And whether we return something special or raise an exception, we still have to do the work of figuring out what's going on.\n\nFrom the user point of view, I think it is a bit easier/more elegant to handle \"corner case\" outputs than exceptions, `fiber_component` and `fiber_dimension` have pretty clear meaning in general. I think `fiber_generic` has it as well. The `fiber_graph` one is indeed quite special and maybe it makes sense to restrict it to surjective or even `is_fibration` case.\n\nIn the case of factoring through the image, the middle variety can be difficult to work with and I am not even sure if the current support is sufficient for any work as well. Then again for the inclusion there is a question of what is covered and what is not, and the natural test seems to be - are there points of this point or not, but if fiber methods don't work, then there should be something separate. I think it will be more complicated.\n\nE.g. take a blowup of a plane and consider the map from one of the charts to the plane. How will it factor??? I suspect clear factorization into surjection and injection requires working with complete fans and that's definitely way too restrictive.",
    "created_at": "2012-07-20T03:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152110",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:20'></a>Well, what exactly do you mean by "fibration"? Fiber bundle? Fibration in the sense of `is_fibration` with all fibers having the same dimension? That excludes even blowups. Anything surjective? That excludes e.g. chart inclusion, or maps from charts of blowups into the original variety. I think for any morphism it is reasonable to look at fibers over any point of the codomain, it is just the inverse image. And whether we return something special or raise an exception, we still have to do the work of figuring out what's going on.

From the user point of view, I think it is a bit easier/more elegant to handle "corner case" outputs than exceptions, `fiber_component` and `fiber_dimension` have pretty clear meaning in general. I think `fiber_generic` has it as well. The `fiber_graph` one is indeed quite special and maybe it makes sense to restrict it to surjective or even `is_fibration` case.

In the case of factoring through the image, the middle variety can be difficult to work with and I am not even sure if the current support is sufficient for any work as well. Then again for the inclusion there is a question of what is covered and what is not, and the natural test seems to be - are there points of this point or not, but if fiber methods don't work, then there should be something separate. I think it will be more complicated.

E.g. take a blowup of a plane and consider the map from one of the charts to the plane. How will it factor??? I suspect clear factorization into surjection and injection requires working with complete fans and that's definitely way too restrictive.



---

archive/issue_comments_152111.json:
```json
{
    "body": "<a id='comment:21'></a>Thinking some more about the last example (which I think we should support for sure): am I right that the image is a toric variety, but not normal, so there is no fan corresponding to it? As I just checked, `restrict_to_image` so far is a method of fan morphisms only and using it here does nothing. I think this has to be the case, but the documentation should be clarified as the restriction does not have to be surjective. It kind of contradicts the name though, should we rename it? I think it is `restrict_to_image_closure` inside of the codomain. We can rename the current method to it and then have `restrict_to_image` which will do the same, but then check that the result is surjective and `raise ValueError` otherwise since \"proper image restriction\" is no longer a fan morphism.",
    "created_at": "2012-07-20T14:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152111",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:21'></a>Thinking some more about the last example (which I think we should support for sure): am I right that the image is a toric variety, but not normal, so there is no fan corresponding to it? As I just checked, `restrict_to_image` so far is a method of fan morphisms only and using it here does nothing. I think this has to be the case, but the documentation should be clarified as the restriction does not have to be surjective. It kind of contradicts the name though, should we rename it? I think it is `restrict_to_image_closure` inside of the codomain. We can rename the current method to it and then have `restrict_to_image` which will do the same, but then check that the result is surjective and `raise ValueError` otherwise since "proper image restriction" is no longer a fan morphism.



---

archive/issue_comments_152112.json:
```json
{
    "body": "<a id='comment:22'></a>There isn't really a universally accepted definition of \"fibration\", it depends on the category you are in. In algebraic topology it is a morphism with the homotopy lifting property, but in algebraic geometry the underlying topological space of a fibration usually is not a fibration in the topology sense. As another data point, [Danilov&Shafarevich define a fibration of curves](http://books.google.com/books?id=ZhzXJHUgcRUC&lpg=PA137&ots=aWMqiSqste&dq=fibration%20of%20curves&pg=PA137#v=onepage&q=fibration%20of%20curves&f=false) to be onto. \n\nAlso, *elliptic fibration* definitely implies surjective to me. Or, in other words, if you excise complete preimages in the codomain then this is not what I would call an elliptic fibration. Though of course YMMV.\n\nRegardless of the category, I think \"fibration\" ought to mean that one is not dealing with the most general morphism but with a suitable morphism such that the preimages can be thought of as being parametrized by the base. To me, this means that you definitely want the morphism to be surjective or at least dominant.\n\nIn algebraic geometry, a fibration needs not be equidimensional (or *flat* in the sense of commutative algebra). This is different from the topologist's fibrations.",
    "created_at": "2012-07-20T15:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152112",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>There isn't really a universally accepted definition of "fibration", it depends on the category you are in. In algebraic topology it is a morphism with the homotopy lifting property, but in algebraic geometry the underlying topological space of a fibration usually is not a fibration in the topology sense. As another data point, [Danilov&Shafarevich define a fibration of curves](http://books.google.com/books?id=ZhzXJHUgcRUC&lpg=PA137&ots=aWMqiSqste&dq=fibration%20of%20curves&pg=PA137#v=onepage&q=fibration%20of%20curves&f=false) to be onto. 

Also, *elliptic fibration* definitely implies surjective to me. Or, in other words, if you excise complete preimages in the codomain then this is not what I would call an elliptic fibration. Though of course YMMV.

Regardless of the category, I think "fibration" ought to mean that one is not dealing with the most general morphism but with a suitable morphism such that the preimages can be thought of as being parametrized by the base. To me, this means that you definitely want the morphism to be surjective or at least dominant.

In algebraic geometry, a fibration needs not be equidimensional (or *flat* in the sense of commutative algebra). This is different from the topologist's fibrations.



---

archive/issue_comments_152113.json:
```json
{
    "body": "<a id='comment:23'></a>Well, I guess what I suggest boils down to:\n* *fibration* - a surjective equidimensional morphism, a \"global in codomain\" property check by `is_fibration`;\n* *fiber* - a preimage of a single point, a \"local in codomain\" construction well-defined for any morphism, regardless of its relation to fibrations in any category. http://mathworld.wolfram.com/Fiber.html is an easy to find reference, although not as authoritative as Danilov&Shafarevich ;-)\n\nMaybe it is a bit unfortunate that they have the same root, kind of like reduced/reducible, but calling it `preimage_component(domain_cone)` is not clear enough since then it may mean full preimage of an orbit or its closure, and something like `point_preimage_component(domain_cone)` is incomprehensible. Limiting to surjective morphisms and excluding a morphism from a blowup chart just because of vocabulary issues is a bit unsatisfactory...",
    "created_at": "2012-07-20T15:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152113",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:23'></a>Well, I guess what I suggest boils down to:
* *fibration* - a surjective equidimensional morphism, a "global in codomain" property check by `is_fibration`;
* *fiber* - a preimage of a single point, a "local in codomain" construction well-defined for any morphism, regardless of its relation to fibrations in any category. http://mathworld.wolfram.com/Fiber.html is an easy to find reference, although not as authoritative as Danilov&Shafarevich ;-)

Maybe it is a bit unfortunate that they have the same root, kind of like reduced/reducible, but calling it `preimage_component(domain_cone)` is not clear enough since then it may mean full preimage of an orbit or its closure, and something like `point_preimage_component(domain_cone)` is incomprehensible. Limiting to surjective morphisms and excluding a morphism from a blowup chart just because of vocabulary issues is a bit unsatisfactory...



---

archive/issue_comments_152114.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:20 novoselt]:\n> E.g. take a blowup of a plane and consider the map from one of the charts to the plane. How will it factor???\n\n\nI don't understand what the problem is. This should factor into the inclusion of the one chart in the blow-up (injective), and the blow-down morphism (surjective). That is:\n\n```\nFan([ Cone([(1,0),(1,1)]) ])\n  -> \n    Fan([ Cone([(1,0),(1,1)]), Cone([(1,1),(0,1)]) ])\n      ->\n        Fan([ Cone([(1,0),(0,1)]) ])\n```",
    "created_at": "2012-07-20T17:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152114",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>Replying to [comment:20 novoselt]:
> E.g. take a blowup of a plane and consider the map from one of the charts to the plane. How will it factor???


I don't understand what the problem is. This should factor into the inclusion of the one chart in the blow-up (injective), and the blow-down morphism (surjective). That is:

```
Fan([ Cone([(1,0),(1,1)]) ])
  -> 
    Fan([ Cone([(1,0),(1,1)]), Cone([(1,1),(0,1)]) ])
      ->
        Fan([ Cone([(1,0),(0,1)]) ])
```



---

archive/issue_comments_152115.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:19 vbraun]:\n> It seems like there is a natural way to factor a morphism into a surjection and an injection, first map to the image fan and then embed the image in the codomain.\n\n\nThat's what you have suggested earlier and this is also the factorization used in HLY paper. The intermediate variety is clearly defined: intersect the codomain fan with the linear subspace spanned by the map of lattices. Works fine when both fans of domain/codomain are complete.\n\nNow for the blowup chart you propose to replace a map between two affine varieties induced by the identity matrix with a reverse factorization - first inclusion, then surjection, going through an intermediate non-affine variety. How is this intermediate variety defined/constructed in general?",
    "created_at": "2012-07-20T17:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152115",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:25'></a>Replying to [comment:19 vbraun]:
> It seems like there is a natural way to factor a morphism into a surjection and an injection, first map to the image fan and then embed the image in the codomain.


That's what you have suggested earlier and this is also the factorization used in HLY paper. The intermediate variety is clearly defined: intersect the codomain fan with the linear subspace spanned by the map of lattices. Works fine when both fans of domain/codomain are complete.

Now for the blowup chart you propose to replace a map between two affine varieties induced by the identity matrix with a reverse factorization - first inclusion, then surjection, going through an intermediate non-affine variety. How is this intermediate variety defined/constructed in general?



---

archive/issue_comments_152116.json:
```json
{
    "body": "<a id='comment:26'></a>Sorry for the long hiatus, but I'm ready to finish this ticket now.\n\nI think the problem is a question of language, the HLY factorization is into a surjective map and one that is generically injective (but not necessarily everywhere if the domain fan is not complete). So thats fine, we'll implement this factorization and then attach the functionaly of this ticket to the surjective fan morphisms. Do you agree?",
    "created_at": "2013-03-21T11:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152116",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:26'></a>Sorry for the long hiatus, but I'm ready to finish this ticket now.

I think the problem is a question of language, the HLY factorization is into a surjective map and one that is generically injective (but not necessarily everywhere if the domain fan is not complete). So thats fine, we'll implement this factorization and then attach the functionaly of this ticket to the surjective fan morphisms. Do you agree?



---

archive/issue_comments_152117.json:
```json
{
    "body": "<a id='comment:27'></a>The factoring part is now #14353",
    "created_at": "2013-03-24T22:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152117",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'></a>The factoring part is now #14353



---

archive/issue_comments_152118.json:
```json
{
    "body": "<a id='comment:28'></a>I'm the one who should be sorry for delays and dragging tickets ;-) I need to go over the discussion here and patches again as I remember confusing myself half a year ago while doing and undoing changes in my patch.\n\nThis factorization makes sense: first to the fan of images of cones in the image sublattice, then inclusion of this fan by the identity map, which is certainly injective on the torus, but may not be on the lower dimensional orbits. I'll try to get back with more detailed thoughts on Tuesday or, at worst, next weekend.",
    "created_at": "2013-03-25T05:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152118",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:28'></a>I'm the one who should be sorry for delays and dragging tickets ;-) I need to go over the discussion here and patches again as I remember confusing myself half a year ago while doing and undoing changes in my patch.

This factorization makes sense: first to the fan of images of cones in the image sublattice, then inclusion of this fan by the identity map, which is certainly injective on the torus, but may not be on the lower dimensional orbits. I'll try to get back with more detailed thoughts on Tuesday or, at worst, next weekend.



---

archive/issue_comments_152119.json:
```json
{
    "body": "<a id='comment:29'></a>OK, just before the long weekend is over: I still would like to have methods for fibers work in non-surjective case, but with surjective/generically-injective factorization it certainly does not have to be the default and perhaps can be turned on by some parameter like `over_distinguished_point=True` which can then add extra output components as well.",
    "created_at": "2013-04-02T06:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152119",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:29'></a>OK, just before the long weekend is over: I still would like to have methods for fibers work in non-surjective case, but with surjective/generically-injective factorization it certainly does not have to be the default and perhaps can be turned on by some parameter like `over_distinguished_point=True` which can then add extra output components as well.



---

archive/issue_comments_152120.json:
```json
{
    "body": "<a id='comment:30'></a>My plan was to move all fibration-related stuff into a subclass for surjective toric morphisms. That'll allow us to have a simple interface for fibrations. This avoids the whole issue of selecting different fibers over various strata of the torus orbits in the codomain, which is encoded in the non-surjective part of the factored morphism.",
    "created_at": "2013-04-02T21:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152120",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>My plan was to move all fibration-related stuff into a subclass for surjective toric morphisms. That'll allow us to have a simple interface for fibrations. This avoids the whole issue of selecting different fibers over various strata of the torus orbits in the codomain, which is encoded in the non-surjective part of the factored morphism.



---

archive/issue_comments_152121.json:
```json
{
    "body": "Attachment [trac_12892_toric_morphism_divisors.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_toric_morphism_divisors.patch) by @vbraun created at 2013-06-24 00:19:54\n\nUpdated patch",
    "created_at": "2013-06-24T00:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152121",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_12892_toric_morphism_divisors.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_toric_morphism_divisors.patch) by @vbraun created at 2013-06-24 00:19:54

Updated patch



---

archive/issue_comments_152122.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-06-24T00:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152122",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_152123.json:
```json
{
    "body": "<a id='comment:31'></a>Attachment [trac_12892_toric_morphism_fibers.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_toric_morphism_fibers.patch) by @vbraun created at 2013-06-24 00:20:24\n\nRediffed for sage-5.11.beta3",
    "created_at": "2013-06-24T00:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152123",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>Attachment [trac_12892_toric_morphism_fibers.patch](tarball://root/attachments/some-uuid/ticket12892/trac_12892_toric_morphism_fibers.patch) by @vbraun created at 2013-06-24 00:20:24

Rediffed for sage-5.11.beta3



---

archive/issue_comments_152124.json:
```json
{
    "body": "<a id='comment:32'></a>How about this compromise between surjective/general morphisms support - compute fibers only for dominant ones. For a toric morphism being dominant implies:\n* surjection between tori, thus\n* surjection onto any torus orbit if it was hit at all, so\n* fiber/preimage over any point of any orbit is the same, including the case when it is empty.\nSo there is no confusion with returning something when distinguished points have something over them and some others don't. In terms of #14353 factorization, this means supporting compositions of surjective and birational factors, but throwing exceptions if the last injective factor is not an identity map on tori/lattices.\n\nIn particular, a blowup chart will be supported with single point fiber over the torus, single point fiber over one of the axis, empty fiber over another axis, and an affine line fiber over the origin. Awesome example for some intro classes ;-)",
    "created_at": "2013-06-30T18:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152124",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:32'></a>How about this compromise between surjective/general morphisms support - compute fibers only for dominant ones. For a toric morphism being dominant implies:
* surjection between tori, thus
* surjection onto any torus orbit if it was hit at all, so
* fiber/preimage over any point of any orbit is the same, including the case when it is empty.
So there is no confusion with returning something when distinguished points have something over them and some others don't. In terms of #14353 factorization, this means supporting compositions of surjective and birational factors, but throwing exceptions if the last injective factor is not an identity map on tori/lattices.

In particular, a blowup chart will be supported with single point fiber over the torus, single point fiber over one of the axis, empty fiber over another axis, and an affine line fiber over the origin. Awesome example for some intro classes ;-)



---

archive/issue_comments_152125.json:
```json
{
    "body": "<a id='comment:33'></a>There is some fuzz for the first patch on 5-11.beta3:\n\n```\nnovoselt@sage:~/sage/devel/sage$ hg qseries\ntrac_14210_matrix_mpolynomial_dense.patch\ntrac_14210_reviewer.patch\ntrac_13458_toric_Weierstrass_covering.patch\ntrac_13458_reviewer.patch\ntrac_12892_orbit_closure_morphism.patch\ntrac_12892_toric_morphism_fibers.patch\ntrac_12892_toric_morphism_divisors.patch\nnovoselt@sage:~/sage/devel/sage$ hg qgoto ism_div\napplying trac_14210_matrix_mpolynomial_dense.patch\napplying trac_14210_reviewer.patch\napplying trac_13458_toric_Weierstrass_covering.patch\napplying trac_13458_reviewer.patch\napplying trac_12892_orbit_closure_morphism.patch\npatching file sage/schemes/toric/morphism.py\nHunk #2 succeeded at 348 with fuzz 2 (offset 8 lines).\napplying trac_12892_toric_morphism_fibers.patch\napplying trac_12892_toric_morphism_divisors.patch\nnow at: trac_12892_toric_morphism_divisors.patch\n```",
    "created_at": "2013-07-15T22:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152125",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:33'></a>There is some fuzz for the first patch on 5-11.beta3:

```
novoselt@sage:~/sage/devel/sage$ hg qseries
trac_14210_matrix_mpolynomial_dense.patch
trac_14210_reviewer.patch
trac_13458_toric_Weierstrass_covering.patch
trac_13458_reviewer.patch
trac_12892_orbit_closure_morphism.patch
trac_12892_toric_morphism_fibers.patch
trac_12892_toric_morphism_divisors.patch
novoselt@sage:~/sage/devel/sage$ hg qgoto ism_div
applying trac_14210_matrix_mpolynomial_dense.patch
applying trac_14210_reviewer.patch
applying trac_13458_toric_Weierstrass_covering.patch
applying trac_13458_reviewer.patch
applying trac_12892_orbit_closure_morphism.patch
patching file sage/schemes/toric/morphism.py
Hunk #2 succeeded at 348 with fuzz 2 (offset 8 lines).
applying trac_12892_toric_morphism_fibers.patch
applying trac_12892_toric_morphism_divisors.patch
now at: trac_12892_toric_morphism_divisors.patch
```



---

archive/issue_comments_152126.json:
```json
{
    "body": "<a id='comment:34'></a>And somehow these patches break fresh factoring: 3 failures with `AttributeError: 'SchemeMorphism_fan_toric_variety' object has no attribute 'is_birational'`",
    "created_at": "2013-07-15T23:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152126",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:34'></a>And somehow these patches break fresh factoring: 3 failures with `AttributeError: 'SchemeMorphism_fan_toric_variety' object has no attribute 'is_birational'`



---

archive/issue_comments_152127.json:
```json
{
    "body": "<a id='comment:35'></a>I moved the patches into a git branch and cleaned up the doctest errors (e.g. `is_birational` was only defined for the fan morphism, not the scheme morphism).",
    "created_at": "2013-07-21T04:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152127",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:35'></a>I moved the patches into a git branch and cleaned up the doctest errors (e.g. `is_birational` was only defined for the fan morphism, not the scheme morphism).



---

archive/issue_comments_152128.json:
```json
{
    "body": "<a id='comment:36'></a>Do we already have instructions somewhere on how to work with these branches?",
    "created_at": "2013-07-21T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152128",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:36'></a>Do we already have instructions somewhere on how to work with these branches?



---

archive/issue_comments_152129.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:36 novoselt]:\n> Do we already have instructions somewhere on how to work with these branches?\n\n\nWorking on it at #14481",
    "created_at": "2013-07-21T05:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152129",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:37'></a>Replying to [comment:36 novoselt]:
> Do we already have instructions somewhere on how to work with these branches?


Working on it at #14481



---

archive/issue_comments_152130.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-08-06T20:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152130",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_152131.json:
```json
{
    "body": "<a id='comment:38'></a>I've updated the branch to implement `is_dominant`, a subclass of dominant toric morphisms, and moved the fibration methods there. Also, a subsection in the documentation to expand on your example of the blowup chart.",
    "created_at": "2013-08-06T20:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152131",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:38'></a>I've updated the branch to implement `is_dominant`, a subclass of dominant toric morphisms, and moved the fibration methods there. Also, a subsection in the documentation to expand on your example of the blowup chart.



---

archive/issue_events_035215.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35215"
}
```



---

archive/issue_events_035216.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-19T06:34:24Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35216"
}
```



---

archive/issue_events_035217.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-19T06:34:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35217"
}
```



---

archive/issue_comments_152132.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-02T10:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152132",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152133.json:
```json
{
    "body": "<a id='comment:42'></a>Will change return format to `(fiber_component, index)` to play with git.",
    "created_at": "2013-09-24T16:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152133",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:42'></a>Will change return format to `(fiber_component, index)` to play with git.



---

archive/issue_comments_152134.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-25T11:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152134",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152135.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-26T18:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152135",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152136.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-27T17:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152136",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152137.json:
```json
{
    "body": "<a id='comment:48'></a>Made [comment:14 square map] work. Also tried to use quotient lattices more but without much success.\n\nWhat exactly is `_image_ray_multiplicity` mathematically? I am confused by picking the maximum one - why don't other matter?",
    "created_at": "2013-09-27T17:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152137",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:48'></a>Made [comment:14 square map] work. Also tried to use quotient lattices more but without much success.

What exactly is `_image_ray_multiplicity` mathematically? I am confused by picking the maximum one - why don't other matter?



---

archive/issue_comments_152138.json:
```json
{
    "body": "<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-28T14:20:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152138",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152139.json:
```json
{
    "body": "<a id='comment:50'></a>Thinking of making `aris` (a variant of spelling arris, \"the sharp edge or salient angle formed by the meeting of two surfaces especially in moldings\") an alias for `ambient_ray_indices` ;-) Would make doctest a bit shorter.\n\nStill have a bug in fan isomorphism and another one in representing morphisms as polynomial maps. Problems tend to stem from either fans/morphisms involving sublattices, which seem to be easy to fix, or from not dealing properly with torus factors, which are more involved.",
    "created_at": "2013-09-28T14:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152139",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:50'></a>Thinking of making `aris` (a variant of spelling arris, "the sharp edge or salient angle formed by the meeting of two surfaces especially in moldings") an alias for `ambient_ray_indices` ;-) Would make doctest a bit shorter.

Still have a bug in fan isomorphism and another one in representing morphisms as polynomial maps. Problems tend to stem from either fans/morphisms involving sublattices, which seem to be easy to fix, or from not dealing properly with torus factors, which are more involved.



---

archive/issue_comments_152140.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-09-28T16:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152140",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152141.json:
```json
{
    "body": "<a id='comment:52'></a>Jan - I think that embedding construction code here is stabilized (unless Volker has any objections) and it is OK to merge your changes on top of this.",
    "created_at": "2013-09-28T17:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152141",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:52'></a>Jan - I think that embedding construction code here is stabilized (unless Volker has any objections) and it is OK to merge your changes on top of this.



---

archive/issue_comments_152142.json:
```json
{
    "body": "<a id='comment:53'></a>Volker - How about adding `.coordinates()` or something like this method to `PointCollection` which will return a point collection with the same points as the original, but written in terms of the basis of the original module? I think this will help in dealing with sublattices and quotients, e.g. there is a bunch of methods for 2d fans that test dimension of the lattice, but need to take into account that actual points may have more than 2 components. This is the reason for the failing doctest where P2 is represented by a fan in a sublattice.",
    "created_at": "2013-09-28T17:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152142",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:53'></a>Volker - How about adding `.coordinates()` or something like this method to `PointCollection` which will return a point collection with the same points as the original, but written in terms of the basis of the original module? I think this will help in dealing with sublattices and quotients, e.g. there is a bunch of methods for 2d fans that test dimension of the lattice, but need to take into account that actual points may have more than 2 components. This is the reason for the failing doctest where P2 is represented by a fan in a sublattice.



---

archive/issue_comments_152143.json:
```json
{
    "body": "Changing keywords from \"sd40.5\" to \"sd40.5 sd53\".",
    "created_at": "2013-09-30T08:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152143",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "sd40.5" to "sd40.5 sd53".



---

archive/issue_events_035218.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35218"
}
```



---

archive/issue_events_035219.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35219"
}
```



---

archive/issue_comments_152144.json:
```json
{
    "body": "<a id='comment:56'></a>Hey Volker, since you have started merging branches, I propose marking the failing doctest for P2 as known bug and merging this one as well - correct fix for P2 will require some careful work and it is certainly not introduced by this ticket. Do you have any objections to my changes so far?",
    "created_at": "2013-12-18T20:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152144",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:56'></a>Hey Volker, since you have started merging branches, I propose marking the failing doctest for P2 as known bug and merging this one as well - correct fix for P2 will require some careful work and it is certainly not introduced by this ticket. Do you have any objections to my changes so far?



---

archive/issue_comments_152145.json:
```json
{
    "body": "<a id='comment:57'></a>I agree with your changes, thanks! I'm also fine with marking the P2 thing as known bug and split it of to a separate ticket. Please go ahead!",
    "created_at": "2013-12-19T13:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152145",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:57'></a>I agree with your changes, thanks! I'm also fine with marking the P2 thing as known bug and split it of to a separate ticket. Please go ahead!



---

archive/issue_events_035220.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35220"
}
```



---

archive/issue_events_035221.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35221"
}
```



---

archive/issue_comments_152146.json:
```json
{
    "body": "<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-26T04:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152146",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_152147.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-03-26T04:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152147",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152148.json:
```json
{
    "body": "Changing keywords from \"sd40.5 sd53\" to \"sd40.5 sd53 toric\".",
    "created_at": "2014-03-26T04:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152148",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "sd40.5 sd53" to "sd40.5 sd53 toric".



---

archive/issue_comments_152149.json:
```json
{
    "body": "<a id='comment:60'></a>Hey Volker - sorry for spending 3 months on these 3 doc lines, but it is still seems to be mergeable and tests run fine for me. I'll take the liberty to switch to positive review since this change was preapproved.",
    "created_at": "2014-03-26T04:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152149",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:60'></a>Hey Volker - sorry for spending 3 months on these 3 doc lines, but it is still seems to be mergeable and tests run fine for me. I'll take the liberty to switch to positive review since this change was preapproved.



---

archive/issue_events_035222.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-01T00:11:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12892#event-35222"
}
```



---

archive/issue_comments_152150.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-01T00:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12892",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12892#issuecomment-152150",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
