# Issue 12923: Comparison of vectors is O(n) even in the simple cases

archive/issues_012751.json:
```json
{
    "assignees": [
        "https://github.com/jasongrout",
        "https://github.com/williamstein"
    ],
    "body": "Comparison of large vectors in Sage is slow in a surprising way: even if all\nthe entries of the vectors are different, the cost is proportional to the\nlength of the vector instead of having constant cost !\n\n```\nsage: l = 1000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)\nsage: %timeit m0 == m1\n625 loops, best of 3: 656 \u76dc per loop\nsage: l = 10000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)\nsage: %timeit m0 == m1\n125 loops, best of 3: 5.66 ms per loop\nsage: l = 100000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)\nsage: %timeit m0 == m1\n5 loops, best of 3: 59.1 ms per loop\n```\nThis seems to affect all the dense vectors independently from the base ring.\n\nCC:  @mguaypaq\n\nKeywords: **vector equality days38**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Florent Hivert**\n\nMerged: **sage-5.3.beta0**\n\nComponent: **linear algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12923_\n\n",
    "closed_at": "2012-08-01T12:11:25Z",
    "created_at": "2012-05-08T13:26:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Comparison of vectors is O(n) even in the simple cases",
    "type": "issue",
    "updated_at": "2015-01-05T14:12:03Z",
    "url": "https://github.com/sagemath/sage/issues/12923",
    "user": "https://github.com/hivert"
}
```
Comparison of large vectors in Sage is slow in a surprising way: even if all
the entries of the vectors are different, the cost is proportional to the
length of the vector instead of having constant cost !

```
sage: l = 1000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)
sage: %timeit m0 == m1
625 loops, best of 3: 656 ç›œ per loop
sage: l = 10000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)
sage: %timeit m0 == m1
125 loops, best of 3: 5.66 ms per loop
sage: l = 100000;   m0 = vector(ZZ, [0]*l); m1 = vector(ZZ, [1]*l)
sage: %timeit m0 == m1
5 loops, best of 3: 59.1 ms per loop
```
This seems to affect all the dense vectors independently from the base ring.

CC:  @mguaypaq

Keywords: **vector equality days38**

Reviewer: **Travis Scrimshaw**

Author: **Florent Hivert**

Merged: **sage-5.3.beta0**

Component: **linear algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/12923_





---

archive/issue_events_178735.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "milestone_number": null,
    "milestone_title": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178735"
}
```



---

archive/issue_events_178736.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178736"
}
```



---

archive/issue_events_178737.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178737"
}
```



---

archive/issue_events_178738.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178738"
}
```



---

archive/issue_events_178739.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "subject": "https://github.com/hivert",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178739"
}
```



---

archive/issue_events_178740.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-05-08T13:26:03Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "subject": "https://github.com/hivert",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178740"
}
```



---

archive/issue_comments_146363.json:
```json
{
    "body": "Changed keywords from **vector equality** to **vector equality days38**",
    "created_at": "2012-05-08T13:26:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146363",
    "user": "https://github.com/hivert"
}
```

Changed keywords from **vector equality** to **vector equality days38**



---

archive/issue_comments_146364.json:
```json
{
    "body": "Attachment: **[trac_12923-free_mod_cmp_fix-fh.patch.gz](https://github.com/sagemath/sage/files/ticket12923/trac_12923-free_mod_cmp_fix-fh.patch.gz)**",
    "created_at": "2012-05-08T16:19:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146364",
    "user": "https://github.com/hivert"
}
```

Attachment: **[trac_12923-free_mod_cmp_fix-fh.patch.gz](https://github.com/sagemath/sage/files/ticket12923/trac_12923-free_mod_cmp_fix-fh.patch.gz)**



---

archive/issue_events_178741.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-08T16:22:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178741"
}
```



---

archive/issue_events_178742.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2012-05-14T22:57:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178742"
}
```



---

archive/issue_events_178743.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2012-05-14T22:57:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178743"
}
```



---

archive/issue_comments_146365.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nIt works fine for integers, but observe the following:\n\n```\nsage: l = 1000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)                 \nsage: %timeit v1 == v2\n5 loops, best of 3: 2.25 ms per loop\nsage: %timeit v1 == v2\n125 loops, best of 3: 3.24 ms per loop\nsage: %timeit v1 == v2\n125 loops, best of 3: 3.27 ms per loop\nsage: %timeit v1 == v2\n125 loops, best of 3: 3.35 ms per loop\nsage: l = 2000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)\nsage: %timeit v1 == v2\n5 loops, best of 3: 4.72 ms per loop\nsage: %timeit v1 == v2\n125 loops, best of 3: 6.81 ms per loop\nsage: %timeit v1 == v2\n125 loops, best of 3: 6.64 ms per loop\n```\nI can't test any higher because running these tests completely kills my memory (the first comparison will allocate ~150MB RAM, the second ~450MB RAM). It only allocates when I call the comparison. Also my memory usage did not drop when I reassign v1 and v2.",
    "created_at": "2012-05-14T22:57:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146365",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:3" align="right">comment:3</div>

It works fine for integers, but observe the following:

```
sage: l = 1000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)                 
sage: %timeit v1 == v2
5 loops, best of 3: 2.25 ms per loop
sage: %timeit v1 == v2
125 loops, best of 3: 3.24 ms per loop
sage: %timeit v1 == v2
125 loops, best of 3: 3.27 ms per loop
sage: %timeit v1 == v2
125 loops, best of 3: 3.35 ms per loop
sage: l = 2000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)
sage: %timeit v1 == v2
5 loops, best of 3: 4.72 ms per loop
sage: %timeit v1 == v2
125 loops, best of 3: 6.81 ms per loop
sage: %timeit v1 == v2
125 loops, best of 3: 6.64 ms per loop
```
I can't test any higher because running these tests completely kills my memory (the first comparison will allocate ~150MB RAM, the second ~450MB RAM). It only allocates when I call the comparison. Also my memory usage did not drop when I reassign v1 and v2.



---

archive/issue_comments_146366.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@tscrim](#comment:3):\n> It works fine for integers, but observe the following:\n> \n> ```\n> sage: l = 1000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)\n> ```\n> I can't test any higher because running these tests completely kills my memory (the first comparison will allocate ~150MB RAM, the second ~450MB RAM). It only allocates when I call the comparison. Also my memory usage did not drop when I reassign v1 and v2.\n\nI'd rather to see that as a different problem. The goal of the code here is to\nremove a bunch bug whose result was that the specialized code already written\nwasn't called. I'm not optimizing anything as I don't have a serious use case\nfor those specific case, do you ? Note that I didn't made any serious\nbenchmark either. Comparing vectors with different base rings, which implies\ndifferent internal data structure could be certainly optimized, but I'd rather\nleaving it to a different ticket.\n\nCheers,\n\nFlorent",
    "created_at": "2012-05-15T01:57:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146366",
    "user": "https://github.com/hivert"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@tscrim](#comment:3):
> It works fine for integers, but observe the following:
> 
> ```
> sage: l = 1000; v1 = vector(ZZ, [0]*l); v2 = vector(QQ, [1]*l)
> ```
> I can't test any higher because running these tests completely kills my memory (the first comparison will allocate ~150MB RAM, the second ~450MB RAM). It only allocates when I call the comparison. Also my memory usage did not drop when I reassign v1 and v2.

I'd rather to see that as a different problem. The goal of the code here is to
remove a bunch bug whose result was that the specialized code already written
wasn't called. I'm not optimizing anything as I don't have a serious use case
for those specific case, do you ? Note that I didn't made any serious
benchmark either. Comparing vectors with different base rings, which implies
different internal data structure could be certainly optimized, but I'd rather
leaving it to a different ticket.

Cheers,

Florent



---

archive/issue_events_178744.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-15T01:57:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178744"
}
```



---

archive/issue_events_178745.json:
```json
{
    "actor": "https://github.com/hivert",
    "created_at": "2012-05-15T01:57:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178745"
}
```



---

archive/issue_comments_146367.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWorks for comparisons between vectors in the same data structure as you intended.",
    "created_at": "2012-07-11T11:38:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146367",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

Works for comparisons between vectors in the same data structure as you intended.



---

archive/issue_events_178746.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2012-07-11T11:38:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178746"
}
```



---

archive/issue_events_178747.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2012-07-11T11:38:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178747"
}
```



---

archive/issue_comments_146368.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nPlease fill in your real name as Reviewer.",
    "created_at": "2012-07-27T20:44:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146368",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Please fill in your real name as Reviewer.



---

archive/issue_comments_146369.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2012-07-30T06:55:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146369",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_146370.json:
```json
{
    "body": "Merged: **sage-5.3.beta0**",
    "created_at": "2012-08-01T12:11:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146370",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.3.beta0**



---

archive/issue_events_178748.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-01T12:11:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178748"
}
```



---

archive/issue_events_178749.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-01T12:11:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12923#event-178749"
}
```



---

archive/issue_comments_146371.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIn this patch, you added in several places\n\n```diff\n+    # __hash__ is not properly inherited if comparison is changed\n+    def __hash__(self):\n+        \"\"\"\n+        TEST::\n+\n+            sage: w = vector(ZZ, [-1,0,0,0])\n+            sage: w.set_immutable()\n+            sage: isinstance(hash(w), int)\n+            True\n+        \"\"\"\n+        return free_module_element.FreeModuleElement.__hash__(self)\n```\n\nWhat's the reason for this? Removing these `__hash__` methods doesn't do any harm.",
    "created_at": "2015-01-05T13:07:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146371",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

In this patch, you added in several places

```diff
+    # __hash__ is not properly inherited if comparison is changed
+    def __hash__(self):
+        """
+        TEST::
+
+            sage: w = vector(ZZ, [-1,0,0,0])
+            sage: w.set_immutable()
+            sage: isinstance(hash(w), int)
+            True
+        """
+        return free_module_element.FreeModuleElement.__hash__(self)
```

What's the reason for this? Removing these `__hash__` methods doesn't do any harm.



---

archive/issue_comments_146372.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment:9):\n> In this patch, you added in several places\n> What's the reason for this? Removing these `__hash__` methods doesn't do any harm.\n\nIn Cython when you overload comparison `__hash__` is not inherited anymore. See the following discussion on cython-user\n\nhttps://groups.google.com/forum/#!searchin/cython-users/$20hash%28el%29$20does$20not$20work$20though/cython-users/6Jqb0v8g_Vo/f5jXtw4KpmYJ",
    "created_at": "2015-01-05T13:33:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146372",
    "user": "https://github.com/hivert"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment:9):
> In this patch, you added in several places
> What's the reason for this? Removing these `__hash__` methods doesn't do any harm.

In Cython when you overload comparison `__hash__` is not inherited anymore. See the following discussion on cython-user

https://groups.google.com/forum/#!searchin/cython-users/$20hash%28el%29$20does$20not$20work$20though/cython-users/6Jqb0v8g_Vo/f5jXtw4KpmYJ



---

archive/issue_comments_146373.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nYes, sorry, you are right.\n\nI got confused because\n\n```\nv.__hash__()\n```\nworks but\n\n```\nhash(v)\n```\ndoesn't.",
    "created_at": "2015-01-05T14:12:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12923#issuecomment-146373",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Yes, sorry, you are right.

I got confused because

```
v.__hash__()
```
works but

```
hash(v)
```
doesn't.
