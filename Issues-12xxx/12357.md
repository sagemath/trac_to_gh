# Issue 12357: Make groupoids garbage collectable

archive/issues_012185.json:
```json
{
    "assignees": [
        "https://github.com/rlmill"
    ],
    "body": "Currently, the groupoid of an object P can not be garbage collected, even when deleting P.\n\nEven worse: The persistence of `Groupoid(P)` also prevents P from being garbage collected.\n\nThe attached patch aims at solving it: An external reference to either P or `Groupoid(P)` is enough to keep both alive. But without an external reference, both P and `Groupoid(P)` become collectable.\n\nExample from the docs:\n\n```\n            sage: P = GF(151)['x','y']\n            sage: n = id(Groupoid(P))\n            sage: import gc\n            sage: _ = gc.collect()\n            sage: n == id(Groupoid(P))   # indirect doctest\n            True\n\n        Thus, the groupoid is cached. But when deleting ``P``, its\n        groupoid can be garbage collected as well::\n\n            sage: del P\n            sage: _ = gc.collect()\n            sage: P = GF(151)['x','y']\n            sage: n == id(Groupoid(P))\n            False\n\n        TESTS:\n\n        We test against some corner cases::\n\n            sage: Groupoid(None)\n            Traceback (most recent call last):\n            ...\n            TypeError: Groupoid of None is not defined\n            sage: Groupoid(1)\n            Traceback (most recent call last):\n            ...\n            TypeError: 1 must either allow attribute assignment or be instances of <type 'sage.structure.parent.Parent'>\n            sage: class A: pass\n            sage: a = A()\n            sage: Groupoid(a)\n            Groupoid with underlying set <__main__.A instance at ...>\n            sage: Groupoid(a) is Groupoid(a)\n            True\n```\n\nSuperseded by #12313.\n\nDepends on #715\nDepends on #11521\nDepends on #12313\nDepends on #11943\n\nCC:  @nthiery @jpflori\n\nKeywords: **groupoid cache Cernay2012**\n\nReviewer: **Simon King, Jean-Pierre Flori**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12357_\n\n",
    "closed_at": "2013-02-28T11:02:28Z",
    "created_at": "2012-01-25T12:30:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/duplicate",
        "https://github.com/sagemath/sage/labels/memleak"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Make groupoids garbage collectable",
    "type": "issue",
    "updated_at": "2013-02-28T11:02:28Z",
    "url": "https://github.com/sagemath/sage/issues/12357",
    "user": "https://github.com/simon-king-jena"
}
```
Currently, the groupoid of an object P can not be garbage collected, even when deleting P.

Even worse: The persistence of `Groupoid(P)` also prevents P from being garbage collected.

The attached patch aims at solving it: An external reference to either P or `Groupoid(P)` is enough to keep both alive. But without an external reference, both P and `Groupoid(P)` become collectable.

Example from the docs:

```
            sage: P = GF(151)['x','y']
            sage: n = id(Groupoid(P))
            sage: import gc
            sage: _ = gc.collect()
            sage: n == id(Groupoid(P))   # indirect doctest
            True

        Thus, the groupoid is cached. But when deleting ``P``, its
        groupoid can be garbage collected as well::

            sage: del P
            sage: _ = gc.collect()
            sage: P = GF(151)['x','y']
            sage: n == id(Groupoid(P))
            False

        TESTS:

        We test against some corner cases::

            sage: Groupoid(None)
            Traceback (most recent call last):
            ...
            TypeError: Groupoid of None is not defined
            sage: Groupoid(1)
            Traceback (most recent call last):
            ...
            TypeError: 1 must either allow attribute assignment or be instances of <type 'sage.structure.parent.Parent'>
            sage: class A: pass
            sage: a = A()
            sage: Groupoid(a)
            Groupoid with underlying set <__main__.A instance at ...>
            sage: Groupoid(a) is Groupoid(a)
            True
```

Superseded by #12313.

Depends on #715
Depends on #11521
Depends on #12313
Depends on #11943

CC:  @nthiery @jpflori

Keywords: **groupoid cache Cernay2012**

Reviewer: **Simon King, Jean-Pierre Flori**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/12357_





---

archive/issue_events_169204.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-25T12:30:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169204"
}
```



---

archive/issue_events_169205.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-25T12:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "d73a4a",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169205"
}
```



---

archive/issue_events_169206.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-25T12:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169206"
}
```



---

archive/issue_events_169207.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-25T12:30:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169207"
}
```



---

archive/issue_events_169208.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2012-01-25T12:30:11Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "subject": "https://github.com/simon-king-jena",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169208"
}
```



---

archive/issue_events_169209.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-25T12:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169209"
}
```



---

archive/issue_comments_134520.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI did not run the full test suite yet. It could be that some silly old doctests use the groupoids in a way they are not intended, such as `Groupoid(1)`. If this is the case, then my patch has to change. Otherwise: Needs review!",
    "created_at": "2012-01-25T12:34:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134520",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

I did not run the full test suite yet. It could be that some silly old doctests use the groupoids in a way they are not intended, such as `Groupoid(1)`. If this is the case, then my patch has to change. Otherwise: Needs review!



---

archive/issue_comments_134521.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nTo my surprise, there were no nasty old doctests. Hence, `make ptest` went well, with the patch from here and its dependencies!",
    "created_at": "2012-01-25T19:10:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134521",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

To my surprise, there were no nasty old doctests. Hence, `make ptest` went well, with the patch from here and its dependencies!



---

archive/issue_comments_134522.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nConcerning timings:\n\nWithout the patch, the groupoid of P is stored in a dictionary, indexed by P. Hence, access to the cache is slow if `hash(P)` is slow.\n\nSome data points:\n\n```\nsage: P = GF(151)['x','y']\nsage: %timeit G = Groupoid(P)  # slow hash\n625 loops, best of 3: 20.9 \u00b5s per loop\nsage: %timeit G = Groupoid(ZZ) # fast hash\n625 loops, best of 3: 1.75 \u00b5s per loop\nsage: class Bar(Parent): pass\n....: \nsage: P = Bar()\nsage: %timeit G = Groupoid(P)  # slow hash\n625 loops, best of 3: 15.3 \u00b5s per loop\n```\n\nBut with the patch, it is stored as an attribute of P. Hence, it is slow if attribute access is slow. The point is that even slow attribute access is faster than slow hash, and slow attribute access is only little slower than fast hash:\n\n```\nsage: P = GF(151)['x','y']\nsage: %timeit G = Groupoid(P)  # slow attribute access\n625 loops, best of 3: 3.11 \u00b5s per loop\nsage: %timeit G = Groupoid(ZZ) # slow attribute access\n625 loops, best of 3: 3.1 \u00b5s per loop\nsage: class Bar(Parent): pass\n....: \nsage: P = Bar()\nsage: %timeit G = Groupoid(P)  # fast attribute access\n625 loops, best of 3: 1.59 \u00b5s per loop\n```\n\nHence, I believe that the patch is not only fixing a memory leak, but has the potential to generate a speed-up.",
    "created_at": "2012-01-25T20:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134522",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Concerning timings:

Without the patch, the groupoid of P is stored in a dictionary, indexed by P. Hence, access to the cache is slow if `hash(P)` is slow.

Some data points:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 20.9 µs per loop
sage: %timeit G = Groupoid(ZZ) # fast hash
625 loops, best of 3: 1.75 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # slow hash
625 loops, best of 3: 15.3 µs per loop
```

But with the patch, it is stored as an attribute of P. Hence, it is slow if attribute access is slow. The point is that even slow attribute access is faster than slow hash, and slow attribute access is only little slower than fast hash:

```
sage: P = GF(151)['x','y']
sage: %timeit G = Groupoid(P)  # slow attribute access
625 loops, best of 3: 3.11 µs per loop
sage: %timeit G = Groupoid(ZZ) # slow attribute access
625 loops, best of 3: 3.1 µs per loop
sage: class Bar(Parent): pass
....: 
sage: P = Bar()
sage: %timeit G = Groupoid(P)  # fast attribute access
625 loops, best of 3: 1.59 µs per loop
```

Hence, I believe that the patch is not only fixing a memory leak, but has the potential to generate a speed-up.



---

archive/issue_comments_134523.json:
```json
{
    "body": "Changed keywords from none to **groupoid cache Cernay2012**",
    "created_at": "2012-02-08T17:19:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134523",
    "user": "https://github.com/jpflori"
}
```

Changed keywords from none to **groupoid cache Cernay2012**



---

archive/issue_comments_134524.json:
```json
{
    "body": "Work Issues: **tests for None?**",
    "created_at": "2012-02-08T17:19:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134524",
    "user": "https://github.com/jpflori"
}
```

Work Issues: **tests for None?**



---

archive/issue_events_169210.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-02-08T17:19:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169210"
}
```



---

archive/issue_events_169211.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-02-08T17:19:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169211"
}
```



---

archive/issue_comments_134525.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThis is the simplest patch of the cache problems suite, and it does not depend on !#715, so I begin with this one.\n\nI'm a little bit confused by all those tests for None in your patch.\n\nIsn't the first one sufficient?\n\nMore specifically, the second test \"if S is not None\" isn't superfluous ?\n\nAnd if it is not None, can G be None ? (I guess there is some cython voodoo involved here)\n\nTo answer my own question, I guess it is none if S is not a Parent (as in your example with 1).\n\nOnce you answer me back, I'll post a reviewer patch with some additional minor corrections.",
    "created_at": "2012-02-08T17:19:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134525",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:4" align="right">comment:4</div>

This is the simplest patch of the cache problems suite, and it does not depend on !#715, so I begin with this one.

I'm a little bit confused by all those tests for None in your patch.

Isn't the first one sufficient?

More specifically, the second test "if S is not None" isn't superfluous ?

And if it is not None, can G be None ? (I guess there is some cython voodoo involved here)

To answer my own question, I guess it is none if S is not a Parent (as in your example with 1).

Once you answer me back, I'll post a reviewer patch with some additional minor corrections.



---

archive/issue_comments_134526.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nYes, the test \"if S is not None\" in line 103 seems redundant, as S being None would result in an error being raised in line 92.\n\nConcerning Cython voodoo: If S is not None and not of type Parent, then `G == S` in line 106 would result in a type error (since G is cdefined) - which is desired behaviour. But if S were None, then `G == S` in line 106 would not complain, and then line 109 would segfault. This is why there must be a test for the corner case - of course, one test would be enough.",
    "created_at": "2012-02-08T18:19:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134526",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Yes, the test "if S is not None" in line 103 seems redundant, as S being None would result in an error being raised in line 92.

Concerning Cython voodoo: If S is not None and not of type Parent, then `G == S` in line 106 would result in a type error (since G is cdefined) - which is desired behaviour. But if S were None, then `G == S` in line 106 would not complain, and then line 109 would segfault. This is why there must be a test for the corner case - of course, one test would be enough.



---

archive/issue_events_169212.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-02-08T18:19:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169212"
}
```



---

archive/issue_events_169213.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-02-08T18:19:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169213"
}
```



---

archive/issue_events_169214.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-02-10T12:38:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169214"
}
```



---

archive/issue_events_169215.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-02-10T12:38:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169215"
}
```



---

archive/issue_comments_134527.json:
```json
{
    "body": "Changed work issues from **tests for None?** to none",
    "created_at": "2012-02-10T12:38:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134527",
    "user": "https://github.com/jpflori"
}
```

Changed work issues from **tests for None?** to none



---

archive/issue_comments_134528.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nOk, I've posted a reviewer patch removing the second test and adding some comments on the code.\n\nEverything is fine for me (as long as further modification in #715 and #12313 do not affect the ticket here).\n\nSo I'll put is as positive review now.",
    "created_at": "2012-02-10T12:38:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134528",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:6" align="right">comment:6</div>

Ok, I've posted a reviewer patch removing the second test and adding some comments on the code.

Everything is fine for me (as long as further modification in #715 and #12313 do not affect the ticket here).

So I'll put is as positive review now.



---

archive/issue_comments_134529.json:
```json
{
    "body": "Reviewer patch",
    "created_at": "2012-02-10T12:38:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134529",
    "user": "https://github.com/jpflori"
}
```

Reviewer patch



---

archive/issue_comments_134530.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAttachment: **[trac12357_reviewer.patch.gz](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)**\n\nThe reviewer patch looks fine to me. Thank you!",
    "created_at": "2012-02-10T16:40:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134530",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Attachment: **[trac12357_reviewer.patch.gz](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)**

The reviewer patch looks fine to me. Thank you!



---

archive/issue_comments_134531.json:
```json
{
    "body": "Changed dependencies from **#12313** to **#715, #12313**",
    "created_at": "2012-02-11T09:43:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134531",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#12313** to **#715, #12313**



---

archive/issue_comments_134532.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nMoving this to sage-pending for now since it depends on two non-positively reviewed tickets.",
    "created_at": "2012-02-12T12:30:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134532",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Moving this to sage-pending for now since it depends on two non-positively reviewed tickets.



---

archive/issue_events_169216.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-12T12:30:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169216"
}
```



---

archive/issue_events_169217.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-12T12:30:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169217"
}
```



---

archive/issue_comments_134533.json:
```json
{
    "body": "Changed dependencies from **#715, #12313** to **#715, #12313, #11943**",
    "created_at": "2012-03-09T16:31:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134533",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#715, #12313** to **#715, #12313, #11943**



---

archive/issue_comments_134534.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThere is a conflict with #11943.\n\n- The ticket here is pending anyway\n- #11943 has only one dependency, that is already merged\n- #11943 is more fundamental than the patch here.\n\nTherefore, I suggest to rebase my patch with respect to #11943.",
    "created_at": "2012-03-09T16:31:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134534",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

There is a conflict with #11943.

- The ticket here is pending anyway
- #11943 has only one dependency, that is already merged
- #11943 is more fundamental than the patch here.

Therefore, I suggest to rebase my patch with respect to #11943.



---

archive/issue_comments_134535.json:
```json
{
    "body": "Work Issues: **rebase rel #11943**",
    "created_at": "2012-03-09T16:31:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134535",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **rebase rel #11943**



---

archive/issue_comments_134536.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -42,3 +42,9 @@\n             sage: Groupoid(a) is Groupoid(a)\n             True\n ```\n+\n+Apply:\n+\n+- [attachment: trac12357_internal_strong_groupoid_cache.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)\n+- [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)\n+\n``````\n",
    "created_at": "2012-03-09T16:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134536",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -42,3 +42,9 @@
             sage: Groupoid(a) is Groupoid(a)
             True
 ```
+
+Apply:
+
+- [attachment: trac12357_internal_strong_groupoid_cache.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)
+- [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)
+
``````




---

archive/issue_comments_134537.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nDone!\n\nApply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch",
    "created_at": "2012-03-09T16:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134537",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Done!

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch



---

archive/issue_comments_134538.json:
```json
{
    "body": "Changed work issues from **rebase rel #11943** to none",
    "created_at": "2012-04-15T13:44:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134538",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **rebase rel #11943** to none



---

archive/issue_comments_134539.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSomething went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.\n\nShould one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?",
    "created_at": "2012-04-15T13:44:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134539",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.

Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?



---

archive/issue_events_169218.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-15T13:44:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169218"
}
```



---

archive/issue_events_169219.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-15T13:44:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169219"
}
```



---

archive/issue_comments_134540.json:
```json
{
    "body": "Attachment: **[trac12357_internal_strong_groupoid_cache.patch.gz](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)**\n\nMake groupoids garbage collectable, but still use a cache by strong references. Relative #11943",
    "created_at": "2012-04-15T15:11:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134540",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac12357_internal_strong_groupoid_cache.patch.gz](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)**

Make groupoids garbage collectable, but still use a cache by strong references. Relative #11943



---

archive/issue_comments_134541.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI had a test that works like \"Create an object and store its memory address; delete it, do garbage collection, create the object again and show that the memory address is different from the old\".\n\nOf course, that is very fragile. By chance, when applying a totally unrelated ticket, the test breaks for me.\n\nTherefore I made a change in the first patch. The test now verifies that the stored memory address does not occur among the memory addresses of uncollectable objects, after garbage collection.\n\nI did not change the dependencies, yet. But perhaps the reviewer has an opinion on that matter?\n\nApply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch",
    "created_at": "2012-04-15T15:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134541",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

I had a test that works like "Create an object and store its memory address; delete it, do garbage collection, create the object again and show that the memory address is different from the old".

Of course, that is very fragile. By chance, when applying a totally unrelated ticket, the test breaks for me.

Therefore I made a change in the first patch. The test now verifies that the stored memory address does not occur among the memory addresses of uncollectable objects, after garbage collection.

I did not change the dependencies, yet. But perhaps the reviewer has an opinion on that matter?

Apply trac12357_internal_strong_groupoid_cache.patch trac12357_reviewer.patch



---

archive/issue_events_169220.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-15T15:15:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169220"
}
```



---

archive/issue_events_169221.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-15T15:15:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169221"
}
```



---

archive/issue_comments_134542.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@simon-king-jena](#comment:12):\n> Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.\n\nYou're right.\n> \n> Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?\n\nThe correct behavior here depends on the application of the three previous tickets, am I right ?\nSo I think its ok to have the three of them as dependencies (as there is no conflict to apply all of them).",
    "created_at": "2012-04-17T09:10:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134542",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@simon-king-jena](#comment:12):
> Something went wrong. Namely, originally, Jean-Pierre reviewed this patch, because it seemed independent of the other weak reference stuff. But meanwhile it depends on the other stuff.

You're right.
> 
> Should one perhaps revert the dependencies? I.e., make it so that the patch here *only* depends on #11943, and then rebase #715 and #12313 relative to it?

The correct behavior here depends on the application of the three previous tickets, am I right ?
So I think its ok to have the three of them as dependencies (as there is no conflict to apply all of them).



---

archive/issue_comments_134543.json:
```json
{
    "body": "Reviewer: **Jean-Pierre Flori**",
    "created_at": "2012-04-17T11:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134543",
    "user": "https://github.com/jpflori"
}
```

Reviewer: **Jean-Pierre Flori**



---

archive/issue_comments_134544.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nApart from my above remark, everything is fine on my install of beta13 plus #715, #11521, #12313, #11943 and this ticket.\n\nThe modified test is ok too.\n\nFrom my point of view #715 (with #11521) and #12313 are needed to make the ticket here work, but the converse is not true.\nAnd from a practical point of view, #11943 plus the ticket here can be applied before or after #715 and #12313 without conflicts.\n\nSo the dependencies look fine to me as they are now, I'm just adding #11521 because it now goes with #715.\nI may also have missed something.\n\nRebasing everything to make all of that going the other way around seems to me to be a waste of time.",
    "created_at": "2012-04-17T11:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134544",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:16" align="right">comment:16</div>

Apart from my above remark, everything is fine on my install of beta13 plus #715, #11521, #12313, #11943 and this ticket.

The modified test is ok too.

From my point of view #715 (with #11521) and #12313 are needed to make the ticket here work, but the converse is not true.
And from a practical point of view, #11943 plus the ticket here can be applied before or after #715 and #12313 without conflicts.

So the dependencies look fine to me as they are now, I'm just adding #11521 because it now goes with #715.
I may also have missed something.

Rebasing everything to make all of that going the other way around seems to me to be a waste of time.



---

archive/issue_events_169222.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-04-17T11:25:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169222"
}
```



---

archive/issue_events_169223.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2012-04-17T11:25:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169223"
}
```



---

archive/issue_comments_134545.json:
```json
{
    "body": "Changed dependencies from **#715, #12313, #11943** to **#715, #11521, #12313, #11943**",
    "created_at": "2012-04-17T11:25:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134545",
    "user": "https://github.com/jpflori"
}
```

Changed dependencies from **#715, #12313, #11943** to **#715, #11521, #12313, #11943**



---

archive/issue_comments_134546.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI've put the ticket back to positive review because I feel that #715 and #12313 will get positive review as well.",
    "created_at": "2012-04-17T11:31:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134546",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:17" align="right">comment:17</div>

I've put the ticket back to positive review because I feel that #715 and #12313 will get positive review as well.



---

archive/issue_events_169224.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-26T22:36:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "milestone_number": null,
    "milestone_title": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169224"
}
```



---

archive/issue_events_169225.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-26T22:36:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169225"
}
```



---

archive/issue_events_169226.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-15T06:47:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "milestone_number": null,
    "milestone_title": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169226"
}
```



---

archive/issue_events_169227.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-15T06:47:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169227"
}
```



---

archive/issue_comments_134547.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nUnfortunalely, this regularly (not always but quite often) gives Segmentation Faults in `sage/schemes/elliptic_curves/gal_reps.py` *after* the file has been tested:\n\n```\n$ ./sage -t --verbose \"devel/sage/sage/schemes/elliptic_curves/gal_reps.py\"\n[...]\n4 items had no tests:\n    __main__\n    __main__.change_warning_output\n    __main__.check_with_tolerance\n    __main__.warning_function\n25 items passed all tests:\n  26 tests in __main__.example_0\n[...]\n  10 tests in __main__.example_9\n263 tests in 29 items.\n263 passed and 0 failed.\nTest passed.\nSegmentation fault\n         [21.5 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t --verbose \"devel/sage/sage/schemes/elliptic_curves/gal_reps.py\"\nTotal time for all tests: 21.6 seconds\n```\n\nThis is with sage-5.1.beta4 + #12357 (beta4 is not yet released, but essentially finished).",
    "created_at": "2012-06-15T09:07:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134547",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Unfortunalely, this regularly (not always but quite often) gives Segmentation Faults in `sage/schemes/elliptic_curves/gal_reps.py` *after* the file has been tested:

```
$ ./sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
[...]
4 items had no tests:
    __main__
    __main__.change_warning_output
    __main__.check_with_tolerance
    __main__.warning_function
25 items passed all tests:
  26 tests in __main__.example_0
[...]
  10 tests in __main__.example_9
263 tests in 29 items.
263 passed and 0 failed.
Test passed.
Segmentation fault
         [21.5 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t --verbose "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
Total time for all tests: 21.6 seconds
```

This is with sage-5.1.beta4 + #12357 (beta4 is not yet released, but essentially finished).



---

archive/issue_events_169228.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-15T09:07:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169228"
}
```



---

archive/issue_events_169229.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-15T09:07:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169229"
}
```



---

archive/issue_comments_134548.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nJeroen, does the segmentation fault persists, now that #715 seems fine due to Cython upgrade?\n\nAnyway, I am now running make ptest with MALLOCK_CHECK_=3 on sage-5.6.rc0 debug version (#13864) plus #12215, #12313 and #12357.",
    "created_at": "2013-01-18T13:13:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134548",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Jeroen, does the segmentation fault persists, now that #715 seems fine due to Cython upgrade?

Anyway, I am now running make ptest with MALLOCK_CHECK_=3 on sage-5.6.rc0 debug version (#13864) plus #12215, #12313 and #12357.



---

archive/issue_comments_134549.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nPatchbot, apply trac12357_internal_strong_groupoid_cache.patch [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)",
    "created_at": "2013-01-18T13:39:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134549",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

Patchbot, apply trac12357_internal_strong_groupoid_cache.patch [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)



---

archive/issue_events_169230.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T13:39:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169230"
}
```



---

archive/issue_events_169231.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T13:39:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169231"
}
```



---

archive/issue_events_169232.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T15:49:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169232"
}
```



---

archive/issue_events_169233.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T15:49:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169233"
}
```



---

archive/issue_comments_134550.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI got one doctest error, which unfortunately shows that the patch does not solve the problem it was created for:\n\n```\nFile \"/home/simon/SAGE/debug/sage-5.6.rc0/devel/sage/sage/categories/groupoid.pyx\", line 64:\n    sage: n in map(id, gc.get_objects())\nExpected:\n    False\nGot:\n    True\n```\n\nHence, some garbage that was supposed to get collected did not become collected. And there also seems to be a timeout in\n\n```\nsage -t -force_lib \"devel/sage/doc/en/bordeaux_2008/birds_other.rst\"\n```",
    "created_at": "2013-01-18T15:49:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134550",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

I got one doctest error, which unfortunately shows that the patch does not solve the problem it was created for:

```
File "/home/simon/SAGE/debug/sage-5.6.rc0/devel/sage/sage/categories/groupoid.pyx", line 64:
    sage: n in map(id, gc.get_objects())
Expected:
    False
Got:
    True
```

Hence, some garbage that was supposed to get collected did not become collected. And there also seems to be a timeout in

```
sage -t -force_lib "devel/sage/doc/en/bordeaux_2008/birds_other.rst"
```



---

archive/issue_comments_134551.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nIn fact, the polynomial ring in the failing example does not become collected, even *without* creating its groupoid. I thought that this would have been fixed in one of the dependencies?\n\n```\nsage: P = GF(151)['x','y'] \nsage: import gc\nsage: m = id(P)\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nTrue\n```",
    "created_at": "2013-01-18T15:54:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134551",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

In fact, the polynomial ring in the failing example does not become collected, even *without* creating its groupoid. I thought that this would have been fixed in one of the dependencies?

```
sage: P = GF(151)['x','y'] 
sage: import gc
sage: m = id(P)
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
```



---

archive/issue_comments_134552.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nPerhaps I should use a test that avoids polynomial rings, but uses a custom `UniqueRepresentation`. Namely, #12215 makes `UniqueRepresentation` collectable, and the patch from here makes the groupoid collectable as well, namely:\n\n```\nsage: class MyParent(UniqueRepresentation, Parent):\n....:     pass\n....: \nsage: P = MyParent()\nsage: import gc\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nFalse\nsage: n in map(id, gc.get_objects()) \nFalse\n```\n\nWhat do you think?\n\nBy the way, the timeout is no problem: I had closed my laptop during the tests. Hence, the tests were interrupted, but the time was running.",
    "created_at": "2013-01-18T16:03:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134552",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Perhaps I should use a test that avoids polynomial rings, but uses a custom `UniqueRepresentation`. Namely, #12215 makes `UniqueRepresentation` collectable, and the patch from here makes the groupoid collectable as well, namely:

```
sage: class MyParent(UniqueRepresentation, Parent):
....:     pass
....: 
sage: P = MyParent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```

What do you think?

By the way, the timeout is no problem: I had closed my laptop during the tests. Hence, the tests were interrupted, but the time was running.



---

archive/issue_comments_134553.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nPS: In unpatched sage-5.6.rc0, one would obtain\n\n```\nsage: P = Parent()\nsage: import gc\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\n```\nAnd this is even *without* using a cache for P!!\n\nHence, the tests does demonstrate that some leak was fixed.",
    "created_at": "2013-01-18T16:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134553",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

PS: In unpatched sage-5.6.rc0, one would obtain

```
sage: P = Parent()
sage: import gc
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
```
And this is even *without* using a cache for P!!

Hence, the tests does demonstrate that some leak was fixed.



---

archive/issue_comments_134554.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nApart from changing the test, I'd like to change something more. Namely, it is stated that `UniqueRepresentation` is using cached_function - but that is wrong by #12215, which is a dependency of this ticket.\n\nThe main idea of storing the groupoid of P as an attribute of P is to avoid creating an external strong reference on the groupoid. But that would not be the case, when using a weak_cached_function for caching.\n\nHence, it could actually be that #12215 already fixes what is attempted here! I'll test that.",
    "created_at": "2013-01-18T17:07:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134554",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">comment:27</div>

Apart from changing the test, I'd like to change something more. Namely, it is stated that `UniqueRepresentation` is using cached_function - but that is wrong by #12215, which is a dependency of this ticket.

The main idea of storing the groupoid of P as an attribute of P is to avoid creating an external strong reference on the groupoid. But that would not be the case, when using a weak_cached_function for caching.

Hence, it could actually be that #12215 already fixes what is attempted here! I'll test that.



---

archive/issue_events_169234.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T17:12:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169234"
}
```



---

archive/issue_events_169235.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T17:12:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169235"
}
```



---

archive/issue_comments_134555.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nIndeed. With just #12215 and #12313 on top of sage-5.6.rc0, one obtains:\n\n```\nsage: P = Parent()\nsage: m = id(P)\nsage: n = id(Groupoid(P)) \nsage: import gc\nsage: m in map(id, gc.get_objects()) \nTrue\nsage: n in map(id, gc.get_objects()) \nTrue\nsage: del P\nsage: _ = gc.collect() \nsage: m in map(id, gc.get_objects()) \nFalse\nsage: n in map(id, gc.get_objects()) \nFalse\n```\nHence, I suggest to resolve this as a duplicate. Jean-Pierre, please change if you disagree.",
    "created_at": "2013-01-18T17:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134555",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">comment:28</div>

Indeed. With just #12215 and #12313 on top of sage-5.6.rc0, one obtains:

```
sage: P = Parent()
sage: m = id(P)
sage: n = id(Groupoid(P)) 
sage: import gc
sage: m in map(id, gc.get_objects()) 
True
sage: n in map(id, gc.get_objects()) 
True
sage: del P
sage: _ = gc.collect() 
sage: m in map(id, gc.get_objects()) 
False
sage: n in map(id, gc.get_objects()) 
False
```
Hence, I suggest to resolve this as a duplicate. Jean-Pierre, please change if you disagree.



---

archive/issue_events_169236.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T17:12:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169236"
}
```



---

archive/issue_events_169237.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T17:12:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169237"
}
```



---

archive/issue_events_169238.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-18T17:12:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "c6c6c6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169238"
}
```



---

archive/issue_comments_134556.json:
```json
{
    "body": "Changed reviewer from **Jean-Pierre Flori** to **Simon King, Jean-Pierre Flori**",
    "created_at": "2013-02-28T11:02:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134556",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **Jean-Pierre Flori** to **Simon King, Jean-Pierre Flori**



---

archive/issue_comments_134557.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -43,8 +43,4 @@\n             True\n ```\n \n-Apply:\n-\n-- [attachment: trac12357_internal_strong_groupoid_cache.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)\n-- [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)\n-\n+Superseded by #12313.\n``````\n",
    "created_at": "2013-02-28T11:02:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134557",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -43,8 +43,4 @@
             True
 ```
 
-Apply:
-
-- [attachment: trac12357_internal_strong_groupoid_cache.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_internal_strong_groupoid_cache.patch.gz)
-- [attachment: trac12357_reviewer.patch](https://github.com/sagemath/sage/files/ticket12357/trac12357_reviewer.patch.gz)
-
+Superseded by #12313.
``````




---

archive/issue_comments_134558.json:
```json
{
    "body": "Changed author from **Simon King** to none",
    "created_at": "2013-02-28T11:02:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12357#issuecomment-134558",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Simon King** to none



---

archive/issue_events_169239.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:02:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169239"
}
```



---

archive/issue_events_169240.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:02:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169240"
}
```



---

archive/issue_events_169241.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:02:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12357",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "c6c6c6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12357#event-169241"
}
```
