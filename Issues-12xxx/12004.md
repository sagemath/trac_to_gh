# Issue 12004: copying a linear program using Coin solver consumes enormous amounts of memory

archive/issues_011832.json:
```json
{
    "assignees": [],
    "body": "The following Sage program quickly explodes memory usage:\n\n```\nP = MixedIntegerLinearProgram(solver=\"Coin\")\nP.add_constraint(P[0]+P[1]==1)\nwhile True:\n  P = copy(P)\n  w = solve(P)\n```\n\nDepends on #12220\n\nAssignee: **@nathanncohen**\n\nKeywords: **linear programming, Coin, copy, memory**\n\nUpstream: **Reported upstream. Developers acknowledge bug.**\n\nReviewer: **Nathann Cohen**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12004_\n\n",
    "closed_at": "2012-04-04T19:48:08Z",
    "created_at": "2011-11-08T20:22:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/component%3A%20linear%20programming",
        "https://github.com/sagemath/sage/labels/duplicate"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "copying a linear program using Coin solver consumes enormous amounts of memory",
    "type": "issue",
    "updated_at": "2012-04-04T19:48:08Z",
    "url": "https://github.com/sagemath/sage/issues/12004",
    "user": "https://github.com/johnperry-math"
}
```
The following Sage program quickly explodes memory usage:

```
P = MixedIntegerLinearProgram(solver="Coin")
P.add_constraint(P[0]+P[1]==1)
while True:
  P = copy(P)
  w = solve(P)
```

Depends on #12220

Assignee: **@nathanncohen**

Keywords: **linear programming, Coin, copy, memory**

Upstream: **Reported upstream. Developers acknowledge bug.**

Reviewer: **Nathann Cohen**

_Issue created by migration from https://trac.sagemath.org/ticket/12004_





---

archive/issue_events_148465.json:
```json
{
    "actor": "https://github.com/johnperry-math",
    "created_at": "2011-11-08T20:22:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148465"
}
```



---

archive/issue_events_148466.json:
```json
{
    "actor": "https://github.com/johnperry-math",
    "created_at": "2011-11-08T20:22:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20linear%20programming",
    "label_color": "0000ff",
    "label_name": "component: linear programming",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148466"
}
```



---

archive/issue_events_148467.json:
```json
{
    "actor": "https://github.com/johnperry-math",
    "created_at": "2011-11-08T20:22:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148467"
}
```



---

archive/issue_events_148468.json:
```json
{
    "actor": "https://github.com/johnperry-math",
    "created_at": "2011-11-08T20:22:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148468"
}
```



---

archive/issue_comments_129701.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nOne problem may lie in line 259 of mip.pyx:\n\n```\ncdef MixedIntegerLinearProgram p = MixedIntegerLinearProgram(solver=\"GLPK\")\n```\nbut changing this does not resolve the problem. In any case, I'm not sure what's the best way to fix this; `p` has to be initialized to **something**. When I first did it, I initialized `p` by checking `isinstance(self._backend,...)`, but that leads to import problems if CPLEX or Coin are not installed. That didn't fix the memory leak, so I didn't see the point in submitting even a preliminary patch. I could add an attribute that would indicate what the backend is, but there's probably a better way.",
    "created_at": "2011-11-08T20:30:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129701",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:1'>Comment 1:</a>
One problem may lie in line 259 of mip.pyx:

```
cdef MixedIntegerLinearProgram p = MixedIntegerLinearProgram(solver="GLPK")
```
but changing this does not resolve the problem. In any case, I'm not sure what's the best way to fix this; `p` has to be initialized to **something**. When I first did it, I initialized `p` by checking `isinstance(self._backend,...)`, but that leads to import problems if CPLEX or Coin are not installed. That didn't fix the memory leak, so I didn't see the point in submitting even a preliminary patch. I could add an attribute that would indicate what the backend is, but there's probably a better way.



---

archive/issue_comments_129702.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nOhhhhhh !! Now I remember why there is this solver=\"GLPK\" where it shouldn't be, inside of the code ! It's because three lines later the ``_backend`` variable is overwritten anyway :\n\n```\np._backend = (<GenericBackend> self._backend).copy()\n```\n\nSo the solver used by the copy of the MILP will indeed be the same as the current solver, and all is well under the sun. Now, for some reason the bug could come from the fact that even though the p._backend is overwritten, the former object is not freed. Would a del p._backend just before the assigning a new value to p._backend solve the problem ? `:-)`\n\nNathann",
    "created_at": "2011-11-09T09:57:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129702",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:2'>Comment 2:</a>
Ohhhhhh !! Now I remember why there is this solver="GLPK" where it shouldn't be, inside of the code ! It's because three lines later the ``_backend`` variable is overwritten anyway :

```
p._backend = (<GenericBackend> self._backend).copy()
```

So the solver used by the copy of the MILP will indeed be the same as the current solver, and all is well under the sun. Now, for some reason the bug could come from the fact that even though the p._backend is overwritten, the former object is not freed. Would a del p._backend just before the assigning a new value to p._backend solve the problem ? `:-)`

Nathann



---

archive/issue_comments_129703.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [@nathanncohen](#comment%3A2):\n> Would a del p._backend just before the assigning a new value to p._backend solve the problem ? `:-)`\n\nI had tried something like this, but Cython complains:\n\n```\nsage/numerical/mip.pyx:281:13: Cannot delete C attribute of extension type\n```\nIs there a command that lets me delete the backend? I can see that there is a command that is commented out, `void del_OsiCbcSolverInterface...`, but I haven't yet figured out whether I should uncomment or use that.",
    "created_at": "2011-11-09T16:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129703",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [@nathanncohen](#comment%3A2):
> Would a del p._backend just before the assigning a new value to p._backend solve the problem ? `:-)`

I had tried something like this, but Cython complains:

```
sage/numerical/mip.pyx:281:13: Cannot delete C attribute of extension type
```
Is there a command that lets me delete the backend? I can see that there is a command that is commented out, `void del_OsiCbcSolverInterface...`, but I haven't yet figured out whether I should uncomment or use that.



---

archive/issue_comments_129704.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nFWIW, I'm fairly convinced that initializing with the GLPK backend is not the problem. I tried the following modifications:\n\n* change `__init__` in MixedIntegerLinearProgram so that `solver==None` actually gives *no* backend, not the GLPK backend;\n* in `__copy__`, initialize with `solver==None`.\n\nI know it is a bad, bad idea to change the behavior of an initializer this way, but I thought it would give unequivocal evidence. I've changed my version back.\n\nIndeed, **even in this case**, copying a Coin solver consumes enormous memory. It seems easier to break out of the loop, though. In fact, within 15 loops it consumes 1.6GB RAM. That's not a typo: only 15!!! `8-0`\n\nSo the problem really does lie elsewhere.",
    "created_at": "2011-11-09T19:33:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129704",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:4'>Comment 4:</a>
FWIW, I'm fairly convinced that initializing with the GLPK backend is not the problem. I tried the following modifications:

* change `__init__` in MixedIntegerLinearProgram so that `solver==None` actually gives *no* backend, not the GLPK backend;
* in `__copy__`, initialize with `solver==None`.

I know it is a bad, bad idea to change the behavior of an initializer this way, but I thought it would give unequivocal evidence. I've changed my version back.

Indeed, **even in this case**, copying a Coin solver consumes enormous memory. It seems easier to break out of the loop, though. In fact, within 15 loops it consumes 1.6GB RAM. That's not a typo: only 15!!! `8-0`

So the problem really does lie elsewhere.



---

archive/issue_comments_129705.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\n> So the problem really does lie elsewhere.\n\nDid you add a \"print 'Hey'\" in the `__dealloc__` method of the COIN backend, just to see whether the backends are really removed each time you overwrite the value of P ?\n\nNathann",
    "created_at": "2011-11-10T08:48:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129705",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'>Comment 5:</a>
> So the problem really does lie elsewhere.

Did you add a "print 'Hey'" in the `__dealloc__` method of the COIN backend, just to see whether the backends are really removed each time you overwrite the value of P ?

Nathann



---

archive/issue_comments_129706.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@nathanncohen](#comment%3A5):\n> Did you add a \"print 'Hey'\" in the `__dealloc__` method of the COIN backend, just to see whether the backends are really removed each time you overwrite the value of P ?\n\nNo, but I tried it now, and the backends really are removed: I get a \"hey\" with every `copy`.\n\nIn addition, the explosion in memory occurs regardless of whether we add constraints or not. You could simply run `P = copy(P)` several times, and memory usage jumps up.",
    "created_at": "2011-11-10T11:54:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129706",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@nathanncohen](#comment%3A5):
> Did you add a "print 'Hey'" in the `__dealloc__` method of the COIN backend, just to see whether the backends are really removed each time you overwrite the value of P ?

No, but I tried it now, and the backends really are removed: I get a "hey" with every `copy`.

In addition, the explosion in memory occurs regardless of whether we add constraints or not. You could simply run `P = copy(P)` several times, and memory usage jumps up.



---

archive/issue_comments_129707.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nMaybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?\n\nPython has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?",
    "created_at": "2011-11-10T12:14:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129707",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:7'>Comment 7:</a>
Maybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?

Python has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?



---

archive/issue_comments_129708.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\n> Maybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?\n\nYep, right `O_o`\n\n> Python has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?\n\nI've got no idea how to do that. And if that were the case, it would have to deal with Cython too !\n\nNathann",
    "created_at": "2011-11-10T12:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129708",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'>Comment 8:</a>
> Maybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?

Yep, right `O_o`

> Python has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?

I've got no idea how to do that. And if that were the case, it would have to deal with Cython too !

Nathann



---

archive/issue_comments_129709.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [@nathanncohen](#comment%3A8):\n> > Maybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?\n\n> \n> Yep, right `O_o`\n\nI was afraid of that.\n\n> > Python has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?\n\n> \n> I've got no idea how to do that. And if that were the case, it would have to deal with Cython too !\n\nI tried it (`import gc; gc.get_referents(P)`). It isn't really helpful.\n\nI also tried the following: instead of calling the copy constructor, I called the clone method. I'm referring to this function in `OsiCbcSolverInterface.hpp`:\n\n```\nvirtual OsiSolverInterface * clone(bool copyData = true) const;\n```\nThat required modifying the `.pxd` file, of course. I got it to compile & run, but the memory problems persist. Still chugging away at this...",
    "created_at": "2011-11-10T13:06:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129709",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [@nathanncohen](#comment%3A8):
> > Maybe I'm wrong (probably) but the exponential growth suggests to me that, during the copy, some sort of nesting is going on. If the problem were merely a failure to deallocate, the growth should be merely linear, shouldn't it?

> 
> Yep, right `O_o`

I was afraid of that.

> > Python has a garbage collector -- is there any way to peek inside the structure of `P`, and see what constitutes it?

> 
> I've got no idea how to do that. And if that were the case, it would have to deal with Cython too !

I tried it (`import gc; gc.get_referents(P)`). It isn't really helpful.

I also tried the following: instead of calling the copy constructor, I called the clone method. I'm referring to this function in `OsiCbcSolverInterface.hpp`:

```
virtual OsiSolverInterface * clone(bool copyData = true) const;
```
That required modifying the `.pxd` file, of course. I got it to compile & run, but the memory problems persist. Still chugging away at this...



---

archive/issue_comments_129710.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nI tried the following code:\n\n```\nfrom sage.numerical.backends.coin_backend import CoinBackend\n\np = CoinBackend()\nwhile True: p = copy(p)\n```\nWe do **not** see an explosion of memory on this. The problem lies elsewhere.\n\nGeez... I should have tried this a long time ago.",
    "created_at": "2011-11-10T13:11:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129710",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:10'>Comment 10:</a>
I tried the following code:

```
from sage.numerical.backends.coin_backend import CoinBackend

p = CoinBackend()
while True: p = copy(p)
```
We do **not** see an explosion of memory on this. The problem lies elsewhere.

Geez... I should have tried this a long time ago.



---

archive/issue_comments_129711.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nAhh... spoke too soon. If I change the above to,\n\n```\nfrom sage.numerical.backends.coin_backend import CoinBackend\n\np = CoinBackend()\nwhile True: p = p.copy()\n```\nthen the memory problems persist.",
    "created_at": "2011-11-10T13:26:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129711",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:11'>Comment 11:</a>
Ahh... spoke too soon. If I change the above to,

```
from sage.numerical.backends.coin_backend import CoinBackend

p = CoinBackend()
while True: p = p.copy()
```
then the memory problems persist.



---

archive/issue_comments_129712.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nI figured out how to implement the copy constructor: in the .pxd file, declare under `cdef cppclass c_OsiCbcSolverInterface \"OsiCbcSolverInterface\"`\n\n```\n  c_OsiCbcSolverInterface(c_OsiCbcSolverInterface &si)\n```\nIn the .pyx file, I then call\n\n```\n        p.si = new c_OsiCbcSolverInterface(<c_OsiCbcSolverInterface>self.si)\n```\nIt runs, but we still get exponential growth of memory.\n\nI'm running out of ideas here. Do you have a copy of the Coin source, and can you see if there is exponential growth if we do the same thing there?",
    "created_at": "2011-11-10T16:39:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129712",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:12'>Comment 12:</a>
I figured out how to implement the copy constructor: in the .pxd file, declare under `cdef cppclass c_OsiCbcSolverInterface "OsiCbcSolverInterface"`

```
  c_OsiCbcSolverInterface(c_OsiCbcSolverInterface &si)
```
In the .pyx file, I then call

```
        p.si = new c_OsiCbcSolverInterface(<c_OsiCbcSolverInterface>self.si)
```
It runs, but we still get exponential growth of memory.

I'm running out of ideas here. Do you have a copy of the Coin source, and can you see if there is exponential growth if we do the same thing there?



---

archive/issue_comments_129713.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nHello again !\n\nDid you try copying several times the line p.si = new [...] ? This way, each time you do a copy() in Sage the COIN interface actually does several of them, if the memory explodes faster you will be sure it comes from their code !\n\nOn my computer I am having some trouble installing CBC right now `^^;`\n\nNathann",
    "created_at": "2011-11-10T17:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129713",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'>Comment 13:</a>
Hello again !

Did you try copying several times the line p.si = new [...] ? This way, each time you do a copy() in Sage the COIN interface actually does several of them, if the memory explodes faster you will be sure it comes from their code !

On my computer I am having some trouble installing CBC right now `^^;`

Nathann



---

archive/issue_comments_129714.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nHere's what I tried. In `coin_backend.copy` I changed line 990,\n\n```\np.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)\n```\nto\n\n```\nfor each in xrange(20): p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)\n```\nThat gave me no problems.\n\nThen I changed it to two lines:\n\n```\np.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)\nfor each in xrange(20): p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> p.si)\n```\nand quickly regretted it!\n\nSo, it looks as if that's the problem.",
    "created_at": "2011-11-10T17:51:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129714",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:14'>Comment 14:</a>
Here's what I tried. In `coin_backend.copy` I changed line 990,

```
p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)
```
to

```
for each in xrange(20): p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)
```
That gave me no problems.

Then I changed it to two lines:

```
p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> self.si)
for each in xrange(20): p.si = new c_OsiCbcSolverInterface(<OsiSolverInterface *> p.si)
```
and quickly regretted it!

So, it looks as if that's the problem.



---

archive/issue_comments_129715.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nI have successfully replicated the problem in C++ directly, using the following short program:\n\n```\n#include \"include/coin/OsiCbcSolverInterface.hpp\"\n#include <stdio.h>\n\nint main() {\n  OsiCbcSolverInterface * si = new OsiCbcSolverInterface(NULL);\n  \n  for (int i = 0; i < 13; i++) {\n    printf(\"%d \", i);\n    si = new OsiCbcSolverInterface(si);\n  }\n  printf(\"\\n\");\n  \n  while (true) {}\n  \n  delete si;\n}\n```\nAn enormous amount of memory is consumed thereby. Since it's possible that this has already been resolved upstream, I will test with the latest version of Coin (2.7.5) in a moment.",
    "created_at": "2011-12-08T20:12:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129715",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:15'>Comment 15:</a>
I have successfully replicated the problem in C++ directly, using the following short program:

```
#include "include/coin/OsiCbcSolverInterface.hpp"
#include <stdio.h>

int main() {
  OsiCbcSolverInterface * si = new OsiCbcSolverInterface(NULL);
  
  for (int i = 0; i < 13; i++) {
    printf("%d ", i);
    si = new OsiCbcSolverInterface(si);
  }
  printf("\n");
  
  while (true) {}
  
  delete si;
}
```
An enormous amount of memory is consumed thereby. Since it's possible that this has already been resolved upstream, I will test with the latest version of Coin (2.7.5) in a moment.



---

archive/issue_comments_129716.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nSame problem in 2.7.5.",
    "created_at": "2011-12-08T22:00:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129716",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:16'>Comment 16:</a>
Same problem in 2.7.5.



---

archive/issue_comments_129717.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nHmmm.... So the issue is to \"report upstream\" ?\n\nNathann",
    "created_at": "2011-12-09T10:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129717",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:17'>Comment 17:</a>
Hmmm.... So the issue is to "report upstream" ?

Nathann



---

archive/issue_comments_129718.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI want to look carefully at the documentation first, and see if there's another way to do what we're trying to do. Maybe this approach is not what they actually want (but I doubt it). I'd also like to see if I can identify the precise location of the error.",
    "created_at": "2011-12-09T14:42:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129718",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:18'>Comment 18:</a>
I want to look carefully at the documentation first, and see if there's another way to do what we're trying to do. Maybe this approach is not what they actually want (but I doubt it). I'd also like to see if I can identify the precise location of the error.



---

archive/issue_comments_129719.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nThe source code (`Cbc/src/OsiCbc/OsiCbcSolverInterface.cpp`) suggests we're doing the right thing: when supplied a solver, the constructor tries to clone it. I can see that they carry out several further steps, cloning the solver again, but that's for a different class member (`referenceSolver_`). Nothing strikes me as obviously wrong.\n\nI will report it upstream and try to find out what's going on.",
    "created_at": "2011-12-09T15:16:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129719",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:19'>Comment 19:</a>
The source code (`Cbc/src/OsiCbc/OsiCbcSolverInterface.cpp`) suggests we're doing the right thing: when supplied a solver, the constructor tries to clone it. I can see that they carry out several further steps, cloning the solver again, but that's for a different class member (`referenceSolver_`). Nothing strikes me as obviously wrong.

I will report it upstream and try to find out what's going on.



---

archive/issue_comments_129720.json:
```json
{
    "body": "Changed assignee from **@nathanncohen** to **@johnperry-math**",
    "created_at": "2011-12-09T15:16:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129720",
    "user": "https://github.com/johnperry-math"
}
```

Changed assignee from **@nathanncohen** to **@johnperry-math**



---

archive/issue_comments_129721.json:
```json
{
    "body": "Upstream: **Not yet reported upstream; Will do shortly.**",
    "created_at": "2011-12-09T15:16:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129721",
    "user": "https://github.com/johnperry-math"
}
```

Upstream: **Not yet reported upstream; Will do shortly.**



---

archive/issue_comments_129722.json:
```json
{
    "body": "Changed upstream from **Not yet reported upstream; Will do shortly.** to **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2011-12-13T04:50:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129722",
    "user": "https://github.com/johnperry-math"
}
```

Changed upstream from **Not yet reported upstream; Will do shortly.** to **Reported upstream. Developers acknowledge bug.**



---

archive/issue_events_148469.json:
```json
{
    "actor": "https://github.com/johnperry-math",
    "created_at": "2011-12-13T04:50:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148469"
}
```



---

archive/issue_comments_129723.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nUpstream replies pretty quickly, once you get the right mailing list. `:-)`\n\n  > I may be wrong but in my experience OsiCbcSolverInterface has several problems and should not be used. If your problem is a linear program, you should use OsiClpSolverInterface instead. Once you load the problem in an object of class OsiClpSolverInterface, you can use the clone() method to obtain copies.\n\nI can verify that modifying the test program above in this way means we can clone without an exponential memory leak:\n\n```\n#include \"include/coin/OsiClpSolverInterface.hpp\"\n#include <stdio.h>\n\nint main() {\n  OsiClpSolverInterface * si = new OsiClpSolverInterface();\n  OsiClpSolverInterface * newsi;\n  \n  for (int i = 0; i < 13; i++) {\n    printf(\"%d \", i);\n    newsi = dynamic_cast <OsiClpSolverInterface *>((*si).clone());\n    delete si;\n    si = newsi;\n  }\n  printf(\"\\n\");\n  \n  while (true) {}\n  \n}\n```\n(FWIW putting `newsi = ...; delete si; si = newsi;` didn't affect the previous version of the code, either.)\n\nSo, now I have a question. Is there a reason we're using the `OsiCbcSolverInterface` instead of the `OsiClpSolverInterface`? or is it okay to switch interfaces?",
    "created_at": "2011-12-13T04:50:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129723",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:20'>Comment 20:</a>
Upstream replies pretty quickly, once you get the right mailing list. `:-)`

  > I may be wrong but in my experience OsiCbcSolverInterface has several problems and should not be used. If your problem is a linear program, you should use OsiClpSolverInterface instead. Once you load the problem in an object of class OsiClpSolverInterface, you can use the clone() method to obtain copies.

I can verify that modifying the test program above in this way means we can clone without an exponential memory leak:

```
#include "include/coin/OsiClpSolverInterface.hpp"
#include <stdio.h>

int main() {
  OsiClpSolverInterface * si = new OsiClpSolverInterface();
  OsiClpSolverInterface * newsi;
  
  for (int i = 0; i < 13; i++) {
    printf("%d ", i);
    newsi = dynamic_cast <OsiClpSolverInterface *>((*si).clone());
    delete si;
    si = newsi;
  }
  printf("\n");
  
  while (true) {}
  
}
```
(FWIW putting `newsi = ...; delete si; si = newsi;` didn't affect the previous version of the code, either.)

So, now I have a question. Is there a reason we're using the `OsiCbcSolverInterface` instead of the `OsiClpSolverInterface`? or is it okay to switch interfaces?



---

archive/issue_comments_129724.json:
```json
{
    "body": "Changed assignee from **@johnperry-math** to **@nathanncohen**",
    "created_at": "2011-12-13T04:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129724",
    "user": "https://github.com/johnperry-math"
}
```

Changed assignee from **@johnperry-math** to **@nathanncohen**



---

archive/issue_comments_129725.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nAnd how did I end up the owner of this ticket, anyway?",
    "created_at": "2011-12-13T04:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129725",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:21'>Comment 21:</a>
And how did I end up the owner of this ticket, anyway?



---

archive/issue_comments_129726.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nWell.... The main reason is that if I make no mistake Clp is their *linear* solver and Cbc their *integer* solver. So if we switch to OsiClpSolverInterface I guess we immediately loose the ability to solve integer programs `O_o`\n\nNathann",
    "created_at": "2011-12-13T09:37:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129726",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:22'>Comment 22:</a>
Well.... The main reason is that if I make no mistake Clp is their *linear* solver and Cbc their *integer* solver. So if we switch to OsiClpSolverInterface I guess we immediately loose the ability to solve integer programs `O_o`

Nathann



---

archive/issue_comments_129727.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nReplying to [@nathanncohen](#comment%3A22):\n\n> Well.... The main reason is that if I make no mistake Clp is their *linear* solver and Cbc their *integer* solver. So if we switch to OsiClpSolverInterface I guess we immediately loose the ability to solve integer programs `O_o` Nathann\n\nThis was a question I had in mind, by the way. Doesn't MILP return float() answers? In fact, I've often found it to return non-integer answers, so that in some of my code, I've had to hack a way to create approximate rational answers (which will suffice for my purposes).\n\nI understand your problem, and I'll ask with them. One option that would work for me would be to create a separate Clp interface, and work with that. I guess that in this case, we couldn't package it with Coin.",
    "created_at": "2011-12-13T14:01:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129727",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:23'>Comment 23:</a>
Replying to [@nathanncohen](#comment%3A22):

> Well.... The main reason is that if I make no mistake Clp is their *linear* solver and Cbc their *integer* solver. So if we switch to OsiClpSolverInterface I guess we immediately loose the ability to solve integer programs `O_o` Nathann

This was a question I had in mind, by the way. Doesn't MILP return float() answers? In fact, I've often found it to return non-integer answers, so that in some of my code, I've had to hack a way to create approximate rational answers (which will suffice for my purposes).

I understand your problem, and I'll ask with them. One option that would work for me would be to create a separate Clp interface, and work with that. I guess that in this case, we couldn't package it with Coin.



---

archive/issue_comments_129728.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\n> ...we couldn't package it with Coin.\n\nSorry, I meant \"we couldn't package it with ***MI***LP\".",
    "created_at": "2011-12-13T14:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129728",
    "user": "https://github.com/johnperry-math"
}
```

<a id='comment:24'>Comment 24:</a>
> ...we couldn't package it with Coin.

Sorry, I meant "we couldn't package it with ***MI***LP".



---

archive/issue_comments_129729.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nJohn reported the bug upstream, they acknowledge it is a bug and do not intend to fix it `:-D`\n\nThe reason is that the C++ class that is currently use to deal with Coin is \"a mistake\" according to the developpers. Anyway the package will eventually be upgraded by #12220, and the rewriting that it will require should solve this bug along.\n\nNathann",
    "created_at": "2012-01-05T13:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129729",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:25'>Comment 25:</a>
John reported the bug upstream, they acknowledge it is a bug and do not intend to fix it `:-D`

The reason is that the C++ class that is currently use to deal with Coin is "a mistake" according to the developpers. Anyway the package will eventually be upgraded by #12220, and the rewriting that it will require should solve this bug along.

Nathann



---

archive/issue_events_148470.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:26:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148470"
}
```



---

archive/issue_events_148471.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:26:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148471"
}
```



---

archive/issue_events_148472.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:26:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148472"
}
```



---

archive/issue_events_148473.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:26:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148473"
}
```



---

archive/issue_events_148474.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:27:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148474"
}
```



---

archive/issue_events_148475.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:27:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148475"
}
```



---

archive/issue_events_148476.json:
```json
{
    "actor": "https://github.com/nathanncohen",
    "created_at": "2012-01-05T13:27:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148476"
}
```



---

archive/issue_comments_129730.json:
```json
{
    "body": "Changed author from **john_perry** to none",
    "created_at": "2012-01-05T14:14:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129730",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **john_perry** to none



---

archive/issue_comments_129731.json:
```json
{
    "body": "Reviewer: **Nathann Cohen**",
    "created_at": "2012-01-05T14:14:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129731",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Nathann Cohen**



---

archive/issue_comments_129732.json:
```json
{
    "body": "Dependencies: **#12220**",
    "created_at": "2012-01-13T09:00:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12004#issuecomment-129732",
    "user": "https://github.com/jdemeyer"
}
```

Dependencies: **#12220**



---

archive/issue_events_148477.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-04T19:48:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148477"
}
```



---

archive/issue_events_148478.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-04T19:48:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148478"
}
```



---

archive/issue_events_148479.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-04T19:48:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12004",
    "label": "https://github.com/sagemath/sage/labels/duplicate",
    "label_color": "a6a6a6",
    "label_name": "duplicate",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12004#event-148479"
}
```
