# Issue 12341: Empty (full) cremona database in Sage 4.8 causes tests to fail

archive/issues_012169.json:
```json
{
    "body": "I am on Ubuntu 11.10, and noticed that a fresh install of Sage 4.8 fails a bunch of tests because the full cremona database is an empty file by default.\n\n```\n[swenson@harry 10:18:14] sage-4.8 :) $ ./sage -t /home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py                                                     (hg)-[default]-\nsage -t  \"devel/sage-main/sage/misc/functional.py\"          \n#0: simplify_sum(expr='sum(q^k,k,0,inf))\n#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))\n**********************************************************************\nFile \"/home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py\", line 1360:\n    sage: regulator(EllipticCurve('11a'))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/swenson/sage-src/sage-4.8/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/swenson/sage-src/sage-4.8/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/swenson/sage-src/sage-4.8/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_54[3]>\", line 1, in <module>\n        regulator(EllipticCurve('11a'))###line 1360:\n    sage: regulator(EllipticCurve('11a'))\n      File \"/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/schemes/elliptic_curves/constructor.py\", line 295, in EllipticCurve\n        return ell_rational_field.EllipticCurve_rational_field(x)\n      File \"/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py\", line 198, in __init__\n        X = sage.databases.cremona.CremonaDatabase()[label]\n      File \"/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/databases/cremona.py\", line 1363, in CremonaDatabase\n        _db = LargeCremonaDatabase(name)\n      File \"/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/databases/cremona.py\", line 1119, in __init__\n        + 'not appear to be a valid SQL Cremona database.')\n    RuntimeError: Database at /home/swenson/sage-src/sage-4.8/data//cremona/cremona.db does not appear to be a valid SQL Cremona database.\n**********************************************************************\n1 items had failures:\n   1 of   5 in __main__.example_54\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/swenson/.sage//tmp/functional_29532.py\n         [4.3 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t  \"devel/sage-main/sage/misc/functional.py\"\nTotal time for all tests: 4.3 seconds\n[swenson@harry 10:18:22] sage-4.8 :( $ rm /home/swenson/sage-src/sage-4.8/data/cremona/cremona.db                                                                            (hg)-[default]-\n[swenson@harry 10:18:25] sage-4.8 :) $ ./sage -t /home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py                                                     (hg)-[default]-\nsage -t  \"devel/sage-main/sage/misc/functional.py\"          \n         [4.3 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 4.3 seconds\n```\n\n---\n\nSee[comment:14](#comment%3A14) for an explanation of the issues causing this.\n\n---\n\nApply attachment:trac_12341.patch to the Sage Library.\n\nAssignee: @JohnCremona\n\nReviewer: John Cremona\n\nAuthor: R. Andrew Ohana\n\nMerged: sage-5.5.beta1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12341\n\n",
    "closed_at": "2012-11-01T12:01:10Z",
    "created_at": "2012-01-22T15:25:26Z",
    "labels": [
        "component: elliptic curves",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.5",
    "title": "Empty (full) cremona database in Sage 4.8 causes tests to fail",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12341",
    "user": "https://github.com/swenson"
}
```
I am on Ubuntu 11.10, and noticed that a fresh install of Sage 4.8 fails a bunch of tests because the full cremona database is an empty file by default.

```
[swenson@harry 10:18:14] sage-4.8 :) $ ./sage -t /home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py                                                     (hg)-[default]-
sage -t  "devel/sage-main/sage/misc/functional.py"          
#0: simplify_sum(expr='sum(q^k,k,0,inf))
#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))
**********************************************************************
File "/home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py", line 1360:
    sage: regulator(EllipticCurve('11a'))
Exception raised:
    Traceback (most recent call last):
      File "/home/swenson/sage-src/sage-4.8/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/swenson/sage-src/sage-4.8/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/swenson/sage-src/sage-4.8/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_54[3]>", line 1, in <module>
        regulator(EllipticCurve('11a'))###line 1360:
    sage: regulator(EllipticCurve('11a'))
      File "/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/schemes/elliptic_curves/constructor.py", line 295, in EllipticCurve
        return ell_rational_field.EllipticCurve_rational_field(x)
      File "/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 198, in __init__
        X = sage.databases.cremona.CremonaDatabase()[label]
      File "/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/databases/cremona.py", line 1363, in CremonaDatabase
        _db = LargeCremonaDatabase(name)
      File "/home/swenson/sage-src/sage-4.8/local/lib/python/site-packages/sage/databases/cremona.py", line 1119, in __init__
        + 'not appear to be a valid SQL Cremona database.')
    RuntimeError: Database at /home/swenson/sage-src/sage-4.8/data//cremona/cremona.db does not appear to be a valid SQL Cremona database.
**********************************************************************
1 items had failures:
   1 of   5 in __main__.example_54
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/swenson/.sage//tmp/functional_29532.py
         [4.3 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t  "devel/sage-main/sage/misc/functional.py"
Total time for all tests: 4.3 seconds
[swenson@harry 10:18:22] sage-4.8 :( $ rm /home/swenson/sage-src/sage-4.8/data/cremona/cremona.db                                                                            (hg)-[default]-
[swenson@harry 10:18:25] sage-4.8 :) $ ./sage -t /home/swenson/sage-src/sage-4.8/devel/sage-main/sage/misc/functional.py                                                     (hg)-[default]-
sage -t  "devel/sage-main/sage/misc/functional.py"          
         [4.3 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 4.3 seconds
```

---

See[comment:14](#comment%3A14) for an explanation of the issues causing this.

---

Apply attachment:trac_12341.patch to the Sage Library.

Assignee: @JohnCremona

Reviewer: John Cremona

Author: R. Andrew Ohana

Merged: sage-5.5.beta1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12341





---

archive/issue_comments_179916.json:
```json
{
    "body": "<a id='comment:1'></a>\nAlso confirmed on my OS X 10.6 with a stock Sage 4.8 install.",
    "created_at": "2012-01-22T15:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179916",
    "user": "https://github.com/swenson"
}
```

<a id='comment:1'></a>
Also confirmed on my OS X 10.6 with a stock Sage 4.8 install.



---

archive/issue_comments_179917.json:
```json
{
    "body": "<a id='comment:2'></a>\nI notice the spkg-install inside elliptic_curves-0.3/cremona_mini has code like\n\n```\ncremona_root=os.environ['SAGE_DATA']+'/cremona'\nif not os.path.exists(cremona_root):\n    os.makedirs(cremona_root)\n\ntarget=cremona_root+'/cremona_mini.db'\n```\nThis is bad form; one should use os.path.join.",
    "created_at": "2012-01-22T15:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179917",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
I notice the spkg-install inside elliptic_curves-0.3/cremona_mini has code like

```
cremona_root=os.environ['SAGE_DATA']+'/cremona'
if not os.path.exists(cremona_root):
    os.makedirs(cremona_root)

target=cremona_root+'/cremona_mini.db'
```
This is bad form; one should use os.path.join.



---

archive/issue_comments_179918.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe following should be using xreadlines, to save memory:\n\n```\nfor line in file('src/allcurves.00000-09999').readlines():\n```\n\n\nThis optional test in cremona.py is bad, since it will always fail when the optional package is installed. \n\n```\n        sage: c = CremonaDatabase()\n        sage: isinstance(c, sage.databases.cremona.MiniCremonaDatabase)\n        True\n        sage: isinstance(c, sage.databases.cremona.LargeCremonaDatabase)  # optional - database_cremona_ellcurve\n        True\n```\nAlso, the name of the optional component is totally wrong -- it should be elliptic_curves, which is the name of the spkg:\n\n```\nsage-4.8/spkg/standard/elliptic_curves-0.3.spkg\n```\n\nAnyway, trac #11587 unfortunately introduced many issues.  Let's fix them asap for 5.0!",
    "created_at": "2012-01-22T15:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179918",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
The following should be using xreadlines, to save memory:

```
for line in file('src/allcurves.00000-09999').readlines():
```


This optional test in cremona.py is bad, since it will always fail when the optional package is installed. 

```
        sage: c = CremonaDatabase()
        sage: isinstance(c, sage.databases.cremona.MiniCremonaDatabase)
        True
        sage: isinstance(c, sage.databases.cremona.LargeCremonaDatabase)  # optional - database_cremona_ellcurve
        True
```
Also, the name of the optional component is totally wrong -- it should be elliptic_curves, which is the name of the spkg:

```
sage-4.8/spkg/standard/elliptic_curves-0.3.spkg
```

Anyway, trac #11587 unfortunately introduced many issues.  Let's fix them asap for 5.0!



---

archive/issue_comments_179919.json:
```json
{
    "body": "<a id='comment:4'></a>\nJust to clarify, this issue occurs without the optional spkg?",
    "created_at": "2012-01-22T15:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179919",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:4'></a>
Just to clarify, this issue occurs without the optional spkg?



---

archive/issue_comments_179920.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis appeared to be caused by, at some point, I must have run\n\n```\n./sage -t --optional devel/sage/sage/databases/cremona.py\n```\n\nThis will create an empty cremona database as a side effect, even though it should not.",
    "created_at": "2012-01-22T16:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179920",
    "user": "https://github.com/swenson"
}
```

<a id='comment:5'></a>
This appeared to be caused by, at some point, I must have run

```
./sage -t --optional devel/sage/sage/databases/cremona.py
```

This will create an empty cremona database as a side effect, even though it should not.



---

archive/issue_comments_179921.json:
```json
{
    "body": "<a id='comment:6'></a>\nohanar, yes -- I did not install any optional packages.",
    "created_at": "2012-01-22T16:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179921",
    "user": "https://github.com/swenson"
}
```

<a id='comment:6'></a>
ohanar, yes -- I did not install any optional packages.



---

archive/issue_comments_179922.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [swenson](#comment%3A5):\n> This appeared to be caused by, at some point, I must have run\n> \n> `./sage -t --optional devel/sage/sage/databases/cremona.py`\n> \n> This will create an empty cremona database as a side effect, even though it should not.\n\n\nI think the culprit is line 1088:\n\n```\nsage: c = CremonaDatabase('cremona') # optional\n```\nThe issue is because I didn't check for `read_only=False` before opening a non-existent database. Shouldn't be too hard to fix.\n\n-- Andrew",
    "created_at": "2012-01-22T16:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179922",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:7'></a>
Replying to [swenson](#comment%3A5):
> This appeared to be caused by, at some point, I must have run
> 
> `./sage -t --optional devel/sage/sage/databases/cremona.py`
> 
> This will create an empty cremona database as a side effect, even though it should not.


I think the culprit is line 1088:

```
sage: c = CremonaDatabase('cremona') # optional
```
The issue is because I didn't check for `read_only=False` before opening a non-existent database. Shouldn't be too hard to fix.

-- Andrew



---

archive/issue_comments_179923.json:
```json
{
    "body": "<a id='comment:8'></a>\nHopefully that fixes this issue. Still a lot of things that could be improved as William noted.",
    "created_at": "2012-01-22T16:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179923",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:8'></a>
Hopefully that fixes this issue. Still a lot of things that could be improved as William noted.



---

archive/issue_comments_179924.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-22T16:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179924",
    "user": "https://github.com/ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_179925.json:
```json
{
    "body": "<a id='comment:9'></a>\nAs one of the reviewers for #11587, I apologise.  I'm not sure what I should have done differently, other than being clever when reading the new code there.  This was rather a complicated change to make since both before and after there were standard and optional spkgs involved.  I cannot have tested all possible combinations.  At least now we only have two combinations to check (before and after installing the optional large database).  All the 4.8 builds I have already have the large database installed though, so unless someone tells me how to uninstall it I cannot test the effect of this patch!",
    "created_at": "2012-01-22T18:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179925",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:9'></a>
As one of the reviewers for #11587, I apologise.  I'm not sure what I should have done differently, other than being clever when reading the new code there.  This was rather a complicated change to make since both before and after there were standard and optional spkgs involved.  I cannot have tested all possible combinations.  At least now we only have two combinations to check (before and after installing the optional large database).  All the 4.8 builds I have already have the large database installed though, so unless someone tells me how to uninstall it I cannot test the effect of this patch!



---

archive/issue_comments_179926.json:
```json
{
    "body": "<a id='comment:10'></a>\nI realized that my patch only half fixes the problem, the creation of and empty full database. The other half is for it to not use that file unless it sees that the full database is installed. I most likely won't be able to get around to this today.\n\nReplying to [cremona](#comment%3A9):\n> As one of the reviewers for #11587, I apologise.\n> This was rather a complicated change to make since both before and after there were standard and optional spkgs involved.\n\n\nYeah, I'm not really surprised by bugs popping up, it was a major change.",
    "created_at": "2012-01-22T18:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179926",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:10'></a>
I realized that my patch only half fixes the problem, the creation of and empty full database. The other half is for it to not use that file unless it sees that the full database is installed. I most likely won't be able to get around to this today.

Replying to [cremona](#comment%3A9):
> As one of the reviewers for #11587, I apologise.
> This was rather a complicated change to make since both before and after there were standard and optional spkgs involved.


Yeah, I'm not really surprised by bugs popping up, it was a major change.



---

archive/issue_comments_179927.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-01-22T18:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179927",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_179928.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-23T10:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179928",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_179929.json:
```json
{
    "body": "Changing author from \"\" to \"R. Andrew Ohana\"",
    "created_at": "2012-01-23T10:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179929",
    "user": "https://github.com/ohanar"
}
```

Changing author from "" to "R. Andrew Ohana"



---

archive/issue_comments_179930.json:
```json
{
    "body": "<a id='comment:12'></a>\nOk, I've updated the patch. The optional spkg is [here](http://wstein.org/home/ohanar/cremona-database/database_cremona_ellcurve-20120113.spkg) if you would like to test with it (the spkg repo hasn't been updated yet).",
    "created_at": "2012-01-23T10:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179930",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:12'></a>
Ok, I've updated the patch. The optional spkg is [here](http://wstein.org/home/ohanar/cremona-database/database_cremona_ellcurve-20120113.spkg) if you would like to test with it (the spkg repo hasn't been updated yet).



---

archive/issue_comments_179931.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Cremona\"",
    "created_at": "2012-02-25T16:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179931",
    "user": "https://github.com/JohnCremona"
}
```

Changing reviewer from "" to "John Cremona"



---

archive/issue_comments_179932.json:
```json
{
    "body": "<a id='comment:13'></a>\nPatch applies fine and all elliptic_curves tests pass both before and after installing the optional database (which with 5.0.bets5 I installed with a plain \"sage -i database_cremona_ellcurve\").\n\nI have not checked all the logic in the revised code.  I was puzzled by the remark about testing with flag --optional since I thought that only made sense with some sensible string after the word \"optional\", e.g. \"magma\".  But it seems that there are doctest lines which are tagged \"# optional\" with no mention of which optional package is relevant.  Possibly for this reason, I had weird failures with\n\n```\nsage -t --optional devel/sage-main/sage/schemes/elliptic_curves/lseries_ell.py # 3 doctests failed\n```\nwhich may have nothing to do with this ticket.\n\nI hesitate to set this to Positive Review since I really don't understand what it going on, but at least I have done something and reported what has happened.",
    "created_at": "2012-02-25T16:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179932",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:13'></a>
Patch applies fine and all elliptic_curves tests pass both before and after installing the optional database (which with 5.0.bets5 I installed with a plain "sage -i database_cremona_ellcurve").

I have not checked all the logic in the revised code.  I was puzzled by the remark about testing with flag --optional since I thought that only made sense with some sensible string after the word "optional", e.g. "magma".  But it seems that there are doctest lines which are tagged "# optional" with no mention of which optional package is relevant.  Possibly for this reason, I had weird failures with

```
sage -t --optional devel/sage-main/sage/schemes/elliptic_curves/lseries_ell.py # 3 doctests failed
```
which may have nothing to do with this ticket.

I hesitate to set this to Positive Review since I really don't understand what it going on, but at least I have done something and reported what has happened.



---

archive/issue_comments_179933.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [cremona](#comment%3A13):\n> I have not checked all the logic in the revised code.\n\n\nI don't think I have explained the issue that this ticket fixes very clearly (which was exposed when running one of the optional doctests without having the optional spkg installed). There are 2 main issues that caused this:\n\n* When calling `CremonaDatabase('name')` the file `SAGE_ROOT/data/cremona/name.db` was being touched, something that is bad in general if the file wasn't there to start with.\n\n* When calling `CremonaDatabase()`, to determine if the full database is installed, it would check for the existence of `SAGE_ROOT/data/cremona/cremona.db` rather than use one of the functions in `sage.misc` for this purpose.\n\nWith these combined, running the optional doctests would break the cremona database: it would run `CremonaDatabase('cremona')`, which would touch `SAGE_ROOT/data/cremona/cremona.db` and thus later calls of `CremonaDatabase()` would break since it would think the full cremona database was installed and try to use the touched file.\n\n> I was puzzled by the remark about testing with flag --optional since I thought that only made sense with some sensible string after the word \"optional\", e.g. \"magma\".\n\n\nUnless you want to test all optional packages (which could be useful for a giant system install -- unfortunately there are a few optional packages that don't want to build properly at the moment).\n\n> But it seems that there are doctest lines which are tagged \"# optional\" with no mention of which optional package is relevant.\n\n\nI consider this a bug and something that should be required for any optional tags.",
    "created_at": "2012-02-25T17:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179933",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:14'></a>
Replying to [cremona](#comment%3A13):
> I have not checked all the logic in the revised code.


I don't think I have explained the issue that this ticket fixes very clearly (which was exposed when running one of the optional doctests without having the optional spkg installed). There are 2 main issues that caused this:

* When calling `CremonaDatabase('name')` the file `SAGE_ROOT/data/cremona/name.db` was being touched, something that is bad in general if the file wasn't there to start with.

* When calling `CremonaDatabase()`, to determine if the full database is installed, it would check for the existence of `SAGE_ROOT/data/cremona/cremona.db` rather than use one of the functions in `sage.misc` for this purpose.

With these combined, running the optional doctests would break the cremona database: it would run `CremonaDatabase('cremona')`, which would touch `SAGE_ROOT/data/cremona/cremona.db` and thus later calls of `CremonaDatabase()` would break since it would think the full cremona database was installed and try to use the touched file.

> I was puzzled by the remark about testing with flag --optional since I thought that only made sense with some sensible string after the word "optional", e.g. "magma".


Unless you want to test all optional packages (which could be useful for a giant system install -- unfortunately there are a few optional packages that don't want to build properly at the moment).

> But it seems that there are doctest lines which are tagged "# optional" with no mention of which optional package is relevant.


I consider this a bug and something that should be required for any optional tags.



---

archive/issue_comments_179934.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -50,3 +50,11 @@\n All tests passed!\n Total time for all tests: 4.3 seconds\n ```\n+\n+---\n+\n+See[comment:14](#comment%3A14) for an explanation of the issues causing this.\n+\n+---\n+\n+Apply attachment:trac12341.patch to the Sage Library.\n``````\n",
    "created_at": "2012-02-25T17:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179934",
    "user": "https://github.com/ohanar"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -50,3 +50,11 @@
 All tests passed!
 Total time for all tests: 4.3 seconds
 ```
+
+---
+
+See[comment:14](#comment%3A14) for an explanation of the issues causing this.
+
+---
+
+Apply attachment:trac12341.patch to the Sage Library.
``````




---

archive/issue_comments_179935.json:
```json
{
    "body": "<a id='comment:15'></a>\nThe second patch (which includes the changes in the previous one) addresses the cases where there is a tag #optional in the code but no indication of which optional pakage is required, for the elliptic_curves directory only.\n\nWith sage-5.4.beta1 with no optional spkgs installed, all tests pass if -optional is not given, while if -optional is given then there are two failures in elliptic_curve/, both due to {{{database_cremona_ellcurve}} not being installed.  After installing that one optional spkg, all these pass.  That is as it should be.\n\nSince I added to the patch it needs a second referee.",
    "created_at": "2012-09-14T13:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179935",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:15'></a>
The second patch (which includes the changes in the previous one) addresses the cases where there is a tag #optional in the code but no indication of which optional pakage is required, for the elliptic_curves directory only.

With sage-5.4.beta1 with no optional spkgs installed, all tests pass if -optional is not given, while if -optional is given then there are two failures in elliptic_curve/, both due to {{{database_cremona_ellcurve}} not being installed.  After installing that one optional spkg, all these pass.  That is as it should be.

Since I added to the patch it needs a second referee.



---

archive/issue_comments_179936.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -57,4 +57,4 @@\n \n ---\n \n-Apply attachment:trac12341.patch to the Sage Library.\n+Apply attachment:trac_12341.patch to the Sage Library.\n``````\n",
    "created_at": "2012-09-14T13:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179936",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -57,4 +57,4 @@
 
 ---
 
-Apply attachment:trac12341.patch to the Sage Library.
+Apply attachment:trac_12341.patch to the Sage Library.
``````




---

archive/issue_comments_179937.json:
```json
{
    "body": "<a id='comment:16'></a>\nok, patch has been rebased against recent changes (removing `SAGE_DATA` in favor of `SAGE_LOCAL/share`)",
    "created_at": "2012-10-10T16:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179937",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:16'></a>
ok, patch has been rebased against recent changes (removing `SAGE_DATA` in favor of `SAGE_LOCAL/share`)



---

archive/issue_comments_179938.json:
```json
{
    "body": "<a id='comment:17'></a>\nStill needs a review from someone, not me!",
    "created_at": "2012-10-10T18:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179938",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:17'></a>
Still needs a review from someone, not me!



---

archive/issue_comments_179939.json:
```json
{
    "body": "<a id='comment:18'></a>\nI can confirm that trac_12341.patch applies cleanly to 5.4.rc1 and all tests in sage/schemes/elliptic_curves still pass.\n\nAndrew, if you are happy with the (very small) changes I had made to your first patch, between us we can make this a positive review.\n\nNote that #12565 depends on this...",
    "created_at": "2012-10-11T11:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179939",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:18'></a>
I can confirm that trac_12341.patch applies cleanly to 5.4.rc1 and all tests in sage/schemes/elliptic_curves still pass.

Andrew, if you are happy with the (very small) changes I had made to your first patch, between us we can make this a positive review.

Note that #12565 depends on this...



---

archive/issue_comments_179940.json:
```json
{
    "body": "<a id='comment:19'></a>\nI'm happy with the small changes you made, shall we mark this as positive review?",
    "created_at": "2012-10-11T23:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179940",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:19'></a>
I'm happy with the small changes you made, shall we mark this as positive review?



---

archive/issue_comments_179941.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-12T08:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179941",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179942.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-10-12T14:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179942",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_179943.json:
```json
{
    "body": "<a id='comment:21'></a>\n\n```\n#optional - database_cremona_ellcurve (conductor is greater than 10000) \n```\nshould be\n\n```\n# optional - database_cremona_ellcurve\n```\n(you're not supposed to put extra stuff after \"optional\")",
    "created_at": "2012-10-12T14:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179943",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>

```
#optional - database_cremona_ellcurve (conductor is greater than 10000) 
```
should be

```
# optional - database_cremona_ellcurve
```
(you're not supposed to put extra stuff after "optional")



---

archive/issue_events_038826.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-12T14:14:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12341#event-38826"
}
```



---

archive/issue_comments_179944.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -57,4 +57,4 @@\n \n ---\n \n-Apply attachment:trac_12341.patch to the Sage Library.\n+Apply attachment:trac_12341a.patch to the Sage Library.\n``````\n",
    "created_at": "2012-10-12T14:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179944",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -57,4 +57,4 @@
 
 ---
 
-Apply attachment:trac_12341.patch to the Sage Library.
+Apply attachment:trac_12341a.patch to the Sage Library.
``````




---

archive/issue_comments_179945.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [jdemeyer](#comment%3A21):\n> {{{\n> #optional - database_cremona_ellcurve (conductor is greater than 10000) \n> }}}\n> should be\n> \n> ```\n> # optional - database_cremona_ellcurve\n> ```\n> (you're not supposed to put extra stuff after \"optional\")\n\n\nFixed -- please may I have my positive review back now?",
    "created_at": "2012-10-12T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179945",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:24'></a>
Replying to [jdemeyer](#comment%3A21):
> {{{
> #optional - database_cremona_ellcurve (conductor is greater than 10000) 
> }}}
> should be
> 
> ```
> # optional - database_cremona_ellcurve
> ```
> (you're not supposed to put extra stuff after "optional")


Fixed -- please may I have my positive review back now?



---

archive/issue_comments_179946.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-10-12T14:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179946",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_179947.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'm afraid this needs to be rebased to sage-5.4.rc1:\n\n```\napplying trac_12341a.patch\npatching file sage/databases/cremona.py\nHunk #1 FAILED at 51\nHunk #2 FAILED at 113\nHunk #4 FAILED at 593\nHunk #7 FAILED at 1317\nHunk #9 FAILED at 1567\n5 out of 9 hunks FAILED -- saving rejects to file sage/databases/cremona.py.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh trac_12341a.patch\n```",
    "created_at": "2012-10-13T10:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179947",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
I'm afraid this needs to be rebased to sage-5.4.rc1:

```
applying trac_12341a.patch
patching file sage/databases/cremona.py
Hunk #1 FAILED at 51
Hunk #2 FAILED at 113
Hunk #4 FAILED at 593
Hunk #7 FAILED at 1317
Hunk #9 FAILED at 1567
5 out of 9 hunks FAILED -- saving rejects to file sage/databases/cremona.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh trac_12341a.patch
```



---

archive/issue_comments_179948.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-10-13T10:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179948",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_179949.json:
```json
{
    "body": "re-rebased against 5.4.rc1",
    "created_at": "2012-10-13T16:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179949",
    "user": "https://github.com/ohanar"
}
```

re-rebased against 5.4.rc1



---

archive/issue_comments_179950.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-13T16:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179950",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_179951.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -57,4 +57,4 @@\n \n ---\n \n-Apply attachment:trac_12341a.patch to the Sage Library.\n+Apply attachment:trac_12341.patch to the Sage Library.\n``````\n",
    "created_at": "2012-10-13T16:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179951",
    "user": "https://github.com/ohanar"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -57,4 +57,4 @@
 
 ---
 
-Apply attachment:trac_12341a.patch to the Sage Library.
+Apply attachment:trac_12341.patch to the Sage Library.
``````




---

archive/issue_comments_179952.json:
```json
{
    "body": "<a id='comment:27'></a>\nAttachment [trac_12341.patch](tarball://root/attachments/some-uuid/ticket12341/trac_12341.patch) by @ohanar created at 2012-10-13 16:52:00\n\nok, re-rebased against 5.4.rc1 (it seems that my rebased changes disappeared when John went to fix the optional doctest flag)",
    "created_at": "2012-10-13T16:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179952",
    "user": "https://github.com/ohanar"
}
```

<a id='comment:27'></a>
Attachment [trac_12341.patch](tarball://root/attachments/some-uuid/ticket12341/trac_12341.patch) by @ohanar created at 2012-10-13 16:52:00

ok, re-rebased against 5.4.rc1 (it seems that my rebased changes disappeared when John went to fix the optional doctest flag)



---

archive/issue_comments_179953.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [ohanar](#comment%3A27):\n> ok, re-rebased against 5.4.rc1 (it seems that my rebased changes disappeared when John went to fix the optional doctest flag)\n\n\nVery sorry, that was entirely my fault as your rebased patch had the same name as the previous one;  I had the old patch on my machine and just edited the patch file without downloading the new version.",
    "created_at": "2012-10-13T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179953",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:28'></a>
Replying to [ohanar](#comment%3A27):
> ok, re-rebased against 5.4.rc1 (it seems that my rebased changes disappeared when John went to fix the optional doctest flag)


Very sorry, that was entirely my fault as your rebased patch had the same name as the previous one;  I had the old patch on my machine and just edited the patch file without downloading the new version.



---

archive/issue_comments_179954.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-15T11:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179954",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179955.json:
```json
{
    "body": "<a id='comment:29'></a>\nThere is one small remaining issue here, which admittedly is not caused by theis ticket/patch.  Namely, all tests pass with this patch without the optional database installed, but when it is installed there is a doctest error on line 6454 of elliptic_curves/heegner.py.  That needs to be fixed somewhere, so that it passes whether or not the optional db is installed.  But I am not sure how to do that: it is an example to illustrate a specific behaviour, so the usual trick of using a curve whose conductor is so large it will not be in the optional database in the forseeable future will not do.\n\nIt seems bad to hold up this ticket for this reason!  So I am giving this a positive review, and refer to #13547 to address the remaining issue.",
    "created_at": "2012-10-15T11:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179955",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:29'></a>
There is one small remaining issue here, which admittedly is not caused by theis ticket/patch.  Namely, all tests pass with this patch without the optional database installed, but when it is installed there is a doctest error on line 6454 of elliptic_curves/heegner.py.  That needs to be fixed somewhere, so that it passes whether or not the optional db is installed.  But I am not sure how to do that: it is an example to illustrate a specific behaviour, so the usual trick of using a curve whose conductor is so large it will not be in the optional database in the forseeable future will not do.

It seems bad to hold up this ticket for this reason!  So I am giving this a positive review, and refer to #13547 to address the remaining issue.



---

archive/issue_comments_179956.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.5.beta1\"",
    "created_at": "2012-11-01T12:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179956",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.5.beta1"



---

archive/issue_comments_179957.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-01T12:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12341#issuecomment-179957",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_038827.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-01T12:01:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12341",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12341#event-38827"
}
```
