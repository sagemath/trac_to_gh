# Issue 12269: coercion and conversion for absolute_field

archive/issues_012097.json:
```json
{
    "body": "```\nsage: x = var('x')\nsage: K1.<a1> = CyclotomicField(11)\nsage: K2.<a2> = K1.extension(x^2 - 3)\nsage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field\nsage: t=a1+6*a2+a3*a1                 # with a complicated element.\nsage: L = K3.absolute_field('b')\nsage: L(t)\n# The code at #11869 takes 12 seconds to compute roots of a\n# polynomial, and then doesn't use them.\n# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field\nsage: L.structure()                   # However, the correct conversion map is available and works almost instantly\n#(Isomorphism map:... , Isomorphism map: ...)\nsage: L.structure()[1](t)\n# big output\nsage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment\n# TypeError: unsupported operand parent(s) for '+': ....\nsage: K3(L.gen())                     # There are similar problems in the other direction\n# TypeError: Cannot coerce element into this number field\nsage: L.structure()[0](L.gen())       # for which the structure maps also work.\n# a3 - a2 + a1\n```\n\nSo this ticket is meant to:\n\n* make both structure maps into conversions\n* maybe make one or both of the structure maps into a coercion\n\nSpeeding up #11869 is not really related and is #12270.\n\nAssignee: @loefflerd\n\nCC:  @jdemeyer simonking @dansme\n\nKeywords: coercion conversion absolute_field number field structure relative absolute\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/12269\n\n",
    "created_at": "2012-01-06T10:28:46Z",
    "labels": [
        "component: number fields"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "coercion and conversion for absolute_field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12269",
    "user": "https://github.com/mstreng"
}
```
```
sage: x = var('x')
sage: K1.<a1> = CyclotomicField(11)
sage: K2.<a2> = K1.extension(x^2 - 3)
sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field
sage: t=a1+6*a2+a3*a1                 # with a complicated element.
sage: L = K3.absolute_field('b')
sage: L(t)
# The code at #11869 takes 12 seconds to compute roots of a
# polynomial, and then doesn't use them.
# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field
sage: L.structure()                   # However, the correct conversion map is available and works almost instantly
#(Isomorphism map:... , Isomorphism map: ...)
sage: L.structure()[1](t)
# big output
sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment
# TypeError: unsupported operand parent(s) for '+': ....
sage: K3(L.gen())                     # There are similar problems in the other direction
# TypeError: Cannot coerce element into this number field
sage: L.structure()[0](L.gen())       # for which the structure maps also work.
# a3 - a2 + a1
```

So this ticket is meant to:

* make both structure maps into conversions
* maybe make one or both of the structure maps into a coercion

Speeding up #11869 is not really related and is #12270.

Assignee: @loefflerd

CC:  @jdemeyer simonking @dansme

Keywords: coercion conversion absolute_field number field structure relative absolute

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/12269





---

archive/issue_comments_148429.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -6,7 +6,7 @@\n sage: t=a1+6*a2+a3*a1                 # with a complicated element.\n sage: L = K3.absolute_field('b')\n sage: L(t)\n-# The code at #11869 takes 12 seconds to compute roots of a\n+# The code at #11800 takes 12 seconds to compute roots of a\n # polynomial, and then doesn't use them.\n # TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field\n sage: L.structure()                   # However, the correct conversion map is available and works almost instantly\n@@ -25,7 +25,7 @@\n \n * make both structure maps into conversions\n * make one of the structure maps into a coercion\n-* move the \"compatible embedding\" code of #12186 to the beginning of the method, to avoid unnecessary root-finding\n+* move the \"compatible embedding\" code of #11800 to the beginning of the method, to avoid unnecessary root-finding\n \n I guess the third item is unrelated to the first two, so could be a separate ticket.\n \n```\n",
    "created_at": "2012-01-06T10:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148429",
    "user": "https://github.com/mstreng"
}
```

Description changed:
```diff
--- 
+++ 
@@ -6,7 +6,7 @@
 sage: t=a1+6*a2+a3*a1                 # with a complicated element.
 sage: L = K3.absolute_field('b')
 sage: L(t)
-# The code at #11869 takes 12 seconds to compute roots of a
+# The code at #11800 takes 12 seconds to compute roots of a
 # polynomial, and then doesn't use them.
 # TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field
 sage: L.structure()                   # However, the correct conversion map is available and works almost instantly
@@ -25,7 +25,7 @@
 
 * make both structure maps into conversions
 * make one of the structure maps into a coercion
-* move the "compatible embedding" code of #12186 to the beginning of the method, to avoid unnecessary root-finding
+* move the "compatible embedding" code of #11800 to the beginning of the method, to avoid unnecessary root-finding
 
 I guess the third item is unrelated to the first two, so could be a separate ticket.
 
```




---

archive/issue_comments_148430.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,33 @@\n+```\n+sage: x = var('x')\n+sage: K1.<a1> = CyclotomicField(11)\n+sage: K2.<a2> = K1.extension(x^2 - 3)\n+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field\n+sage: t=a1+6*a2+a3*a1                 # with a complicated element.\n+sage: L = K3.absolute_field('b')\n+sage: L(t)\n+# The code at #11869 takes 12 seconds to compute roots of a\n+# polynomial, and then doesn't use them.\n+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field\n+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly\n+#(Isomorphism map:... , Isomorphism map: ...)\n+sage: L.structure()[1](t)\n+# big output\n+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment\n+# TypeError: unsupported operand parent(s) for '+': ....\n+sage: K3(L.gen())                     # There are similar problems in the other direction\n+# TypeError: Cannot coerce element into this number field\n+sage: L.structure()[0](L.gen())       # for which the structure maps also work.\n+# a3 - a2 + a1\n+```\n \n+So to do:\n+\n+* make both structure maps into conversions\n+* make one of the structure maps into a coercion\n+* move the \"compatible embedding\" code of #11869 to the beginning of the method, to avoid unnecessary root-finding\n+\n+I guess the third item is unrelated to the first two, so could be a separate ticket.\n \n Comment: 1\n \n```\n",
    "created_at": "2012-01-06T10:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148430",
    "user": "https://github.com/mstreng"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,33 @@
+```
+sage: x = var('x')
+sage: K1.<a1> = CyclotomicField(11)
+sage: K2.<a2> = K1.extension(x^2 - 3)
+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field
+sage: t=a1+6*a2+a3*a1                 # with a complicated element.
+sage: L = K3.absolute_field('b')
+sage: L(t)
+# The code at #11869 takes 12 seconds to compute roots of a
+# polynomial, and then doesn't use them.
+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field
+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly
+#(Isomorphism map:... , Isomorphism map: ...)
+sage: L.structure()[1](t)
+# big output
+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment
+# TypeError: unsupported operand parent(s) for '+': ....
+sage: K3(L.gen())                     # There are similar problems in the other direction
+# TypeError: Cannot coerce element into this number field
+sage: L.structure()[0](L.gen())       # for which the structure maps also work.
+# a3 - a2 + a1
+```
 
+So to do:
+
+* make both structure maps into conversions
+* make one of the structure maps into a coercion
+* move the "compatible embedding" code of #11869 to the beginning of the method, to avoid unnecessary root-finding
+
+I guess the third item is unrelated to the first two, so could be a separate ticket.
 
 Comment: 1
 
```




---

archive/issue_comments_148431.json:
```json
{
    "body": "<a id='comment:2'></a>Sorry, I'm messing up the patch numbers. I mean #11869 everywhere.",
    "created_at": "2012-01-06T10:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148431",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:2'></a>Sorry, I'm messing up the patch numbers. I mean #11869 everywhere.



---

archive/issue_comments_148432.json:
```json
{
    "body": "Attachment [11800-indicator.patch](tarball://root/attachments/some-uuid/ticket12269/11800-indicator.patch) by @mstreng created at 2012-01-06 10:33:55\n\nshows where long calculations are done in #11869",
    "created_at": "2012-01-06T10:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148432",
    "user": "https://github.com/mstreng"
}
```

Attachment [11800-indicator.patch](tarball://root/attachments/some-uuid/ticket12269/11800-indicator.patch) by @mstreng created at 2012-01-06 10:33:55

shows where long calculations are done in #11869



---

archive/issue_comments_148433.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,31 @@\n+```\n+sage: x = var('x')\n+sage: K1.<a1> = CyclotomicField(11)\n+sage: K2.<a2> = K1.extension(x^2 - 3)\n+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field\n+sage: t=a1+6*a2+a3*a1                 # with a complicated element.\n+sage: L = K3.absolute_field('b')\n+sage: L(t)\n+# The code at #11869 takes 12 seconds to compute roots of a\n+# polynomial, and then doesn't use them.\n+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field\n+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly\n+#(Isomorphism map:... , Isomorphism map: ...)\n+sage: L.structure()[1](t)\n+# big output\n+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment\n+# TypeError: unsupported operand parent(s) for '+': ....\n+sage: K3(L.gen())                     # There are similar problems in the other direction\n+# TypeError: Cannot coerce element into this number field\n+sage: L.structure()[0](L.gen())       # for which the structure maps also work.\n+# a3 - a2 + a1\n+```\n \n+So to do:\n+\n+* make both structure maps into conversions (this ticket)\n+* make one of the structure maps into a coercion (this ticket)\n+* move the \"compatible embedding\" code of #11869 to the beginning of the method, to avoid unnecessary root-finding (#12270)\n \n Comment: 1\n \n```\n",
    "created_at": "2012-01-06T10:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148433",
    "user": "https://github.com/mstreng"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,31 @@
+```
+sage: x = var('x')
+sage: K1.<a1> = CyclotomicField(11)
+sage: K2.<a2> = K1.extension(x^2 - 3)
+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field
+sage: t=a1+6*a2+a3*a1                 # with a complicated element.
+sage: L = K3.absolute_field('b')
+sage: L(t)
+# The code at #11869 takes 12 seconds to compute roots of a
+# polynomial, and then doesn't use them.
+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field
+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly
+#(Isomorphism map:... , Isomorphism map: ...)
+sage: L.structure()[1](t)
+# big output
+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment
+# TypeError: unsupported operand parent(s) for '+': ....
+sage: K3(L.gen())                     # There are similar problems in the other direction
+# TypeError: Cannot coerce element into this number field
+sage: L.structure()[0](L.gen())       # for which the structure maps also work.
+# a3 - a2 + a1
+```
 
+So to do:
+
+* make both structure maps into conversions (this ticket)
+* make one of the structure maps into a coercion (this ticket)
+* move the "compatible embedding" code of #11869 to the beginning of the method, to avoid unnecessary root-finding (#12270)
 
 Comment: 1
 
```




---

archive/issue_comments_148434.json:
```json
{
    "body": "<a id='comment:4'></a>See also #12271 (which is the same, but for relativize)",
    "created_at": "2012-01-06T11:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148434",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:4'></a>See also #12271 (which is the same, but for relativize)



---

archive/issue_comments_148435.json:
```json
{
    "body": "<a id='comment:5'></a>I believe a solution similar to #11876 is in order: make `absolute_field` store an embedding (in this case an isomorphism) to the starting field.",
    "created_at": "2012-01-06T11:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148435",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>I believe a solution similar to #11876 is in order: make `absolute_field` store an embedding (in this case an isomorphism) to the starting field.



---

archive/issue_comments_148436.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:\n> I believe a solution similar to #11876 is in order: make `absolute_field` store an embedding (in this case an isomorphism) to the starting field.\n\n\nThat would fix it, but I don't think it would be very fast, as it would still use `.roots()` / #11869.\n\nWouldn't it be better to use the category/coercion framework here? I suppose all that is needed it to store the `.structure()` homomorphisms in the appropriate place (wherever that is, cc: Simon) as conversion maps. The structure homomorphisms are computed already, and using them is very fast.\n\nStill, inheriting embeddings as in #11876 is certainly useful, so I think it is best to do both.",
    "created_at": "2012-01-06T11:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148436",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:
> I believe a solution similar to #11876 is in order: make `absolute_field` store an embedding (in this case an isomorphism) to the starting field.


That would fix it, but I don't think it would be very fast, as it would still use `.roots()` / #11869.

Wouldn't it be better to use the category/coercion framework here? I suppose all that is needed it to store the `.structure()` homomorphisms in the appropriate place (wherever that is, cc: Simon) as conversion maps. The structure homomorphisms are computed already, and using them is very fast.

Still, inheriting embeddings as in #11876 is certainly useful, so I think it is best to do both.



---

archive/issue_comments_148437.json:
```json
{
    "body": "<a id='comment:7'></a>The map `absolute_field().structure()[1]` (from relative to absolute) cannot be a *coercion*, because it would lead to non-commuting diagrams of coercions. In sage-4.8.alpha4:\n\n```\nsage: K.<a> = NumberField(x^2-2, embedding=-1)\nsage: L.<b> = NumberField(x^2-2, embedding=1)\nsage: xK = K['x'].gen()\nsage: xL = L['x'].gen()\nsage: M.<c> = NumberField(xK^2-3)\nsage: N.<d> = NumberField(xL^2-3)\nsage: O = M.absolute_field('e')\nsage: P = N.absolute_field('e')\nsage: b_in_a = K(0)+b\nsage: map1 = O.structure()[1]\nsage: map2 = P.structure()[1]\nsage: b_in_a in map1.domain()\n# True\nsage: b in map2.domain()\n# True\nsage: map1(b_in_a) - map2(b)\n# e^3 - 9*e, which is non-zero, so the diagrams don't commute!\n```\nFast *conversions* in both directions would be very useful though. And maybe coercion from absolute to relative?",
    "created_at": "2012-01-09T21:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148437",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:7'></a>The map `absolute_field().structure()[1]` (from relative to absolute) cannot be a *coercion*, because it would lead to non-commuting diagrams of coercions. In sage-4.8.alpha4:

```
sage: K.<a> = NumberField(x^2-2, embedding=-1)
sage: L.<b> = NumberField(x^2-2, embedding=1)
sage: xK = K['x'].gen()
sage: xL = L['x'].gen()
sage: M.<c> = NumberField(xK^2-3)
sage: N.<d> = NumberField(xL^2-3)
sage: O = M.absolute_field('e')
sage: P = N.absolute_field('e')
sage: b_in_a = K(0)+b
sage: map1 = O.structure()[1]
sage: map2 = P.structure()[1]
sage: b_in_a in map1.domain()
# True
sage: b in map2.domain()
# True
sage: map1(b_in_a) - map2(b)
# e^3 - 9*e, which is non-zero, so the diagrams don't commute!
```
Fast *conversions* in both directions would be very useful though. And maybe coercion from absolute to relative?



---

archive/issue_comments_148438.json:
```json
{
    "body": "<a id='comment:8'></a>Sorry, I did not answer Marco's question yet.\n\nIs it the case that the map is already known at initialisation time? Then, you could use (depending on whether you want a conversion or a coercion or an action) `sage.structure.parent.Parent.register_conversion(...)` or `...register_coercion(...)` or `...register_action(...)`. But note that it might be tricky to find the right moment for using these methods: They raise an error if the coercion framework was used before invoking the methods.\n\nIf the maps are not available at initialisation time (or if otherwise initialisation takes too much time), you could implement either `_convert_map_from_` or `_coerce_map_from_` -- see the documentation of both methods in `sage.structure.parent.Parent` for the expected return values. The advantage is that the map would only be constructed when needed.\n\nConcerning \"coercion or conversion between relative and absolute number fields\", I think there has been at least one thread on sage-nt and also a trac ticket devoted to that subject.",
    "created_at": "2012-01-09T22:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148438",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Sorry, I did not answer Marco's question yet.

Is it the case that the map is already known at initialisation time? Then, you could use (depending on whether you want a conversion or a coercion or an action) `sage.structure.parent.Parent.register_conversion(...)` or `...register_coercion(...)` or `...register_action(...)`. But note that it might be tricky to find the right moment for using these methods: They raise an error if the coercion framework was used before invoking the methods.

If the maps are not available at initialisation time (or if otherwise initialisation takes too much time), you could implement either `_convert_map_from_` or `_coerce_map_from_` -- see the documentation of both methods in `sage.structure.parent.Parent` for the expected return values. The advantage is that the map would only be constructed when needed.

Concerning "coercion or conversion between relative and absolute number fields", I think there has been at least one thread on sage-nt and also a trac ticket devoted to that subject.



---

archive/issue_comments_148439.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2012-01-10T09:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148439",
    "user": "https://github.com/mstreng"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_148440.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 SimonKing]:\n> Sorry, I did not answer Marco's question yet.\n\n\nNo problem, it wasn't a very direct question.\n\n> Is it the case that the map is already known at initialisation time?\n\n\nDon't know, I'll have to dig through the code some more.\n\n> Concerning \"coercion or conversion between relative and absolute number fields\", I think there has been at least one thread on sage-nt and also a trac ticket devoted to that subject.\n\n\nThanks, I don't know that ticket/thread. I have found\n\n* [https://groups.google.com/group/sage-nt/browse_thread/thread/5c376dbf7e99ea97/](https://groups.google.com/group/sage-nt/browse_thread/thread/5c376dbf7e99ea97/)\n* [https://groups.google.com/group/sage-nt/browse_thread/thread/32b65a5173f43267/](https://groups.google.com/group/sage-nt/browse_thread/thread/32b65a5173f43267/) \n* [https://groups.google.com/group/sage-nt/browse_thread/thread/9108218411e7f0a6/](https://groups.google.com/group/sage-nt/browse_thread/thread/9108218411e7f0a6/)\n\nThe first two are about coercions between number fields, but don't say anything about relative versus absolute. The third is about conversions, again no relative versus absolute.\n\nI also did another search on trac, and could only find the tickets I created last week: #12269 (this ticket) and #12271 (same, but for relativize).",
    "created_at": "2012-01-10T09:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148440",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:9'></a>Replying to [comment:8 SimonKing]:
> Sorry, I did not answer Marco's question yet.


No problem, it wasn't a very direct question.

> Is it the case that the map is already known at initialisation time?


Don't know, I'll have to dig through the code some more.

> Concerning "coercion or conversion between relative and absolute number fields", I think there has been at least one thread on sage-nt and also a trac ticket devoted to that subject.


Thanks, I don't know that ticket/thread. I have found

* [https://groups.google.com/group/sage-nt/browse_thread/thread/5c376dbf7e99ea97/](https://groups.google.com/group/sage-nt/browse_thread/thread/5c376dbf7e99ea97/)
* [https://groups.google.com/group/sage-nt/browse_thread/thread/32b65a5173f43267/](https://groups.google.com/group/sage-nt/browse_thread/thread/32b65a5173f43267/) 
* [https://groups.google.com/group/sage-nt/browse_thread/thread/9108218411e7f0a6/](https://groups.google.com/group/sage-nt/browse_thread/thread/9108218411e7f0a6/)

The first two are about coercions between number fields, but don't say anything about relative versus absolute. The third is about conversions, again no relative versus absolute.

I also did another search on trac, and could only find the tickets I created last week: #12269 (this ticket) and #12271 (same, but for relativize).



---

archive/issue_comments_148441.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:7 mstreng]:\n> `structure()[1]` cannot be a coercion, because it would lead to non-commuting diagrams of coercions.\n\n\nActually, maybe it is the coercion between O to P that shouldn't be there! All of the following maps are natural\n` O <--> M <-- K <--> L --> N <--> P `\nand a map between O and P sending generator to generator does not commute with the abovementioned natural maps.\n\nSome more about O and P:\n\n```\nsage: O\nNumber Field in e with defining polynomial x^4 - 10*x^2 + 1\nsage: P\nNumber Field in e with defining polynomial x^4 - 10*x^2 + 1\nsage: O is P\nFalse\nsage: O == P\nTrue\nsage: RR(O.structure()[1].domain().base_field().gen())\n-1.41421356237309\nsage: RR(P.structure()[1].domain().base_field().gen())\n1.41421356237309\n```\nO and P are really different, I don't understand True for \"==\" here. Is that a bug?\n\n```\nsage: K is L\nFalse\nsage: K == L\nFalse\n```",
    "created_at": "2012-01-10T10:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148441",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:10'></a>Replying to [comment:7 mstreng]:
> `structure()[1]` cannot be a coercion, because it would lead to non-commuting diagrams of coercions.


Actually, maybe it is the coercion between O to P that shouldn't be there! All of the following maps are natural
` O <--> M <-- K <--> L --> N <--> P `
and a map between O and P sending generator to generator does not commute with the abovementioned natural maps.

Some more about O and P:

```
sage: O
Number Field in e with defining polynomial x^4 - 10*x^2 + 1
sage: P
Number Field in e with defining polynomial x^4 - 10*x^2 + 1
sage: O is P
False
sage: O == P
True
sage: RR(O.structure()[1].domain().base_field().gen())
-1.41421356237309
sage: RR(P.structure()[1].domain().base_field().gen())
1.41421356237309
```
O and P are really different, I don't understand True for "==" here. Is that a bug?

```
sage: K is L
False
sage: K == L
False
```



---

archive/issue_comments_148442.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+```\n+sage: x = var('x')\n+sage: K1.<a1> = CyclotomicField(11)\n+sage: K2.<a2> = K1.extension(x^2 - 3)\n+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field\n+sage: t=a1+6*a2+a3*a1                 # with a complicated element.\n+sage: L = K3.absolute_field('b')\n+sage: L(t)\n+# The code at #11869 takes 12 seconds to compute roots of a\n+# polynomial, and then doesn't use them.\n+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field\n+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly\n+#(Isomorphism map:... , Isomorphism map: ...)\n+sage: L.structure()[1](t)\n+# big output\n+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment\n+# TypeError: unsupported operand parent(s) for '+': ....\n+sage: K3(L.gen())                     # There are similar problems in the other direction\n+# TypeError: Cannot coerce element into this number field\n+sage: L.structure()[0](L.gen())       # for which the structure maps also work.\n+# a3 - a2 + a1\n+```\n \n+So this ticket is meant to:\n+\n+* make both structure maps into conversions\n+* maybe make one or both of the structure maps into a coercion\n+\n+Speeding up #11869 is not really related and is #12270.\n \n Comment: 1\n \n```\n",
    "created_at": "2012-01-10T10:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148442",
    "user": "https://github.com/mstreng"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,32 @@
+```
+sage: x = var('x')
+sage: K1.<a1> = CyclotomicField(11)
+sage: K2.<a2> = K1.extension(x^2 - 3)
+sage: K3.<a3> = K2.extension(x^2 + 1) # Let's make a big relative number field
+sage: t=a1+6*a2+a3*a1                 # with a complicated element.
+sage: L = K3.absolute_field('b')
+sage: L(t)
+# The code at #11869 takes 12 seconds to compute roots of a
+# polynomial, and then doesn't use them.
+# TypeError: No compatible natural embeddings found for Number Field in b with .... and Complex Lazy Field
+sage: L.structure()                   # However, the correct conversion map is available and works almost instantly
+#(Isomorphism map:... , Isomorphism map: ...)
+sage: L.structure()[1](t)
+# big output
+sage: L.gen() + t                     # It would be good if one of the structure maps is a coercion, but they aren't at the moment
+# TypeError: unsupported operand parent(s) for '+': ....
+sage: K3(L.gen())                     # There are similar problems in the other direction
+# TypeError: Cannot coerce element into this number field
+sage: L.structure()[0](L.gen())       # for which the structure maps also work.
+# a3 - a2 + a1
+```
 
+So this ticket is meant to:
+
+* make both structure maps into conversions
+* maybe make one or both of the structure maps into a coercion
+
+Speeding up #11869 is not really related and is #12270.
 
 Comment: 1
 
```




---

archive/issue_comments_148443.json:
```json
{
    "body": "<a id='comment:11'></a>Hi, I agree that the error here is that O and P should not be given a coercion. Note that the code above does not work if P is given another generator name. On this example I would not expect a canonical isomorphism from O to P.",
    "created_at": "2012-01-30T11:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148443",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:11'></a>Hi, I agree that the error here is that O and P should not be given a coercion. Note that the code above does not work if P is given another generator name. On this example I would not expect a canonical isomorphism from O to P.



---

archive/issue_comments_148444.json:
```json
{
    "body": "<a id='comment:12'></a>Forcing coercions exposes other errors in the coercion model:\n\n```\nK = NumberField([x^2-2, x^2-3], 'a,b')\nM = K.absolute_field('c')\nM_to_K, K_to_M = M.structure()\nM.register_coercion(K_to_M)\nK.register_coercion(M_to_K)\nM.coerce_map_from(QQ)\n...\nUnboundLocalError: local variable 'connecting' referenced before assignment\n```",
    "created_at": "2012-01-30T14:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148444",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:12'></a>Forcing coercions exposes other errors in the coercion model:

```
K = NumberField([x^2-2, x^2-3], 'a,b')
M = K.absolute_field('c')
M_to_K, K_to_M = M.structure()
M.register_coercion(K_to_M)
K.register_coercion(M_to_K)
M.coerce_map_from(QQ)
...
UnboundLocalError: local variable 'connecting' referenced before assignment
```



---

archive/issue_comments_148445.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 lftabera]:\n> Forcing coercions exposes other errors in the coercion model:\n\n\nRight. And here it is (in sage.structure.parent, lines 2300-2303):\n\n```\n                connection = None\n                if EltPair(mor._domain, S, \"coerce\") not in _coerce_test_dict:\n                    connecting = mor._domain.coerce_map_from(S)\n                if connecting is not None:\n```\n\nSo, apparently someone intended to write \"connecting = None\", but wrote \"connection = None\". Can you try whether writing \"connecting = None\" fixes the problem? \n\n\n> {{{\n> K = NumberField([x^2-2, x^2-3], 'a,b')\n> M = K.absolute_field('c')\n> M_to_K, K_to_M = M.structure()\n> M.register_coercion(K_to_M)\n> K.register_coercion(M_to_K)\n> M.coerce_map_from(QQ)\n> ...\n> UnboundLocalError: local variable 'connecting' referenced before assignment\n> }}}",
    "created_at": "2012-01-30T14:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148445",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>Replying to [comment:12 lftabera]:
> Forcing coercions exposes other errors in the coercion model:


Right. And here it is (in sage.structure.parent, lines 2300-2303):

```
                connection = None
                if EltPair(mor._domain, S, "coerce") not in _coerce_test_dict:
                    connecting = mor._domain.coerce_map_from(S)
                if connecting is not None:
```

So, apparently someone intended to write "connecting = None", but wrote "connection = None". Can you try whether writing "connecting = None" fixes the problem? 


> {{{
> K = NumberField([x^2-2, x^2-3], 'a,b')
> M = K.absolute_field('c')
> M_to_K, K_to_M = M.structure()
> M.register_coercion(K_to_M)
> K.register_coercion(M_to_K)
> M.coerce_map_from(QQ)
> ...
> UnboundLocalError: local variable 'connecting' referenced before assignment
> }}}



---

archive/issue_comments_148446.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:11 lftabera]:\n> Hi, I agree that the error here is that O and P should not be given a coercion. Note that the code above does not work if P is given another generator name. On this example I would not expect a canonical isomorphism from O to P.\n\n\nThis can be fixed by making `O == P` be False by letting `O.__cmp__(P)` compare structure maps.",
    "created_at": "2012-01-30T17:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148446",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:14'></a>Replying to [comment:11 lftabera]:
> Hi, I agree that the error here is that O and P should not be given a coercion. Note that the code above does not work if P is given another generator name. On this example I would not expect a canonical isomorphism from O to P.


This can be fixed by making `O == P` be False by letting `O.__cmp__(P)` compare structure maps.



---

archive/issue_comments_148447.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 SimonKing]:\n> Replying to [comment:12 lftabera]:\n> > Forcing coercions exposes other errors in the coercion model:\n\n> \n> Right. And here it is (in sage.structure.parent, lines 2300-2303):\n> \n> ```\n>                 connection = None\n>                 if EltPair(mor._domain, S, \"coerce\") not in _coerce_test_dict:\n>                     connecting = mor._domain.coerce_map_from(S)\n>                 if connecting is not None:\n> ```\n> \n> So, apparently someone intended to write \"connecting = None\", but wrote \"connection = None\". Can you try whether writing \"connecting = None\" fixes the problem? \n\n\nYes, this solves the problem. I guess that this fix should go to a new ticket.",
    "created_at": "2012-02-08T08:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148447",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:15'></a>Replying to [comment:13 SimonKing]:
> Replying to [comment:12 lftabera]:
> > Forcing coercions exposes other errors in the coercion model:

> 
> Right. And here it is (in sage.structure.parent, lines 2300-2303):
> 
> ```
>                 connection = None
>                 if EltPair(mor._domain, S, "coerce") not in _coerce_test_dict:
>                     connecting = mor._domain.coerce_map_from(S)
>                 if connecting is not None:
> ```
> 
> So, apparently someone intended to write "connecting = None", but wrote "connection = None". Can you try whether writing "connecting = None" fixes the problem? 


Yes, this solves the problem. I guess that this fix should go to a new ticket.



---

archive/issue_comments_148448.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 lftabera]:\n> Yes, this solves the problem. I guess that this fix should go to a new ticket.\n\n\nOK, but I couldn't do it right now. I am in quite a mess with my good old group cohomology spkg, which wouldn't work in the latest Sage version for at least three independent reasons.",
    "created_at": "2012-02-08T09:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148448",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>Replying to [comment:15 lftabera]:
> Yes, this solves the problem. I guess that this fix should go to a new ticket.


OK, but I couldn't do it right now. I am in quite a mess with my good old group cohomology spkg, which wouldn't work in the latest Sage version for at least three independent reasons.



---

archive/issue_comments_148449.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 lftabera]:\n> Yes, this solves the problem. I guess that this fix should go to a new ticket.\n\n\nYes, that makes sense. It is a bugfix of 2 characters, so doesn't have to wait for all of #12269 to be fixed.",
    "created_at": "2012-02-08T09:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148449",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:17'></a>Replying to [comment:15 lftabera]:
> Yes, this solves the problem. I guess that this fix should go to a new ticket.


Yes, that makes sense. It is a bugfix of 2 characters, so doesn't have to wait for all of #12269 to be fixed.



---

archive/issue_comments_148450.json:
```json
{
    "body": "<a id='comment:18'></a>For the typo in parent.pyx I have added a patch in #12990",
    "created_at": "2012-05-22T18:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12269#issuecomment-148450",
    "user": "https://github.com/lftabera"
}
```

<a id='comment:18'></a>For the typo in parent.pyx I have added a patch in #12990



---

archive/issue_events_032769.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32769"
}
```



---

archive/issue_events_032770.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32770"
}
```



---

archive/issue_events_032771.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32771"
}
```



---

archive/issue_events_032772.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32772"
}
```



---

archive/issue_events_032773.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32773"
}
```



---

archive/issue_events_032774.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32774"
}
```



---

archive/issue_events_032775.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12269",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12269#event-32775"
}
```
