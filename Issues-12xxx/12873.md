# Issue 12873: Clear FPU in i386/x86_64 longjmp()

archive/issues_012701.json:
```json
{
    "body": "If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.\n\nThe proposed solution is to clear the FPU \"tag word\" (using the `EMMS` or `FFREE` instructions) in the signal handler.\n\nTo see the problem in action, compile [attachment:emms.c] on i686 hardware with\n\n```\ngcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n```\n\n**Apply** [attachment:12873_emms.patch]\n\n**Obsoleted** by #13076 and fixed in a better way.\n\nAssignee: @jdemeyer\n\nCC:  @nexttime\n\nReviewer: Volker Braun\n\nAuthor: Jeroen Demeyer\n\nMerged: sage-5.1.beta0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/12873\n\n",
    "closed_at": "2012-05-06T12:20:38Z",
    "created_at": "2012-04-24T15:17:01Z",
    "labels": [
        "component: c_lib",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "Clear FPU in i386/x86_64 longjmp()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12873",
    "user": "https://github.com/jdemeyer"
}
```
If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.

The proposed solution is to clear the FPU "tag word" (using the `EMMS` or `FFREE` instructions) in the signal handler.

To see the problem in action, compile [attachment:emms.c] on i686 hardware with

```
gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
```

**Apply** [attachment:12873_emms.patch]

**Obsoleted** by #13076 and fixed in a better way.

Assignee: @jdemeyer

CC:  @nexttime

Reviewer: Volker Braun

Author: Jeroen Demeyer

Merged: sage-5.1.beta0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/12873





---

archive/issue_comments_161199.json:
```json
{
    "body": "<a id='comment:1'></a>Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.",
    "created_at": "2012-04-24T16:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161199",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.



---

archive/issue_comments_161200.json:
```json
{
    "body": "Changing component from solaris to c_lib.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161200",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from solaris to c_lib.



---

archive/issue_comments_161201.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,4 @@\n-The libc `setjmp`/`longjmp` functions of OpenSolaris 06.2009-32 on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.\n-\n-Assignee: drkirkby\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161201",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,4 @@
-The libc `setjmp`/`longjmp` functions of OpenSolaris 06.2009-32 on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.
-
-Assignee: drkirkby
+The libc `setjmp`/`longjmp` functions on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161202.json:
```json
{
    "body": "Changing assignee from drkirkby to @jdemeyer.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161202",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from drkirkby to @jdemeyer.



---

archive/issue_comments_161203.json:
```json
{
    "body": "<a id='comment:3'></a>I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161203",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.



---

archive/issue_comments_161204.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.\n \n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -lm -march=native -m32 -mfpmath=387 emms.c -o emms\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-25T15:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161204",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,10 @@
+The libc `setjmp`/`longjmp` functions on i686 hardware do not fully restore the x87 FPU state, in particular when MMX instructions have been used.  The proposed solution is to execute the `EMMS` instruction before `longjmp()`.  For more context, see #12777 where this bug was discovered.
 
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -lm -march=native -m32 -mfpmath=387 emms.c -o emms
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161205.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -lm -march=native -m32 -mfpmath=387 emms.c -o emms\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-26T09:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161205",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -lm -march=native -m32 -mfpmath=387 emms.c -o emms
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161206.json:
```json
{
    "body": "Test program",
    "created_at": "2012-04-26T20:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161206",
    "user": "https://github.com/jdemeyer"
}
```

Test program



---

archive/issue_comments_161207.json:
```json
{
    "body": "<a id='comment:6'></a>Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01",
    "created_at": "2012-04-26T20:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161207",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01



---

archive/issue_comments_161208.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-26T20:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161208",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161209.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-26T20:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161209",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,12 @@
+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161210.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n+\n+**Apply** [attachment:12873_emms.patch]\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-27T15:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161210",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+The libc `setjmp`/`longjmp` functions on i686 hardware do not restore the x87 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU state (using the `EMMS` instruction) in the signal handler.  For more context, see #12777 where this bug was discovered.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
+
+**Apply** [attachment:12873_emms.patch]
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161211.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-27T15:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161211",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_161212.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25",
    "created_at": "2012-04-30T09:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161212",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25



---

archive/issue_comments_161213.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+The libc `setjmp`/`longjmp` functions on i386/x86_64 hardware do not restore the 387 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU (using the `EMMS` or `FFREE` instructions) in the signal handler.  For more context, see #12777 where this bug was discovered.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n+\n+**Apply** [attachment:12873_emms.patch]\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-30T09:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161213",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+The libc `setjmp`/`longjmp` functions on i386/x86_64 hardware do not restore the 387 FPU state, in particular when MMX instructions have been used.  On Linux and OS X 10.6, the FPU state is restored when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU (using the `EMMS` or `FFREE` instructions) in the signal handler.  For more context, see #12777 where this bug was discovered.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
+
+**Apply** [attachment:12873_emms.patch]
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161214.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU \"tag word\" (using the `EMMS` or `FFREE` instructions) in the signal handler.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n+\n+**Apply** [attachment:12873_emms.patch]\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-04-30T09:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161214",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU "tag word" (using the `EMMS` or `FFREE` instructions) in the signal handler.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
+
+**Apply** [attachment:12873_emms.patch]
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161215.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161215",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_161216.json:
```json
{
    "body": "<a id='comment:11'></a>The joys of the x86 architechture! ;-)\n\nPatch looks good to me.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161216",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>The joys of the x86 architechture! ;-)

Patch looks good to me.



---

archive/issue_events_035109.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-30T20:51:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12873#event-35109"
}
```



---

archive/issue_comments_161217.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-06T12:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161217",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_035110.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-06T12:20:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12873#event-35110"
}
```



---

archive/issue_comments_161218.json:
```json
{
    "body": "Similar test program using setcontext()",
    "created_at": "2012-06-03T13:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161218",
    "user": "https://github.com/jdemeyer"
}
```

Similar test program using setcontext()



---

archive/issue_comments_161219.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.\n \n+The proposed solution is to clear the FPU \"tag word\" (using the `EMMS` or `FFREE` instructions) in the signal handler.\n+\n+To see the problem in action, compile [attachment:emms.c] on i686 hardware with\n+\n+```\n+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n+```\n+\n+**Apply** [attachment:12873_emms.patch]\n+\n+**Obsoleted** by #13076 and fixed in a better way.\n \n Author: Jeroen Demeyer\n \n```\n",
    "created_at": "2012-06-03T19:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161219",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,16 @@
+If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.
 
+The proposed solution is to clear the FPU "tag word" (using the `EMMS` or `FFREE` instructions) in the signal handler.
+
+To see the problem in action, compile [attachment:emms.c] on i686 hardware with
+
+```
+gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
+```
+
+**Apply** [attachment:12873_emms.patch]
+
+**Obsoleted** by #13076 and fixed in a better way.
 
 Author: Jeroen Demeyer
 
```




---

archive/issue_comments_161220.json:
```json
{
    "body": "<a id='comment:14'></a>Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45\n\n#13076 fixes this problem in a much better way, so that ticket effectively undoes this.",
    "created_at": "2012-06-03T19:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-161220",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45

#13076 fixes this problem in a much better way, so that ticket effectively undoes this.
