# Issue 12873: Clear FPU in i386/x86_64 longjmp()

archive/issues_012701.json:
```json
{
    "body": "Assignee: @jdemeyer\n\nCC:  @nexttime\n\nIf an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.\n\nThe proposed solution is to clear the FPU \"tag word\" (using the `EMMS` or `FFREE` instructions) in the signal handler.\n\nTo see the problem in action, compile [attachment:emms.c] on i686 hardware with\n\n```\ngcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms\n```\n\n**Apply** [attachment:12873_emms.patch]\n\n**Obsoleted** by #13076 and fixed in a better way.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12873\n\n",
    "closed_at": "2012-05-06T12:20:38Z",
    "created_at": "2012-04-24T15:17:01Z",
    "labels": [
        "component: c_lib",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "Clear FPU in i386/x86_64 longjmp()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12873",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: @jdemeyer

CC:  @nexttime

If an interrupt occurs during a 387 FPU computation or during an MMX computation (which also uses the FPU registers), then some of the FPU registers will be occupied.  This may lead to failures with subsequent FPU compuations, see for example #12777.  Some operating systems (e.g. Linux and OS X 10.6) restore the FPU state when an interrupt occurs, but on Solaris this is not the case.

The proposed solution is to clear the FPU "tag word" (using the `EMMS` or `FFREE` instructions) in the signal handler.

To see the problem in action, compile [attachment:emms.c] on i686 hardware with

```
gcc -march=pentium2 -m32 -mfpmath=387 -lm emms.c -o emms
```

**Apply** [attachment:12873_emms.patch]

**Obsoleted** by #13076 and fixed in a better way.

Issue created by migration from https://trac.sagemath.org/ticket/12873





---

archive/issue_comments_151559.json:
```json
{
    "body": "Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.",
    "created_at": "2012-04-24T16:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151559",
    "user": "https://github.com/jdemeyer"
}
```

Well, actually it's not so clear whether `longjmp()` should restore the FPU state.  I'll try to see whether I can reproduce the problem on Linux i686.



---

archive/issue_comments_151560.json:
```json
{
    "body": "Changing component from solaris to c_lib.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151560",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from solaris to c_lib.



---

archive/issue_comments_151561.json:
```json
{
    "body": "Changing assignee from drkirkby to @jdemeyer.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151561",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from drkirkby to @jdemeyer.



---

archive/issue_comments_151562.json:
```json
{
    "body": "I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.",
    "created_at": "2012-04-25T15:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151562",
    "user": "https://github.com/jdemeyer"
}
```

I can't be sure that the problem is limited to Solaris.  Using a test program (attached), I managed to reproduce the issue on Linux also.



---

archive/issue_comments_151563.json:
```json
{
    "body": "Test program",
    "created_at": "2012-04-26T20:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151563",
    "user": "https://github.com/jdemeyer"
}
```

Test program



---

archive/issue_comments_151564.json:
```json
{
    "body": "Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01",
    "created_at": "2012-04-26T20:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151564",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [emms.c](tarball://root/attachments/some-uuid/ticket12873/emms.c) by @jdemeyer created at 2012-04-26 20:33:01



---

archive/issue_comments_151565.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-27T15:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151565",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_151566.json:
```json
{
    "body": "Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25",
    "created_at": "2012-04-30T09:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151566",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12873_emms.patch](tarball://root/attachments/some-uuid/ticket12873/12873_emms.patch) by @jdemeyer created at 2012-04-30 09:40:25



---

archive/issue_comments_151567.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151567",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_151568.json:
```json
{
    "body": "The joys of the x86 architechture! ;-)\n\nPatch looks good to me.",
    "created_at": "2012-04-30T15:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151568",
    "user": "https://github.com/vbraun"
}
```

The joys of the x86 architechture! ;-)

Patch looks good to me.



---

archive/issue_events_035109.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-30T20:51:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "milestone": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12873#event-35109"
}
```



---

archive/issue_comments_151569.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-06T12:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151569",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_035110.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-06T12:20:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12873#event-35110"
}
```



---

archive/issue_comments_151570.json:
```json
{
    "body": "Similar test program using setcontext()",
    "created_at": "2012-06-03T13:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151570",
    "user": "https://github.com/jdemeyer"
}
```

Similar test program using setcontext()



---

archive/issue_comments_151571.json:
```json
{
    "body": "Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45\n\n#13076 fixes this problem in a much better way, so that ticket effectively undoes this.",
    "created_at": "2012-06-03T19:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12873#issuecomment-151571",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [context.c](tarball://root/attachments/some-uuid/ticket12873/context.c) by @jdemeyer created at 2012-06-03 19:54:45

#13076 fixes this problem in a much better way, so that ticket effectively undoes this.
