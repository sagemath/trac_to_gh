# Issue 12521: bug in jordan_form(transformation=true) for integer matrices

archive/issues_012521.json:
```json
{
    "body": "Assignee: jason, was\n\nKeywords: jordan form, sd40.5\n\n```\nsage: M=matrix(((2,2,2),(0,0,0),(-2,-2,-2)))\nsage: M.jordan_form(transformation=true) \n(\n[0 1|0]            \n[0 0|0]  [ 2  1  1]\n[---+-]  [ 0  0  0]\n[0 0|0], [-2  0 -1]\n)\n```\n\nIf the output from M.jordan_form(transformation=true) is J,P, then we are supposed to have J=P<sup>-1</sup> M P.  The output here is obviously wrong, since P is not invertible (having a zero row).  \n\nIf you change the 2's to 1's and the -2's to -1's it works properly.  \n\nThis behaviour exists in 4.8 and 5.0beta5.  \n\n**Apply:**\n1.  [attachment:trac_12693_fix_jordan_form_bug.3.patch]\n2.  [attachment:trac_12693_fix_jordan_form_reviewer.patch]\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12693\n\n",
    "closed_at": "2012-06-18T10:23:44Z",
    "created_at": "2012-03-19T00:28:55Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "bug in jordan_form(transformation=true) for integer matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12521",
    "user": "https://github.com/hughrthomas"
}
```
Assignee: jason, was

Keywords: jordan form, sd40.5

```
sage: M=matrix(((2,2,2),(0,0,0),(-2,-2,-2)))
sage: M.jordan_form(transformation=true) 
(
[0 1|0]            
[0 0|0]  [ 2  1  1]
[---+-]  [ 0  0  0]
[0 0|0], [-2  0 -1]
)
```

If the output from M.jordan_form(transformation=true) is J,P, then we are supposed to have J=P<sup>-1</sup> M P.  The output here is obviously wrong, since P is not invertible (having a zero row).  

If you change the 2's to 1's and the -2's to -1's it works properly.  

This behaviour exists in 4.8 and 5.0beta5.  

**Apply:**
1.  [attachment:trac_12693_fix_jordan_form_bug.3.patch]
2.  [attachment:trac_12693_fix_jordan_form_reviewer.patch]


Issue created by migration from https://trac.sagemath.org/ticket/12693





---

archive/issue_comments_148099.json:
```json
{
    "body": "Looks like a simple type error somewhere.  Fails for integers, works for rationals:\n\n```\n\nsage: M\n[ 2  2  2]\n[ 0  0  0]\n[-2 -2 -2]\nsage: parent(M)\nFull MatrixSpace of 3 by 3 dense matrices over Integer Ring\nsage: M.jordan_form(transformation=True)\n(\n[0 1|0]            \n[0 0|0]  [ 2  1  1]\n[---+-]  [ 0  0  0]\n[0 0|0], [-2  0 -1]\n)\n```\n\nbut\n\n```\nsage: (M/1).jordan_form(transformation=True)\n(\n[0 1|0]            \n[0 0|0]  [ 2  1  0]\n[---+-]  [ 0  0  1]\n[0 0|0], [-2  0 -1]\n)\nsage: parent(M/1)\nFull MatrixSpace of 3 by 3 dense matrices over Rational Field\nsage: (M/1).jordan_form(transformation=True)\n(\n[0 1|0]            \n[0 0|0]  [ 2  1  0]\n[---+-]  [ 0  0  1]\n[0 0|0], [-2  0 -1]\n)\nsage: J, P = (M/1).jordan_form(transformation=True)\nsage: J == P**(-1)*M*P\nTrue\n```\n\nWill see if I can track it down.",
    "created_at": "2012-03-19T00:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148099",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Looks like a simple type error somewhere.  Fails for integers, works for rationals:

```

sage: M
[ 2  2  2]
[ 0  0  0]
[-2 -2 -2]
sage: parent(M)
Full MatrixSpace of 3 by 3 dense matrices over Integer Ring
sage: M.jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  1]
[---+-]  [ 0  0  0]
[0 0|0], [-2  0 -1]
)
```

but

```
sage: (M/1).jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  0]
[---+-]  [ 0  0  1]
[0 0|0], [-2  0 -1]
)
sage: parent(M/1)
Full MatrixSpace of 3 by 3 dense matrices over Rational Field
sage: (M/1).jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  0]
[---+-]  [ 0  0  1]
[0 0|0], [-2  0 -1]
)
sage: J, P = (M/1).jordan_form(transformation=True)
sage: J == P**(-1)*M*P
True
```

Will see if I can track it down.



---

archive/issue_comments_148100.json:
```json
{
    "body": "Thanks!  And thanks for the quick-and-dirty fix, which will mean I can finish the calculation I was working on!",
    "created_at": "2012-03-19T01:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148100",
    "user": "https://github.com/hughrthomas"
}
```

Thanks!  And thanks for the quick-and-dirty fix, which will mean I can finish the calculation I was working on!



---

archive/issue_comments_148101.json:
```json
{
    "body": "I can see what's going on, but I'm not sure what the best way to deal with it is.  For my part I'd probably simply push everything to the fraction field during the base_ring changes of jordan_form() in matrix2.pyx and work with vector spaces over the field instead of free modules over the ring, but not everyone might like that.\n\n\nComparing the differences between the code paths for ZZ and QQ, the first divergence seems to come in _jordan_form_vector_in_difference.  Both cases get V= [(1, 0, -1), (0, 1, -1)] and W = [(2, 0, -2), (1, 0, 0)], but in the integer case the resulting W_space is\n\n```\nW_space: Free module of degree 3 and rank 2 over Integer Ring\nEchelon basis matrix:\n[1 0 0]\n[0 0 2]\n```\n\ni.e. a FreeModule_submodule_pid_with_category (not a FreeModule_submodule_field_with_category, as it would be in QQ) at which point Sage decides (reasonably enough) that (1, 0, -1) isn't in W_space. For comparison, the QQ case gives\n\n```\nW_space: Vector space of degree 3 and dimension 2 over Rational Field\nBasis matrix:\n[1 0 0]\n[0 0 1]\n```\n\nand it returns (0, 1, -1) instead.  \n\nGood news is that whatever we decide to do should be straightforward.",
    "created_at": "2012-03-19T03:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148101",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

I can see what's going on, but I'm not sure what the best way to deal with it is.  For my part I'd probably simply push everything to the fraction field during the base_ring changes of jordan_form() in matrix2.pyx and work with vector spaces over the field instead of free modules over the ring, but not everyone might like that.


Comparing the differences between the code paths for ZZ and QQ, the first divergence seems to come in _jordan_form_vector_in_difference.  Both cases get V= [(1, 0, -1), (0, 1, -1)] and W = [(2, 0, -2), (1, 0, 0)], but in the integer case the resulting W_space is

```
W_space: Free module of degree 3 and rank 2 over Integer Ring
Echelon basis matrix:
[1 0 0]
[0 0 2]
```

i.e. a FreeModule_submodule_pid_with_category (not a FreeModule_submodule_field_with_category, as it would be in QQ) at which point Sage decides (reasonably enough) that (1, 0, -1) isn't in W_space. For comparison, the QQ case gives

```
W_space: Vector space of degree 3 and dimension 2 over Rational Field
Basis matrix:
[1 0 0]
[0 0 1]
```

and it returns (0, 1, -1) instead.  

Good news is that whatever we decide to do should be straightforward.



---

archive/issue_comments_148102.json:
```json
{
    "body": "Working over QQ (or, in general, over the fraction field) seems fine to me.  Basically, though, I am not knowledgeable enough to have an opinion.",
    "created_at": "2012-03-19T12:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148102",
    "user": "https://github.com/hughrthomas"
}
```

Working over QQ (or, in general, over the fraction field) seems fine to me.  Basically, though, I am not knowledgeable enough to have an opinion.



---

archive/issue_comments_148103.json:
```json
{
    "body": "I cannot see how this routine should be guaranteed to succeed over a ring that is not a field.  And eventually we need to factor the characteristic polynomial over the ring anyway.\n\nSo I see no harm into moving to the fraction field now and if there **is** a way to do this over a ring, another patch can attempt that.\n\nRob",
    "created_at": "2012-05-26T03:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148103",
    "user": "https://github.com/rbeezer"
}
```

I cannot see how this routine should be guaranteed to succeed over a ring that is not a field.  And eventually we need to factor the characteristic polynomial over the ring anyway.

So I see no harm into moving to the fraction field now and if there **is** a way to do this over a ring, another patch can attempt that.

Rob



---

archive/issue_comments_148104.json:
```json
{
    "body": "Changing keywords from \"jordan form\" to \"jordan form, sd40.5\".",
    "created_at": "2012-05-26T03:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148104",
    "user": "https://github.com/rbeezer"
}
```

Changing keywords from "jordan form" to "jordan form, sd40.5".



---

archive/issue_comments_148105.json:
```json
{
    "body": "Okay, here's a draft.  It passes matrix/* doctests but I haven't yet run the full test suite.",
    "created_at": "2012-05-26T03:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148105",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Okay, here's a draft.  It passes matrix/* doctests but I haven't yet run the full test suite.



---

archive/issue_comments_148106.json:
```json
{
    "body": "Attachment [trac_12693_fix_jordan_form_bug.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.patch) by dsm created at 2012-05-26 04:07:09\n\npush ring to the field",
    "created_at": "2012-05-26T04:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148106",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Attachment [trac_12693_fix_jordan_form_bug.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.patch) by dsm created at 2012-05-26 04:07:09

push ring to the field



---

archive/issue_comments_148107.json:
```json
{
    "body": "Attachment [trac_12693_fix_jordan_form_bug.2.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.2.patch) by dsm created at 2012-05-26 04:07:50\n\npush ring to the field",
    "created_at": "2012-05-26T04:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148107",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Attachment [trac_12693_fix_jordan_form_bug.2.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.2.patch) by dsm created at 2012-05-26 04:07:50

push ring to the field



---

archive/issue_comments_148108.json:
```json
{
    "body": "Attachment [trac_12693_fix_jordan_form_bug.3.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.3.patch) by dsm created at 2012-05-26 04:08:00\n\npush ring to the field",
    "created_at": "2012-05-26T04:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148108",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Attachment [trac_12693_fix_jordan_form_bug.3.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_bug.3.patch) by dsm created at 2012-05-26 04:08:00

push ring to the field



---

archive/issue_comments_148109.json:
```json
{
    "body": "Looking good.  I'll be more thorough in the morning.",
    "created_at": "2012-05-26T05:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148109",
    "user": "https://github.com/rbeezer"
}
```

Looking good.  I'll be more thorough in the morning.



---

archive/issue_comments_148110.json:
```json
{
    "body": "Reviewer patch",
    "created_at": "2012-05-27T04:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148110",
    "user": "https://github.com/rbeezer"
}
```

Reviewer patch



---

archive/issue_comments_148111.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-27T04:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148111",
    "user": "https://github.com/rbeezer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_148112.json:
```json
{
    "body": "Attachment [trac_12693_fix_jordan_form_reviewer.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_reviewer.patch) by @rbeezer created at 2012-05-27 04:37:49",
    "created_at": "2012-05-27T04:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148112",
    "user": "https://github.com/rbeezer"
}
```

Attachment [trac_12693_fix_jordan_form_reviewer.patch](tarball://root/attachments/some-uuid/ticket12693/trac_12693_fix_jordan_form_reviewer.patch) by @rbeezer created at 2012-05-27 04:37:49



---

archive/issue_comments_148113.json:
```json
{
    "body": "Version 3 patch has a positive review from me, my reviewer patch will need a look (from Doug?).",
    "created_at": "2012-05-27T04:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148113",
    "user": "https://github.com/rbeezer"
}
```

Version 3 patch has a positive review from me, my reviewer patch will need a look (from Doug?).



---

archive/issue_comments_148114.json:
```json
{
    "body": "Okay, the reviewer patch looks good to me.",
    "created_at": "2012-05-27T05:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148114",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

Okay, the reviewer patch looks good to me.



---

archive/issue_comments_148115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-27T05:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148115",
    "user": "https://github.com/rbeezer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_034415.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-06-18T10:23:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12521#event-34415"
}
```



---

archive/issue_comments_148116.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-06-18T10:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12521#issuecomment-148116",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
