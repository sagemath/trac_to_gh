# Issue 12954: Make MPIR support SAGE_FAT_BINARY on all systems

archive/issues_012782.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  @jdemeyer @nexttime jpflori @mwhansen @kcrisman @vbraun\n\nKeywords: sd40.5\n\nThe OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.\n\nReported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n\n**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n\n### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)\n* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support\n  --enable-fat, compile a generic binary (not assuming any particular\n  CPU) by passing the output of configfsf.guess to the --build option\n  of ./configure.\n* Disable SAGE_FAT_BINARY when bootstrapping GCC.\n* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.\n* Add configure options directly to MPIR_CONFIGURE, no longer use\n  SAGE_CONF_OPTS for this.\n* When user specifies CFLAGS, append them to MPIR's flags instead of\n  completely replacing MPIR's flags.\n* Remove $default_cflags and get_processor_specific_cflags().\n\nIssue created by migration from https://trac.sagemath.org/ticket/12954\n\n",
    "closed_at": "2012-05-28T22:59:04Z",
    "created_at": "2012-05-17T04:07:00Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0.1",
    "title": "Make MPIR support SAGE_FAT_BINARY on all systems",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12954",
    "user": "https://github.com/vbraun"
}
```
Assignee: tbd

CC:  @jdemeyer @nexttime jpflori @mwhansen @kcrisman @vbraun

Keywords: sd40.5

The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.

Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion

**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)

### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)
* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support
  --enable-fat, compile a generic binary (not assuming any particular
  CPU) by passing the output of configfsf.guess to the --build option
  of ./configure.
* Disable SAGE_FAT_BINARY when bootstrapping GCC.
* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.
* Add configure options directly to MPIR_CONFIGURE, no longer use
  SAGE_CONF_OPTS for this.
* When user specifies CFLAGS, append them to MPIR's flags instead of
  completely replacing MPIR's flags.
* Remove $default_cflags and get_processor_specific_cflags().

Issue created by migration from https://trac.sagemath.org/ticket/12954





---

archive/issue_comments_153110.json:
```json
{
    "body": "Can you disassemble to see which instruction failed?\n\nThis MPFR binary was built with\n\n```\n-Wall -Wmissing-prototypes -Wpointer-arith -O2 -m64 -march=corei7 -mtune=corei7 \n```\n\nMPIR was built with\n\n```\n-O2 -m64 -march=corei7 -mtune=corei7\n```\n\nSo, SAGE_FAT_BINARY indeed doesn't work as it should.",
    "created_at": "2012-05-17T13:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153110",
    "user": "https://github.com/jdemeyer"
}
```

Can you disassemble to see which instruction failed?

This MPFR binary was built with

```
-Wall -Wmissing-prototypes -Wpointer-arith -O2 -m64 -march=corei7 -mtune=corei7 
```

MPIR was built with

```
-O2 -m64 -march=corei7 -mtune=corei7
```

So, SAGE_FAT_BINARY indeed doesn't work as it should.



---

archive/issue_comments_153111.json:
```json
{
    "body": "> Can you disassemble to see which instruction failed?\n> \n\n\nIf you tell me how to do that (explicit commands) I have the offending binary on the right CPU and could at least get you a dump of the info that came out.",
    "created_at": "2012-05-17T13:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153111",
    "user": "https://github.com/kcrisman"
}
```

> Can you disassemble to see which instruction failed?
> 


If you tell me how to do that (explicit commands) I have the offending binary on the right CPU and could at least get you a dump of the info that came out.



---

archive/issue_comments_153112.json:
```json
{
    "body": "Changing component from build to packages.",
    "created_at": "2012-05-17T16:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153112",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from build to packages.



---

archive/issue_comments_153113.json:
```json
{
    "body": "Changing assignee from GeorgSWeber to tbd.",
    "created_at": "2012-05-17T16:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153113",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from GeorgSWeber to tbd.



---

archive/issue_comments_153114.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2012-05-17T16:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153114",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_153115.json:
```json
{
    "body": "The problem is with MPIR (as MPFR simply uses MPIR's flags).  The current MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.",
    "created_at": "2012-05-17T18:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153115",
    "user": "https://github.com/jdemeyer"
}
```

The problem is with MPIR (as MPFR simply uses MPIR's flags).  The current MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.



---

archive/issue_events_035435.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-18T12:26:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "milestone": "sage-5.0.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12954#event-35435"
}
```



---

archive/issue_comments_153116.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-18T12:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153116",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_153117.json:
```json
{
    "body": "`SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n\nSAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n\nI think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.",
    "created_at": "2012-05-18T14:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153117",
    "user": "https://github.com/vbraun"
}
```

`SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:

SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"

I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.



---

archive/issue_comments_153118.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n> \n> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n> \n> I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.\n\n\nMPIR actually does support \"fat binaries\" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.",
    "created_at": "2012-05-18T14:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153118",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"
> 
> I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.


MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.



---

archive/issue_comments_153119.json:
```json
{
    "body": "I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.",
    "created_at": "2012-05-18T22:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153119",
    "user": "https://github.com/dimpase"
}
```

I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
 on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.



---

archive/issue_comments_153120.json:
```json
{
    "body": "Replying to [comment:13 dimpase]:\n> I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n>  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.\n\n\nI would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?",
    "created_at": "2012-05-18T22:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153120",
    "user": "https://github.com/mwhansen"
}
```

Replying to [comment:13 dimpase]:
> I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
>  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.


I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?



---

archive/issue_comments_153121.json:
```json
{
    "body": "Replying to [comment:14 mhansen]:\n> Replying to [comment:13 dimpase]:\n> > I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n> >  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.\n\n> \n> I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?\n\n\nit's a good point. Well, I don't have newer hardware to test this.",
    "created_at": "2012-05-18T22:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153121",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:14 mhansen]:
> Replying to [comment:13 dimpase]:
> > I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
> >  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.

> 
> I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?


it's a good point. Well, I don't have newer hardware to test this.



---

archive/issue_comments_153122.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> MPIR actually does support \"fat binaries\" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.\n\n\nWhy do we have to set CFLAGS at all, then?\n\nAlso, is this really true? With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?",
    "created_at": "2012-05-18T22:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153122",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:12 jdemeyer]:
> MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.


Why do we have to set CFLAGS at all, then?

Also, is this really true? With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?



---

archive/issue_comments_153123.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?\n\nThe surrounding library code is compiled with basic CFLAGS, without setting `-march` at all.  But the critical routines are compiled several times for various processors.",
    "created_at": "2012-05-19T08:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153123",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?

The surrounding library code is compiled with basic CFLAGS, without setting `-march` at all.  But the critical routines are compiled several times for various processors.



---

archive/issue_comments_153124.json:
```json
{
    "body": "If you want",
    "created_at": "2012-05-19T08:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153124",
    "user": "https://github.com/jdemeyer"
}
```

If you want



---

archive/issue_comments_153125.json:
```json
{
    "body": "I tried the (non-app) binary from 5.0.1.rc0 on on Core 2 Duo (OSX 10.6.8), and got the usual crash:\n\n```\n\nsage: int(2.75)\n\n------------------------------------------------------------------------\nUnhandled SIGILL: An illegal instruction occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/Users/dima/Desktop/sage/spkg/bin/sage: line 312: 63629 Illegal instruction     sage-ipython \"$@\" -i\n\n```\n\nwith ./sage -gdb, I get \n\n```\nsage: int(2.75)\n\nProgram received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.\n0x00000001016e3ed9 in case1 ()\n(gdb) bt\n#0  0x00000001016e3ed9 in case1 ()\n#1  0x0000000103e6dba4 in parsed_string_to_mpfr ()\n#2  0x0000000103e6e7fb in mpfr_strtofr ()\nPrevious frame inner to this frame (gdb could not unwind past this frame)\n(gdb) \n```",
    "created_at": "2012-05-19T12:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153125",
    "user": "https://github.com/dimpase"
}
```

I tried the (non-app) binary from 5.0.1.rc0 on on Core 2 Duo (OSX 10.6.8), and got the usual crash:

```

sage: int(2.75)

------------------------------------------------------------------------
Unhandled SIGILL: An illegal instruction occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/Users/dima/Desktop/sage/spkg/bin/sage: line 312: 63629 Illegal instruction     sage-ipython "$@" -i

```

with ./sage -gdb, I get 

```
sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) bt
#0  0x00000001016e3ed9 in case1 ()
#1  0x0000000103e6dba4 in parsed_string_to_mpfr ()
#2  0x0000000103e6e7fb in mpfr_strtofr ()
Previous frame inner to this frame (gdb could not unwind past this frame)
(gdb) 
```



---

archive/issue_comments_153126.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-19T12:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153126",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_153127.json:
```json
{
    "body": "Can you send the output of\n\n```\n(gdb) disas\n```\nwhen getting a `SIGILL`?",
    "created_at": "2012-05-19T13:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153127",
    "user": "https://github.com/jdemeyer"
}
```

Can you send the output of

```
(gdb) disas
```
when getting a `SIGILL`?



---

archive/issue_comments_153128.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> Can you send the output of\n> \n> ```\n> (gdb) disas\n> ```\n> when getting a `SIGILL`?\n\n{{{\n\nsage: int(2.75)\n\nProgram received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.\n0x00000001016e3ed9 in case1 ()\n(gdb) disas\nDump of assembler code for function case1:\n0x00000001016e3ed9 <case1+0>:\tpopcnt 0x20(%rdi),%r8\n0x00000001016e3edf <case1+6>:\tadd    %r8,%rax\nEnd of assembler dump.\n(gdb) \n}}}",
    "created_at": "2012-05-19T13:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153128",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:20 jdemeyer]:
> Can you send the output of
> 
> ```
> (gdb) disas
> ```
> when getting a `SIGILL`?

{{{

sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) disas
Dump of assembler code for function case1:
0x00000001016e3ed9 <case1+0>:	popcnt 0x20(%rdi),%r8
0x00000001016e3edf <case1+6>:	add    %r8,%rax
End of assembler dump.
(gdb) 
}}}



---

archive/issue_comments_153129.json:
```json
{
    "body": "popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do \n\n```\n[~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt\n   45200:\tf3 4c 0f b8 04 cf    \tpopcnt (%rdi,%rcx,8),%r8\n   45206:\tf3 4c 0f b8 4c cf 08 \tpopcnt 0x8(%rdi,%rcx,8),%r9\n[...]\n```\nand I believe the equivalent command on OSX would be `otool -tV`. Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?",
    "created_at": "2012-05-19T22:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153129",
    "user": "https://github.com/vbraun"
}
```

popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 

```
[~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
   45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
   45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
[...]
```
and I believe the equivalent command on OSX would be `otool -tV`. Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?



---

archive/issue_comments_153130.json:
```json
{
    "body": "Replying to [comment:22 vbraun]:\n> popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do \n> \n> ```\n> [~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt\n>    45200:\tf3 4c 0f b8 04 cf    \tpopcnt (%rdi,%rcx,8),%r8\n>    45206:\tf3 4c 0f b8 4c cf 08 \tpopcnt 0x8(%rdi,%rcx,8),%r9\n> [...]\n> ```\n> and I believe the equivalent command on OSX would be `otool -tV`. \n\nyes, that's right (except it's not .so, but .dylb)\n\n```\n$ otool -tV local/lib/libmpir.dylib | grep popcnt\n000000000003be60\tpopcnt\t(%rdi,%rcx,8),%r8\n000000000003be66\tpopcnt\t0x08(%rdi,%rcx,8),%r9\n```\n\n> Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?\n\n\nhow would it help?\nThe problem seems to be in the inability of non-Apple gcc to build fat, a.k.a. universal, dynamic libs and executables. So I think we should either resort to making binary releases for OSX targeted to a particular architecture, or provide some post-install script that basically would do ./sage -f mpir (and anything else that needs similar fix) followed by ./sage -b. It's time-consuming to run, but it needs to be done only once...",
    "created_at": "2012-05-19T23:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153130",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:22 vbraun]:
> popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 
> 
> ```
> [~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
>    45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
>    45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
> [...]
> ```
> and I believe the equivalent command on OSX would be `otool -tV`. 

yes, that's right (except it's not .so, but .dylb)

```
$ otool -tV local/lib/libmpir.dylib | grep popcnt
000000000003be60	popcnt	(%rdi,%rcx,8),%r8
000000000003be66	popcnt	0x08(%rdi,%rcx,8),%r9
```

> Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?


how would it help?
The problem seems to be in the inability of non-Apple gcc to build fat, a.k.a. universal, dynamic libs and executables. So I think we should either resort to making binary releases for OSX targeted to a particular architecture, or provide some post-install script that basically would do ./sage -f mpir (and anything else that needs similar fix) followed by ./sage -b. It's time-consuming to run, but it needs to be done only once...



---

archive/issue_comments_153131.json:
```json
{
    "body": "Replying to [comment:23 dimpase]:\n> how would it help?\n\n\nIt would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.",
    "created_at": "2012-05-19T23:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153131",
    "user": "https://github.com/vbraun"
}
```

Replying to [comment:23 dimpase]:
> how would it help?


It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.



---

archive/issue_comments_153132.json:
```json
{
    "body": "Replying to [comment:24 vbraun]:\n> Replying to [comment:23 dimpase]:\n> > how would it help?\n\n> \n> It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.\n\n\nwell, we certainly should ship such binaries, it's more about the proper labeling of them as such...",
    "created_at": "2012-05-19T23:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153132",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:24 vbraun]:
> Replying to [comment:23 dimpase]:
> > how would it help?

> 
> It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.


well, we certainly should ship such binaries, it's more about the proper labeling of them as such...



---

archive/issue_comments_153133.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n> \n> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n\n\nThat description is certainly insufficient (or, to be more precise, one shouldn't read it from right to left).  One should in general not prepare \"fat\" binaries on relatively new (e.g. Core i7) CPUs -- unless one knows what one's doing... ;-)\n\nIMHO the main purpose of `SAGE_FAT_BINARY` is to avoid the use of processor-specific (\"hand-written\") *assembly code* (and prevent Sage from using things like `-march=native`); it's still up to the *distributor* to make sure the compiler is targeted to the *desired* CPU family (whichever that is).\n\n\n\n\nDoing some \"sanity check\" upon `sage -bdist` isn't all bad, but of course heavily depends on what (limited) architecture a specific binary distribution is supposed to be run on.\n\n\n---\n\nI never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.",
    "created_at": "2012-05-23T15:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153133",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:11 vbraun]:
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"


That description is certainly insufficient (or, to be more precise, one shouldn't read it from right to left).  One should in general not prepare "fat" binaries on relatively new (e.g. Core i7) CPUs -- unless one knows what one's doing... ;-)

IMHO the main purpose of `SAGE_FAT_BINARY` is to avoid the use of processor-specific ("hand-written") *assembly code* (and prevent Sage from using things like `-march=native`); it's still up to the *distributor* to make sure the compiler is targeted to the *desired* CPU family (whichever that is).




Doing some "sanity check" upon `sage -bdist` isn't all bad, but of course heavily depends on what (limited) architecture a specific binary distribution is supposed to be run on.


---

I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.



---

archive/issue_comments_153134.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-27T06:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153134",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_153135.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd40.5\".",
    "created_at": "2012-05-27T06:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153135",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "sd40.5".



---

archive/issue_comments_153136.json:
```json
{
    "body": "Replying to [comment:25 dimpase]:\n> Replying to [comment:24 vbraun]:\n> > Replying to [comment:23 dimpase]:\n> > > how would it help?\n\n> > \n> > It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.\n\n> \n> well, we certainly should ship such binaries\n\nI don't think we should ship such binaries, otherwise you're just going to confuse people.",
    "created_at": "2012-05-27T06:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153136",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 dimpase]:
> Replying to [comment:24 vbraun]:
> > Replying to [comment:23 dimpase]:
> > > how would it help?

> > 
> > It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.

> 
> well, we certainly should ship such binaries

I don't think we should ship such binaries, otherwise you're just going to confuse people.



---

archive/issue_comments_153137.json:
```json
{
    "body": "New spkg should be ready for review, changes have not yet been committed.",
    "created_at": "2012-05-27T06:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153137",
    "user": "https://github.com/jdemeyer"
}
```

New spkg should be ready for review, changes have not yet been committed.



---

archive/issue_comments_153138.json:
```json
{
    "body": "Attachment [mpir-2.4.0.p4.diff](tarball://root/attachments/some-uuid/ticket12954/mpir-2.4.0.p4.diff) by @jdemeyer created at 2012-05-27 06:23:49\n\nDiff between the 2.4.0.p3 and 2.4.0.p4 spkgs. For reference / review only.",
    "created_at": "2012-05-27T06:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153138",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [mpir-2.4.0.p4.diff](tarball://root/attachments/some-uuid/ticket12954/mpir-2.4.0.p4.diff) by @jdemeyer created at 2012-05-27 06:23:49

Diff between the 2.4.0.p3 and 2.4.0.p4 spkgs. For reference / review only.



---

archive/issue_comments_153139.json:
```json
{
    "body": "Replying to [comment:26 leif]:\n> I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.\n\nSo let's change it to `{PKG}_CONFIGURE`.  Some of these packages (mpfr, ecm, pari) need to be changed anyway.",
    "created_at": "2012-05-27T06:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153139",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:26 leif]:
> I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.

So let's change it to `{PKG}_CONFIGURE`.  Some of these packages (mpfr, ecm, pari) need to be changed anyway.



---

archive/issue_comments_153140.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-27T16:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153140",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_153141.json:
```json
{
    "body": "I read through your patch twice, tried building with SAGE_FAT_BINARY=\"yes\", and this all looks great to me.  Of course, the real test is the buildbot and whether or not this really solves people's problems.   So for now I give this a positive review.",
    "created_at": "2012-05-27T16:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153141",
    "user": "https://github.com/williamstein"
}
```

I read through your patch twice, tried building with SAGE_FAT_BINARY="yes", and this all looks great to me.  Of course, the real test is the buildbot and whether or not this really solves people's problems.   So for now I give this a positive review.



---

archive/issue_comments_153142.json:
```json
{
    "body": "I can confirm that this seems to work on an Intel Core 2 Duo which previously could not use the buildbot's binary.",
    "created_at": "2012-05-28T22:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153142",
    "user": "https://github.com/kcrisman"
}
```

I can confirm that this seems to work on an Intel Core 2 Duo which previously could not use the buildbot's binary.



---

archive/issue_events_035436.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-28T22:59:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12954#event-35436"
}
```



---

archive/issue_comments_153143.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-28T22:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153143",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_153144.json:
```json
{
    "body": "Just for reference, this also appears to have solved a similar issue on older PPC Macs using binaries built on (still old, but not *as* old) less old PPC Macs which was new with 5.0.  Good work.",
    "created_at": "2012-05-31T21:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12954#issuecomment-153144",
    "user": "https://github.com/kcrisman"
}
```

Just for reference, this also appears to have solved a similar issue on older PPC Macs using binaries built on (still old, but not *as* old) less old PPC Macs which was new with 5.0.  Good work.
