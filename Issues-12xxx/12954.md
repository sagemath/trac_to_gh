# Issue 12954: Make MPIR support SAGE_FAT_BINARY on all systems

archive/issues_012782.json:
```json
{
    "assignees": [],
    "body": "The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.\n\nReported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n\n**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n\n### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)\n* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support\n  --enable-fat, compile a generic binary (not assuming any particular\n  CPU) by passing the output of configfsf.guess to the --build option\n  of ./configure.\n* Disable SAGE_FAT_BINARY when bootstrapping GCC.\n* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.\n* Add configure options directly to MPIR_CONFIGURE, no longer use\n  SAGE_CONF_OPTS for this.\n* When user specifies CFLAGS, append them to MPIR's flags instead of\n  completely replacing MPIR's flags.\n* Remove $default_cflags and get_processor_specific_cflags().\n\nCC:  @jdemeyer @nexttime @jpflori @mwhansen @kcrisman @vbraun\n\nComponent: **packages: standard**\n\nKeywords: **sd40.5**\n\nAuthor: **Jeroen Demeyer**\n\nReviewer: **William Stein, Karl-Dieter Crisman**\n\nMerged: **sage-5.0.1.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12954_\n\n",
    "closed_at": "2012-05-28T22:59:04Z",
    "created_at": "2012-05-17T04:07:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.0.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Make MPIR support SAGE_FAT_BINARY on all systems",
    "type": "issue",
    "updated_at": "2012-05-31T21:10:42Z",
    "url": "https://github.com/sagemath/sage/issues/12954",
    "user": "https://github.com/vbraun"
}
```
The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.

Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion

**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)

### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)
* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support
  --enable-fat, compile a generic binary (not assuming any particular
  CPU) by passing the output of configfsf.guess to the --build option
  of ./configure.
* Disable SAGE_FAT_BINARY when bootstrapping GCC.
* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.
* Add configure options directly to MPIR_CONFIGURE, no longer use
  SAGE_CONF_OPTS for this.
* When user specifies CFLAGS, append them to MPIR's flags instead of
  completely replacing MPIR's flags.
* Remove $default_cflags and get_processor_specific_cflags().

CC:  @jdemeyer @nexttime @jpflori @mwhansen @kcrisman @vbraun

Component: **packages: standard**

Keywords: **sd40.5**

Author: **Jeroen Demeyer**

Reviewer: **William Stein, Karl-Dieter Crisman**

Merged: **sage-5.0.1.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/12954_





---

archive/issue_events_177482.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-05-17T04:07:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "milestone_number": null,
    "milestone_title": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177482"
}
```



---

archive/issue_events_177483.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-05-17T04:07:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177483"
}
```



---

archive/issue_events_177484.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-05-17T04:07:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177484"
}
```



---

archive/issue_events_177485.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2012-05-17T04:07:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177485"
}
```



---

archive/issue_events_177486.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2012-05-17T04:07:00Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177486"
}
```



---

archive/issue_comments_146842.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCan you disassemble to see which instruction failed?\n\nThis MPFR binary was built with\n\n```\n-Wall -Wmissing-prototypes -Wpointer-arith -O2 -m64 -march=corei7 -mtune=corei7 \n```\n\nMPIR was built with\n\n```\n-O2 -m64 -march=corei7 -mtune=corei7\n```\n\nSo, SAGE_FAT_BINARY indeed doesn't work as it should.",
    "created_at": "2012-05-17T13:42:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146842",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Can you disassemble to see which instruction failed?

This MPFR binary was built with

```
-Wall -Wmissing-prototypes -Wpointer-arith -O2 -m64 -march=corei7 -mtune=corei7 
```

MPIR was built with

```
-O2 -m64 -march=corei7 -mtune=corei7
```

So, SAGE_FAT_BINARY indeed doesn't work as it should.



---

archive/issue_comments_146843.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\n> Can you disassemble to see which instruction failed?\n> \n\nIf you tell me how to do that (explicit commands) I have the offending binary on the right CPU and could at least get you a dump of the info that came out.",
    "created_at": "2012-05-17T13:54:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146843",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:4" align="right">comment:4</div>

> Can you disassemble to see which instruction failed?
> 

If you tell me how to do that (explicit commands) I have the offending binary on the right CPU and could at least get you a dump of the info that came out.



---

archive/issue_events_177487.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-17T16:24:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177487"
}
```



---

archive/issue_events_177488.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-17T16:24:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177488"
}
```



---

archive/issue_events_177489.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2012-05-17T16:24:09Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177489"
}
```



---

archive/issue_events_177490.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-17T16:24:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177490"
}
```



---

archive/issue_events_177491.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-17T16:24:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177491"
}
```



---

archive/issue_comments_146844.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThe problem is with MPIR (as MPFR simply uses MPIR's flags).  The current MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.",
    "created_at": "2012-05-17T18:31:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146844",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

The problem is with MPIR (as MPFR simply uses MPIR's flags).  The current MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.



---

archive/issue_comments_146845.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -11,7 +11,3 @@\n Previous frame inner to this frame (gdb could not unwind past this frame) \n ```\n Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n-\n-\n-\n-\n``````\n",
    "created_at": "2012-05-17T18:31:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146845",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -11,7 +11,3 @@
 Previous frame inner to this frame (gdb could not unwind past this frame) 
 ```
 Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion
-
-
-
-
``````




---

archive/issue_events_177492.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-17T18:31:05Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "title_is": "Make MPIR support SAGE_FAT_BINARY on all systems",
    "title_was": "MPFR illegal instruction in OSX binaries",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177492"
}
```



---

archive/issue_comments_146846.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,13 +1,3 @@\n-The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors. Newer CPUs are fine, most likely too aggressive CFLAGS (are we correctly dialing them down if SAGE_FAT_BINARY is set?)\n+The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.\n \n-```\n-sage: int(2.75) \n-Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand. \n-0x0000000101723ed9 in case1 () \n-(gdb) bt \n-#0  0x0000000101723ed9 in case1 () \n-#1  0x0000000103e8bba4 in parsed_string_to_mpfr () \n-#2  0x0000000103e8c7fb in mpfr_strtofr () \n-Previous frame inner to this frame (gdb could not unwind past this frame) \n-```\n Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n``````\n",
    "created_at": "2012-05-17T18:33:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146846",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,13 +1,3 @@
-The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors. Newer CPUs are fine, most likely too aggressive CFLAGS (are we correctly dialing them down if SAGE_FAT_BINARY is set?)
+The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.
 
-```
-sage: int(2.75) 
-Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand. 
-0x0000000101723ed9 in case1 () 
-(gdb) bt 
-#0  0x0000000101723ed9 in case1 () 
-#1  0x0000000103e8bba4 in parsed_string_to_mpfr () 
-#2  0x0000000103e8c7fb in mpfr_strtofr () 
-Previous frame inner to this frame (gdb could not unwind past this frame) 
-```
 Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion
``````




---

archive/issue_comments_146847.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2012-05-17T21:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146847",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_146848.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.\n \n Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n+\n+Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n+\n+### mpir-2.4.0.p4 (Jeroen Demeyer, 17 May 2012)\n+* Trac #12954: honor SAGE_FAT_BINARY on all systems.\n+* Disable SAGE_FAT_BINARY when bootstrapping GCC.\n+\n``````\n",
    "created_at": "2012-05-17T21:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146848",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,10 @@
 The OSX binary sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg dies in MPFR on Core 2 Duo processors.  This is because the MPIR spkg only checks `SAGE_FAT_BINARY` on Linux systems.
 
 Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion
+
+Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)
+
+### mpir-2.4.0.p4 (Jeroen Demeyer, 17 May 2012)
+* Trac #12954: honor SAGE_FAT_BINARY on all systems.
+* Disable SAGE_FAT_BINARY when bootstrapping GCC.
+
``````




---

archive/issue_comments_146849.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,7 +4,12 @@\n \n Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n \n-### mpir-2.4.0.p4 (Jeroen Demeyer, 17 May 2012)\n+### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)\n * Trac #12954: honor SAGE_FAT_BINARY on all systems.\n * Disable SAGE_FAT_BINARY when bootstrapping GCC.\n-\n+* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.\n+* Add configure options directly to MPIR_CONFIGURE, no longer use\n+  SAGE_CONF_OPTS for this.\n+* On architectures which do not support --enable-fat, simply remove\n+  -march= and -mcpu flags.\n+* Remove $default_cflags, as those weren't really used anyway.\n``````\n",
    "created_at": "2012-05-18T11:14:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146849",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,7 +4,12 @@
 
 Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)
 
-### mpir-2.4.0.p4 (Jeroen Demeyer, 17 May 2012)
+### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)
 * Trac #12954: honor SAGE_FAT_BINARY on all systems.
 * Disable SAGE_FAT_BINARY when bootstrapping GCC.
-
+* Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.
+* Add configure options directly to MPIR_CONFIGURE, no longer use
+  SAGE_CONF_OPTS for this.
+* On architectures which do not support --enable-fat, simply remove
+  -march= and -mcpu flags.
+* Remove $default_cflags, as those weren't really used anyway.
``````




---

archive/issue_events_177493.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-18T12:26:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "milestone_number": null,
    "milestone_title": "sage-5.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177493"
}
```



---

archive/issue_events_177494.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-18T12:26:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "milestone_number": null,
    "milestone_title": "sage-5.0.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177494"
}
```



---

archive/issue_events_177495.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-18T12:26:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177495"
}
```



---

archive/issue_comments_146850.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,14 +2,17 @@\n \n Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion\n \n-Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n \n ### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)\n-* Trac #12954: honor SAGE_FAT_BINARY on all systems.\n+* Trac #12954: when SAGE_FAT_BINARY=yes is specified on a system which\n+  doesn't support --enable-fat, instead build for a generic CPU by\n+  removing all -march= and -mpcu= CFLAGS.\n * Disable SAGE_FAT_BINARY when bootstrapping GCC.\n * Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.\n * Add configure options directly to MPIR_CONFIGURE, no longer use\n   SAGE_CONF_OPTS for this.\n-* On architectures which do not support --enable-fat, simply remove\n-  -march= and -mcpu flags.\n-* Remove $default_cflags, as those weren't really used anyway.\n+* When user specifies CFLAGS, append them to MPIR's flags instead of\n+  completely replacing MPIR's flags.\n+* Remove $default_cflags and get_processor_specific_cflags().\n+\n``````\n",
    "created_at": "2012-05-18T12:26:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146850",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,14 +2,17 @@
 
 Reported on https://groups.google.com/d/topic/sage-support/IfJCisKo7Ao/discussion
 
-Very preliminary spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)
+**spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)
 
 ### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)
-* Trac #12954: honor SAGE_FAT_BINARY on all systems.
+* Trac #12954: when SAGE_FAT_BINARY=yes is specified on a system which
+  doesn't support --enable-fat, instead build for a generic CPU by
+  removing all -march= and -mpcu= CFLAGS.
 * Disable SAGE_FAT_BINARY when bootstrapping GCC.
 * Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.
 * Add configure options directly to MPIR_CONFIGURE, no longer use
   SAGE_CONF_OPTS for this.
-* On architectures which do not support --enable-fat, simply remove
-  -march= and -mcpu flags.
-* Remove $default_cflags, as those weren't really used anyway.
+* When user specifies CFLAGS, append them to MPIR's flags instead of
+  completely replacing MPIR's flags.
+* Remove $default_cflags and get_processor_specific_cflags().
+
``````




---

archive/issue_comments_146851.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\n`SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n\nSAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n\nI think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.",
    "created_at": "2012-05-18T14:15:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146851",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">comment:11</div>

`SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:

SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"

I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.



---

archive/issue_comments_146852.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@vbraun](#comment%3A11):\n> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n> \n> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n> \n> I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.\n\nMPIR actually does support \"fat binaries\" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.",
    "created_at": "2012-05-18T14:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146852",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@vbraun](#comment%3A11):
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"
> 
> I think right now you don't remove advanced `CFLAGS` on linux platfroms if `SAGE_FAT_BINARY` is set.

MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.



---

archive/issue_comments_146853.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.",
    "created_at": "2012-05-18T22:14:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146853",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:13" align="right">comment:13</div>

I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
 on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.



---

archive/issue_comments_146854.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@dimpase](#comment%3A13):\n> I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n>  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.\n\nI would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?",
    "created_at": "2012-05-18T22:30:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146854",
    "user": "https://github.com/mwhansen"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@dimpase](#comment%3A13):
> I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
>  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.

I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?



---

archive/issue_comments_146855.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@mwhansen](#comment%3A14):\n> Replying to [@dimpase](#comment%3A13):\n> > I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release\n> >  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.\n\n> \n> I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?\n\nit's a good point. Well, I don't have newer hardware to test this.",
    "created_at": "2012-05-18T22:33:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146855",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@mwhansen](#comment%3A14):
> Replying to [@dimpase](#comment%3A13):
> > I can confirm that installing this spkg into the sage-5.0-OSX-64bit-10.6-x86_64-Darwin.dmg binary release
> >  on Core 2 Duo (OSX 10.6.8) fixes the problem, apparently. I'll run more tests, just in case.

> 
> I would think that any spkg installed (i.e., built from source on the machine it's running on) would work.  Isn't the issue when it's built on another machine (with newer processor) and then the resulting binary used on an older machine?

it's a good point. Well, I don't have newer hardware to test this.



---

archive/issue_comments_146856.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jdemeyer](#comment%3A12):\n> MPIR actually does support \"fat binaries\" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.\n\nWhy do we have to set CFLAGS at all, then?\n\nAlso, is this really true? With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?",
    "created_at": "2012-05-18T22:49:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146856",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jdemeyer](#comment%3A12):
> MPIR actually does support "fat binaries" in the true sense on x86 systems: building a library with code for different processors, determining at run-time which one to use.

Why do we have to set CFLAGS at all, then?

Also, is this really true? With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?



---

archive/issue_comments_146857.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment%3A16):\n> With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?\n\nThe surrounding library code is compiled with basic CFLAGS, without setting `-march` at all.  But the critical routines are compiled several times for various processors.",
    "created_at": "2012-05-19T08:19:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146857",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment%3A16):
> With all CFLAGS turned on won't the compiler potentially emit advanced instructions in the surrounding library code, outside of the time-critical algorithms?

The surrounding library code is compiled with basic CFLAGS, without setting `-march` at all.  But the critical routines are compiled several times for various processors.



---

archive/issue_comments_146858.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,3 +16,4 @@\n   completely replacing MPIR's flags.\n * Remove $default_cflags and get_processor_specific_cflags().\n \n+**Binaries for testing**: [http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/](http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/)\n``````\n",
    "created_at": "2012-05-19T08:22:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146858",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,3 +16,4 @@
   completely replacing MPIR's flags.
 * Remove $default_cflags and get_processor_specific_cflags().
 
+**Binaries for testing**: [http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/](http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/)
``````




---

archive/issue_comments_146859.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nIf you want",
    "created_at": "2012-05-19T08:22:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146859",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

If you want



---

archive/issue_comments_146860.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI tried the (non-app) binary from 5.0.1.rc0 on on Core 2 Duo (OSX 10.6.8), and got the usual crash:\n\n```\n\nsage: int(2.75)\n\n------------------------------------------------------------------------\nUnhandled SIGILL: An illegal instruction occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n/Users/dima/Desktop/sage/spkg/bin/sage: line 312: 63629 Illegal instruction     sage-ipython \"$@\" -i\n\n```\n\nwith ./sage -gdb, I get \n\n```\nsage: int(2.75)\n\nProgram received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.\n0x00000001016e3ed9 in case1 ()\n(gdb) bt\n#0  0x00000001016e3ed9 in case1 ()\n#1  0x0000000103e6dba4 in parsed_string_to_mpfr ()\n#2  0x0000000103e6e7fb in mpfr_strtofr ()\nPrevious frame inner to this frame (gdb could not unwind past this frame)\n(gdb) \n```",
    "created_at": "2012-05-19T12:17:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146860",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">comment:19</div>

I tried the (non-app) binary from 5.0.1.rc0 on on Core 2 Duo (OSX 10.6.8), and got the usual crash:

```

sage: int(2.75)

------------------------------------------------------------------------
Unhandled SIGILL: An illegal instruction occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
/Users/dima/Desktop/sage/spkg/bin/sage: line 312: 63629 Illegal instruction     sage-ipython "$@" -i

```

with ./sage -gdb, I get 

```
sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) bt
#0  0x00000001016e3ed9 in case1 ()
#1  0x0000000103e6dba4 in parsed_string_to_mpfr ()
#2  0x0000000103e6e7fb in mpfr_strtofr ()
Previous frame inner to this frame (gdb could not unwind past this frame)
(gdb) 
```



---

archive/issue_events_177496.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-05-19T12:17:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177496"
}
```



---

archive/issue_events_177497.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2012-05-19T12:17:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177497"
}
```



---

archive/issue_comments_146861.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nCan you send the output of\n\n```\n(gdb) disas\n```\nwhen getting a `SIGILL`?",
    "created_at": "2012-05-19T13:35:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146861",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Can you send the output of

```
(gdb) disas
```
when getting a `SIGILL`?



---

archive/issue_comments_146862.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@jdemeyer](#comment%3A20):\n> Can you send the output of\n> \n> ```\n> (gdb) disas\n> ```\n> when getting a `SIGILL`?\n\n\n```\n\nsage: int(2.75)\n\nProgram received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.\n0x00000001016e3ed9 in case1 ()\n(gdb) disas\nDump of assembler code for function case1:\n0x00000001016e3ed9 <case1+0>:\tpopcnt 0x20(%rdi),%r8\n0x00000001016e3edf <case1+6>:\tadd    %r8,%rax\nEnd of assembler dump.\n(gdb) \n```",
    "created_at": "2012-05-19T13:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146862",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@jdemeyer](#comment%3A20):
> Can you send the output of
> 
> ```
> (gdb) disas
> ```
> when getting a `SIGILL`?


```

sage: int(2.75)

Program received signal EXC_BAD_INSTRUCTION, Illegal instruction/operand.
0x00000001016e3ed9 in case1 ()
(gdb) disas
Dump of assembler code for function case1:
0x00000001016e3ed9 <case1+0>:	popcnt 0x20(%rdi),%r8
0x00000001016e3edf <case1+6>:	add    %r8,%rax
End of assembler dump.
(gdb) 
```



---

archive/issue_comments_146863.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\npopcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do \n\n```\n[~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt\n   45200:\tf3 4c 0f b8 04 cf    \tpopcnt (%rdi,%rcx,8),%r8\n   45206:\tf3 4c 0f b8 4c cf 08 \tpopcnt 0x8(%rdi,%rcx,8),%r9\n[...]\n```\nand I believe the equivalent command on OSX would be `otool -tV`. Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?",
    "created_at": "2012-05-19T22:59:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146863",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:22" align="right">comment:22</div>

popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 

```
[~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
   45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
   45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
[...]
```
and I believe the equivalent command on OSX would be `otool -tV`. Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?



---

archive/issue_comments_146864.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@vbraun](#comment%3A22):\n> popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do \n> \n> ```\n> [~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt\n>    45200:\tf3 4c 0f b8 04 cf    \tpopcnt (%rdi,%rcx,8),%r8\n>    45206:\tf3 4c 0f b8 4c cf 08 \tpopcnt 0x8(%rdi,%rcx,8),%r9\n> [...]\n> ```\n> and I believe the equivalent command on OSX would be `otool -tV`. \n\nyes, that's right (except it's not .so, but .dylb)\n\n```\n$ otool -tV local/lib/libmpir.dylib | grep popcnt\n000000000003be60\tpopcnt\t(%rdi,%rcx,8),%r8\n000000000003be66\tpopcnt\t0x08(%rdi,%rcx,8),%r9\n```\n\n> Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?\n\nhow would it help?\nThe problem seems to be in the inability of non-Apple gcc to build fat, a.k.a. universal, dynamic libs and executables. So I think we should either resort to making binary releases for OSX targeted to a particular architecture, or provide some post-install script that basically would do ./sage -f mpir (and anything else that needs similar fix) followed by ./sage -b. It's time-consuming to run, but it needs to be done only once...",
    "created_at": "2012-05-19T23:13:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146864",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@vbraun](#comment%3A22):
> popcnt is SSE4.2, so Core 2 Duo don't have it. Btw on Linux I can do 
> 
> ```
> [~]$ objdump -d sage/local/lib/libmpir.so | grep popcnt
>    45200:	f3 4c 0f b8 04 cf    	popcnt (%rdi,%rcx,8),%r8
>    45206:	f3 4c 0f b8 4c cf 08 	popcnt 0x8(%rdi,%rcx,8),%r9
> [...]
> ```
> and I believe the equivalent command on OSX would be `otool -tV`. 

yes, that's right (except it's not .so, but .dylb)

```
$ otool -tV local/lib/libmpir.dylib | grep popcnt
000000000003be60	popcnt	(%rdi,%rcx,8),%r8
000000000003be66	popcnt	0x08(%rdi,%rcx,8),%r9
```

> Shouldn't we add some script to `sage -bdist` that checks for the absence of, say, SSE >= 4 instructions?

how would it help?
The problem seems to be in the inability of non-Apple gcc to build fat, a.k.a. universal, dynamic libs and executables. So I think we should either resort to making binary releases for OSX targeted to a particular architecture, or provide some post-install script that basically would do ./sage -f mpir (and anything else that needs similar fix) followed by ./sage -b. It's time-consuming to run, but it needs to be done only once...



---

archive/issue_comments_146865.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@dimpase](#comment%3A23):\n> how would it help?\n\nIt would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.",
    "created_at": "2012-05-19T23:22:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146865",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@dimpase](#comment%3A23):
> how would it help?

It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.



---

archive/issue_comments_146866.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@vbraun](#comment%3A24):\n> Replying to [@dimpase](#comment%3A23):\n> > how would it help?\n\n> \n> It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.\n\nwell, we certainly should ship such binaries, it's more about the proper labeling of them as such...",
    "created_at": "2012-05-19T23:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146866",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@vbraun](#comment%3A24):
> Replying to [@dimpase](#comment%3A23):
> > how would it help?

> 
> It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.

well, we certainly should ship such binaries, it's more about the proper labeling of them as such...



---

archive/issue_comments_146867.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@vbraun](#comment%3A11):\n> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:\n> \n> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to \"yes\"\n\nThat description is certainly insufficient (or, to be more precise, one shouldn't read it from right to left).  One should in general not prepare \"fat\" binaries on relatively new (e.g. Core i7) CPUs -- unless one knows what one's doing... ;-)\n\nIMHO the main purpose of `SAGE_FAT_BINARY` is to avoid the use of processor-specific (\"hand-written\") *assembly code* (and prevent Sage from using things like `-march=native`); it's still up to the *distributor* to make sure the compiler is targeted to the *desired* CPU family (whichever that is).\n\n\n\n\nDoing some \"sanity check\" upon `sage -bdist` isn't all bad, but of course heavily depends on what (limited) architecture a specific binary distribution is supposed to be run on.\n\n\n---\n\nI never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.",
    "created_at": "2012-05-23T15:23:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146867",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@vbraun](#comment%3A11):
> `SAGE_FAT_BINARY` should be synonymous with `SAGE_GENERIC_BINARY`, though for historical reasons it isn't named well. From http://www.sagemath.org/doc/installation/source.html:
> 
> SAGE_FAT_BINARY - to prepare a binary distribution that will run on the widest range of target machines, set this variable to "yes"

That description is certainly insufficient (or, to be more precise, one shouldn't read it from right to left).  One should in general not prepare "fat" binaries on relatively new (e.g. Core i7) CPUs -- unless one knows what one's doing... ;-)

IMHO the main purpose of `SAGE_FAT_BINARY` is to avoid the use of processor-specific ("hand-written") *assembly code* (and prevent Sage from using things like `-march=native`); it's still up to the *distributor* to make sure the compiler is targeted to the *desired* CPU family (whichever that is).




Doing some "sanity check" upon `sage -bdist` isn't all bad, but of course heavily depends on what (limited) architecture a specific binary distribution is supposed to be run on.


---

I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.



---

archive/issue_events_177498.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-27T06:08:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177498"
}
```



---

archive/issue_events_177499.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-27T06:08:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177499"
}
```



---

archive/issue_comments_146868.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,10 +4,11 @@\n \n **spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)\n \n-### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)\n-* Trac #12954: when SAGE_FAT_BINARY=yes is specified on a system which\n-  doesn't support --enable-fat, instead build for a generic CPU by\n-  removing all -march= and -mpcu= CFLAGS.\n+### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)\n+* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support\n+  --enable-fat, compile a generic binary (not assuming any particular\n+  CPU) by passing the output of configfsf.guess to the --build option\n+  of ./configure.\n * Disable SAGE_FAT_BINARY when bootstrapping GCC.\n * Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.\n * Add configure options directly to MPIR_CONFIGURE, no longer use\n@@ -15,5 +16,3 @@\n * When user specifies CFLAGS, append them to MPIR's flags instead of\n   completely replacing MPIR's flags.\n * Remove $default_cflags and get_processor_specific_cflags().\n-\n-**Binaries for testing**: [http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/](http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/)\n``````\n",
    "created_at": "2012-05-27T06:08:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146868",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,10 +4,11 @@
 
 **spkg**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpir-2.4.0.p4.spkg)
 
-### mpir-2.4.0.p4 (Jeroen Demeyer, 18 May 2012)
-* Trac #12954: when SAGE_FAT_BINARY=yes is specified on a system which
-  doesn't support --enable-fat, instead build for a generic CPU by
-  removing all -march= and -mpcu= CFLAGS.
+### mpir-2.4.0.p4 (Jeroen Demeyer, 26 May 2012)
+* Trac #12954: when SAGE_FAT_BINARY=yes on systems which don't support
+  --enable-fat, compile a generic binary (not assuming any particular
+  CPU) by passing the output of configfsf.guess to the --build option
+  of ./configure.
 * Disable SAGE_FAT_BINARY when bootstrapping GCC.
 * Rename MPIR_EXTRA_OPTS to MPIR_CONFIGURE.
 * Add configure options directly to MPIR_CONFIGURE, no longer use
@@ -15,5 +16,3 @@
 * When user specifies CFLAGS, append them to MPIR's flags instead of
   completely replacing MPIR's flags.
 * Remove $default_cflags and get_processor_specific_cflags().
-
-**Binaries for testing**: [http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/](http://boxen.math.washington.edu/home/buildbot/binaries/sage/5.0.1.rc0/)
``````




---

archive/issue_comments_146869.json:
```json
{
    "body": "Changed keywords from none to **sd40.5**",
    "created_at": "2012-05-27T06:11:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146869",
    "user": "https://github.com/jdemeyer"
}
```

Changed keywords from none to **sd40.5**



---

archive/issue_comments_146870.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@dimpase](#comment%3A25):\n> Replying to [@vbraun](#comment%3A24):\n> > Replying to [@dimpase](#comment%3A23):\n> > > how would it help?\n\n> > \n> > It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.\n\n> \n> well, we certainly should ship such binaries\n\nI don't think we should ship such binaries, otherwise you're just going to confuse people.",
    "created_at": "2012-05-27T06:20:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146870",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@dimpase](#comment%3A25):
> Replying to [@vbraun](#comment%3A24):
> > Replying to [@dimpase](#comment%3A23):
> > > how would it help?

> > 
> > It would help to ensure that we don't accidentally ship binaries that require advanced instruction set extensions. Thats all I meant.

> 
> well, we certainly should ship such binaries

I don't think we should ship such binaries, otherwise you're just going to confuse people.



---

archive/issue_comments_146871.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nNew spkg should be ready for review, changes have not yet been committed.",
    "created_at": "2012-05-27T06:22:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146871",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

New spkg should be ready for review, changes have not yet been committed.



---

archive/issue_comments_146872.json:
```json
{
    "body": "Attachment: **[mpir-2.4.0.p4.diff.gz](https://github.com/sagemath/sage/files/ticket12954/mpir-2.4.0.p4.diff.gz)**\n\nDiff between the 2.4.0.p3 and 2.4.0.p4 spkgs. For reference / review only.",
    "created_at": "2012-05-27T06:23:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146872",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[mpir-2.4.0.p4.diff.gz](https://github.com/sagemath/sage/files/ticket12954/mpir-2.4.0.p4.diff.gz)**

Diff between the 2.4.0.p3 and 2.4.0.p4 spkgs. For reference / review only.



---

archive/issue_comments_146873.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@nexttime](#comment%3A26):\n> I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.\n\nSo let's change it to `{PKG}_CONFIGURE`.  Some of these packages (mpfr, ecm, pari) need to be changed anyway.",
    "created_at": "2012-05-27T06:53:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146873",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@nexttime](#comment%3A26):
> I never liked `MPIR_EXTRA_OPTS` (for additional options to be passed to MPIR's `configure`), but it's named like this for consistency with other spkgs, i.e., historical reasons.  A couple of spkgs (or every spkg that supports such) use `${PKG_NAME}_EXTRA_OPTS`.

So let's change it to `{PKG}_CONFIGURE`.  Some of these packages (mpfr, ecm, pari) need to be changed anyway.



---

archive/issue_events_177500.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-05-27T16:59:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177500"
}
```



---

archive/issue_events_177501.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2012-05-27T16:59:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177501"
}
```



---

archive/issue_comments_146874.json:
```json
{
    "body": "Reviewer: **William Stein**",
    "created_at": "2012-05-27T16:59:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146874",
    "user": "https://github.com/williamstein"
}
```

Reviewer: **William Stein**



---

archive/issue_comments_146875.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI read through your patch twice, tried building with SAGE_FAT_BINARY=\"yes\", and this all looks great to me.  Of course, the real test is the buildbot and whether or not this really solves people's problems.   So for now I give this a positive review.",
    "created_at": "2012-05-27T16:59:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146875",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:32" align="right">comment:32</div>

I read through your patch twice, tried building with SAGE_FAT_BINARY="yes", and this all looks great to me.  Of course, the real test is the buildbot and whether or not this really solves people's problems.   So for now I give this a positive review.



---

archive/issue_comments_146876.json:
```json
{
    "body": "Changed reviewer from **William Stein** to **William Stein, Karl-Dieter Crisman**",
    "created_at": "2012-05-28T22:47:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146876",
    "user": "https://github.com/kcrisman"
}
```

Changed reviewer from **William Stein** to **William Stein, Karl-Dieter Crisman**



---

archive/issue_comments_146877.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI can confirm that this seems to work on an Intel Core 2 Duo which previously could not use the buildbot's binary.",
    "created_at": "2012-05-28T22:47:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146877",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:33" align="right">comment:33</div>

I can confirm that this seems to work on an Intel Core 2 Duo which previously could not use the buildbot's binary.



---

archive/issue_events_177502.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-28T22:59:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177502"
}
```



---

archive/issue_events_177503.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-05-28T22:59:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12954#event-177503"
}
```



---

archive/issue_comments_146878.json:
```json
{
    "body": "Merged: **sage-5.0.1**",
    "created_at": "2012-05-28T22:59:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146878",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.0.1**



---

archive/issue_comments_146879.json:
```json
{
    "body": "Changed merged from **sage-5.0.1** to **sage-5.0.1.rc0**",
    "created_at": "2012-05-28T23:03:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146879",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-5.0.1** to **sage-5.0.1.rc0**



---

archive/issue_comments_146880.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nJust for reference, this also appears to have solved a similar issue on older PPC Macs using binaries built on (still old, but not *as* old) less old PPC Macs which was new with 5.0.  Good work.",
    "created_at": "2012-05-31T21:10:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12954",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12954#issuecomment-146880",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:36" align="right">comment:36</div>

Just for reference, this also appears to have solved a similar issue on older PPC Macs using binaries built on (still old, but not *as* old) less old PPC Macs which was new with 5.0.  Good work.
