# Issue 12479: Clean up sage-spkg

archive/issues_012307.json:
```json
{
    "body": "This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.\n\nMostly, this patch reorganizes things.  Some diagnostics are added, for example a warning when `spkg-install` or `spkg-check` isn't executable.  Also, the line\n\n```\nTEST SUITE: not available\n```\nbeing printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.\n\nFollow-ups:\n1. #12579: allow selective `SAGE_CHECK`\n2. #12602: rework downloading/extracting of .spkg files\n3. #12606: Fix sage --info <package>\n4. #12613: Add '-c' option so `sage -i -c <pkg>` installs the package and runs its test suite.\n\nDepends on #4949\n\nDepends on #10192\n\n**Assignee:** GeorgSWeber\n\n**Reviewer:** John Palmieri\n\n**Author:** Jeroen Demeyer\n\n**Merged:** sage-5.0.beta7\n\nIssue created by migration from https://trac.sagemath.org/ticket/12479\n\n",
    "closed_at": "2012-03-04T21:17:30Z",
    "created_at": "2012-02-09T10:07:22Z",
    "labels": [
        "component: build",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.0",
    "title": "Clean up sage-spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/12479",
    "user": "https://github.com/jdemeyer"
}
```
This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.

Mostly, this patch reorganizes things.  Some diagnostics are added, for example a warning when `spkg-install` or `spkg-check` isn't executable.  Also, the line

```
TEST SUITE: not available
```
being printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.

Follow-ups:
1. #12579: allow selective `SAGE_CHECK`
2. #12602: rework downloading/extracting of .spkg files
3. #12606: Fix sage --info <package>
4. #12613: Add '-c' option so `sage -i -c <pkg>` installs the package and runs its test suite.

Depends on #4949

Depends on #10192

**Assignee:** GeorgSWeber

**Reviewer:** John Palmieri

**Author:** Jeroen Demeyer

**Merged:** sage-5.0.beta7

Issue created by migration from https://trac.sagemath.org/ticket/12479





---

archive/issue_comments_140028.json:
```json
{
    "body": "<a id='comment:1'></a>\nSee also #11021.",
    "created_at": "2012-02-09T16:21:05Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140028",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
See also #11021.



---

archive/issue_comments_140029.json:
```json
{
    "body": "<a id='comment:2'></a>\nThanks for the link.  I think that ticket is now too bitrotted.  We should consider the ideas from that ticket and apply them (better in separate tickets instead of one \"fix everything\" ticket).",
    "created_at": "2012-02-14T09:25:53Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140029",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Thanks for the link.  I think that ticket is now too bitrotted.  We should consider the ideas from that ticket and apply them (better in separate tickets instead of one "fix everything" ticket).



---

archive/issue_comments_140030.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.\n``````\n",
    "created_at": "2012-02-14T09:25:53Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140030",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.
``````




---

archive/issue_comments_140031.json:
```json
{
    "body": "**Dependencies:** #4949",
    "created_at": "2012-02-14T09:29:24Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140031",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #4949



---

archive/issue_comments_140032.json:
```json
{
    "body": "**Changing dependencies** from \"#4949\" to \"#4949, #10192\".",
    "created_at": "2012-02-25T21:59:46Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140032",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#4949" to "#4949, #10192".



---

archive/issue_comments_140033.json:
```json
{
    "body": "<a id='comment:5'></a>\nWhat is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead? For example:\n\n```\n        echo >&2 \"No file SAGE.txt in $PKG_NAME\"\n```\n\nBy the way, #12579 also modifies sage-spkg; you might take a look at that ticket if you have time.\n\nWhat do you think of replacing `./spkg-check` with `time ./spkg-check`?",
    "created_at": "2012-02-25T22:50:08Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140033",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
What is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead? For example:

```
        echo >&2 "No file SAGE.txt in $PKG_NAME"
```

By the way, #12579 also modifies sage-spkg; you might take a look at that ticket if you have time.

What do you think of replacing `./spkg-check` with `time ./spkg-check`?



---

archive/issue_comments_140034.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jhpalmieri](#comment%3A5):\n> What is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead?\n\nOf course, but I don't want to mistake of #11021: fixing too many things on one ticket.  On this ticket, I essentially just want to clean things up, with little or none functional difference.\n\n> What do you think of replacing `./spkg-check` with `time ./spkg-check`?\n",
    "created_at": "2012-02-26T09:04:45Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140034",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Replying to [jhpalmieri](#comment%3A5):
> What is the file `SAGE.txt` referred to in this script? Should it be `SPKG.txt` instead?

Of course, but I don't want to mistake of #11021: fixing too many things on one ticket.  On this ticket, I essentially just want to clean things up, with little or none functional difference.

> What do you think of replacing `./spkg-check` with `time ./spkg-check`?




---

archive/issue_comments_140035.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jhpalmieri](#comment%3A5):\n> What do you think of replacing `./spkg-check` with `time ./spkg-check`?\n\nDone.",
    "created_at": "2012-02-26T22:37:07Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140035",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
Replying to [jhpalmieri](#comment%3A5):
> What do you think of replacing `./spkg-check` with `time ./spkg-check`?

Done.



---

archive/issue_comments_140036.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,8 @@\n This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.\n+\n+Mostly, this patch reorganizes things.  Some diagnostics are added, for example a warning when `spkg-install` or `spkg-check` isn't executable.  Also, the line\n+\n+```\n+TEST SUITE: not available\n+```\n+being printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.\n``````\n",
    "created_at": "2012-02-27T13:35:44Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140036",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,8 @@
 This ticket aims to do a simply clean-up of `sage-spkg` and nothing more.  The goal is to provide a solid base for future enhancements to `sage-spkg`, not fix all issues regarding `sage-spkg`.
+
+Mostly, this patch reorganizes things.  Some diagnostics are added, for example a warning when `spkg-install` or `spkg-check` isn't executable.  Also, the line
+
+```
+TEST SUITE: not available
+```
+being printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.
``````




---

archive/issue_comments_140037.json:
```json
{
    "body": "<a id='comment:9'></a>\nJohn, could you please review this?",
    "created_at": "2012-02-27T15:01:22Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140037",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
John, could you please review this?



---

archive/issue_events_102728.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-27T15:01:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102728"
}
```



---

archive/issue_comments_140038.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,3 +6,7 @@\n TEST SUITE: not available\n ```\n being printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.\n+\n+Follow-ups:\n+1. #12579: allow selective `SAGE_CHECK`\n+2. #12602: rework downloading/extracting of .spkg files\n``````\n",
    "created_at": "2012-02-27T15:54:05Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140038",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,3 +6,7 @@
 TEST SUITE: not available
 ```
 being printed to `spkg/installed/$PKG_NAME` when `SAGE_CHECK=yes` but there is no `spkg-check` file.
+
+Follow-ups:
+1. #12579: allow selective `SAGE_CHECK`
+2. #12602: rework downloading/extracting of .spkg files
``````




---

archive/issue_comments_140039.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.\n\nI will look at this more later.",
    "created_at": "2012-02-27T23:51:46Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140039",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.

I will look at this more later.



---

archive/issue_comments_140040.json:
```json
{
    "body": "<a id='comment:12'></a>\nMy previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.\n\nFor \"Authors\", perhaps you could add something like:\n\n```\n - William Stein and others (Sage 4.8 and earlier)\n```\nafter your name.\n\nThe header might also include documentation about the options -f, -s, -info.  Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?  If we want to keep it, then consider lines 209-213:\n\n```\n    echo \"\"\n    if [ $? -ne 0 ]; then\n        echo >&2 \"No file SPKG.txt in $PKG_NAME\"\n        exit 1\n    fi\n```\nWon't the test `if [ $? -ne 0]; then` reflect the exit status of the `echo` command?  I think that the `echo` line should be deleted and the test moved inside the previous if block, so it's connected to the tar command.  Or something like that.",
    "created_at": "2012-02-28T03:46:04Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140040",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>
My previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.

For "Authors", perhaps you could add something like:

```
 - William Stein and others (Sage 4.8 and earlier)
```
after your name.

The header might also include documentation about the options -f, -s, -info.  Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?  If we want to keep it, then consider lines 209-213:

```
    echo ""
    if [ $? -ne 0 ]; then
        echo >&2 "No file SPKG.txt in $PKG_NAME"
        exit 1
    fi
```
Won't the test `if [ $? -ne 0]; then` reflect the exit status of the `echo` command?  I think that the `echo` line should be deleted and the test moved inside the previous if block, so it's connected to the tar command.  Or something like that.



---

archive/issue_comments_140041.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,3 +10,4 @@\n Follow-ups:\n 1. #12579: allow selective `SAGE_CHECK`\n 2. #12602: rework downloading/extracting of .spkg files\n+3. #12606: Fix sage --info <package>\n``````\n",
    "created_at": "2012-02-28T07:45:24Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140041",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,3 +10,4 @@
 Follow-ups:
 1. #12579: allow selective `SAGE_CHECK`
 2. #12602: rework downloading/extracting of .spkg files
+3. #12606: Fix sage --info <package>
``````




---

archive/issue_events_102729.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T07:50:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102729"
}
```



---

archive/issue_events_102730.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T07:50:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102730"
}
```



---

archive/issue_comments_140042.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jhpalmieri](#comment%3A12):\n> My previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.\n> \n> For \"Authors\", perhaps you could add something like:\n> \n> ```\n>  - William Stein and others (Sage 4.8 and earlier)\n> ```\n> after your name.\n\nI changed this to\n\n```\n# AUTHORS:\n#\n# - Jeroen Demeyer (2012-02-27): #12479: big reorganization.\n#\n# - Volker Braun, Jeroen Demeyer (2012-01-18): #11073: remove the\n#   spkg/base repository, move this file from local/bin/sage-spkg to\n#   spkg/bin/sage-spkg.\n#\n# - William Stein, John Palmieri and others (Sage 4.8 and earlier).\n```\nThe reason I put your name also is because it appears several times in `hg log` of the 4.8 `sage-spkg`.\n\n> Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?\n\nSee #12606.",
    "created_at": "2012-02-28T07:50:40Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140042",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [jhpalmieri](#comment%3A12):
> My previous comment about creating directories unnecessarily also applies when running `sage -i` with no arguments.
> 
> For "Authors", perhaps you could add something like:
> 
> ```
>  - William Stein and others (Sage 4.8 and earlier)
> ```
> after your name.

I changed this to

```
# AUTHORS:
#
# - Jeroen Demeyer (2012-02-27): #12479: big reorganization.
#
# - Volker Braun, Jeroen Demeyer (2012-01-18): #11073: remove the
#   spkg/base repository, move this file from local/bin/sage-spkg to
#   spkg/bin/sage-spkg.
#
# - William Stein, John Palmieri and others (Sage 4.8 and earlier).
```
The reason I put your name also is because it appears several times in `hg log` of the 4.8 `sage-spkg`.

> Actually, I don't think -info is used anywhere, nor is it accessible from the main sage script; should it be deleted altogether (here or on another ticket)?

See #12606.



---

archive/issue_comments_140043.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jhpalmieri](#comment%3A11):\n> This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.\n\nOkay, I will change this in the follow-up #12602.",
    "created_at": "2012-02-28T07:51:47Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140043",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [jhpalmieri](#comment%3A11):
> This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.

Okay, I will change this in the follow-up #12602.



---

archive/issue_comments_140044.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [jdemeyer](#comment%3A15):\n> Replying to [jhpalmieri](#comment%3A11):\n> > This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.\n\n> Okay, I will change this in the follow-up #12602.\nNever mind, I'll do it on this ticket anyway.",
    "created_at": "2012-02-28T07:54:36Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140044",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [jdemeyer](#comment%3A15):
> Replying to [jhpalmieri](#comment%3A11):
> > This is pretty minor, but if a package has been installed already, for example, then with the patch, `sage -i pkg` still creates `SAGE_BUILD_DIR`, then quits without doing anything else. It would be nicer if this directory were not created until needed.

> Okay, I will change this in the follow-up #12602.
Never mind, I'll do it on this ticket anyway.



---

archive/issue_comments_140045.json:
```json
{
    "body": "<a id='comment:17'></a>\nJohn, new patch needs review.  I also made some changes to `spkg/bin/sage` in the calls to `sage-spkg`.  I think I took care of all your comments, except for `-info` which I moved to #12606.\n\nThis version allows multiple options, so you can do something silly like\n\n```\n./sage -i -f -s -f -f -m spkg/optional/mpc-0.9.spkg\n```",
    "created_at": "2012-02-28T10:10:02Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140045",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
John, new patch needs review.  I also made some changes to `spkg/bin/sage` in the calls to `sage-spkg`.  I think I took care of all your comments, except for `-info` which I moved to #12606.

This version allows multiple options, so you can do something silly like

```
./sage -i -f -s -f -f -m spkg/optional/mpc-0.9.spkg
```



---

archive/issue_events_102731.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T10:10:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102731"
}
```



---

archive/issue_events_102732.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T10:10:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102732"
}
```



---

archive/issue_comments_140046.json:
```json
{
    "body": "<a id='comment:18'></a>\nThe patch to `spkg/bin/sage` needs work: the combination of\n\n```sh\nif [ \"$1\" = '-i' ]; then\n   shift\n   install \"$@\"   # used to be    install \" \" \"$@\"\nfi\n```\nand (in the install function)\n\n```sh\n    if [ $# -le 1 ]; then\n        exec sage-spkg\n    fi\n```\nmeans that `sage -i pkg` just lists the currently installed packages. Maybe this test should say `if [ $# -eq 0 ]`?  Maybe if after processing the flags, there are no arguments left, then you should run `exec sage-spkg`?  For example:\n\n```diff\ndiff --git a/spkg/bin/sage b/spkg/bin/sage\n--- a/spkg/bin/sage\n+++ b/spkg/bin/sage\n@@ -767,11 +767,9 @@ fi\n \n install() {\n     cd \"$SAGE_ROOT/spkg\"\n-    if [ $# -le 1 ]; then\n-        exec sage-spkg\n-    fi\n     SAGE_LOGS=\"$SAGE_ROOT/spkg/logs\"\n     mkdir -p \"$SAGE_LOGS\"\n+    no_pkg=\"yes\"\n     for PKG in \"$@\"\n     do\n         # Check for options\n@@ -784,6 +782,7 @@ install() {\n             -s) OPTS=\"-s\"\n                 continue;;\n         esac\n+        no_pkg=\"no\"\n \n         echo \"Calling sage-spkg on '$PKG'\"\n         PKG_NAME=`echo \"$PKG\" | sed -e \"s/\\.spkg$//\"`\n@@ -804,6 +803,9 @@ install() {\n         fi\n         shift\n     done\n+    if [ $no_pkg = \"yes\" ]; then\n+        exec sage-spkg\n+    fi\n     exit $?\n }\n```\nThere are probably better ways of doing this.\n\nOtherwise, I think this is looking good.\n\nThis is a possible suggestion for another ticket: have a command-line flag for spkg-install which sets `SAGE_CHECK` to be \"yes\".  That might be more convenient than setting `SAGE_CHECK=yes`, running `sage -i ...`, then unsetting `SAGE_CHECK`.",
    "created_at": "2012-02-28T21:39:03Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140046",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>
The patch to `spkg/bin/sage` needs work: the combination of

```sh
if [ "$1" = '-i' ]; then
   shift
   install "$@"   # used to be    install " " "$@"
fi
```
and (in the install function)

```sh
    if [ $# -le 1 ]; then
        exec sage-spkg
    fi
```
means that `sage -i pkg` just lists the currently installed packages. Maybe this test should say `if [ $# -eq 0 ]`?  Maybe if after processing the flags, there are no arguments left, then you should run `exec sage-spkg`?  For example:

```diff
diff --git a/spkg/bin/sage b/spkg/bin/sage
--- a/spkg/bin/sage
+++ b/spkg/bin/sage
@@ -767,11 +767,9 @@ fi
 
 install() {
     cd "$SAGE_ROOT/spkg"
-    if [ $# -le 1 ]; then
-        exec sage-spkg
-    fi
     SAGE_LOGS="$SAGE_ROOT/spkg/logs"
     mkdir -p "$SAGE_LOGS"
+    no_pkg="yes"
     for PKG in "$@"
     do
         # Check for options
@@ -784,6 +782,7 @@ install() {
             -s) OPTS="-s"
                 continue;;
         esac
+        no_pkg="no"
 
         echo "Calling sage-spkg on '$PKG'"
         PKG_NAME=`echo "$PKG" | sed -e "s/\.spkg$//"`
@@ -804,6 +803,9 @@ install() {
         fi
         shift
     done
+    if [ $no_pkg = "yes" ]; then
+        exec sage-spkg
+    fi
     exit $?
 }
```
There are probably better ways of doing this.

Otherwise, I think this is looking good.

This is a possible suggestion for another ticket: have a command-line flag for spkg-install which sets `SAGE_CHECK` to be "yes".  That might be more convenient than setting `SAGE_CHECK=yes`, running `sage -i ...`, then unsetting `SAGE_CHECK`.



---

archive/issue_events_102733.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-02-28T21:39:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102733"
}
```



---

archive/issue_events_102734.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-02-28T21:39:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102734"
}
```



---

archive/attachments_016770.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "12479_clean_sage_spkg.patch",
    "asset_url": "tarball://root/attachments/ticket12479/12479_clean_sage_spkg.patch",
    "created_at": "2012-02-28T22:28:31Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket12479/12479_clean_sage_spkg.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_140047.json:
```json
{
    "body": "Attachment [12479_clean_sage_spkg.patch](https://github.com/sagemath/sage/files/ticket12479/12479_clean_sage_spkg.patch) by @jdemeyer created at 2012-02-28 22:28:31",
    "created_at": "2012-02-28T22:28:31Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140047",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12479_clean_sage_spkg.patch](https://github.com/sagemath/sage/files/ticket12479/12479_clean_sage_spkg.patch) by @jdemeyer created at 2012-02-28 22:28:31



---

archive/issue_comments_140048.json:
```json
{
    "body": "**Reviewer:** John Palmieri",
    "created_at": "2012-02-28T22:38:07Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140048",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** John Palmieri



---

archive/issue_events_102735.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T22:38:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102735"
}
```



---

archive/issue_events_102736.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-28T22:38:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102736"
}
```



---

archive/issue_comments_140049.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2012-02-28T22:38:07Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140049",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_140050.json:
```json
{
    "body": "<a id='comment:19'></a>\nFixed, needs review.\n\nI like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.",
    "created_at": "2012-02-28T22:38:07Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140050",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Fixed, needs review.

I like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.



---

archive/issue_events_102737.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-02-29T21:43:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102737"
}
```



---

archive/issue_events_102738.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2012-02-29T21:43:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102738"
}
```



---

archive/issue_comments_140051.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -11,3 +11,4 @@\n 1. #12579: allow selective `SAGE_CHECK`\n 2. #12602: rework downloading/extracting of .spkg files\n 3. #12606: Fix sage --info <package>\n+4. #12613: Add '-c' option so `sage -i -c <pkg>` installs the package and runs its test suite.\n``````\n",
    "created_at": "2012-02-29T21:43:45Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140051",
    "user": "https://github.com/jhpalmieri"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -11,3 +11,4 @@
 1. #12579: allow selective `SAGE_CHECK`
 2. #12602: rework downloading/extracting of .spkg files
 3. #12606: Fix sage --info <package>
+4. #12613: Add '-c' option so `sage -i -c <pkg>` installs the package and runs its test suite.
``````




---

archive/issue_comments_140052.json:
```json
{
    "body": "<a id='comment:20'></a>\nOkay, this looks good.\n\n> I like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.\n\n\nSee #12613.",
    "created_at": "2012-02-29T21:43:45Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140052",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>
Okay, this looks good.

> I like your idea of a SPKG_CHECK=yes command line option, how about -c for check?  But not on this ticket.


See #12613.



---

archive/issue_comments_140053.json:
```json
{
    "body": "<a id='comment:21'></a>\nThis shouldn't have anything to do with positive review here, but aren't there a few spkgs that run tests automatically with or without `SAGE_CHECK`, and don't have spkg-check files?  I see them sometimes while waiting for Sage to build... For instance, R does this, I believe, and maybe one of the elliptic curve packages.",
    "created_at": "2012-02-29T22:03:31Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140053",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:21'></a>
This shouldn't have anything to do with positive review here, but aren't there a few spkgs that run tests automatically with or without `SAGE_CHECK`, and don't have spkg-check files?  I see them sometimes while waiting for Sage to build... For instance, R does this, I believe, and maybe one of the elliptic curve packages.



---

archive/issue_comments_140054.json:
```json
{
    "body": "<a id='comment:22'></a>\nI'm not sure. Some spkgs (like zn_poly) run a small batch of tests always, and then run much longer tests if `SAGE_CHECK` is set. Anything on this ticket or related ones won't affect tests which are run by the `spkg-install` script; these just affect whether the `spkg-check` script is run.",
    "created_at": "2012-02-29T22:37:28Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140054",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>
I'm not sure. Some spkgs (like zn_poly) run a small batch of tests always, and then run much longer tests if `SAGE_CHECK` is set. Anything on this ticket or related ones won't affect tests which are run by the `spkg-install` script; these just affect whether the `spkg-check` script is run.



---

archive/issue_comments_140055.json:
```json
{
    "body": "<a id='comment:23'></a>\nI guess I was referring to `echo \"Package $PKG_NAME has no test suite.\" `, which wouldn't strictly be true if there was a full test suite run that didn't happen to be in an spkg-check file.   Well, not so important.",
    "created_at": "2012-03-01T02:15:16Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140055",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:23'></a>
I guess I was referring to `echo "Package $PKG_NAME has no test suite." `, which wouldn't strictly be true if there was a full test suite run that didn't happen to be in an spkg-check file.   Well, not so important.



---

archive/issue_events_102739.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-04T21:17:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102739"
}
```



---

archive/issue_events_102740.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-04T21:17:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12479#event-102740"
}
```



---

archive/issue_comments_140056.json:
```json
{
    "body": "**Merged:** sage-5.0.beta7",
    "created_at": "2012-03-04T21:17:30Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140056",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.0.beta7



---

archive/issue_comments_140057.json:
```json
{
    "body": "<a id='comment:25'></a>\nI don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).  The script doesn't exit with an error, just the shell complains, i.e. the spkg apparently gets installed, I'm just not sure whether some more or less important code got skipped.\n\nAtm too tired to investigate myself... :P",
    "created_at": "2012-04-05T21:02:40Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140057",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'></a>
I don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).  The script doesn't exit with an error, just the shell complains, i.e. the spkg apparently gets installed, I'm just not sure whether some more or less important code got skipped.

Atm too tired to investigate myself... :P



---

archive/issue_comments_140058.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [leif](#comment%3A25):\n> I don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).\n\nIt must be the `spkg-install` file doing that.  With `patch` (the first spkg I tried), there are no errors:\n\n```\n$ ./sage -i patch\nCalling sage-spkg on 'patch'\npatch-2.5.9.p2\n====================================================\nExtracting package /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg\n-rw-r--r-- 1 jdemeyer jdemeyer 174221 Aug 16  2011 /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg\nFinished extraction\n****************************************************\nHost system:\nLinux boxen 2.6.24-24-server #1 SMP Fri Sep 18 16:47:05 UTC 2009 x86_64 GNU/Linux\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/home/jdemeyer/local/libexec/gcc/x86_64-unknown-linux-gnu/4.6.1/lto-wrapper\nTarget: x86_64-unknown-linux-gnu\nConfigured with: ../gcc-4.6.1/configure --prefix=/home/jdemeyer/local\nThread model: posix\ngcc version 4.6.1 (GCC)\n****************************************************\nchecking for gcc... gcc\nchecking for C compiler default output... a.out\nchecking whether the C compiler works... yes\n[...]\n```",
    "created_at": "2012-04-05T21:09:33Z",
    "issue": "https://github.com/sagemath/sage/issues/12479",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12479#issuecomment-140058",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [leif](#comment%3A25):
> I don't know to which ticket / change it exactly belongs, but I noticed that one meanwhile gets an error when using `sage -i ...` before building Sage (something at the of `sage-spkg` trying to `cd` to some not-yet-existent directory, `$SAGE_LOCAL/bin/` IIRC).

It must be the `spkg-install` file doing that.  With `patch` (the first spkg I tried), there are no errors:

```
$ ./sage -i patch
Calling sage-spkg on 'patch'
patch-2.5.9.p2
====================================================
Extracting package /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg
-rw-r--r-- 1 jdemeyer jdemeyer 174221 Aug 16  2011 /padic/scratch/jdemeyer/sage-5.0.beta12/spkg/standard/patch-2.5.9.p2.spkg
Finished extraction
****************************************************
Host system:
Linux boxen 2.6.24-24-server #1 SMP Fri Sep 18 16:47:05 UTC 2009 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/home/jdemeyer/local/libexec/gcc/x86_64-unknown-linux-gnu/4.6.1/lto-wrapper
Target: x86_64-unknown-linux-gnu
Configured with: ../gcc-4.6.1/configure --prefix=/home/jdemeyer/local
Thread model: posix
gcc version 4.6.1 (GCC)
****************************************************
checking for gcc... gcc
checking for C compiler default output... a.out
checking whether the C compiler works... yes
[...]
```
