# Issue 12215: Memleak in UniqueRepresentation, @cached_method

archive/issues_012043.json:
```json
{
    "assignees": [],
    "body": "The documentation says that UniqueRepresentation uses weak refs, but this was switched over to the `@`cached_method decorator. The latter does currently use strong references, so unused unique parents stay in memory forever:\n\n```\nimport sage.structure.unique_representation\nlen(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n\nfor i in range(2,1000):\n    ring = ZZ.quotient(ZZ(i))\n    vectorspace = ring^2\n\nimport gc\ngc.collect()\nlen(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n```\nRelated tickets:\n* #11521 (needs review, introducing weak references for caching homsets), and\n* #715 (needs review, using weak references for caching coerce maps). \n* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)\n\nFurther notes:\n* not everything in Python can be weakref'ed, for example ``None`` cannot.\n* some results that are expensive to compute should not just be cached by a weak reference. Perhaps there is place for a permanent cache, or maybe some minimal age before garbage collecting it.\n\n__Apply__\n\n* [attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)\n* [attachment: trac12215_safe_callback.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)\n\n\nCC:  @simon-king-jena @jdemeyer @mwhansen @vbraun @jpflori\n\nKeywords: **UniqueRepresentation cached_method caching**\n\nReviewer: **Nils Bruin**\n\nAuthor: **Simon King**\n\nMerged: **sage-5.7.beta1**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/12215_\n\n",
    "closed_at": "2013-01-25T13:07:03Z",
    "created_at": "2011-12-21T20:04:31Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/memleak",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Memleak in UniqueRepresentation, @cached_method",
    "type": "issue",
    "updated_at": "2013-01-25T13:07:03Z",
    "url": "https://github.com/sagemath/sage/issues/12215",
    "user": "https://github.com/vbraun"
}
```
The documentation says that UniqueRepresentation uses weak refs, but this was switched over to the `@`cached_method decorator. The latter does currently use strong references, so unused unique parents stay in memory forever:

```
import sage.structure.unique_representation
len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)

for i in range(2,1000):
    ring = ZZ.quotient(ZZ(i))
    vectorspace = ring^2

import gc
gc.collect()
len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)
```
Related tickets:
* #11521 (needs review, introducing weak references for caching homsets), and
* #715 (needs review, using weak references for caching coerce maps). 
* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)

Further notes:
* not everything in Python can be weakref'ed, for example ``None`` cannot.
* some results that are expensive to compute should not just be cached by a weak reference. Perhaps there is place for a permanent cache, or maybe some minimal age before garbage collecting it.

__Apply__

* [attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)
* [attachment: trac12215_safe_callback.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)


CC:  @simon-king-jena @jdemeyer @mwhansen @vbraun @jpflori

Keywords: **UniqueRepresentation cached_method caching**

Reviewer: **Nils Bruin**

Author: **Simon King**

Merged: **sage-5.7.beta1**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/12215_





---

archive/issue_events_166034.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-12-21T20:04:31Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166034"
}
```



---

archive/issue_events_166035.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-12-21T20:04:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "696969",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166035"
}
```



---

archive/issue_events_166036.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-12-21T20:04:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166036"
}
```



---

archive/issue_events_166037.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2011-12-21T20:04:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166037"
}
```



---

archive/issue_events_166038.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2011-12-21T20:04:31Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166038"
}
```



---

archive/issue_comments_131867.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,6 +15,7 @@\n Related tickets:\n * #11521 (needs review, introducing weak references for caching homsets), and\n * #715 (needs a lot of work, eventually aiming at using weak references for caching coerce maps). \n+* #5970 (the polynomial rings cache use strong references)\n \n Further notes:\n * not everything in Python can be weakref'ed, for example ``None`` cannot.\n``````\n",
    "created_at": "2011-12-21T20:31:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131867",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,6 +15,7 @@
 Related tickets:
 * #11521 (needs review, introducing weak references for caching homsets), and
 * #715 (needs a lot of work, eventually aiming at using weak references for caching coerce maps). 
+* #5970 (the polynomial rings cache use strong references)
 
 Further notes:
 * not everything in Python can be weakref'ed, for example ``None`` cannot.
``````




---

archive/issue_comments_131868.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSee my comment at #5970: It seems that having a weak version of cached_function (which is used to decorate `UniqueRepresentation.__classcall__` is the missing bit (in addition to #11521 and #715 and a two-line change in the polynomial ring constructor) for fixing the issues at #5970.\n\nI think this should be done on top of #11115, which rewrites cached methods and already has a positive review.",
    "created_at": "2011-12-21T21:51:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131868",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

See my comment at #5970: It seems that having a weak version of cached_function (which is used to decorate `UniqueRepresentation.__classcall__` is the missing bit (in addition to #11521 and #715 and a two-line change in the polynomial ring constructor) for fixing the issues at #5970.

I think this should be done on top of #11115, which rewrites cached methods and already has a positive review.



---

archive/issue_comments_131869.json:
```json
{
    "body": "Dependencies: **#11115**",
    "created_at": "2011-12-21T22:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131869",
    "user": "https://github.com/simon-king-jena"
}
```

Dependencies: **#11115**



---

archive/issue_comments_131870.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nHere is a patch. It isn't tested yet.",
    "created_at": "2011-12-21T22:41:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131870",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Here is a patch. It isn't tested yet.



---

archive/issue_comments_131871.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\n... and I immediately updated the patch: Join categories were not using unique representation but cached_function (by #11900). So, that had to change.",
    "created_at": "2011-12-21T22:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131871",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

... and I immediately updated the patch: Join categories were not using unique representation but cached_function (by #11900). So, that had to change.



---

archive/issue_comments_131872.json:
```json
{
    "body": "Changed dependencies from **#11115** to **#11115 #11900**",
    "created_at": "2011-12-21T22:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131872",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115** to **#11115 #11900**



---

archive/issue_comments_131873.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nSorry, it was impossible to use weak_cached_function on the join function in sage.categories.category, since it may return a list (not weakly referenceable). Hence, I had to work around. With the attached patch (applied on top of #11900 and its dependencies), sage at least starts...",
    "created_at": "2011-12-21T23:03:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131873",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Sorry, it was impossible to use weak_cached_function on the join function in sage.categories.category, since it may return a list (not weakly referenceable). Hence, I had to work around. With the attached patch (applied on top of #11900 and its dependencies), sage at least starts...



---

archive/issue_comments_131874.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIt turns out that all the patches can still not fix the problem. We also have to deal with `sage.structure.factory.UniqueFactory`.\n\nI suggest to add an option to `UniqueFactory`, that decides whether a strong or a weak cache is used. And I suggest to do this *here*, because I don't want to create yet another ticket.\n\nThe applications of `UniqueFactory` should mainly be in cases where weak references work. Therefore I suggest to use the weak cache by default - I am curious how many doc tests will fail...\n\nCoercion sucks.",
    "created_at": "2011-12-21T23:16:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131874",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

It turns out that all the patches can still not fix the problem. We also have to deal with `sage.structure.factory.UniqueFactory`.

I suggest to add an option to `UniqueFactory`, that decides whether a strong or a weak cache is used. And I suggest to do this *here*, because I don't want to create yet another ticket.

The applications of `UniqueFactory` should mainly be in cases where weak references work. Therefore I suggest to use the weak cache by default - I am curious how many doc tests will fail...

Coercion sucks.



---

archive/issue_comments_131875.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIt turns out that `UniqueFactory` already was somehow using weak references, but in an improper way. The new patch version replaces that by `WeakValueDictionary`.\n\nIt doesn't solve the problem, though.",
    "created_at": "2011-12-21T23:35:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131875",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

It turns out that `UniqueFactory` already was somehow using weak references, but in an improper way. The new patch version replaces that by `WeakValueDictionary`.

It doesn't solve the problem, though.



---

archive/issue_comments_131876.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI have slightly updated my patch, so that there is no conflict with #11935.",
    "created_at": "2011-12-22T08:27:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131876",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

I have slightly updated my patch, so that there is no conflict with #11935.



---

archive/issue_comments_131877.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThere is yet another location where it makes sense to use `@`weak_cached_function: For the cache of dynamic classes!\n\nNamely, dynamic classes are frequently used in the category framework, they have a strong cache, and the parent/element classes keep a pointer to the category they belong to. So, that's preventing categories from being garbage collected.\n\nI think that my patches from here, #715, and #11935 (which reduces the number of dynamic classes created) might actually be enough to fix the problem. When I run\n\n```\nsage: for p in primes(2,1000000):\n....:     R = GF(p)['x','y','z']\n....:     print get_memory_usage()\n```\nthen one initially still sees an increased memory usage. But after a while it seems to stabilise.",
    "created_at": "2011-12-22T08:36:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131877",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

There is yet another location where it makes sense to use `@`weak_cached_function: For the cache of dynamic classes!

Namely, dynamic classes are frequently used in the category framework, they have a strong cache, and the parent/element classes keep a pointer to the category they belong to. So, that's preventing categories from being garbage collected.

I think that my patches from here, #715, and #11935 (which reduces the number of dynamic classes created) might actually be enough to fix the problem. When I run

```
sage: for p in primes(2,1000000):
....:     R = GF(p)['x','y','z']
....:     print get_memory_usage()
```
then one initially still sees an increased memory usage. But after a while it seems to stabilise.



---

archive/issue_comments_131878.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,8 +14,8 @@\n ```\n Related tickets:\n * #11521 (needs review, introducing weak references for caching homsets), and\n-* #715 (needs a lot of work, eventually aiming at using weak references for caching coerce maps). \n-* #5970 (the polynomial rings cache use strong references)\n+* #715 (using weak references for caching coerce maps). \n+* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache here)\n \n Further notes:\n * not everything in Python can be weakref'ed, for example ``None`` cannot.\n``````\n",
    "created_at": "2011-12-22T18:18:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131878",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,8 +14,8 @@
 ```
 Related tickets:
 * #11521 (needs review, introducing weak references for caching homsets), and
-* #715 (needs a lot of work, eventually aiming at using weak references for caching coerce maps). 
-* #5970 (the polynomial rings cache use strong references)
+* #715 (using weak references for caching coerce maps). 
+* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache here)
 
 Further notes:
 * not everything in Python can be weakref'ed, for example ``None`` cannot.
``````




---

archive/issue_events_166039.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-12-22T18:18:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166039"
}
```



---

archive/issue_comments_131879.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI have updated the patch. It documents the changes, and at least the tests in sage/misc/cachefunc.pyx, in sage/categories/..., in sage/rings/... and in sage/structure/unique_representation.py pass.\n\nHence, needs review!",
    "created_at": "2011-12-22T18:18:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131879",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

I have updated the patch. It documents the changes, and at least the tests in sage/misc/cachefunc.pyx, in sage/categories/..., in sage/rings/... and in sage/structure/unique_representation.py pass.

Hence, needs review!



---

archive/issue_comments_131880.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2011-12-22T18:18:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131880",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Simon King**



---

archive/issue_comments_131881.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -15,7 +15,7 @@\n Related tickets:\n * #11521 (needs review, introducing weak references for caching homsets), and\n * #715 (using weak references for caching coerce maps). \n-* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache here)\n+* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)\n \n Further notes:\n * not everything in Python can be weakref'ed, for example ``None`` cannot.\n``````\n",
    "created_at": "2011-12-22T18:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131881",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -15,7 +15,7 @@
 Related tickets:
 * #11521 (needs review, introducing weak references for caching homsets), and
 * #715 (using weak references for caching coerce maps). 
-* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache here)
+* #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)
 
 Further notes:
 * not everything in Python can be weakref'ed, for example ``None`` cannot.
``````




---

archive/issue_events_166040.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-12-23T22:29:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166040"
}
```



---

archive/issue_events_166041.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2011-12-23T22:29:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166041"
}
```



---

archive/issue_comments_131882.json:
```json
{
    "body": "Work Issues: **segfaults for elliptic curves**",
    "created_at": "2011-12-23T22:29:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131882",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **segfaults for elliptic curves**



---

archive/issue_comments_131883.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nWhile the tests in sage/categories, sage/rings and sage/structure/unique_representation.py pass, I get some segfaults for the elliptic curve tests. Thus, needs work.",
    "created_at": "2011-12-23T22:29:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131883",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

While the tests in sage/categories, sage/rings and sage/structure/unique_representation.py pass, I get some segfaults for the elliptic curve tests. Thus, needs work.



---

archive/issue_comments_131884.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI did `sage -t --verbose \"devel/sage-main/sage/schemes/elliptic_curves/ell_point.py\"`, and it did *not* reveal a segfault while running the tests. The test process itself crashed:\n\n```\n830 tests in 54 items.\n830 passed and 0 failed.\nTest passed.\nThe doctested process was killed by signal 11\n         [23.8 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t --verbose \"devel/sage-main/sage/schemes/elliptic_curves/ell_point.py\" # Killed/crashed\n```\nStrange.",
    "created_at": "2011-12-23T22:46:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131884",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

I did `sage -t --verbose "devel/sage-main/sage/schemes/elliptic_curves/ell_point.py"`, and it did *not* reveal a segfault while running the tests. The test process itself crashed:

```
830 tests in 54 items.
830 passed and 0 failed.
Test passed.
The doctested process was killed by signal 11
         [23.8 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t --verbose "devel/sage-main/sage/schemes/elliptic_curves/ell_point.py" # Killed/crashed
```
Strange.



---

archive/issue_comments_131885.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI think I found the problem.\n\nSome doctest of the form\n\n```\nsage: K.residue_field()\n<expected answer>\n```\nsegfaults. But when the result is assigned to a variable, like this\n\n```\nsage: RF = K.residue_field(); RF\n<expected answer>\n```\nthen everything works.\n\nIs it perhaps the case that garbage collection of the residue field (that was enabled by my patch) happens between the creation and the computation of the string representation of the object?\n\nBut that is strange. There are variables `_` and `__`, which are supposed to provide strong references to the last two results - hence, there should be no garbage collection.",
    "created_at": "2011-12-24T23:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131885",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:17" align="right">comment:17</div>

I think I found the problem.

Some doctest of the form

```
sage: K.residue_field()
<expected answer>
```
segfaults. But when the result is assigned to a variable, like this

```
sage: RF = K.residue_field(); RF
<expected answer>
```
then everything works.

Is it perhaps the case that garbage collection of the residue field (that was enabled by my patch) happens between the creation and the computation of the string representation of the object?

But that is strange. There are variables `_` and `__`, which are supposed to provide strong references to the last two results - hence, there should be no garbage collection.



---

archive/issue_comments_131886.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\n`sage.structure.factory.UniqueFactory` did use weak references before. But it did so - I think - improperly, namely without using `weakref.WeakValueDictionary`. The new patch version changes that.\n\nIt isn't ready for review, yet, because of the segfaults.",
    "created_at": "2011-12-24T23:53:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131886",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

`sage.structure.factory.UniqueFactory` did use weak references before. But it did so - I think - improperly, namely without using `weakref.WeakValueDictionary`. The new patch version changes that.

It isn't ready for review, yet, because of the segfaults.



---

archive/issue_comments_131887.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nSome old code is *not* using the cache: There was some coerce map created in sage/rings/residue_field.pyx, whose parent was not created by `Hom(domain,codomain)`, but directly by `RingHomset(domain,codomain)`. \n\nChanging it fixed at least one segfault. I wish all segfaults would go away so easily...",
    "created_at": "2011-12-27T10:16:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131887",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:19" align="right">comment:19</div>

Some old code is *not* using the cache: There was some coerce map created in sage/rings/residue_field.pyx, whose parent was not created by `Hom(domain,codomain)`, but directly by `RingHomset(domain,codomain)`. 

Changing it fixed at least one segfault. I wish all segfaults would go away so easily...



---

archive/issue_comments_131888.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nFortunately, I now have a short example that triggers a memory access error when leaving Sage:\n\n```\nsage: E = EllipticCurve('15a1')\nsage: K.<t>=NumberField(x^2+2*x+10)\nsage: EK=E.base_extend(K)\nsage: EK.torsion_subgroup()\nTorsion Subgroup isomorphic to Z/4 + Z/4 associated to the Elliptic Curve defined by y^2 + x*y + y = x^3 + x^2 + (-10)*x + (-10) over Number Field in t with defining polynomial x^2 + 2*x + 10\nsage: quit\nExiting Sage (CPU time 0m1.98s, Wall time 0m52.03s).\nlocal/bin/sage-sage: Zeile 303: 30045 Speicherzugriffsfehler  sage-ipython \"$@\" -i\n```\n\nHowever, I wonder how I can trigger the error without leaving Sage, and how I can trace what is going on.",
    "created_at": "2011-12-27T17:44:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131888",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

Fortunately, I now have a short example that triggers a memory access error when leaving Sage:

```
sage: E = EllipticCurve('15a1')
sage: K.<t>=NumberField(x^2+2*x+10)
sage: EK=E.base_extend(K)
sage: EK.torsion_subgroup()
Torsion Subgroup isomorphic to Z/4 + Z/4 associated to the Elliptic Curve defined by y^2 + x*y + y = x^3 + x^2 + (-10)*x + (-10) over Number Field in t with defining polynomial x^2 + 2*x + 10
sage: quit
Exiting Sage (CPU time 0m1.98s, Wall time 0m52.03s).
local/bin/sage-sage: Zeile 303: 30045 Speicherzugriffsfehler  sage-ipython "$@" -i
```

However, I wonder how I can trigger the error without leaving Sage, and how I can trace what is going on.



---

archive/issue_comments_131889.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nActually `EK._torsion_bound(number_of_places=20)` is enough to trigger the memory access error.",
    "created_at": "2011-12-27T17:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131889",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Actually `EK._torsion_bound(number_of_places=20)` is enough to trigger the memory access error.



---

archive/issue_comments_131890.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nHere is the stack:\n\n```\nProgram terminated with signal 11, Segmentation fault.\n#0  cgetg (y=22, x=<optimized out>) at ../src/kernel/none/level1.h:114\n114\t../src/kernel/none/level1.h: No such file or directory.\n\tin ../src/kernel/none/level1.h\nTraceback (most recent call last):\n  File \"/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.16-gdb.py\", line 59, in <module>\n    from libstdcxx.v6.printers import register_libstdcxx_printers\n  File \"/usr/lib64/../share/gcc-4.6.2/python/libstdcxx/v6/printers.py\", line 19, in <module>\n    import itertools\nImportError: No module named itertools\nMissing separate debuginfos, use: debuginfo-install atlas-3.8.4-1.fc16.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-4.fc16.x86_64 keyutils-libs-1.5.2-1.fc16.x86_64 krb5-libs-1.9.2-4.fc16.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libselinux-2.1.6-5.fc16.x86_64 ncurses-libs-5.9-2.20110716.fc16.x86_64 openssl-1.0.0e-1.fc16.x86_64\n(gdb) bt\n#0  cgetg (y=22, x=<optimized out>) at ../src/kernel/none/level1.h:114\n#1  convi (x=0x288b2a8, l=0x7fff6a2f8a38) at ../src/kernel/gmp/mp.c:1288\n#2  0x00007f11fb1637ec in itostr_sign (x=<optimized out>, sx=1, len=0x7fff6a2f8b48) at ../src/language/es.c:500\n#3  0x00007f11fb167b4f in str_absint (x=0x288b2a8, S=0x7fff6a2f8cb0) at ../src/language/es.c:1778\n#4  bruti_intern (g=0x288b2a8, T=<optimized out>, S=0x7fff6a2f8cb0, addsign=1) at ../src/language/es.c:2557\n#5  0x00007f11fb168453 in bruti_intern (g=0x288b2d8, T=0x7f11fb4b27a0, S=0x7fff6a2f8cb0, addsign=<optimized out>)\n    at ../src/language/es.c:2730\n#6  0x00007f11fb1679ae in GENtostr_fun (out=0x7f11fb16a7b0 <bruti>, T=0x7f11fb4b27a0, x=0x288b2d8)\n    at ../src/language/es.c:1645\n#7  GENtostr (x=0x288b2d8) at ../src/language/es.c:1651\n#8  0x00007f11f5ae5c44 in gcmp_sage (y=0x583d1b8, x=<optimized out>) at sage/libs/pari/misc.h:60\n#9  __pyx_f_4sage_4libs_4pari_3gen_3gen__cmp_c_impl (__pyx_v_left=<optimized out>, __pyx_v_right=<optimized out>)\n    at sage/libs/pari/gen.c:8513\n#10 0x00007f11f8663227 in __pyx_f_4sage_9structure_7element_7Element__richcmp_c_impl (__pyx_v_left=0x5780e10, \n    __pyx_v_right=<optimized out>, __pyx_v_op=2) at sage/structure/element.c:7775\n#11 0x00007f11f86875ec in __pyx_f_4sage_9structure_7element_7Element__richcmp (__pyx_v_left=0x5780e10, \n    __pyx_v_right=0x5863f70, __pyx_v_op=2) at sage/structure/element.c:7498\n#12 0x00007f11f5ae045b in __pyx_pf_4sage_4libs_4pari_3gen_3gen_44__richcmp__ (__pyx_v_left=<optimized out>, \n    __pyx_v_right=<optimized out>, __pyx_v_op=<optimized out>) at sage/libs/pari/gen.c:8475\n#13 0x00007f1208b32e6a in try_rich_compare (v=0x5780e10, w=0x5863f70, op=2) at Objects/object.c:619\n#14 0x00007f1208b3518d in try_rich_compare_bool (op=<optimized out>, w=<optimized out>, v=<optimized out>)\n    at Objects/object.c:647\n#15 try_rich_to_3way_compare (w=0x5863f70, v=0x5780e10) at Objects/object.c:681\n#16 do_cmp (w=0x5863f70, v=0x5780e10) at Objects/object.c:834\n#17 PyObject_Compare (v=0x5780e10, w=0x5863f70) at Objects/object.c:863\n#18 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f8f0c)\n    at Objects/abstract.c:41\n#19 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422\n#20 0x00007f1208b917fd in call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9000) at Python/ceval.c:3706\n#21 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389\n#22 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, \n    args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0)\n    at Python/ceval.c:2968\n#23 0x00007f1208b1f7f6 in function_call (func=0x1fec9b0, arg=0x5864518, kw=0x0) at Objects/funcobject.c:524\n#24 0x00007f1208af97a3 in PyObject_Call (func=0x1fec9b0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#25 0x00007f1208b0667f in instancemethod_call (func=0x1fec9b0, arg=0x5864518, kw=0x0)\n    at Objects/classobject.c:2579\n#26 0x00007f1208af97a3 in PyObject_Call (func=0x579d0f0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#27 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253\n#28 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x5713af0, other=0x5866af0) at Objects/typeobject.c:5278\n#29 0x00007f1208b35260 in do_cmp (w=0x5866af0, v=0x5713af0) at Objects/object.c:817\n#30 PyObject_Compare (v=0x5713af0, w=0x5866af0) at Objects/object.c:863\n#31 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f955c)\n    at Objects/abstract.c:41\n#32 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422\n#33 0x00007f1208af97a3 in PyObject_Call (func=0x7f120903e2d8, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#34 0x00007f11e5b541fc in __pyx_pf_4sage_5rings_13residue_field_20ResidueField_generic_8__cmp__ (\n    __pyx_self=<optimized out>, __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)\n    at sage/rings/residue_field.c:7317\n#35 0x00007f1208af97a3 in PyObject_Call (func=0x22e7200, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n---Type <return> to continue, or q <return> to quit---\n#36 0x00007f1208b0667f in instancemethod_call (func=0x22e7200, arg=0x586d320, kw=0x0)\n    at Objects/classobject.c:2579\n#37 0x00007f1208af97a3 in PyObject_Call (func=0x4e32aa0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#38 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253\n#39 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x57f2410, other=0x5906e90) at Objects/typeobject.c:5278\n#40 0x00007f1208b35260 in do_cmp (w=0x5906e90, v=0x57f2410) at Objects/object.c:817\n#41 PyObject_Compare (v=0x57f2410, w=0x5906e90) at Objects/object.c:863\n#42 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f99bc)\n    at Objects/abstract.c:41\n#43 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422\n#44 0x00007f1208b917fd in call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9ab0) at Python/ceval.c:3706\n#45 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389\n#46 0x00007f1208b92593 in fast_function (nk=<optimized out>, na=2, n=<optimized out>, pp_stack=0x7fff6a2f9c10, \n    func=0x3b0a410) at Python/ceval.c:3792\n#47 call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9c10) at Python/ceval.c:3727\n#48 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389\n#49 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, \n    args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0)\n    at Python/ceval.c:2968\n#50 0x00007f1208b1f7f6 in function_call (func=0x3af28c0, arg=0x588d7a0, kw=0x0) at Objects/funcobject.c:524\n#51 0x00007f1208af97a3 in PyObject_Call (func=0x3af28c0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#52 0x00007f1208b0667f in instancemethod_call (func=0x3af28c0, arg=0x588d7a0, kw=0x0)\n    at Objects/classobject.c:2579\n#53 0x00007f1208af97a3 in PyObject_Call (func=0x4e29be0, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#54 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253\n#55 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x579f908, other=0x58c5528) at Objects/typeobject.c:5278\n#56 0x00007f1208b34dad in PyObject_RichCompare (v=0x579f908, w=0x58c5528, op=2) at Objects/object.c:967\n#57 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)\n    at Objects/object.c:1001\n#58 0x00007f1208b49264 in tuplerichcompare (op=2, w=0x5898a70, v=0x578bf38) at Objects/tupleobject.c:546\n#59 tuplerichcompare (v=0x578bf38, w=0x5898a70, op=2) at Objects/tupleobject.c:517\n#60 0x00007f1208b34d71 in PyObject_RichCompare (v=0x578bf38, w=0x5898a70, op=2) at Objects/object.c:958\n#61 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)\n    at Objects/object.c:1001\n#62 0x00007f1208b49264 in tuplerichcompare (op=2, w=0x5898ab8, v=0x579c368) at Objects/tupleobject.c:546\n#63 tuplerichcompare (v=0x579c368, w=0x5898ab8, op=2) at Objects/tupleobject.c:517\n#64 0x00007f1208b34d71 in PyObject_RichCompare (v=0x579c368, w=0x5898ab8, op=2) at Objects/object.c:958\n#65 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)\n    at Objects/object.c:1001\n#66 0x00007f1208b2f305 in lookdict (mp=0x14c51d0, key=<optimized out>, hash=-1399715627429533172)\n    at Objects/dictobject.c:351\n#67 0x00007f1208b3087c in PyDict_DelItem (op=0x14c51d0, key=0x5898ab8) at Objects/dictobject.c:742\n#68 0x00007f1208b8e924 in PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:1555\n#69 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, \n    args=<optimized out>, argcount=1, kws=0x0, kwcount=0, defs=0x1458be8, defcount=1, closure=0x0)\n    at Python/ceval.c:2968\n#70 0x00007f1208b1f7f6 in function_call (func=0x1464320, arg=0x7f1208fdf510, kw=0x0) at Objects/funcobject.c:524\n#71 0x00007f1208af97a3 in PyObject_Call (func=0x1464320, arg=<optimized out>, kw=<optimized out>)\n    at Objects/abstract.c:2492\n#72 0x00007f1208afa1e0 in PyObject_CallFunctionObjArgs (callable=0x1464320) at Objects/abstract.c:2723\n#73 0x00007f1208bc4146 in handle_weakrefs (old=0x7f1208e52b40, unreachable=0x7fff6a2fa700)\n---Type <return> to continue, or q <return> to quit---\n    at Modules/gcmodule.c:607\n#74 collect (generation=2) at Modules/gcmodule.c:859\n#75 0x00007f1208bc4b04 in PyGC_Collect () at Modules/gcmodule.c:1292\n#76 0x00007f1208bb6d73 in Py_Finalize () at Python/pythonrun.c:424\n#77 0x00007f1208bb5c38 in Py_Exit (sts=0) at Python/pythonrun.c:1714\n#78 0x00007f1208bb5d2f in handle_system_exit () at Python/pythonrun.c:1116\n#79 0x00007f1208bb5fc5 in handle_system_exit () at Python/pythonrun.c:1078\n#80 PyErr_PrintEx (set_sys_last_vars=1) at Python/pythonrun.c:1126\n#81 0x00007f1208bb643e in PyRun_SimpleFileExFlags (fp=<optimized out>, filename=<optimized out>, closeit=1, \n    flags=0x7fff6a2fa9e0) at Python/pythonrun.c:935\n#82 0x00007f1208bc35a3 in Py_Main (argc=<optimized out>, argv=<optimized out>) at Modules/main.c:599\n#83 0x00007f1207e7569d in __libc_start_main (main=0x400620 <main>, argc=3, ubp_av=0x7fff6a2fab08, \n    init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7fff6a2faaf8)\n    at libc-start.c:226\n#84 0x0000000000400651 in _start ()\n```\nFor the record, I enabled coredumps and then ran `gdb --core core.4522 local/bin/python`",
    "created_at": "2011-12-27T18:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131890",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:22" align="right">comment:22</div>

Here is the stack:

```
Program terminated with signal 11, Segmentation fault.
#0  cgetg (y=22, x=<optimized out>) at ../src/kernel/none/level1.h:114
114	../src/kernel/none/level1.h: No such file or directory.
	in ../src/kernel/none/level1.h
Traceback (most recent call last):
  File "/usr/share/gdb/auto-load/usr/lib64/libstdc++.so.6.0.16-gdb.py", line 59, in <module>
    from libstdcxx.v6.printers import register_libstdcxx_printers
  File "/usr/lib64/../share/gcc-4.6.2/python/libstdcxx/v6/printers.py", line 19, in <module>
    import itertools
ImportError: No module named itertools
Missing separate debuginfos, use: debuginfo-install atlas-3.8.4-1.fc16.x86_64 expat-2.0.1-11.fc15.x86_64 fontconfig-2.8.0-4.fc16.x86_64 keyutils-libs-1.5.2-1.fc16.x86_64 krb5-libs-1.9.2-4.fc16.x86_64 libcom_err-1.41.14-2.fc15.x86_64 libselinux-2.1.6-5.fc16.x86_64 ncurses-libs-5.9-2.20110716.fc16.x86_64 openssl-1.0.0e-1.fc16.x86_64
(gdb) bt
#0  cgetg (y=22, x=<optimized out>) at ../src/kernel/none/level1.h:114
#1  convi (x=0x288b2a8, l=0x7fff6a2f8a38) at ../src/kernel/gmp/mp.c:1288
#2  0x00007f11fb1637ec in itostr_sign (x=<optimized out>, sx=1, len=0x7fff6a2f8b48) at ../src/language/es.c:500
#3  0x00007f11fb167b4f in str_absint (x=0x288b2a8, S=0x7fff6a2f8cb0) at ../src/language/es.c:1778
#4  bruti_intern (g=0x288b2a8, T=<optimized out>, S=0x7fff6a2f8cb0, addsign=1) at ../src/language/es.c:2557
#5  0x00007f11fb168453 in bruti_intern (g=0x288b2d8, T=0x7f11fb4b27a0, S=0x7fff6a2f8cb0, addsign=<optimized out>)
    at ../src/language/es.c:2730
#6  0x00007f11fb1679ae in GENtostr_fun (out=0x7f11fb16a7b0 <bruti>, T=0x7f11fb4b27a0, x=0x288b2d8)
    at ../src/language/es.c:1645
#7  GENtostr (x=0x288b2d8) at ../src/language/es.c:1651
#8  0x00007f11f5ae5c44 in gcmp_sage (y=0x583d1b8, x=<optimized out>) at sage/libs/pari/misc.h:60
#9  __pyx_f_4sage_4libs_4pari_3gen_3gen__cmp_c_impl (__pyx_v_left=<optimized out>, __pyx_v_right=<optimized out>)
    at sage/libs/pari/gen.c:8513
#10 0x00007f11f8663227 in __pyx_f_4sage_9structure_7element_7Element__richcmp_c_impl (__pyx_v_left=0x5780e10, 
    __pyx_v_right=<optimized out>, __pyx_v_op=2) at sage/structure/element.c:7775
#11 0x00007f11f86875ec in __pyx_f_4sage_9structure_7element_7Element__richcmp (__pyx_v_left=0x5780e10, 
    __pyx_v_right=0x5863f70, __pyx_v_op=2) at sage/structure/element.c:7498
#12 0x00007f11f5ae045b in __pyx_pf_4sage_4libs_4pari_3gen_3gen_44__richcmp__ (__pyx_v_left=<optimized out>, 
    __pyx_v_right=<optimized out>, __pyx_v_op=<optimized out>) at sage/libs/pari/gen.c:8475
#13 0x00007f1208b32e6a in try_rich_compare (v=0x5780e10, w=0x5863f70, op=2) at Objects/object.c:619
#14 0x00007f1208b3518d in try_rich_compare_bool (op=<optimized out>, w=<optimized out>, v=<optimized out>)
    at Objects/object.c:647
#15 try_rich_to_3way_compare (w=0x5863f70, v=0x5780e10) at Objects/object.c:681
#16 do_cmp (w=0x5863f70, v=0x5780e10) at Objects/object.c:834
#17 PyObject_Compare (v=0x5780e10, w=0x5863f70) at Objects/object.c:863
#18 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f8f0c)
    at Objects/abstract.c:41
#19 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422
#20 0x00007f1208b917fd in call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9000) at Python/ceval.c:3706
#21 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389
#22 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, 
    args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0)
    at Python/ceval.c:2968
#23 0x00007f1208b1f7f6 in function_call (func=0x1fec9b0, arg=0x5864518, kw=0x0) at Objects/funcobject.c:524
#24 0x00007f1208af97a3 in PyObject_Call (func=0x1fec9b0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#25 0x00007f1208b0667f in instancemethod_call (func=0x1fec9b0, arg=0x5864518, kw=0x0)
    at Objects/classobject.c:2579
#26 0x00007f1208af97a3 in PyObject_Call (func=0x579d0f0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#27 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253
#28 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x5713af0, other=0x5866af0) at Objects/typeobject.c:5278
#29 0x00007f1208b35260 in do_cmp (w=0x5866af0, v=0x5713af0) at Objects/object.c:817
#30 PyObject_Compare (v=0x5713af0, w=0x5866af0) at Objects/object.c:863
#31 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f955c)
    at Objects/abstract.c:41
#32 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422
#33 0x00007f1208af97a3 in PyObject_Call (func=0x7f120903e2d8, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#34 0x00007f11e5b541fc in __pyx_pf_4sage_5rings_13residue_field_20ResidueField_generic_8__cmp__ (
    __pyx_self=<optimized out>, __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)
    at sage/rings/residue_field.c:7317
#35 0x00007f1208af97a3 in PyObject_Call (func=0x22e7200, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
---Type <return> to continue, or q <return> to quit---
#36 0x00007f1208b0667f in instancemethod_call (func=0x22e7200, arg=0x586d320, kw=0x0)
    at Objects/classobject.c:2579
#37 0x00007f1208af97a3 in PyObject_Call (func=0x4e32aa0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#38 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253
#39 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x57f2410, other=0x5906e90) at Objects/typeobject.c:5278
#40 0x00007f1208b35260 in do_cmp (w=0x5906e90, v=0x57f2410) at Objects/object.c:817
#41 PyObject_Compare (v=0x57f2410, w=0x5906e90) at Objects/object.c:863
#42 0x00007f1208af5ae5 in PyObject_Cmp (o1=<optimized out>, o2=<optimized out>, result=0x7fff6a2f99bc)
    at Objects/abstract.c:41
#43 0x00007f1208b879d4 in builtin_cmp (self=<optimized out>, args=<optimized out>) at Python/bltinmodule.c:422
#44 0x00007f1208b917fd in call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9ab0) at Python/ceval.c:3706
#45 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389
#46 0x00007f1208b92593 in fast_function (nk=<optimized out>, na=2, n=<optimized out>, pp_stack=0x7fff6a2f9c10, 
    func=0x3b0a410) at Python/ceval.c:3792
#47 call_function (oparg=<optimized out>, pp_stack=0x7fff6a2f9c10) at Python/ceval.c:3727
#48 PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:2389
#49 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, 
    args=<optimized out>, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0)
    at Python/ceval.c:2968
#50 0x00007f1208b1f7f6 in function_call (func=0x3af28c0, arg=0x588d7a0, kw=0x0) at Objects/funcobject.c:524
#51 0x00007f1208af97a3 in PyObject_Call (func=0x3af28c0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#52 0x00007f1208b0667f in instancemethod_call (func=0x3af28c0, arg=0x588d7a0, kw=0x0)
    at Objects/classobject.c:2579
#53 0x00007f1208af97a3 in PyObject_Call (func=0x4e29be0, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#54 0x00007f1208b545c6 in half_compare (self=<optimized out>, other=<optimized out>) at Objects/typeobject.c:5253
#55 0x00007f1208b547a5 in _PyObject_SlotCompare (self=0x579f908, other=0x58c5528) at Objects/typeobject.c:5278
#56 0x00007f1208b34dad in PyObject_RichCompare (v=0x579f908, w=0x58c5528, op=2) at Objects/object.c:967
#57 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)
    at Objects/object.c:1001
#58 0x00007f1208b49264 in tuplerichcompare (op=2, w=0x5898a70, v=0x578bf38) at Objects/tupleobject.c:546
#59 tuplerichcompare (v=0x578bf38, w=0x5898a70, op=2) at Objects/tupleobject.c:517
#60 0x00007f1208b34d71 in PyObject_RichCompare (v=0x578bf38, w=0x5898a70, op=2) at Objects/object.c:958
#61 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)
    at Objects/object.c:1001
#62 0x00007f1208b49264 in tuplerichcompare (op=2, w=0x5898ab8, v=0x579c368) at Objects/tupleobject.c:546
#63 tuplerichcompare (v=0x579c368, w=0x5898ab8, op=2) at Objects/tupleobject.c:517
#64 0x00007f1208b34d71 in PyObject_RichCompare (v=0x579c368, w=0x5898ab8, op=2) at Objects/object.c:958
#65 0x00007f1208b3505f in PyObject_RichCompareBool (v=<optimized out>, w=<optimized out>, op=<optimized out>)
    at Objects/object.c:1001
#66 0x00007f1208b2f305 in lookdict (mp=0x14c51d0, key=<optimized out>, hash=-1399715627429533172)
    at Objects/dictobject.c:351
#67 0x00007f1208b3087c in PyDict_DelItem (op=0x14c51d0, key=0x5898ab8) at Objects/dictobject.c:742
#68 0x00007f1208b8e924 in PyEval_EvalFrameEx (f=<optimized out>, throwflag=<optimized out>) at Python/ceval.c:1555
#69 0x00007f1208b934d9 in PyEval_EvalCodeEx (co=<optimized out>, globals=<optimized out>, locals=<optimized out>, 
    args=<optimized out>, argcount=1, kws=0x0, kwcount=0, defs=0x1458be8, defcount=1, closure=0x0)
    at Python/ceval.c:2968
#70 0x00007f1208b1f7f6 in function_call (func=0x1464320, arg=0x7f1208fdf510, kw=0x0) at Objects/funcobject.c:524
#71 0x00007f1208af97a3 in PyObject_Call (func=0x1464320, arg=<optimized out>, kw=<optimized out>)
    at Objects/abstract.c:2492
#72 0x00007f1208afa1e0 in PyObject_CallFunctionObjArgs (callable=0x1464320) at Objects/abstract.c:2723
#73 0x00007f1208bc4146 in handle_weakrefs (old=0x7f1208e52b40, unreachable=0x7fff6a2fa700)
---Type <return> to continue, or q <return> to quit---
    at Modules/gcmodule.c:607
#74 collect (generation=2) at Modules/gcmodule.c:859
#75 0x00007f1208bc4b04 in PyGC_Collect () at Modules/gcmodule.c:1292
#76 0x00007f1208bb6d73 in Py_Finalize () at Python/pythonrun.c:424
#77 0x00007f1208bb5c38 in Py_Exit (sts=0) at Python/pythonrun.c:1714
#78 0x00007f1208bb5d2f in handle_system_exit () at Python/pythonrun.c:1116
#79 0x00007f1208bb5fc5 in handle_system_exit () at Python/pythonrun.c:1078
#80 PyErr_PrintEx (set_sys_last_vars=1) at Python/pythonrun.c:1126
#81 0x00007f1208bb643e in PyRun_SimpleFileExFlags (fp=<optimized out>, filename=<optimized out>, closeit=1, 
    flags=0x7fff6a2fa9e0) at Python/pythonrun.c:935
#82 0x00007f1208bc35a3 in Py_Main (argc=<optimized out>, argv=<optimized out>) at Modules/main.c:599
#83 0x00007f1207e7569d in __libc_start_main (main=0x400620 <main>, argc=3, ubp_av=0x7fff6a2fab08, 
    init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7fff6a2faaf8)
    at libc-start.c:226
#84 0x0000000000400651 in _start ()
```
For the record, I enabled coredumps and then ran `gdb --core core.4522 local/bin/python`



---

archive/issue_comments_131891.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThank you! How does one enable coredumps?",
    "created_at": "2011-12-27T20:07:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131891",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

Thank you! How does one enable coredumps?



---

archive/issue_comments_131892.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nIf I understand correctly, the coredump says that it occurs while doing `c = cmp(self.p, x.p)`, where x and self are residue fields.",
    "created_at": "2011-12-27T20:22:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131892",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

If I understand correctly, the coredump says that it occurs while doing `c = cmp(self.p, x.p)`, where x and self are residue fields.



---

archive/issue_comments_131893.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nYep, I just inserted a print statement before and after the \"cmp\" line. When leaving sage, the first line was printed, and the segfault happened before printing the second line. Hence, the problem occurs when comparing fractional ideals.",
    "created_at": "2011-12-27T20:25:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131893",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Yep, I just inserted a print statement before and after the "cmp" line. When leaving sage, the first line was printed, and the segfault happened before printing the second line. Hence, the problem occurs when comparing fractional ideals.



---

archive/issue_comments_131894.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nTo enable coredumps (at least with bash):\n\n```\nulimit -c unlimited\n```",
    "created_at": "2011-12-27T20:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131894",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:26" align="right">comment:26</div>

To enable coredumps (at least with bash):

```
ulimit -c unlimited
```



---

archive/issue_comments_131895.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nAha! A comparison of two sage.libs.pari.gen.gen happens *after* _unsafe_deallocate_pari_stack is called, which closes pari. That is, of course, bad.\n\nOnly I wonder how the order can be changed. Alternatively, it could be tested before comparison whether pari is still alive. But that would result in a slow-down.",
    "created_at": "2011-12-27T22:35:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131895",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">comment:27</div>

Aha! A comparison of two sage.libs.pari.gen.gen happens *after* _unsafe_deallocate_pari_stack is called, which closes pari. That is, of course, bad.

Only I wonder how the order can be changed. Alternatively, it could be tested before comparison whether pari is still alive. But that would result in a slow-down.



---

archive/issue_comments_131896.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI guess one must make sure that there is a strong reference to the (unique?) pari instance until all sage.libs.pari.gen.gen are deallocated.",
    "created_at": "2011-12-27T22:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131896",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">comment:28</div>

I guess one must make sure that there is a strong reference to the (unique?) pari instance until all sage.libs.pari.gen.gen are deallocated.



---

archive/issue_comments_131897.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n`pari._unsafe_deallocate_pari_stack` is called in sage.all.quit_sage. It does not help to move it to the end of quit_sage. I wonder why it is not put into a proper `__del__` method of `PariInstance`? Is it really needed to be in quit_sage??",
    "created_at": "2011-12-27T23:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131897",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:29" align="right">comment:29</div>

`pari._unsafe_deallocate_pari_stack` is called in sage.all.quit_sage. It does not help to move it to the end of quit_sage. I wonder why it is not put into a proper `__del__` method of `PariInstance`? Is it really needed to be in quit_sage??



---

archive/issue_comments_131898.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nYessss! When removing `_unsafe_deallocate_pari_stack` from quit_sage and renaming it into a `__dealloc__` method, then the segfault vanishes!",
    "created_at": "2011-12-27T23:22:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131898",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:30" align="right">comment:30</div>

Yessss! When removing `_unsafe_deallocate_pari_stack` from quit_sage and renaming it into a `__dealloc__` method, then the segfault vanishes!



---

archive/issue_comments_131899.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nToo bad. It fixes the segfault of `sage -t sage/rings/number_field/number_field_ideal.py`, but it doesn't help for `sage -t sage/schemes/elliptic_curves/heegner.py`.\n\nWhy is it always the elliptic curves code that causes trouble for my patches?",
    "created_at": "2011-12-27T23:36:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131899",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:31" align="right">comment:31</div>

Too bad. It fixes the segfault of `sage -t sage/rings/number_field/number_field_ideal.py`, but it doesn't help for `sage -t sage/schemes/elliptic_curves/heegner.py`.

Why is it always the elliptic curves code that causes trouble for my patches?



---

archive/issue_comments_131900.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI have attached a second patch, that fixes two or three segfaults - which isn't enough.",
    "created_at": "2011-12-27T23:39:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131900",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:32" align="right">comment:32</div>

I have attached a second patch, that fixes two or three segfaults - which isn't enough.



---

archive/issue_comments_131901.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nIn Python one must not use __dealloc__() to free C resources, at least not unless you are absolutely certain that the Python object does not participate in circular references. \n\nDoes it help to do an explicit `gc.collect()` at the end of `quit_sage` and only then deallocate Pari? If not we might have to give up clearing the Pari stack...",
    "created_at": "2011-12-28T00:02:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131901",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:33" align="right">comment:33</div>

In Python one must not use __dealloc__() to free C resources, at least not unless you are absolutely certain that the Python object does not participate in circular references. 

Does it help to do an explicit `gc.collect()` at the end of `quit_sage` and only then deallocate Pari? If not we might have to give up clearing the Pari stack...



---

archive/issue_comments_131902.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@vbraun](#comment:33):\n> In Python one must not use __dealloc__() to free C resources, at least not unless you are absolutely certain that the Python object does not participate in circular references. \n\nDo you mean `__del__`? If I remember correctly, `__dealloc__` is Cython, has nothing to do with the ability of the garbage collector to deal with circular references, and it is what one *must* have if there are C-resources to free after deleting all Python stuff. So, from all what I know, using `__dealloc__` (not `__del__`!) is a clean solution.\n\n> Does it help to do an explicit `gc.collect()` at the end of `quit_sage` and only then deallocate Pari? If not we might have to give up clearing the Pari stack...\n\nI didn't try.",
    "created_at": "2011-12-28T01:26:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131902",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@vbraun](#comment:33):
> In Python one must not use __dealloc__() to free C resources, at least not unless you are absolutely certain that the Python object does not participate in circular references. 

Do you mean `__del__`? If I remember correctly, `__dealloc__` is Cython, has nothing to do with the ability of the garbage collector to deal with circular references, and it is what one *must* have if there are C-resources to free after deleting all Python stuff. So, from all what I know, using `__dealloc__` (not `__del__`!) is a clean solution.

> Does it help to do an explicit `gc.collect()` at the end of `quit_sage` and only then deallocate Pari? If not we might have to give up clearing the Pari stack...

I didn't try.



---

archive/issue_comments_131903.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nYes, you are right: `__dealloc__` is ok, `__del__` is not.\n\nBut the problem seems to be that we finalize Pari before finalizing all Pari elements. Ideally, elements keep their parent alive because they hold a reference but I think GENs are often used in an ad-hoc way in Sage. So moving the Pari finalizer to `__dealloc__` just makes it run later, but still gives no guarantees about finalizer ordering.",
    "created_at": "2011-12-28T10:47:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131903",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:35" align="right">comment:35</div>

Yes, you are right: `__dealloc__` is ok, `__del__` is not.

But the problem seems to be that we finalize Pari before finalizing all Pari elements. Ideally, elements keep their parent alive because they hold a reference but I think GENs are often used in an ad-hoc way in Sage. So moving the Pari finalizer to `__dealloc__` just makes it run later, but still gives no guarantees about finalizer ordering.



---

archive/issue_comments_131904.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nPari elements have no parent, if I am not mistaken. Adding a parent means: Create an overhead, namely an additional pointer as part of all Pari elements. I am not sure if the number theorists would like that - one might ask on sage-nt.",
    "created_at": "2011-12-28T10:59:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131904",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:36" align="right">comment:36</div>

Pari elements have no parent, if I am not mistaken. Adding a parent means: Create an overhead, namely an additional pointer as part of all Pari elements. I am not sure if the number theorists would like that - one might ask on sage-nt.



---

archive/issue_comments_131905.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nThere is `sage.rings.pari_ring` which implements parents and elements. But when Pari is used in the Sage library its usually directly via its C API.\n\nLooking at Python's C API, it seems that `Py_AtExit()` is what we want: A callback for a cleanup function that is run after Python is finalized. In fact anything from `quit_sage()` that just finalizes a C library should probably be moved there. See http://docs.python.org/c-api/sys.html",
    "created_at": "2011-12-28T12:06:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131905",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:37" align="right">comment:37</div>

There is `sage.rings.pari_ring` which implements parents and elements. But when Pari is used in the Sage library its usually directly via its C API.

Looking at Python's C API, it seems that `Py_AtExit()` is what we want: A callback for a cleanup function that is run after Python is finalized. In fact anything from `quit_sage()` that just finalizes a C library should probably be moved there. See http://docs.python.org/c-api/sys.html



---

archive/issue_comments_131906.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nNot sure why I was added to \"cc\".  But the newly added doctest in [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) looks bad because there really should be only **one** running `PariInstance`, since global variables are used for the PARI stack (this is the fault of PARI, not of Sage).",
    "created_at": "2011-12-28T21:05:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131906",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Not sure why I was added to "cc".  But the newly added doctest in [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) looks bad because there really should be only **one** running `PariInstance`, since global variables are used for the PARI stack (this is the fault of PARI, not of Sage).



---

archive/issue_comments_131907.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@jdemeyer](#comment:38):\n> But the newly added doctest in [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) looks bad because there really should be only **one** running `PariInstance`\n\nHow else could one test that `__dealloc__` works?",
    "created_at": "2011-12-28T23:12:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131907",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@jdemeyer](#comment:38):
> But the newly added doctest in [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) looks bad because there really should be only **one** running `PariInstance`

How else could one test that `__dealloc__` works?



---

archive/issue_comments_131908.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@simon-king-jena](#comment:39):\n> How else could one test that `__dealloc__` works?\n\nBy Sage not crashing upon exit.  I don't see any other way here.",
    "created_at": "2011-12-28T23:20:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131908",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@simon-king-jena](#comment:39):
> How else could one test that `__dealloc__` works?

By Sage not crashing upon exit.  I don't see any other way here.



---

archive/issue_comments_131909.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@jdemeyer](#comment:40):\n> Replying to [@simon-king-jena](#comment:39):\n> > How else could one test that `__dealloc__` works?\n\n> By Sage not crashing upon exit.  I don't see any other way here.\n\nOK. I just thought Sage has a 100% doctest policy.",
    "created_at": "2011-12-28T23:26:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131909",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@jdemeyer](#comment:40):
> Replying to [@simon-king-jena](#comment:39):
> > How else could one test that `__dealloc__` works?

> By Sage not crashing upon exit.  I don't see any other way here.

OK. I just thought Sage has a 100% doctest policy.



---

archive/issue_comments_131910.json:
```json
{
    "body": "Changed work issues from **segfaults for elliptic curves** to **fix it...**",
    "created_at": "2012-01-11T17:43:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131910",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **segfaults for elliptic curves** to **fix it...**



---

archive/issue_comments_131911.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nWith sage-5.0.prealpha0 plus #11780 plus #715 plus #11521 plus #12290, all tests pass. But if one adds the two patches from here, one gets\n\n```\n        sage -t  -force_lib devel/sage/sage/combinat/combinatorial_algebra.py # 4 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/partition.py # 3 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/kschur.py # 17 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/sfa.py # 284 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/macdonald.py # 107 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/hall_littlewood.py # 61 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/llt.py # 50 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/monomial.py # 16 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/orthotriang.py # 25 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/elementary.py # 9 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/homogeneous.py # 9 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/dual.py # 87 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/schur.py # 13 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/ns_macdonald.py # 2 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/powersum.py # 17 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/classical.py # 9 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/sf/jack.py # 35 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/product_species.py # 1 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/composition_species.py # 2 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/functorial_composition_species.py # 3 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/generating_series.py # 44 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/library.py # 4 doctests failed\n        sage -t  -force_lib devel/sage/sage/combinat/species/species.py # 2 doctests failed\n        sage -t  -force_lib devel/sage/sage/libs/pari/gen.pyx # Killed/crashed\n```\n\nHopefully most of these errors have a common root.",
    "created_at": "2012-01-11T17:43:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131911",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:42" align="right">comment:42</div>

With sage-5.0.prealpha0 plus #11780 plus #715 plus #11521 plus #12290, all tests pass. But if one adds the two patches from here, one gets

```
        sage -t  -force_lib devel/sage/sage/combinat/combinatorial_algebra.py # 4 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/partition.py # 3 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/kschur.py # 17 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/sfa.py # 284 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/macdonald.py # 107 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/hall_littlewood.py # 61 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/llt.py # 50 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/monomial.py # 16 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/orthotriang.py # 25 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/elementary.py # 9 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/homogeneous.py # 9 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/dual.py # 87 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/schur.py # 13 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/ns_macdonald.py # 2 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/powersum.py # 17 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/classical.py # 9 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/sf/jack.py # 35 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/product_species.py # 1 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/composition_species.py # 2 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/functorial_composition_species.py # 3 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/generating_series.py # 44 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/library.py # 4 doctests failed
        sage -t  -force_lib devel/sage/sage/combinat/species/species.py # 2 doctests failed
        sage -t  -force_lib devel/sage/sage/libs/pari/gen.pyx # Killed/crashed
```

Hopefully most of these errors have a common root.



---

archive/issue_comments_131912.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nIt seems that a good deal of the errors comes from a method `sage.combinat.sf.sf.SymmetricFunctions.register_isomorphism`: It registers a coercion, but this is only possible when no coercion has been established for that object before.\n\nWhat should one do: Catch the error and 'not'' registering the coercion? Or wipe the registered coercions, by calling `sage.structure.parent.Parent.unset_coercions_used`?",
    "created_at": "2012-01-12T11:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131912",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:43" align="right">comment:43</div>

It seems that a good deal of the errors comes from a method `sage.combinat.sf.sf.SymmetricFunctions.register_isomorphism`: It registers a coercion, but this is only possible when no coercion has been established for that object before.

What should one do: Catch the error and 'not'' registering the coercion? Or wipe the registered coercions, by calling `sage.structure.parent.Parent.unset_coercions_used`?



---

archive/issue_comments_131913.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nI have to slightly modify my preceding statement. The error is raised not if there has been established a coercion for that object before, but if there has been a coercion registered between the *two* objects before. Anyway, the problem remains the same.",
    "created_at": "2012-01-12T11:43:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131913",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:44" align="right">comment:44</div>

I have to slightly modify my preceding statement. The error is raised not if there has been established a coercion for that object before, but if there has been a coercion registered between the *two* objects before. Anyway, the problem remains the same.



---

archive/issue_comments_131914.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nHere is a very short example triggering the error:\n\n```\nsage: P = JackPolynomialsP(QQ,1)\nsage: P([2,1])^2\n```\n\nHopefully this is short enough for debugging - I find it quite mysterious, so far.",
    "created_at": "2012-01-12T13:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131914",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:45" align="right">comment:45</div>

Here is a very short example triggering the error:

```
sage: P = JackPolynomialsP(QQ,1)
sage: P([2,1])^2
```

Hopefully this is short enough for debugging - I find it quite mysterious, so far.



---

archive/issue_comments_131915.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nSomething else is interesting: The error changes when repeating it.\n\n```\nsage: P = JackPolynomialsP(QQ,1)\nsage: p = P([2,1])\nsage: p^2\nERROR: An unexpected error occurred while tokenizing input\nThe following traceback may be corrupted or invalid\nThe error message is: ('EOF in multi-line statement', (56, 0))\n\nERROR: Internal Python error in the inspect module.\nBelow is the traceback from this internal error.\n\nTraceback (most recent call last):\n...\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/combinat/sf/sf.pyc in register_isomorphism(self, morphism)\n    324         mathematically wrong, as above. Use with care!\n    325         \"\"\"\n--> 326         morphism.codomain().register_coercion(morphism)\n    327 \n    328     _shorthands = set(['e', 'h', 'm', 'p', 's'])\n\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.register_coercion (sage/structure/parent.c:11955)()\n\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.register_coercion (sage/structure/parent.c:11889)()\n\nAssertionError: coercion from Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis to Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis already registered or discovered\nsage: p^2\nERROR: An unexpected error occurred while tokenizing input\nThe following traceback may be corrupted or invalid\nThe error message is: ('EOF in multi-line statement', (56, 0))\n\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n...\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.pyc in _from_cache(self, element, cache_function, cache_dict, **subs_dict)\n    631             if sum(part) not in cache_dict:\n    632                 cache_function(sum(part))\n--> 633             for part2, c2 in cache_dict[sum(part)][part].iteritems():\n    634                 c3 = c*c2\n    635                 if hasattr(c3,'subs'): # c3 may be in the base ring\n\nKeyError: [2, 1]\n```\n\nCc to the author of sage/combinat/sf/jack.py.",
    "created_at": "2012-01-12T13:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131915",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:46" align="right">comment:46</div>

Something else is interesting: The error changes when repeating it.

```
sage: P = JackPolynomialsP(QQ,1)
sage: p = P([2,1])
sage: p^2
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (56, 0))

ERROR: Internal Python error in the inspect module.
Below is the traceback from this internal error.

Traceback (most recent call last):
...
/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/combinat/sf/sf.pyc in register_isomorphism(self, morphism)
    324         mathematically wrong, as above. Use with care!
    325         """
--> 326         morphism.codomain().register_coercion(morphism)
    327 
    328     _shorthands = set(['e', 'h', 'm', 'p', 's'])

/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.register_coercion (sage/structure/parent.c:11955)()

/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.register_coercion (sage/structure/parent.c:11889)()

AssertionError: coercion from Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis to Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis already registered or discovered
sage: p^2
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (56, 0))

---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
...
/home/simon/SAGE/sage-5.0.prealpha0/local/lib/python2.7/site-packages/sage/combinat/sf/sfa.pyc in _from_cache(self, element, cache_function, cache_dict, **subs_dict)
    631             if sum(part) not in cache_dict:
    632                 cache_function(sum(part))
--> 633             for part2, c2 in cache_dict[sum(part)][part].iteritems():
    634                 c3 = c*c2
    635                 if hasattr(c3,'subs'): # c3 may be in the base ring

KeyError: [2, 1]
```

Cc to the author of sage/combinat/sf/jack.py.



---

archive/issue_comments_131916.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nI inserted some print statement into the `register_isomorphism` method of symmetric functions. I found that with *or* without the patch, the isomorphisms are registered both during initialisation of the `JackPolynomialsP` *and* before raising an element to a power for the first time:\n\n```\nsage: P = JackPolynomialsP(QQ,1)\nregistering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis\nsage: p = P([2,1])\nsage: p^2\nregistering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis\nregistering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis\nJackP[2, 2, 1, 1] + JackP[2, 2, 2] + JackP[3, 1, 1, 1] + 2*JackP[3, 2, 1] + JackP[3, 3] + JackP[4, 1, 1] + JackP[4, 2]\nsage: p^2\nJackP[2, 2, 1, 1] + JackP[2, 2, 2] + JackP[3, 1, 1, 1] + 2*JackP[3, 2, 1] + JackP[3, 3] + JackP[4, 1, 1] + JackP[4, 2]\n```\n\nThis gives rise to some questions:\n\n* Why are the symmetric functions registering the isomorphisms *twice*, even without my patch?\n* Why is there no error without my patch? There should be, since double-registration of a coercion is illegal!\n\nI guess, the best solution would be to address the first question: Registering the same thing twice is a waste or resources anyway.",
    "created_at": "2012-01-12T13:58:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131916",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:47" align="right">comment:47</div>

I inserted some print statement into the `register_isomorphism` method of symmetric functions. I found that with *or* without the patch, the isomorphisms are registered both during initialisation of the `JackPolynomialsP` *and* before raising an element to a power for the first time:

```
sage: P = JackPolynomialsP(QQ,1)
registering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Power symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Schur symmetric functions as basis
registering Symmetric Function Algebra over Rational Field, Power symmetric functions as basis  TO  Symmetric Function Algebra over Rational Field, Monomial symmetric functions as basis
sage: p = P([2,1])
sage: p^2
registering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Elementary symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Homogeneous symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Schur symmetric functions as basis
registering Symmetric Function Algebra over Integer Ring, Power symmetric functions as basis  TO  Symmetric Function Algebra over Integer Ring, Monomial symmetric functions as basis
JackP[2, 2, 1, 1] + JackP[2, 2, 2] + JackP[3, 1, 1, 1] + 2*JackP[3, 2, 1] + JackP[3, 3] + JackP[4, 1, 1] + JackP[4, 2]
sage: p^2
JackP[2, 2, 1, 1] + JackP[2, 2, 2] + JackP[3, 1, 1, 1] + 2*JackP[3, 2, 1] + JackP[3, 3] + JackP[4, 1, 1] + JackP[4, 2]
```

This gives rise to some questions:

* Why are the symmetric functions registering the isomorphisms *twice*, even without my patch?
* Why is there no error without my patch? There should be, since double-registration of a coercion is illegal!

I guess, the best solution would be to address the first question: Registering the same thing twice is a waste or resources anyway.



---

archive/issue_comments_131917.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nSorry, I was mistaken! It is not two times the same! The first time it is over the rational field, the second time over the integer ring. So, forget my previous questions.",
    "created_at": "2012-01-12T14:00:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131917",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:48" align="right">comment:48</div>

Sorry, I was mistaken! It is not two times the same! The first time it is over the rational field, the second time over the integer ring. So, forget my previous questions.



---

archive/issue_comments_131918.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nNow I understand the problem:\n\n`SymmetricFunctions` is a subclass of `UniqueRepresentation`. By my patch, `UniqueRepresentation` is using weak references. Apparently `SymmetricFunctions` therefore can be garbage collected, but - and now comes the strange point - the coercion system still recalls that a coercion to them has already been registered.\n\nAnyway, with my patch, `SymmetricFunctions(ZZ)` and SymmetricFunctions(QQ)` are created repeatedly, and that's bad.",
    "created_at": "2012-01-12T14:19:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131918",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:49" align="right">comment:49</div>

Now I understand the problem:

`SymmetricFunctions` is a subclass of `UniqueRepresentation`. By my patch, `UniqueRepresentation` is using weak references. Apparently `SymmetricFunctions` therefore can be garbage collected, but - and now comes the strange point - the coercion system still recalls that a coercion to them has already been registered.

Anyway, with my patch, `SymmetricFunctions(ZZ)` and SymmetricFunctions(QQ)` are created repeatedly, and that's bad.



---

archive/issue_comments_131919.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nI updated the second patch, which should solve the problem!!\n\nFirst of all: The segfault in the tests of sage/libs/pari/gen.pyx was due to my test for the new dealloc method. Following Jeroen's advice, I removed it and stated in the docs that Sage not crashing at exit is an indirect doctest.\n\nThen, all failures in sage/combinat could be fixed by using a *strong* cache for `SymmetricFunctions(...)`. So, I simply overrode the `__classcall__` method inherited from `UniqueRepresentation`.\n\nI just tested that with the new patch all tests in sage/combinat and sage/libs/pari/gen.pyx pass. The others passed even with the old patch version, so that I am confident that they will pass as well (of course, one must try!).",
    "created_at": "2012-01-12T15:14:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131919",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:50" align="right">comment:50</div>

I updated the second patch, which should solve the problem!!

First of all: The segfault in the tests of sage/libs/pari/gen.pyx was due to my test for the new dealloc method. Following Jeroen's advice, I removed it and stated in the docs that Sage not crashing at exit is an indirect doctest.

Then, all failures in sage/combinat could be fixed by using a *strong* cache for `SymmetricFunctions(...)`. So, I simply overrode the `__classcall__` method inherited from `UniqueRepresentation`.

I just tested that with the new patch all tests in sage/combinat and sage/libs/pari/gen.pyx pass. The others passed even with the old patch version, so that I am confident that they will pass as well (of course, one must try!).



---

archive/issue_events_166042.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-12T15:14:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166042"
}
```



---

archive/issue_events_166043.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-12T15:14:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166043"
}
```



---

archive/issue_comments_131920.json:
```json
{
    "body": "Changed work issues from **fix it...** to none",
    "created_at": "2012-01-12T15:14:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131920",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **fix it...** to none



---

archive/issue_comments_131921.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nFWIW, `make ptest` succeeded.",
    "created_at": "2012-01-12T16:33:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131921",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:51" align="right">comment:51</div>

FWIW, `make ptest` succeeded.



---

archive/issue_comments_131922.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nAs I said in my previous post, the tests pass with this patch. The tests also pass with the patch from #12313. However, there are three segfaults that occur when *both* patches are applied. I have difficulties to trace it down.",
    "created_at": "2012-01-19T10:25:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131922",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:52" align="right">comment:52</div>

As I said in my previous post, the tests pass with this patch. The tests also pass with the patch from #12313. However, there are three segfaults that occur when *both* patches are applied. I have difficulties to trace it down.



---

archive/issue_comments_131923.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nCc to Volker, because I expect he has enough knowledge to give me some advice on how I could trace down the following segfault.\n\nWith #12313 and the patch from here, `sage -t -verbose -force_lib \"devel/sage/doc/en/bordeaux_2008/half_integral.rst\"` segfaults. By inspection of the core file, I found that the segfault occurs during deallocation of a functor.\n\nFor debugging, I added a `__dealloc__` method to `sage.categories.functor.Functor` that writes the type and the address of self and of the two cdef attributes `__domain` and `__codomain` to some file. The same is done during initialisation of the functor.\n\nAnd the last lines of the resulting file (before the segfault) are:\n\n```\nDealloc Functor <type 'sage.structure.coerce_actions.LeftModuleAction'> at 71023056\n  Domain <class 'sage.categories.groupoid.Groupoid'> at 75636560\n  Codom. <class 'sage.categories.commutative_rings.CommutativeRings'> at 15429144\nDealloc Functor <type 'sage.structure.coerce_actions.LeftModuleAction'> at 71023056\n  Domain <type 'NoneType'> at 140661532564960\n  Codom. <type 'NoneType'> at 140661532564960\n```\n\nIn other words, the functor is deallocated twice, which is a legitimate reason to segfault.\n\nHow can I find out why Sage tries to deallocate it twice?",
    "created_at": "2012-01-19T10:54:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131923",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:53" align="right">comment:53</div>

Cc to Volker, because I expect he has enough knowledge to give me some advice on how I could trace down the following segfault.

With #12313 and the patch from here, `sage -t -verbose -force_lib "devel/sage/doc/en/bordeaux_2008/half_integral.rst"` segfaults. By inspection of the core file, I found that the segfault occurs during deallocation of a functor.

For debugging, I added a `__dealloc__` method to `sage.categories.functor.Functor` that writes the type and the address of self and of the two cdef attributes `__domain` and `__codomain` to some file. The same is done during initialisation of the functor.

And the last lines of the resulting file (before the segfault) are:

```
Dealloc Functor <type 'sage.structure.coerce_actions.LeftModuleAction'> at 71023056
  Domain <class 'sage.categories.groupoid.Groupoid'> at 75636560
  Codom. <class 'sage.categories.commutative_rings.CommutativeRings'> at 15429144
Dealloc Functor <type 'sage.structure.coerce_actions.LeftModuleAction'> at 71023056
  Domain <type 'NoneType'> at 140661532564960
  Codom. <type 'NoneType'> at 140661532564960
```

In other words, the functor is deallocated twice, which is a legitimate reason to segfault.

How can I find out why Sage tries to deallocate it twice?



---

archive/issue_comments_131924.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nIs it actually being finalized twice? To me, it seems that just the malloc bin was reused for a second `LeftModuleAction` instance. In particular, why would domain and codomain be different in the second destructor call.",
    "created_at": "2012-01-20T03:25:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131924",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:54" align="right">comment:54</div>

Is it actually being finalized twice? To me, it seems that just the malloc bin was reused for a second `LeftModuleAction` instance. In particular, why would domain and codomain be different in the second destructor call.



---

archive/issue_comments_131925.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@vbraun](#comment:54):\n> In particular, why would domain and codomain be different in the second destructor call.\n\nBecause domain and codomain were deleted the first time. The second time, they already are `NoneType`.",
    "created_at": "2012-01-20T06:30:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131925",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@vbraun](#comment:54):
> In particular, why would domain and codomain be different in the second destructor call.

Because domain and codomain were deleted the first time. The second time, they already are `NoneType`.



---

archive/issue_comments_131926.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@vbraun](#comment:54):\n> Is it actually being finalized twice? To me, it seems that just the malloc bin was reused for a second `LeftModuleAction` instance.\n\nAnd I do believe it is the same instance. Namely, if what you say was right, then we should see a call to \"init\" between the two deallocations (I made both init and dealloc write to the same log file). But the two deallocations followed directly: No initialisation and no other deallocation in between.",
    "created_at": "2012-01-20T06:32:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131926",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@vbraun](#comment:54):
> Is it actually being finalized twice? To me, it seems that just the malloc bin was reused for a second `LeftModuleAction` instance.

And I do believe it is the same instance. Namely, if what you say was right, then we should see a call to "init" between the two deallocations (I made both init and dealloc write to the same log file). But the two deallocations followed directly: No initialisation and no other deallocation in between.



---

archive/issue_comments_131927.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nNo progress on my side. For my project, it probably means that I have to pick between two evils: Either live with the memleak that would be fixed in #12313, or live with the memleak that would be fixed here. Bad.",
    "created_at": "2012-01-20T10:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131927",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:57" align="right">comment:57</div>

No progress on my side. For my project, it probably means that I have to pick between two evils: Either live with the memleak that would be fixed in #12313, or live with the memleak that would be fixed here. Bad.



---

archive/issue_events_166044.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T12:57:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166044"
}
```



---

archive/issue_events_166045.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T12:57:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166045"
}
```



---

archive/issue_comments_131928.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nNow that's weird:\n\nWhen I define\n\n```\n    def __dealloc__(self):\n        if self.__domain is not None:\n            Py_INCREF(self.__domain)\n        if self.__codomain is not None:\n            Py_INCREF(self.__codomain)\n```\nfor sage.categories.functor.Functor, then the segfault disappears.\n\nCan this be a solution? It looks weird.",
    "created_at": "2012-01-20T12:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131928",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:58" align="right">comment:58</div>

Now that's weird:

When I define

```
    def __dealloc__(self):
        if self.__domain is not None:
            Py_INCREF(self.__domain)
        if self.__codomain is not None:
            Py_INCREF(self.__codomain)
```
for sage.categories.functor.Functor, then the segfault disappears.

Can this be a solution? It looks weird.



---

archive/issue_events_166046.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T14:01:46Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166046"
}
```



---

archive/issue_events_166047.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T14:01:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166047"
}
```



---

archive/issue_comments_131929.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,9 +14,15 @@\n ```\n Related tickets:\n * #11521 (needs review, introducing weak references for caching homsets), and\n-* #715 (using weak references for caching coerce maps). \n+* #715 (needs review, using weak references for caching coerce maps). \n * #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)\n \n Further notes:\n * not everything in Python can be weakref'ed, for example ``None`` cannot.\n * some results that are expensive to compute should not just be cached by a weak reference. Perhaps there is place for a permanent cache, or maybe some minimal age before garbage collecting it.\n+\n+__Apply__\n+\n+* [attachment: trac12215_weak_cached_function.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function.patch.gz)\n+* [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)\n+\n``````\n",
    "created_at": "2012-01-20T14:27:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131929",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,9 +14,15 @@
 ```
 Related tickets:
 * #11521 (needs review, introducing weak references for caching homsets), and
-* #715 (using weak references for caching coerce maps). 
+* #715 (needs review, using weak references for caching coerce maps). 
 * #5970 (the polynomial rings cache use strong references, which may now be a duplicate, as I introduce the weak cache in #715)
 
 Further notes:
 * not everything in Python can be weakref'ed, for example ``None`` cannot.
 * some results that are expensive to compute should not just be cached by a weak reference. Perhaps there is place for a permanent cache, or maybe some minimal age before garbage collecting it.
+
+__Apply__
+
+* [attachment: trac12215_weak_cached_function.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function.patch.gz)
+* [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)
+
``````




---

archive/issue_comments_131930.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nI have updated the second patch, which was about fixing segfaults anyway.\n\nAs I already stated: I find it weird that the problem is solved by *incrementing* the reference count of the domain and codomain of an action when the action is deallocated. But it works, i.e., the doctests that used to segfault with #12313 and the old version of the patches run fine with the new patch version.\n\nI need an expert opinion, though, and the full test suite is also to be run.\n\nConcerning memleaks, here is the example from the ticket description.\n\nWith #12313 and the patches from here:\n\n```\nsage: import sage.structure.unique_representation\nsage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n135\nsage: \nsage: for i in range(2,1000):\n....:         ring = ZZ.quotient(ZZ(i))\n....:     vectorspace = ring^2\n....: \nsage: import gc\nsage: gc.collect()\n16641\nsage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n227\n```\n\nWith #12313 only:\n\n```\nsage: import sage.structure.unique_representation\nsage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n151\nsage: \nsage: for i in range(2,1000):\n....:         ring = ZZ.quotient(ZZ(i))\n....:     vectorspace = ring^2\n....: \nsage: import gc\nsage: gc.collect()\n3805\nsage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)\n5142\n```\n\nSo, it is a clear progress, and IIRC the patches comprise tests against at least one memory leak that is fixed. Needs review!\n\nApply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-01-20T14:27:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131930",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:60" align="right">comment:60</div>

I have updated the second patch, which was about fixing segfaults anyway.

As I already stated: I find it weird that the problem is solved by *incrementing* the reference count of the domain and codomain of an action when the action is deallocated. But it works, i.e., the doctests that used to segfault with #12313 and the old version of the patches run fine with the new patch version.

I need an expert opinion, though, and the full test suite is also to be run.

Concerning memleaks, here is the example from the ticket description.

With #12313 and the patches from here:

```
sage: import sage.structure.unique_representation
sage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)
135
sage: 
sage: for i in range(2,1000):
....:         ring = ZZ.quotient(ZZ(i))
....:     vectorspace = ring^2
....: 
sage: import gc
sage: gc.collect()
16641
sage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)
227
```

With #12313 only:

```
sage: import sage.structure.unique_representation
sage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)
151
sage: 
sage: for i in range(2,1000):
....:         ring = ZZ.quotient(ZZ(i))
....:     vectorspace = ring^2
....: 
sage: import gc
sage: gc.collect()
3805
sage: len(sage.structure.unique_representation.UniqueRepresentation.__classcall__.cache)
5142
```

So, it is a clear progress, and IIRC the patches comprise tests against at least one memory leak that is fixed. Needs review!

Apply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch



---

archive/issue_events_166048.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T17:46:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166048"
}
```



---

archive/issue_events_166049.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-01-20T17:46:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166049"
}
```



---

archive/issue_comments_131931.json:
```json
{
    "body": "Work Issues: **Fix two tests**",
    "created_at": "2012-01-20T17:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131931",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Fix two tests**



---

archive/issue_comments_131932.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nWith sage-5.0.prealpha0 plus #11780, #11290, #715, #11521, #12313 and the patches from here, make ptest results in\n\n```\n        sage -t  -force_lib devel/sage/sage/combinat/sf/sf.py # 1 doctests failed\n        sage -t  -force_lib devel/sage/sage/categories/category.py # 1 doctests failed\n```\n\nSo, it needs work (because all tests pass when the patches from here are not applied), but it should hopefully be easy to fix.",
    "created_at": "2012-01-20T17:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131932",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:61" align="right">comment:61</div>

With sage-5.0.prealpha0 plus #11780, #11290, #715, #11521, #12313 and the patches from here, make ptest results in

```
        sage -t  -force_lib devel/sage/sage/combinat/sf/sf.py # 1 doctests failed
        sage -t  -force_lib devel/sage/sage/categories/category.py # 1 doctests failed
```

So, it needs work (because all tests pass when the patches from here are not applied), but it should hopefully be easy to fix.



---

archive/issue_comments_131933.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nI tried the following in `cdef class Action`:\n\n```python\n    def __cinit__(self):\n        print 'Action __cinit__ ' + str(id(self))\n\n    def __dealloc__(self):\n        print 'Action __dealloc__ ' + str(id(self))\n```\nthen I do get occasionally reused id (=memory address in CPython), for example\n\n```\n    Action __cinit__ 105376976\n    Action __dealloc__ 105376976\n    Action __cinit__ 105376976\n    Action __dealloc__ 105376976\n```\nBut I don't see any double finalizers without the object being constructed in-between. I also don't get any segfault in `bordeaux_2008/half_integral.rst`.",
    "created_at": "2012-01-20T20:46:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131933",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:62" align="right">comment:62</div>

I tried the following in `cdef class Action`:

```python
    def __cinit__(self):
        print 'Action __cinit__ ' + str(id(self))

    def __dealloc__(self):
        print 'Action __dealloc__ ' + str(id(self))
```
then I do get occasionally reused id (=memory address in CPython), for example

```
    Action __cinit__ 105376976
    Action __dealloc__ 105376976
    Action __cinit__ 105376976
    Action __dealloc__ 105376976
```
But I don't see any double finalizers without the object being constructed in-between. I also don't get any segfault in `bordeaux_2008/half_integral.rst`.



---

archive/issue_comments_131934.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nFor the record, I have these patches applied on top of sage-4.8.rc0:\n\n```\n12221_debug.patch\ntrac_12247_var_construction.patch\n9138_flat.patch\ntrac11900_category_speedup_combined.patch\ntrac11900_only_fix_singleton_hash.patch\ntrac11900_doctest.patch\n11115_flat.patch\ntrac_11115_docfix.patch\ntrac12215_weak_cached_function.patch\ntrac12215_segfault_fixes.patch\n```\nremoved the `Py_INCREF(self.__domain)` and `Py_INCREF(self.__codomain)` bandaid. Still no segfault.",
    "created_at": "2012-01-20T20:51:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131934",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:63" align="right">comment:63</div>

For the record, I have these patches applied on top of sage-4.8.rc0:

```
12221_debug.patch
trac_12247_var_construction.patch
9138_flat.patch
trac11900_category_speedup_combined.patch
trac11900_only_fix_singleton_hash.patch
trac11900_doctest.patch
11115_flat.patch
trac_11115_docfix.patch
trac12215_weak_cached_function.patch
trac12215_segfault_fixes.patch
```
removed the `Py_INCREF(self.__domain)` and `Py_INCREF(self.__codomain)` bandaid. Still no segfault.



---

archive/issue_comments_131935.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@vbraun](#comment:63):\n> For the record, I have these patches applied on top of sage-4.8.rc0:\n> \n> ```\n> 12221_debug.patch\n> trac_12247_var_construction.patch\n> 9138_flat.patch\n> trac11900_category_speedup_combined.patch\n> trac11900_only_fix_singleton_hash.patch\n> trac11900_doctest.patch\n> 11115_flat.patch\n> trac_11115_docfix.patch\n> trac12215_weak_cached_function.patch\n> trac12215_segfault_fixes.patch\n> ```\n> removed the `Py_INCREF(self.__domain)` and `Py_INCREF(self.__codomain)` bandaid. Still no segfault.\n\nSure. As I stated in some post above, the segfault only results when applying both #12313 (hence, its dependency #715 as well) *and* the (old) patches from here.\n\nIf you only have the (old or new) patches from here or only have #715+#12313 then there is no segfault.",
    "created_at": "2012-01-20T22:29:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131935",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@vbraun](#comment:63):
> For the record, I have these patches applied on top of sage-4.8.rc0:
> 
> ```
> 12221_debug.patch
> trac_12247_var_construction.patch
> 9138_flat.patch
> trac11900_category_speedup_combined.patch
> trac11900_only_fix_singleton_hash.patch
> trac11900_doctest.patch
> 11115_flat.patch
> trac_11115_docfix.patch
> trac12215_weak_cached_function.patch
> trac12215_segfault_fixes.patch
> ```
> removed the `Py_INCREF(self.__domain)` and `Py_INCREF(self.__codomain)` bandaid. Still no segfault.

Sure. As I stated in some post above, the segfault only results when applying both #12313 (hence, its dependency #715 as well) *and* the (old) patches from here.

If you only have the (old or new) patches from here or only have #715+#12313 then there is no segfault.



---

archive/issue_comments_131936.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nI ran all doctests and there are a few crashes in `functor.so` elsewhere. I didn't have to apply any additional patches. It dies with\n\n```\nAction __cinit__ 84546128\nAction __dealloc__ 84546128\nAction __cinit__ 84546128\nAction __dealloc__ 84546128\nAction __cinit__ 84628736\nAction __cinit__ 84546128\nAction __dealloc__ 84546128\nAction __dealloc__ 84546128\n/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fcc0db1adf6]\n/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7fcc0db1ae28]\n/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fcc0db1aa76]\n```\nIt seems that its just memory corruption that manifests itself by freeing the object twice. But the error is presumably elsewhere. Also the gdb stack trace is completely corrupted.",
    "created_at": "2012-01-21T00:52:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131936",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:65" align="right">comment:65</div>

I ran all doctests and there are a few crashes in `functor.so` elsewhere. I didn't have to apply any additional patches. It dies with

```
Action __cinit__ 84546128
Action __dealloc__ 84546128
Action __cinit__ 84546128
Action __dealloc__ 84546128
Action __cinit__ 84628736
Action __cinit__ 84546128
Action __dealloc__ 84546128
Action __dealloc__ 84546128
/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fcc0db1adf6]
/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(sigdie+0x14)[0x7fcc0db1ae28]
/home/vbraun/opt/sage-4.8.rc0/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fcc0db1aa76]
```
It seems that its just memory corruption that manifests itself by freeing the object twice. But the error is presumably elsewhere. Also the gdb stack trace is completely corrupted.



---

archive/issue_comments_131937.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nHere is the stack trace: \n\n```\n#0  0x00007ffaadb88511 in __pyx_tp_dealloc_4sage_10categories_7functor_Functor (o=0x63ed250) at sage/categories/functor.c:2845\n#1  0x00007ffaad970cc8 in __pyx_tp_dealloc_4sage_10categories_6action_Action (o=0x63ed250) at sage/categories/action.c:5943\n#2  0x00007ffaad5485a0 in __pyx_tp_dealloc_4sage_9structure_14coerce_actions_ModuleAction (o=0x63ed250) at sage/structure/coerce_actions.c:7505\n#3  0x00007ffabbcf8f0c in type_call (type=<optimized out>, args=0x63e09e0, kwds=0x0) at Objects/typeobject.c:748\n#4  0x00007ffabbca27a3 in PyObject_Call (func=0x7ffaad754ec0, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492\n#5  0x00007ffaad53ffbb in __pyx_pf_4sage_9structure_14coerce_actions_1detect_element_action (__pyx_self=0x0, __pyx_args=0x63fbb40, __pyx_kwds=0x0)\n    at sage/structure/coerce_actions.c:4616\n#6  0x00007ffabbca27a3 in PyObject_Call (func=0x2683dd0, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492\n#7  0x00007ffaaeb0ea32 in __pyx_f_4sage_9structure_6parent_6Parent_discover_action (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, \n    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1) at sage/structure/parent.c:16618\n#8  0x00007ffaaed48057 in __pyx_f_4sage_9structure_10parent_old_6Parent_get_action_c_impl (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, \n    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1) at sage/structure/parent_old.c:3312\n#9  0x00007ffaaed47ea2 in __pyx_pf_4sage_9structure_10parent_old_6Parent_4get_action_impl (__pyx_v_self=0x644ab00, __pyx_args=0x63fb910, \n    __pyx_kwds=0x0) at sage/structure/parent_old.c:3258\n#10 0x00007ffabbca27a3 in PyObject_Call (func=0x636a5a8, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492\n#11 0x00007ffaaed46ee7 in __pyx_f_4sage_9structure_10parent_old_6Parent_get_action_c (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, \n    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1, __pyx_skip_dispatch=0) at sage/structure/parent_old.c:2935\n#12 0x00007ffaaed4f19d in __pyx_f_4sage_9structure_10parent_old_6Parent__get_action_ (__pyx_v_self=0x644ab00, __pyx_v_other=0x6448770, \n    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1, __pyx_skip_dispatch=0) at sage/structure/parent_old.c:6228\n#13 0x00007ffaaeb0b17c in __pyx_f_4sage_9structure_6parent_6Parent_get_action (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, __pyx_skip_dispatch=0, \n    __pyx_optional_args=0x7fff38b8e2f0) at sage/structure/parent.c:15635\n#14 0x00007ffaae1fa2e6 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_discover_action (__pyx_v_self=0x26286d0, __pyx_v_R=0x644ab00, \n    __pyx_v_S=0x6448770, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:12473\n#15 0x00007ffaae1f6564 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_get_action (__pyx_v_self=0x26286d0, __pyx_v_R=0x644ab00, \n    __pyx_v_S=0x6448770, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:11424\n#16 0x00007ffaae1e64e2 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (__pyx_v_self=0x26286d0, __pyx_v_x=0x6354b48, \n    __pyx_v_y=0x63e36b0, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:6583\n#17 0x00007ffaae448f03 in __pyx_pf_4sage_9structure_7element_6Vector_1__mul__ (__pyx_v_left=0x6354b48, __pyx_v_right=0x63e36b0)\n    at sage/structure/element.c:16130\n#18 0x00007ffabbc9dc5f in binary_op1 (v=0x6354b48, w=0x63e36b0, op_slot=16) at Objects/abstract.c:917\n#19 0x00007ffabbca0cc8 in PyNumber_Multiply (v=0x6354b48, w=0x63e36b0) at Objects/abstract.c:1188\n#20 0x00007ffa9be33b68 in __pyx_f_4sage_5rings_13residue_field_12ReductionMap__call_ (__pyx_v_self=0x63f10e8, __pyx_v_x=0x6405108, \n    __pyx_skip_dispatch=0) at sage/rings/residue_field.c:8140\n```\nwithin `coercion_model.bin_op()` (frame 17) there are calls to Python methods (`PyObject_Call`), and in there the garbage collector is free to run. I suspect that this is what is happening somewhere...",
    "created_at": "2012-01-21T01:39:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131937",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:66" align="right">comment:66</div>

Here is the stack trace: 

```
#0  0x00007ffaadb88511 in __pyx_tp_dealloc_4sage_10categories_7functor_Functor (o=0x63ed250) at sage/categories/functor.c:2845
#1  0x00007ffaad970cc8 in __pyx_tp_dealloc_4sage_10categories_6action_Action (o=0x63ed250) at sage/categories/action.c:5943
#2  0x00007ffaad5485a0 in __pyx_tp_dealloc_4sage_9structure_14coerce_actions_ModuleAction (o=0x63ed250) at sage/structure/coerce_actions.c:7505
#3  0x00007ffabbcf8f0c in type_call (type=<optimized out>, args=0x63e09e0, kwds=0x0) at Objects/typeobject.c:748
#4  0x00007ffabbca27a3 in PyObject_Call (func=0x7ffaad754ec0, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492
#5  0x00007ffaad53ffbb in __pyx_pf_4sage_9structure_14coerce_actions_1detect_element_action (__pyx_self=0x0, __pyx_args=0x63fbb40, __pyx_kwds=0x0)
    at sage/structure/coerce_actions.c:4616
#6  0x00007ffabbca27a3 in PyObject_Call (func=0x2683dd0, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492
#7  0x00007ffaaeb0ea32 in __pyx_f_4sage_9structure_6parent_6Parent_discover_action (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, 
    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1) at sage/structure/parent.c:16618
#8  0x00007ffaaed48057 in __pyx_f_4sage_9structure_10parent_old_6Parent_get_action_c_impl (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, 
    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1) at sage/structure/parent_old.c:3312
#9  0x00007ffaaed47ea2 in __pyx_pf_4sage_9structure_10parent_old_6Parent_4get_action_impl (__pyx_v_self=0x644ab00, __pyx_args=0x63fb910, 
    __pyx_kwds=0x0) at sage/structure/parent_old.c:3258
#10 0x00007ffabbca27a3 in PyObject_Call (func=0x636a5a8, arg=<optimized out>, kw=<optimized out>) at Objects/abstract.c:2492
#11 0x00007ffaaed46ee7 in __pyx_f_4sage_9structure_10parent_old_6Parent_get_action_c (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, 
    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1, __pyx_skip_dispatch=0) at sage/structure/parent_old.c:2935
#12 0x00007ffaaed4f19d in __pyx_f_4sage_9structure_10parent_old_6Parent__get_action_ (__pyx_v_self=0x644ab00, __pyx_v_other=0x6448770, 
    __pyx_v_op=0x7ffab525aea8, __pyx_v_self_on_left=1, __pyx_skip_dispatch=0) at sage/structure/parent_old.c:6228
#13 0x00007ffaaeb0b17c in __pyx_f_4sage_9structure_6parent_6Parent_get_action (__pyx_v_self=0x644ab00, __pyx_v_S=0x6448770, __pyx_skip_dispatch=0, 
    __pyx_optional_args=0x7fff38b8e2f0) at sage/structure/parent.c:15635
#14 0x00007ffaae1fa2e6 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_discover_action (__pyx_v_self=0x26286d0, __pyx_v_R=0x644ab00, 
    __pyx_v_S=0x6448770, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:12473
#15 0x00007ffaae1f6564 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_get_action (__pyx_v_self=0x26286d0, __pyx_v_R=0x644ab00, 
    __pyx_v_S=0x6448770, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:11424
#16 0x00007ffaae1e64e2 in __pyx_f_4sage_9structure_6coerce_24CoercionModel_cache_maps_bin_op (__pyx_v_self=0x26286d0, __pyx_v_x=0x6354b48, 
    __pyx_v_y=0x63e36b0, __pyx_v_op=0x7ffab525aea8, __pyx_skip_dispatch=0) at sage/structure/coerce.c:6583
#17 0x00007ffaae448f03 in __pyx_pf_4sage_9structure_7element_6Vector_1__mul__ (__pyx_v_left=0x6354b48, __pyx_v_right=0x63e36b0)
    at sage/structure/element.c:16130
#18 0x00007ffabbc9dc5f in binary_op1 (v=0x6354b48, w=0x63e36b0, op_slot=16) at Objects/abstract.c:917
#19 0x00007ffabbca0cc8 in PyNumber_Multiply (v=0x6354b48, w=0x63e36b0) at Objects/abstract.c:1188
#20 0x00007ffa9be33b68 in __pyx_f_4sage_5rings_13residue_field_12ReductionMap__call_ (__pyx_v_self=0x63f10e8, __pyx_v_x=0x6405108, 
    __pyx_skip_dispatch=0) at sage/rings/residue_field.c:8140
```
within `coercion_model.bin_op()` (frame 17) there are calls to Python methods (`PyObject_Call`), and in there the garbage collector is free to run. I suspect that this is what is happening somewhere...



---

archive/issue_comments_131938.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nReplying to [@vbraun](#comment:65):\n> I ran all doctests and there are a few crashes in `functor.so` elsewhere. I didn't have to apply any additional patches.\n\nWhat exactly do you mean? Do you have the *old* patches from here applied (i.e., without the new `__dealloc__` method), or does the segfault even occur with the *new* patches?\n\nIs it normal that both you and me see segfaults, and it seems to be analogous problems (namely double deallocation), but we see it in different examples and with different patches (namely, even with the *old* patches from here, all tests pass for me)?\n\n> It dies with\n> ...\n> It seems that its just memory corruption that manifests itself by freeing the object twice. \n\nSo, you can confirm that it is the same object.\n\n> But the error is presumably elsewhere. Also the gdb stack trace is completely corrupted.\n\nThat sounds like one should write a complete log of all python code executed - according to your suggestion that the error somewhere occurs during a Python method.",
    "created_at": "2012-01-21T09:47:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131938",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:67" align="right">comment:67</div>

Replying to [@vbraun](#comment:65):
> I ran all doctests and there are a few crashes in `functor.so` elsewhere. I didn't have to apply any additional patches.

What exactly do you mean? Do you have the *old* patches from here applied (i.e., without the new `__dealloc__` method), or does the segfault even occur with the *new* patches?

Is it normal that both you and me see segfaults, and it seems to be analogous problems (namely double deallocation), but we see it in different examples and with different patches (namely, even with the *old* patches from here, all tests pass for me)?

> It dies with
> ...
> It seems that its just memory corruption that manifests itself by freeing the object twice. 

So, you can confirm that it is the same object.

> But the error is presumably elsewhere. Also the gdb stack trace is completely corrupted.

That sounds like one should write a complete log of all python code executed - according to your suggestion that the error somewhere occurs during a Python method.



---

archive/issue_comments_131939.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nHere is some more info on the segfault.\n\nSetting: I have sage-5.0.prealpha0 plus #11780, #11290, #715, #11521, #12313 and the patches from here, removing the `__dealloc__` method introduced by the last patch.\n\nThe segfault is triggered by doing\n\n```\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)\n[]\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fe047add9c6]\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(sigdie+0x14)[0x7fe047add9f8]\n/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fe047add646]\n/lib64/libpthread.so.0(+0xfd00)[0x7fe04cd80d00]\n...\n```\nWhen I revert the lines, that's to say, if I do\n\n```\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)\n[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)\n[]\nsage: quit\nExiting Sage (CPU time 0m2.02s, Wall time 0m20.49s).\n\n**********************************************************************\n\nOops, Sage crashed. We do our best to make it stable, but...\n\nA crash report was automatically generated with the following information:\n  - A verbatim copy of the crash traceback.\n  - A copy of your input history during this session.\n  - Data on your current Sage configuration.\n\nIt was left in the file named:\n        '/home/simon/.sage/ipython/Sage_crash_report.txt'\nIf you can email this file to the developers, the information in it will help\nthem in understanding and correcting the problem.\n\nYou can mail it to: sage-support at sage-support@googlegroups.com\nwith the subject 'Sage Crash Report'.\n\nIf you want to do it now, the following command will work (under Unix):\nmail -s 'Sage Crash Report' sage-support@googlegroups.com < /home/simon/.sage/ipython/Sage_crash_report.txt\n\nTo ensure accurate tracking of this issue, please file a report about it at:\nhttp://trac.sagemath.org/sage_trac\n\nPress enter to exit:\n```\n\nI was tracing all python commands for the first variant of the segfault. The last few lines of the log are as follows:\n\n```\nsage.categories.pushout:__call__:2125         if self.p == other.p:\nsage.categories.pushout:__call__:2126             from sage.all import Infinity\nsage.categories.pushout:__call__:2127             if self.prec == other.prec:\nsage.categories.pushout:__call__:2128                 extras = self.extras.copy()\nsage.categories.pushout:__call__:3102     except CoercionException:\nsage.categories.pushout:__call__:3104     except (TypeError, ValueError, AttributeError, NotImplementedError), ex:\nsage.categories.pushout:__call__:3108         raise CoercionException(ex)\nweakref:__call__:49             self = selfref()\nweakref:__call__:50             if self is not None:\nweakref:__call__:51                 del self.data[wr.key]\nsage.rings.power_series_ring:__call__:556         s = \"Power Series Ring in %s over %s\"%(self.variable_name(), self.base_ring())\nsage.rings.power_series_ring:__call__:557         if self.is_sparse():\nsage.rings.power_series_ring:__call__:562         return self.__is_sparse\nsage.rings.power_series_ring:__call__:559         return s\n```\nSo, indeed it seems that the problem has something to do with weak references. There is an item of a weak value dictionary deleted right before segfaulting.\n\nTo do: Find out what item of what dictionary is deleted, why it is deleted, and how deletion can be prevented.",
    "created_at": "2012-01-22T14:46:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131939",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:68" align="right">comment:68</div>

Here is some more info on the segfault.

Setting: I have sage-5.0.prealpha0 plus #11780, #11290, #715, #11521, #12313 and the patches from here, removing the `__dealloc__` method introduced by the last patch.

The segfault is triggered by doing

```
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)
[]
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)
/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(print_backtrace+0x31)[0x7fe047add9c6]
/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(sigdie+0x14)[0x7fe047add9f8]
/home/simon/SAGE/sage-5.0.prealpha0/local/lib/libcsage.so(sage_signal_handler+0x20c)[0x7fe047add646]
/lib64/libpthread.so.0(+0xfd00)[0x7fe04cd80d00]
...
```
When I revert the lines, that's to say, if I do

```
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)
[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)
[]
sage: quit
Exiting Sage (CPU time 0m2.02s, Wall time 0m20.49s).

**********************************************************************

Oops, Sage crashed. We do our best to make it stable, but...

A crash report was automatically generated with the following information:
  - A verbatim copy of the crash traceback.
  - A copy of your input history during this session.
  - Data on your current Sage configuration.

It was left in the file named:
        '/home/simon/.sage/ipython/Sage_crash_report.txt'
If you can email this file to the developers, the information in it will help
them in understanding and correcting the problem.

You can mail it to: sage-support at sage-support@googlegroups.com
with the subject 'Sage Crash Report'.

If you want to do it now, the following command will work (under Unix):
mail -s 'Sage Crash Report' sage-support@googlegroups.com < /home/simon/.sage/ipython/Sage_crash_report.txt

To ensure accurate tracking of this issue, please file a report about it at:
http://trac.sagemath.org/sage_trac

Press enter to exit:
```

I was tracing all python commands for the first variant of the segfault. The last few lines of the log are as follows:

```
sage.categories.pushout:__call__:2125         if self.p == other.p:
sage.categories.pushout:__call__:2126             from sage.all import Infinity
sage.categories.pushout:__call__:2127             if self.prec == other.prec:
sage.categories.pushout:__call__:2128                 extras = self.extras.copy()
sage.categories.pushout:__call__:3102     except CoercionException:
sage.categories.pushout:__call__:3104     except (TypeError, ValueError, AttributeError, NotImplementedError), ex:
sage.categories.pushout:__call__:3108         raise CoercionException(ex)
weakref:__call__:49             self = selfref()
weakref:__call__:50             if self is not None:
weakref:__call__:51                 del self.data[wr.key]
sage.rings.power_series_ring:__call__:556         s = "Power Series Ring in %s over %s"%(self.variable_name(), self.base_ring())
sage.rings.power_series_ring:__call__:557         if self.is_sparse():
sage.rings.power_series_ring:__call__:562         return self.__is_sparse
sage.rings.power_series_ring:__call__:559         return s
```
So, indeed it seems that the problem has something to do with weak references. There is an item of a weak value dictionary deleted right before segfaulting.

To do: Find out what item of what dictionary is deleted, why it is deleted, and how deletion can be prevented.



---

archive/issue_comments_131940.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nI was also tracing the deletion of items of weak value dictionaries: I was writing the key to a log file whenever an item was deleted.\n\nAlready when starting sage, we see that the same key (and presumably the same value as well) is deleted repeatedly:\n\n```\n...\n((<class 'sage.categories.category.JoinCategory'>, (Category of semirings, Category of infinite enumerated sets)), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Integer Ring), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())\n```\n\nWhen issuing the first line of the crashing example and repeating it, we see something like\n\n```\n...\n((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Cyclotomic Field of order 4 and degree 2), ())\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 0, 0, False), ())\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 10, 0, False), ())\n((5, 0, 'prealpha0'), (Rational Field, 0, False, None))\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 0, 0, False), ())\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 10, 0, False), ())\n```\n\nAnd at crashing, one has\n\n```\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Ring of integers modulo 46337, 4, 10, False), ())\n((<class 'sage.categories.vector_spaces.VectorSpaces'>, Ring of integers modulo 46337), ())\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Integer Ring, 4, 10, False), ())\n((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 4, 10, False), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())\n((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Integer Ring), ())\n```\n\nConclusion:\n\nThe occurring keys indicate that the deletions occur in `UniqueRepresentation`. While using weak references for `UniqueRepresentation` fixes memory leaks, it seems that far too often stuff is removed that would actually still be needed. Certainly it is bad for speed, and it seems that it is also responsible for the segmentation faults.\n\nI am not sure how that problem should best be addressed.",
    "created_at": "2012-01-22T15:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131940",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:69" align="right">comment:69</div>

I was also tracing the deletion of items of weak value dictionaries: I was writing the key to a log file whenever an item was deleted.

Already when starting sage, we see that the same key (and presumably the same value as well) is deleted repeatedly:

```
...
((<class 'sage.categories.category.JoinCategory'>, (Category of semirings, Category of infinite enumerated sets)), ())
((<class 'sage.categories.groupoid.Groupoid'>, Integer Ring), ())
((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Rational Field), ())
```

When issuing the first line of the crashing example and repeating it, we see something like

```
...
((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Complex Lazy Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Cyclotomic Field of order 4 and degree 2), ())
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 0, 0, False), ())
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 10, 0, False), ())
((5, 0, 'prealpha0'), (Rational Field, 0, False, None))
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 0, 0, False), ())
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 10, 0, False), ())
```

And at crashing, one has

```
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Ring of integers modulo 46337, 4, 10, False), ())
((<class 'sage.categories.vector_spaces.VectorSpaces'>, Ring of integers modulo 46337), ())
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Integer Ring, 4, 10, False), ())
((<class 'sage.matrix.matrix_space.MatrixSpace'>, Rational Field, 4, 10, False), ())
((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Rational Field), ())
((<class 'sage.categories.groupoid.Groupoid'>, Power Series Ring in q over Integer Ring), ())
```

Conclusion:

The occurring keys indicate that the deletions occur in `UniqueRepresentation`. While using weak references for `UniqueRepresentation` fixes memory leaks, it seems that far too often stuff is removed that would actually still be needed. Certainly it is bad for speed, and it seems that it is also responsible for the segmentation faults.

I am not sure how that problem should best be addressed.



---

archive/issue_comments_131941.json:
```json
{
    "body": "Changed work issues from **Fix two tests** to **Fix a coercion problem in sage.combinat.sf.sf**",
    "created_at": "2012-03-09T12:33:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131941",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Fix two tests** to **Fix a coercion problem in sage.combinat.sf.sf**



---

archive/issue_comments_131942.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nI think I have not properly stated that with the latest patches applied to sage-5.0.prealpha0, the segfault is gone. However, at least when I also have a couple of other tickets (#11780, #12290, #715. #11521, #12313, #12357, #12351, #7797), I get one coercion error in sage.combinat.sf.sf.\n\nTo be precise, I do not get that error when I only have all the other patches. So, it really seems to be caused by the patches from here. Trying to track it down...",
    "created_at": "2012-03-09T12:33:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131942",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:70" align="right">comment:70</div>

I think I have not properly stated that with the latest patches applied to sage-5.0.prealpha0, the segfault is gone. However, at least when I also have a couple of other tickets (#11780, #12290, #715. #11521, #12313, #12357, #12351, #7797), I get one coercion error in sage.combinat.sf.sf.

To be precise, I do not get that error when I only have all the other patches. So, it really seems to be caused by the patches from here. Trying to track it down...



---

archive/issue_comments_131943.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nThat's odd. The failing test is from the `__call__` method in sage.combinat.sf.sf. When I execute things in the command line, I get the following:\n\n```\nsage: Sym = SymmetricFunctions(QQ[x])\nsage: p = Sym.p(); s = Sym.s()\nsage: P = p[1].parent()\nsage: S = s[1].parent()\nsage: P.coerce_map_from(S)\nGeneric morphism:\n  From: Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Schur symmetric functions as basis\n  To:   Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Power symmetric functions as basis\nsage: S.coerce_map_from(P)\nGeneric morphism:\n  From: Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Power symmetric functions as basis\n  To:   Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Schur symmetric functions as basis\n```\n\nHowever, when the same is executed as a doctest, then *there is no coercion map* between S and P. Could it be that some other doctest is messing with the coercion maps, and my patch (perhaps in combination with #715 and #11521) reveals it?",
    "created_at": "2012-03-09T12:59:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131943",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:71" align="right">comment:71</div>

That's odd. The failing test is from the `__call__` method in sage.combinat.sf.sf. When I execute things in the command line, I get the following:

```
sage: Sym = SymmetricFunctions(QQ[x])
sage: p = Sym.p(); s = Sym.s()
sage: P = p[1].parent()
sage: S = s[1].parent()
sage: P.coerce_map_from(S)
Generic morphism:
  From: Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Schur symmetric functions as basis
  To:   Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Power symmetric functions as basis
sage: S.coerce_map_from(P)
Generic morphism:
  From: Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Power symmetric functions as basis
  To:   Symmetric Function Algebra over Univariate Polynomial Ring in x over Rational Field, Schur symmetric functions as basis
```

However, when the same is executed as a doctest, then *there is no coercion map* between S and P. Could it be that some other doctest is messing with the coercion maps, and my patch (perhaps in combination with #715 and #11521) reveals it?



---

archive/issue_events_166050.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-03-09T15:30:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166050"
}
```



---

archive/issue_events_166051.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-03-09T15:30:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166051"
}
```



---

archive/issue_comments_131944.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nThat's even odder. With #11780, #12290, #715. #11521, #12313, #12357, #12351, #7797 and #12645 (so, adding #12645, which only changes the rst markup in sage/combinat/sf/sf.py), all tests in sage/combinat pass.\n\nAnyway. Since the second patch is in conflict with #12645 anyway, I am rebasing it. Since the doctest error has vanished, I put it back to \"needs review\", even though I wish I knew what was the reason for the temporary problem.",
    "created_at": "2012-03-09T15:30:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131944",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:72" align="right">comment:72</div>

That's even odder. With #11780, #12290, #715. #11521, #12313, #12357, #12351, #7797 and #12645 (so, adding #12645, which only changes the rst markup in sage/combinat/sf/sf.py), all tests in sage/combinat pass.

Anyway. Since the second patch is in conflict with #12645 anyway, I am rebasing it. Since the doctest error has vanished, I put it back to "needs review", even though I wish I knew what was the reason for the temporary problem.



---

archive/issue_comments_131945.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900** to **#11115 #11900 #12645**",
    "created_at": "2012-03-09T15:30:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131945",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900** to **#11115 #11900 #12645**



---

archive/issue_comments_131946.json:
```json
{
    "body": "Changed work issues from **Fix a coercion problem in sage.combinat.sf.sf** to none",
    "created_at": "2012-03-09T15:30:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131946",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Fix a coercion problem in sage.combinat.sf.sf** to none



---

archive/issue_comments_131947.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nBad. Meanwhile I work on top of sage-5.0.beta7. This time, it is the first patch that creates a coercion error in sage/combinat/sf/sf.py. Needs work.",
    "created_at": "2012-03-10T10:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131947",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:73" align="right">comment:73</div>

Bad. Meanwhile I work on top of sage-5.0.beta7. This time, it is the first patch that creates a coercion error in sage/combinat/sf/sf.py. Needs work.



---

archive/issue_comments_131948.json:
```json
{
    "body": "Work Issues: **coercion in symmetric function algebras**",
    "created_at": "2012-03-10T10:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131948",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **coercion in symmetric function algebras**



---

archive/issue_events_166052.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-03-10T10:08:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166052"
}
```



---

archive/issue_events_166053.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-03-10T10:08:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166053"
}
```



---

archive/issue_comments_131949.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nEven worse: After applying related tickets (#715, #11521, #12313, #12357) to sage-5.0.beta13, 16 out of 18 hunks fail to apply. So, I need to find out where the problem comes from.",
    "created_at": "2012-04-15T15:20:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131949",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:74" align="right">comment:74</div>

Even worse: After applying related tickets (#715, #11521, #12313, #12357) to sage-5.0.beta13, 16 out of 18 hunks fail to apply. So, I need to find out where the problem comes from.



---

archive/issue_comments_131950.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645** to **#11115 #11900 #12645 #11599**",
    "created_at": "2012-04-15T15:25:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131950",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645** to **#11115 #11900 #12645 #11599**



---

archive/issue_comments_131951.json:
```json
{
    "body": "Changed work issues from **coercion in symmetric function algebras** to **Rebase wrt #11599. Coercion in symmetric function algebras**",
    "created_at": "2012-04-15T15:25:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131951",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **coercion in symmetric function algebras** to **Rebase wrt #11599. Coercion in symmetric function algebras**



---

archive/issue_comments_131952.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nIt comes from #11599, which fixes the same docstring misformattings that I fix in my patch as well...",
    "created_at": "2012-04-15T15:25:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131952",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:75" align="right">comment:75</div>

It comes from #11599, which fixes the same docstring misformattings that I fix in my patch as well...



---

archive/issue_comments_131953.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nArrgh. With #715, #11521, #12313, #11943, #11935, #12357 and #7797 on top of sage-5.0.beta13, all tests pass. But adding the (rebased) patch from here, I get failures in\n\n```\n        sage -t  -force_lib \"devel/sage/sage/structure/coerce_dict.pyx\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/macdonald.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/llt.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/jack.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/kschur.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/hall_littlewood.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/sfa.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/multiplicative.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/schur.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/species/library.py\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/combinatorial_algebra.py\"\n        sage -t  -force_lib \"devel/sage/sage/categories/homset.py\"\n```\n\nThat's not good.",
    "created_at": "2012-04-15T18:15:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131953",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:76" align="right">comment:76</div>

Arrgh. With #715, #11521, #12313, #11943, #11935, #12357 and #7797 on top of sage-5.0.beta13, all tests pass. But adding the (rebased) patch from here, I get failures in

```
        sage -t  -force_lib "devel/sage/sage/structure/coerce_dict.pyx"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/macdonald.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/llt.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/jack.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/kschur.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/hall_littlewood.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/sfa.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/multiplicative.py"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/schur.py"
        sage -t  -force_lib "devel/sage/sage/combinat/species/library.py"
        sage -t  -force_lib "devel/sage/sage/combinat/combinatorial_algebra.py"
        sage -t  -force_lib "devel/sage/sage/categories/homset.py"
```

That's not good.



---

archive/issue_comments_131954.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nOops, I had only the first of the two patches from here applied. Nevertheless, it doesn't look good.",
    "created_at": "2012-04-15T18:17:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131954",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:77" align="right">comment:77</div>

Oops, I had only the first of the two patches from here applied. Nevertheless, it doesn't look good.



---

archive/issue_comments_131955.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nI have rebased the first patch relative to #11599.\n\nWith both patches, one \"only\" has errors in\n\n```\n        sage -t  -force_lib \"devel/sage/sage/structure/coerce_dict.pyx\"\n        sage -t  -force_lib \"devel/sage/sage/combinat/sf/sf.py\"\n        sage -t  -force_lib \"devel/sage/sage/categories/homset.py\"\n```\n\nSo, it still needs work, but it is less bad than I thought...\n\nApply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-04-15T21:42:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131955",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:78" align="right">comment:78</div>

I have rebased the first patch relative to #11599.

With both patches, one "only" has errors in

```
        sage -t  -force_lib "devel/sage/sage/structure/coerce_dict.pyx"
        sage -t  -force_lib "devel/sage/sage/combinat/sf/sf.py"
        sage -t  -force_lib "devel/sage/sage/categories/homset.py"
```

So, it still needs work, but it is less bad than I thought...

Apply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_131956.json:
```json
{
    "body": "Changed work issues from **Rebase wrt #11599. Coercion in symmetric function algebras** to **Coercion in symmetric function algebras**",
    "created_at": "2012-04-15T21:42:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131956",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Rebase wrt #11599. Coercion in symmetric function algebras** to **Coercion in symmetric function algebras**



---

archive/issue_comments_131957.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nA bit more detail: The tests in coerce_dict.pyx and homset.py fail even if only the first patch is applied. But the tests in sf.py pass if only the first patch is applied.",
    "created_at": "2012-04-16T17:33:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131957",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:79" align="right">comment:79</div>

A bit more detail: The tests in coerce_dict.pyx and homset.py fail even if only the first patch is applied. But the tests in sf.py pass if only the first patch is applied.



---

archive/issue_comments_131958.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nI tested whether the problem comes from the combination of this ticket with #12357. But it turns out that the following test\n\n```\n        sage: K = GF(1<<55,'t')\n        sage: for i in range(50):\n        ...     a = K.random_element()\n        ...     E = EllipticCurve(j=a)\n        ...     P = E.random_point()\n        ...     Q = 2*P\n        sage: import gc\n        sage: n = gc.collect()\n        sage: from sage.schemes.elliptic_curves.ell_finite_field import EllipticCurve_finite_field\n        sage: LE = [x for x in gc.get_objects() if isinstance(x, EllipticCurve_finite_field)]\n        sage: len(LE)    # indirect doctest\n        1\n```\nstill fails. The test has been introduced in #12313. And of course it is not acceptable that #12313 makes a memory leak disappear, but #12215 makes it show up again.",
    "created_at": "2012-04-17T10:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131958",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:80" align="right">comment:80</div>

I tested whether the problem comes from the combination of this ticket with #12357. But it turns out that the following test

```
        sage: K = GF(1<<55,'t')
        sage: for i in range(50):
        ...     a = K.random_element()
        ...     E = EllipticCurve(j=a)
        ...     P = E.random_point()
        ...     Q = 2*P
        sage: import gc
        sage: n = gc.collect()
        sage: from sage.schemes.elliptic_curves.ell_finite_field import EllipticCurve_finite_field
        sage: LE = [x for x in gc.get_objects() if isinstance(x, EllipticCurve_finite_field)]
        sage: len(LE)    # indirect doctest
        1
```
still fails. The test has been introduced in #12313. And of course it is not acceptable that #12313 makes a memory leak disappear, but #12215 makes it show up again.



---

archive/issue_comments_131959.json:
```json
{
    "body": "Changed work issues from **Coercion in symmetric function algebras** to **Keep the fix from #12313. Coercion in symmetric function algebras**",
    "created_at": "2012-04-17T10:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131959",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Coercion in symmetric function algebras** to **Keep the fix from #12313. Coercion in symmetric function algebras**



---

archive/issue_comments_131960.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nI think I located the problem. By some patch, I had introduced a weak dictionary in sage.structure.factory. But somehow I managed to remove the corresponding hunk from the patch. Now, I need to find out where that has happened...",
    "created_at": "2012-04-17T10:16:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131960",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:81" align="right">comment:81</div>

I think I located the problem. By some patch, I had introduced a weak dictionary in sage.structure.factory. But somehow I managed to remove the corresponding hunk from the patch. Now, I need to find out where that has happened...



---

archive/issue_comments_131961.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nAha! It turns out that I introduced the `WeakValueDictionary` in the first patch from here, but somehow I managed to delete it. Now the leak remains fixed, the patch is updated.\n\nApply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-04-17T10:22:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131961",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:82" align="right">comment:82</div>

Aha! It turns out that I introduced the `WeakValueDictionary` in the first patch from here, but somehow I managed to delete it. Now the leak remains fixed, the patch is updated.

Apply trac12215_weak_cached_function.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_131962.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nWith the updated version of the first patch (applied on top of #715, #11521, #12313, #11943 and #11935), the tests in sage/structure/coerce_dict and sage/categories/homset pass.\n\nThere remains the problem with symmetric functions, but this is due to the second patch...",
    "created_at": "2012-04-17T10:25:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131962",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:83" align="right">comment:83</div>

With the updated version of the first patch (applied on top of #715, #11521, #12313, #11943 and #11935), the tests in sage/structure/coerce_dict and sage/categories/homset pass.

There remains the problem with symmetric functions, but this is due to the second patch...



---

archive/issue_comments_131963.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nWhat exactly is the problem?\n\nIt is\n\n```\n            sage: S = SymmetricFunctions(ZZ)\n            sage: S.inject_shorthands()\n            doctest:...: RuntimeWarning: redefining global value `e`\n            doctest:...: RuntimeWarning: redefining global value `m`\n            sage: s[1] + e[2] * p[1,1] + 2*h[3] + m[2,1]\n            s[1] - 2*s[1, 1, 1] + s[1, 1, 1, 1] + s[2, 1] + 2*s[2, 1, 1] + s[2, 2] + 2*s[3] + s[3, 1]\n```\nThe last line fails with an error when doctesting, but works fine when doing the same in an interactive session.",
    "created_at": "2012-04-17T10:34:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131963",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:84" align="right">comment:84</div>

What exactly is the problem?

It is

```
            sage: S = SymmetricFunctions(ZZ)
            sage: S.inject_shorthands()
            doctest:...: RuntimeWarning: redefining global value `e`
            doctest:...: RuntimeWarning: redefining global value `m`
            sage: s[1] + e[2] * p[1,1] + 2*h[3] + m[2,1]
            s[1] - 2*s[1, 1, 1] + s[1, 1, 1, 1] + s[2, 1] + 2*s[2, 1, 1] + s[2, 2] + 2*s[3] + s[3, 1]
```
The last line fails with an error when doctesting, but works fine when doing the same in an interactive session.



---

archive/issue_events_166054.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2012-04-17T10:34:22Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "subject": "https://github.com/simon-king-jena",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166054"
}
```



---

archive/issue_comments_131964.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nThe failure is really strange. If one does\n\n```\nsage: S = SymmetricFunctions(ZZ)\nsage: S.inject_shorthands()\nsage: e.has_coerce_map_from(m)\n```\non the command line, then one gets the answer \"True\". Doing the same in a *separate* doctest, one still gets \"True\". But doing the same in line 384 of sage.combinat.sf.sf.py, one gets \"False\". So, there seems to be a nasty diffcult-to-debug side effect, which apparently was introduced by the second patch.",
    "created_at": "2012-04-17T10:59:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131964",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:85" align="right">comment:85</div>

The failure is really strange. If one does

```
sage: S = SymmetricFunctions(ZZ)
sage: S.inject_shorthands()
sage: e.has_coerce_map_from(m)
```
on the command line, then one gets the answer "True". Doing the same in a *separate* doctest, one still gets "True". But doing the same in line 384 of sage.combinat.sf.sf.py, one gets "False". So, there seems to be a nasty diffcult-to-debug side effect, which apparently was introduced by the second patch.



---

archive/issue_comments_131965.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nThe error disappears if one does not override that `__classcall__` method of symmetric function algebras. However, by the first ticket, it uses a weak cache, which results in many errors elsewhere...\n\nBut if I recall correctly, there has been a recent ticket dealing with coercion for symmetric functions. Perhaps a miracle occurs and the strongly cached custom `__classcall__` can be cancelled (count the words that start with \"c\"...)?",
    "created_at": "2012-04-17T11:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131965",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:86" align="right">comment:86</div>

The error disappears if one does not override that `__classcall__` method of symmetric function algebras. However, by the first ticket, it uses a weak cache, which results in many errors elsewhere...

But if I recall correctly, there has been a recent ticket dealing with coercion for symmetric functions. Perhaps a miracle occurs and the strongly cached custom `__classcall__` can be cancelled (count the words that start with "c"...)?



---

archive/issue_comments_131966.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nHow unfortunate. If I remove the custom (strongly cached) `__classcall__` of symmetric function algebras, I get\n\n```\nThe following tests failed:\n\n\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/macdonald.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/llt.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/jack.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/kschur.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/hall_littlewood.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/classical.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/sfa.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/elementary.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/multiplicative.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/schur.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/sf/homogeneous.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/species/library.py\"\n\tsage -t  -force_lib \"devel/sage/sage/combinat/combinatorial_algebra.py\"\n```\nBut if one has a custom strong cache for symmetric function algebras, then one has the single failure in\n\n```\n\tsage -t -force_lib \"devel/sage/sage/combinat/sf/sf.py\"\n```",
    "created_at": "2012-04-17T12:45:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131966",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:87" align="right">comment:87</div>

How unfortunate. If I remove the custom (strongly cached) `__classcall__` of symmetric function algebras, I get

```
The following tests failed:


	sage -t  -force_lib "devel/sage/sage/combinat/sf/macdonald.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/llt.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/jack.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/kschur.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/hall_littlewood.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/classical.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/sfa.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/elementary.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/multiplicative.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/schur.py"
	sage -t  -force_lib "devel/sage/sage/combinat/sf/homogeneous.py"
	sage -t  -force_lib "devel/sage/sage/combinat/species/library.py"
	sage -t  -force_lib "devel/sage/sage/combinat/combinatorial_algebra.py"
```
But if one has a custom strong cache for symmetric function algebras, then one has the single failure in

```
	sage -t -force_lib "devel/sage/sage/combinat/sf/sf.py"
```



---

archive/issue_comments_131967.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nHooray! It turns out that one can fix the failing doctest in sf.py by not only providing a strongly cached `sf.SymmetricFunctions.__classcall__`, but by additionally providing a strongly cached `sfa.SymmetricFunctionAlgebra_generic.__classcall__`.\n\nIt is a bit unfortunate that a strong cache creeps back in, but apparently the assumption of strong caching is extensively used in sage.combinat.sf. Having weakly cached unique representation everywhere except in sage.combinat.sf is at least something...\n\nI am now running the full testsuite with the new modification.",
    "created_at": "2012-04-17T14:16:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131967",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:88" align="right">comment:88</div>

Hooray! It turns out that one can fix the failing doctest in sf.py by not only providing a strongly cached `sf.SymmetricFunctions.__classcall__`, but by additionally providing a strongly cached `sfa.SymmetricFunctionAlgebra_generic.__classcall__`.

It is a bit unfortunate that a strong cache creeps back in, but apparently the assumption of strong caching is extensively used in sage.combinat.sf. Having weakly cached unique representation everywhere except in sage.combinat.sf is at least something...

I am now running the full testsuite with the new modification.



---

archive/issue_comments_131968.json:
```json
{
    "body": "<div id=\"comment:89\" align=\"right\">comment:89</div>\n\nNow the second patch has been updated as well. As I have announced, the second patch is now not only introducing a strong custom cache for `SymmetricFunctions`, but also for the different representations, i.e., for `SymmetricFunctionAlgebra_generic`. It is certainly not ideal that symmetric functions need to be strongly cached, but I think that there may be a different ticket to resolve this special case.\n\nAnyway, with sage-5.0.beta13 plus #715, #11521, #12313, #11943, #11935 and the two patches from here, all doctests pass. I am confident that they would also pass when one only has 5.0.beta13 plus the two patches from here.\n\nNeeds review, then!",
    "created_at": "2012-04-17T15:52:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131968",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:89" align="right">comment:89</div>

Now the second patch has been updated as well. As I have announced, the second patch is now not only introducing a strong custom cache for `SymmetricFunctions`, but also for the different representations, i.e., for `SymmetricFunctionAlgebra_generic`. It is certainly not ideal that symmetric functions need to be strongly cached, but I think that there may be a different ticket to resolve this special case.

Anyway, with sage-5.0.beta13 plus #715, #11521, #12313, #11943, #11935 and the two patches from here, all doctests pass. I am confident that they would also pass when one only has 5.0.beta13 plus the two patches from here.

Needs review, then!



---

archive/issue_events_166055.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-17T15:52:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166055"
}
```



---

archive/issue_events_166056.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-17T15:52:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166056"
}
```



---

archive/issue_comments_131969.json:
```json
{
    "body": "Changed work issues from **Keep the fix from #12313. Coercion in symmetric function algebras** to none",
    "created_at": "2012-04-17T15:52:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131969",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Keep the fix from #12313. Coercion in symmetric function algebras** to none



---

archive/issue_events_166057.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-30T13:25:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166057"
}
```



---

archive/issue_events_166058.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-04-30T13:25:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166058"
}
```



---

archive/issue_comments_131970.json:
```json
{
    "body": "Work Issues: **rebase wrt #12808**",
    "created_at": "2012-04-30T13:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131970",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **rebase wrt #12808**



---

archive/issue_comments_131971.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599** to **#11115 #11900 #12645 #11599 #12215**",
    "created_at": "2012-04-30T13:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131971",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599** to **#11115 #11900 #12645 #11599 #12215**



---

archive/issue_comments_131972.json:
```json
{
    "body": "<div id=\"comment:90\" align=\"right\">comment:90</div>\n\nThere is a conflict with #12808, which has a positive review. Hence, we need to rebase it!",
    "created_at": "2012-04-30T13:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131972",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:90" align="right">comment:90</div>

There is a conflict with #12808, which has a positive review. Hence, we need to rebase it!



---

archive/issue_comments_131973.json:
```json
{
    "body": "<div id=\"comment:91\" align=\"right\">comment:91</div>\n\nReplying to [@simon-king-jena](#comment:90):\n> There is a conflict with #12808, which has a positive review. Hence, we need to rebase it!\n\n(Trivial) rebase done in the updated patch (at the end of the day, I needed it urgently, so I just took over the task).",
    "created_at": "2012-05-01T21:22:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131973",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:91" align="right">comment:91</div>

Replying to [@simon-king-jena](#comment:90):
> There is a conflict with #12808, which has a positive review. Hence, we need to rebase it!

(Trivial) rebase done in the updated patch (at the end of the day, I needed it urgently, so I just took over the task).



---

archive/issue_comments_131974.json:
```json
{
    "body": "Changed work issues from **rebase wrt #12808** to none",
    "created_at": "2012-05-02T08:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131974",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **rebase wrt #12808** to none



---

archive/issue_comments_131975.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599 #12215** to **#11115 #11900 #12645 #11599 #12808**",
    "created_at": "2012-05-02T08:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131975",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599 #12215** to **#11115 #11900 #12645 #11599 #12808**



---

archive/issue_comments_131976.json:
```json
{
    "body": "<div id=\"comment:92\" align=\"right\">comment:92</div>\n\nThank you, Nicolas! I planned to do the change today.",
    "created_at": "2012-05-02T08:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131976",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:92" align="right">comment:92</div>

Thank you, Nicolas! I planned to do the change today.



---

archive/issue_events_166059.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-05-02T08:57:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166059"
}
```



---

archive/issue_events_166060.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-05-02T08:57:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166060"
}
```



---

archive/issue_comments_131977.json:
```json
{
    "body": "<div id=\"comment:93\" align=\"right\">comment:93</div>\n\n... and I guess it needs review, again?",
    "created_at": "2012-05-02T08:57:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131977",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:93" align="right">comment:93</div>

... and I guess it needs review, again?



---

archive/issue_comments_131978.json:
```json
{
    "body": "<div id=\"comment:94\" align=\"right\">comment:94</div>\n\nAnne mentioned on combinat-devel that the patch needs to be rebased because of #7980.",
    "created_at": "2012-07-16T21:26:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131978",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:94" align="right">comment:94</div>

Anne mentioned on combinat-devel that the patch needs to be rebased because of #7980.



---

archive/issue_comments_131979.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599 #12808** to **#11115 #11900 #12645 #11599 #12808 #7980**",
    "created_at": "2012-07-16T21:26:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131979",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599 #12808** to **#11115 #11900 #12645 #11599 #12808 #7980**



---

archive/issue_comments_131980.json:
```json
{
    "body": "Work Issues: **Rebase wrt #7980**",
    "created_at": "2012-07-16T21:26:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131980",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Rebase wrt #7980**



---

archive/issue_events_166061.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-07-16T21:26:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166061"
}
```



---

archive/issue_events_166062.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-07-16T21:26:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166062"
}
```



---

archive/issue_comments_131981.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,6 +23,6 @@\n \n __Apply__\n \n-* [attachment: trac12215_weak_cached_function.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function.patch.gz)\n+* [attachment: trac12215_weak_cached_function-sk.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function-sk.patch.gz)\n * [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)\n \n``````\n",
    "created_at": "2012-07-23T12:16:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131981",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,6 +23,6 @@
 
 __Apply__
 
-* [attachment: trac12215_weak_cached_function.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function.patch.gz)
+* [attachment: trac12215_weak_cached_function-sk.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function-sk.patch.gz)
 * [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)
 
``````




---

archive/issue_comments_131982.json:
```json
{
    "body": "<div id=\"comment:95\" align=\"right\">comment:95</div>\n\nThe patches are now rebased rel #7980. I have not been able to replace my first patch, because trac believes that it isn't my patch but Nicolas'...\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-07-23T12:16:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131982",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:95" align="right">comment:95</div>

The patches are now rebased rel #7980. I have not been able to replace my first patch, because trac believes that it isn't my patch but Nicolas'...

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_events_166063.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-07-23T12:16:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166063"
}
```



---

archive/issue_events_166064.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-07-23T12:16:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166064"
}
```



---

archive/issue_comments_131983.json:
```json
{
    "body": "Changed work issues from **Rebase wrt #7980** to none",
    "created_at": "2012-07-23T12:16:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131983",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Rebase wrt #7980** to none



---

archive/issue_comments_131984.json:
```json
{
    "body": "<div id=\"comment:97\" align=\"right\">comment:97</div>\n\nI don't know how, but I managed to mess up the patch. Now it should work.\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-07-23T12:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131984",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:97" align="right">comment:97</div>

I don't know how, but I managed to mess up the patch. Now it should work.

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_131985.json:
```json
{
    "body": "<div id=\"comment:98\" align=\"right\">comment:98</div>\n\nWhen applying\n\n```\ntrac12969_fix_coercion_cache.patch\ntrac12215_weak_cached_function-sk.patch\ntrac12215_segfault_fixes.patch\ntrac_715_combined.patch\ntrac_11521_homset_weakcache_combined.patch\ntrac_12313-mono_dict-combined-random-sk.patch\n```\non top of sage-5.2.rc0, all tests on bsd.math pass.",
    "created_at": "2012-07-23T14:55:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131985",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:98" align="right">comment:98</div>

When applying

```
trac12969_fix_coercion_cache.patch
trac12215_weak_cached_function-sk.patch
trac12215_segfault_fixes.patch
trac_715_combined.patch
trac_11521_homset_weakcache_combined.patch
trac_12313-mono_dict-combined-random-sk.patch
```
on top of sage-5.2.rc0, all tests on bsd.math pass.



---

archive/issue_events_166065.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-15T15:22:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166065"
}
```



---

archive/issue_events_166066.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-15T15:22:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166066"
}
```



---

archive/issue_comments_131986.json:
```json
{
    "body": "<div id=\"comment:99\" align=\"right\">comment:99</div>\n\nAlas. The second patch does not apply to sage-5.3.beta2. Needs work.",
    "created_at": "2012-08-15T15:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131986",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:99" align="right">comment:99</div>

Alas. The second patch does not apply to sage-5.3.beta2. Needs work.



---

archive/issue_comments_131987.json:
```json
{
    "body": "Work Issues: **Rebase rel sage-5.3.beta2**",
    "created_at": "2012-08-15T15:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131987",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Rebase rel sage-5.3.beta2**



---

archive/issue_comments_131988.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nApparently it is a very severe conflict with sage/combinat/sf/sf.py. Bad, apparently that file has totally changed. I can't even recognise where the patch was supposed to be applied.",
    "created_at": "2012-08-15T15:26:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131988",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:0" align="right">comment:0</div>

Apparently it is a very severe conflict with sage/combinat/sf/sf.py. Bad, apparently that file has totally changed. I can't even recognise where the patch was supposed to be applied.



---

archive/issue_comments_131989.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nPerhaps the changes to sage/combinat/sf/sf.py are not needed? I have replaced the second patch by one that does not touch sf.py (in particular, it does not introduce a strong cache to symmetric function algebras). If that won't work, I can still put the necessary changes into a third patch...\n\nFor the moment:\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-15T15:32:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131989",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

Perhaps the changes to sage/combinat/sf/sf.py are not needed? I have replaced the second patch by one that does not touch sf.py (in particular, it does not introduce a strong cache to symmetric function algebras). If that won't work, I can still put the necessary changes into a third patch...

For the moment:

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_events_166067.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-15T15:32:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166067"
}
```



---

archive/issue_events_166068.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-15T15:32:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166068"
}
```



---

archive/issue_comments_131990.json:
```json
{
    "body": "Changed work issues from **Rebase rel sage-5.3.beta2** to none",
    "created_at": "2012-08-15T15:32:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131990",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Rebase rel sage-5.3.beta2** to none



---

archive/issue_comments_131991.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nArrgh. The first patch needs two little changes in the documentation. There were two lines in a doc string that started with an indentation, which was a typo.\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-15T16:14:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131991",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

Arrgh. The first patch needs two little changes in the documentation. There were two lines in a doc string that started with an indentation, which was a typo.

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_131992.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHi Simon,\n\nI've read the patches to see if there is anything weird or questionable. It looks good for the most part. Just some things you might be able to comment on:\n\n**main patch:**\n\nsage/categories/category.py\n\nYou make some changes to _join, which has the note\n\n    It is used for getting a temporary speed-up at trac ticket #11900.\n    But it is supposed to be replaced by a better solution at trac\n    ticket #11943.\n\nand #11943 was merged in 5.1! Is this function still used?\n\nOtherwise: Looks good!\n\n**sefault_fixes:**\n\nsage/combinat/sf/sf.py\n\nThere is still a change to that file, namely, you add\n\"from sage.misc.cachefunc import cached_function\"\n\nwhich is an odd thing to do in one patch by itself. Perhaps it's a change you failed to revert?\n\nINCREF:\n\nscary stuff ... I don't like black magic in code, but you seem to know what\nyou're doing...\n\n\n**Conclusion:**\n\nI'd be close to giving a positive review. I haven't run test suits (yet), but you've done a lot of that and the bot should be doing that anyway. The changes themselves look fairly straightforward.",
    "created_at": "2012-08-15T19:27:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131992",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

Hi Simon,

I've read the patches to see if there is anything weird or questionable. It looks good for the most part. Just some things you might be able to comment on:

**main patch:**

sage/categories/category.py

You make some changes to _join, which has the note

    It is used for getting a temporary speed-up at trac ticket #11900.
    But it is supposed to be replaced by a better solution at trac
    ticket #11943.

and #11943 was merged in 5.1! Is this function still used?

Otherwise: Looks good!

**sefault_fixes:**

sage/combinat/sf/sf.py

There is still a change to that file, namely, you add
"from sage.misc.cachefunc import cached_function"

which is an odd thing to do in one patch by itself. Perhaps it's a change you failed to revert?

INCREF:

scary stuff ... I don't like black magic in code, but you seem to know what
you're doing...


**Conclusion:**

I'd be close to giving a positive review. I haven't run test suits (yet), but you've done a lot of that and the bot should be doing that anyway. The changes themselves look fairly straightforward.



---

archive/issue_comments_131993.json:
```json
{
    "body": "<div id=\"comment:104\" align=\"right\">comment:104</div>\n\nHi Nils,\n\nReplying to [@nbruin](#comment:103):\n> **main patch:**\n> \n> sage/categories/category.py\n> \n> You make some changes to _join, which has the note\n> \n>     It is used for getting a temporary speed-up at trac ticket #11900.\n>     But it is supposed to be replaced by a better solution at trac\n>     ticket #11943.\n> \n> and #11943 was merged in 5.1! Is this function still used?\n\nThank you for spotting it. The plan was to replace it, but apparently it wasn't done. So, I removed the note.\n\n> **sefault_fixes:**\n> \n> sage/combinat/sf/sf.py\n> \n> There is still a change to that file, namely, you add\n> \"from sage.misc.cachefunc import cached_function\"\n> \n> which is an odd thing to do in one patch by itself. Perhaps it's a change you failed to revert?\n\n \nI have removed the import. I also removed the *strongly* cached classcall from sage/combinat/sf/sfa.py: it turns out that a strong cache for symmetric function algebras is not needed any more, after the recent overhaul.\n\n> INCREF:\n> \n> scary stuff ...\n\nI know. I am now testing whether it it still needed.\n\nAnyway, it should now be ready for review. I think, to be on the safe side, we should use #11521 as a dependency, which meanwhile has a positive review (thank you!).\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-17T05:05:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131993",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:104" align="right">comment:104</div>

Hi Nils,

Replying to [@nbruin](#comment:103):
> **main patch:**
> 
> sage/categories/category.py
> 
> You make some changes to _join, which has the note
> 
>     It is used for getting a temporary speed-up at trac ticket #11900.
>     But it is supposed to be replaced by a better solution at trac
>     ticket #11943.
> 
> and #11943 was merged in 5.1! Is this function still used?

Thank you for spotting it. The plan was to replace it, but apparently it wasn't done. So, I removed the note.

> **sefault_fixes:**
> 
> sage/combinat/sf/sf.py
> 
> There is still a change to that file, namely, you add
> "from sage.misc.cachefunc import cached_function"
> 
> which is an odd thing to do in one patch by itself. Perhaps it's a change you failed to revert?

 
I have removed the import. I also removed the *strongly* cached classcall from sage/combinat/sf/sfa.py: it turns out that a strong cache for symmetric function algebras is not needed any more, after the recent overhaul.

> INCREF:
> 
> scary stuff ...

I know. I am now testing whether it it still needed.

Anyway, it should now be ready for review. I think, to be on the safe side, we should use #11521 as a dependency, which meanwhile has a positive review (thank you!).

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_131994.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980** to **#11115 #11900 #12645 #11599 #12808 #7980 #11521**",
    "created_at": "2012-08-17T05:06:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131994",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980** to **#11115 #11900 #12645 #11599 #12808 #7980 #11521**



---

archive/issue_comments_131995.json:
```json
{
    "body": "Work Issues: **Do not INCREF when deallocating**",
    "created_at": "2012-08-17T05:33:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131995",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Do not INCREF when deallocating**



---

archive/issue_events_166069.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T05:33:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166069"
}
```



---

archive/issue_events_166070.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T05:33:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166070"
}
```



---

archive/issue_comments_131996.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nGreat! The scary INCREF apparently is not needed!! All tests in sage/schemes and sage/sf pass. The following two examples previously resulted in a segfault, but now they don't:\n\n```\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)\n[]\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)\n[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]\nsage: quit\nExiting Sage (CPU time 0m0.36s, Wall time 0m32.82s).\n```\n\n```\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)\n[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]\nsage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)\n[]\nsage: quit\nExiting Sage (CPU time 0m0.29s, Wall time 0m4.68s).\n```\n\nSo, I will (a bit later today) update the segfault patch, fortunately removing the odd INCREF.",
    "created_at": "2012-08-17T05:33:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131996",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

Great! The scary INCREF apparently is not needed!! All tests in sage/schemes and sage/sf pass. The following two examples previously resulted in a segfault, but now they don't:

```
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)
[]
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)
[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]
sage: quit
Exiting Sage (CPU time 0m0.36s, Wall time 0m32.82s).
```

```
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 5, 10)
[q - 2*q^3 - 2*q^5 + 4*q^7 - q^9 + O(q^10)]
sage: half_integral_weight_modform_basis(DirichletGroup(16,QQ).1, 3, 10)
[]
sage: quit
Exiting Sage (CPU time 0m0.29s, Wall time 0m4.68s).
```

So, I will (a bit later today) update the segfault patch, fortunately removing the odd INCREF.



---

archive/issue_comments_131997.json:
```json
{
    "body": "Changed work issues from **Do not INCREF when deallocating** to none",
    "created_at": "2012-08-17T06:24:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131997",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Do not INCREF when deallocating** to none



---

archive/issue_comments_131998.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe INCREF is gone!\n\nNote that in the commit message of the old patch version, I mention a segfault that occurs in combination with #12313. But I think - if the segfault still occurs - it should be dealt with there.\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-17T06:24:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131998",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

The INCREF is gone!

Note that in the commit message of the old patch version, I mention a segfault that occurs in combination with #12313. But I think - if the segfault still occurs - it should be dealt with there.

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_events_166071.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T06:24:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166071"
}
```



---

archive/issue_events_166072.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T06:24:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166072"
}
```



---

archive/issue_comments_131999.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAre you sure you produced these patches against a clean 5.3beta1? Your [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) still has a (trivial) hunk for `sage/combinat/sf/sfa.py` which fails to apply for me. If that were the only problem you could just remove that hunk, but I'm also getting quite some doctest failures along the lines of [comment:42](#comment:42) (but the pari test is fine now!)\n\nI confirm that I'm not seeing any of the problems that necessitated the INCREF hack, so you're good for that. I'm doubtful that the combinatorics stuff is fixed, though ...",
    "created_at": "2012-08-17T08:14:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-131999",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

Are you sure you produced these patches against a clean 5.3beta1? Your [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz) still has a (trivial) hunk for `sage/combinat/sf/sfa.py` which fails to apply for me. If that were the only problem you could just remove that hunk, but I'm also getting quite some doctest failures along the lines of [comment:42](#comment:42) (but the pari test is fine now!)

I confirm that I'm not seeing any of the problems that necessitated the INCREF hack, so you're good for that. I'm doubtful that the combinatorics stuff is fixed, though ...



---

archive/issue_comments_132000.json:
```json
{
    "body": "<div id=\"comment:109\" align=\"right\">comment:109</div>\n\nReplying to [@nbruin](#comment:108):\n> Are you sure you produced these patches against a clean 5.3beta1?\n\nI am sure that I produced these patches against 5.3.beta2 (not beta1). I don't know if Jeroen did some last minute changes to beta2; I downloaded it two days ago.",
    "created_at": "2012-08-17T10:13:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132000",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:109" align="right">comment:109</div>

Replying to [@nbruin](#comment:108):
> Are you sure you produced these patches against a clean 5.3beta1?

I am sure that I produced these patches against 5.3.beta2 (not beta1). I don't know if Jeroen did some last minute changes to beta2; I downloaded it two days ago.



---

archive/issue_comments_132001.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nI guess #5457 needs to be added as a dependency. It rewrites the symmetric function code, and was merged in beta2.",
    "created_at": "2012-08-17T10:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132001",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:0" align="right">comment:0</div>

I guess #5457 needs to be added as a dependency. It rewrites the symmetric function code, and was merged in beta2.



---

archive/issue_comments_132002.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980 #11521** to **#11115 #11900 #12645 #11599 #12808 #7980 #11521 #5457**",
    "created_at": "2012-08-17T10:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132002",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980 #11521** to **#11115 #11900 #12645 #11599 #12808 #7980 #11521 #5457**



---

archive/issue_comments_132003.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe patchbot reports:\n\n```\nsage -t  -force_lib devel/sage-12215/sage/structure/coerce.pyx\n**********************************************************************\nFile \"/opt/patchbot-5.3.beta2/devel/sage-12215/sage/structure/coerce.pyx\", line 179:\n    sage: cm.get_stats()\nExpected:\n    ((0, 1.0, 4), (0, 0.25, 1))\nGot:\n    ((0, 1.0, 4), (0, 0.0, 0))\n```\n\nSince I do not get that error, it seems that the distribution of data into the buckets is machine dependent. Hence, I suggest to mark that test as random.",
    "created_at": "2012-08-17T17:31:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132003",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

The patchbot reports:

```
sage -t  -force_lib devel/sage-12215/sage/structure/coerce.pyx
**********************************************************************
File "/opt/patchbot-5.3.beta2/devel/sage-12215/sage/structure/coerce.pyx", line 179:
    sage: cm.get_stats()
Expected:
    ((0, 1.0, 4), (0, 0.25, 1))
Got:
    ((0, 1.0, 4), (0, 0.0, 0))
```

Since I do not get that error, it seems that the distribution of data into the buckets is machine dependent. Hence, I suggest to mark that test as random.



---

archive/issue_events_166073.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T17:50:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166073"
}
```



---

archive/issue_events_166074.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T17:50:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166074"
}
```



---

archive/issue_comments_132004.json:
```json
{
    "body": "Work Issues: **Fix one doc test**",
    "created_at": "2012-08-17T17:50:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132004",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Fix one doc test**



---

archive/issue_comments_132005.json:
```json
{
    "body": "<div id=\"comment:112\" align=\"right\">comment:112</div>\n\nReplying to [@simon-king-jena](#comment:111):\n> Since I do not get that error, \n\nWrong! I *do* get the same error. Hence, needs work.",
    "created_at": "2012-08-17T17:50:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132005",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:112" align="right">comment:112</div>

Replying to [@simon-king-jena](#comment:111):
> Since I do not get that error, 

Wrong! I *do* get the same error. Hence, needs work.



---

archive/issue_comments_132006.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI fixed the doc test (by modifying the second patch).\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-17T17:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132006",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

I fixed the doc test (by modifying the second patch).

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_events_166075.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T17:54:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166075"
}
```



---

archive/issue_events_166076.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-08-17T17:54:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166076"
}
```



---

archive/issue_comments_132007.json:
```json
{
    "body": "Changed work issues from **Fix one doc test** to none",
    "created_at": "2012-08-17T17:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132007",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Fix one doc test** to none



---

archive/issue_comments_132008.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nGood! indeed, with the new dependency things apply cleanly.\n\n```\nsage/structure/coerce.pyx\n```\nAgreed. Things get placed in buckets based on address. I'd expect that to depend on not just the machine but even on the run!\n\n```\nsage/combinat/integer_vectors_mod_permgroup.py\n```\nThat one times out for me too. With `--verbose` I get that all 271 tests pass but then it hangs on\n\n```\nA workspace appears to have been corrupted... automatically rebuilding (this is harmless).\n```\nwhich explains a timeout. That might just been my setup, but since one of the bots experienced a similar problem, perhaps this needs attention.\n\nI've seen some startup time failures on `sage.math`, but the machine is rather loaded. I don't think any of the #5457, #12215 patches are individually responsible for slowdowns.\n\nSo at this point, it's just technical bits -- nothing intrinsic about the code proposed here.",
    "created_at": "2012-08-17T19:04:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132008",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

Good! indeed, with the new dependency things apply cleanly.

```
sage/structure/coerce.pyx
```
Agreed. Things get placed in buckets based on address. I'd expect that to depend on not just the machine but even on the run!

```
sage/combinat/integer_vectors_mod_permgroup.py
```
That one times out for me too. With `--verbose` I get that all 271 tests pass but then it hangs on

```
A workspace appears to have been corrupted... automatically rebuilding (this is harmless).
```
which explains a timeout. That might just been my setup, but since one of the bots experienced a similar problem, perhaps this needs attention.

I've seen some startup time failures on `sage.math`, but the machine is rather loaded. I don't think any of the #5457, #12215 patches are individually responsible for slowdowns.

So at this point, it's just technical bits -- nothing intrinsic about the code proposed here.



---

archive/issue_comments_132009.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWhen I last changed the second patch, I modified the expected result of some cm.get_stats() test. However, I forgot to mark the result \"random\". You seem to agree that it is indeed random (depending on memory addresses). Hence, I just changed the second patch accordingly.\n\nApply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch",
    "created_at": "2012-08-18T06:15:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132009",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

When I last changed the second patch, I modified the expected result of some cm.get_stats() test. However, I forgot to mark the result "random". You seem to agree that it is indeed random (depending on memory addresses). Hence, I just changed the second patch accordingly.

Apply trac12215_weak_cached_function-sk.patch trac12215_segfault_fixes.patch



---

archive/issue_comments_132010.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nBot's only complaint:\n\n```\nsage -t  -force_lib devel/sage-12215/sage/sat/boolean_polynomials.py # Killed/crashed\n```\nI cannot confirm this error on a clean 5.3b2 patched up to #12313. It pretty much has to be some assert failing in polybori, because I think that's the only component called from there.",
    "created_at": "2012-08-21T02:07:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132010",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:6" align="right">comment:6</div>

Bot's only complaint:

```
sage -t  -force_lib devel/sage-12215/sage/sat/boolean_polynomials.py # Killed/crashed
```
I cannot confirm this error on a clean 5.3b2 patched up to #12313. It pretty much has to be some assert failing in polybori, because I think that's the only component called from there.



---

archive/issue_comments_132011.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe log says:\n\n```\nsage -t  -force_lib devel/sage-12215/sage/sat/boolean_polynomials.py\nThe doctested process was killed by signal 6\n```\nHas this anything to do with my patch? What is signal 6?",
    "created_at": "2012-08-21T13:57:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132011",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

The log says:

```
sage -t  -force_lib devel/sage-12215/sage/sat/boolean_polynomials.py
The doctested process was killed by signal 6
```
Has this anything to do with my patch? What is signal 6?



---

archive/issue_comments_132012.json:
```json
{
    "body": "Reviewer: **Nils Bruin**",
    "created_at": "2012-08-24T23:15:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132012",
    "user": "https://github.com/nbruin"
}
```

Reviewer: **Nils Bruin**



---

archive/issue_events_166077.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-08-24T23:15:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166077"
}
```



---

archive/issue_events_166078.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2012-08-24T23:15:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166078"
}
```



---

archive/issue_events_166079.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T11:08:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166079"
}
```



---

archive/issue_events_166080.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-08-27T11:08:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166080"
}
```



---

archive/issue_comments_132013.json:
```json
{
    "body": "Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980 #11521 #5457** to **#11521**",
    "created_at": "2012-08-27T11:17:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132013",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#11115 #11900 #12645 #11599 #12808 #7980 #11521 #5457** to **#11521**



---

archive/issue_events_166081.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-09-10T06:31:57Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166081"
}
```



---

archive/issue_events_166082.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-09-10T06:31:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166082"
}
```



---

archive/issue_comments_132014.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThere were problems with #715+#11521 on OS X. It is solved by #13447. Hence, moving the dependency...",
    "created_at": "2012-09-17T09:38:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132014",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

There were problems with #715+#11521 on OS X. It is solved by #13447. Hence, moving the dependency...



---

archive/issue_comments_132015.json:
```json
{
    "body": "Changed dependencies from **#11521** to **#13447**",
    "created_at": "2012-09-17T09:38:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132015",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11521** to **#13447**



---

archive/issue_comments_132016.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAre the dependencies of this ticket correct, does it really depend on #13447?",
    "created_at": "2012-09-29T07:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132016",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Are the dependencies of this ticket correct, does it really depend on #13447?



---

archive/issue_comments_132017.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nNo patches were changed, only the dependencies. One of the patches on #715 ensures that the problem that #13447 solves doesn't occur, so this ticket should be safe while only depending on #715, #11521.",
    "created_at": "2012-09-29T09:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132017",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

No patches were changed, only the dependencies. One of the patches on #715 ensures that the problem that #13447 solves doesn't occur, so this ticket should be safe while only depending on #715, #11521.



---

archive/issue_comments_132018.json:
```json
{
    "body": "Changed dependencies from **#13447** to **#11521**",
    "created_at": "2012-09-29T09:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132018",
    "user": "https://github.com/nbruin"
}
```

Changed dependencies from **#13447** to **#11521**



---

archive/issue_events_166083.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-03T14:48:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166083"
}
```



---

archive/issue_events_166084.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-03T14:48:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166084"
}
```



---

archive/issue_comments_132019.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWhen applying this on top of sage-5.5.beta0 (not released), I get doctest failures in `sage/crypto/mq`.  I'll investigate further and report back.",
    "created_at": "2012-10-23T14:55:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132019",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

When applying this on top of sage-5.5.beta0 (not released), I get doctest failures in `sage/crypto/mq`.  I'll investigate further and report back.



---

archive/issue_comments_132020.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI **[edit:] cannot quite** confirm that\n\n```\nsage -t  \"devel/sage-main/sage/crypto/mq/mpolynomialsystem.py\"\n```\non sage-5.5.beta0+#12215 on sage.math does not succeed. In fact, when I run it, I usually get \"Connection to sage.math.washington.edu closed by remote host.\". A screen session doesn't help either, since that gets killed too.\n\nIt seems to hang somewhere around line 971 (that's the last I see from `sage -t --verbose`), which is in the doctesting of \"coefficient_matrix\". Running that doctest by itself doesn't cause any problems.\n\nOops, I had one run now where my connection wasn't closed! I got a \" TIMED OUT! PROCESS KILLED!\" this time.\n\nAnd in fact, the \"connection closed\" thing seems to happen quite a bit, so I don't think I have confirmation that there's really a bug. It may be that sage.math is just flaky.",
    "created_at": "2012-10-26T18:03:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132020",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

I **[edit:] cannot quite** confirm that

```
sage -t  "devel/sage-main/sage/crypto/mq/mpolynomialsystem.py"
```
on sage-5.5.beta0+#12215 on sage.math does not succeed. In fact, when I run it, I usually get "Connection to sage.math.washington.edu closed by remote host.". A screen session doesn't help either, since that gets killed too.

It seems to hang somewhere around line 971 (that's the last I see from `sage -t --verbose`), which is in the doctesting of "coefficient_matrix". Running that doctest by itself doesn't cause any problems.

Oops, I had one run now where my connection wasn't closed! I got a " TIMED OUT! PROCESS KILLED!" this time.

And in fact, the "connection closed" thing seems to happen quite a bit, so I don't think I have confirmation that there's really a bug. It may be that sage.math is just flaky.



---

archive/issue_comments_132021.json:
```json
{
    "body": "<div id=\"comment:128\" align=\"right\">comment:128</div>\n\nReplying to [@nbruin](#comment:127):\n> And in fact, the \"connection closed\" thing seems to happen quite a bit, so I don't think I have confirmation that there's really a bug. It may be that sage.math is just flaky.\n\nMaybe your ssh program is flaky?",
    "created_at": "2012-10-30T08:18:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132021",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:128" align="right">comment:128</div>

Replying to [@nbruin](#comment:127):
> And in fact, the "connection closed" thing seems to happen quite a bit, so I don't think I have confirmation that there's really a bug. It may be that sage.math is just flaky.

Maybe your ssh program is flaky?



---

archive/issue_comments_132022.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nRebased patch because it applied with fuzz.",
    "created_at": "2012-10-30T16:37:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132022",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Rebased patch because it applied with fuzz.



---

archive/issue_comments_132023.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nIrrelevant remark: you might replace `trac ticket 12215` in documentation by <code>:trac:\\`12215\\`</code>.",
    "created_at": "2012-10-30T16:41:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132023",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:0" align="right">comment:0</div>

Irrelevant remark: you might replace `trac ticket 12215` in documentation by <code>:trac:\`12215\`</code>.



---

archive/issue_comments_132024.json:
```json
{
    "body": "<div id=\"comment:131\" align=\"right\">comment:131</div>\n\nOK, the \"connection lost\" problem was resolved by `rm -rf ~/.sage`. I don't know what was screwed up, but something there was making *any* sage session very prone to terminating the whole connection.\n\nIt seems that line 971 in `mpolynomialsystem.py` is indeed a problematic doctest. It seems to hang. When I run the doctest in `gdb` I can interrupt and get a traceback (first bit):\n\n```\n#0  0x00007fb5259748aa in PyObject_Free (p=0x57d0300) at Objects/obmalloc.c:969\n#1  0x00007fb525985dcc in PyTuple_ClearFreeList () at Objects/tupleobject.c:916\n#2  0x00007fb525a0d5cb in collect (generation=2) at Modules/gcmodule.c:792\n#3  0x00007fb525a0d87e in _PyObject_GC_Malloc (basicsize=<value optimized out>) at Modules/gcmodule.c:996\n#4  0x00007fb525a0d92d in _PyObject_GC_New (tp=0x7fb525c801a0) at Modules/gcmodule.c:1467\n#5  0x00007fb52595e64c in PyList_New (size=0) at Objects/listobject.c:142\n#6  0x00007fb51c6c47e5 in __pyx_pw_4sage_9structure_11coerce_dict_10TripleDict_1__init__ (__pyx_v_self=0xf7abc50, \n    __pyx_args=<value optimized out>, __pyx_kwds=<value optimized out>) at sage/structure/coerce_dict.c:1440\n#7  0x00007fb5259885a8 in type_call (type=<value optimized out>, args=0xf714d0, kwds=0x0) at Objects/typeobject.c:735\n#8  0x00007fb52592c308 in PyObject_Call (func=0x7fb51c8d1620, arg=0xf714d0, kw=0x0) at Objects/abstract.c:2529\n#9  0x00007fb51cf2d550 in __pyx_f_4sage_9structure_6parent_6Parent_init_coerce (__pyx_v_self=0x4acacf0, \n    __pyx_optional_args=<value optimized out>) at sage/structure/parent.c:5757\n#10 0x00007fb51d17176b in __pyx_f_4sage_9structure_10parent_old_6Parent_init_coerce (__pyx_v_self=0x57d0300, \n    __pyx_optional_args=<value optimized out>) at sage/structure/parent_old.c:1638\n```\nso it seems `TripleDict` is implicated. I've tried it a couple of times and the tracebacks are not completely identical all the time, but the `collect (generation=2)` always seems to be there. So either the system gets stuck in a loop in which it is spending a large percentage of the time in `collect` or somehow `collect` itself gets caught in an infinite loop. I guess instrumenting TripleDict to see what it's chewing on is most likely to resolve this one (anything below seems python library).",
    "created_at": "2012-10-30T19:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132024",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:131" align="right">comment:131</div>

OK, the "connection lost" problem was resolved by `rm -rf ~/.sage`. I don't know what was screwed up, but something there was making *any* sage session very prone to terminating the whole connection.

It seems that line 971 in `mpolynomialsystem.py` is indeed a problematic doctest. It seems to hang. When I run the doctest in `gdb` I can interrupt and get a traceback (first bit):

```
#0  0x00007fb5259748aa in PyObject_Free (p=0x57d0300) at Objects/obmalloc.c:969
#1  0x00007fb525985dcc in PyTuple_ClearFreeList () at Objects/tupleobject.c:916
#2  0x00007fb525a0d5cb in collect (generation=2) at Modules/gcmodule.c:792
#3  0x00007fb525a0d87e in _PyObject_GC_Malloc (basicsize=<value optimized out>) at Modules/gcmodule.c:996
#4  0x00007fb525a0d92d in _PyObject_GC_New (tp=0x7fb525c801a0) at Modules/gcmodule.c:1467
#5  0x00007fb52595e64c in PyList_New (size=0) at Objects/listobject.c:142
#6  0x00007fb51c6c47e5 in __pyx_pw_4sage_9structure_11coerce_dict_10TripleDict_1__init__ (__pyx_v_self=0xf7abc50, 
    __pyx_args=<value optimized out>, __pyx_kwds=<value optimized out>) at sage/structure/coerce_dict.c:1440
#7  0x00007fb5259885a8 in type_call (type=<value optimized out>, args=0xf714d0, kwds=0x0) at Objects/typeobject.c:735
#8  0x00007fb52592c308 in PyObject_Call (func=0x7fb51c8d1620, arg=0xf714d0, kw=0x0) at Objects/abstract.c:2529
#9  0x00007fb51cf2d550 in __pyx_f_4sage_9structure_6parent_6Parent_init_coerce (__pyx_v_self=0x4acacf0, 
    __pyx_optional_args=<value optimized out>) at sage/structure/parent.c:5757
#10 0x00007fb51d17176b in __pyx_f_4sage_9structure_10parent_old_6Parent_init_coerce (__pyx_v_self=0x57d0300, 
    __pyx_optional_args=<value optimized out>) at sage/structure/parent_old.c:1638
```
so it seems `TripleDict` is implicated. I've tried it a couple of times and the tracebacks are not completely identical all the time, but the `collect (generation=2)` always seems to be there. So either the system gets stuck in a loop in which it is spending a large percentage of the time in `collect` or somehow `collect` itself gets caught in an infinite loop. I guess instrumenting TripleDict to see what it's chewing on is most likely to resolve this one (anything below seems python library).



---

archive/issue_comments_132025.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nOf course this is another heisenbug: If I take the doctesting python file that gets produced, `~/.sage/tmp/mpolynomialsystem_*.py` and run that through python via\n\n```\n $ ./sage -sh\n $ python ~/.sage/tmp/mpolynomialsystem_*.py\n```\nthe doctest succeeds, which is weird, because that is exactly what `sage-doctest` is supposed to run too.",
    "created_at": "2012-10-31T23:45:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132025",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:2" align="right">comment:2</div>

Of course this is another heisenbug: If I take the doctesting python file that gets produced, `~/.sage/tmp/mpolynomialsystem_*.py` and run that through python via

```
 $ ./sage -sh
 $ python ~/.sage/tmp/mpolynomialsystem_*.py
```
the doctest succeeds, which is weird, because that is exactly what `sage-doctest` is supposed to run too.



---

archive/issue_comments_132026.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nFWIW, with #12313 doctests pass, so perhaps we should just merge them together?",
    "created_at": "2012-11-01T17:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132026",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

FWIW, with #12313 doctests pass, so perhaps we should just merge them together?



---

archive/issue_comments_132027.json:
```json
{
    "body": "Changed dependencies from **#11521** to **#11521, merge with #12313**",
    "created_at": "2012-11-01T17:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132027",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#11521** to **#11521, merge with #12313**



---

archive/issue_events_166085.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-05T14:50:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166085"
}
```



---

archive/issue_events_166086.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-11-05T14:50:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166086"
}
```



---

archive/issue_comments_132028.json:
```json
{
    "body": "Changed dependencies from **#11521, merge with #12313** to **#11521, #13741, merge with #12313**",
    "created_at": "2012-11-22T13:10:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132028",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#11521, merge with #12313** to **#11521, #13741, merge with #12313**



---

archive/issue_comments_132029.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThis had a positive review, however I think one can not realistically expect it will soon go in: It depends on other tickets, that have a tendency to uncover nasty problems.\n\nHence, I suggest to cut it into smaller pieces - one of them being the Pari deallocation, that is now the new dependency #13741. The second patch thus needs to be rebased.",
    "created_at": "2012-11-22T13:10:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132029",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

This had a positive review, however I think one can not realistically expect it will soon go in: It depends on other tickets, that have a tendency to uncover nasty problems.

Hence, I suggest to cut it into smaller pieces - one of them being the Pari deallocation, that is now the new dependency #13741. The second patch thus needs to be rebased.



---

archive/issue_comments_132030.json:
```json
{
    "body": "Work Issues: **rebase rel #13741**",
    "created_at": "2012-11-22T13:10:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132030",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **rebase rel #13741**



---

archive/issue_events_166087.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-22T13:10:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166087"
}
```



---

archive/issue_events_166088.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2012-11-22T13:10:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166088"
}
```



---

archive/issue_comments_132031.json:
```json
{
    "body": "<div id=\"comment:137\" align=\"right\">comment:137</div>\n\nReplying to [@simon-king-jena](#comment:136):\n> Hence, I suggest to cut it into smaller pieces - one of them being the Pari deallocation, that is now the new dependency #13741. The second patch thus needs to be rebased.\n\nI just did that rebase for the sage-combinat queue (by removing the two relevant hunks), uploaded the updated patch here and tentatively set this ticket back to needs review.",
    "created_at": "2012-12-29T12:14:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132031",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:137" align="right">comment:137</div>

Replying to [@simon-king-jena](#comment:136):
> Hence, I suggest to cut it into smaller pieces - one of them being the Pari deallocation, that is now the new dependency #13741. The second patch thus needs to be rebased.

I just did that rebase for the sage-combinat queue (by removing the two relevant hunks), uploaded the updated patch here and tentatively set this ticket back to needs review.



---

archive/issue_events_166089.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2012-12-29T12:14:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166089"
}
```



---

archive/issue_events_166090.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2012-12-29T12:14:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166090"
}
```



---

archive/issue_comments_132032.json:
```json
{
    "body": "Changed work issues from **rebase rel #13741** to none",
    "created_at": "2012-12-29T12:14:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132032",
    "user": "https://github.com/nthiery"
}
```

Changed work issues from **rebase rel #13741** to none



---

archive/issue_comments_132033.json:
```json
{
    "body": "Implement a weak version of cached_function, and use it for `UniqueRepresentation`. Properly use `WeakValueDictionary` in `UniqueFactory`. Combined patch",
    "created_at": "2013-01-17T13:17:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132033",
    "user": "https://github.com/simon-king-jena"
}
```

Implement a weak version of cached_function, and use it for `UniqueRepresentation`. Properly use `WeakValueDictionary` in `UniqueFactory`. Combined patch



---

archive/issue_comments_132034.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAttachment: **[trac12215_weak_cached_function_combined.patch.gz](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)**\n\nI have combined the two patches into one. I haven't tested it yet, but will do in Sage's debug version.\n\nApply trac12215_weak_cached_function_combined.patch",
    "created_at": "2013-01-17T13:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132034",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

Attachment: **[trac12215_weak_cached_function_combined.patch.gz](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)**

I have combined the two patches into one. I haven't tested it yet, but will do in Sage's debug version.

Apply trac12215_weak_cached_function_combined.patch



---

archive/issue_comments_132035.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,6 +23,5 @@\n \n __Apply__\n \n-* [attachment: trac12215_weak_cached_function-sk.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function-sk.patch.gz)\n-* [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)\n+[attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)\n \n``````\n",
    "created_at": "2013-01-17T13:18:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132035",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,6 +23,5 @@
 
 __Apply__
 
-* [attachment: trac12215_weak_cached_function-sk.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function-sk.patch.gz)
-* [attachment: trac12215_segfault_fixes.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_segfault_fixes.patch.gz)
+[attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)
 
``````




---

archive/issue_comments_132036.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nFWIW: In sage-5.6.rc0 built with SAGE_DEBUG=yes (see #13864) plus #12215 plus #12313, all doctests pass on my x86_64 `openSuse` 12.1 laptop with `MALLOC_CHECK_=3`.",
    "created_at": "2013-01-17T21:12:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132036",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:0" align="right">comment:0</div>

FWIW: In sage-5.6.rc0 built with SAGE_DEBUG=yes (see #13864) plus #12215 plus #12313, all doctests pass on my x86_64 `openSuse` 12.1 laptop with `MALLOC_CHECK_=3`.



---

archive/issue_events_166091.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-01-18T18:17:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166091"
}
```



---

archive/issue_events_166092.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-01-18T18:17:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166092"
}
```



---

archive/issue_comments_132037.json:
```json
{
    "body": "<div id=\"comment:141\" align=\"right\">comment:141</div>\n\nReplying to [@nbruin](#comment:131):\n> It seems that line 971 in `mpolynomialsystem.py` is indeed a problematic doctest. It seems to hang.\n\nThat behaviour is entirely consistent with a double free (and hence a circular freelist) that we solved in #13896. So, back to positive review from me!",
    "created_at": "2013-01-18T18:17:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132037",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:141" align="right">comment:141</div>

Replying to [@nbruin](#comment:131):
> It seems that line 971 in `mpolynomialsystem.py` is indeed a problematic doctest. It seems to hang.

That behaviour is entirely consistent with a double free (and hence a circular freelist) that we solved in #13896. So, back to positive review from me!



---

archive/issue_events_166093.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-19T09:30:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166093"
}
```



---

archive/issue_events_166094.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-19T09:30:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166094"
}
```



---

archive/issue_comments_132038.json:
```json
{
    "body": "Changed dependencies from **#11521, #13741, merge with #12313** to **merge with #12313 and #13378**",
    "created_at": "2013-01-19T09:30:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132038",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#11521, #13741, merge with #12313** to **merge with #12313 and #13378**



---

archive/issue_events_166095.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:12:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166095"
}
```



---

archive/issue_events_166096.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:12:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166096"
}
```



---

archive/issue_comments_132039.json:
```json
{
    "body": "Changed dependencies from **merge with #12313 and #13378** to **merge with #12313**",
    "created_at": "2013-01-21T21:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132039",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **merge with #12313 and #13378** to **merge with #12313**



---

archive/issue_comments_132040.json:
```json
{
    "body": "Changed dependencies from **merge with #12313** to none",
    "created_at": "2013-01-21T21:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132040",
    "user": "https://github.com/nbruin"
}
```

Changed dependencies from **merge with #12313** to none



---

archive/issue_comments_132041.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWe only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.\n\nHence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.",
    "created_at": "2013-01-21T21:23:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132041",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

We only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.

Hence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.



---

archive/issue_comments_132042.json:
```json
{
    "body": "<div id=\"comment:145\" align=\"right\">comment:145</div>\n\nReplying to [@nbruin](#comment:144):\n> We only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.\n> \n> Hence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.\n\nJust to have a second opinion: Simon, do you agree?",
    "created_at": "2013-01-21T22:23:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132042",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:145" align="right">comment:145</div>

Replying to [@nbruin](#comment:144):
> We only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.
> 
> Hence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.

Just to have a second opinion: Simon, do you agree?



---

archive/issue_events_166097.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T22:23:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166097"
}
```



---

archive/issue_events_166098.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T22:23:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166098"
}
```



---

archive/issue_comments_132043.json:
```json
{
    "body": "<div id=\"comment:146\" align=\"right\">comment:146</div>\n\nReplying to [@jdemeyer](#comment:145):\n> Replying to [@nbruin](#comment:144):\n> > We only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.\n> > \n> > Hence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.\n\n> \n> Just to have a second opinion: Simon, do you agree?\n\nYes. Note also [comment:52](#comment:52): It used to be the case that both #12215 and #12313 were fine *separately*, but problems occurred when they were used *together*. But in later patch versions or Sage versions, it was observed that having them together makes the Heisenbug magically disappear - and the suggestion to merge them together was based on this observation.\n\nNow it very much seems that the Cython upgrade was enough to fix the crashes. We should of course verify that no problems occur when #12215 is merged without #12313, but I think there is no reason to merge #12215 and #12313 together.",
    "created_at": "2013-01-22T07:01:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132043",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:146" align="right">comment:146</div>

Replying to [@jdemeyer](#comment:145):
> Replying to [@nbruin](#comment:144):
> > We only introduced a codependence on #12313 because of comment [comment:133]. In view of comment [comment:141] I suspect the source of the problem noted in comment [comment:131] was actually solved, rather than hidden by merging tickets together.
> > 
> > Hence, I propose that this ticket is considered without dependencies and be considered for merging in sage-5.7 anyway.

> 
> Just to have a second opinion: Simon, do you agree?

Yes. Note also [comment:52](#comment:52): It used to be the case that both #12215 and #12313 were fine *separately*, but problems occurred when they were used *together*. But in later patch versions or Sage versions, it was observed that having them together makes the Heisenbug magically disappear - and the suggestion to merge them together was based on this observation.

Now it very much seems that the Cython upgrade was enough to fix the crashes. We should of course verify that no problems occur when #12215 is merged without #12313, but I think there is no reason to merge #12215 and #12313 together.



---

archive/issue_comments_132044.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWith #12215+#13378 but without #12313:\n\n```\nsage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py\n------------------------------------------------------------------------\n/release/merger/sage-5.7.beta0/local/lib/libcsage.so(print_backtrace+0x2b)[0x2b9501a4093d]\n/release/merger/sage-5.7.beta0/local/lib/libcsage.so(sigdie+0x34)[0x2b9501a40ae4]\n/release/merger/sage-5.7.beta0/local/lib/libcsage.so(sage_signal_handler+0x15b)[0x2b9501a40317]\n/lib/libpthread.so.0[0x2b94ffa697d0]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508ca14b6]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508ca1ee6]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_CallFunctionObjArgs+0x161)[0x2b94ff6be631]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_ClearWeakRefs+0x44a)[0x2b94ff728b4a]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/category_object.so[0x2b9508656a38]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff719e01]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff716681]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff716681]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6fd66b]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff719e5c]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/categories/functor.so[0x2b95099ab54e]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ee447]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ee447]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508c9a967]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff79d13d]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(_PyObject_GC_Malloc+0xee)[0x2b94ff79d89e]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(_PyObject_GC_New+0xd)[0x2b94ff79d94d]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyDict_New+0xcd)[0x2b94ff6fcffd]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b87c3e9]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b8df1da]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b870eaa]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ecb3e]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6f156d]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6f1b0b]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b873c3e]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/polynomial/polynomial_rational_flint.so[0x2b9514ecad42]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/polynomial/polynomial_rational_flint.so[0x2b9514ecf271]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x37bf)[0x2b94ff76103f]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_maps.so[0x2b950fe80b58]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/parent.so[0x2b9508434031]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/number_field/number_field_element.so[0x2b95183388a5]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7177dc]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x56)[0x2b94ff75cb26]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6d8b53]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/number_field/number_field_element_quadratic.so[0x2b95185aa867]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_maps.so[0x2b950fe80b58]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/parent.so[0x2b9508434031]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x56)[0x2b94ff75cb26]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff75a238]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5de2)[0x2b94ff763662]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/residue_field.so[0x2b951cd4a7b5]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/factory.so[0x2b951431ab1d]\n/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/factory.so[0x2b9514317940]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x2b94ff765472]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x714e)[0x2b94ff7649ce]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x2b94ff765472]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xc1)[0x2b94ff7891f1]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1f9)[0x2b94ff7894c9]\n/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(Py_Main+0xb15)[0x2b94ff79c115]\n/lib/libc.so.6(__libc_start_main+0xf4)[0x2b950031e1f4]\npython[0x400679]\n```",
    "created_at": "2013-01-22T11:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132044",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

With #12215+#13378 but without #12313:

```
sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py
------------------------------------------------------------------------
/release/merger/sage-5.7.beta0/local/lib/libcsage.so(print_backtrace+0x2b)[0x2b9501a4093d]
/release/merger/sage-5.7.beta0/local/lib/libcsage.so(sigdie+0x34)[0x2b9501a40ae4]
/release/merger/sage-5.7.beta0/local/lib/libcsage.so(sage_signal_handler+0x15b)[0x2b9501a40317]
/lib/libpthread.so.0[0x2b94ffa697d0]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508ca14b6]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508ca1ee6]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_CallFunctionObjArgs+0x161)[0x2b94ff6be631]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_ClearWeakRefs+0x44a)[0x2b94ff728b4a]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/category_object.so[0x2b9508656a38]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff719e01]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff716681]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff716681]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6fd66b]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff719e5c]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/categories/functor.so[0x2b95099ab54e]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ee447]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ee447]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_dict.so[0x2b9508c9a967]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff79d13d]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(_PyObject_GC_Malloc+0xee)[0x2b94ff79d89e]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(_PyObject_GC_New+0xd)[0x2b94ff79d94d]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyDict_New+0xcd)[0x2b94ff6fcffd]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b87c3e9]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b8df1da]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b870eaa]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6ecb3e]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6f156d]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6f1b0b]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/libs/pari/gen.so[0x2b950b873c3e]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/polynomial/polynomial_rational_flint.so[0x2b9514ecad42]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/polynomial/polynomial_rational_flint.so[0x2b9514ecf271]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x37bf)[0x2b94ff76103f]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_maps.so[0x2b950fe80b58]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/parent.so[0x2b9508434031]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/number_field/number_field_element.so[0x2b95183388a5]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7177dc]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x56)[0x2b94ff75cb26]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6d8b53]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/number_field/number_field_element_quadratic.so[0x2b95185aa867]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff7185a8]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/coerce_maps.so[0x2b950fe80b58]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/parent.so[0x2b9508434031]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_CallObjectWithKeywords+0x56)[0x2b94ff75cb26]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff75a238]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5de2)[0x2b94ff763662]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/rings/residue_field.so[0x2b951cd4a7b5]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/factory.so[0x2b951431ab1d]
/release/merger/sage-5.7.beta0/local/lib/python/site-packages/sage/structure/factory.so[0x2b9514317940]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x69c5)[0x2b94ff764245]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x2b94ff765472]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x714e)[0x2b94ff7649ce]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6e99b9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0[0x2b94ff6cc8bf]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyObject_Call+0x68)[0x2b94ff6bc308]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x1299)[0x2b94ff75eb19]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x5ae4)[0x2b94ff763364]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x852)[0x2b94ff765352]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x32)[0x2b94ff765472]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyRun_FileExFlags+0xc1)[0x2b94ff7891f1]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(PyRun_SimpleFileExFlags+0x1f9)[0x2b94ff7894c9]
/release/merger/sage-5.7.beta0/local/lib/libpython2.7.so.1.0(Py_Main+0xb15)[0x2b94ff79c115]
/lib/libc.so.6(__libc_start_main+0xf4)[0x2b950031e1f4]
python[0x400679]
```



---

archive/issue_events_166099.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-22T11:02:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166099"
}
```



---

archive/issue_events_166100.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-22T11:02:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166100"
}
```



---

archive/issue_comments_132045.json:
```json
{
    "body": "<div id=\"comment:148\" align=\"right\">comment:148</div>\n\nReplying to [@jdemeyer](#comment:147):\n> With #12215+#13378 but without #12313:\n> \n> ```\n> sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py\n> ```\n\nOuch. Well, I hope I can reproduce it in Sage-5.6.rc0 debug version.",
    "created_at": "2013-01-22T11:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132045",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:148" align="right">comment:148</div>

Replying to [@jdemeyer](#comment:147):
> With #12215+#13378 but without #12313:
> 
> ```
> sage -t  -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py
> ```

Ouch. Well, I hope I can reproduce it in Sage-5.6.rc0 debug version.



---

archive/issue_comments_132046.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nFortunately I can confirm it (at least with MALLOC_CHECK_=3). I'm running it now under gdb.",
    "created_at": "2013-01-22T11:55:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132046",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

Fortunately I can confirm it (at least with MALLOC_CHECK_=3). I'm running it now under gdb.



---

archive/issue_comments_132047.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nWhat I get is:\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007fffedeb9f4c in __pyx_pf_4sage_9structure_11coerce_dict_16TripleDictEraser_2__call__ (__pyx_v_self=0x73982d0, __pyx_v_r=0x7fffea2aaf00) at sage/structure/coerce_dict.c:1107\n1107      __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, (__pyx_v_h % PyList_GET_SIZE(__pyx_t_4)));\n(gdb) bt\n#0  0x00007fffedeb9f4c in __pyx_pf_4sage_9structure_11coerce_dict_16TripleDictEraser_2__call__ (__pyx_v_self=0x73982d0, __pyx_v_r=0x7fffea2aaf00) at sage/structure/coerce_dict.c:1107\n#1  0x00007fffedeb9592 in __pyx_pw_4sage_9structure_11coerce_dict_16TripleDictEraser_3__call__ (__pyx_v_self=0x73982d0, __pyx_args=0x75bfd10, __pyx_kwds=0x0) at sage/structure/coerce_dict.c:966\n#2  0x00007ffff79be33e in PyObject_Call (func=0x73982d0, arg=0x75bfd10, kw=0x0) at Objects/abstract.c:2529\n#3  0x00007ffff79bf059 in PyObject_CallFunctionObjArgs (callable=0x73982d0) at Objects/abstract.c:2760\n#4  0x00007ffff7a64194 in handle_callback (ref=0x7fffea2aaf00, callback=0x73982d0) at Objects/weakrefobject.c:881\n#5  0x00007ffff7a645e9 in PyObject_ClearWeakRefs (object=0x90c07b0) at Objects/weakrefobject.c:965\n#6  0x00007fffee53af5b in __pyx_tp_dealloc_4sage_9structure_15category_object_CategoryObject (o=0x90c07b0) at sage/structure/category_object.c:8990\n#7  0x00007fffee7e6fe0 in __pyx_tp_dealloc_4sage_9structure_6parent_Parent (o=0x90c07b0) at sage/structure/parent.c:21519\n#8  0x00007fffeea2aa7f in __pyx_tp_dealloc_4sage_9structure_10parent_old_Parent (o=0x90c07b0) at sage/structure/parent_old.c:7261\n#9  0x00007fffeec3bca8 in __pyx_tp_dealloc_4sage_9structure_11parent_base_ParentWithBase (o=0x90c07b0) at sage/structure/parent_base.c:1876\n#10 0x00007fffead58cbc in __pyx_tp_dealloc_4sage_9structure_11parent_gens_ParentWithGens (o=0x90c07b0) at sage/structure/parent_gens.c:5865\n#11 0x00007ffff7a4ce4c in subtype_dealloc (self=0x90c07b0) at Objects/typeobject.c:1014\n#12 0x00007ffff7a27be4 in _Py_Dealloc (op=0x90c07b0) at Objects/object.c:2243\n#13 0x00007ffff7a480b0 in tupledealloc (op=0x845ab50) at Objects/tupleobject.c:220\n#14 0x00007ffff7a27be4 in _Py_Dealloc (op=0x845ab50) at Objects/object.c:2243\n#15 0x00007ffff7a480b0 in tupledealloc (op=0x7fffea2a0760) at Objects/tupleobject.c:220\n#16 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7fffea2a0760) at Objects/object.c:2243\n#17 0x00007ffff7a18e8e in dict_dealloc (mp=0x9052b70) at Objects/dictobject.c:985\n#18 0x00007ffff7a27be4 in _Py_Dealloc (op=0x9052b70) at Objects/object.c:2243\n#19 0x00007ffff7a4cd73 in subtype_dealloc (self=0x85045a0) at Objects/typeobject.c:999\n#20 0x00007ffff7a27be4 in _Py_Dealloc (op=0x85045a0) at Objects/object.c:2243\n#21 0x00007fffed102313 in __pyx_tp_dealloc_4sage_10categories_7functor_Functor (o=0x7985950) at sage/categories/functor.c:3209\n#22 0x00007fffecee64a1 in __pyx_tp_dealloc_4sage_10categories_6action_Action (o=0x7985950) at sage/categories/action.c:6461\n#23 0x00007fffbcd614ea in __pyx_tp_dealloc_4sage_6matrix_6action_MatrixMulAction (o=0x7985950) at sage/matrix/action.c:4724\n#24 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7985950) at Objects/object.c:2243\n#25 0x00007ffff7a02c8e in list_dealloc (op=0x759fa38) at Objects/listobject.c:309\n#26 0x00007ffff7a27be4 in _Py_Dealloc (op=0x759fa38) at Objects/object.c:2243\n#27 0x00007ffff7a02c8e in list_dealloc (op=0x7964858) at Objects/listobject.c:309\n#28 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7964858) at Objects/object.c:2243\n#29 0x00007fffedecec13 in __pyx_tp_clear_4sage_9structure_11coerce_dict_TripleDict (o=0x3cbd8d0) at sage/structure/coerce_dict.c:5921\n#30 0x00007ffff7b1378b in delete_garbage (collectable=0x7fffffff30f0, old=0x7ffff7dc1540 <generations+96>) at Modules/gcmodule.c:769\n#31 0x00007ffff7b13d04 in collect (generation=2) at Modules/gcmodule.c:930\n#32 0x00007ffff7b13f06 in collect_generations () at Modules/gcmodule.c:996\n#33 0x00007ffff7b14bcc in _PyObject_GC_Malloc (basicsize=264) at Modules/gcmodule.c:1457\n#34 0x00007ffff7b14c04 in _PyObject_GC_New (tp=0x7ffff7d9c5a0 <PyDict_Type>) at Modules/gcmodule.c:1467\n#35 0x00007ffff7a16cc7 in PyDict_New () at Objects/dictobject.c:277\n#36 0x00007fffeaa83860 in __pyx_f_4sage_4libs_4pari_3gen_12PariInstance_new_ref (__pyx_v_self=0xcceae0, __pyx_v_g=0xa968360, __pyx_v_parent=0xa8d8748) at sage/libs/pari/gen.c:49228\n#37 0x00007fffea9fb417 in __pyx_pf_4sage_4libs_4pari_3gen_3gen_80__getitem__ (__pyx_v_self=0xa8d8748, __pyx_v_n=0x61f7f0) at sage/libs/pari/gen.c:8638\n#38 0x00007fffea9f63b7 in __pyx_pw_4sage_4libs_4pari_3gen_3gen_81__getitem__ (__pyx_v_self=0xa8d8748, __pyx_v_n=0x61f7f0) at sage/libs/pari/gen.c:7643\n#39 0x00007fffeaa9a688 in __pyx_sq_item_4sage_4libs_4pari_3gen_gen (o=0xa8d8748, i=1) at sage/libs/pari/gen.c:55757\n#40 0x00007ffff79bcdd7 in PySequence_GetItem (s=0xa8d8748, i=1) at Objects/abstract.c:1989\n#41 0x00007ffff7a01934 in iter_iternext (iterator=0xa99c300) at Objects/iterobject.c:58\n#42 0x00007ffff7a04abe in listextend (self=0xa7db060, b=0xa8d8748) at Objects/listobject.c:872\n#43 0x00007ffff7a08ad9 in list_init (self=0xa7db060, args=0xa7a3920, kw=0x0) at Objects/listobject.c:2458\n#44 0x00007ffff7a4c1ad in type_call (type=0x7ffff7d9a3c0 <PyList_Type>, args=0xa7a3920, kwds=0x0) at Objects/typeobject.c:737\n#45 0x00007ffff79be33e in PyObject_Call (func=0x7ffff7d9a3c0 <PyList_Type>, arg=0xa7a3920, kw=0x0) at Objects/abstract.c:2529\n#46 0x00007fffea9eb6f1 in __pyx_pf_4sage_4libs_4pari_3gen_3gen_12list (__pyx_v_self=0xa8d87d0) at sage/libs/pari/gen.c:4507\n#47 0x00007fffea9eb4a0 in __pyx_pw_4sage_4libs_4pari_3gen_3gen_13list (__pyx_v_self=0xa8d87d0, unused=0x0) at sage/libs/pari/gen.c:4455\n#48 0x00007ffff7a21156 in PyCFunction_Call (func=0xa85b858, arg=0x7ffff7f90060, kw=0x0) at Objects/methodobject.c:90\n#49 0x00007ffff79be33e in PyObject_Call (func=0xa85b858, arg=0x7ffff7f90060, kw=0x0) at Objects/abstract.c:2529\n#50 0x00007fffe14ff0aa in __pyx_pf_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_6__init__ (__pyx_v_self=0xa781258, __pyx_v_parent=0x135f730, __pyx_v_x=0xa8d87d0, \n    __pyx_v_check=0x7ffff7d89ec0 <_Py_TrueStruct>, __pyx_v_is_gen=0x7ffff7d89e80 <_Py_ZeroStruct>, __pyx_v_construct=0x7ffff7d89e80 <_Py_ZeroStruct>)\n    at sage/rings/polynomial/polynomial_rational_flint.cpp:5760\n#51 0x00007fffe14fc966 in __pyx_pw_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_7__init__ (__pyx_v_self=0xa781258, __pyx_args=0xa6f97d0, __pyx_kwds=0xa83c050)\n    at sage/rings/polynomial/polynomial_rational_flint.cpp:5165\n#52 0x00007ffff7a4c1ad in type_call (type=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, args=0xa6f97d0, kwds=0xa83c050)\n    at Objects/typeobject.c:737\n#53 0x00007ffff79be33e in PyObject_Call (func=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, arg=0xa6f97d0, kw=0xa83c050)\n    at Objects/abstract.c:2529\n#54 0x00007ffff7ac8282 in ext_do_call (func=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, pp_stack=0x7fffffff3a98, flags=2, na=4, nk=1)\n    at Python/ceval.c:4334\n#55 0x00007ffff7ac1a8b in PyEval_EvalFrameEx (f=0xa663520, throwflag=0) at Python/ceval.c:2705\n#56 0x00007ffff7ac420b in PyEval_EvalCodeEx (co=0x7fffe303bb40, globals=0x10a78b0, locals=0x0, args=0xa8acf10, argcount=2, kws=0x0, kwcount=0, defs=0x7fffe17556e8, defcount=4, closure=0x0)\n    at Python/ceval.c:3253\n#57 0x00007ffff79fd447 in function_call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/funcobject.c:526\n#58 0x00007ffff79be33e in PyObject_Call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/abstract.c:2529\n#59 0x00007ffff79da359 in instancemethod_call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/classobject.c:2578\n#60 0x00007ffff79be33e in PyObject_Call (func=0x7ffff0cdf060, arg=0x7fffea521990, kw=0x0) at Objects/abstract.c:2529\n#61 0x00007fffe6888d3b in __pyx_f_4sage_9structure_11coerce_maps_24DefaultConvertMap_unique__call_ (__pyx_v_self=0x7fffbcf7f3f0, __pyx_v_x=0xa8d87d0, __pyx_skip_dispatch=0)\n    at sage/structure/coerce_maps.c:3485\n#62 0x00007fffee7acda1 in __pyx_pf_4sage_9structure_6parent_6Parent_28__call__ (__pyx_v_self=0x135f730, __pyx_v_x=0xa8d87d0, __pyx_v_args=0x7ffff7f90060, __pyx_v_kwds=0xa751480)\n    at sage/structure/parent.c:7415\n#63 0x00007fffee7ac0a4 in __pyx_pw_4sage_9structure_6parent_6Parent_29__call__ (__pyx_v_self=0x135f730, __pyx_args=0xa80fc30, __pyx_kwds=0x0) at sage/structure/parent.c:7096\n#64 0x00007ffff79be33e in PyObject_Call (func=0x135f730, arg=0xa80fc30, kw=0x0) at Objects/abstract.c:2529\n#65 0x00007fffddd720a3 in __pyx_pf_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_2__init__ (__pyx_v_self=0xa860400, __pyx_v_parent=0x331b730, __pyx_v_f=0xa8d87d0)\n    at sage/rings/number_field/number_field_element.cpp:6090\n#66 0x00007fffddd6d545 in __pyx_pw_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_3__init__ (__pyx_v_self=0xa860400, __pyx_args=0xa85eab0, __pyx_kwds=0x0)\n    at sage/rings/number_field/number_field_element.cpp:5340\n#67 0x00007ffff7a595f6 in wrap_init (self=0xa860400, args=0xa85eab0, \n    wrapped=0x7fffddd6d316 <__pyx_pw_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_3__init__(PyObject*, PyObject*, PyObject*)>, kwds=0x0) at Objects/typeobject.c:4719\n#68 0x00007ffff79e2145 in wrapper_call (wp=0xa99c220, args=0xa85eab0, kwds=0x0) at Objects/descrobject.c:998\n#69 0x00007ffff79be33e in PyObject_Call (func=0xa99c220, arg=0xa85eab0, kw=0x0) at Objects/abstract.c:2529\n#70 0x00007ffff7ac6404 in PyEval_CallObjectWithKeywords (func=0xa99c220, arg=0xa85eab0, kw=0x0) at Python/ceval.c:3890\n#71 0x00007ffff79e1194 in wrapperdescr_call (descr=0x7fffde6d9ae0, args=0xa85eab0, kwds=0x0) at Objects/descrobject.c:306\n#72 0x00007ffff79be33e in PyObject_Call (func=0x7fffde6d9ae0, arg=0xa881360, kw=0x0) at Objects/abstract.c:2529\n#73 0x00007fffddaddacf in __pyx_pf_4sage_5rings_12number_field_30number_field_element_quadratic_28NumberFieldElement_quadratic___init__ (__pyx_v_self=0xa860400, __pyx_v_parent=0x331b730, \n    __pyx_v_f=0xa8d87d0) at sage/rings/number_field/number_field_element_quadratic.cpp:3893\n#74 0x00007fffddadbbdb in __pyx_pw_4sage_5rings_12number_field_30number_field_element_quadratic_28NumberFieldElement_quadratic_1__init__ (__pyx_v_self=0xa860400, __pyx_args=0xa85ca38, __pyx_kwds=0x0)\n    at sage/rings/number_field/number_field_element_quadratic.cpp:3386\n#75 0x00007ffff7a4c1ad in type_call (type=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, args=0xa85ca38, kwds=0x0)\n    at Objects/typeobject.c:737\n#76 0x00007ffff79be33e in PyObject_Call (func=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, arg=0xa85ca38, kw=0x0)\n    at Objects/abstract.c:2529\n#77 0x00007ffff7ac7bc3 in do_call (func=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, pp_stack=0x7fffffff4a10, na=2, nk=0)\n    at Python/ceval.c:4239\n#78 0x00007ffff7ac6efc in call_function (pp_stack=0x7fffffff4a10, oparg=2) at Python/ceval.c:4044\n#79 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x33b1e00, throwflag=0) at Python/ceval.c:2666\n#80 0x00007ffff7ac71f4 in fast_function (func=0x7fffddd47450, pp_stack=0x7fffffff4d90, n=2, na=2, nk=0) at Python/ceval.c:4107\n#81 0x00007ffff7ac6ee0 in call_function (pp_stack=0x7fffffff4d90, oparg=1) at Python/ceval.c:4042\n#82 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x37a3270, throwflag=0) at Python/ceval.c:2666\n#83 0x00007ffff7ac420b in PyEval_EvalCodeEx (co=0x7fffde989ca0, globals=0x1108b20, locals=0x0, args=0xa850f10, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3253\n#84 0x00007ffff79fd447 in function_call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/funcobject.c:526\n#85 0x00007ffff79be33e in PyObject_Call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/abstract.c:2529\n#86 0x00007ffff79da359 in instancemethod_call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/classobject.c:2578\n#87 0x00007ffff79be33e in PyObject_Call (func=0x7fffc2ecc360, arg=0xa70d1b0, kw=0x0) at Objects/abstract.c:2529\n#88 0x00007fffe6888d3b in __pyx_f_4sage_9structure_11coerce_maps_24DefaultConvertMap_unique__call_ (__pyx_v_self=0x7fffbcd4b780, __pyx_v_x=0xa8d87d0, __pyx_skip_dispatch=0)\n    at sage/structure/coerce_maps.c:3485\n#89 0x00007fffee7acda1 in __pyx_pf_4sage_9structure_6parent_6Parent_28__call__ (__pyx_v_self=0x331b730, __pyx_v_x=0xa8d87d0, __pyx_v_args=0x7ffff7f90060, __pyx_v_kwds=0xa9d32c0)\n    at sage/structure/parent.c:7415\n#90 0x00007fffee7ac0a4 in __pyx_pw_4sage_9structure_6parent_6Parent_29__call__ (__pyx_v_self=0x331b730, __pyx_args=0xa7a3a70, __pyx_kwds=0x0) at sage/structure/parent.c:7096\n#91 0x00007ffff79be33e in PyObject_Call (func=0x331b730, arg=0xa7a3a70, kw=0x0) at Objects/abstract.c:2529\n#92 0x00007ffff7ac6404 in PyEval_CallObjectWithKeywords (func=0x331b730, arg=0xa7a3a70, kw=0x0) at Python/ceval.c:3890\n#93 0x00007ffff7ab2344 in builtin_map (self=0x0, args=0xa8dde70) at Python/bltinmodule.c:1038\n#94 0x00007ffff7a210f2 in PyCFunction_Call (func=0x7ffff7f52060, arg=0xa8dde70, kw=0x0) at Objects/methodobject.c:81\n#95 0x00007ffff7ac6cdc in call_function (pp_stack=0x7fffffff5900, oparg=2) at Python/ceval.c:4021\n#96 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x3944d10, throwflag=0) at Python/ceval.c:2666\n...\n```\nI see a couple of familiar names in the backtrace...",
    "created_at": "2013-01-22T12:00:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132047",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:0" align="right">comment:0</div>

What I get is:

```
Program received signal SIGSEGV, Segmentation fault.
0x00007fffedeb9f4c in __pyx_pf_4sage_9structure_11coerce_dict_16TripleDictEraser_2__call__ (__pyx_v_self=0x73982d0, __pyx_v_r=0x7fffea2aaf00) at sage/structure/coerce_dict.c:1107
1107      __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, (__pyx_v_h % PyList_GET_SIZE(__pyx_t_4)));
(gdb) bt
#0  0x00007fffedeb9f4c in __pyx_pf_4sage_9structure_11coerce_dict_16TripleDictEraser_2__call__ (__pyx_v_self=0x73982d0, __pyx_v_r=0x7fffea2aaf00) at sage/structure/coerce_dict.c:1107
#1  0x00007fffedeb9592 in __pyx_pw_4sage_9structure_11coerce_dict_16TripleDictEraser_3__call__ (__pyx_v_self=0x73982d0, __pyx_args=0x75bfd10, __pyx_kwds=0x0) at sage/structure/coerce_dict.c:966
#2  0x00007ffff79be33e in PyObject_Call (func=0x73982d0, arg=0x75bfd10, kw=0x0) at Objects/abstract.c:2529
#3  0x00007ffff79bf059 in PyObject_CallFunctionObjArgs (callable=0x73982d0) at Objects/abstract.c:2760
#4  0x00007ffff7a64194 in handle_callback (ref=0x7fffea2aaf00, callback=0x73982d0) at Objects/weakrefobject.c:881
#5  0x00007ffff7a645e9 in PyObject_ClearWeakRefs (object=0x90c07b0) at Objects/weakrefobject.c:965
#6  0x00007fffee53af5b in __pyx_tp_dealloc_4sage_9structure_15category_object_CategoryObject (o=0x90c07b0) at sage/structure/category_object.c:8990
#7  0x00007fffee7e6fe0 in __pyx_tp_dealloc_4sage_9structure_6parent_Parent (o=0x90c07b0) at sage/structure/parent.c:21519
#8  0x00007fffeea2aa7f in __pyx_tp_dealloc_4sage_9structure_10parent_old_Parent (o=0x90c07b0) at sage/structure/parent_old.c:7261
#9  0x00007fffeec3bca8 in __pyx_tp_dealloc_4sage_9structure_11parent_base_ParentWithBase (o=0x90c07b0) at sage/structure/parent_base.c:1876
#10 0x00007fffead58cbc in __pyx_tp_dealloc_4sage_9structure_11parent_gens_ParentWithGens (o=0x90c07b0) at sage/structure/parent_gens.c:5865
#11 0x00007ffff7a4ce4c in subtype_dealloc (self=0x90c07b0) at Objects/typeobject.c:1014
#12 0x00007ffff7a27be4 in _Py_Dealloc (op=0x90c07b0) at Objects/object.c:2243
#13 0x00007ffff7a480b0 in tupledealloc (op=0x845ab50) at Objects/tupleobject.c:220
#14 0x00007ffff7a27be4 in _Py_Dealloc (op=0x845ab50) at Objects/object.c:2243
#15 0x00007ffff7a480b0 in tupledealloc (op=0x7fffea2a0760) at Objects/tupleobject.c:220
#16 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7fffea2a0760) at Objects/object.c:2243
#17 0x00007ffff7a18e8e in dict_dealloc (mp=0x9052b70) at Objects/dictobject.c:985
#18 0x00007ffff7a27be4 in _Py_Dealloc (op=0x9052b70) at Objects/object.c:2243
#19 0x00007ffff7a4cd73 in subtype_dealloc (self=0x85045a0) at Objects/typeobject.c:999
#20 0x00007ffff7a27be4 in _Py_Dealloc (op=0x85045a0) at Objects/object.c:2243
#21 0x00007fffed102313 in __pyx_tp_dealloc_4sage_10categories_7functor_Functor (o=0x7985950) at sage/categories/functor.c:3209
#22 0x00007fffecee64a1 in __pyx_tp_dealloc_4sage_10categories_6action_Action (o=0x7985950) at sage/categories/action.c:6461
#23 0x00007fffbcd614ea in __pyx_tp_dealloc_4sage_6matrix_6action_MatrixMulAction (o=0x7985950) at sage/matrix/action.c:4724
#24 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7985950) at Objects/object.c:2243
#25 0x00007ffff7a02c8e in list_dealloc (op=0x759fa38) at Objects/listobject.c:309
#26 0x00007ffff7a27be4 in _Py_Dealloc (op=0x759fa38) at Objects/object.c:2243
#27 0x00007ffff7a02c8e in list_dealloc (op=0x7964858) at Objects/listobject.c:309
#28 0x00007ffff7a27be4 in _Py_Dealloc (op=0x7964858) at Objects/object.c:2243
#29 0x00007fffedecec13 in __pyx_tp_clear_4sage_9structure_11coerce_dict_TripleDict (o=0x3cbd8d0) at sage/structure/coerce_dict.c:5921
#30 0x00007ffff7b1378b in delete_garbage (collectable=0x7fffffff30f0, old=0x7ffff7dc1540 <generations+96>) at Modules/gcmodule.c:769
#31 0x00007ffff7b13d04 in collect (generation=2) at Modules/gcmodule.c:930
#32 0x00007ffff7b13f06 in collect_generations () at Modules/gcmodule.c:996
#33 0x00007ffff7b14bcc in _PyObject_GC_Malloc (basicsize=264) at Modules/gcmodule.c:1457
#34 0x00007ffff7b14c04 in _PyObject_GC_New (tp=0x7ffff7d9c5a0 <PyDict_Type>) at Modules/gcmodule.c:1467
#35 0x00007ffff7a16cc7 in PyDict_New () at Objects/dictobject.c:277
#36 0x00007fffeaa83860 in __pyx_f_4sage_4libs_4pari_3gen_12PariInstance_new_ref (__pyx_v_self=0xcceae0, __pyx_v_g=0xa968360, __pyx_v_parent=0xa8d8748) at sage/libs/pari/gen.c:49228
#37 0x00007fffea9fb417 in __pyx_pf_4sage_4libs_4pari_3gen_3gen_80__getitem__ (__pyx_v_self=0xa8d8748, __pyx_v_n=0x61f7f0) at sage/libs/pari/gen.c:8638
#38 0x00007fffea9f63b7 in __pyx_pw_4sage_4libs_4pari_3gen_3gen_81__getitem__ (__pyx_v_self=0xa8d8748, __pyx_v_n=0x61f7f0) at sage/libs/pari/gen.c:7643
#39 0x00007fffeaa9a688 in __pyx_sq_item_4sage_4libs_4pari_3gen_gen (o=0xa8d8748, i=1) at sage/libs/pari/gen.c:55757
#40 0x00007ffff79bcdd7 in PySequence_GetItem (s=0xa8d8748, i=1) at Objects/abstract.c:1989
#41 0x00007ffff7a01934 in iter_iternext (iterator=0xa99c300) at Objects/iterobject.c:58
#42 0x00007ffff7a04abe in listextend (self=0xa7db060, b=0xa8d8748) at Objects/listobject.c:872
#43 0x00007ffff7a08ad9 in list_init (self=0xa7db060, args=0xa7a3920, kw=0x0) at Objects/listobject.c:2458
#44 0x00007ffff7a4c1ad in type_call (type=0x7ffff7d9a3c0 <PyList_Type>, args=0xa7a3920, kwds=0x0) at Objects/typeobject.c:737
#45 0x00007ffff79be33e in PyObject_Call (func=0x7ffff7d9a3c0 <PyList_Type>, arg=0xa7a3920, kw=0x0) at Objects/abstract.c:2529
#46 0x00007fffea9eb6f1 in __pyx_pf_4sage_4libs_4pari_3gen_3gen_12list (__pyx_v_self=0xa8d87d0) at sage/libs/pari/gen.c:4507
#47 0x00007fffea9eb4a0 in __pyx_pw_4sage_4libs_4pari_3gen_3gen_13list (__pyx_v_self=0xa8d87d0, unused=0x0) at sage/libs/pari/gen.c:4455
#48 0x00007ffff7a21156 in PyCFunction_Call (func=0xa85b858, arg=0x7ffff7f90060, kw=0x0) at Objects/methodobject.c:90
#49 0x00007ffff79be33e in PyObject_Call (func=0xa85b858, arg=0x7ffff7f90060, kw=0x0) at Objects/abstract.c:2529
#50 0x00007fffe14ff0aa in __pyx_pf_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_6__init__ (__pyx_v_self=0xa781258, __pyx_v_parent=0x135f730, __pyx_v_x=0xa8d87d0, 
    __pyx_v_check=0x7ffff7d89ec0 <_Py_TrueStruct>, __pyx_v_is_gen=0x7ffff7d89e80 <_Py_ZeroStruct>, __pyx_v_construct=0x7ffff7d89e80 <_Py_ZeroStruct>)
    at sage/rings/polynomial/polynomial_rational_flint.cpp:5760
#51 0x00007fffe14fc966 in __pyx_pw_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_7__init__ (__pyx_v_self=0xa781258, __pyx_args=0xa6f97d0, __pyx_kwds=0xa83c050)
    at sage/rings/polynomial/polynomial_rational_flint.cpp:5165
#52 0x00007ffff7a4c1ad in type_call (type=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, args=0xa6f97d0, kwds=0xa83c050)
    at Objects/typeobject.c:737
#53 0x00007ffff79be33e in PyObject_Call (func=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, arg=0xa6f97d0, kw=0xa83c050)
    at Objects/abstract.c:2529
#54 0x00007ffff7ac8282 in ext_do_call (func=0x7fffe174bc20 <__pyx_type_4sage_5rings_10polynomial_25polynomial_rational_flint_Polynomial_rational_flint>, pp_stack=0x7fffffff3a98, flags=2, na=4, nk=1)
    at Python/ceval.c:4334
#55 0x00007ffff7ac1a8b in PyEval_EvalFrameEx (f=0xa663520, throwflag=0) at Python/ceval.c:2705
#56 0x00007ffff7ac420b in PyEval_EvalCodeEx (co=0x7fffe303bb40, globals=0x10a78b0, locals=0x0, args=0xa8acf10, argcount=2, kws=0x0, kwcount=0, defs=0x7fffe17556e8, defcount=4, closure=0x0)
    at Python/ceval.c:3253
#57 0x00007ffff79fd447 in function_call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/funcobject.c:526
#58 0x00007ffff79be33e in PyObject_Call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/abstract.c:2529
#59 0x00007ffff79da359 in instancemethod_call (func=0x7fffdfc76ae0, arg=0xa8acee8, kw=0x0) at Objects/classobject.c:2578
#60 0x00007ffff79be33e in PyObject_Call (func=0x7ffff0cdf060, arg=0x7fffea521990, kw=0x0) at Objects/abstract.c:2529
#61 0x00007fffe6888d3b in __pyx_f_4sage_9structure_11coerce_maps_24DefaultConvertMap_unique__call_ (__pyx_v_self=0x7fffbcf7f3f0, __pyx_v_x=0xa8d87d0, __pyx_skip_dispatch=0)
    at sage/structure/coerce_maps.c:3485
#62 0x00007fffee7acda1 in __pyx_pf_4sage_9structure_6parent_6Parent_28__call__ (__pyx_v_self=0x135f730, __pyx_v_x=0xa8d87d0, __pyx_v_args=0x7ffff7f90060, __pyx_v_kwds=0xa751480)
    at sage/structure/parent.c:7415
#63 0x00007fffee7ac0a4 in __pyx_pw_4sage_9structure_6parent_6Parent_29__call__ (__pyx_v_self=0x135f730, __pyx_args=0xa80fc30, __pyx_kwds=0x0) at sage/structure/parent.c:7096
#64 0x00007ffff79be33e in PyObject_Call (func=0x135f730, arg=0xa80fc30, kw=0x0) at Objects/abstract.c:2529
#65 0x00007fffddd720a3 in __pyx_pf_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_2__init__ (__pyx_v_self=0xa860400, __pyx_v_parent=0x331b730, __pyx_v_f=0xa8d87d0)
    at sage/rings/number_field/number_field_element.cpp:6090
#66 0x00007fffddd6d545 in __pyx_pw_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_3__init__ (__pyx_v_self=0xa860400, __pyx_args=0xa85eab0, __pyx_kwds=0x0)
    at sage/rings/number_field/number_field_element.cpp:5340
#67 0x00007ffff7a595f6 in wrap_init (self=0xa860400, args=0xa85eab0, 
    wrapped=0x7fffddd6d316 <__pyx_pw_4sage_5rings_12number_field_20number_field_element_18NumberFieldElement_3__init__(PyObject*, PyObject*, PyObject*)>, kwds=0x0) at Objects/typeobject.c:4719
#68 0x00007ffff79e2145 in wrapper_call (wp=0xa99c220, args=0xa85eab0, kwds=0x0) at Objects/descrobject.c:998
#69 0x00007ffff79be33e in PyObject_Call (func=0xa99c220, arg=0xa85eab0, kw=0x0) at Objects/abstract.c:2529
#70 0x00007ffff7ac6404 in PyEval_CallObjectWithKeywords (func=0xa99c220, arg=0xa85eab0, kw=0x0) at Python/ceval.c:3890
#71 0x00007ffff79e1194 in wrapperdescr_call (descr=0x7fffde6d9ae0, args=0xa85eab0, kwds=0x0) at Objects/descrobject.c:306
#72 0x00007ffff79be33e in PyObject_Call (func=0x7fffde6d9ae0, arg=0xa881360, kw=0x0) at Objects/abstract.c:2529
#73 0x00007fffddaddacf in __pyx_pf_4sage_5rings_12number_field_30number_field_element_quadratic_28NumberFieldElement_quadratic___init__ (__pyx_v_self=0xa860400, __pyx_v_parent=0x331b730, 
    __pyx_v_f=0xa8d87d0) at sage/rings/number_field/number_field_element_quadratic.cpp:3893
#74 0x00007fffddadbbdb in __pyx_pw_4sage_5rings_12number_field_30number_field_element_quadratic_28NumberFieldElement_quadratic_1__init__ (__pyx_v_self=0xa860400, __pyx_args=0xa85ca38, __pyx_kwds=0x0)
    at sage/rings/number_field/number_field_element_quadratic.cpp:3386
#75 0x00007ffff7a4c1ad in type_call (type=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, args=0xa85ca38, kwds=0x0)
    at Objects/typeobject.c:737
#76 0x00007ffff79be33e in PyObject_Call (func=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, arg=0xa85ca38, kw=0x0)
    at Objects/abstract.c:2529
#77 0x00007ffff7ac7bc3 in do_call (func=0x7fffddd15020 <__pyx_type_4sage_5rings_12number_field_30number_field_element_quadratic_NumberFieldElement_quadratic>, pp_stack=0x7fffffff4a10, na=2, nk=0)
    at Python/ceval.c:4239
#78 0x00007ffff7ac6efc in call_function (pp_stack=0x7fffffff4a10, oparg=2) at Python/ceval.c:4044
#79 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x33b1e00, throwflag=0) at Python/ceval.c:2666
#80 0x00007ffff7ac71f4 in fast_function (func=0x7fffddd47450, pp_stack=0x7fffffff4d90, n=2, na=2, nk=0) at Python/ceval.c:4107
#81 0x00007ffff7ac6ee0 in call_function (pp_stack=0x7fffffff4d90, oparg=1) at Python/ceval.c:4042
#82 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x37a3270, throwflag=0) at Python/ceval.c:2666
#83 0x00007ffff7ac420b in PyEval_EvalCodeEx (co=0x7fffde989ca0, globals=0x1108b20, locals=0x0, args=0xa850f10, argcount=2, kws=0x0, kwcount=0, defs=0x0, defcount=0, closure=0x0) at Python/ceval.c:3253
#84 0x00007ffff79fd447 in function_call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/funcobject.c:526
#85 0x00007ffff79be33e in PyObject_Call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/abstract.c:2529
#86 0x00007ffff79da359 in instancemethod_call (func=0x7fffddd43108, arg=0xa850ee8, kw=0x0) at Objects/classobject.c:2578
#87 0x00007ffff79be33e in PyObject_Call (func=0x7fffc2ecc360, arg=0xa70d1b0, kw=0x0) at Objects/abstract.c:2529
#88 0x00007fffe6888d3b in __pyx_f_4sage_9structure_11coerce_maps_24DefaultConvertMap_unique__call_ (__pyx_v_self=0x7fffbcd4b780, __pyx_v_x=0xa8d87d0, __pyx_skip_dispatch=0)
    at sage/structure/coerce_maps.c:3485
#89 0x00007fffee7acda1 in __pyx_pf_4sage_9structure_6parent_6Parent_28__call__ (__pyx_v_self=0x331b730, __pyx_v_x=0xa8d87d0, __pyx_v_args=0x7ffff7f90060, __pyx_v_kwds=0xa9d32c0)
    at sage/structure/parent.c:7415
#90 0x00007fffee7ac0a4 in __pyx_pw_4sage_9structure_6parent_6Parent_29__call__ (__pyx_v_self=0x331b730, __pyx_args=0xa7a3a70, __pyx_kwds=0x0) at sage/structure/parent.c:7096
#91 0x00007ffff79be33e in PyObject_Call (func=0x331b730, arg=0xa7a3a70, kw=0x0) at Objects/abstract.c:2529
#92 0x00007ffff7ac6404 in PyEval_CallObjectWithKeywords (func=0x331b730, arg=0xa7a3a70, kw=0x0) at Python/ceval.c:3890
#93 0x00007ffff7ab2344 in builtin_map (self=0x0, args=0xa8dde70) at Python/bltinmodule.c:1038
#94 0x00007ffff7a210f2 in PyCFunction_Call (func=0x7ffff7f52060, arg=0xa8dde70, kw=0x0) at Objects/methodobject.c:81
#95 0x00007ffff7ac6cdc in call_function (pp_stack=0x7fffffff5900, oparg=2) at Python/ceval.c:4021
#96 0x00007ffff7ac17f9 in PyEval_EvalFrameEx (f=0x3944d10, throwflag=0) at Python/ceval.c:2666
...
```
I see a couple of familiar names in the backtrace...



---

archive/issue_comments_132048.json:
```json
{
    "body": "Crash log",
    "created_at": "2013-01-22T12:07:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132048",
    "user": "https://github.com/simon-king-jena"
}
```

Crash log



---

archive/issue_comments_132049.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[sage_crash_WgD9iG.log](https://github.com/sagemath/sage/files/ticket12215/sage_crash_WgD9iG.log)**\n\nThanks to Volker's enhanced backtraces, running the test in verbose mode and without gdb yields [this backtrace](https://github.com/sagemath/sage/files/ticket12215/sage_crash_WgD9iG.log), and the crash occurs here (line 6467 of heegner.py)\n\n```\n        sage: E = EllipticCurve('681b')\n        sage: I = E.heegner_index(-8); I\n```\n\nUnfortunately, running this in an interactive session works just fine.",
    "created_at": "2013-01-22T12:19:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132049",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[sage_crash_WgD9iG.log](https://github.com/sagemath/sage/files/ticket12215/sage_crash_WgD9iG.log)**

Thanks to Volker's enhanced backtraces, running the test in verbose mode and without gdb yields [this backtrace](https://github.com/sagemath/sage/files/ticket12215/sage_crash_WgD9iG.log), and the crash occurs here (line 6467 of heegner.py)

```
        sage: E = EllipticCurve('681b')
        sage: I = E.heegner_index(-8); I
```

Unfortunately, running this in an interactive session works just fine.



---

archive/issue_comments_132050.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nGot it, I think.\n\nThe crash happens in the last line of the following snippet\n\n```\n  __pyx_t_1 = __pyx_v_self->D->buckets;\n  __Pyx_INCREF(__pyx_t_1);\n  __pyx_t_4 = __pyx_v_self->D->buckets;\n  __Pyx_INCREF(__pyx_t_4);\n  __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, (__pyx_v_h % PyList_GET_SIZE(__pyx_t_4)));\n```\nand according to the crash log, we have\n\n```\n        __pyx_t_1 = 0x7f3db87dcb00 <_Py_NoneStruct>\n```\n\nHence, again, we have the problem that some attributes have already become invalid. I think this was fixed by [the second patch](https://github.com/sagemath/sage/files/ticket12313/trac_12313-safe_callback.patch.gz) from #12313.\n\nSuggestion: In order to keep things modular, the part of the second #12313 patch that applies to `TripleDict` shall be moved here, so that #12215 remains independent of #12313. And then, the second patch of #12313 should be replaced by something that only takes care of the new `MonoDict`.\n\nRationale: #12313 has a problem with a time regression, while #12215 should (hopefully) be fine after installing the fix.",
    "created_at": "2013-01-22T12:32:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132050",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

Got it, I think.

The crash happens in the last line of the following snippet

```
  __pyx_t_1 = __pyx_v_self->D->buckets;
  __Pyx_INCREF(__pyx_t_1);
  __pyx_t_4 = __pyx_v_self->D->buckets;
  __Pyx_INCREF(__pyx_t_4);
  __pyx_t_10 = PyList_GET_ITEM(__pyx_t_1, (__pyx_v_h % PyList_GET_SIZE(__pyx_t_4)));
```
and according to the crash log, we have

```
        __pyx_t_1 = 0x7f3db87dcb00 <_Py_NoneStruct>
```

Hence, again, we have the problem that some attributes have already become invalid. I think this was fixed by [the second patch](https://github.com/sagemath/sage/files/ticket12313/trac_12313-safe_callback.patch.gz) from #12313.

Suggestion: In order to keep things modular, the part of the second #12313 patch that applies to `TripleDict` shall be moved here, so that #12215 remains independent of #12313. And then, the second patch of #12313 should be replaced by something that only takes care of the new `MonoDict`.

Rationale: #12313 has a problem with a time regression, while #12215 should (hopefully) be fine after installing the fix.



---

archive/issue_comments_132051.json:
```json
{
    "body": "Safer callback in `TripleDictEraser`",
    "created_at": "2013-01-22T12:40:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132051",
    "user": "https://github.com/simon-king-jena"
}
```

Safer callback in `TripleDictEraser`



---

archive/issue_events_166101.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-22T12:44:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166101"
}
```



---

archive/issue_events_166102.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-01-22T12:44:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166102"
}
```



---

archive/issue_comments_132052.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAttachment: **[trac12215_safe_callback.patch.gz](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)**\n\nThe patch's up, and it fixes the crash in heegner.py (tested in sage-5.6.rc0 debug version with MALLOC_CHECK_=3)\n\nApply trac12215_weak_cached_function_combined.patch trac12215_safe_callback.patch",
    "created_at": "2013-01-22T12:44:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132052",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Attachment: **[trac12215_safe_callback.patch.gz](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)**

The patch's up, and it fixes the crash in heegner.py (tested in sage-5.6.rc0 debug version with MALLOC_CHECK_=3)

Apply trac12215_weak_cached_function_combined.patch trac12215_safe_callback.patch



---

archive/issue_comments_132053.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -23,5 +23,6 @@\n \n __Apply__\n \n-[attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)\n+* [attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)\n+* [attachment: trac12215_safe_callback.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)\n \n``````\n",
    "created_at": "2013-01-22T12:44:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132053",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -23,5 +23,6 @@
 
 __Apply__
 
-[attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)
+* [attachment: trac12215_weak_cached_function_combined.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_weak_cached_function_combined.patch.gz)
+* [attachment: trac12215_safe_callback.patch](https://github.com/sagemath/sage/files/ticket12215/trac12215_safe_callback.patch.gz)
 
``````




---

archive/issue_events_166103.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-01-22T18:07:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166103"
}
```



---

archive/issue_events_166104.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2013-01-22T18:07:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166104"
}
```



---

archive/issue_comments_132054.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nYes, this solves the problem here as well, so positive review.\n\nIt looks like the analysis on [#12313:226](https://github.com/sagemath/sage/issues/12313#comment:266) and the patch that followed from it was based on this ticket. I probably pulled the non-raw patches for #12313 when I tested ... Should we factor out a utility from the Patchbot to pull and apply patches given a ticket number?\n\nHappy to see this work did find some use after all. Again, I believe that in the future, when `TripleDictEraser` holds a weakref to its dictionary, this won't be necessary anymore, because the weakref will be broken before attributes on the dictionary get erased.\n\nThat enhanced traceback (including cython code!) is extremely cool. A big thanks to Volker for making that happen. With that traceback, you only only have to stare at the traceback to diagnose this problem.",
    "created_at": "2013-01-22T18:07:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132054",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

Yes, this solves the problem here as well, so positive review.

It looks like the analysis on [#12313:226](https://github.com/sagemath/sage/issues/12313#comment:266) and the patch that followed from it was based on this ticket. I probably pulled the non-raw patches for #12313 when I tested ... Should we factor out a utility from the Patchbot to pull and apply patches given a ticket number?

Happy to see this work did find some use after all. Again, I believe that in the future, when `TripleDictEraser` holds a weakref to its dictionary, this won't be necessary anymore, because the weakref will be broken before attributes on the dictionary get erased.

That enhanced traceback (including cython code!) is extremely cool. A big thanks to Volker for making that happen. With that traceback, you only only have to stare at the traceback to diagnose this problem.



---

archive/issue_comments_132055.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nJust for the record: All tests pass on my `openSuse` laptop in the debug version of sage-5.6.rc0+#13878+#13378+#12215, with MALLOC_CHECK_=3.",
    "created_at": "2013-01-22T19:31:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132055",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Just for the record: All tests pass on my `openSuse` laptop in the debug version of sage-5.6.rc0+#13878+#13378+#12215, with MALLOC_CHECK_=3.



---

archive/issue_comments_132056.json:
```json
{
    "body": "Merged: **sage-5.7.beta1**",
    "created_at": "2013-01-25T13:07:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12215#issuecomment-132056",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.7.beta1**



---

archive/issue_events_166105.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-25T13:07:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166105"
}
```



---

archive/issue_events_166106.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-25T13:07:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12215",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12215#event-166106"
}
```
