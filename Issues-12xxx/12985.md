# Issue 12985: Build ECL with unicode enabled

archive/issues_012813.json:
```json
{
    "assignees": [],
    "body": "The current ECL spkg disables unicode support, while it is enabled upstream. \n\nNew tarball: http://pub.math.leidenuniv.nl/~bruinpj/sage/ecl-12.12.1.20140917.tar.bz2\n\n**Assignee:** @williamstein\n\n**CC:**  jpflori Snark\n\n**Branch:** [9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)\n\n**Reviewer:** Fran\u00e7ois Bissey\n\n**Author:** Paulo C\u00e9sar Pereira de Andrade\n\nIssue created by migration from https://trac.sagemath.org/ticket/12985\n\n",
    "closed_at": "2014-10-02T16:21:42Z",
    "created_at": "2012-05-20T18:46:44Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/minor",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Build ECL with unicode enabled",
    "type": "issue",
    "updated_at": "2014-11-19T16:22:24Z",
    "url": "https://github.com/sagemath/sage/issues/12985",
    "user": "https://github.com/sagetrac-pcpa"
}
```
The current ECL spkg disables unicode support, while it is enabled upstream. 

New tarball: http://pub.math.leidenuniv.nl/~bruinpj/sage/ecl-12.12.1.20140917.tar.bz2

**Assignee:** @williamstein

**CC:**  jpflori Snark

**Branch:** [9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)

**Reviewer:** François Bissey

**Author:** Paulo César Pereira de Andrade

Issue created by migration from https://trac.sagemath.org/ticket/12985





---

archive/issue_events_152046.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2012-05-20T18:46:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152046"
}
```



---

archive/issue_events_152047.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2012-05-20T18:46:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "08517b",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152047"
}
```



---

archive/issue_events_152048.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2012-05-20T18:46:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/minor",
    "label_color": "ff0000",
    "label_name": "minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152048"
}
```



---

archive/issue_events_152049.json:
```json
{
    "actor": "https://github.com/sagetrac-pcpa",
    "created_at": "2012-05-20T18:46:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152049"
}
```



---

archive/issue_comments_149786.json:
```json
{
    "body": "**Attachment:** [sage-5.0-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/sage-5.0-ecl-unicode.patch.gz)\n\nsage-5.0-ecl-unicode.patch",
    "created_at": "2012-05-20T18:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149786",
    "user": "https://github.com/sagetrac-pcpa"
}
```

**Attachment:** [sage-5.0-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/sage-5.0-ecl-unicode.patch.gz)

sage-5.0-ecl-unicode.patch



---

archive/issue_comments_149787.json:
```json
{
    "body": "<a id='comment:1'></a>\nThanks Paulo, we had identified that problem in sage-on-gentoo a long time ago but since we can just ask for ecl to be build without unicode support for sage we just did that. If we apply your patch does sage work just as well if ecl is compiled without unicode support or does that become a requirement?",
    "created_at": "2012-06-29T11:22:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149787",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>
Thanks Paulo, we had identified that problem in sage-on-gentoo a long time ago but since we can just ask for ecl to be build without unicode support for sage we just did that. If we apply your patch does sage work just as well if ecl is compiled without unicode support or does that become a requirement?



---

archive/issue_comments_149788.json:
```json
{
    "body": "<a id='comment:2'></a>\nActually just looking at the patch, you are just adding a conversion layer, right?",
    "created_at": "2012-06-29T11:24:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149788",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
Actually just looking at the patch, you are just adding a conversion layer, right?



---

archive/issue_comments_149789.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [@kiwifb](#comment%3A2):\n> Actually just looking at the patch, you are just adding a conversion layer, right?\n\nYes, and if the ecl is built without unicode support, it should be a minor overhead noop, as it would attempt to convert a base string to a base string :-)\nThere are some comments from Juan at http://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 that may be of interest, about possible issues with unprotected lisp objects.",
    "created_at": "2012-07-01T10:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149789",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:3'></a>
Replying to [@kiwifb](#comment%3A2):
> Actually just looking at the patch, you are just adding a conversion layer, right?

Yes, and if the ecl is built without unicode support, it should be a minor overhead noop, as it would attempt to convert a base string to a base string :-)
There are some comments from Juan at http://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 that may be of interest, about possible issues with unprotected lisp objects.



---

archive/issue_comments_149790.json:
```json
{
    "body": "<a id='comment:4'></a>\nJuan's of course right in being concerned that objects are protected against garbage collection while alive. As far as I know, Boehm does watch the C stack for pointers, so a local variable pointing to the string should protect it against garbage collection while in scope.\n\nI'm pretty sure that every `ecl_base_string_pointer_safe` occurs in a context where a python string object is required. Cython injects a `PyBytes_FromString` for that, which copies the content into a Python allocated object. The ECL-managed object is thus extremely short lived and during its life, is referenced by a local C variable (i.e., is referenced on the C stack). Boehm is supposed to watch the C stack for references, so it is protected against GC during its life.\n\nIf the reference returned by `ecl_base_string_pointer_safe` were to be stored in, say, a malloc'd location (or Python managed memory) such protection is no longer guaranteed. This is why `EclObject.set_obj` makes the little `remove_node`/`insert_node_after` dance, which ensures that a reference to the underlying ecl-object is stored within memory watched by Boehm-GC.\n\n**EDIT**: Actually, I see what Juan is worried about: `ecl_base_string_pointer_safe` is a pointer to the string *content*, not the ecl string object. So yes, explicitly assigning the result of `cl_write_to_string` to a local variable, as he suggests, is probably a good idea.\n\nThe whole unicode problem would of course be much more elegantly solved by directly converting ecl unicode strings to python unicode strings and back. Given our use of ecl (maxima), there would be very little actual gain from doing so.",
    "created_at": "2012-07-04T06:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149790",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>
Juan's of course right in being concerned that objects are protected against garbage collection while alive. As far as I know, Boehm does watch the C stack for pointers, so a local variable pointing to the string should protect it against garbage collection while in scope.

I'm pretty sure that every `ecl_base_string_pointer_safe` occurs in a context where a python string object is required. Cython injects a `PyBytes_FromString` for that, which copies the content into a Python allocated object. The ECL-managed object is thus extremely short lived and during its life, is referenced by a local C variable (i.e., is referenced on the C stack). Boehm is supposed to watch the C stack for references, so it is protected against GC during its life.

If the reference returned by `ecl_base_string_pointer_safe` were to be stored in, say, a malloc'd location (or Python managed memory) such protection is no longer guaranteed. This is why `EclObject.set_obj` makes the little `remove_node`/`insert_node_after` dance, which ensures that a reference to the underlying ecl-object is stored within memory watched by Boehm-GC.

**EDIT**: Actually, I see what Juan is worried about: `ecl_base_string_pointer_safe` is a pointer to the string *content*, not the ecl string object. So yes, explicitly assigning the result of `cl_write_to_string` to a local variable, as he suggests, is probably a good idea.

The whole unicode problem would of course be much more elegantly solved by directly converting ecl unicode strings to python unicode strings and back. Given our use of ecl (maxima), there would be very little actual gain from doing so.



---

archive/issue_comments_149791.json:
```json
{
    "body": "patch to wrap ecl potential unicode output",
    "created_at": "2012-07-06T01:33:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149791",
    "user": "https://github.com/kiwifb"
}
```

patch to wrap ecl potential unicode output



---

archive/issue_comments_149792.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053\n+ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 see also https://github.com/cschwan/sage-on-gentoo/issues/2\n \n AFAIK it can be built with unicode disabled, just that it will fail make check at least.\n \n+Apply:\n+* [attachment: trac12985-ecl-unicode.patch]\n``````\n",
    "created_at": "2012-07-06T01:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149792",
    "user": "https://github.com/kiwifb"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053
+ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 see also https://github.com/cschwan/sage-on-gentoo/issues/2
 
 AFAIK it can be built with unicode disabled, just that it will fail make check at least.
 
+Apply:
+* [attachment: trac12985-ecl-unicode.patch]
``````




---

archive/issue_events_152050.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-07-06T01:40:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152050"
}
```



---

archive/issue_comments_149793.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Attachment:** [trac12985-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac12985-ecl-unicode.patch.gz)\n\nI have put the patch in a better shape and checked it applied correctly on a recent 5.2beta0. I'd very much like this to go in 5.2. It doesn't really benefit sage at the present time but makes the works from people like me and Paulo on getting sage to run natively on linux distros much easier. I am doing a few tests and then I'll give it the thumbs up.",
    "created_at": "2012-07-06T01:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149793",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'></a>
**Attachment:** [trac12985-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac12985-ecl-unicode.patch.gz)

I have put the patch in a better shape and checked it applied correctly on a recent 5.2beta0. I'd very much like this to go in 5.2. It doesn't really benefit sage at the present time but makes the works from people like me and Paulo on getting sage to run natively on linux distros much easier. I am doing a few tests and then I'll give it the thumbs up.



---

archive/issue_comments_149794.json:
```json
{
    "body": "**Author:** Paulo C\u00e9sar Pereira de Andradet",
    "created_at": "2012-07-06T01:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149794",
    "user": "https://github.com/kiwifb"
}
```

**Author:** Paulo César Pereira de Andradet



---

archive/issue_comments_149795.json:
```json
{
    "body": "**Reviewer:** Fran\u00e7ois Bissey",
    "created_at": "2012-07-06T01:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149795",
    "user": "https://github.com/kiwifb"
}
```

**Reviewer:** François Bissey



---

archive/issue_comments_149796.json:
```json
{
    "body": "<a id='comment:6'></a>\nPaulo I tried the patch with 5.1.beta6 and ecl-12.2.1 with unicode enabled and the sage/libs/ecl.pyx doctest stops waiting for input (with -verbose I get):\n\n```\nTrying:\n    interrupt_after_delay(Integer(1000))###line 246:_sage_    >>> interrupt_after_delay(1000)\nExpecting nothing\nok\nTrying:\n    inf_loop()###line 247:_sage_    >>> inf_loop()\nExpecting:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: ECL says: Console interrupt\n\nCondition of type: SIMPLE-TYPE-ERROR\nIn function MAKE-FOREIGN-DATA-FROM-ARRAY, the value of argument is\n        \"Console interrupt.\"\nwhich is not of expected type BASE-STRING\nAvailable restarts:\n\n1. (USE-VALUE) Supply a new value of type BASE-STRING.\n\nTop level.\n> \n```\nand it stays at that prompt until I interrupt it.",
    "created_at": "2012-07-06T02:21:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149796",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>
Paulo I tried the patch with 5.1.beta6 and ecl-12.2.1 with unicode enabled and the sage/libs/ecl.pyx doctest stops waiting for input (with -verbose I get):

```
Trying:
    interrupt_after_delay(Integer(1000))###line 246:_sage_    >>> interrupt_after_delay(1000)
Expecting nothing
ok
Trying:
    inf_loop()###line 247:_sage_    >>> inf_loop()
Expecting:
    Traceback (most recent call last):
    ...
    RuntimeError: ECL says: Console interrupt

Condition of type: SIMPLE-TYPE-ERROR
In function MAKE-FOREIGN-DATA-FROM-ARRAY, the value of argument is
        "Console interrupt."
which is not of expected type BASE-STRING
Available restarts:

1. (USE-VALUE) Supply a new value of type BASE-STRING.

Top level.
> 
```
and it stays at that prompt until I interrupt it.



---

archive/issue_comments_149797.json:
```json
{
    "body": "<a id='comment:7'></a>\nI cannot test it right now as I am still fighting to get a lot of packages updated in fedora, but will try to switch from sage-5.0.1 to 5.1.beta as soon as possible. The failure could be the requirement of some extra patch, or, the \"interrupt after delay\" may need some kind of \"non interrruptible\" code block when making the conversion.\n\nBut the error message appears to tell it somehow got a t_string where a t_base_string was expected, so, probably the ecl-unicode patch needs to be extended for 5.1.beta6.\n\nHopefully, `sage/libs/ecl.pxd` diff from 5.1.beta6 to 5.0.1 will show where the probem is, or, a new test case is triggering some unexpected condition.",
    "created_at": "2012-07-06T14:31:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149797",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:7'></a>
I cannot test it right now as I am still fighting to get a lot of packages updated in fedora, but will try to switch from sage-5.0.1 to 5.1.beta as soon as possible. The failure could be the requirement of some extra patch, or, the "interrupt after delay" may need some kind of "non interrruptible" code block when making the conversion.

But the error message appears to tell it somehow got a t_string where a t_base_string was expected, so, probably the ecl-unicode patch needs to be extended for 5.1.beta6.

Hopefully, `sage/libs/ecl.pxd` diff from 5.1.beta6 to 5.0.1 will show where the probem is, or, a new test case is triggering some unexpected condition.



---

archive/issue_comments_149798.json:
```json
{
    "body": "<a id='comment:8'></a>\nIsn't this just a case of missed conversions? On line 256 we have\n\n```\n    if ecl_nvalues > 1:\n        raise RuntimeError, \"ECL says: \"+ecl_base_string_pointer_safe(ecl_values(1))\n    else:\n        return ecl_values(0)\n```\n(this occurs in `ecl_safe_eval`, `ecl_safe_funcall`, `ecl_safe_apply`) and none of the patches here seem to touch that line. The second value will be ECL's error string, which is probably a unicode string if ECL uses unicode. Two solutions:\n\n* Change the definitions of the LISP routines `sage-safe-eval` and friend (line 212 and further) to already convert the error message to base_string, e.g.:\n\n```\n        (defun sage-safe-eval (form)\n            (handler-case\n                (values (eval form))\n                (serious-condition (cnd)\n                    (values nil (si:coerce-to-base-string (princ-to-string cnd))))))\n```\nI don't think in this case we need to store the reference to `ecl_values(1)`, because the value itself is in a \"last value returned\" buffer by ecl and all we're doing is reaching into it to get a string pointer and copy it into a python string. No opportunity for ecl to invalidate the `values` buffer.\n\n* do the conversion in the python routines:\n\n```\ncdef cl_object ecl_safe_eval(cl_object form) except NULL:\n    cdef cl_object s \n    ecl_sig_on()\n    cl_funcall(2,safe_eval_clobj,form)\n    ecl_sig_off()\n\n    if ecl_nvalues > 1:\n        s = si_coerce_to_base_string(ecl_values(1))\n        raise RuntimeError, \"ECL says: \"+ecl_base_string_pointer_safe(s)\n    else:\n        return ecl_values(0)\n```",
    "created_at": "2012-07-06T15:39:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149798",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>
Isn't this just a case of missed conversions? On line 256 we have

```
    if ecl_nvalues > 1:
        raise RuntimeError, "ECL says: "+ecl_base_string_pointer_safe(ecl_values(1))
    else:
        return ecl_values(0)
```
(this occurs in `ecl_safe_eval`, `ecl_safe_funcall`, `ecl_safe_apply`) and none of the patches here seem to touch that line. The second value will be ECL's error string, which is probably a unicode string if ECL uses unicode. Two solutions:

* Change the definitions of the LISP routines `sage-safe-eval` and friend (line 212 and further) to already convert the error message to base_string, e.g.:

```
        (defun sage-safe-eval (form)
            (handler-case
                (values (eval form))
                (serious-condition (cnd)
                    (values nil (si:coerce-to-base-string (princ-to-string cnd))))))
```
I don't think in this case we need to store the reference to `ecl_values(1)`, because the value itself is in a "last value returned" buffer by ecl and all we're doing is reaching into it to get a string pointer and copy it into a python string. No opportunity for ecl to invalidate the `values` buffer.

* do the conversion in the python routines:

```
cdef cl_object ecl_safe_eval(cl_object form) except NULL:
    cdef cl_object s 
    ecl_sig_on()
    cl_funcall(2,safe_eval_clobj,form)
    ecl_sig_off()

    if ecl_nvalues > 1:
        s = si_coerce_to_base_string(ecl_values(1))
        raise RuntimeError, "ECL says: "+ecl_base_string_pointer_safe(s)
    else:
        return ecl_values(0)
```



---

archive/issue_comments_149799.json:
```json
{
    "body": "Rediff of patch and applying changes in nbruin comment",
    "created_at": "2012-07-10T17:01:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149799",
    "user": "https://github.com/sagetrac-pcpa"
}
```

Rediff of patch and applying changes in nbruin comment



---

archive/issue_comments_149800.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Attachment:** [sage-5.2-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/sage-5.2-ecl-unicode.patch.gz)",
    "created_at": "2012-07-11T17:30:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149800",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:9'></a>
**Attachment:** [sage-5.2-ecl-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/sage-5.2-ecl-unicode.patch.gz)



---

archive/issue_comments_149801.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [@kiwifb](#comment%3A6):\n> Paulo I tried the patch with 5.1.beta6 and ecl-12.2.1 with unicode enabled and the sage/libs/ecl.pyx doctest stops waiting for input (with -verbose I get):\n> \n> ```\n> Trying:\n>     interrupt_after_delay(Integer(1000))###line 246:_sage_    >>> interrupt_after_delay(1000)\n> Expecting nothing\n> ok\n> Trying:\n>     inf_loop()###line 247:_sage_    >>> inf_loop()\n> Expecting:\n>     Traceback (most recent call last):\n>     ...\n>     RuntimeError: ECL says: Console interrupt\n> \n> Condition of type: SIMPLE-TYPE-ERROR\n> In function MAKE-FOREIGN-DATA-FROM-ARRAY, the value of argument is\n>         \"Console interrupt.\"\n> which is not of expected type BASE-STRING\n> Available restarts:\n> \n> 1. (USE-VALUE) Supply a new value of type BASE-STRING.\n> \n> Top level.\n> > \n> ```\n> and it stays at that prompt until I interrupt it.\n\nWith ecl-12.7.1 it just hangs at the same spot even without unicode so there may be something deeper going on there. Haven't tried the new patch it did go under my radar unnoticed so I don't know if it will solve the problem yet.",
    "created_at": "2012-08-05T11:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149801",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:10'></a>
Replying to [@kiwifb](#comment%3A6):
> Paulo I tried the patch with 5.1.beta6 and ecl-12.2.1 with unicode enabled and the sage/libs/ecl.pyx doctest stops waiting for input (with -verbose I get):
> 
> ```
> Trying:
>     interrupt_after_delay(Integer(1000))###line 246:_sage_    >>> interrupt_after_delay(1000)
> Expecting nothing
> ok
> Trying:
>     inf_loop()###line 247:_sage_    >>> inf_loop()
> Expecting:
>     Traceback (most recent call last):
>     ...
>     RuntimeError: ECL says: Console interrupt
> 
> Condition of type: SIMPLE-TYPE-ERROR
> In function MAKE-FOREIGN-DATA-FROM-ARRAY, the value of argument is
>         "Console interrupt."
> which is not of expected type BASE-STRING
> Available restarts:
> 
> 1. (USE-VALUE) Supply a new value of type BASE-STRING.
> 
> Top level.
> > 
> ```
> and it stays at that prompt until I interrupt it.

With ecl-12.7.1 it just hangs at the same spot even without unicode so there may be something deeper going on there. Haven't tried the new patch it did go under my radar unnoticed so I don't know if it will solve the problem yet.



---

archive/issue_comments_149802.json:
```json
{
    "body": "<a id='comment:11'></a>\nI will have to reformat your patch a little bit Paulo. Not only it wasn't produced by hg my cython didn't like the result very much\n\n```\nError compiling Cython file:\n------------------------------------------------------------\n...\n    ecl_sig_on()\n    cl_funcall(2,safe_eval_clobj,form)\n    ecl_sig_off()\n\n    if ecl_nvalues > 1:\n        s = si_coerce_to_base_string(ecl_values(1))\n^\n------------------------------------------------------------\n\nsage/libs/ecl.pyx:258:0: Mixed use of tabs and spaces\n```",
    "created_at": "2012-08-06T10:32:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149802",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>
I will have to reformat your patch a little bit Paulo. Not only it wasn't produced by hg my cython didn't like the result very much

```
Error compiling Cython file:
------------------------------------------------------------
...
    ecl_sig_on()
    cl_funcall(2,safe_eval_clobj,form)
    ecl_sig_off()

    if ecl_nvalues > 1:
        s = si_coerce_to_base_string(ecl_values(1))
^
------------------------------------------------------------

sage/libs/ecl.pyx:258:0: Mixed use of tabs and spaces
```



---

archive/issue_comments_149803.json:
```json
{
    "body": "<a id='comment:12'></a>\nI have a riddle. With the patch and ecl 12.7.1\n\n```\nsage -t -long -force_lib \"devel/sage/sage/libs/ecl.pyx\" -verbose\n```\ntake 2.9s and is successful if you exclude [this little problem](https://github.com/cschwan/sage-on-gentoo/issues/123) but if I run it without \"-verbose\" it times out - presumably at the same spot. And I haven't tried unicode yet.",
    "created_at": "2012-08-06T11:03:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149803",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:12'></a>
I have a riddle. With the patch and ecl 12.7.1

```
sage -t -long -force_lib "devel/sage/sage/libs/ecl.pyx" -verbose
```
take 2.9s and is successful if you exclude [this little problem](https://github.com/cschwan/sage-on-gentoo/issues/123) but if I run it without "-verbose" it times out - presumably at the same spot. And I haven't tried unicode yet.



---

archive/issue_comments_149804.json:
```json
{
    "body": "<a id='comment:13'></a>\nI noticed later I submitted a patch with tabs instead of spaces in a few places but left it as an exercise for the reader to correct :-)\n\nIt appears to work in my current Fedora build\n\n```\n$ rpm -q sagemath ecl\nsagemath-5.2-1.fc18.x86_64\necl-12.2.1-4.fc18.x86_64\n```\nRunning it I see:\n\n```\n$ sage -t -long -force_lib \"devel/sage/sage/libs/ecl.pyx\"\nsage -t -long -force_lib \"devel/sage/sage/libs/ecl.pyx\"\u00a0\u00a0\u00a0\u00a0 \n**********************************************************************\nFile \"/usr/share/sagemath/devel/sage/sage/libs/ecl.pyx\", line 247:\n\u00a0\u00a0\u00a0 sage: inf_loop()\nExpected:\n\u00a0\u00a0\u00a0 Traceback (most recent call last):\n\u00a0\u00a0\u00a0 ...\n\u00a0\u00a0\u00a0 RuntimeError: ECL says: Console interrupt\nGot:\n\u00a0\u00a0\u00a0 Traceback (most recent call last):\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"/usr/share/sagemath/local/bin/ncadoctest.py\", line 1231, in run_one_test\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 self.run_one_example(test, example, filename, compileflags)\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"/usr/share/sagemath/local/bin/sagedoctest.py\", line 38, in run_one_example\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"/usr/share/sagemath/local/bin/ncadoctest.py\", line 1172, in run_one_example\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 compileflags, 1) in test.globs\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"<doctest __main__.example_6[7]>\", line 1, in <module>\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 inf_loop()###line 247:\n\u00a0\u00a0\u00a0 sage: inf_loop()\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"ecl.pyx\", line 712, in sage.libs.ecl.EclObject.__call__ (sage/libs/ecl.c:5042)\n\u00a0\u00a0\u00a0\u00a0\u00a0 File \"ecl.pyx\", line 285, in sage.libs.ecl.ecl_safe_apply (sage/libs/ecl.c:3047)\n\u00a0\u00a0\u00a0 RuntimeError: ECL says: Console interrupt.\n**********************************************************************\n1 items had failures:\n\u00a0\u00a0 1 of\u00a0\u00a0 9 in __main__.example_6\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/pcpa/.sage/tmp/ecl_1962.py\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 [7.1 s]\n\u00a0\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 sage -t -long -force_lib \"devel/sage/sage/libs/ecl.pyx\"\nTotal time for all tests: 7.2 seconds\n```\nAlso takes 2.8s in the second run...\n\nI suspect it should be ecl-2.7.1, but there may be a few other variables involving gc and glibc version.\n\nI did not look at ecl-2.7.1 yet, but maybe need a patch equivalent to\n\nhttp://pkgs.fedoraproject.org/cgit/ecl.git/tree/ecl-12.2.1-signal_handling_thread.patch\n\nShould not be required as sagemath should already have an equivalent patch, and the above patch was required to make maxima ecl backend not hang.",
    "created_at": "2012-08-06T23:28:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149804",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:13'></a>
I noticed later I submitted a patch with tabs instead of spaces in a few places but left it as an exercise for the reader to correct :-)

It appears to work in my current Fedora build

```
$ rpm -q sagemath ecl
sagemath-5.2-1.fc18.x86_64
ecl-12.2.1-4.fc18.x86_64
```
Running it I see:

```
$ sage -t -long -force_lib "devel/sage/sage/libs/ecl.pyx"
sage -t -long -force_lib "devel/sage/sage/libs/ecl.pyx"     
**********************************************************************
File "/usr/share/sagemath/devel/sage/sage/libs/ecl.pyx", line 247:
    sage: inf_loop()
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: ECL says: Console interrupt
Got:
    Traceback (most recent call last):
      File "/usr/share/sagemath/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/share/sagemath/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/share/sagemath/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_6[7]>", line 1, in <module>
        inf_loop()###line 247:
    sage: inf_loop()
      File "ecl.pyx", line 712, in sage.libs.ecl.EclObject.__call__ (sage/libs/ecl.c:5042)
      File "ecl.pyx", line 285, in sage.libs.ecl.ecl_safe_apply (sage/libs/ecl.c:3047)
    RuntimeError: ECL says: Console interrupt.
**********************************************************************
1 items had failures:
   1 of   9 in __main__.example_6
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/pcpa/.sage/tmp/ecl_1962.py
         [7.1 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t -long -force_lib "devel/sage/sage/libs/ecl.pyx"
Total time for all tests: 7.2 seconds
```
Also takes 2.8s in the second run...

I suspect it should be ecl-2.7.1, but there may be a few other variables involving gc and glibc version.

I did not look at ecl-2.7.1 yet, but maybe need a patch equivalent to

http://pkgs.fedoraproject.org/cgit/ecl.git/tree/ecl-12.2.1-signal_handling_thread.patch

Should not be required as sagemath should already have an equivalent patch, and the above patch was required to make maxima ecl backend not hang.



---

archive/issue_comments_149805.json:
```json
{
    "body": "<a id='comment:14'></a>\nWe don't that patch in Gentoo at all. Never noticed a problem with maxima so far. It is just curious that with 12.7.1 I get a different behavior between a verbose and non-verbose test. No that's a puzzler to me. There must be a variable affecting ecl or something.",
    "created_at": "2012-08-06T23:35:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149805",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
We don't that patch in Gentoo at all. Never noticed a problem with maxima so far. It is just curious that with 12.7.1 I get a different behavior between a verbose and non-verbose test. No that's a puzzler to me. There must be a variable affecting ecl or something.



---

archive/issue_comments_149806.json:
```json
{
    "body": "<a id='comment:15'></a>\nOK your patch now works as expected without fuss with ecl-12.2.1. I'll reformat the patch for inclusion in sage and save the weird behavior in 12.7.1 for another day. Sounds OK?",
    "created_at": "2012-08-07T22:58:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149806",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>
OK your patch now works as expected without fuss with ecl-12.2.1. I'll reformat the patch for inclusion in sage and save the weird behavior in 12.7.1 for another day. Sounds OK?



---

archive/issue_comments_149807.json:
```json
{
    "body": "**Attachment:** [trac12985-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch.gz)\n\nlatest version of Paulo",
    "created_at": "2012-08-07T23:54:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149807",
    "user": "https://github.com/kiwifb"
}
```

**Attachment:** [trac12985-unicode.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch.gz)

latest version of Paulo



---

archive/issue_comments_149808.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n AFAIK it can be built with unicode disabled, just that it will fail make check at least.\n \n Apply:\n-* [attachment: trac12985-ecl-unicode.patch]\n+* [attachment: trac12985-unicode.patch]\n``````\n",
    "created_at": "2012-08-07T23:56:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149808",
    "user": "https://github.com/kiwifb"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 AFAIK it can be built with unicode disabled, just that it will fail make check at least.
 
 Apply:
-* [attachment: trac12985-ecl-unicode.patch]
+* [attachment: trac12985-unicode.patch]
``````




---

archive/issue_events_152051.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-08-07T23:56:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152051"
}
```



---

archive/issue_events_152052.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-08-07T23:56:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152052"
}
```



---

archive/issue_comments_149809.json:
```json
{
    "body": "<a id='comment:16'></a>\nRe-generated the patch against sage-5.3.beta0. Pushing the positive review button.",
    "created_at": "2012-08-07T23:56:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149809",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:16'></a>
Re-generated the patch against sage-5.3.beta0. Pushing the positive review button.



---

archive/issue_comments_149810.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [@kiwifb](#comment%3A15):\n\n> OK your patch now works as expected without fuss with ecl-12.2.1. I'll reformat the patch for inclusion in sage and save the weird behavior in 12.7.1 for another day. Sounds OK?\n\nIt is ok with me. I should test latest upstream ecl at some point also. BTW, the `ecl-12.2.1-signal_handling_thread.patch` in Fedora was my solution to allow maxima's `make check` to work with the ecl backend, when I made patches and requested support for the ecl backend; most tests would work, I think it was that it would fail somewhere in the tests, probably due to triggering gc in some specific time window.",
    "created_at": "2012-08-08T00:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149810",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:17'></a>
Replying to [@kiwifb](#comment%3A15):

> OK your patch now works as expected without fuss with ecl-12.2.1. I'll reformat the patch for inclusion in sage and save the weird behavior in 12.7.1 for another day. Sounds OK?

It is ok with me. I should test latest upstream ecl at some point also. BTW, the `ecl-12.2.1-signal_handling_thread.patch` in Fedora was my solution to allow maxima's `make check` to work with the ecl backend, when I made patches and requested support for the ecl backend; most tests would work, I think it was that it would fail somewhere in the tests, probably due to triggering gc in some specific time window.



---

archive/issue_comments_149811.json:
```json
{
    "body": "<a id='comment:18'></a>\nWait a minute we cannot merge this if we don't have ecl compiled with unicode.",
    "created_at": "2012-08-08T01:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149811",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:18'></a>
Wait a minute we cannot merge this if we don't have ecl compiled with unicode.



---

archive/issue_events_152053.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-08-08T01:02:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152053"
}
```



---

archive/issue_events_152054.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2012-08-08T01:02:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152054"
}
```



---

archive/issue_comments_149812.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@kiwifb](#comment%3A18):\n\n> Wait a minute we cannot merge this if we don't have ecl compiled with unicode.\n\nIt is supposed to be a noop if ecl is built without unicode support.\nAFAIR I made tests with unicode disabled and applying the propsed patch, but it should be wise to test it again.",
    "created_at": "2012-08-08T01:21:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149812",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:19'></a>
Replying to [@kiwifb](#comment%3A18):

> Wait a minute we cannot merge this if we don't have ecl compiled with unicode.

It is supposed to be a noop if ecl is built without unicode support.
AFAIR I made tests with unicode disabled and applying the propsed patch, but it should be wise to test it again.



---

archive/issue_comments_149813.json:
```json
{
    "body": "<a id='comment:20'></a>\nIt causes problem for me with\n\n```\nsage -t -long  -force_lib devel/sage-main/sage/calculus/calculus.py\n\n\ufffd[?1034h#0: solve_rat_ineq(ineq=x # 5)\n#0: simplify_sum(expr='sum(q^k,k,0,inf))\n#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))\n**********************************************************************\nFile \"/usr/share/sage/devel/sage-main/sage/calculus/calculus.py\", line 677:\n    sage: f.nintegral(x,0,1,1e-14)\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/usr/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/usr/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_3[3]>\", line 1, in <module>\n        f.nintegral(x,Integer(0),Integer(1),RealNumber('1e-14'))###line 677:\n    sage: f.nintegral(x,0,1,1e-14)\n      File \"expression.pyx\", line 9073, in sage.symbolic.expression.Expression.nintegral (sage/symbolic/expression.cpp:38115)\n      File \"/usr/lib64/python2.7/site-packages/sage/calculus/calculus.py\", line 752, in nintegral\n        raise ValueError, \"Maxima (via quadpack) cannot compute the integral\"\n    ValueError: Maxima (via quadpack) cannot compute the integral\n**********************************************************************\n1 items had failures:\n   1 of  17 in __main__.example_3\n***Test Failed*** 1 failures.\n```\nMay be your maxima patch deals with that.\nIf I use an ecl compiled without unicode and this patch at the same time we there are unresolved symbol because of the declaration\n\n```\ncl_object si_coerce_to_base_string(cl_object x) \n```\nin ecl.pxd. It won't be there if ecl is compiled without unicode. I may have to crosscheck that if that particular bit is nasty or not.",
    "created_at": "2012-08-08T01:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149813",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:20'></a>
It causes problem for me with

```
sage -t -long  -force_lib devel/sage-main/sage/calculus/calculus.py

�[?1034h#0: solve_rat_ineq(ineq=x # 5)
#0: simplify_sum(expr='sum(q^k,k,0,inf))
#1: simplify_sum(expr=a*'sum(q^k,k,0,inf))
**********************************************************************
File "/usr/share/sage/devel/sage-main/sage/calculus/calculus.py", line 677:
    sage: f.nintegral(x,0,1,1e-14)
Exception raised:
    Traceback (most recent call last):
      File "/usr/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[3]>", line 1, in <module>
        f.nintegral(x,Integer(0),Integer(1),RealNumber('1e-14'))###line 677:
    sage: f.nintegral(x,0,1,1e-14)
      File "expression.pyx", line 9073, in sage.symbolic.expression.Expression.nintegral (sage/symbolic/expression.cpp:38115)
      File "/usr/lib64/python2.7/site-packages/sage/calculus/calculus.py", line 752, in nintegral
        raise ValueError, "Maxima (via quadpack) cannot compute the integral"
    ValueError: Maxima (via quadpack) cannot compute the integral
**********************************************************************
1 items had failures:
   1 of  17 in __main__.example_3
***Test Failed*** 1 failures.
```
May be your maxima patch deals with that.
If I use an ecl compiled without unicode and this patch at the same time we there are unresolved symbol because of the declaration

```
cl_object si_coerce_to_base_string(cl_object x) 
```
in ecl.pxd. It won't be there if ecl is compiled without unicode. I may have to crosscheck that if that particular bit is nasty or not.



---

archive/issue_comments_149814.json:
```json
{
    "body": "<a id='comment:21'></a>\nSage and maxima must link to an ecl with the same build options. From `/usr/include/ecl/external.h`\n\n```\n#ifdef ECL_UNICODE\nextern ECL_API cl_object si_base_char_p(cl_object x);\nextern ECL_API cl_object si_base_string_p(cl_object x);\nextern ECL_API cl_object si_coerce_to_base_string(cl_object x);\nextern ECL_API cl_object si_coerce_to_extended_string(cl_object x);\n#define ecl_alloc_simple_extended_string(l) ecl_alloc_simple_vector((l),aet_ch)\nextern ECL_API cl_object ecl_alloc_adjustable_extended_string(cl_index l);\n#else\n#define si_base_char_p cl_characterp\n#define si_base_string_p cl_stringp\n#define si_coerce_to_base_string cl_string\n#define si_coerce_to_extended_string cl_string\n#endif\n```",
    "created_at": "2012-08-08T02:02:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149814",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:21'></a>
Sage and maxima must link to an ecl with the same build options. From `/usr/include/ecl/external.h`

```
#ifdef ECL_UNICODE
extern ECL_API cl_object si_base_char_p(cl_object x);
extern ECL_API cl_object si_base_string_p(cl_object x);
extern ECL_API cl_object si_coerce_to_base_string(cl_object x);
extern ECL_API cl_object si_coerce_to_extended_string(cl_object x);
#define ecl_alloc_simple_extended_string(l) ecl_alloc_simple_vector((l),aet_ch)
extern ECL_API cl_object ecl_alloc_adjustable_extended_string(cl_index l);
#else
#define si_base_char_p cl_characterp
#define si_base_string_p cl_stringp
#define si_coerce_to_base_string cl_string
#define si_coerce_to_extended_string cl_string
#endif
```



---

archive/issue_comments_149815.json:
```json
{
    "body": "<a id='comment:22'></a>\nThat would be why I got bad stuff about unresolved symbols with ecl.pyx but for the calculus.py doctest I had something consistent: ecl with unicode and maxima and sage rebuilt against it.",
    "created_at": "2012-08-08T02:06:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149815",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:22'></a>
That would be why I got bad stuff about unresolved symbols with ecl.pyx but for the calculus.py doctest I had something consistent: ecl with unicode and maxima and sage rebuilt against it.



---

archive/issue_comments_149816.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n AFAIK it can be built with unicode disabled, just that it will fail make check at least.\n \n Apply:\n-* [attachment: trac12985-unicode.patch]\n+* [attachment:trac12985-unicode.patch](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch)\n``````\n",
    "created_at": "2012-12-14T18:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149816",
    "user": "https://github.com/kcrisman"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 AFAIK it can be built with unicode disabled, just that it will fail make check at least.
 
 Apply:
-* [attachment: trac12985-unicode.patch]
+* [attachment:trac12985-unicode.patch](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch)
``````




---

archive/issue_comments_149817.json:
```json
{
    "body": "<a id='comment:24'></a>\nThe current packages at #13324 have\n\n```\n--enable-unicode=no\n```\nWould that be an acceptable resolution to this ticket, or should we re-enable it with this fix eventually?  (Currently I'd say #13324 is higher-priority so that we might actually have a chance at getting Cygwin up to speed...)",
    "created_at": "2012-12-14T18:35:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149817",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:24'></a>
The current packages at #13324 have

```
--enable-unicode=no
```
Would that be an acceptable resolution to this ticket, or should we re-enable it with this fix eventually?  (Currently I'd say #13324 is higher-priority so that we might actually have a chance at getting Cygwin up to speed...)



---

archive/issue_comments_149818.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [@kcrisman](#comment%3A24):\n\n> The current packages at #13324  have ` --enable-unicode=no `\n\n  The fedora package has an explicit `--enable-unicode`. The fact that ecl was failing `make check` if using `--disable-unicode` was an ecl bug.\n\n> Would that be an acceptable resolution to this ticket, or should we re-enable it with this fix eventually?  (Currently I'd say #13324  is higher-priority so that we might actually have a chance at getting Cygwin up to speed...)\n\nThe patch must work with ecl compiled with or without unicode (the patch reason is to not break sagemath if ecl was built with unicode enabled), but the patch was causing a link failure if using an ecl older than 12.2.",
    "created_at": "2012-12-14T23:21:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149818",
    "user": "https://github.com/sagetrac-pcpa"
}
```

<a id='comment:25'></a>
Replying to [@kcrisman](#comment%3A24):

> The current packages at #13324  have ` --enable-unicode=no `

  The fedora package has an explicit `--enable-unicode`. The fact that ecl was failing `make check` if using `--disable-unicode` was an ecl bug.

> Would that be an acceptable resolution to this ticket, or should we re-enable it with this fix eventually?  (Currently I'd say #13324  is higher-priority so that we might actually have a chance at getting Cygwin up to speed...)

The patch must work with ecl compiled with or without unicode (the patch reason is to not break sagemath if ecl was built with unicode enabled), but the patch was causing a link failure if using an ecl older than 12.2.



---

archive/issue_comments_149819.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'll have to check if I still have a couple of weird issues stemming from Unicode and this patch. Haven't touched it in  while. I have been more focused on upgrading numpy in #11334 of late.",
    "created_at": "2012-12-14T23:45:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149819",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:26'></a>
I'll have to check if I still have a couple of weird issues stemming from Unicode and this patch. Haven't touched it in  while. I have been more focused on upgrading numpy in #11334 of late.



---

archive/issue_comments_149820.json:
```json
{
    "body": "**Attachment:** [trac_12985_ecl_unicode_5.10.beta4.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch.gz)\n\nPatch rebased for 5.10.beta4",
    "created_at": "2013-05-25T15:25:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149820",
    "user": "https://github.com/sagetrac-Snark"
}
```

**Attachment:** [trac_12985_ecl_unicode_5.10.beta4.patch.gz](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch.gz)

Patch rebased for 5.10.beta4



---

archive/issue_comments_149821.json:
```json
{
    "body": "<a id='comment:28'></a>\nI checked that the rebased patch used with the current ECL spkg which disables unicode, works: everything compiles and doctests.",
    "created_at": "2013-05-26T07:51:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149821",
    "user": "https://github.com/sagetrac-Snark"
}
```

<a id='comment:28'></a>
I checked that the rebased patch used with the current ECL spkg which disables unicode, works: everything compiles and doctests.



---

archive/issue_comments_149822.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,3 @@\n-ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 see also https://github.com/cschwan/sage-on-gentoo/issues/2\n+The current ECL spkg disables unicode support, while it is enabled upstream. The patch [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) makes sage work correctly whether the ecl spkg enables unicode or not. The [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) spkg is compiled with unicode support -- which means less difference with upstream, and is hence better for people packaging sage in various distributions.\n \n-AFAIK it can be built with unicode disabled, just that it will fail make check at least.\n-\n-Apply:\n-* [attachment:trac12985-unicode.patch](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch)\n+To review, apply [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) and use [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) (recompile maxima afterwards if not from scratch).\n``````\n",
    "created_at": "2013-05-26T13:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149822",
    "user": "https://github.com/sagetrac-Snark"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,3 @@
-ecl 12.2.1 has unicode support enabled by default, what creates two string types, t_base_string and t_string. The problem is that sage does not properly handle those, as described in https://sourceforge.net/tracker/?func=detail&aid=3526370&group_id=30035&atid=398053 see also https://github.com/cschwan/sage-on-gentoo/issues/2
+The current ECL spkg disables unicode support, while it is enabled upstream. The patch [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) makes sage work correctly whether the ecl spkg enables unicode or not. The [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) spkg is compiled with unicode support -- which means less difference with upstream, and is hence better for people packaging sage in various distributions.
 
-AFAIK it can be built with unicode disabled, just that it will fail make check at least.
-
-Apply:
-* [attachment:trac12985-unicode.patch](https://github.com/sagemath/sage/files/ticket12985/trac12985-unicode.patch)
+To review, apply [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) and use [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) (recompile maxima afterwards if not from scratch).
``````




---

archive/issue_events_152055.json:
```json
{
    "actor": "https://github.com/sagetrac-Snark",
    "created_at": "2013-05-26T13:34:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "008080",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152055"
}
```



---

archive/issue_events_152056.json:
```json
{
    "actor": "https://github.com/sagetrac-Snark",
    "created_at": "2013-05-26T13:34:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152056"
}
```



---

archive/issue_events_152057.json:
```json
{
    "actor": "https://github.com/sagetrac-Snark",
    "created_at": "2013-05-26T13:34:46Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "rename": {
        "from": "Possible future issues with ECL build with unicode enabled",
        "to": "Build ECL with unicode enabled"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152057"
}
```



---

archive/issue_events_152058.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152058"
}
```



---

archive/issue_events_152059.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152059"
}
```



---

archive/issue_events_152060.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152060"
}
```



---

archive/issue_events_152061.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152061"
}
```



---

archive/issue_comments_149823.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n-The current ECL spkg disables unicode support, while it is enabled upstream. The patch [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) makes sage work correctly whether the ecl spkg enables unicode or not. The [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) spkg is compiled with unicode support -- which means less difference with upstream, and is hence better for people packaging sage in various distributions.\n+The current ECL spkg disables unicode support, while it is enabled upstream. \n \n-To review, apply [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) and use [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) (recompile maxima afterwards if not from scratch).\n+New tarball: http://boxen.math.washington.edu/home/vbraun/upstream/ecl-12.12.1.20140409.tar.bz2\n``````\n",
    "created_at": "2014-04-09T00:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149823",
    "user": "https://github.com/vbraun"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
-The current ECL spkg disables unicode support, while it is enabled upstream. The patch [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) makes sage work correctly whether the ecl spkg enables unicode or not. The [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) spkg is compiled with unicode support -- which means less difference with upstream, and is hence better for people packaging sage in various distributions.
+The current ECL spkg disables unicode support, while it is enabled upstream. 
 
-To review, apply [attachment:trac_12985_ecl_unicode_5.10.beta4.patch](https://github.com/sagemath/sage/files/ticket12985/trac_12985_ecl_unicode_5.10.beta4.patch) and use [http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg](http://boxen.math.washington.edu/home/jpuydt/ecl-12.12.1.p4.spkg) (recompile maxima afterwards if not from scratch).
+New tarball: http://boxen.math.washington.edu/home/vbraun/upstream/ecl-12.12.1.20140409.tar.bz2
``````




---

archive/issue_comments_149824.json:
```json
{
    "body": "**Branch:** [u/vbraun/build_ecl_with_unicode_enabled](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/build_ecl_with_unicode_enabled)",
    "created_at": "2014-04-09T00:11:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149824",
    "user": "https://github.com/vbraun"
}
```

**Branch:** [u/vbraun/build_ecl_with_unicode_enabled](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/build_ecl_with_unicode_enabled)



---

archive/issue_events_152062.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152062"
}
```



---

archive/issue_events_152063.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152063"
}
```



---

archive/issue_comments_149825.json:
```json
{
    "body": "**Commit:** [7d358ff15e482ef45c54222119577cf84fd07c41](https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41)",
    "created_at": "2014-05-27T13:16:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149825",
    "user": "https://github.com/pjbruin"
}
```

**Commit:** [7d358ff15e482ef45c54222119577cf84fd07c41](https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41)



---

archive/issue_events_152064.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-27T13:16:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152064"
}
```



---

archive/issue_events_152065.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-05-27T13:16:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152065"
}
```



---

archive/issue_comments_149826.json:
```json
{
    "body": "<a id='comment:35'></a>\n- does not merge with 6.3.beta2\n- probably needs a new tarball\n \n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ed10dce1f4720d742f5f0d738ebe1626445c886a\">ed10dce</a></td><td><code>Trac 12985: make sage work with ecl compiled with unicode support</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41\">7d358ff</a></td><td><code>enable unicode in ecl</code></td></tr></table>\n",
    "created_at": "2014-05-27T13:16:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149826",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:35'></a>
- does not merge with 6.3.beta2
- probably needs a new tarball
 
---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ed10dce1f4720d742f5f0d738ebe1626445c886a">ed10dce</a></td><td><code>Trac 12985: make sage work with ecl compiled with unicode support</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41">7d358ff</a></td><td><code>enable unicode in ecl</code></td></tr></table>




---

archive/issue_events_152066.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152066"
}
```



---

archive/issue_events_152067.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152067"
}
```



---

archive/issue_comments_149827.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers deny it's a bug.\" to \"\".",
    "created_at": "2014-09-17T11:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149827",
    "user": "https://github.com/pjbruin"
}
```

**Changing upstream** from "Reported upstream. Developers deny it's a bug." to "".



---

archive/issue_events_152068.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-09-17T11:22:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152068"
}
```



---

archive/issue_events_152069.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2014-09-17T11:22:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152069"
}
```



---

archive/issue_comments_149828.json:
```json
{
    "body": "**Changing branch** from \"[u/vbraun/build_ecl_with_unicode_enabled](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/build_ecl_with_unicode_enabled)\" to \"[u/pbruin/12985-ecl_unicode](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12985-ecl_unicode)\".",
    "created_at": "2014-09-17T11:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149828",
    "user": "https://github.com/pjbruin"
}
```

**Changing branch** from "[u/vbraun/build_ecl_with_unicode_enabled](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/build_ecl_with_unicode_enabled)" to "[u/pbruin/12985-ecl_unicode](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12985-ecl_unicode)".



---

archive/issue_comments_149829.json:
```json
{
    "body": "**Changing commit** from \"[7d358ff15e482ef45c54222119577cf84fd07c41](https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41)\" to \"[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)\".",
    "created_at": "2014-09-17T11:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149829",
    "user": "https://github.com/pjbruin"
}
```

**Changing commit** from "[7d358ff15e482ef45c54222119577cf84fd07c41](https://github.com/sagemath/sagetrac-mirror/commit/7d358ff15e482ef45c54222119577cf84fd07c41)" to "[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)".



---

archive/issue_comments_149830.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The current ECL spkg disables unicode support, while it is enabled upstream. \n \n-New tarball: http://boxen.math.washington.edu/home/vbraun/upstream/ecl-12.12.1.20140409.tar.bz2\n+New tarball: http://pub.math.leidenuniv.nl/~bruinpj/sage/ecl-12.12.1.20140917.tar.bz2\n``````\n",
    "created_at": "2014-09-17T11:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149830",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The current ECL spkg disables unicode support, while it is enabled upstream. 
 
-New tarball: http://boxen.math.washington.edu/home/vbraun/upstream/ecl-12.12.1.20140409.tar.bz2
+New tarball: http://pub.math.leidenuniv.nl/~bruinpj/sage/ecl-12.12.1.20140917.tar.bz2
``````




---

archive/issue_comments_149831.json:
```json
{
    "body": "<a id='comment:37'></a>\nMerged with 6.4.beta3, updated tarball, minor changes to files in `build/pkgs/ecl/`.",
    "created_at": "2014-09-17T11:22:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149831",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:37'></a>
Merged with 6.4.beta3, updated tarball, minor changes to files in `build/pkgs/ecl/`.



---

archive/issue_comments_149832.json:
```json
{
    "body": "<a id='comment:38'></a>\nIs there any chance to update to the latest (and final?) ECL?\nWasn't the main blocker the previous versions of Maxima?",
    "created_at": "2014-09-17T12:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149832",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:38'></a>
Is there any chance to update to the latest (and final?) ECL?
Wasn't the main blocker the previous versions of Maxima?



---

archive/issue_comments_149833.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [jpflori](#comment%3A38):\n> Is there any chance to update to the latest (and final?) ECL?\n> Wasn't the main blocker the previous versions of Maxima?\n\nI think we should give it a try, but on a separate ticket...",
    "created_at": "2014-09-17T13:04:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149833",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:39'></a>
Replying to [jpflori](#comment%3A38):
> Is there any chance to update to the latest (and final?) ECL?
> Wasn't the main blocker the previous versions of Maxima?

I think we should give it a try, but on a separate ticket...



---

archive/issue_comments_149834.json:
```json
{
    "body": "<a id='comment:40'></a>\nSure, on another ticket :)",
    "created_at": "2014-09-17T13:05:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149834",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:40'></a>
Sure, on another ticket :)



---

archive/issue_comments_149835.json:
```json
{
    "body": "<a id='comment:41'></a>\nDo we have one? We are now fully using ecl 13.5.1 and there are no problems with it.\nSo this will really be the last ecl for potentially a long time?\nOne of the reason we switched to ecl was the \"maxima as a library\" thing. Now that particular extension has been included in asdf 3+ so we could potentially build it with another lisp.",
    "created_at": "2014-09-17T21:23:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149835",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:41'></a>
Do we have one? We are now fully using ecl 13.5.1 and there are no problems with it.
So this will really be the last ecl for potentially a long time?
One of the reason we switched to ecl was the "maxima as a library" thing. Now that particular extension has been included in asdf 3+ so we could potentially build it with another lisp.



---

archive/issue_comments_149836.json:
```json
{
    "body": "<a id='comment:42'></a>\nI meant do we have a ticket and sage-on-gentoo is using 13.5.1.",
    "created_at": "2014-09-17T21:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149836",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:42'></a>
I meant do we have a ticket and sage-on-gentoo is using 13.5.1.



---

archive/issue_comments_149837.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [@kiwifb](#comment%3A42):\n> I meant do we have a ticket and sage-on-gentoo is using 13.5.1.\n\nWe don't seem to have a ticket yet; I'll open one.",
    "created_at": "2014-09-18T07:16:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149837",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:43'></a>
Replying to [@kiwifb](#comment%3A42):
> I meant do we have a ticket and sage-on-gentoo is using 13.5.1.

We don't seem to have a ticket yet; I'll open one.



---

archive/issue_comments_149838.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [@pjbruin](#comment%3A43):\n> Replying to [@kiwifb](#comment%3A42):\n> > I meant do we have a ticket and sage-on-gentoo is using 13.5.1.\n\n> We don't seem to have a ticket yet; I'll open one.\n\nThis is now #17003.",
    "created_at": "2014-09-18T07:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149838",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:44'></a>
Replying to [@pjbruin](#comment%3A43):
> Replying to [@kiwifb](#comment%3A42):
> > I meant do we have a ticket and sage-on-gentoo is using 13.5.1.

> We don't seem to have a ticket yet; I'll open one.

This is now #17003.



---

archive/issue_comments_149839.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [@kiwifb](#comment%3A41):\n> One of the reason we switched to ecl was the \"maxima as a library\" thing. Now that particular extension has been included in asdf 3+ so we could potentially build it with another lisp.\n\nBefore you can use \"maxima as a library\" from sage, you first need \"lisp as a library\" and I think ECL is still the only player in that arena. I'm sure you can get \"maxima as a lisp library\" in pretty much any lisp implementation, but we need to be able to call into that lisp implementation from C code.",
    "created_at": "2014-09-18T19:16:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149839",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:45'></a>
Replying to [@kiwifb](#comment%3A41):
> One of the reason we switched to ecl was the "maxima as a library" thing. Now that particular extension has been included in asdf 3+ so we could potentially build it with another lisp.

Before you can use "maxima as a library" from sage, you first need "lisp as a library" and I think ECL is still the only player in that arena. I'm sure you can get "maxima as a lisp library" in pretty much any lisp implementation, but we need to be able to call into that lisp implementation from C code.



---

archive/issue_comments_149840.json:
```json
{
    "body": "<a id='comment:46'></a>\nOK, it passes basic review here but maxima and sage need rebuilding. I assume that will be automagic with #17072.",
    "created_at": "2014-09-30T11:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149840",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:46'></a>
OK, it passes basic review here but maxima and sage need rebuilding. I assume that will be automagic with #17072.



---

archive/issue_events_152070.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2014-09-30T11:08:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152070"
}
```



---

archive/issue_events_152071.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2014-09-30T11:08:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152071"
}
```



---

archive/issue_events_152072.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-02T16:21:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152072"
}
```



---

archive/issue_events_152073.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5a647f81f454b12d6db69465e9429c5b56a05587",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-10-02T16:21:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/12985#event-152073"
}
```



---

archive/issue_comments_149841.json:
```json
{
    "body": "**Changing branch** from \"[u/pbruin/12985-ecl_unicode](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12985-ecl_unicode)\" to \"[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)\".",
    "created_at": "2014-10-02T16:21:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149841",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/pbruin/12985-ecl_unicode](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/12985-ecl_unicode)" to "[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)".



---

archive/issue_comments_149842.json:
```json
{
    "body": "**Changing author** from \"Paulo C\u00e9sar Pereira de Andradet\" to \"Paulo C\u00e9sar Pereira de Andrade\".",
    "created_at": "2014-11-19T16:22:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149842",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Paulo César Pereira de Andradet" to "Paulo César Pereira de Andrade".



---

archive/issue_comments_149843.json:
```json
{
    "body": "**Changing commit** from \"[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)\" to \"\".",
    "created_at": "2014-11-19T16:22:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/12985#issuecomment-149843",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[9ae50681bb70ed16c046e296fe72dbc1c43f8eb3](https://github.com/sagemath/sagetrac-mirror/commit/9ae50681bb70ed16c046e296fe72dbc1c43f8eb3)" to "".
