# Issue 12977: Let singular_function expect "attributes" not as a dict

archive/issues_012805.json:
```json
{
    "body": "Here is how attributes are passed to libsingular when calling a singular function:\n\n```\nsage: from sage.libs.singular import singular_function\nsage: P.<x,y>=QQ[]\nsage: J = P*[P.random_element() for _ in range(100)]\nsage: NF = singular_function('reduce')\nsage: _ = NF(J.groebner_basis(),J,attributes={J:{'isSB':1}})\n```\n\nHence, a dictionary is expected, where the keys are arguments to the function. Now, that's bad: The hash of ideals is broken and is slow (see #12976).\n\nMoreover, the attribute is supposed to be applied to a particular object, but *not* to an object that is only *equal* (but not identical).\n\n**__Suggestion__**\n\nMake it so that\n\n```\nsage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))\n```\nworks: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.\n\nApply\n\n* [attachment:trac12977_singular_function_attributes.patch]\n\nAssignee: @malb\n\nCC:  @malb polybori @burcin\n\nKeywords: sd40.5\n\nReviewer: Mike Hansen\n\nAuthor: Simon King\n\nStatus: needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/12977\n\n",
    "created_at": "2012-05-19T13:31:17Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Let singular_function expect \"attributes\" not as a dict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12977",
    "user": "https://github.com/simon-king-jena"
}
```
Here is how attributes are passed to libsingular when calling a singular function:

```
sage: from sage.libs.singular import singular_function
sage: P.<x,y>=QQ[]
sage: J = P*[P.random_element() for _ in range(100)]
sage: NF = singular_function('reduce')
sage: _ = NF(J.groebner_basis(),J,attributes={J:{'isSB':1}})
```

Hence, a dictionary is expected, where the keys are arguments to the function. Now, that's bad: The hash of ideals is broken and is slow (see #12976).

Moreover, the attribute is supposed to be applied to a particular object, but *not* to an object that is only *equal* (but not identical).

**__Suggestion__**

Make it so that

```
sage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))
```
works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.

Apply

* [attachment:trac12977_singular_function_attributes.patch]

Assignee: @malb

CC:  @malb polybori @burcin

Keywords: sd40.5

Reviewer: Mike Hansen

Author: Simon King

Status: needs_work

Issue created by migration from https://trac.sagemath.org/ticket/12977





---

archive/issue_comments_190624.json:
```json
{
    "body": "<a id='comment:1'></a>I think the suggestion in the new ticket description is better than the old one.",
    "created_at": "2012-05-19T13:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190624",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>I think the suggestion in the new ticket description is better than the old one.



---

archive/issue_comments_190625.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,6 +17,6 @@\n Make it so that\n \n ```\n-sage: _ = NF(J.groebner_basis(),J,attributes=((J,{'isSB':1}),))\n+sage: _ = NF(J.groebner_basis(),J,attributes=({'isSB':1},))\n ```\n-works, where inside `NF.__call__` the items in the attributes tuple/list are compared by identity.\n+works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.\n``````\n",
    "created_at": "2012-05-19T13:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190625",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,6 +17,6 @@
 Make it so that
 
 ```
-sage: _ = NF(J.groebner_basis(),J,attributes=((J,{'isSB':1}),))
+sage: _ = NF(J.groebner_basis(),J,attributes=({'isSB':1},))
 ```
-works, where inside `NF.__call__` the items in the attributes tuple/list are compared by identity.
+works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.
``````




---

archive/issue_comments_190626.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -17,6 +17,6 @@\n Make it so that\n \n ```\n-sage: _ = NF(J.groebner_basis(),J,attributes=({'isSB':1},))\n+sage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))\n ```\n works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.\n``````\n",
    "created_at": "2012-05-19T13:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190626",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -17,6 +17,6 @@
 Make it so that
 
 ```
-sage: _ = NF(J.groebner_basis(),J,attributes=({'isSB':1},))
+sage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))
 ```
 works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.
``````




---

archive/issue_comments_190627.json:
```json
{
    "body": "<a id='comment:4'></a>Alternative idea of Burcin:\n\n```\nsage: _ = NF(J.groebner_basis(),set_singular_attribute(J,isSB=1))\n```\n`set_singular_attribute` (or a shorter name) would create some auxiliary object that stores J and its attribute, so that the singular function can retrieve the necessary data from it.\n\nAlternative idea of Simon:\n\n```\nsage: _ = NF(J.groebner_basis(),J,attributes=((J,{'isSB':1})))\n```\nwhere the first part of the tuple items is compared by identity (not by equality, since that would involve GB computation.",
    "created_at": "2012-05-19T13:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190627",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>Alternative idea of Burcin:

```
sage: _ = NF(J.groebner_basis(),set_singular_attribute(J,isSB=1))
```
`set_singular_attribute` (or a shorter name) would create some auxiliary object that stores J and its attribute, so that the singular function can retrieve the necessary data from it.

Alternative idea of Simon:

```
sage: _ = NF(J.groebner_basis(),J,attributes=((J,{'isSB':1})))
```
where the first part of the tuple items is compared by identity (not by equality, since that would involve GB computation.



---

archive/issue_comments_190628.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-21T07:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190628",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_190629.json:
```json
{
    "body": "<a id='comment:5'></a>The attached patch still supports the current way of providing the attributes to a singular_function, but also supports a new one that does not involve a GB computation but compares ideals by identity, and is thus faster. Example:\n\n```\nsage: P.<x,y> = QQ[]\nsage: J = P*[P.random_element(4,5)^2 for _ in range(4)]\nsage: J\nIdeal (x^4*y^4 + 2*x^2*y^5 + y^6 - 2/3*x^2*y^2 - 2/3*y^3 + 1/9, 9/16*y^6 - x^2*y^3 + 3/2*x*y^4 + 1/2*y^5 + 4/9*x^4 - 4/3*x^3*y + 5/9*x^2*y^2 + 2/3*x*y^3 + 1/9*y^4 + 12*y^3 - 32/3*x^2 + 16*x*y + 16/3*y^2 + 64, y^8 - 2/5*x^3*y^4 + 1/25*x^6 - 4/11*x*y^4 + 6*y^5 + 4/55*x^4 - 6/5*x^3*y + 10*y^4 - 2*x^3 + 4/121*x^2 - 12/11*x*y + 9*y^2 - 20/11*x + 30*y + 25, 1/400*x^4*y^4 - 1/5*x^5*y^2 - 1/20*x^4*y^3 + 4*x^6 + 2*x^5*y + 11/20*x^4*y^2 - 12*x^5 - 3*x^4*y + 9*x^4) of Multivariate Polynomial Ring in x, y over Rational Field\nsage: J2 = J.gens()*P\nsage: J.groebner_basis()\n[1]\n```\n\nSo, we consider here the trivial ideal. As it happens, the GB computation takes a noticeable time.\n\nLet us define a singular library function:\n\n```\nsage: isSB = {'isSB':1}\nsage: from sage.libs.singular import singular_function\nsage: NF = singular_function('reduce')\n```\n\nOld syntax:\n\n```\nsage: sage: %timeit q = NF(J,J, attributes={J:isSB})\n625 loops, best of 3: 1.42 ms per loop\nsage: %timeit q = NF(J2,J, attributes={J:isSB})\n125 loops, best of 3: 5.62 ms per loop\nsage: %timeit q = NF(J2,J2, attributes={J2:isSB})\n25 loops, best of 3: 14 ms per loop\n```\nAs you observe, the timings differ widely when one takes copies of the same ideal. I thought the reason is that the Gr\u00f6bner basis of J has been computed, but that of J2 has not. Thus, comparing J2 with another ideal involves computing the Gr\u00f6bner basis *of a copy of J2*. But I could be mistaken, see below.\n\nHere is the same with the new syntax:\n\n```\nsage: %timeit q = NF(J,J, attributes=((J,isSB),))\n625 loops, best of 3: 279 \u00b5s per loop\nsage: %timeit q = NF(J2,J, attributes=((J,isSB),))\n625 loops, best of 3: 654 \u00b5s per loop\nsage: %timeit q = NF(J2,J2, attributes=((J2,isSB),))\n125 loops, best of 3: 1.69 ms per loop\n```\n\nI am actually surprised that the timings differ. Anyway, the timings in the new syntax are a lot faster than with the old syntax.\n\nAnd here is why I think that my statement on computation of Gr\u00f6bner bases in the old syntax may be wrong. Namely, the timings for comparison are a long way slower:\n\n```\nsage: J2 = J.gens()*P\nsage: %timeit J==J2\n5 loops, best of 3: 645 ms per loop\nsage: J2.groebner_basis.is_in_cache()\nFalse\n```\nHence, even though J and J2 belong to the same ring, a Gr\u00f6bner basis of a copy of J2 is computed, which is thus not cached. That should be changed on a different ticket.\n\n__Conclusion__\n\nThe problem was different than I originally thought, but the new (optional) syntax provided by my patch makes things faster. Needs review, although I should change the text in the documentation (because apparently Gr\u00f6bner bases aren't involved).",
    "created_at": "2012-05-21T07:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190629",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>The attached patch still supports the current way of providing the attributes to a singular_function, but also supports a new one that does not involve a GB computation but compares ideals by identity, and is thus faster. Example:

```
sage: P.<x,y> = QQ[]
sage: J = P*[P.random_element(4,5)^2 for _ in range(4)]
sage: J
Ideal (x^4*y^4 + 2*x^2*y^5 + y^6 - 2/3*x^2*y^2 - 2/3*y^3 + 1/9, 9/16*y^6 - x^2*y^3 + 3/2*x*y^4 + 1/2*y^5 + 4/9*x^4 - 4/3*x^3*y + 5/9*x^2*y^2 + 2/3*x*y^3 + 1/9*y^4 + 12*y^3 - 32/3*x^2 + 16*x*y + 16/3*y^2 + 64, y^8 - 2/5*x^3*y^4 + 1/25*x^6 - 4/11*x*y^4 + 6*y^5 + 4/55*x^4 - 6/5*x^3*y + 10*y^4 - 2*x^3 + 4/121*x^2 - 12/11*x*y + 9*y^2 - 20/11*x + 30*y + 25, 1/400*x^4*y^4 - 1/5*x^5*y^2 - 1/20*x^4*y^3 + 4*x^6 + 2*x^5*y + 11/20*x^4*y^2 - 12*x^5 - 3*x^4*y + 9*x^4) of Multivariate Polynomial Ring in x, y over Rational Field
sage: J2 = J.gens()*P
sage: J.groebner_basis()
[1]
```

So, we consider here the trivial ideal. As it happens, the GB computation takes a noticeable time.

Let us define a singular library function:

```
sage: isSB = {'isSB':1}
sage: from sage.libs.singular import singular_function
sage: NF = singular_function('reduce')
```

Old syntax:

```
sage: sage: %timeit q = NF(J,J, attributes={J:isSB})
625 loops, best of 3: 1.42 ms per loop
sage: %timeit q = NF(J2,J, attributes={J:isSB})
125 loops, best of 3: 5.62 ms per loop
sage: %timeit q = NF(J2,J2, attributes={J2:isSB})
25 loops, best of 3: 14 ms per loop
```
As you observe, the timings differ widely when one takes copies of the same ideal. I thought the reason is that the Gröbner basis of J has been computed, but that of J2 has not. Thus, comparing J2 with another ideal involves computing the Gröbner basis *of a copy of J2*. But I could be mistaken, see below.

Here is the same with the new syntax:

```
sage: %timeit q = NF(J,J, attributes=((J,isSB),))
625 loops, best of 3: 279 µs per loop
sage: %timeit q = NF(J2,J, attributes=((J,isSB),))
625 loops, best of 3: 654 µs per loop
sage: %timeit q = NF(J2,J2, attributes=((J2,isSB),))
125 loops, best of 3: 1.69 ms per loop
```

I am actually surprised that the timings differ. Anyway, the timings in the new syntax are a lot faster than with the old syntax.

And here is why I think that my statement on computation of Gröbner bases in the old syntax may be wrong. Namely, the timings for comparison are a long way slower:

```
sage: J2 = J.gens()*P
sage: %timeit J==J2
5 loops, best of 3: 645 ms per loop
sage: J2.groebner_basis.is_in_cache()
False
```
Hence, even though J and J2 belong to the same ring, a Gröbner basis of a copy of J2 is computed, which is thus not cached. That should be changed on a different ticket.

__Conclusion__

The problem was different than I originally thought, but the new (optional) syntax provided by my patch makes things faster. Needs review, although I should change the text in the documentation (because apparently Gröbner bases aren't involved).



---

archive/issue_comments_190630.json:
```json
{
    "body": "<a id='comment:6'></a>The problem of avoiding needless GB computations in comparison of ideals is now #12987.",
    "created_at": "2012-05-21T08:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190630",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>The problem of avoiding needless GB computations in comparison of ideals is now #12987.



---

archive/issue_comments_190631.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Mike Hansen\"",
    "created_at": "2012-05-28T23:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190631",
    "user": "https://github.com/mwhansen"
}
```

Changing reviewer from "" to "Mike Hansen"



---

archive/issue_comments_190632.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,3 +20,8 @@\n sage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))\n ```\n works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.\n+\n+Apply\n+\n+* [attachment:trac12977_singular_function_attributes.patch]\n+* [attachment:trac_12977-fix_doctest.patch]\n``````\n",
    "created_at": "2012-05-28T23:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190632",
    "user": "https://github.com/mwhansen"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,3 +20,8 @@
 sage: _ = NF(J.groebner_basis(),J,attributes=(None,{'isSB':1}))
 ```
 works: attributes is a tuple or list of things that are to be interpreted as attribute of the different arguments of the singular function, in the given order.
+
+Apply
+
+* [attachment:trac12977_singular_function_attributes.patch]
+* [attachment:trac_12977-fix_doctest.patch]
``````




---

archive/issue_comments_190633.json:
```json
{
    "body": "Changing author from \"\" to \"Simon King\"",
    "created_at": "2012-05-28T23:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190633",
    "user": "https://github.com/mwhansen"
}
```

Changing author from "" to "Simon King"



---

archive/issue_comments_190634.json:
```json
{
    "body": "<a id='comment:7'></a>Attachment [trac_12977-fix_doctest.patch](tarball://root/attachments/some-uuid/ticket12977/trac_12977-fix_doctest.patch) by @mwhansen created at 2012-05-28 23:36:17\n\nSimon, your patch looks good, but I had to make a change to the doctest to get it to pass.  Are you okay with this change?  If so, you can mark this as positive review.\n\nFor the patchbot:\n\nApply trac12977_singular_function_attributes.patch and trac_12977-fix_doctest.patch",
    "created_at": "2012-05-28T23:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190634",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:7'></a>Attachment [trac_12977-fix_doctest.patch](tarball://root/attachments/some-uuid/ticket12977/trac_12977-fix_doctest.patch) by @mwhansen created at 2012-05-28 23:36:17

Simon, your patch looks good, but I had to make a change to the doctest to get it to pass.  Are you okay with this change?  If so, you can mark this as positive review.

For the patchbot:

Apply trac12977_singular_function_attributes.patch and trac_12977-fix_doctest.patch



---

archive/issue_comments_190635.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd40.5\".",
    "created_at": "2012-05-28T23:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190635",
    "user": "https://github.com/mwhansen"
}
```

Changing keywords from "" to "sd40.5".



---

archive/issue_comments_190636.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-29T05:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190636",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_190637.json:
```json
{
    "body": "<a id='comment:9'></a>a_attrib will be defined after any non-empty loop even if it doesn't break with a match\n\nI think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it). On that note, is indexing ever safe (do equal ideals always hash the same?)",
    "created_at": "2012-05-29T05:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190637",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:9'></a>a_attrib will be defined after any non-empty loop even if it doesn't break with a match

I think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it). On that note, is indexing ever safe (do equal ideals always hash the same?)



---

archive/issue_comments_190638.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 robertwb]:\n> a_attrib will be defined after any non-empty loop even if it doesn't break with a match\n\n\nI don't understand that comment. a_attrib is used only in the few lines that I changed. And what loop are you talking about? The outer loop `for a in args:` (line 559)? But a_attrib is set to None at each round of the outer loop: See the new line 630. \n\n> I think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it).\n\n\nOne could argue that by using the dictionary (i.e., the old syntax) you declare that you want comparison by equality rather than identity. And also note that in Singular you assign an attribute to an individual ideal; hence, I find it wrong that in Sage we assign the attributes to an equivalence class of ideal.\n\n> On that note, is indexing ever safe (do equal ideals always hash the same?)\n\n\nNo, as mentioned in the ticket description, the hash is totally broken (#12976). Two polynomial ideals are equal if they have the same reduced Gr\u00f6bner basis (computed in degrevlex order, if the GB for the \"real\" order ist not in the cache), but the hash relies on the given generators. That's why I support the old syntax only for backwards compatibility.",
    "created_at": "2012-05-29T05:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190638",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>Replying to [comment:9 robertwb]:
> a_attrib will be defined after any non-empty loop even if it doesn't break with a match


I don't understand that comment. a_attrib is used only in the few lines that I changed. And what loop are you talking about? The outer loop `for a in args:` (line 559)? But a_attrib is set to None at each round of the outer loop: See the new line 630. 

> I think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it).


One could argue that by using the dictionary (i.e., the old syntax) you declare that you want comparison by equality rather than identity. And also note that in Singular you assign an attribute to an individual ideal; hence, I find it wrong that in Sage we assign the attributes to an equivalence class of ideal.

> On that note, is indexing ever safe (do equal ideals always hash the same?)


No, as mentioned in the ticket description, the hash is totally broken (#12976). Two polynomial ideals are equal if they have the same reduced Gröbner basis (computed in degrevlex order, if the GB for the "real" order ist not in the cache), but the hash relies on the given generators. That's why I support the old syntax only for backwards compatibility.



---

archive/issue_comments_190639.json:
```json
{
    "body": "<a id='comment:11'></a>I am changing back to \"needs review\", as I think a_attrib is correctly used in the code, and I think I have addressed the other questions of Robert as well.",
    "created_at": "2012-05-29T19:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190639",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>I am changing back to "needs review", as I think a_attrib is correctly used in the code, and I think I have addressed the other questions of Robert as well.



---

archive/issue_comments_190640.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-29T19:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190640",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_190641.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 SimonKing]:\n> Replying to [comment:9 robertwb]:\n> > a_attrib will be defined after any non-empty loop even if it doesn't break with a match\n\n> \n> I don't understand that comment. a_attrib is used only in the few lines that I changed. And what loop are you talking about? The outer loop `for a in args:` (line 559)? But a_attrib is set to None at each round of the outer loop: See the new line 630. \n\n\n```\n \t634\t                    for a_,a_attrib in attributes: \n \t635\t                        if a_ is a: \n \t636\t                            break \n```\n\nIf the `a_ is a` clause is never executed, the loop will run to completion and `a_attrib` will have the value `attributes[-1][1]` unless attributes happens to be empty.\n\n> > I think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it).\n\n> \n> One could argue that by using the dictionary (i.e., the old syntax) you declare that you want comparison by equality rather than identity. \n\n\nBut this is equivalently subtle, I'd never guess that in seeing the two versions. In any case it's certainly not \n\n```\nsage: import this\nThe Zen of Python, by Tim Peters\n...\nExplicit is better than implicit.\n```\n\nAre you against having an explicit flag? \n\n> And also note that in Singular you assign an attribute to an individual ideal; hence, I find it wrong that in Sage we assign the attributes to an equivalence class of ideal.\n\n\nI'm with you here, but that's orthogonal.",
    "created_at": "2012-05-29T21:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190641",
    "user": "https://github.com/robertwb"
}
```

<a id='comment:12'></a>Replying to [comment:10 SimonKing]:
> Replying to [comment:9 robertwb]:
> > a_attrib will be defined after any non-empty loop even if it doesn't break with a match

> 
> I don't understand that comment. a_attrib is used only in the few lines that I changed. And what loop are you talking about? The outer loop `for a in args:` (line 559)? But a_attrib is set to None at each round of the outer loop: See the new line 630. 


```
 	634	                    for a_,a_attrib in attributes: 
 	635	                        if a_ is a: 
 	636	                            break 
```

If the `a_ is a` clause is never executed, the loop will run to completion and `a_attrib` will have the value `attributes[-1][1]` unless attributes happens to be empty.

> > I think that this interface is rather subtle, I'd rather have a compare_using_identiy=[True|False] keyword in the function (which will iterate over the dictionary rather than indexing into it).

> 
> One could argue that by using the dictionary (i.e., the old syntax) you declare that you want comparison by equality rather than identity. 


But this is equivalently subtle, I'd never guess that in seeing the two versions. In any case it's certainly not 

```
sage: import this
The Zen of Python, by Tim Peters
...
Explicit is better than implicit.
```

Are you against having an explicit flag? 

> And also note that in Singular you assign an attribute to an individual ideal; hence, I find it wrong that in Sage we assign the attributes to an equivalence class of ideal.


I'm with you here, but that's orthogonal.



---

archive/issue_comments_190642.json:
```json
{
    "body": "Changing work_issues from \"\" to \"Do not set a_attrib accidentally. Provide a flag for \"comparison by equality\"\"",
    "created_at": "2012-05-29T21:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190642",
    "user": "https://github.com/simon-king-jena"
}
```

Changing work_issues from "" to "Do not set a_attrib accidentally. Provide a flag for "comparison by equality""



---

archive/issue_comments_190643.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-05-29T21:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190643",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_190644.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 robertwb]:\n> {{{\n>  \t634\t                    for a_,a_attrib in attributes: \n>  \t635\t                        if a_ is a: \n>  \t636\t                            break \n> }}}\n> \n> If the `a_ is a` clause is never executed, the loop will run to completion and `a_attrib` will have the value `attributes[-1][1]` unless attributes happens to be empty.\n\n\nI see. Right, that has to be fixed.\n\n> Are you against having an explicit flag? \n\n\nI think the default should be \"comparison by identity\", because I am sure that this is how the attributes argument is intended to be used.\n\nI also think that (for backwards compatibility) one should still support the old syntax, for which \"comparison by Gr\u00f6bner basis computation and broken hash\" is implicit.\n\nAnd I think that there is no harm in providing an explicit flag if one wants the new syntax with a \"comparison by Gr\u00f6bner bass computation but without broken hash involved since there is a list and not a dictionary of ideal-attribute pairs\".",
    "created_at": "2012-05-29T21:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190644",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>Replying to [comment:12 robertwb]:
> {{{
>  	634	                    for a_,a_attrib in attributes: 
>  	635	                        if a_ is a: 
>  	636	                            break 
> }}}
> 
> If the `a_ is a` clause is never executed, the loop will run to completion and `a_attrib` will have the value `attributes[-1][1]` unless attributes happens to be empty.


I see. Right, that has to be fixed.

> Are you against having an explicit flag? 


I think the default should be "comparison by identity", because I am sure that this is how the attributes argument is intended to be used.

I also think that (for backwards compatibility) one should still support the old syntax, for which "comparison by Gröbner basis computation and broken hash" is implicit.

And I think that there is no harm in providing an explicit flag if one wants the new syntax with a "comparison by Gröbner bass computation but without broken hash involved since there is a list and not a dictionary of ideal-attribute pairs".



---

archive/issue_comments_190645.json:
```json
{
    "body": "Attachment [trac12977_singular_function_attributes.patch](tarball://root/attachments/some-uuid/ticket12977/trac12977_singular_function_attributes.patch) by @simon-king-jena created at 2013-05-22 15:15:20\n\nAn alternative way of passing attributes to singular_function that won't involve GB computations",
    "created_at": "2013-05-22T15:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190645",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac12977_singular_function_attributes.patch](tarball://root/attachments/some-uuid/ticket12977/trac12977_singular_function_attributes.patch) by @simon-king-jena created at 2013-05-22 15:15:20

An alternative way of passing attributes to singular_function that won't involve GB computations



---

archive/issue_comments_190646.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-22T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190646",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_190647.json:
```json
{
    "body": "<a id='comment:14'></a>Sorry for not finishing it earlier.\n\nI hope I did address the two complaints successfully. In particular, a_attrib will now only be non-none, if it actually applies to one of the arguments. And I provide an optional argument by which one can choose whether one wants comparison by identity or by equality.\n\nIf the attributes are passed as a dict, then there is no change w.r.t old behaviour: The broken hash will be used, and comparison by equality. In particular, this will not break things that were not broken before.\n\nIf the attributes are passed as a tuple or list, then the default is a comparison by identity---I can not imagine a use case in which one would like to compare by equality. But if one really wants equality, one can set an optional parameter accordingly.\n\nFurther changes: I tried to make the new syntax more visible in the docs. The second patch is not needed. Hence:\n\nApply trac12977_singular_function_attributes.patch",
    "created_at": "2013-05-22T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190647",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>Sorry for not finishing it earlier.

I hope I did address the two complaints successfully. In particular, a_attrib will now only be non-none, if it actually applies to one of the arguments. And I provide an optional argument by which one can choose whether one wants comparison by identity or by equality.

If the attributes are passed as a dict, then there is no change w.r.t old behaviour: The broken hash will be used, and comparison by equality. In particular, this will not break things that were not broken before.

If the attributes are passed as a tuple or list, then the default is a comparison by identity---I can not imagine a use case in which one would like to compare by equality. But if one really wants equality, one can set an optional parameter accordingly.

Further changes: I tried to make the new syntax more visible in the docs. The second patch is not needed. Hence:

Apply trac12977_singular_function_attributes.patch



---

archive/issue_comments_190648.json:
```json
{
    "body": "Changing work_issues from \"Do not set a_attrib accidentally. Provide a flag for \"comparison by equality\"\" to \"\"",
    "created_at": "2013-05-22T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190648",
    "user": "https://github.com/simon-king-jena"
}
```

Changing work_issues from "Do not set a_attrib accidentally. Provide a flag for "comparison by equality"" to ""



---

archive/issue_comments_190649.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -24,4 +24,3 @@\n Apply\n \n * [attachment:trac12977_singular_function_attributes.patch]\n-* [attachment:trac_12977-fix_doctest.patch]\n``````\n",
    "created_at": "2013-05-22T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190649",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -24,4 +24,3 @@
 Apply
 
 * [attachment:trac12977_singular_function_attributes.patch]
-* [attachment:trac_12977-fix_doctest.patch]
``````




---

archive/issue_events_035527.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35527"
}
```



---

archive/issue_comments_190650.json:
```json
{
    "body": "<a id='comment:16'></a>Is there any reviewer? I still think it is a good idea to not use multivariate polynomial ideals as dictionary keys, given the fact that their hash is broken (or used to be broken until recently) and comparison can be extremely slow due to Gr\u00f6bner basis computations.",
    "created_at": "2013-08-15T08:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190650",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>Is there any reviewer? I still think it is a good idea to not use multivariate polynomial ideals as dictionary keys, given the fact that their hash is broken (or used to be broken until recently) and comparison can be extremely slow due to Gröbner basis computations.



---

archive/issue_comments_190651.json:
```json
{
    "body": "<a id='comment:17'></a>Sorry for being late to the party. \n\nI am wondering, though, whether we every want to compare **not** by identit as we are talking about attributes of objects here. \n\nWe could keep the dict notation but write our own little loop (similar to your tuple loop) which compares keys. These dicts will be small, so the overhead is okay, I'd say.",
    "created_at": "2013-08-15T10:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190651",
    "user": "https://github.com/malb"
}
```

<a id='comment:17'></a>Sorry for being late to the party. 

I am wondering, though, whether we every want to compare **not** by identit as we are talking about attributes of objects here. 

We could keep the dict notation but write our own little loop (similar to your tuple loop) which compares keys. These dicts will be small, so the overhead is okay, I'd say.



---

archive/issue_comments_190652.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 malb]:\n> Sorry for being late to the party. \n> \n> I am wondering, though, whether we every want to compare **not** by identit as we are talking about attributes of objects here. \n\n\nI wonder as well. From my perspective, comparing by identity is fine.\n\n> We could keep the dict notation but write our own little loop (similar to your tuple loop) which compares keys. These dicts will be small, so the overhead is okay, I'd say.\n\n\nIs this really so easy? If the dictionary contains at least two ideals, then the *creation* of this dictionary might be problematic, due to broken hash and slow comparison.",
    "created_at": "2013-08-15T20:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190652",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>Replying to [comment:17 malb]:
> Sorry for being late to the party. 
> 
> I am wondering, though, whether we every want to compare **not** by identit as we are talking about attributes of objects here. 


I wonder as well. From my perspective, comparing by identity is fine.

> We could keep the dict notation but write our own little loop (similar to your tuple loop) which compares keys. These dicts will be small, so the overhead is okay, I'd say.


Is this really so easy? If the dictionary contains at least two ideals, then the *creation* of this dictionary might be problematic, due to broken hash and slow comparison.



---

archive/issue_comments_190653.json:
```json
{
    "body": "<a id='comment:19'></a>Ah, crap, yes, you're right. We shouldn't create dictionaries. How about we deprecate dicts and use your tuple construction instead?",
    "created_at": "2013-08-15T22:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190653",
    "user": "https://github.com/malb"
}
```

<a id='comment:19'></a>Ah, crap, yes, you're right. We shouldn't create dictionaries. How about we deprecate dicts and use your tuple construction instead?



---

archive/issue_events_035528.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35528"
}
```



---

archive/issue_events_035529.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35529"
}
```



---

archive/issue_comments_190654.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-03-31T07:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190654",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_035530.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35530"
}
```



---

archive/issue_events_035531.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35531"
}
```



---

archive/issue_events_035532.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35532"
}
```



---

archive/issue_events_035533.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12977#event-35533"
}
```



---

archive/issue_comments_190655.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:19 malb]:\n> Ah, crap, yes, you're right. We shouldn't create dictionaries. How about we deprecate dicts and use your tuple construction instead?\n\n\nWhy not?\n\nLet's get this fixed!",
    "created_at": "2015-07-23T14:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12977",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12977#issuecomment-190655",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>Replying to [comment:19 malb]:
> Ah, crap, yes, you're right. We shouldn't create dictionaries. How about we deprecate dicts and use your tuple construction instead?


Why not?

Let's get this fixed!
