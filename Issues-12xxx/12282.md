# Issue 12282: Fix strcmp() with NULL argument in termcap library

archive/issues_012110.json:
```json
{
    "body": "If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.\n\nTo reproduce this issue: let `tgetent_test.c` be the file\n\n```\n#include <termcap.h>\n#include <stdlib.h>\n#include <stdio.h>\n\nint main(int argc, char** argv)\n{\n    char* buf = malloc(100000);\n    tgetent(buf, \"dumb\");\n    printf(\"Successful!\\n\");\n}\n```\n\nNow compile and link this with Sage's `libtermcap.a` (don't use `-ltermcap`, instead explicitly specify the path to the `libtermcap.a` file):\n\n```\n$ gcc tgetent_test.c local/lib/libtermcap.a -o tgetent_test\n```\n\nRun this with `TERMCAP` set but `TERM` unset:\n\n```\n$ unset TERM\n$ export TERMCAP=\"x\"\n$ ./tgetent_test\nSegmentation fault\n```\n\nNot reported upstream because there is no known contact person nor bug report page.\n\n**Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)\n\nAssignee: tbd\n\nKeywords: sd35.5\n\nResolution: fixed\n\nAuthor: Jeroen Demeyer\n\nReviewer: Georg S. Weber\n\nUpstream: None of the above - read trac for reasoning.\n\nMerged: sage-4.8.rc0\n\nIssue created by migration from https://trac.sagemath.org/ticket/12282\n\n",
    "closed_at": "2012-01-15T15:40:49Z",
    "created_at": "2012-01-09T10:07:32Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Fix strcmp() with NULL argument in termcap library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12282",
    "user": "https://github.com/jdemeyer"
}
```
If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.

To reproduce this issue: let `tgetent_test.c` be the file

```
#include <termcap.h>
#include <stdlib.h>
#include <stdio.h>

int main(int argc, char** argv)
{
    char* buf = malloc(100000);
    tgetent(buf, "dumb");
    printf("Successful!\n");
}
```

Now compile and link this with Sage's `libtermcap.a` (don't use `-ltermcap`, instead explicitly specify the path to the `libtermcap.a` file):

```
$ gcc tgetent_test.c local/lib/libtermcap.a -o tgetent_test
```

Run this with `TERMCAP` set but `TERM` unset:

```
$ unset TERM
$ export TERMCAP="x"
$ ./tgetent_test
Segmentation fault
```

Not reported upstream because there is no known contact person nor bug report page.

**Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)

Assignee: tbd

Keywords: sd35.5

Resolution: fixed

Author: Jeroen Demeyer

Reviewer: Georg S. Weber

Upstream: None of the above - read trac for reasoning.

Merged: sage-4.8.rc0

Issue created by migration from https://trac.sagemath.org/ticket/12282





---

archive/issue_comments_172642.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2012-01-09T10:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172642",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_172643.json:
```json
{
    "body": "<a id='comment:1'></a>\nJeroen, I cannot reproduce this issue:\n\n```\ntiramisu% cat tgetent_test.c\n#include <termcap.h>\n#include <stdlib.h>\n\nint main(int argc, char** argv)\n{\n  char* buf = malloc(100000);\n  tgetent(buf, \"dumb\");\n}\ntiramisu% gcc tgetent_test.c -o tgetent_test -ltermcap\ntiramisu% printenv | grep TERM\nTERMCAP=1\ntiramisu% ./tgetent_test\ntiramisu%\n```\nPaul",
    "created_at": "2012-01-09T10:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172643",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:1'></a>
Jeroen, I cannot reproduce this issue:

```
tiramisu% cat tgetent_test.c
#include <termcap.h>
#include <stdlib.h>

int main(int argc, char** argv)
{
  char* buf = malloc(100000);
  tgetent(buf, "dumb");
}
tiramisu% gcc tgetent_test.c -o tgetent_test -ltermcap
tiramisu% printenv | grep TERM
TERMCAP=1
tiramisu% ./tgetent_test
tiramisu%
```
Paul



---

archive/issue_comments_172644.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd35.5\".",
    "created_at": "2012-01-09T10:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172644",
    "user": "https://github.com/zimmermann6"
}
```

Changing keywords from "" to "sd35.5".



---

archive/issue_comments_172645.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2012-01-09T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172645",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_172646.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2012-01-09T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172646",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_172647.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,33 @@\n If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.\n+\n+To reproduce this issue: let `tgetent_test.c` be the file\n+\n+```\n+#include <termcap.h>\n+#include <stdlib.h>\n+#include <stdio.h>\n+\n+int main(int argc, char** argv)\n+{\n+    char* buf = malloc(100000);\n+    tgetent(buf, \"dumb\");\n+    printf(\"Successful!\\n\");\n+}\n+```\n+\n+Now compile and link this with Sage's `libtermcap.a` (don't use `-ltermcap`, instead explicitly specify the path to the `libtermcap.a` file):\n+\n+```\n+$ gcc tgetent_test.c local/lib/libtermcap.a -o tgetent_test\n+```\n+\n+Run this with `TERMCAP` set but `TERM` unset:\n+\n+```\n+$ unset TERM\n+$ export TERMCAP=\"x\"\n+$ ./tgetent_test\n+Segmentation fault\n+```\n+\n+**Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)\n``````\n",
    "created_at": "2012-01-09T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172647",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,33 @@
 If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.
+
+To reproduce this issue: let `tgetent_test.c` be the file
+
+```
+#include <termcap.h>
+#include <stdlib.h>
+#include <stdio.h>
+
+int main(int argc, char** argv)
+{
+    char* buf = malloc(100000);
+    tgetent(buf, "dumb");
+    printf("Successful!\n");
+}
+```
+
+Now compile and link this with Sage's `libtermcap.a` (don't use `-ltermcap`, instead explicitly specify the path to the `libtermcap.a` file):
+
+```
+$ gcc tgetent_test.c local/lib/libtermcap.a -o tgetent_test
+```
+
+Run this with `TERMCAP` set but `TERM` unset:
+
+```
+$ unset TERM
+$ export TERMCAP="x"
+$ ./tgetent_test
+Segmentation fault
+```
+
+**Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)
``````




---

archive/issue_comments_172648.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe fix in the spkg is\n\n```diff\ndiff -ru src/termcap.c src.fixed/termcap.c\n--- src/termcap.c       2002-02-25 18:59:21.000000000 +0100\n+++ src.fixed/termcap.c 2012-01-09 11:04:54.000000000 +0100\n@@ -460,6 +460,7 @@\n   char *tcenv = NULL;          /* TERMCAP value, if it contains :tc=.  */\n   char *indirect = NULL;       /* Terminal type in :tc= in TERMCAP value.  */\n   int filep;\n+  char *term_name;\n \n #ifdef INTERNAL_TERMINAL\n   /* For the internal terminal we don't want to read any termcap file,\n@@ -500,7 +501,8 @@\n      it is the entry itself, but only if\n      the name the caller requested matches the TERM variable.  */\n \n-  if (termcap_name && !filep && !strcmp (name, getenv (\"TERM\")))\n+  term_name = getenv(\"TERM\");\n+  if (termcap_name && !filep && term_name && !strcmp (name, term_name))\n     {\n       indirect = tgetst1 (find_capability (termcap_name, \"tc\"), (char **) 0);\n       if (!indirect)\n```",
    "created_at": "2012-01-09T10:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172648",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
The fix in the spkg is

```diff
diff -ru src/termcap.c src.fixed/termcap.c
--- src/termcap.c       2002-02-25 18:59:21.000000000 +0100
+++ src.fixed/termcap.c 2012-01-09 11:04:54.000000000 +0100
@@ -460,6 +460,7 @@
   char *tcenv = NULL;          /* TERMCAP value, if it contains :tc=.  */
   char *indirect = NULL;       /* Terminal type in :tc= in TERMCAP value.  */
   int filep;
+  char *term_name;
 
 #ifdef INTERNAL_TERMINAL
   /* For the internal terminal we don't want to read any termcap file,
@@ -500,7 +501,8 @@
      it is the entry itself, but only if
      the name the caller requested matches the TERM variable.  */
 
-  if (termcap_name && !filep && !strcmp (name, getenv ("TERM")))
+  term_name = getenv("TERM");
+  if (termcap_name && !filep && term_name && !strcmp (name, term_name))
     {
       indirect = tgetst1 (find_capability (termcap_name, "tc"), (char **) 0);
       if (!indirect)
```



---

archive/issue_comments_172649.json:
```json
{
    "body": "<a id='comment:5'></a>\nDid you forget to commit the changes in the spkg?",
    "created_at": "2012-01-09T10:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172649",
    "user": "https://github.com/wjp"
}
```

<a id='comment:5'></a>
Did you forget to commit the changes in the spkg?



---

archive/issue_comments_172650.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [wjp](#comment%3A5):\n> Did you forget to commit the changes in the spkg?\n\n\nYes and no.  I prefer to commit them *after* positive_review (this leaves a cleaner hg repository if reviewers request small changes).",
    "created_at": "2012-01-09T10:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172650",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Replying to [wjp](#comment%3A5):
> Did you forget to commit the changes in the spkg?


Yes and no.  I prefer to commit them *after* positive_review (this leaves a cleaner hg repository if reviewers request small changes).



---

archive/issue_comments_172651.json:
```json
{
    "body": "Changing upstream from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. Little or no feedback.\"",
    "created_at": "2012-01-09T11:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172651",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "Not yet reported upstream; Will do shortly." to "Reported upstream. Little or no feedback."



---

archive/issue_comments_172652.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.\n+If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.\n \n To reproduce this issue: let `tgetent_test.c` be the file\n \n@@ -30,4 +30,6 @@\n Segmentation fault\n ```\n \n+Reported upstream by email to the email address in `src/README`.\n+\n **Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)\n``````\n",
    "created_at": "2012-01-09T11:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172652",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.
+If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.
 
 To reproduce this issue: let `tgetent_test.c` be the file
 
@@ -30,4 +30,6 @@
 Segmentation fault
 ```
 
+Reported upstream by email to the email address in `src/README`.
+
 **Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)
``````




---

archive/issue_comments_172653.json:
```json
{
    "body": "<a id='comment:9'></a>\nCommitted changes now.",
    "created_at": "2012-01-09T13:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172653",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Committed changes now.



---

archive/issue_comments_172654.json:
```json
{
    "body": "<a id='comment:10'></a>\nI'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant), but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM. Your suggested change prevents the TERMCAP value from being used at all in this case, I believe.",
    "created_at": "2012-01-09T13:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172654",
    "user": "https://github.com/wjp"
}
```

<a id='comment:10'></a>
I'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant), but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM. Your suggested change prevents the TERMCAP value from being used at all in this case, I believe.



---

archive/issue_comments_172655.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [wjp](#comment%3A10):\n> I'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant)\n\nThere is more info at #11970.  It's a combination of the new readline spkg at #11970 and the patch at #12263, and it also depends on the gcc version.\n\n> but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM.\n\nIn practice, this will be the case.  The `tgetent()` code checks whether the argument `char *term` equals the environment variable \"TERM\".  Normally, `term` will not be the empty string.  But you are certainly right that\n\n```\nterm_name = getenv(\"TERM\");\nif (!term_name)\n    term_name = \"\";\n```\nwould also work.",
    "created_at": "2012-01-09T13:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172655",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Replying to [wjp](#comment%3A10):
> I'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant)

There is more info at #11970.  It's a combination of the new readline spkg at #11970 and the patch at #12263, and it also depends on the gcc version.

> but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM.

In practice, this will be the case.  The `tgetent()` code checks whether the argument `char *term` equals the environment variable "TERM".  Normally, `term` will not be the empty string.  But you are certainly right that

```
term_name = getenv("TERM");
if (!term_name)
    term_name = "";
```
would also work.



---

archive/issue_comments_172656.json:
```json
{
    "body": "<a id='comment:13'></a>\nJust a small comment: line 10 of Makefile.patch should say\n\n+# I **commented** this (William), since SAGE install should work as not-root.\n\nMy experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.",
    "created_at": "2012-01-09T15:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172656",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:13'></a>
Just a small comment: line 10 of Makefile.patch should say

+# I **commented** this (William), since SAGE install should work as not-root.

My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.



---

archive/issue_comments_172657.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [ppurka](#comment%3A13):\n> Just a small comment: line 10 of Makefile.patch should say\n> \n> +# I **commented** this (William), since SAGE install should work as not-root.\n> \n> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.\n\n\nWell, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.\n\n* Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also **without** commenting out the `for` loop).\n\n* Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.\n\nIn the latter case we wouldn't have to patch the Makefile at all.\n\n(Slightly OT: Should we in general issue a warning -- or abort the build -- if someone builds Sage as root?)\n\n\n\n\nAnother minor thing: In `spkg-install`, `-m64` should be **ap**pended, since it should take precedence over whatever a user specified in `CFLAGS`.",
    "created_at": "2012-01-09T20:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172657",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>
Replying to [ppurka](#comment%3A13):
> Just a small comment: line 10 of Makefile.patch should say
> 
> +# I **commented** this (William), since SAGE install should work as not-root.
> 
> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.


Well, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.

* Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also **without** commenting out the `for` loop).

* Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.

In the latter case we wouldn't have to patch the Makefile at all.

(Slightly OT: Should we in general issue a warning -- or abort the build -- if someone builds Sage as root?)




Another minor thing: In `spkg-install`, `-m64` should be **ap**pended, since it should take precedence over whatever a user specified in `CFLAGS`.



---

archive/issue_comments_172658.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-01-09T20:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172658",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_172659.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [leif](#comment%3A14):\n> Well, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.\n> \n> * Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also **without** commenting out the `for` loop).\n> \n> * Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.\n> \n> In the latter case we wouldn't have to patch the Makefile at all.\n\nMaybe you are right, but I don't want to make these minor changes now in this blocker ticket.  If you want to make a follow-up ticket for the above, go ahead.\n\n> Another minor thing: In `spkg-install`, `-m64` should be **ap**pended, since it should take precedence over whatever a user specified in `CFLAGS`.\n\nDone.",
    "created_at": "2012-01-09T20:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172659",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Replying to [leif](#comment%3A14):
> Well, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.
> 
> * Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also **without** commenting out the `for` loop).
> 
> * Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.
> 
> In the latter case we wouldn't have to patch the Makefile at all.

Maybe you are right, but I don't want to make these minor changes now in this blocker ticket.  If you want to make a follow-up ticket for the above, go ahead.

> Another minor thing: In `spkg-install`, `-m64` should be **ap**pended, since it should take precedence over whatever a user specified in `CFLAGS`.

Done.



---

archive/issue_comments_172660.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [ppurka](#comment%3A13):\n> Just a small comment: line 10 of Makefile.patch should say\n> \n> +# I **commented** this (William), since SAGE install should work as not-root.\n\nThanks, I fixed this comment.\n\n> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch.\n\nLuckily, there is no need to review the Makefile.  This is an old patch which was directly applied to the src/ directory, instead of being applied by `spkg-install`.  I restored the upstream sources and made an explicit patch.  So the file `patches/Makefile.patch` doesn't need to be reviewed for this ticket.",
    "created_at": "2012-01-09T20:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172660",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [ppurka](#comment%3A13):
> Just a small comment: line 10 of Makefile.patch should say
> 
> +# I **commented** this (William), since SAGE install should work as not-root.

Thanks, I fixed this comment.

> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch.

Luckily, there is no need to review the Makefile.  This is an old patch which was directly applied to the src/ directory, instead of being applied by `spkg-install`.  I restored the upstream sources and made an explicit patch.  So the file `patches/Makefile.patch` doesn't need to be reviewed for this ticket.



---

archive/issue_comments_172661.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-09T20:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172661",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_172662.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [ticket:12282 jdemeyer]:\n> If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.\n\n\nTwo further remarks:\n\n* `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other \"abused\" environment variables).\n\n* readline isn't supposed to use *Sage's* termcap; the p4 at #11970 avoids its use under all circumstances (perhaps unless one manually adds `-L$SAGE_LOCAL/lib/` to `LDFLAGS` or the like).",
    "created_at": "2012-01-09T20:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172662",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:17'></a>
Replying to [ticket:12282 jdemeyer]:
> If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.


Two further remarks:

* `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other "abused" environment variables).

* readline isn't supposed to use *Sage's* termcap; the p4 at #11970 avoids its use under all circumstances (perhaps unless one manually adds `-L$SAGE_LOCAL/lib/` to `LDFLAGS` or the like).



---

archive/issue_comments_172663.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [leif](#comment%3A17):\n> Replying to [ticket:12282 jdemeyer]:\n> > If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.\n\n> \n> Two further remarks:\n> \n> * `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other \"abused\" environment variables).\n\nVery true.  Luckily, this problem is restricted to the Sage installation scripts, and not to running Sage (which would be a much more serious problem).\n\n>  * readline isn't supposed to use *Sage's* termcap;\n \nWhy not?  My guess is that we ship `termcap` precisely because `readline` might need it.",
    "created_at": "2012-01-09T20:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172663",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Replying to [leif](#comment%3A17):
> Replying to [ticket:12282 jdemeyer]:
> > If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.

> 
> Two further remarks:
> 
> * `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other "abused" environment variables).

Very true.  Luckily, this problem is restricted to the Sage installation scripts, and not to running Sage (which would be a much more serious problem).

>  * readline isn't supposed to use *Sage's* termcap;
 
Why not?  My guess is that we ship `termcap` precisely because `readline` might need it.



---

archive/issue_comments_172664.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [jdemeyer](#comment%3A18):\n> Replying to [leif](#comment%3A17):\n> >  * readline isn't supposed to use *Sage's* termcap;\n \n> Why not?  My guess is that we ship `termcap` precisely because `readline` might need it.\n\nNo, a few other packages like PARI use it.  If readline would use it, we should also build a shared library (which the package as is doesn't offer), and, more importantly, use *that* termcap library's headers (`-I$SAGE_LOCAL/include`).\n\nBut somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap. \n\nIn principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.\n\n---\n\nOne more thing: *Chang**e**log* lacks an *\"e\"* in `SPKG.txt`.\n\nI'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.",
    "created_at": "2012-01-09T21:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172664",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:19'></a>
Replying to [jdemeyer](#comment%3A18):
> Replying to [leif](#comment%3A17):
> >  * readline isn't supposed to use *Sage's* termcap;
 
> Why not?  My guess is that we ship `termcap` precisely because `readline` might need it.

No, a few other packages like PARI use it.  If readline would use it, we should also build a shared library (which the package as is doesn't offer), and, more importantly, use *that* termcap library's headers (`-I$SAGE_LOCAL/include`).

But somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap. 

In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.

---

One more thing: *Chang**e**log* lacks an *"e"* in `SPKG.txt`.

I'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.



---

archive/issue_comments_172665.json:
```json
{
    "body": "Attachment [termcap-1.3.1.p1-p2.diff](tarball://root/attachments/some-uuid/ticket12282/termcap-1.3.1.p1-p2.diff) by @jdemeyer created at 2012-01-11 10:19:51",
    "created_at": "2012-01-11T10:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172665",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [termcap-1.3.1.p1-p2.diff](tarball://root/attachments/some-uuid/ticket12282/termcap-1.3.1.p1-p2.diff) by @jdemeyer created at 2012-01-11 10:19:51



---

archive/issue_comments_172666.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [leif](#comment%3A19):\n> One more thing: *Chang**e**log* lacks an *\"e\"* in `SPKG.txt`.\n> \n> I'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.\n\nI made these changes, needs review.",
    "created_at": "2012-01-11T10:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172666",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
Replying to [leif](#comment%3A19):
> One more thing: *Chang**e**log* lacks an *"e"* in `SPKG.txt`.
> 
> I'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.

I made these changes, needs review.



---

archive/issue_comments_172667.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [leif](#comment%3A19):\n> But somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap.\n\nSince #11970, readline does link in Sage's termcap (at least with some compilers/linkers), so I don't think that #12098 was a mistake.",
    "created_at": "2012-01-11T10:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172667",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [leif](#comment%3A19):
> But somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap.

Since #11970, readline does link in Sage's termcap (at least with some compilers/linkers), so I don't think that #12098 was a mistake.



---

archive/issue_comments_172668.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [leif](#comment%3A19):\n> No, a few other packages like PARI use it.\n\nPARI certainly doesn't (I find no mention of the string \"termcap\" in the PARI source tree).\n\n> In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.\n\nIf this is true, then I would support this.  I don't know whether your assumption (\"replacements on every supported system\") is true though.",
    "created_at": "2012-01-11T10:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172668",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [leif](#comment%3A19):
> No, a few other packages like PARI use it.

PARI certainly doesn't (I find no mention of the string "termcap" in the PARI source tree).

> In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.

If this is true, then I would support this.  I don't know whether your assumption ("replacements on every supported system") is true though.



---

archive/issue_comments_172669.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [jdemeyer](#comment%3A22):\n> Replying to [leif](#comment%3A19):\n> > In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.\n\n> If this is true, then I would support this.  I don't know whether your assumption (\"replacements on every supported system\") is true though.\n\nThis might very well be true. I see this in the README of termcap:\n\n```\nHowever, use of termcap is discouraged.  Termcap is\nbeing phased out in favor of the terminfo-based ncurses library, which\ncontains an emulation of the termcap library routines in addition to\nan excellent curses implementation.  ncurses is available from the\nusual GNU archive sites.\n```\nterminfo seems to be around since 1981. That's a long enough time for all systems to have caught up by now. Other websites:\nhttp://www.catb.org/~esr/terminfo/\nhttp://en.wikipedia.org/wiki/Terminfo",
    "created_at": "2012-01-11T10:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172669",
    "user": "https://github.com/ppurka"
}
```

<a id='comment:23'></a>
Replying to [jdemeyer](#comment%3A22):
> Replying to [leif](#comment%3A19):
> > In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.

> If this is true, then I would support this.  I don't know whether your assumption ("replacements on every supported system") is true though.

This might very well be true. I see this in the README of termcap:

```
However, use of termcap is discouraged.  Termcap is
being phased out in favor of the terminfo-based ncurses library, which
contains an emulation of the termcap library routines in addition to
an excellent curses implementation.  ncurses is available from the
usual GNU archive sites.
```
terminfo seems to be around since 1981. That's a long enough time for all systems to have caught up by now. Other websites:
http://www.catb.org/~esr/terminfo/
http://en.wikipedia.org/wiki/Terminfo



---

archive/issue_comments_172670.json:
```json
{
    "body": "<a id='comment:24'></a>\nJust for fun I removed the termcap spkg and modified spkg/install and spkg/standard/deps accordingly.  All tests passed on sage.math and on OS X 10.6.  I haven't tried on any other platforms.",
    "created_at": "2012-01-12T06:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172670",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'></a>
Just for fun I removed the termcap spkg and modified spkg/install and spkg/standard/deps accordingly.  All tests passed on sage.math and on OS X 10.6.  I haven't tried on any other platforms.



---

archive/issue_comments_172671.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [jdemeyer](#comment%3A22):\n> Replying to [leif](#comment%3A19):\n> > No, a few other packages like PARI use it.\n\n> PARI certainly doesn't (I find no mention of the string \"termcap\" in the PARI source tree).\n\nLook into (e.g.) `pari-*/src/config/get_readline`.\n\nPARI usually looks for readline, and then ncurses, then eventually gives libtermcap a try (for `tgetent()`; but apparently only in conjunction with readline).",
    "created_at": "2012-01-12T21:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172671",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:25'></a>
Replying to [jdemeyer](#comment%3A22):
> Replying to [leif](#comment%3A19):
> > No, a few other packages like PARI use it.

> PARI certainly doesn't (I find no mention of the string "termcap" in the PARI source tree).

Look into (e.g.) `pari-*/src/config/get_readline`.

PARI usually looks for readline, and then ncurses, then eventually gives libtermcap a try (for `tgetent()`; but apparently only in conjunction with readline).



---

archive/issue_comments_172672.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -30,6 +30,6 @@\n Segmentation fault\n ```\n \n-Reported upstream by email to the email address in `src/README`.\n+Not reported upstream because there is no known contact person nor bug report page.\n \n **Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)\n``````\n",
    "created_at": "2012-01-14T14:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172672",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -30,6 +30,6 @@
 Segmentation fault
 ```
 
-Reported upstream by email to the email address in `src/README`.
+Not reported upstream because there is no known contact person nor bug report page.
 
 **Apply**: [http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/termcap-1.3.1.p2.spkg)
``````




---

archive/issue_comments_172673.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. Little or no feedback.\" to \"None of the above - read trac for reasoning.\"",
    "created_at": "2012-01-14T14:39:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172673",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "Reported upstream. Little or no feedback." to "None of the above - read trac for reasoning."



---

archive/issue_comments_172674.json:
```json
{
    "body": "<a id='comment:27'></a>\nLooks good to me.",
    "created_at": "2012-01-15T15:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172674",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

<a id='comment:27'></a>
Looks good to me.



---

archive/issue_comments_172675.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-15T15:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172675",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_032834.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-15T15:40:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12282#event-32834"
}
```



---

archive/issue_comments_172676.json:
```json
{
    "body": "<a id='comment:28'></a>\nMany thanks for the review.",
    "created_at": "2012-01-15T15:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172676",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Many thanks for the review.



---

archive/issue_comments_172677.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-15T15:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172677",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_172678.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-4.8.rc0\"",
    "created_at": "2012-01-15T15:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172678",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-4.8.rc0"



---

archive/issue_comments_172679.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Georg S. Weber\"",
    "created_at": "2012-01-15T22:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172679",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Georg S. Weber"



---

archive/issue_comments_172680.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [jdemeyer](#comment%3A6):\n> Replying to [wjp](#comment%3A5):\n> > Did you forget to commit the changes in the spkg?\n\n> \n> Yes and no.  I prefer to commit them *after* positive_review (this leaves a cleaner hg repository if reviewers request small changes).\n\n\nFWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.",
    "created_at": "2012-01-16T05:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172680",
    "user": "https://github.com/kini"
}
```

<a id='comment:30'></a>
Replying to [jdemeyer](#comment%3A6):
> Replying to [wjp](#comment%3A5):
> > Did you forget to commit the changes in the spkg?

> 
> Yes and no.  I prefer to commit them *after* positive_review (this leaves a cleaner hg repository if reviewers request small changes).


FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.



---

archive/issue_comments_172681.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [kini](#comment%3A30):\n> FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.\n\nI didn't know this, thanks for the \"tip\".",
    "created_at": "2012-01-16T08:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172681",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
Replying to [kini](#comment%3A30):
> FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.

I didn't know this, thanks for the "tip".



---

archive/issue_comments_172682.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [jdemeyer](#comment%3A31):\n> Replying to [kini](#comment%3A30):\n> > FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.\n\n> I didn't know this, thanks for the \"tip\".\n\nFWIW, for a single \"uncommit\", you can also use `hg rollback`.",
    "created_at": "2012-01-16T18:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172682",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:32'></a>
Replying to [jdemeyer](#comment%3A31):
> Replying to [kini](#comment%3A30):
> > FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.

> I didn't know this, thanks for the "tip".

FWIW, for a single "uncommit", you can also use `hg rollback`.



---

archive/issue_comments_172683.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [leif](#comment%3A32):\n> FWIW, for a single \"uncommit\", you can also use `hg rollback`.\n\n\nWell, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.",
    "created_at": "2012-01-17T04:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172683",
    "user": "https://github.com/kini"
}
```

<a id='comment:33'></a>
Replying to [leif](#comment%3A32):
> FWIW, for a single "uncommit", you can also use `hg rollback`.


Well, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.



---

archive/issue_comments_172684.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [kini](#comment%3A33):\n> Replying to [leif](#comment%3A32):\n> > FWIW, for a single \"uncommit\", you can also use `hg rollback`.\n\n> \n> Well, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.\n\n\n:-) As always, one should know what one's doing...\n\nI was thinking of (and originally planned to write) smth like\n\n```sh\nwhile true; do\n    hg commit -m \"foo\"\n    hg rollback\n    # edit\n    # reupload spkg\ndone\n```",
    "created_at": "2012-01-17T19:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12282",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12282#issuecomment-172684",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:34'></a>
Replying to [kini](#comment%3A33):
> Replying to [leif](#comment%3A32):
> > FWIW, for a single "uncommit", you can also use `hg rollback`.

> 
> Well, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.


:-) As always, one should know what one's doing...

I was thinking of (and originally planned to write) smth like

```sh
while true; do
    hg commit -m "foo"
    hg rollback
    # edit
    # reupload spkg
done
```
