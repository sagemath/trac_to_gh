# Issue 22511: Provide yasm when not available

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2017-04-03 11:45:45

CC:  jdemeyer vbraun fbissey

yasm is needed to compile MPIR (see #22493)


---

Comment by jpflori created at 2017-04-25 16:42:09

Changing status from new to needs_review.


---

Comment by jpflori created at 2017-04-25 16:42:09

At the moment yasm won't be built when building Sage...

I'll trigger that when updating MPIR.
----
New commits:


---

Comment by jdemeyer created at 2017-04-25 17:45:48

Replying to [comment:1 jpflori]:
> At the moment yasm won't be built when building Sage...

It's a standard package, so it will be built. It just won't be used by anything.


---

Comment by jpflori created at 2017-04-25 17:46:49

Ok, I thought that if nothing depended on it, it could get skipped.


---

Comment by jdemeyer created at 2017-04-25 17:51:40

Replying to [comment:4 jpflori]:
> Ok, I thought that if nothing depended on it, it could get skipped.

No no. Otherwise there would be no difference between standard and optional packages.


---

Comment by fbissey created at 2017-04-25 20:16:13

A more interesting question, to me, would be whether or not it should be rebuilt after gcc is built, like mpir/mpfr/mpc. I'd say it would be overkill but I am ready to hear other opinions.


---

Comment by jdemeyer created at 2017-04-25 20:20:59

I see no reason to rebuild yasm, which is just a build tool.


---

Comment by fbissey created at 2017-04-25 20:36:57

An assembler that outputs object code, just a build tool? We have different opinions.  

Anyway since it is to be a standard package we should at least test if it builds on non-x86 architectures where it cannot be used anyway. I am not sure if it could pass its test suite on arm or ppc64. May be we need to do something more subtle in configure.


---

Comment by fbissey created at 2017-04-25 23:54:22

Somewhat surprisingly only 3 tests fail on ppc64

```
==================================
   yasm 1.3.0: ./test-suite.log
==================================

# TOTAL: 44
# PASS:  41
# SKIP:  0
# XFAIL: 0
# FAIL:  3
# XPASS: 0
# ERROR: 0

.. contents:: :depth: 2

FAIL: modules/objfmts/elf/tests/amd64/elf_amd64_test.sh
=======================================================

Test elf_amd64_test: ..O. +3-1/4 75%
 ** O: gotpcrel did not match object file!

FAIL: modules/objfmts/elf/tests/x32/elf_x32_test.sh
===================================================

Test elf_x32_test: O... +3-1/4 75%
 ** O: elf-rip did not match object file!

FAIL: modules/objfmts/elf/tests/gasx32/elf_gasx32_test.sh
=========================================================

Test elf_gasx32_test: O... +3-1/4 75%
 ** O: crosssect did not match object file!
```

but at the minimum I think we should only allow `spkg-check` to be run on intel class hardware.


---

Comment by jpflori created at 2017-04-26 12:57:53

Is it really problematic?
Remember that at the moment we ship GIAC which is completely broken outside x86*...

You can still modify spkg-check to disable testing on non-x86* if you want.


---

Comment by jpflori created at 2017-04-26 12:59:49

I guess there is no need to rebuild yasm: its output won't depend on the compiler used to build it (or do I hope), it "just" takes text and makes binary from it.


---

Comment by fbissey created at 2017-04-27 00:07:34

Replying to [comment:11 jpflori]:
> I guess there is no need to rebuild yasm: its output won't depend on the compiler used to build it (or do I hope), it "just" takes text and makes binary from it.

You mean, just like a compiler ;)

It is true that at the moment we are borked out on ppc64 and arm64 so it doesn't matter so much I guess.


---

Comment by jpflori created at 2017-04-28 07:22:45

So an we get this in?
Note that it is really a trivial ticket as yasm was already built before when building mpir.


---

Comment by fbissey created at 2017-04-28 07:29:29

Replying to [comment:13 jpflori]:
> So an we get this in?

yes 

> Note that it is really a trivial ticket as yasm was already built before when building mpir.

mpir only built yasm on x86(_64), this will build everywhere it can.


---

Comment by jpflori created at 2017-04-28 07:37:50

True, I did not notice mpir was that smart!


---

Comment by jdemeyer created at 2017-04-28 11:56:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-04-28 12:09:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-04-28 12:13:59

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-04-28 12:56:19

Jeroen changes look good to me.


---

Comment by jdemeyer created at 2017-04-28 13:38:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-29 23:30:07

Resolution: fixed


---

Comment by vbraun created at 2017-06-11 14:35:14

Followup at #23217


---

Comment by rws created at 2017-09-12 14:24:12

Another followup at #23841.
