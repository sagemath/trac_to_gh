# Issue 11762: Symbolic simplification error

archive/issues_011762.json:
```json
{
    "body": "Assignee: burcin\n\nI ran into this today with a real function. Sorry I don't have a shorter test case. The attached file should show a simplification which, as far as I can tell, is invalid.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11934\n\n",
    "created_at": "2011-10-17T19:17:55Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "Symbolic simplification error",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11762",
    "user": "mjo"
}
```
Assignee: burcin

I ran into this today with a real function. Sorry I don't have a shorter test case. The attached file should show a simplification which, as far as I can tell, is invalid.

Issue created by migration from https://trac.sagemath.org/ticket/11934





---

archive/issue_comments_134014.json:
```json
{
    "body": "Attachment\n\nA sage file that displays and attempts to plot the simplification",
    "created_at": "2011-10-17T19:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134014",
    "user": "mjo"
}
```

Attachment

A sage file that displays and attempts to plot the simplification



---

archive/issue_comments_134015.json:
```json
{
    "body": "Can you be more specific about the invalidity?    I think the plot errors are because of the imaginary pieces.  Remember, these simplifications are not supposed to be 100 percent valid at all times; especially with roots there are branch issues, unfortunately.  The `f` in question is pretty long - any sense as to where it might simplify in an unusual way?",
    "created_at": "2011-10-18T02:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134015",
    "user": "kcrisman"
}
```

Can you be more specific about the invalidity?    I think the plot errors are because of the imaginary pieces.  Remember, these simplifications are not supposed to be 100 percent valid at all times; especially with roots there are branch issues, unfortunately.  The `f` in question is pretty long - any sense as to where it might simplify in an unusual way?



---

archive/issue_comments_134016.json:
```json
{
    "body": "Replying to [comment:1 kcrisman]:\n> Can you be more specific about the invalidity?\n\nThis seems to be the root of the problem. My function is real, the simplification is not:\n\n\n```\nsage: n(f(x=-0.5))\n0.0175781250000000\n\nsage: n(f.full_simplify()(x=-0.5))\n0.0175781250000000 - 1.27567374911183e-18*I\n```\n\n\nI realize that the imaginary part is basically zero, but one of the simplifications has overstepped its bounds somewhere in that the expression is verifiably different pre- and post-simplification.",
    "created_at": "2011-10-18T02:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134016",
    "user": "mjo"
}
```

Replying to [comment:1 kcrisman]:
> Can you be more specific about the invalidity?

This seems to be the root of the problem. My function is real, the simplification is not:


```
sage: n(f(x=-0.5))
0.0175781250000000

sage: n(f.full_simplify()(x=-0.5))
0.0175781250000000 - 1.27567374911183e-18*I
```


I realize that the imaginary part is basically zero, but one of the simplifications has overstepped its bounds somewhere in that the expression is verifiably different pre- and post-simplification.



---

archive/issue_comments_134017.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134017",
    "user": "jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_134018.json:
```json
{
    "body": "This really depends on #12737, but for the patch to apply nicely, #12322 should go in first.",
    "created_at": "2012-03-24T00:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134018",
    "user": "mjo"
}
```

This really depends on #12737, but for the patch to apply nicely, #12322 should go in first.



---

archive/issue_comments_134019.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-24T00:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134019",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_134020.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-06-12T20:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134020",
    "user": "kcrisman"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_134021.json:
```json
{
    "body": "I'm questioning whether this really is fixing anything.   First, it's still there with `simplify_radical`.\n\n```\nsage: f = sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\nsage: f.subs(x=-1/2).n()\n1.47861134210963\nsage: f.simplify_radical().subs(x=-1/2).n()\n1.47861134210963 - 9.05388323648765e-17*I\n```\n\nSecondly, the problem is really this.  Notice I'm not simplifying anything at all here.\n\n```\nsage: h = I*x^(1/2)\nsage: h(x=-1/2)\nI*sqrt(-1/2)\nsage: h(x=-1/2).n()\n-0.707106781186548 + 4.32978028117747e-17*I\n```\n\nNeeds work/info, but not because of your patch or #12737, but rather because this doesn't really treat the underlying issue.  This could just be some floating point thing that is inherently impossible to avoid once one allows complex numbers (and since your original example is complex sometimes, the answers are going to be complex, unfortunately).",
    "created_at": "2013-06-12T20:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134021",
    "user": "kcrisman"
}
```

I'm questioning whether this really is fixing anything.   First, it's still there with `simplify_radical`.

```
sage: f = sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
sage: f.subs(x=-1/2).n()
1.47861134210963
sage: f.simplify_radical().subs(x=-1/2).n()
1.47861134210963 - 9.05388323648765e-17*I
```

Secondly, the problem is really this.  Notice I'm not simplifying anything at all here.

```
sage: h = I*x^(1/2)
sage: h(x=-1/2)
I*sqrt(-1/2)
sage: h(x=-1/2).n()
-0.707106781186548 + 4.32978028117747e-17*I
```

Needs work/info, but not because of your patch or #12737, but rather because this doesn't really treat the underlying issue.  This could just be some floating point thing that is inherently impossible to avoid once one allows complex numbers (and since your original example is complex sometimes, the answers are going to be complex, unfortunately).



---

archive/issue_comments_134022.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> Needs work/info, but not because of your patch or #12737, but rather because this doesn't really treat the underlying issue.  This could just be some floating point thing that is inherently impossible to avoid once one allows complex numbers (and since your original example is complex sometimes, the answers are going to be complex, unfortunately).\n\nThere aren't any floating point issues if you don't call `n()` on anything. The issue is still there with `simplify_radical()`, but that's because `simplify_radical()` is broken by design: it chooses a branch arbitrarily for the square root. This is what `radcan()` in Maxima is documented to do, but if you re-brand it as a simplification, it's a bug.\n\nPlain `simplify()` works:\n\n\n```\nsage: f = sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\nsage: f.simplify()\nsqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\n```\n\n\nAs does `simplify_trig()`:\n\n\n```\nsage: f.simplify_trig()\nsqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\n```\n\n\nAnd `simplify_rational()`:\n\n\n```\nsage: f.simplify_rational()\nsqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\n```\n\n\nAnd `simplify_log()`:\n\n\n```\nsage: f.simplify_log()\nsqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)\n```\n\n\nIt's only `simplify_radical()` that messes everything up (note I haven't called `n()` anywhere, so there are no numerical issues):\n\n\n```\nsage: f.simplify_radical()\n2*I*sqrt((4*sqrt(2) - 7)*x - 6*sqrt(2) + 10)*sqrt(2)*x^(3/2)\n```\n\n\nI don't want a random branch of the square root when I ask for a simplification. I want a simplification, but only if possible! Without more information, you can't simplify that expression. The rest of the simplify functions don't do anything, but that's the correct thing to do here.",
    "created_at": "2013-06-16T03:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134022",
    "user": "mjo"
}
```

Replying to [comment:6 kcrisman]:
> Needs work/info, but not because of your patch or #12737, but rather because this doesn't really treat the underlying issue.  This could just be some floating point thing that is inherently impossible to avoid once one allows complex numbers (and since your original example is complex sometimes, the answers are going to be complex, unfortunately).

There aren't any floating point issues if you don't call `n()` on anything. The issue is still there with `simplify_radical()`, but that's because `simplify_radical()` is broken by design: it chooses a branch arbitrarily for the square root. This is what `radcan()` in Maxima is documented to do, but if you re-brand it as a simplification, it's a bug.

Plain `simplify()` works:


```
sage: f = sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
sage: f.simplify()
sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
```


As does `simplify_trig()`:


```
sage: f.simplify_trig()
sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
```


And `simplify_rational()`:


```
sage: f.simplify_rational()
sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
```


And `simplify_log()`:


```
sage: f.simplify_log()
sqrt(-8*(4*sqrt(2) - 7)*x^4 + 16*(3*sqrt(2) - 5)*x^3)
```


It's only `simplify_radical()` that messes everything up (note I haven't called `n()` anywhere, so there are no numerical issues):


```
sage: f.simplify_radical()
2*I*sqrt((4*sqrt(2) - 7)*x - 6*sqrt(2) + 10)*sqrt(2)*x^(3/2)
```


I don't want a random branch of the square root when I ask for a simplification. I want a simplification, but only if possible! Without more information, you can't simplify that expression. The rest of the simplify functions don't do anything, but that's the correct thing to do here.



---

archive/issue_comments_134023.json:
```json
{
    "body": "Attachment\n\nDoctest for a subexpression of the one in the ticket",
    "created_at": "2013-08-17T01:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134023",
    "user": "mjo"
}
```

Attachment

Doctest for a subexpression of the one in the ticket



---

archive/issue_comments_134024.json:
```json
{
    "body": "I just uploaded a slightly better doctest now that this is fixed.",
    "created_at": "2013-08-17T01:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134024",
    "user": "mjo"
}
```

I just uploaded a slightly better doctest now that this is fixed.



---

archive/issue_comments_134025.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-08-17T01:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134025",
    "user": "mjo"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_134026.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-07T08:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134026",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_134027.json:
```json
{
    "body": "This doesn't seem to depend on #12322 at all.",
    "created_at": "2013-12-07T08:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134027",
    "user": "jdemeyer"
}
```

This doesn't seem to depend on #12322 at all.



---

archive/issue_comments_134028.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> This doesn't seem to depend on #12322 at all.\n\nBoth tickets add a doctest in exactly the same spot, so I added the dep to avoid fuzzing the patches. But you're right, the changes themselves are independent.",
    "created_at": "2013-12-07T16:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11762",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11762#issuecomment-134028",
    "user": "mjo"
}
```

Replying to [comment:10 jdemeyer]:
> This doesn't seem to depend on #12322 at all.

Both tickets add a doctest in exactly the same spot, so I added the dep to avoid fuzzing the patches. But you're right, the changes themselves are independent.
