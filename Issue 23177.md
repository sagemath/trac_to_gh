# Issue 23177: Clean up dict_del_by_value

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-07-12 17:37:27




---

Comment by nbruin created at 2017-07-13 09:52:14

I intentionally kept the definitions of `PyDictEntry` etc. out of the `pxd`: I didn't feel that it was the task of that pxd to provide interfaces to CPython API, in particular because they are Py2/Py3 dependent. Do you have a good reason to start exposing these in the pxd? Also, differentiating between the different fields depending on implementation by just comments seems a little fragile to me. It punts all errors to the c compile, whereas the cythonization can already fail here.
----
New commits:


---

Comment by jdemeyer created at 2017-07-13 10:00:20

Replying to [comment:2 nbruin]:
> Do you have a good reason to start exposing these in the pxd?

The main reason is to eventually move those to Cython itself. Usually, Cython upstream welcomes additional declarations regarding the CPython API.


---

Comment by jdemeyer created at 2017-07-13 10:00:30

Changing status from new to needs_review.


---

Comment by nbruin created at 2017-07-17 13:44:16

Replying to [comment:3 jdemeyer]:
> The main reason is to eventually move those to Cython itself. Usually, Cython upstream welcomes additional declarations regarding the CPython API.

OK. The part of the API that gets exposed is indeed part of what `Python.h` publishes. However, it is a bit that is dependent on Py2/Py3. Currently, the header file basically publishes the union, leaving it to the C compiler afterwards to raise an error in case of a python version mismatch. So code that includes this header file needs to guard on Py2/Py3.

On the other hand, the file backports `PyDict_GetItemWithError`, which works towards writing code that is Py2/Py3 agnostic.

Furthermore, the main purpose of this module is to provide a function that is badly bound to unpublished implementation details of dictionaries. As far as I know, the routine provided here is only a good idea for an improved implementation of `WeakValueDict`. So its `pxd` would ideally only include `del_dictitem_by_exact_value`, so that people only create dependencies on this module if they really need to.

I'm a little hesitant to name this a good API choice. Since this ticket is only about refactoring, I think we only want to merge it if it actually improves the API and the reasons above make me doubt that.

I don't think the change proposed is disastrous either, so if there's another reviewer who thinks the proposed change really does provide an improvement, I won't argue.

The easiest way to accomplish integration into cython is probably just to generate a pull request to include these definitions into `site-packages/Cython/Includes/cpython/dict.pxd`.

It'll be relatively complicated, because Cython tries to generate C-code that can be compiled against `Py2` as well as `Py3` and they are fundamentally incompatible for this.


---

Comment by jdemeyer created at 2017-07-17 14:01:49

When talking about moving to Cython, I meant just the declarations of the structs, not everything in this Sage module.


---

Comment by jdemeyer created at 2017-07-17 14:03:51

Replying to [comment:5 nbruin]:
> The easiest way to accomplish integration into cython is probably just to generate a pull request to include these definitions into `site-packages/Cython/Includes/cpython/dict.pxd`.

I usually prefer to put the code in Sage first, as some kind of testcase. When it's been shown that the Sage code works, I'll make a pull request. Otherwise, you might end up in a situation where you first make a pull request and then realize that it doesn't quite work.


---

Comment by nbruin created at 2017-07-17 22:03:53

Replying to [comment:6 jdemeyer]:
> When talking about moving to Cython, I meant just the declarations of the structs, not everything in this Sage module.

Yes, I understand. I think moving those to cython would be fine. 

The problem with the structs is that these are incompatible between Py2/Py3 and that code for one will not compile on the other. And I'm not sure that taking the union of the two on the cython level is the best way to handle (hide) this incompatibility. I also don't think sage is a great testing ground for Py2/Py3 compatibility just yet, because it doesn't really get compiled on Py3 yet.

My main concern is that this module, because it implements relatively dangerous stuff, is not an appropriate testing ground either.


---

Comment by jdemeyer created at 2017-07-18 07:47:14

Replying to [comment:8 nbruin]:
> My main concern is that this module, because it implements relatively dangerous stuff, is not an appropriate testing ground either.

Well, it is a testing ground to ensure that stuff compiles, which is really the only thing which could go wrong with the `struct` declarations.


---

Comment by jdemeyer created at 2017-07-18 07:59:59

Replying to [comment:8 nbruin]:
> The problem with the structs is that these are incompatible between Py2/Py3 and that code for one will not compile on the other. And I'm not sure that taking the union of the two on the cython level is the best way to handle (hide) this incompatibility.

It's simple, it works. Why not?


---

Comment by nbruin created at 2017-07-18 09:07:13

Replying to [comment:10 jdemeyer]:
> It's simple, it works. Why not?

It just looks wrong to me because the struct definition is not a subset of the fields available (not on Py2 and not on Py3), and there's a struct definition that is not available on Py3.

I was hoping to help and review this ticket, but I don't feel this is within my expertise. I'd be comfortable if the different structs were guarded by a `PY_HEX_VERSION` or similar, because then it is clearly declaring the right thing.


---

Comment by nbruin created at 2017-07-18 09:09:07

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 nbruin]:
> > My main concern is that this module, because it implements relatively dangerous stuff, is not an appropriate testing ground either.
> 
> Well, it is a testing ground to ensure that stuff compiles, which is really the only thing which could go wrong with the `struct` declarations.

That's not the issue: You're adding functionality to the `pxd`, giving a reason to include this `pxd` for reasons other than including `del_dictitem_by_exact_value`.


---

Comment by chapoton created at 2018-03-11 17:13:26

does not apply


---

Comment by chapoton created at 2018-03-11 17:13:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-11 22:24:06

Resolution: wontfix
