# Issue 10015: R's spkg-install calls "sage -f ..." to install the contained Rpy spkg

Issue created by migration from https://trac.sagemath.org/ticket/10016

Original creator: leif

Original creation time: 2010-09-25 20:52:27

Assignee: leif

CC:  mpatel

Keywords: sage-spkg deps scripts dependency

This already caused trouble when the Sage scripts spkg wasn't yet installed, and making all standard packages depend on the complete set of Sage scripts (which had actually then been done) is an overkill.

There's a lot wrong with this spkg, and the Rpy spkg should be moved out of R's (#9906), but as a short-term solution, I decided to just replace the call to `$SAGE_ROOT/sage` (which requires `sage-sage`) by a direct one to `$SAGE_ROOT/local/bin/sage-spkg`, which should be present in any case, s.t. we don't have to make the R spkg depend on the Sage scripts spkg.

The new p4 spkg does not address any other issues.


---

Comment by leif created at 2010-09-25 22:37:12

Changing status from new to needs_review.


---

Attachment

Diff between the p3 and p4 spkg (actually a Mercurial patch). For reference/review.


---

Comment by kcrisman created at 2010-09-26 00:05:28


```
# sage -f "$RPY_VER".spkg # EVIL
```

I think you have different standards of evil than I do :)

But this sounds like a good intermediate step here.  What I understand of the change in the script makes sense.  I don't know how `tee` works, and whether `pipestatus` really is in the path or what it does, so I sadly can't review this.  Maybe you should cc: the maintainers?  (Which I think are jason and was.)


---

Comment by leif created at 2010-09-29 15:18:21

I just noticed this doesn't fully work with spaces in the path, but since spaces aren't supported yet anyway (and most probably won't be soon), and this is just a temporary solution (cf. #9906), I'm not going to change the fairly large spkg again _here_...


---

Comment by leif created at 2010-09-29 15:20:54

Replying to [comment:3 leif]:
> [...] I'm not going to change the fairly large spkg again _here_...

... unless somebody finds other things that have to be fixed here.


---

Comment by jhpalmieri created at 2010-09-29 16:57:36

So because of the tee command, is the install log for rpy going to appear in both r-2.10.1.p4.log and rpy2-2.0.8.log?

I suppose I should try it and see.  Should I use the "deps" file from #9896?


---

Comment by jhpalmieri created at 2010-09-29 17:04:40

Just to experiment, I took deps from #9896, took out the dependency of R on sage-scripts, and _put in_ a dependency of sage-scripts on R.


---

Comment by leif created at 2010-09-29 17:08:40

Trac...

Replying to [comment:5 jhpalmieri]:
> So because of the tee command, is the install log for rpy going to appear in both r-2.10.1.p4.log and rpy2-2.0.8.log?

I will appear in both. Note that previously the `./sage -f ...` directly wrote (appended) to `$SAGE_ROOT/install.log` as well, which I consider also a bug.

> I suppose I should try it and see.  Should I use the "deps" file from #9896?

This makes no difference, since R still depends on the scripts in both.
(But you could remove the dependency of R on `sage_scripts` in the `deps.v2b` at #9896.)


---

Comment by leif created at 2010-09-29 17:10:52

LOL, `s/I will/It will/`.


---

Comment by leif created at 2010-09-29 17:25:51

Replying to [comment:6 jhpalmieri]:
> Just to experiment, I took deps from #9896, took out the dependency of R on sage-scripts, and _put in_ a dependency of sage-scripts on R.

Good idea. But you should (at least) also remove `local/bin/sage-sage` to make such a test effective. In principle, you could remove everything from `local/bin` except `sage-spkg` and `sage-env` IIRC, but you'd have to install the new R spkg by copying it to `spkg/` and then running `make` (or just `make build`).

Or rebuild Sage from scratch with the new R spkg and such deps, as I did...


---

Comment by leif created at 2010-09-29 17:31:22

Replying to [comment:9 leif]:
> Replying to [comment:6 jhpalmieri]:
> > Just to experiment, I took deps from #9896, took out the dependency of R on sage-scripts, and _put in_ a dependency of sage-scripts on R.
> 
> Good idea. But you should (at least) also remove `local/bin/sage-sage` to make such a test effective. In principle, you could remove everything from `local/bin` except `sage-spkg` and `sage-env` IIRC, but you'd have to install the new R spkg by copying it to `spkg/` and then running `make` (or just `make build`).

And of course remove `spkg/installed/sage_scripts-*` before running `make`.

> Or rebuild Sage from scratch with the new R spkg and such deps, as I did...


---

Comment by leif created at 2010-09-29 17:34:29

Argh, _"copying it to `spkg/`"_ should read _"copying it to `spkg/standard/`"_.


---

Comment by jhpalmieri created at 2010-09-29 17:52:35

I wasn't clear: I'm building from scratch with the modified deps and the new R spkg, so I didn't need to remove anything.  (I had a few false starts, but "make distclean" fixed those.)


---

Comment by jhpalmieri created at 2010-09-29 21:04:45

This looks good to me.  With my purely experimental version of deps, it emphasizes the problem on #9434: since sage-scripts is installed very late, there are many warning messages about being unable to find sage-banner.


---

Comment by jhpalmieri created at 2010-09-29 21:04:45

Changing status from needs_review to positive_review.


---

Comment by leif created at 2010-09-29 21:08:06

Thanks for reviewing this.

Replying to [comment:13 jhpalmieri]:
> [...] With my purely experimental version of deps, it emphasizes the problem on #9434: since sage-scripts is installed very late, there are many warning messages about being unable to find sage-banner.

:D


---

Comment by mpatel created at 2010-09-29 23:55:50

Resolution: fixed
