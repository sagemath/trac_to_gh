# Issue 30004: New implementation class FiniteRankDualFreeModule

Issue created by migration from https://trac.sagemath.org/ticket/30241

Original creator: mkoeppe

Original creation time: 2020-07-28 18:34:16

CC:  egourgoulhon tscrim @mjungmath

(from #30169)

Currently, we have the following identifications:

```
sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: M is M.exterior_power(1)
True
sage: M is M.tensor_module(1, 0)
True
```


In contrast:

```
sage: M.dual() is M.dual_exterior_power(1)
True
sage: M.dual() is M.tensor_module(0, 1)
False
```


The dual is implemented twice, as a special case of both `TensorFreeModule` and `ExtPowerDualFreeModule`.

We create a separate implementation class `FiniteRankDualFreeModule` for it.

By adding `__classcall_private__` methods, we delegate the construction to the new class for the special cases.


---

Comment by @mjungmath created at 2020-07-28 18:43:51

This doesn't sound sensible to me. `ExtPowerDualFreeModule` and `TensorFreeModule` follow _very_ different construction patterns. For a reason: even from the mathematical point of view, one forms and (0,1) tensors are constructed differently, though they are isomorphic.

From that perspective, the current implementation makes perfect sense. What would make more sense is implementing the isomorphism.


---

Comment by mkoeppe created at 2020-07-28 18:48:46

Replying to [comment:1 gh-mjungmath]:
> This doesn't sound sensible to me. `ExtPowerDualFreeModule` and `TensorFreeModule` follow _very_ different construction patterns. For a reason: mathematically, meaning very strictly speaking, one forms and (0,1) tensors are defined differently, though they are isomorphic.

The same is true for `M.exterior_power(1)` and `M.tensor_module(1, 0)`, but we do have this identification.


---

Comment by mkoeppe created at 2020-07-28 18:50:42

By the way, I am adding the additional structure of the exterior powers as quotients of tensor modules in #30169. Please take a look


---

Comment by @mjungmath created at 2020-07-28 19:08:36

Replying to [comment:2 mkoeppe]:
> Replying to [comment:1 gh-mjungmath]:
> > This doesn't sound sensible to me. `ExtPowerDualFreeModule` and `TensorFreeModule` follow _very_ different construction patterns. For a reason: mathematically, meaning very strictly speaking, one forms and (0,1) tensors are defined differently, though they are isomorphic.
> 
> The same is true for `M.exterior_power(1)` and `M.tensor_module(1, 0)`, but we do have this identification.

Fair point. Then I would vote for changing this to the expected outputs rather than creating a whole new class which has no further purpose than everything that is already there. Regarding Travis [comment:10](https://trac.sagemath.org/ticket/30169#comment:10) this would be a convenient solution. Meaning: `M.exterior_power(1)` should return an instance of `ExtPowerFreeModule` and `M.tensor_module(1, 0)` should return an instance of `TensorFreeModule`. Then, one can implement the isomorphisms.

Either way, I agree that consistency is desirable here.

Allow me a side note: please remember that the whole manifold setup is built upon `FiniteRankFreeModule`. Modifying substatial things here might cause problems in the manifold implementation. It would be good to double check and, if absolutely necessary, make changes there, too. Henceforth, I suggest doctesting the manifold part, too.


---

Comment by mkoeppe created at 2020-07-28 19:11:50

Replying to [comment:4 gh-mjungmath]:
> ... a whole new class which has no further purpose than everything that is already there. 

Note that by creating the new class, both of the `ExtPowerDualFreeModule` and `TensorFreeModule` classes will be simplified because they no longer have to implement the special case.


---

Comment by mkoeppe created at 2020-07-28 19:14:58

Replying to [comment:4 gh-mjungmath]:
> `M.exterior_power(1)` should return an instance of `ExtPowerFreeModule` and `M.tensor_module(1, 0)` should return an instance of `TensorFreeModule`. 

Let's see. In your opinion, what should `M.exterior_power(0)` and `M.dual_exterior_power(0)` return?


---

Comment by @mjungmath created at 2020-07-28 19:19:15

Replying to [comment:6 mkoeppe]:
> Replying to [comment:4 gh-mjungmath]:
> > `M.exterior_power(1)` should return an instance of `ExtPowerFreeModule` and `M.tensor_module(1, 0)` should return an instance of `TensorFreeModule`. 
> 
> Let's see. In your opinion, what should `M.exterior_power(0)` and `M.dual_exterior_power(0)` return?

Strictly speaking, they should return instances of `ExtPowerFreeModule` or `ExtPowerDualFreeModule` respectively, which are isomorphic to the base ring.

You definitely have a good point. And I totally agree that this should be unified, in either way.

But I am strictly against a new class dedicated to just one special case. At least, this is how I understand your proposal.


---

Comment by mkoeppe created at 2020-07-28 19:26:01

Replying to [comment:7 gh-mjungmath]:
> I am strictly against a new class dedicated to just one special case.

I'll just prepare a branch and then you can see how it simplifies things, which will make it easier to review this proposal


---

Comment by @mjungmath created at 2020-07-28 19:36:18

Sure, I will take a look. Travis, what do you say?


---

Comment by mkoeppe created at 2020-07-28 19:42:28

Replying to [comment:4 gh-mjungmath]:
> Allow me a side note: please remember that the whole manifold setup is built upon `FiniteRankFreeModule`. Modifying substatial things here might cause problems in the manifold implementation. It would be good to double check and, if absolutely necessary, make changes there, too. Henceforth, I suggest doctesting the manifold part, too.

Thanks. Prompted by your remark, I have taken a look and I noticed that `VectorFieldModule` also has similar code. I have yet to study this code in detail (I am slowly making my way up the stack...), but it looks it has the same inconsistency between primal and dual:

```
sage: M = Manifold(2, 'M')
sage: XM = M.vector_field_module()
sage: XM.tensor_module(1, 0) is XM
True
sage: XM.tensor_module(0, 1) is XM.dual()
False
```



---

Comment by mkoeppe created at 2020-07-28 19:56:05

I think I have a solution that could make everyone happy. 

In #30169, I had implemented `FiniteRankDualFreeModule.__classcall_private__` methods that delegate to other classes and implement the identification.

But we could as well take care of all identifications in the `FiniteRankModule.exterior_power`, `dual_power`, `tensor_module` methods.

Then the class constructors `ExtPowerFreeModule` could keep the strict behavior (I would also check that the case of degree 0 is correctly implemented - I don't think it is currently).


---

Comment by @mjungmath created at 2020-07-28 20:09:57

Replying to [comment:11 mkoeppe]:
> I think I have a solution that could make everyone happy. 
> 
> In #30169, I had implemented `FiniteRankDualFreeModule.__classcall_private__` methods that delegate to other classes and implement the identification.



> But we could as well take care of all identifications in the `FiniteRankModule.exterior_power`, `dual_power`, `tensor_module` methods.

This sounds much better, yes. It would also be good to leave a note in the documentation so that the user knows about these special cases and how they are treated (if not already done).

> Then the class constructors `ExtPowerFreeModule` could keep the strict behavior (I would also check that the case of degree 0 is correctly implemented - I don't think it is currently).

I would appreciate this task. The degree zero case had already caused some troubles in the past.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-09-01 15:52:23

Ticket description needs updating after #34474


---

Comment by git created at 2022-09-02 20:56:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-02 20:57:27

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-09-04 18:10:34

Looks good, thanks. There are some minor issues regarding the documentation of class `FiniteRankDualFreeModule`:

```diff
-     the *dual of* `M` is the set `M^*` of all linear forms `p` on `M`,
+     the *dual of* `M` is the set `M^*` of all linear forms on `M`,
```



```diff
-    - ``name`` -- (default: ``None``) string; name given to `\Lambda^p(M^*)`
+    - ``name`` -- (default: ``None``) string; name given to `M^*`
```



```diff
-    EXAMPLES:
+    EXAMPLES::
```

It would also be nice to update the `AUTHORS` field of `finite_rank_free_module.py`.

You probably already know it, but just in case: instead of running `make doc` (which is so slow that one always hesitate to run it), a fast way to generate the documentation regarding tensors on finite rank free modules is 

```
sage -docbuild reference/tensor_free_modules html
```

The documentation is then located in `local/share/doc/sage/html/en/reference/tensor_free_modules/index.html` under the Sage root directory. 

Michael, do you have any further comments?


---

Comment by egourgoulhon created at 2022-09-04 18:25:18

Another issue regardng the documentation: in the html doc, the method `construction()` of `FiniteRankDualFreeModule` appears as an empty item, which is somewhat weird. This is because its docstring contains only a `TESTS` field. There should be at least something like "Not implemented yet" and/or the comment that appears only in the Python code (`No construction until we extend VectorFunctor with a parameter 'dual'`). Same remark about the `construction()` methods of `TensorFreeModule`, `ExtPowerFreeModule` and `ExtPowerDualFreeModule` after #30235.


---

Comment by git created at 2022-09-04 18:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-04 18:57:01

I left the docstring of `TensorFreeModule.construction` as is because it's getting replaced in #34448 already


---

Comment by mkoeppe created at 2022-09-04 18:59:41

Replying to [comment:26 Eric Gourgoulhon]:
> It would also be nice to update the `AUTHORS` field of `finite_rank_free_module.py`.

I'll do this in a follow-up ticket to avoid a merge conflict with #30229.


---

Comment by egourgoulhon created at 2022-09-04 19:47:07

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-09-04 19:47:07

Replying to [comment:29 Matthias Köppe]:
> I left the docstring of `TensorFreeModule.construction` as is because it's getting replaced in #34448 already
OK. Thanks for the other changes. 

Michael, do you agree with the positive review?


---

Comment by @mjungmath created at 2022-09-07 18:52:08

Sorry, it's a long time ago I looked into this.

We want tensor products for dual elements, am I getting this right? Is the long term goal then to implement `ExtPowerDualFreeModule` as a quotient of tensor powers of `FiniteRankDualFreeModule`?


---

Comment by vbraun created at 2022-09-22 22:35:00

Resolution: fixed
