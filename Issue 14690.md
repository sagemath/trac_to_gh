# Issue 14690: Update to Pari 2.6.0 (when its out) and fix error handling

archive/issues_014690.json:
```json
{
    "body": "Assignee: @jdemeyer\n\nCC:  @jdemeyer\n\nPari GIT has made significant changes to the error handling code, which will require us to make some changes to Sage. See also http://trac.sagemath.org/sage_trac/ticket/14873#comment:9 for a list of issues with the current approach.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14894\n\n",
    "created_at": "2013-07-15T14:21:31Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Update to Pari 2.6.0 (when its out) and fix error handling",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14690",
    "user": "@vbraun"
}
```
Assignee: @jdemeyer

CC:  @jdemeyer

Pari GIT has made significant changes to the error handling code, which will require us to make some changes to Sage. See also http://trac.sagemath.org/sage_trac/ticket/14873#comment:9 for a list of issues with the current approach.

Issue created by migration from https://trac.sagemath.org/ticket/14894





---

archive/issue_comments_187040.json:
```json
{
    "body": "Ah sorry, its dutch, not french. Too many variations of my own surname ;-)",
    "created_at": "2013-07-15T14:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187040",
    "user": "@vbraun"
}
```

Ah sorry, its dutch, not french. Too many variations of my own surname ;-)



---

archive/issue_comments_187041.json:
```json
{
    "body": "Replying to [comment:2 vbraun]:\n> Ah sorry, its dutch, not french. Too many variations of my own surname ;-)\nKein Problem! 8-)",
    "created_at": "2013-07-15T15:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187041",
    "user": "@pjbruin"
}
```

Replying to [comment:2 vbraun]:
> Ah sorry, its dutch, not french. Too many variations of my own surname ;-)
Kein Problem! 8-)



---

archive/issue_comments_187042.json:
```json
{
    "body": "Changing keywords from \"\" to \"pari error signal\".",
    "created_at": "2013-07-16T09:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187042",
    "user": "@pjbruin"
}
```

Changing keywords from "" to "pari error signal".



---

archive/issue_comments_187043.json:
```json
{
    "body": "new Cython macros for PARI error handling",
    "created_at": "2013-07-16T09:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187043",
    "user": "@pjbruin"
}
```

new Cython macros for PARI error handling



---

archive/issue_comments_187044.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch.patch) by @pjbruin created at 2013-07-16 09:27:20\n\nmake gen.pyx use new PARI error handling macros",
    "created_at": "2013-07-16T09:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187044",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch.patch) by @pjbruin created at 2013-07-16 09:27:20

make gen.pyx use new PARI error handling macros



---

archive/issue_comments_187045.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch_gen.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_gen.patch) by @pjbruin created at 2013-07-16 09:27:37\n\nmake PARI finite field elements use new error handling macros",
    "created_at": "2013-07-16T09:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187045",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch_gen.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_gen.patch) by @pjbruin created at 2013-07-16 09:27:37

make PARI finite field elements use new error handling macros



---

archive/issue_comments_187046.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch_FiniteFieldElement_pari_ffelt.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_FiniteFieldElement_pari_ffelt.patch) by @pjbruin created at 2013-07-16 09:27:51\n\nnew PARI error handling for miscellaneous Cython code",
    "created_at": "2013-07-16T09:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187046",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch_FiniteFieldElement_pari_ffelt.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_FiniteFieldElement_pari_ffelt.patch) by @pjbruin created at 2013-07-16 09:27:51

new PARI error handling for miscellaneous Cython code



---

archive/issue_comments_187047.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch_misc.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_misc.patch) by @pjbruin created at 2013-07-16 09:28:06\n\ndelete old Cython macros for PARI error handling",
    "created_at": "2013-07-16T09:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187047",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch_misc.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_misc.patch) by @pjbruin created at 2013-07-16 09:28:06

delete old Cython macros for PARI error handling



---

archive/issue_comments_187048.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-07-16T09:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187048",
    "user": "@pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_187049.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch_delete_old.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_delete_old.patch) by @pjbruin created at 2013-07-16 09:30:26",
    "created_at": "2013-07-16T09:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187049",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch_delete_old.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_delete_old.patch) by @pjbruin created at 2013-07-16 09:30:26



---

archive/issue_comments_187050.json:
```json
{
    "body": "Looks fine to me. We lose some syntactic sugar but get closer to the upstream coding convention, so it should make our live easier in the long run. Maybe Jeroen has an opinion?\n\nI would have preferred some shorter names especially since they'll be used very frequently in the Pari library interface.  The file is part of the Sage library, so why prefix with `sage_`?. Maybe just `catch_begin` / `catch_end` / `catch_reset` since its usage should be pretty much only in `sage/libs/pari`.",
    "created_at": "2013-07-16T14:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187050",
    "user": "@vbraun"
}
```

Looks fine to me. We lose some syntactic sugar but get closer to the upstream coding convention, so it should make our live easier in the long run. Maybe Jeroen has an opinion?

I would have preferred some shorter names especially since they'll be used very frequently in the Pari library interface.  The file is part of the Sage library, so why prefix with `sage_`?. Maybe just `catch_begin` / `catch_end` / `catch_reset` since its usage should be pretty much only in `sage/libs/pari`.



---

archive/issue_comments_187051.json:
```json
{
    "body": "Replying to [comment:7 vbraun]:\n> Looks fine to me. We lose some syntactic sugar but get closer to the upstream coding convention, so it should make our live easier in the long run.\n\nThe new macros do require more keystrokes -- or things like `replace-regexp` in Emacs, which I ought to list as a co-author of these patches. 8-)  On the other hand, they make the code easier to understand in the sense that one doesn't have to remember or guess where the error catching block ends.\n\n> I would have preferred some shorter names especially since they'll be used very frequently in the Pari library interface.  The file is part of the Sage library, so why prefix with `sage_`?. Maybe just `catch_begin` / `catch_end` / `catch_reset` since its usage should be pretty much only in `sage/libs/pari`.\n\nIn fact, I spent quite a bit of thought on the names, and altogether, I think that there are good reasons for the `sage_pari_` prefix:\n\nMy first idea was `pari_catch` / `pari_endcatch` / `pari_catch_reset`.  Then I decided that this set of names looks better with `catch_end` than with `endcatch`.\n\nThe variable `sage_pari_catcherr` in your patch for #14873 then gave me the idea of prefixing the names with `sage_`.  It is true that this makes them a bit long (which is why I did not change `sage_pari_catch` to `sage_pari_catch_begin`).  But it is also true that they are non-trivial wrappers around the corresponding PARI macros that involve signal trapping, conversion of PARI errors to Python exceptions, and potentially retrying the same code several times until the stack is large enough.  I thought this justified the prefix `sage_` to make it clear that they are not the vanilla PARI macros but somewhat elaborate customised versions.\n\nAbout keeping the `pari` part of the name: I think it is important because these macros *are* used outside `sage/libs/pari`, so the name should indicate that they have a more specialised purpose than the generic `sig_on()` / `sig_off()`.  Currently they are used in a few places for integers, real and complex numbers, and integer and rational matrices.  The `FiniteField_pari_ffelt` class of #12142 heavily depends on them, and there are many other data types of which fast PARI implementations could be made (e.g. polynomials, power series rings and elliptic curves over finite fields), which would undoubtedly also use these macros.",
    "created_at": "2013-07-16T16:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187051",
    "user": "@pjbruin"
}
```

Replying to [comment:7 vbraun]:
> Looks fine to me. We lose some syntactic sugar but get closer to the upstream coding convention, so it should make our live easier in the long run.

The new macros do require more keystrokes -- or things like `replace-regexp` in Emacs, which I ought to list as a co-author of these patches. 8-)  On the other hand, they make the code easier to understand in the sense that one doesn't have to remember or guess where the error catching block ends.

> I would have preferred some shorter names especially since they'll be used very frequently in the Pari library interface.  The file is part of the Sage library, so why prefix with `sage_`?. Maybe just `catch_begin` / `catch_end` / `catch_reset` since its usage should be pretty much only in `sage/libs/pari`.

In fact, I spent quite a bit of thought on the names, and altogether, I think that there are good reasons for the `sage_pari_` prefix:

My first idea was `pari_catch` / `pari_endcatch` / `pari_catch_reset`.  Then I decided that this set of names looks better with `catch_end` than with `endcatch`.

The variable `sage_pari_catcherr` in your patch for #14873 then gave me the idea of prefixing the names with `sage_`.  It is true that this makes them a bit long (which is why I did not change `sage_pari_catch` to `sage_pari_catch_begin`).  But it is also true that they are non-trivial wrappers around the corresponding PARI macros that involve signal trapping, conversion of PARI errors to Python exceptions, and potentially retrying the same code several times until the stack is large enough.  I thought this justified the prefix `sage_` to make it clear that they are not the vanilla PARI macros but somewhat elaborate customised versions.

About keeping the `pari` part of the name: I think it is important because these macros *are* used outside `sage/libs/pari`, so the name should indicate that they have a more specialised purpose than the generic `sig_on()` / `sig_off()`.  Currently they are used in a few places for integers, real and complex numbers, and integer and rational matrices.  The `FiniteField_pari_ffelt` class of #12142 heavily depends on them, and there are many other data types of which fast PARI implementations could be made (e.g. polynomials, power series rings and elliptic curves over finite fields), which would undoubtedly also use these macros.



---

archive/issue_comments_187052.json:
```json
{
    "body": "I'm attaching one more patch, which I hope will be the last one for this ticket.  It makes the C macros as simple as possible and moves the handling of `pari_errno` to a single Cython function `pari_handle_error`.",
    "created_at": "2013-07-22T14:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187052",
    "user": "@pjbruin"
}
```

I'm attaching one more patch, which I hope will be the last one for this ticket.  It makes the C macros as simple as possible and moves the handling of `pari_errno` to a single Cython function `pari_handle_error`.



---

archive/issue_comments_187053.json:
```json
{
    "body": "One other thing I experimented with is a decorator ``@`pari_catch_function`, which wraps the function in `sage_pari_catch()...sage_pari_catch_end()`.  It works nicely, but I'm not sure that it is useful for `gen.pyx`, since it will probably slow things down.  On the other hand, it might be useful later for new code that is less speed-critical.  I am thinking of creating a patch implementing this (in a new ticket) sometime in the future.",
    "created_at": "2013-07-22T14:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187053",
    "user": "@pjbruin"
}
```

One other thing I experimented with is a decorator ``@`pari_catch_function`, which wraps the function in `sage_pari_catch()...sage_pari_catch_end()`.  It works nicely, but I'm not sure that it is useful for `gen.pyx`, since it will probably slow things down.  On the other hand, it might be useful later for new code that is less speed-critical.  I am thinking of creating a patch implementing this (in a new ticket) sometime in the future.



---

archive/issue_comments_187054.json:
```json
{
    "body": "One recomendation: could you use other names than `sage_pari_catch`, something which clearly refers to `sig_on()`, since `sage_pari_catch()` really is an extension of `sig_on()`.\n\nWhat about `pari_sig_on()` and `pari_sig_off()` which would mirror `ecl_sig_on()` and `ecl_sig_off()` which we already have?",
    "created_at": "2013-07-24T07:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187054",
    "user": "@jdemeyer"
}
```

One recomendation: could you use other names than `sage_pari_catch`, something which clearly refers to `sig_on()`, since `sage_pari_catch()` really is an extension of `sig_on()`.

What about `pari_sig_on()` and `pari_sig_off()` which would mirror `ecl_sig_on()` and `ecl_sig_off()` which we already have?



---

archive/issue_comments_187055.json:
```json
{
    "body": "Replying to [comment:10 pbruin]:\n> One other thing I experimented with is a decorator ``@`pari_catch_function`, which wraps the function in `sage_pari_catch()...sage_pari_catch_end()`.\n\nSince this is low-level C code, I cannot believe a decorator (which is on the level of Python) would work.",
    "created_at": "2013-07-24T07:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187055",
    "user": "@jdemeyer"
}
```

Replying to [comment:10 pbruin]:
> One other thing I experimented with is a decorator ``@`pari_catch_function`, which wraps the function in `sage_pari_catch()...sage_pari_catch_end()`.

Since this is low-level C code, I cannot believe a decorator (which is on the level of Python) would work.



---

archive/issue_comments_187056.json:
```json
{
    "body": "Also, I really don't like that `sage_pari_catch()` and `sage_pari_catch_end()` contain complementaty braces. I would strongly recommend to try to keep the following working as before:\n\n```\n    sage_pari_catch()\n    return new_gen(something returning GEN)\n```\n",
    "created_at": "2013-07-24T07:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187056",
    "user": "@jdemeyer"
}
```

Also, I really don't like that `sage_pari_catch()` and `sage_pari_catch_end()` contain complementaty braces. I would strongly recommend to try to keep the following working as before:

```
    sage_pari_catch()
    return new_gen(something returning GEN)
```




---

archive/issue_comments_187057.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> One recomendation: could you use other names than `sage_pari_catch`, something which clearly refers to `sig_on()`, since `sage_pari_catch()` really is an extension of `sig_on()`.\n\nAs I understand it, the two purposes of `sage_pari_catch()` are equally important, namely\n- catching signals\n- catching PARI errors.\nIt would be nice to have a name that mirror this.  Maybe the prefix `sage_` is somewhat redundant, as Volker Braun suggested, and we could call them `pari_catch_on()` and `pari_catch_off()`?\n\n> What about `pari_sig_on()` and `pari_sig_off()` which would mirror `ecl_sig_on()` and `ecl_sig_off()` which we already have?\n\nDo these have the same two purposes as above?  In that case, I would find the names `pari_sig_on()` and `pari_sig_off()` acceptable for the sake of consistency, but in principle I dislike the fact that they don't hint at the fact that these macros catch PARI errors and not just signals.",
    "created_at": "2013-07-24T11:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187057",
    "user": "@pjbruin"
}
```

Replying to [comment:11 jdemeyer]:
> One recomendation: could you use other names than `sage_pari_catch`, something which clearly refers to `sig_on()`, since `sage_pari_catch()` really is an extension of `sig_on()`.

As I understand it, the two purposes of `sage_pari_catch()` are equally important, namely
- catching signals
- catching PARI errors.
It would be nice to have a name that mirror this.  Maybe the prefix `sage_` is somewhat redundant, as Volker Braun suggested, and we could call them `pari_catch_on()` and `pari_catch_off()`?

> What about `pari_sig_on()` and `pari_sig_off()` which would mirror `ecl_sig_on()` and `ecl_sig_off()` which we already have?

Do these have the same two purposes as above?  In that case, I would find the names `pari_sig_on()` and `pari_sig_off()` acceptable for the sake of consistency, but in principle I dislike the fact that they don't hint at the fact that these macros catch PARI errors and not just signals.



---

archive/issue_comments_187058.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Since this is low-level C code, I cannot believe a decorator (which is on the level of Python) would work.\nMaybe I can convince you by giving the definition of the decorator:\n\n```\ndef pari_catch_function(f):\n    \"\"\"\n    Decorator to wrap a function in sage_pari_catch() ... sage_pari_catch_end().\n    \"\"\"\n    def g(*args):\n        cdef object _x\n        sage_pari_catch()\n        _x = f(*args)\n        sage_pari_catch_end()\n        return _x\n    return g\n```\n\nI put this in a Cython file and tested it.  It works, but probably it is not very good for efficiency.\n\nSomething that I do *not* see how to do easily, on the other hand, is a context guard (context manager) for use with the `with` statement, i.e.\n\n```\nwith pari_catch:\n    ...code...\n```\n\ngiving you catching of PARI errors and signals within the block.",
    "created_at": "2013-07-24T11:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187058",
    "user": "@pjbruin"
}
```

Replying to [comment:12 jdemeyer]:
> Since this is low-level C code, I cannot believe a decorator (which is on the level of Python) would work.
Maybe I can convince you by giving the definition of the decorator:

```
def pari_catch_function(f):
    """
    Decorator to wrap a function in sage_pari_catch() ... sage_pari_catch_end().
    """
    def g(*args):
        cdef object _x
        sage_pari_catch()
        _x = f(*args)
        sage_pari_catch_end()
        return _x
    return g
```

I put this in a Cython file and tested it.  It works, but probably it is not very good for efficiency.

Something that I do *not* see how to do easily, on the other hand, is a context guard (context manager) for use with the `with` statement, i.e.

```
with pari_catch:
    ...code...
```

giving you catching of PARI errors and signals within the block.



---

archive/issue_comments_187059.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Also, I really don't like that `sage_pari_catch()` and `sage_pari_catch_end()` contain complementaty braces. I would strongly recommend to try to keep the following working as before:\n> {{{\n>     sage_pari_catch()\n>     return new_gen(something returning GEN)\n> }}}\nI see that this would be desirable because it saves typing a few lines each time.  On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.  The fact that the macros contain complementary braces makes them less flexible, but make it clearer where the error-catching block ends.\n\nActually, as far as I'm concerned it would be even nicer if we could have the `with` syntax as in my previous comment.  This would force us at the same time to avoid complementary braces, which can be a good thing or not (we seem to disagree on this).  However, there are two real disadvantages to this approach:\n- it won't translate into simple C code and will certainly be slower;\n- we cannot use the macros that PARI provides, and instead hack something ourselves that uses `alloca()`, `malloc()` or a global variable to allocate the `jmp_buf` (stack environment for use with `sigjmp()`); otherwise it will disappear from the scope.  This is exactly the problem that this ticket tries to solve.",
    "created_at": "2013-07-24T11:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187059",
    "user": "@pjbruin"
}
```

Replying to [comment:13 jdemeyer]:
> Also, I really don't like that `sage_pari_catch()` and `sage_pari_catch_end()` contain complementaty braces. I would strongly recommend to try to keep the following working as before:
> {{{
>     sage_pari_catch()
>     return new_gen(something returning GEN)
> }}}
I see that this would be desirable because it saves typing a few lines each time.  On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.  The fact that the macros contain complementary braces makes them less flexible, but make it clearer where the error-catching block ends.

Actually, as far as I'm concerned it would be even nicer if we could have the `with` syntax as in my previous comment.  This would force us at the same time to avoid complementary braces, which can be a good thing or not (we seem to disagree on this).  However, there are two real disadvantages to this approach:
- it won't translate into simple C code and will certainly be slower;
- we cannot use the macros that PARI provides, and instead hack something ourselves that uses `alloca()`, `malloc()` or a global variable to allocate the `jmp_buf` (stack environment for use with `sigjmp()`); otherwise it will disappear from the scope.  This is exactly the problem that this ticket tries to solve.



---

archive/issue_comments_187060.json:
```json
{
    "body": "One last comment for now: when I was working on this ticket I realised that a language feature that would give a good solution for this problem would be Lisp-style macros (so one could pass a \"quoted\" piece of code to a macro that does `catch_on()`, evaluates the code, and does `catch_off()`).  Unfortunately this is something that Python doesn't have; the closest thing is the decorator described above, but it only works for entire functions.",
    "created_at": "2013-07-24T12:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187060",
    "user": "@pjbruin"
}
```

One last comment for now: when I was working on this ticket I realised that a language feature that would give a good solution for this problem would be Lisp-style macros (so one could pass a "quoted" piece of code to a macro that does `catch_on()`, evaluates the code, and does `catch_off()`).  Unfortunately this is something that Python doesn't have; the closest thing is the decorator described above, but it only works for entire functions.



---

archive/issue_comments_187061.json:
```json
{
    "body": "I also don't like the unbalanced-bracket-hack. But, since Pari sets up its error catching framework that way, we should go with it, ugly or not.\n\nThen I agree with Peter that the name should be different form `sig_on`/`off` precisely because it has different semantics.\n\nI don't really see the need for getting too fancy with context managers or decorators, the pari error try/catch should essentially only be used in `sage.libs.pari` and nowhere else in the Sage tree. And that is precisely where you wouldn't want to take any performance hit for one of the more fancy solutions.",
    "created_at": "2013-07-24T23:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187061",
    "user": "@vbraun"
}
```

I also don't like the unbalanced-bracket-hack. But, since Pari sets up its error catching framework that way, we should go with it, ugly or not.

Then I agree with Peter that the name should be different form `sig_on`/`off` precisely because it has different semantics.

I don't really see the need for getting too fancy with context managers or decorators, the pari error try/catch should essentially only be used in `sage.libs.pari` and nowhere else in the Sage tree. And that is precisely where you wouldn't want to take any performance hit for one of the more fancy solutions.



---

archive/issue_comments_187062.json:
```json
{
    "body": "Replying to [comment:16 pbruin]:\n> Actually, as far as I'm concerned it would be even nicer if we could have the `with` syntax as in my previous comment.\nSure, but that needs some Cython patches, so it's not possible now.",
    "created_at": "2013-07-25T06:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187062",
    "user": "@jdemeyer"
}
```

Replying to [comment:16 pbruin]:
> Actually, as far as I'm concerned it would be even nicer if we could have the `with` syntax as in my previous comment.
Sure, but that needs some Cython patches, so it's not possible now.



---

archive/issue_comments_187063.json:
```json
{
    "body": "Replying to [comment:15 pbruin]:\n> I put this in a Cython file and tested it.  It works, but probably it is not very good for efficiency.\nSince `_x = f(*args)` is evaluated through Python (not C), it will badly break the Python interpreter if interrupted at the wrong time.",
    "created_at": "2013-07-25T06:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187063",
    "user": "@jdemeyer"
}
```

Replying to [comment:15 pbruin]:
> I put this in a Cython file and tested it.  It works, but probably it is not very good for efficiency.
Since `_x = f(*args)` is evaluated through Python (not C), it will badly break the Python interpreter if interrupted at the wrong time.



---

archive/issue_comments_187064.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch_simplify.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_simplify.patch) by @pjbruin created at 2013-07-29 21:01:10\n\nsimplify macros, do pari_errno handling in gen.pyx:pari_handle_error",
    "created_at": "2013-07-29T21:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187064",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch_simplify.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch_simplify.patch) by @pjbruin created at 2013-07-29 21:01:10

simplify macros, do pari_errno handling in gen.pyx:pari_handle_error



---

archive/issue_comments_187065.json:
```json
{
    "body": "In the previous version of [attachment:trac_14894-pari_catch_simplify.patch] I tried to move the `except *` from `sage_pari_catch()` to `sage_pari_catch_end()`.  This was fine for catching PARI errors, but turned out to break interrupt handling, so I reverted this change.",
    "created_at": "2013-07-29T21:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187065",
    "user": "@pjbruin"
}
```

In the previous version of [attachment:trac_14894-pari_catch_simplify.patch] I tried to move the `except *` from `sage_pari_catch()` to `sage_pari_catch_end()`.  This was fine for catching PARI errors, but turned out to break interrupt handling, so I reverted this change.



---

archive/issue_comments_187066.json:
```json
{
    "body": "About the names for the macros: how about `pari_catch_on()` and `pari_catch_off()`?\n\nAdvantages:\n- not too long\n- reminiscent of `sig_on()` and `sig_off()`\n- do not suggest that the sole purpose is handling signals (as opposed to PARI errors)",
    "created_at": "2013-08-05T14:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187066",
    "user": "@pjbruin"
}
```

About the names for the macros: how about `pari_catch_on()` and `pari_catch_off()`?

Advantages:
- not too long
- reminiscent of `sig_on()` and `sig_off()`
- do not suggest that the sole purpose is handling signals (as opposed to PARI errors)



---

archive/issue_comments_187067.json:
```json
{
    "body": "Replying to [comment:22 pbruin]:\n> - reminiscent of `sig_on()` and `sig_off()`\nIn my opinion, not sufficiently reminiscent..., I still prefer `pari_sig_on()` and `pari_sig_off()`.\n\n> I see that this would be desirable because it saves typing a few lines each time. On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.\nThat might be true, but in this case I don't think it justifies the overcomplication of two-liners like\n\n```\nsig_on() \nreturn P.new_gen(gcos(x.g, pbw(precision))) \n```\n\nto the five-liner\n\n```\ncdef gen result_gen \nsage_pari_catch() \nresult_gen = P.new_gen(gcos(x.g, pbw(precision))) \nsage_pari_catch_end() \nreturn result_gen \n```\n",
    "created_at": "2013-08-13T12:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187067",
    "user": "@jdemeyer"
}
```

Replying to [comment:22 pbruin]:
> - reminiscent of `sig_on()` and `sig_off()`
In my opinion, not sufficiently reminiscent..., I still prefer `pari_sig_on()` and `pari_sig_off()`.

> I see that this would be desirable because it saves typing a few lines each time. On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.
That might be true, but in this case I don't think it justifies the overcomplication of two-liners like

```
sig_on() 
return P.new_gen(gcos(x.g, pbw(precision))) 
```

to the five-liner

```
cdef gen result_gen 
sage_pari_catch() 
result_gen = P.new_gen(gcos(x.g, pbw(precision))) 
sage_pari_catch_end() 
return result_gen 
```




---

archive/issue_comments_187068.json:
```json
{
    "body": "For reviewing purposes, could you please fold all patches into one? Because some later patches rewrite stuff from older patches.",
    "created_at": "2013-08-13T12:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187068",
    "user": "@jdemeyer"
}
```

For reviewing purposes, could you please fold all patches into one? Because some later patches rewrite stuff from older patches.



---

archive/issue_comments_187069.json:
```json
{
    "body": "After looking at the PARI 2.6 sources, I think the best solution for Sage would be to use the (admittedly undocumented) variable `iferr_env` from PARI. Because the `pari_CATCH` stuff is re-doing a `setjmp()` call which Sage's `sig_on()` already does. This is bad, for example for performance reasons (I made a lot of effort in making `sig_on()` fast).",
    "created_at": "2013-08-13T12:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187069",
    "user": "@jdemeyer"
}
```

After looking at the PARI 2.6 sources, I think the best solution for Sage would be to use the (admittedly undocumented) variable `iferr_env` from PARI. Because the `pari_CATCH` stuff is re-doing a `setjmp()` call which Sage's `sig_on()` already does. This is bad, for example for performance reasons (I made a lot of effort in making `sig_on()` fast).



---

archive/issue_comments_187070.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-08-13T12:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187070",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_187071.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Replying to [comment:22 pbruin]:\n> > - reminiscent of `sig_on()` and `sig_off()`\n> In my opinion, not sufficiently reminiscent..., I still prefer `pari_sig_on()` and `pari_sig_off()`.\n\nBut why?  When I started looking at `gen.pyx`, the names `sig_on()` and `sig_off()` really confused me, because they suggest that they are just signal handling macros.  It seems to me that in practice, PARI errors (e.g. zero division) occur more often than signals, so the names should not suggest otherwise.  If you ask me, this problem is not fixed by renaming them `pari_sig_on()` and `pari_sig_off()`.\n\n> > I see that this would be desirable because it saves typing a few lines each time. On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.\n> That might be true, but in this case I don't think it justifies the overcomplication of two-liners like [...] to the five-liner [...]\n\nI can't say I'm completely happy with the code increase, either, and by now I'm really inclined to try one of two opposite strategies:\n- either find out how (in)efficient context managers (the `with` statement) are in Cython; I still think being able to say `with pari_catch: code` (as in comment:15) would be ideal, and perhaps the overhead is not so big compared to the overhead that we already have by using Cython;\n- or translate this part of `gen.pyx` from Cython to C, both for speed and to be able to use a macro for signal and error handling.  This macro, say `pari_catch_wrap()`, should call `pari_catch_on()`, execute `code` (and remember its return value), call `pari_catch_off()` and return the return value of `code`, so one could type (in C)\n\n```\nreturn pari_catch_wrap(code);\n```\n\n\n> After looking at the PARI 2.6 sources, I think the best solution for Sage would be to use the (admittedly undocumented) variable `iferr_env` from PARI. Because the `pari_CATCH` stuff is re-doing a `setjmp()` call which Sage's `sig_on()` already does. This is bad, for example for performance reasons (I made a lot of effort in making `sig_on()` fast).\nThere is a trade-off between execution time and developer time here.\n\nWhat you suggest seems to require a new set of macros, merging `sig_on()/sig_off()` and PARI's error handling macros, that only do one `sigsetjmp()` but then have to distinguish within the error-handling code whether a signal or a PARI error occurred.\n\nI would hope that `setjmp()` is very fast on most systems, so that it doesn't really hurt to use it twice: once to set up signal handling and once to set up PARI error handling.  I would certainly be happy to pay this price in order to cleanly separate between handling signals and handling PARI errors.",
    "created_at": "2013-08-13T13:51:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187071",
    "user": "@pjbruin"
}
```

Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 pbruin]:
> > - reminiscent of `sig_on()` and `sig_off()`
> In my opinion, not sufficiently reminiscent..., I still prefer `pari_sig_on()` and `pari_sig_off()`.

But why?  When I started looking at `gen.pyx`, the names `sig_on()` and `sig_off()` really confused me, because they suggest that they are just signal handling macros.  It seems to me that in practice, PARI errors (e.g. zero division) occur more often than signals, so the names should not suggest otherwise.  If you ask me, this problem is not fixed by renaming them `pari_sig_on()` and `pari_sig_off()`.

> > I see that this would be desirable because it saves typing a few lines each time. On the other hand, I think the above code is bad style because it explicity begins a block, but implicity ends it.
> That might be true, but in this case I don't think it justifies the overcomplication of two-liners like [...] to the five-liner [...]

I can't say I'm completely happy with the code increase, either, and by now I'm really inclined to try one of two opposite strategies:
- either find out how (in)efficient context managers (the `with` statement) are in Cython; I still think being able to say `with pari_catch: code` (as in comment:15) would be ideal, and perhaps the overhead is not so big compared to the overhead that we already have by using Cython;
- or translate this part of `gen.pyx` from Cython to C, both for speed and to be able to use a macro for signal and error handling.  This macro, say `pari_catch_wrap()`, should call `pari_catch_on()`, execute `code` (and remember its return value), call `pari_catch_off()` and return the return value of `code`, so one could type (in C)

```
return pari_catch_wrap(code);
```


> After looking at the PARI 2.6 sources, I think the best solution for Sage would be to use the (admittedly undocumented) variable `iferr_env` from PARI. Because the `pari_CATCH` stuff is re-doing a `setjmp()` call which Sage's `sig_on()` already does. This is bad, for example for performance reasons (I made a lot of effort in making `sig_on()` fast).
There is a trade-off between execution time and developer time here.

What you suggest seems to require a new set of macros, merging `sig_on()/sig_off()` and PARI's error handling macros, that only do one `sigsetjmp()` but then have to distinguish within the error-handling code whether a signal or a PARI error occurred.

I would hope that `setjmp()` is very fast on most systems, so that it doesn't really hurt to use it twice: once to set up signal handling and once to set up PARI error handling.  I would certainly be happy to pay this price in order to cleanly separate between handling signals and handling PARI errors.



---

archive/issue_comments_187072.json:
```json
{
    "body": "Replying to [comment:27 pbruin]:\n> - either find out how (in)efficient context managers (the `with` statement) are in Cython; I still think being able to say `with pari_catch: code` would be ideal\nOf course this would be ideal. But as I said, this needs Cython patches. I recently looked into this for implementing `sig_on()` and it currently cannot be done in Cython.\n\n> What you suggest seems to require a new set of macros, merging sig_on()/sig_off() and PARI's error handling macros, that only do one sigsetjmp() but then have to distinguish within the error-handling code whether a signal or a PARI error occurred. \nExactly. I know it's far from trivial, otherwise I would have done it already in the past. But I can say that I **thought** a lot about signal/error handling.\n\n> I would hope that setjmp() is very fast on most systems\nIt's not. I remember it being particularly slow on BSD (and therefore OS X) systems.",
    "created_at": "2013-08-13T14:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187072",
    "user": "@jdemeyer"
}
```

Replying to [comment:27 pbruin]:
> - either find out how (in)efficient context managers (the `with` statement) are in Cython; I still think being able to say `with pari_catch: code` would be ideal
Of course this would be ideal. But as I said, this needs Cython patches. I recently looked into this for implementing `sig_on()` and it currently cannot be done in Cython.

> What you suggest seems to require a new set of macros, merging sig_on()/sig_off() and PARI's error handling macros, that only do one sigsetjmp() but then have to distinguish within the error-handling code whether a signal or a PARI error occurred. 
Exactly. I know it's far from trivial, otherwise I would have done it already in the past. But I can say that I **thought** a lot about signal/error handling.

> I would hope that setjmp() is very fast on most systems
It's not. I remember it being particularly slow on BSD (and therefore OS X) systems.



---

archive/issue_comments_187073.json:
```json
{
    "body": "Attachment [trac_14894-pari_catch-folded.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch-folded.patch) by @pjbruin created at 2013-08-13 14:06:52\n\nunified patch combining all the above patches",
    "created_at": "2013-08-13T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187073",
    "user": "@pjbruin"
}
```

Attachment [trac_14894-pari_catch-folded.patch](tarball://root/attachments/some-uuid/ticket14894/trac_14894-pari_catch-folded.patch) by @pjbruin created at 2013-08-13 14:06:52

unified patch combining all the above patches



---

archive/issue_comments_187074.json:
```json
{
    "body": "Replying to [comment:28 jdemeyer]:\n> Replying to [comment:27 pbruin]:\n> > I would hope that setjmp() is very fast on most systems\n> It's not. I remember it being particularly slow on BSD (and therefore OS X) systems.\nI just found a discussion about this on the pari-dev mailing list: [http://pari.math.u-bordeaux.fr/archives/pari-dev-0909/msg00007.html](http://pari.math.u-bordeaux.fr/archives/pari-dev-0909/msg00007.html).\n\nThe reason is that in BSD, `setjmp()` saves the signal mask (which apparently is very expensive), while in System V-like systems it does not.  BSD does have `_setjmp()` and `sigsetjmp(, 0)`, which are comparable to `setjmp()` on other systems.  According to the link above, the `setjmp()` variant that does not touch the signal mask is 2.5 to 12 times as fast as the one that does.\n\nOf course, for signal handling you are stuck with the slow version, but for other purposes one could use the fast version.  In our situation the question is whether we do one slow system call, or the slow one for signal handling plus the fast one for handling PARI errors.\n\nFinally, the discussion cited above mentions the idea of letting the user of the PARI library specify a function to call when an error occurs instead of the `setjmp()/longjmp()` construction.  This doesn't currently seem to be implemented, though.",
    "created_at": "2013-08-13T14:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187074",
    "user": "@pjbruin"
}
```

Replying to [comment:28 jdemeyer]:
> Replying to [comment:27 pbruin]:
> > I would hope that setjmp() is very fast on most systems
> It's not. I remember it being particularly slow on BSD (and therefore OS X) systems.
I just found a discussion about this on the pari-dev mailing list: [http://pari.math.u-bordeaux.fr/archives/pari-dev-0909/msg00007.html](http://pari.math.u-bordeaux.fr/archives/pari-dev-0909/msg00007.html).

The reason is that in BSD, `setjmp()` saves the signal mask (which apparently is very expensive), while in System V-like systems it does not.  BSD does have `_setjmp()` and `sigsetjmp(, 0)`, which are comparable to `setjmp()` on other systems.  According to the link above, the `setjmp()` variant that does not touch the signal mask is 2.5 to 12 times as fast as the one that does.

Of course, for signal handling you are stuck with the slow version, but for other purposes one could use the fast version.  In our situation the question is whether we do one slow system call, or the slow one for signal handling plus the fast one for handling PARI errors.

Finally, the discussion cited above mentions the idea of letting the user of the PARI library specify a function to call when an error occurs instead of the `setjmp()/longjmp()` construction.  This doesn't currently seem to be implemented, though.



---

archive/issue_comments_187075.json:
```json
{
    "body": "Replying to [comment:29 pbruin]:\n> Of course, for signal handling you are stuck with the slow version\nFalse :-)  Sage's `sig_on()` uses `sigsetjmp(env,0)`. It manually resets the signal mask when actually handling an error.\n\n> Finally, the discussion cited above mentions the idea of letting the user of the PARI library specify a function to call when an error occurs instead of the `setjmp()/longjmp()` construction.\nI think this would be very good for Sage. I personally wouldn't mind patching that in ourselves in the Sage version of PARI.",
    "created_at": "2013-08-13T15:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187075",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 pbruin]:
> Of course, for signal handling you are stuck with the slow version
False :-)  Sage's `sig_on()` uses `sigsetjmp(env,0)`. It manually resets the signal mask when actually handling an error.

> Finally, the discussion cited above mentions the idea of letting the user of the PARI library specify a function to call when an error occurs instead of the `setjmp()/longjmp()` construction.
I think this would be very good for Sage. I personally wouldn't mind patching that in ourselves in the Sage version of PARI.



---

archive/issue_comments_187076.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:29 pbruin]:\n> > Of course, for signal handling you are stuck with the slow version\n> False :-)  Sage's `sig_on()` uses `sigsetjmp(env,0)`. It manually resets the signal mask when actually handling an error.\nOK, I read the code too carelessly.  But if you can simply use `sigsetjmp(env, 0)` for signal handling, then surely you can use it for handling PARI errors as well, so the slowness of `setjmp()` on BSD should be irrelevant.  The try/catch macros provided by PARI do use a plain `setjmp()`, but that should be easy to change.\n\nAnyway, if a non-`setjmp()`-based approach is feasible, that would be great.  It would probably still be quite non-trivial, though.",
    "created_at": "2013-08-13T15:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187076",
    "user": "@pjbruin"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:29 pbruin]:
> > Of course, for signal handling you are stuck with the slow version
> False :-)  Sage's `sig_on()` uses `sigsetjmp(env,0)`. It manually resets the signal mask when actually handling an error.
OK, I read the code too carelessly.  But if you can simply use `sigsetjmp(env, 0)` for signal handling, then surely you can use it for handling PARI errors as well, so the slowness of `setjmp()` on BSD should be irrelevant.  The try/catch macros provided by PARI do use a plain `setjmp()`, but that should be easy to change.

Anyway, if a non-`setjmp()`-based approach is feasible, that would be great.  It would probably still be quite non-trivial, though.



---

archive/issue_comments_187077.json:
```json
{
    "body": "Replying to [comment:32 pbruin]:\n> But if you can simply use `sigsetjmp(env, 0)` for signal handling, then surely you can use it for handling PARI errors as well\n\n> Anyway, if a non-`setjmp()`-based approach is feasible, that would be great.\n\nBoth of these require patching the PARI sources, and then I prefer the second approach for simplicity.",
    "created_at": "2013-08-13T15:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187077",
    "user": "@jdemeyer"
}
```

Replying to [comment:32 pbruin]:
> But if you can simply use `sigsetjmp(env, 0)` for signal handling, then surely you can use it for handling PARI errors as well

> Anyway, if a non-`setjmp()`-based approach is feasible, that would be great.

Both of these require patching the PARI sources, and then I prefer the second approach for simplicity.



---

archive/issue_comments_187078.json:
```json
{
    "body": "Actually, in `[PARI source]/language/init.c` (and in the header file `paricom.h`) there is a declaration\n\n```\nint  (*cb_pari_handle_exception)(long);\n```\n\nif this is non-zero, `pari_err()` calls it (with an error code as argument) when no saved environment is present to do a `longjmp()` to.  I could imagine setting this to a Cython function that converts a PARI error into an appropriate Python exception, and raising that exception.\n\nIt appears that the function to which `cb_pari_handle_exception` points should return non-zero if and only if the error was handled succesfully; if it was, `pari_err()` simply returns.  However, functions calling `pari_err()` normally expect that function not to return, so as things stand now, a suitable `setjmp()/longjmp()` would still seem to be necessary.",
    "created_at": "2013-08-13T16:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187078",
    "user": "@pjbruin"
}
```

Actually, in `[PARI source]/language/init.c` (and in the header file `paricom.h`) there is a declaration

```
int  (*cb_pari_handle_exception)(long);
```

if this is non-zero, `pari_err()` calls it (with an error code as argument) when no saved environment is present to do a `longjmp()` to.  I could imagine setting this to a Cython function that converts a PARI error into an appropriate Python exception, and raising that exception.

It appears that the function to which `cb_pari_handle_exception` points should return non-zero if and only if the error was handled succesfully; if it was, `pari_err()` simply returns.  However, functions calling `pari_err()` normally expect that function not to return, so as things stand now, a suitable `setjmp()/longjmp()` would still seem to be necessary.



---

archive/issue_comments_187079.json:
```json
{
    "body": "And just now I discovered that as long ago as #9640, you (Jeroen) were already saying that we should use `cb_pari_handle_exception` to catch PARI errors...",
    "created_at": "2013-08-13T16:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187079",
    "user": "@pjbruin"
}
```

And just now I discovered that as long ago as #9640, you (Jeroen) were already saying that we should use `cb_pari_handle_exception` to catch PARI errors...



---

archive/issue_comments_187080.json:
```json
{
    "body": "In any case, is this urgent at all? I think it makes more sense to do this as part of the upgrade to PARI-2.6, because PARI-2.6 does change the error handling mechanism quite a bit.",
    "created_at": "2013-08-14T08:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187080",
    "user": "@jdemeyer"
}
```

In any case, is this urgent at all? I think it makes more sense to do this as part of the upgrade to PARI-2.6, because PARI-2.6 does change the error handling mechanism quite a bit.



---

archive/issue_comments_187081.json:
```json
{
    "body": "Replying to [comment:36 jdemeyer]:\n> In any case, is this urgent at all? I think it makes more sense to do this as part of the upgrade to PARI-2.6, because PARI-2.6 does change the error handling mechanism quite a bit.\nThe current implementation has its problems (see the ticket description), but I know of nothing that is broken in practice.  Whether to do it now or during the upgrade depends on which solution is chosen.\n- Option 1: use the try/catch macros provided by PARI.  This we can do now, and it will make the upgrade easier, since similar macros are provided in 2.6 (albeit with slightly different names and a different implementation).\n- Option 2: keep using undocumented PARI functions/variables.  This can only be done at the same time as the upgrade, since the internals have changed a lot in 2.6.\nOption 1 is what the current patch does, and I still prefer this option.",
    "created_at": "2013-08-14T13:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187081",
    "user": "@pjbruin"
}
```

Replying to [comment:36 jdemeyer]:
> In any case, is this urgent at all? I think it makes more sense to do this as part of the upgrade to PARI-2.6, because PARI-2.6 does change the error handling mechanism quite a bit.
The current implementation has its problems (see the ticket description), but I know of nothing that is broken in practice.  Whether to do it now or during the upgrade depends on which solution is chosen.
- Option 1: use the try/catch macros provided by PARI.  This we can do now, and it will make the upgrade easier, since similar macros are provided in 2.6 (albeit with slightly different names and a different implementation).
- Option 2: keep using undocumented PARI functions/variables.  This can only be done at the same time as the upgrade, since the internals have changed a lot in 2.6.
Option 1 is what the current patch does, and I still prefer this option.



---

archive/issue_comments_187082.json:
```json
{
    "body": "Or option 3: patch PARI to hack the error handling functions.",
    "created_at": "2013-08-30T09:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187082",
    "user": "@jdemeyer"
}
```

Or option 3: patch PARI to hack the error handling functions.



---

archive/issue_comments_187083.json:
```json
{
    "body": "Part of this should be done now for use in #14888: making the `pari_sig_on()` macros available, see #15124.",
    "created_at": "2013-08-30T10:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187083",
    "user": "@jdemeyer"
}
```

Part of this should be done now for use in #14888: making the `pari_sig_on()` macros available, see #15124.



---

archive/issue_comments_187084.json:
```json
{
    "body": "I asked `pari-dev` about a callback function instead of `longjmp()` for PARI error handling (i.e. option 3 above).",
    "created_at": "2013-08-30T11:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187084",
    "user": "@jdemeyer"
}
```

I asked `pari-dev` about a callback function instead of `longjmp()` for PARI error handling (i.e. option 3 above).



---

archive/issue_comments_187085.json:
```json
{
    "body": "Replying to [comment:40 jdemeyer]:\n> I asked `pari-dev` about a callback function instead of `longjmp()` for PARI error handling (i.e. option 3 above).\nThere is the callback function `cb_pari_handle_exception`, but I don't quite see how to use this without any `longjmp()`; see comment:34.  Hence two questions:\n- Would a new callback function really be needed (e.g. because it has to be called at a different moment than `cb_pari_handle_exception`)?\n- Does the option 3 that you have in mind somehow avoid `longjmp()`, or do you propose to do the `longjmp()` inside a common error-handling function for signals and PARI errors?",
    "created_at": "2013-08-30T12:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187085",
    "user": "@pjbruin"
}
```

Replying to [comment:40 jdemeyer]:
> I asked `pari-dev` about a callback function instead of `longjmp()` for PARI error handling (i.e. option 3 above).
There is the callback function `cb_pari_handle_exception`, but I don't quite see how to use this without any `longjmp()`; see comment:34.  Hence two questions:
- Would a new callback function really be needed (e.g. because it has to be called at a different moment than `cb_pari_handle_exception`)?
- Does the option 3 that you have in mind somehow avoid `longjmp()`, or do you propose to do the `longjmp()` inside a common error-handling function for signals and PARI errors?



---

archive/issue_comments_187086.json:
```json
{
    "body": "Replying to [comment:41 pbruin]:\n> There is the callback function `cb_pari_handle_exception`\nThe problem with that callback is that it is called after printing the error message. For Sage, we don't want the error to be printed.\n\nMy approach would still use a `longjmp()` to jump to the `setjmp()` inside `sig_on()`. It would avoid an additional `setjmp()` call for PARI.",
    "created_at": "2013-08-30T13:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187086",
    "user": "@jdemeyer"
}
```

Replying to [comment:41 pbruin]:
> There is the callback function `cb_pari_handle_exception`
The problem with that callback is that it is called after printing the error message. For Sage, we don't want the error to be printed.

My approach would still use a `longjmp()` to jump to the `setjmp()` inside `sig_on()`. It would avoid an additional `setjmp()` call for PARI.



---

archive/issue_comments_187087.json:
```json
{
    "body": "Replying to [comment:42 jdemeyer]:\n> Replying to [comment:41 pbruin]:\n> > There is the callback function `cb_pari_handle_exception`\n> The problem with that callback is that it is called after printing the error message. For Sage, we don't want the error to be printed.\nCouldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.\n\n> My approach would still use a `longjmp()` to jump to the `setjmp()` inside `sig_on()`. It would avoid an additional `setjmp()` call for PARI.\nGood, that is what I suspected.",
    "created_at": "2013-08-30T14:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187087",
    "user": "@pjbruin"
}
```

Replying to [comment:42 jdemeyer]:
> Replying to [comment:41 pbruin]:
> > There is the callback function `cb_pari_handle_exception`
> The problem with that callback is that it is called after printing the error message. For Sage, we don't want the error to be printed.
Couldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.

> My approach would still use a `longjmp()` to jump to the `setjmp()` inside `sig_on()`. It would avoid an additional `setjmp()` call for PARI.
Good, that is what I suspected.



---

archive/issue_comments_187088.json:
```json
{
    "body": "Replying to [comment:43 pbruin]:\n> Couldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.\nThat was my original idea but there are some complications, for example the printing of an extra newline in `err_init()` and the use of ANSI escape sequences for colours.",
    "created_at": "2013-08-30T14:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187088",
    "user": "@jdemeyer"
}
```

Replying to [comment:43 pbruin]:
> Couldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.
That was my original idea but there are some complications, for example the printing of an extra newline in `err_init()` and the use of ANSI escape sequences for colours.



---

archive/issue_comments_187089.json:
```json
{
    "body": "Replying to [comment:44 jdemeyer]:\n> Replying to [comment:43 pbruin]:\n> > Couldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.\n> That was my original idea but there are some complications, for example the printing of an extra newline in `err_init()` and the use of ANSI escape sequences for colours.\nI see.  But wouldn't it be a more satisfactory solution to have PARI do those things only if the output is connected to a terminal (using `isatty`)?  This would still require a patch, of course.",
    "created_at": "2013-08-30T17:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187089",
    "user": "@pjbruin"
}
```

Replying to [comment:44 jdemeyer]:
> Replying to [comment:43 pbruin]:
> > Couldn't we prevent printing the error message by using a custom `pariErr` like we already do for `pariOut`?  Besides not having to patch PARI to add another callback, this has the additional advantage that the error text can be stored for possible inspection.
> That was my original idea but there are some complications, for example the printing of an extra newline in `err_init()` and the use of ANSI escape sequences for colours.
I see.  But wouldn't it be a more satisfactory solution to have PARI do those things only if the output is connected to a terminal (using `isatty`)?  This would still require a patch, of course.



---

archive/issue_comments_187090.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2013-11-22T23:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187090",
    "user": "@pjbruin"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_187091.json:
```json
{
    "body": "Now that we have a better error-handling mechanism (#9640), is there anything specific that needs to be done in this area when upgrading PARI?  Should this rather become a general PARI upgrade ticket, or be closed as a duplicate of #9640?\n\nAlso, do we want to upgrade to PARI 2.6.x or wait for 2.7.x (even minor version = development, odd = stable)?  In January there will be an \"Atelier PARI/GP\" where planning for PARI 2.9 is on the agenda (http://pari.math.u-bordeaux.fr/Events/PARI2014/), which suggests that a 2.7 release is in the pipeline.",
    "created_at": "2013-11-22T23:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187091",
    "user": "@pjbruin"
}
```

Now that we have a better error-handling mechanism (#9640), is there anything specific that needs to be done in this area when upgrading PARI?  Should this rather become a general PARI upgrade ticket, or be closed as a duplicate of #9640?

Also, do we want to upgrade to PARI 2.6.x or wait for 2.7.x (even minor version = development, odd = stable)?  In January there will be an "Atelier PARI/GP" where planning for PARI 2.9 is on the agenda (http://pari.math.u-bordeaux.fr/Events/PARI2014/), which suggests that a 2.7 release is in the pipeline.



---

archive/issue_comments_187092.json:
```json
{
    "body": "I would say: let this ticket quietly sit here and let's look at it again when PARI-2.7 is released.",
    "created_at": "2013-11-23T10:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187092",
    "user": "@jdemeyer"
}
```

I would say: let this ticket quietly sit here and let's look at it again when PARI-2.7 is released.



---

archive/issue_comments_187093.json:
```json
{
    "body": "In the light of #9640 and #15767, I think this ticket is no longer relevant and suggest to close it.",
    "created_at": "2014-08-18T23:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187093",
    "user": "@pjbruin"
}
```

In the light of #9640 and #15767, I think this ticket is no longer relevant and suggest to close it.



---

archive/issue_comments_187094.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-08-18T23:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187094",
    "user": "@pjbruin"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_187095.json:
```json
{
    "body": "I think that this ticket is still relevant, since PARI-2.7.x has improved error handling mechanisms which we don't use.",
    "created_at": "2014-08-19T08:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187095",
    "user": "@jdemeyer"
}
```

I think that this ticket is still relevant, since PARI-2.7.x has improved error handling mechanisms which we don't use.



---

archive/issue_comments_187096.json:
```json
{
    "body": "I think we do need to reconsider the approach though. Personally I like to use Karim's proposal from [http://pari.math.u-bordeaux.fr/archives/pari-dev-1309/msg00002.html](http://pari.math.u-bordeaux.fr/archives/pari-dev-1309/msg00002.html), but that hasn't been implemented upstream yet.",
    "created_at": "2014-08-19T08:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187096",
    "user": "@jdemeyer"
}
```

I think we do need to reconsider the approach though. Personally I like to use Karim's proposal from [http://pari.math.u-bordeaux.fr/archives/pari-dev-1309/msg00002.html](http://pari.math.u-bordeaux.fr/archives/pari-dev-1309/msg00002.html), but that hasn't been implemented upstream yet.



---

archive/issue_comments_187097.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2014-08-19T08:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187097",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_187098.json:
```json
{
    "body": "I'm willing to look into this ticket, but not right now.",
    "created_at": "2014-08-19T08:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187098",
    "user": "@jdemeyer"
}
```

I'm willing to look into this ticket, but not right now.



---

archive/issue_comments_187099.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-13T19:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187099",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_187100.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-13T19:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187100",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_187101.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-14T14:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187101",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_187102.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-14T16:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187102",
    "user": "@pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_187103.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-29T22:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14690",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14690#issuecomment-187103",
    "user": "@vbraun"
}
```

Resolution: fixed
