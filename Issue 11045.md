# Issue 11045: Bad displays for M2 in worksheets

Issue created by migration from https://trac.sagemath.org/ticket/11217

Original creator: tdupu

Original creation time: 2011-04-19 04:06:45

Assignee: jason, mpatel, was

Keywords: Macaulay2, Sage Notebook

This input in the sage notebook

```
R2 = macaulay2.ring('QQ','[x,y]'); R2
```

gives this output

```
        	

QQ[x..y, Degrees => {2:1}, Heft => {1}, MonomialOrder =>
{MonomialSize => 16}, DegreeRank => 1]
                                                         {Lex => 2   
}
                                                         {Position =>
Up    }


```


This input in the sage notebook 

```
I = macaulay2.ideal( ('y^2 -x','x-y') ); I
J = I^3;
print J
print J.gb()
```

gives this output

```
        6       4     2 2    3     4    5     2 2       3    3    2    2
2       3    4    3     2       2   3     2        2    3
ideal (y  + 2x*y  - 2x y  - x , x*y  - y  - 2x y  + 2x*y  + x  - x y, x
y  - 2x*y  + y  - x  + 2x y - x*y , x  + 2x y - 2x*y  - y )
GroebnerBasis[status: done; S-pairs encountered up to degree 6]
```

This may not be limited to the sage notebook. I haven't checked.


---

Comment by chapoton created at 2019-06-21 08:11:00

Changing keywords from "Macaulay2, Sage Notebook" to "Macaulay2".


---

Comment by chapoton created at 2019-06-21 08:11:00

Changing component from notebook to interfaces: optional.


---

Comment by @mwageringel created at 2019-06-22 15:01:07

This is controlled by `printWidth` in Macaulay2, which is initialized to 0 by the interface, effectively disabling line wrapping. It could probably be set to something else, e.g. 80 or the terminal width, but some parts of the implementation might expect unwrapped output, such as tab completion.

With Macaulay2 1.12, it can also be set manually:

```
sage: macaulay2.eval('printWidth = 80;')

sage: I^3
          3     2 2       4    6   3     2 2    2       4       3
ideal (- x  + 3x y  - 3x*y  + y , x  - 2x y  - x y + x*y  + 2x*y
------------------------------------------------------------------
   5     3    2 2     2        3      2    4   3     2        2
- y , - x  + x y  + 2x y - 2x*y  - x*y  + y , x  - 3x y + 3x*y  -
------------------------------------------------------------------
 3
y )
```


In Macaulay2 1.13, this does not have any effect. Apparently the behavior of `describe` has changed to ignore `printWidth` – this should make it work:

```diff
--- a/src/sage/interfaces/macaulay2.py
+++ b/src/sage/interfaces/macaulay2.py
@@ -303,7 +311,7 @@ class Macaulay2(ExtraTabCompletion, Expect):
             sage: macaulay2.get("a")      # optional - macaulay2
             2
         """
-        return self.eval("describe %s"%var, strip=True)
+        return self.eval("net describe %s"%var, strip=True)

     def set(self, var, value):
         """
```



---

Comment by @mwageringel created at 2019-06-27 19:54:34

The following patch (based on #27979) works for me with Macaulay2 version 1.12 and 1.13. This leaves `printWidth` alone, but comes with the advantage that it always takes the current terminal width into account. In the notebook, it defaults to 80 characters.

Several doctests will need to be updated for this – I will postpone this until the other Macaulay2 tickets are merged.


```diff
--- a/src/sage/interfaces/macaulay2.py
+++ b/src/sage/interfaces/macaulay2.py
@@ -184,7 +184,12 @@ class Macaulay2(ExtraTabCompletion, Expect):
             # Also prevent line wrapping in Macaulay2
             "printWidth = 0;" +
             # And make all output labels to be of the same width
-            "lineNumber = 10^9;")
+            "lineNumber = 10^9;"
+            # Convert a Macaulay2 element to Net for display in Sage.
+            'sageDescribe = method();'
+            'sageDescribe(Thing) := net @@ describe;'
+            'sageDescribe(Matrix) := net;'
+            )
         Expect.__init__(self,
                         name = 'macaulay2',
                         prompt = PROMPT,
@@ -339,8 +344,9 @@ class Macaulay2(ExtraTabCompletion, Expect):
             | 1 2 |
             | 3 4 |
         """
-        return self.eval('(if instance({0}, Matrix) then net else describe)'
-                         ' {0}'.format(var), strip=True)
+        from sage.typeset.ascii_art import empty_ascii_art
+        return self.eval('wrap(%d,"-",sageDescribe %s)'
+                % (empty_ascii_art._terminal_width(), var), strip=True)

     def set(self, var, value):
         """
```



---

Comment by @mwageringel created at 2019-07-15 21:00:40

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-07-15 21:00:40

Here is a branch implementing this. This was tested with Macaulay2 version 1.12 and 1.13 using

```
./sage -t --long --optional=sage,macaulay2 $(grep -i "optional.*macaulay2" -r src/sage -l | paste -sd " " -)
```

----
New commits:


---

Comment by @mwageringel created at 2019-07-15 22:05:18

Changing status from needs_review to needs_work.


---

Comment by @mwageringel created at 2019-07-15 22:05:18

This needs more work, as conversion to Sage in the method `_sage_()` depends on the unwrapped string representation of Macaulay2 elements, in several places. For example this fails:

```
sage: macaulay2('QQ[x_0..x_5]')._sage_()
Multivariate Polynomial Ring in x_0, x_1, x_2, x_3, x_4, x_5 over Rational Field
sage: macaulay2('QQ[x_0..x_100]')._sage_()
...
ValueError: variable name '------...' is not alphanumeric
```



---

Comment by git created at 2019-07-17 22:20:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-07-17 22:28:16

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2019-07-17 22:28:16

I solved this by implementing the method `_repr_` which is now distinct from `__str__`. Now `_repr_` wraps the Macaulay2 output in the Sage REPL, similar to how output is wrapped in the Macaulay2 REPL.

In contrast, `__str__` does not wrap the output – this way, printing a `Macaulay2Element` using `print` gives the unwrapped output, just like printing in Macaulay2 does not wrap the output.

```
sage: macaulay2.eval('print(1..25)')
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
sage: print(macaulay2('1..25'))
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
sage: macaulay2('1..25')
(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,
--------------------------------------------------------------------------------
23, 24, 25)
```


Aside from that, I changed the way the Nets of Macaulay2 elements are converted to the string representations in Sage (in `get` and `_repr_`). Namely, I added a `print` as this avoids having to remove the prompt from the output string.

I also fixed a corner case involving Macaulay2 Sequences, and changed a few doctests to be more specific in what they test (in order to avoid the clumsy output of Macaulay2 polynomial rings).


---

Comment by chapoton created at 2019-07-18 07:58:47

looks good, works and pass the tests => positive review

Maybe one should send "sageDescribe" to upstream ?


---

Comment by chapoton created at 2019-07-18 07:58:47

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2019-07-19 19:32:06

Thanks. I opened https://github.com/Macaulay2/M2/issues/967 about this.


---

Comment by vbraun created at 2019-07-23 21:03:56

Resolution: fixed
