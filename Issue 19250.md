# Issue 19250: Support .zip upstream/ files

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2015-10-27 14:42:20

CC:  mkoeppe

Here it is. It was not so tough, though the code is a bit clumsy.

Nathann


---

Comment by ncohen created at 2015-10-27 14:43:46

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-10-27 14:43:46

The mosst obvious use-case for this ticket would be #19483 (whose original tarball is .zip) but it is already reviewed. I'll do what the reviewers ask.

Nathann
----
New commits:


---

Comment by vbraun created at 2015-10-28 09:14:13

Ooh fugly, unzip and re-tar and pipe and untar? Of course its really the original script's fault for not being modular...

Can we at least put sage-unzip into build/bin/ and not expose it via a `sage -unzip` command line argument? It has no mathematical purpose, its just an internal tool for building Sage packages.


---

Comment by dimpase created at 2015-10-28 09:23:58

Replying to [comment:2 vbraun]:
> Ooh fugly, unzip and re-tar and pipe and untar? Of course its really the original script's fault for not being modular...
> 
> Can we at least put sage-unzip into build/bin/ and not expose it via a `sage -unzip` command line argument? It has no mathematical purpose, its just an internal tool for building Sage packages.

neither `sage --git`, nor `sage --twisted` have any maths purpose, yet they are still there...


---

Comment by ncohen created at 2015-10-28 09:24:40

> Ooh fugly, unzip and re-tar and pipe and untar? Of course its really the original script's fault for not being modular...

Yeah well. I minimize my changes to the current scripts. So I adapted to what was already there. I loved that line in particular:

```
lbzip2 -d -c "$1" 2>/dev/null || bzip2 -d -c "$1" 2>/dev/null || gzip -d -c "$1" 2>/dev/null || cat "$1"
```


> Can we at least put sage-unzip into build/bin/ and not expose it via a `sage -unzip` command line argument? It has no mathematical purpose, its just an internal tool for building Sage packages.

Can you make this comment on the right ticket, i.e. #19484?

Nathann


---

Comment by vbraun created at 2015-10-28 09:28:34

Discussion moved to #19484


---

Comment by git created at 2015-10-28 13:52:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-11-22 12:11:25

I guess what I'd like to see is a zipfile-based example to use this patch to install stuff. How about making one on #18708 ?


---

Comment by ncohen created at 2015-11-22 12:18:34

I can update bliss, but that's a bit silly since it is the latest version since #19483 (which is why I wrote this branch). I don't know what 'normalize' is: can you add this ticket as a dependency of #18708? This way you can check that it works (should be totally straightforward) and that other package will be udpated.

Nathann


---

Comment by mkoeppe created at 2015-12-17 07:38:43

This does not work on Mac OS X because "sed -s" is a GNU extension.


---

Comment by mkoeppe created at 2015-12-17 07:38:43

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-12-17 07:41:12

I don't have Mac OS X, and I do not know how it must be written to work there. Can you fix what must be for it to work on your platform ?


---

Comment by mkoeppe created at 2015-12-17 08:20:16

Sure, I'll try to make it portable


---

Comment by git created at 2015-12-17 12:35:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-17 12:37:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-12-17 12:38:24

Unless this does the trick? I removed the '-s', as I have no idea why it was there in the first place `O_o`

Nathann


---

Comment by ncohen created at 2015-12-17 12:38:33

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2015-12-17 21:37:21

The regexp needed fixing also.
----
New commits:


---

Comment by ncohen created at 2015-12-18 07:45:48

Err... You sure that there is no way to have a 'OR' in a regexp under MacOSX ?.... The readability has dramatically decreased, if I may say..

Also you seem to strip lz, but I do not think that our scripts can unpackage lz files.

Nathann


---

Comment by mkoeppe created at 2015-12-18 17:48:02

The GNU sed implementation explains pretty well what are GNU extensions. And yes, if one always used the GNU version it's stunning how restrictive the classic UNIX versions were.

Perhaps best to rewrite the whole thing using a sequence of bash substitutions instead.

I stripped a few more file extensions to future-proof the script.


---

Comment by dimpase created at 2015-12-18 18:42:33

how about a python script instead?


---

Comment by ncohen created at 2015-12-18 20:09:21

> The GNU sed implementation explains pretty well what are GNU extensions. And yes, if one always used the GNU version it's stunning how restrictive the classic UNIX versions were.

I tried to rewrite this regexp in posix. Can you try whether this works in Mac OSX? The '--posix' flag is meant to disable whatever shouldn't be supported


```
~$ echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed --posix "s/[\.zip|\.tar|\.gz]*$//g" 
whatever.tar.2.0
```


Nathann


---

Comment by vbraun created at 2015-12-18 20:22:18

The whole zip/re-tar stuff is hilarious. If anything, this ticket shows that the current sage-spkg script is just unmaintainable. 

+1 to a python script...


---

Comment by ncohen created at 2015-12-18 20:27:08

> The whole zip/re-tar stuff is hilarious.

+1. I couldn't believe when I first saw it `:-P`

> If anything, this ticket shows that the current sage-spkg script is just unmaintainable. 
> 
> +1 to a python script...

Well I don't mind if you want to write it, but given that the present ticket does not change it too much, honestly I don't think that it is very urgent to rewrite. But indeed, this script is... "hacky"? `:-P`

Nathann


---

Comment by mkoeppe created at 2015-12-18 21:13:05

Replying to [comment:21 ncohen]:
> > The GNU sed implementation explains pretty well what are GNU extensions. And yes, if one always used the GNU version it's stunning how restrictive the classic UNIX versions were.
> 
> I tried to rewrite this regexp in posix. Can you try whether this works in Mac OSX? The '--posix' flag is meant to disable whatever shouldn't be supported
> 
> {{{
> ~$ echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed --posix "s/[\.zip|\.tar|\.gz]*$//g" 
> whatever.tar.2.0
> }}}

It does not work. UNIX sed does not understand any command line option with double dashes.

And, by the way, your original regexp does not work because you're confusing [] and \( \).


---

Comment by ncohen created at 2015-12-18 21:22:12

Helloooo,

> It does not work. UNIX sed does not understand any command line option with double dashes.

Do you mean the " ? Are those called "double dashes" ? Does it still fail if you use simple quotes instead, i.e. `sed --posix 's/[\.zip|\.tar|\.gz]*$//g'`

> And, by the way, your original regexp does not work because you're confusing [] and \( \).

Yep yep sorry, I noticed that while working on this new version. Which seems to work reliably, on my distro at least.

Nathann


---

Comment by jhpalmieri created at 2015-12-18 21:25:11

By double dashes, he meant the option `--posix`.

On OS X, use the `-E` flag for sed:

```
echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed -E "s/(\.zip|\.tar|\.gz|\.tgz)*$//g" 
```

But `-E` is not a posix option or a GNU sed option, so I guess we can't use it. A Python script would avoid these compatibility issues.


---

Comment by ncohen created at 2015-12-18 21:28:07

> By double dashes, he meant the option `--posix`.

Oh, okay sorry. This being said, my command also works without the '--posix'. So if we can have 

```
~$ echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed "s/[\.zip|\.tar|\.gz]*$//g"  
whatever.tar.2.0
```


and if it works in OSX too, then it's good?.. Apparently it is posix, for it works even when --posix is added (though it is not necessary).

Nathann


---

Comment by jhpalmieri created at 2015-12-18 21:55:29

Your command works but is probably not what we want. The regular expression `[\.zip|\.tar|\.gz]*` matches any string formed by the characters between the brackets, so it is equivalent to `[\.ziptarg|]*`. So I think it matches too much: the `sed` invocation would convert `whatever.tar.2.0.zig.zag.rat` to `whatever.tar.2.0`. This was mkoeppe's comment about confusing `[]` with `\(\)`.

On OS X, 

```
echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed -E "s/(\.zip|\.tar|\.gz|\.tgz)*$//g"
```

works, while omitting `-E`

```
echo whatever.tar.2.0.zip.tar.gz.tar.tgz | sed "s/(\.zip|\.tar|\.gz|\.tgz)*$//g"
```

does not.


---

Comment by ncohen created at 2015-12-19 08:49:19

> Your command works but is probably not what we want. The regular expression `[\.zip|\.tar|\.gz]*` matches any string formed by the characters between the brackets, so it is equivalent to `[\.ziptarg|]*`.

Arg... Yeah, it just doesn't work at all. Sorry `:-/`

I'll try to find something else `:-/`

Nathann


---

Comment by ncohen created at 2015-12-19 09:59:20

Okay okay.. Can't find much better. Bash substitution would be very verbose too so, well. Let's stick with the ugly/long sed command `:-/`


---

Comment by ncohen created at 2015-12-19 10:13:02

New commits:


---

Comment by ncohen created at 2015-12-19 10:14:34

Hello !

I updated this ticket a bit in order to use the original .zip archive for the bliss package. It is the same version as the one we use, so it is not even a package update and there is no risk of anything. I used to test the ticket, and it works well: if you also agree with it, then we can get it merged.

Thanks,

Nathann


---

Comment by dimpase created at 2015-12-20 17:33:14

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2015-12-20 17:33:14

OK, good. I tested it with Sage 6.10  merged in, it works.
I suppose the bliss zip file needs to be uploaded to the mirrors...


---

Comment by dimpase created at 2015-12-20 19:47:55

by the way, isn't the option to do checksum of just one file broken?


---

Comment by dimpase created at 2015-12-20 20:03:50

also, no upstream/*bz2 files are checksum'ed anymore!


---

Comment by dimpase created at 2015-12-20 20:03:50

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2015-12-20 20:16:58

if seems to work if I apply

```
diff --git a/src/bin/sage-fix-pkg-checksums b/src/bin/sage-fix-pkg-checksums
index 149f68f..f16fab7 100755
--- a/src/bin/sage-fix-pkg-checksums
+++ b/src/bin/sage-fix-pkg-checksums
`@``@` -14,7 +14,7 `@``@` do
     pkg_name=${tarball%%-*}
     # Convert to lowercase for the directory name:
     pkg_name_lc=`echo $pkg_name | tr '[:upper:]' '[:lower:]'`
-    extension=$(echo $tarball | grep -o -E "(.tar|.gz|.zip)*$") # file extension (.tar,.tar.gz,.zip)
+    extension=$(echo $tarball | grep -o -E "(.tar|.gz|.bz2|.zip)*$") # file extension (.tar,.tar.gz,.zip)
     if [ -d "$SAGE_ROOT/build/pkgs/$pkg_name_lc" ]; then
         sage_version=`cat "$SAGE_ROOT/build/pkgs/$pkg_name_lc/package-version.txt" | sed 's/\.p[0-9][0-9]*$//'`
         if [ ${tarball%$extension*} = "$pkg_name-$sage_version" ]; then
```



---

Comment by git created at 2015-12-20 20:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-12-20 20:52:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ncohen created at 2015-12-20 20:53:01

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-12-22 19:49:46

Resolution: fixed


---

Comment by jhpalmieri created at 2016-02-26 04:52:14

See #20120 for a followup: replace the uncompressing stuff with a Python script.
