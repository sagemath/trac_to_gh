# Issue 32622: Wrong display from type() with %display latex

Issue created by migration from https://trac.sagemath.org/ticket/32859

Original creator: egourgoulhon

Original creation time: 2021-11-12 12:23:06

CC:  klee

Keywords: jupyter display latex

In Sage 9.4 and 9.5.beta5, the following cell of a Jupyter notebook

```
%display latex
type(x)
```

results in 

```
\[\newcommand{\Bold}[1]{\mathbf{#1}}\verb||\]
```

instead of 

```
<ðšŒðš•ðšŠðšœðšœ'ðšœðšŠðšðšŽ.ðšœðš¢ðš–ðš‹ðš˜ðš•ðš’ðšŒ.ðšŽðš¡ðš™ðš›ðšŽðšœðšœðš’ðš˜ðš—.ð™´ðš¡ðš™ðš›ðšŽðšœðšœðš’ðš˜ðš—'>
```

Everything is OK with Sage <= 9.3. 


---

Comment by git created at 2021-11-12 14:35:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-11-12 14:35:28

Changing status from new to needs_review.


---

Comment by klee created at 2021-11-12 14:36:57

The fix for this ticket is this part:


```diff
--- a/src/sage/misc/html.py
+++ b/src/sage/misc/html.py
@@ -351,15 +351,16 @@ class MathJax:
             [_Latex_prefs._option['macros']] +
             parts
         )
+        mathjax_string = latex_string.replace('<', '&lt;')
         if mode == 'display':
             html = r'<html>\[{0}\]</html>'
         elif mode == 'inline':
             html = r'<html>\({0}\)</html>'
         elif mode == 'plain':
-            return latex_string
+            return mathjax_string
         else:
             raise ValueError("mode must be either 'display', 'inline', or 'plain'")
-        return MathJaxExpr(html.format(latex_string))
+        return MathJaxExpr(html.format(mathjax_string))
 
 
 class HTMLFragmentFactory(SageObject):
diff --git a/src/sage/repl/rich_output/output_browser.py b/src/sage/repl/rich_output/output_browser.py
index 2746e3dff8..3d7cda599a 100644
--- a/src/sage/repl/rich_output/output_browser.py
+++ b/src/sage/repl/rich_output/output_browser.py
@@ -40,10 +40,12 @@ class OutputHtml(OutputBase):
         # pdf export of a notebook
         m = latex_re.match(html)
         if m:
+            mathjax_string = m.group('latex')
+            latex_string = mathjax_string.replace('&lt;', '<')
             if m.group('mathstart') == r'\[' and m.group('mathend') == r'\]':
-                self.latex = OutputBuffer('$$' + m.group('latex') + '$$')
+                self.latex = OutputBuffer('$$' + latex_string + '$$')
             else:
-                self.latex = OutputBuffer('$' + m.group('latex') + '$')
+                self.latex = OutputBuffer('$' + latex_string + '$')
```



---

Comment by klee created at 2021-11-12 14:39:29

But I merged the branch of #32208 to the present branch, in order to also fix pdf export problem of the example

```
%display latex
type(x)
```

of this ticket.


---

Comment by klee created at 2021-11-12 14:42:22

As always, please watch for any unexpected side effects in display and printing...


---

Comment by git created at 2021-11-12 14:54:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-11-13 10:32:33

Thank you very much for the prompt fix! I am setting #32208 as a dependency because of comment:6 and I am going to test both tickets.


---

Comment by egourgoulhon created at 2021-11-13 10:32:33

Changing priority from major to critical.


---

Comment by egourgoulhon created at 2021-11-13 13:38:12

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-11-13 13:38:12

As for #32208, I've tested the fix with these notebooks: [test_display_latex](https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display_latex.ipynb), [SM_Kerr_surfaces](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_surfaces.ipynb) and [SM_spheres_S2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_sphere_S2.ipynb). Everything seems OK. Thank you very much.


---

Comment by klee created at 2021-11-13 23:23:18

Thank you.


---

Comment by klee created at 2021-11-13 23:53:48

This is an off-topic, but your notebooks show latex expressions flush left. As far as I know, latex expressions are displayed centered by default. I don't know how you did it. Anyway, I think latex expressions should be shown flush left by default. What do you think?


---

Comment by egourgoulhon created at 2021-11-14 08:52:33

Replying to [comment:12 klee]:
> This is an off-topic, but your notebooks show latex expressions flush left. As far as I know, latex expressions are displayed centered by default. I don't know how you did it. 

I did nothing special. Latex expressions have always been flushed left on my notebooks since the introduction of Jupyter in Sage. Are they centered on your computer? The only thing I've noticed is that when run on CoCalc, the very same notebook has latex expression centered, see e.g. this [example](https://cocalc.com/share/public_paths/6850015be0320058cadba1ce63e7a3eedf4eef89).
>Anyway, I think latex expressions should be shown flush left by default. What do you think?
I don't have any strong opinion on that, but I agree with you: flush left is usually what we have in published articles.


---

Comment by klee created at 2021-11-14 10:14:18

Replying to [comment:13 egourgoulhon]:
> I did nothing special. Latex expressions have always been flushed left on my notebooks since the introduction of Jupyter in Sage. Are they centered on your computer? 

Yes. It is mysterious to me since I know that latex expressions are centered because they are enclosed by `\[...\]`.

> >Anyway, I think latex expressions should be shown flush left by default. What do you think?
> I don't have any strong opinion on that, but I agree with you: flush left is usually what we have in published articles.

Okay. Thank you.


---

Comment by vbraun created at 2021-11-14 17:09:25

Merge conflict


---

Comment by vbraun created at 2021-11-14 17:09:25

Changing status from positive_review to needs_work.


---

Comment by egourgoulhon created at 2021-11-14 20:35:08

Replying to [comment:14 klee]:
> Replying to [comment:13 egourgoulhon]:
> > I did nothing special. Latex expressions have always been flushed left on my notebooks since the introduction of Jupyter in Sage. Are they centered on your computer? 
> 
> Yes. It is mysterious to me since I know that latex expressions are centered because they are enclosed by `\[...\]`.
This is strange indeed... Maybe it's a matter of OS? What is yours? Mine is Ubuntu 20.04. I've always had flushed left expressions on all the computers I've used (all running various versions of Ubuntu). It could also be related to the locale (fr_FR in my case). The centered rendering on CoCalc does not surprise me further because their Jupyter is somehow customized.


---

Comment by egourgoulhon created at 2021-11-14 20:36:23

Replying to [comment:15 vbraun]:
> Merge conflict
I guess we have to wait for 9.5.beta7 to solve that one.


---

Comment by git created at 2021-11-15 01:06:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-11-15 01:07:09

Resolved merge conflict


---

Comment by klee created at 2021-11-15 01:07:09

Changing status from needs_work to positive_review.


---

Comment by klee created at 2021-11-15 01:15:12

Replying to [comment:16 egourgoulhon]:
> This is strange indeed... Maybe it's a matter of OS? What is yours? Mine is Ubuntu 20.04.

Mine is Mac OS. 

> I've always had flushed left expressions on all the computers I've used (all running various versions of Ubuntu). It could also be related to the locale (fr_FR in my case). 

Possibly. I don't know. If you open the notebook in editor (by right-clicking it), then you can see the raw data. Mine shows

```
    {
     "data": {
      "text/html": [
       "<html>\\[\\newcommand{\\Bold}[1]{\\mathbf{#1}}\\verb|&lt;class|\\verb| |\\verb|'sage.symbolic.expression.Expression'>|\\]</html>"
      ],
      "text/latex": [
       "$$\\newcommand{\\Bold}[1]{\\mathbf{#1}}\\verb|<class|\\verb| |\\verb|'sage.symbolic.expression.Expression'>|$$"
      ],
      "text/plain": [
       "<class 'sage.symbolic.expression.Expression'>"
      ]
     }
```

for `type(x)` cell. You see `\\[` and `$$`. How about yours?


---

Comment by klee created at 2021-11-15 01:22:12

I directly checked your notebooks. They are the same, the same `\\[` and `$$`.


---

Comment by klee created at 2021-11-15 01:37:35

I downloaded your notebook to open it in my jupyterlab. Now latex expressions are centered. In nbviewer, they are rendered by mathjax 2.7.1. My jupyterlab uses mathjax 2.7.9. It might be a bug of mathjax 2.7.1...


---

Comment by egourgoulhon created at 2021-11-15 08:35:03

Replying to [comment:22 klee]:
> I downloaded your notebook to open it in my jupyterlab. Now latex expressions are centered. In nbviewer, they are rendered by mathjax 2.7.1. My jupyterlab uses mathjax 2.7.9. It might be a bug of mathjax 2.7.1... 

My Jupyter notebook uses Mathjax 2.7.9 as well. However, if I right-click on a displayed expression to open the Mathjax contextual menu and choose `Math Settings -> Math Redender`, I see that `HTML-CSS` is selected; if I select `MathML` instead, I get a warning:

```
Your browser's native MathML does not implement all the features used by MathJax, 
so some expressions may not render properly.
```

but then all the formulas in the notebook become centered! Moreover, the Rubik's cube is then correctly displayed. 

The above is for Firefox (my default browser). If I do the same thing with Chrome (where initially all LaTeX expressions are left-flushed as well), I got the same warning when switching from `HTML-CSS` to `MathML`, but then, instead of LaTeX rendering, the literal code is displayed,
e.g. 

```
\newcommand{\Bold}[1]{\mathbf{#1}}\sin\left(x^{2}\right)
```

for the first formula.


---

Comment by klee created at 2021-11-15 08:44:45

Replying to [comment:23 egourgoulhon]:
> My Jupyter notebook uses Mathjax 2.7.9 as well. However, if I right-click on a displayed expression to open the Mathjax contextual menu and choose `Math Settings -> Math Redender`, I see that `HTML-CSS` is selected; if I select `MathML` instead, I get a warning:
> {{{
> Your browser's native MathML does not implement all the features used by MathJax, 
> so some expressions may not render properly.
> }}}
> but then all the formulas in the notebook become centered! Moreover, the Rubik's cube is then correctly displayed. 

I experience all the same except that with HTML-CSS renderer, latex expressions are still centered.


---

Comment by klee created at 2021-11-15 08:51:04

With Firefox on my mac, all the same (centered displays).


---

Comment by klee created at 2021-11-15 08:58:37

Jupyter screenshot


---

Attachment

Another data point: when running Jupyterlab on my computer (via `sage -n jupyterlab`), latex expressions are centered. So there is a difference of behavior between the Jupyter notebook and Jupyterlab.


---

Comment by klee created at 2021-11-15 10:47:33

Replying to [comment:26 egourgoulhon]:
> Another data point: when running Jupyterlab on my computer (via `sage -n jupyterlab`), latex expressions are centered. So there is a difference of behavior between the Jupyter notebook and Jupyterlab.

Right. Me too. So it is a difference between jupyter notebook and jupyterlab!


---

Comment by egourgoulhon created at 2021-11-15 13:17:46

Another thing: you might have noticed on Cell [7] of the notebook [test_display_latex](https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display_latex.ipynb) that in `%display latex` mode, `matplotlib.pyplot.show()` displays `Figure(432x288)` instead of the actual figure. This issue certainly does not pertain to the current ticket. Is there already a ticket for it?


---

Comment by klee created at 2021-11-16 04:58:57

Replying to [comment:28 egourgoulhon]:
> Another thing: you might have noticed on Cell [7] of the notebook [test_display_latex](https://nbviewer.org/github/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display_latex.ipynb) that in `%display latex` mode, `matplotlib.pyplot.show()` displays `Figure(432x288)` instead of the actual figure. This issue certainly does not pertain to the current ticket. Is there already a ticket for it?

#32882 is the new ticket for it.


---

Comment by egourgoulhon created at 2021-11-16 09:05:44

Replying to [comment:29 klee]:
> 
> #32882 is the new ticket for it.
> 
Thank you!


---

Comment by vbraun created at 2021-11-18 23:38:08

Resolution: fixed


---

Comment by egourgoulhon created at 2021-11-26 13:19:10

Regarding the above discussion about centered math formulas, a relevant [ask.sagemath question](https://ask.sagemath.org/question/59775/display-latex-makes-output-centered-in-exported-tex-file/) has been posted recently, complaining about centered outputs in LaTeX exports of Jupyter notebooks.  Apparently `\begin{math}...\end{math}` has been replaced by `$$...$$` somewhere between Sage 9.3 and 9.4.


---

Comment by klee created at 2021-11-26 16:35:41

Replying to [comment:32 egourgoulhon]:
> Regarding the above discussion about centered math formulas, a relevant [ask.sagemath question](https://ask.sagemath.org/question/59775/display-latex-makes-output-centered-in-exported-tex-file/) has been posted recently, complaining about centered outputs in LaTeX exports of Jupyter notebooks.  Apparently `\begin{math}...\end{math}` has been replaced by `$$...$$` somewhere between Sage 9.3 and 9.4. 

I don't know how that happened. But it is likely that the behavior was introduced by one of the tickets that I authored.  

Anyway that "centered" behavior is consistent with what we see in the jupyterlab. So the question is what behavior we want.


---

Comment by egourgoulhon created at 2021-11-26 16:55:17

Replying to [comment:33 klee]:
> 
> Anyway that "centered" behavior is consistent with what we see in the jupyterlab. So the question is what behavior we want. 

Exactly. As I said before (comment:13), I am kind of neutral on that.


---

Comment by klee created at 2021-11-26 23:09:45

Replying to [comment:34 egourgoulhon]:
> Exactly. As I said before (comment:13), I am kind of neutral on that.  

I prefer flush left. Well, I think users would be divided. A solution would be to introduce an option to control the behavior.


---

Comment by klee created at 2021-11-27 13:29:47

Replying to [comment:35 klee]:
> A solution would be to introduce an option to control the behavior.

This is now implemented in #32942. Please review.
