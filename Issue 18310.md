# Issue 18310: Improve polynomial powering in positive characteristic

archive/issues_018310.json:
```json
{
    "body": "Keywords: polynomial, powering\n\nBefore:\n\n\n```python\nsage: R.<x> = PolynomialRing(GF(5), sparse=True)\nsage: (1+x)^(5^10)\n... (hangs for ever)\n```\n\n\nAfter:\n\n```python\nsage: R.<x> = PolynomialRing(GF(5), sparse=True)\nsage: (1+x)^(5^10)\nx^9765625 + 1\n```\n\n\n**Notes.**\n1. I've tried to be careful with quite extensive tests not to slow down the computations for \"easy\" cases. This explains the threshold values in the code.\n2. This is related to #7253 and #12660. Though, there is another problem for non-sparse polynomials: Simply assigning the value and printing the polynomial take a very long time. Compare the timings for\n    {{{#!python\n    sage: R.<x> = ZZ[]\n    sage: 1+x<sup>5</sup>10\n    x^9765625 + 1\n    }}}\n    and \n    {{{#!python\n    sage: R.<x> = GF(5)[]\n    sage: 1+x<sup>5</sup>10\n    x^9765625 + 1\n    }}}\n    Thus for tickets #7253 and #12660 to be closed, it remains to handle this other problem, but this is not the purpose of this ticket.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18547\n\n",
    "created_at": "2015-05-29T15:18:57Z",
    "labels": [
        "component: commutative algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Improve polynomial powering in positive characteristic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18310",
    "user": "https://github.com/bgrenet"
}
```
Keywords: polynomial, powering

Before:


```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
... (hangs for ever)
```


After:

```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
x^9765625 + 1
```


**Notes.**
1. I've tried to be careful with quite extensive tests not to slow down the computations for "easy" cases. This explains the threshold values in the code.
2. This is related to #7253 and #12660. Though, there is another problem for non-sparse polynomials: Simply assigning the value and printing the polynomial take a very long time. Compare the timings for
    {{{#!python
    sage: R.<x> = ZZ[]
    sage: 1+x<sup>5</sup>10
    x^9765625 + 1
    }}}
    and 
    {{{#!python
    sage: R.<x> = GF(5)[]
    sage: 1+x<sup>5</sup>10
    x^9765625 + 1
    }}}
    Thus for tickets #7253 and #12660 to be closed, it remains to handle this other problem, but this is not the purpose of this ticket.



Issue created by migration from https://trac.sagemath.org/ticket/18547





---

archive/issue_comments_247962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-29T15:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247963.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-29T15:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247963",
    "user": "https://github.com/bgrenet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_247964.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-29T15:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247964",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247965.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-29T19:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247965",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_247966.json:
```json
{
    "body": "Your added doctest still takes `# long time` (28s on my computer). You should shorten the test to take less than 1s: `5^8` instead of `5^10` would be better.",
    "created_at": "2015-05-29T19:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247966",
    "user": "https://github.com/jdemeyer"
}
```

Your added doctest still takes `# long time` (28s on my computer). You should shorten the test to take less than 1s: `5^8` instead of `5^10` would be better.



---

archive/issue_comments_247967.json:
```json
{
    "body": "I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...",
    "created_at": "2015-05-29T19:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247967",
    "user": "https://github.com/jdemeyer"
}
```

I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...



---

archive/issue_comments_247968.json:
```json
{
    "body": "I think it does use the code.  But what's happening is that in the line\n\n```\n                return self.subs({x:x**(q*p)}) * self**r\n```\n\n`x**(q*p)` is taking (almost) all the time.  And this comes from the section of the code dealing with powers of the polynomial generator, in particular the line\n\n```\n            return self.parent()(v, check=False)\n```\n\nwhere `v` is defined in the previous line as\n\n```\n                v = [R.zero()]*right + [R.one()]\n```\n\nwith `R` being the base ring.  It just takes a long time to create a non-sparse polynomial of this size.",
    "created_at": "2015-05-30T09:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247968",
    "user": "https://trac.sagemath.org/admin/accounts/users/fwclarke"
}
```

I think it does use the code.  But what's happening is that in the line

```
                return self.subs({x:x**(q*p)}) * self**r
```

`x**(q*p)` is taking (almost) all the time.  And this comes from the section of the code dealing with powers of the polynomial generator, in particular the line

```
            return self.parent()(v, check=False)
```

where `v` is defined in the previous line as

```
                v = [R.zero()]*right + [R.one()]
```

with `R` being the base ring.  It just takes a long time to create a non-sparse polynomial of this size.



---

archive/issue_comments_247969.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-01T09:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247969",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247970.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-01T09:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247971.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...\n\nRight, because my doctest was wrong: The code is intended for sparse polynomials. I have not really been able yet to determine what is precisely going on for dense polynomial. Though, as indicated by [comment:6 fwclarke] and mentioned in my note 2. in the description, there is another problem for dense polynomial, namely that creating a large polynomial over a finite field takes a very long time. It is not the purpose of this ticket to correct this, even though it should be corrected!\n\nThis patch thus improves the situation for *sparse polynomials only*. The code is indeed not used for dense polynomials over `Zmod(k)` for any `k` since specific code appears in `src/sage/rings/polynomial/polynomial_template.pxi` for this case.\n\n**Important note:** I forgot to test whether the base ring is a field, which is of course mandatory. I correct this mistake in my latest commit.",
    "created_at": "2015-06-01T09:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247971",
    "user": "https://github.com/bgrenet"
}
```

Replying to [comment:5 jdemeyer]:
> I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...

Right, because my doctest was wrong: The code is intended for sparse polynomials. I have not really been able yet to determine what is precisely going on for dense polynomial. Though, as indicated by [comment:6 fwclarke] and mentioned in my note 2. in the description, there is another problem for dense polynomial, namely that creating a large polynomial over a finite field takes a very long time. It is not the purpose of this ticket to correct this, even though it should be corrected!

This patch thus improves the situation for *sparse polynomials only*. The code is indeed not used for dense polynomials over `Zmod(k)` for any `k` since specific code appears in `src/sage/rings/polynomial/polynomial_template.pxi` for this case.

**Important note:** I forgot to test whether the base ring is a field, which is of course mandatory. I correct this mistake in my latest commit.



---

archive/issue_comments_247972.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-01T09:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247972",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_247973.json:
```json
{
    "body": "You added 3 cases here:\n\n```\nif self.parent().base_ring().is_finite():\n    return ...\nif self.parent().is_sparse():\n    ...\nelse:\n    ...\n```\n\nYou should add a doctest for each of these 3 cases (and perhaps replace the second `if` by `elif` for clarity).",
    "created_at": "2015-06-01T11:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247973",
    "user": "https://github.com/jdemeyer"
}
```

You added 3 cases here:

```
if self.parent().base_ring().is_finite():
    return ...
if self.parent().is_sparse():
    ...
else:
    ...
```

You should add a doctest for each of these 3 cases (and perhaps replace the second `if` by `elif` for clarity).



---

archive/issue_comments_247974.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-01T11:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247974",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_247975.json:
```json
{
    "body": "Replying to [comment:9 bruno]:\n> **Important note:** I forgot to test whether the base ring is a field, which is of course mandatory.\nWhy is this \"of course\" mandatory? You need that the characteristic is a prime number, not that the base ring is a field.",
    "created_at": "2015-06-01T11:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247975",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 bruno]:
> **Important note:** I forgot to test whether the base ring is a field, which is of course mandatory.
Why is this "of course" mandatory? You need that the characteristic is a prime number, not that the base ring is a field.



---

archive/issue_comments_247976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-01T16:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247977.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-01T16:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247977",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_247978.json:
```json
{
    "body": "The algorithm I proposed was completely wrong: If `p` is the characteristic and `n=p * q + r`, I used the **wrong** identity `f(x)^n = f(x^{p*q}) * f(x)^r` instead of the correct `f(x)^n = f(x<sup>p)</sup>q * f(x)^r`. \n\nIn the commit, I correct this mistake, and in the same time I take [comment:10 jdemeyer]'s comments into account:\n- I add doctests for the different possibilities. (Note that I wrote code for the case where the base ring is a finite field and the polynomials are in dense representation, though as I wrote [comment:9 above] this code is not used since there is specific code in `polynomial_template.pxi`. Thus there is no doctest for this case.)\n- \"Of course\", it is not \"of course mandatory\" for the base ring to be a finite field...\n\nFurthermore, I improve the code not using `self.subs(...)`, but rather doing the computations myself.",
    "created_at": "2015-06-01T16:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247978",
    "user": "https://github.com/bgrenet"
}
```

The algorithm I proposed was completely wrong: If `p` is the characteristic and `n=p * q + r`, I used the **wrong** identity `f(x)^n = f(x^{p*q}) * f(x)^r` instead of the correct `f(x)^n = f(x<sup>p)</sup>q * f(x)^r`. 

In the commit, I correct this mistake, and in the same time I take [comment:10 jdemeyer]'s comments into account:
- I add doctests for the different possibilities. (Note that I wrote code for the case where the base ring is a finite field and the polynomials are in dense representation, though as I wrote [comment:9 above] this code is not used since there is specific code in `polynomial_template.pxi`. Thus there is no doctest for this case.)
- "Of course", it is not "of course mandatory" for the base ring to be a finite field...

Furthermore, I improve the code not using `self.subs(...)`, but rather doing the computations myself.



---

archive/issue_comments_247979.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-28T20:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247979",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_247980.json:
```json
{
    "body": "There should be an empty line after\n\n```\nCheck that the algorithm used is indeed correct::\n```\n",
    "created_at": "2015-08-28T20:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247980",
    "user": "https://github.com/fchapoton"
}
```

There should be an empty line after

```
Check that the algorithm used is indeed correct::
```




---

archive/issue_comments_247981.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-29T08:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247981",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247982.json:
```json
{
    "body": "Replying to [comment:14 chapoton]:\n> There should be an empty line after\n> {{{\n> Check that the algorithm used is indeed correct::\n> }}}\n\nDone!",
    "created_at": "2015-08-29T08:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247982",
    "user": "https://github.com/bgrenet"
}
```

Replying to [comment:14 chapoton]:
> There should be an empty line after
> {{{
> Check that the algorithm used is indeed correct::
> }}}

Done!



---

archive/issue_comments_247983.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-29T08:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247983",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_247984.json:
```json
{
    "body": "I think this test is much too weak:\n\n```\nsage: R.<x> = PolynomialRing(GF(17), sparse=True)\nsage: for d in [17, 264, 516]:\n....: assert((1+x)^d == generic_power(1+x,d))\n```\n\n\n(but I'll wait to suggest a better test until I understand the code better).",
    "created_at": "2015-08-30T11:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247984",
    "user": "https://github.com/jdemeyer"
}
```

I think this test is much too weak:

```
sage: R.<x> = PolynomialRing(GF(17), sparse=True)
sage: for d in [17, 264, 516]:
....: assert((1+x)^d == generic_power(1+x,d))
```


(but I'll wait to suggest a better test until I understand the code better).



---

archive/issue_events_052137.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-08-30T11:38:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "milestone": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18310#event-52137"
}
```



---

archive/issue_comments_247985.json:
```json
{
    "body": "Please justify in the code why\n\n```\n# characteristic 2 is special\n```\n",
    "created_at": "2015-08-30T11:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247985",
    "user": "https://github.com/jdemeyer"
}
```

Please justify in the code why

```
# characteristic 2 is special
```




---

archive/issue_comments_247986.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-30T11:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247986",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_247987.json:
```json
{
    "body": "I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.",
    "created_at": "2015-08-30T11:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247987",
    "user": "https://github.com/jdemeyer"
}
```

I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.



---

archive/issue_comments_247988.json:
```json
{
    "body": "And I'm not too happy with this either:\n\n```\nself.base_ring().is_field()\n```\n\n\nChecking whether some complicated ring is a field might be an expensive operation. I prefer\n\n```\nself.base_ring() in IntegralDomains\n```\n",
    "created_at": "2015-08-30T11:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247988",
    "user": "https://github.com/jdemeyer"
}
```

And I'm not too happy with this either:

```
self.base_ring().is_field()
```


Checking whether some complicated ring is a field might be an expensive operation. I prefer

```
self.base_ring() in IntegralDomains
```




---

archive/issue_comments_247989.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-31T12:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247990.json:
```json
{
    "body": "I didn't say you had to remove this:\n\n```\nif ... or p.is_prime()\n```\n",
    "created_at": "2015-08-31T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247990",
    "user": "https://github.com/jdemeyer"
}
```

I didn't say you had to remove this:

```
if ... or p.is_prime()
```




---

archive/issue_comments_247991.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Please justify in the code why\n> {{{\n> # characteristic 2 is special\n> }}}\nI had run some tests and my conclusion that was using `generic_power` was faster in characteristic 2. (Note that binary exponentiation is well suited to this characteristic.) I am not able to reproduce this behavior though, so I removed the special case.\n\nReplying to [comment:20 jdemeyer]:\n> And I'm not too happy with this either:\n> {{{\n> self.base_ring().is_field()\n> }}}\n> \n> Checking whether some complicated ring is a field might be an expensive operation. I prefer\n> {{{\n> self.base_ring() in IntegralDomains\n> }}}\n\nDone.\n\nReplying to [comment:19 jdemeyer]:\n> I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.\n\nActually, the current code is faster for finite fields. With the special case:\n\n```python\nsage: R.<x> = PolynomialRing(GF(17),sparse=True)\nsage: p = R.random_element(100)\nsage: %timeit p^(17^5)\nThe slowest run took 11.13 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 159 \u00b5s per loop\n```\n\n\nWithout the special case, with the same `p`:\n\n```python\n%timeit p^(17^5)\nThe slowest run took 26.59 times longer than the fastest. This could mean that an intermediate result is being cached \n1000 loops, best of 3: 249 \u00b5s per loop\n```\n\n\nI may refactor the code though so that it is less redundant. Tell me what you think.\n\nReplying to [comment:17 jdemeyer]:\n> I think this test is much too weak\nI am happy if you find a good way to test this function!",
    "created_at": "2015-08-31T13:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247991",
    "user": "https://github.com/bgrenet"
}
```

Replying to [comment:18 jdemeyer]:
> Please justify in the code why
> {{{
> # characteristic 2 is special
> }}}
I had run some tests and my conclusion that was using `generic_power` was faster in characteristic 2. (Note that binary exponentiation is well suited to this characteristic.) I am not able to reproduce this behavior though, so I removed the special case.

Replying to [comment:20 jdemeyer]:
> And I'm not too happy with this either:
> {{{
> self.base_ring().is_field()
> }}}
> 
> Checking whether some complicated ring is a field might be an expensive operation. I prefer
> {{{
> self.base_ring() in IntegralDomains
> }}}

Done.

Replying to [comment:19 jdemeyer]:
> I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.

Actually, the current code is faster for finite fields. With the special case:

```python
sage: R.<x> = PolynomialRing(GF(17),sparse=True)
sage: p = R.random_element(100)
sage: %timeit p^(17^5)
The slowest run took 11.13 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 159 µs per loop
```


Without the special case, with the same `p`:

```python
%timeit p^(17^5)
The slowest run took 26.59 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 249 µs per loop
```


I may refactor the code though so that it is less redundant. Tell me what you think.

Replying to [comment:17 jdemeyer]:
> I think this test is much too weak
I am happy if you find a good way to test this function!



---

archive/issue_comments_247992.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-31T13:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247993.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> I didn't say you had to remove this:\n> {{{\n> if ... or p.is_prime()\n> }}}\n\nRight, my mistake!",
    "created_at": "2015-08-31T13:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247993",
    "user": "https://github.com/bgrenet"
}
```

Replying to [comment:22 jdemeyer]:
> I didn't say you had to remove this:
> {{{
> if ... or p.is_prime()
> }}}

Right, my mistake!



---

archive/issue_comments_247994.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-31T13:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247994",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_247995.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-01T08:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247995",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_247996.json:
```json
{
    "body": "Replying to [comment:23 bruno]:\n> I am happy if you find a good way to test this function!\nYou have many cases and they should all be tested:\n\n```\nsage: R1 = PolynomialRing(GF(8, 'a'), 'x')\nsage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)\nsage: R3 = PolynomialRing(R2, 'y')\nsage: R4 = PolynomialRing(R1, 'y', sparse=True)\nsage: for d in range(40):  # long time\n....:     for R in [R1, R2, R3, R4]:\n....:         a = R.random_element()\n....:         assert a^d == generic_power(a, d)\n```\n",
    "created_at": "2015-09-01T08:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247996",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 bruno]:
> I am happy if you find a good way to test this function!
You have many cases and they should all be tested:

```
sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
sage: R3 = PolynomialRing(R2, 'y')
sage: R4 = PolynomialRing(R1, 'y', sparse=True)
sage: for d in range(40):  # long time
....:     for R in [R1, R2, R3, R4]:
....:         a = R.random_element()
....:         assert a^d == generic_power(a, d)
```




---

archive/issue_comments_247997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-01T13:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247997",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_247998.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> Replying to [comment:23 bruno]:\n> > I am happy if you find a good way to test this function!\n> You have many cases and they should all be tested:\n> {{{\n> sage: R1 = PolynomialRing(GF(8, 'a'), 'x')\n> sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)\n> sage: R3 = PolynomialRing(R2, 'y')\n> sage: R4 = PolynomialRing(R1, 'y', sparse=True)\n> sage: for d in range(40):  # long time\n> ....:     for R in [R1, R2, R3, R4]:\n> ....:         a = R.random_element()\n> ....:         assert a^d == generic_power(a, d)\n> }}}\n\nI introduced your proposed doctest, with the following change: Since I put a threshold `20` on the exponent before using the new code (for efficiency reasons), the loop is `for d in range(20,40)`.\n\nReplying to [comment:23 bruno]:\n> Replying to [comment:19 jdemeyer]:\n> > I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.\n>\n> Actually, the current code is faster for finite fields.\n\nActually, the code was not correct for non-prime finite fields... (The special case should have been for prime finite fields only.) So I finally followed your advice and removed the special case. In the same time, I refactored a bit the code.",
    "created_at": "2015-09-01T13:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247998",
    "user": "https://github.com/bgrenet"
}
```

Replying to [comment:26 jdemeyer]:
> Replying to [comment:23 bruno]:
> > I am happy if you find a good way to test this function!
> You have many cases and they should all be tested:
> {{{
> sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
> sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
> sage: R3 = PolynomialRing(R2, 'y')
> sage: R4 = PolynomialRing(R1, 'y', sparse=True)
> sage: for d in range(40):  # long time
> ....:     for R in [R1, R2, R3, R4]:
> ....:         a = R.random_element()
> ....:         assert a^d == generic_power(a, d)
> }}}

I introduced your proposed doctest, with the following change: Since I put a threshold `20` on the exponent before using the new code (for efficiency reasons), the loop is `for d in range(20,40)`.

Replying to [comment:23 bruno]:
> Replying to [comment:19 jdemeyer]:
> > I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.
>
> Actually, the current code is faster for finite fields.

Actually, the code was not correct for non-prime finite fields... (The special case should have been for prime finite fields only.) So I finally followed your advice and removed the special case. In the same time, I refactored a bit the code.



---

archive/issue_comments_247999.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-01T13:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-247999",
    "user": "https://github.com/bgrenet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_248000.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-07T12:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-248000",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_052138.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-07T21:34:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18310#event-52138"
}
```



---

archive/issue_comments_248001.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-07T21:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18310",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18310#issuecomment-248001",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
