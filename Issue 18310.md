# Issue 18310: Improve polynomial powering in positive characteristic

Issue created by migration from Trac.

Original creator: bruno

Original creation time: 2015-05-29 15:18:57

Keywords: polynomial, powering

Before:


```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
... (hangs for ever)
```


After:

```python
sage: R.<x> = PolynomialRing(GF(5), sparse=True)
sage: (1+x)^(5^10)
x^9765625 + 1
```


**Notes.**
1. I've tried to be careful with quite extensive tests not to slow down the computations for "easy" cases. This explains the threshold values in the code.
2. This is related to #7253 and #12660. Though, there is another problem for non-sparse polynomials: Simply assigning the value and printing the polynomial take a very long time. Compare the timings for
    {{{#!python
    sage: R.<x> = ZZ[]
    sage: 1+x<sup>5</sup>10
    x^9765625 + 1
    }}}
    and 
    {{{#!python
    sage: R.<x> = GF(5)[]
    sage: 1+x<sup>5</sup>10
    x^9765625 + 1
    }}}
    Thus for tickets #7253 and #12660 to be closed, it remains to handle this other problem, but this is not the purpose of this ticket.




---

Comment by git created at 2015-05-29 15:20:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-05-29 15:20:37

Changing status from new to needs_review.


---

Comment by git created at 2015-05-29 15:26:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-29 19:31:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-29 19:31:03

Your added doctest still takes `# long time` (28s on my computer). You should shorten the test to take less than 1s: `5^8` instead of `5^10` would be better.


---

Comment by jdemeyer created at 2015-05-29 19:38:19

I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...


---

Comment by fwclarke created at 2015-05-30 09:18:07

I think it does use the code.  But what's happening is that in the line

```
                return self.subs({x:x**(q*p)}) * self**r
```

`x**(q*p)` is taking (almost) all the time.  And this comes from the section of the code dealing with powers of the polynomial generator, in particular the line

```
            return self.parent()(v, check=False)
```

where `v` is defined in the previous line as

```
                v = [R.zero()]*right + [R.one()]
```

with `R` being the base ring.  It just takes a long time to create a non-sparse polynomial of this size.


---

Comment by git created at 2015-06-01 09:07:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-01 09:45:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-06-01 09:50:30

Replying to [comment:5 jdemeyer]:
> I don't get it, it seems that the doctest doesn't even use the new code. It's equally slow with or without this patch...

Right, because my doctest was wrong: The code is intended for sparse polynomials. I have not really been able yet to determine what is precisely going on for dense polynomial. Though, as indicated by [comment:6 fwclarke] and mentioned in my note 2. in the description, there is another problem for dense polynomial, namely that creating a large polynomial over a finite field takes a very long time. It is not the purpose of this ticket to correct this, even though it should be corrected!

This patch thus improves the situation for _sparse polynomials only_. The code is indeed not used for dense polynomials over `Zmod(k)` for any `k` since specific code appears in `src/sage/rings/polynomial/polynomial_template.pxi` for this case.

**Important note:** I forgot to test whether the base ring is a field, which is of course mandatory. I correct this mistake in my latest commit.


---

Comment by bruno created at 2015-06-01 09:50:30

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-01 11:39:50

You added 3 cases here:

```
if self.parent().base_ring().is_finite():
    return ...
if self.parent().is_sparse():
    ...
else:
    ...
```

You should add a doctest for each of these 3 cases (and perhaps replace the second `if` by `elif` for clarity).


---

Comment by jdemeyer created at 2015-06-01 11:39:50

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-01 11:44:02

Replying to [comment:9 bruno]:
> **Important note:** I forgot to test whether the base ring is a field, which is of course mandatory.
Why is this "of course" mandatory? You need that the characteristic is a prime number, not that the base ring is a field.


---

Comment by git created at 2015-06-01 16:02:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-06-01 16:12:25

Changing status from needs_work to needs_review.


---

Comment by bruno created at 2015-06-01 16:12:25

The algorithm I proposed was completely wrong: If `p` is the characteristic and `n=p * q + r`, I used the **wrong** identity `f(x)^n = f(x^{p*q}) * f(x)^r` instead of the correct `f(x)^n = f(x<sup>p)</sup>q * f(x)^r`. 

In the commit, I correct this mistake, and in the same time I take [comment:10 jdemeyer]'s comments into account:
- I add doctests for the different possibilities. (Note that I wrote code for the case where the base ring is a finite field and the polynomials are in dense representation, though as I wrote [comment:9 above] this code is not used since there is specific code in `polynomial_template.pxi`. Thus there is no doctest for this case.)
- "Of course", it is not "of course mandatory" for the base ring to be a finite field...

Furthermore, I improve the code not using `self.subs(...)`, but rather doing the computations myself.


---

Comment by chapoton created at 2015-08-28 20:07:09

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-08-28 20:07:09

There should be an empty line after

```
Check that the algorithm used is indeed correct::
```



---

Comment by git created at 2015-08-29 08:55:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-08-29 08:56:34

Replying to [comment:14 chapoton]:
> There should be an empty line after
> {{{
> Check that the algorithm used is indeed correct::
> }}}

Done!


---

Comment by bruno created at 2015-08-29 08:56:34

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-08-30 11:37:38

I think this test is much too weak:

```
sage: R.<x> = PolynomialRing(GF(17), sparse=True)
sage: for d in [17, 264, 516]:
....: assert((1+x)^d == generic_power(1+x,d))
```


(but I'll wait to suggest a better test until I understand the code better).


---

Comment by jdemeyer created at 2015-08-30 11:38:15

Please justify in the code why

```
# characteristic 2 is special
```



---

Comment by jdemeyer created at 2015-08-30 11:38:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-08-30 11:41:54

I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.


---

Comment by jdemeyer created at 2015-08-30 11:47:58

And I'm not too happy with this either:

```
self.base_ring().is_field()
```


Checking whether some complicated ring is a field might be an expensive operation. I prefer

```
self.base_ring() in IntegralDomains
```



---

Comment by git created at 2015-08-31 12:55:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-08-31 13:01:30

I didn't say you had to remove this:

```
if ... or p.is_prime()
```



---

Comment by bruno created at 2015-08-31 13:04:18

Replying to [comment:18 jdemeyer]:
> Please justify in the code why
> {{{
> # characteristic 2 is special
> }}}
I had run some tests and my conclusion that was using `generic_power` was faster in characteristic 2. (Note that binary exponentiation is well suited to this characteristic.) I am not able to reproduce this behavior though, so I removed the special case.

Replying to [comment:20 jdemeyer]:
> And I'm not too happy with this either:
> {{{
> self.base_ring().is_field()
> }}}
> 
> Checking whether some complicated ring is a field might be an expensive operation. I prefer
> {{{
> self.base_ring() in IntegralDomains
> }}}

Done.

Replying to [comment:19 jdemeyer]:
> I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.

Actually, the current code is faster for finite fields. With the special case:

```python
sage: R.<x> = PolynomialRing(GF(17),sparse=True)
sage: p = R.random_element(100)
sage: %timeit p^(17^5)
The slowest run took 11.13 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 159 µs per loop
```


Without the special case, with the same `p`:

```python
%timeit p^(17^5)
The slowest run took 26.59 times longer than the fastest. This could mean that an intermediate result is being cached 
1000 loops, best of 3: 249 µs per loop
```


I may refactor the code though so that it is less redundant. Tell me what you think.

Replying to [comment:17 jdemeyer]:
> I think this test is much too weak
I am happy if you find a good way to test this function!


---

Comment by git created at 2015-08-31 13:06:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-08-31 13:06:48

Replying to [comment:22 jdemeyer]:
> I didn't say you had to remove this:
> {{{
> if ... or p.is_prime()
> }}}

Right, my mistake!


---

Comment by bruno created at 2015-08-31 13:06:48

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-01 08:19:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-09-01 08:19:19

Replying to [comment:23 bruno]:
> I am happy if you find a good way to test this function!
You have many cases and they should all be tested:

```
sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
sage: R3 = PolynomialRing(R2, 'y')
sage: R4 = PolynomialRing(R1, 'y', sparse=True)
sage: for d in range(40):  # long time
....:     for R in [R1, R2, R3, R4]:
....:         a = R.random_element()
....:         assert a^d == generic_power(a, d)
```



---

Comment by git created at 2015-09-01 13:38:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-09-01 13:43:35

Replying to [comment:26 jdemeyer]:
> Replying to [comment:23 bruno]:
> > I am happy if you find a good way to test this function!
> You have many cases and they should all be tested:
> {{{
> sage: R1 = PolynomialRing(GF(8, 'a'), 'x')
> sage: R2 = PolynomialRing(GF(9, 'b'), 'x', sparse=True)
> sage: R3 = PolynomialRing(R2, 'y')
> sage: R4 = PolynomialRing(R1, 'y', sparse=True)
> sage: for d in range(40):  # long time
> ....:     for R in [R1, R2, R3, R4]:
> ....:         a = R.random_element()
> ....:         assert a^d == generic_power(a, d)
> }}}

I introduced your proposed doctest, with the following change: Since I put a threshold `20` on the exponent before using the new code (for efficiency reasons), the loop is `for d in range(20,40)`.

Replying to [comment:23 bruno]:
> Replying to [comment:19 jdemeyer]:
> > I suggest to remove the special case for finite fields. The generic code should work just fine for finite fields.
>
> Actually, the current code is faster for finite fields.

Actually, the code was not correct for non-prime finite fields... (The special case should have been for prime finite fields only.) So I finally followed your advice and removed the special case. In the same time, I refactored a bit the code.


---

Comment by bruno created at 2015-09-01 13:43:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-07 12:40:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-07 21:34:55

Resolution: fixed
