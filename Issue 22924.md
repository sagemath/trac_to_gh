# Issue 22924: Wrong zlib library might be loaded in sage-rst2txt

Issue created by migration from https://trac.sagemath.org/ticket/23161

Original creator: jdemeyer

Original creation time: 2017-06-07 15:04:34

CC:  embray vbraun fbissey

The script `sage-rst2txt` suffers from the same issue as #23122.


---

Comment by jdemeyer created at 2017-06-07 15:12:52

New commits:


---

Comment by jdemeyer created at 2017-06-07 15:12:52

Changing status from new to needs_review.


---

Comment by kcrisman created at 2017-06-08 14:48:02

How would one test that this is fixed?   It does look identical to the fix in the previous ticket.


---

Comment by vbraun created at 2017-06-11 09:39:09

A better solution would probably be to fix the Python linking, there is something wrong with Jeroen's binaries that I can't reproduce. The `_ssl.so` module should have an RPATH set and this will come first in the library resolution order even for transitive dependencies...


---

Comment by jdemeyer created at 2017-06-14 08:39:11

In case it helps:

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x14d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
 0x000000000000000c (INIT)               0x71d8
 0x000000000000000d (FINI)               0xf6f0
 0x0000000000000019 (INIT_ARRAY)         0x214d48
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x214d50
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x1c8
 0x0000000000000005 (STRTAB)             0x18d0
 0x0000000000000006 (SYMTAB)             0x208
 0x000000000000000a (STRSZ)              4539 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000003 (PLTGOT)             0x215000
 0x0000000000000002 (PLTRELSZ)           5256 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0x5d50
 0x0000000000000007 (RELA)               0x2cd8
 0x0000000000000008 (RELASZ)             12408 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x2c78
 0x000000006fffffff (VERNEEDNUM)         2
 0x000000006ffffff0 (VERSYM)             0x2a8c
 0x000000006ffffff9 (RELACOUNT)          499
 0x0000000000000000 (NULL)               0x0
```



---

Comment by vbraun created at 2017-06-14 19:13:32

The dependency on libz is not direct, but via libpython and libssl. The difference between our systems seems to be that I'm using RPATH any you use RUNPATH.

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x13d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [/home/vbraun/Code/sage.git/local/lib]
[...]
```

The difference is of course that the executableâ€™s RUNPATH is not used for finding indirect library dependencies: http://blog.qt.io/blog/2011/10/28/rpath-and-runpath/

In an ideal world we'd either 
* ship all our dependencies (including openssl) without holes in the dependency chain, or 
* let you link against the same libs as openssl (and not build our own libz).

The best course of action is probably to add `-Wl,--disable-new-dtags` to our LDFLAGS when compiling Sage, that would ensure that our zlib wins.


---

Comment by fbissey created at 2017-06-14 21:41:18

Very interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.


---

Comment by fbissey created at 2017-06-15 00:07:29

Replying to [comment:7 fbissey]:
> Very interesting blog post. Cleared a few things up for me. I am fairly sure Jeroen uses Gentoo and that it default to `-Wl,--enable-new-dtags` by default. So disabling that is an easy option.

That would be a gnu ld setting, so valid for linux but not OS X. Don't know for freeBSD or cygwin.


---

Comment by vbraun created at 2017-06-17 13:51:15

Jeroen, does that fix it for you?
----
New commits:


---

Comment by jdemeyer created at 2017-06-19 08:36:45

Hmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...

Now (without this patch), I get

```
$ readelf -d local/lib/python2.7/lib-dynload/_ssl.so

Dynamic section at offset 0x14d60 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
 0x000000000000000c (INIT)               0x71d8
 0x000000000000000d (FINI)               0xf6f0
 0x0000000000000019 (INIT_ARRAY)         0x214d48
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x214d50
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x1c8
 0x0000000000000005 (STRTAB)             0x18d0
 0x0000000000000006 (SYMTAB)             0x208
 0x000000000000000a (STRSZ)              4539 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000003 (PLTGOT)             0x215000
 0x0000000000000002 (PLTRELSZ)           5256 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0x5d50
 0x0000000000000007 (RELA)               0x2cd8
 0x0000000000000008 (RELASZ)             12408 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffffe (VERNEED)            0x2c78
 0x000000006fffffff (VERNEEDNUM)         2
 0x000000006ffffff0 (VERSYM)             0x2a8c
 0x000000006ffffff9 (RELACOUNT)          499
 0x0000000000000000 (NULL)               0x0
```



---

Comment by fbissey created at 2017-06-19 08:58:28

Replying to [comment:11 jdemeyer]:
> Hmm, for some reason I cannot reproduce the problem anymore. There must be some non-deterministic aspect...
> 
> Now (without this patch), I get
> {{{
> $ readelf -d local/lib/python2.7/lib-dynload/_ssl.so
> 
> Dynamic section at offset 0x14d60 contains 29 entries:
>   Tag        Type                         Name/Value
>  0x0000000000000001 (NEEDED)             Shared library: [libssl.so.1.0.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libcrypto.so.1.0.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
>  0x000000000000001d (RUNPATH)            Library runpath: [/usr/local/src/sage-config/local/lib]
>  0x000000000000000c (INIT)               0x71d8
>  0x000000000000000d (FINI)               0xf6f0
>  0x0000000000000019 (INIT_ARRAY)         0x214d48
>  0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
>  0x000000000000001a (FINI_ARRAY)         0x214d50
>  0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
>  0x000000006ffffef5 (GNU_HASH)           0x1c8
>  0x0000000000000005 (STRTAB)             0x18d0
>  0x0000000000000006 (SYMTAB)             0x208
>  0x000000000000000a (STRSZ)              4539 (bytes)
>  0x000000000000000b (SYMENT)             24 (bytes)
>  0x0000000000000003 (PLTGOT)             0x215000
>  0x0000000000000002 (PLTRELSZ)           5256 (bytes)
>  0x0000000000000014 (PLTREL)             RELA
>  0x0000000000000017 (JMPREL)             0x5d50
>  0x0000000000000007 (RELA)               0x2cd8
>  0x0000000000000008 (RELASZ)             12408 (bytes)
>  0x0000000000000009 (RELAENT)            24 (bytes)
>  0x000000006ffffffe (VERNEED)            0x2c78
>  0x000000006fffffff (VERNEEDNUM)         2
>  0x000000006ffffff0 (VERSYM)             0x2a8c
>  0x000000006ffffff9 (RELACOUNT)          499
>  0x0000000000000000 (NULL)               0x0
> }}}
Which looks very much the same as before. Would you happen to have upgraded the system zlib on your box? 1.2.11 is the only version available in Gentoo now and you wouldn't get the message if the version on the system is the same as in sage.


---

Comment by jdemeyer created at 2017-06-19 10:06:00

Replying to [comment:12 fbissey]:
> Would you happen to have upgraded the system zlib on your box?

No, I did not. My system has `zlib-1.2.8-r1`.


---

Comment by vbraun created at 2017-06-20 10:52:40

It depends on which transitive dependency is pulled first, so it may very well be random.


---

Comment by fbissey created at 2017-06-28 02:25:21

After looking up some more stuff as part of discussion we are also having regarding gf2x upcoming release, stuff on freeBSD and other libtool matters. I now think disabling `disable-new-dtags` may actually bring more harm than good.

Without it `DT_RUNPATH` is not present in the elf file. Just `DT_RPATH`, which means that `DT_RPATH` has priority look up over `LD_LIBRARY_PATH`. That doesn't seem to be a problem until you realise how libtool wraps binaries to be able run the `make check` target with `LD_LIBRARY_PATH` (or equivalent) to make sure you use the version of the library in the build tree. 

Of course sage's spkg install before testing, which is a bit goofy but that's another argument, so it may not feel relevant. But we are dealing with stuff that is a bit more complicated like `gf2x`'s tuning. For `gf2x`'s tuning to work, you actually need to use a version of the library that you haven't installed yet. In that context, unless you remove the old `gf2x` first, you cannot re-run the install of `gf2x` properly. That's probably the only case for standard packages, Dima would have mentioned any other one on the freeBSD support ticket (basically this branch would enable the current behavior observed on freeBSD).


---

Comment by vbraun created at 2017-06-28 19:58:16

E.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.

IMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?


---

Comment by fbissey created at 2017-06-28 21:17:11

Replying to [comment:16 vbraun]:
> E.g. Fedora defaults to `disable-new-dtags` so it has to work; The only question is whether or not we want to support both.
> 

It does work. And you'll get correct results on the first install.

> IMHO gf2x is just unnecessarily playing it on hard mode; Shared libraries with the same version number are supposed to be interchangeable. Why use shared libraries for tuning?

Well they are technically interchangeable, they expose the same API, they just have different internals during tuning to find the best internals. You are right, using static libraries would solve the problem, but you would probably have to rethink the way it is built and tuned.
Like I said you, will have the correct result on first install, on subsequent installs or upgrade you will have to remove the old installed library to get the correct tuning.

I won't oppose the change if you, Jeroen and Erik think it is the way to go. But I think having the conversation and understanding some of the implications was necessary.


---

Comment by jdemeyer created at 2017-07-06 10:26:04

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2017-07-06 10:26:04

I can no longer reproduce this, so I'm downgrading the priority.


---

Comment by jdemeyer created at 2017-08-31 08:53:36

Resolution: worksforme
