# Issue 15434: sig_error() without sig_on()

Issue created by migration from Trac.

Original creator: zimmerma

Original creation time: 2014-01-13 21:21:48

with Sage 6.0 and the following program:

```
def search(p):
   R = RealField(p)
   m = 2^(2*p)+2^(p+1)-1
   l = []
   for a in range(2^p):
      for b in range(2^p):
         for e in range(2):
            l.append(a*b*2^e)
   l = uniq(l)
   l.sort()
   n = len(l)
   i = j = 0
   while i < n and l[i]-l[j] < m:
      i += 1
   sol = 0
   while i < n:
      if l[i]-l[j]==m:
         sol += 1
      j += 1
      while i < n and l[i]-l[j] < m:
         i += 1
   print "sol=", sol
```

I get:

```
sage: search(15)
sig_error() without sig_on()
------------------------------------------------------------------------
------------------------------------------------------------------------
Attaching gdb to process id 404.
```



---

Comment by pbruin created at 2014-01-13 22:22:26

The problem seems to lie in `sage/rings/integer.pyx:fast_tp_new()`, where the call to `mpz_alloc()` is not surrounded by `sig_on()...sig_off()`.  This should be fixed, but it probably won't help in this specific example, because Sage runs hopelessly out of memory.  I tried it twice with the `sig_on()...sig_off()` added, and Sage still crashes, just not with the same error message; once it was killed by IPython with a `MemoryError`, once by Sage's `c_lib/src/interrupt.c:sigdie()`, presumably because another out of memory error occurs during signal handling.


---

Comment by jdemeyer created at 2014-01-14 10:52:53

That `mpz_alloc()` allocated very little memory (8 bytes on a 64-bit system). If allocating even 8 bytes fails, you are going to run into trouble anyway.


---

Comment by pbruin created at 2014-01-15 17:05:16

Here is the fix, not to actually solve any memory problems, just to increase the probability that the user gets a somewhat informative error message.


---

Comment by pbruin created at 2014-01-15 17:05:16

Changing status from new to needs_review.


---

Comment by zimmerma created at 2014-01-15 17:18:54

Peter, your fix looks good to me, however if a complete run of doctests is needed, I won't have time in the near future.

Paul


---

Comment by pbruin created at 2014-05-09 17:17:44

Curiously, this innocent-looking fix causes three doctests to fail with a `SystemError`, see the [patchbot report](http://patchbot.sagemath.org/log/15671/debian/wheezy/sid/x86_64/3.2.0-57-generic/selmer/2014-05-09%2018:21:24%20+0100?short):

```
sage -t --long src/sage/structure/parent.pyx  # 1 doctest failed
sage -t --long src/sage/rings/integer.pyx  # 1 doctest failed
sage -t --long src/sage/rings/polynomial/polynomial_real_mpfr_dense.pyx  # 1 doctest failed
```



---

Comment by pbruin created at 2014-05-09 17:17:51

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-08-18 22:40:28

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-08-18 23:13:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-11-27 23:05:06

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2014-11-27 23:05:06

Merge conflict because of #16910, which replaced the `mpz_alloc()` in question by `sage_malloc()`.

I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.  First try:

```
sage: search(15)
sig_error() without sig_on()

Program received signal SIGABRT, Aborted.
0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007ffff74560d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007ffff745983b in abort () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007fffeb373082 in sig_error () from /home/bruinpj/src/sage/local/lib/libcsage.so
#3  0x00007fffeb373171 in alloc_error () from /home/bruinpj/src/sage/local/lib/libcsage.so
#4  0x00007fffeb3731f8 in sage_gmp_realloc () from /home/bruinpj/src/sage/local/lib/libcsage.so
#5  0x00007fffeb124f21 in __gmpz_realloc (m=0x1b48dfc0, new_alloc=2) at realloc.c:33
#6  0x00007fffeb121e70 in __gmpz_mul_si (prod=0x1b48dfc0, mult=0x1b48df50, small_mult=2445144) at mul_i.h:67
#7  0x00007fffe35185b2 in __pyx_f_4sage_5rings_7integer_7Integer__mul_long (__pyx_v_self=0x1b48df30, __pyx_v_n=2445144) at build/cythonized/sage/rings/integer.c:12409
#8  0x00007fffe73c4c73 in __pyx_pf_4sage_9structure_7element_11RingElement_10__mul__ (__pyx_v_right=<sage.rings.integer.Integer at remote 0x1b48df30>, __pyx_v_left=
    2445144) at build/cythonized/sage/structure/element.c:16796
...
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
```

Second try:

```
sage: search(15)

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
(gdb) bt
#0  0x00007ffff756a1e7 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007fffe3512bc5 in __pyx_f_4sage_5rings_7integer_fast_tp_new (__pyx_v_t=<optimized out>, __pyx_v_a=<optimized out>, __pyx_v_k=<optimized out>)
    at /usr/include/x86_64-linux-gnu/bits/string3.h:52
#2  0x00007fffe3532684 in __pyx_pf_4sage_5rings_7integer_7Integer_72__pow__ (__pyx_v_self=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, __pyx_v_n=1,
    __pyx_v_modulus=<optimized out>) at build/cythonized/sage/rings/integer.c:13906
#3  0x00007ffff7a43832 in ternary_op (v=<sage.rings.integer.Integer at remote 0x7fffbc5a7ab0>, w=1, z=None, op_slot=48, op_name=<optimized out>)
    at Objects/abstract.c:1065
...
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
```



---

Comment by jdemeyer created at 2014-11-28 06:09:36

Replying to [comment:13 pbruin]:
> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors.
This is to be expected, see [comment:2].


---

Comment by jdemeyer created at 2014-11-28 06:19:12

Replying to [comment:13 pbruin]:
> I tried running the example again (with `ulimit -v 2000000` to keep memory usage within reasonable bounds) and got different errors
Sorry, I understand what you mean. You get 2 different errors which are also different from the error that was initially reported.


---

Comment by jdemeyer created at 2014-11-28 06:25:09

We should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).


---

Comment by jdemeyer created at 2014-11-28 06:28:37

Proposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.


---

Comment by pbruin created at 2014-11-28 06:58:09

Replying to [comment:16 jdemeyer]:
> We should indeed put `sig_on()`/`sig_off()` in many more places, but I'm afraid people will worry about the performance impact (there is a very small but still measurable slow-down with `sig_on()`).
Indeed, it seems that at least in the first run we explicitly do not use `sig_on()`:

```python
cdef ModuleElement _mul_long(self, long n):
    """
    Fast path for multiplying a C long.
    ...
    """
    cdef Integer x = <Integer>PY_NEW(Integer)
    if mpz_size(self.value) > 100000:
        sig_on()
        mpz_mul_si(x.value, self.value, n)
        sig_off()
    else:
        mpz_mul_si(x.value, self.value, n)
    return x
```


In the second one, `fast_tp_new()` does not check the result of an allocation:

```python

    new = PyObject_MALLOC( sizeof_Integer )
    ...
    memcpy(new, (<void*>global_dummy_Integer), sizeof_Integer )
```

The signal happens in `memcpy()`; I guess `PyObject_MALLOC()` returned `NULL`.

(Both fragments are from `integer.pyx`.)


---

Comment by pbruin created at 2015-05-06 19:49:38

Replying to [comment:17 jdemeyer]:
> Proposal: introduce new Sage functions `sage_malloc_check()` which raises `MemoryError` when the allocation failed and use that to fix this issue.
Now that you introduced `check_malloc()` in #10257 (merged in 6.6.beta1), could we use that function here?  In `fast_tp_new()`, we could presumably at least replace the `sage_malloc()` that allocates `new.value` by `check_malloc()`; what about the `PyObject_Malloc()` that allocates `new` itself?


---

Comment by git created at 2015-05-06 21:00:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-06 21:01:02

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2015-05-06 21:53:00

The new commit makes a few more changes (hopefully improvements) to memory error handling in `integer.pyx`.


---

Comment by jdemeyer created at 2015-05-08 08:07:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-08 13:10:45

Resolution: fixed
