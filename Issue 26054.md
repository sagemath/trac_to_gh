# Issue 26054: Create a pool for ETuple

Issue created by migration from https://trac.sagemath.org/ticket/26291

Original creator: SimonKing

Original creation time: 2018-09-15 10:27:24

CC:  tscrim

Keywords: pool ETuple

Working on #26243, I found that one can get a substantial speed-up by implementing a pool for ETuple (so that memory allocation and deallocation occurs less often).

I chose the component "memleak", because my first attempt at implementing a pool has a memory leak...


---

Comment by SimonKing created at 2018-09-15 10:37:17

Ouch, I am so sorry! For some reasons, I got the timings wrong and though that the pool gives a speed-up. But it doesn't.

Please close this as invalid.
----
Last 10 new commits:


---

Comment by SimonKing created at 2018-09-15 10:37:17

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-09-15 10:37:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-11-08 16:17:54

I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...


---

Comment by embray created at 2018-11-08 16:17:54

Changing status from positive_review to needs_info.


---

Comment by SimonKing created at 2018-11-08 20:32:19

Replying to [comment:4 embray]:
> I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...

Actually I do not clearly recall how I did that. My original motivation came from the computation of Hilbert series in cases in which Singular couldn't give an answer and other available packages in Sage sucked. So, I guess I was timing the Hilbert series computation (which in fact heavily uses ETuple).

Another possibility is to create polynomials in the generic implementation, i.e., NOT using libsingular but instead using `MPolynomial_polydict`, and test the time for arithmetic operations, as they rely on ETuple operations, too.


---

Comment by embray created at 2018-11-09 13:06:05

I put your branch back on the ticket just for the sake of inspection.  Maybe this doesn't need to be high priority or anything, but I'm sure you are right that there are opportunity for gains here; the question is in the details.
----
New commits:


---

Comment by embray created at 2018-11-09 13:14:58

I forget _precisely_ why this is, but I believe that in Cython code you lose most any advantage of using a custom `fast_tp_new` if you don't use `PY_NEW(ETuple)` to get a new instance, as it goes directly through `ETuple.tp_new`; otherwise Cython adds some kind of overhead to the call.


---

Comment by SimonKing created at 2018-12-04 08:57:06

There is a merge conflict with the current "develop" branch. So, first I'll try to fix the merge conflict.


---

Comment by SimonKing created at 2018-12-04 09:00:57

One rather silly conflicts is this:

In "develop"

```
# ****************************************************************************
#       Copyright (C) 2005 William Stein <wstein@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  https://www.gnu.org/licenses/
# ****************************************************************************
```

In this branch:

```
#****************************************************************************
#       Copyright (C) 2005 William Stein <wstein@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  https://www.gnu.org/licenses/
#****************************************************************************
```


What do people prefer? Having a blank space after `#` or not?


---

Comment by SimonKing created at 2018-12-04 09:30:56

In several other places I find the preamble without space after `#`. So, I'll remove it from develop.


---

Comment by SimonKing created at 2018-12-04 09:35:09

According to git blame, the blank space was introduced in #26279. Erik, would you be OK with removing the space?


---

Comment by tscrim created at 2018-12-06 05:04:54

My guess is that it was probably done by Frédéric to more strictly conform to PEP8. I would probably keep things as they are to avoid as many trivial changes as possible, but that is just my 2 cents.


---

Comment by git created at 2018-12-08 09:10:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2018-12-08 09:23:21

Changing status from needs_info to needs_review.


---

Comment by SimonKing created at 2018-12-08 09:23:21

I have rebased the old branch on top of the current develop branch. Also, I changed all remaining `for i from 0<=i<whatever` to `for i in range(whatever)`.

Here are timings. For test, I am using this:

```
sage: from sage.rings.polynomial.polydict import ETuple
sage: cython("""
....: from sage.rings.polynomial.polydict cimport ETuple
....: from sage.all import get_memory_usage
....: def test_new(ETuple T):
....:     cdef int i
....:     for i in range(10000):
....:         T = T._new()
....: def test_addmin(ETuple T):
....:     cdef int i
....:     for i in range(10000):
....:         T = T.emin(T.eadd(T))
....: """)
sage: T = ETuple(range(20))
```

Timing with `develop`:

```
sage: %timeit test_new(T)
1000 loops, best of 3: 299 µs per loop
sage: %timeit test_addmin(T)
100 loops, best of 3: 2.98 ms per loop
```

Timing with the branch from here:

```
sage: %timeit test_new(T)
10000 loops, best of 3: 71.7 µs per loop
sage: %timeit test_addmin(T)
100 loops, best of 3: 2.96 ms per loop
```


So, the time for creating new instance has indeed improved. However, it also becomes clear that the creation of a new tuple (which occurs both in `.eadd()` and `.emin()`) is negligible compared with what else is to be done.

Therefore, I believe that having an ETuple pool is not a real improvement after all. But I let this up to the reviewer: If you think that the improvement isn't worth the effort, then review this as "invalid/won't fix". If you think "why not?", then we can of course keep working on it.


---

Comment by jdemeyer created at 2018-12-09 19:54:48

Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.


---

Comment by SimonKing created at 2018-12-09 19:56:23

Replying to [comment:15 jdemeyer]:
> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.

I guess that's because I am unaware of a ready-to-be-plugged-in Cython implementation.


---

Comment by SimonKing created at 2018-12-09 22:31:47

Replying to [comment:15 jdemeyer]:
> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.

Actually I am not fully deallocating the tuple data in `tp_dealloc`! I only dealloc the tuple data if the pool is full and thus every data has to go to oblivion. But if an ETuple is parked in the pool, then the tuple data is in fact kept. If later the ETuple is revived, the tuple data is not allocated but reallocated during `__init__` (which typically should be faster than a full deallocation followed by an allocation).

So, I guess ``@`cython.freelist(1000)` won't be equivalent.
