# Issue 20233: Conversion of sparse to dense matrices over F2 is unspeakably slow

Issue created by migration from Trac.

Original creator: kedlaya

Original creation time: 2016-04-19 19:46:54

Keywords: sparse matrices, dense matrices

Converting a sparse matrix to a dense one should be an easy operation: create the zero matrix and then populate a few entries. But behold:

```
sage: time S = CremonaModularSymbols(400001, sign=+1)
CPU times: user 15 s, sys: 36 ms, total: 15 s
Wall time: 15 s
sage: time T2 = S.hecke_matrix(2) # This matrix has <= 3 nonzero entries per row
CPU times: user 11.6 s, sys: 4.19 s, total: 15.8 s
Wall time: 15.8 s
sage: time sT2 = T2.sage_matrix_over_ZZ()
CPU times: user 1.56 s, sys: 1e+03 Âµs, total: 1.56 s
Wall time: 1.56 s
sage: time sT2F2 = sT2.change_ring(GF(2))
sage: time sT2F2 = sT2.change_ring(GF(2))
CPU times: user 979 ms, sys: 8 ms, total: 987 ms
Wall time: 987 ms
sage: sT2F2
38098 x 38098 sparse matrix over Finite Field of size 2 (use the '.str()' method to see the entries)
sage: M2 = MatrixSpace(GF(2), 38098, sparse=False)
sage: time sT2F2a = M2(sT2F2) #unspeakably slow!
CPU times: user 19min 43s, sys: 47.2 s, total: 20min 30s
Wall time: 20min 31s
```

Presumably this is an artifact of the constructor, as internal operations are much faster:

```
sage: time sT2F2a.rank()
CPU times: user 14.4 s, sys: 63 ms, total: 14.5 s
Wall time: 14.5 s
38098
```

By contrast, staying in the sparse realm has a price which I think is at most only partly related (see https://groups.google.com/forum/#!topic/sage-devel/l1O82XMC0zo for another contributing factor):

```
sage: time sT2F2.rank()
CPU times: user 24min 54s, sys: 544 ms, total: 24min 55s
Wall time: 24min 56s
38098
```



---

Comment by jhpalmieri created at 2016-04-19 20:50:55

How much time does

```
time sT2F2a = sT2F2.dense_matrix()
```

take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)


---

Comment by kedlaya created at 2016-04-19 20:56:05

Replying to [comment:1 jhpalmieri]:
> How much time does
> {{{
> time sT2F2a = sT2F2.dense_matrix()
> }}}
> take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)

That is indeed much faster:

```
sage: time sT2F2b = sT2F2.dense_matrix()
CPU times: user 318 ms, sys: 47 ms, total: 365 ms
Wall time: 365 ms
sage: sT2F2a == sT2F2b
True
```


I guess that means this is easy to fix: the constructor for dense matrices (over any base), upon receiving a sparse matrix as input, should simply call the `dense_matrix()` method.


---

Comment by jhpalmieri created at 2016-04-19 23:05:35

I think the culprit is the `matrix` method for the `MatrixSpace` class: when you do `M2(...)`, it runs the `__call__` method, which does this:

```
        return self.matrix(entries, coerce, copy)
```

Then the `matrix` method does this, if the input `x` is a matrix with the right size:

```
x = x.list()  # this is the slow part
...
x = list_to_dict(x, m, n)
```

So it should instead call `dense_matrix`.


---

Comment by jhpalmieri created at 2016-04-19 23:06:40

New commits:


---

Comment by jhpalmieri created at 2016-04-19 23:06:40

Changing status from new to needs_review.


---

Comment by kedlaya created at 2016-04-20 00:19:39

Patchbot throws up a weird error but I can't tell whether it's meaningful.

More seriously, is there a good way to doctest this?


---

Comment by jhpalmieri created at 2016-04-20 02:53:21

I think I've seen those patchbot errors on other tickets. I don't think they are related. Also, I thought about doctests, but since this is supposed to be a speed upgrade which does not change functionality, I couldn't come up with anything.


---

Comment by tscrim created at 2016-04-20 04:29:17

You could add a doctest that took a long time prior (e.g., a few seconds) but now is quite quick (less than half a second).


---

Comment by git created at 2016-04-20 15:19:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2016-04-20 15:36:07

Okay, good idea, here is a doctest.


---

Comment by kedlaya created at 2016-04-20 18:13:53

Changing status from needs_review to positive_review.


---

Comment by kedlaya created at 2016-04-20 18:13:53

I'm not sure what the deal is with patchbot, but on my machine this passes all doctests. Positive review.


---

Comment by vbraun created at 2016-04-22 07:13:02

Resolution: fixed
