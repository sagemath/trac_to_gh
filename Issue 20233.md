# Issue 20233: Conversion of sparse to dense matrices over F2 is unspeakably slow

archive/issues_020233.json:
```json
{
    "body": "Keywords: sparse matrices, dense matrices\n\nConverting a sparse matrix to a dense one should be an easy operation: create the zero matrix and then populate a few entries. But behold:\n\n```\nsage: time S = CremonaModularSymbols(400001, sign=+1)\nCPU times: user 15 s, sys: 36 ms, total: 15 s\nWall time: 15 s\nsage: time T2 = S.hecke_matrix(2) # This matrix has <= 3 nonzero entries per row\nCPU times: user 11.6 s, sys: 4.19 s, total: 15.8 s\nWall time: 15.8 s\nsage: time sT2 = T2.sage_matrix_over_ZZ()\nCPU times: user 1.56 s, sys: 1e+03 \u00b5s, total: 1.56 s\nWall time: 1.56 s\nsage: time sT2F2 = sT2.change_ring(GF(2))\nsage: time sT2F2 = sT2.change_ring(GF(2))\nCPU times: user 979 ms, sys: 8 ms, total: 987 ms\nWall time: 987 ms\nsage: sT2F2\n38098 x 38098 sparse matrix over Finite Field of size 2 (use the '.str()' method to see the entries)\nsage: M2 = MatrixSpace(GF(2), 38098, sparse=False)\nsage: time sT2F2a = M2(sT2F2) #unspeakably slow!\nCPU times: user 19min 43s, sys: 47.2 s, total: 20min 30s\nWall time: 20min 31s\n```\n\nPresumably this is an artifact of the constructor, as internal operations are much faster:\n\n```\nsage: time sT2F2a.rank()\nCPU times: user 14.4 s, sys: 63 ms, total: 14.5 s\nWall time: 14.5 s\n38098\n```\n\nBy contrast, staying in the sparse realm has a price which I think is at most only partly related (see https://groups.google.com/forum/#!topic/sage-devel/l1O82XMC0zo for another contributing factor):\n\n```\nsage: time sT2F2.rank()\nCPU times: user 24min 54s, sys: 544 ms, total: 24min 55s\nWall time: 24min 56s\n38098\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20470\n\n",
    "created_at": "2016-04-19T19:46:54Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Conversion of sparse to dense matrices over F2 is unspeakably slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20233",
    "user": "https://github.com/kedlaya"
}
```
Keywords: sparse matrices, dense matrices

Converting a sparse matrix to a dense one should be an easy operation: create the zero matrix and then populate a few entries. But behold:

```
sage: time S = CremonaModularSymbols(400001, sign=+1)
CPU times: user 15 s, sys: 36 ms, total: 15 s
Wall time: 15 s
sage: time T2 = S.hecke_matrix(2) # This matrix has <= 3 nonzero entries per row
CPU times: user 11.6 s, sys: 4.19 s, total: 15.8 s
Wall time: 15.8 s
sage: time sT2 = T2.sage_matrix_over_ZZ()
CPU times: user 1.56 s, sys: 1e+03 Âµs, total: 1.56 s
Wall time: 1.56 s
sage: time sT2F2 = sT2.change_ring(GF(2))
sage: time sT2F2 = sT2.change_ring(GF(2))
CPU times: user 979 ms, sys: 8 ms, total: 987 ms
Wall time: 987 ms
sage: sT2F2
38098 x 38098 sparse matrix over Finite Field of size 2 (use the '.str()' method to see the entries)
sage: M2 = MatrixSpace(GF(2), 38098, sparse=False)
sage: time sT2F2a = M2(sT2F2) #unspeakably slow!
CPU times: user 19min 43s, sys: 47.2 s, total: 20min 30s
Wall time: 20min 31s
```

Presumably this is an artifact of the constructor, as internal operations are much faster:

```
sage: time sT2F2a.rank()
CPU times: user 14.4 s, sys: 63 ms, total: 14.5 s
Wall time: 14.5 s
38098
```

By contrast, staying in the sparse realm has a price which I think is at most only partly related (see https://groups.google.com/forum/#!topic/sage-devel/l1O82XMC0zo for another contributing factor):

```
sage: time sT2F2.rank()
CPU times: user 24min 54s, sys: 544 ms, total: 24min 55s
Wall time: 24min 56s
38098
```


Issue created by migration from https://trac.sagemath.org/ticket/20470





---

archive/issue_comments_278481.json:
```json
{
    "body": "How much time does\n\n```\ntime sT2F2a = sT2F2.dense_matrix()\n```\n\ntake? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)",
    "created_at": "2016-04-19T20:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278481",
    "user": "https://github.com/jhpalmieri"
}
```

How much time does

```
time sT2F2a = sT2F2.dense_matrix()
```

take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)



---

archive/issue_comments_278482.json:
```json
{
    "body": "Replying to [comment:1 jhpalmieri]:\n> How much time does\n> {{{\n> time sT2F2a = sT2F2.dense_matrix()\n> }}}\n> take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)\n\nThat is indeed much faster:\n\n```\nsage: time sT2F2b = sT2F2.dense_matrix()\nCPU times: user 318 ms, sys: 47 ms, total: 365 ms\nWall time: 365 ms\nsage: sT2F2a == sT2F2b\nTrue\n```\n\n\nI guess that means this is easy to fix: the constructor for dense matrices (over any base), upon receiving a sparse matrix as input, should simply call the `dense_matrix()` method.",
    "created_at": "2016-04-19T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278482",
    "user": "https://github.com/kedlaya"
}
```

Replying to [comment:1 jhpalmieri]:
> How much time does
> {{{
> time sT2F2a = sT2F2.dense_matrix()
> }}}
> take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)

That is indeed much faster:

```
sage: time sT2F2b = sT2F2.dense_matrix()
CPU times: user 318 ms, sys: 47 ms, total: 365 ms
Wall time: 365 ms
sage: sT2F2a == sT2F2b
True
```


I guess that means this is easy to fix: the constructor for dense matrices (over any base), upon receiving a sparse matrix as input, should simply call the `dense_matrix()` method.



---

archive/issue_comments_278483.json:
```json
{
    "body": "I think the culprit is the `matrix` method for the `MatrixSpace` class: when you do `M2(...)`, it runs the `__call__` method, which does this:\n\n```\n        return self.matrix(entries, coerce, copy)\n```\n\nThen the `matrix` method does this, if the input `x` is a matrix with the right size:\n\n```\nx = x.list()  # this is the slow part\n...\nx = list_to_dict(x, m, n)\n```\n\nSo it should instead call `dense_matrix`.",
    "created_at": "2016-04-19T23:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278483",
    "user": "https://github.com/jhpalmieri"
}
```

I think the culprit is the `matrix` method for the `MatrixSpace` class: when you do `M2(...)`, it runs the `__call__` method, which does this:

```
        return self.matrix(entries, coerce, copy)
```

Then the `matrix` method does this, if the input `x` is a matrix with the right size:

```
x = x.list()  # this is the slow part
...
x = list_to_dict(x, m, n)
```

So it should instead call `dense_matrix`.



---

archive/issue_comments_278484.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278484",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_278485.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278485",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278486.json:
```json
{
    "body": "Patchbot throws up a weird error but I can't tell whether it's meaningful.\n\nMore seriously, is there a good way to doctest this?",
    "created_at": "2016-04-20T00:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278486",
    "user": "https://github.com/kedlaya"
}
```

Patchbot throws up a weird error but I can't tell whether it's meaningful.

More seriously, is there a good way to doctest this?



---

archive/issue_comments_278487.json:
```json
{
    "body": "I think I've seen those patchbot errors on other tickets. I don't think they are related. Also, I thought about doctests, but since this is supposed to be a speed upgrade which does not change functionality, I couldn't come up with anything.",
    "created_at": "2016-04-20T02:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278487",
    "user": "https://github.com/jhpalmieri"
}
```

I think I've seen those patchbot errors on other tickets. I don't think they are related. Also, I thought about doctests, but since this is supposed to be a speed upgrade which does not change functionality, I couldn't come up with anything.



---

archive/issue_comments_278488.json:
```json
{
    "body": "You could add a doctest that took a long time prior (e.g., a few seconds) but now is quite quick (less than half a second).",
    "created_at": "2016-04-20T04:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278488",
    "user": "https://github.com/tscrim"
}
```

You could add a doctest that took a long time prior (e.g., a few seconds) but now is quite quick (less than half a second).



---

archive/issue_comments_278489.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-20T15:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278489",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278490.json:
```json
{
    "body": "Okay, good idea, here is a doctest.",
    "created_at": "2016-04-20T15:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278490",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, good idea, here is a doctest.



---

archive/issue_comments_278491.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-20T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278491",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_278492.json:
```json
{
    "body": "I'm not sure what the deal is with patchbot, but on my machine this passes all doctests. Positive review.",
    "created_at": "2016-04-20T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278492",
    "user": "https://github.com/kedlaya"
}
```

I'm not sure what the deal is with patchbot, but on my machine this passes all doctests. Positive review.



---

archive/issue_comments_278493.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-22T07:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20233#issuecomment-278493",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_019215.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-22T07:13:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20233",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20233#event-19215"
}
```
