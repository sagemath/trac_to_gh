# Issue 27367: Topcom and Python 3

Issue created by migration from https://trac.sagemath.org/ticket/27604

Original creator: jhpalmieri

Original creation time: 2019-04-05 01:24:44

CC:  fbissey

With Python 3 and the `topcom` package installed:

```
sage: PointConfiguration.set_engine('internal')
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-1-ff863e4c078c> in <module>()
----> 1 PointConfiguration.set_engine('internal')

/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.8.beta0/local/lib/python3.6/site-packages/sage/geometry/triangulation/point_configuration.py in set_engine(cls, engine)
    394             raise ValueError('Unknown value for "engine": '+str(engine))
    395 
--> 396         have_TOPCOM = PointConfiguration._have_TOPCOM()
    397         PointConfiguration._use_TOPCOM = \
    398             (engine == 'topcom') or (engine == 'auto' and have_TOPCOM)

/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.8.beta0/local/lib/python3.6/site-packages/sage/geometry/triangulation/point_configuration.py in _have_TOPCOM(cls)
    287         try:
    288             out = next(PointConfiguration._TOPCOM_exec('points2placingtriang',
--> 289                                                   '[[0,1],[1,1]]', verbose=False))
    290             PointConfiguration._have_TOPCOM_cached = True
    291             assert out=='{{0,1}}',\

/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.8.beta0/local/lib/python3.6/site-packages/sage/geometry/triangulation/point_configuration.py in _TOPCOM_exec(cls, executable, input_string, verbose)
    628         proc.expect(r'\.\.\. done\.')
    629         proc.setecho(0)
--> 630         assert proc.readline().strip() == ''
    631 
    632         if verbose:

AssertionError: 
```

`proc.readline().strip()` actually equals `b''`, so we should compare to that instead. There is another similar string comparison that needs fixing.


---

Comment by jhpalmieri created at 2019-04-05 01:26:36

This should be tested with `topcom` and without, and with both Python 2 and Python 3.


---

Comment by jhpalmieri created at 2019-04-05 01:26:36

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-04-05 01:27:01

New commits:


---

Comment by fbissey created at 2019-04-05 01:29:58

Seems to be working with python2 and 3 for me. And with and without `topcom` as well. I will do a test run build of the documentation with that patch before putting it in positive review.


---

Comment by fbissey created at 2019-04-05 01:52:00

Oh well, that made progress compared to my initial report of documentation mot building

```
Error building the documentation.
multiprocessing.pool.RemoteTraceback: 
"""
Traceback (most recent call last):
  File "/usr/lib64/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/lib64/python3.6/multiprocessing/pool.py", line 44, in mapstar
    return list(map(*args))
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/sage_setup/docbuild/__init__.py", line 761, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/sage_setup/docbuild/__init__.py", line 133, in f
    runsphinx()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
    sys.stderr.raise_errors()
  File "/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
    raise OSError(self._error)
OSError: /dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/lib/sage/geometry/triangulation/point_configuration.py:docstring of sage.geometry.triangulation.point_configuration:107: WARNING: Exception occurred in plotting point_configuration-2
"""
```

We made progress from `point_configuration-1` to `point_configuration-2`.


---

Comment by git created at 2019-04-05 01:53:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-04-05 01:54:06

Sorry, I hadn't fully tested before, just made sure that the command in the ticket description worked. Please try this new version.


---

Comment by jhpalmieri created at 2019-04-05 01:56:00

For me, with topcom + Python 3, all tests pass in `geometry/triangulation`.


---

Comment by fbissey created at 2019-04-05 01:56:26

As soon as I am home after picking up the kids from school. You removed one of the `b`?


---

Comment by jhpalmieri created at 2019-04-05 02:12:24

Yes, and instead made sure that the function that returned topcom's output returned a string, not `bytes`, by using `line = line.decode()`. Then the other functions which use that output can continue to use strings rather than `b'...'` when doing things like `triangulation = line[ line.find('{{')+2 : line.rfind('}}') ]`.


---

Comment by fbissey created at 2019-04-05 03:36:50

Solves my issue.


---

Comment by fbissey created at 2019-04-05 03:36:50

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-04-05 14:36:58

Author fullname please


---

Comment by vbraun created at 2019-04-07 15:15:35

Resolution: fixed
