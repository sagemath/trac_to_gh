# Issue 31052: Mark documentation builder as parallel_read_safe

Issue created by migration from https://trac.sagemath.org/ticket/31289

Original creator: @tobiasdiez

Original creation time: 2021-01-25 11:40:17

CC:  dimpase jhpalmieri slabbe slelievre

According to https://www.sphinx-doc.org/en/master/extdev/index.html#extension-metadata on should specify parallel_read_safe if the builder is able to read source files in parallel.
> 'parallel_read_safe': a boolean that specifies if parallel reading of source files can be used when the extension is loaded. It defaults to False, i.e. you have to explicitly specify your extension to be parallel-read-safe after checking that it is.

This is done in this ticket. I didn't had any problems with it, but I'm also not completely sure the builders are indeed able to read source files in parallel.


---

Comment by @tobiasdiez created at 2021-01-25 11:40:24

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-01-25 22:17:19

Is there a reason for doing this? It didn't speed up docbuilding for me. Why change from the default setting?


---

Comment by @tobiasdiez created at 2021-01-25 22:22:23

You have to run `sphinx-build -jNUM` for this to be activated. This ticket is a first step to use this during sage's docbuild. My aim was actually to already implement this as part of this ticket, but I don't have the time right now.


---

Comment by jhpalmieri created at 2021-01-25 22:40:16

We have our homemade parallel docbuilding already. Are you hoping to replace that? I tried adding "-j6" to the sphinx-build command with this change:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index b07e9c100c..71973f683b 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -121,7 +121,7 @@ def builder_helper(type):
         else:
             options += ' -D multidoc_first_pass=1'
 
-        build_command = '-b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
+        build_command = '-j6 -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
                                                   options, self.dir,
                                                   output_dir)
         logger.debug(build_command)
```

but it didn't speed things up.


---

Comment by jhpalmieri created at 2021-01-25 22:43:21

This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see

   For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.


---

Comment by jhpalmieri created at 2021-01-25 22:49:54

Replying to [comment:5 jhpalmieri]:
> This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see
> 
>    For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.

On second thought, this may not be related, although `./sage --docbuild ...` is much slower on my Mac than `make doc` is, probably because of this issue.


---

Comment by @tobiasdiez created at 2021-01-28 16:21:34

> We have our homemade parallel docbuilding already. Are you hoping to replace that?

That was my initial path. I had some problems with the current code, and thought maybe it's simpler to use sphinx built-in parallel mechanism anyway. But then the problems disappeared again, and I moved on to work on other things. That's why this ticket is only a very minimal step in this direction. But I guess it doesn't hurt to have it, although currently it does not change anything.


---

Comment by dimpase created at 2021-01-29 13:51:20

I think we should at some point replace our custom docbuilder with what's provided by Sphinxn -- as it's a hack no current Sage dev fully understands, and is thus very hard to maintain. 

It would be great to have a ticket where the task to do this replacement is set out in steps.


---

Comment by dimpase created at 2021-01-29 13:52:45

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2021-01-29 16:48:43

Thanks!


---

Comment by vbraun created at 2021-03-14 15:03:23

Resolution: fixed
