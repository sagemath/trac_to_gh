# Issue 28958: do not lazy-import sagenb on python3

Issue created by migration from https://trac.sagemath.org/ticket/29195

Original creator: dimpase

Original creation time: 2020-02-14 09:25:36

CC:  chapoton embray mkoeppe

currently, with py3 sage, 

```
sage: notebook()
```

results in an import error.

This is because sagenb is still lazy-imported in 
`src/sage/all.py`. This lazy import should be made conditional on python version.




---

Comment by dimpase created at 2020-02-14 09:27:26

Changing priority from major to minor.


---

Comment by jhpalmieri created at 2020-02-14 21:43:25

Something like this?

```diff
diff --git a/src/sage/all.py b/src/sage/all.py
index 97f01b4005..70021c91bd 100644
--- a/src/sage/all.py
+++ b/src/sage/all.py
@@ -206,14 +206,17 @@ from sage.manifolds.all import *
 
 from cysignals.alarm import alarm, cancel_alarm
 
-# Lazily import notebook functions and interacts (#15335)
-lazy_import('sagenb.notebook.notebook_object', 'notebook')
-lazy_import('sagenb.notebook.notebook_object', 'inotebook')
-lazy_import('sagenb.notebook.sage_email', 'email')
-lazy_import('sage.interacts.debugger', 'debug')
-lazy_import('sage.interacts', 'all', 'interacts')
-# interact decorator from SageNB (will be overridden by Jupyter)
-lazy_import('sagenb.notebook.interact', 'interact')
+from six import PY2
+if PY2:
+    # Lazily import notebook functions and interacts (#15335)
+    lazy_import('sagenb.notebook.notebook_object', 'notebook')
+    lazy_import('sagenb.notebook.notebook_object', 'inotebook')
+    lazy_import('sagenb.notebook.sage_email', 'email')
+    lazy_import('sage.interacts.debugger', 'debug')
+    lazy_import('sage.interacts', 'all', 'interacts')
+    # interact decorator from SageNB (will be overridden by Jupyter)
+    lazy_import('sagenb.notebook.interact', 'interact')
+del PY2
 
 from copy import copy, deepcopy
 
```



---

Comment by dimpase created at 2020-02-14 21:49:01

well, I trust you that `six.PY2` is exactly what's needed. What's that `del PY2` for?
Why not just `if six.PY2:`, without `import` and `del`?


---

Comment by jhpalmieri created at 2020-02-14 21:59:33

If I use `if six.PY2` without any import statement, I see this when starting Sage:

```
NameError: name 'six' is not defined
```

So then of course `del PY2` is there so that `PY2` is not defined when `all.py` is imported when Sage starts up.

`six.PY2`: ["A boolean indicating if the code is running on Python 2"](https://six.readthedocs.io/#six.PY2)


---

Comment by dimpase created at 2020-02-14 22:33:25


```
$ grep -R "import six" src/sage/ | wc -l
102
```


why not just put `import six` in `all.py`?


---

Comment by dimpase created at 2020-02-14 22:39:07

also:

```
$ grep -R "PY2" src/sage/ | wc -l
58
$ grep -R "six\.PY2" src/sage/ | wc -l
30
```

so it seems that `six.PY2` is a bit more popular :-)


---

Comment by jhpalmieri created at 2020-02-15 00:48:03

Everything in `all.py` is executed when Sage starts, so if I put `import six` there, then `six` is available from the command-line. The current state of affairs:

```
sage: six
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
<ipython-input-1-cfa698ef8823> in <module>()
----> 1 six

NameError: name 'six' is not defined
```

With `import six` in `all.py`:

```
sage: six
<module 'six' from '/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.1.beta4/local/lib/python3.7/site-packages/six.py'>
```

We should not add any extra imports without good reason.

In random files in the Sage library, not everything is imported, so you can do `import six` and `six.PY2` without running into these problems. `all.py` is special.


---

Comment by dimpase created at 2020-02-15 10:04:10

`all.py` imports   `os` and `sys`, even though it may be argued against having them there by exactly the same argument as for `six`.


---

Comment by dimpase created at 2020-02-15 10:08:56

I think if we can remove several hundreds (count all of `import six` and `from six`, it is over 700 total) of imports from the library without causing problems, then we should do it.


---

Comment by jhpalmieri created at 2020-02-15 16:12:45

How do you propose doing that? If `file.py` imports six and `all.py` imports `file`, then adding an import to `all` won’t help with `file`, will it?


---

Comment by jhpalmieri created at 2020-02-15 16:14:37

Anyway, I’m going to be away from my computer for a week, so I won’t be working on this.


---

Comment by dimpase created at 2020-02-15 23:48:39

New commits:


---

Comment by chapoton created at 2020-02-16 07:22:38

We have already started to remove all calls to six. This lazy import of sagenb should just be removed.


---

Comment by dimpase created at 2020-02-16 08:27:22

Replying to [comment:13 chapoton]:
> We have already started to remove all calls to six. This lazy import of sagenb should just be removed.

I must say I missed this. I thought the coming release is still going to be py2-compatible. Could you point me out the corresponding tickets?


---

Comment by chapoton created at 2020-02-16 10:11:22

So far, we are removing six when possible so that it does not break (but may slow) the python 2 version of sage.

See for example

af348cfc28 Trac #29103: get rid of part of itervalues

5abdaf4583 Trac #29077: get rid of six.iterkeys


---

Comment by dimpase created at 2020-02-16 10:15:21

do you propose to remove sagenb, or just the lazy import?


---

Comment by chapoton created at 2020-02-16 10:17:43

well, does removing just the lazy import breaks some doctests ? (in py2 and py3) ?

My opinion is that people cannot reasonably both ask to use the latest sage, python2 and the legacy notebook.


---

Comment by dimpase created at 2020-02-16 10:21:35

Replying to [comment:17 chapoton]:
> well, does removing just the lazy import breaks some doctests ? (in py2 and py3) ?
> 
> My opinion is that people cannot reasonably both ask to use the latest sage, python2 and the legacy notebook.

If there is a dependency/doctest on py3 that needs any of sagenb then it is a bug.

Any tickets on this?


---

Comment by dimpase created at 2020-02-16 12:49:40

what's "broken" if sagenb is not (lazy) imported is sage.interacts - but this is as expected, it appears nothing in sage.interacts works without sagenb, despite some vague comments about Jupyter.


---

Comment by dimpase created at 2020-02-16 15:21:07

I don't understand how the tests in `src/sage/interacts/library.py` work on py3, without a functioning sagenb (but with these lazy imports present).

I get errors there on this branch.


---

Comment by chapoton created at 2020-02-16 18:25:12

I would suggest to just remove the lines starting with

```
lazy_import('sagenb
```



---

Comment by dimpase created at 2020-02-16 20:00:58

Replying to [comment:21 chapoton]:
> I would suggest to just remove the lines starting with
> {{{
> lazy_import('sagenb
> }}}

this, as well as the branch on the ticket, causes doctest errors in sage.interacts.library, no?


---

Comment by chapoton created at 2020-02-17 09:16:18


```diff
diff --git a/src/sage/all.py b/src/sage/all.py
index 97f01b4005..80ac1d8372 100644
--- a/src/sage/all.py
+++ b/src/sage/all.py
@@ -207,13 +207,13 @@ from sage.manifolds.all import *
 from cysignals.alarm import alarm, cancel_alarm
 
 # Lazily import notebook functions and interacts (#15335)
-lazy_import('sagenb.notebook.notebook_object', 'notebook')
-lazy_import('sagenb.notebook.notebook_object', 'inotebook')
-lazy_import('sagenb.notebook.sage_email', 'email')
+#lazy_import('sagenb.notebook.notebook_object', 'notebook')
+#lazy_import('sagenb.notebook.notebook_object', 'inotebook')
+#lazy_import('sagenb.notebook.sage_email', 'email')
 lazy_import('sage.interacts.debugger', 'debug')
 lazy_import('sage.interacts', 'all', 'interacts')
 # interact decorator from SageNB (will be overridden by Jupyter)
-lazy_import('sagenb.notebook.interact', 'interact')
+#lazy_import('sagenb.notebook.interact', 'interact')
 
 from copy import copy, deepcopy
```


does not break any doctest in interacts (under py3).


---

Comment by chapoton created at 2020-02-17 20:43:25

Here is a branch. Launching my bot on it.
----
New commits:


---

Comment by kcrisman created at 2020-02-17 21:33:57

But `sage -notebook` will (eventually) launch Jupyter, correct?  We are just removing the possibility of launching a notebook from within a Sage session here - I guess it's not possible to do that with Jupyter, or so I recall.

This business of interact depending on sagenb is tricky.  Not having interactive stuff in Jupyter is a real regression; I constantly use Sage cell server instances (and sometimes still Sage notebook) with interacts, and of course CoCalc has them.


---

Comment by dimpase created at 2020-02-19 20:27:09

`grep -R "notebook()" src/doc/`
returns few hits, they need to be sorted out.


---

Comment by dimpase created at 2020-02-19 20:27:09

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-02-19 20:44:38

Indeed, here is the list

```
sage3$ git grep -c "notebook()" src/
src/doc/de/tutorial/interactive_shell.rst:4
src/doc/en/faq/faq-usage.rst:1
src/doc/en/installation/source.rst:1
src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/introduction.rst:1
src/doc/en/tutorial/interactive_shell.rst:4
src/doc/fr/tutorial/interactive_shell.rst:4
src/doc/ja/tutorial/interactive_shell.rst:4
src/doc/pt/tutorial/interactive_shell.rst:4
src/doc/ru/tutorial/interactive_shell.rst:4
src/mac-app/sage-README-macOS.txt:1
src/sage/interfaces/sage0.py:2
```



---

Comment by git created at 2020-02-19 21:33:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-19 21:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-19 21:58:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-02-19 22:09:15

In `src/doc/*/tutorial/interactive_shell.rst`, 3 out of 4 appearences of `notebook()` are just in Sage banners, so that's trivial to fix without knowning the language. The 4th is harder, and I did it in English, German, and Russian. I haven't touched French, Portugese, and Japanese files.


---

Comment by git created at 2020-02-19 22:29:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-20 10:16:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-02-22 21:05:39

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-02-22 21:05:39

we can fix the more exotic languages later.


---

Comment by vbraun created at 2020-02-23 16:51:28

Resolution: fixed
