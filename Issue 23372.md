# Issue 23372: Random failure in ell_rational_field.py

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-08-11 10:46:49

CC:  cremona was spice

Keywords: random_fail

I see this happen sometimes:

```
sage -t src/sage/schemes/elliptic_curves/ell_rational_field.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_rational_field.py", line 3972, in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.cremona_label
Failed example:
    E.cremona_label()
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: Cremona label not known for Elliptic Curve defined by y^2 + y = x^3 - 79*x + 342 over Rational Field.
Got:
    '19047851a1'
**********************************************************************
```

I am guessing that this is happening because the curve in question is in the database of curves with large rank (rank 5 in this case). It seems that the Cremona labels of those curves are known. If the curve from the doctest happens to be in memory, the Cremona label is therefore known.

The solution is simple: use a different curve in that doctest, which is not used anywhere else.


---

Comment by cremona created at 2017-08-11 11:07:10

No -- Cremona labels only exist for curves of conductor < 400000.  So what is wrong is the code which claims to know it.
Both the Cremona and LMFDB labels are only determined when all elliptic curves of that conductor are known, since they depend on sorting that complete list.


---

Comment by jdemeyer created at 2017-08-11 12:07:19

Replying to [comment:1 cremona]:
> No -- Cremona labels only exist for curves of conductor < 400000.  So what is wrong is the code which claims to know it.

Interesting. So you are saying that this is wrong:

```
sage: E = elliptic_curves.rank(5)[0]
sage: E
Elliptic Curve defined by y^2 + y = x^3 - 79*x + 342 over Rational Field
sage: E.cremona_label()
'19047851a1'
```


I know nothing about the definition of the Cremona labels, so I have no idea if they are easy to compute for a given curve.


---

Comment by cremona created at 2017-08-11 13:02:50

See http://www.lmfdb.org/knowledge/show/ec.q.cremona_label .
These labels are assigned when I find a curve, based on certain principles.  The first part is the conductor, no problem as that's a positive integer (represented as a decimal string!).  The second part tells you which isogeny class it is among all curves of that conductor, expressed as an integer in base 26 (starting at 0) and represented using a-z as digits 0-26.  (So it goes a,b,c,...,z,ba,bb,...).  To know this you need to know all the isogeny classes and how they are sorted.  For smaller conductors the sorting was basically random; for a while now it is deterministic (and matches that used for LMFDB labels).  It's lexicographical ordering of the sequence of coefficients of the L-function (or of the attached modular form).  The last part is a number between 1 and 8 telling you the index of the curve in its isogeny class, based on a sorting scheme (different for Cremona and LMFDB labels).

The first and last parts are easy, what is hard is the middle part.  But if you don't know all the curves of a given conductor (as we don't for most conductors >400000) then you don't know the label, and tagging 'a1' onto the conductor is only a placeholder.

The LMFDB is coming up with a way to extend these labels to situations like this, but it has not yet been implemented.

Meanwhile I think the correct output in your example would be to raise an error saying "Cremona label for ... does not exist" or "Cremona labales only exist for elliptic curves of conductor up to 400000".  I am not currently planning to extend that database; if I did I would update the Sage package database_cremona_ellcurve accordingly.  If it were not an optional package you could make this bound of 400000 dynamic:

```
sage: CremonaDatabase().largest_conductor()
399998
```

but that would say 9999 I think if the optional package is not installed.  (In case you are still reading and are wondering, there happen to be no elliptic curves with conductor 399999 or 400000.)


---

Comment by cremona created at 2017-08-11 13:17:54

On the question of why

```
sage: E = elliptic_curves.rank(5)[0]
sage: E.cremona_label()
'19047851a1'
```

does not raise an error now:  These high rank curves a read in from text files in sage/local/share/ellcurves.  I did not create these: they were extended fairly recently by William's student Simon Spicer.  It looks to me as if all curves which our outside my range have " a 1" in those files, and these are set in the rank() function in sage/schemes/elliptic_curves/ec_database.py.  So a correct fix would be in that file where it does `E._set_cremona_label(label)`, make that conditional on the conductor.  I think there labels are correct when conductor is < 400000 but did not check very carefully.


---

Comment by jdemeyer created at 2017-08-11 14:17:12

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-08-11 14:17:12

New commits:


---

Comment by cremona created at 2017-08-11 14:26:39

OK, under review.


---

Comment by jdemeyer created at 2017-08-11 14:33:14

Replying to [comment:5 cremona]:
> I think there labels are correct when conductor is < 400000 but did not check very carefully.

The `rank3` file ends with

```
119744 i 1 [0,1,0,-7489,246975] 3 1
119744 j 1 [0,1,0,95,159] 3 1
119822 a 1 [1,0,1,-144,650] 3 1
119859 b 1 [0,1,1,-212,1202] 3 1
119888 a 1 [0,0,0,-8699,252426] 3 1
```

so it seems to go up to 120000 and the labels seem correct.

The complete `rank4` file is

```
234446 a 1 [1,-1,0,-79,289] 4 1
545723 a 1 [0,0,1,-7,36] 4 1
842596 a 1 [0,0,0,-169,841] 4 1
926584 a 1 [0,0,0,-127,610] 4 1
1099496 a 1 [0,0,0,-172,820] 4 1
1109716 a 1 [0,0,0,-64,169] 4 1
1129211 a 1 [0,0,1,-19,60] 4 1
1142158 a 1 [1,-1,0,-1,73] 4 1
1162928 a 1 [0,0,0,-259,2194] 4 1
1175648 a 1 [0,0,0,-316,2080] 4 1
```

Only the first curve has conductor <= 400000 and the label is correct.

For `rank5` and above, all conductors are > 400000.


---

Comment by git created at 2017-08-11 15:01:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-08-11 15:12:31

I had never seen LookupError or literal_eval before -- nice.
I did not spot your typo but can you change the docstring of `database_attributes()` since it says that it might return a RuntimError and now it's a LookupError?


---

Comment by cremona created at 2017-08-11 15:14:37

Thanks for checking those labels by the way


---

Comment by jdemeyer created at 2017-08-15 10:23:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-15 10:38:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-08-15 10:48:20

Rebased and fixed the documentation.


---

Comment by jdemeyer created at 2017-08-15 10:48:20

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2017-08-15 10:52:55

If you tell me that all your did was fix thet docstring issue (and rebase) I'll give you a positive review for free.


---

Comment by jdemeyer created at 2017-08-15 11:19:10

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-08-15 11:19:10

Replying to [comment:17 cremona]:
> If you tell me that all your did was fix thet docstring issue (and rebase) I'll give you a positive review for free.

Well, that and rebasing (there was a conflict in 8.1.beta2).


---

Comment by cremona created at 2017-08-15 11:24:50

OK!


---

Comment by vbraun created at 2017-08-17 20:33:23

Resolution: fixed
