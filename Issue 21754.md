# Issue 21754: Problems with RealLazyField

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2016-11-29 15:21:37

As I was working with quadratic fields I encountered #21979 that might have been caused by `RealLazyField` related problems. Namely

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0
```



---

Comment by mmezzarobba created at 2016-12-02 13:17:55

I don't think the bug is in `RLF`:

```
sage: RealIntervalField(100)(u)
0
sage: RealIntervalField(100)(u).is_exact()
True
```



---

Comment by vdelecroix created at 2016-12-02 13:30:03

Replying to [comment:1 mmezzarobba]:
> I don't think the bug is in `RLF`:
> {{{
> sage: RealIntervalField(100)(u)
> 0
> sage: RealIntervalField(100)(u).is_exact()
> True
> }}}

I don't understand. This is fixed in #21979 mentioned in the description and which is merged in beta5

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: RealIntervalField(100)(u)
0.?e-9
sage: RealIntervalField(100)(u).is_exact()
False
```



---

Comment by mmezzarobba created at 2016-12-02 13:46:33

Whoops, I tested with an older beta by accident. Sorry for the noise.


---

Comment by mmezzarobba created at 2016-12-02 14:46:56

The attached patch fixes the problem reported in this ticket. However, the reason the conversion worked in some cases in spite of the misnamed conversion method: namely, that `RealIntervalFieldElement.__init__()` has a code path that attempts conversions to `RealField`s with directed rounding. This is sort-of-okay (and used in sage...) in the case of an “atomic” floating-point evaluation (assuming the conversion code correctly takes the rounding mode into account), but certainly not in that of `RLF`, which calls the conversion recursively on the operands of a `LazyBinop`. I'd be tempted to remove this code path altogether. However, it is used elsewhere; besides, some code in Sage does seem to have been written with the idea that it is each parent's responsibility to ensure that its conversions to `RealField` with directed rounding return upper/lower bounds on the true value.

So I'm not sure what to do. An option might be to move all existing conversions to `RealField` that return rigorous bounds to separate methods (`_mpfr_upper_bound_()` and similar, say), and call these methods directly when we expect rigorous bounds...


---

Comment by git created at 2016-12-02 14:47:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-12-02 15:33:57

I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense. Did you make a list of what break when removing these methods?

Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).


---

Comment by mmezzarobba created at 2016-12-02 15:39:50

Replying to [comment:6 vdelecroix]:
> I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense.

What do you mean?

> Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).

It certainly would be possible to use them less (and also more efficiently), but it is also very convenient to have a unified way to represent constants that can be evaluated to arbitrary precision.


---

Comment by slelievre created at 2021-04-11 09:24:32

In SageMath 9.3.rc2:

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0.?e-17
```



---

Comment by git created at 2021-04-11 12:34:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2021-04-11 12:35:13

Changing priority from major to minor.


---

Comment by mmezzarobba created at 2021-04-11 12:35:13

Thanks Samuel!


---

Comment by mmezzarobba created at 2021-04-11 12:35:13

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2021-04-11 12:39:22

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-19 20:57:02

Changing priority from minor to major.


---

Comment by mkoeppe created at 2021-07-19 20:57:02

Promoting the oldest 5 positively reviewed tickets to "major"


---

Comment by vbraun created at 2021-07-23 20:11:37

Resolution: fixed
