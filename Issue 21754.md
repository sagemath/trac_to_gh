# Issue 21754: Problems with RealLazyField

archive/issues_021754.json:
```json
{
    "body": "As I was working with quadratic fields I encountered #21979 that might have been caused by `RealLazyField` related problems. Namely\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: v = RLF(u)\nsage: v\n0.?e6\nsage: v.is_zero()\nFalse\nsage: RealIntervalField(128)(v)\n0\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21991\n\n",
    "created_at": "2016-11-29T15:21:37Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Problems with RealLazyField",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21754",
    "user": "vdelecroix"
}
```
As I was working with quadratic fields I encountered #21979 that might have been caused by `RealLazyField` related problems. Namely

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0
```


Issue created by migration from https://trac.sagemath.org/ticket/21991





---

archive/issue_comments_301825.json:
```json
{
    "body": "I don't think the bug is in `RLF`:\n\n```\nsage: RealIntervalField(100)(u)\n0\nsage: RealIntervalField(100)(u).is_exact()\nTrue\n```\n",
    "created_at": "2016-12-02T13:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301825",
    "user": "mmezzarobba"
}
```

I don't think the bug is in `RLF`:

```
sage: RealIntervalField(100)(u)
0
sage: RealIntervalField(100)(u).is_exact()
True
```




---

archive/issue_comments_301826.json:
```json
{
    "body": "Replying to [comment:1 mmezzarobba]:\n> I don't think the bug is in `RLF`:\n> {{{\n> sage: RealIntervalField(100)(u)\n> 0\n> sage: RealIntervalField(100)(u).is_exact()\n> True\n> }}}\n\nI don't understand. This is fixed in #21979 mentioned in the description and which is merged in beta5\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: RealIntervalField(100)(u)\n0.?e-9\nsage: RealIntervalField(100)(u).is_exact()\nFalse\n```\n",
    "created_at": "2016-12-02T13:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301826",
    "user": "vdelecroix"
}
```

Replying to [comment:1 mmezzarobba]:
> I don't think the bug is in `RLF`:
> {{{
> sage: RealIntervalField(100)(u)
> 0
> sage: RealIntervalField(100)(u).is_exact()
> True
> }}}

I don't understand. This is fixed in #21979 mentioned in the description and which is merged in beta5

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: RealIntervalField(100)(u)
0.?e-9
sage: RealIntervalField(100)(u).is_exact()
False
```




---

archive/issue_comments_301827.json:
```json
{
    "body": "Whoops, I tested with an older beta by accident. Sorry for the noise.",
    "created_at": "2016-12-02T13:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301827",
    "user": "mmezzarobba"
}
```

Whoops, I tested with an older beta by accident. Sorry for the noise.



---

archive/issue_comments_301828.json:
```json
{
    "body": "The attached patch fixes the problem reported in this ticket. However, the reason the conversion worked in some cases in spite of the misnamed conversion method: namely, that `RealIntervalFieldElement.__init__()` has a code path that attempts conversions to `RealField`s with directed rounding. This is sort-of-okay (and used in sage...) in the case of an \u201catomic\u201d floating-point evaluation (assuming the conversion code correctly takes the rounding mode into account), but certainly not in that of `RLF`, which calls the conversion recursively on the operands of a `LazyBinop`. I'd be tempted to remove this code path altogether. However, it is used elsewhere; besides, some code in Sage does seem to have been written with the idea that it is each parent's responsibility to ensure that its conversions to `RealField` with directed rounding return upper/lower bounds on the true value.\n\nSo I'm not sure what to do. An option might be to move all existing conversions to `RealField` that return rigorous bounds to separate methods (`_mpfr_upper_bound_()` and similar, say), and call these methods directly when we expect rigorous bounds...",
    "created_at": "2016-12-02T14:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301828",
    "user": "mmezzarobba"
}
```

The attached patch fixes the problem reported in this ticket. However, the reason the conversion worked in some cases in spite of the misnamed conversion method: namely, that `RealIntervalFieldElement.__init__()` has a code path that attempts conversions to `RealField`s with directed rounding. This is sort-of-okay (and used in sage...) in the case of an “atomic” floating-point evaluation (assuming the conversion code correctly takes the rounding mode into account), but certainly not in that of `RLF`, which calls the conversion recursively on the operands of a `LazyBinop`. I'd be tempted to remove this code path altogether. However, it is used elsewhere; besides, some code in Sage does seem to have been written with the idea that it is each parent's responsibility to ensure that its conversions to `RealField` with directed rounding return upper/lower bounds on the true value.

So I'm not sure what to do. An option might be to move all existing conversions to `RealField` that return rigorous bounds to separate methods (`_mpfr_upper_bound_()` and similar, say), and call these methods directly when we expect rigorous bounds...



---

archive/issue_comments_301829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-12-02T14:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301829",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301830.json:
```json
{
    "body": "I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense. Did you make a list of what break when removing these methods?\n\nGetting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).",
    "created_at": "2016-12-02T15:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301830",
    "user": "vdelecroix"
}
```

I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense. Did you make a list of what break when removing these methods?

Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).



---

archive/issue_comments_301831.json:
```json
{
    "body": "Replying to [comment:6 vdelecroix]:\n> I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense.\n\nWhat do you mean?\n\n> Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).\n\nIt certainly would be possible to use them less (and also more efficiently), but it is also very convenient to have a unified way to represent constants that can be evaluated to arbitrary precision.",
    "created_at": "2016-12-02T15:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301831",
    "user": "mmezzarobba"
}
```

Replying to [comment:6 vdelecroix]:
> I am also tempted to avoid the real lazy field as much as possible. The current conversions `lazy -> interval` and `lazy -> floating` are nonsense.

What do you mean?

> Getting rid of `RLF/CLF` is doable everywhere in number fields (not sure whether it is the case).

It certainly would be possible to use them less (and also more efficiently), but it is also very convenient to have a unified way to represent constants that can be evaluated to arbitrary precision.



---

archive/issue_comments_301832.json:
```json
{
    "body": "In SageMath 9.3.rc2:\n\n```\nsage: a = QuadraticField(5).gen()\nsage: u = -573147844013817084101/2*a + 1281597540372340914251/2\nsage: v = RLF(u)\nsage: v\n0.?e6\nsage: v.is_zero()\nFalse\nsage: RealIntervalField(128)(v)\n0.?e-17\n```\n",
    "created_at": "2021-04-11T09:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301832",
    "user": "slelievre"
}
```

In SageMath 9.3.rc2:

```
sage: a = QuadraticField(5).gen()
sage: u = -573147844013817084101/2*a + 1281597540372340914251/2
sage: v = RLF(u)
sage: v
0.?e6
sage: v.is_zero()
False
sage: RealIntervalField(128)(v)
0.?e-17
```




---

archive/issue_comments_301833.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-11T12:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301833",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301834.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301834",
    "user": "mmezzarobba"
}
```

Changing priority from major to minor.



---

archive/issue_comments_301835.json:
```json
{
    "body": "Thanks Samuel!",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301835",
    "user": "mmezzarobba"
}
```

Thanks Samuel!



---

archive/issue_comments_301836.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-11T12:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301836",
    "user": "mmezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_301837.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-11T12:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301837",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301838.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2021-07-19T20:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301838",
    "user": "mkoeppe"
}
```

Changing priority from minor to major.



---

archive/issue_comments_301839.json:
```json
{
    "body": "Promoting the oldest 5 positively reviewed tickets to \"major\"",
    "created_at": "2021-07-19T20:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301839",
    "user": "mkoeppe"
}
```

Promoting the oldest 5 positively reviewed tickets to "major"



---

archive/issue_comments_301840.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21754",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21754#issuecomment-301840",
    "user": "vbraun"
}
```

Resolution: fixed
