# Issue 15770: give solution constants of ODEs unique names

Issue created by migration from https://trac.sagemath.org/ticket/16007

Original creator: rws

Original creation time: 2014-03-25 10:09:58

CC:  kcrisman

(this was reported as part of #6882)

... solving of ode y'=c*x is not correct, the free variable is messed up with a parameter, see [sage-devel](http://groups.google.cz/group/sage-devel/browse_thread/thread/e04cbc547095f2ac) - thanks for  	 	
Yuri Karadzhov

```
sage: from sage.calculus.calculus import symbolic_expression_from_maxima_string
sage: symbolic_expression_from_maxima_string('%c')
c
sage: c=var('c'); y=function('y',x); eq=diff(y,x)==c*x; eq
D[0](y)(x) == c*x
sage: desolve(eq,y,ivar=x)
1/2*c*x^2 + c
```

the answer should be something like 1/2*c*x<sup>2</sup> + c1

The fix depends on closing #8734. The `c` variable that comes from Sage can then be easily recognized, and the constant `c` should then be renamed to `c1` or `_C1`.


---

Comment by nbruin created at 2014-03-26 06:23:25

Actually, these variables are very easy to recognize any way:

```
sage: function('f',x)
f(x)
sage: var('c')
c
sage: W=diff(f(x),x,x)-f(x)+c
sage: V=diff(f(x),x)-f(x)+c
sage: maxima_calculus(V).ode2(f(x),x)
'f(x)=(c*%e^-x+%c)*%e^x
sage: maxima_calculus(W).ode2(f(x),x)
'f(x)=%k1*%e^x+%k2*%e^-x+c
```

As you can see, maxima creates these constants as `%c, %k1, %k2`, so there's no collision there. The collision only happens upon conversion back to sage. So we make the conversion more intelligent there wouldn't be an issue at all. Using `sage.interfaces.maxima_lib.max_to_sr` this would be fairly straightforward.


---

Comment by rws created at 2014-03-26 15:47:09

Indeed, many thanks. With this easy patch the output is now

```
sage: sage: x=function('x',t)
sage: sage: var('c')
c
sage: sage: desolve(diff(x,t)+2*x==t^2-2*t+c,x,ivar=t).expand()
1/2*t^2 + _C*e^(-2*t) + 1/2*c - 3/2*t + 3/4

sage: desolve(diff(f(x),x,x)-f(x),f(x))
_K2*e^(-x) + _K1*e^x
```

Any more variables?
----
New commits:


---

Comment by rws created at 2014-03-26 15:47:09

Changing status from new to needs_review.


---

Comment by zimmerma created at 2014-03-27 09:05:56

seems to be a duplicate of #9421.

Paul


---

Comment by rws created at 2014-03-27 10:17:46

Yes. So, are you okay with this solution applied to #9421, instead of the warning? If so, then I will make a reviewer's patch there and invalid this ticket.


---

Comment by zimmerma created at 2014-03-27 11:04:59

yes I agree with this solution, but I won't have time quite soon to check the doctests still pass.

Paul


---

Comment by kcrisman created at 2014-03-27 16:38:56

It might be worth doing a few things.  First, you must have documentation testing this fix - especially since people will be confused by underscore variables without some documentation!  Also, how many different things can show up?  Just `c`, `k1`, `k2`, or also `c1` et al, or `k3`, ... ?  It would be worth asking on the [Maxima email list](http://sourceforge.net/p/maxima/mailman/maxima-discuss/) about what outputs can possibly happen (assuming it's working - I was at some point subscribed to the "new" version but now am apparently not again).

But I agree it's very unlikely for anyone to have an underscore variable, so this could be a good compromise... there remains the issue of substituting in for non-Sageified variables.


---

Comment by rws created at 2014-04-04 07:10:20

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-06-05 15:39:53

Deleted misplaced comment.


---

Comment by rws created at 2014-06-06 08:45:00

Maxima-discuss list mail:

```
On 05-06-2014 16:36, Ralf Stephan wrote:
>Sage uses Maxima to solve ODEs. To do that bug free we would
>need to know which constant vars apart from %c, %k1, %k2 are
>returned by Maxima. Can you please help?
looking at the source code of the programs in share/diffequations,
it seems to me that those 3 are the only ones. I don't know if you
have other programs in mind, apart from those in share/diffequations.

Regards,
Jaime
```

I take it then the ticket is complete for review.


---

Comment by rws created at 2014-06-06 08:45:00

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-06-06 14:35:08

Thanks for doing that due diligence.  Yes, I believe these only arise from a contrib package in Maxima.
> I take it then the ticket is complete for review.
Well... see in comment:8
> First, you must have documentation testing this fix - especially since people will be confused by underscore variables without some documentation! 
It's really unfortunate with the underscores.  But I hate to think of checking whether `C`, `C1`, `C2` etc. were defined and then using whatever the next one was.  Anyway, unless Nils (who knows this stuff better than me) objects to your solution (quoting comment:9:ticket:9421)
>  (with the righter solution being: making sage's "forget the %" more intelligent, so that collisions can be avoided)
then as I said, this is definitely much better than leaving it 'as is'.


---

Comment by git created at 2014-06-07 06:53:26

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by rws created at 2014-06-07 06:54:33

Merged in #8734. Thanks for the doctest reminder.


---

Comment by kcrisman created at 2014-06-08 00:46:51

> Merged in #8734. Thanks for the doctest reminder.
No problem.   Do you think it's useful to add an example where there might have otherwise been a collision of names, or is that superfluous?

Also, why is the doctest

```
sefms('%k1*%x + %k2*%y + %c')
```

and not

```
sefms('%k1*x + %k2*y + %c')
```

I'm not sure what the `%` is doing on the variables, though I don't doubt Sage would strip those percents off, if I recall that part of the code correctly (it's been a while, though).


---

Comment by git created at 2014-06-08 07:07:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-06-08 07:09:08

OK. Though not wrong, it wasn't what I intended, so it's changed now.


---

Comment by kcrisman created at 2014-06-10 00:17:14

I realized another question.  I can't build a branch right now to check this, but I believe that in the past the `c` and friends were not only confusing, they didn't actually correspond to any Sage variable.  So now we have it that there is unlikely collision, but even then we still have `_C` and friends not corresponding to any Sage variable - they haven't been injected into any namespace.  (And I don't think we want to do it at startup on the off chance someone needs them.)  We _may_ want to do a seek-and-find for them but doing it every time could be annoying/add a little time.  Anyway, at the very least that should probably be (finally!) documented if we're going to fix this.

Sorry for all the minor things occurring to me.


---

Comment by nbruin created at 2014-06-10 01:04:13

Replying to [comment:19 kcrisman]:
> I realized another question.  I can't build a branch right now to check this, but I believe that in the past the `c` and friends were not only confusing, they didn't actually correspond to any Sage variable.  So now we have it that there is unlikely collision, but even then we still have `_C` and friends not corresponding to any Sage variable

Uh ... as soon as these make it back in sage there are symbolic variable objects that represent them. They are full-blown pynac objects right then.

> - they haven't been injected into any namespace.

That has never been a requirement for objects to "exist" in sage. I don't think this is an issue at all. The objects can be accessed via `SR("_C")` as usual, and in fact if the user does `_C=var("_C")` or toplevel `var("_C")` he/she can have the object bound. We should absolutely not mess with namespaces during runtime. We _might_ prebind `_C` etc. if someone thinks it's too difficult for users otherwise.


---

Comment by rws created at 2014-06-10 04:37:22

Replying to [comment:20 nbruin]:
> We _might_ prebind `_C` etc. if someone thinks it's too difficult for users otherwise.
I would like to. How would I do it?


---

Comment by nbruin created at 2014-06-10 16:07:42

You can already have them predefined by putting in `$HOME/.sage/init.sage` something like:

```
_C = SR.var("_C")
_K1 = SR.var("_K1")
_K2 = SR.var("_K2")
```

Various notebook/mathcloud solutions probably expose this mechanism or something equivalent somehow.

The error people get when they do try to access these objects via the correspondingly named variables is pretty clear and they'll probably do the right thing next (they've already been able to define a differential equation in sage, so they've had to jump some hurdles already). I'd propose holding off on filling global namespace now and only consider that if it turns out to be a common complaint. The "c,k1,k2" we had before suffered the same problem and didn't generate complaints either.


---

Comment by kcrisman created at 2014-06-10 17:11:12

> > We _might_ prebind `_C` etc. if someone thinks it's too difficult for users otherwise.
> I would like to. How would I do it?
I think my point is that presumably if one then retyped the answer, or tried to use it somehow, one would get an error about an undefined variable.  

```

sage: var('d')
d
sage: y=function('y',x); eq=diff(y,x)==d*x; eq
D[0](y)(x) == d*x
sage: desolve(eq,y,ivar=x)
1/2*d*x^2 + c
sage: c
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
<ipython-input-4-2cd6ee2c70b0> in <module>()
----> 1 c

NameError: name 'c' is not defined
```

That said, 

```

sage: D = desolve(eq,y,ivar=x)
sage: D.subs(c=3)
1/2*d*x^2 + 3
```

works.  So I would be comfortable with very good documentation or something ahead of time - and Nils' comment indicates that better documentation for how to use these is best.


---

Comment by git created at 2014-06-14 08:01:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-06-14 08:02:53

Please don't forget to add your names.


---

Comment by rws created at 2014-06-17 12:57:42

Not positive? So what's missing?


---

Comment by kcrisman created at 2014-06-17 13:29:57

> Not positive? So what's missing?
Still working on it!  I wanted to look more closely at #8734 first.  It does look okay, but I just wanted to think a little more about any unintended interactions.


---

Comment by kcrisman created at 2014-06-17 15:26:53

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-06-17 15:26:53

Is the line

```
sage: from sage.calculus.calculus import symbolic_expression_from_maxima_string as sefms
```

necessary in the doctest?  Though it doesn't hurt anything.

----


```
sage: sefms('%k1*x + %k2*y + %c')
_K1*x + _K2*y + _C
sage: _._latex_()
'_{K_{1}} x + _{K_{2}} y + _{C}'
```

I have a feeling this is not what we are looking for, but I don't know how to deal with it best.  Presumably 'naked variables/constants' don't need to be subscripted in typesetting.

One idea, which [mimics our handling of lambda](http://sagemath.org/doc/prep/Programming.html#gotchas-from-names-and-copies), would be to make the constants have names `k1_` and `c_` instead.

```
sage: var('lambda_')
lambda_
sage: latex(_)
\lambda
sage: var('beta_')
beta_
sage: latex(_)
\beta
sage: var('k1_')
k1_
sage: latex(_)
\mathit{k1}
```

Note that this is not what is desired either, since

```
sage: latex(k1)
k_{1}
sage: latex(k1_)
\mathit{k1}
sage: latex(c_)
c
```

I don't know whether this is a good solution, but we do need proper typesetting of these guys.


---

Comment by rws created at 2014-06-17 16:18:22

Indeed. I would propose to use `c_`, `k_`, and `K_` then, because `%k2` rarely appears. Changing the behaviour of `latex()` wrt to leading underscore will open the next can of worms, like complaints about typesetting `_3F_1`.


---

Comment by rws created at 2014-06-18 08:57:25

On the other hand, no. The best solution is in `latex_variable_name()` to recognize if a varname matches one entry of the `symtable` in `calculus.py`.


---

Comment by git created at 2014-06-18 09:27:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-06-18 09:28:01

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-06-18 20:37:48

> On the other hand, no. The best solution is in `latex_variable_name()` to recognize if a varname matches one entry of the `symtable` in `calculus.py`.
Really?  But now the distinction between `c` and `_c` is lost in typesetting, if I understand this correctly, though I don't know how one would typeset the underscore in any case.  I guess there probably isn't any better way, though - or? Ideas?


---

Comment by rws created at 2014-06-19 03:12:14

Well, now there is a code point where the behaviour can be changed. So, again, is there anything missing?


---

Comment by kcrisman created at 2014-06-24 15:48:52

> though I don't know how one would typeset the underscore in any case.
Turns out it currently just keeps the underscore.

This change could minutely slow down latex for variables that start with underscores, or if the symtable gets huge... but that is probably silly to worry about for now, neither are likely in the near future.  Also may help with #6882.  So I'm happy with this commit.
> So, again, is there anything missing?
Doctest (presumably just in `latex_variable_name`) for the latexing.  I realize this seems like a lot of rounds, but I've found the review process very helpful in the past, anyway.   (And I'm sorry I haven't time to check out the last commit of #8734 yet.)


---

Comment by git created at 2014-06-25 05:41:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-06-25 05:43:42

Replying to [comment:36 kcrisman]:
> > So, again, is there anything missing?
> Doctest (presumably just in `latex_variable_name`) for the latexing.  I realize this seems like a lot of rounds, but I've found the review process very helpful in the past, anyway.   (And I'm sorry I haven't time to check out the last commit of #8734 yet.)
I appreciate your thoroughness, and thanks for the review!


---

Comment by kcrisman created at 2014-06-25 13:37:43

Okay, if doctests pass (currently attempting to build the branch but it will take a while) then I'm happy with this.  Thanks for working on so many symbolics/calculus things recently.


---

Comment by kcrisman created at 2014-06-25 14:07:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-06-26 02:46:57

Doctests don't pass (try `make ptestlong`)

```
sage -t --long src/doc/en/tutorial/tour_algebra.rst
**********************************************************************
File "src/doc/en/tutorial/tour_algebra.rst", line 156, in doc.en.tutorial.tour_algebra
Failed example:
    desolve(DE, [x,t])
Expected:
    (c + e^t)*e^(-t)
Got:
    (_C + e^t)*e^(-t)
**********************************************************************
```



---

Comment by vbraun created at 2014-06-26 02:46:57

Changing status from positive_review to needs_work.


---

Comment by kcrisman created at 2014-06-26 03:13:42

Nuts!!!  I could have sworn I checked everything... and now I see why long tests on #8734 are taking so long too, I did `make testlong` and not `make ptestlong`.   Very sorry about this.


---

Comment by git created at 2014-06-26 08:56:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-06-26 08:59:01

Not all of #8734 was merged. Sorry for the inconvenience.


---

Comment by rws created at 2014-06-26 08:59:01

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-06-26 12:24:54

So has the code from #8734 been reviewed? If not make it a dependency here so I don't accidentally merge it.


---

Comment by git created at 2014-07-02 15:22:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-07-02 15:48:08

I am not going to check whether this passes tests, but at any rate the changes most recent seem fine, although I don't know why the non-doctest pieces had to have the constant `C` instead of `c` (but I don't really care about that).  So if anyone checks it passes tests we are good here, since #8734 is positive review.


---

Comment by git created at 2014-07-03 06:22:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-07-03 06:26:16

Thanks. Pulled in changes from dependencies. I'll run a patchbot on this now.


---

Comment by vbraun created at 2014-07-08 13:06:29

Resolution: fixed
