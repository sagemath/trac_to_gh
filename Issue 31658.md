# Issue 31658: Crash when exiting Sage

archive/issues_031658.json:
```json
{
    "body": "Keywords: exit crash\n\nWhen I do the following, I sometimes get Sage to crash when I exit:\n\n```\nuqtscrim@SMP-36PQ8T2:~/sage-build$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.3, Release Date: 2021-05-09                     \u2502\n\u2502 Using Python 3.9.2. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: ZZ(5)^(0.5+14.1347251*I)                                                                                      \n-1.62414637645790 - 1.53692828324508*I\nsage: quit()\nExiting Sage (CPU time 0m0.15s, Wall time 0m1.65s).\ndouble free or corruption (fasttop)\n------------------------------------------------------------------------\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fe59ed3c96b]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6b48)[0x7fe59ed3cb48]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x92ad)[0x7fe59ed3f2ad]\n/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fe5ae2df040]\n/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fe5ae2defb7]\n/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fe5ae2e0921]\n/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fe5ae329967]\n/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fe5ae3309da]\n/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fe5ae3380f4]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fe475ff32b2]\n/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_pool+0x2e)[0x7fe59c64d3be]\n/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_cache+0xe)[0x7fe59c62fb6e]\n/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fe590739ead]\n/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fe472834edf]\n/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fe5ae2e3161]\n/lib/x86_64-linux-gnu/libc.so.6(+0x4325a)[0x7fe5ae2e325a]\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee)[0x7fe5ae2c1bfe]\npython3(_start+0x2a)[0x55c62494675a]\n------------------------------------------------------------------------\n```\n\nI generally use ctrl-D to exit, which is how I first noticed it. Sometimes, all I get is\n\n```\nExiting Sage (CPU time 0m0.12s, Wall time 0m1.13s).\ndouble free or corruption (fasttop)malloc_consolidate(): invalid chunk size\n\n------------------------------------------------------------------------\nAborted (core dumped)\n```\n\nAnother error I got once:\n\n```\nExiting Sage (CPU time 0m0.23s, Wall time 0m2.62s).\ndouble free or corruption (fasttop)corrupted size vs. prev_size\n\n------------------------------------------------------------------------\n------------------------------------------------------------------------\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fc1ff18696b]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b+0x)6b48[0x)[0x7fc1ff18696b]\n7fc1ff186b48]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x+0x6b48)929c)[0x7fc1ff18929c]\n[0x7fc1ff186b48]\n/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7fc20e6e804092ad)]\n[0x7fc1ff1892ad]\n/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]\n/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fc20e6e8040]\n/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]\n/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]\n/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]\n/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]\n/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fc20e7399da]\n/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]\n/lib/x86_64-linux-gnu/libc.so.6(+0x90bdc)[0x/lib/x86_64-linux-gnu/libc.so.67fc20e739bdc]\n(+0x909da)[0x7fc20e7399da/lib/x86_64-linux-gnu/libc.so.6(cfree+0x]\n6fb)[0x7fc20e74112b]\n/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fc20e7410f4]\n/home/uqtscrim/sage-build/local/lib/libflint.so.14(_fmpz_cleanup+0x21)[0x7fc1f0b4d501]\n/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fc0d63eb2b2]\n/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fc0d2c2cedf]\n/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_func+0x40)[0x7fc1fca0d5e0/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fc20e6ec161]\n]\n/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_clear+0x1d)[0x7fc1fca0587d]\n/lib/x86_64-linux-gnu/libc.so.6(+0x4325a/home/uqtscrim/sage-build/local/lib/libmpfr.so.6)[0x7fc20e6ec25a(]\nmpfr_clear_cache+0x11)/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee[0x7fc1fca3a8e1]\n)[0x/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(7fc20e6cabfe]\n+0x42b30)python3(_start+0x2a)[0x[0x7fc1fca39b3055821e97b75a]\n]\n------------------------------------------------------------------------\n/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fc1f0b31ead]\n/usr/lib/x86_64-linux-gnu/libgomp.so.1(+0x1696e)[0x7fc0d2c3596e]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x76db)[0x7fc20e4916db]\n/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7fc20e7ca71f]\n------------------------------------------------------------------------\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31895\n\n",
    "created_at": "2021-06-02T22:19:31Z",
    "labels": [
        "component: misc",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Crash when exiting Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31658",
    "user": "https://github.com/tscrim"
}
```
Keywords: exit crash

When I do the following, I sometimes get Sage to crash when I exit:

```
uqtscrim@SMP-36PQ8T2:~/sage-build$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3, Release Date: 2021-05-09                     │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: ZZ(5)^(0.5+14.1347251*I)                                                                                      
-1.62414637645790 - 1.53692828324508*I
sage: quit()
Exiting Sage (CPU time 0m0.15s, Wall time 0m1.65s).
double free or corruption (fasttop)
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fe59ed3c96b]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6b48)[0x7fe59ed3cb48]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x92ad)[0x7fe59ed3f2ad]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fe5ae2df040]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fe5ae2defb7]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fe5ae2e0921]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fe5ae329967]
/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fe5ae3309da]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fe5ae3380f4]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fe475ff32b2]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_pool+0x2e)[0x7fe59c64d3be]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_cache+0xe)[0x7fe59c62fb6e]
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fe590739ead]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fe472834edf]
/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fe5ae2e3161]
/lib/x86_64-linux-gnu/libc.so.6(+0x4325a)[0x7fe5ae2e325a]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee)[0x7fe5ae2c1bfe]
python3(_start+0x2a)[0x55c62494675a]
------------------------------------------------------------------------
```

I generally use ctrl-D to exit, which is how I first noticed it. Sometimes, all I get is

```
Exiting Sage (CPU time 0m0.12s, Wall time 0m1.13s).
double free or corruption (fasttop)malloc_consolidate(): invalid chunk size

------------------------------------------------------------------------
Aborted (core dumped)
```

Another error I got once:

```
Exiting Sage (CPU time 0m0.23s, Wall time 0m2.62s).
double free or corruption (fasttop)corrupted size vs. prev_size

------------------------------------------------------------------------
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fc1ff18696b]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b+0x)6b48[0x)[0x7fc1ff18696b]
7fc1ff186b48]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x+0x6b48)929c)[0x7fc1ff18929c]
[0x7fc1ff186b48]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7fc20e6e804092ad)]
[0x7fc1ff1892ad]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fc20e6e8040]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]
/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fc20e7399da]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]
/lib/x86_64-linux-gnu/libc.so.6(+0x90bdc)[0x/lib/x86_64-linux-gnu/libc.so.67fc20e739bdc]
(+0x909da)[0x7fc20e7399da/lib/x86_64-linux-gnu/libc.so.6(cfree+0x]
6fb)[0x7fc20e74112b]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fc20e7410f4]
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_fmpz_cleanup+0x21)[0x7fc1f0b4d501]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fc0d63eb2b2]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fc0d2c2cedf]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_func+0x40)[0x7fc1fca0d5e0/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fc20e6ec161]
]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_clear+0x1d)[0x7fc1fca0587d]
/lib/x86_64-linux-gnu/libc.so.6(+0x4325a/home/uqtscrim/sage-build/local/lib/libmpfr.so.6)[0x7fc20e6ec25a(]
mpfr_clear_cache+0x11)/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee[0x7fc1fca3a8e1]
)[0x/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(7fc20e6cabfe]
+0x42b30)python3(_start+0x2a)[0x[0x7fc1fca39b3055821e97b75a]
]
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fc1f0b31ead]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(+0x1696e)[0x7fc0d2c3596e]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x76db)[0x7fc20e4916db]
/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7fc20e7ca71f]
------------------------------------------------------------------------
```


Issue created by migration from https://trac.sagemath.org/ticket/31895





---

archive/issue_comments_451571.json:
```json
{
    "body": "still present in recent betas?",
    "created_at": "2021-07-19T03:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451571",
    "user": "https://github.com/mkoeppe"
}
```

still present in recent betas?



---

archive/issue_comments_451572.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2021-07-19T03:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451572",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_451573.json:
```json
{
    "body": "I cannot seem to reproduce it anymore. I would like to know what the cause was, but I don't currently see it.",
    "created_at": "2021-07-19T03:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451573",
    "user": "https://github.com/tscrim"
}
```

I cannot seem to reproduce it anymore. I would like to know what the cause was, but I don't currently see it.



---

archive/issue_comments_451574.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-07-19T03:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451574",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_451575.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-30T05:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451575",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451576.json:
```json
{
    "body": "Let's just close this since I still cannot reproduce.",
    "created_at": "2021-07-30T05:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451576",
    "user": "https://github.com/tscrim"
}
```

Let's just close this since I still cannot reproduce.



---

archive/issue_events_028857.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-07-30T13:05:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31658#event-28857"
}
```



---

archive/issue_comments_451577.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-07-30T13:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31658",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31658#issuecomment-451577",
    "user": "https://github.com/fchapoton"
}
```

Resolution: invalid
