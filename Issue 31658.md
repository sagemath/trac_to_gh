# Issue 31658: Crash when exiting Sage

Issue created by migration from https://trac.sagemath.org/ticket/31895

Original creator: tscrim

Original creation time: 2021-06-02 22:19:31

Keywords: exit crash

When I do the following, I sometimes get Sage to crash when I exit:

```
uqtscrim@SMP-36PQ8T2:~/sage-build$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3, Release Date: 2021-05-09                     │
│ Using Python 3.9.2. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: ZZ(5)^(0.5+14.1347251*I)                                                                                      
-1.62414637645790 - 1.53692828324508*I
sage: quit()
Exiting Sage (CPU time 0m0.15s, Wall time 0m1.65s).
double free or corruption (fasttop)
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fe59ed3c96b]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x6b48)[0x7fe59ed3cb48]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x92ad)[0x7fe59ed3f2ad]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fe5ae2df040]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fe5ae2defb7]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fe5ae2e0921]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fe5ae329967]
/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fe5ae3309da]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fe5ae3380f4]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fe475ff32b2]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_pool+0x2e)[0x7fe59c64d3be]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_cache+0xe)[0x7fe59c62fb6e]
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fe590739ead]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fe472834edf]
/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fe5ae2e3161]
/lib/x86_64-linux-gnu/libc.so.6(+0x4325a)[0x7fe5ae2e325a]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee)[0x7fe5ae2c1bfe]
python3(_start+0x2a)[0x55c62494675a]
------------------------------------------------------------------------
```

I generally use ctrl-D to exit, which is how I first noticed it. Sometimes, all I get is

```
Exiting Sage (CPU time 0m0.12s, Wall time 0m1.13s).
double free or corruption (fasttop)malloc_consolidate(): invalid chunk size

------------------------------------------------------------------------
Aborted (core dumped)
```

Another error I got once:

```
Exiting Sage (CPU time 0m0.23s, Wall time 0m2.62s).
double free or corruption (fasttop)corrupted size vs. prev_size

------------------------------------------------------------------------
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b)[0x7fc1ff18696b]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x696b+0x)6b48[0x)[0x7fc1ff18696b]
7fc1ff186b48]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x+0x6b48)929c)[0x7fc1ff18929c]
[0x7fc1ff186b48]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/cysignals/signals.cpython-39-x86_64-linux-gnu.so(+0x7fc20e6e804092ad)]
[0x7fc1ff1892ad]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]
/lib/x86_64-linux-gnu/libc.so.6(+0x3f040)[0x7fc20e6e8040]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0xc7)[0x7fc20e6e7fb7]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x141)[0x7fc20e6e9921]
/lib/x86_64-linux-gnu/libc.so.6(+0x909da)[0x7fc20e7399da]
/lib/x86_64-linux-gnu/libc.so.6(+0x89967)[0x7fc20e732967]
/lib/x86_64-linux-gnu/libc.so.6(+0x90bdc)[0x/lib/x86_64-linux-gnu/libc.so.67fc20e739bdc]
(+0x909da)[0x7fc20e7399da/lib/x86_64-linux-gnu/libc.so.6(cfree+0x]
6fb)[0x7fc20e74112b]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x6c4)[0x7fc20e7410f4]
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_fmpz_cleanup+0x21)[0x7fc1f0b4d501]
/home/uqtscrim/sage-build/local/lib/python3.9/site-packages/sage/ext/memory.cpython-39-x86_64-linux-gnu.so(+0x32b2)[0x7fc0d63eb2b2]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(GOMP_parallel+0x3f)[0x7fc0d2c2cedf]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_free_func+0x40)[0x7fc1fca0d5e0/lib/x86_64-linux-gnu/libc.so.6(+0x43161)[0x7fc20e6ec161]
]
/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(mpfr_clear+0x1d)[0x7fc1fca0587d]
/lib/x86_64-linux-gnu/libc.so.6(+0x4325a/home/uqtscrim/sage-build/local/lib/libmpfr.so.6)[0x7fc20e6ec25a(]
mpfr_clear_cache+0x11)/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xee[0x7fc1fca3a8e1]
)[0x/home/uqtscrim/sage-build/local/lib/libmpfr.so.6(7fc20e6cabfe]
+0x42b30)python3(_start+0x2a)[0x[0x7fc1fca39b3055821e97b75a]
]
------------------------------------------------------------------------
/home/uqtscrim/sage-build/local/lib/libflint.so.14(_flint_cleanup+0x8d)[0x7fc1f0b31ead]
/usr/lib/x86_64-linux-gnu/libgomp.so.1(+0x1696e)[0x7fc0d2c3596e]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x76db)[0x7fc20e4916db]
/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7fc20e7ca71f]
------------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2021-07-19 03:54:23

still present in recent betas?


---

Comment by mkoeppe created at 2021-07-19 03:54:23

Changing status from new to needs_info.


---

Comment by tscrim created at 2021-07-19 03:57:37

I cannot seem to reproduce it anymore. I would like to know what the cause was, but I don't currently see it.


---

Comment by tscrim created at 2021-07-19 03:57:37

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2021-07-30 05:59:11

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-07-30 05:59:11

Let's just close this since I still cannot reproduce.


---

Comment by chapoton created at 2021-07-30 13:05:37

Resolution: invalid
