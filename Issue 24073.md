# Issue 24073: #timeit crashes unconditionally

archive/issues_024073.json:
```json
{
    "body": "CC:  mkoeppe\n\nAll #timeit commands lead to a crash. Example: `%timeit 1+1`. The crash log is attached. Excerpts\n\n```\nNo symbol table info available.\n#1  0x00007f3ff70d30d6 in print_enhanced_backtrace ()\n    at build/src/cysignals/implementation.c:394\n        parent_pid = 26300\n        pid = 26371\n#2  0x00007f3ff70d30fb in sigdie (sig=6, \n    s=0x7f3ff70e17c8 \"Unhandled SIGABRT: An abort() occurred.\")\n    at build/src/cysignals/implementation.c:413\nNo locals.\n#3  0x00007f3ff70d2a2d in cysigs_signal_handler (sig=6)\n    at build/src/cysignals/implementation.c:203\n        inside = 0\n#4  <signal handler called>\nNo symbol table info available.\n#5  0x00007f3fff06b8d7 in raise () from /lib64/libc.so.6\nNo symbol table info available.\n#6  0x00007f3fff06ccaa in abort () from /lib64/libc.so.6\nNo symbol table info available.\n#7  0x00007f3fff064866 in __assert_fail_base () from /lib64/libc.so.6\nNo symbol table info available.\n#8  0x00007f3fff064912 in __assert_fail () from /lib64/libc.so.6\nNo symbol table info available.\n#9  0x00007f3fffe6e77a in assemble_lnotab (a=0x7fffcce0df50, i=0x7f3da149ed70)\n    at Python/compile.c:3560\n        d_bytecode = 13\n        d_lineno = -3\n        len = 16\n        lnotab = 0x7f3da1202488 '\\313' <repeats 11 times>, <incomplete sequence \\313>\n        __PRETTY_FUNCTION__ = \"assemble_lnotab\"\n#10 0x00007f3fffe6eb86 in assemble_emit (a=0x7fffcce0df50, i=0x7f3da149ed70)\n    at Python/compile.c:3659\n        size = 3\n        arg = 0\n        ext = 0\n        len = 128\n        code = 0x7f3da1471e0a '\\313' <repeats 105 times>, <incomplete sequence \\313>\n        __PRETTY_FUNCTION__ = \"assemble_emit\"\n#11 0x00007f3fffe6f9c2 in assemble (c=0x7fffcce0e110, addNone=1)\n    at Python/compile.c:3951\n        b = 0x7f3da37ae310\n        entryblock = 0x7f3da37aeb30\n        a = {a_bytecode = 0x7f3da1471dc0, a_offset = 22, a_nblocks = 4, \n          a_postorder = 0x7f3da120e140, a_lnotab = 0x7f3da1202450, \n          a_lnotab_off = 4, a_lineno = 4, a_lineno_off = 9}\n        i = 2\n        j = 2\n        nblocks = 4\n        co = 0x0\n#12 0x00007f3fffe674f2 in compiler_function (c=0x7fffcce0e110, s=0x484c458)\n    at Python/compile.c:1381\n        co = 0x7f3fffdbd39f <_PyObject_DebugMalloc+29>\n        first_const = 0x7f400013cc60 <_Py_NoneStruct>\n        args = 0x484be28\n        decos = 0x484c448\n        st = 0x484c418\n        i = 5\n        n = 5\n        docstring = 0\n        __PRETTY_FUNCTION__ = \"compiler_function\"\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24310\n\n",
    "created_at": "2017-12-01T08:38:48Z",
    "labels": [
        "user interface",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "#timeit crashes unconditionally",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24073",
    "user": "rws"
}
```
CC:  mkoeppe

All #timeit commands lead to a crash. Example: `%timeit 1+1`. The crash log is attached. Excerpts

```
No symbol table info available.
#1  0x00007f3ff70d30d6 in print_enhanced_backtrace ()
    at build/src/cysignals/implementation.c:394
        parent_pid = 26300
        pid = 26371
#2  0x00007f3ff70d30fb in sigdie (sig=6, 
    s=0x7f3ff70e17c8 "Unhandled SIGABRT: An abort() occurred.")
    at build/src/cysignals/implementation.c:413
No locals.
#3  0x00007f3ff70d2a2d in cysigs_signal_handler (sig=6)
    at build/src/cysignals/implementation.c:203
        inside = 0
#4  <signal handler called>
No symbol table info available.
#5  0x00007f3fff06b8d7 in raise () from /lib64/libc.so.6
No symbol table info available.
#6  0x00007f3fff06ccaa in abort () from /lib64/libc.so.6
No symbol table info available.
#7  0x00007f3fff064866 in __assert_fail_base () from /lib64/libc.so.6
No symbol table info available.
#8  0x00007f3fff064912 in __assert_fail () from /lib64/libc.so.6
No symbol table info available.
#9  0x00007f3fffe6e77a in assemble_lnotab (a=0x7fffcce0df50, i=0x7f3da149ed70)
    at Python/compile.c:3560
        d_bytecode = 13
        d_lineno = -3
        len = 16
        lnotab = 0x7f3da1202488 '\313' <repeats 11 times>, <incomplete sequence \313>
        __PRETTY_FUNCTION__ = "assemble_lnotab"
#10 0x00007f3fffe6eb86 in assemble_emit (a=0x7fffcce0df50, i=0x7f3da149ed70)
    at Python/compile.c:3659
        size = 3
        arg = 0
        ext = 0
        len = 128
        code = 0x7f3da1471e0a '\313' <repeats 105 times>, <incomplete sequence \313>
        __PRETTY_FUNCTION__ = "assemble_emit"
#11 0x00007f3fffe6f9c2 in assemble (c=0x7fffcce0e110, addNone=1)
    at Python/compile.c:3951
        b = 0x7f3da37ae310
        entryblock = 0x7f3da37aeb30
        a = {a_bytecode = 0x7f3da1471dc0, a_offset = 22, a_nblocks = 4, 
          a_postorder = 0x7f3da120e140, a_lnotab = 0x7f3da1202450, 
          a_lnotab_off = 4, a_lineno = 4, a_lineno_off = 9}
        i = 2
        j = 2
        nblocks = 4
        co = 0x0
#12 0x00007f3fffe674f2 in compiler_function (c=0x7fffcce0e110, s=0x484c458)
    at Python/compile.c:1381
        co = 0x7f3fffdbd39f <_PyObject_DebugMalloc+29>
        first_const = 0x7f400013cc60 <_Py_NoneStruct>
        args = 0x484be28
        decos = 0x484c448
        st = 0x484c418
        i = 5
        n = 5
        docstring = 0
        __PRETTY_FUNCTION__ = "compiler_function"
```


Issue created by migration from https://trac.sagemath.org/ticket/24310





---

archive/issue_comments_337317.json:
```json
{
    "body": "Attachment [crash_xpy5Sy.log](tarball://root/attachments/some-uuid/ticket24310/crash_xpy5Sy.log) by jdemeyer created at 2017-12-01 09:36:54\n\nWorks for me:\n\n```\nsage: %timeit 1+1\nThe slowest run took 24.56 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 204 ns per loop\n```\n\n\nObvious question: did you run `make` (or at least `make build`)?",
    "created_at": "2017-12-01T09:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337317",
    "user": "jdemeyer"
}
```

Attachment [crash_xpy5Sy.log](tarball://root/attachments/some-uuid/ticket24310/crash_xpy5Sy.log) by jdemeyer created at 2017-12-01 09:36:54

Works for me:

```
sage: %timeit 1+1
The slowest run took 24.56 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 204 ns per loop
```


Obvious question: did you run `make` (or at least `make build`)?



---

archive/issue_comments_337318.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2017-12-01T09:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337318",
    "user": "jdemeyer"
}
```

Changing priority from critical to major.



---

archive/issue_comments_337319.json:
```json
{
    "body": "It seems to be crashing inside Python itself...\n\nCan you please post the initial part of the exact output of `%timeit 1+1` (i.e. the part that comes before the crash log)",
    "created_at": "2017-12-01T09:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337319",
    "user": "jdemeyer"
}
```

It seems to be crashing inside Python itself...

Can you please post the initial part of the exact output of `%timeit 1+1` (i.e. the part that comes before the crash log)



---

archive/issue_comments_337320.json:
```json
{
    "body": "Ah, I overlooked that:\n\n```\nsage: %timeit 1+1\npython: Python/compile.c:3560: assemble_lnotab: Assertion 'd_lineno >= 0' failed.\n----------------\n```\n",
    "created_at": "2017-12-01T09:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337320",
    "user": "rws"
}
```

Ah, I overlooked that:

```
sage: %timeit 1+1
python: Python/compile.c:3560: assemble_lnotab: Assertion 'd_lineno >= 0' failed.
----------------
```




---

archive/issue_comments_337321.json:
```json
{
    "body": "Okay, I remember at some time building Python with `SAGE_DEBUG=yes`. I'll test without.",
    "created_at": "2017-12-01T09:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337321",
    "user": "rws"
}
```

Okay, I remember at some time building Python with `SAGE_DEBUG=yes`. I'll test without.



---

archive/issue_comments_337322.json:
```json
{
    "body": "Details:\n- with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash\n- with `export SAGE_DEBUG=yes ; ./sage -p python2 ; export SAGE_DEBUG=no ; make start`: timeit does crash\n- with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash\n\nI also found this:\nhttps://bugs.python.org/issue21385\n\nIf this is the same bug then they fixed it in Py3 but apparently not in Py2.",
    "created_at": "2017-12-01T15:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337322",
    "user": "rws"
}
```

Details:
- with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash
- with `export SAGE_DEBUG=yes ; ./sage -p python2 ; export SAGE_DEBUG=no ; make start`: timeit does crash
- with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash

I also found this:
https://bugs.python.org/issue21385

If this is the same bug then they fixed it in Py3 but apparently not in Py2.



---

archive/issue_comments_337323.json:
```json
{
    "body": "Setting milestone to 9.1.1 assuming this ticket is only about Python 2.\n\nIf not please revert.",
    "created_at": "2020-09-16T18:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337323",
    "user": "slelievre"
}
```

Setting milestone to 9.1.1 assuming this ticket is only about Python 2.

If not please revert.



---

archive/issue_comments_337324.json:
```json
{
    "body": "I think we can close this one as obsolete. Ok ?",
    "created_at": "2022-05-14T17:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337324",
    "user": "chapoton"
}
```

I think we can close this one as obsolete. Ok ?



---

archive/issue_comments_337325.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-05-14T17:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337325",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337326.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-05-14T17:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337326",
    "user": "dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337327.json:
```json
{
    "body": "We don't support Python2 anymore.",
    "created_at": "2022-05-14T17:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337327",
    "user": "dcoudert"
}
```

We don't support Python2 anymore.



---

archive/issue_comments_337328.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2022-05-15T16:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24073#issuecomment-337328",
    "user": "chapoton"
}
```

Resolution: invalid
