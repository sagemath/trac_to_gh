# Issue 24073: #timeit crashes unconditionally

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2017-12-01 08:38:48

CC:  mkoeppe

All #timeit commands lead to a crash. Example: `%timeit 1+1`. The crash log is attached. Excerpts

```
No symbol table info available.
#1  0x00007f3ff70d30d6 in print_enhanced_backtrace ()
    at build/src/cysignals/implementation.c:394
        parent_pid = 26300
        pid = 26371
#2  0x00007f3ff70d30fb in sigdie (sig=6, 
    s=0x7f3ff70e17c8 "Unhandled SIGABRT: An abort() occurred.")
    at build/src/cysignals/implementation.c:413
No locals.
#3  0x00007f3ff70d2a2d in cysigs_signal_handler (sig=6)
    at build/src/cysignals/implementation.c:203
        inside = 0
#4  <signal handler called>
No symbol table info available.
#5  0x00007f3fff06b8d7 in raise () from /lib64/libc.so.6
No symbol table info available.
#6  0x00007f3fff06ccaa in abort () from /lib64/libc.so.6
No symbol table info available.
#7  0x00007f3fff064866 in __assert_fail_base () from /lib64/libc.so.6
No symbol table info available.
#8  0x00007f3fff064912 in __assert_fail () from /lib64/libc.so.6
No symbol table info available.
#9  0x00007f3fffe6e77a in assemble_lnotab (a=0x7fffcce0df50, i=0x7f3da149ed70)
    at Python/compile.c:3560
        d_bytecode = 13
        d_lineno = -3
        len = 16
        lnotab = 0x7f3da1202488 '\313' <repeats 11 times>, <incomplete sequence \313>
        __PRETTY_FUNCTION__ = "assemble_lnotab"
#10 0x00007f3fffe6eb86 in assemble_emit (a=0x7fffcce0df50, i=0x7f3da149ed70)
    at Python/compile.c:3659
        size = 3
        arg = 0
        ext = 0
        len = 128
        code = 0x7f3da1471e0a '\313' <repeats 105 times>, <incomplete sequence \313>
        __PRETTY_FUNCTION__ = "assemble_emit"
#11 0x00007f3fffe6f9c2 in assemble (c=0x7fffcce0e110, addNone=1)
    at Python/compile.c:3951
        b = 0x7f3da37ae310
        entryblock = 0x7f3da37aeb30
        a = {a_bytecode = 0x7f3da1471dc0, a_offset = 22, a_nblocks = 4, 
          a_postorder = 0x7f3da120e140, a_lnotab = 0x7f3da1202450, 
          a_lnotab_off = 4, a_lineno = 4, a_lineno_off = 9}
        i = 2
        j = 2
        nblocks = 4
        co = 0x0
#12 0x00007f3fffe674f2 in compiler_function (c=0x7fffcce0e110, s=0x484c458)
    at Python/compile.c:1381
        co = 0x7f3fffdbd39f <_PyObject_DebugMalloc+29>
        first_const = 0x7f400013cc60 <_Py_NoneStruct>
        args = 0x484be28
        decos = 0x484c448
        st = 0x484c418
        i = 5
        n = 5
        docstring = 0
        __PRETTY_FUNCTION__ = "compiler_function"
```



---

Attachment

Works for me:

```
sage: %timeit 1+1
The slowest run took 24.56 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 204 ns per loop
```


Obvious question: did you run `make` (or at least `make build`)?


---

Comment by jdemeyer created at 2017-12-01 09:39:10

Changing priority from critical to major.


---

Comment by jdemeyer created at 2017-12-01 09:39:10

It seems to be crashing inside Python itself...

Can you please post the initial part of the exact output of `%timeit 1+1` (i.e. the part that comes before the crash log)


---

Comment by rws created at 2017-12-01 09:52:32

Ah, I overlooked that:

```
sage: %timeit 1+1
python: Python/compile.c:3560: assemble_lnotab: Assertion 'd_lineno >= 0' failed.
----------------
```



---

Comment by rws created at 2017-12-01 09:56:04

Okay, I remember at some time building Python with `SAGE_DEBUG=yes`. I'll test without.


---

Comment by rws created at 2017-12-01 15:51:12

Details:
 - with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash
 - with `export SAGE_DEBUG=yes ; ./sage -p python2 ; export SAGE_DEBUG=no ; make start`: timeit does crash
 - with `export SAGE_DEBUG=no ; ./sage -p python2 ; make start`: timeit does not crash

I also found this:
https://bugs.python.org/issue21385

If this is the same bug then they fixed it in Py3 but apparently not in Py2.


---

Comment by slelievre created at 2020-09-16 18:16:16

Setting milestone to 9.1.1 assuming this ticket is only about Python 2.

If not please revert.


---

Comment by chapoton created at 2022-05-14 17:10:41

I think we can close this one as obsolete. Ok ?


---

Comment by chapoton created at 2022-05-14 17:10:55

Changing status from new to needs_review.


---

Comment by dcoudert created at 2022-05-14 17:28:33

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2022-05-14 17:28:33

We don't support Python2 anymore.


---

Comment by chapoton created at 2022-05-15 16:38:47

Resolution: invalid
