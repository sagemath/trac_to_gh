# Issue 31962: Conjugating Set Runtime Improvement

Issue created by migration from https://trac.sagemath.org/ticket/32199

Original creator: @EnderWannabe

Original creation time: 2021-07-13 20:54:07

CC:  bhutz

Keywords: gsoc2021

Currently, conjugating set is very slow for maps with many fixed points. This ticket aims to improve the runtime of conjugating set by using the multipliers of the fixed points to reduce the combinatorics necessary to find all conjugations. Additionally, we aim to check conjugations in parallel to further speed up the calculation.


---

Comment by @EnderWannabe created at 2021-07-20 14:27:42

Last 10 new commits:


---

Comment by @EnderWannabe created at 2021-07-20 14:27:42

Changing status from new to needs_review.


---

Comment by git created at 2021-07-20 14:29:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-20 16:42:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-07-27 14:01:36

So far, I've found no issues with functionality. Mostly some doc and doctest issues:

- 2052 - f is not defined nor passed in??

- 2098, 2245 - "instead do" -> "instead use"

- 2106, 2253 - looks like it fits on the previous line

- 2119, 2266 - can be on same line as 2117


- 2205, 2233: conjugating_set_helper -- Is it possible for different threads to find the same automorphism? I think "no" since the source set is fixed for all threads.

- 2379: need blank line at end of file


- need to update 32155




Finite field automorphism_group:

- do not have any dimension > 1 examples as well as a sanity check on the results:


```
R.<x,y,z> = ProjectiveSpace(GF(5),2)
f = DynamicalSystem_projective([x^3+x*z^2, y^3+y*z^2,z^3])
all([f.conjugate(m) == f for m in f.automorphism_group()])
```




field automorphism_group:

- num_cpus default = 2?  Why does this function default to 1 when the others default to 2.

- no interesting dim 2 examples


conjugating set:

- 6548: since 2 is the default should probably change to num_cpus=3

- 6727  "an" -> "can"  (not your error, but may as well fix it while we are working on this function



is_conjugate:

- default num_cpus = 2?


---

Comment by bhutz created at 2021-07-27 14:01:36

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-27 19:50:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-27 19:50:35

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-07-29 14:52:44

an error was introduced somewhere; looks like from the merging in the new #32155. Pretty much every example gives


```
ValueError                                Traceback (most recent call last)
<timed exec> in <module>

~/sage-test/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/projective_ds.py in conjugating_set(self, other, R, num_cpus)
   6742             and (f.sigma_invariants(1) != g.sigma_invariants(1)):
   6743             return []
-> 6744         tup = conjugating_set_initializer(f, g)
   6745         if tup == []:
   6746             return []

~/sage-test/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/endPN_automorphism_group.py in conjugating_set_initializer(f, g)
   1913     # does find a subset, then the subset will most likely minimize the combinatorics
   1914     # of checking conjugations
-> 1915     tup = greedy_independence_check(P, repeated_mult_L, point_to_mult_L)
   1916     if not tup is None:
   1917         more = False

~/sage-test/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/endPN_automorphism_group.py in greedy_independence_check(P, repeated_mult, point_to_mult)
   2087         for point_lst in repeated_mult[r]:
   2088             for point in point_lst:
-> 2089                 if P.is_linearly_independent(source + [point], n+1):
   2090                     source.append(point)
   2091                     mult = point_to_mult[point]

~/sage-test/local/lib/python3.9/site-packages/sage/schemes/projective/projective_space.py in is_linearly_independent(self, points, n)
   1791         n = Integer(n)
   1792         if n < 1 or n > len(points):
-> 1793             raise ValueError('n must be a non negative integer not greater than the length of points')
   1794         all_subsets = Subsets(range(len(points)), n)
   1795         linearly_independent = True

ValueError: n must be a non negative integer not greater than the length of points
```



---

Comment by bhutz created at 2021-07-29 14:52:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-29 14:59:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-07-29 15:00:22

Replying to [comment:8 bhutz]:
> looks like from the merging in the new #32155

The new version was backwards incompatible, whoops. Fix pushed


---

Comment by bhutz created at 2021-07-29 15:43:16

ok, that looks better. Just waiting on the merge conflict for #32155 now.


---

Comment by git created at 2021-08-03 16:14:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-08-03 16:14:40

Merged latest #32155


---

Comment by @EnderWannabe created at 2021-08-03 16:14:40

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-08-04 18:26:54

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2021-08-04 18:26:54

Note that the patchbot has caught two failures:


```
File "src/sage/dynamics/arithmetic_dynamics/endPN_automorphism_group.py", line 1841, in sage.dynamics.arithmetic_dynamics.endPN_automorphism_group.conjugating_set_initializer
Failed example:
    conjugating_set_initializer(f, f)
Expected:
    ([(-1 : 0 : 1), (0 : -1 : 1), (0 : 1 : 0), (1 : 0 : 0)],
     [[[(-1 : 0 : 1), (0 : -1 : 1), (-1 : 1 : 0)], 2],
     [[(0 : 1 : 0), (1 : 0 : 0), (1 : 1 : 1), (0 : 0 : 1)], 2]])
Got:
    ([(-1 : 1 : 0), (0 : -1 : 1), (1 : 1 : 1), (1 : 0 : 0)],
     [[[(-1 : 1 : 0), (0 : -1 : 1), (-1 : 0 : 1)], 2],
      [[(1 : 1 : 1), (1 : 0 : 0), (0 : 0 : 1), (0 : 1 : 0)], 2]])
```



```
File "src/sage/dynamics/arithmetic_dynamics/endPN_automorphism_group.py", line 2143, in sage.dynamics.arithmetic_dynamics.endPN_automorphism_group.conjugating_set_helper
Failed example:
    conjugating_set_helper(f, f, 2, source, possible_targets)
Expected:
    [
    [1 0]  [0 1]
    [0 1], [1 0]
    ]
Got:
    [
    [0 1]  [1 0]
    [1 0], [0 1]
    ]
```



---

Comment by @EnderWannabe created at 2021-08-04 19:10:02

Replying to [comment:14 bhutz]:
> Note that the patchbot has caught two failures

Tests pass for me locally. Not sure what is going on here


---

Comment by bhutz created at 2021-08-04 19:21:10

Might it be a sorting problem with .peroiodic_points()?


---

Comment by @EnderWannabe created at 2021-08-04 19:35:46

Replying to [comment:16 bhutz]:
> Might it be a sorting problem with .peroiodic_points()?

I'm not sure. Patchbot ran on two machines I think, and checking the logs the failures were different on each machine. The other machine shows these failures


```
**********************************************************************
File "src/sage/schemes/projective/projective_space.py", line 1731, in sage.schemes.projective.projective_space.ProjectiveSpace_ring.is_linearly_independent
Failed example:
    points = [P((1, 0)), P((1, 1))]
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.projective.projective_space.ProjectiveSpace_ring.is_linearly_independent[0]>", line 1, in <module>
        points = [P((Integer(1), Integer(0))), P((Integer(1), Integer(1)))]
    NameError: name 'P' is not defined
**********************************************************************
File "src/sage/schemes/projective/projective_space.py", line 1732, in sage.schemes.projective.projective_space.ProjectiveSpace_ring.is_linearly_independent
Failed example:
    P.is_linearly_independent(points)
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.projective.projective_space.ProjectiveSpace_ring.is_linearly_independent[1]>", line 1, in <module>
        P.is_linearly_independent(points)
    NameError: name 'P' is not defined
**********************************************************************
```


These don't seem like actual failures - P is defined on the line before. Also, the conjugating set examples pass on this machine.


---

Comment by bhutz created at 2021-08-04 19:52:19

I also don't think these 2nd machine failures are real failures since these tests pass on all machines for #32155. So I'd focus on the first failures. Those seem more likely to be real failures, but we could wait for the patchbot to run again while we are waiting on #32155 to be cleared.


---

Comment by git created at 2021-08-04 20:10:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-08-04 20:11:23

Ok, lets wait for patchbot. I removed some unused imports in the last push


---

Comment by git created at 2021-08-05 17:59:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-08-05 18:02:36

Examples are definitely causing errors. I pushed a branch which doesn't rely on directly comparing the strings.


---

Comment by @EnderWannabe created at 2021-08-05 18:32:54

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-08-13 15:51:05

looks good.


---

Comment by bhutz created at 2021-08-13 15:51:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-19 20:30:56

Resolution: fixed
