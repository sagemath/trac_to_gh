# Issue 30816: MR49: Register sorted dict pprinter earlier in doctest forker

Issue created by migration from https://trac.sagemath.org/ticket/31053

Original creator: galois

Original creation time: 2020-12-15 16:28:07

Mauricio Collares ([`@`collares](https://gitlab.com/collares)) opened a merge request at https://gitlab.com/sagemath/sage/-/merge_requests/49:
----

```markdown
Currently, the pprinter gets registered after controller.load_environment(). This is fine if a lazy import cache exists in ~/.sage/cache, because in this case sandpile.py doesn't get immediately executed. However, if there's no such cache, then the line

```
pretty.for_type(SandpileConfig, pretty.for_type(dict, None))
```

in sandpiles.py gets to run before the new dict pretty printer gets registered, causing the unsorted pretty printer to be registered for SandpileConfig (and similarly for SandpileDivisor). This leads to test failures in the absence of the lazy import cache.
```



---

Comment by dimpase created at 2021-01-02 10:11:02

Changing component from PLEASE CHANGE to doctest framework.


---

Comment by dimpase created at 2021-01-02 10:11:02

Changing type from PLEASE CHANGE to defect.


---

Comment by dimpase created at 2021-01-02 10:17:24

Good catch. LGTM


---

Comment by dimpase created at 2021-01-02 10:17:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-01-03 12:15:33

Resolution: fixed
