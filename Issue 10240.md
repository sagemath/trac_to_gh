# Issue 10240: Remove unportable '-q' option to grep on SAGE_ROOT/spkg/install

archive/issues_010240.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @nexttime @jhpalmieri\n\nAlthough the -q option to grep is defined by POSIX, many older greps do not implement this. Even the man page of `grep` on a Linux machine says not to use -q or -s on scripts that are supposed to be portable. \n\nThe grep in /usr/bin on Solaris does not support the option. This is done by Sun to maintain backward compatibility with older versions which did not support it. So this causes a problem. \n\n\n```\ndrkirkby@hawk:~/sage-4.6.1.alpha0$ make\nspkg/pipestatus \"cd spkg && ./install all 2>&1\" \"tee -a ../install.log\"\ngrep: illegal option -- q\nUsage: grep -hblcnsviw pattern file . . .\n```\n\n\nPOSIX says:\n\n\n```\n-q\n    Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.\n```\n\n\nso it is quite easy to work around. \n\nSee also:\n\nhttp://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep\n\nIssue created by migration from https://trac.sagemath.org/ticket/10241\n\n",
    "created_at": "2010-11-09T21:09:42Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Remove unportable '-q' option to grep on SAGE_ROOT/spkg/install",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10240",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```
Assignee: GeorgSWeber

CC:  @nexttime @jhpalmieri

Although the -q option to grep is defined by POSIX, many older greps do not implement this. Even the man page of `grep` on a Linux machine says not to use -q or -s on scripts that are supposed to be portable. 

The grep in /usr/bin on Solaris does not support the option. This is done by Sun to maintain backward compatibility with older versions which did not support it. So this causes a problem. 


```
drkirkby@hawk:~/sage-4.6.1.alpha0$ make
spkg/pipestatus "cd spkg && ./install all 2>&1" "tee -a ../install.log"
grep: illegal option -- q
Usage: grep -hblcnsviw pattern file . . .
```


POSIX says:


```
-q
    Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.
```


so it is quite easy to work around. 

See also:

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep

Issue created by migration from https://trac.sagemath.org/ticket/10241





---

archive/issue_comments_104209.json:
```json
{
    "body": "Revised install file, which avoids the unportable grep -q",
    "created_at": "2010-11-09T21:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104209",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Revised install file, which avoids the unportable grep -q



---

archive/issue_comments_104210.json:
```json
{
    "body": "Attachment [install](tarball://root/attachments/some-uuid/ticket10241/install) by drkirkby created at 2010-11-09 21:59:54\n\nUnified diff, for review purposes only. The install file is not in a repository",
    "created_at": "2010-11-09T21:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104210",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Attachment [install](tarball://root/attachments/some-uuid/ticket10241/install) by drkirkby created at 2010-11-09 21:59:54

Unified diff, for review purposes only. The install file is not in a repository



---

archive/issue_comments_104211.json:
```json
{
    "body": "Attachment [install.diff](tarball://root/attachments/some-uuid/ticket10241/install.diff) by drkirkby created at 2010-11-09 22:02:28",
    "created_at": "2010-11-09T22:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104211",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Attachment [install.diff](tarball://root/attachments/some-uuid/ticket10241/install.diff) by drkirkby created at 2010-11-09 22:02:28



---

archive/issue_comments_104212.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-11-09T22:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104212",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_104213.json:
```json
{
    "body": "This needs review.",
    "created_at": "2010-11-09T22:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104213",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

This needs review.



---

archive/issue_comments_104214.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2010-11-09T23:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104214",
    "user": "https://github.com/jhpalmieri"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_104215.json:
```json
{
    "body": "looks and works good.",
    "created_at": "2010-11-10T03:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104215",
    "user": "https://github.com/dimpase"
}
```

looks and works good.



---

archive/issue_comments_104216.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-11-10T03:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104216",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_104217.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-11T13:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104217",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_010360.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2010-11-11T13:02:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10240#event-10360"
}
```



---

archive/issue_comments_104218.json:
```json
{
    "body": "Post-mortem comment: ;-)\n\nIn general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n\nIMHO Sage's `configure` should handle such. We're not building `gcc`, nor do we support last millenium's systems...\n\n(Btw, `egrep` and `echo -n` aren't very portable in that sense either. If we only use the smallest subset of all systems or program versions one could think of, the code gets unreadable and harder to maintain.)\n\nFortunately, `sage-upgrade` won't get very large (I hope), but that's not the case for other uses of `grep -q`. Abusing `sed` is IMHO not an option (see above).",
    "created_at": "2010-11-21T20:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104218",
    "user": "https://github.com/nexttime"
}
```

Post-mortem comment: ;-)

In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

IMHO Sage's `configure` should handle such. We're not building `gcc`, nor do we support last millenium's systems...

(Btw, `egrep` and `echo -n` aren't very portable in that sense either. If we only use the smallest subset of all systems or program versions one could think of, the code gets unreadable and harder to maintain.)

Fortunately, `sage-upgrade` won't get very large (I hope), but that's not the case for other uses of `grep -q`. Abusing `sed` is IMHO not an option (see above).



---

archive/issue_comments_104219.json:
```json
{
    "body": "Replying to [comment:7 leif]:\n> Post-mortem comment: ;-)\n> \n> In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n\nWhat has this to do with setting `PATH`?",
    "created_at": "2010-11-21T21:55:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104219",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 leif]:
> Post-mortem comment: ;-)
> 
> In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

What has this to do with setting `PATH`?



---

archive/issue_comments_104220.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 leif]:\n> > Post-mortem comment: ;-)\n> > \n> > In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.\n> \n> What has this to do with setting `PATH`?\n\nAsk Oracle... ;-)\n\n(The POSIX-conformant versions aren't in the default `PATH`, for \"compatibility\" reasons.)",
    "created_at": "2010-11-21T22:51:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104220",
    "user": "https://github.com/nexttime"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 leif]:
> > Post-mortem comment: ;-)
> > 
> > In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.
> 
> What has this to do with setting `PATH`?

Ask Oracle... ;-)

(The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)



---

archive/issue_comments_104221.json:
```json
{
    "body": "Replying to [comment:9 leif]:\n> Replying to [comment:8 jdemeyer]:\n> > What has this to do with setting `PATH`?\n> \n> Ask Oracle... ;-)\n> \n> (The POSIX-conformant versions aren't in the default `PATH`, for \"compatibility\" reasons.)\n\nOf course the fact the default path does not always have POSIX options is a little unfortunate, but does mean Solaris has excellent backward compatibility. A 20 years old SunOS binary will still run today on Solaris. \n\nI do occasionally build Sage on the 2005 edition of Solaris 10, and it works on the latest revision. \n\nThe same can not be said for Linux, where it seems that there is a never ending battle of keeping things working as the operating systems are updated. \n\n* ECL does not work on Fedora 14 -  #10185\n* Readline not work on the latest Arch or openSUSE #9530\n* etc, etc etc.\n\n**I've yet to see one single example of where Sage builds on an old version of Solaris, but not on a newer one.**\n \nIt should also be noted that Linux does not ship with POSIX commands - `ls`, `df`, `du` being 3 simple examples. But there are tons of them. \n\nhttps://www.opengroup.org/platform/single_unix_specification/uploads/40/13450/POSIX_and_Linux_Application_Compatibility_Final_-_v1.0.pdf\n\nLike it or not, to create portable code, it is best to test on multiple platforms and whenever possible work around non-portable options. In a case like `grep` it is trivial. \n\nSome common examples of non-portable code are given at\n\nhttp://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep\n\nDave",
    "created_at": "2010-11-22T17:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10240#issuecomment-104221",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Replying to [comment:9 leif]:
> Replying to [comment:8 jdemeyer]:
> > What has this to do with setting `PATH`?
> 
> Ask Oracle... ;-)
> 
> (The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)

Of course the fact the default path does not always have POSIX options is a little unfortunate, but does mean Solaris has excellent backward compatibility. A 20 years old SunOS binary will still run today on Solaris. 

I do occasionally build Sage on the 2005 edition of Solaris 10, and it works on the latest revision. 

The same can not be said for Linux, where it seems that there is a never ending battle of keeping things working as the operating systems are updated. 

* ECL does not work on Fedora 14 -  #10185
* Readline not work on the latest Arch or openSUSE #9530
* etc, etc etc.

**I've yet to see one single example of where Sage builds on an old version of Solaris, but not on a newer one.**
 
It should also be noted that Linux does not ship with POSIX commands - `ls`, `df`, `du` being 3 simple examples. But there are tons of them. 

https://www.opengroup.org/platform/single_unix_specification/uploads/40/13450/POSIX_and_Linux_Application_Compatibility_Final_-_v1.0.pdf

Like it or not, to create portable code, it is best to test on multiple platforms and whenever possible work around non-portable options. In a case like `grep` it is trivial. 

Some common examples of non-portable code are given at

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep

Dave
