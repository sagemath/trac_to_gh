# Issue 10240: Remove unportable '-q' option to grep on SAGE_ROOT/spkg/install

Issue created by migration from Trac.

Original creator: drkirkby

Original creation time: 2010-11-09 21:09:42

Assignee: GeorgSWeber

CC:  leif jhpalmieri

Although the -q option to grep is defined by POSIX, many older greps do not implement this. Even the man page of `grep` on a Linux machine says not to use -q or -s on scripts that are supposed to be portable. 

The grep in /usr/bin on Solaris does not support the option. This is done by Sun to maintain backward compatibility with older versions which did not support it. So this causes a problem. 


```
drkirkby`@`hawk:~/sage-4.6.1.alpha0$ make
spkg/pipestatus "cd spkg && ./install all 2>&1" "tee -a ../install.log"
grep: illegal option -- q
Usage: grep -hblcnsviw pattern file . . .
```


POSIX says:


```
-q
    Quiet. Nothing shall be written to the standard output, regardless of matching lines. Exit with zero status if an input line is selected.
```


so it is quite easy to work around. 

See also:

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep


---

Comment by drkirkby created at 2010-11-09 21:59:04

Revised install file, which avoids the unportable grep -q


---

Attachment

Unified diff, for review purposes only. The install file is not in a repository


---

Attachment


---

Comment by drkirkby created at 2010-11-09 22:02:28

Changing status from new to needs_review.


---

Comment by drkirkby created at 2010-11-09 22:05:44

This needs review.


---

Comment by jhpalmieri created at 2010-11-09 23:00:41

Changing type from PLEASE CHANGE to defect.


---

Comment by dimpase created at 2010-11-10 03:47:02

looks and works good.


---

Comment by dimpase created at 2010-11-10 03:47:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2010-11-11 13:02:59

Resolution: fixed


---

Comment by leif created at 2010-11-21 20:32:20

Post-mortem comment: ;-)

In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

IMHO Sage's `configure` should handle such. We're not building `gcc`, nor do we support last millenium's systems...

(Btw, `egrep` and `echo -n` aren't very portable in that sense either. If we only use the smallest subset of all systems or program versions one could think of, the code gets unreadable and harder to maintain.)

Fortunately, `sage-upgrade` won't get very large (I hope), but that's not the case for other uses of `grep -q`. Abusing `sed` is IMHO not an option (see above).


---

Comment by jdemeyer created at 2010-11-21 21:55:43

Replying to [comment:7 leif]:
> Post-mortem comment: ;-)
> 
> In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.

What has this to do with setting `PATH`?


---

Comment by leif created at 2010-11-21 22:51:12

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 leif]:
> > Post-mortem comment: ;-)
> > 
> > In general I'm not very happy with avoiding POSIX options just because some people don't set their `PATH` properly.
> 
> What has this to do with setting `PATH`?

Ask Oracle... ;-)

(The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)


---

Comment by drkirkby created at 2010-11-22 17:42:24

Replying to [comment:9 leif]:
> Replying to [comment:8 jdemeyer]:
> > What has this to do with setting `PATH`?
> 
> Ask Oracle... ;-)
> 
> (The POSIX-conformant versions aren't in the default `PATH`, for "compatibility" reasons.)

Of course the fact the default path does not always have POSIX options is a little unfortunate, but does mean Solaris has excellent backward compatibility. A 20 years old SunOS binary will still run today on Solaris. 

I do occasionally build Sage on the 2005 edition of Solaris 10, and it works on the latest revision. 

The same can not be said for Linux, where it seems that there is a never ending battle of keeping things working as the operating systems are updated. 

 * ECL does not work on Fedora 14 -  #10185
 * Readline not work on the latest Arch or openSUSE #9530
 * etc, etc etc.

*I've yet to see one single example of where Sage builds on an old version of Solaris, but not on a newer one.*
 
It should also be noted that Linux does not ship with POSIX commands - `ls`, `df`, `du` being 3 simple examples. But there are tons of them. 

https://www.opengroup.org/platform/single_unix_specification/uploads/40/13450/POSIX_and_Linux_Application_Compatibility_Final_-_v1.0.pdf

Like it or not, to create portable code, it is best to test on multiple platforms and whenever possible work around non-portable options. In a case like `grep` it is trivial. 

Some common examples of non-portable code are given at

http://www.gnu.org/software/hello/manual/autoconf/Limitations-of-Usual-Tools.html#grep

Dave
