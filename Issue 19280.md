# Issue 19280: Graphs: canonical_label() and return_graph -parameter

Issue created by migration from Trac.

Original creator: jmantysalo

Original creation time: 2015-11-04 08:26:49

CC:  dcoudert

Several problems I noticed on `generic_graph.py`:

- Indentation in docstring for `return_graph` is wrong.

- That parameter seems to have no effect when `algorithm='sage'`:


```
sage: G = Graph({10: [20]})
sage: G.canonical_label(algorithm='sage', return_graph=False)
Graph on 2 vertices
sage: G.vertices()
[10, 20]
sage: G.canonical_label(algorithm='sage', return_graph=True)
Graph on 2 vertices
sage: G.vertices()
[10, 20]
```


- I installed bliss with `sage -i` and it seems to be fine. I got normal messages from gcc and then `Successfully installed bliss-0.73`, and  `'bliss' in sage.misc.package.optional_packages()[0]` says `True`. But still


```
sage: G.canonical_label(algorithm='bliss', return_graph=True)
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
 . . . 
ImportError: You must install the 'bliss' package to run this command.
```


- Why the name of the parameter `return_graph` in this, but `inplace` in all other functions?


---

Comment by ncohen created at 2015-11-05 14:44:30

Hello !

All your remarks seem correct (and easy to fix) but I have no idea what the problem with the bliss package comes from `O_o`

Nathann


---

Comment by jmantysalo created at 2015-11-05 15:32:30

There is something strange with `bliss` installation, see https://groups.google.com/forum/#!topic/sage-devel/_1OYNuVNltM

`return_graph` is not converse of `inplace`. I guess. It is badly documented. What is the meaning of it's output? A list of pairs somehow... Try


```
G = graphs.PetersenGraph()
G.relabel(lambda x: chr(ord('a')+x))
G.canonical_label(return_graph=False)
```


And why it deletes vertex positioning contraty to `relabel`? Try for example


```
G = graphs.PetersenGraph()
G.relabel(lambda x: chr(ord('a')+x))
G.show()
G = G.canonical_label()
G.canonical_label().show()
```



---

Comment by ncohen created at 2015-11-05 15:49:43

> There is something strange with `bliss` installation, see https://groups.google.com/forum/#!topic/sage-devel/_1OYNuVNltM

Something like that happened during the last update of bliss, but Jeroen noticed it at the last minute:
http://trac.sagemath.org/ticket/19483#comment:15

> `return_graph` is not converse of `inplace`. I guess. It is badly documented. What is the meaning of it's output?

(assuming that you are talking of 'canonical_label')

`return_graph` tells whether or not you want the actual graph. Somethimes you only need the labelling, and not the whole graph.


 A list of pairs somehow... Try
> 
> {{{
> G = graphs.PetersenGraph()
> G.relabel(lambda x: chr(ord('a')+x))
> G.canonical_label(return_graph=False)
> }}}

These pairs are the edges of the relabeled graph

```
sage: Graph(G.canonical_label(return_graph=False)) == graphs.PetersenGraph().canonical_label()
True
```


Can't say that I see the point to return this instead of a `Graph` object...

> And why it deletes vertex positioning contraty to `relabel`? Try for example

Probably because the graph is built from the list of edges, instead of being built as a relabelled copy of the original graph. Why do you ask these questions like there is a mystical explanation behind? It's a bug, that's all. It just needs to be fixed.

Nathann


---

Comment by jmantysalo created at 2015-11-06 06:09:54

OK, modified the description. I do not think that forgetting vertex positions is necessarily a bug. But to remember them on `relabel()` and to forget on `canonical_label()` is.


---

Comment by jmantysalo created at 2017-10-30 11:09:14

Getting back to this old ticket... First of all I changed the check for parameters to better understand what happens. Now `algorithm='bliss'` will always raise an error if Bliss is not installed, even when the graph has multiedges and Bliss could not be used anyway.

I think that this should just compute canonical relabeling and call `.relabel()`. That would take care the problem of vertex positions.
----
New commits:


---

Comment by dcoudert created at 2017-10-30 12:45:36

It's true that this method needs significant cleaning. 
- The first line of description is not standard and could be `Return a canonical labeling of the vertices of this (di)graph `.
- In the INPUT block, the parameters could be better explained
- an OUTPUT block could be useful as the output depends on the parameters
etc.



one doctest fails because I have bliss installed. So you could do:

```
-            sage: G.canonical_label(edge_labels=True, certificate=True)
-            (Graph on 5 vertices, {0: 4, 1: 3, 2: 0, 3: 1, 4: 2})
+            sage: G.canonical_label(edge_labels=True, certificate=True, algorithm='sage')
+            (Graph on 5 vertices, {0: 4, 1: 3, 2: 0, 3: 1, 4: 2})
+            sage: G.canonical_label(edge_labels=True, certificate=True, algorithm='bliss') # optional - bliss
+            (Graph on 5 vertices, {{0: 4, 1: 3, 2: 1, 3: 0, 4: 2})
```

The last 2 lines might be placed with the examples using bliss.


---

Comment by git created at 2017-10-31 06:15:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-10-31 06:16:45

Ah, I did not notice the line `not edge_labels` I removed. Now corrected that one.

(These must also be said in `INPUT`section.)


---

Comment by git created at 2017-10-31 08:37:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-01 05:09:03

Just noticed that Bliss with `return_graph=False` returns set of edges, not a dictionary of mapping. Hence we must copy a part of `relabel`:


```
attributes_to_update = ('_pos', '_assoc', '_embedding')
for attr in attributes_to_update:
    if hasattr(self, attr) and getattr(self, attr) is not None:
        new_attr = {}
        for v,value in iteritems(getattr(self, attr)):
            new_attr[perm[v]] = value

        setattr(self, attr, new_attr)
```



---

Comment by jmantysalo created at 2017-11-01 05:29:47

Forget, I was blind when writing my last comment.

We could do something like


```
         if algorithm == 'bliss':
            vert_dict = canonical_form(self, partition, certificate=True)[1]
            return self.relabel(vert_dict, inplace=not return_graph)
```


maybe... But what the hell this function is supposed to do??? `certificate` seems a wrong word here, but at least `certificate=True` works similarly with both `algorithm='sage'` and `algorithm='bliss'`.


---

Comment by jdemeyer created at 2017-11-02 23:39:18

Just came here after the sage-devel post by Jori. Is there anything controversial here? Or were you just fishing for reviewers :-)


---

Comment by jmantysalo created at 2017-11-03 04:48:56

Replying to [comment:13 jdemeyer]:
> Just came here after the sage-devel post by Jori. Is there anything controversial here?

I guess not, but not sure, so I write a short message to sage-devel.

> Or were you just fishing for reviewers :-)

Not really. It would be more helpful to get comments about what this should do. `certificate` vs. `return_graph` - whaat?


---

Comment by git created at 2017-11-03 05:45:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-03 05:46:17

Some modifications to docstring. Now also vertex positions are preserved even when Bliss is used.

Must add many tests to this.


---

Comment by git created at 2017-11-03 08:28:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-03 08:35:11

Currently Bliss have no verbose mode, and the docstring of `search_tree` says "verbosity â€“ currently ignored". Hence I just removed the parameter.

I changed docstring and allowed `return_graph=False` only when `bliss=True` is explicitly said.

Docstring modified.

Now this needs comments.


---

Comment by dcoudert created at 2017-11-03 11:03:20

In `bliss.pyx`:
- `canonical graph of G. Otherwise, it returns its set of edges.` -> `canonical graph of `G`. Otherwise, it returns its set of edges.`

In `generic_graph.py`:
- unfortunately you can not remove parameter `verbosity` like that, although it is `currently ignored`. A deprecation warning is needed.
- In the documentation, you must use ```True``, ``False```

I don't see any place where the `certificate` parameter is used, but it might be useful to some users, no ?

put the ticket to needs review when ready.


---

Comment by git created at 2017-11-03 18:36:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-03 18:38:05

Found a bug in my code. Deprecation and your suggestions done.

I also tried to make better examples. Still lacking an example of partition, also I will check that the parameter is really used.


---

Comment by git created at 2017-11-04 16:59:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-04 17:01:35

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2017-11-04 17:01:35

Maybe these changes should be integrated to Sage now, and get back to this later? One parameter is still missing examples and documentation, but that can be done later.


---

Comment by dcoudert created at 2017-11-05 08:42:02

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2017-11-05 08:42:02

In `bliss.pyx`, you changed some ```G``` and `G` to ``G``, but this last form is not well taken into account when building the doc. You must also use `r"""`. You should also do the same in `generic_graph.py`.

In the toc, you added `Return the canonically labeled graph.` but this is different from the sentence in the method. I suggest to use only `Return the canonical graph`.

You don't want to use [canonization](https://en.wikipedia.org/wiki/Canonization) but [canonicalization](https://en.wikipedia.org/wiki/Canonicalization), right ? ;)


Some comments on the parameters

```
-        - ``certificate`` -- if ``True``, a dictionary mapping from the
-          (di)graph to its canonical label will be given.
+        - ``certificate`` -- boolean (default: ``False``). When set to ``True``,
+          a dictionary mapping from the vertices of the (di)graph to its canonical
+          label will also be returned.
```



```
-        - ``edge_labels`` -- default ``False``, otherwise allows
-          only permutations respecting edge labels.
+        - ``edge_labels`` -- boolean (default: ``False``). When set to ``True``,
+          allows only permutations respecting edge labels.
```



```
-        - ``algorithm``, a string -- the algorithm to use; currently available:
+        - ``algorithm`` -- a string (default: ``None``). The algorithm to use;
+          currently available:
```



```
-        - ``return_graph`` -- if set, instead of graph return the list of
-          edges of the the canonical graph; only available when Bliss is
-          explicitly set as algorithm
+        - ``return_graph`` -- boolean (default: ``True``). When set to ``False``,
+          returns the list of edges of the the canonical graph instead of the
+          canonical graph; only available when ``'bliss'`` is explicitly set as
+          algorithm.
```


use `bliss` and not `Bliss` to avoid confusion.

`return_graph='false'` -> `return_graph=False`

`graph with multiedges` -> `graph with multiple edges` to be consistent with the names of methods (ok, not with the constructor parameter).


Failing example in `generic_graph.py`:

```
Failed example:
    g
Expected:
    Graph on 6 vertices
Got:
    Grid Graph for [2, 3]: Graph on 6 vertices
```


For parameter `partition`, I tried the following:

```
sage: G = graphs.PetersenGraph()
sage: C = G.coloring()
sage: C
[[1, 3, 5, 9], [0, 2, 6], [4, 7, 8]]
sage: C[::-1]
[[4, 7, 8], [0, 2, 6], [1, 3, 5, 9]]
sage: A = G.canonical_label(partition=C, algorithm='bliss')
sage: B = G.canonical_label(partition=C[::-1], algorithm='bliss')
sage: A == B
False
sage: B = G.canonical_label(partition=[C[0], C[2], C[1]], algorithm='bliss')
sage: A == B
False
sage: A = G.canonical_label(partition=C, algorithm='bliss')
sage: B = G.canonical_label(partition=[C[0], C[1], C[2][::-1]], algorithm='bliss')
sage: A == B
True
```

By the way, it's boring to type `algorithm='bliss'` when bliss is your default algorithm...


---

Comment by git created at 2017-11-05 13:45:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-05 13:58:25

Replying to [comment:25 dcoudert]:

Thanks for comments. I did most of them, but some comments:

> In `bliss.pyx`, you changed some ```G``` and `G` to ``G``, but this last form is not well taken into account when building the doc.

This is sometimes hard to decide. I guess we should use ``x`` only when referring to mathematical definition without any connection to the specific function parameters we are documenting.

> In the toc, you added `Return the canonically labeled graph.` but this is different from the sentence in the method. I suggest to use only `Return the canonical graph`.

I changed that.

In general I try to write a one-line description of the function to TOC when possible. For example `is_uniform` is explained as "Return True if all congruences of the lattice consists of equal-sized blocks." in TOC, but the function starts with "Return True if the lattice is uniform - -" and then explains what is uniform.

> You don't want to use [canonization](https://en.wikipedia.org/wiki/Canonization) but [canonicalization](https://en.wikipedia.org/wiki/Canonicalization), right ? ;)

But then there is [Graph canonization](https://en.wikipedia.org/wiki/Graph_canonization), so what to do?

> For parameter `partition`, I tried the following:

For that we must first define what means to be "canonical" but still "restrict permutations". That's why I suggest postponing that to another ticket.

> By the way, it's boring to type `algorithm='bliss'` when bliss is your default algorithm...

True, but there is no other choise for most examples.

E: I am not sure if the function should keep the graph's name or not. However, now it is consistent with `relabel()`.


---

Comment by dcoudert created at 2017-11-05 14:22:55

> In general I try to write a one-line description of the function to TOC when possible. For example `is_uniform` is explained as "Return True if all congruences of the lattice consists of equal-sized blocks." in TOC, but the function starts with "Return True if the lattice is uniform - -" and then explains what is uniform.
 
Agreed. A significant effort remains to be done for cleaning the graph module. 

  

> > You don't want to use [canonization](https://en.wikipedia.org/wiki/Canonization) but [canonicalization](https://en.wikipedia.org/wiki/Canonicalization), right ? ;)
> 
> But then there is [Graph canonization](https://en.wikipedia.org/wiki/Graph_canonization), so what to do?
 
You are right. I did not see that. So let's use graph canonization.

Could you add a link to the wikipedia page ?

 

> > For parameter `partition`, I tried the following:
> 
> For that we must first define what means to be "canonical" but still "restrict permutations". That's why I suggest postponing that to another ticket.

Agreed. It's already much better

 

> E: I am not sure if the function should keep the graph's name or not. However, now it is consistent with `relabel()`.

I have no opinion on that.


---

Comment by git created at 2017-11-05 17:29:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-11-05 17:29:46

Replying to [comment:28 dcoudert]:

> Could you add a link to the wikipedia page ?

Good idea. Done.


---

Comment by jmantysalo created at 2017-11-05 17:29:46

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2017-11-05 17:58:33

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2017-11-05 17:58:33

Good. The doc displays nicely now (I like the \cong stuff).


---

Comment by vbraun created at 2017-11-08 19:24:31

Resolution: fixed
