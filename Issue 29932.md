# Issue 29932: FiniteRankFreeModule needs __classcall__

Issue created by migration from https://trac.sagemath.org/ticket/30169

Original creator: mkoeppe

Original creation time: 2020-07-18 16:59:29

CC:  egourgoulhon tscrim @mjungmath

... to normalize init arguments for `UniqueRepresentation`.


```
sage: FiniteRankFreeModule(QQ, 3) is FiniteRankFreeModule(QQ, 3)
True
sage: FiniteRankFreeModule(QQ, 3) is FiniteRankFreeModule(QQ, 3, name=None)
False
```



---

Comment by mkoeppe created at 2020-07-21 16:50:17

I am not sure about the change I made in the first commit. Surely the category should depend on the category of the underlying free module, but I suspect some construction functor needs to come into play. 
----
New commits:


---

Comment by mkoeppe created at 2020-07-21 16:50:17

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-07-24 07:21:22

You are getting a lot of doctest failures because the `FiniteRankFreeModule.__init__` now explicitly requires all 7 arguments from its subclasses. So I would keep the default parameters.


---

Comment by git created at 2020-07-24 23:57:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-26 23:05:36

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-07-27 00:38:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-27 00:38:59

Let's see if the bot likes this version better


---

Comment by mkoeppe created at 2020-07-27 00:38:59

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-27 01:50:39

There are also some other unique representation issues in these classes.

```
sage: M = FiniteRankFreeModule(ZZ, 3, name='M')
sage: M is M.exterior_power(1)
True
sage: M.dual() is M.dual_exterior_power(1)
True
sage: M.dual() is M.tensor_module(0, 1)
False
```

If I'm not mistaken, they should all be the same


---

Comment by tscrim created at 2020-07-27 03:46:30

Since this fixes the problem with the ticket description, I would be willing to set a positive review. However, I suspect there might be some test failures given the latest working patchbot report. So I want to wait for a working patchbot report.

I am not convinced they should be the same because something in the tensor space should not be the same thing, even though they are isomorphic. The user might expect certain features and semantics that would be different if `M.tensor_module(0, 1)` does not return a `TensorFreeModule`.


---

Comment by mkoeppe created at 2020-07-27 04:07:03

Replying to [comment:9 tscrim]:
> I am not convinced they should be the same because something in the tensor space should not be the same thing, even though they are isomorphic. The user might expect certain features and semantics that would be different if `M.tensor_module(0, 1)` does not return a `TensorFreeModule`.

Note that without "dual", the three are identified:

```
sage: M is M.tensor_module(1, 0)
True
```



---

Comment by mkoeppe created at 2020-07-27 04:13:10

Replying to [comment:2 mkoeppe]:
> I am not sure about the change I made in the first commit. Surely the category should depend on the category of the underlying free module, but I suspect some construction functor needs to come into play. 

Working on a version that improves this bit.


---

Comment by git created at 2020-07-27 04:31:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-27 04:40:37

Here I am running into the following problem `TensorProducts` seems to forget finite dimension...

```
sage: Modules(ZZ).FiniteDimensional().TensorProducts()
Category of tensor products of modules over Integer Ring
sage: Modules(ZZ).FiniteDimensional().TensorProducts().FiniteDimensional()
Category of finite dimensional tensor products of modules over Integer Ring
```

How to fix?


---

Comment by git created at 2020-07-27 05:17:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-27 23:00:00

The `TensorProducts` category needs to know it is finite dimensional (axioms do not naturally commute with functorial constructions; as they should not), so it needs a

```python
    class TensorProducts(TensorProductsCategory):
        def extra_super_categories(self):
            return [self.base_category()]
```

See `modules_with_basis.py`.


---

Comment by mkoeppe created at 2020-07-27 23:38:41

Thank you! I'll work on this


---

Comment by mkoeppe created at 2020-07-28 00:07:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-07-28 00:30:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-28 00:31:22

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-07-28 01:37:03

The `extra_super_categories` needs a doctest, but other than that (and a green patchbot), LGTM. (If I really wanted to haggle, I would say the one-line descriptions should end in periods/full-stops.)


---

Comment by git created at 2020-07-28 01:57:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-28 02:02:16

Getting closer to getting the categories right. `ExtPowerFreeModule` is now a quotient.
What's missing next is `DualObjects` of a module


---

Comment by git created at 2020-07-28 02:13:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-28 02:15:17

Replying to [comment:20 tscrim]:
> The `extra_super_categories` needs a doctest

Done, but I noticed that it fails for QQ:

```
   sage: Modules(QQ).FiniteDimensional().TensorProducts().extra_super_categories()
   AttributeError: 'JoinCategory_with_category' object has no attribute 'extra_super_categories'
```

Do I need to duplicate all of this for `VectorSpaces`?


---

Comment by git created at 2020-07-28 02:19:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-28 18:36:56

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2020-07-29 01:13:35

Replying to [comment:24 mkoeppe]:
> Replying to [comment:20 tscrim]:
> > The `extra_super_categories` needs a doctest
> 
> Done, but I noticed that it fails for QQ:
> {{{
>    sage: Modules(QQ).FiniteDimensional().TensorProducts().extra_super_categories()
>    AttributeError: 'JoinCategory_with_category' object has no attribute 'extra_super_categories'
> }}}
> Do I need to duplicate all of this for `VectorSpaces`?
> 

Unfortunately...


---

Comment by mkoeppe created at 2020-07-30 03:10:26

I'll work on this in #30252.


---

Comment by git created at 2020-07-30 03:21:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-07-30 03:22:16

I've reduced to the branch to take care only of what is promised in the ticket description. I'll take care of the other things discussed in independent tickets.


---

Comment by mkoeppe created at 2020-07-30 03:22:16

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-07-30 04:30:53

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-07-30 04:30:53

Okay, LGTM. (Assuming the patchbot will be green since it came back green before.)


---

Comment by mkoeppe created at 2020-07-30 05:01:34

Thanks!


---

Comment by vbraun created at 2020-08-07 19:07:33

Resolution: fixed
