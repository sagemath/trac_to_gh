# Issue 13271: Some clean up of R spkg

Issue created by migration from https://trac.sagemath.org/ticket/13443

Original creator: jdemeyer

Original creation time: 2012-09-10 13:18:44

Assignee: tbd

CC:  kcrisman

Clean up the R spkg, also proof-of-concept for #13348.


---

Comment by jdemeyer created at 2012-09-10 13:51:27

Changing keywords from "" to "r-project spkg".


---

Comment by jdemeyer created at 2012-09-10 15:32:33

Diff for the R spkg. For reference / review only.


---

Attachment


---

Comment by jdemeyer created at 2012-09-10 15:33:09

Changing status from new to needs_review.


---

Comment by kcrisman created at 2012-09-18 12:55:16

Okay, the diff looks okay to this somewhat untrained eye.  A few questions that are doubtless not that important.
 * I still get a lot of "make -jN disabled setting jobserver mode" and the like - but it seems like it's obeying the j.  ?
 * I don't see the extra C flags that #13348 supposedly adds.  `gcc -std=gnu99 -I. -I. -I../../../src/include -I../../../src/include  -DHAVE_CONFIG_H   -fopenmp -fpic  -g -O2  -fvisibility=hidden -c pcre_xclass.c -o pcre_xclass.o` but probably I don't understand this.  

I had trouble on sage.math.  It installs, but:

```

installing translations:
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/en/LC_MESSAGES
  en
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/en_GB/LC_MESSAGES
  en_GB
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/es/LC_MESSAGES
  es
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/fr/LC_MESSAGES
  fr
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/de/LC_MESSAGES
  de
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/it/LC_MESSAGES
  it
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/ja/LC_MESSAGES
  ja
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/ko/LC_MESSAGES
  ko
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/nn/LC_MESSAGES
  nn
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/pt_BR/LC_MESSAGES
  pt_BR
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/ru/LC_MESSAGES
  ru
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/tr/LC_MESSAGES
  tr
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/zh_CN/LC_MESSAGES
  zh_CN
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/zh_TW/LC_MESSAGES
  zh_TW
mkdir -p -- /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/local/lib/R/share/locale/en@quot/LC_MESSAGES
  en@quot
make[1]: Leaving directory `/scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/spkg/build/r-2.14.0.p6/src/po'

real	9m10.329s
user	13m9.990s
sys	1m7.740s
Successfully installed r-2.14.0.p6
cat: /scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/VERSION.txt: No such file or directory
Deleting temporary build directory
/scratch/kcrisman/sage-5.4.beta1-sage.math.washington.edu-x86_64-Linux/spkg/build/r-2.14.0.p6
Making Python scripts relocatable...
Finished installing r-2.14.0.p6.spkg
```

What is up with that `cat` error message?


---

Comment by jdemeyer created at 2012-09-18 13:48:19

Replying to [comment:4 kcrisman]:
> What is up with that `cat` error message?
That's a bug fixed by #13457.  bdisted distributions were missing `VERSION.txt`.


---

Comment by jdemeyer created at 2012-09-18 13:59:13

Replying to [comment:4 kcrisman]:
>  * I still get a lot of "make -jN disabled setting jobserver mode" and the like - but it seems like it's obeying the j.  ?
I guess you mean

```
warning: -jN forced in submake: disabling jobserver mode.
```


Anyway, that's really a bug in the Sage documentation:

```
MAKE="make -j8" make
```

is *not* the correct way to do things, one should use `MAKEFLAGS` instead (similar to the difference between `CC` and `CFLAGS`).  There is a work-around for this "mistake" when compiling using `spkg/install` (e.g. when issuing `make` from `SAGE_ROOT`), but not when installing using `./sage -i`.

In any case, it has nothing to do with this specific package.


---

Comment by jdemeyer created at 2012-09-18 14:31:30

Replying to [comment:4 kcrisman]:
>  * I don't see the extra C flags that #13348 supposedly adds.  `gcc -std=gnu99 -I. -I. -I../../../src/include -I../../../src/include  -DHAVE_CONFIG_H   -fopenmp -fpic  -g -O2  -fvisibility=hidden -c pcre_xclass.c -o pcre_xclass.o` but probably I don't understand this.  
Exactly, these are implicit options.  It's similar to a hypothetical `-I/usr/include` option.  

The compiler always looks for include files in `/usr/include`, so you never need to add `-I/usr/include`.  With #13348, `$SAGE_ROOT/local/include` becomes an automatic directory for includes, just like `/usr/include` already is.


---

Comment by kcrisman created at 2012-09-18 15:31:09

Thanks for clarifying these things.  It all seems to work on Linux and (new) Mac, relevant tests and `SAGE_CHECK` pass.  I also tried some R stuff and it seems to be working.

I'm still a little uncomfortable giving final positive review just because of the big changes in the spkg-install, but it certainly all looks ok.  Maybe someone else can just make sure they like the syntax; R itself seems to be fine, and it looks like all relevant flags are still passed in the right ways.


---

Comment by jhpalmieri created at 2012-09-18 20:53:04

The changes to spkg-install look fine to me.


---

Comment by jhpalmieri created at 2012-09-18 20:53:04

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2012-09-19 00:20:12

Thanks.


---

Comment by jdemeyer created at 2012-09-19 06:35:03

Resolution: fixed


---

Comment by leif created at 2013-06-06 03:00:44

This again breaks _linking_ against *Sage's* `libreadline`;  R's `configure` doesn't support specifying a (non-standard) location for readline, only `[--with-readline=]yes` (default) and `no`, where everything but `no` is interpreted as `yes`.


---

Comment by leif created at 2013-06-09 22:23:43

Replying to [comment:12 leif]:
> This again breaks _linking_ against *Sage's* `libreadline`;  R's `configure` doesn't support specifying a (non-standard) location for readline, only `[--with-readline=]yes` (default) and `no`, where everything but `no` is interpreted as `yes`.

See #14709 for the general problem, and #14706 where R is supposed to get upgraded (which alone doesn't fix the issue; we'd have to revert the changes to R's `spkg-install`, or patch R's `configure` accordingly).
