# Issue 11507: Allow different directory for server_pool communication

archive/issues_011507.json:
```json
{
    "body": "Assignee: jason, mpatel, was\n\nIn a remote notebook setup using ``server_pool``, all communication between the main Sage process and the workers goes through ``/tmp``.  I suggest to introduce an environment variable ``SAGENB_TMPDIR`` (with fallback to ``TMPDIR``) to configure this.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11679\n\n",
    "created_at": "2011-08-11T13:19:37Z",
    "labels": [
        "notebook",
        "major",
        "enhancement"
    ],
    "title": "Allow different directory for server_pool communication",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11507",
    "user": "jdemeyer"
}
```
Assignee: jason, mpatel, was

In a remote notebook setup using ``server_pool``, all communication between the main Sage process and the workers goes through ``/tmp``.  I suggest to introduce an environment variable ``SAGENB_TMPDIR`` (with fallback to ``TMPDIR``) to configure this.

Issue created by migration from https://trac.sagemath.org/ticket/11679





---

archive/issue_comments_128784.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-11T15:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128784",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128785.json:
```json
{
    "body": "shouldn't we use python's tempfile.gettempdir() as a fallback and never have hardcoded directories.\n\nAlso seems there are changes to the ulimit docs? Were they wrong?\n\nOther than that the patch seems ok.",
    "created_at": "2011-08-16T15:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128785",
    "user": "rkirov"
}
```

shouldn't we use python's tempfile.gettempdir() as a fallback and never have hardcoded directories.

Also seems there are changes to the ulimit docs? Were they wrong?

Other than that the patch seems ok.



---

archive/issue_comments_128786.json:
```json
{
    "body": "Replying to [comment:2 rkirov]:\n> shouldn't we use python's tempfile.gettempdir() as a fallback and never have hardcoded directories.\nI will look into that.\n\n> Also seems there are changes to the ulimit docs? Were they wrong?\nMaybe not technically wrong but at least I think I clarified it a lot.  In particular, the ``ulimit`` options which are documented are the only ones which actually work, while the documentation might suggest that all ``ulimit`` options from ``bash`` or whathever work.",
    "created_at": "2011-08-16T15:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128786",
    "user": "jdemeyer"
}
```

Replying to [comment:2 rkirov]:
> shouldn't we use python's tempfile.gettempdir() as a fallback and never have hardcoded directories.
I will look into that.

> Also seems there are changes to the ulimit docs? Were they wrong?
Maybe not technically wrong but at least I think I clarified it a lot.  In particular, the ``ulimit`` options which are documented are the only ones which actually work, while the documentation might suggest that all ``ulimit`` options from ``bash`` or whathever work.



---

archive/issue_comments_128787.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-16T15:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128787",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128788.json:
```json
{
    "body": "I'm concerned -- I think this would first time any environment variable is used to configure the notebook.   I think there is a much better and more standard way to implement this feature, which is unfortunately more work and requires knowing a lot more about how the notebook works.  However, it is better in the longrun, since it will be much less confusing to admins and easier to maintain. \n  \nFor the notebook, implementing the following would be much more natural:\n\n```\n   notebook(local_directory = '/path/you/want', ...)\n```\n\n\nThis would involve modifying the notebook.py file by editing \"new_worksheet_process\" and run_notebook.py, etc.   Also, this new option would be part of the server configuration database (currently a pickle, but someday a SQL table), so it would automatically be something that can be edited graphically by the notebook admin from the notebook configuration settings webpage. \n\nSo a big +1 to having this feature, but -1 to using environment variables in the longrun to implement it, since we already have a standard system for configuring the server, and it isn't via environment variables.  \n\nThoughts?",
    "created_at": "2011-08-16T17:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128788",
    "user": "was"
}
```

I'm concerned -- I think this would first time any environment variable is used to configure the notebook.   I think there is a much better and more standard way to implement this feature, which is unfortunately more work and requires knowing a lot more about how the notebook works.  However, it is better in the longrun, since it will be much less confusing to admins and easier to maintain. 
  
For the notebook, implementing the following would be much more natural:

```
   notebook(local_directory = '/path/you/want', ...)
```


This would involve modifying the notebook.py file by editing "new_worksheet_process" and run_notebook.py, etc.   Also, this new option would be part of the server configuration database (currently a pickle, but someday a SQL table), so it would automatically be something that can be edited graphically by the notebook admin from the notebook configuration settings webpage. 

So a big +1 to having this feature, but -1 to using environment variables in the longrun to implement it, since we already have a standard system for configuring the server, and it isn't via environment variables.  

Thoughts?



---

archive/issue_comments_128789.json:
```json
{
    "body": "Replying to [comment:4 was]:\n> I'm concerned -- I think this would first time any environment variable is used to configure the notebook.   I think there is a much better and more standard way to implement this feature, which is unfortunately more work and requires knowing a lot more about how the notebook works.  However, it is better in the longrun, since it will be much less confusing to admins and easier to maintain. \n>   \n> For the notebook, implementing the following would be much more natural:\n> {{{\n>    notebook(local_directory = '/path/you/want', ...)\n> }}}\n> \n> This would involve modifying the notebook.py file by editing \"new_worksheet_process\" and run_notebook.py, etc.   Also, this new option would be part of the server configuration database (currently a pickle, but someday a SQL table), so it would automatically be something that can be edited graphically by the notebook admin from the notebook configuration settings webpage. \n> \n> So a big +1 to having this feature, but -1 to using environment variables in the longrun to implement it, since we already have a standard system for configuring the server, and it isn't via environment variables.  \n> \n> Thoughts?\n\nWell, using environment variables for temporary directories is not unusual, see the fairly standard use of `TPMDIR`.\n\nOn the other hand, you are right that it would be a new way to configure the notebook.  So my answer is \"Yes, you are probably right but I'm not going to implement it\".  I do think this is a very useful feature.",
    "created_at": "2011-08-16T17:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128789",
    "user": "jdemeyer"
}
```

Replying to [comment:4 was]:
> I'm concerned -- I think this would first time any environment variable is used to configure the notebook.   I think there is a much better and more standard way to implement this feature, which is unfortunately more work and requires knowing a lot more about how the notebook works.  However, it is better in the longrun, since it will be much less confusing to admins and easier to maintain. 
>   
> For the notebook, implementing the following would be much more natural:
> {{{
>    notebook(local_directory = '/path/you/want', ...)
> }}}
> 
> This would involve modifying the notebook.py file by editing "new_worksheet_process" and run_notebook.py, etc.   Also, this new option would be part of the server configuration database (currently a pickle, but someday a SQL table), so it would automatically be something that can be edited graphically by the notebook admin from the notebook configuration settings webpage. 
> 
> So a big +1 to having this feature, but -1 to using environment variables in the longrun to implement it, since we already have a standard system for configuring the server, and it isn't via environment variables.  
> 
> Thoughts?

Well, using environment variables for temporary directories is not unusual, see the fairly standard use of `TPMDIR`.

On the other hand, you are right that it would be a new way to configure the notebook.  So my answer is "Yes, you are probably right but I'm not going to implement it".  I do think this is a very useful feature.



---

archive/issue_comments_128790.json:
```json
{
    "body": "> On the other hand, you are right that it would be a new way to configure\n>  the notebook. So my answer is \"Yes, you are probably right but I'm not going \n> to implement it\". I do think this is a very useful feature.\n\nI very much agree with your answer above.   It would make sense for me, or Rado, or Mike to \"properly\" implement this feature, and you can spend your valuable time on release management (which you are doing a fantastic job on).",
    "created_at": "2011-08-16T18:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128790",
    "user": "was"
}
```

> On the other hand, you are right that it would be a new way to configure
>  the notebook. So my answer is "Yes, you are probably right but I'm not going 
> to implement it". I do think this is a very useful feature.

I very much agree with your answer above.   It would make sense for me, or Rado, or Mike to "properly" implement this feature, and you can spend your valuable time on release management (which you are doing a fantastic job on).



---

archive/issue_comments_128791.json:
```json
{
    "body": "Attachment [11679.patch](tarball://root/attachments/some-uuid/ticket11679/11679.patch) by jdemeyer created at 2013-12-11 10:01:00",
    "created_at": "2013-12-11T10:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128791",
    "user": "jdemeyer"
}
```

Attachment [11679.patch](tarball://root/attachments/some-uuid/ticket11679/11679.patch) by jdemeyer created at 2013-12-11 10:01:00



---

archive/issue_comments_128792.json:
```json
{
    "body": "This was reported at https://github.com/sagemath/sagenb/issues/32 a while ago.",
    "created_at": "2014-10-22T16:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128792",
    "user": "kcrisman"
}
```

This was reported at https://github.com/sagemath/sagenb/issues/32 a while ago.



---

archive/issue_comments_128793.json:
```json
{
    "body": "Unfortunately not yet fixed. 3 years ago William wrote in [comment:4] that my patch was no good. Given that there hasn't surfaced a better fix and given that I don't know much about the notebook, wouldn't it be possible to just apply my patch?\n\nI have been using it in a production environment at my university and it hasn't broken anything.",
    "created_at": "2014-10-23T07:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128793",
    "user": "jdemeyer"
}
```

Unfortunately not yet fixed. 3 years ago William wrote in [comment:4] that my patch was no good. Given that there hasn't surfaced a better fix and given that I don't know much about the notebook, wouldn't it be possible to just apply my patch?

I have been using it in a production environment at my university and it hasn't broken anything.



---

archive/issue_comments_128794.json:
```json
{
    "body": "> Unfortunately not yet fixed. 3 years ago William wrote in [comment:4] that my patch was no good. Given that there hasn't surfaced a better fix and given that I don't know much about the notebook, wouldn't it be possible to just apply my patch?\n\nSure, we can try that.  My previous comment was mostly just to keep tabs on things so we don't lose issues.   I may take a look, but I don't know much about the actual communication part of web apps.\n\nBy the way, Rado's comment refers to a previous version of this patch which had some doc on `ulimit`.   I don't see it in this version; if you have some info on that it would be helpful to add to the sagenb doc.",
    "created_at": "2014-10-23T14:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128794",
    "user": "kcrisman"
}
```

> Unfortunately not yet fixed. 3 years ago William wrote in [comment:4] that my patch was no good. Given that there hasn't surfaced a better fix and given that I don't know much about the notebook, wouldn't it be possible to just apply my patch?

Sure, we can try that.  My previous comment was mostly just to keep tabs on things so we don't lose issues.   I may take a look, but I don't know much about the actual communication part of web apps.

By the way, Rado's comment refers to a previous version of this patch which had some doc on `ulimit`.   I don't see it in this version; if you have some info on that it would be helpful to add to the sagenb doc.



---

archive/issue_comments_128795.json:
```json
{
    "body": "I think the `ulimit` thing refered to an old version of this patch. I don't remember if that was merged as part of a different ticket.",
    "created_at": "2014-10-30T16:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128795",
    "user": "jdemeyer"
}
```

I think the `ulimit` thing refered to an old version of this patch. I don't remember if that was merged as part of a different ticket.



---

archive/issue_comments_128796.json:
```json
{
    "body": "I finally looked at this patch.  I really don't see how it can harm anything, though I will point out that on Macs at least this would mean a change of folder.\n\n```\n$ echo $TMPDIR\n/var/folders/k8/nj0z1bkd11dcs1v5hbh_tknc92p43w/T/\n```\n\nCan you make a branch upstream so I can review it?  I know you said somewhere that would make things easier for you, though I don't recall where...",
    "created_at": "2015-01-06T15:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128796",
    "user": "kcrisman"
}
```

I finally looked at this patch.  I really don't see how it can harm anything, though I will point out that on Macs at least this would mean a change of folder.

```
$ echo $TMPDIR
/var/folders/k8/nj0z1bkd11dcs1v5hbh_tknc92p43w/T/
```

Can you make a branch upstream so I can review it?  I know you said somewhere that would make things easier for you, though I don't recall where...



---

archive/issue_comments_128797.json:
```json
{
    "body": "I wonder if the backup to `$TMPDIR` is okay...\n\n```\n$ stat $TMPDIR\n234881026 42865026 drwx------ ...\n$ stat /tmp\n234881026 33176 lrwxr-xr-x ...\n```\n\nWould having fewer permissions cause problems for processes?  I know that is sort of the point, but I don't know what minimum permissions are needed.\n\nBy the way, you can just reference https://github.com/sagemath/sagenb/issues/32 in said pull request.",
    "created_at": "2015-01-06T15:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128797",
    "user": "kcrisman"
}
```

I wonder if the backup to `$TMPDIR` is okay...

```
$ stat $TMPDIR
234881026 42865026 drwx------ ...
$ stat /tmp
234881026 33176 lrwxr-xr-x ...
```

Would having fewer permissions cause problems for processes?  I know that is sort of the point, but I don't know what minimum permissions are needed.

By the way, you can just reference https://github.com/sagemath/sagenb/issues/32 in said pull request.



---

archive/issue_comments_128798.json:
```json
{
    "body": "Replying to [comment:16 kcrisman]:\n> Would having fewer permissions cause problems for processes?\nYes, but only when running a multi-user sagenb server using the `server_pool` option. Given that such a setup requires some non-trivial configuration anyway, I don't see this as a problem.",
    "created_at": "2015-01-06T16:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128798",
    "user": "jdemeyer"
}
```

Replying to [comment:16 kcrisman]:
> Would having fewer permissions cause problems for processes?
Yes, but only when running a multi-user sagenb server using the `server_pool` option. Given that such a setup requires some non-trivial configuration anyway, I don't see this as a problem.



---

archive/issue_comments_128799.json:
```json
{
    "body": "Agreed.",
    "created_at": "2015-01-06T16:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128799",
    "user": "kcrisman"
}
```

Agreed.



---

archive/issue_comments_128800.json:
```json
{
    "body": "Just need an upstream package now, which will come soon for #12212 in any case.",
    "created_at": "2015-01-09T01:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128800",
    "user": "kcrisman"
}
```

Just need an upstream package now, which will come soon for #12212 in any case.



---

archive/issue_comments_128801.json:
```json
{
    "body": "This has been merged, n'est pas?",
    "created_at": "2015-02-12T15:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128801",
    "user": "kcrisman"
}
```

This has been merged, n'est pas?



---

archive/issue_comments_128802.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-02-12T15:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128802",
    "user": "kcrisman"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_128803.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-12T21:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11507",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11507#issuecomment-128803",
    "user": "vbraun"
}
```

Resolution: fixed
