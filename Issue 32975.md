# Issue 32975: Karatsuba multiplication of matrices:  failed test

Issue created by migration from https://trac.sagemath.org/ticket/33212

Original creator: @GMS103

Original creation time: 2022-01-21 20:20:04

CC:  malb

This is for [SageMath](SageMath) version 9.5.rc3 built on an M1 Mac with macOS 12.1 (Monterey).

One test in

```
src/sage/matrix/matrix_gf2e_dense.pyx
```

seems to fail consistently, namely

```
sage: K.<a> = GF(2^n)
sage: A = random_matrix(K, 50, 50)
sage: B = random_matrix(K, 50, 50)
sage: A._multiply_karatsuba(B) == A._multiply_classical(B)
```

as soon as `n > 2`.
In fact, `A` and `B` appear to be completely different.

I do not know how to deal with this, but I am available to test.


---

Comment by mkoeppe created at 2022-01-21 23:09:56

Changing priority from major to critical.


---

Comment by malb created at 2022-01-22 11:47:25

Works on my x64 Linux. I assume the underlying reason is that M4RIE relies on some undefined behaviour that works "as expected" on x86-ish architectures? Can you compile M4RIE with all warnings on and then run the tests? Maybe it's already triggered there?


---

Comment by @GMS103 created at 2022-01-22 21:47:33

I have been able to compile M4RI and M4RIE (the former is needed for the latter).

However, all checks fail for M4RIE.

See

https://bitbucket.org/malb/m4ri/issues/83/trying-to-compile-on-apple-m1

and

https://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1

HTH


---

Comment by malb created at 2022-01-24 19:46:46

So it seems to be an issue with M4RIE but not sure how to debug this. I've asked on sage-devel if others can reproduce it (I assume the answer is "yes", but still).


---

Comment by @GMS103 created at 2022-03-20 22:11:56

M4RIE works correctly on an Apple Silicon M1 Mac under macOS 12.3 (Monterey) with Xcode 13.3 (see https://bitbucket.org/malb/m4rie/issues/23/trying-to-compile-on-apple-m1):  the test in this ticket succeeds.

The bad news is that Xcode 13.3 is not available for macOS 11.6.5 (Monterey), the last available version being Xcode 13.2.1, which fails as indicated above.


---

Comment by malb created at 2022-03-26 10:21:44

Thanks for tracking this down. We can compile with a lower optimisation level on those machines with a buggy compiler?


---

Comment by @GMS103 created at 2022-03-26 11:49:38

It should be possible, but I do not know how to do it when making [SageMath](SageMath).
