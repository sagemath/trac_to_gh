# Issue 17346: Clean up free module elements

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-01-05 13:26:20

General clean-up using modern Cython code in preparation for follow-up tickets.


---

Comment by git created at 2015-01-21 12:30:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-01-21 12:30:28

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2015-01-23 10:00:50

Changing status from needs_review to needs_info.


---

Comment by mmezzarobba created at 2015-01-23 10:00:50

`_sparse_dot_product()` (which you didn't touch) appears not to be used anywhere and could probably be deleted.

By the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?

Otherwise lgtm.


---

Comment by jdemeyer created at 2015-01-23 20:25:26

Replying to [comment:5 mmezzarobba]:
> By the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?
Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.

I'm actually preparing a commit which refactors dot products, since the logic was a bit strange. With the new commit (still testing), there will be a `cpdef` method `_dot_product_` for equal parents and `_dot_product_coerce_` for parents which might be different.


---

Comment by git created at 2015-01-23 21:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-01-23 21:36:45

I also merged #10779 to avoid a small merge conflict. The only relevant new commit is


---

Comment by jdemeyer created at 2015-01-23 21:36:45

Changing status from needs_info to needs_review.


---

Comment by mmezzarobba created at 2015-01-24 11:11:24

Replying to [comment:6 jdemeyer]:
> Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.

Fine. (I was not sure that it would be faster...)

Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`. Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.

Also, I think we can do two additional simplifications related to `dot_product`:

```
diff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx
index b2ff48a..a4cf07c 100644
--- a/src/sage/matrix/matrix_generic_sparse.pyx
+++ b/src/sage/matrix/matrix_generic_sparse.pyx
`@``@` -495,17 +495,6 `@``@` def Matrix_sparse_from_rows(X):
     return M(entries, coerce=False, copy=False)
 
 
-## def _sparse_dot_product(v, w):
-##     """
-##     INPUT:
-##         v and w are dictionaries with integer keys.
-##     """
-##     x = set(v.keys()).intersection(set(w.keys()))
-##     a = 0
-##     for k in x:
-##         a = a + v[k]*w[k]
-##     return a
-
 cdef _convert_sparse_entries_to_dict(entries):
     e = {}
     for i in xrange(len(entries)):
diff --git a/src/sage/modules/vector_double_dense.pyx b/src/sage/modules/vector_double_dense.pyx
index 9efe536..279ce58 100644
--- a/src/sage/modules/vector_double_dense.pyx
+++ b/src/sage/modules/vector_double_dense.pyx
`@``@` -389,8 +389,6 `@``@` cdef class Vector_double_dense(free_module_element.FreeModuleElement):
             sage: w*v
             1.0
         """
-        if not right.parent() == self.parent():
-            right = self.parent().ambient_module()(right)
         if self._degree == 0:
             from copy import copy
             return copy(self)
```



---

Comment by jdemeyer created at 2015-01-24 14:11:29

Replying to [comment:9 mmezzarobba]:
> Replying to [comment:6 jdemeyer]:
> > Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.
> 
> Fine. (I was not sure that it would be faster...)
It's always going to be somewhat faster and it avoids extra work in case the parents are not equal.

> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.
I could easily move it...

> Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.
Currently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a _free_ module...

> Also, I think we can do two additional simplifications related to `dot_product`:
> {{{
> diff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx
> index b2ff48a..a4cf07c 100644
> --- a/src/sage/matrix/matrix_generic_sparse.pyx
> +++ b/src/sage/matrix/matrix_generic_sparse.pyx
> `@``@` -495,17 +495,6 `@``@` def Matrix_sparse_from_rows(X):
>      return M(entries, coerce=False, copy=False)
>  
>  
> -## def _sparse_dot_product(v, w):
> -##     """
> -##     INPUT:
> -##         v and w are dictionaries with integer keys.
> -##     """
> -##     x = set(v.keys()).intersection(set(w.keys()))
> -##     a = 0
> -##     for k in x:
> -##         a = a + v[k]*w[k]
> -##     return a
> -
>  cdef _convert_sparse_entries_to_dict(entries):
>      e = {}
>      for i in xrange(len(entries)):
> }}}
Absolutely not on this ticket, but see #17663.


---

Comment by jdemeyer created at 2015-01-24 14:31:29

Replying to [comment:9 mmezzarobba]:
> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.
For consistency, I would prefer to keep `dot_product` in `FreeModuleElement`. For `pairwise_product()` (which I didn't change), we also have `pairwise_product` on the level of `FreeModuleElement` but `_pairwise_product_` on the level of `Vector`. Further refactoring would need to involve all kinds of products (dot, cross and pairwise) and I would prefer not to do this now.


---

Comment by git created at 2015-01-24 16:59:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-01-25 09:23:19

Despite the fact that "Trac's automerging failed", the branch actually merges when using `git`.


---

Comment by mmezzarobba created at 2015-01-25 09:53:42

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2015-01-25 09:53:42

Replying to [comment:10 jdemeyer]:
> Currently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a _free_ module...

Sure, but either its elements would derive direclty from `ModuleElement`, or (I'd say) much of what `FreeModuleElement` currently does would need to be moved to `Vector`. Anyway, if you feel that `dot_product` should stay in `FreeModuleElement` until someone does this kind of refactoring, I'm fine with that.

Thanks for you work on this ticket!


---

Comment by vbraun created at 2015-01-29 13:26:19

Resolution: fixed
