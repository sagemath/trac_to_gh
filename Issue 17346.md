# Issue 17346: Clean up free module elements

archive/issues_017346.json:
```json
{
    "body": "General clean-up using modern Cython code in preparation for follow-up tickets.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17583\n\n",
    "created_at": "2015-01-05T13:26:20Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Clean up free module elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17346",
    "user": "https://github.com/jdemeyer"
}
```
General clean-up using modern Cython code in preparation for follow-up tickets.

Issue created by migration from https://trac.sagemath.org/ticket/17583





---

archive/issue_comments_230820.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-21T12:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230820",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_230821.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-21T12:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230821",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_230822.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-01-23T10:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230822",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_230823.json:
```json
{
    "body": "`_sparse_dot_product()` (which you didn't touch) appears not to be used anywhere and could probably be deleted.\n\nBy the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?\n\nOtherwise lgtm.",
    "created_at": "2015-01-23T10:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230823",
    "user": "https://github.com/mezzarobba"
}
```

`_sparse_dot_product()` (which you didn't touch) appears not to be used anywhere and could probably be deleted.

By the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?

Otherwise lgtm.



---

archive/issue_comments_230824.json:
```json
{
    "body": "Replying to [comment:5 mmezzarobba]:\n> By the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?\nYes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.\n\nI'm actually preparing a commit which refactors dot products, since the logic was a bit strange. With the new commit (still testing), there will be a `cpdef` method `_dot_product_` for equal parents and `_dot_product_coerce_` for parents which might be different.",
    "created_at": "2015-01-23T20:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230824",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 mmezzarobba]:
> By the way, is there a reason to special-case the vectors of length zero in `FreeModuleElement.dot_product()`?
Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.

I'm actually preparing a commit which refactors dot products, since the logic was a bit strange. With the new commit (still testing), there will be a `cpdef` method `_dot_product_` for equal parents and `_dot_product_coerce_` for parents which might be different.



---

archive/issue_comments_230825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-23T21:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230825",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_230826.json:
```json
{
    "body": "I also merged #10779 to avoid a small merge conflict. The only relevant new commit is",
    "created_at": "2015-01-23T21:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230826",
    "user": "https://github.com/jdemeyer"
}
```

I also merged #10779 to avoid a small merge conflict. The only relevant new commit is



---

archive/issue_comments_230827.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-01-23T21:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230827",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_230828.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.\n\nFine. (I was not sure that it would be faster...)\n\nRegarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`. Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.\n\nAlso, I think we can do two additional simplifications related to `dot_product`:\n\n```\ndiff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx\nindex b2ff48a..a4cf07c 100644\n--- a/src/sage/matrix/matrix_generic_sparse.pyx\n+++ b/src/sage/matrix/matrix_generic_sparse.pyx\n@@ -495,17 +495,6 @@ def Matrix_sparse_from_rows(X):\n     return M(entries, coerce=False, copy=False)\n \n \n-## def _sparse_dot_product(v, w):\n-##     \"\"\"\n-##     INPUT:\n-##         v and w are dictionaries with integer keys.\n-##     \"\"\"\n-##     x = set(v.keys()).intersection(set(w.keys()))\n-##     a = 0\n-##     for k in x:\n-##         a = a + v[k]*w[k]\n-##     return a\n-\n cdef _convert_sparse_entries_to_dict(entries):\n     e = {}\n     for i in xrange(len(entries)):\ndiff --git a/src/sage/modules/vector_double_dense.pyx b/src/sage/modules/vector_double_dense.pyx\nindex 9efe536..279ce58 100644\n--- a/src/sage/modules/vector_double_dense.pyx\n+++ b/src/sage/modules/vector_double_dense.pyx\n@@ -389,8 +389,6 @@ cdef class Vector_double_dense(free_module_element.FreeModuleElement):\n             sage: w*v\n             1.0\n         \"\"\"\n-        if not right.parent() == self.parent():\n-            right = self.parent().ambient_module()(right)\n         if self._degree == 0:\n             from copy import copy\n             return copy(self)\n```\n",
    "created_at": "2015-01-24T11:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230828",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:6 jdemeyer]:
> Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.

Fine. (I was not sure that it would be faster...)

Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`. Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.

Also, I think we can do two additional simplifications related to `dot_product`:

```
diff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx
index b2ff48a..a4cf07c 100644
--- a/src/sage/matrix/matrix_generic_sparse.pyx
+++ b/src/sage/matrix/matrix_generic_sparse.pyx
@@ -495,17 +495,6 @@ def Matrix_sparse_from_rows(X):
     return M(entries, coerce=False, copy=False)
 
 
-## def _sparse_dot_product(v, w):
-##     """
-##     INPUT:
-##         v and w are dictionaries with integer keys.
-##     """
-##     x = set(v.keys()).intersection(set(w.keys()))
-##     a = 0
-##     for k in x:
-##         a = a + v[k]*w[k]
-##     return a
-
 cdef _convert_sparse_entries_to_dict(entries):
     e = {}
     for i in xrange(len(entries)):
diff --git a/src/sage/modules/vector_double_dense.pyx b/src/sage/modules/vector_double_dense.pyx
index 9efe536..279ce58 100644
--- a/src/sage/modules/vector_double_dense.pyx
+++ b/src/sage/modules/vector_double_dense.pyx
@@ -389,8 +389,6 @@ cdef class Vector_double_dense(free_module_element.FreeModuleElement):
             sage: w*v
             1.0
         """
-        if not right.parent() == self.parent():
-            right = self.parent().ambient_module()(right)
         if self._degree == 0:
             from copy import copy
             return copy(self)
```




---

archive/issue_comments_230829.json:
```json
{
    "body": "Replying to [comment:9 mmezzarobba]:\n> Replying to [comment:6 jdemeyer]:\n> > Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.\n> \n> Fine. (I was not sure that it would be faster...)\nIt's always going to be somewhat faster and it avoids extra work in case the parents are not equal.\n\n> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.\nI could easily move it...\n\n> Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.\nCurrently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a *free* module...\n\n> Also, I think we can do two additional simplifications related to `dot_product`:\n> {{{\n> diff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx\n> index b2ff48a..a4cf07c 100644\n> --- a/src/sage/matrix/matrix_generic_sparse.pyx\n> +++ b/src/sage/matrix/matrix_generic_sparse.pyx\n> `@``@` -495,17 +495,6 `@``@` def Matrix_sparse_from_rows(X):\n>      return M(entries, coerce=False, copy=False)\n>  \n>  \n> -## def _sparse_dot_product(v, w):\n> -##     \"\"\"\n> -##     INPUT:\n> -##         v and w are dictionaries with integer keys.\n> -##     \"\"\"\n> -##     x = set(v.keys()).intersection(set(w.keys()))\n> -##     a = 0\n> -##     for k in x:\n> -##         a = a + v[k]*w[k]\n> -##     return a\n> -\n>  cdef _convert_sparse_entries_to_dict(entries):\n>      e = {}\n>      for i in xrange(len(entries)):\n> }}}\nAbsolutely not on this ticket, but see #17663.",
    "created_at": "2015-01-24T14:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230829",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 mmezzarobba]:
> Replying to [comment:6 jdemeyer]:
> > Yes, to apply the following optimization: instead of starting with zero and `a[i]*b[i]`, we start with `a[0] * b[0]` and add `a[i]*b[i]` for `i >= 1`.
> 
> Fine. (I was not sure that it would be faster...)
It's always going to be somewhat faster and it avoids extra work in case the parents are not equal.

> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.
I could easily move it...

> Actually I don't understand the point of the distinction between `Vector` and `FreeModuleElement` at all.
Currently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a *free* module...

> Also, I think we can do two additional simplifications related to `dot_product`:
> {{{
> diff --git a/src/sage/matrix/matrix_generic_sparse.pyx b/src/sage/matrix/matrix_generic_sparse.pyx
> index b2ff48a..a4cf07c 100644
> --- a/src/sage/matrix/matrix_generic_sparse.pyx
> +++ b/src/sage/matrix/matrix_generic_sparse.pyx
> `@``@` -495,17 +495,6 `@``@` def Matrix_sparse_from_rows(X):
>      return M(entries, coerce=False, copy=False)
>  
>  
> -## def _sparse_dot_product(v, w):
> -##     """
> -##     INPUT:
> -##         v and w are dictionaries with integer keys.
> -##     """
> -##     x = set(v.keys()).intersection(set(w.keys()))
> -##     a = 0
> -##     for k in x:
> -##         a = a + v[k]*w[k]
> -##     return a
> -
>  cdef _convert_sparse_entries_to_dict(entries):
>      e = {}
>      for i in xrange(len(entries)):
> }}}
Absolutely not on this ticket, but see #17663.



---

archive/issue_comments_230830.json:
```json
{
    "body": "Replying to [comment:9 mmezzarobba]:\n> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.\nFor consistency, I would prefer to keep `dot_product` in `FreeModuleElement`. For `pairwise_product()` (which I didn't change), we also have `pairwise_product` on the level of `FreeModuleElement` but `_pairwise_product_` on the level of `Vector`. Further refactoring would need to involve all kinds of products (dot, cross and pairwise) and I would prefer not to do this now.",
    "created_at": "2015-01-24T14:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230830",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 mmezzarobba]:
> Regarding your last commit, I agree with the changes, but I don't understand why `dot_product` is defined in `FreeModuleElement` rather than in `Vector`.
For consistency, I would prefer to keep `dot_product` in `FreeModuleElement`. For `pairwise_product()` (which I didn't change), we also have `pairwise_product` on the level of `FreeModuleElement` but `_pairwise_product_` on the level of `Vector`. Further refactoring would need to involve all kinds of products (dot, cross and pairwise) and I would prefer not to do this now.



---

archive/issue_comments_230831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-24T16:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_230832.json:
```json
{
    "body": "Despite the fact that \"Trac's automerging failed\", the branch actually merges when using `git`.",
    "created_at": "2015-01-25T09:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230832",
    "user": "https://github.com/jdemeyer"
}
```

Despite the fact that "Trac's automerging failed", the branch actually merges when using `git`.



---

archive/issue_comments_230833.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-25T09:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230833",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_230834.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> Currently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a *free* module...\n\nSure, but either its elements would derive direclty from `ModuleElement`, or (I'd say) much of what `FreeModuleElement` currently does would need to be moved to `Vector`. Anyway, if you feel that `dot_product` should stay in `FreeModuleElement` until someone does this kind of refactoring, I'm fine with that.\n\nThanks for you work on this ticket!",
    "created_at": "2015-01-25T09:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230834",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:10 jdemeyer]:
> Currently in Sage, the only `Vector`s are also `FreeModuleElement`s. But one could envision a parent which is not a *free* module...

Sure, but either its elements would derive direclty from `ModuleElement`, or (I'd say) much of what `FreeModuleElement` currently does would need to be moved to `Vector`. Anyway, if you feel that `dot_product` should stay in `FreeModuleElement` until someone does this kind of refactoring, I'm fine with that.

Thanks for you work on this ticket!



---

archive/issue_comments_230835.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-29T13:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17346#issuecomment-230835",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_016735.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2015-01-29T13:26:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17346",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17346#event-16735"
}
```
