# Issue 29044: saving 3d plots to disk seems to be completely broken in sage-9.0

Issue created by migration from https://trac.sagemath.org/ticket/29281

Original creator: was

Original creation time: 2020-03-04 21:20:26

1. Type `sphere().save('a.png')`
2. Get a stacktrace that looks very much like a Python3 porting mistake:

```
~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sphere().save('a.png')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-fbbed3d16b26> in <module>()
----> 1 sphere().save('a.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save (build/cythonized/sage/plot/plot3d/base.c:21661)()
   1635         elif ext in ['.bmp', '.png', '.gif', '.ppm', '.tiff', '.tif',
   1636                      '.jpg', '.jpeg']:
-> 1637             self.save_image(filename, **kwds)
   1638         elif filename.endswith('.spt.zip'):
   1639             scene = self._rich_repr_jmol(**kwds)

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save_image (build/cythonized/sage/plot/plot3d/base.c:21219)()
   1564             raise ValueError('unknown image file type: {0}'.format(ext))
   1565         if ext == '.png':
-> 1566             self._save_image_png(filename, **kwds)
   1567         else:
   1568             png = tmp_filename(ext='.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._save_image_png (build/cythonized/sage/plot/plot3d/base.c:20856)()
   1526             render.png.save_as(filename)
   1527         elif viewer == 'jmol':
-> 1528             scene = self._rich_repr_jmol(**opts)
   1529             scene.preview_png.save_as(filename)
   1530         else:

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7224)()
    259         from sage.interfaces.jmoldata import JmolData
    260         jdata = JmolData()
--> 261         if not jdata.is_jvm_available():
    262             # We can only use JMol to generate preview if a jvm is installed
    263             from sage.repl.rich_output.output_graphics import OutputImagePng

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/interfaces/jmoldata.py in is_jvm_available(self)
     68             return False
     69 
---> 70         java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
     71         return java_version_number >= 7
     72 

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
sage: 
```


This breaks SageTex, probably animation, etc...

See https://github.com/sagemathinc/cocalc/issues/4433

Also, there is another unrelated old ticket about plotting and 3d graphics: #21686




---

Comment by chapoton created at 2020-03-05 19:53:59

This works fine outside C*Calc. Did you try ?


---

Comment by jhpalmieri created at 2020-03-05 20:06:51

Works for me, too. What does "Enhanced for CoCalc" mean in the Sage banner? Could some of the enhancements be involved?


---

Comment by chapoton created at 2020-03-05 20:16:13

I think I have seen Harald say something about JAVA options in C*calc somewhere.


---

Comment by was created at 2020-03-05 20:17:07

Thanks for testing.  The error message in the stacktrace above is in some code to determine the java version; maybe our java runtime environment on cocalc behaves slightly differently than whatever you are testing on.  In the stacktrace, it is trying to turn 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11' into an int.  Maybe it needs to take only the 11 in the last line?  No clue...  I'll see if Harald has an idea, since he setup the Java environment.

--

I fixed a possibly similar issue here

https://github.com/sagemathinc/cocalc-docker/issues/69#issuecomment-594981326

where it turned out the permissions on the usr/local/sage/local/share/jmol directory were strangely wrong for normal user usage.   

Whatever is happening with sage-9.0 might involve some similar permissions issue or something else (no clue).


---

Comment by jhpalmieri created at 2020-03-05 20:30:26

What does "java -version" say on your machine?


---

Comment by jhpalmieri created at 2020-03-05 20:33:22

This is what I see in Sage:

```
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
sage: version
'java version "1.8.0_172"\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\n'
sage: print(version)
java version "1.8.0_172"
Java(TM) SE Runtime Environment (build 1.8.0_172-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
8
```

It looks like something in this chain of commands is not working as expected.


---

Comment by was created at 2020-03-05 20:37:33

On cocalc (as anybody can reproduce in any project):

```
~/cocalc/src/smc-webapp$ java -version
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)
~/cocalc/src/smc-webapp$ sage-9.0
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: version
'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version "11.0.6" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n'
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-7-67eb0f74af21> in <module>()
----> 1 int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
```


Maybe that regular expression isn't quite good enough...


---

Comment by was created at 2020-03-05 20:42:25

Look:

```
wstein@kucalc:~/cocalc-docker$ export _JAVA_OPTIONS="-Xms64m"
wstein@kucalc:~/cocalc-docker$ java -version
Picked up _JAVA_OPTIONS: -Xms64m
openjdk version "1.8.0_242"
OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~16.04-b08)
OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)
```


So anybody who happens to have the env variable _JAVA_OPTIONS set will find that saving 3d graphics to disk is broken in sage-9.0....


---

Comment by jhpalmieri created at 2020-03-05 20:44:36

I don't know why it's using `re.sub` instead of `re.search`. Can you test this?

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..86b21d9722 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,8 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        m = re.search(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', version)
+        java_version_number = int(m.group(2))
         return java_version_number >= 7
 
     def export_image(self,
```



---

Comment by jhpalmieri created at 2020-03-05 20:46:07

Or a smaller change:

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..40984bdc33 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,7 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
         return java_version_number >= 7
 
     def export_image(self,
```



---

Comment by was created at 2020-03-05 21:42:08

Yes, your latter suggestion using flags works for me:

```
~/cocalc/src/smc-webapp$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sage: from sage.cpython.string import bytes_to_str
....: sage: import subprocess
....: sage: import re
....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
11
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

```



---

Comment by jhpalmieri created at 2020-03-05 22:09:31

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-03-05 22:09:31

The flag `re.S` means that `.` matches that "dot matches all", including a newline. So in case "java -version" prints lines before `version "..."`, those lines are swallowed up by the `.` in `.*version`, which is what we want.
----
New commits:


---

Comment by was created at 2020-03-05 22:36:53

Positive review since it works for me.  Thanks!


---

Comment by was created at 2020-03-05 22:37:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-03-05 23:24:28

Please fill out the reviewer name...


---

Comment by vbraun created at 2020-03-05 23:25:11

Changing status from positive_review to needs_work.


---

Comment by was created at 2020-03-06 00:27:47

Changing status from needs_work to positive_review.


---

Comment by was created at 2020-03-06 00:27:47

Done.  Sorry for forgetting that!


---

Comment by schilly created at 2020-03-06 11:41:08

This is a dup of #28648 

I reported this in [October last year on the mailing list](https://groups.google.com/d/topic/sage-devel/TrQ9efDAdKc/discussion)


---

Comment by vbraun created at 2020-03-11 23:46:16

Resolution: fixed
