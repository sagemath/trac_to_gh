# Issue 29044: saving 3d plots to disk seems to be completely broken in sage-9.0

archive/issues_029044.json:
```json
{
    "body": "1. Type `sphere().save('a.png')`\n2. Get a stacktrace that looks very much like a Python3 porting mistake:\n\n```\n~$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: sphere().save('a.png')\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-fbbed3d16b26> in <module>()\n----> 1 sphere().save('a.png')\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save (build/cythonized/sage/plot/plot3d/base.c:21661)()\n   1635         elif ext in ['.bmp', '.png', '.gif', '.ppm', '.tiff', '.tif',\n   1636                      '.jpg', '.jpeg']:\n-> 1637             self.save_image(filename, **kwds)\n   1638         elif filename.endswith('.spt.zip'):\n   1639             scene = self._rich_repr_jmol(**kwds)\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save_image (build/cythonized/sage/plot/plot3d/base.c:21219)()\n   1564             raise ValueError('unknown image file type: {0}'.format(ext))\n   1565         if ext == '.png':\n-> 1566             self._save_image_png(filename, **kwds)\n   1567         else:\n   1568             png = tmp_filename(ext='.png')\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._save_image_png (build/cythonized/sage/plot/plot3d/base.c:20856)()\n   1526             render.png.save_as(filename)\n   1527         elif viewer == 'jmol':\n-> 1528             scene = self._rich_repr_jmol(**opts)\n   1529             scene.preview_png.save_as(filename)\n   1530         else:\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7224)()\n    259         from sage.interfaces.jmoldata import JmolData\n    260         jdata = JmolData()\n--> 261         if not jdata.is_jvm_available():\n    262             # We can only use JMol to generate preview if a jvm is installed\n    263             from sage.repl.rich_output.output_graphics import OutputImagePng\n\n/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/interfaces/jmoldata.py in is_jvm_available(self)\n     68             return False\n     69 \n---> 70         java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n     71         return java_version_number >= 7\n     72 \n\nValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11'\nsage: \n```\n\n\nThis breaks SageTex, probably animation, etc...\n\nSee https://github.com/sagemathinc/cocalc/issues/4433\n\nAlso, there is another unrelated old ticket about plotting and 3d graphics: #21686\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29281\n\n",
    "created_at": "2020-03-04T21:20:26Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "saving 3d plots to disk seems to be completely broken in sage-9.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29044",
    "user": "was"
}
```
1. Type `sphere().save('a.png')`
2. Get a stacktrace that looks very much like a Python3 porting mistake:

```
~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sphere().save('a.png')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-fbbed3d16b26> in <module>()
----> 1 sphere().save('a.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save (build/cythonized/sage/plot/plot3d/base.c:21661)()
   1635         elif ext in ['.bmp', '.png', '.gif', '.ppm', '.tiff', '.tif',
   1636                      '.jpg', '.jpeg']:
-> 1637             self.save_image(filename, **kwds)
   1638         elif filename.endswith('.spt.zip'):
   1639             scene = self._rich_repr_jmol(**kwds)

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.save_image (build/cythonized/sage/plot/plot3d/base.c:21219)()
   1564             raise ValueError('unknown image file type: {0}'.format(ext))
   1565         if ext == '.png':
-> 1566             self._save_image_png(filename, **kwds)
   1567         else:
   1568             png = tmp_filename(ext='.png')

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._save_image_png (build/cythonized/sage/plot/plot3d/base.c:20856)()
   1526             render.png.save_as(filename)
   1527         elif viewer == 'jmol':
-> 1528             scene = self._rich_repr_jmol(**opts)
   1529             scene.preview_png.save_as(filename)
   1530         else:

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7224)()
    259         from sage.interfaces.jmoldata import JmolData
    260         jdata = JmolData()
--> 261         if not jdata.is_jvm_available():
    262             # We can only use JMol to generate preview if a jvm is installed
    263             from sage.repl.rich_output.output_graphics import OutputImagePng

/ext/sage/sage-9.0/local/lib/python3.7/site-packages/sage/interfaces/jmoldata.py in is_jvm_available(self)
     68             return False
     69 
---> 70         java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
     71         return java_version_number >= 7
     72 

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
sage: 
```


This breaks SageTex, probably animation, etc...

See https://github.com/sagemathinc/cocalc/issues/4433

Also, there is another unrelated old ticket about plotting and 3d graphics: #21686



Issue created by migration from https://trac.sagemath.org/ticket/29281





---

archive/issue_comments_411068.json:
```json
{
    "body": "This works fine outside C*Calc. Did you try ?",
    "created_at": "2020-03-05T19:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411068",
    "user": "chapoton"
}
```

This works fine outside C*Calc. Did you try ?



---

archive/issue_comments_411069.json:
```json
{
    "body": "Works for me, too. What does \"Enhanced for CoCalc\" mean in the Sage banner? Could some of the enhancements be involved?",
    "created_at": "2020-03-05T20:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411069",
    "user": "jhpalmieri"
}
```

Works for me, too. What does "Enhanced for CoCalc" mean in the Sage banner? Could some of the enhancements be involved?



---

archive/issue_comments_411070.json:
```json
{
    "body": "I think I have seen Harald say something about JAVA options in C*calc somewhere.",
    "created_at": "2020-03-05T20:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411070",
    "user": "chapoton"
}
```

I think I have seen Harald say something about JAVA options in C*calc somewhere.



---

archive/issue_comments_411071.json:
```json
{
    "body": "Thanks for testing.  The error message in the stacktrace above is in some code to determine the java version; maybe our java runtime environment on cocalc behaves slightly differently than whatever you are testing on.  In the stacktrace, it is trying to turn 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11' into an int.  Maybe it needs to take only the 11 in the last line?  No clue...  I'll see if Harald has an idea, since he setup the Java environment.\n\n--\n\nI fixed a possibly similar issue here\n\nhttps://github.com/sagemathinc/cocalc-docker/issues/69#issuecomment-594981326\n\nwhere it turned out the permissions on the usr/local/sage/local/share/jmol directory were strangely wrong for normal user usage.   \n\nWhatever is happening with sage-9.0 might involve some similar permissions issue or something else (no clue).",
    "created_at": "2020-03-05T20:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411071",
    "user": "was"
}
```

Thanks for testing.  The error message in the stacktrace above is in some code to determine the java version; maybe our java runtime environment on cocalc behaves slightly differently than whatever you are testing on.  In the stacktrace, it is trying to turn 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11' into an int.  Maybe it needs to take only the 11 in the last line?  No clue...  I'll see if Harald has an idea, since he setup the Java environment.

--

I fixed a possibly similar issue here

https://github.com/sagemathinc/cocalc-docker/issues/69#issuecomment-594981326

where it turned out the permissions on the usr/local/sage/local/share/jmol directory were strangely wrong for normal user usage.   

Whatever is happening with sage-9.0 might involve some similar permissions issue or something else (no clue).



---

archive/issue_comments_411072.json:
```json
{
    "body": "What does \"java -version\" say on your machine?",
    "created_at": "2020-03-05T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411072",
    "user": "jhpalmieri"
}
```

What does "java -version" say on your machine?



---

archive/issue_comments_411073.json:
```json
{
    "body": "This is what I see in Sage:\n\n```\nsage: from sage.cpython.string import bytes_to_str\nsage: import subprocess\nsage: import re\nsage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\nsage: version\n'java version \"1.8.0_172\"\\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\\n'\nsage: print(version)\njava version \"1.8.0_172\"\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\n\nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n8\n```\n\nIt looks like something in this chain of commands is not working as expected.",
    "created_at": "2020-03-05T20:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411073",
    "user": "jhpalmieri"
}
```

This is what I see in Sage:

```
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
sage: version
'java version "1.8.0_172"\nJava(TM) SE Runtime Environment (build 1.8.0_172-b11)\nJava HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)\n'
sage: print(version)
java version "1.8.0_172"
Java(TM) SE Runtime Environment (build 1.8.0_172-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.172-b11, mixed mode)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
8
```

It looks like something in this chain of commands is not working as expected.



---

archive/issue_comments_411074.json:
```json
{
    "body": "On cocalc (as anybody can reproduce in any project):\n\n```\n~/cocalc/src/smc-webapp$ java -version\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n~/cocalc/src/smc-webapp$ sage-9.0\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: from sage.cpython.string import bytes_to_str\nsage: import subprocess\nsage: import re\nsage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\n....: \nsage: version\n'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\nopenjdk version \"11.0.6\" 2020-01-14\\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\\n'\nsage: print(version)\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n\nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-7-67eb0f74af21> in <module>()\n----> 1 int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n\nValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\\n11'\n```\n\n\nMaybe that regular expression isn't quite good enough...",
    "created_at": "2020-03-05T20:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411074",
    "user": "was"
}
```

On cocalc (as anybody can reproduce in any project):

```
~/cocalc/src/smc-webapp$ java -version
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)
~/cocalc/src/smc-webapp$ sage-9.0
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess
sage: import re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: version
'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version "11.0.6" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n'
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-7-67eb0f74af21> in <module>()
----> 1 int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))

ValueError: invalid literal for int() with base 10: 'Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\n11'
```


Maybe that regular expression isn't quite good enough...



---

archive/issue_comments_411075.json:
```json
{
    "body": "Look:\n\n```\nwstein@kucalc:~/cocalc-docker$ export _JAVA_OPTIONS=\"-Xms64m\"\nwstein@kucalc:~/cocalc-docker$ java -version\nPicked up _JAVA_OPTIONS: -Xms64m\nopenjdk version \"1.8.0_242\"\nOpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~16.04-b08)\nOpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)\n```\n\n\nSo anybody who happens to have the env variable _JAVA_OPTIONS set will find that saving 3d graphics to disk is broken in sage-9.0....",
    "created_at": "2020-03-05T20:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411075",
    "user": "was"
}
```

Look:

```
wstein@kucalc:~/cocalc-docker$ export _JAVA_OPTIONS="-Xms64m"
wstein@kucalc:~/cocalc-docker$ java -version
Picked up _JAVA_OPTIONS: -Xms64m
openjdk version "1.8.0_242"
OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~16.04-b08)
OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)
```


So anybody who happens to have the env variable _JAVA_OPTIONS set will find that saving 3d graphics to disk is broken in sage-9.0....



---

archive/issue_comments_411076.json:
```json
{
    "body": "I don't know why it's using `re.sub` instead of `re.search`. Can you test this?\n\n```diff\ndiff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py\nindex 8f291fb954..86b21d9722 100644\n--- a/src/sage/interfaces/jmoldata.py\n+++ b/src/sage/interfaces/jmoldata.py\n@@ -67,7 +67,8 @@ class JmolData(SageObject):\n         except (subprocess.CalledProcessError, OSError):\n             return False\n \n-        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n+        m = re.search(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', version)\n+        java_version_number = int(m.group(2))\n         return java_version_number >= 7\n \n     def export_image(self,\n```\n",
    "created_at": "2020-03-05T20:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411076",
    "user": "jhpalmieri"
}
```

I don't know why it's using `re.sub` instead of `re.search`. Can you test this?

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..86b21d9722 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,8 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        m = re.search(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', version)
+        java_version_number = int(m.group(2))
         return java_version_number >= 7
 
     def export_image(self,
```




---

archive/issue_comments_411077.json:
```json
{
    "body": "Or a smaller change:\n\n```diff\ndiff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py\nindex 8f291fb954..40984bdc33 100644\n--- a/src/sage/interfaces/jmoldata.py\n+++ b/src/sage/interfaces/jmoldata.py\n@@ -67,7 +67,7 @@ class JmolData(SageObject):\n         except (subprocess.CalledProcessError, OSError):\n             return False\n \n-        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version))\n+        java_version_number = int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version, flags=re.S))\n         return java_version_number >= 7\n \n     def export_image(self,\n```\n",
    "created_at": "2020-03-05T20:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411077",
    "user": "jhpalmieri"
}
```

Or a smaller change:

```diff
diff --git a/src/sage/interfaces/jmoldata.py b/src/sage/interfaces/jmoldata.py
index 8f291fb954..40984bdc33 100644
--- a/src/sage/interfaces/jmoldata.py
+++ b/src/sage/interfaces/jmoldata.py
@@ -67,7 +67,7 @@ class JmolData(SageObject):
         except (subprocess.CalledProcessError, OSError):
             return False
 
-        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version))
+        java_version_number = int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
         return java_version_number >= 7
 
     def export_image(self,
```




---

archive/issue_comments_411078.json:
```json
{
    "body": "Yes, your latter suggestion using flags works for me:\n\n```\n~/cocalc/src/smc-webapp$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: sage: from sage.cpython.string import bytes_to_str\n....: sage: import subprocess\n....: sage: import re\n....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))\n....: \nsage: int(re.sub(r'.*version \"(0\\.|1\\.)?(\\d*)[\\s\\S]*', r'\\2', version, flags=re.S))\n11\nsage: print(version)\nPicked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m\nopenjdk version \"11.0.6\" 2020-01-14\nOpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)\nOpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)\n\n```\n",
    "created_at": "2020-03-05T21:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411078",
    "user": "was"
}
```

Yes, your latter suggestion using flags works for me:

```
~/cocalc/src/smc-webapp$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sage: from sage.cpython.string import bytes_to_str
....: sage: import subprocess
....: sage: import re
....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
....: 
sage: int(re.sub(r'.*version "(0\.|1\.)?(\d*)[\s\S]*', r'\2', version, flags=re.S))
11
sage: print(version)
Picked up _JAVA_OPTIONS: -Djava.io.tmpdir=/home/user/tmp/ -Xms64m
openjdk version "11.0.6" 2020-01-14
OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)
OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)

```




---

archive/issue_comments_411079.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411079",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411080.json:
```json
{
    "body": "The flag `re.S` means that `.` matches that \"dot matches all\", including a newline. So in case \"java -version\" prints lines before `version \"...\"`, those lines are swallowed up by the `.` in `.*version`, which is what we want.\n----\nNew commits:",
    "created_at": "2020-03-05T22:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411080",
    "user": "jhpalmieri"
}
```

The flag `re.S` means that `.` matches that "dot matches all", including a newline. So in case "java -version" prints lines before `version "..."`, those lines are swallowed up by the `.` in `.*version`, which is what we want.
----
New commits:



---

archive/issue_comments_411081.json:
```json
{
    "body": "Positive review since it works for me.  Thanks!",
    "created_at": "2020-03-05T22:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411081",
    "user": "was"
}
```

Positive review since it works for me.  Thanks!



---

archive/issue_comments_411082.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-05T22:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411082",
    "user": "was"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411083.json:
```json
{
    "body": "Please fill out the reviewer name...",
    "created_at": "2020-03-05T23:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411083",
    "user": "vbraun"
}
```

Please fill out the reviewer name...



---

archive/issue_comments_411084.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-05T23:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411084",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_411085.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-03-06T00:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411085",
    "user": "was"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_411086.json:
```json
{
    "body": "Done.  Sorry for forgetting that!",
    "created_at": "2020-03-06T00:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411086",
    "user": "was"
}
```

Done.  Sorry for forgetting that!



---

archive/issue_comments_411087.json:
```json
{
    "body": "This is a dup of #28648 \n\nI reported this in [October last year on the mailing list](https://groups.google.com/d/topic/sage-devel/TrQ9efDAdKc/discussion)",
    "created_at": "2020-03-06T11:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411087",
    "user": "schilly"
}
```

This is a dup of #28648 

I reported this in [October last year on the mailing list](https://groups.google.com/d/topic/sage-devel/TrQ9efDAdKc/discussion)



---

archive/issue_comments_411088.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-11T23:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29044#issuecomment-411088",
    "user": "vbraun"
}
```

Resolution: fixed
