# Issue 8601: Bug in vector reduction

archive/issues_008601.json:
```json
{
    "body": "Assignee: was\n\nCC:  rbeezer\n\n\n```\nOn Mar 24, 2010, at 10:35 AM, mb wrote:\n\nHi,\n\nThe following seems like strange behavior to me.\n\nIn [1]: V=VectorSpace(GF(2),2)\nIn [2]: V([1,3])\nOut[2]: (1, 1)\nIn [3]: V([1,-3])\nOut[3]: (1, 0)\n\nI would expect the last answer to be (1,1).\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/8601\n\n",
    "created_at": "2010-03-24T17:47:43Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "title": "Bug in vector reduction",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/8601",
    "user": "robertwb"
}
```
Assignee: was

CC:  rbeezer


```
On Mar 24, 2010, at 10:35 AM, mb wrote:

Hi,

The following seems like strange behavior to me.

In [1]: V=VectorSpace(GF(2),2)
In [2]: V([1,3])
Out[2]: (1, 1)
In [3]: V([1,-3])
Out[3]: (1, 0)

I would expect the last answer to be (1,1).
```


Issue created by migration from https://trac.sagemath.org/ticket/8601





---

archive/issue_comments_077892.json:
```json
{
    "body": "Narrowing this down:\n\n\n```\nsage: V=GF(2)^2                                   \nsage: V.coordinate_vector([1,-3])\n(1, 0)\n```\n",
    "created_at": "2010-03-25T00:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77892",
    "user": "jason"
}
```

Narrowing this down:


```
sage: V=GF(2)^2                                   
sage: V.coordinate_vector([1,-3])
(1, 0)
```




---

archive/issue_comments_077893.json:
```json
{
    "body": "As a workaround:\n\n\n```\nsage: vector(GF(2),[1,-3])                                                     \n(1, 1)\n```\n\n\nNote that the category seems autogenerated or something since I can't get the source:\n\n\n```\nsage: type(GF(2)^2)\n<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>\nsage: sage.modules.free_module.FreeModule_ambient_field_with_category??\nObject `sage.modules.free_module.FreeModule_ambient_field_with_category` not found.\n\n```\n",
    "created_at": "2010-03-25T00:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77893",
    "user": "jason"
}
```

As a workaround:


```
sage: vector(GF(2),[1,-3])                                                     
(1, 1)
```


Note that the category seems autogenerated or something since I can't get the source:


```
sage: type(GF(2)^2)
<class 'sage.modules.free_module.FreeModule_ambient_field_with_category'>
sage: sage.modules.free_module.FreeModule_ambient_field_with_category??
Object `sage.modules.free_module.FreeModule_ambient_field_with_category` not found.

```




---

archive/issue_comments_077894.json:
```json
{
    "body": "It seems to only affect GF(2), and only when you pass in negative numbers:\n\n\n```\nsage: (GF(2)^10)(range(-5,5))\n(0, 0, 0, 0, 0, 0, 1, 0, 1, 0)\nsage: (GF(3)^10)(range(-5,5))\n(1, 2, 0, 1, 2, 0, 1, 2, 0, 1)\n```\n",
    "created_at": "2010-03-25T00:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77894",
    "user": "jason"
}
```

It seems to only affect GF(2), and only when you pass in negative numbers:


```
sage: (GF(2)^10)(range(-5,5))
(0, 0, 0, 0, 0, 0, 1, 0, 1, 0)
sage: (GF(3)^10)(range(-5,5))
(1, 2, 0, 1, 2, 0, 1, 2, 0, 1)
```




---

archive/issue_comments_077895.json:
```json
{
    "body": "If after line 150 of vector_mod2_dense.pyx, you put the line:\n\n```\nprint xi, type(xi), xi%2\n```\n\nyou see that the problem happens because in the Cython file, -1%2 is -1, not 1.  Apparently the C standard doesn't specify what happens if you mod with a negative number; some compilers return positive numbers, some return negative numbers.\n\nHere is a patch which fixes the issue.  I don't have time to formalize it and upload it right now.\n\n```\ndiff -r c04df7b7f023 sage/modules/vector_mod2_dense.pyx\n--- a/sage/modules/vector_mod2_dense.pyx\tThu Mar 18 01:56:14 2010 -0500\n+++ b/sage/modules/vector_mod2_dense.pyx\tWed Mar 24 20:12:27 2010 -0500\n@@ -137,6 +137,8 @@\n             (0, 0, 1)\n             sage: VS((0,0,GF(2)(1)))\n             (0, 0, 1)\n+            sage: VS((-1,-2,-3))\n+            (1, 0, 1)\n         \"\"\"\n         cdef Py_ssize_t i\n         cdef int xi\n@@ -146,7 +148,8 @@\n             for i from 0 <= i < self._degree:\n                 if PY_TYPE_CHECK(x[i],IntegerMod_int) or PY_TYPE_CHECK(x[i],int) or PY_TYPE_CHECK(x[i],Integer):\n                     xi = x[i]\n-                    mzd_write_bit(self._entries, 0, i, xi%2)\n+                    # the if/else statement is because some in some compilers, (-1)%2 is -1\n+                    mzd_write_bit(self._entries, 0, i, 0 if xi%2==0 else 1)\n                 else:\n                     mzd_write_bit(self._entries, 0, i, x[i]%2)\n             return\n```\n",
    "created_at": "2010-03-25T01:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77895",
    "user": "jason"
}
```

If after line 150 of vector_mod2_dense.pyx, you put the line:

```
print xi, type(xi), xi%2
```

you see that the problem happens because in the Cython file, -1%2 is -1, not 1.  Apparently the C standard doesn't specify what happens if you mod with a negative number; some compilers return positive numbers, some return negative numbers.

Here is a patch which fixes the issue.  I don't have time to formalize it and upload it right now.

```
diff -r c04df7b7f023 sage/modules/vector_mod2_dense.pyx
--- a/sage/modules/vector_mod2_dense.pyx	Thu Mar 18 01:56:14 2010 -0500
+++ b/sage/modules/vector_mod2_dense.pyx	Wed Mar 24 20:12:27 2010 -0500
@@ -137,6 +137,8 @@
             (0, 0, 1)
             sage: VS((0,0,GF(2)(1)))
             (0, 0, 1)
+            sage: VS((-1,-2,-3))
+            (1, 0, 1)
         """
         cdef Py_ssize_t i
         cdef int xi
@@ -146,7 +148,8 @@
             for i from 0 <= i < self._degree:
                 if PY_TYPE_CHECK(x[i],IntegerMod_int) or PY_TYPE_CHECK(x[i],int) or PY_TYPE_CHECK(x[i],Integer):
                     xi = x[i]
-                    mzd_write_bit(self._entries, 0, i, xi%2)
+                    # the if/else statement is because some in some compilers, (-1)%2 is -1
+                    mzd_write_bit(self._entries, 0, i, 0 if xi%2==0 else 1)
                 else:
                     mzd_write_bit(self._entries, 0, i, x[i]%2)
             return
```




---

archive/issue_comments_077896.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2010-03-25T01:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77896",
    "user": "jason"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_077897.json:
```json
{
    "body": "Attachment\n\nThis patch should be ready for review.  Doctests pass in the modules/*.pyx files.",
    "created_at": "2010-05-01T19:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77897",
    "user": "jason"
}
```

Attachment

This patch should be ready for review.  Doctests pass in the modules/*.pyx files.



---

archive/issue_comments_077898.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-05-01T19:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77898",
    "user": "jason"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_077899.json:
```json
{
    "body": "Attachment\n\nThe patch [trac-8601-vector-mod2-negative.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/8601/trac-8601-vector-mod2-negative.patch) is OK by me. But I would prefer referencing the ticket number in a doctest. My reviewer patch does that and it also fixes a typo. Anyone but myself is welcome to give a final sign off on this ticket.",
    "created_at": "2010-05-11T05:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77899",
    "user": "mvngu"
}
```

Attachment

The patch [trac-8601-vector-mod2-negative.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/8601/trac-8601-vector-mod2-negative.patch) is OK by me. But I would prefer referencing the ticket number in a doctest. My reviewer patch does that and it also fixes a typo. Anyone but myself is welcome to give a final sign off on this ticket.



---

archive/issue_comments_077900.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-05-11T06:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77900",
    "user": "jason"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_077901.json:
```json
{
    "body": "Your changes look good to me (and pass doctests).",
    "created_at": "2010-05-11T06:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77901",
    "user": "jason"
}
```

Your changes look good to me (and pass doctests).



---

archive/issue_comments_077902.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-05-12T22:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/8601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/8601#issuecomment-77902",
    "user": "mvngu"
}
```

Resolution: fixed
