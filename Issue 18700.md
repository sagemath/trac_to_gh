# Issue 18700: Upgrade patchbot again

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2015-07-22 12:36:12

CC:  vdelecroix ncohen

Keywords: patchbot

A lot of work has been done on the patchbot since the latest update.

In particular, the ascii plugin now looks for unicode only in .py[x] missing utf8 declaration.

Latest available version is 2.3.8

spkg here : http://chapoton.perso.math.cnrs.fr/patchbot-2.3.8.spkg


---

Comment by chapoton created at 2015-08-04 09:37:59

New commits:


---

Comment by git created at 2015-08-20 20:27:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-08-20 20:30:23

Changing status from new to needs_review.


---

Comment by chapoton created at 2015-08-20 20:30:23

I think that I am getting close to the correct switch to new style spkg.

Please double check !


---

Comment by jdemeyer created at 2015-08-20 21:33:23

Just a small comment: you can replace

```
if [ -e "$SAGE_LOCAL/bin/patchbot" ]; then
   rm -rf "$SAGE_LOCAL/bin/patchbot"
fi
```

by

```
rm -rf "$SAGE_LOCAL/bin/patchbot"
```



---

Comment by git created at 2015-08-21 07:41:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-08-21 13:22:56

I have simplified the spkg-install as suggested.

This package works, and has been tested, see its report on top of http://patchbot.sagemath.org/ticket/18594/

Needs review.


---

Comment by chapoton created at 2015-08-22 16:36:12

I need help, please. What is the correct top-level content of the tar archive:

a directory "patchbot-2.4.0" ? or a directory "src" ?


---

Comment by jdemeyer created at 2015-08-23 19:59:07

Replying to [comment:11 chapoton]:
> I need help, please. What is the correct top-level content of the tar archive:
> 
> a directory "patchbot-2.4.0" ? or a directory "src" ?

I'd say: anything is fine, as long as it works.


---

Comment by jdemeyer created at 2015-08-26 17:54:45

This is a problem:

```
Traceback (most recent call last):
  File "/home/patchbot/sage-patchbot/local/bin/patchbot/patchbot.py", line 45, in <module>
    from trac import scrape, pull_from_trac
  File "/home/patchbot/sage-patchbot/local/bin/patchbot/trac.py", line 15, in <module>
    from util import (do_or_die, now_str, describe_branch,
  File "/home/patchbot/sage-patchbot/local/bin/patchbot/util.py", line 7, in <module>
    import pytz
ImportError: No module named pytz
```



---

Comment by jdemeyer created at 2015-08-26 17:54:45

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-08-27 07:14:10

Instead of `wget`, why not use `sage-download-file` which will work on every system?


---

Comment by jdemeyer created at 2015-08-27 07:42:54

The patchbot is not Python 3 compatible:

```
  File "/usr/local/src/sage-git/local/bin/patchbot/patchbot.py", line 128
    print datetime()
                 ^
SyntaxError: invalid syntax
```



---

Comment by chapoton created at 2015-08-27 07:47:03

Yes, indeed. Several print statements are problematic.. Should I try to switch to python3 only, or really try to make a code that can run in both py2 and py3 ?


---

Comment by jdemeyer created at 2015-08-27 07:54:34

Since you're using the system Python, you really need to support both Python 2 and Python 3.

However, you might be able to use the `2to3` tool at install-time to solve this.


---

Comment by jdemeyer created at 2015-08-27 07:59:55

The upstream github repo contains a `spkg-install` file which is not the same as the one in Sage. Can you also update it upstream please?


---

Comment by chapoton created at 2015-08-27 08:48:17

May I instead remove the "spkg-install" and the "SPKG.txt" completely inside the tar ball ?


---

Comment by jdemeyer created at 2015-08-28 10:23:15

Replying to [comment:19 chapoton]:
> May I instead remove the "spkg-install" and the "SPKG.txt" completely inside the tar ball ?

Yes, under the condition that the patchbot can be easily installed from the sources (which is the case currently, just copy/symlink the whole directory).

If (for whatever reason) the installation procedure needs to become more complicated, that complexity should go to an install script inside the sources, not to `spkg-install`. It should not become a _requirement_ to use Sage's `spkg-install` to install the patchbot.


---

Comment by chapoton created at 2015-08-28 18:32:40

Hello,

I am having trouble to get the patchbot running on python3, because of severe encoding problems. Would it be possible to keep this enhancement for a later upgrading of the patchbot spkg ?


---

Comment by jdemeyer created at 2015-08-29 15:25:17

Fine for me, but I would really prefer to see the system-wide dependencies reduced, in particular the `pytz` package, which is not installed by default on many operating systems.


---

Comment by git created at 2015-08-30 15:42:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-08-30 15:46:10

Ok, here is a version without need for pytz. It still needs dateutil, but it would be hard
to do without anything to handle timezones..

This is not working in python3, because of encoding problems. Still I think it would be good to have a recent patchbot in the new style spkg.

This patchbot has not yet been run on a ticket.


---

Comment by chapoton created at 2015-09-01 09:47:45

I think this is good to go, and so set to needs_review


---

Comment by chapoton created at 2015-09-01 09:47:45

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-01 09:53:24

It is highly recommended to add a `build/pkgs/patchbot/dependencies` file.


---

Comment by jdemeyer created at 2015-09-01 09:53:58

You just added an additional dependency on `six`:

```
Traceback (most recent call last):
  File "/home/worker/sage-patchbot/local/bin/patchbot/patchbot.py", line 41, in <module>
    from six.moves import cPickle as pickle
ImportError: No module named six.moves
```



---

Comment by jdemeyer created at 2015-09-01 09:56:20

Another question: why is `safe_only=True` the default? Why is there such an option in the first place?


---

Comment by jdemeyer created at 2015-09-01 10:30:27

Since the need for `six` is again quite trivial, could you just replace the 2 uses of `six` by some logic like

```
try:
    import ...
except ImportError:
    import ...
```



---

Comment by chapoton created at 2015-09-01 11:40:47

* Ok, I will remove the dependency on six.

* What should I put in the build/pkgs/patchbot/dependencies ? This is not explained in the doc

http://doc.sagemath.org/html/en/developer/packaging.html

It is not clear to me if I should write there shell commands, python packages, or both.

* Concerning the safe-only mode, this is certainly not perfect. I guess its main aim is to avoid the horribly long recompilation that can take place sometimes when some low-level things are changed. Patchbot users are always free to change the default setting. It is up to them to decide whether or not they test all the tickets, including some that may take a *lot* of time.


---

Comment by jdemeyer created at 2015-09-01 11:54:17

Replying to [comment:31 chapoton]:
> * What should I put in the build/pkgs/patchbot/dependencies ? This is not explained in the doc

True, the documentation is lacking. For the patchbot, I think there are no dependencies, so something like

```
# No dependencies
```

should be fine.

> * Concerning the safe-only mode, this is certainly not perfect. I guess its main aim is to avoid the horribly long recompilation that can take place sometimes when some low-level things are changed.
If that is the reason, the name `safe_only` looks badly chosen: it seems to imply that testing other tickets is "unsafe" somehow.

> Patchbot users are always free to change the default setting. It is up to them to decide whether or not they test all the tickets, including some that may take a *lot* of time.
Personally, I would prefer to have `safe_only=False` by default. I think that most patchbots are running all the time, so I don't see the problem.


---

Comment by git created at 2015-09-01 13:56:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-01 13:59:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-09-01 14:04:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-01 14:05:22

ok, here is a version without six, and with a dependencies file added


---

Comment by jdemeyer created at 2015-09-03 07:35:09

Is there a difference between

```
datetime.now()
```

and

```
datetime.now(tzlocal())
```

and between

```
datetime.utcnow()
```

and

```
datetime.now(tzutc())
```



---

Comment by jdemeyer created at 2015-09-03 07:38:10

Apart from [comment:37], the only remaining use of `dateutil` is `dateutil.parser`.


---

Comment by chapoton created at 2015-09-03 07:47:06

In fact, there is a *big* difference between datetime.utcnow() and datetime.now(tzutc())

* `datetime.utcnow()` does not have any information about its timezone
* `datetime.now(tzutc())` is an object that knows that it is in UTC timezone

Because I want to take differences between times, the clean way is to make pretty sure
that all datetimes are aware of their own timezones.

Given the nature of the patchbot, which is to receive and compare data from all over the world, I think there is no point in trying to get rid of the dateutil package.


---

Comment by jdemeyer created at 2015-09-03 09:02:59

Well, the patchbot package worked fine for a long time without `dateutil`, so there is no fundamental reason why we need it. We could do the replacements in [comment:37] and revert the `parse_datetime` function to what it was in earlier patchbot versions and have the patchbot "just work" that way.


---

Comment by chapoton created at 2015-09-03 09:49:37

Is there any fundamental reason why we should avoid any dependency ? Should we trade at all prize clean code for code which may be approximate but our own ?

I am grateful that you look at the patchbot code. Nevertheless, during this time, sage4 using patchbot 2.3.3 is just spending its time looptesting #258, once every two minutes. Maybe you should rather stop it.

The patchbot has several issues, the main one in my opinion being the recognition of trusted users, that is currently not good at all. I hope that it will not be necessary to solve all the issues in order to have a new style spkg.


---

Comment by jdemeyer created at 2015-09-03 13:50:23

Replying to [comment:41 chapoton]:
> Is there any fundamental reason why we should avoid any dependency ?
Yes: `patchbot` would be the only Sage package which has dependencies beyond Sage. Installing packages system-wide is a big requirement.


---

Comment by ncohen created at 2015-09-03 14:20:58

> Yes: `patchbot` would be the only Sage package which has dependencies beyond Sage. 

https://groups.google.com/d/msg/sage-devel/-oLvlyvbclA/GXK3UjXVCwAJ

> Installing packages system-wide is a big requirement.

For those who install the patchbot? Come on, who installs that except developpers? If they get a message saying that "X must be installed" they will install it, and that's it.

To install mine I had to fight for days, create an user account only for the patchbot, fight with ccache... Having a system dependency like that really isn't a problem (if an explicit error message appears).

Nathann


---

Comment by chapoton created at 2015-09-10 19:58:25

Jeroen, do you object if this is made a new-style spkg in its current state ?

Version 2.4.2 works well, it is now running quite smoothly on arando since a long time.

I would really like the patchbot to survive the "disparition" of old-style spkgs..


---

Comment by vdelecroix created at 2015-09-10 22:32:38

There is no such thing as disparation of old style package. We will still be able to do

```
sage -i FULL_URL_OF_OLD_PKG
```


Note that having new style package for the patchbot is much less flexible then the old one (i.e. you have to wait the next release to have the patchbot updated).


---

Comment by git created at 2015-09-11 19:49:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-11 19:53:26

Here is major new version 2.4.3

I have enhanced the trust control, hereby reducing the number of tickets that were not tested for wrong reasons. But this will work better if all people that run patchbots agree to update their patchbots.

Therefore this ticket needs review, more than ever.


---

Comment by vdelecroix created at 2015-09-11 22:59:42

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-09-11 22:59:42

Would be better with a working patchbot... break after ten seconds with

```
[2015-09-11 22:58:44 +0000] Getting ticket list...
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 1316, in main
    patchbot.test_a_ticket(ticket)
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 846, in test_a_ticket
    rating, ticket = self.get_one_ticket()
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 672, in get_one_ticket
    for t in all))
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 672, in <genexpr>
    for t in all))
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 728, in rate_ticket
    if not ticket['authors_fullnames']:
KeyError: 'authors_fullnames'
```



---

Comment by git created at 2015-09-12 07:47:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-12 07:50:21

I am very sorry. I was a bit over-enthusiastic for having an idea to solve the trust-checking issue. This should work now.

By the way, what will happen if I do

```
sage -i patchbot-2.4.9
```

with a future instance of the new-style spkg ?
In other words, can one install new-style spkg updates in that way ?


---

Comment by chapoton created at 2015-09-12 07:56:01

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-09-12 14:23:11

You should seriously test the patchbot before posting a new tarball here...

```
19158: Pending
ok (report successfully posted)
2015-09-12 14:22:29 +0000
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 886, in test_a_ticket
    print(self.banner())
UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-9: ordinal not in range(128)
2015-09-12 14:22:29 +0000
0 seconds
[2015-09-12 14:22:31 +0000] An exception has been raised during the test of #19158
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 886, in test_a_ticket
    print(self.banner())
UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-9: ordinal not in range(128)
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 1316, in main
    patchbot.test_a_ticket(ticket)
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 1023, in test_a_ticket
    self.write_log("Reporting #{} with status {}".format(ticket['id'], status[state]),
UnboundLocalError: local variable 'state' referenced before assignment
```



---

Comment by vdelecroix created at 2015-09-12 14:23:11

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-09-12 15:40:53

I had tested it, but obviously not enough.. I'm testing usually inside a ipython session.

Difficulties with utf8, I find them quite hard and messy.


---

Comment by chapoton created at 2015-09-12 16:04:17

`@`vincent: maybe it is your terminal that does not support utf8 ?

I do not see this problem when I try to test the same ticket.


---

Comment by vdelecroix created at 2015-09-12 17:22:21

Perhaps my terminal is messy but anyway the final traceback is

```
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 1316, in main
    patchbot.test_a_ticket(ticket)
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 1023, in test_a_ticket
    self.write_log("Reporting #{} with status {}".format(ticket['id'], status[state]),
UnboundLocalError: local variable 'state' referenced before assignment
```

which tells that something is wrong.

Anyway, it used to work with the very same terminal.


---

Comment by git created at 2015-09-13 15:55:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-14 16:40:00

Vincent or Jeroen, would you please try that one ? I do no longer dare to put that into needs_review... :(


---

Comment by vdelecroix created at 2015-09-14 16:50:35

Same problem as before

```
2015-09-14 16:50:06 +0000
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 889, in test_a_ticket
    print(self.banner())
UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-9: ordinal not in range(128)
2015-09-14 16:50:06 +0000
0 seconds
```



---

Comment by chapoton created at 2015-09-14 20:11:41

damn.. could you please check your terminal utf8 capacities ?


---

Comment by vdelecroix created at 2015-09-14 23:37:07

Works perfectly with version 2.3.9 of the patchbot.


---

Comment by git created at 2015-09-15 13:19:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-15 13:21:14

I think that I have solved this problem of utf8. Please check.


---

Comment by vdelecroix created at 2015-09-15 13:29:17

At least it started! Yipee! It currently runs on librae. Let see what happens.

Vincent


---

Comment by vdelecroix created at 2015-09-15 21:36:03

Remains the question about Python module dependencies... what is the current status?

Could you also split the very long line in SPKG.txt?

Vincent


---

Comment by vdelecroix created at 2015-09-15 21:36:03

Changing status from needs_work to needs_info.


---

Comment by vdelecroix created at 2015-09-15 22:42:00

In the `history.txt` file I got some strange missing things

```
[2015-09-15 15:25:11 +0000] #19001: starting tests
[2015-09-15 16:00:53 +0000] #19001: TestsPassed
[2015-09-15 16:01:10 +0000] #19043: starting tests
[2015-09-15 16:01:26 +0000] #19048: starting tests
[2015-09-15 16:02:21 +0000] #19068: starting tests
```

Indeed #19043 is unsafe and was skipped. But this does not appear in the history.

For #19048 I think that something gets wrong because in `patchbot.log` I got

```
[2015-09-15 16:02:09 +0000] An exception has been raised during the test of #19048
```

Which is not very precise. Looking at 19048-log.txt it appears that

```
[calculus ] reading sources... [  5%] sage/calculus/calculus
Error building the documentation.
Traceback (most recent call last):
  File "/home/vincent/sage_patchbot/src/doc/common/builder.py", line 1626, in <module>
    getattr(get_builder(name), type)()
  File "/home/vincent/sage_patchbot/src/doc/common/builder.py", line 292, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/vincent/sage_patchbot/src/doc/common/builder.py", line 503, in _wrapper
    x.get(99999)
  File "/home/vincent/sage_patchbot/local/lib/python/multiprocessing/pool.py", line 558, in get
    raise self._value
OSError: [rings    ] /home/vincent/sage_patchbot/local/lib/python2.7/site-packages/sage/rings/asymptotic/asymptotic_ring.py:docstring of sage.rings.asymptotic.asymptotic_ring:16: ERROR: Unexpected indentation.
```

So the report status should be that the documentation does not build... the error was catched but somehow misinterpreted.

Vincent


---

Comment by vdelecroix created at 2015-09-15 22:45:37

Comes from this commit

```
commit f648b882bebdb033e423fe038237dad3f1e5df1e
Author: Frédéric Chapoton <chapoton`@`math.univ-lyon1.fr>
Date:   Mon Mar 30 14:24:22 2015 +0200

    little more doc

```

it desactivate the docbuild plugin and hence does not catch error when building the documentation.

EDIT: not sure that it was fine before the mentioned commit... because the build would have failed anyway.


---

Comment by vdelecroix created at 2015-09-15 22:45:37

Changing status from needs_info to needs_work.


---

Comment by chapoton created at 2015-09-16 08:13:58

1) the html doc is now always build, when doing make, so the plugin is not activated to avoid a duplicate. There is also a pdf-doc plugin, not activated by default.

2) "An exception has been raised during the test" is now raised when nothing is known about the exception. Maybe this was a wrong change, and should be reverted ?

3) concerning python dependencies, there is only dateutil. I would prefer to keep it, because it makes sense to have a correct handling of timezones in a world-wide server.


---

Comment by git created at 2015-09-16 09:27:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-16 13:28:30

Replying to [comment:69 chapoton]:
> 1) the html doc is now always build, when doing make, so the plugin is not activated to avoid a duplicate. There is also a pdf-doc plugin, not activated by default.
> 
> 2) "An exception has been raised during the test" is now raised when nothing is known about the exception. Maybe this was a wrong change, and should be reverted ?

This is a clear problem. The patchbot did report nothing to #19048 where it should have said documentation failed to build. I do not know how it handled it before but I thought that the patchbot did report some kind of "documentation failed" as a status. Though, the main problem is not the fact that it does not know what kind of error it is (you can figure out from the log) but the fact that the patchbot did not send the log to the server...

> 3) concerning python dependencies, there is only dateutil. I would prefer to keep it, because it makes sense to have a correct handling of timezones in a world-wide server.

Then perhaps its presence could be checked in the installation script?


---

Comment by jdemeyer created at 2015-09-16 13:58:41

Replying to [comment:71 vdelecroix]:
> Then perhaps its presence could be checked in the installation script?

Or, alternatively, remove the artificial dependency on `dateutil`.

I still find it hard to believe that something as trivial as a patchbot needs to deal with timezones (and, if you look at the code, it doesn't actually deal with different timezones). You could just assume all times to be in UTC, problem solved.


---

Comment by chapoton created at 2015-09-16 14:24:55

ok, ok, I will now remove dateutil dependencies.

Currently doc failure should be reported as BuildFailed, but I may have broken that.


---

Comment by git created at 2015-09-17 08:40:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-17 08:44:28

Ok, here is a new version, again (I am starting to get tired to work on a patchbot that nobody uses).

It does no longer depends on dateutil.

It has a better log in history.txt for skipped tickets.

The doc plugin has been reactivated, and the initial "make" replaced by "make build".
So the doc is only build once, and doc failure is reported as a plugin failure.

I have tested it, it seems to work. Please double-check.


---

Comment by jdemeyer created at 2015-09-17 08:54:05

So it's needs_review again?

> I am starting to get tired to work on a patchbot that nobody uses
Well, after this is done, hopefully more people will use it!


---

Comment by jdemeyer created at 2015-09-17 08:54:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-17 09:15:04

I'm now testing it on `arando`.


---

Comment by vdelecroix created at 2015-09-17 09:29:12

On the previous version of the patchbot, namely 2.4.6, I got

```
[2015-09-17 09:22:03 +0000] Getting ticket list...
Traceback (most recent call last):
  File ".../patchbot.py", line 1321, in main
    patchbot.test_a_ticket(ticket)
  File ".../patchbot.py", line 850, in test_a_ticket
    rating, ticket = self.get_one_ticket()
  File ".../patchbot.py", line 673, in get_one_ticket
    for t in all)))
  File ".../patchbot.py", line 673, in <genexpr>
    for t in all)))
  File ".../patchbot.py", line 772, in rate_ticket
    prune_pending(ticket)
  File ".../util.py", line 60, in prune_pending
    elif (now - t).total_seconds() > timeout:
TypeError: can't subtract offset-naive and offset-aware datetimes
```

But I do not know whether it is fixed in your last version.


---

Comment by chapoton created at 2015-09-17 09:44:12

yes, this should be fixed by the removal of dateutil dependencies.


---

Comment by vdelecroix created at 2015-09-17 10:58:42

Replying to [comment:81 chapoton]:
> yes, this should be fixed by the removal of dateutil dependencies.

Nice ;-) I also launched the 2.4.7 on librae.


---

Comment by chapoton created at 2015-09-17 15:54:23

Hmm, there is a problem:

A) either we do not build the doc before running the tests, and the tests fail when a new sage-release appears
(this is what happens with 2.4.7, I think, see your reports on ticket 0)

B) or we do build the doc before, but then there is no plugin reporting about doc failure
(this would revert to the previous behaviour)

C) or we can build the doc twice..

D) or find a better solution (do make when a new develop is pulled ?)

I would vote for B) or D)

Frederic


---

Comment by jdemeyer created at 2015-09-17 18:42:29

Replying to [comment:83 chapoton]:
> Hmm, there is a problem
Can you explain what the problem is?


---

Comment by chapoton created at 2015-09-17 19:31:39

Hello,
I am not quite sure, but looking at the latest report of arando and librae on 6.9.b7 here:

http://patchbot.sagemath.org/log/Pending/0/Ubuntu/14.04/i686/3.13.0-40-generic/arando/2015-09-17%2013:28:51?short

(librae report is no longer there)

one finds that one of them fails because the doc was not build before the tests were run, and the other for some strange reason.


---

Comment by jdemeyer created at 2015-09-17 19:51:03

Replying to [comment:85 chapoton]:
> one finds that one of them fails because the doc was not build before the tests were run
Well, in the arando report, it is clear that the doc was built. So I don't know why you think that the problem is related to the docs.


---

Comment by jdemeyer created at 2015-09-17 20:00:20

The arando failure is genuine, not the fault of the patchbot.


---

Comment by chapoton created at 2015-09-18 19:25:18

Another problem with bot 2.4.7 on arando: it apparently does not report anything when there is a doctest failure!

Looking at http://patchbot.sagemath.org/log/Pending/19191/Ubuntu/14.04/i686/3.13.0-40-generic/arando/2015-09-18%2016:54:52?short

or there

http://patchbot.sagemath.org/log/Pending/8829/Ubuntu/14.04/i686/3.13.0-40-generic/arando/2015-09-18%2012:15:11?short

for example. I have no time to analyse that now.


---

Comment by git created at 2015-09-22 19:09:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-22 19:11:53

This new version should fix the issue with wrong "reporting test failure as pending".

Could you please run that on librae and arando ?


---

Comment by vdelecroix created at 2015-09-22 19:17:58

On librae, the patchbot was stuck (version 2.3.9) with

```
[2015-09-22 19:14:16 +0000] Check base.
git checkout patchbot/base
Already on 'patchbot/base'
git fetch git://github.com/sagemath/sage.git +develop:patchbot/base_upstream
[2015-09-22 19:14:17 +0000] Getting ticket list...
Traceback (most recent call last):
  File ".../patchbot/patchbot.py", line 1260, in main
    patchbot.test_a_ticket(ticket)
  File ".../patchbot/patchbot.py", line 800, in test_a_ticket
    rating, ticket = self.get_one_ticket()
  File ".../bin/patchbot/patchbot.py", line 632, in get_one_ticket
    for t in all))
  File ".../bin/patchbot/patchbot.py", line 632, in <genexpr>
    for t in all))
  File ".../bin/patchbot/patchbot.py", line 722, in rate_ticket
    prune_pending(ticket)
  File ".../patchbot/util.py", line 70, in prune_pending
    elif (now - t).total_seconds() > timeout:
TypeError: can't subtract offset-naive and offset-aware datetimes
```

Do you know if this is fixed?

Vincent


---

Comment by vdelecroix created at 2015-09-22 19:23:57

Launched on librae.


---

Comment by vdelecroix created at 2015-09-22 21:29:09

The [#19125 report](http://patchbot.sagemath.org/log/19125/Ubuntu/14.04/x86_64/3.13.0-63-generic/librae/2015-09-22%2020:59:40?short) and many others say

```
Git branch: patchbot/ticket_merged
Using --optional=mpir,python2,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3186 files using 7 threads.
sage -t --long src/sage/misc/sagedoc.py
**********************************************************************
File "src/sage/misc/sagedoc.py", line 22, in sage.misc.sagedoc
Failed example:
    for line in open(docfilename):
          if "#sage.symbolic.expression.Expression.N" in line:
              print line
Exception raised:
    Traceback (most recent call last):
      File ".../sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File ".../sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sagedoc[1]>", line 1, in <module>
        for line in open(docfilename):
    IOError: [Errno 2] No such file or directory:
    '.../doc/output/html/en/reference/calculus/sage/symbolic/expression.html'
**********************************************************************
```

... it seems that the doc is not built anymore. Note that I had a very special configuration where the plugin "doctest.continuation" is *not* activated. It was stupid from my side but either this plugin is mandatory and it is not a plugin or the patchbot should not run into such troubles.


---

Comment by vdelecroix created at 2015-09-22 21:32:18

And the patchbot seems to avoid testing base now.


---

Comment by vdelecroix created at 2015-09-22 22:41:43

I relaunched the patchbot on librae and it gets better. But still, the doctest construction needs to be fixed (or the status of plugins clearer).


---

Comment by vdelecroix created at 2015-09-22 22:41:43

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-09-23 08:42:05

In the current state, the plugin ￼"plugins.docbuild" is indeed mandatory, otherwise the doc is not build and therefore the tests do not pass.

Some time ago, the doc was build once with a "make" and then again in the optional "docbuild" plugin. Now it is only build once in the plugin.

I can enforce in the code that the plugin "docbuild" is always activated.

OR I can step back and build the doc during the initial "make" call. But then doc failure will be again reported as Build failure, and the "docbuild" plugin will again become useless.

Opinions are required, please.

I find it very annoying that some tests do not pass if the doc is not build.


---

Comment by vdelecroix created at 2015-09-23 11:30:01

Replying to [comment:96 chapoton]:
> I find it very annoying that some tests do not pass if the doc is not build.

We will not change that in this ticket.

> In the current state, the plugin ￼"plugins.docbuild" is indeed mandatory, otherwise the doc is not build and therefore the tests do not pass.
> 
> Some time ago, the doc was build once with a "make" and then again in the optional "docbuild" plugin. Now it is only build once in the plugin.
> 
> I can enforce in the code that the plugin "docbuild" is always activated.
>
> OR I can step back and build the doc during the initial "make" call. But then doc failure will be again reported as Build failure, and the "docbuild" plugin will again become useless.

IMO, it is better to report properly docbuild errors and hence to separate the "make doc" from the "make build". That being said, I have no opinion whether or not the "make doc" process should stay a module. And I have nothing against mandatory modules.


---

Comment by git created at 2015-09-23 13:16:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-23 13:19:07

Here is a new version that always activates the docbuild plugin (unless in plugin_only mode)
so that the tests can pass.

Vincent, do you confirm that there is a problem with testing the base ?


---

Comment by vdelecroix created at 2015-09-23 15:15:51

Replying to [comment:99 chapoton]:
> Vincent, do you confirm that there is a problem with testing the base ?

I don't know. Under which conditions it should check the base? I launched it twice and twice it avoided it.


---

Comment by vdelecroix created at 2015-09-23 15:23:34

Something weird happend with patchbot-2.4.8:

```
[2015-09-23 00:07:24] Getting ticket list...
[2015-09-23 00:07:30] testing found ticket #17096
[2015-09-23 00:07:30] #17096: starting tests
[2015-09-23 15:17:25] #17096 raises an exception: [Errno 32] Broken pipe
```

15 hours is not reasonable to test a ticket. The broken pipe is because I just interrupted it with Ctrl-C. The log `17096-log.txt` just stops after the doc build. I do not know what is going wrong.


---

Comment by vdelecroix created at 2015-09-23 15:28:59

I launched 2.4.9 on librae. And again it did not start with checking the base.

Vincent


---

Comment by jdemeyer created at 2015-09-23 17:26:16

With 2.4.9, something is indeed fishy with the docbuild plugin. Note the "elapsed time" and the total time for the plugin, there is a difference of about 900s:

```
Build finished. The built documents can be found in /home/patchbot/sage-patchbot/src/doc/output/html/en/thematic_tutorials
Elapsed time: 1003.6 seconds.
Done building the documentation!
make[1]: Leaving directory `/home/patchbot/sage-patchbot/build/make'

real    32m6.825s
user    14m4.656s
sys     0m25.444s
Sage build/upgrade complete!
plugins.docbuild -- 1948 seconds
========== end plugins.docbuild ==========
```



---

Comment by chapoton created at 2015-09-23 20:00:28

`@`Jeroen, on which ticket do you see these 900 seconds, please ?

Well, maybe this could be an effect of the grep command in that plugin ?

What is the size of your SAGE_ROOT/logs/dochtml.log ? Mine is 73 Mo

Do you know if the "make doc" command clears this log or not ?


---

Comment by vdelecroix created at 2015-09-23 20:19:54

Patchbot got stuck after 5 tickets

```
$ tail -n 3 history.txt
[2015-09-23 18:48:40] #18223: TestsFailed
[2015-09-23 18:48:49] #18411: starting tests
[2015-09-23 20:18:06] #18411 raises an exception: [Errno 32] Broken pipe
```

(the Broken pipe is because of my Ctrl-C). It seems that the patchbot was doing nothing. Its last line of output was

```
Build finished. The built documents can be found in .../doc/output/html/ca/intro
```


My `dochtml.log` is 14M and `install.log` is 39M.


---

Comment by jdemeyer created at 2015-09-24 07:44:27

Replying to [comment:104 chapoton]:
> `@`Jeroen, on which ticket do you see these 900 seconds, please ?
Ticket #0

> Do you know if the "make doc" command clears this log or not ?
It does not. In fact, Sage logs are never cleared automatically (except with `make distclean`)


---

Comment by jdemeyer created at 2015-09-24 07:47:18

Replying to [comment:104 chapoton]:
> What is the size of your SAGE_ROOT/logs/dochtml.log ?
449 MB


---

Comment by jdemeyer created at 2015-09-24 07:48:47

I don't think you should `grep dochtml.log`. Instead, just check the status of the `make doc` command. If it succeeds, it means that the doc builds fine.


---

Comment by chapoton created at 2015-09-24 08:03:45

Thanks.

I will remove the grep on the logs, but I am afraid that it is not the real problem.

I suspect that pickling may be the cause.. Still investigating.


---

Comment by chapoton created at 2015-09-24 08:11:48

`@`Vincent: very strange, it seems that this is not the usual end of make doc. Could it be that the patchbot was stuck inside the doc building ??

Replying to [comment:105 vdelecroix]:
> Patchbot got stuck after 5 tickets
> {{{
> $ tail -n 3 history.txt
> [2015-09-23 18:48:40] #18223: TestsFailed
> [2015-09-23 18:48:49] #18411: starting tests
> [2015-09-23 20:18:06] #18411 raises an exception: [Errno 32] Broken pipe
> }}}
> (the Broken pipe is because of my Ctrl-C). It seems that the patchbot was doing nothing. Its last line of output was
> {{{
> Build finished. The built documents can be found in .../doc/output/html/ca/intro
> }}}
> 
> My `dochtml.log` is 14M and `install.log` is 39M.


---

Comment by jdemeyer created at 2015-09-25 12:44:37

The patchbot should run `./configure` before testing a ticket: [https://groups.google.com/forum/#!topic/sage-devel/AcwT37Zndeg](https://groups.google.com/forum/#!topic/sage-devel/AcwT37Zndeg)


---

Comment by chapoton created at 2015-09-25 15:00:24

Currently:

```
do_or_die('$MAKE doc-clean')
do_or_die("$MAKE build")  # doc is made later in a plugin
```

Where should I insert the "./configure" ?


---

Comment by jdemeyer created at 2015-09-25 18:36:50

Replying to [comment:112 chapoton]:
> Where should I insert the "./configure" ?
As very first command.


---

Comment by git created at 2015-09-25 19:14:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-25 19:17:42

`@`Jeroen

ok, I have added the ./configure before the make (but not tested the resulting patchbot, sorry). I have also removed the grep in the doc plugins.

`@`Vincent

patchbot 2.4.9 has been working quite good (I think) on arando (including testing the base
when necessary). Have you checked your json config for librae (skip_base in particular) ?


---

Comment by vdelecroix created at 2015-09-25 23:26:39

I launch twice the 2.5.0 patchbot and twice I ran out of memory during the docbuild. I thought that 8G should be enough for that purpose...

Vincent


---

Comment by vdelecroix created at 2015-09-26 10:43:25

Replying to [comment:116 vdelecroix]:
> I launch twice the 2.5.0 patchbot and twice I ran out of memory during the docbuild. I thought that 8G should be enough for that purpose...

Hopefully, it does not seem to be because of the patchbot; see [sage-6.9.rc0 thread on sage-release](https://groups.google.com/forum/#!topic/sage-release/MGkb_-y-moM).


---

Comment by jdemeyer created at 2015-09-26 11:02:53

Docbuilder on arando:

```
Elapsed time: 6632.6 seconds.
Done building the documentation!
make[1]: Leaving directory `/home/patchbot/sage-patchbot/build/make'

real    112m57.498s
user    14m29.724s
sys     1m57.856s
Sage build/upgrade complete!
plugins.docbuild -- 6778 seconds
```



---

Comment by jdemeyer created at 2015-09-26 19:28:45

One more thing: I find it very annoying that the patchbot doesn't respect `$MAKE`. It seems to use 3 threads regardless of `$MAKE`.


---

Comment by jdemeyer created at 2015-09-26 19:30:08

The docbuild really is a problem. I just cannot run a patchbot anymore on `arando`, the machine becomes unresponsive when building the documentation.


---

Comment by chapoton created at 2015-09-26 20:51:47

Replying to [comment:119 jdemeyer]:
> One more thing: I find it very annoying that the patchbot doesn't respect `$MAKE`. It seems to use 3 threads regardless of `$MAKE`.

* Which $MAKE do you want it to respect ? The system-wide MAKE if it is set ?
  The patchbot currently sets MAKE to its own value, with a number of parallel threads      that can be chosen in the config of the patchbot.

* Do you think the problem with the very-long and memory consuming docbuild comes from the patchbot ?


---

Comment by git created at 2015-09-27 07:15:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-27 07:18:02

I have stepped back to use simply "make" in the doc plugins (instead of custom $MAKE).

Hopefully, this can restore the previous behavior of the plugins.


---

Comment by jdemeyer created at 2015-09-27 07:49:04

Replying to [comment:123 chapoton]:
> I have stepped back to use simply "make" in the doc plugins (instead of custom $MAKE).

Please don't! Just respect the existing value of `$MAKE`.


---

Comment by chapoton created at 2015-09-27 08:19:48

Replying to [comment:124 jdemeyer]:
> Replying to [comment:123 chapoton]:
> > I have stepped back to use simply "make" in the doc plugins (instead of custom $MAKE).
> 
> Please don't! Just respect the existing value of `$MAKE`.

Why should I expect that there exists a $MAKE at all?


---

Comment by vdelecroix created at 2015-09-27 18:38:33


```
sage: import os
sage: my_make = os.environ['MAKE'] or 'make -j whathever'
```


EDIT: the solution above will give you a `KeyError` if `MAKE` is not defined... better solution

```
sage: os.getenv('MAKE', default_value)
```



---

Comment by git created at 2015-09-28 09:32:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-09-28 09:35:02

Here is a new version, which should respect your $MAKE if you have one.

Can I hope that there will be a positive review one day ?


---

Comment by jdemeyer created at 2015-09-29 08:22:04

Replying to [comment:128 chapoton]:
> Can I hope that there will be a positive review one day ?

At least, you'll need to set it to needs_review...


---

Comment by chapoton created at 2015-09-29 13:53:53

ok. Is this all ?


---

Comment by chapoton created at 2015-09-29 13:53:53

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-09-30 18:18:33

Please, please, would it be possible to let this get a positive review ?

I know it is not perfect, but it is working, no ?


---

Comment by jdemeyer created at 2015-09-30 18:41:26

I'd like to run my patchbots for a few days and see if things work out...


---

Comment by chapoton created at 2015-09-30 18:48:51

I understand. Let us see if something bad happens..


---

Comment by jdemeyer created at 2015-10-01 10:32:58

Also, I'd really like to investigate better the docbuilding issue.

It's clear to me that there is an issue on arando: until not so long ago, the docbuilding took on the order of minutes to finish, now it's more like 1 hour.


---

Comment by kdilks created at 2015-10-02 17:19:14

I don't know how much technical assistance I can provide, but I am testing the new patchbot on a few different machines. I'll leave them running while I'm out of town for the next few days, and let you know if anything breaks when I get back.


---

Comment by vdelecroix created at 2015-10-05 21:38:43

There is something weird with the following report

    http://patchbot.sagemath.org/log/19345/Ubuntu/14.04/x86_64/3.13.0-65-generic/librae/2015-10-05%2006:12:03?short

There is a timeout problem (apparently because of communication problem with the server). But the patchbot report appears as `TestsFailed`.


---

Comment by vdelecroix created at 2015-10-05 21:43:00

Here is the relevant part from `history.txt`

```
[2015-10-05 05:52:00] #19345: init phase
[2015-10-05 05:54:29] #19345 raises an exception: <urlopen error [Errno 110] Connection timed out>
[2015-10-05 05:54:29] #19345: TestsFailed
[2015-10-05 06:01:37] #19345: TestsFailed
[2015-10-05 06:06:53] #19345: TestsFailed
[2015-10-05 06:12:03] #19345: TestsFailed
```



---

Comment by vdelecroix created at 2015-10-05 21:52:57

Indeed `urllib2.URLError` is more general than `urllib2.HTTPError`...

```
sage: import urllib2
sage: issubclass(urllib2.URLError, urllib2.HTTPError)
False
sage: issubclass(urllib2.HTTPError, urllib2.URLError)
True
```

But only `urllib2.HTTPError` is catch at line `1024` of `patchbot.py`. Maybe it should be changed?

EDIT: but it is not clear what was the error raised!


---

Comment by kdilks created at 2015-10-07 15:02:52

My home server still has issues with the timezone stuff (I'm pretty sure I have all the necessary dependencies, but maybe there's one not listed on the wiki I'm forgetting about?), but things seem to have been running fine for the past 5 days on my home desktop, laptop, and virtual machine on my office computer.


---

Comment by chapoton created at 2015-10-07 15:23:24

Thanks a lot for reporting.

With bot 2.5.2, there is no more any dependency about timezone and the like..

Is your home server also running 2.5.2 ? What is the name of the machine where you see problems ?


---

Comment by kdilks created at 2015-10-08 04:06:21

I was just being dumb. I had downloaded the tarball, but hadn't pulled this ticket. So the installation failed, I didn't pay enough attention to notice, and it was still running the old version.


---

Comment by chapoton created at 2015-10-08 09:14:10

yes, that's the reason why it would be much simpler to have this ticket into positive review, so that one can simply do "sage -i patchbot"


---

Comment by kdilks created at 2015-10-09 16:33:54

I'd be willing to give it a positive review based on usability, but I can't comment at all about quality of the underlying code/documentation/etc.


---

Comment by chapoton created at 2015-10-09 16:45:04

Well, this is only an optional package. This code is not going to be included in sage.

Jeroen and/or Vincent, could you please say your word now ?


---

Comment by jdemeyer created at 2015-10-09 17:43:24

I have no objections to a positive_review.


---

Comment by chapoton created at 2015-10-10 19:05:35

So, could somebody please express more than an absence of objection ?


---

Comment by kdilks created at 2015-10-10 19:08:59

Changing status from needs_review to positive_review.


---

Comment by kdilks created at 2015-10-10 19:08:59

I was giving Vincent a day or two to weigh in. But I guess based on my experience and Jeroen's non-objection, this is good enough for positive review, and any other problems/enhancements/etc. can be part of future tickets.


---

Comment by vbraun created at 2015-10-12 07:16:14

Resolution: fixed
