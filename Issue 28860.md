# Issue 28860: build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall

Issue created by migration from https://trac.sagemath.org/ticket/29097

Original creator: mkoeppe

Original creation time: 2020-01-29 01:51:51

CC:  dimpase embray jhpalmieri slabbe mjo schilly

Cleaning means to remove build artifacts from the directory ``@`builddir`@`` (= SAGE_ROOT).
But these targets *uninstall* packages from ``@`prefix`@`=$SAGE_LOCAL`.


---

Comment by jhpalmieri created at 2020-06-16 21:12:27

There is no reason for any deprecation here, is there? I have a branch that I'm testing out now to do the change "clean -> uninstall", but not the new phony targets `SPKG-deps`.


---

Comment by jhpalmieri created at 2020-06-16 22:19:38

Here is a branch to test out. I wasn't sure about the instruction when docbuilding fails: 

```
    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean" first and try again.
```

There could be artifacts that `make doc-uninstall` won't clean up, so I think I want to keep this as `make doc-clean`. I don't know if it should also suggest running `./bootstrap`, but that's a separate issue.
----
New commits:


---

Comment by mjo created at 2020-06-17 00:18:21

> There could be artifacts that make doc-uninstall won't clean up, so I think I want to keep this as make doc-clean

Right now `doc-clean` does both `doc-src-clean doc-output-clean`. I suggest,

0. Rename `doc-output-clean` to `doc-uninstall` (already done).
1. Drop `doc-clean`
2. Rename `doc-src-clean` to `doc-clean`
3. Change the suggestion to run both `doc-clean` and `doc-uninstall`

That way the targets wind up with the right names, and the suggestion doesn't effectively change.

NB: in this hunk the doc-src-clean was dropped (I don't know which is correct):


```
-doc-html-no-plot: doc-clean $(DOC_DEPENDENCIES)
+doc-html-no-plot: doc-uninstall $(DOC_DEPENDENCIES)
```



---

Comment by jhpalmieri created at 2020-06-17 20:49:28

Replying to [comment:9 mjo]:
> > There could be artifacts that make doc-uninstall won't clean up, so I think I want to keep this as make doc-clean
> 
> Right now `doc-clean` does both `doc-src-clean doc-output-clean`. I suggest,
> 
> 0. Rename `doc-output-clean` to `doc-uninstall` (already done).
> 1. Drop `doc-clean`
> 2. Rename `doc-src-clean` to `doc-clean`
> 3. Change the suggestion to run both `doc-clean` and `doc-uninstall`
> 
> That way the targets wind up with the right names, and the suggestion doesn't effectively change.

My only reluctance is that I am very used to typing `make doc-clean` when working with tickets involving docbuilding. I don't know how many others are in the same habit, but we would all have to change that habit.

> NB: in this hunk the doc-src-clean was dropped (I don't know which is correct):
> 
> {{{
> -doc-html-no-plot: doc-clean $(DOC_DEPENDENCIES)
> +doc-html-no-plot: doc-uninstall $(DOC_DEPENDENCIES)
> }}}

This should be okay: the reason to clean the docs when toggling `doc-html-no-plot` is because inclusion (or not) of plots is cached in the doc output (in local/share/doc/sage/inventory or maybe .../doctrees). So `doc-uninstall` should be good enough. It works for me, at least.


---

Comment by mkoeppe created at 2020-08-10 01:15:52

For the `doc-...` cleaning/uninstalling targets, I would like to understand first whether everything that we put in `$SAGE_LOCAL/share/doc/sage/` should really be installed there. 

Are `doctrees` and `inventory` needed in the installation at all? Do other Python packages install inventory files? Or is this just something that is reused and updated in an incremental docbuild?


---

Comment by jhpalmieri created at 2020-08-10 05:30:57

The inventory files are intended to allow for cross-references among different pieces of the documentation: see https://www.sphinx-doc.org/en/master/usage/extensions/intersphinx.html and `set_intersphinx_mapping` in `src/sage/docs/conf.py`. It allows the tutorial (for example) to refer to the reference manual. For example, the reference `:ref:`sage.rings.padics.tutorial`` in `tour_numtheory.rst` in the tutorial points to the reference manual, and I think this uses the inventory files to construct the link when building the documentation.

According to https://www.sphinx-doc.org/en/master/man/sphinx-build.html, the doctrees are used to cache the parsed source files before writing output. Once the output has been written, they aren't needed, so I guess they could be moved somewhere else, and I'm guessing the same for the inventory files, but I think they are all needed when building the docs.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-07-21 06:35:48

New commits:


---

Comment by mkoeppe created at 2022-07-21 06:35:48

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-07-21 19:03:25

What is the purpose of the `%-SAGE_LOCAL-uninstall` and `%-SAGE_VENV-uninstall` targets? Where are they used?


---

Comment by mkoeppe created at 2022-07-21 19:12:42

Fixed the description to explain it


---

Comment by mkoeppe created at 2022-07-21 19:14:06

Ah, but I can probably do better


---

Comment by git created at 2022-07-21 19:22:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-07-21 22:06:33

Thank you for the explanation and the new target; that now makes sense.

Not from this branch: I don't understand `SAGE_I_TARGETS`. `List of targets that can be run using `sage -i` or `sage -f``. The list contains only `sagelib` and `doc`, so is the implication that one shouldn't use `sage -i sagetex`? As far as I can tell, `SAGE_I_TARGETS` is only used in the `list` target.

Regarding this change in `sage_bootstrap/uninstall.py`:

```
     # The default path to this directory; however its value should be read
     # from the environment if possible
     spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
-    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
```

Is the point that we now have two possible locations for the installation files, either SAGE_LOCAL or SAGE_VENV, so we can't use the single variable `SAGE_SPKG_INST`? I think the comment about reading the value from the environment should probably be removed or changed.

Otherwise things look good.


---

Comment by jhpalmieri created at 2022-07-21 22:10:49

And if you're going to fix the comment about environment variables, maybe also fix the docstring for the function to not refer to just `SAGE_LOCAL` but also `SAGE_VENV`? Or point out in the docstring that the variable `sage_local` should be either `SAGE_LOCAL` or `SAGE_VENV`?


---

Comment by mkoeppe created at 2022-07-21 22:44:11

Replying to [comment:36 jhpalmieri]:
> Regarding this change in `sage_bootstrap/uninstall.py`:
> {{{
>      # The default path to this directory; however its value should be read
>      # from the environment if possible
>      spkg_inst = pth.join(sage_local, 'var', 'lib', 'sage', 'installed')
> -    spkg_inst = os.environ.get('SAGE_SPKG_INST', spkg_inst)
> }}}
> Is the point that we now have two possible locations for the installation files, either SAGE_LOCAL or SAGE_VENV, so we can't use the single variable `SAGE_SPKG_INST`?

Yes.

> I think the comment about reading the value from the environment should probably be removed or changed.

Thanks, I'll fix that


---

Comment by git created at 2022-07-21 22:47:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-21 22:52:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-21 22:52:42

Replying to [comment:37 jhpalmieri]:
> And if you're going to fix the comment about environment variables, maybe also fix the docstring for the function to not refer to just `SAGE_LOCAL` but also `SAGE_VENV`? Or point out in the docstring that the variable `sage_local` should be either `SAGE_LOCAL` or `SAGE_VENV`?

Done, please take a look


---

Comment by git created at 2022-07-21 22:55:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-07-21 23:07:17

Looks good to me. I don't have access to my usual computer so I can't push to trac right now. If you feel like fixing it, there is a typo:

```diff
diff --git a/build/sage_bootstrap/uninstall.py b/build/sage_bootstrap/uninstall.py
index feb91ead158..1ce039921fc 100644
--- a/build/sage_bootstrap/uninstall.py
+++ b/build/sage_bootstrap/uninstall.py
@@ -51,7 +51,7 @@ PKGS = pth.join(SAGE_ROOT, 'build', 'pkgs')
 
 def uninstall(spkg_name, sage_local, keep_files=False, verbose=False):
     """
-    Given a package name and path to an installation tree (SAGE_LOCAL or SAGE_VENV,
+    Given a package name and path to an installation tree (SAGE_LOCAL or SAGE_VENV),
     uninstall that package from that tree if it is currently installed.
     """
 
```



---

Comment by jhpalmieri created at 2022-07-21 23:07:17

Changing status from needs_review to positive_review.


---

Comment by git created at 2022-07-21 23:09:12

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-07-21 23:09:12

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2022-07-21 23:09:36

Thank you!


---

Comment by mkoeppe created at 2022-07-21 23:09:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-28 19:10:23

Resolution: fixed
