# Issue 15226: Implement crystal morphisms, subcrystals, and virtual crystals

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2013-11-28 07:47:43

Assignee: sage-combinat

CC:  sage-combinat aschilling nthiery bsalisbury1

Keywords: crystals, morphisms, subcrystals

This implements:

- Crystal morphisms (usual, twisted, and virtual).
- Subcrystals, so we no long have to do the subset workaround in `digraph()`.
- Virtual crystals, so we can now view the elements in the virtual crystal as a crystal graph.

This also reworks `DirectSumOfCrystals` and `TensorProductOfCrystals` to make them associative as constructions.

After this, we will be able to do coercions between crystals.


---

Comment by git created at 2013-11-28 07:49:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2013-11-28 07:50:38

Also, I'd like to deprecate the method `crystal_morphism` in place of `morphism`, but the KR crystals currently use them. In an ideal world, I'd just do a straight replacement of the method, but this might be too drastic of a change...


---

Comment by tscrim created at 2013-11-28 07:51:14

Changing status from new to needs_review.


---

Comment by nthiery created at 2013-11-28 09:10:14

Replying to [comment:2 tscrim]:
> Also, I'd like to deprecate the method `crystal_morphism` in place of `morphism`,

I am not sure to have all elements of context for the case at hand, but the name ``crystal_morphism`` is a priori better than ``morphim``. For the same reason, we have module_morphism, algebra_morphism etc else where. The point is that if a set has several structures this naming convention avoids conflicts.


---

Comment by aschilling created at 2013-11-28 16:59:48

You definitely need to give references for similarity techniques and virtual crystals!


---

Comment by tscrim created at 2013-11-28 21:11:29

Replying to [comment:5 nthiery]:
> Replying to [comment:2 tscrim]:
> > Also, I'd like to deprecate the method `crystal_morphism` in place of `morphism`,
> 
> I am not sure to have all elements of context for the case at hand, but the name ``crystal_morphism`` is a priori better than ``morphim``. For the same reason, we have module_morphism, algebra_morphism etc else where. The point is that if a set has several structures this naming convention avoids conflicts.

What would you recommend doing? The output/behavior of the method would radically change, but is that okay? Then should we then move the old functionality into KR crystals to avoid rewriting the promotion functionality there? Thanks.


---

Comment by tscrim created at 2014-03-08 17:21:57

Okay, so I've changed KR crystals to return honest crystal morphisms and made `DirectSumOfCrystals` into a proper facade parent (when requested). I've also changed `morphism()` to `crystal_morphism()` and moved the old function to `kirillov_reshetikhin.py` in case we want to revive it. I also added references to `virtual_crystal.py` and had `Subcrystal` redirect to `VirtualCrystal` depending on parameters so we could have in the future a more uniform interface with the `subcrystal()` method.

Here's some timing tests for KR crystals.

The test I ran:

```python
def test_KR(ct, r, s):
    print "construction:"
    %time B = KirillovReshetikhinCrystal(ct, r, s)
    print "TestSuite:"
    %time TestSuite(B).run()
    print "Digraph:"
    %time G = B.digraph()
```


With the branch:

```
sage: test_KR(['A',4,1], 3, 2)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.04 s
TestSuite:
CPU times: user 2.61 s, sys: 0.09 s, total: 2.70 s
Wall time: 3.21 s
Digraph:
CPU times: user 0.23 s, sys: 0.01 s, total: 0.24 s
Wall time: 0.26 s

sage: test_KR(['D',4,1], 2, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.01 s
TestSuite:
CPU times: user 2.07 s, sys: 0.00 s, total: 2.08 s
Wall time: 2.33 s
Digraph:
CPU times: user 0.23 s, sys: 0.01 s, total: 0.24 s
Wall time: 0.27 s

sage: test_KR(['E',6,1], 1, 1)
construction:
CPU times: user 0.19 s, sys: 0.00 s, total: 0.19 s
Wall time: 0.31 s
TestSuite:
CPU times: user 0.57 s, sys: 0.00 s, total: 0.57 s
Wall time: 0.70 s
Digraph:
CPU times: user 0.12 s, sys: 0.02 s, total: 0.14 s
Wall time: 0.16 s

sage: test_KR(['A',6,2], 2, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.02 s
TestSuite:
CPU times: user 2.23 s, sys: 0.01 s, total: 2.24 s
Wall time: 2.71 s
Digraph:
CPU times: user 0.24 s, sys: 0.00 s, total: 0.24 s
Wall time: 0.27 s

sage: test_KR(['D',4,2], 2, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.01 s
TestSuite:
CPU times: user 2.91 s, sys: 0.02 s, total: 2.92 s
Wall time: 3.36 s
Digraph:
CPU times: user 0.27 s, sys: 0.01 s, total: 0.28 s
Wall time: 0.38 s

sage: K = KirillovReshetikhinCrystal(['D',4,1], 2,2)
sage: %time TestSuite(K).run()
CPU times: user 58.50 s, sys: 0.10 s, total: 58.60 s
Wall time: 70.46 s
```

Develop:

```
sage: test_KR(['A',4,1], 3, 2)
construction:
CPU times: user 0.04 s, sys: 0.00 s, total: 0.04 s
Wall time: 0.18 s
TestSuite:
CPU times: user 2.59 s, sys: 0.06 s, total: 2.65 s
Wall time: 3.97 s
Digraph:
CPU times: user 0.23 s, sys: 0.01 s, total: 0.24 s
Wall time: 0.33 s

sage: test_KR(['D',4,1], 2, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.02 s
Wall time: 0.07 s
TestSuite:
CPU times: user 0.52 s, sys: 0.02 s, total: 0.54 s
Wall time: 0.75 s
Digraph:
CPU times: user 0.10 s, sys: 0.00 s, total: 0.10 s
Wall time: 0.12 s

sage: test_KR(['E',6,1], 1, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.02 s
Wall time: 0.07 s
TestSuite:
CPU times: user 0.45 s, sys: 0.00 s, total: 0.45 s
Wall time: 0.58 s
Digraph:
CPU times: user 0.10 s, sys: 0.01 s, total: 0.11 s
Wall time: 0.12 s

sage: test_KR(['A',6,2], 2, 1)
construction:
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.09 s
TestSuite:
CPU times: user 0.64 s, sys: 0.02 s, total: 0.65 s
Wall time: 0.86 s
Digraph:
CPU times: user 0.21 s, sys: 0.00 s, total: 0.21 s
Wall time: 0.28 s

sage: test_KR(['D',4,2], 2, 1)
construction:
CPU times: user 0.00 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.01 s
TestSuite:
CPU times: user 0.38 s, sys: 0.01 s, total: 0.39 s
Wall time: 0.50 s
Digraph:
CPU times: user 0.12 s, sys: 0.01 s, total: 0.13 s
Wall time: 0.28 s

sage: K = KirillovReshetikhinCrystal(['D',4,1], 2,2)
sage: %time TestSuite(K).run()
CPU times: user 5.30 s, sys: 0.02 s, total: 5.32 s
Wall time: 6.30 s
```


So there's a major speed penality with using promotion as a crystal morphism directly. My guess is caused from the fact we are no longer caching things. On develop we have:

```
sage: K = KirillovReshetikhinCrystal(['D',4,1], 2,2)
sage: K.promotion()
Cached version of <function morphism at 0xc77133c>
```

So I have a the following questions:

1 - The code and the documentation for the old `crystal_morphism()` did not match as the default was to not cache (i.e. `cache = False` but the code did return a cached function when the `cache` argument was `False`. Do we want to cache the output of the promotion (or something else that's related)?

2 - Do we want to use honest crystal morphisms or use the old function returned from the old `crystal_morphism()`?

3 - Do we want to have an option to cache the output of a crystal morphism, or morphisms in general?


---

Comment by git created at 2014-03-08 17:22:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-02 01:31:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-09 02:05:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-12 14:33:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-04-13 04:27:29

With the new custom promotion map, I actually get a speedup when running the test suite except with the twisted types -- most likely from the maps to/from the ambient type which aren't cached as well:

```
sage: test_KR(['A',4,1], 3, 2)
construction
CPU times: user 36 ms, sys: 4 ms, total: 40 ms
Wall time: 40.1 ms
TestSuite:
CPU times: user 1.1 s, sys: 36 ms, total: 1.13 s
Wall time: 1.15 s
Digraph:
CPU times: user 144 ms, sys: 4 ms, total: 148 ms
Wall time: 164 ms
sage: test_KR(['A',4,1], 3, 2)
construction
CPU times: user 0 ns, sys: 0 ns, total: 0 ns
Wall time: 240 Âµs
TestSuite:
CPU times: user 708 ms, sys: 24 ms, total: 732 ms
Wall time: 712 ms
Digraph:
CPU times: user 180 ms, sys: 4 ms, total: 184 ms
Wall time: 207 ms
sage: test_KR(['D',4,1], 2, 1)
construction
CPU times: user 24 ms, sys: 4 ms, total: 28 ms
Wall time: 26.5 ms
TestSuite:
CPU times: user 412 ms, sys: 0 ns, total: 412 ms
Wall time: 421 ms
Digraph:
CPU times: user 112 ms, sys: 4 ms, total: 116 ms
Wall time: 126 ms
sage: test_KR(['E',6,1], 1, 1)
construction
CPU times: user 124 ms, sys: 8 ms, total: 132 ms
Wall time: 132 ms
TestSuite:
CPU times: user 232 ms, sys: 0 ns, total: 232 ms
Wall time: 234 ms
Digraph:
CPU times: user 104 ms, sys: 8 ms, total: 112 ms
Wall time: 124 ms
sage: test_KR(['A',6,2], 2, 1)
construction
CPU times: user 12 ms, sys: 4 ms, total: 16 ms
Wall time: 15.3 ms
TestSuite:
CPU times: user 1.2 s, sys: 8 ms, total: 1.2 s
Wall time: 1.23 s
Digraph:
CPU times: user 184 ms, sys: 4 ms, total: 188 ms
Wall time: 200 ms
sage: test_KR(['D',4,2], 2, 1)
construction
CPU times: user 8 ms, sys: 4 ms, total: 12 ms
Wall time: 11 ms
TestSuite:
CPU times: user 1.02 s, sys: 8 ms, total: 1.03 s
Wall time: 1.05 s
Digraph:
CPU times: user 164 ms, sys: 4 ms, total: 168 ms
Wall time: 176 ms
sage: test_KR(['D',4,1], 2, 2)
construction
CPU times: user 20 ms, sys: 0 ns, total: 20 ms
Wall time: 17.7 ms
TestSuite:
CPU times: user 4.07 s, sys: 4 ms, total: 4.07 s
Wall time: 4.08 s
Digraph:
CPU times: user 328 ms, sys: 4 ms, total: 332 ms
Wall time: 344 ms
```

Before:

```
sage: test_KR(['A',4,1], 3, 2)
construction
CPU times: user 32 ms, sys: 0 ns, total: 32 ms
Wall time: 128 ms
TestSuite:
CPU times: user 2.88 s, sys: 72 ms, total: 2.95 s
Wall time: 3.54 s
Digraph:
CPU times: user 236 ms, sys: 8 ms, total: 244 ms
Wall time: 253 ms

sage: test_KR(['D',4,1], 2, 1)
construction
CPU times: user 20 ms, sys: 4 ms, total: 24 ms
Wall time: 58.2 ms
TestSuite:
CPU times: user 528 ms, sys: 12 ms, total: 540 ms
Wall time: 602 ms
Digraph:
CPU times: user 104 ms, sys: 4 ms, total: 108 ms
Wall time: 121 ms

sage: test_KR(['E',6,1], 1, 1)
construction
CPU times: user 28 ms, sys: 8 ms, total: 36 ms
Wall time: 47.7 ms
TestSuite:
CPU times: user 424 ms, sys: 16 ms, total: 440 ms
Wall time: 445 ms
Digraph:
CPU times: user 96 ms, sys: 24 ms, total: 120 ms
Wall time: 128 ms

sage: test_KR(['A',6,2], 2, 1)
construction
CPU times: user 20 ms, sys: 0 ns, total: 20 ms
Wall time: 97.4 ms
TestSuite:
CPU times: user 716 ms, sys: 16 ms, total: 732 ms
Wall time: 762 ms
Digraph:
CPU times: user 168 ms, sys: 8 ms, total: 176 ms
Wall time: 189 ms

sage: test_KR(['D',4,2], 2, 1)
construction
CPU times: user 12 ms, sys: 0 ns, total: 12 ms
Wall time: 11.3 ms
TestSuite:
CPU times: user 404 ms, sys: 28 ms, total: 432 ms
Wall time: 480 ms
Digraph:
CPU times: user 124 ms, sys: 8 ms, total: 132 ms
Wall time: 170 ms

sage: test_KR(['D',4,1], 2, 2)
construction
CPU times: user 16 ms, sys: 4 ms, total: 20 ms
Wall time: 18 ms
TestSuite:
CPU times: user 5.08 s, sys: 12 ms, total: 5.1 s
Wall time: 5.13 s
Digraph:
CPU times: user 312 ms, sys: 4 ms, total: 316 ms
Wall time: 328 ms
```

Now to merge with #15882 and do some work on the doc and make all tests pass.


---

Comment by git created at 2014-04-13 06:47:15

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2014-04-15 02:17:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-14 14:49:26

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-05-14 14:49:26

patchbot:

```
sage -t --long src/sage/combinat/crystals/monomial_crystals.py  # 1 doctest failed
sage -t --long src/sage/matrix/matrix_integer_dense.pyx  # 1 doctest failed
sage -t --long src/sage/combinat/crystals/generalized_young_walls.py  # 7 doctests failed
sage -t --long src/sage/combinat/crystals/infinity_crystals.py  # 8 doctests failed
sage -t --long src/sage/categories/regular_crystals.py  # 1 doctest failed
sage -t --long src/sage/combinat/crystals/direct_sum.py  # 3 doctests failed
sage -t --long src/sage/combinat/crystals/subcrystal.py  # 2 doctests failed
sage -t --long src/sage/combinat/crystals/virtual_crystal.py  # 1 doctest failed
```



---

Comment by git created at 2014-05-15 07:32:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-05-15 07:39:06

Hey Ralf,

Please don't use the patchbot as absolute truth for doctest failures as it can give false negatives. I could not reproduce the integer matrix failures (which is completely unrelated to this ticket). If you're going to change the status of the ticket, I would like you to make sure to actually test the files in question as part of an actual review. Thank you.


---

Comment by tscrim created at 2014-05-15 07:39:21

Changing status from needs_work to needs_review.


---

Comment by rws created at 2014-05-15 08:18:59

Will do!


---

Comment by git created at 2014-05-17 19:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-26 03:44:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-15 14:06:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-16 08:18:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-17 05:44:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-25 20:57:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-09-25 20:58:57

Conflicts with #16001.


---

Comment by git created at 2015-03-17 18:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-04-09 19:56:49

many failing doctests, see patchbot report


---

Comment by chapoton created at 2015-04-09 19:56:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-15 20:48:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-16 17:29:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-16 17:34:06

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-06-16 17:34:06

I simplified the classes for the different types of crystal morphisms down to a single class as Anne and I discussed.

I also implemented a `subtype` method for `CartanType` to simplify the overall interface so that crystal morphisms does not directly depend on the index set (instead it is indirectly as part of the Cartan type).


---

Comment by chapoton created at 2015-06-17 10:11:21

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-06-17 10:11:21

4 doctests failing, and one old-style raise statement re-introduced


---

Comment by git created at 2015-06-17 19:38:10

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-06-17 19:39:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-17 19:41:41

Fixed.

#18453 introduced a bug in computing the weight for elements in the highest weight Nakajima monomial model (mainly, the weight of any highest weight element is 0). I have fixed it on this branch, but if this will not be getting in soon, we should split that fix off into a separate branch.


---

Comment by tscrim created at 2015-06-17 19:41:41

Changing status from needs_work to needs_review.


---

Comment by aschilling created at 2015-06-17 20:00:32

Replying to [comment:40 tscrim]:
> Fixed.
> 
> #18453 introduced a bug in computing the weight for elements in the highest weight Nakajima monomial model (mainly, the weight of any highest weight element is 0). I have fixed it on this branch, but if this will not be getting in soon, we should split that fix off into a separate branch.

If there is a bug in Nakajima monomials, I suggest that you split that off (since I will have quite a few changes to this patch) and discuss it with Ben (as he did most of the changes in #18453 to Nakajima monomials).

Best,

Anne


---

Comment by tscrim created at 2015-06-17 20:17:02

This is now #18722.


---

Comment by git created at 2015-06-17 20:18:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 04:18:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-21 02:56:28

Hi Travis,

Here are some comments on the current branch:

- I am not quite sure how to use the induced crystal. Either the code is wrong or the documentation needs to be updated

```
sage: X = Words(2,4)
sage: L = crystals.Letters(['A',1])
sage: T = crystals.TensorProduct(*[L]*4)
sage: Phi = lambda x : Word([i.value for i in x])
sage: I = crystals.Induced(T,Phi,preimage=X,from_crystal=True)
sage: b = I[0]
sage: b
word: 1111
sage: b.parent()
Crystal induced by <function <lambda> at 0x1102d8c80> from Full tensor product of the crystals [The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1]]
sage: b.f(1)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-43-0a3acf464041> in <module>()
----> 1 b.f(Integer(1))

/Applications/sage/local/lib/python2.7/site-packages/sage/combinat/crystals/induced_structure.pyc in f(self, i)
    593             """
    594             P = self.parent()
--> 595             ret = P._preimage(self.value).f(i)
    596             if ret is None:
    597                 return None

AttributeError: 'FiniteWord_list' object has no attribute 'f'
```


- The other way is really also not what one would expect

```
sage: X = Words(2,4)
sage: L = crystals.Letters(['A',1])
sage: T = crystals.TensorProduct(*[L]*4)
sage: Phi = lambda x : T(*[L(i) for i in x])
sage: I = crystals.Induced(X,Phi,preimage=T)
sage: view(I)
```


- Many of the morphism methods do not work

```
sage: B = crystals.Tableaux(['C',2], shape=[1,1])
sage: C = crystals.Tableaux(['C',2], ([2,1], [1,1]))
sage: psi = B.crystal_morphism(C.module_generators[1:], codomain=C)
sage: psi.is_surjective()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-64-cf3b5c84f16e> in <module>()
----> 1 psi.is_surjective()

/Applications/sage/src/sage/categories/map.pyx in sage.categories.map.Map.is_surjective (/Applications/sage/src/build/cythonized/sage/categories/map.c:8344)()
   1207             NotImplementedError: <type 'sage.categories.map.Map'>
   1208         """
-> 1209         raise NotImplementedError, type(self)
   1210 
   1211     def __pow__(Map self, n, dummy):

NotImplementedError: <class 'sage.categories.highest_weight_crystals.HighestWeightCrystalHomset_with_category.element_class'>
sage: psi.is_zero()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-65-39b9856b43ed> in <module>()
----> 1 psi.is_zero()

/Applications/sage/src/sage/structure/element.pyx in sage.structure.element.Element.is_zero (/Applications/sage/src/build/cythonized/sage/structure/element.c:8906)()
    905             implement ``__nonzero__`` instead.
    906         """
--> 907         return not self
    908 
    909     cdef int _cmp(self, other) except -2:

/Applications/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__nonzero__ (/Applications/sage/src/build/cythonized/sage/structure/element.c:8819)()
    891             False
    892         """
--> 893         return self != self._parent.zero()
    894 
    895     def is_zero(self):

/Applications/sage/src/sage/structure/parent.pyx in sage.structure.parent.Parent.__getattr__ (/Applications/sage/src/build/cythonized/sage/structure/parent.c:7833)()
    839             return self.__cached_methods[name]
    840         except KeyError:
--> 841             attr = getattr_from_other_class(self, self._category.parent_class, name)
    842             self.__cached_methods[name] = attr
    843             return attr

/Applications/sage/src/sage/structure/misc.pyx in sage.structure.misc.getattr_from_other_class (/Applications/sage/src/build/cythonized/sage/structure/misc.c:1580)()
    251         dummy_error_message.cls = type(self)
    252         dummy_error_message.name = name
--> 253         raise dummy_attribute_error
    254     try:
    255         attribute = getattr(cls, name)

AttributeError: 'HighestWeightCrystalHomset_with_category_with_equality_by_id' object has no attribute 'zero'
```


- subcrystals now has options ``virtualization``, ``scaling_factors``, but there are no examples on how to use them. Please add examples that test all options.

- What is the status on the slow down that you mentioned earlier for KR crystals? I think such a huge slow down would not be acceptable (since they are anyway slow already).

So much for now,

Anne


---

Comment by tscrim created at 2015-06-21 06:37:27

Replying to [comment:45 aschilling]:
> - I am not quite sure how to use the induced crystal. Either the code is wrong or the documentation needs to be updated
> {{{
> sage: X = Words(2,4)
> sage: L = crystals.Letters(['A',1])
> sage: T = crystals.TensorProduct(*[L]*4)
> sage: Phi = lambda x : Word([i.value for i in x])
> sage: I = crystals.Induced(T,Phi,preimage=X,from_crystal=True)
> sage: b = I[0]
> sage: b
> word: 1111
> sage: b.parent()
> Crystal induced by <function <lambda> at 0x1102d8c80> from Full tensor product of the crystals [The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1], The crystal of letters for type ['A', 1]]
> sage: b.f(1)
> ---------------------------------------------------------------------------
> AttributeError                            Traceback (most recent call last)
> <ipython-input-43-0a3acf464041> in <module>()
> ----> 1 b.f(Integer(1))
> 
> /Applications/sage/local/lib/python2.7/site-packages/sage/combinat/crystals/induced_structure.pyc in f(self, i)
>     593             """
>     594             P = self.parent()
> --> 595             ret = P._preimage(self.value).f(i)
>     596             if ret is None:
>     597                 return None
> 
> AttributeError: 'FiniteWord_list' object has no attribute 'f'
> }}}
> 
> - The other way is really also not what one would expect
> {{{
> sage: X = Words(2,4)
> sage: L = crystals.Letters(['A',1])
> sage: T = crystals.TensorProduct(*[L]*4)
> sage: Phi = lambda x : T(*[L(i) for i in x])
> sage: I = crystals.Induced(X,Phi,preimage=T)
> sage: view(I)
> }}}

I will take a look at this in more detail and update documentation/examples accordingly.

> - Many of the morphism methods do not work
> {{{
> sage: B = crystals.Tableaux(['C',2], shape=[1,1])
> sage: C = crystals.Tableaux(['C',2], ([2,1], [1,1]))
> sage: psi = B.crystal_morphism(C.module_generators[1:], codomain=C)
> sage: psi.is_surjective()
> [...]
> NotImplementedError: <class 'sage.categories.highest_weight_crystals.HighestWeightCrystalHomset_with_category.element_class'>
> }}}

In general, this is an undecidable problem and should result in this error. However, since this is a morphism of a finite crystal, this should work at the very least by brute force. Will implement.

> {{{
> sage: psi.is_zero()
> [...]
> AttributeError: 'HighestWeightCrystalHomset_with_category_with_equality_by_id' object has no attribute 'zero'
> }}}

This is easy enough to check as long as the crystals have a finite generating set; otherwise it may run forever.

> - subcrystals now has options ``virtualization``, ``scaling_factors``, but there are no examples on how to use them. Please add examples that test all options.

Will do.

> - What is the status on the slow down that you mentioned earlier for KR crystals? I think such a huge slow down would not be acceptable (since they are anyway slow already).

See comment:15. Overall it seems the caching and construction of the morphisms I do is faster than before. However there seems to be some slowdowns when there is no caching (and for some object creations, but these are acceptable IMO as it is small in absolute time and the creation of KR crystals is infrequent). I can try and optimize it more if you think what is currently there is insufficient.


---

Comment by git created at 2015-06-21 19:36:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-21 19:40:27

I've added support for many of the methods for the morphisms (and generalized them so that they work when the domain is finite).

For the induced crystals, `preimage` was the wrong word; it should have been `inverse`. I've updated the documentation accordingly.

Do you want me to try and further optimize the KR crystals?


---

Comment by aschilling created at 2015-06-21 21:58:00

> For the induced crystals, `preimage` was the wrong word; it should have been `inverse`. I've updated the documentation accordingly.

Well, Travis, it still does not work

```
sage: X = Words(2,4)
sage: L = crystals.Letters(['A',1])
sage: T = crystals.TensorProduct(*[L]*4)
sage: Phi = lambda x : T(*[L(i) for i in x])
sage: I = crystals.Induced(X,Phi)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-21-64af8dd3a5ae> in <module>()
----> 1 I = crystals.Induced(X,Phi)

/Applications/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (/Applications/sage/src/build/cythonized/sage/misc/classcall_metaclass.c:1207)()
    324         """
    325         if cls.classcall is not None:
--> 326             return cls.classcall(cls, *args, **kwds)
    327         else:
    328             # Fast version of type.__call__(cls, *args, **kwds)

/Applications/sage/local/lib/python2.7/site-packages/sage/combinat/crystals/induced_structure.pyc in __classcall_private__(cls, X, phi, inverse, codomain, from_crystal)
    134                 codomain = phi(X.an_element()).parent()
    135 
--> 136         return super(InducedCrystal, cls).__classcall__(cls, X, phi, inverse, codomain)
    137 
    138     def __init__(self, X, phi, inverse, codomain):

/Applications/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.WeakCachedFunction.__call__ (/Applications/sage/src/build/cythonized/sage/misc/cachefunc.c:8111)()
   1308             except TypeError: # k is not hashable
   1309                 k = (_cache_key,_cache_key(k))
-> 1310                 return self.cache[k]
   1311         except KeyError:
   1312             w = self.f(*args, **kwds)

/Applications/sage/src/sage/misc/weak_dict.pyx in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/Applications/sage/src/build/cythonized/sage/misc/weak_dict.c:3661)()
    876 
    877         """
--> 878         cdef PyObject* wr = PyDict_GetItemWithError(self, k)
    879         if wr == NULL:
    880             raise KeyError(k)

/Applications/sage/src/sage/misc/weak_dict.pyx in sage.misc.weak_dict.PyDict_GetItemWithError (/Applications/sage/src/build/cythonized/sage/misc/weak_dict.c:1073)()
    147     cdef PyDictEntry* ep
    148     cdef PyDictObject* mp = <PyDictObject*><void *>op
--> 149     ep = mp.ma_lookup(mp, <PyObject*><void*>key, PyObject_Hash(key))
    150     if ep:
    151         return ep.me_value

TypeError: unhashable type: 'dict'
```

So please either remove this from the patch or fix it and show me how to do it in the above example.

Thanks,

Anne


---

Comment by git created at 2015-06-22 02:01:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-22 02:02:48

Hmmm....that's an interesting way for an unhashable to be obtained and shows what I get for only testing by explicitly constructing the inverse map and passing that in. I've moved the logic for determining an inverse map when none is specified into the appropriate classes, so it should work now.


---

Comment by aschilling created at 2015-06-22 18:18:48

Replying to [comment:51 tscrim]:
> Hmmm....that's an interesting way for an unhashable to be obtained and shows what I get for only testing by explicitly constructing the inverse map and passing that in. I've moved the logic for determining an inverse map when none is specified into the appropriate classes, so it should work now.

Ok, it works better now. But why do you let the user input the inverse function? Is it checked that the function is the inverse and that the result is a crystal? The following gives the wrong results (I agree that Phi_inv is not the inverse of Phi, but this could happen by accident):

```
sage: X = Words(2,3)
sage: L = crystals.Letters(['A',1])
sage: T = crystals.TensorProduct(*[L]*3)
sage: Phi = lambda x : Word([i.value for i in x])
sage: Phi_inv = lambda x : T(*[L(i) for i in x.reversal()])
sage: I = crystals.Induced(T,Phi,Phi_inv,from_crystal=True)
sage: view(I)
```

Also, I was able to input the wrong codomain and the code did not complain. Why should this be inputted?

Best,

Anne


---

Comment by tscrim created at 2015-06-22 18:46:26

Replying to [comment:52 aschilling]:
> Replying to [comment:51 tscrim]:
> > Hmmm....that's an interesting way for an unhashable to be obtained and shows what I get for only testing by explicitly constructing the inverse map and passing that in. I've moved the logic for determining an inverse map when none is specified into the appropriate classes, so it should work now.
> 
> Ok, it works better now. But why do you let the user input the inverse function? Is it checked that the function is the inverse and that the result is a crystal? The following gives the wrong results (I agree that Phi_inv is not the inverse of Phi, but this could happen by accident):
> {{{
> sage: X = Words(2,3)
> sage: L = crystals.Letters(['A',1])
> sage: T = crystals.TensorProduct(*[L]*3)
> sage: Phi = lambda x : Word([i.value for i in x])
> sage: Phi_inv = lambda x : T(*[L(i) for i in x.reversal()])
> sage: I = crystals.Induced(T,Phi,Phi_inv,from_crystal=True)
> sage: view(I)
> }}}

I made it this way because I wanted it to work with infinite sets. For finite sets, I could add an explicit check that it is the inverse function (with an optional check argument).

> Also, I was able to input the wrong codomain and the code did not complain. Why should this be inputted?

I guess I really don't need this since I'm operating under the assumption that the crystal is non-empty. Will change.

Note for self, add examples for virtualization arguments to subcrystal.


---

Comment by git created at 2015-07-07 01:28:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-11 12:06:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-12 11:45:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-12 11:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-12 11:51:54

I get doctest failures:

```
sage -t ../../categories/crystals.py
**********************************************************************
File "../../categories/crystals.py", line 395, in sage.categories.crystals.Crystals.ParentMethods.?
Failed example:
    list(C.subcrystal(index_set=[1,3], generators=[C(1,4)], direction='upper'))
Expected:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro)]
Got:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro), [This is the Trac macro *2, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 3-macro)]
**********************************************************************
File "../../categories/crystals.py", line 397, in sage.categories.crystals.Crystals.ParentMethods.?
Failed example:
    list(C.subcrystal(index_set=[1,3], generators=[C(1,4)], direction='lower'))
Expected:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro)]
Got:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro), [This is the Trac macro *2, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 3-macro)]
**********************************************************************
File "../../categories/crystals.py", line 1641, in sage.categories.crystals.Crystals.ElementMethods.?
Failed example:
    list(elt.subcrystal(index_set=[1,3], direction='upper'))
Expected:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro)]
Got:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro), [This is the Trac macro *2, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 3-macro)]
**********************************************************************
File "../../categories/crystals.py", line 1643, in sage.categories.crystals.Crystals.ElementMethods.?
Failed example:
    list(elt.subcrystal(index_set=[1,3], direction='lower'))
Expected:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro)]
Got:
    [This is the Trac macro *[1, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1, 4-macro), [This is the Trac macro *2, 4* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 4-macro), [This is the Trac macro *1, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 3-macro), [This is the Trac macro *2, 3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#2, 3-macro)]
**********************************************************************
[...]
sage -t subcrystal.py
**********************************************************************
File "subcrystal.py", line 74, in sage.combinat.crystals.subcrystal.Subcrystal
Failed example:
    S.cardinality()
Expected:
    11
Got:
    20
**********************************************************************
File "subcrystal.py", line 97, in sage.combinat.crystals.subcrystal.Subcrystal
Failed example:
    list(U)
Expected:
    [[[1, 1], [2]]]
Got:
    [[[1, 1], [2]],
     [[1, 1], [3]],
     [[1, 2], [2]],
     [[1, 2], [3]],
     [[1, 3], [2]],
     [[1, 3], [3]],
     [[2, 2], [3]],
     [[2, 3], [3]]]
**********************************************************************
```

that I am working on fixing, but the rest of my changes are good and up for review.


---

Comment by chapoton created at 2015-07-12 11:52:49

could you please correct the INPUT:: and OUTPUT:: that you introduce ?


---

Comment by git created at 2015-07-12 11:55:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-12 11:56:38

I found the `INPUT::` mistake(s). Good catch, thanks! (Although I couldn't find any `OUTPUT::`.)


---

Comment by git created at 2015-07-12 12:00:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-12 12:03:07

All bugs should be gone now.


---

Comment by git created at 2015-07-13 03:57:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-13 04:57:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-13 06:00:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-13 07:03:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-13 07:32:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-13 10:21:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-07-13 11:17:54

I get the following doctest failure

```
sage -t --long affinization.py
**********************************************************************
File "affinization.py", line 235, in sage.combinat.crystals.affinization.AffinizationOfCrystal.Element.__lt__
Failed example:
    sorted(S)
Expected:
    [[[1, 1], [2, 2]](0),
     [[1, 1], [2, 3]](0),
     [[1, 2], [2, 3]](0),
     [[1, 1], [3, 3]](0),
     [[1, 1], [2, 3]](1),
     [[1, 2], [2, 3]](1),
     [[1, 2], [3, 3]](1),
     [[2, 2], [3, 3]](2)]
Got:
    [[[1, 1], [2, 2]](0),
     [[1, 2], [2, 3]](1),
     [[1, 1], [2, 3]](0),
     [[1, 2], [3, 3]](1),
     [[1, 1], [2, 3]](1),
     [[1, 2], [2, 3]](0),
     [[1, 1], [3, 3]](0),
     [[2, 2], [3, 3]](2)]
**********************************************************************
```



---

Comment by git created at 2015-07-13 11:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-13 11:27:17

I implemented the necessary `__lt__`. My Sage is still recompiling; could you fix the doctest I added?


---

Comment by git created at 2015-07-13 11:48:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-07-13 11:54:01

Ok, looks good now!


---

Comment by aschilling created at 2015-07-13 11:54:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-07-13 11:55:04

Thank you!


---

Comment by vbraun created at 2015-07-13 20:59:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-07-13 20:59:26

Tests fail


---

Comment by git created at 2015-07-13 23:22:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-13 23:27:16

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2015-07-13 23:27:16

Trivial failures because the elements for subcrystals are now ordered by the `__lt__` added.


---

Comment by vbraun created at 2015-07-14 22:37:31

Some `# long time` tests still fail


---

Comment by vbraun created at 2015-07-14 22:37:31

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2015-07-14 23:32:05

So the issue is in `rigged_configurations/bij_infinity.py` where we test elements in a subcrystal, whose elements are no longer elements in the crystal and there is no coercion map from the subcrystal to the ambient crystal. I'm working on implementing the coercion.


---

Comment by git created at 2015-07-15 00:19:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-15 00:21:13

So implementing the coercion and getting those tests to work seems to be a minor can of worms. Instead I just changed the tests to work (and they are still testing what they should be).


---

Comment by tscrim created at 2015-07-15 00:21:19

Changing status from needs_work to needs_review.


---

Comment by aschilling created at 2015-07-15 01:29:07

Tests pass for me now!


---

Comment by aschilling created at 2015-07-15 01:29:26

Tests pass for me now!


---

Comment by aschilling created at 2015-07-15 01:29:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-27 15:15:58

Resolution: fixed
