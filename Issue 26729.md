# Issue 26729: py3: new doctest failures in homology

archive/issues_026729.json:
```json
{
    "body": "With Python 3, before #26931:\n\n```\nsage -t src/sage/homology/simplicial_complex.py  # 22 doctests failed\nsage -t src/sage/homology/examples.py  # 7 doctests failed\n```\n\nAfter #26931:\n\n```\nsage -t src/sage/homology/examples.py  # 14 doctests failed\nsage -t src/sage/homology/simplicial_complex.py  # 35 doctests failed\nsage -t src/sage/homology/simplicial_set.py  # 6 doctests failed\nsage -t src/sage/homology/delta_complex.py  # 3 doctests failed\nsage -t src/sage/homology/simplicial_complexes_catalog.py  # 3 doctests failed\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26966\n\n",
    "created_at": "2018-12-28T22:33:23Z",
    "labels": [
        "python3",
        "critical",
        "bug"
    ],
    "title": "py3: new doctest failures in homology",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26729",
    "user": "jhpalmieri"
}
```
With Python 3, before #26931:

```
sage -t src/sage/homology/simplicial_complex.py  # 22 doctests failed
sage -t src/sage/homology/examples.py  # 7 doctests failed
```

After #26931:

```
sage -t src/sage/homology/examples.py  # 14 doctests failed
sage -t src/sage/homology/simplicial_complex.py  # 35 doctests failed
sage -t src/sage/homology/simplicial_set.py  # 6 doctests failed
sage -t src/sage/homology/delta_complex.py  # 3 doctests failed
sage -t src/sage/homology/simplicial_complexes_catalog.py  # 3 doctests failed
```


Issue created by migration from https://trac.sagemath.org/ticket/26966





---

archive/issue_comments_375961.json:
```json
{
    "body": "The failures come from trying to sort vertices. Before #26931, there was a fallback to use `str` as a key, but that was removed.\n\n```\nFile \"src/sage/homology/simplicial_complexes_catalog.py\", line 57, in sage.homology.simplicial_complexes_catalog\nFailed example:\n    simplicial_complexes.SurfaceOfGenus(3)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.homology.simplicial_complexes_catalog[2]>\", line 1, in <module>\n        simplicial_complexes.SurfaceOfGenus(Integer(3))\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/examples.py\", line 451, in SurfaceOfGenus\n        S = S.connected_sum(T)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/simplicial_complex.py\", line 2770, in connected_sum\n        return SimplicialComplex(facet_set, is_mutable=is_mutable)\n      File \"/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/simplicial_complex.py\", line 1040, in __init__\n        vertex_set = sorted(vertex_set)\n    TypeError: '<' not supported between instances of 'str' and 'int'\n```\n",
    "created_at": "2018-12-28T22:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375961",
    "user": "jhpalmieri"
}
```

The failures come from trying to sort vertices. Before #26931, there was a fallback to use `str` as a key, but that was removed.

```
File "src/sage/homology/simplicial_complexes_catalog.py", line 57, in sage.homology.simplicial_complexes_catalog
Failed example:
    simplicial_complexes.SurfaceOfGenus(3)
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.homology.simplicial_complexes_catalog[2]>", line 1, in <module>
        simplicial_complexes.SurfaceOfGenus(Integer(3))
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/examples.py", line 451, in SurfaceOfGenus
        S = S.connected_sum(T)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/simplicial_complex.py", line 2770, in connected_sum
        return SimplicialComplex(facet_set, is_mutable=is_mutable)
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/PYTHON3/sage-8.5/local/lib/python3.6/site-packages/sage/homology/simplicial_complex.py", line 1040, in __init__
        vertex_set = sorted(vertex_set)
    TypeError: '<' not supported between instances of 'str' and 'int'
```




---

archive/issue_comments_375962.json:
```json
{
    "body": "I don't know if this branch is the correct approach, but it helps. If it is the correct approach, it is incomplete: at #26966, I included a list of some of the methods which need attention paid to how vertices are sorted:\n\n- product\n- join\n- disjoint_union\n- wedge\n- connected_sum\n- link\n- star\n- generated_subcomplex\n- alexander_dual\n- stellar_subdivision\n- n_skeleton\n- connected_component\n- fixed_complex\n- intersection\n- `_contractible_subcomplex`\n- `_enlarge_subcomplex`\n- `__copy__`\n\nThis list may not be complete, and the branch here only deals with a few of these.",
    "created_at": "2018-12-29T21:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375962",
    "user": "jhpalmieri"
}
```

I don't know if this branch is the correct approach, but it helps. If it is the correct approach, it is incomplete: at #26966, I included a list of some of the methods which need attention paid to how vertices are sorted:

- product
- join
- disjoint_union
- wedge
- connected_sum
- link
- star
- generated_subcomplex
- alexander_dual
- stellar_subdivision
- n_skeleton
- connected_component
- fixed_complex
- intersection
- `_contractible_subcomplex`
- `_enlarge_subcomplex`
- `__copy__`

This list may not be complete, and the branch here only deals with a few of these.



---

archive/issue_comments_375963.json:
```json
{
    "body": "I don't agree with\n\n```diff\ndiff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py\nindex 946eda0..fd88c23 100644\n--- a/src/sage/homology/simplicial_complex.py\n+++ b/src/sage/homology/simplicial_complex.py\n@@ -1037,7 +1037,10 @@ class SimplicialComplex(Parent, GenericCellComplex):\n             vertex_set = range(n + 1)\n \n         if sort_facets is True:\n-            vertex_set = sorted(vertex_set)\n+            try:\n+                vertex_set = sorted(vertex_set)\n+            except TypeError:\n+                vertex_set = sorted(vertex_set, key=str)\n         elif callable(sort_facets):\n             vertex_set = sorted(vertex_set, key=sort_facets)\n         elif not sort_facets:\n```\n\nbecause it's rather arbitrary and ill-defined.\n----\nNew commits:",
    "created_at": "2018-12-30T01:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375963",
    "user": "jdemeyer"
}
```

I don't agree with

```diff
diff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py
index 946eda0..fd88c23 100644
--- a/src/sage/homology/simplicial_complex.py
+++ b/src/sage/homology/simplicial_complex.py
@@ -1037,7 +1037,10 @@ class SimplicialComplex(Parent, GenericCellComplex):
             vertex_set = range(n + 1)
 
         if sort_facets is True:
-            vertex_set = sorted(vertex_set)
+            try:
+                vertex_set = sorted(vertex_set)
+            except TypeError:
+                vertex_set = sorted(vertex_set, key=str)
         elif callable(sort_facets):
             vertex_set = sorted(vertex_set, key=sort_facets)
         elif not sort_facets:
```

because it's rather arbitrary and ill-defined.
----
New commits:



---

archive/issue_comments_375964.json:
```json
{
    "body": "Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?",
    "created_at": "2018-12-30T01:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375964",
    "user": "jdemeyer"
}
```

Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?



---

archive/issue_comments_375965.json:
```json
{
    "body": "For example, in `MooreSpace`, the obvious solution to me is to use only strings as vertices, i.e. replace `1` by `\"1\"`.",
    "created_at": "2018-12-30T01:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375965",
    "user": "jdemeyer"
}
```

For example, in `MooreSpace`, the obvious solution to me is to use only strings as vertices, i.e. replace `1` by `"1"`.



---

archive/issue_comments_375966.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?\n\nI don't think we should impose restrictions on what users might choose to do. We can choose good defaults for the specific examples (like `MooreSpace`), but if someone wants to form a disjoint union from a complex whose vertices are integers with another whose vertices are strings, we should allow that.",
    "created_at": "2018-12-30T02:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375966",
    "user": "jhpalmieri"
}
```

Replying to [comment:5 jdemeyer]:
> Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?

I don't think we should impose restrictions on what users might choose to do. We can choose good defaults for the specific examples (like `MooreSpace`), but if someone wants to form a disjoint union from a complex whose vertices are integers with another whose vertices are strings, we should allow that.



---

archive/issue_comments_375967.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> I don't agree with\n> {{{\n> #!diff\n> diff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py\n> index 946eda0..fd88c23 100644\n> --- a/src/sage/homology/simplicial_complex.py\n> +++ b/src/sage/homology/simplicial_complex.py\n> `@``@` -1037,7 +1037,10 `@``@` class SimplicialComplex(Parent, GenericCellComplex):\n>              vertex_set = range(n + 1)\n>  \n>          if sort_facets is True:\n> -            vertex_set = sorted(vertex_set)\n> +            try:\n> +                vertex_set = sorted(vertex_set)\n> +            except TypeError:\n> +                vertex_set = sorted(vertex_set, key=str)\n>          elif callable(sort_facets):\n>              vertex_set = sorted(vertex_set, key=sort_facets)\n>          elif not sort_facets:\n> }}}\n> because it's rather arbitrary and ill-defined.\n\nOn the other hand, it's the old behavior, so it's safe. We could throw in a warning if the `except` clause ever kicks in, to try to discourage it.",
    "created_at": "2018-12-30T02:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375967",
    "user": "jhpalmieri"
}
```

Replying to [comment:4 jdemeyer]:
> I don't agree with
> {{{
> #!diff
> diff --git a/src/sage/homology/simplicial_complex.py b/src/sage/homology/simplicial_complex.py
> index 946eda0..fd88c23 100644
> --- a/src/sage/homology/simplicial_complex.py
> +++ b/src/sage/homology/simplicial_complex.py
> `@``@` -1037,7 +1037,10 `@``@` class SimplicialComplex(Parent, GenericCellComplex):
>              vertex_set = range(n + 1)
>  
>          if sort_facets is True:
> -            vertex_set = sorted(vertex_set)
> +            try:
> +                vertex_set = sorted(vertex_set)
> +            except TypeError:
> +                vertex_set = sorted(vertex_set, key=str)
>          elif callable(sort_facets):
>              vertex_set = sorted(vertex_set, key=sort_facets)
>          elif not sort_facets:
> }}}
> because it's rather arbitrary and ill-defined.

On the other hand, it's the old behavior, so it's safe. We could throw in a warning if the `except` clause ever kicks in, to try to discourage it.



---

archive/issue_comments_375968.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> Replying to [comment:5 jdemeyer]:\n> > Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?\n> \n> I don't think we should impose restrictions on what users might choose to do.\n\nI didn't say that we should. I'm just saying that, if the user does that, they have to explicitly specify the sorting key. Otherwise, it's too fragile (for example, code will behave *differently* on Python 2 and Python 3).",
    "created_at": "2018-12-30T12:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375968",
    "user": "jdemeyer"
}
```

Replying to [comment:7 jhpalmieri]:
> Replying to [comment:5 jdemeyer]:
> > Do you know why unsortable lists of vertices are so common in simplicial complexes? Is there a single place where these mixed `int`/`str` vertices come from?
> 
> I don't think we should impose restrictions on what users might choose to do.

I didn't say that we should. I'm just saying that, if the user does that, they have to explicitly specify the sorting key. Otherwise, it's too fragile (for example, code will behave *differently* on Python 2 and Python 3).



---

archive/issue_comments_375969.json:
```json
{
    "body": "I feel like the sort key should mainly be internal, and users should not have to worry about it. Sorting the vertices needs to be done consistently for each simplicial complex, but maybe it's not important if, as the simplicial complex changes, the sorting changes. The ticket description at #26931 sounds compelling, but in retrospect, I'm not convinced. I could easily imagine a user doing this:\n\n```\nsage: T = SimplicialComplex([range(1,5)])\nsage: T.add_face([0,1,'*']) # add a new distinguished vertex\nsage: T.homology()\n...\nTypeError: '<' not supported between instances of 'str' and 'int'\n```\n",
    "created_at": "2018-12-30T18:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375969",
    "user": "jhpalmieri"
}
```

I feel like the sort key should mainly be internal, and users should not have to worry about it. Sorting the vertices needs to be done consistently for each simplicial complex, but maybe it's not important if, as the simplicial complex changes, the sorting changes. The ticket description at #26931 sounds compelling, but in retrospect, I'm not convinced. I could easily imagine a user doing this:

```
sage: T = SimplicialComplex([range(1,5)])
sage: T.add_face([0,1,'*']) # add a new distinguished vertex
sage: T.homology()
...
TypeError: '<' not supported between instances of 'str' and 'int'
```




---

archive/issue_comments_375970.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> I feel like the sort key should mainly be internal, and users should not have to worry about it.\n\nLet me ask an even more basic question: why do we need to sort anything at all? If it's not to hard to drop that, we should go for it. Especially if it's meant to be internal as you say, there shouldn't be a fundamental reason why vertices need to be sorted.",
    "created_at": "2018-12-30T20:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375970",
    "user": "jdemeyer"
}
```

Replying to [comment:10 jhpalmieri]:
> I feel like the sort key should mainly be internal, and users should not have to worry about it.

Let me ask an even more basic question: why do we need to sort anything at all? If it's not to hard to drop that, we should go for it. Especially if it's meant to be internal as you say, there shouldn't be a fundamental reason why vertices need to be sorted.



---

archive/issue_comments_375971.json:
```json
{
    "body": "In order to compute homology, each simplex needs to be sorted consistently with the other simplices, and the easiest way to achieve that is a total ordering on the vertices. I don't know a minimal example, but if you turn off sorting, then the homology of `simplicial_complexes.ComplexProjectivePlane()` is wrong. That is:\n\n```\nS = SimplicialComplex([[1, 2, 4, 5, 6], [2, 3, 5, 6, 4], [3, 1, 6, 4, 5],\n         [1, 2, 4, 5, 9], [2, 3, 5, 6, 7], [3, 1, 6, 4, 8],\n         [2, 3, 6, 4, 9], [3, 1, 4, 5, 7], [1, 2, 5, 6, 8],\n         [3, 1, 5, 6, 9], [1, 2, 6, 4, 7], [2, 3, 4, 5, 8],\n         [4, 5, 7, 8, 9], [5, 6, 8, 9, 7], [6, 4, 9, 7, 8],\n         [4, 5, 7, 8, 3], [5, 6, 8, 9, 1], [6, 4, 9, 7, 2],\n         [5, 6, 9, 7, 3], [6, 4, 7, 8, 1], [4, 5, 8, 9, 2],\n         [6, 4, 8, 9, 3], [4, 5, 9, 7, 1], [5, 6, 7, 8, 2],\n         [7, 8, 1, 2, 3], [8, 9, 2, 3, 1], [9, 7, 3, 1, 2],\n         [7, 8, 1, 2, 6], [8, 9, 2, 3, 4], [9, 7, 3, 1, 5],\n         [8, 9, 3, 1, 6], [9, 7, 1, 2, 4], [7, 8, 2, 3, 5],\n         [9, 7, 2, 3, 6], [7, 8, 3, 1, 4], [8, 9, 1, 2, 5]],\n        sort_facets=False)\nS.homology()\n```\n\nproduces the wrong answer: `{0: 0, 1: 0, 2: C2, 3: 0, 4: 0}` instead of `{0: 0, 1: 0, 2: Z, 3: 0, 4: Z}`.",
    "created_at": "2018-12-30T21:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375971",
    "user": "jhpalmieri"
}
```

In order to compute homology, each simplex needs to be sorted consistently with the other simplices, and the easiest way to achieve that is a total ordering on the vertices. I don't know a minimal example, but if you turn off sorting, then the homology of `simplicial_complexes.ComplexProjectivePlane()` is wrong. That is:

```
S = SimplicialComplex([[1, 2, 4, 5, 6], [2, 3, 5, 6, 4], [3, 1, 6, 4, 5],
         [1, 2, 4, 5, 9], [2, 3, 5, 6, 7], [3, 1, 6, 4, 8],
         [2, 3, 6, 4, 9], [3, 1, 4, 5, 7], [1, 2, 5, 6, 8],
         [3, 1, 5, 6, 9], [1, 2, 6, 4, 7], [2, 3, 4, 5, 8],
         [4, 5, 7, 8, 9], [5, 6, 8, 9, 7], [6, 4, 9, 7, 8],
         [4, 5, 7, 8, 3], [5, 6, 8, 9, 1], [6, 4, 9, 7, 2],
         [5, 6, 9, 7, 3], [6, 4, 7, 8, 1], [4, 5, 8, 9, 2],
         [6, 4, 8, 9, 3], [4, 5, 9, 7, 1], [5, 6, 7, 8, 2],
         [7, 8, 1, 2, 3], [8, 9, 2, 3, 1], [9, 7, 3, 1, 2],
         [7, 8, 1, 2, 6], [8, 9, 2, 3, 4], [9, 7, 3, 1, 5],
         [8, 9, 3, 1, 6], [9, 7, 1, 2, 4], [7, 8, 2, 3, 5],
         [9, 7, 2, 3, 6], [7, 8, 3, 1, 4], [8, 9, 1, 2, 5]],
        sort_facets=False)
S.homology()
```

produces the wrong answer: `{0: 0, 1: 0, 2: C2, 3: 0, 4: 0}` instead of `{0: 0, 1: 0, 2: Z, 3: 0, 4: Z}`.



---

archive/issue_comments_375972.json:
```json
{
    "body": "If the only requirement is a predictable ordering, you could have a dict mapping arbitrary vertices to integers and use that to sort.",
    "created_at": "2019-01-02T18:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375972",
    "user": "jdemeyer"
}
```

If the only requirement is a predictable ordering, you could have a dict mapping arbitrary vertices to integers and use that to sort.



---

archive/issue_comments_375973.json:
```json
{
    "body": "For example, the already-existing attribute `_vertex_set` could be used for that: we could implement a `set`-like class which internally uses a `dict` to store a `vertex: index` mapping.",
    "created_at": "2019-01-02T18:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375973",
    "user": "jdemeyer"
}
```

For example, the already-existing attribute `_vertex_set` could be used for that: we could implement a `set`-like class which internally uses a `dict` to store a `vertex: index` mapping.



---

archive/issue_comments_375974.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-03T19:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375974",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_375975.json:
```json
{
    "body": "Okay, here is an attempt at not sorting vertices (publicly) any more. A few Python 3 doctests have random outputs, since if vertices cannot be sorted, they aren't, and the doctests give different outputs depending on the order of the vertices. I've marked one as `# py3 # random` and I've made another Python 2 only.",
    "created_at": "2019-01-03T19:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375975",
    "user": "jhpalmieri"
}
```

Okay, here is an attempt at not sorting vertices (publicly) any more. A few Python 3 doctests have random outputs, since if vertices cannot be sorted, they aren't, and the doctests give different outputs depending on the order of the vertices. I've marked one as `# py3 # random` and I've made another Python 2 only.



---

archive/issue_comments_375976.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-03T19:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375976",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375977.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-03T20:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375977",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_375978.json:
```json
{
    "body": "1. What's the use case for trying to sort anyway? That way, you make doctests different on Python 2 and Python 3 for no good reason.\n\n2. Use dict comprehension instead of `dict((x,y) ....)` for example here:\n\n```\n        vertex_to_index = dict((vertex, i) for i, vertex\n                               in enumerate(vertices))\n```\n\n\n3. `self._vertex_to_index` seems redundant with `self._vertex_set`. It seems that `self._vertex_to_index` could replace `self._vertex_set`.",
    "created_at": "2019-01-03T20:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375978",
    "user": "jdemeyer"
}
```

1. What's the use case for trying to sort anyway? That way, you make doctests different on Python 2 and Python 3 for no good reason.

2. Use dict comprehension instead of `dict((x,y) ....)` for example here:

```
        vertex_to_index = dict((vertex, i) for i, vertex
                               in enumerate(vertices))
```


3. `self._vertex_to_index` seems redundant with `self._vertex_set`. It seems that `self._vertex_to_index` could replace `self._vertex_set`.



---

archive/issue_comments_375979.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> 1. What's the use case for trying to sort anyway? That way, you make doctests different on Python 2 and Python 3 for no good reason.\n\nI tried without any sorting, but it didn't work well. Various methods rely on sorting: for example, when you take the product of simplicial complexes, if you want to triangulate the product of two edges, there are two choices, and which choice depends on how the vertices are ordered. Another example: when you compute the fundamental group, the presentation of the group depends on how the vertices and edges are sorted. So if nothing is sorted, lots of doctests break and/or the code needs special cases. Why not order if it's easy? Looking to the future when we switch to Python 3, it makes a lot of sense to sort the vertices if the vertices are just integers, and that's what I have in mind in the sorting code.\n\n> 2. Use dict comprehension instead of `dict((x,y) ....)` for example here:\n> {{{\n>         vertex_to_index = dict((vertex, i) for i, vertex\n>                                in enumerate(vertices))\n> }}}\n\nI can do that. Is this just a stylistic choice, or is it better to use dict comprehension for other reasons?\n \n> 3. `self._vertex_to_index` seems redundant with `self._vertex_set`. It seems that `self._vertex_to_index` could replace `self._vertex_set`.\n \nThat shouldn't be hard to do.",
    "created_at": "2019-01-03T22:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375979",
    "user": "jhpalmieri"
}
```

Replying to [comment:17 jdemeyer]:
> 1. What's the use case for trying to sort anyway? That way, you make doctests different on Python 2 and Python 3 for no good reason.

I tried without any sorting, but it didn't work well. Various methods rely on sorting: for example, when you take the product of simplicial complexes, if you want to triangulate the product of two edges, there are two choices, and which choice depends on how the vertices are ordered. Another example: when you compute the fundamental group, the presentation of the group depends on how the vertices and edges are sorted. So if nothing is sorted, lots of doctests break and/or the code needs special cases. Why not order if it's easy? Looking to the future when we switch to Python 3, it makes a lot of sense to sort the vertices if the vertices are just integers, and that's what I have in mind in the sorting code.

> 2. Use dict comprehension instead of `dict((x,y) ....)` for example here:
> {{{
>         vertex_to_index = dict((vertex, i) for i, vertex
>                                in enumerate(vertices))
> }}}

I can do that. Is this just a stylistic choice, or is it better to use dict comprehension for other reasons?
 
> 3. `self._vertex_to_index` seems redundant with `self._vertex_set`. It seems that `self._vertex_to_index` could replace `self._vertex_set`.
 
That shouldn't be hard to do.



---

archive/issue_comments_375980.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-04T01:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375980",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375981.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-04T01:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375981",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_375982.json:
```json
{
    "body": "Replying to [comment:18 jhpalmieri]:\n> Various methods rely on sorting\n\nWell, that's a problem. If things rely on sorting, then allowing the sort to fail is bad.\n\nI much prefer either always sorting or never sorting to this \"compromise\" of trying to sort.",
    "created_at": "2019-01-04T07:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375982",
    "user": "jdemeyer"
}
```

Replying to [comment:18 jhpalmieri]:
> Various methods rely on sorting

Well, that's a problem. If things rely on sorting, then allowing the sort to fail is bad.

I much prefer either always sorting or never sorting to this "compromise" of trying to sort.



---

archive/issue_comments_375983.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Replying to [comment:18 jhpalmieri]:\n> > Various methods rely on sorting\n> \n> Well, that's a problem. If things rely on sorting, then allowing the sort to fail is bad.\n\n\"Bad\" is a bit strong. The answers can vary if the order varies (as will happen if the vertices are unsorted), but the answers will still be mathematically correct.\n \n> I much prefer either always sorting or never sorting to this \"compromise\" of trying to sort.\n\nHow much work should be put into this? You don't like it when I add a fallback to sort using `str`, so what do you suggest? And note that the compromise works pretty well. In practice, most simplicial complexes will have sortable vertices (either integers or tuples of integers). With the current branch, there are only two doctests with unpredictable results in Python 3: the one in `simplicial_set.py` now marked \"random\", and this:\n\n```\n            sage: G = (S1.wedge(S1)).flip_graph()\n            sage: G.vertices(); G.edges(labels=False) # py2\n            [(0, 'L1'), (0, 'L2'), (0, 'R1'), (0, 'R2'), ('L1', 'L2'), ('R1', 'R2')]\n            [((0, 'L1'), (0, 'L2')),\n             ((0, 'L1'), (0, 'R1')),\n             ((0, 'L1'), (0, 'R2')),\n             ((0, 'L1'), ('L1', 'L2')),\n             ((0, 'L2'), (0, 'R1')),\n             ((0, 'L2'), (0, 'R2')),\n             ((0, 'L2'), ('L1', 'L2')),\n             ((0, 'R1'), (0, 'R2')),\n             ((0, 'R1'), ('R1', 'R2')),\n             ((0, 'R2'), ('R1', 'R2'))]\n```\n\nWith Python 3, the vertices may be ordered randomly, and the same with the edges. Not a big deal, I think.",
    "created_at": "2019-01-04T17:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375983",
    "user": "jhpalmieri"
}
```

Replying to [comment:21 jdemeyer]:
> Replying to [comment:18 jhpalmieri]:
> > Various methods rely on sorting
> 
> Well, that's a problem. If things rely on sorting, then allowing the sort to fail is bad.

"Bad" is a bit strong. The answers can vary if the order varies (as will happen if the vertices are unsorted), but the answers will still be mathematically correct.
 
> I much prefer either always sorting or never sorting to this "compromise" of trying to sort.

How much work should be put into this? You don't like it when I add a fallback to sort using `str`, so what do you suggest? And note that the compromise works pretty well. In practice, most simplicial complexes will have sortable vertices (either integers or tuples of integers). With the current branch, there are only two doctests with unpredictable results in Python 3: the one in `simplicial_set.py` now marked "random", and this:

```
            sage: G = (S1.wedge(S1)).flip_graph()
            sage: G.vertices(); G.edges(labels=False) # py2
            [(0, 'L1'), (0, 'L2'), (0, 'R1'), (0, 'R2'), ('L1', 'L2'), ('R1', 'R2')]
            [((0, 'L1'), (0, 'L2')),
             ((0, 'L1'), (0, 'R1')),
             ((0, 'L1'), (0, 'R2')),
             ((0, 'L1'), ('L1', 'L2')),
             ((0, 'L2'), (0, 'R1')),
             ((0, 'L2'), (0, 'R2')),
             ((0, 'L2'), ('L1', 'L2')),
             ((0, 'R1'), (0, 'R2')),
             ((0, 'R1'), ('R1', 'R2')),
             ((0, 'R2'), ('R1', 'R2'))]
```

With Python 3, the vertices may be ordered randomly, and the same with the edges. Not a big deal, I think.



---

archive/issue_comments_375984.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> the answers will still be mathematically correct.\n\nOK, in that case I misunderstood what you said in [comment:18].\n\nI would suggest then to not sort and just replace the doctest outputs with the different-but-equally-correct outputs.",
    "created_at": "2019-01-04T18:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375984",
    "user": "jdemeyer"
}
```

Replying to [comment:22 jhpalmieri]:
> the answers will still be mathematically correct.

OK, in that case I misunderstood what you said in [comment:18].

I would suggest then to not sort and just replace the doctest outputs with the different-but-equally-correct outputs.



---

archive/issue_comments_375985.json:
```json
{
    "body": "I was wrong about one thing: when you are dealing with the product of a simplicial complex K with itself, you have to sort the vertices in the product consistently with the sorting of the vertices in K, or else the diagonal map may not be defined properly. So we need some sort of sorting. I can see two easy options:\n\n- always sort using `key=str`. Consistent, but '10' comes before '9', which is a little annoying to me.\n- test somehow to see if the vertices can be sorted well. Maybe just test to see if they are integers or tuples of integers (the most common cases) and sort those the default way. Sort using `key=str` in all other cases. I don't know of any way to force Python 2 to behave like Python 3 with regard to sorting. There is no analogue of `from __future__ import print_function` for sorting, is there?",
    "created_at": "2019-01-08T22:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375985",
    "user": "jhpalmieri"
}
```

I was wrong about one thing: when you are dealing with the product of a simplicial complex K with itself, you have to sort the vertices in the product consistently with the sorting of the vertices in K, or else the diagonal map may not be defined properly. So we need some sort of sorting. I can see two easy options:

- always sort using `key=str`. Consistent, but '10' comes before '9', which is a little annoying to me.
- test somehow to see if the vertices can be sorted well. Maybe just test to see if they are integers or tuples of integers (the most common cases) and sort those the default way. Sort using `key=str` in all other cases. I don't know of any way to force Python 2 to behave like Python 3 with regard to sorting. There is no analogue of `from __future__ import print_function` for sorting, is there?



---

archive/issue_comments_375986.json:
```json
{
    "body": "Replying to [comment:24 jhpalmieri]:\n> - always sort using `key=str`. Consistent, but '10' comes before '9', which is a little annoying to me.\n\nNot guaranteed to be consistent either, since `str()` does not have to be an injective function:\n\n```\nsage: L1 = [1.0 + 2^-52, 1.0]; L2 = reversed(L1)\nsage: sorted(L1, key=str) == sorted(L2, key=str)\nFalse\n```\n",
    "created_at": "2019-01-09T09:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375986",
    "user": "jdemeyer"
}
```

Replying to [comment:24 jhpalmieri]:
> - always sort using `key=str`. Consistent, but '10' comes before '9', which is a little annoying to me.

Not guaranteed to be consistent either, since `str()` does not have to be an injective function:

```
sage: L1 = [1.0 + 2^-52, 1.0]; L2 = reversed(L1)
sage: sorted(L1, key=str) == sorted(L2, key=str)
False
```




---

archive/issue_comments_375987.json:
```json
{
    "body": "Any suggestions, then? I suppose we could delete all of the simplicial complex code.",
    "created_at": "2019-01-09T16:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375987",
    "user": "jhpalmieri"
}
```

Any suggestions, then? I suppose we could delete all of the simplicial complex code.



---

archive/issue_comments_375988.json:
```json
{
    "body": "I could do the sort of test you gave: compare `sorted(vertices, key=str)` with `sorted(reversed(vertices), key=str)` (or using whatever key is appropriate). If this is `False`, print a warning when constructing the product of a complex with itself.\n\nI don't know of any other case in which the sorting makes a difference. For homology, for example, the facets are sorted once in the `__init__` method, and that sorting is all that is necessary.",
    "created_at": "2019-01-09T18:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375988",
    "user": "jhpalmieri"
}
```

I could do the sort of test you gave: compare `sorted(vertices, key=str)` with `sorted(reversed(vertices), key=str)` (or using whatever key is appropriate). If this is `False`, print a warning when constructing the product of a complex with itself.

I don't know of any other case in which the sorting makes a difference. For homology, for example, the facets are sorted once in the `__init__` method, and that sorting is all that is necessary.



---

archive/issue_comments_375989.json:
```json
{
    "body": "And to confirm, if I create a simplicial complex with vertices with nonunique string representations and sort always using `key=str`, the diagonal map can break. With my own branch which sorts exclusively by str:\n\n```\nsage: K = SimplicialComplex([[1.0 + 2^-52, 1.0]])\nsage: L = K.product(K)\nsage: d = Hom(K,L).diagonal_morphism()\nsage: d.associated_chain_complex_morphism()\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: matrices must define a chain complex morphism\n```\n\n\nEdit: this case is actually worse because in the product `L`, the vertices are named using string representations, so there is only one vertex, not four, as there should be. (Each vertex is named `'L1.00000000000000R1.00000000000000'`, and since they all have the same name, they are viewed as the same vertex.) You can avoid this as follows:\n\n```\nsage: K = SimplicialComplex([[1.0 + 2^-52, 1.0]])\nsage: L = K.product(K, rename_vertices=False)\nsage: d = Hom(K,L).diagonal_morphism(rename_vertices=False)\nsage: d.associated_chain_complex_morphism()\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n...\nValueError: matrices must define a chain complex morphism\n```\n\nNow the names of the vertices cause bad sorting, and so the purported map `d` does not induce a chain map as it should. This is the same problem that arises with other complexes if we don't sort at all.",
    "created_at": "2019-01-09T18:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375989",
    "user": "jhpalmieri"
}
```

And to confirm, if I create a simplicial complex with vertices with nonunique string representations and sort always using `key=str`, the diagonal map can break. With my own branch which sorts exclusively by str:

```
sage: K = SimplicialComplex([[1.0 + 2^-52, 1.0]])
sage: L = K.product(K)
sage: d = Hom(K,L).diagonal_morphism()
sage: d.associated_chain_complex_morphism()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: matrices must define a chain complex morphism
```


Edit: this case is actually worse because in the product `L`, the vertices are named using string representations, so there is only one vertex, not four, as there should be. (Each vertex is named `'L1.00000000000000R1.00000000000000'`, and since they all have the same name, they are viewed as the same vertex.) You can avoid this as follows:

```
sage: K = SimplicialComplex([[1.0 + 2^-52, 1.0]])
sage: L = K.product(K, rename_vertices=False)
sage: d = Hom(K,L).diagonal_morphism(rename_vertices=False)
sage: d.associated_chain_complex_morphism()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: matrices must define a chain complex morphism
```

Now the names of the vertices cause bad sorting, and so the purported map `d` does not induce a chain map as it should. This is the same problem that arises with other complexes if we don't sort at all.



---

archive/issue_comments_375990.json:
```json
{
    "body": "Replying to [comment:26 jhpalmieri]:\n> Any suggestions, then? I suppose we could delete all of the simplicial complex code.\n\nAs I suggested several times: just don't sort at all. That's how we have been fixing other sorting-related bugs (for example in incidence structures, graphs, ...).",
    "created_at": "2019-01-10T08:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375990",
    "user": "jdemeyer"
}
```

Replying to [comment:26 jhpalmieri]:
> Any suggestions, then? I suppose we could delete all of the simplicial complex code.

As I suggested several times: just don't sort at all. That's how we have been fixing other sorting-related bugs (for example in incidence structures, graphs, ...).



---

archive/issue_comments_375991.json:
```json
{
    "body": "Jeroen - this might need a novel definition for homology to work smoothly...\n\nI'd say: always sort. This \"unsortable\" insanity of py3 has already taken its toll on the progress of porting to py3.",
    "created_at": "2019-01-10T12:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375991",
    "user": "dimpase"
}
```

Jeroen - this might need a novel definition for homology to work smoothly...

I'd say: always sort. This "unsortable" insanity of py3 has already taken its toll on the progress of porting to py3.



---

archive/issue_comments_375992.json:
```json
{
    "body": "Replying to [comment:30 dimpase]:\n> Jeroen - this might need a novel definition for homology to work smoothly...\n\nI think you are confusing two kinds of sorting introduced by this ticket.\n\nOne is the sorting using `vertex_to_index` which is perfectly fine. It allows consistent ordering of vertices which is indeed required for homology computations.\n\nThe sorting that I object to is this one:\n\n```\n        try:\n            # If vertices can be sorted, sort them.\n            vertices = tuple(sorted(vertices))\n        except TypeError:\n            pass\n```\n\nThis shouldn't be needed for anything. It also adds (rather than solves) problems with porting to Python 3 since this code behaves differently on Python 2 and Python 3.",
    "created_at": "2019-01-10T12:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375992",
    "user": "jdemeyer"
}
```

Replying to [comment:30 dimpase]:
> Jeroen - this might need a novel definition for homology to work smoothly...

I think you are confusing two kinds of sorting introduced by this ticket.

One is the sorting using `vertex_to_index` which is perfectly fine. It allows consistent ordering of vertices which is indeed required for homology computations.

The sorting that I object to is this one:

```
        try:
            # If vertices can be sorted, sort them.
            vertices = tuple(sorted(vertices))
        except TypeError:
            pass
```

This shouldn't be needed for anything. It also adds (rather than solves) problems with porting to Python 3 since this code behaves differently on Python 2 and Python 3.



---

archive/issue_comments_375993.json:
```json
{
    "body": "The vertex sorting is needed but just for one thing: for the diagonal map `X -> X x X` to be defined properly. If you sort the vertices in the product incompatibly with the sorting in the original simplicial complex, you can end up with a square triangulated the wrong way, so the diagonal map is not a map of simplicial complexes. So you really do need to sort the vertices.\n\nAs Jeroen says in his last comment, the `vertex_to_index` dictionary is sufficient sorting for homology.",
    "created_at": "2019-01-10T16:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375993",
    "user": "jhpalmieri"
}
```

The vertex sorting is needed but just for one thing: for the diagonal map `X -> X x X` to be defined properly. If you sort the vertices in the product incompatibly with the sorting in the original simplicial complex, you can end up with a square triangulated the wrong way, so the diagonal map is not a map of simplicial complexes. So you really do need to sort the vertices.

As Jeroen says in his last comment, the `vertex_to_index` dictionary is sufficient sorting for homology.



---

archive/issue_comments_375994.json:
```json
{
    "body": "Or maybe there is a way to use the `vertex_to_index` sorting when defining the product, although that take some work to implement. I'll have to think about that.",
    "created_at": "2019-01-10T16:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375994",
    "user": "jhpalmieri"
}
```

Or maybe there is a way to use the `vertex_to_index` sorting when defining the product, although that take some work to implement. I'll have to think about that.



---

archive/issue_comments_375995.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T23:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375995",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_375996.json:
```json
{
    "body": "The last commit undoes a large part of the previous one, but oh well. This now does not sort vertices at all. It uses `sort_facets` as an optional argument to allow users to specify the dictionary which converts vertices to integers. This optional argument is only used when taking the product of a simplicial complex with itself. A few doctests had to be changed. In some cases, I knew what they were testing and could provide suitable replacements. In one (for `flip_graph`), it wasn't clear what the point was, so I replaced with something that I think captures the right spirit.",
    "created_at": "2019-01-11T23:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375996",
    "user": "jhpalmieri"
}
```

The last commit undoes a large part of the previous one, but oh well. This now does not sort vertices at all. It uses `sort_facets` as an optional argument to allow users to specify the dictionary which converts vertices to integers. This optional argument is only used when taking the product of a simplicial complex with itself. A few doctests had to be changed. In some cases, I knew what they were testing and could provide suitable replacements. In one (for `flip_graph`), it wasn't clear what the point was, so I replaced with something that I think captures the right spirit.



---

archive/issue_comments_375997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-11T23:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375997",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375998.json:
```json
{
    "body": "I made a few other changes in here. For example, the change\n\n```diff\n@@ -1692,10 +1708,7 @@ class SimplicialComplex(Parent, GenericCellComplex):\n         # construct a graph with one vertex for each facet, one edge\n         # when two facets intersect in a (d-1)-simplex, and see\n         # whether that graph is connected.\n-        V = [f.set() for f in self.facets()]\n-        E = (lambda a, b: len(a.intersection(b)) == d)\n-        g = Graph([V, E])\n-        return g.is_connected()\n+        return self.flip_graph().is_connected()\n \n     def product(self, right, rename_vertices=True, is_mutable=True):\n         \"\"\"\n```\n\nis an attempt to make the documentation for `flip_graph` correct: it says `The flip graph is used to detect if ``self`` is a pseudomanifold.`",
    "created_at": "2019-01-11T23:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375998",
    "user": "jhpalmieri"
}
```

I made a few other changes in here. For example, the change

```diff
@@ -1692,10 +1708,7 @@ class SimplicialComplex(Parent, GenericCellComplex):
         # construct a graph with one vertex for each facet, one edge
         # when two facets intersect in a (d-1)-simplex, and see
         # whether that graph is connected.
-        V = [f.set() for f in self.facets()]
-        E = (lambda a, b: len(a.intersection(b)) == d)
-        g = Graph([V, E])
-        return g.is_connected()
+        return self.flip_graph().is_connected()
 
     def product(self, right, rename_vertices=True, is_mutable=True):
         """
```

is an attempt to make the documentation for `flip_graph` correct: it says `The flip graph is used to detect if ``self`` is a pseudomanifold.`



---

archive/issue_comments_375999.json:
```json
{
    "body": "By the way, a few doctests were changed from a known output to a random output or to ellipses. In these cases, the answer will depend on, for example, how the vertices are sorted in\n\n```\nvertex_to_index = {v:i for i,v in enumerate(vertices)}\n```\n\nwhich is more or less random. It can certainly depend on whether you are using Python 2 vs. Python 3, and at least with Python 3, it will be random.",
    "created_at": "2019-01-11T23:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-375999",
    "user": "jhpalmieri"
}
```

By the way, a few doctests were changed from a known output to a random output or to ellipses. In these cases, the answer will depend on, for example, how the vertices are sorted in

```
vertex_to_index = {v:i for i,v in enumerate(vertices)}
```

which is more or less random. It can certainly depend on whether you are using Python 2 vs. Python 3, and at least with Python 3, it will be random.



---

archive/issue_comments_376000.json:
```json
{
    "body": "Some minor comments:\n\nInstead of `lambda x: vertex_to_index[x]`, you can use `vertex_to_index.__getitem__` (which I believe is faster).\n\nAlso, this `try` block is if the `max` is empty, right:\n\n```diff\n        try:\n            idx = max(vertex_to_index.values()) + 1\n        except ValueError:\n            idx = 0\n```\n\nso you should be able to do this:\n\n```python\n        if vertex_to_index:\n            idx = max(vertex_to_index.values()) + 1\n        else:\n            idx = 0\n```\n\n\nI would pull out the `self._translation_to_numeric()` call here so it is not called on every `key` call:\n\n```\nsimplex = Simplex(sorted(face, key=lambda x: self._translation_to_numeric()[x]))\n```\n\n\nI think the latter syntax is easier to read (IIRC, it is also a little faster too):\n\n```diff\n-dict((g, i) for i, g in enumerate(gens))\n+{g: i for i, g in enumerate(gens)}\n```\n\nYou might also be able to simply do `dict(enumerate(gens))` too.",
    "created_at": "2019-01-13T17:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376000",
    "user": "tscrim"
}
```

Some minor comments:

Instead of `lambda x: vertex_to_index[x]`, you can use `vertex_to_index.__getitem__` (which I believe is faster).

Also, this `try` block is if the `max` is empty, right:

```diff
        try:
            idx = max(vertex_to_index.values()) + 1
        except ValueError:
            idx = 0
```

so you should be able to do this:

```python
        if vertex_to_index:
            idx = max(vertex_to_index.values()) + 1
        else:
            idx = 0
```


I would pull out the `self._translation_to_numeric()` call here so it is not called on every `key` call:

```
simplex = Simplex(sorted(face, key=lambda x: self._translation_to_numeric()[x]))
```


I think the latter syntax is easier to read (IIRC, it is also a little faster too):

```diff
-dict((g, i) for i, g in enumerate(gens))
+{g: i for i, g in enumerate(gens)}
```

You might also be able to simply do `dict(enumerate(gens))` too.



---

archive/issue_comments_376001.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-13T19:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376001",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376002.json:
```json
{
    "body": "Replying to [comment:39 tscrim]:\n> Some minor comments:\n\n[snip]\n \n> I think the latter syntax is easier to read (IIRC, it is also a little faster too):\n> {{{#!diff\n> -dict((g, i) for i, g in enumerate(gens))\n> +{g: i for i, g in enumerate(gens)}\n> }}}\n> You might also be able to simply do `dict(enumerate(gens))` too.\n\nI agree with everything except the very last sentence: `dict(enumerate(gens))` would be equivalent to `{i:g for i,g in enumerate(gens)}`, but I want `g:i`, not `i:g`.",
    "created_at": "2019-01-13T19:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376002",
    "user": "jhpalmieri"
}
```

Replying to [comment:39 tscrim]:
> Some minor comments:

[snip]
 
> I think the latter syntax is easier to read (IIRC, it is also a little faster too):
> {{{#!diff
> -dict((g, i) for i, g in enumerate(gens))
> +{g: i for i, g in enumerate(gens)}
> }}}
> You might also be able to simply do `dict(enumerate(gens))` too.

I agree with everything except the very last sentence: `dict(enumerate(gens))` would be equivalent to `{i:g for i,g in enumerate(gens)}`, but I want `g:i`, not `i:g`.



---

archive/issue_comments_376003.json:
```json
{
    "body": "Replying to [comment:41 jhpalmieri]:\n> Replying to [comment:39 tscrim]:\n> > I think the latter syntax is easier to read (IIRC, it is also a little faster too):\n> > {{{#!diff\n> > -dict((g, i) for i, g in enumerate(gens))\n> > +{g: i for i, g in enumerate(gens)}\n> > }}}\n> > You might also be able to simply do `dict(enumerate(gens))` too.\n> \n> I agree with everything except the very last sentence: `dict(enumerate(gens))` would be equivalent to `{i:g for i,g in enumerate(gens)}`, but I want `g:i`, not `i:g`.\n\nAh, right. I will try to finish the review in a day or two.",
    "created_at": "2019-01-13T20:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376003",
    "user": "tscrim"
}
```

Replying to [comment:41 jhpalmieri]:
> Replying to [comment:39 tscrim]:
> > I think the latter syntax is easier to read (IIRC, it is also a little faster too):
> > {{{#!diff
> > -dict((g, i) for i, g in enumerate(gens))
> > +{g: i for i, g in enumerate(gens)}
> > }}}
> > You might also be able to simply do `dict(enumerate(gens))` too.
> 
> I agree with everything except the very last sentence: `dict(enumerate(gens))` would be equivalent to `{i:g for i,g in enumerate(gens)}`, but I want `g:i`, not `i:g`.

Ah, right. I will try to finish the review in a day or two.



---

archive/issue_comments_376004.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376004",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_376005.json:
```json
{
    "body": "Two additional things; everything else LGTM.\n\n- `return tuple(self._vertex_to_index.keys())` is better as `return tuple(self._vertex_to_index)`\n- In `product`, is there some way we can avoid creating two simplicial complexes? I imagine it is slower to do it twice. Why not for the first case return the simplicial complex and for the second use the `facets`?",
    "created_at": "2019-01-15T22:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376005",
    "user": "tscrim"
}
```

Two additional things; everything else LGTM.

- `return tuple(self._vertex_to_index.keys())` is better as `return tuple(self._vertex_to_index)`
- In `product`, is there some way we can avoid creating two simplicial complexes? I imagine it is slower to do it twice. Why not for the first case return the simplicial complex and for the second use the `facets`?



---

archive/issue_comments_376006.json:
```json
{
    "body": "Replying to [comment:44 tscrim]:\n> Two additional things; everything else LGTM.\n> \n> - `return tuple(self._vertex_to_index.keys())` is better as `return tuple(self._vertex_to_index)`\n\nSure, sounds good.\n\n> - In `product`, is there some way we can avoid creating two simplicial complexes? I imagine it is slower to do it twice. Why not for the first case return the simplicial complex and for the second use the `facets`?\n\nYes. I think when I first wrote this, I was going to use something produced by the `__init__` method and so I was constructing the simplicial complex to avoid code duplication. That doesn't seem to be the case any more, so you're right, I can just use `facets` in the second case.",
    "created_at": "2019-01-15T23:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376006",
    "user": "jhpalmieri"
}
```

Replying to [comment:44 tscrim]:
> Two additional things; everything else LGTM.
> 
> - `return tuple(self._vertex_to_index.keys())` is better as `return tuple(self._vertex_to_index)`

Sure, sounds good.

> - In `product`, is there some way we can avoid creating two simplicial complexes? I imagine it is slower to do it twice. Why not for the first case return the simplicial complex and for the second use the `facets`?

Yes. I think when I first wrote this, I was going to use something produced by the `__init__` method and so I was constructing the simplicial complex to avoid code duplication. That doesn't seem to be the case any more, so you're right, I can just use `facets` in the second case.



---

archive/issue_comments_376007.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-15T23:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376007",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376008.json:
```json
{
    "body": "Thanks.",
    "created_at": "2019-01-16T00:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376008",
    "user": "tscrim"
}
```

Thanks.



---

archive/issue_comments_376009.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-16T00:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376009",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_376010.json:
```json
{
    "body": "Great, thanks for reviewing!",
    "created_at": "2019-01-16T00:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376010",
    "user": "jhpalmieri"
}
```

Great, thanks for reviewing!



---

archive/issue_comments_376011.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T15:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26729",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26729#issuecomment-376011",
    "user": "vbraun"
}
```

Resolution: fixed
