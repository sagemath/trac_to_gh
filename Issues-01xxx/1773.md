# Issue 1773: piecewise functions and integration / arithmetic do not play well together

archive/issues_001773.json:
```json
{
    "body": "\n```\nOn 1/13/08, Hector Villafuerte <> wrote:\n> \n> I defined a piecewise function (specifically, a triangular wave) like this:\n> \n> sage: f1(x) = -abs(x) + 1\n> sage: f2(x) = abs(x - 2) - 1\n> sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])\n> \n> One can plot it and it looks very nice:\n> \n> sage: tri_wave.plot()\n> \n> But while calculating this integral I get \"ValueError: Value not\n> defined outside of domain.\"\n> \n> sage: integrate(tri_wave(x)^2, x, -1, 3)\n> \n> Is there a way to integrate piecewise-defined functions?\n> As always, thanks for your help,\n\nThis is clearly broken.  As a band-aide, you can at least\nnumerically integrate as follows:\n\nsage: integral_numerical(lambda x: tri_wave(x)^2, -1, 3)\n(1.3333333333333333, 1.4765966227514582e-14)\n\nThe first output (1.3333...) is the answer, and the second is an error bound.\n\n -- William\n```\n\nAssignee: @garyfurnish\n\nCC:  @kcrisman @jondo @vbraun @slel @mkoeppe @eviatarbach @rwst\n\nBranch/Commit: fe8304efd0d3b898932dfc0bb2b68a701a88fd41\n\nReviewer: Volker Braun\n\nAuthor: Marcelo Forets\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/1773\n\n",
    "closed_at": "2018-12-23T23:41:12Z",
    "created_at": "2008-01-14T06:02:44Z",
    "labels": [
        "component: calculus",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "piecewise functions and integration / arithmetic do not play well together",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/1773",
    "user": "https://github.com/williamstein"
}
```

```
On 1/13/08, Hector Villafuerte <> wrote:
> 
> I defined a piecewise function (specifically, a triangular wave) like this:
> 
> sage: f1(x) = -abs(x) + 1
> sage: f2(x) = abs(x - 2) - 1
> sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])
> 
> One can plot it and it looks very nice:
> 
> sage: tri_wave.plot()
> 
> But while calculating this integral I get "ValueError: Value not
> defined outside of domain."
> 
> sage: integrate(tri_wave(x)^2, x, -1, 3)
> 
> Is there a way to integrate piecewise-defined functions?
> As always, thanks for your help,

This is clearly broken.  As a band-aide, you can at least
numerically integrate as follows:

sage: integral_numerical(lambda x: tri_wave(x)^2, -1, 3)
(1.3333333333333333, 1.4765966227514582e-14)

The first output (1.3333...) is the answer, and the second is an error bound.

 -- William
```

Assignee: @garyfurnish

CC:  @kcrisman @jondo @vbraun @slel @mkoeppe @eviatarbach @rwst

Branch/Commit: fe8304efd0d3b898932dfc0bb2b68a701a88fd41

Reviewer: Volker Braun

Author: Marcelo Forets

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/1773





---

archive/issue_comments_012048.json:
```json
{
    "body": "Changing assignee from @williamstein to @garyfurnish.",
    "created_at": "2008-03-16T20:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12048",
    "user": "https://github.com/garyfurnish"
}
```

Changing assignee from @williamstein to @garyfurnish.



---

archive/issue_comments_012049.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2008-03-16T20:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12049",
    "user": "https://github.com/garyfurnish"
}
```

Changing status from new to assigned.



---

archive/issue_comments_012050.json:
```json
{
    "body": "<a id='comment:2'></a>This isn't specific to integrate. The problem is that piecewise functions don't play well with *symbolics*\n\n```\nsage: f1(x) = -abs(x) + 1\nsage: f2(x) = abs(x - 2) - 1\nsage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])\nsage: tri_wave(x)\nSAME ERROR\n```",
    "created_at": "2009-01-22T07:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12050",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:2'></a>This isn't specific to integrate. The problem is that piecewise functions don't play well with *symbolics*

```
sage: f1(x) = -abs(x) + 1
sage: f2(x) = abs(x - 2) - 1
sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])
sage: tri_wave(x)
SAME ERROR
```



---

archive/issue_comments_012051.json:
```json
{
    "body": "<a id='comment:3'></a>What should maybe happen is in piecewise.py, in the `__call__` method, if a SymbolicVariable is passed in as `x0`, it should return a CallableSymbolicExpression which just in turn calls back to the `__call__` method again. Does this sound reasonable? If so, how would one implement this?",
    "created_at": "2009-01-22T07:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12051",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:3'></a>What should maybe happen is in piecewise.py, in the `__call__` method, if a SymbolicVariable is passed in as `x0`, it should return a CallableSymbolicExpression which just in turn calls back to the `__call__` method again. Does this sound reasonable? If so, how would one implement this?



---

archive/issue_comments_012052.json:
```json
{
    "body": "Changing upstream from \"\" to \"N/A\"",
    "created_at": "2011-03-16T15:33:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12052",
    "user": "https://github.com/kcrisman"
}
```

Changing upstream from "" to "N/A"



---

archive/issue_comments_012053.json:
```json
{
    "body": "<a id='comment:5'></a>See also #11225, which is about plotting - but sometimes this stuff causes plots to not work, of course.",
    "created_at": "2011-08-15T14:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12053",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:5'></a>See also #11225, which is about plotting - but sometimes this stuff causes plots to not work, of course.



---

archive/issue_comments_012054.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [rlm](#comment%3A2):\n> This isn't specific to integrate. The problem is that piecewise functions don't play well with *symbolics*\n> \n> \n> ```\n> sage: f1(x) = -abs(x) + 1\n> sage: f2(x) = abs(x - 2) - 1\n> sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])\n> sage: tri_wave(x)\n> SAME ERROR\n> ```\n\n\nOr see what happens when we try to multiply piecewise and symbolic.\n\n```\nsage: f = Piecewise([[(0,pi/2),-1],[(pi/2,pi),2]]) \nsage: f*sin(x)\n---------------------------------------------------------------------------\nAttributeError              \n```",
    "created_at": "2011-08-15T14:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12054",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:6'></a>Replying to [rlm](#comment%3A2):
> This isn't specific to integrate. The problem is that piecewise functions don't play well with *symbolics*
> 
> 
> ```
> sage: f1(x) = -abs(x) + 1
> sage: f2(x) = abs(x - 2) - 1
> sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])
> sage: tri_wave(x)
> SAME ERROR
> ```


Or see what happens when we try to multiply piecewise and symbolic.

```
sage: f = Piecewise([[(0,pi/2),-1],[(pi/2,pi),2]]) 
sage: f*sin(x)
---------------------------------------------------------------------------
AttributeError              
```



---

archive/issue_events_004317.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:34:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4317"
}
```



---

archive/issue_events_004318.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4318"
}
```



---

archive/issue_events_004319.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4319"
}
```



---

archive/issue_comments_012055.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#14801\"",
    "created_at": "2014-02-23T13:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12055",
    "user": "https://github.com/ppurka"
}
```

Changing dependencies from "" to "#14801"



---

archive/issue_events_004320.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4320"
}
```



---

archive/issue_events_004321.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4321"
}
```



---

archive/issue_events_004322.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4322"
}
```



---

archive/issue_events_004323.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4323"
}
```



---

archive/issue_comments_012056.json:
```json
{
    "body": "<a id='comment:13'></a>While all the examples appearing in the comments are fixed with the new `piecewise` of #14801, the original bug example still fails (but with a different error message). \n\nCc'ing #14801's cc list.\n\n```\nsage: f1(x) = -abs(x) + 1\nsage: f2(x) = abs(x - 2) - 1\nsage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])\nsage: tri_wave.plot()\nLaunched png viewer for Graphics object consisting of 1 graphics primitive\nsage: integrate(tri_wave(x)^2, x, -1, 3)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-8-9387c34a513c> in <module>()\n----> 1 integrate(tri_wave(x)**Integer(2), x, -Integer(1), Integer(3))\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/misc/functional.py in integral(x, *args, **kwds)\n    663     \"\"\"\n    664     if hasattr(x, 'integral'):\n--> 665         return x.integral(*args, **kwds)\n    666     else:\n    667         from sage.symbolic.ring import SR\n\n/Users/mkoeppe/cvs/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/expression.cpp:60225)()\n  11484                     R = ring.SR\n  11485             return R(integral(f, v, a, b, **kwds))\n> 11486         return integral(self, *args, **kwds)\n  11487 \n  11488     integrate = integral\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)\n    763         return indefinite_integral(expression, v, hold=hold)\n    764     else:\n--> 765         return definite_integral(expression, v, a, b, hold=hold)\n    766 \n    767 integral = integrate\n\n/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:11170)()\n    970             res = self._evalf_try_(*args)\n    971             if res is None:\n--> 972                 res = super(BuiltinFunction, self).__call__(\n    973                         *args, coerce=coerce, hold=hold)\n    974 \n\n/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:6921)()\n    481             for i from 0 <= i < len(args):\n    482                 vec.push_back((<Expression>args[i])._gobj)\n--> 483             res = g_function_evalv(self._serial, vec, hold)\n    484         elif self._nargs == 1:\n    485             res = g_function_eval1(self._serial,\n\n/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction._evalf_or_eval_ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:12417)()\n   1059         res = self._evalf_try_(*args)\n   1060         if res is None:\n-> 1061             return self._eval0_(*args)\n   1062         else:\n   1063             return res\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x, a, b)\n    176         for integrator in self.integrators:\n    177             try:\n--> 178                 return integrator(*args)\n    179             except NotImplementedError:\n    180                 pass\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/external.py in maxima_integrator(expression, v, a, b)\n     22         result = maxima.sr_integral(expression,v)\n     23     else:\n---> 24         result = maxima.sr_integral(expression, v, a, b)\n     25     return result._sage_()\n     26 \n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in sr_integral(self, *args)\n    796         \"\"\"\n    797         try:\n--> 798             return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))\n    799         except RuntimeError as error:\n    800             s = str(error)\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)\n   1634         op_max=caar(expr)\n   1635         if op_max in special_max_to_sage:\n-> 1636             return special_max_to_sage[op_max](expr)\n   1637         if not(op_max in max_op_dict):\n   1638             op_max_str=maxprint(op_max).python()[1:-1]\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in dummy_integrate(expr)\n   1428         integrate(f(x), x, 0, 10)\n   1429     \"\"\"\n-> 1430     args=[max_to_sr(a) for a in cdr(expr)]\n   1431     if len(args) == 4 :\n   1432         return sage.symbolic.integration.integral.definite_integral(*args,\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)\n   1651             op=max_op_dict[op_max]\n   1652         max_args=cdr(expr)\n-> 1653         args=[max_to_sr(a) for a in max_args]\n   1654         return op(*args)\n   1655     elif expr.symbolp():\n\n/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)\n   1652         max_args=cdr(expr)\n   1653         args=[max_to_sr(a) for a in max_args]\n-> 1654         return op(*args)\n   1655     elif expr.symbolp():\n   1656         if not(expr in max_sym_dict):\n\nTypeError: __call__() takes exactly 2 arguments (3 given)\n```",
    "created_at": "2016-06-25T17:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12056",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>While all the examples appearing in the comments are fixed with the new `piecewise` of #14801, the original bug example still fails (but with a different error message). 

Cc'ing #14801's cc list.

```
sage: f1(x) = -abs(x) + 1
sage: f2(x) = abs(x - 2) - 1
sage: tri_wave = piecewise([ [(-1,1), f1], [(1,3), f2]])
sage: tri_wave.plot()
Launched png viewer for Graphics object consisting of 1 graphics primitive
sage: integrate(tri_wave(x)^2, x, -1, 3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-8-9387c34a513c> in <module>()
----> 1 integrate(tri_wave(x)**Integer(2), x, -Integer(1), Integer(3))

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/misc/functional.py in integral(x, *args, **kwds)
    663     """
    664     if hasattr(x, 'integral'):
--> 665         return x.integral(*args, **kwds)
    666     else:
    667         from sage.symbolic.ring import SR

/Users/mkoeppe/cvs/sage/src/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.integral (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/expression.cpp:60225)()
  11484                     R = ring.SR
  11485             return R(integral(f, v, a, b, **kwds))
> 11486         return integral(self, *args, **kwds)
  11487 
  11488     integrate = integral

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in integrate(expression, v, a, b, algorithm, hold)
    763         return indefinite_integral(expression, v, hold=hold)
    764     else:
--> 765         return definite_integral(expression, v, a, b, hold=hold)
    766 
    767 integral = integrate

/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:11170)()
    970             res = self._evalf_try_(*args)
    971             if res is None:
--> 972                 res = super(BuiltinFunction, self).__call__(
    973                         *args, coerce=coerce, hold=hold)
    974 

/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:6921)()
    481             for i from 0 <= i < len(args):
    482                 vec.push_back((<Expression>args[i])._gobj)
--> 483             res = g_function_evalv(self._serial, vec, hold)
    484         elif self._nargs == 1:
    485             res = g_function_eval1(self._serial,

/Users/mkoeppe/cvs/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction._evalf_or_eval_ (/Users/mkoeppe/cvs/sage/src/build/cythonized/sage/symbolic/function.cpp:12417)()
   1059         res = self._evalf_try_(*args)
   1060         if res is None:
-> 1061             return self._eval0_(*args)
   1062         else:
   1063             return res

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x, a, b)
    176         for integrator in self.integrators:
    177             try:
--> 178                 return integrator(*args)
    179             except NotImplementedError:
    180                 pass

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/symbolic/integration/external.py in maxima_integrator(expression, v, a, b)
     22         result = maxima.sr_integral(expression,v)
     23     else:
---> 24         result = maxima.sr_integral(expression, v, a, b)
     25     return result._sage_()
     26 

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in sr_integral(self, *args)
    796         """
    797         try:
--> 798             return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))
    799         except RuntimeError as error:
    800             s = str(error)

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1634         op_max=caar(expr)
   1635         if op_max in special_max_to_sage:
-> 1636             return special_max_to_sage[op_max](expr)
   1637         if not(op_max in max_op_dict):
   1638             op_max_str=maxprint(op_max).python()[1:-1]

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in dummy_integrate(expr)
   1428         integrate(f(x), x, 0, 10)
   1429     """
-> 1430     args=[max_to_sr(a) for a in cdr(expr)]
   1431     if len(args) == 4 :
   1432         return sage.symbolic.integration.integral.definite_integral(*args,

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1651             op=max_op_dict[op_max]
   1652         max_args=cdr(expr)
-> 1653         args=[max_to_sr(a) for a in max_args]
   1654         return op(*args)
   1655     elif expr.symbolp():

/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.py in max_to_sr(expr)
   1652         max_args=cdr(expr)
   1653         args=[max_to_sr(a) for a in max_args]
-> 1654         return op(*args)
   1655     elif expr.symbolp():
   1656         if not(expr in max_sym_dict):

TypeError: __call__() takes exactly 2 arguments (3 given)
```



---

archive/issue_events_004324.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-06-25T17:32:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4324"
}
```



---

archive/issue_events_004325.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-06-25T17:32:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4325"
}
```



---

archive/issue_comments_012057.json:
```json
{
    "body": "<a id='comment:14'></a>The problem on first sight here is that operations on `piecewise` do not get translated to what is expected, i.e., squaring the pieces. Also it seems that Maxima does not convert them, nor is it considering loading `pw.mac` without which it simply knows nothing about piecewise functions. So we must either load this package when encountering `piecewise` in the Maxima interface then convert, or the expression must be simplified, i.e., the operations applied piecewise, probably by Pynac. Or both.\n\nOf course, the `integral` member function is accessible with pure `piecewise` objects:\n\n```\nsage: tri_wave1 = piecewise([ [(-1,1), f1^2], [(1,3), f2^2]])\nsage: tri_wave1.integral(definite=True)\n4/3\n```",
    "created_at": "2016-06-26T15:23:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12057",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>The problem on first sight here is that operations on `piecewise` do not get translated to what is expected, i.e., squaring the pieces. Also it seems that Maxima does not convert them, nor is it considering loading `pw.mac` without which it simply knows nothing about piecewise functions. So we must either load this package when encountering `piecewise` in the Maxima interface then convert, or the expression must be simplified, i.e., the operations applied piecewise, probably by Pynac. Or both.

Of course, the `integral` member function is accessible with pure `piecewise` objects:

```
sage: tri_wave1 = piecewise([ [(-1,1), f1^2], [(1,3), f2^2]])
sage: tri_wave1.integral(definite=True)
4/3
```



---

archive/issue_comments_012058.json:
```json
{
    "body": "<a id='comment:15'></a>`@`rws: does adding a new `__pow__` method in piecewise fix the issue or not? (cf. code+test added in this branch)\n\n\n---\n\n\n... well it doesn't work for the OP problem, but that's another thing (misuse?) i guess, since:\n\n```\nsage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]]), x, -1, 3)\n...\nValueError: point 3 is not in the domain\n```\n\nalthough\n\n```\nsage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]]), x)\npiecewise(x|-->1/2*x^2 - 1/2 on (-1, 1), x|-->1/3*x^3 - 1/3 on (1, 3); x)\n```\n\nand with the current patch one has:\n\n```\nsage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]])**2, x)\npiecewise(x|-->1/3*x^3 + 1/3 on (-1, 1), x|-->1/5*x^5 + 7/15 on (1, 3); x)\n```\n\n---\nNew commits:",
    "created_at": "2017-05-07T19:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12058",
    "user": "https://github.com/mforets"
}
```

<a id='comment:15'></a>`@`rws: does adding a new `__pow__` method in piecewise fix the issue or not? (cf. code+test added in this branch)


---


... well it doesn't work for the OP problem, but that's another thing (misuse?) i guess, since:

```
sage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]]), x, -1, 3)
...
ValueError: point 3 is not in the domain
```

although

```
sage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]]), x)
piecewise(x|-->1/2*x^2 - 1/2 on (-1, 1), x|-->1/3*x^3 - 1/3 on (1, 3); x)
```

and with the current patch one has:

```
sage: integrate(piecewise([ [(-1,1), x], [(1,3), x^2]])**2, x)
piecewise(x|-->1/3*x^3 + 1/3 on (-1, 1), x|-->1/5*x^5 + 7/15 on (1, 3); x)
```

---
New commits:



---

archive/issue_comments_012059.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mforets/1773\"",
    "created_at": "2017-05-07T19:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12059",
    "user": "https://github.com/mforets"
}
```

Changing branch from "" to "u/mforets/1773"



---

archive/issue_comments_012060.json:
```json
{
    "body": "Changing commit from \"\" to \"115c198b1b2cf2bb63423d89dad14c402c055454\"",
    "created_at": "2017-05-07T19:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12060",
    "user": "https://github.com/mforets"
}
```

Changing commit from "" to "115c198b1b2cf2bb63423d89dad14c402c055454"



---

archive/issue_comments_012061.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-07T19:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12061",
    "user": "https://github.com/mforets"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_012062.json:
```json
{
    "body": "<a id='comment:16'></a>Hmmm, what i've uploaded doesn't work well with symbolic expressions as exponents!\n\n```\nsage: f = piecewise([ [(-1,1), x], [(1,3), x^2]])\nsage: k = var('k')\nsage: f**k\npiecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)\n```\n\nthe independent variable is misunderstood.",
    "created_at": "2017-05-07T19:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12062",
    "user": "https://github.com/mforets"
}
```

<a id='comment:16'></a>Hmmm, what i've uploaded doesn't work well with symbolic expressions as exponents!

```
sage: f = piecewise([ [(-1,1), x], [(1,3), x^2]])
sage: k = var('k')
sage: f**k
piecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)
```

the independent variable is misunderstood.



---

archive/issue_comments_012063.json:
```json
{
    "body": "<a id='comment:17'></a>This seems to depend on if the expression contains a lexicographically earlier symbol:\n\n```\nsage: f^y\npiecewise(x|-->x^y on (-1, 1), x|-->(x^2)^y on (1, 3); x)\nsage: f^k\npiecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)\nsage: f^z\npiecewise(x|-->x^z on (-1, 1), x|-->(x^2)^z on (1, 3); x)\nsage: f^t\npiecewise(t|-->x^t on (-1, 1), t|-->(x^2)^t on (1, 3); t)\n```",
    "created_at": "2017-05-08T06:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12063",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>This seems to depend on if the expression contains a lexicographically earlier symbol:

```
sage: f^y
piecewise(x|-->x^y on (-1, 1), x|-->(x^2)^y on (1, 3); x)
sage: f^k
piecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)
sage: f^z
piecewise(x|-->x^z on (-1, 1), x|-->(x^2)^z on (1, 3); x)
sage: f^t
piecewise(t|-->x^t on (-1, 1), t|-->(x^2)^t on (1, 3); t)
```



---

archive/issue_comments_012064.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-08T13:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_012065.json:
```json
{
    "body": "Changing commit from \"115c198b1b2cf2bb63423d89dad14c402c055454\" to \"41c5796fe91dbb403f21978d836b2570633bca86\"",
    "created_at": "2017-05-08T13:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12065",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "115c198b1b2cf2bb63423d89dad14c402c055454" to "41c5796fe91dbb403f21978d836b2570633bca86"



---

archive/issue_comments_012066.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [rws](#comment%3A17):\n> This seems to depend on if the expression contains a lexicographically earlier symbol:\n> \n> ```\n> sage: f^y\n> piecewise(x|-->x^y on (-1, 1), x|-->(x^2)^y on (1, 3); x)\n> sage: f^k\n> piecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)\n> sage: f^z\n> piecewise(x|-->x^z on (-1, 1), x|-->(x^2)^z on (1, 3); x)\n> sage: f^t\n> piecewise(t|-->x^t on (-1, 1), t|-->(x^2)^t on (1, 3); t)\n> ```\n\n\nOk, i see. as a workaround i've specified the `var` argument to the constructor, which gives the same result as `self.variables()[0]`.",
    "created_at": "2017-05-08T14:01:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12066",
    "user": "https://github.com/mforets"
}
```

<a id='comment:19'></a>Replying to [rws](#comment%3A17):
> This seems to depend on if the expression contains a lexicographically earlier symbol:
> 
> ```
> sage: f^y
> piecewise(x|-->x^y on (-1, 1), x|-->(x^2)^y on (1, 3); x)
> sage: f^k
> piecewise(k|-->x^k on (-1, 1), k|-->(x^2)^k on (1, 3); k)
> sage: f^z
> piecewise(x|-->x^z on (-1, 1), x|-->(x^2)^z on (1, 3); x)
> sage: f^t
> piecewise(t|-->x^t on (-1, 1), t|-->(x^2)^t on (1, 3); t)
> ```


Ok, i see. as a workaround i've specified the `var` argument to the constructor, which gives the same result as `self.variables()[0]`.



---

archive/issue_comments_012067.json:
```json
{
    "body": "Changing author from \"\" to \"Marcelo Forets\"",
    "created_at": "2017-07-10T04:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12067",
    "user": "https://github.com/mforets"
}
```

Changing author from "" to "Marcelo Forets"



---

archive/issue_comments_012068.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-05T07:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12068",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_004326.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-05T07:25:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4326"
}
```



---

archive/issue_events_004327.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-05-05T07:25:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4327"
}
```



---

archive/issue_comments_012069.json:
```json
{
    "body": "Changing dependencies from \"#14801\" to \"\"",
    "created_at": "2018-05-05T07:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12069",
    "user": "https://github.com/fchapoton"
}
```

Changing dependencies from "#14801" to ""



---

archive/issue_comments_012070.json:
```json
{
    "body": "<a id='comment:21'></a>does not apply",
    "created_at": "2018-05-05T07:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12070",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>does not apply



---

archive/issue_comments_012071.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-31T11:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_012072.json:
```json
{
    "body": "Changing commit from \"41c5796fe91dbb403f21978d836b2570633bca86\" to \"ffea99058531a07c82012ec9f4fec5183d7a3fb6\"",
    "created_at": "2018-05-31T11:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "41c5796fe91dbb403f21978d836b2570633bca86" to "ffea99058531a07c82012ec9f4fec5183d7a3fb6"



---

archive/issue_comments_012073.json:
```json
{
    "body": "<a id='comment:23'></a>update milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12073",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>update milestone 8.3 -> 8.4



---

archive/issue_events_004328.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4328"
}
```



---

archive/issue_events_004329.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4329"
}
```



---

archive/issue_comments_012074.json:
```json
{
    "body": "Changing branch from \"u/mforets/1773\" to \"public/ticket/1773\"",
    "created_at": "2018-12-17T19:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12074",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "u/mforets/1773" to "public/ticket/1773"



---

archive/issue_comments_012075.json:
```json
{
    "body": "<a id='comment:24'></a>New commits:",
    "created_at": "2018-12-17T19:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12075",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>New commits:



---

archive/issue_events_004330.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-17T19:38:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4330"
}
```



---

archive/issue_events_004331.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-17T19:38:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4331"
}
```



---

archive/issue_comments_012076.json:
```json
{
    "body": "Changing commit from \"ffea99058531a07c82012ec9f4fec5183d7a3fb6\" to \"fe8304efd0d3b898932dfc0bb2b68a701a88fd41\"",
    "created_at": "2018-12-17T19:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12076",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "ffea99058531a07c82012ec9f4fec5183d7a3fb6" to "fe8304efd0d3b898932dfc0bb2b68a701a88fd41"



---

archive/issue_comments_012077.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-17T19:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12077",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_012078.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Volker Braun\"",
    "created_at": "2018-12-17T20:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12078",
    "user": "https://github.com/vbraun"
}
```

Changing reviewer from "" to "Volker Braun"



---

archive/issue_comments_012079.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-17T20:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12079",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_012080.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12080",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_004332.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:41:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/1773#event-4332"
}
```



---

archive/issue_comments_012081.json:
```json
{
    "body": "Changing branch from \"public/ticket/1773\" to \"fe8304efd0d3b898932dfc0bb2b68a701a88fd41\"",
    "created_at": "2018-12-23T23:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/1773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/1773#issuecomment-12081",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/ticket/1773" to "fe8304efd0d3b898932dfc0bb2b68a701a88fd41"
