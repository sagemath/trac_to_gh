# Issue 32996: sage -t --baseline-stats-path

archive/issues_032996.json:
```json
{
    "body": "CC:  @fchapoton @vbraun @kliem @seblabbe @tobiasdiez @orlitzky @kiwifb @antonio-rojas tmonteil @videlec\n\nIf the new option `--baseline-stats-path PATH_TO_JSON_FILE` is given, read failure information from there.\n\nTests that already are marked as `failed` there will be specially marked as baseline failures in the doctest report.\n\nIf there are only baseline failures, no new failures, then `sage -t` will exit with status code 0.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33233\n\n",
    "created_at": "2022-01-26T18:05:28Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "sage -t --baseline-stats-path",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32996",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @fchapoton @vbraun @kliem @seblabbe @tobiasdiez @orlitzky @kiwifb @antonio-rojas tmonteil @videlec

If the new option `--baseline-stats-path PATH_TO_JSON_FILE` is given, read failure information from there.

Tests that already are marked as `failed` there will be specially marked as baseline failures in the doctest report.

If there are only baseline failures, no new failures, then `sage -t` will exit with status code 0.

Issue created by migration from https://trac.sagemath.org/ticket/33233





---

archive/issue_comments_469981.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-26T19:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469981",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-26T19:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469982",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469983.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-26T19:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469983",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469984.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-31T22:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469984",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469985.json:
```json
{
    "body": "Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no \"failed in baseline\" message.",
    "created_at": "2022-02-05T19:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469985",
    "user": "https://github.com/tobiasdiez"
}
```

Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no "failed in baseline" message.



---

archive/issue_comments_469986.json:
```json
{
    "body": "This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.",
    "created_at": "2022-02-05T20:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469986",
    "user": "https://github.com/kiwifb"
}
```

This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.



---

archive/issue_comments_469987.json:
```json
{
    "body": "I don't really like the idea but it's probably a necessary evil. We're the only project where it can take a month to get trivial bug fixes into the development branch that's used for testing all of the other branches.\n\nAnd (for example) sage-9.5 was released with a number of broken tests having fixes waiting to be merged.\n\nI wish we could address **that** problem, but will settle for this one.",
    "created_at": "2022-02-05T20:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469987",
    "user": "https://github.com/orlitzky"
}
```

I don't really like the idea but it's probably a necessary evil. We're the only project where it can take a month to get trivial bug fixes into the development branch that's used for testing all of the other branches.

And (for example) sage-9.5 was released with a number of broken tests having fixes waiting to be merged.

I wish we could address **that** problem, but will settle for this one.



---

archive/issue_comments_469988.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no \"failed in baseline\" message.\nIt's merged there but it doesn't end up being used because of a caching mistake",
    "created_at": "2022-02-05T20:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469988",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no "failed in baseline" message.
It's merged there but it doesn't end up being used because of a caching mistake



---

archive/issue_comments_469989.json:
```json
{
    "body": "Replying to [comment:13 fbissey]:\n> This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.\n\nNote that currently the failures are recorded on the granularity of files, but it would be easy to make it more fine-grained to support this use case better.\n\nI could imagine that could be better than carrying distro patches that patch out doctests",
    "created_at": "2022-02-05T20:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469989",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:13 fbissey]:
> This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.

Note that currently the failures are recorded on the granularity of files, but it would be easy to make it more fine-grained to support this use case better.

I could imagine that could be better than carrying distro patches that patch out doctests



---

archive/issue_comments_469990.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> I could imagine that could be better than carrying distro patches that patch out doctests\n> \n\nDefinitely. On the other hand, things have moved considerably in the last couple of years. Most distros doctests failures these days are from some version mis-match of dependencies or some corner case that should be fixed. I had a brief period of zero doctest failures in sage-on-gentoo and I am hoping to get there again in 9.6.\n\nLooking at my own patches, there is very little about doctest fixing/suppressing left, and the one that are, are about sage's packaging system.",
    "created_at": "2022-02-05T20:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469990",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:16 mkoeppe]:
> I could imagine that could be better than carrying distro patches that patch out doctests
> 

Definitely. On the other hand, things have moved considerably in the last couple of years. Most distros doctests failures these days are from some version mis-match of dependencies or some corner case that should be fixed. I had a brief period of zero doctest failures in sage-on-gentoo and I am hoping to get there again in 9.6.

Looking at my own patches, there is very little about doctest fixing/suppressing left, and the one that are, are about sage's packaging system.



---

archive/issue_comments_469991.json:
```json
{
    "body": "As it turns out, I will soon be moving from testing sage after install to testing as part of the building process. Testing after install should still be doable but I will be moving my focus to the part of the building process. It automatically does all the version of python I intend to support while testing after install has a number of steps involved.\n\nSo, I now have the choice of patching everything to get to zero doctests failures or this ticket. A funny thing is that I may need to patch the sage sources for #33141 when the patch really should belong to their individual packages. \n\nThere is also the problem of the regular transient failure(s) that only occur when doctesting in parallel and disappear once tested on their own - a long running and recurring issue, for which I only have this ticket to get out of.",
    "created_at": "2022-03-14T20:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469991",
    "user": "https://github.com/kiwifb"
}
```

As it turns out, I will soon be moving from testing sage after install to testing as part of the building process. Testing after install should still be doable but I will be moving my focus to the part of the building process. It automatically does all the version of python I intend to support while testing after install has a number of steps involved.

So, I now have the choice of patching everything to get to zero doctests failures or this ticket. A funny thing is that I may need to patch the sage sources for #33141 when the patch really should belong to their individual packages. 

There is also the problem of the regular transient failure(s) that only occur when doctesting in parallel and disappear once tested on their own - a long running and recurring issue, for which I only have this ticket to get out of.



---

archive/issue_comments_469992.json:
```json
{
    "body": "I am currently testing this on some real case I \"built\". I have the following failures \n\n```\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage/env.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage/tests/startup.py  # 1 doctest failed [failed in baseline]\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage_docbuild/__init__.py  # 2 doctests failed\nsage -t --long --random-seed=140550856929631684337539526074563197630 sage_setup/find.py  # 9 doctests failed [failed in baseline]\n```\n\nand using this json file to establish the baseline\n\n```\n{\"sage.env\": {\"failed\": true},\"sage.interfaces.gap_workspace\": {\"failed\": true},\"sage.plot.plot3d.tachyon\": {\"failed\": true},\"sage.tests.startup\": {\"failed\": true},\"sage_docbuild.__init__\": {\"failed\": true},\"sage_setup.find\": {\"failed\": true},\"sage.tests.cmdline\": {\"failed\": true}}\n```\n\nHow do I correctly deal with `sage_docbuild/__init__.py` since adding `\"sage_docbuild.__init__\": {\"failed\": true}` didn't help? Am I missing something obvious?",
    "created_at": "2022-03-16T01:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469992",
    "user": "https://github.com/kiwifb"
}
```

I am currently testing this on some real case I "built". I have the following failures 

```
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/env.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/tests/startup.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage_docbuild/__init__.py  # 2 doctests failed
sage -t --long --random-seed=140550856929631684337539526074563197630 sage_setup/find.py  # 9 doctests failed [failed in baseline]
```

and using this json file to establish the baseline

```
{"sage.env": {"failed": true},"sage.interfaces.gap_workspace": {"failed": true},"sage.plot.plot3d.tachyon": {"failed": true},"sage.tests.startup": {"failed": true},"sage_docbuild.__init__": {"failed": true},"sage_setup.find": {"failed": true},"sage.tests.cmdline": {"failed": true}}
```

How do I correctly deal with `sage_docbuild/__init__.py` since adding `"sage_docbuild.__init__": {"failed": true}` didn't help? Am I missing something obvious?



---

archive/issue_comments_469993.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-16T20:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469993",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469994.json:
```json
{
    "body": "OK, answering my own question, it seems that `\"sage_docbuild\": {\"failed\": true}` works in that case. Although, I am fairly sure that it is over-reaching.\n\nBut otherwise the ticket does its job, so I will review it positively.",
    "created_at": "2022-03-16T20:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469994",
    "user": "https://github.com/kiwifb"
}
```

OK, answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.

But otherwise the ticket does its job, so I will review it positively.



---

archive/issue_comments_469995.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2022-03-16T21:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469995",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for the review!



---

archive/issue_comments_469996.json:
```json
{
    "body": "Replying to [comment:22 fbissey]:\n> answering my own question, it seems that `\"sage_docbuild\": {\"failed\": true}` works in that case. Although, I am fairly sure that it is over-reaching.\n\nIt may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.",
    "created_at": "2022-03-16T21:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469996",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:22 fbissey]:
> answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.

It may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.



---

archive/issue_comments_469997.json:
```json
{
    "body": "Replying to [comment:24 mkoeppe]:\n> Replying to [comment:22 fbissey]:\n> > answering my own question, it seems that `\"sage_docbuild\": {\"failed\": true}` works in that case. Although, I am fairly sure that it is over-reaching.\n> \n> It may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.\n\nI am not about building a test case to check on that :) But I had come to that conclusion about the naming, you don't import `__init__.py` files, they get read when you import the parent module. At least that's how I thought of it.",
    "created_at": "2022-03-16T21:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469997",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:24 mkoeppe]:
> Replying to [comment:22 fbissey]:
> > answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.
> 
> It may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.

I am not about building a test case to check on that :) But I had come to that conclusion about the naming, you don't import `__init__.py` files, they get read when you import the parent module. At least that's how I thought of it.



---

archive/issue_comments_469998.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-21T23:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469998",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_469999.json:
```json
{
    "body": "A curiosity that may need addressing\n\n```\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/doctest/forker.py  # 1 doctest failed\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/env.py  # 2 doctests failed\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/interfaces/gap_workspace.py  # 2 doctests failed\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/plot/plot3d/tachyon.py  # 1 doctest failed\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/startup.py  # 1 doctest failed\nsage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/clean.py  # 4 doctests failed [failed in baseline]\nsage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/find.py  # 9 doctests failed [failed in baseline]\nsage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 1 doctest failed\n```\n\nI probably will avoid running the test suite that way in the future. But I now can do automated testing in a venv (which is why a lot of stuff is prefixed with `/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install`, that's the venv root), I ran the above test with `--installed` on the venv rather than with `--all` on the source - which is what I will focus on in the future. Everything in that test should have been caught by the provided baseline file but for some reason the stuff in the venv is not.",
    "created_at": "2022-03-25T00:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32996#issuecomment-469999",
    "user": "https://github.com/kiwifb"
}
```

A curiosity that may need addressing

```
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/doctest/forker.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/env.py  # 2 doctests failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/interfaces/gap_workspace.py  # 2 doctests failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/plot/plot3d/tachyon.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/startup.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/clean.py  # 4 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/find.py  # 9 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 1 doctest failed
```

I probably will avoid running the test suite that way in the future. But I now can do automated testing in a venv (which is why a lot of stuff is prefixed with `/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install`, that's the venv root), I ran the above test with `--installed` on the venv rather than with `--all` on the source - which is what I will focus on in the future. Everything in that test should have been caught by the provided baseline file but for some reason the stuff in the venv is not.
