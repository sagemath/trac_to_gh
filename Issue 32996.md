# Issue 32996: sage -t --baseline-stats-path

Issue created by migration from https://trac.sagemath.org/ticket/33233

Original creator: mkoeppe

Original creation time: 2022-01-26 18:05:28

CC:  chapoton vbraun @kliem slabbe @tobiasdiez mjo fbissey arojas tmonteil vdelecroix

If the new option `--baseline-stats-path PATH_TO_JSON_FILE` is given, read failure information from there.

Tests that already are marked as `failed` there will be specially marked as baseline failures in the doctest report.

If there are only baseline failures, no new failures, then `sage -t` will exit with status code 0.


---

Comment by git created at 2022-01-26 19:04:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-26 19:42:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-26 19:43:18

Changing status from new to needs_review.


---

Comment by git created at 2022-01-31 22:21:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-05 19:46:53

Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no "failed in baseline" message.


---

Comment by fbissey created at 2022-02-05 20:14:49

This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.


---

Comment by mjo created at 2022-02-05 20:20:25

I don't really like the idea but it's probably a necessary evil. We're the only project where it can take a month to get trivial bug fixes into the development branch that's used for testing all of the other branches.

And (for example) sage-9.5 was released with a number of broken tests having fixes waiting to be merged.

I wish we could address **that** problem, but will settle for this one.


---

Comment by mkoeppe created at 2022-02-05 20:27:07

Replying to [comment:12 gh-tobiasdiez]:
> Is this already used in #33222? Because in this run https://github.com/mkoeppe/sage/runs/5060070979?check_suite_focus=true the integration tests fail and there is no "failed in baseline" message.
It's merged there but it doesn't end up being used because of a caching mistake


---

Comment by mkoeppe created at 2022-02-05 20:29:29

Replying to [comment:13 fbissey]:
> This is an interesting idea. We can have a record of known failures in distros, in gentoo failing a test suite can prevent install. But with this, we could reduce it to really unexpected failures.

Note that currently the failures are recorded on the granularity of files, but it would be easy to make it more fine-grained to support this use case better.

I could imagine that could be better than carrying distro patches that patch out doctests


---

Comment by fbissey created at 2022-02-05 20:43:53

Replying to [comment:16 mkoeppe]:
> I could imagine that could be better than carrying distro patches that patch out doctests
> 

Definitely. On the other hand, things have moved considerably in the last couple of years. Most distros doctests failures these days are from some version mis-match of dependencies or some corner case that should be fixed. I had a brief period of zero doctest failures in sage-on-gentoo and I am hoping to get there again in 9.6.

Looking at my own patches, there is very little about doctest fixing/suppressing left, and the one that are, are about sage's packaging system.


---

Comment by fbissey created at 2022-03-14 20:30:18

As it turns out, I will soon be moving from testing sage after install to testing as part of the building process. Testing after install should still be doable but I will be moving my focus to the part of the building process. It automatically does all the version of python I intend to support while testing after install has a number of steps involved.

So, I now have the choice of patching everything to get to zero doctests failures or this ticket. A funny thing is that I may need to patch the sage sources for #33141 when the patch really should belong to their individual packages. 

There is also the problem of the regular transient failure(s) that only occur when doctesting in parallel and disappear once tested on their own - a long running and recurring issue, for which I only have this ticket to get out of.


---

Comment by fbissey created at 2022-03-16 01:14:56

I am currently testing this on some real case I "built". I have the following failures 

```
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/env.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage/tests/startup.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=140550856929631684337539526074563197630 sage_docbuild/__init__.py  # 2 doctests failed
sage -t --long --random-seed=140550856929631684337539526074563197630 sage_setup/find.py  # 9 doctests failed [failed in baseline]
```

and using this json file to establish the baseline

```
{"sage.env": {"failed": true},"sage.interfaces.gap_workspace": {"failed": true},"sage.plot.plot3d.tachyon": {"failed": true},"sage.tests.startup": {"failed": true},"sage_docbuild.__init__": {"failed": true},"sage_setup.find": {"failed": true},"sage.tests.cmdline": {"failed": true}}
```

How do I correctly deal with `sage_docbuild/__init__.py` since adding `"sage_docbuild.__init__": {"failed": true}` didn't help? Am I missing something obvious?


---

Comment by fbissey created at 2022-03-16 20:17:26

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-03-16 20:17:26

OK, answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.

But otherwise the ticket does its job, so I will review it positively.


---

Comment by mkoeppe created at 2022-03-16 21:01:01

Thanks for the review!


---

Comment by mkoeppe created at 2022-03-16 21:01:51

Replying to [comment:22 fbissey]:
> answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.

It may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.


---

Comment by fbissey created at 2022-03-16 21:29:31

Replying to [comment:24 mkoeppe]:
> Replying to [comment:22 fbissey]:
> > answering my own question, it seems that `"sage_docbuild": {"failed": true}` works in that case. Although, I am fairly sure that it is over-reaching.
> 
> It may just be what it uses as the name of the module in this case. Pretty sure it does not mark all modules in this package as failed.

I am not about building a test case to check on that :) But I had come to that conclusion about the naming, you don't import `__init__.py` files, they get read when you import the parent module. At least that's how I thought of it.


---

Comment by vbraun created at 2022-03-21 23:34:34

Resolution: fixed


---

Comment by fbissey created at 2022-03-25 00:43:13

A curiosity that may need addressing

```
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/doctest/forker.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/env.py  # 2 doctests failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/interfaces/gap_workspace.py  # 2 doctests failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/plot/plot3d/tachyon.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/startup.py  # 1 doctest failed
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/clean.py  # 4 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /usr/lib/python3.10/site-packages/sage_setup/find.py  # 9 doctests failed [failed in baseline]
sage -t --long --random-seed=234497371435892995843174411690375861350 /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install/usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 1 doctest failed
```

I probably will avoid running the test suite that way in the future. But I now can do automated testing in a venv (which is why a lot of stuff is prefixed with `/var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_10/install`, that's the venv root), I ran the above test with `--installed` on the venv rather than with `--all` on the source - which is what I will focus on in the future. Everything in that test should have been caught by the provided baseline file but for some reason the stuff in the venv is not.
