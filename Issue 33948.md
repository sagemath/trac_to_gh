# Issue 33948: New doctest option to hide features

Issue created by migration from https://trac.sagemath.org/ticket/34185

Original creator: soehms

Original creation time: 2022-07-15 07:02:30

CC:  slabbe

As suggested in #33823 (see [comment 25](https://trac.sagemath.org/ticket/33823#comment:25)) I make a first attempt for such an option here. The purpose of the option is to find test which need to be marked as `optional` but aren't right now.

For example see the test of the following file which contains two tests involving the optional package `database_knotinfo`. Note that on the system where I produced the output below this feature is available.


```bash
cat test_knotinfo.py
r"""
sage: KnotInfo.K9_10.homfly_polynomial()
-v^10*z^2 + v^8*z^4 - 2*v^10 + 2*v^8*z^2 + 2*v^6*z^4 + v^8 + 5*v^6*z^2 + v^4*z^4 + 2*v^6 + 2*v^4*z^2
sage: KnotInfo.K9_10.alexander_polynomial()  # optional database_knotinfo
4*t^4 - 8*t^3 + 9*t^2 - 8*t + 4
"""
```


The first test is missing the `optional` tag. Thus, this would fail on a system without that feature. But, running `sage -t` without the new option does not show the problem:



```bash
sage -t test_knotinfo.py
too many failed tests, not using stored timings
Running doctests with ID ...
...
Git ref: 9.7.beta5-...
...
Using --optional=database_knotinfo,debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg
Features to be detected: ...
Doctesting 1 file.
sage -t --random-seed=17350038375103993251556014960108337039 test_knotinfo.py
    [2 tests, 4.66 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.7 seconds
    cpu time: 4.7 seconds
    cumulative wall time: 4.7 seconds
Features detected for doctesting:
```


Using the new option this will be the case:


```bash
sage -t --hide=database_knotinfo test_knotinfo.py
too many failed tests, not using stored timings
Running doctests with ...
...
Git ref: 9.7.beta5-...
...
Using --optional=debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg
Features to be detected: ...
Hidden features: database_knotinfo
Doctesting 1 file.
sage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py
**********************************************************************
File "test_knotinfo.py", line 2, in test_knotinfo
Failed example:
    KnotInfo.K9_10.homfly_polynomial()
Exception raised:
    Traceback (most recent call last):
    ...
    NameError: name 'KnotInfo' is not defined
**********************************************************************
1 item had failures:
   1 of   2 in test_knotinfo
    [1 test, 1 failure, 0.00 s]
----------------------------------------------------------------------
sage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting:
```





---

Comment by soehms created at 2022-07-15 07:08:17

Changing status from new to needs_review.


---

Comment by soehms created at 2022-07-15 07:08:17

New commits:


---

Comment by mkoeppe created at 2022-07-15 13:57:53

I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`


---

Comment by git created at 2022-07-18 16:02:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-07-18 16:03:14

Replying to [comment:3 mkoeppe]:
> I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`
Actually, I didn't do that well. Many thanks for looking at the ticket!


---

Comment by mkoeppe created at 2022-07-19 21:01:09

A `JoinFeature` should probably hide/unhide its components


---

Comment by soehms created at 2022-07-20 16:28:38

Replying to [comment:6 mkoeppe]:
> A `JoinFeature` should probably hide/unhide its components
Will be in the next commit.

I'm wondering what's wrong with the patchbots? For example:


```
**********************************************************************
File "/Users/jpalmier/Desktop/Sage/git/patchbot/sage-9.7.beta5/src/sage/features/__init__.py", line 301, in sage.features.Feature.is_optional
Failed example:
    DatabaseCremona().is_optional()
Exception raised:
    Traceback (most recent call last):
    ...
    AttributeError: 'DatabaseCremona' object has no attribute 'is_optional'
```


All tests failing on the patchbots succeed in the Gitpod environment. But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:


```
sage: from sage.features.latex import LaTeXPackage
sage: LaTeXPackage("tkz-graph").is_present()
Traceback (most recent call last):
...
FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'
```


This happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a _joined feature_ with `pdflatex`?


---

Comment by git created at 2022-07-25 06:40:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-07-25 06:41:21

The recent commit takes care of joined features. In addition (in order to allow more interesting doctest examples) I make `lazy_import` be hide-able.


---

Comment by git created at 2022-08-05 07:22:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-05 07:26:41

Replying to [comment:7 soehms]:
> ... But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:
> 
> {{{
> sage: from sage.features.latex import LaTeXPackage
> sage: LaTeXPackage("tkz-graph").is_present()
> Traceback (most recent call last):
> ...
> FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'
> }}}
> 
> This happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a _joined feature_ with `pdflatex`?
> 

See #34282 for a suggestion to have this fixed.

Furthermore, when testing on a system with meataxe you may randomly run into a circular import issue in `matrix_space`. This is fixed in ticket #34283.


---

Comment by git created at 2022-08-09 08:27:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-09 08:30:46

The previous commit should fix the only failure that happened on the previous patchbot run. This is the following long test:


```sage
Doctesting 1 file using 4 threads.
sage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py
**********************************************************************
File "src/sage/doctest/sources.py", line 781, in sage.doctest.sources.FileDocTestSource._test_enough_doctests
Failed example:
    for path, dirs, files in itertools.chain(os.walk('sage'), os.walk('doc')): # long time
        path = os.path.relpath(path)
        dirs.sort(); files.sort()
        for F in files:
            _, ext = os.path.splitext(F)
            if ext in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst'):
                filename = os.path.join(path, F)
                FDS = FileDocTestSource(filename, DocTestDefaults(long=True, optional=True, force_lib=True))
                FDS._test_enough_doctests(verbose=False)
Expected:
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
Got:
    There are 7 tests in sage/doctest/control.py that are not being run
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
**********************************************************************
1 item had failures:
   1 of   9 in sage.doctest.sources.FileDocTestSource._test_enough_doctests
    [371 tests, 1 failure, 105.47 s]
----------------------------------------------------------------------
sage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py  # 1 doctest failed
```



---

Comment by slabbe created at 2022-08-24 16:37:11

I saw one typo when looking at the diff:

```
    def unhide(self):
        r"""
        Hide this feature and all its joined features.
```



---

Comment by git created at 2022-09-06 07:32:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-09-06 07:34:33

Replying to [comment:15 Sébastien Labbé]:
> I saw one typo when looking at the diff:
> {{{
>     def unhide(self):
>         r"""
>         Hide this feature and all its joined features.
> }}}

Done!

In Addition I rebased over 9.7.rc0 and the current changes in #34282.


---

Comment by git created at 2022-09-30 21:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-09-30 21:28:59

Just rebasing to 9.8.beta1.
