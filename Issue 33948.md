# Issue 33948: New doctest option to hide features

archive/issues_033948.json:
```json
{
    "body": "CC:  @seblabbe\n\nAs suggested in #33823 (see [comment 25](https://trac.sagemath.org/ticket/33823#comment:25)) I make a first attempt for such an option here. The purpose of the option is to find test which need to be marked as `optional` but aren't right now.\n\nFor example see the test of the following file which contains two tests involving the optional package `database_knotinfo`. Note that on the system where I produced the output below this feature is available.\n\n\n```bash\ncat test_knotinfo.py\nr\"\"\"\nsage: KnotInfo.K9_10.homfly_polynomial()\n-v^10*z^2 + v^8*z^4 - 2*v^10 + 2*v^8*z^2 + 2*v^6*z^4 + v^8 + 5*v^6*z^2 + v^4*z^4 + 2*v^6 + 2*v^4*z^2\nsage: KnotInfo.K9_10.alexander_polynomial()  # optional database_knotinfo\n4*t^4 - 8*t^3 + 9*t^2 - 8*t + 4\n\"\"\"\n```\n\n\nThe first test is missing the `optional` tag. Thus, this would fail on a system without that feature. But, running `sage -t` without the new option does not show the problem:\n\n\n\n```bash\nsage -t test_knotinfo.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID ...\n...\nGit ref: 9.7.beta5-...\n...\nUsing --optional=database_knotinfo,debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg\nFeatures to be detected: ...\nDoctesting 1 file.\nsage -t --random-seed=17350038375103993251556014960108337039 test_knotinfo.py\n    [2 tests, 4.66 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 4.7 seconds\n    cpu time: 4.7 seconds\n    cumulative wall time: 4.7 seconds\nFeatures detected for doctesting:\n```\n\n\nUsing the new option this will be the case:\n\n\n```bash\nsage -t --hide=database_knotinfo test_knotinfo.py\ntoo many failed tests, not using stored timings\nRunning doctests with ...\n...\nGit ref: 9.7.beta5-...\n...\nUsing --optional=debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg\nFeatures to be detected: ...\nHidden features: database_knotinfo\nDoctesting 1 file.\nsage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py\n**********************************************************************\nFile \"test_knotinfo.py\", line 2, in test_knotinfo\nFailed example:\n    KnotInfo.K9_10.homfly_polynomial()\nException raised:\n    Traceback (most recent call last):\n    ...\n    NameError: name 'KnotInfo' is not defined\n**********************************************************************\n1 item had failures:\n   1 of   2 in test_knotinfo\n    [1 test, 1 failure, 0.00 s]\n----------------------------------------------------------------------\nsage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 0.0 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\nFeatures detected for doctesting:\n```\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34185\n\n",
    "created_at": "2022-07-15T07:02:30Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "New doctest option to hide features",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33948",
    "user": "@soehms"
}
```
CC:  @seblabbe

As suggested in #33823 (see [comment 25](https://trac.sagemath.org/ticket/33823#comment:25)) I make a first attempt for such an option here. The purpose of the option is to find test which need to be marked as `optional` but aren't right now.

For example see the test of the following file which contains two tests involving the optional package `database_knotinfo`. Note that on the system where I produced the output below this feature is available.


```bash
cat test_knotinfo.py
r"""
sage: KnotInfo.K9_10.homfly_polynomial()
-v^10*z^2 + v^8*z^4 - 2*v^10 + 2*v^8*z^2 + 2*v^6*z^4 + v^8 + 5*v^6*z^2 + v^4*z^4 + 2*v^6 + 2*v^4*z^2
sage: KnotInfo.K9_10.alexander_polynomial()  # optional database_knotinfo
4*t^4 - 8*t^3 + 9*t^2 - 8*t + 4
"""
```


The first test is missing the `optional` tag. Thus, this would fail on a system without that feature. But, running `sage -t` without the new option does not show the problem:



```bash
sage -t test_knotinfo.py
too many failed tests, not using stored timings
Running doctests with ID ...
...
Git ref: 9.7.beta5-...
...
Using --optional=database_knotinfo,debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg
Features to be detected: ...
Doctesting 1 file.
sage -t --random-seed=17350038375103993251556014960108337039 test_knotinfo.py
    [2 tests, 4.66 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.7 seconds
    cpu time: 4.7 seconds
    cumulative wall time: 4.7 seconds
Features detected for doctesting:
```


Using the new option this will be the case:


```bash
sage -t --hide=database_knotinfo test_knotinfo.py
too many failed tests, not using stored timings
Running doctests with ...
...
Git ref: 9.7.beta5-...
...
Using --optional=debian,debugpy,mathics,mathics_scanner,palettable,pint,pip,sage,sage_spkg
Features to be detected: ...
Hidden features: database_knotinfo
Doctesting 1 file.
sage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py
**********************************************************************
File "test_knotinfo.py", line 2, in test_knotinfo
Failed example:
    KnotInfo.K9_10.homfly_polynomial()
Exception raised:
    Traceback (most recent call last):
    ...
    NameError: name 'KnotInfo' is not defined
**********************************************************************
1 item had failures:
   1 of   2 in test_knotinfo
    [1 test, 1 failure, 0.00 s]
----------------------------------------------------------------------
sage -t --random-seed=109756173219998976577146490280531589198 test_knotinfo.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting:
```




Issue created by migration from https://trac.sagemath.org/ticket/34185





---

archive/issue_comments_482067.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-15T07:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482067",
    "user": "@soehms"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482068.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-07-15T07:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482068",
    "user": "@soehms"
}
```

New commits:



---

archive/issue_comments_482069.json:
```json
{
    "body": "I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`",
    "created_at": "2022-07-15T13:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482069",
    "user": "@mkoeppe"
}
```

I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`



---

archive/issue_comments_482070.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-18T16:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482070",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482071.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`\nActually, I didn't do that well. Many thanks for looking at the ticket!",
    "created_at": "2022-07-18T16:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482071",
    "user": "@soehms"
}
```

Replying to [comment:3 mkoeppe]:
> I think instead of reading from SAGE_PKGS directly, it would be better to refactor `sage.misc.package.list_packages`
Actually, I didn't do that well. Many thanks for looking at the ticket!



---

archive/issue_comments_482072.json:
```json
{
    "body": "A `JoinFeature` should probably hide/unhide its components",
    "created_at": "2022-07-19T21:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482072",
    "user": "@mkoeppe"
}
```

A `JoinFeature` should probably hide/unhide its components



---

archive/issue_comments_482073.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> A `JoinFeature` should probably hide/unhide its components\nWill be in the next commit.\n\nI'm wondering what's wrong with the patchbots? For example:\n\n\n```\n**********************************************************************\nFile \"/Users/jpalmier/Desktop/Sage/git/patchbot/sage-9.7.beta5/src/sage/features/__init__.py\", line 301, in sage.features.Feature.is_optional\nFailed example:\n    DatabaseCremona().is_optional()\nException raised:\n    Traceback (most recent call last):\n    ...\n    AttributeError: 'DatabaseCremona' object has no attribute 'is_optional'\n```\n\n\nAll tests failing on the patchbots succeed in the Gitpod environment. But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:\n\n\n```\nsage: from sage.features.latex import LaTeXPackage\nsage: LaTeXPackage(\"tkz-graph\").is_present()\nTraceback (most recent call last):\n...\nFileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'\n```\n\n\nThis happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a *joined feature* with `pdflatex`?",
    "created_at": "2022-07-20T16:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482073",
    "user": "@soehms"
}
```

Replying to [comment:6 mkoeppe]:
> A `JoinFeature` should probably hide/unhide its components
Will be in the next commit.

I'm wondering what's wrong with the patchbots? For example:


```
**********************************************************************
File "/Users/jpalmier/Desktop/Sage/git/patchbot/sage-9.7.beta5/src/sage/features/__init__.py", line 301, in sage.features.Feature.is_optional
Failed example:
    DatabaseCremona().is_optional()
Exception raised:
    Traceback (most recent call last):
    ...
    AttributeError: 'DatabaseCremona' object has no attribute 'is_optional'
```


All tests failing on the patchbots succeed in the Gitpod environment. But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:


```
sage: from sage.features.latex import LaTeXPackage
sage: LaTeXPackage("tkz-graph").is_present()
Traceback (most recent call last):
...
FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'
```


This happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a *joined feature* with `pdflatex`?



---

archive/issue_comments_482074.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-25T06:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482074",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482075.json:
```json
{
    "body": "The recent commit takes care of joined features. In addition (in order to allow more interesting doctest examples) I make `lazy_import` be hide-able.",
    "created_at": "2022-07-25T06:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482075",
    "user": "@soehms"
}
```

The recent commit takes care of joined features. In addition (in order to allow more interesting doctest examples) I make `lazy_import` be hide-able.



---

archive/issue_comments_482076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-05T07:22:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482076",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482077.json:
```json
{
    "body": "Replying to [comment:7 soehms]:\n> ... But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:\n> \n> {{{\n> sage: from sage.features.latex import LaTeXPackage\n> sage: LaTeXPackage(\"tkz-graph\").is_present()\n> Traceback (most recent call last):\n> ...\n> FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'\n> }}}\n> \n> This happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a *joined feature* with `pdflatex`?\n> \n\nSee #34282 for a suggestion to have this fixed.\n\nFurthermore, when testing on a system with meataxe you may randomly run into a circular import issue in `matrix_space`. This is fixed in ticket #34283.",
    "created_at": "2022-08-05T07:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482077",
    "user": "@soehms"
}
```

Replying to [comment:7 soehms]:
> ... But here there is a failing test, as well, but obviously unrelated to the branch. It is caused by:
> 
> {{{
> sage: from sage.features.latex import LaTeXPackage
> sage: LaTeXPackage("tkz-graph").is_present()
> Traceback (most recent call last):
> ...
> FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'
> }}}
> 
> This happens since `kpsewhich` is not installed on the environment. Shouldn't `LaTeXPackage` be a *joined feature* with `pdflatex`?
> 

See #34282 for a suggestion to have this fixed.

Furthermore, when testing on a system with meataxe you may randomly run into a circular import issue in `matrix_space`. This is fixed in ticket #34283.



---

archive/issue_comments_482078.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T08:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482078",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482079.json:
```json
{
    "body": "The previous commit should fix the only failure that happened on the previous patchbot run. This is the following long test:\n\n\n```sage\nDoctesting 1 file using 4 threads.\nsage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py\n**********************************************************************\nFile \"src/sage/doctest/sources.py\", line 781, in sage.doctest.sources.FileDocTestSource._test_enough_doctests\nFailed example:\n    for path, dirs, files in itertools.chain(os.walk('sage'), os.walk('doc')): # long time\n        path = os.path.relpath(path)\n        dirs.sort(); files.sort()\n        for F in files:\n            _, ext = os.path.splitext(F)\n            if ext in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst'):\n                filename = os.path.join(path, F)\n                FDS = FileDocTestSource(filename, DocTestDefaults(long=True, optional=True, force_lib=True))\n                FDS._test_enough_doctests(verbose=False)\nExpected:\n    There are 3 unexpected tests being run in sage/doctest/parsing.py\n    There are 1 unexpected tests being run in sage/doctest/reporting.py\nGot:\n    There are 7 tests in sage/doctest/control.py that are not being run\n    There are 3 unexpected tests being run in sage/doctest/parsing.py\n    There are 1 unexpected tests being run in sage/doctest/reporting.py\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage.doctest.sources.FileDocTestSource._test_enough_doctests\n    [371 tests, 1 failure, 105.47 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py  # 1 doctest failed\n```\n",
    "created_at": "2022-08-09T08:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482079",
    "user": "@soehms"
}
```

The previous commit should fix the only failure that happened on the previous patchbot run. This is the following long test:


```sage
Doctesting 1 file using 4 threads.
sage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py
**********************************************************************
File "src/sage/doctest/sources.py", line 781, in sage.doctest.sources.FileDocTestSource._test_enough_doctests
Failed example:
    for path, dirs, files in itertools.chain(os.walk('sage'), os.walk('doc')): # long time
        path = os.path.relpath(path)
        dirs.sort(); files.sort()
        for F in files:
            _, ext = os.path.splitext(F)
            if ext in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst'):
                filename = os.path.join(path, F)
                FDS = FileDocTestSource(filename, DocTestDefaults(long=True, optional=True, force_lib=True))
                FDS._test_enough_doctests(verbose=False)
Expected:
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
Got:
    There are 7 tests in sage/doctest/control.py that are not being run
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
**********************************************************************
1 item had failures:
   1 of   9 in sage.doctest.sources.FileDocTestSource._test_enough_doctests
    [371 tests, 1 failure, 105.47 s]
----------------------------------------------------------------------
sage -t --long --random-seed=32647687899858611983071143867735298580 src/sage/doctest/sources.py  # 1 doctest failed
```




---

archive/issue_comments_482080.json:
```json
{
    "body": "I saw one typo when looking at the diff:\n\n```\n    def unhide(self):\n        r\"\"\"\n        Hide this feature and all its joined features.\n```\n",
    "created_at": "2022-08-24T16:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482080",
    "user": "@seblabbe"
}
```

I saw one typo when looking at the diff:

```
    def unhide(self):
        r"""
        Hide this feature and all its joined features.
```




---

archive/issue_comments_482081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-06T07:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482082.json:
```json
{
    "body": "Replying to [comment:15 S\u00e9bastien Labb\u00e9]:\n> I saw one typo when looking at the diff:\n> {{{\n>     def unhide(self):\n>         r\"\"\"\n>         Hide this feature and all its joined features.\n> }}}\n\nDone!\n\nIn Addition I rebased over 9.7.rc0 and the current changes in #34282.",
    "created_at": "2022-09-06T07:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482082",
    "user": "@soehms"
}
```

Replying to [comment:15 Sébastien Labbé]:
> I saw one typo when looking at the diff:
> {{{
>     def unhide(self):
>         r"""
>         Hide this feature and all its joined features.
> }}}

Done!

In Addition I rebased over 9.7.rc0 and the current changes in #34282.



---

archive/issue_comments_482083.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-30T21:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482083",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482084.json:
```json
{
    "body": "Just rebasing to 9.8.beta1.",
    "created_at": "2022-09-30T21:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33948#issuecomment-482084",
    "user": "@soehms"
}
```

Just rebasing to 9.8.beta1.
