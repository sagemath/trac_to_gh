# Issue 31632: A simple substitution can send Sage in an infiite loop.

Issue created by migration from https://trac.sagemath.org/ticket/31869

Original creator: charpent

Original creation time: 2021-05-28 13:26:09

CC:  charpent @sheerluck @ypfmde nbruin slelievre

Reported in [`sage-support`](https://groups.google.com/g/sage-support/c/BLGNjf7319k)

An inocuous-looking expression :

```
sage: f.expand()(y==I)
15*z/(17*(y == I) + 11) - 5*z/(4*(y == I) + 1) + 15*z/(3*(y == I) - 4) - 75*z^2/((17*(y == I) + 11)*(4*(y == I) + 1)) + 225*z^2/((17*(y == I) + 11)*(3*(y == I) - 4)) - 75*z^2/((4*(y == I) + 1)*(3*(y == I) - 4)) - 1125*z^3/((17*(y == I) + 11)*(4*(y == I) + 1)*(3*(y == I) - 4)) + 1
sage: f.partial_fraction(y)(y==I)
-5/909*(21675*z^3 - 1700*z^2 - 2727*z)/(17*(y == I) + 11) - 15/1919*(675*z^3 + 660*z^2 - 1919*z)/(3*(y == I) - 4) + 5/171*(1200*z^3 + 160*z^2 - 171*z)/(4*(y == I) + 1) + 1
sage: f.simplify_full()(y==I)
(-300*(2*(y == I) + 1)*z^2 - 211*(y == I) - 1125*z^3 + 204*(y == I)^3 + 5*(189*(y == I)^2 + 179*(y == I) + 65)*z - 89*(y == I)^2 - 44)/(204*(y == I)^3 - 89*(y == I)^2 - 211*(y == I) - 44)
```

So far, so fine. But

```
sage: f(y=I)
```

never returns, and need a long raft of interruptions to exit.

Marked as `critical`, because a simple substitution can crash Sage.


---

Comment by charpent created at 2021-05-28 13:35:37

For one, this //isn't// a Maxima problem :

```
sage: maxima_calculus.interact()

  --> Switching to Maxima_lib <--

maxima_lib: subst([y=%i], -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)) ;
((15*z)/(3*%i-4)+1)*((5*z)/(4*%i+1)-1)*((-(15*z)/(17*%i+11))-1)
maxima_lib: 
  --> Exiting back to Sage <--

```

But :

```
maxima_calculus.subst([y==i],f).sage()
```

sends Sage in an infinite loop again...

the problem might lie in the Maxima-->Sage translation layer :

```
sage: foo = f._maxima_lib_()
sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
sage: bar
-((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
```

works fine ; but asking for `bar.sage()` sends Sage in an infinite loop...


---

Comment by nbruin created at 2021-05-28 17:15:39

Replying to [comment:1 charpent]:

Putting the example in self-contained form here:
> {{{
> sage: var('z y')
> sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)
> sage: foo = f._maxima_lib_()
> sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
> sage: bar
> -((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
> }}}
> but asking the following throws sage in an apparently infinite loop.
> {{{
> sage: bar.sage()
> }}}

Oddly enough, interrupting the process and looking at the traceback often shows sage is constructing $\sqrt(17)$.


---

Comment by @sheerluck created at 2021-05-28 20:22:03

Replying to [comment:2 nbruin]:
> traceback often shows sage is constructing $\sqrt(17)$.
I see
* `parse_sequence` from `misc/parser.pyx`, it goes to
* `__mul__` from `structure/element.pyx` line 1513 

```
         if HAVE_SAME_PARENT(cl):
             return (<Element>left)._mul_(right)
```

* `_mul_` from `symbolic/expression.pyx` line 3792

```
         else:
             x = left._gobj * _right._gobj
```

* and it jumps in `GiNaC::operator*` from `pynac-0.7.27/ginac/operators.cpp:78`
* `GiNaC::exmul` from `pynac-0.7.27/ginac/operators.cpp:53`
* `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314`
* `GiNaC::ex::construct_from_basic` from `pynac-0.7.27/ginac/ex.cpp:923`
* `GiNaC::mul::eval` from `pynac-0.7.27/ginac/mul.cpp:783`
* and here in jumps back to `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314` and repeat calls `GiNaC::ex::ex -> GiNaC::ex::construct_from_basic -> GiNaC::mul::eval` more than **36500** times :(


---

Comment by @ypfmde created at 2021-05-28 23:27:28

I don't know if that helps to pin down the problem, but even in

```
var('z')
a = z/(4*I + 1)
b = 15*z/(3*I - 4) + 1
c = a*b
```

the execution of the last line hangs. Slight modifications of the assignment of `b`, like `b = z/(3*I - 4) + 1` or `b = 15*z/(3*I - 4)` don't display that problem.


---

Comment by nbruin created at 2021-05-29 00:12:21

Replying to [comment:4 gh-ypfmde]:
> I don't know if that helps to pin down the problem
I think it does: as far as I can see, the code example you give does not involve maxima at all. This indicates it's a straight-up bug in pynac, or at least in the way sage uses it (pynac is basically part of sage: I don't think there is any other package that uses it)


---

Comment by @ypfmde created at 2021-05-29 10:11:59

I'm new to sage trac (and more of a naive end user of sage), so I don't want to potentially mess up this ticket. But in view of the many tickets, wouldn't a more expressive title (and fix of the typo) be more useful? From `A simple substitution can send Sage in an infiite loop` I would expect that some substitution generates an unlimited recursion. Maybe something explicit like `y = x*(5*x/(3*I-4)+1)/I causes segfault`? (And indeed it does!)


---

Comment by slelievre created at 2021-05-29 12:16:13

Changing keywords from "" to "pynac, segfault".


---

Comment by slelievre created at 2021-05-29 12:16:13

Here is a simpler reproducer: `x * ((3*i + 4)*x - 5)`.

Kept original expression in ticket description
so the discussion still makes sense.


---

Comment by @DaveWitteMorris created at 2021-05-30 23:27:50

The infinite loop (in pynac) is caused by an incorrect calculation of the `integer_content` of a polynomial (or other sum) that has complex coefficients. I will soon provide a patch and further explanation.


---

Comment by @DaveWitteMorris created at 2021-05-31 03:13:56

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-05-31 03:13:56

This pynac patch should solve the problem.

*Diagnosis:* Pynac automatically simplifies expressions to a standard form. In the situation here, it passes repeatedly through a loop, until no changes are made in a pass, so it knows that it is finished. One step of the simplification of a polynomial (or other sum) divides by the `integer_content`. This is supposed to be the largest rational number that can be divided by to give a result that has no denominator. 

For a polynomial with rational coefficients, the `integer_content` can be calculated by taking the gcd of the numerators, and dividing by the lcm of the denominators. Pynac tries to use this same formula for polynomials with complex coefficients, but a "feature" of the `gcd` function sends the calculation awry. Namely, pynac assumes that `gcd(a,0)` is always `abs(a)`. (See #31884 for a complaint about this.)

_Here is what goes wrong:_ To calculate the `integer_content` of the expression `(3*i + 4)*x - 5`, pynac calculates `gcd(gcd(0, 3*i + 4), -5)`.  Since `gcd(0, 3*i + 4)` is `abs(3*i + 4)`, which is `5`, the result is `gcd(5, -5)`, which is `5`. (This is incorrect: the `integer_content` of this polynomial is `1`.) So pynac divides by `5`, resulting in `(3/5 * i + 4/5)*x - 1`. In the next pass through the loop, pynac sees the denominator of `5`, and (correctly) concludes that the `integer_content` of this polynomial is `1/5`. It therefore divides by `1/5` to get rid of the denominator. This gets us back to the original polynomial, so pynac is in an infinite loop.

*Solution:* The `integer_content` of a polynomial with coefficient `a + b*i` should be calculated as if `a` and `b` were the coefficients of two different terms.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-05-31 07:19:48

PS Thanks to everyone who contributed to this discussion. The simplified example, the traceback, and the other comments made it much easier to locate the bug!


---

Comment by tscrim created at 2021-06-01 00:13:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-06-01 00:13:29

LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.


---

Comment by charpent created at 2021-06-01 05:57:18

Replying to [comment:12 tscrim]:
> LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.

Same results here : passes `ptestlong` with the sae results as 9.4.betaO).

Thanks a lot !


---

Comment by vbraun created at 2021-06-07 21:40:31

Resolution: fixed
