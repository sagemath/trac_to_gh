# Issue 31632: A simple substitution can send Sage in an infiite loop.

archive/issues_031632.json:
```json
{
    "body": "CC:  charpent @sheerluck @ypfmde nbruin slelievre\n\nReported in [`sage-support`](https://groups.google.com/g/sage-support/c/BLGNjf7319k)\n\nAn inocuous-looking expression :\n\n```\nsage: f.expand()(y==I)\n15*z/(17*(y == I) + 11) - 5*z/(4*(y == I) + 1) + 15*z/(3*(y == I) - 4) - 75*z^2/((17*(y == I) + 11)*(4*(y == I) + 1)) + 225*z^2/((17*(y == I) + 11)*(3*(y == I) - 4)) - 75*z^2/((4*(y == I) + 1)*(3*(y == I) - 4)) - 1125*z^3/((17*(y == I) + 11)*(4*(y == I) + 1)*(3*(y == I) - 4)) + 1\nsage: f.partial_fraction(y)(y==I)\n-5/909*(21675*z^3 - 1700*z^2 - 2727*z)/(17*(y == I) + 11) - 15/1919*(675*z^3 + 660*z^2 - 1919*z)/(3*(y == I) - 4) + 5/171*(1200*z^3 + 160*z^2 - 171*z)/(4*(y == I) + 1) + 1\nsage: f.simplify_full()(y==I)\n(-300*(2*(y == I) + 1)*z^2 - 211*(y == I) - 1125*z^3 + 204*(y == I)^3 + 5*(189*(y == I)^2 + 179*(y == I) + 65)*z - 89*(y == I)^2 - 44)/(204*(y == I)^3 - 89*(y == I)^2 - 211*(y == I) - 44)\n```\n\nSo far, so fine. But\n\n```\nsage: f(y=I)\n```\n\nnever returns, and need a long raft of interruptions to exit.\n\nMarked as `critical`, because a simple substitution can crash Sage.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31869\n\n",
    "created_at": "2021-05-28T13:26:09Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "title": "A simple substitution can send Sage in an infiite loop.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31632",
    "user": "charpent"
}
```
CC:  charpent @sheerluck @ypfmde nbruin slelievre

Reported in [`sage-support`](https://groups.google.com/g/sage-support/c/BLGNjf7319k)

An inocuous-looking expression :

```
sage: f.expand()(y==I)
15*z/(17*(y == I) + 11) - 5*z/(4*(y == I) + 1) + 15*z/(3*(y == I) - 4) - 75*z^2/((17*(y == I) + 11)*(4*(y == I) + 1)) + 225*z^2/((17*(y == I) + 11)*(3*(y == I) - 4)) - 75*z^2/((4*(y == I) + 1)*(3*(y == I) - 4)) - 1125*z^3/((17*(y == I) + 11)*(4*(y == I) + 1)*(3*(y == I) - 4)) + 1
sage: f.partial_fraction(y)(y==I)
-5/909*(21675*z^3 - 1700*z^2 - 2727*z)/(17*(y == I) + 11) - 15/1919*(675*z^3 + 660*z^2 - 1919*z)/(3*(y == I) - 4) + 5/171*(1200*z^3 + 160*z^2 - 171*z)/(4*(y == I) + 1) + 1
sage: f.simplify_full()(y==I)
(-300*(2*(y == I) + 1)*z^2 - 211*(y == I) - 1125*z^3 + 204*(y == I)^3 + 5*(189*(y == I)^2 + 179*(y == I) + 65)*z - 89*(y == I)^2 - 44)/(204*(y == I)^3 - 89*(y == I)^2 - 211*(y == I) - 44)
```

So far, so fine. But

```
sage: f(y=I)
```

never returns, and need a long raft of interruptions to exit.

Marked as `critical`, because a simple substitution can crash Sage.

Issue created by migration from https://trac.sagemath.org/ticket/31869





---

archive/issue_comments_451784.json:
```json
{
    "body": "For one, this //isn't// a Maxima problem :\n\n```\nsage: maxima_calculus.interact()\n\n  --> Switching to Maxima_lib <--\n\nmaxima_lib: subst([y=%i], -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)) ;\n((15*z)/(3*%i-4)+1)*((5*z)/(4*%i+1)-1)*((-(15*z)/(17*%i+11))-1)\nmaxima_lib: \n  --> Exiting back to Sage <--\n\n```\n\nBut :\n\n```\nmaxima_calculus.subst([y==i],f).sage()\n```\n\nsends Sage in an infinite loop again...\n\nthe problem might lie in the Maxima-->Sage translation layer :\n\n```\nsage: foo = f._maxima_lib_()\nsage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)\nsage: bar\n-((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)\n```\n\nworks fine ; but asking for `bar.sage()` sends Sage in an infinite loop...",
    "created_at": "2021-05-28T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451784",
    "user": "charpent"
}
```

For one, this //isn't// a Maxima problem :

```
sage: maxima_calculus.interact()

  --> Switching to Maxima_lib <--

maxima_lib: subst([y=%i], -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)) ;
((15*z)/(3*%i-4)+1)*((5*z)/(4*%i+1)-1)*((-(15*z)/(17*%i+11))-1)
maxima_lib: 
  --> Exiting back to Sage <--

```

But :

```
maxima_calculus.subst([y==i],f).sage()
```

sends Sage in an infinite loop again...

the problem might lie in the Maxima-->Sage translation layer :

```
sage: foo = f._maxima_lib_()
sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
sage: bar
-((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
```

works fine ; but asking for `bar.sage()` sends Sage in an infinite loop...



---

archive/issue_comments_451785.json:
```json
{
    "body": "Replying to [comment:1 charpent]:\n\nPutting the example in self-contained form here:\n> {{{\n> sage: var('z y')\n> sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)\n> sage: foo = f._maxima_lib_()\n> sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)\n> sage: bar\n> -((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)\n> }}}\n> but asking the following throws sage in an apparently infinite loop.\n> {{{\n> sage: bar.sage()\n> }}}\n\nOddly enough, interrupting the process and looking at the traceback often shows sage is constructing $\\sqrt(17)$.",
    "created_at": "2021-05-28T17:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451785",
    "user": "nbruin"
}
```

Replying to [comment:1 charpent]:

Putting the example in self-contained form here:
> {{{
> sage: var('z y')
> sage: f = -(15*z/(17*y + 11) + 1)*(5*z/(4*y + 1) - 1)*(15*z/(3*y - 4) + 1)
> sage: foo = f._maxima_lib_()
> sage: bar = maxima_calculus.subst((y==I)._maxima_lib_(), foo)
> sage: bar
> -((15*_SAGE_VAR_z)/(3*%i-4)+1)*((5*_SAGE_VAR_z)/(4*%i+1)-1)*((15*_SAGE_VAR_z)/(17*%i+11)+1)
> }}}
> but asking the following throws sage in an apparently infinite loop.
> {{{
> sage: bar.sage()
> }}}

Oddly enough, interrupting the process and looking at the traceback often shows sage is constructing $\sqrt(17)$.



---

archive/issue_comments_451786.json:
```json
{
    "body": "Replying to [comment:2 nbruin]:\n> traceback often shows sage is constructing $\\sqrt(17)$.\nI see\n* `parse_sequence` from `misc/parser.pyx`, it goes to\n* `__mul__` from `structure/element.pyx` line 1513 \n\n```\n         if HAVE_SAME_PARENT(cl):\n             return (<Element>left)._mul_(right)\n```\n\n* `_mul_` from `symbolic/expression.pyx` line 3792\n\n```\n         else:\n             x = left._gobj * _right._gobj\n```\n\n* and it jumps in `GiNaC::operator*` from `pynac-0.7.27/ginac/operators.cpp:78`\n* `GiNaC::exmul` from `pynac-0.7.27/ginac/operators.cpp:53`\n* `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314`\n* `GiNaC::ex::construct_from_basic` from `pynac-0.7.27/ginac/ex.cpp:923`\n* `GiNaC::mul::eval` from `pynac-0.7.27/ginac/mul.cpp:783`\n* and here in jumps back to `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314` and repeat calls `GiNaC::ex::ex -> GiNaC::ex::construct_from_basic -> GiNaC::mul::eval` more than **36500** times :(",
    "created_at": "2021-05-28T20:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451786",
    "user": "@sheerluck"
}
```

Replying to [comment:2 nbruin]:
> traceback often shows sage is constructing $\sqrt(17)$.
I see
* `parse_sequence` from `misc/parser.pyx`, it goes to
* `__mul__` from `structure/element.pyx` line 1513 

```
         if HAVE_SAME_PARENT(cl):
             return (<Element>left)._mul_(right)
```

* `_mul_` from `symbolic/expression.pyx` line 3792

```
         else:
             x = left._gobj * _right._gobj
```

* and it jumps in `GiNaC::operator*` from `pynac-0.7.27/ginac/operators.cpp:78`
* `GiNaC::exmul` from `pynac-0.7.27/ginac/operators.cpp:53`
* `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314`
* `GiNaC::ex::construct_from_basic` from `pynac-0.7.27/ginac/ex.cpp:923`
* `GiNaC::mul::eval` from `pynac-0.7.27/ginac/mul.cpp:783`
* and here in jumps back to `GiNaC::ex::ex` from `pynac-0.7.27/ginac/ex.h:314` and repeat calls `GiNaC::ex::ex -> GiNaC::ex::construct_from_basic -> GiNaC::mul::eval` more than **36500** times :(



---

archive/issue_comments_451787.json:
```json
{
    "body": "I don't know if that helps to pin down the problem, but even in\n\n```\nvar('z')\na = z/(4*I + 1)\nb = 15*z/(3*I - 4) + 1\nc = a*b\n```\n\nthe execution of the last line hangs. Slight modifications of the assignment of `b`, like `b = z/(3*I - 4) + 1` or `b = 15*z/(3*I - 4)` don't display that problem.",
    "created_at": "2021-05-28T23:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451787",
    "user": "@ypfmde"
}
```

I don't know if that helps to pin down the problem, but even in

```
var('z')
a = z/(4*I + 1)
b = 15*z/(3*I - 4) + 1
c = a*b
```

the execution of the last line hangs. Slight modifications of the assignment of `b`, like `b = z/(3*I - 4) + 1` or `b = 15*z/(3*I - 4)` don't display that problem.



---

archive/issue_comments_451788.json:
```json
{
    "body": "Replying to [comment:4 gh-ypfmde]:\n> I don't know if that helps to pin down the problem\nI think it does: as far as I can see, the code example you give does not involve maxima at all. This indicates it's a straight-up bug in pynac, or at least in the way sage uses it (pynac is basically part of sage: I don't think there is any other package that uses it)",
    "created_at": "2021-05-29T00:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451788",
    "user": "nbruin"
}
```

Replying to [comment:4 gh-ypfmde]:
> I don't know if that helps to pin down the problem
I think it does: as far as I can see, the code example you give does not involve maxima at all. This indicates it's a straight-up bug in pynac, or at least in the way sage uses it (pynac is basically part of sage: I don't think there is any other package that uses it)



---

archive/issue_comments_451789.json:
```json
{
    "body": "I'm new to sage trac (and more of a naive end user of sage), so I don't want to potentially mess up this ticket. But in view of the many tickets, wouldn't a more expressive title (and fix of the typo) be more useful? From `A simple substitution can send Sage in an infiite loop` I would expect that some substitution generates an unlimited recursion. Maybe something explicit like `y = x*(5*x/(3*I-4)+1)/I causes segfault`? (And indeed it does!)",
    "created_at": "2021-05-29T10:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451789",
    "user": "@ypfmde"
}
```

I'm new to sage trac (and more of a naive end user of sage), so I don't want to potentially mess up this ticket. But in view of the many tickets, wouldn't a more expressive title (and fix of the typo) be more useful? From `A simple substitution can send Sage in an infiite loop` I would expect that some substitution generates an unlimited recursion. Maybe something explicit like `y = x*(5*x/(3*I-4)+1)/I causes segfault`? (And indeed it does!)



---

archive/issue_comments_451790.json:
```json
{
    "body": "Changing keywords from \"\" to \"pynac, segfault\".",
    "created_at": "2021-05-29T12:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451790",
    "user": "slelievre"
}
```

Changing keywords from "" to "pynac, segfault".



---

archive/issue_comments_451791.json:
```json
{
    "body": "Here is a simpler reproducer: `x * ((3*i + 4)*x - 5)`.\n\nKept original expression in ticket description\nso the discussion still makes sense.",
    "created_at": "2021-05-29T12:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451791",
    "user": "slelievre"
}
```

Here is a simpler reproducer: `x * ((3*i + 4)*x - 5)`.

Kept original expression in ticket description
so the discussion still makes sense.



---

archive/issue_comments_451792.json:
```json
{
    "body": "The infinite loop (in pynac) is caused by an incorrect calculation of the `integer_content` of a polynomial (or other sum) that has complex coefficients. I will soon provide a patch and further explanation.",
    "created_at": "2021-05-30T23:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451792",
    "user": "@DaveWitteMorris"
}
```

The infinite loop (in pynac) is caused by an incorrect calculation of the `integer_content` of a polynomial (or other sum) that has complex coefficients. I will soon provide a patch and further explanation.



---

archive/issue_comments_451793.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-31T03:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451793",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_451794.json:
```json
{
    "body": "This pynac patch should solve the problem.\n\n**Diagnosis:** Pynac automatically simplifies expressions to a standard form. In the situation here, it passes repeatedly through a loop, until no changes are made in a pass, so it knows that it is finished. One step of the simplification of a polynomial (or other sum) divides by the `integer_content`. This is supposed to be the largest rational number that can be divided by to give a result that has no denominator. \n\nFor a polynomial with rational coefficients, the `integer_content` can be calculated by taking the gcd of the numerators, and dividing by the lcm of the denominators. Pynac tries to use this same formula for polynomials with complex coefficients, but a \"feature\" of the `gcd` function sends the calculation awry. Namely, pynac assumes that `gcd(a,0)` is always `abs(a)`. (See #31884 for a complaint about this.)\n\n*Here is what goes wrong:* To calculate the `integer_content` of the expression `(3*i + 4)*x - 5`, pynac calculates `gcd(gcd(0, 3*i + 4), -5)`.  Since `gcd(0, 3*i + 4)` is `abs(3*i + 4)`, which is `5`, the result is `gcd(5, -5)`, which is `5`. (This is incorrect: the `integer_content` of this polynomial is `1`.) So pynac divides by `5`, resulting in `(3/5 * i + 4/5)*x - 1`. In the next pass through the loop, pynac sees the denominator of `5`, and (correctly) concludes that the `integer_content` of this polynomial is `1/5`. It therefore divides by `1/5` to get rid of the denominator. This gets us back to the original polynomial, so pynac is in an infinite loop.\n\n**Solution:** The `integer_content` of a polynomial with coefficient `a + b*i` should be calculated as if `a` and `b` were the coefficients of two different terms.\n----\nNew commits:",
    "created_at": "2021-05-31T03:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451794",
    "user": "@DaveWitteMorris"
}
```

This pynac patch should solve the problem.

**Diagnosis:** Pynac automatically simplifies expressions to a standard form. In the situation here, it passes repeatedly through a loop, until no changes are made in a pass, so it knows that it is finished. One step of the simplification of a polynomial (or other sum) divides by the `integer_content`. This is supposed to be the largest rational number that can be divided by to give a result that has no denominator. 

For a polynomial with rational coefficients, the `integer_content` can be calculated by taking the gcd of the numerators, and dividing by the lcm of the denominators. Pynac tries to use this same formula for polynomials with complex coefficients, but a "feature" of the `gcd` function sends the calculation awry. Namely, pynac assumes that `gcd(a,0)` is always `abs(a)`. (See #31884 for a complaint about this.)

*Here is what goes wrong:* To calculate the `integer_content` of the expression `(3*i + 4)*x - 5`, pynac calculates `gcd(gcd(0, 3*i + 4), -5)`.  Since `gcd(0, 3*i + 4)` is `abs(3*i + 4)`, which is `5`, the result is `gcd(5, -5)`, which is `5`. (This is incorrect: the `integer_content` of this polynomial is `1`.) So pynac divides by `5`, resulting in `(3/5 * i + 4/5)*x - 1`. In the next pass through the loop, pynac sees the denominator of `5`, and (correctly) concludes that the `integer_content` of this polynomial is `1/5`. It therefore divides by `1/5` to get rid of the denominator. This gets us back to the original polynomial, so pynac is in an infinite loop.

**Solution:** The `integer_content` of a polynomial with coefficient `a + b*i` should be calculated as if `a` and `b` were the coefficients of two different terms.
----
New commits:



---

archive/issue_comments_451795.json:
```json
{
    "body": "PS Thanks to everyone who contributed to this discussion. The simplified example, the traceback, and the other comments made it much easier to locate the bug!",
    "created_at": "2021-05-31T07:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451795",
    "user": "@DaveWitteMorris"
}
```

PS Thanks to everyone who contributed to this discussion. The simplified example, the traceback, and the other comments made it much easier to locate the bug!



---

archive/issue_comments_451796.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-01T00:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451796",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451797.json:
```json
{
    "body": "LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.",
    "created_at": "2021-06-01T00:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451797",
    "user": "tscrim"
}
```

LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.



---

archive/issue_comments_451798.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.\n\nSame results here : passes `ptestlong` with the sae results as 9.4.betaO).\n\nThanks a lot !",
    "created_at": "2021-06-01T05:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451798",
    "user": "charpent"
}
```

Replying to [comment:12 tscrim]:
> LGTM. Please also create a PR [upstream](https://github.com/pynac/pynac) and link it in the ticket description.

Same results here : passes `ptestlong` with the sae results as 9.4.betaO).

Thanks a lot !



---

archive/issue_comments_451799.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-07T21:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-451799",
    "user": "vbraun"
}
```

Resolution: fixed
