# Issue 31119: Restructure docbuild as optional script packages sagemath_doc_html, sagemath_doc_pdf

Issue created by migration from https://trac.sagemath.org/ticket/31356

Original creator: mkoeppe

Original creation time: 2021-02-07 18:33:03

CC:  jhpalmieri

In particular, we make building the HTML documentation optional.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-02-25 04:56:44

New commits:


---

Comment by git created at 2021-02-25 05:40:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-02-25 05:42:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-25 05:48:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-15 06:10:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-29 23:55:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-30 00:07:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-30 05:16:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-01 02:20:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-09 00:19:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-09 00:21:17

Changing status from new to needs_review.


---

Comment by git created at 2021-11-09 00:26:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-09 01:27:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-09 05:44:38

I feel like `trees.txt` should be `tree.txt`, unless there is some way to specify more than one tree there. Obviously not a big deal. I would like this file to be documented, though, and maybe a comment in `m4/sage_spkg_collect.m4` is the right place.


---

Comment by mkoeppe created at 2021-11-09 05:48:15

Yes, actually several trees are allowed to be specified there.
We don't need this quite yet, but a separate environment for the Jupyter notebook could make sense; and then some packages such as `jupyter_core` would have to be installed in both `SAGE_VENV` and the new notebook environment.


---

Comment by mkoeppe created at 2021-11-09 05:50:27

I'll add a bit to the developer's guide


---

Comment by git created at 2021-11-09 06:00:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-09 19:28:42

It's not clear to me what `./configure --enable-sagemath_doc_pdf` is supposed to do just by reading `./configure --help`. If I run `make`, will it also run `make doc-pdf`, or does it just do some prep work for the PDF build? I see this:

```
  --enable-sagemath_doc_pdf={no|if_installed (default)|yes}
                          enable build and use of the optional package sagemath_doc_pdf
                          * package info: ./sage -info sagemath_doc_pdf
```

and then unfortunately `./sage -info sagemath_doc_pdf` is not very useful.


---

Comment by mkoeppe created at 2021-11-09 19:36:25

I'll add `SPKG.rst` files to make the info more useful


---

Comment by jhpalmieri created at 2021-11-09 19:57:22

I think that `sage_docbuild` should be a dependency of each of the new packages: I just got this error (`sagemath_doc_html-none.log`):

```
/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/bin/python3: No module named sage_docbuild
make doc-inventory--
cd /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5 && ./sage --docbuild --no-pdf-links .o inventory 
/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/bin/python3: No module named sage_docbuild
make[6]: *** [doc-inventory--.o] Error 1
make[5]: *** [doc-inventory-reference] Error 2
```



---

Comment by git created at 2021-11-09 20:02:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-09 20:04:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-09 20:23:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-09 21:18:16

I'm getting an error with the pdf build, one that I don't get with the `develop` branch: `en/reference/plotting` is failing, and the file `local/share/doc/sage/latex/en/reference/plotting/plotting.log` ends with

```
Package pdftex.def Info: plot-23.pdf  used on input line 864.
(pdftex.def)             Requested size: 462.52684pt x 346.89516pt.
<plot-24.pdf, id=486, 462.52798pt x 346.89601pt>
File: plot-24.pdf Graphic file (type pdf)
<use plot-24.pdf>
Package pdftex.def Info: plot-24.pdf  used on input line 884.
(pdftex.def)             Requested size: 462.52684pt x 346.89516pt.

[23 <./plot-22.pdf>] [24 <./plot-23.pdf>] [25 <./plot-24.pdf
!pdfTeX error: pdflatex (file ./plot-24.pdf): PDF inclusion: type <cmd> cannot 
be copied
 ==> Fatal error occurred, no output PDF file produced!
```

Any ideas?


---

Comment by mkoeppe created at 2021-11-09 21:40:33

No idea, I haven't seen this failure


---

Comment by git created at 2021-11-09 21:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-09 21:55:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-09 23:03:10

I'm also getting an error with the html build:

```
[developer] The HTML pages are in local/share/doc/sage/html/en/developer.
Error building the documentation.
Traceback (most recent call last):
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1814, in main
    builder()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
    runsphinx()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
    sys.stderr.raise_errors()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
    raise OSError(self._error)
OSError: /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/src/doc/en/developer/packaging.rst:721: WARNING: Duplicate explicit target name: "section-dependencies".
```

This is after `make distclean && ./configure && make`.


---

Comment by mkoeppe created at 2021-11-10 00:05:17

Thanks, I see this one now too, after `make distclean`


---

Comment by git created at 2021-11-10 00:09:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-10 00:21:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-10 02:28:33

PDF builds for me without error


---

Comment by jhpalmieri created at 2021-11-10 05:28:43

I think that `sagemath_doc_html` should be a dependency for `sagemath_doc_pdf`. Otherwise both may try to build at the same time, and they may both try to build the inventory files at the same time, which could easily lead to race conditions.


---

Comment by mkoeppe created at 2021-11-10 05:34:26

Yes, I agree


---

Comment by git created at 2021-11-10 05:44:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-10 22:37:24

Everything now builds for me.


---

Comment by mkoeppe created at 2021-11-10 22:50:53

Thanks for testing!


---

Comment by jhpalmieri created at 2021-11-11 05:40:33

I think this is ready to go. Merge now or wait until 9.6? I can imagine it breaking something for unforeseen reasons.


---

Comment by mkoeppe created at 2021-11-11 05:49:03

I think we can merge it now


---

Comment by jhpalmieri created at 2021-11-11 17:18:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-11 17:24:13

Thank you!


---

Comment by vbraun created at 2021-11-14 17:06:30

Resolution: fixed
