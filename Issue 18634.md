# Issue 18634: MILP formulation for cutwidth

Issue created by migration from Trac.

Original creator: dcoudert

Original creation time: 2015-07-08 17:17:59

CC:  ncohen

Keywords: cutwidth, MILP

This ticket adds a MILP formulation for computing the cutwidth of graphs. This method has no limit on the size of the input graph, but it is slower than other methods.


---

Comment by git created at 2015-07-08 17:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-08 17:21:54

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-07-10 13:37:06

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-07-10 13:37:06

Hellooooooo David,

Some comments:

- Module's doc, documentation of MILP variable `z`: at the end of the line there
  is a `y^y`. Shouldn't it be `y^k`?

- Constraints: the third constraint is missing one side of the inequality.

- But I am not sure that I understand the system: why wouldn't you say that:
  a) `x_v^k <= x_v^{k+1}` (the values can only increase)
  b) `\sum_v x_v^k == k` (for every k)

- About y: what about only having those two constraints:
  - `y_{uv}^k >= x_v^k - x_u^k`
  - `y_{uv}^k >= x_u^k - x_v^k`
  It seems to me that they are sufficient to express `y_{uv}^k >= x_u^k XOR x_v^k`. And you do not really need to say that `y` has to be *equal* to the
  XOR, the `>=` should be enough given that you minimize the cost of a cut.

- If you see a better way to name the `x,y`, and `z`... `:-P`

- When building the documentation, the references toward the number of the
  constraints do not appear correctly. Neither does the 'xor'.

- You call `set_binary` on a variable that you already defined as binary.

- Is there any reason why you catch the `MIPSolverException`?

- You do not have to int+round the value of `z['z']`. The solver should give you
  an integer value as you defined the variable as integral: if it does not,
  that's a bug that should be fixed.

Nathann


---

Comment by git created at 2015-07-10 16:26:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-10 16:30:26

> - Module's doc, documentation of MILP variable `z`: at the end of the line there
>   is a `y^y`. Shouldn't it be `y^k`?
Right.
 
> - Constraints: the third constraint is missing one side of the inequality.
Added
  
> - But I am not sure that I understand the system: why wouldn't you say that:
>   a) `x_v^k <= x_v^{k+1}` (the values can only increase)
>   b) `\sum_v x_v^k == k` (for every k)
Constraint (a) can be rewritten with a sum as I did. It is sometimes faster for the solver. Don't know why.
 
> - About y: what about only having those two constraints:
>   - `y_{uv}^k >= x_v^k - x_u^k`
>   - `y_{uv}^k >= x_u^k - x_v^k`
>   It seems to me that they are sufficient to express `y_{uv}^k >= x_u^k XOR x_v^k`. And you do not really need to say that `y` has to be *equal* to the
>   XOR, the `>=` should be enough given that you minimize the cost of a cut.
You are right. I have simplified the code.
 
> - If you see a better way to name the `x,y`, and `z`... `:-P`
unfortunately no better names in mind.
  
> - When building the documentation, the references toward the number of the
>   constraints do not appear correctly. Neither does the 'xor'.
Corrected. (and no xor anymore)
 
> - You call `set_binary` on a variable that you already defined as binary.
removed.
 
> - Is there any reason why you catch the `MIPSolverException`?
Removed. no particular reason.
  
> - You do not have to int+round the value of `z['z']`. The solver should give you
>   an integer value as you defined the variable as integral: if it does not,
>   that's a bug that should be fixed.
I have removed the round.

Thanks for the review.


---

Comment by git created at 2015-07-10 16:52:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-07-10 16:56:34

Hello again,

I added a small commit with a couple of modifications:

- replaces "A - B <= 0" constraints with "A <= B"

- Removed 'except:'

The problem with 'except' without any exception name is that it catches too much:


```
sage: try:
....:     p.solveeeeee()
....: except:
....:     raise ValueError("Infeasible Problem")
ValueError: Infeasible Problem
```


This way, the LP solver is forwarded to the user, and it will be more meaningful that a generic error message: on my computer I get this:


```
sage: cutwidth.cutwidth_MILP(G, lower_bound=G.size()+1)
...
MIPSolverException: 'CPLEX: The primal has no feasible solution'
```


You can change the ticket's status to `positive_review` unless there is something that you want to change.

Have fuuuuuuun,

Nathann


---

Comment by ncohen created at 2015-07-10 16:56:34

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-07-11 09:31:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-11 09:38:30

Hello,

I agree with your modifications, and I have removed the import of MIPSolverException.

I have a question because the patchbot is complaining about multiline doctest:

```
========== plugins.doctest_continuation ==========

--- 6.8.beta8

+++ 6.8.beta8 + #18871


-Old-style doctest continuation inserted on 0 non-empty lines
+inside file:  b/src/sage/graphs/graph_decompositions/cutwidth.pyx
+`@``@` -258,6 +312,16 `@``@` def cutwidth(G, algorithm="exponential", cut_off=0):
++        ...       G = graphs.RandomGNP(10, 0.2)
++        ...       ve, le = cutwidth.cutwidth_dyn(G)
++        ...       vm, lm = cutwidth.cutwidth_MILP(G)
++        ...       if ve != vm:
++        ...          print "Something goes wrong!"
+`@``@` -478,3 +545,157 `@``@` cdef inline int exists(FastDigraph g, uint8_t * neighborhoods, int S, int cost_S
++        ...       G = graphs.RandomGNP(10, 0.2)
++        ...       ve, le = cutwidth.cutwidth_dyn(G)
++        ...       vm, lm = cutwidth.cutwidth_MILP(G)
++        ...       if ve != vm:
++        ...          print "The solution is not optimal!"
+Old-style doctest continuation inserted on 10 non-empty lines
+Traceback (most recent call last):
+  File "/home/vincent/sage_patchbot/local/bin/patchbot/patchbot.py", line 906, in test_a_ticket
+    baseline=baseline, **kwds)
+  File "/home/vincent/sage_patchbot/local/bin/patchbot/plugins.py", line 310, in doctest_continuation
+    msg="Old-style doctest continuation", **kwds)
+  File "/home/vincent/sage_patchbot/local/bin/patchbot/plugins.py", line 207, in exclude_new
+    raise ValueError(full_msg)
+ValueError: {} inserted on {} non-empty lines
```

I not sure to understand the problem. Should we use `...` or `....:` as indicated here http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings ?
Both style are used in the tests of method ` vertex_separation_MILP`, in file `vertex_separation.pyx`.
Let me know what I should do.

David.


---

Comment by ncohen created at 2015-07-11 11:01:41

YOooooooo !

We should use the new-style '....:' everywhere. Old code has not been changed, but the policy is to not add more.

Nathann


---

Comment by git created at 2015-07-11 11:08:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-11 11:08:34

Should be ok now. Thanks.


---

Comment by ncohen created at 2015-07-11 14:11:32

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-07-11 14:14:24

Thanks.


---

Comment by vbraun created at 2015-07-11 22:21:54


```
! Emergency stop.
 ...                                              
                                                  
l.58326 \end{alignat}
                     
!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on graphs.log.
Makefile:55: recipe for target 'graphs.pdf' failed
make[2]: *** [graphs.pdf] Error 1
```



---

Comment by vbraun created at 2015-07-11 22:21:54

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-07-12 07:41:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-12 07:44:16

On my computer, command `./sage -docbuild reference/graphs pdf` produces the pdf file and the ouput is correct.
David.


---

Comment by dcoudert created at 2015-07-12 07:44:16

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-07-12 08:39:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-12 13:00:53

Resolution: fixed


---

Comment by vbraun created at 2015-07-14 23:06:54

Changing status from closed to new.


---

Comment by vbraun created at 2015-07-14 23:06:54

Resolution changed from fixed to 


---

Comment by vbraun created at 2015-07-14 23:06:54

This tests insanely slow, to the point of making tests time out (possibly randomly):

```
sage -t --warn-long 27.3 src/sage/graphs/graph_decompositions/cutwidth.pyx
    Timed out
**********************************************************************
Tests run before process (pid=23887) timed out:
sage: from sage.graphs.graph_decompositions import cutwidth ## line 206 ##
sage: G = graphs.CycleGraph(6) ## line 207 ##
sage: L = G.vertices() ## line 208 ##
sage: cutwidth.width_of_cut_decomposition(G, L) ## line 209 ##
2
sage: from sage.graphs.graph_decompositions import cutwidth ## line 214 ##
sage: P = graphs.PathGraph(6) ## line 215 ##
sage: cutwidth.width_of_cut_decomposition(P, [0, 1, 2, 3, 4, 5]) ## line 216 ##
1
sage: cutwidth.width_of_cut_decomposition(P, [5, 0, 1, 2, 3, 4]) ## line 218 ##
2
sage: cutwidth.width_of_cut_decomposition(P, [0, 2, 4, 1, 3, 5]) ## line 220 ##
5
sage: from sage.graphs.graph_decompositions import cutwidth ## line 227 ##
sage: cutwidth.width_of_cut_decomposition(Graph(), ['a','b']) ## line 228 ##
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 232 ##
0
sage: from sage.graphs.graph_decompositions.cutwidth import cutwidth ## line 294 ##
sage: G = graphs.CompleteGraph(5) ## line 295 ##
sage: cw,L = cutwidth(G, algorithm="exponential"); cw ## line 296 ##
6
sage: K = graphs.CompleteGraph(6) ## line 298 ##
sage: cw,L = cutwidth(K, algorithm="exponential"); cw ## line 299 ##
9
sage: cw,L = cutwidth(K+K, algorithm="exponential"); cw ## line 301 ##
9
sage: from sage.graphs.graph_decompositions.cutwidth import cutwidth ## line 306 ##
sage: G = graphs.Grid2dGraph(3,3) ## line 307 ##
sage: cw,L = cutwidth(G, algorithm="exponential"); cw ## line 308 ##
4
sage: G = graphs.Grid2dGraph(3,5) ## line 310 ##
sage: cw,L = cutwidth(G, algorithm="exponential"); cw ## line 311 ##
4
sage: from sage.graphs.graph_decompositions import cutwidth ## line 318 ##
sage: for i in range(10):  # long test
    G = graphs.RandomGNP(10, 0.2)
    ve, le = cutwidth.cutwidth_dyn(G)
    vm, lm = cutwidth.cutwidth_MILP(G)
    if ve != vm:
       print "Something goes wrong!" ## line 319 ##

**********************************************************************
----------------------------------------------------------------------
sage -t --warn-long 27.3 src/sage/graphs/graph_decompositions/cutwidth.pyx  # Timed out
----------------------------------------------------------------------
Total time for all tests: 323.1 seconds
    cpu time: 123.0 seconds
    cumulative wall time: 231.2 seconds
```

This was on my state of the art Haswell-E desktop fyi


---

Comment by dcoudert created at 2015-07-15 09:17:08

Changing status from new to needs_info.


---

Comment by dcoudert created at 2015-07-15 09:17:08

New commits:


---

Comment by dcoudert created at 2015-07-15 09:26:42

Really sorry about that Volker. I forgot that my default solver is cplex and the difference of timing is impressive (on my macbook air...)

```
confetti:sage dcoudert$ ./sage -btp src/sage/graphs/graph_decompositions/cutwidth.pyx
...
Using --optional=cbc,gap_packages,gcc,mpir,python2,sage,scons
Doctesting 1 file using 4 threads.
sage -t src/sage/graphs/graph_decompositions/cutwidth.pyx
    [56 tests, 2.28 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2.3 seconds
    cpu time: 4.7 seconds
    cumulative wall time: 2.3 seconds
```

I will simplify the tests and check with GLPK.


---

Comment by git created at 2015-07-15 09:52:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-07-15 09:52:50

Changing status from needs_info to needs_review.


---

Comment by ncohen created at 2015-07-15 10:06:26

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2015-07-15 10:06:26

I ran the test with GLPK as the default solver, and it went well.


---

Comment by vbraun created at 2015-07-27 15:15:52

Resolution: fixed
