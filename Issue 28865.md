# Issue 28865: fflas_ffpack installation error on new CPUs with old compilers

Issue created by migration from https://trac.sagemath.org/ticket/29102

Original creator: mkoeppe

Original creation time: 2020-01-29 15:18:33

CC:  dimpase arojas @timokau fbissey vbraun ​tmonteil

As observed in #29084, ​fflas_ffpack compilation fails on a processor that supports AVX512 extensions with the default compiler on Ubuntu Trusty - gcc version 4.8.4 (Ubuntu 4.8.4-2ubuntu1~14.04.4).

See `ubuntu-trusty-minimal` run at ​https://github.com/mkoeppe/sage/runs/414021553

`fflas_ffpack` configuration should check that the compiler actually supports the architecture flags that it wants to use.

It should be checked whether upstream has a fix for this.
Not the same upstream issue: https://github.com/linbox-team/fflas-ffpack/issues/284


---

Comment by @mwageringel created at 2020-01-29 17:34:55

See also this thread on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/0thZC21OFAAJ).


---

Comment by mkoeppe created at 2020-02-06 21:03:29

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-02-06 21:03:29

Tests run at https://github.com/mkoeppe/sage/actions/runs/35630769
----
New commits:


---

Comment by fbissey created at 2020-02-06 21:08:56

Are those the only options not supported by gcc-4.8.2? My first thought was testing only those flags, and not stuff like `sse4`.


---

Comment by mkoeppe created at 2020-02-06 21:17:27

I only took care of the `-mavx512*` flags because I knew that gcc-4.8.4 (as on Ubuntu trusty) does not have them. I threw in -mfma, -mfma4 because I was not familiar with them (though 4.8.4 supports them). All other flags are ancient and they are supported by 4.8.4.


---

Comment by fbissey created at 2020-02-06 21:21:29

Looks good to me then, but I cannot review the commits from the dependencies. If they are OK, I agree with the stuff that specifically is here.


---

Comment by git created at 2020-02-06 21:48:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-07 03:51:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-08 03:52:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-08 04:05:23

This now actually works and fixes installation on `ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/432608426?check_suite_focus=true).

But with this fix there's an error on `debian-jessie-standard` https://github.com/mkoeppe/sage/runs/432608838?check_suite_focus=true
Here the compiler supports only one of the avx512 flags.


---

Comment by dimpase created at 2020-02-08 09:20:37

I'd just drop jessie, it's too much hassle to go to for something with EOL in 5 months
https://wiki.debian.org/LTS/Jessie


---

Comment by mkoeppe created at 2020-02-08 22:24:40

I don't think this is how we should think about it. Shouldn't we rather be increasing the minimum accepted gcc version, and install our own gcc if too old?


---

Comment by dimpase created at 2020-02-08 23:02:12

Well, it's possible, but newer gcc might not even get built with that old gcc.


---

Comment by git created at 2020-02-24 07:43:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-24 07:45:56

Now this is more robust and also works on `debian-jessie-standard`.

See https://github.com/mkoeppe/sage/actions/runs/44043380


---

Comment by git created at 2020-02-27 04:15:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-02 01:36:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2020-03-02 23:28:36

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-02 23:31:02

Thanks!


---

Comment by vbraun created at 2020-03-03 23:21:28

Resolution: fixed


---

Comment by vbraun created at 2020-03-07 21:18:21

This breaks linbox on fresh builds:

```
-----------------------------------------------
Default path = /var/lib/buildbot/slave/sage2_git/build/local /usr /usr/local 
checking whether to compile the drivers... no
-----------------------------------------------
checking for pkg-config... /var/lib/buildbot/slave/sage2_git/build/local/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for FFLAS_FFPACK... no
configure: error: Package requirements (fflas-ffpack >= 2.4.0) were not met:
Package fflas-ffpack was not found in the pkg-config search path.
Perhaps you should add the directory containing `fflas-ffpack.pc'
to the PKG_CONFIG_PATH environment variable
Package 'fflas-ffpack', required by 'world', not found
Consider adjusting the PKG_CONFIG_PATH environment variable if you
installed software in a non-standard prefix.
Alternatively, you may set the environment variables FFLAS_FFPACK_CFLAGS
and FFLAS_FFPACK_LIBS to avoid the need to call pkg-config.
See the pkg-config man page for more details.
********************************************************************************
```



---

Comment by vbraun created at 2020-03-07 21:18:21

Changing status from closed to new.


---

Comment by vbraun created at 2020-03-07 21:18:21

Resolution changed from fixed to 


---

Comment by mkoeppe created at 2020-03-07 21:19:57

On what system?


---

Comment by mkoeppe created at 2020-03-07 21:22:32

Full log please


---

Comment by mkoeppe created at 2020-03-09 01:10:29

Tests at https://github.com/mkoeppe/sage/actions/runs/51973394
----
New commits:


---

Comment by mkoeppe created at 2020-03-09 15:42:03

OK, I can reproduce the build error on `centos-8-standard`(https://github.com/mkoeppe/sage/runs/494058924, https://github.com/mkoeppe/sage/suites/507443973/artifacts/2680774)


---

Comment by git created at 2020-03-09 19:18:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-09 19:19:29

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-12 00:34:10

`@`vbraun Let's get this into the next beta please


---

Comment by git created at 2020-03-15 23:55:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-15 23:56:33

Merged #29305 to resolve a potential merge conflict


---

Comment by git created at 2020-03-19 00:05:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-19 00:06:34

Rebased/squashed on 9.1.beta8, needs review


---

Comment by mkoeppe created at 2020-03-21 13:10:35

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-03-21 13:10:35

Anyone interested in completing the review of this ticket? As noted many times in sage-release, most recently in https://groups.google.com/d/msg/sage-release/eMQIlhglN98/bTwDGD9HBQAJ, this problem prevents Sage from build on major platforms: ubuntu-trusty-minimal/standard, debian-jessie-standard, centos-7-minimal/standard.


---

Comment by mkoeppe created at 2020-03-21 13:25:59

Tests run at https://github.com/mkoeppe/sage/actions/runs/60291174


---

Comment by mkoeppe created at 2020-03-22 02:19:02

The tests are done. Needs review.


---

Comment by dimpase created at 2020-03-22 02:25:51

All tests fail. E.g. Debian tests fail due to `cannot find -larb` thing - perhaps this should be rebased on top of the corresponding ticket? 

Fedora builds fail due to the inability to build numpy, probably related to *blas.pc issue.


---

Comment by mkoeppe created at 2020-03-22 03:09:28

Yes, they fail - because of unrelated issues. What is important is that the fflas_ffpack failures are gone!


---

Comment by mkoeppe created at 2020-03-22 03:12:31

For example, if you look at `ubuntu-trusty-minimal`, which had an fflas_ffpack failure, this now builds Sage correctly (https://github.com/mkoeppe/sage/runs/524022952) and runs its test suite:

```
sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t src/sage/plot/plot.py  # Timed out
sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
```



---

Comment by dimpase created at 2020-03-22 06:27:10

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-22 09:39:58

Thank you!


---

Comment by vbraun created at 2020-03-25 22:48:53

Resolution: fixed
