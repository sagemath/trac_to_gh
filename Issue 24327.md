# Issue 24327: Primitive extension of lattices

archive/issues_024327.json:
```json
{
    "body": "Keywords: lattices\n\nLet L1,L2 two integer lattices and A_L1, A_L2 their discriminant groups.\nIf G1,G2 are subgroups of A_L1 and AL2 respectively and f:G1-->G2 an isomorphisme of group we could define the \"gluing\" L, a primitive extension of L1+L2-->L\n\nIssue created by migration from https://trac.sagemath.org/ticket/24564\n\n",
    "created_at": "2018-01-19T10:07:02Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Primitive extension of lattices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24327",
    "user": "pmenegat"
}
```
Keywords: lattices

Let L1,L2 two integer lattices and A_L1, A_L2 their discriminant groups.
If G1,G2 are subgroups of A_L1 and AL2 respectively and f:G1-->G2 an isomorphisme of group we could define the "gluing" L, a primitive extension of L1+L2-->L

Issue created by migration from https://trac.sagemath.org/ticket/24564





---

archive/issue_comments_340591.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to quadratic forms.",
    "created_at": "2018-01-19T10:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340591",
    "user": "sbrandhorst"
}
```

Changing component from PLEASE CHANGE to quadratic forms.



---

archive/issue_comments_340592.json:
```json
{
    "body": "Changing keywords from \"lattices\" to \"IntegralLattice\".",
    "created_at": "2018-01-19T10:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340592",
    "user": "sbrandhorst"
}
```

Changing keywords from "lattices" to "IntegralLattice".



---

archive/issue_comments_340593.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-09T22:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340593",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340594.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-16T18:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340594",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340595.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-16T18:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340595",
    "user": "pmenegat"
}
```

New commits:



---

archive/issue_comments_340596.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-16T18:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340596",
    "user": "pmenegat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340597.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T06:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340597",
    "user": "sbrandhorst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340598.json:
```json
{
    "body": "The mul function is a good idea. But please make it a separate ticket.\n\nWhat you define is an extension - but it is not primitive.\nFor this consider your first example\n\n```\n    sage: from sage.modules.free_quadratic_module_integer_symmetric import PrimitiveExtension\n    sage: L1 = IntegralLattice(matrix([[4]]))\n    sage: g1 = L1.discriminant_group().gens()[0]\n    sage: glue = [[2*g1]]\n    sage: PrimitiveExtension([L1],glue)\n    Lattice of degree 1 and rank 1 over Integer Ring\n    Basis matrix:\n    [1]\n    Inner product matrix:\n    [1]\n    ....\n```\n\nA single lattice does not have any primitive extensions.\n\nYour code breaks if the lattices have a given basis different from the standard one.\nIt is not enough to just consider the gram matrices.:\n\n```\nsage: from sage.modules.free_quadratic_module_integer_symmetric import PrimitiveExtension\nsage: A = IntegralLattice(matrix.identity(2),basis=[(2,2)])\nsage: g = A.discriminant_group().gens()\nsage: PrimitiveExtension([A,A],[g,g])\n.....\nTypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 1 dense matrices over Integer Ring' and 'Free module of degree 2 and rank 1 over Integer Ring\nEchelon basis matrix:\n[1/4 1/4]'\n```\n\n\n- I would suggest to enhance the `.direct_sum` method to eat a list of lattices (or a single lattice) - best make it a separate ticket.\n- For me a primitive extension is defined as follows:\n\nLet `L1`, `L2` be two lattices. Then a primitive extension is an overlattice `L`\n`L1 + L2 -- > L` such that `L1 * QQ` intersected with `L` is L1 and likewise for `L2`.\nThen Nikulin proved:\nA primitive extension is the same as giving a homomorphism\n`phi: AL1 -- > AL2` on the discriminant groups reversing the sign of the discriminant form:\n`q(x) = -q(phi(x))`.\n\nThen my suggestion is to define a method. \n\n\n```\ndef primitive_extension(self, L2, phi):\n\n   1. check that phi is a homomorphism reversing the sign\n   2. take the direct sum of L1 and L2\n   3. take the graph Gamma of phi inside A_L1 + A_L2\n   4. return (L1.direct_sum(L2)).overlattice(Gamma)\n```\n\nAnd maybe the morphisms defining the embeddings.",
    "created_at": "2018-02-19T06:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340598",
    "user": "sbrandhorst"
}
```

The mul function is a good idea. But please make it a separate ticket.

What you define is an extension - but it is not primitive.
For this consider your first example

```
    sage: from sage.modules.free_quadratic_module_integer_symmetric import PrimitiveExtension
    sage: L1 = IntegralLattice(matrix([[4]]))
    sage: g1 = L1.discriminant_group().gens()[0]
    sage: glue = [[2*g1]]
    sage: PrimitiveExtension([L1],glue)
    Lattice of degree 1 and rank 1 over Integer Ring
    Basis matrix:
    [1]
    Inner product matrix:
    [1]
    ....
```

A single lattice does not have any primitive extensions.

Your code breaks if the lattices have a given basis different from the standard one.
It is not enough to just consider the gram matrices.:

```
sage: from sage.modules.free_quadratic_module_integer_symmetric import PrimitiveExtension
sage: A = IntegralLattice(matrix.identity(2),basis=[(2,2)])
sage: g = A.discriminant_group().gens()
sage: PrimitiveExtension([A,A],[g,g])
.....
TypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 1 dense matrices over Integer Ring' and 'Free module of degree 2 and rank 1 over Integer Ring
Echelon basis matrix:
[1/4 1/4]'
```


- I would suggest to enhance the `.direct_sum` method to eat a list of lattices (or a single lattice) - best make it a separate ticket.
- For me a primitive extension is defined as follows:

Let `L1`, `L2` be two lattices. Then a primitive extension is an overlattice `L`
`L1 + L2 -- > L` such that `L1 * QQ` intersected with `L` is L1 and likewise for `L2`.
Then Nikulin proved:
A primitive extension is the same as giving a homomorphism
`phi: AL1 -- > AL2` on the discriminant groups reversing the sign of the discriminant form:
`q(x) = -q(phi(x))`.

Then my suggestion is to define a method. 


```
def primitive_extension(self, L2, phi):

   1. check that phi is a homomorphism reversing the sign
   2. take the direct sum of L1 and L2
   3. take the graph Gamma of phi inside A_L1 + A_L2
   4. return (L1.direct_sum(L2)).overlattice(Gamma)
```

And maybe the morphisms defining the embeddings.



---

archive/issue_comments_340599.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-22T13:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340599",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340600.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-23T09:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340600",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340601.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-23T10:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340601",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-23T11:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340602",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340603.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-23T15:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340603",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340604.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-02T14:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340604",
    "user": "pmenegat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340605.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-03T10:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340605",
    "user": "sbrandhorst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340606.json:
```json
{
    "body": "I think that the ambient spaces should be preserved. If the user has given the lattice a specific basis/ambient space, she probably had a good reason and wants to keep it. \nAs a general rule: We should not forget any information - unless the user explicitly requests it.\n\nHence, the overlattice (=glued lattice) should live in the direct sum of the respective ambient spaces. \nI do like that you provide the embeddings. That is a good feature.\nAs a suggestion: \n- Improve the `direct_sum` method to take a list of lattices as input and output the inclusions as well.\n- In a second step use `overlattice` to create the glueing.\n- Please add input checks.",
    "created_at": "2018-03-03T10:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340606",
    "user": "sbrandhorst"
}
```

I think that the ambient spaces should be preserved. If the user has given the lattice a specific basis/ambient space, she probably had a good reason and wants to keep it. 
As a general rule: We should not forget any information - unless the user explicitly requests it.

Hence, the overlattice (=glued lattice) should live in the direct sum of the respective ambient spaces. 
I do like that you provide the embeddings. That is a good feature.
As a suggestion: 
- Improve the `direct_sum` method to take a list of lattices as input and output the inclusions as well.
- In a second step use `overlattice` to create the glueing.
- Please add input checks.



---

archive/issue_comments_340607.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-29T08:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340607",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340608.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-29T09:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340608",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340609.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-29T11:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340609",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340610.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-29T13:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340610",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340611.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-29T13:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340611",
    "user": "pmenegat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340612.json:
```json
{
    "body": "you can give it a positive review if you are happy with my changes.\n----\nNew commits:",
    "created_at": "2018-04-03T19:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340612",
    "user": "sbrandhorst"
}
```

you can give it a positive review if you are happy with my changes.
----
New commits:



---

archive/issue_comments_340613.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-17T08:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340613",
    "user": "pmenegat"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340614.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-08T17:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24327",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24327#issuecomment-340614",
    "user": "vbraun"
}
```

Resolution: fixed
