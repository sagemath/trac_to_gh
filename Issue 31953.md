# Issue 31953: Add hash to class functions

archive/issues_031953.json:
```json
{
    "body": "CC:  @tscrim @trevorkarn\n\nKeywords: gsoc2021 class-function hash\n\nIt is still a to-do item to put ``ClassFunction``s into the category framework. In the mean time we implement a hash function to ``ClassFunction_gap`` and ``ClassFunction_libgap``\n\nIssue created by migration from https://trac.sagemath.org/ticket/32190\n\n",
    "created_at": "2021-07-12T19:02:00Z",
    "labels": [
        "algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Add hash to class functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31953",
    "user": "@trevorkarn"
}
```
CC:  @tscrim @trevorkarn

Keywords: gsoc2021 class-function hash

It is still a to-do item to put ``ClassFunction``s into the category framework. In the mean time we implement a hash function to ``ClassFunction_gap`` and ``ClassFunction_libgap``

Issue created by migration from https://trac.sagemath.org/ticket/32190





---

archive/issue_comments_456565.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-12T19:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456565",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456566.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-12T19:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456566",
    "user": "@trevorkarn"
}
```

New commits:



---

archive/issue_comments_456567.json:
```json
{
    "body": "Set assignee to @trevorkarn.",
    "created_at": "2021-07-12T19:19:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456567",
    "user": "@trevorkarn"
}
```

Set assignee to @trevorkarn.



---

archive/issue_comments_456568.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-12T21:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456568",
    "user": "@trevorkarn"
}
```

New commits:



---

archive/issue_comments_456569.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-12T21:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456569",
    "user": "@trevorkarn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_456570.json:
```json
{
    "body": "I don't see why making this a `CachedRepresentation` is needed to do that. All you would need is the equality comparison and a `__hash__`. Can you explain the reasoning in a bit more detail?",
    "created_at": "2021-07-12T22:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456570",
    "user": "@tscrim"
}
```

I don't see why making this a `CachedRepresentation` is needed to do that. All you would need is the equality comparison and a `__hash__`. Can you explain the reasoning in a bit more detail?



---

archive/issue_comments_456571.json:
```json
{
    "body": "My main reasoning was that I wanted to pass an instance of `ClassFunction` as an argument of `FiniteDimensionalTwistedInvariantModule.__init__` of #32145 and when doing doctesting I was getting errors which seemed to be because of cacheing (`FiniteDimensionalTwistedInvariantModule` inherits from `UniqueRepresentation` via `SubmoduleWithBasis`). It did work to fix it with a hash (c.f. commit \u200b0cdd853 on branch u/tkarn/class_function_hash-32190) but I didn't see anywhere else in source code that directly implemented a `__hash__` and so I thought `CachedRepresentation` seemed like the right way to do it following the general Sage conventions.",
    "created_at": "2021-07-13T16:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456571",
    "user": "@trevorkarn"
}
```

My main reasoning was that I wanted to pass an instance of `ClassFunction` as an argument of `FiniteDimensionalTwistedInvariantModule.__init__` of #32145 and when doing doctesting I was getting errors which seemed to be because of cacheing (`FiniteDimensionalTwistedInvariantModule` inherits from `UniqueRepresentation` via `SubmoduleWithBasis`). It did work to fix it with a hash (c.f. commit â€‹0cdd853 on branch u/tkarn/class_function_hash-32190) but I didn't see anywhere else in source code that directly implemented a `__hash__` and so I thought `CachedRepresentation` seemed like the right way to do it following the general Sage conventions.



---

archive/issue_comments_456572.json:
```json
{
    "body": "Thanks for your frank reply. See [documentation](https://doc.sagemath.org/html/en/reference/structure/sage/structure/unique_representation.html#sage.structure.unique_representation.CachedRepresentation). The classes `CachedRepresentation` and `UniqueRepresentation` are to establish nonlocal objects. They introduce extra overhead, with possible savings when objects get created with equivalent construction parameters repeatedly, but they do that at the cost of modified semantics (you should really not change anything on these objects, because your changes may affect unrelated code). Oddly enough, `CachedRepresentation` does *not* define equality or hashing behaviour, so it shouldn't even do what you're using it for.",
    "created_at": "2021-07-13T16:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456572",
    "user": "@nbruin"
}
```

Thanks for your frank reply. See [documentation](https://doc.sagemath.org/html/en/reference/structure/sage/structure/unique_representation.html#sage.structure.unique_representation.CachedRepresentation). The classes `CachedRepresentation` and `UniqueRepresentation` are to establish nonlocal objects. They introduce extra overhead, with possible savings when objects get created with equivalent construction parameters repeatedly, but they do that at the cost of modified semantics (you should really not change anything on these objects, because your changes may affect unrelated code). Oddly enough, `CachedRepresentation` does *not* define equality or hashing behaviour, so it shouldn't even do what you're using it for.



---

archive/issue_comments_456573.json:
```json
{
    "body": "Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?",
    "created_at": "2021-07-13T18:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456573",
    "user": "@trevorkarn"
}
```

Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?



---

archive/issue_comments_456574.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-13T19:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456574",
    "user": "@trevorkarn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_456575.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-13T19:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456575",
    "user": "@trevorkarn"
}
```

New commits:



---

archive/issue_comments_456576.json:
```json
{
    "body": "Replying to [comment:8 tkarn]:\n> Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?\n\nThat's just a python thing: hashable objects must be comparable for equality, and items that compare equal should have identical hashes. Without that, dictionary lookup and sets don't work properly (and hashable objects must play nice with sets and dictionaries -- that's what hashing is for). Because hash and equality need to be coordinated, it's normally not even possible in python to inherit one but not the other.\n\n(sage actually violates the python hash contract, because `1 == GF(5)(1) == 6`. This causes trouble, but it is required to have `==` work properly with coercion, which was felt important for a CAS)",
    "created_at": "2021-07-13T20:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456576",
    "user": "@nbruin"
}
```

Replying to [comment:8 tkarn]:
> Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?

That's just a python thing: hashable objects must be comparable for equality, and items that compare equal should have identical hashes. Without that, dictionary lookup and sets don't work properly (and hashable objects must play nice with sets and dictionaries -- that's what hashing is for). Because hash and equality need to be coordinated, it's normally not even possible in python to inherit one but not the other.

(sage actually violates the python hash contract, because `1 == GF(5)(1) == 6`. This causes trouble, but it is required to have `==` work properly with coercion, which was felt important for a CAS)



---

archive/issue_comments_456577.json:
```json
{
    "body": "That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error \n\n\n```div style=\"font-size: 80%\"\n  {{{\nTypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be \ncombined with @richcmp_method\n  }}}\n```\n\n\nDoes that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?",
    "created_at": "2021-07-13T22:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456577",
    "user": "@trevorkarn"
}
```

That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error 


```div style="font-size: 80%"
  {{{
TypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be 
combined with @richcmp_method
  }}}
```


Does that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?



---

archive/issue_comments_456578.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-13T22:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456578",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456579.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-13T22:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456579",
    "user": "@trevorkarn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_456580.json:
```json
{
    "body": "Replying to [comment:11 tkarn]:\n> That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error \n> \n> {{{\n> #!div style=\"font-size: 80%\"\n>   {{{\n> TypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be \n> combined with `@`richcmp_method\n>   }}}\n> }}}\n> \n> Does that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?\n\nYes, that's correct. The `_richcmp_` covers all comparison operators, in particular `==`.\n\nI would propose a slightly different hash function:\n\n```python\ndef __hash__(self):\n    return hash((self._group, self.values())\n```\n\nThese are the two things that are checked for equality, but you get distinct hashes for all of the class functions. Right now, all class functions have the same repr, so they all have the same hash (which is less than ideal).\n\nIt might also be good to put the `__hash__` method below the `__richcmp__` as typically the `__init__` is the first method.",
    "created_at": "2021-07-14T02:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456580",
    "user": "@tscrim"
}
```

Replying to [comment:11 tkarn]:
> That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error 
> 
> {{{
> #!div style="font-size: 80%"
>   {{{
> TypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be 
> combined with `@`richcmp_method
>   }}}
> }}}
> 
> Does that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?

Yes, that's correct. The `_richcmp_` covers all comparison operators, in particular `==`.

I would propose a slightly different hash function:

```python
def __hash__(self):
    return hash((self._group, self.values())
```

These are the two things that are checked for equality, but you get distinct hashes for all of the class functions. Right now, all class functions have the same repr, so they all have the same hash (which is less than ideal).

It might also be good to put the `__hash__` method below the `__richcmp__` as typically the `__init__` is the first method.



---

archive/issue_comments_456581.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-14T12:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456581",
    "user": "@trevorkarn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_456582.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-14T15:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456582",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456583.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-14T15:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456583",
    "user": "@trevorkarn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_456584.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-14T23:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456584",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456585.json:
```json
{
    "body": "LGTM. Thank you.",
    "created_at": "2021-07-14T23:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456585",
    "user": "@tscrim"
}
```

LGTM. Thank you.



---

archive/issue_comments_456586.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-14T23:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456586",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_456587.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-24T15:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31953#issuecomment-456587",
    "user": "@vbraun"
}
```

Resolution: fixed
