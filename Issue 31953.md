# Issue 31953: Add hash to class functions

Issue created by migration from https://trac.sagemath.org/ticket/32190

Original creator: tkarn

Original creation time: 2021-07-12 19:02:00

CC:  tscrim tkarn

Keywords: gsoc2021 class-function hash

It is still a to-do item to put ``ClassFunction``s into the category framework. In the mean time we implement a hash function to ``ClassFunction_gap`` and ``ClassFunction_libgap``


---

Comment by git created at 2021-07-12 19:09:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2021-07-12 19:19:58

New commits:


---

Comment by tkarn created at 2021-07-12 19:19:58

Set assignee to tkarn.


---

Comment by tkarn created at 2021-07-12 21:39:01

New commits:


---

Comment by tkarn created at 2021-07-12 21:39:01

Changing status from new to needs_review.


---

Comment by tscrim created at 2021-07-12 22:45:08

I don't see why making this a `CachedRepresentation` is needed to do that. All you would need is the equality comparison and a `__hash__`. Can you explain the reasoning in a bit more detail?


---

Comment by tkarn created at 2021-07-13 16:00:43

My main reasoning was that I wanted to pass an instance of `ClassFunction` as an argument of `FiniteDimensionalTwistedInvariantModule.__init__` of #32145 and when doing doctesting I was getting errors which seemed to be because of cacheing (`FiniteDimensionalTwistedInvariantModule` inherits from `UniqueRepresentation` via `SubmoduleWithBasis`). It did work to fix it with a hash (c.f. commit â€‹0cdd853 on branch u/tkarn/class_function_hash-32190) but I didn't see anywhere else in source code that directly implemented a `__hash__` and so I thought `CachedRepresentation` seemed like the right way to do it following the general Sage conventions.


---

Comment by nbruin created at 2021-07-13 16:53:00

Thanks for your frank reply. See [documentation](https://doc.sagemath.org/html/en/reference/structure/sage/structure/unique_representation.html#sage.structure.unique_representation.CachedRepresentation). The classes `CachedRepresentation` and `UniqueRepresentation` are to establish nonlocal objects. They introduce extra overhead, with possible savings when objects get created with equivalent construction parameters repeatedly, but they do that at the cost of modified semantics (you should really not change anything on these objects, because your changes may affect unrelated code). Oddly enough, `CachedRepresentation` does *not* define equality or hashing behaviour, so it shouldn't even do what you're using it for.


---

Comment by tkarn created at 2021-07-13 18:59:32

Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?


---

Comment by tkarn created at 2021-07-13 19:07:32

Changing status from needs_review to needs_work.


---

Comment by tkarn created at 2021-07-13 19:07:32

New commits:


---

Comment by nbruin created at 2021-07-13 20:48:30

Replying to [comment:8 tkarn]:
> Thank you for the explanation. That makes sense. I understand why hashing behavior is needed for my desired use-case, but could you explain why equality behavior would be needed?

That's just a python thing: hashable objects must be comparable for equality, and items that compare equal should have identical hashes. Without that, dictionary lookup and sets don't work properly (and hashable objects must play nice with sets and dictionaries -- that's what hashing is for). Because hash and equality need to be coordinated, it's normally not even possible in python to inherit one but not the other.

(sage actually violates the python hash contract, because `1 == GF(5)(1) == 6`. This causes trouble, but it is required to have `==` work properly with coercion, which was felt important for a CAS)


---

Comment by tkarn created at 2021-07-13 22:21:42

That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error 


```div style="font-size: 80%"
  {{{
TypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be 
combined with @richcmp_method
  }}}
```


Does that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?


---

Comment by git created at 2021-07-13 22:25:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2021-07-13 22:25:40

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-07-14 02:21:56

Replying to [comment:11 tkarn]:
> That makes sense thanks. `ClassFunction_gap` already has ``@`richcmp_method` so when I try to implement `__eq__`, I get the error 
> 
> {{{
> #!div style="font-size: 80%"
>   {{{
> TypeError: class <class 'sage.groups.class_function.ClassFunction_gap'> defines __eq__ which cannot be 
> combined with `@`richcmp_method
>   }}}
> }}}
> 
> Does that mean that I don't need to implement an `__eq__` and it suffices to implement just a hash?

Yes, that's correct. The `_richcmp_` covers all comparison operators, in particular `==`.

I would propose a slightly different hash function:

```python
def __hash__(self):
    return hash((self._group, self.values())
```

These are the two things that are checked for equality, but you get distinct hashes for all of the class functions. Right now, all class functions have the same repr, so they all have the same hash (which is less than ideal).

It might also be good to put the `__hash__` method below the `__richcmp__` as typically the `__init__` is the first method.


---

Comment by tkarn created at 2021-07-14 12:02:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-14 15:44:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tkarn created at 2021-07-14 15:45:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-07-14 23:14:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-14 23:16:58

LGTM. Thank you.


---

Comment by tscrim created at 2021-07-14 23:16:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-24 15:27:47

Resolution: fixed
