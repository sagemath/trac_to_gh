# Issue 27152: Why is there src/build/cythonized/build/cythonized/sage/libs/eclib/wrap.cpp

Issue created by migration from https://trac.sagemath.org/ticket/27389

Original creator: jdemeyer

Original creation time: 2019-03-01 08:58:07

Inside `$SAGE_ROOT`, I see a file like

```
src/build/cythonized/build/cythonized/sage/libs/eclib/wrap.cpp
```

which is surely not how it's supposed to be.

So either this is a bug upstream somewhere or we are doing something wrong.


---

Comment by jhpalmieri created at 2019-03-01 19:03:32

This seems to be recent: I don't see it in Sage 8.6.


---

Comment by jhpalmieri created at 2019-03-01 21:14:51

Is it a problem to have `src/build/cythonized/setup.py`, a copy of `src/setup.py`? That's been there for some time, I think.


---

Comment by jhpalmieri created at 2019-03-01 21:54:42

It looks to me like the `build/cythonized/build/cythonized` problem first arises in 8.7.beta2.


---

Comment by jhpalmieri created at 2019-03-02 01:03:48

Could the problem be #27041?


---

Comment by jhpalmieri created at 2019-03-02 07:08:56

No, it's #27040, and in particular, the directories are created when `cythonize` is run in `sage_build_cython.run`. The dependencies for the elements in `module_list` are wrong: before #27040, I see (among other things):

```
/path/to/SAGE_ROOT/local/include/python2.7/pythread.h
/path/to/SAGE_ROOT/src/sage/cpython/cython_metaclass.h
/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap.h
/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap_impl.h
/path/to/SAGE_ROOT/src/setup.py
```

while after #27040, I see

```
/path/to/SAGE_ROOT/local/include/python2.7/pythread.h
build/cythonized/sage/cpython/cython_metaclass.h
build/cythonized/sage/libs/ntl/ntlwrap.h
build/cythonized/sage/libs/ntl/ntlwrap_impl.h
build/cythonized/setup.py
```

(I put a print statement in the `Cython.Build.Dependencies.cythonize` function: after `module_list, module_metadata = create_extension_list(...`, I added

```
    for m in module_list:
        for dep in m.depends:
            print(dep)
```

)
Does that clarify anything?


---

Comment by jdemeyer created at 2019-03-02 07:57:20

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2019-03-04 10:40:35

New commits:


---

Comment by jdemeyer created at 2019-03-04 10:40:35

Changing status from new to needs_review.


---

Comment by embray created at 2019-03-04 16:11:21

Just to be clear, this is only an oddity when building in source, right?  Does it actually _break_ anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?


---

Comment by jdemeyer created at 2019-03-04 16:18:06

Replying to [comment:13 embray]:
> Just to be clear, this is only an oddity when building in source, right?

What do you mean with "building in source"?

> Does it actually _break_ anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?

Yes, this is needed to fix dependency checking because the build directory `build/cythonize` is also in the list of include directories (see line 421 of `src/setup.py`). Certain auto-generated files end up in `build/cythonize`, so that's needed. Normal C/C++ source files like `sage/cpython/cython_metaclass.h` appear in the source directory `$SAGE_SRC`. They are also copied by Cython to `build/cythonized`. But the dependency should be on the file in `$SAGE_SRC` which means that this directory is needed in the list of include directories and it should come before `build/cythonized` in that list.


---

Comment by jhpalmieri created at 2019-03-04 21:27:20

With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems? Is there any reason to clean them up?


---

Comment by jdemeyer created at 2019-03-04 22:40:47

Replying to [comment:15 jhpalmieri]:
> With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems?

I don't think so.


---

Comment by jhpalmieri created at 2019-03-05 00:02:07

First: with this branch, the `build/cythonized/build/` directory is not created.

Second: without this branch (and is this what Erik was asking?), if I use `./configure --prefix=/path/to/somewhere/else`, then `build/cythonized/build` is still created in `SAGE_ROOT/src`.


---

Comment by jhpalmieri created at 2019-03-05 00:03:02

I'm ready to give this a positive review. I'll wait a day to see if there are any objections.


---

Comment by jdemeyer created at 2019-03-06 19:52:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-07 19:27:00

Resolution: fixed
