# Issue 33216: statistics

Issue created by migration from https://trac.sagemath.org/ticket/33453

Original creator: vdelecroix

Original creation time: 2022-03-03 07:15:23

CC:  mkoeppe

We implement a sage compatible version of the [statistics module](https://docs.python.org/3/library/statistics.html) in `stats/statistics.py`. In particular, it will provide the `mean` and `median` functions that were recently deprecated for removal in #29662. See also #33432.


---

Comment by vdelecroix created at 2022-03-03 08:49:02

New commits:


---

Comment by git created at 2022-03-03 08:49:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-03 09:41:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2022-03-03 09:49:26

Changing status from new to needs_review.


---

Comment by kcrisman created at 2022-03-03 12:29:26

Thank you, this looks like a great addition which should take care of the necessary problems but continue providing what is needed.  I didn't see any obvious problems in the code but it would be good to get a second more detailed eye.


---

Comment by mkoeppe created at 2022-03-03 19:22:51

Your new function `mean` is not compatible with the built-in `statistics.mean` - that specifies "If data is empty, `StatisticsError` will be raised." https://docs.python.org/3/library/statistics.html#statistics.mean

(Also, the argument is called `data`, not `v`.)


---

Comment by mkoeppe created at 2022-03-03 19:23:59

Also, please include cross-references to the ``numpy`` functions in the documentation so that this information is not lost.


---

Comment by mkoeppe created at 2022-03-03 19:24:54

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2022-03-03 20:11:31

Replying to [comment:7 mkoeppe]:
> Your new function `mean` is not compatible with the built-in `statistics.mean` - that specifies "If data is empty, `StatisticsError` will be raised." https://docs.python.org/3/library/statistics.html#statistics.mean

True. I did that on purpose to follow the numpy behaviour. The current code that I wrote only emits a `RuntimeWarning`.

> (Also, the argument is called `data`, not `v`.)

Is the argument name really relevant? Though `data` is definitely much better.


---

Comment by mkoeppe created at 2022-03-03 20:13:24

Replying to [comment:10 vdelecroix]:
> Replying to [comment:7 mkoeppe]:
> > Your new function `mean` is not compatible with the built-in `statistics.mean` - that specifies "If data is empty, `StatisticsError` will be raised." https://docs.python.org/3/library/statistics.html#statistics.mean
> 
> True. I did that on purpose to follow the numpy behaviour. The current code that I wrote only emits a `RuntimeWarning`.

That makes no sense - the point of the module is to be compatible not with numpy but with the built-in statistics module.


---

Comment by mkoeppe created at 2022-03-03 20:14:47

Replying to [comment:10 vdelecroix]:
> > (Also, the argument is called `data`, not `v`.)
> 
> Is the argument name really relevant? Though `data` is definitely much better.

Yes, because the signature is `mean(data)`, not `mean(data, /)`, users are allowed to call it as `mean(data=...)`.


---

Comment by vdelecroix created at 2022-03-03 20:38:31

Note thate Python argument naming is awful
- `statistics.variance(data, xbar=None)`
- `statistics.pvariance(data, mu=None)`


---

Comment by mkoeppe created at 2022-03-03 20:43:04

Compatibility > beauty


---

Comment by vdelecroix created at 2022-03-03 20:46:35

Replying to [comment:14 mkoeppe]:
> Compatibility > beauty

This is not about beauty but coherence. However this is a very minor point. It is perfectly fine to keep as much as the Python world as we can.


---

Comment by vdelecroix created at 2022-03-03 20:51:32

More importantly
- if the user provides a numpy array then the appropriate numpy method is called. This is not the Python behaviour. Should I remove it?
- If `data` only contains builtin Python data (`int`, `float`, `Fraction`, `Decimal`, ...) should the code simply transfer to the Python `statistics` module? Usually, sage functions tend to use `py_scalar_to_element` which does convert `int -> Integer`, `float -> RealNumber`, etc


---

Comment by mkoeppe created at 2022-03-03 20:56:46

The distinction of `xbar` and `mu` is deliberate, see discussion in https://bugs.python.org/issue20389


---

Comment by mkoeppe created at 2022-03-03 21:00:22

Replying to [comment:16 vdelecroix]:
> More importantly
> - if the user provides a numpy array then the appropriate numpy method is called. This is not the Python behaviour. Should I remove it?

Computing it via the numpy method I think is a good idea; but the result type / error handling must be compatible with the other types.

> - If `data` only contains builtin Python data (`int`, `float`, `Fraction`, `Decimal`, ...) should the code simply transfer to the Python `statistics` module? Usually, sage functions tend to use `py_scalar_to_element` which does convert `int -> Integer`, `float -> RealNumber`, etc

I think it would make sense to always make the result a Sage type, via `py_scalar_to_element` if necessary


---

Comment by git created at 2022-03-04 17:58:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2022-03-04 17:59:04

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2022-03-04 17:59:22

Replying to [comment:8 mkoeppe]:
> Also, please include cross-references to the ``numpy`` functions in the documentation so that this information is not lost.

Not sure about what you meant here.


---

Comment by mkoeppe created at 2022-03-04 19:01:08

Can't just replace `sage.stats.basic_stats.mean` by `lazy_import('sage.stats.statistics', 'mean', deprecation=33453)`. They have a different specification.


---

Comment by mkoeppe created at 2022-03-04 19:01:34

Changing status from needs_review to needs_work.


---

Comment by DavidLowry created at 2022-03-04 19:51:32

I have a very minor observation. I think there are a few typos in `sage.stats.statistics` in the updated deprecation notices:


```diff
--- basic_stats.sage
+++ basic_stats.sage with small changes
@@ -76,7 +76,7 @@
 
         sage: std([1..6], bias=True)
         doctest:warning...
-        DeprecationWarning: sage.stats.basic_stats.std is deprecated; use sage.stats.statstics.stdev or sage.stats.statistics.pstdev instead
+        DeprecationWarning: sage.stats.basic_stats.std is deprecated; use sage.stats.statistics.stdev or sage.stats.statistics.pstdev instead
         See https://trac.sagemath.org/33453 for details.
         1/2*sqrt(35/3)
         sage: std([1..6], bias=False)
@@ -106,7 +106,7 @@
         sage: std(data)  # random
         0.29487771726609185
     """
-    deprecation(33453, 'sage.stats.basic_stats.std is deprecated; use sage.stats.statstics.stdev or sage.stats.statistics.pstdev instead')
+    deprecation(33453, 'sage.stats.basic_stats.std is deprecated; use sage.stats.statistics.stdev or sage.stats.statistics.pstdev instead')
 
     if hasattr(v, 'standard_deviation'):
         return v.standard_deviation(bias=bias)
```



---

Comment by git created at 2022-03-05 08:11:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-05 08:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2022-03-05 08:12:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-05 18:09:46

Replying to [comment:21 vdelecroix]:
> Replying to [comment:8 mkoeppe]:
> > Also, please include cross-references to the ``numpy`` functions in the documentation so that this information is not lost.
> 
> Not sure about what you meant here.


```
     We define the mean of the empty list to be the (symbolic) NaN,
     following the convention of MATLAB, Scipy, and R.
 
-    This function is deprecated.  Use ``numpy.mean`` or ``numpy.nanmean``
-    instead.
+    This function is deprecated.  Use ``sage.stats.statistics.mean`` instead. The
+    differences with this function are
+
+    - the code does not try to call ``v.mean()``
+    - raises an error on empty input
```


Stuff like this -- please don't remove cross-references to numpy.


---

Comment by mkoeppe created at 2022-03-05 18:17:09

In 

```
+    if is_numpy_type(type(data)):
+        import numpy
+        if isinstance(data, numpy.ndarray):
+            return data.mean()
```

I think the result should be coerced to a Sage number type (comment:18)


---

Comment by vdelecroix created at 2022-03-05 18:50:25

Replying to [comment:29 mkoeppe]:
> In 
> {{{
> +    if is_numpy_type(type(data)):
> +        import numpy
> +        if isinstance(data, numpy.ndarray):
> +            return data.mean()
> }}}
> I think the result should be coerced to a Sage number type (comment:18)

I don't like the conversion afterwards so much. The mean of a list of integers is a floating point in numpy.

```
sage: data = [1,2,7,-11,15,23]
sage: statistics.mean(data)
37/6
sage: import sage.stats.statistics as statistics
sage: import numpy
sage: statistics.mean(numpy.array(data))
6.166666666666667
```

Maybe I should just remove these numpy shortcuts and simply document how to use the proper numpy methods in the documentation only?


---

Comment by git created at 2022-03-05 18:50:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2022-03-07 04:57:10

Changing status from needs_review to needs_work.


---

Comment by roed created at 2022-03-07 04:57:10

There are pyflakes errors.  Once those are fixed, I'm happy to give this a positive review.


---

Comment by vdelecroix created at 2022-03-07 07:43:06

Replying to [comment:32 roed]:
> There are pyflakes errors.  Once those are fixed, I'm happy to give this a positive review.

Please don't. [This is the Trac macro *comment:30* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:30-macro) has to be sorted out first.

Also, I would like to mitigate the warnings in `basic_stats`. Currently, the only deprecated behaviour of `mean(v)` are when either
- it calls the underlying `v.mean()` method of the object
- ot when the input data `v` is empty.
In all other cases, we can suppress the deprecation. And similarly for all other functions in `basic_stats`.
