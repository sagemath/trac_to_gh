# Issue 17048: CIF(cos(3/2)) fails

archive/issues_017048.json:
```json
{
    "body": "CC:  tmonteil @videlec\n\n\n```\nsage: CIF(cos(3/2))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-31-4eae9038f0b3> in <module>()\n----> 1 CIF(cos(Integer(3)/Integer(2)))\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/complex_interval_field.pyc in __call__(self, x, im)\n    378 \n    379             try:\n--> 380                 return x._complex_mpfi_( self )\n    381             except AttributeError:\n    382                 pass\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._complex_mpfi_ (build/cythonized/sage/symbolic/expression.cpp:8043)()\n```\n\n\nSimilar things do work:\n\n```\nsage: RIF(cos(3/2))\n0.0707372016677030?\nsage: CC(cos(3/2))\n0.0707372016677029\nsage: CIF(cos(3))\n-0.98999249660044542?\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17285\n\n",
    "created_at": "2014-11-04T10:37:17Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "CIF(cos(3/2)) fails",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17048",
    "user": "https://github.com/jdemeyer"
}
```
CC:  tmonteil @videlec


```
sage: CIF(cos(3/2))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-31-4eae9038f0b3> in <module>()
----> 1 CIF(cos(Integer(3)/Integer(2)))

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/complex_interval_field.pyc in __call__(self, x, im)
    378 
    379             try:
--> 380                 return x._complex_mpfi_( self )
    381             except AttributeError:
    382                 pass

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._complex_mpfi_ (build/cythonized/sage/symbolic/expression.cpp:8043)()
```


Similar things do work:

```
sage: RIF(cos(3/2))
0.0707372016677030?
sage: CC(cos(3/2))
0.0707372016677029
sage: CIF(cos(3))
-0.98999249660044542?
```


Issue created by migration from https://trac.sagemath.org/ticket/17285





---

archive/issue_comments_226410.json:
```json
{
    "body": "Changing component from symbolics to basic arithmetic.",
    "created_at": "2014-11-04T11:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226410",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from symbolics to basic arithmetic.



---

archive/issue_comments_226411.json:
```json
{
    "body": "Are you working on this ?\n\nIs a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?",
    "created_at": "2014-11-04T13:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226411",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Are you working on this ?

Is a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?



---

archive/issue_comments_226412.json:
```json
{
    "body": "Replying to [comment:2 tmonteil]:\n> Are you working on this ?\nNo.\n\n> Is a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?\nI think it's acceptable to rely on `exp()` but instead, I would rather use the structure of the `exp()` method: completely reduce the computation to a computation in `RIF`.",
    "created_at": "2014-11-04T15:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226412",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:2 tmonteil]:
> Are you working on this ?
No.

> Is a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?
I think it's acceptable to rely on `exp()` but instead, I would rather use the structure of the `exp()` method: completely reduce the computation to a computation in `RIF`.



---

archive/issue_comments_226413.json:
```json
{
    "body": "For best accuracy, one should use `cos(a+bi) = cos(a)*cosh(b) + sin(a)*sinh(b)*i` and `sin(a+bi) = sin(a)*cosh(b) + cos(a)*sinh(b)*i` (if I got those formulas right). \n\nThere's a `mpfi_sin_cos` but it looks like there's no `mpfi_sinh_cosh` yet.",
    "created_at": "2014-11-04T16:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226413",
    "user": "https://github.com/fredrik-johansson"
}
```

For best accuracy, one should use `cos(a+bi) = cos(a)*cosh(b) + sin(a)*sinh(b)*i` and `sin(a+bi) = sin(a)*cosh(b) + cos(a)*sinh(b)*i` (if I got those formulas right). 

There's a `mpfi_sin_cos` but it looks like there's no `mpfi_sinh_cosh` yet.



---

archive/issue_comments_226414.json:
```json
{
    "body": "This is also responsible for\n\n```\nsage: a = RLF(cos(2/3))\nsage: b = CLF(QQbar(-2).sqrt())\nsage: a + b\n<repr(<sage.rings.real_lazy.LazyBinop at 0x7fb7ffc28680>) failed: TypeError: unable to simplify to a complex interval approximation>\n```\n",
    "created_at": "2015-04-02T09:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226414",
    "user": "https://github.com/videlec"
}
```

This is also responsible for

```
sage: a = RLF(cos(2/3))
sage: b = CLF(QQbar(-2).sqrt())
sage: a + b
<repr(<sage.rings.real_lazy.LazyBinop at 0x7fb7ffc28680>) failed: TypeError: unable to simplify to a complex interval approximation>
```




---

archive/issue_comments_226415.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-06T16:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226415",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_226416.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-06T16:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226416",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_226417.json:
```json
{
    "body": "This is not the fastest and safest way possible (the obtained interval is sometimes too large). But at least, the given implementation has the feature that trigonometric functions preserve real and imaginary axes...\n\nVincent",
    "created_at": "2015-04-06T16:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226417",
    "user": "https://github.com/videlec"
}
```

This is not the fastest and safest way possible (the obtained interval is sometimes too large). But at least, the given implementation has the feature that trigonometric functions preserve real and imaginary axes...

Vincent



---

archive/issue_comments_226418.json:
```json
{
    "body": "Note: the link to the ask question is dead!",
    "created_at": "2015-04-06T16:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226418",
    "user": "https://github.com/videlec"
}
```

Note: the link to the ask question is dead!



---

archive/issue_comments_226419.json:
```json
{
    "body": "I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?",
    "created_at": "2015-04-06T21:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226419",
    "user": "https://github.com/jdemeyer"
}
```

I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?



---

archive/issue_comments_226420.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?\n\nThe main reason is to avoid numerical noise (I want the cosine of a real number to be a real number). You have\n\n```\nsage: a = CIF(2,0)\nsage: I = CIF.gen()\nsage: ((I*a).exp() + (-I*a).exp()) / 2\n-0.4161468365471424? + 0.?e-16*I\n```\n\nIt should be fine to remove the imaginary branch, but then it would be less precise\n\n```\nsage: a = CIF(0,2)\nsage: b1 = CIF(0, a.imag().cosh())\nsage: b1.diameter()\n1.33393183261575e-16\nsage: b2 = ((I*a).exp() + (-I*a).exp()) / 2\nsage: b2.diameter()\n2.36079803558624e-16\n```\n\n\nVincent",
    "created_at": "2015-04-06T21:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226420",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 jdemeyer]:
> I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?

The main reason is to avoid numerical noise (I want the cosine of a real number to be a real number). You have

```
sage: a = CIF(2,0)
sage: I = CIF.gen()
sage: ((I*a).exp() + (-I*a).exp()) / 2
-0.4161468365471424? + 0.?e-16*I
```

It should be fine to remove the imaginary branch, but then it would be less precise

```
sage: a = CIF(0,2)
sage: b1 = CIF(0, a.imag().cosh())
sage: b1.diameter()
1.33393183261575e-16
sage: b2 = ((I*a).exp() + (-I*a).exp()) / 2
sage: b2.diameter()
2.36079803558624e-16
```


Vincent



---

archive/issue_comments_226421.json:
```json
{
    "body": "For the sine and cosine, you can use the formula at the end of [http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers](http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers) which computes the real and imaginary part separately. Assuming that sinh(0) = 0 exactly, this formula will not introduce a fake imaginary part.",
    "created_at": "2015-04-07T06:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226421",
    "user": "https://github.com/jdemeyer"
}
```

For the sine and cosine, you can use the formula at the end of [http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers](http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers) which computes the real and imaginary part separately. Assuming that sinh(0) = 0 exactly, this formula will not introduce a fake imaginary part.



---

archive/issue_comments_226422.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-07T06:23:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226422",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_226423.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-07T07:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226423",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_226424.json:
```json
{
    "body": "New implementation using other trigonometric identities (and much faster).\n\nFor `tan` and `tanh` this is certainly not the best possible.\n\nVincent",
    "created_at": "2015-04-07T07:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226424",
    "user": "https://github.com/videlec"
}
```

New implementation using other trigonometric identities (and much faster).

For `tan` and `tanh` this is certainly not the best possible.

Vincent



---

archive/issue_comments_226425.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-07T07:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226425",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_226426.json:
```json
{
    "body": "You're not actually supposed to do this:\n\n```\nfrom sage.ext.interrupt cimport sig_on, sig_off\n```\n\nThe official way is still `include \"sage/ext/interrupt.pxi\"` (and this will even become mandatory after #18027)",
    "created_at": "2015-04-07T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226426",
    "user": "https://github.com/jdemeyer"
}
```

You're not actually supposed to do this:

```
from sage.ext.interrupt cimport sig_on, sig_off
```

The official way is still `include "sage/ext/interrupt.pxi"` (and this will even become mandatory after #18027)



---

archive/issue_comments_226427.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-07T08:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226427",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_226428.json:
```json
{
    "body": "I like the new code. However, a few comments:\n- move the `# cos(x + yi) = ... ` comments inside the docstring as an `ALGORITHM:` block.\n- move the `mpfi_init2()` and `mpfi_clear()` outside the `sig_on()`/`sig_off()` (it's not really wrong to put them inside, but it's certainly safer outside)",
    "created_at": "2015-04-07T08:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226428",
    "user": "https://github.com/jdemeyer"
}
```

I like the new code. However, a few comments:
- move the `# cos(x + yi) = ... ` comments inside the docstring as an `ALGORITHM:` block.
- move the `mpfi_init2()` and `mpfi_clear()` outside the `sig_on()`/`sig_off()` (it's not really wrong to put them inside, but it's certainly safer outside)



---

archive/issue_comments_226429.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-07T09:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226429",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_226430.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-07T09:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226430",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_226431.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-07T10:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226431",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_226432.json:
```json
{
    "body": "Thanks for the review.\n\nJust one related question. With the current code, if a `KeyboardInterrupt` happens in between the `sig_on/sig_off` block, then the code `mpfi_clear(tmp)` will never get called and hence the memory allocated to `tmp` will not be freed. Is there a clean solution for that?",
    "created_at": "2015-04-07T10:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226432",
    "user": "https://github.com/videlec"
}
```

Thanks for the review.

Just one related question. With the current code, if a `KeyboardInterrupt` happens in between the `sig_on/sig_off` block, then the code `mpfi_clear(tmp)` will never get called and hence the memory allocated to `tmp` will not be freed. Is there a clean solution for that?



---

archive/issue_comments_226433.json:
```json
{
    "body": "Replying to [comment:19 vdelecroix]:\n> Is there a clean solution for that?\n`try:`/`finally:`.",
    "created_at": "2015-04-07T11:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226433",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:19 vdelecroix]:
> Is there a clean solution for that?
`try:`/`finally:`.



---

archive/issue_comments_226434.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17048",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17048#issuecomment-226434",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
