# Issue 17048: CIF(cos(3/2)) fails

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-11-04 10:37:17

CC:  tmonteil vdelecroix


```
sage: CIF(cos(3/2))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-31-4eae9038f0b3> in <module>()
----> 1 CIF(cos(Integer(3)/Integer(2)))

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/complex_interval_field.pyc in __call__(self, x, im)
    378 
    379             try:
--> 380                 return x._complex_mpfi_( self )
    381             except AttributeError:
    382                 pass

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression._complex_mpfi_ (build/cythonized/sage/symbolic/expression.cpp:8043)()
```


Similar things do work:

```
sage: RIF(cos(3/2))
0.0707372016677030?
sage: CC(cos(3/2))
0.0707372016677029
sage: CIF(cos(3))
-0.98999249660044542?
```



---

Comment by jdemeyer created at 2014-11-04 11:06:20

Changing component from symbolics to basic arithmetic.


---

Comment by tmonteil created at 2014-11-04 13:20:28

Are you working on this ?

Is a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?


---

Comment by jdemeyer created at 2014-11-04 15:59:18

Replying to [comment:2 tmonteil]:
> Are you working on this ?
No.

> Is a solution involving the use of the (already defined) `.exp()` method acceptable on the short term (it may not lead to the thinest possible intervals), or do you think about some more accurate way of writing those ?
I think it's acceptable to rely on `exp()` but instead, I would rather use the structure of the `exp()` method: completely reduce the computation to a computation in `RIF`.


---

Comment by fredrik.johansson created at 2014-11-04 16:18:19

For best accuracy, one should use `cos(a+bi) = cos(a)*cosh(b) + sin(a)*sinh(b)*i` and `sin(a+bi) = sin(a)*cosh(b) + cos(a)*sinh(b)*i` (if I got those formulas right). 

There's a `mpfi_sin_cos` but it looks like there's no `mpfi_sinh_cosh` yet.


---

Comment by vdelecroix created at 2015-04-02 09:25:20

This is also responsible for

```
sage: a = RLF(cos(2/3))
sage: b = CLF(QQbar(-2).sqrt())
sage: a + b
<repr(<sage.rings.real_lazy.LazyBinop at 0x7fb7ffc28680>) failed: TypeError: unable to simplify to a complex interval approximation>
```



---

Comment by vdelecroix created at 2015-04-06 16:15:50

New commits:


---

Comment by vdelecroix created at 2015-04-06 16:15:50

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-06 16:17:48

This is not the fastest and safest way possible (the obtained interval is sometimes too large). But at least, the given implementation has the feature that trigonometric functions preserve real and imaginary axes...

Vincent


---

Comment by vdelecroix created at 2015-04-06 16:18:17

Note: the link to the ask question is dead!


---

Comment by jdemeyer created at 2015-04-06 21:33:56

I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?


---

Comment by vdelecroix created at 2015-04-06 21:59:38

Replying to [comment:9 jdemeyer]:
> I don't like the added complexity of having 3 branches in every function. Why not just use the generic case everywhere?

The main reason is to avoid numerical noise (I want the cosine of a real number to be a real number). You have

```
sage: a = CIF(2,0)
sage: I = CIF.gen()
sage: ((I*a).exp() + (-I*a).exp()) / 2
-0.4161468365471424? + 0.?e-16*I
```

It should be fine to remove the imaginary branch, but then it would be less precise

```
sage: a = CIF(0,2)
sage: b1 = CIF(0, a.imag().cosh())
sage: b1.diameter()
1.33393183261575e-16
sage: b2 = ((I*a).exp() + (-I*a).exp()) / 2
sage: b2.diameter()
2.36079803558624e-16
```


Vincent


---

Comment by jdemeyer created at 2015-04-07 06:23:10

For the sine and cosine, you can use the formula at the end of [http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers](http://en.wikipedia.org/wiki/Trigonometric_functions#Relationship_to_exponential_function_and_complex_numbers) which computes the real and imaginary part separately. Assuming that sinh(0) = 0 exactly, this formula will not introduce a fake imaginary part.


---

Comment by jdemeyer created at 2015-04-07 06:23:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-07 07:47:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-07 07:48:59

New implementation using other trigonometric identities (and much faster).

For `tan` and `tanh` this is certainly not the best possible.

Vincent


---

Comment by vdelecroix created at 2015-04-07 07:48:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-07 08:05:48

You're not actually supposed to do this:

```
from sage.ext.interrupt cimport sig_on, sig_off
```

The official way is still `include "sage/ext/interrupt.pxi"` (and this will even become mandatory after #18027)


---

Comment by jdemeyer created at 2015-04-07 08:05:48

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-04-07 08:10:13

I like the new code. However, a few comments:
- move the `# cos(x + yi) = ... ` comments inside the docstring as an `ALGORITHM:` block.
- move the `mpfi_init2()` and `mpfi_clear()` outside the `sig_on()`/`sig_off()` (it's not really wrong to put them inside, but it's certainly safer outside)


---

Comment by git created at 2015-04-07 09:00:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-07 09:01:40

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-04-07 10:30:56

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-07 10:34:53

Thanks for the review.

Just one related question. With the current code, if a `KeyboardInterrupt` happens in between the `sig_on/sig_off` block, then the code `mpfi_clear(tmp)` will never get called and hence the memory allocated to `tmp` will not be freed. Is there a clean solution for that?


---

Comment by jdemeyer created at 2015-04-07 11:39:26

Replying to [comment:19 vdelecroix]:
> Is there a clean solution for that?
`try:`/`finally:`.


---

Comment by vbraun created at 2015-04-14 19:44:05

Resolution: fixed
