# Issue 16740: remove 32-bit limitations in eclib modular symbols interface

Issue created by migration from https://trac.sagemath.org/ticket/16977

Original creator: cremona

Original creation time: 2014-09-12 14:11:10

CC:  wuthrich pbruin

Keywords: eclib 32-bit

In sage/libs/cremona/newforms.pyx lines 66-70 there is a conversion from Sage integers to NTL ZZs, as used in eclib, which goes via Python ints.  This causes some problems on 32-bit machines, which few people still use but which causes doctest problems, in that file and also in sage/schemes/elliptic_curves/sha_tate where this interface is used.

See #16959 for some discussion on this.  It should not be hard to fix, as this conversion is already implemented in sage/libs/mwrank/mwrank.pyx, but will need testing on both 32- and 64-bit machines.



---

Comment by jdemeyer created at 2014-12-23 11:47:13

There are functions `ZZ_to_mpz` and `mpz_to_ZZ` defined in `src/c_lib/include/ntl_wrap.h`, you probably need those.


---

Comment by cremona created at 2014-12-23 11:49:52

Agreed.  I did try to do this a while back but couldn't get it to work.   I'm sure others will have more success.


---

Comment by jdemeyer created at 2014-12-23 11:56:22

John, what are the requirements for the `ECModularSymbol` class, do you require a minimal model?


---

Comment by jdemeyer created at 2014-12-23 12:01:25

A good doctest could be for example to check that `EllipticCurve([0,0,0,0,2^72])` (which fails on 32-bit and 64-bit) gives the same results as `EllipticCurve([0,0,0,0,1])`.


---

Comment by jdemeyer created at 2014-12-23 12:01:58

Changing component from interfaces to elliptic curves.


---

Comment by cremona created at 2014-12-23 12:07:17

Replying to [comment:4 jdemeyer]:
> John, what are the requirements for the `ECModularSymbol` class, do you require a minimal model?

I had to check the code in eclib for this, and the answer seems to be "yes".  The C++ test program for this functionality minimises the input curve.  If not minimal then it is likely that the incorrect Hecke eigenvalue for non-minimal primes will be used, with the result that the modular symbol eigenspace will not be found correctly.

My C++ code documentation has improved since I started contributng to Sage but is still not perfect!


---

Comment by jdemeyer created at 2014-12-23 12:10:49

Given your comment, I will add the line

```
E = E.minimal_model()
```


Can you come up with a good test case where at least one coefficient is larger than `2^63` in absolute value?


---

Comment by cremona created at 2014-12-23 12:15:34

Replying to [comment:8 jdemeyer]:
> Given your comment, I will add the line
> {{{
> E = E.minimal_model()
> }}}
> 
> Can you come up with a good test case where at least one coefficient is larger than `2^63` in absolute value?

Coefficient of what?


---

Comment by jdemeyer created at 2014-12-23 12:27:02

Coefficient = one of a1,a2,a3,a4,a6


---

Comment by jdemeyer created at 2014-12-23 14:05:34

New commits:


---

Comment by jdemeyer created at 2014-12-23 14:05:34

Changing status from new to needs_review.


---

Comment by cremona created at 2014-12-23 15:11:35

Replying to [comment:10 jdemeyer]:
> Coefficient = one of a1,a2,a3,a4,a6

sage: E = EllipticCurve('50568m1'); E.ainvs()
(0, -1, 0, -37998022884432, 90154970279923910796)
sage: RR(E.a6().abs()).log(2.0)
66.2890408330703


but the conductor is rather large for the modular symbol computation to be reasonable in a test.


---

Comment by pbruin created at 2014-12-23 19:31:30

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-12-23 19:31:30

There were also some doctests in `sha_tate.py` that needed to be updated.


---

Comment by jdemeyer created at 2014-12-23 19:41:21

Replying to [comment:14 cremona]:
> but the conductor is rather large for the modular symbol computation to be reasonable in a test.
Thanks, but I already checked your wonderful database and found `21758k3`, which is the smallest example where a coefficient is larger than `2^60` (the coefficient has 65 bits in fact).


---

Comment by cremona created at 2014-12-23 20:28:43

Replying to [comment:16 jdemeyer]:
> Replying to [comment:14 cremona]:
> > but the conductor is rather large for the modular symbol computation to be reasonable in a test.
> Thanks, but I already checked your wonderful database and found `21758k3`, which is the smallest example where a coefficient is larger than `2^60` (the coefficient has 65 bits in fact).

:) I know, my loop found that one first as well, but I went back since that curve is not "optimal" (last part of label > 1) and people normally only ask for the modular symbol map on optimal curves (though they are certainly allowed to ask for any curve and should get a reasonable answer...).  The first time I used "for E in cremona_curves()" and the I used "for E in cremona_optimal_curves()".


---

Comment by vbraun created at 2015-01-02 22:12:25

Resolution: fixed
