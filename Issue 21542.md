# Issue 21542: py3 get rid of cmp() in some cython files

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2016-10-28 18:24:12

CC:  jmantysalo tscrim aapitzsch jdemeyer

as a very tiny step in the huge cmp problem

done by using richcmp


---

Comment by chapoton created at 2016-10-28 18:24:55

New commits:


---

Comment by chapoton created at 2016-10-28 18:24:55

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-28 23:45:19

In *Cython* files, use *C* or *Cython* functions, don't `import richcmp`, just use `PyObject_RichCompare`.


---

Comment by jdemeyer created at 2016-10-28 23:45:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-28 23:47:41

Also, `raise NotImplemented` should be `return NotImplemented`.


---

Comment by git created at 2016-10-29 07:28:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-10-29 07:28:42

done, thanks


---

Comment by chapoton created at 2016-10-29 07:28:42

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-29 10:00:22

The code in `src/sage/modular/arithgroup/farey_symbol.pyx` is less efficient than before because it no longer "lazily" computes the `cusps()` and `fractions()` methods.


---

Comment by jdemeyer created at 2016-10-29 10:05:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-29 10:05:44

See also #21176#comment:6


---

Comment by git created at 2016-10-29 14:16:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-10-29 14:18:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-10-29 14:18:47

ok, I was expecting this answer...

I introduced an helper function, to be used in this kind of situation.


---

Comment by chapoton created at 2016-10-30 14:59:26

Patchbot is green. I am not sure to have done the helper function in a proper way. I had to use richcmp to make it work, but maybe you would know a way to use PyObject_RichCompare ?


---

Comment by jdemeyer created at 2016-11-01 09:45:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-11-01 09:45:12

1. `elif op in [Py_LT, Py_GT, Py_LE, Py_GE]:` should be optimized to `else`.

2. `richcmp_step` needs better documentation of what it does and how it should be used. Simply saying "assumed to be only a non-final step in a sequence of several comparison checks." is absolutely not clear enough.

3. Using `richcmp` is fine. The problem is _importing_ `richcmp` (introducing Python overhead), not calling it.

4. Replace `not(step is None)` by `step is not None`.

5. Replace `richcmp(x, y, Py_EQ)` by `x == y`. Similarly, inside the first `if` branches where you know what `op` is.

6. I still have to check whether your helper function is better/worse/equivalent to my proposal in #21176#comment:6


---

Comment by jdemeyer created at 2016-11-01 09:53:05

In terms of behaviour, the use of your helper function looks identical to my proposal in #21176#comment:6 (assuming that `x != y` is equivalent to `not x == y`).

But your code looks slightly less efficient (you always call `richcmp_step` and then check the result to `None` while I only call `richcmp_not_equal` when I know that the answer will be useful). Given that your code is not shorter nor more understandable, I don't see the advantage.

I don't feel very strongly about this about this, but it makes me wonder why you didn't just implement #21176#comment:6


---

Comment by jdemeyer created at 2016-11-01 09:57:29

7. I would prefer to use `NotImplemented` to signal "maybe" instead of `None`.

8. Code like

```
if richcmp(x, y, op):
    return True
else:
    return False
```

could be shorted to `return richcmp(x, y, op)`.


---

Comment by git created at 2016-11-01 10:39:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-01 10:46:51

Thanks for the review.

1: Done

2: I have added some documentation, tell me if this is enough.

3: so there is nothing to do, right ?

4: Done

5: Done in all possible places

6: I see several differences: ~~mine compares the (potentially complex) objects at most once except when absolutely needed (yours does this always twice), and has the correct behaviour for NE (not sure about yours for that)~~

*EDIT*: in fact, there is no real difference, maybe. I prefer the logic of mine, but let me think about that.

7: I would prefer to keep `None`, because `NotImplemented` has a different precise 
semantic. Of course the ideal would be `Maybe`, but there is no such constant, AFAIK

8: Done


---

Comment by git created at 2016-11-01 12:31:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-01 12:33:00

ok, after reflexion, I decided to use your proposal. This is slightly less intuitive to use, maybe.


---

Comment by chapoton created at 2016-11-01 12:33:00

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-11-01 13:54:45

FYI: There is an `Unknown` object in Sage.


---

Comment by jdemeyer created at 2016-11-01 14:36:30

Replying to [comment:16 chapoton]:
> 7: I would prefer to keep `None`, because `NotImplemented` has a different precise 
> semantic.

The object `NotImplemented` is used whenever a comparison function cannot decide what the result of the comparison is. That looks very much like what is needed here.


---

Comment by chapoton created at 2016-11-01 14:52:26

Anyway, `None` is not longer used here, no need to find a better replacement.


---

Comment by jdemeyer created at 2016-11-01 16:40:16

Right!


---

Comment by jdemeyer created at 2016-11-01 16:41:32

`cimport`, not `import`!

```
from sage.structure.sage_object import richcmp_not_equal
```



---

Comment by jdemeyer created at 2016-11-01 16:41:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-11-01 17:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-11-01 17:36:56

done so in the code. Should I change that in the examples too ?


---

Comment by jdemeyer created at 2016-11-01 19:20:06

The examples are in Python, so you cannot `cimport`.


---

Comment by jdemeyer created at 2016-11-01 21:49:41

Needs review?


---

Comment by chapoton created at 2016-11-02 07:06:05

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-11-02 07:06:05

yes, of course

note that I have not re-compiled to check that it works


---

Comment by jdemeyer created at 2016-11-02 07:41:23

Let's see what the patchbot says.

One detail: this is not entirely true:

```
OUTPUT: ``True`` or ``False``
```

since rich comparisons are not required to return `True` or `False`. I would be explicit and say something like:

```
OUTPUT: If ``op`` is not ``op_EQ`` or ``op_NE``, the result of ``richcmp(x, y, op)``. If ``op`` is ``op_EQ``, return ``False``. If ``op`` is ``op_NE``, return ``True``.
```



---

Comment by git created at 2016-11-02 12:39:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-11-02 13:56:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-11-02 21:04:21

Positive_review if this passes tests.


---

Comment by chapoton created at 2016-11-03 07:13:35

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-11-03 07:13:35

ok, bot is green. Thanks for the review.


---

Comment by vbraun created at 2016-11-08 23:42:11

Resolution: fixed


---

Comment by jdemeyer created at 2017-05-31 11:17:57

Replying to [comment:9 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[405a5ce](https://git.sagemath.org/sage.git/commit/?id=405a5ce07e4b08d17b80b975dd88cf27d3df21fa)||`trac 21779 introducing auxiliary function for sequential rich comparison`||

Follow-up: in #22087 I will introduce a function very similar to the `richcmp_step` which was introduced here (but reverted again).
