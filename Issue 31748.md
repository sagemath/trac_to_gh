# Issue 31748: WQSym.M().basis(3) is broken

Issue created by migration from https://trac.sagemath.org/ticket/31985

Original creator: @darijgr

Original creation time: 2021-06-15 17:56:40

CC:  tscrim darij lauve

Keywords: WQSym, combinatorial Hopf algebras, ordered set partitions

This should return a basis for the degree-3 component of WQSym (and yes, it is finite):

```
sage: WQSym = algebras.WQSym(QQ)
sage: M = WQSym.M()
sage: M.basis(3)
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
~/sage/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10303)()
   1942             try:
-> 1943                 return cache[k]
   1944             except TypeError:  # k is not hashable

KeyError: ((3,), ())

During handling of the above exception, another exception occurred:

KeyError                                  Traceback (most recent call last)
~/sage/local/lib/python3.6/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7074)()
    838         try:
--> 839             return self.__cached_methods[name]
    840         except KeyError:

KeyError: 'subset'

During handling of the above exception, another exception occurred:

AttributeError                            Traceback (most recent call last)
~/sage/local/lib/python3.6/site-packages/sage/categories/filtered_modules_with_basis.py in homogeneous_component_basis(self, d)
    214             try:
--> 215                 S = self._indices.subset(size=d)
    216             except (AttributeError, ValueError, TypeError):

~/sage/local/lib/python3.6/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.__getattr__ (build/cythonized/sage/structure/category_object.c:6993)()
    832         """
--> 833         return self.getattr_from_category(name)
    834

~/sage/local/lib/python3.6/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7159)()
    847
--> 848             attr = getattr_from_other_class(self, cls, name)
    849             self.__cached_methods[name] = attr

~/sage/local/lib/python3.6/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2551)()
    366         dummy_error_message.name = name
--> 367         raise AttributeError(dummy_error_message)
    368     cdef PyObject* attr = instance_getattr(cls, name)

AttributeError: 'OrderedSetPartitions_all_with_category' object has no attribute 'subset'

During handling of the above exception, another exception occurred:

NotImplementedError                       Traceback (most recent call last)
<ipython-input-5-446eb4b46bf3> in <module>
----> 1 M.basis(Integer(3))

~/sage/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10437)()
   1946                 return cache[k]
   1947         except KeyError:
-> 1948             w = self._instance_call(*args, **kwds)
   1949             cache[k] = w
   1950             return w

~/sage/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9916)()
   1822             True
   1823         """
-> 1824         return self.f(self._instance, *args, **kwds)
   1825
   1826     cdef fix_args_kwds(self, tuple args, dict kwds):

~/sage/local/lib/python3.6/site-packages/sage/categories/filtered_modules_with_basis.py in basis(self, d)
    186                 return Family(self._indices, self.monomial)
    187             else:
--> 188                 return self.homogeneous_component_basis(d)
    189
    190         # TODO: Change `list(self._indices)` to `self._indices` and move

~/sage/local/lib/python3.6/site-packages/sage/categories/filtered_modules_with_basis.py in homogeneous_component_basis(self, d)
    215                 S = self._indices.subset(size=d)
    216             except (AttributeError, ValueError, TypeError):
--> 217                 S = [i for i in list(self._indices) if self.degree_on_basis(i) == d]
    218             return Family(S, self.monomial)
    219

~/sage/local/lib/python3.6/site-packages/sage/categories/enumerated_sets.py in __len__(self)
    477                 c = self.cardinality()
    478                 if c is Infinity:
--> 479                     raise NotImplementedError('infinite set')
    480                 return int(c)
    481             except AttributeError:

NotImplementedError: infinite set
```


Same problem with other bases.


---

Comment by @darijgr created at 2021-06-15 18:45:19

Changing status from new to needs_review.


---

Comment by @darijgr created at 2021-06-15 18:46:25

New commits:


---

Comment by chapoton created at 2021-06-15 18:56:07

Returns should be Return


---

Comment by git created at 2021-06-15 18:58:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-06-16 05:13:15

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-06-16 05:13:15

LGTM. Thanks. There might be others CHAs that need a similar treatment as a warning.

Frédéric, I added you as a reviewer for comment:5.


---

Comment by @darijgr created at 2021-06-16 09:11:03

Thanks, both of you!


---

Comment by vbraun created at 2021-06-30 21:16:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-30 21:16:17


```
sage -t --long --warn-long 41.1 --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed
sage -t --long --warn-long 41.1 --random-seed=0 src/sage/categories/quotient_fields.py  # 2 doctests failed
```



---

Comment by @darijgr created at 2021-06-30 21:32:53

Changing status from needs_work to positive_review.


---

Comment by @darijgr created at 2021-06-30 21:32:53

I don't think these have anything to do with my branch.


```
skraeling@moria ~/sage
$ sage -t --long --warn-long 41.1 --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed
Running doctests with ID 2021-06-30-23-20-11-ecd9f2e8.
Git branch: ospsize
Using --optional=build,cygwin,dochtml,pip,rubiks,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 41.1 --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py
    [110 tests, 16.76 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 23.1 seconds
    cpu time: 4.2 seconds
    cumulative wall time: 16.8 seconds

skraeling@moria ~/sage
$ sage -t --long --warn-long 41.1 --random-seed=0 src/sage/categories/quotient_fields.py  # 2 doctests failed
Running doctests with ID 2021-06-30-23-30-34-35f1c6cc.
Git branch: ospsize
Using --optional=build,cygwin,dochtml,pip,rubiks,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 41.1 --random-seed=0 src/sage/categories/quotient_fields.py
    [158 tests, 7.91 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 8.7 seconds
    cpu time: 3.3 seconds
    cumulative wall time: 7.9 seconds
```



---

Comment by @darijgr created at 2021-06-30 21:35:41

While I don't have your logs, both of the files that are randomly failing involve approximate values in doctest results. I wouldn't be surprised if they need to be hardened for approximation errors.


---

Comment by vbraun created at 2021-07-04 22:45:34

Can you try on top of the latest beta?

```
sage -t --long --warn-long 43.2 --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py
**********************************************************************
File "src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py", line 260, in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest
Failed example:
    Frac(C['x'])(r).partial_fraction_decomposition()
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest[69]>", line 1, in <module>
        Frac(C['x'])(r).partial_fraction_decomposition()
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/categories/quotient_fields.py", line 540, in partial_fraction_decomposition
        for r in factor:
    NameError: name 'factor' is not defined
**********************************************************************
```



---

Comment by vbraun created at 2021-07-04 22:45:34

Changing status from positive_review to needs_work.


---

Comment by @darijgr created at 2021-07-04 22:54:08

Line 540 of quotient_fields.py says "for r in factors", not "for r in factor":

https://github.com/sagemath/sage/blob/develop/src/sage/categories/quotient_fields.py

Nothing about my branch changes this. Are you sure your setup isn't corrupted (e.g., by some broken E701/702 fix)?


---

Comment by @darijgr created at 2021-07-04 23:01:55

That, or your bot is either merging or testing the wrong branch.


---

Comment by @darijgr created at 2021-07-04 23:02:12

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-07-09 20:23:36

Resolution: fixed
