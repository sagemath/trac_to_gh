# Issue 18068: Element comparison for Python classes

Issue created by migration from https://trac.sagemath.org/ticket/18305

Original creator: vdelecroix

Original creation time: 2015-04-26 19:11:18

CC:  jdemeyer jpflori

In #17890 the comparisons of elements (i.e. through `__cmp__` and `__richcmp__`) has been simplified. In order for elements to take benefit of the coercion framekwork they should either implement `_cmp_(left,right)` and/or `_richcmp_(left,right,op)`.

In particular, it is discouraged to implement `__eq__` and `__ne__` if coercion has to be involved. It would also be simpler if no element implements `__cmp__`.

In this ticket:
 - make everything needed for rich comparisons available from Python (i.e. `Py_EQ`, `Py_NE`, etc as well as `rich_to_bool/rich_to_bool_sgn`)
 - we check the sage libraries for occurrences of `__eq__`/`__ne__`/`__cmp__` in elements and see whether these can be simplified
     - #18303 takes care of `sage.rings.qqbar`
 - update the documentation in `sage.structure.Element`


---

Comment by jdemeyer created at 2015-04-26 19:32:48

I think in general, rich comparisons (both Cython's `__richcmp__` and Python's `__eq__` and friends) should be discouraged in favour of `_cmp_`, because the latter needs coercion only once. Only for more complicated types where rich comparisons cannot be implemented in terms of `__cmp__` (intervals for example) should rich comparisons be used.

Do you agree?


---

Comment by vdelecroix created at 2015-04-26 19:45:44

Replying to [comment:1 jdemeyer]:
> I think in general, rich comparisons (both Cython's `__richcmp__` and Python's `__eq__` and friends) should be discouraged in favour of `_cmp_`, because the latter needs coercion only once. Only for more complicated types where rich comparisons cannot be implemented in terms of `__cmp__` (intervals for example) should rich comparisons be used.
> 
> Do you agree?

Partly. I agree that if `_cmp_` is doable *and* cheap then it is preferable. But
 - consider lists (or words or sequences), you have a cheap test to check whether they are different: comparing the length. So in that case, you might want to use it before comparing items one by one for getting the lexicographic ordering. 
 - there are elements where equality makes sense but not comparison. `_richcmp_` can handle that but not `_cmp_`. In such case I would implement `_richcmp_` and raise an error if the operator is not `Py_EQ` or `Py_NE`.

And I am not sure that I understand why `_cmp_` needs less coercion than `_richcmp_`.


---

Comment by vdelecroix created at 2015-04-28 12:20:26

Another example: embedded number fields in `RR`. If you want that rich comparisons coincide with the order on `RR` then `==` and `!=` are cheap but not `<`, `<=`, `>` and `>=`.

Do you agree with the new description?


---

Comment by vdelecroix created at 2015-04-29 16:13:44

I was able to modify six Python elements to use coercion for their comparisons. The code is simplified.

In order to do that, I had to modify slightly the implementation of `_richcmp` to not catch a `TypeError` when it calls `_richcmp_`. We should precise what elements should do when `==` and `!=` makes sense but not `<`, `<=`, `>=`, `>`. Is `TypeError` appropriate?

Vincent
----
Last 10 new commits:


---

Comment by git created at 2015-04-29 16:24:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-29 16:24:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-05-04 09:05:08

I plan to have a look at this when #17890 is merged. I would also like to have some feedback on #18322, since both this ticket and #18322 change `Element`.


---

Comment by vdelecroix created at 2015-05-04 11:19:16

Replying to [comment:7 jdemeyer]:
> I plan to have a look at this when #17890 is merged. I would also like to have some feedback on #18322, since both this ticket and #18322 change `Element`.

Perhaps I should set #18322 as a dependency? I do not think that there will be any conflict since nothing in Sage explicitely uses `cmp` (except doctests).

Vincent


---

Comment by git created at 2015-05-06 08:06:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-06 08:07:51

Rebase on sage-6.7.beta4


---

Comment by jdemeyer created at 2015-05-06 08:12:09

Replying to [comment:4 vdelecroix]:
> ||[042b6fe](http://git.sagemath.org/sage.git/commit/?id=042b6fe0fae411b924a09521aab7163731c2e588)||`Trac 18305: modify Element._richcmp so that _richcmp_ can raise errors`||

I moved this to #18322 since I think it fits better there.


---

Comment by vdelecroix created at 2015-05-07 09:44:35

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-05-07 09:44:35

Replying to [comment:12 jdemeyer]:
> Replying to [comment:4 vdelecroix]:
> > ||[042b6fe](http://git.sagemath.org/sage.git/commit/?id=042b6fe0fae411b924a09521aab7163731c2e588)||`Trac 18305: modify Element._richcmp so that _richcmp_ can raise errors`||
> 
> I moved this to #18322 since I think it fits better there.

Good to me.


---

Comment by jdemeyer created at 2015-05-07 09:50:15

About this ticket: I don't really like that you're making major unrelated changes, for example (but not only) in alternating sign matrices. Do you really need that? Could those changes be moved to a different ticket?


---

Comment by git created at 2015-05-08 21:47:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-08 21:49:57

Rebased above #18322.

The alternating sign matrices is now #18383. What are the other "major unrelated changes"?


---

Comment by vdelecroix created at 2015-05-08 21:52:58

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-21 09:12:02

I think having both `py_rich_to_bool_sgn` and `py_rich_to_bool` in Python is overkill. Since these are Python functions anyway, the overhead of the `_sgn` variant can be ignored.

And I don't like most of your comment changes to `src/sage/structure/element.pyx`: if you implement just `_richcmp_`, then you don't need `__cmp__`, not even for `cmp()`. Why did you remove `or if that gives better performance`. And the `and are not identical (i.e. self is not other).` addition is also wrong I think.


---

Comment by jdemeyer created at 2015-05-21 09:15:31

Also, there is no need for the `int` in

```
def py_rich_to_bool_sgn(int op, int c)
```

(if we ever change the prototype of `rich_to_bool_sgn`, there is additional work for no reason)


---

Comment by git created at 2015-05-23 15:58:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-23 16:00:36

Rebased on 6.8.beta0.

I took care of your comments.

Vincent


---

Comment by chapoton created at 2015-07-30 12:41:23

does not apply, needs rebase


---

Comment by chapoton created at 2015-07-30 12:41:23

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-06 15:35:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-06 15:36:02

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-08-06 15:36:02

rebased on sage-6.9.beta1


---

Comment by jdemeyer created at 2015-08-28 06:11:23

See also #19108 which solves the same problem in a different (more complicated) way.


---

Comment by jdemeyer created at 2015-09-08 13:33:40

Can you split off the changes to `src/sage/algebras` to a different ticket?


---

Comment by jdemeyer created at 2015-09-08 13:34:49

Replace

```
If you need to call this function from Cython prefer
```

by

```
Do not use this function from Cython. Instead, call
```



---

Comment by git created at 2015-09-09 00:58:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-09 01:10:28

Replying to [comment:27 jdemeyer]:
> Can you split off the changes to `src/sage/algebras` to a different ticket?

It is now #19170


---

Comment by jdemeyer created at 2015-09-14 11:53:54

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-09-14 11:53:54

This is not good, you're adding back stuff which was removed:

```diff
diff --git a/src/sage/structure/element.pyx b/src/sage/structure/element.pyx
index ede0157..4208a50 100644
--- a/src/sage/structure/element.pyx
+++ b/src/sage/structure/element.pyx
@@ -1043,10 +1043,16 @@ cdef class Element(SageObject):
             return rich_to_bool(op, -1)
 
     ####################################################################
-    # For a Cython class, you must define either _cmp_ (if your subclass
-    # is totally ordered), _richcmp_ (if your subclass is partially
-    # ordered), or both (if your class has both a total order and a
-    # partial order, or if implementing both gives better performance).
+    # For a derived Cython class, you **must** put the __richcmp__
+    # method below in your subclasses, in order for it to take
+    # advantage of the above generic comparison code. If you want to use cmp()
+    # but did not implement a rich comparison, then you must copy paste the
+    # __cmp__ method below.
+    #
+    # In a Cython or a Python class, you must define either _cmp_
+    # (if your subclass is totally ordered), _richcmp_ (if your subclass
+    # is partially ordered), or both (if your class has both a total order
+    # and a partial order, or if that gives better performance).
     #
     # Rich comparisons (like a < b) will default to using _richcmp_,
     # three-way comparisons (like cmp(a,b)) will default to using
```



---

Comment by jdemeyer created at 2015-09-14 11:56:57

`Py_EQ` should be `op_EQ` here:

```
    INPUT:

    - ``op`` -- a rich comparison operation (e.g. ``Py_EQ``)
```


`c` can be any integer, not only -1, 0 or 1:

```
    - ``c`` -- the result of an ordinary comparison: -1, 0 or 1.
```


No trailing slash needed:

```
        sage: from sage.structure.sage_object import (py_rich_to_bool, \
        ....:    op_EQ, op_NE, op_LT, op_LE, op_GT, op_GE)
```



---

Comment by jdemeyer created at 2015-09-14 11:58:33

Please keep the doctests for `IndexedMonoidElement.__ne__` like you did for the other comparisons.


---

Comment by jdemeyer created at 2015-09-14 12:04:39


```
$ pyflakes src/sage/geometry/newton_polygon.py
src/sage/geometry/newton_polygon.py:20: 'op_GT' imported but unused
src/sage/geometry/newton_polygon.py:20: 'py_rich_to_bool' imported but unused
```



---

Comment by git created at 2015-09-14 17:50:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-09-14 17:51:33

Hello Jeroen,

I rebased on the latest beta taking care of all your remarks.

Vincent


---

Comment by vdelecroix created at 2015-09-14 17:52:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-09-14 18:50:03

Replying to [comment:36 vdelecroix]:
> I rebased on the latest beta taking care of all your remarks.

General comment: you should not rebase a branch which is being reviewed. For example, it is difficult for me to see what you changed since last time, which essentially forces me to re-review everything again.


---

Comment by vdelecroix created at 2015-09-14 22:27:51

If you tell me, I can move back my changes on top of the previous commits. Sorry.


---

Comment by jdemeyer created at 2015-09-17 11:42:37

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-09-17 11:44:09

Thanks Jeroen. And again, I am sorry for the too early rebase.

Vincent


---

Comment by jdemeyer created at 2015-09-17 13:33:06

Replying to [comment:41 vdelecroix]:
> Thanks Jeroen. And again, I am sorry for the too early rebase.

Why "too early"? I don't think a ticket under review should be rebased at all.

Rebasing before review is fine for me.


---

Comment by vbraun created at 2015-09-18 13:03:22

Resolution: fixed
