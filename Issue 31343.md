# Issue 31343: Update matplotlib to 3.4

Issue created by migration from https://trac.sagemath.org/ticket/31580

Original creator: arojas

Original creation time: 2021-03-30 18:02:58

CC:  mkoeppe fbissey gh_timokau




---

Comment by arojas created at 2021-03-30 18:08:47

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2021-03-30 18:08:47

----
New commits:


---

Comment by arojas created at 2021-03-30 18:08:47

Changing status from new to needs_review.


---

Comment by arojas created at 2021-03-30 18:08:47

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by fbissey created at 2021-03-30 19:10:07

At this stage, I don't think that will make it in 9.3 unless there was something critical about it. That being said, would matplotlib 3.3.x work just as well with that line removed?


---

Comment by arojas created at 2021-03-30 19:26:00

Replying to [comment:3 fbissey]:
> At this stage, I don't think that will make it in 9.3 unless there was something critical about it. That being said, would matplotlib 3.3.x work just as well with that line removed?

Sure, I didn't expect it to - just didn't change the default Milestone value. I haven't tested, but given that the line in question didn't have any effect (according to the upstream commit I linked) I don't expect there to be any issues with 3.3.x


---

Comment by fbissey created at 2021-03-30 19:29:12

I didn't really see your link earlier. Probably a bit too early in the morning for me to process information properly. In any case I was wondering if it would be OK to just squeeze that change in since it is a no-op anyway.


---

Comment by arojas created at 2021-03-30 21:31:31

Replying to [comment:5 fbissey]:
> I didn't really see your link earlier. Probably a bit too early in the morning for me to process information properly. In any case I was wondering if it would be OK to just squeeze that change in since it is a no-op anyway.

As usual, I wrote in the comment box instead of the description. Yes, would be nice to remove that line for 9.3 - would save me some garbage output when doctesting.


---

Comment by mkoeppe created at 2021-04-07 19:29:15

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-05-12 01:26:37

3.4.2 is out


---

Comment by mkoeppe created at 2021-05-12 01:26:37

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-12 06:23:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-05-12 06:24:57

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2021-05-12 07:40:49

LGTM


---

Comment by fbissey created at 2021-05-12 07:40:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-05-13 14:03:23

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-05-13 14:03:23

Build tries to download additional source files:

```
  copying lib/matplotlib/backends/web_backend/all_figures.html -> build/lib.linux-x86_64-3.9/matplotlib/backends/web_backend
  copying lib/matplotlib/mpl-data/fonts/pdfcorefonts/ZapfDingbats.afm -> build/lib.linux-x86_64-3.9/matplotlib/mpl-data/fonts/pdfcorefonts
  copying lib/matplotlib/mpl-data/fonts/afm/pagd8a.afm -> build/lib.linux-x86_64-3.9/matplotlib/mpl-data/fonts/afm
  copying lib/matplotlib/mpl-data/images/qt4_editor_options.svg -> build/lib.linux-x86_64-3.9/matplotlib/mpl-data/images
  copying lib/matplotlib/mpl-data/images/zoom_to_rect.png -> build/lib.linux-x86_64-3.9/matplotlib/mpl-data/images
  UPDATING build/lib.linux-x86_64-3.9/matplotlib/_version.py
  set build/lib.linux-x86_64-3.9/matplotlib/_version.py to '3.4.2'
  running build_ext
  error: Failed to download any of the following: ['http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz'].  Please download one of these urls and extract it into 'build/' at the top-level of the source repository.
  Building wheel for matplotlib (setup.py): finished with status 'error'
  ERROR: Failed building wheel for matplotlib
```



---

Comment by arojas created at 2021-05-13 18:38:36

heh, so it looks like it no longer bundles qhull [1] so it will finally have to be made standard. Since this may take a while, I'll split off the sagelib part.

[1] https://github.com/matplotlib/matplotlib/commit/d81d15d368ec8b7fbdd3c0450d7d3ee96641ffe1


---

Comment by arojas created at 2021-05-14 19:17:02

Done in #31827


---

Comment by dimpase created at 2021-07-17 10:36:55

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-07-17 10:36:55

New commits:


---

Comment by git created at 2021-07-17 10:50:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-07-17 13:05:11

tests are running on https://github.com/sagemath/sagetrac-mirror/actions/runs/1040329661


---

Comment by mkoeppe created at 2021-07-17 17:59:16

I haven't looked at the details, but it looks like our `qhull` package is outdated - https://repology.org/project/qhull/versions


---

Comment by dimpase created at 2021-07-18 09:03:15

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-07-18 09:03:15

errors about inability to build wheels for mathplotlib.


---

Comment by dimpase created at 2021-07-18 18:18:57

one  needs to unconditionally allow qhull from the system in the python script generat8ng .cfg file.


---

Comment by git created at 2021-07-19 11:43:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-19 13:25:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-07-19 13:27:27

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-07-19 13:27:27

OK, this should fix the issue. TOX tests on
https://github.com/sagemath/sagetrac-mirror/actions/runs/1045348934


---

Comment by dimpase created at 2021-07-20 09:58:38

There is a race condition in docbuild which leads to this GH Actions run erroring out on many systems, as follows:

```
  [dochtml]   [reference]     topology: 1937 js index entries
  [dochtml]   [reference]     valuations: 973 js index entries
  [dochtml]   [reference] ... done (64387 js index entries)
  [dochtml]   [reference] copying static files... failed
  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   [reference] dumping search index in English (code: en)... done
  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.
  [dochtml]   Error building the documentation.
  [dochtml]   Traceback (most recent call last):
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
  [dochtml]       return _run_code(code, main_globals, None,
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
  [dochtml]       exec(code, run_globals)
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
  [dochtml]       main()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1813, in main
  [dochtml]       builder()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
  [dochtml]       runsphinx()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
  [dochtml]       sys.stderr.raise_errors()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
  [dochtml]       raise OSError(self._error)
  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   
  [dochtml]       Note: incremental documentation builds sometimes cause spurious
  [dochtml]       error messages. To be certain that these are real errors, run
  [dochtml]       "make doc-clean" first and try again.
  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1
  [dochtml]   make[2]: *** [doc-html-reference] Error 2
  [dochtml]   make[2]: Target `doc-html' not remade because of errors.
  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log
make[1]: *** [doc-html] Error 2
```


this was altready reported on https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ


---

Comment by klee created at 2021-07-22 08:23:14

From #32262:

Replying to [comment:8 dimpase]:
> Replying to [comment:5 klee]:
> > What is the command to reproduce the bug?
> try building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.
> 

Building fails with me:

```
[matplotlib-3.4.2] ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/matplotlib/matplotlib-3.4.2.tar.gz'
[matplotlib-3.4.2] ************************************************************************
[matplotlib-3.4.2] Traceback (most recent call last):
...
[matplotlib-3.4.2]     raise FileNotMirroredError('tarball does not exist on mirror network')
[matplotlib-3.4.2] FileNotMirroredError: tarball does not exist on mirror network
```



---

Comment by dimpase created at 2021-07-22 08:46:15

Of course the tarballs are not on the mirrors yet, this only happens after the ticket is merged etc.
 You need to

```
./configure --enable-download-from-upstream-url
```

Then the URLs in checksum.ini files will be used if nothing is found on the mirrors.
Due to this feature (crucial for CI), nobody lists explicit tarballs in ticket descriptions any more.
 
(Or look at checksum.ini, find the URL, manually upload the tarfile to upstream/)


---

Comment by git created at 2021-07-28 10:34:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-09-07 23:43:32

3.4.3 is out


---

Comment by git created at 2021-09-08 12:51:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-09-08 13:05:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-08 13:06:03

updated to 3.4.3.


---

Comment by git created at 2021-09-14 09:20:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-09-14 09:21:55

rebased over 9.5.beta1


---

Comment by dimpase created at 2021-09-14 09:24:20

tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1233039865


---

Comment by git created at 2021-09-14 10:18:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2021-09-14 10:26:59

Replying to [comment:40 dimpase]:
> tests on https://github.com/sagemath/sagetrac-mirror/actions/runs/1233039865

> should be https://github.com/sagemath/sagetrac-mirror/actions/runs/1233224818

https://github.com/sagemath/sagetrac-mirror/actions/runs/1235471874


---

Comment by git created at 2021-09-14 22:28:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-09-19 10:56:36

tests are done, please have a look


---

Comment by mkoeppe created at 2021-11-08 05:15:09

Also the dependencies of matplotlib: `cycler`, `kiwisolver`, ... are outdated


---

Comment by git created at 2021-11-16 15:47:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-16 15:52:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-16 16:41:33

and more new deps are coming, such as cppy... hold tight


---

Comment by dimpase created at 2021-11-16 16:41:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-16 16:57:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 17:07:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-16 17:19:06

`cppy` is missing `SPKG.rst`.  Consider using `sage --package create --pypi cppy` to create packages...


---

Comment by git created at 2021-11-16 17:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-16 17:51:18

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-16 17:52:01

Let's get rid of these "Dependencies" sections in SPKG.rst please if they just duplicate what's in the `dependencies` file.


---

Comment by git created at 2021-11-16 17:53:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-11-16 17:54:18

New commits:
----
New commits:


---

Comment by mkoeppe created at 2021-11-16 17:54:43


```
diff --git a/build/pkgs/_prereq/distros/debian.txt b/build/pkgs/_prereq/distros/debian.txt
index 50be6ac..c348ee3 100644
--- a/build/pkgs/_prereq/distros/debian.txt
+++ b/build/pkgs/_prereq/distros/debian.txt
@@ -26,5 +26,6 @@ gcc
 # configure: error: in `/sage':
 # configure: error: C++ preprocessor "/lib/cpp" fails sanity check
 g++
+gfortran
 # Needed if we download some packages from a https upstream URL
 ca-certificates
```


Please don't sneak these changes in.


---

Comment by mkoeppe created at 2021-11-16 17:55:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-16 17:58:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-11-16 17:58:56

oops, sorry, should be OK now.


---

Comment by dimpase created at 2021-11-16 17:59:06

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-16 18:23:55


```
--- a/build/pkgs/cycler/checksums.ini
+++ b/build/pkgs/cycler/checksums.ini
@@ -1,4 +1,5 @@
 tarball=cycler-VERSION.tar.gz
-sha1=1bcf4a985a5f414333603f3f70a7deebbaf30439
-md5=4cb42917ac5007d1cdff6cccfe2d016b
-cksum=4189438538
+sha1=ea144185cf1d54d7415e3c66d705d9a232e57da5
+md5=cf3b4846fded12fa4d2a7a291a5d6e13
+cksum=3626319704
+upstream_url=https://github.com/matplotlib/cycler/archive/refs/tags/vVERSION.tar.gz
```


Please use PyPI URL, not a github archive


---

Comment by git created at 2021-11-16 18:43:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-11-20 09:08:38

In the meantime, 3.5 is released with new dependencies (fonttools) and new deprecations. I've opened #32909 to fix these.


---

Comment by dimpase created at 2021-11-21 12:40:04

OK, so can this ticket get in, please?


---

Comment by tornaria created at 2021-12-16 23:29:24

Note that matplotlib 3.5 is needed to avoid distutils deprecation warnings with python 3.10 (see #30766#comment:68).

The actual commit fixing the deprecation warning is https://github.com/matplotlib/matplotlib/commit/7d77bb96707f10032d8fedf2bd225491f9a28afe


---

Comment by dimpase created at 2021-12-17 11:50:53

Are we aiming at a full support of Python 3.10 in 9.5? If so, I guess we should go straight to matplotlib 3.5.


---

Comment by mkoeppe created at 2021-12-17 16:50:13

Replying to [comment:70 dimpase]:
> Are we aiming at a full support of Python 3.10 in 9.5? 

Not sure if we can/should. I think it's better to have a release very soon because of the glibc 2.34 issue (#32576), which lots of people are already running into.


---

Comment by mkoeppe created at 2021-12-17 16:57:10

Replying to [comment:69 tornaria]:
> Note that matplotlib 3.5 is needed to avoid distutils deprecation warnings with python 3.10 

Opened #33040 for this


---

Comment by mkoeppe created at 2021-12-17 16:57:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-17 16:57:54

Changing priority from major to critical.


---

Comment by vbraun created at 2021-12-20 00:33:21

On OSX:

```
**********************************************************************
File "src/sage/plot/plot3d/list_plot3d.py", line 380, in sage.plot.plot3d.list_plot3d.list_plot3d_tuples
Failed example:
    list_plot3d(m, color='yellow', interpolation_type='linear', num_points=5) # indirect doctest
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.list_plot3d.list_plot3d_tuples[2]>", line 1, in <module>
        list_plot3d(m, color='yellow', interpolation_type='linear', num_points=Integer(5)) # indirect doctest
      File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/plot3d/list_plot3d.py", line 188, in list_plot3d
        return list_plot3d_tuples(data, interpolation_type, **kwds)
      File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/plot/plot3d/list_plot3d.py", line 453, in list_plot3d_tuples
        T = tri.Triangulation(x, y)
      File "/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/matplotlib/tri/triangulation.py", line 39, in __init__
        from matplotlib import _qhull
    ImportError: dlopen(/Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/matplotlib/_qhull.cpython-39-darwin.so, 2): Library not loaded: lib/libqhull_r.8.0.dylib
      Referenced from: /Users/buildbot-sage/worker/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/matplotlib/_qhull.cpython-39-darwin.so
      Reason: image not found
**********************************************************************
1 item had failures:
   1 of   7 in sage.plot.plot3d.list_plot3d.list_plot3d_tuples
    [48 tests, 1 failure, 4.36 s]
----------------------------------------------------------------------
sage -t --long --random-seed=269285139450068045496865355624462748906 src/sage/plot/plot3d/list_plot3d.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2021-12-20 00:33:21

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2021-12-20 00:42:28

Looks like some wrong `install_name` was used on that `qhull` install. Is `qhull` supposed to come from conda, brew or sage internals on OSX during those testruns?

It is a bit strange it wasn't seen before.


---

Comment by fbissey created at 2021-12-20 01:01:39

OK, `qhull` used to be optional and has been switched to standard with this release. Unfortunately boiler plate `sdh_cmake` doesn't set `install_name` properly for qhull. I am not sure how it all install in the proper places but to get the right `rpath` and `install_name`, `-DLIB_INSTALL_DIR=...` has to be passed to camke when configuring.

I'll fix that ASAP. This would affect the further upgrade to 3.5.1.


---

Comment by fbissey created at 2021-12-20 01:21:53

Should work now.
----
New commits:


---

Comment by fbissey created at 2021-12-20 01:21:53

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-20 02:55:40

Also `cppy` is missing `install-requires.txt`.


---

Comment by mkoeppe created at 2021-12-20 02:55:40

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-12-20 03:07:38

New commits:


---

Comment by mkoeppe created at 2021-12-20 03:07:38

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-20 03:34:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-12-28 21:15:44

Resolution: fixed
