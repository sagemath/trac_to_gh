# Issue 21489: Support splitting spkg install into `spkg-build` and `spkg-install` (for SAGE_SUDO)

archive/issues_021489.json:
```json
{
    "body": "CC:  jdemeyer fbissey embray vbraun dimpase tscrim\n\nHere's a new attempt toward #21537 that is perhaps more elegant.\n\nLet's change `build/bin/sage-spkg` as follows:\n\n- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. \n- Otherwise, just call `spkg-install` (with $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/21726\n\n",
    "created_at": "2016-10-19T01:25:18Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Support splitting spkg install into `spkg-build` and `spkg-install` (for SAGE_SUDO)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21489",
    "user": "mkoeppe"
}
```
CC:  jdemeyer fbissey embray vbraun dimpase tscrim

Here's a new attempt toward #21537 that is perhaps more elegant.

Let's change `build/bin/sage-spkg` as follows:

- If `spkg-build` exists, call that, followed by `$SAGE_SUDO spkg-install`. 
- Otherwise, just call `spkg-install` (with $SAGE_SUDO). (Such packages cannot be installed into a SAGE_ROOT that is only root-writable.)

Issue created by migration from https://trac.sagemath.org/ticket/21726





---

archive/issue_comments_298300.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298300",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_298301.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-19T03:49:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298301",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_298302.json:
```json
{
    "body": "So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be \"special\" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?",
    "created_at": "2016-11-07T11:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298302",
    "user": "embray"
}
```

So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be "special" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?



---

archive/issue_comments_298303.json:
```json
{
    "body": "What is this about?\n\n\n```\n+    if [ ! -x spkg-build ]; then\n+\techo >&2 \"WARNING: spkg-build is not executable, making it executable\"\n+\tchmod +x spkg-build\n+    fi\n```\n\n\nWhy not just require it to be executable in the first place?",
    "created_at": "2016-11-07T11:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298303",
    "user": "embray"
}
```

What is this about?


```
+    if [ ! -x spkg-build ]; then
+	echo >&2 "WARNING: spkg-build is not executable, making it executable"
+	chmod +x spkg-build
+    fi
```


Why not just require it to be executable in the first place?



---

archive/issue_comments_298304.json:
```json
{
    "body": "LGTM otherwise.  This looks like what I had in mind in #21537.",
    "created_at": "2016-11-07T11:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298304",
    "user": "embray"
}
```

LGTM otherwise.  This looks like what I had in mind in #21537.



---

archive/issue_comments_298305.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be \"special\" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?\n\nThat's right.",
    "created_at": "2016-11-08T12:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298305",
    "user": "mkoeppe"
}
```

Replying to [comment:8 embray]:
> So, if I understand correctly, the point of calling `spkg-install` *without* `$SAGE_SUDO` if no `spkg-build` exists, is that for backwards-compatibility such packages should be assumed to be "special" in some way, and have to handle `$SAGE_SUDO` on their own.  Is that correct?

That's right.



---

archive/issue_comments_298306.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> What is this about?\n> \n> {{{\n> +    if [ ! -x spkg-build ]; then\n> +\techo >&2 \"WARNING: spkg-build is not executable, making it executable\"\n> +\tchmod +x spkg-build\n> +    fi\n> }}}\n> \n> Why not just require it to be executable in the first place?\n\nIt's imitating existing code that does the same for `spkg-install`. I don't know why it does that. Hysterical raisins?",
    "created_at": "2016-11-08T12:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298306",
    "user": "mkoeppe"
}
```

Replying to [comment:9 embray]:
> What is this about?
> 
> {{{
> +    if [ ! -x spkg-build ]; then
> +	echo >&2 "WARNING: spkg-build is not executable, making it executable"
> +	chmod +x spkg-build
> +    fi
> }}}
> 
> Why not just require it to be executable in the first place?

It's imitating existing code that does the same for `spkg-install`. I don't know why it does that. Hysterical raisins?



---

archive/issue_comments_298307.json:
```json
{
    "body": "I see that now.  Might as well keep it for now then :(",
    "created_at": "2016-11-08T12:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298307",
    "user": "embray"
}
```

I see that now.  Might as well keep it for now then :(



---

archive/issue_comments_298308.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-08T12:50:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298308",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_298309.json:
```json
{
    "body": "Thanks!",
    "created_at": "2016-11-08T18:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298309",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_298310.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-09T18:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298310",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_298311.json:
```json
{
    "body": "Semi-related, see #22510.",
    "created_at": "2017-03-03T13:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21489#issuecomment-298311",
    "user": "embray"
}
```

Semi-related, see #22510.
