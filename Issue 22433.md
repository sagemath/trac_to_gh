# Issue 22433: Make Three.js work offline redux

archive/issues_022433.json:
```json
{
    "body": "CC:  novoselt egourgoulhon\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22670\n\n",
    "created_at": "2017-03-21T23:50:15Z",
    "labels": [
        "graphics",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "Make Three.js work offline redux",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22433",
    "user": "paulmasson"
}
```
CC:  novoselt egourgoulhon



Issue created by migration from https://trac.sagemath.org/ticket/22670





---

archive/issue_comments_312489.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-03-22T00:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312489",
    "user": "paulmasson"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_312490.json:
```json
{
    "body": "Some more thoughts: we should avoid code duplication as much as feasible here so that we don't have to chase all places where the version of the threejs is used when we want to change it. Perhaps something like this will work:\n- generic method returns CDN scripts with `online=True` and throws an exception with `online=False`, these scripts include the version number\n- backend-specific implementation provide appropriate paths to Sage package (which does not include the version number), and if they have to include a fall-back CDN section, they do it by invoking the parent method with `online=True` and embed that string in appropriate places\n\nThis way when upgrading threejs package one has also to bump version number in the generic method (and perhaps it should be mentioned in `SPKG.txt`), but backend ones will likely never require tweaking.",
    "created_at": "2017-03-22T02:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312490",
    "user": "novoselt"
}
```

Some more thoughts: we should avoid code duplication as much as feasible here so that we don't have to chase all places where the version of the threejs is used when we want to change it. Perhaps something like this will work:
- generic method returns CDN scripts with `online=True` and throws an exception with `online=False`, these scripts include the version number
- backend-specific implementation provide appropriate paths to Sage package (which does not include the version number), and if they have to include a fall-back CDN section, they do it by invoking the parent method with `online=True` and embed that string in appropriate places

This way when upgrading threejs package one has also to bump version number in the generic method (and perhaps it should be mentioned in `SPKG.txt`), but backend ones will likely never require tweaking.



---

archive/issue_comments_312491.json:
```json
{
    "body": "Andrey, please have a look at this. I'm using the internal `installed_packages` table to read the version number where needed, so we'll only have to change it once in the package itself during upgrades. I didn't include an error test to make sure the package is installed since it's now standard and should always be present. The IPython notebook can't call the parent method as you'd like because that fallback is in the JavaScript, so it needs to look up the version as well, but then there will be no tweaking for upgrades.\n\nThere is currently a failing doctest for something called \"BackendDoctest\". I'll fix that once I know we're on the right track.\n----\nNew commits:",
    "created_at": "2017-03-31T22:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312491",
    "user": "paulmasson"
}
```

Andrey, please have a look at this. I'm using the internal `installed_packages` table to read the version number where needed, so we'll only have to change it once in the package itself during upgrades. I didn't include an error test to make sure the package is installed since it's now standard and should always be present. The IPython notebook can't call the parent method as you'd like because that fallback is in the JavaScript, so it needs to look up the version as well, but then there will be no tweaking for upgrades.

There is currently a failing doctest for something called "BackendDoctest". I'll fix that once I know we're on the right track.
----
New commits:



---

archive/issue_comments_312492.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-31T22:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312492",
    "user": "paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_312493.json:
```json
{
    "body": "Automatic version matching is great, thanks for figuring it out!\n\nIt still seems to me that in `base.pyx` it would be better to have just\n\n```python\nscripts = backend.threejs_scripts(options['online'])\n```\n\nwith the base backend class handling `True` case and more specific classes worrying about `False`. That way `BackendIPythonNotebook` could call parent method for extra bits instead of repeating the logic. Also, everything would be more in one place rather than the same thing split between `plot` and `repl`. But overall this design is already a nice improvement over current version.",
    "created_at": "2017-04-01T03:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312493",
    "user": "novoselt"
}
```

Automatic version matching is great, thanks for figuring it out!

It still seems to me that in `base.pyx` it would be better to have just

```python
scripts = backend.threejs_scripts(options['online'])
```

with the base backend class handling `True` case and more specific classes worrying about `False`. That way `BackendIPythonNotebook` could call parent method for extra bits instead of repeating the logic. Also, everything would be more in one place rather than the same thing split between `plot` and `repl`. But overall this design is already a nice improvement over current version.



---

archive/issue_comments_312494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-02T00:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312494",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312495.json:
```json
{
    "body": "Hopefully this is closer to what you had in mind.\n\nI've included an error test in the base method, but this causes a doctest in `plot3d/base.pyx` to fail even with the keyword argument set explicitly. Do you know why the doctesting process ignores the keyword argument?\n\nA workaround is to have the base method return an empty string when `online=False` but that's hardly desirable.",
    "created_at": "2017-04-02T01:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312495",
    "user": "paulmasson"
}
```

Hopefully this is closer to what you had in mind.

I've included an error test in the base method, but this causes a doctest in `plot3d/base.pyx` to fail even with the keyword argument set explicitly. Do you know why the doctesting process ignores the keyword argument?

A workaround is to have the base method return an empty string when `online=False` but that's hardly desirable.



---

archive/issue_comments_312496.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-04-02T18:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312496",
    "user": "novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_312497.json:
```json
{
    "body": "Tweaked a bit backend code.\n\nRegarding option ignoring - that's because you ignore them instead of doing `opts = self._process_viewing_options(kwds)` as other methods ;-) I'm looking at how things work and hope to post a solution shortly, will be useful for my understanding of option handling.\n----\nNew commits:",
    "created_at": "2017-04-02T18:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312497",
    "user": "novoselt"
}
```

Tweaked a bit backend code.

Regarding option ignoring - that's because you ignore them instead of doing `opts = self._process_viewing_options(kwds)` as other methods ;-) I'm looking at how things work and hope to post a solution shortly, will be useful for my understanding of option handling.
----
New commits:



---

archive/issue_comments_312498.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-02T19:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312498",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312499.json:
```json
{
    "body": "Improved option handing, but now the error is\n\n```\nFailed example:\n    sphere(online=True)._rich_repr_threejs()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/novoselt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.plot.plot3d.base.Graphics3d._rich_repr_threejs[0]>\", line 1, in <module>\n        sphere(online=True)._rich_repr_threejs()\n      File \"sage/plot/plot3d/base.pyx\", line 424, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:10615)\n        html = html.replace('SAGE_OPTIONS', json.dumps(options))\n      File \"/home/novoselt/sage/local/lib/python/json/__init__.py\", line 244, in dumps\n        return _default_encoder.encode(obj)\n      File \"/home/novoselt/sage/local/lib/python/json/encoder.py\", line 207, in encode\n        chunks = self.iterencode(o, _one_shot=True)\n      File \"/home/novoselt/sage/local/lib/python/json/encoder.py\", line 270, in iterencode\n        return _iterencode(o, 0)\n      File \"/home/novoselt/sage/local/lib/python/json/encoder.py\", line 184, in default\n        raise TypeError(repr(o) + \" is not JSON serializable\")\n    TypeError: Texture(texture42, 6666ff) is not JSON serializable\n```\n\nwhich makes me wonder why these options are sent to the output at all?..",
    "created_at": "2017-04-02T19:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312499",
    "user": "novoselt"
}
```

Improved option handing, but now the error is

```
Failed example:
    sphere(online=True)._rich_repr_threejs()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/novoselt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.base.Graphics3d._rich_repr_threejs[0]>", line 1, in <module>
        sphere(online=True)._rich_repr_threejs()
      File "sage/plot/plot3d/base.pyx", line 424, in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:10615)
        html = html.replace('SAGE_OPTIONS', json.dumps(options))
      File "/home/novoselt/sage/local/lib/python/json/__init__.py", line 244, in dumps
        return _default_encoder.encode(obj)
      File "/home/novoselt/sage/local/lib/python/json/encoder.py", line 207, in encode
        chunks = self.iterencode(o, _one_shot=True)
      File "/home/novoselt/sage/local/lib/python/json/encoder.py", line 270, in iterencode
        return _iterencode(o, 0)
      File "/home/novoselt/sage/local/lib/python/json/encoder.py", line 184, in default
        raise TypeError(repr(o) + " is not JSON serializable")
    TypeError: Texture(texture42, 6666ff) is not JSON serializable
```

which makes me wonder why these options are sent to the output at all?..



---

archive/issue_comments_312500.json:
```json
{
    "body": "OK, looking at the template I see how they are used, but I am not sure what's the correct way to proceed: fix representation of texture option, drop if from threejs output, or send only options which are known to be used in JavaScript?",
    "created_at": "2017-04-02T19:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312500",
    "user": "novoselt"
}
```

OK, looking at the template I see how they are used, but I am not sure what's the correct way to proceed: fix representation of texture option, drop if from threejs output, or send only options which are known to be used in JavaScript?



---

archive/issue_comments_312501.json:
```json
{
    "body": "I don't see how invoking `_process_viewing_options(kwds)` fixes anything: all it appears to do is add a bunch of options that won't be used in JavaScript, at least not yet. Where is `online` actually getting passed on to the doctest backend with your changes?\n\nAll the other changes look good. And FYI `decimals` is Three.js specific.",
    "created_at": "2017-04-02T20:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312501",
    "user": "paulmasson"
}
```

I don't see how invoking `_process_viewing_options(kwds)` fixes anything: all it appears to do is add a bunch of options that won't be used in JavaScript, at least not yet. Where is `online` actually getting passed on to the doctest backend with your changes?

All the other changes look good. And FYI `decimals` is Three.js specific.



---

archive/issue_comments_312502.json:
```json
{
    "body": "FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.",
    "created_at": "2017-04-02T20:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312502",
    "user": "paulmasson"
}
```

FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.



---

archive/issue_comments_312503.json:
```json
{
    "body": "`online=True` passed to the constructor is saved in the object, `_process_viewing_options` assembles default options, options passed to constructor, and options passed directly in `kwds`, it also does some normalization of them, so I am pretty sure it is \"the right thing\" to call it here as well. I've tried to mark `decimals` as Three.js specific - they are set there to a default if not passed via other means and then another section is dealing with type conversion.",
    "created_at": "2017-04-02T20:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312503",
    "user": "novoselt"
}
```

`online=True` passed to the constructor is saved in the object, `_process_viewing_options` assembles default options, options passed to constructor, and options passed directly in `kwds`, it also does some normalization of them, so I am pretty sure it is "the right thing" to call it here as well. I've tried to mark `decimals` as Three.js specific - they are set there to a default if not passed via other means and then another section is dealing with type conversion.



---

archive/issue_comments_312504.json:
```json
{
    "body": "Replying to [comment:15 paulmasson]:\n> FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.\n\nBut you are using some of the options that are \"standard\" like `axes` and the problem was that it was not possible to pass threejs-specific options via standard means. So I am still convinced that my changes are on the right track. And it seems to me now that the next step is to keep only whitelisted options in this dictionary before sending them to template.",
    "created_at": "2017-04-02T20:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312504",
    "user": "novoselt"
}
```

Replying to [comment:15 paulmasson]:
> FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.

But you are using some of the options that are "standard" like `axes` and the problem was that it was not possible to pass threejs-specific options via standard means. So I am still convinced that my changes are on the right track. And it seems to me now that the next step is to keep only whitelisted options in this dictionary before sending them to template.



---

archive/issue_comments_312505.json:
```json
{
    "body": "Replying to [comment:17 novoselt]:\n> Replying to [comment:15 paulmasson]:\n> > FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.\n> \n> But you are using some of the options that are \"standard\" like `axes` and the problem was that it was not possible to pass threejs-specific options via standard means. So I am still convinced that my changes are on the right track. And it seems to me now that the next step is to keep only whitelisted options in this dictionary before sending them to template.\nIf it gets things to work then good, but I'm not yet seeing the standard means. Sorry about the `decimals` mix up: was editing my statement when you responded. And one correction: `online` isn't used in the template so doesn't need to be whitelisted.",
    "created_at": "2017-04-02T20:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312505",
    "user": "paulmasson"
}
```

Replying to [comment:17 novoselt]:
> Replying to [comment:15 paulmasson]:
> > FYI the `options` explicitly set by me are the only ones used in the template, which is why I just created my own dictionary.
> 
> But you are using some of the options that are "standard" like `axes` and the problem was that it was not possible to pass threejs-specific options via standard means. So I am still convinced that my changes are on the right track. And it seems to me now that the next step is to keep only whitelisted options in this dictionary before sending them to template.
If it gets things to work then good, but I'm not yet seeing the standard means. Sorry about the `decimals` mix up: was editing my statement when you responded. And one correction: `online` isn't used in the template so doesn't need to be whitelisted.



---

archive/issue_comments_312506.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-02T21:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312506",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312507.json:
```json
{
    "body": "By \"standard means\" I meant that this is how other similar functions process options: of the main interest to us is that it picks up options passed to constructor, but there is some extra logic to e.g. handle `aspect_ratio`. After all, in the ideal world there would be no backend/viewer specific options, e.g. why can't other viewers support `axes_labels`?\n\nAnyway, the last commit lets tests pass, but let me fiddle a little more with backends.",
    "created_at": "2017-04-02T21:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312507",
    "user": "novoselt"
}
```

By "standard means" I meant that this is how other similar functions process options: of the main interest to us is that it picks up options passed to constructor, but there is some extra logic to e.g. handle `aspect_ratio`. After all, in the ideal world there would be no backend/viewer specific options, e.g. why can't other viewers support `axes_labels`?

Anyway, the last commit lets tests pass, but let me fiddle a little more with backends.



---

archive/issue_comments_312508.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-02T22:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312508",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312509.json:
```json
{
    "body": "The use of `installed_packages` looks nifty in theory. It automates things nicely. The only problem with it, is that it depends on you using sagemath's packaging system in full. sage-on-distro or if we switch (cross fingers) to a more effective packaging solution this will just be in the way.\n\nAs a sage-on-distro person I disapprove of anything using `sage.misc.package` at runtime.\n\nI don't have a better solution at this stage. Are different release on the CDN all that different? Do they have some backward or forward compatibility?\n----\nNew commits:",
    "created_at": "2017-04-02T22:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312509",
    "user": "fbissey"
}
```

The use of `installed_packages` looks nifty in theory. It automates things nicely. The only problem with it, is that it depends on you using sagemath's packaging system in full. sage-on-distro or if we switch (cross fingers) to a more effective packaging solution this will just be in the way.

As a sage-on-distro person I disapprove of anything using `sage.misc.package` at runtime.

I don't have a better solution at this stage. Are different release on the CDN all that different? Do they have some backward or forward compatibility?
----
New commits:



---

archive/issue_comments_312510.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-02T22:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312510",
    "user": "novoselt"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_312511.json:
```json
{
    "body": "OK, how about this one? It still bugged me that `_backend` of display manager was accessed directly, so I moved the CDN method to `DisplayManager` and made backends responsible for offline case only as in your original version. It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly. Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?",
    "created_at": "2017-04-02T22:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312511",
    "user": "novoselt"
}
```

OK, how about this one? It still bugged me that `_backend` of display manager was accessed directly, so I moved the CDN method to `DisplayManager` and made backends responsible for offline case only as in your original version. It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly. Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?



---

archive/issue_comments_312512.json:
```json
{
    "body": "Regarding CDN releases - in principle the version matters, although the problems are presumably more frequent when using old instead of new. So we may try to omit the version and use the master branch of threejs.",
    "created_at": "2017-04-02T22:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312512",
    "user": "novoselt"
}
```

Regarding CDN releases - in principle the version matters, although the problems are presumably more frequent when using old instead of new. So we may try to omit the version and use the master branch of threejs.



---

archive/issue_comments_312513.json:
```json
{
    "body": "Replying to [comment:24 novoselt]:\n> Regarding CDN releases - in principle the version matters, although the problems are presumably more frequent when using old instead of new. So we may try to omit the version and use the master branch of threejs.\nWith Three.js the version number can matter greatly, unfortunately. Mr. Doob has made radical changes in the past that render the code not backward compatible. That doesn't happen too often but it will be an ongoing concern.",
    "created_at": "2017-04-02T23:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312513",
    "user": "paulmasson"
}
```

Replying to [comment:24 novoselt]:
> Regarding CDN releases - in principle the version matters, although the problems are presumably more frequent when using old instead of new. So we may try to omit the version and use the master branch of threejs.
With Three.js the version number can matter greatly, unfortunately. Mr. Doob has made radical changes in the past that render the code not backward compatible. That doesn't happen too often but it will be an ongoing concern.



---

archive/issue_comments_312514.json:
```json
{
    "body": "OK, possible solutions:\n1. Have hard-coded version number and add some comment to SPKG.txt as I originally proposed.\n2. Pick up the version number from the library file itself, presumably this is possible.\n3. Put an extra file together with the library into `share/threejs`\n4. =2+3: Pick up the version number from the library file and then write it into some file for speed. Or just some variable to avoid disk operations and access issues...",
    "created_at": "2017-04-02T23:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312514",
    "user": "novoselt"
}
```

OK, possible solutions:
1. Have hard-coded version number and add some comment to SPKG.txt as I originally proposed.
2. Pick up the version number from the library file itself, presumably this is possible.
3. Put an extra file together with the library into `share/threejs`
4. =2+3: Pick up the version number from the library file and then write it into some file for speed. Or just some variable to avoid disk operations and access issues...



---

archive/issue_comments_312515.json:
```json
{
    "body": "Options 2,3 and 4 rely on theejs to be installed locally, a distro may very decide to make that optional (if at all - properly packaging this kind of stuff is a pain) and to rely on online availability by default.\n\nAlternative to (1) declare a variable in `sage.env.py` it could be migrated to a separate file installed by the spkg once we work out #22652. That method would be ok to me as I can supply an arbitrary extra file for my distro.",
    "created_at": "2017-04-02T23:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312515",
    "user": "fbissey"
}
```

Options 2,3 and 4 rely on theejs to be installed locally, a distro may very decide to make that optional (if at all - properly packaging this kind of stuff is a pain) and to rely on online availability by default.

Alternative to (1) declare a variable in `sage.env.py` it could be migrated to a separate file installed by the spkg once we work out #22652. That method would be ok to me as I can supply an arbitrary extra file for my distro.



---

archive/issue_comments_312516.json:
```json
{
    "body": "Replying to [comment:23 novoselt]:\n> It still bugged me that `_backend` of display manager was accessed directly\nWhy is this a bad thing to do?\n> It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly.\nOnly the IPython notebook does this, to provide a fallback requested by Eric. How would you do this more properly?\n>Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?\nThe server directory to Three.js files doesn't exist in the current version of the notebook. A [pull request](https://github.com/sagemath/sagenb/pull/424) was merged to provide that and the method will be altered when a newer version of the notebook is available.\n\nCouple minor things:\n\n1) In display manager documentation, \"Three.js\" should be capitalized and \"offline\" is one word.\n\n2) I may want to reuse the `options` dictionary for handling future features, like setting iframe size from `figsize`, so it shouldn't be completely overwritten. Please introduce a different name on the next commit.",
    "created_at": "2017-04-03T00:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312516",
    "user": "paulmasson"
}
```

Replying to [comment:23 novoselt]:
> It still bugged me that `_backend` of display manager was accessed directly
Why is this a bad thing to do?
> It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly.
Only the IPython notebook does this, to provide a fallback requested by Eric. How would you do this more properly?
>Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?
The server directory to Three.js files doesn't exist in the current version of the notebook. A [pull request](https://github.com/sagemath/sagenb/pull/424) was merged to provide that and the method will be altered when a newer version of the notebook is available.

Couple minor things:

1) In display manager documentation, "Three.js" should be capitalized and "offline" is one word.

2) I may want to reuse the `options` dictionary for handling future features, like setting iframe size from `figsize`, so it shouldn't be completely overwritten. Please introduce a different name on the next commit.



---

archive/issue_comments_312517.json:
```json
{
    "body": "Andrey, scenes render for all three backends and both on/offline, but you've introduced a problem with IPython offline. The closing script tags need to be written as `<\\/script>` with the forward slash escaped to prevent the remainer of that line of code, the `');`, from printing in the cell above the scene. Please do a string replace before returning.",
    "created_at": "2017-04-03T00:23:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312517",
    "user": "paulmasson"
}
```

Andrey, scenes render for all three backends and both on/offline, but you've introduced a problem with IPython offline. The closing script tags need to be written as `<\/script>` with the forward slash escaped to prevent the remainer of that line of code, the `');`, from printing in the cell above the scene. Please do a string replace before returning.



---

archive/issue_comments_312518.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> Options 2,3 and 4 rely on theejs to be installed locally, a distro may very decide to make that optional (if at all - properly packaging this kind of stuff is a pain) and to rely on online availability by default.\n> \n> Alternative to (1) declare a variable in `sage.env.py` it could be migrated to a separate file installed by the spkg once we work out #22652. That method would be ok to me as I can supply an arbitrary extra file for my distro.\n\nOur three.js package contrains only two files that we use instead of the whole repository, so it does not seem a big deal to me to keep it installed as part of Sage. In any case I think that for now (i.e. this ticket) we should keep it as is and modify to something else once (and if) it becomes a problem.",
    "created_at": "2017-04-03T00:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312518",
    "user": "novoselt"
}
```

Replying to [comment:27 fbissey]:
> Options 2,3 and 4 rely on theejs to be installed locally, a distro may very decide to make that optional (if at all - properly packaging this kind of stuff is a pain) and to rely on online availability by default.
> 
> Alternative to (1) declare a variable in `sage.env.py` it could be migrated to a separate file installed by the spkg once we work out #22652. That method would be ok to me as I can supply an arbitrary extra file for my distro.

Our three.js package contrains only two files that we use instead of the whole repository, so it does not seem a big deal to me to keep it installed as part of Sage. In any case I think that for now (i.e. this ticket) we should keep it as is and modify to something else once (and if) it becomes a problem.



---

archive/issue_comments_312519.json:
```json
{
    "body": "For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.\n\nIt will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.",
    "created_at": "2017-04-03T01:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312519",
    "user": "fbissey"
}
```

For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.

It will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.



---

archive/issue_comments_312520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-03T01:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312520",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_312521.json:
```json
{
    "body": "Replying to [comment:28 paulmasson]:\n> Replying to [comment:23 novoselt]:\n> > It still bugged me that `_backend` of display manager was accessed directly\n> Why is this a bad thing to do?\nBecause backends are supposed to be isolated! It was really, really painful to have a lot of places spread over Sage that were doing different things depending on the way it was launched and I would prefer none of them coming back ;-)\n> > It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly.\n> Only the IPython notebook does this, to provide a fallback requested by Eric. How would you do this more properly?\nNo how, it is just a bit unfortunate that this problem arises in the first place.\n> >Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?\n> The server directory to Three.js files doesn't exist in the current version of the notebook. A [pull request](https://github.com/sagemath/sagenb/pull/424) was merged to provide that and the method will be altered when a newer version of the notebook is available.\nGreat!\n> \n> Couple minor things:\n> \n> 1) In display manager documentation, \"Three.js\" should be capitalized and \"offline\" is one word.\n> \nFixed.\n> 2) I may want to reuse the `options` dictionary for handling future features, like setting iframe size from `figsize`, so it shouldn't be completely overwritten. Please introduce a different name on the next commit.\nThat's why I put this code right next to template filling, but different name works just as well, done.",
    "created_at": "2017-04-03T01:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312521",
    "user": "novoselt"
}
```

Replying to [comment:28 paulmasson]:
> Replying to [comment:23 novoselt]:
> > It still bugged me that `_backend` of display manager was accessed directly
> Why is this a bad thing to do?
Because backends are supposed to be isolated! It was really, really painful to have a lot of places spread over Sage that were doing different things depending on the way it was launched and I would prefer none of them coming back ;-)
> > It is somewhat ugly that they call that CDN method when handling offline case, but it is kind of due to things not done completely properly.
> Only the IPython notebook does this, to provide a fallback requested by Eric. How would you do this more properly?
No how, it is just a bit unfortunate that this problem arises in the first place.
> >Why SageNB is using CDN for offline case? Doesn't it have access to Sage installation which includes three.js?
> The server directory to Three.js files doesn't exist in the current version of the notebook. A [pull request](https://github.com/sagemath/sagenb/pull/424) was merged to provide that and the method will be altered when a newer version of the notebook is available.
Great!
> 
> Couple minor things:
> 
> 1) In display manager documentation, "Three.js" should be capitalized and "offline" is one word.
> 
Fixed.
> 2) I may want to reuse the `options` dictionary for handling future features, like setting iframe size from `figsize`, so it shouldn't be completely overwritten. Please introduce a different name on the next commit.
That's why I put this code right next to template filling, but different name works just as well, done.



---

archive/issue_comments_312522.json:
```json
{
    "body": "Replying to [comment:31 fbissey]:\n> For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.\n> \n> It will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.\n\nI am not trying to stay put on my island and I am all for isolation etc. But if use of `sage.misc.package` is prohibited, then perhaps it should not be exposed and look like an accessible functionality. How should we know that you disapprove of it? Please improve the current non-ideal situation, but if depends on a new ticket I would like to merge this one for the moment since it does improve threejs situation and we hope to make it default viewer in 8.0.",
    "created_at": "2017-04-03T01:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312522",
    "user": "novoselt"
}
```

Replying to [comment:31 fbissey]:
> For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.
> 
> It will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.

I am not trying to stay put on my island and I am all for isolation etc. But if use of `sage.misc.package` is prohibited, then perhaps it should not be exposed and look like an accessible functionality. How should we know that you disapprove of it? Please improve the current non-ideal situation, but if depends on a new ticket I would like to merge this one for the moment since it does improve threejs situation and we hope to make it default viewer in 8.0.



---

archive/issue_comments_312523.json:
```json
{
    "body": "Replying to [comment:34 novoselt]:\n> Replying to [comment:31 fbissey]:\n> > For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.\n> > \n> > It will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.\n> \n> I am not trying to stay put on my island and I am all for isolation etc. But if use of `sage.misc.package` is prohibited, then perhaps it should not be exposed and look like an accessible functionality. How should we know that you disapprove of it? Please improve the current non-ideal situation, but if depends on a new ticket I would like to merge this one for the moment since it does improve threejs situation and we hope to make it default viewer in 8.0.\n\n\nYes, you are right there should be a higher level policy on this. `sage.misc.package` is an artefact of sage being its own packaging system and it has unwelcome tentacles all over the place. I am trying to convince people not create any more tentacles - like I killed most uses of SAGE_ROOT before. I shall bring it on sage-devel.",
    "created_at": "2017-04-03T01:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312523",
    "user": "fbissey"
}
```

Replying to [comment:34 novoselt]:
> Replying to [comment:31 fbissey]:
> > For sage on its own, in its corner playing all alone, by itself, there is no problem. There is never a problem, you are self contained. I don't suggest you change the status standard package for threejs either. I am encouraging you to think of a bigger picture regarding package management when you are not on your little island.
> > 
> > It will be a problem for anyone doing sage-on-distro/conda as soon as it is merged. I probably should publicise this ticket on the `sage-packaging` mailing list and see what everyone think of the threejs business as it is now, since the current situation is hardly ideal either.
> 
> I am not trying to stay put on my island and I am all for isolation etc. But if use of `sage.misc.package` is prohibited, then perhaps it should not be exposed and look like an accessible functionality. How should we know that you disapprove of it? Please improve the current non-ideal situation, but if depends on a new ticket I would like to merge this one for the moment since it does improve threejs situation and we hope to make it default viewer in 8.0.


Yes, you are right there should be a higher level policy on this. `sage.misc.package` is an artefact of sage being its own packaging system and it has unwelcome tentacles all over the place. I am trying to convince people not create any more tentacles - like I killed most uses of SAGE_ROOT before. I shall bring it on sage-devel.



---

archive/issue_comments_312524.json:
```json
{
    "body": "Documentation won't build. Looks like some extra whitespace somewhere:\n\n\n```\n[repl     ] /Users/Masson/Downloads/GitHub/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_ipython.py:docstring of sage.repl.rich_output.backend_ipython.BackendIPythonNotebook.threejs_offline_scripts:13: WARNING: Block quote ends without a blank line; unexpected unindent.\n[repl     ] /Users/Masson/Downloads/GitHub/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:docstring of sage.repl.rich_output.display_manager.DisplayManager.threejs_scripts:22: WARNING: Block quote ends without a blank line; unexpected unindent.\nError building the documentation.\n```\n",
    "created_at": "2017-04-03T02:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312524",
    "user": "paulmasson"
}
```

Documentation won't build. Looks like some extra whitespace somewhere:


```
[repl     ] /Users/Masson/Downloads/GitHub/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_ipython.py:docstring of sage.repl.rich_output.backend_ipython.BackendIPythonNotebook.threejs_offline_scripts:13: WARNING: Block quote ends without a blank line; unexpected unindent.
[repl     ] /Users/Masson/Downloads/GitHub/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py:docstring of sage.repl.rich_output.display_manager.DisplayManager.threejs_scripts:22: WARNING: Block quote ends without a blank line; unexpected unindent.
Error building the documentation.
```




---

archive/issue_comments_312525.json:
```json
{
    "body": "Figured out it was the `\\n` in two doctests. Replaced with `...` and documentation now builds and doctests still pass.\n\nSetting to positive review unless someone else wants to test it further.\n----\nNew commits:",
    "created_at": "2017-04-03T21:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312525",
    "user": "paulmasson"
}
```

Figured out it was the `\n` in two doctests. Replaced with `...` and documentation now builds and doctests still pass.

Setting to positive review unless someone else wants to test it further.
----
New commits:



---

archive/issue_comments_312526.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-03T21:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312526",
    "user": "paulmasson"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_312527.json:
```json
{
    "body": "I suspect it might have been fixed if you made the string raw, i.e., use `r\"\"\"`.",
    "created_at": "2017-04-03T21:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312527",
    "user": "tscrim"
}
```

I suspect it might have been fixed if you made the string raw, i.e., use `r"""`.



---

archive/issue_comments_312528.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-07T22:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312528",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_312529.json:
```json
{
    "body": "See #25665 for a follow-up",
    "created_at": "2018-06-26T11:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22433",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22433#issuecomment-312529",
    "user": "jdemeyer"
}
```

See #25665 for a follow-up
