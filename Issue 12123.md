# Issue 12123: maple interface broken

Issue created by migration from Trac.

Original creator: sluther

Original creation time: 2012-01-11 13:46:21

Assignee: was


```
With sage-4.7 (and maple 14) it works:
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: maple('1+1')
2
sage:
| Sage Version 4.7, Release Date: 2011-05-23                         |
| Type notebook() for the GUI, and license() for information.        |

But with 4.7.2 all maple commands end in this traceback:

----------------------------------------------------------------------
----------------------------------------------------------------------
sage: maple('1+1')
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (17, 0))
| Sage Version 4.7.2, Release Date: 2011-10-29                       |
| Type notebook() for the GUI, and license() for information.        |
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)

/home/luther/<ipython console> in <module>()

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/IPython/Prompts.pyc in __call__(self, arg)
    550 
    551             # and now call a possibly user-defined print mechanism
--> 552             manipulated_val = self.display(arg)
    553             
    554             # user display hooks can change the variable to be stored in

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/IPython/Prompts.pyc in _display(self, arg)
    576             return IPython.generics.result_display(arg)
    577         except TryNext:            
--> 578             return self.shell.hooks.result_display(arg)
    579 
    580     # Assign the default display method:

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/IPython/hooks.pyc in __call__(self, *args, **kw)
    139             #print "prio",prio,"cmd",cmd #dbg
    140             try:
--> 141                 ret = cmd(*args, **kw)
    142                 return ret
    143             except ipapi.TryNext, exc:

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/misc/displayhook.pyc in result_display(ip_self, obj)
    148     # IPython's default result_display() uses the IPython.genutils.Term.cout stream.
    149     # See also local/lib/python2.6/site-packages/IPython/hooks.py.
--> 150     print_obj(IPython.genutils.Term.cout, obj)
    151 
    152 def displayhook(obj):

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/misc/displayhook.pyc in print_obj(out_stream, obj)
    140             if _check_tall_list_and_print(out_stream, obj):
    141                 return
--> 142     print >>out_stream, `obj`
    143 
    144 def result_display(ip_self, obj):

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/interfaces/maple.pyc in __repr__(self)
   1056         """
   1057         self._check_valid()
-> 1058         return self.parent().get(self._name)
   1059 
   1060     def _latex_(self):

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/interfaces/maple.pyc in get(self, var)
    609             '2'
    610         """
--> 611         s = self.eval('printf("%%q",%s)'%var)
    612         return s
    613 

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1034                 if (split_lines is "nofile" and allow_use_file and
   1035                         self._eval_using_file_cutoff and len(code) > self._eval_using_file_cutoff):
-> 1036                     return self._eval_line_using_file(code)
   1037                 elif split_lines:
   1038                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/interfaces/expect.pyc in _eval_line_using_file(self, line)
    653             tmp_to_use = self._remote_tmpfile()
    654         try:
--> 655             s = self._eval_line(self._read_in_file_command(tmp_to_use), allow_use_file=False)
    656         except pexpect.EOF, msg:
    657             if self._quit_string() in line:

/home/luther/sage-4.7.2-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/lib/python2.6/site-packages/sage/interfaces/maple.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt)
    559                 e.expect('__sage__;')
    560                 e.expect(self._prompt)            
--> 561                 raise RuntimeError, "An error occurred running a Maple command:\nINPUT:\n%s\nOUTPUT:\n%s"%(line, z)
    562         return z
    563 

RuntimeError: An error occurred running a Maple command:
INPUT:
read "/home/luther/.sage//temp/dirac/18306//interface//tmp18309";
OUTPUT:
on line 2, unexpected end of input
Error, while reading
`/home/luther/.sage//temp/dirac/18306//interface//tmp18309`
```



---

Comment by migeruhito created at 2013-02-15 15:38:44

* *Patch to apply:* trac-12295-maple_interface_20130115.patch
* *Versions:*
  * Sage 5.6
  * Maple 13
  * Linux Mint 14 cinnamon edition x86_64
* *Dependencies:* None
* *Causes:* 
  1. Maple command line interface automatically breaks input lines so pexpect interface sometimes fails (e.g. when the Sage user's home has a _long_ route).
  1. When this is fixed, a new bug appears because the method sage.interfaces.maple.Maple._eval_line_using_file did not manage the Maple's ";"-stuff.
  1. When these bugs are corrected, a new issue appears in sage.interfaces.maple.Maple._keyboard_interrupt. If we expect two maple prompts, the interface freezes when hitting ctrl-c once to stop a long calculation.
* *Fixes:*
  The Maple command passed to sage.interfaces.expect.Expect contains now a Maple configuration command.
    1. Now, Maple command line interface does not break input lines.
    1. When an Maple syntax error occurs, the command line interface does not enter in edit mode. Thus, we are not restricted to only use the expect file interface.
* *Additional changes:*
    1. The method sage.interfaces.maple.Maple.clear was modified to provide a standard way to eventually _clear_ a Maple variable.
    1. Some docstrings are changed to pass the doctests.
    1. A docstring is changed in sage.symbolic.integration.integral to pass the tests of Ticket #2120
* *Related tickets:* The issues of Tickets #2120 and #1465 could be also fixed with this patch, but not sure.
* *Tests passed:*
  {{{
  sage -coverage devel/sage-maple/sage/interfaces/maple.py
  sage -t -optional devel/sage-maple/sage/interfaces/maple.py
  sage -t --only-optional=maple devel/sage-maple/sage/interfaces/maple.py
  sage -t --only-optional=maple devel/sage/sage/symbolic/expression.pyx  
  sage -t --only-optional=maple devel/sage/sage/symbolic/integration/integral.py
  sage -t --only-optional=maple devel/sage/sage/calculus/calculus.py
  sage -t --only-optional=maple devel/sage/sage/misc/functional.py
  sage -t --only-optional=maple devel/sage/sage/tests/benchmark.py
  sage -t --only-optional=maple devel/sage/sage/interfaces/maple.py
  sage --testall --long
  sage -docbuild reference html
  sage -docbuild reference pdf
  }}}


---

Comment by migeruhito created at 2013-02-15 15:39:21

Fix Maple interface


---

Attachment

* trac-12295-maple_interface_20130115.patch works with Sage 5.6 and 5.7
 * trac-12295-maple_interface_20130321.patch is a similar patch but for Sage 5.8
 * trac-12295-maple_interface_5.9_20130614.patch is a similar patch but for Sage 5.9


---

Comment by kcrisman created at 2013-04-16 21:22:01

Please put your real name on both the patch and the ticket "Author" description.


---

Comment by kcrisman created at 2013-04-16 21:22:01

Changing status from new to needs_info.


---

Attachment

Maple interface fix for Sage 5.8


---

Comment by migeruhito created at 2013-06-14 17:01:09

Maple interface fix for Sage 5.9


---

Attachment


---

Comment by rws created at 2014-03-30 16:42:34

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2014-07-24 13:24:35

Changing keywords from "" to "maple interface".


---

Comment by chapoton created at 2014-07-24 13:24:35

Here is a git branch. Could somebody please have a look before it rosts ?
----
New commits:


---

Comment by migeruhito created at 2014-09-15 18:13:37

Branch u/chapoton/12295 merged with 6.3 sources.
Tested for Linux mint 17 and maple 13.
It works fine.


---

Comment by chapoton created at 2014-09-22 09:36:35

Would you give a positive review, then ?


---

Comment by migeruhito created at 2014-09-22 21:27:03

I have been successfully using the fix for more than a year.


---

Comment by chapoton created at 2014-09-23 07:45:09

Then could you please put this ticket in positive review, so that it can be closed ?


---

Comment by migeruhito created at 2014-09-23 07:53:16

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-09-23 07:53:58

Changing status from positive_review to needs_info.


---

Comment by kcrisman created at 2014-09-23 07:53:58

`@`chapoton:  Umm... Miguel **IS** the author!  So he definitely can't review it.  However, if it solves the problem for you as well (perhaps on a different platform? having someone test on Mac would be good) that would be great for positive review.  I'll put a note on sage-devel.


---

Comment by vbraun created at 2014-09-23 08:01:45

Why are those marked random? This should have deterministic output (depending on maple of course):

```
-        sage: g = maple(f); g                             # optional - maple
+        sage: g = maple(f); g                  # random ; optional - maple
         sin(x^2)+y^z
-        sage: g.integrate(x)                              # optional - maple
+        sage: g.integrate(x)                   # random ; optional - maple
         1/2*2^(1/2)*Pi^(1/2)*FresnelS(2^(1/2)/Pi^(1/2)*x)+y^z*x
```



---

Comment by migeruhito created at 2014-09-23 08:53:28

The order of the operands is session-dependent in maple. Sometimes the tests didn't passed due to this fact, when I performed them (long time ago). I know that this "random" setting makes the tests (mathematically) useless, but I don't know how to address this problem. Maybe now the test suite takes into account this issue.


---

Comment by mmezzarobba created at 2014-09-23 09:18:03

Replying to [comment:20 migeruhito]:
> The order of the operands is session-dependent in maple.

I believe starting maple with option `--setsort=1` and then calling (maple's) `sort()` on the result before sending it back to sage should make the output deterministic, at least on these examples.


---

Comment by migeruhito created at 2014-09-23 12:59:20

I performed my tests with maple 11. Prior to Maple 12, the only sort option available is session dependent, and I think `--setsort` option is not available at all. By including it, we will probably break the interface for older versions of maple. In the other hand, `--setsort=1` seems to be deterministic for these examples as mmezzarobba said, but it is the default from version 12. `sort()` is not necessary in this case.

I think that "random" must be removed from the tests and `--setsort=1` must not be added in the call parameters of the maple interface. Then, the status of the question would be:

* For Maple prior to v. 11, the tests will randomly pass.
* For Maple from v. 12, the tests will probably pass. (From Maple documentation:: "The --setsort=orderNumber option changes the sort order for Maple sets". I believe that maple expressions are ordered like sets, but not sure).


---

Comment by vbraun created at 2014-09-23 13:03:13

Sounds good to me.


---

Comment by mmezzarobba created at 2014-09-23 14:20:29

Replying to [comment:22 migeruhito]:
> I performed my tests with maple 11. Prior to Maple 12, the only sort option available is session dependent, and I think `--setsort` option is not available at all. By including it, we will probably break the interface for older versions of maple. In the other hand, `--setsort=1` seems to be deterministic for these examples as mmezzarobba said, but it is the default from version 12. `sort()` is not necessary in this case.

Yes, I forgot that `setsort=1` was in fact the default. However, while _sets_ are sorted by default under recent versions of Maple, it looks like expressions aren't. For example, with Maple 17, I get:

```
$ maple -t
#-->sin(x^2)+y^z;
sin(x^2)+y^z
#-->{sin(x^2),y^z};
{y^z, sin(x^2)}
#-->sort(%%);
y^z+sin(x^2)
```

So I would say that adding the command-line option is indeed not necessary, but we do need to call `sort()` to make the tests deterministic under Maple 12+.

> I believe that maple expressions are ordered like sets, but not sure).

Same for me.


---

Comment by git created at 2014-09-23 20:26:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-23 20:35:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-09-24 18:37:12

Is this ok like that ?

I regret that testing `optional=something` does not run the "not-optional" tests. This prevents from the `optional=maple` tests to pass for me in this ticket in the current state.

But the `optional=all` do pass (except for the mathematica optional ones, cause I do not have that.


---

Comment by chapoton created at 2014-09-24 18:37:12

Changing status from needs_info to needs_review.


---

Comment by vbraun created at 2014-09-24 19:10:32

You can run standard + optional maple tests with 

```
sage -t --optional=sage,maple src/sage/foo.py
```



---

Comment by vbraun created at 2014-09-25 12:13:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-27 12:57:12

Resolution: fixed
