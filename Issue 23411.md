# Issue 23411: Py3: TypeError from Cython string conversion

Issue created by migration from https://trac.sagemath.org/ticket/23648

Original creator: rws

Original creation time: 2017-08-19 07:51:25

CC:  chapoton embray

Keywords: Py3, cython

With Py3, as reported in https://github.com/pynac/pynac/issues/271

```
In [2]: import sage
In [3]: from sage.libs.pynac.constant import PynacConstant
In [4]: f = PynacConstant('foo', 'foo', 'real')
...
TypeError: expected bytes, str found
```

It's is in this part of the Sage-Pynac interface:

```
  /* "sage/libs/pynac/constant.pyx":68
 *             self.pointer = <GConstant *>&g_NaN
 *         else:
>>> *          self._object = new GConstant(name, ConstantEvalf, texname, domain)             # <<<<<<<<<<<<<<
 *             self.pointer = self._object
 * 
 */
  /*else*/ {
    __pyx_t_2 = __Pyx_PyObject_AsWritableString(__pyx_v_name); if (unlikely((!__pyx_t_2) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)
    __pyx_t_3 = __Pyx_PyObject_AsWritableString(__pyx_v_texname); if (unlikely((!__pyx_t_3) && PyErr_Occurred())) __PYX_ERR(0, 68, __pyx_L1_error)
    __pyx_v_self->_object = new constant(__pyx_t_2, ConstantEvalf, __pyx_t_3, __pyx_v_domain);
```

Apparently the error comes from this function (or below): https://github.com/cython/cython/blob/master/Cython/Utility/TypeConversion.c#L202


---

Comment by jdemeyer created at 2017-08-19 18:27:24

Changing component from cython to python3.


---

Comment by jdemeyer created at 2017-08-19 18:27:24

Changing keywords from "Py3, cython" to "Py3".


---

Comment by chapoton created at 2017-08-22 13:40:53

so this is not a cython problem ? where is the issue then ?


---

Comment by jdemeyer created at 2017-08-22 13:44:09

It's just your typical `unicode` vs. `bytes` issue. Some API expects `bytes` but is given `unicode` instead.


---

Comment by chapoton created at 2017-08-22 14:30:04

well, same kind of thing as here then ?

```
cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.Polrev()

cypari2/pari_instance.pyx in cypari2.pari_instance.get_var()

TypeError: string argument without an encoding
```

Hopefully this one will be fixed by #23518


---

Comment by chapoton created at 2017-09-10 16:36:21

Confirmed in the latest python3 build.

EDIT: And this is a major blocking point.


---

Comment by chapoton created at 2017-09-11 11:05:20

Changing status from new to needs_info.


---

Comment by rws created at 2017-09-12 05:46:49

Jeroen, can you please clarify where this should be fixed?


---

Comment by chapoton created at 2017-09-14 08:23:47

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2017-09-14 08:23:47

New commits:


---

Comment by jdemeyer created at 2017-09-14 08:37:00

1. Please remove `to_unicode = u`, that is not relevant here.

2. I suggest to use `sys.getfilesystemencoding()` instead of hard-coding UTF-8. The reason is that the conversions you are doing here are really analogous to the implicit `bytes <-> unicode` conversions that Python 3 does internally. In those cases, Python 3 mostly uses `sys.getfilesystemencoding()`.


---

Comment by jdemeyer created at 2017-09-14 08:39:22

3. Maybe renaming the function to `string_to_bytes` to make it clear that it accepts only string-like objects, it does not convert everything to `bytes`.

4. For efficiency, I would implement this in a Cython file as `cpdef` functions such that Cython code can benefit from fast calls. Maybe a new file like `src/sage/cpython/string.pyx`?


---

Comment by git created at 2017-09-14 08:44:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-14 13:02:17

Alternatively, you could directly implement conversion `char *` -> `str` (skipping the intermediate `bytes` step) using `PyUnicode_DecodeFSDefault` in Python 3.


---

Comment by chapoton created at 2017-09-20 09:53:10

How is your last comment related to #23857 ?

I am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?


---

Comment by jdemeyer created at 2017-09-20 12:31:44

Replying to [comment:14 chapoton]:
> How is your last comment related to #23857 ?

It is not strictly related to #23857. It is just that #23857 also fixes some `bytes` vs `str` bugs, but only for C++ code.


---

Comment by chapoton created at 2017-10-12 08:21:23

Replying to [comment:14 chapoton]:
> How is your last comment related to #23857 ?
> 
> I am not able to turn the branche here easily into a cpdef function. Could one of you do that please ?

***ping*** ?


---

Comment by jdemeyer created at 2017-10-13 15:24:08

Traceback please!


---

Comment by jdemeyer created at 2017-10-13 15:25:06

See also https://groups.google.com/d/msg/sage-devel/H0t9l6XdfPI/5ss5I5A4CAAJ


---

Comment by chapoton created at 2017-10-30 16:22:13

Changing keywords from "Py3" to "Py3, unicode".


---

Comment by chapoton created at 2017-10-31 15:47:46

Here is some traceback (using ipython3 with a failed python3-built):

```
In [3]: from sage.all import *
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-90a1b1fe16c5> in <module>()
----> 1 from sage.all import *

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/all.py in <module>()
    100 from sage.matrix.all     import *
    101 
--> 102 from sage.symbolic.all   import *
    103 from sage.modules.all    import *
    104 from sage.monoids.all    import *

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/all.py in <module>()
      5 
      6 from .ring import SR
----> 7 from .constants import (pi, e, NaN, golden_ratio, log2, euler_gamma, catalan,
      8                        khinchin, twinprime, mertens, glaisher)
      9 from .expression import Expression, solve_diophantine

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in <module>()
    842         return sympy.GoldenRatio
    843 
--> 844 golden_ratio = GoldenRatio().expression()
    845 
    846 class Log2(Constant):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name)
    772                            kash='(1+Sqrt(5))/2', giac='(1+sqrt(5))/2')
    773         Constant.__init__(self, name, conversions=conversions,
--> 774                           latex=r'\phi', domain='positive')
    775 
    776     def minpoly(self, bits=None, degree=None, epsilon=0):

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/symbolic/constants.py in __init__(self, name, conversions, latex, mathml, domain)
    286 
    287         from sage.libs.pynac.constant import PynacConstant
--> 288         self._pynac = PynacConstant(self._name, self._latex, self._domain)
    289         self._serial = self._pynac.serial()
    290         constants_table[self._serial] = self

/home/chapoton/sage3/src/sage/libs/pynac/constant.pyx in sage.libs.pynac.constant.PynacConstant.__cinit__ (build/cythonized/sage/libs/pynac/constant.cpp:2527)()

TypeError: expected bytes, str found
```



---

Comment by chapoton created at 2017-11-04 08:38:19

ping ?

Once again, I am not able to make a cpdef function, so please do that.


---

Comment by chapoton created at 2017-11-10 12:45:17

I have created a new ticket that just wants to introduce the conversion tools: #24186.


---

Comment by rws created at 2017-11-26 17:08:20

No patchbot on this until now, strange.


---

Comment by chapoton created at 2017-11-26 20:12:18

Authors field is empty..


---

Comment by jdemeyer created at 2017-11-28 12:35:36

This should use the functions introduced in #24222.


---

Comment by jdemeyer created at 2017-11-28 12:35:36

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-02-12 14:08:45

Let us close this one as invalid, please


---

Comment by chapoton created at 2018-02-12 14:08:45

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-12 14:14:59

Why? Is it already fixed?


---

Comment by chapoton created at 2018-02-12 14:17:29

It seems so. I am not able to reproduce that in ipython. And I am also currently no longer able to have a starting python3-sage, sadly.


---

Comment by rws created at 2018-02-12 15:44:47

So we need more info, no?


---

Comment by rws created at 2018-02-12 15:44:47

Changing status from needs_review to needs_info.


---

Comment by chapoton created at 2018-02-12 16:44:35

No, no need for more info. Maybe I was not clear enough.

Using an ipython shell, I can do exactly what I did in the first part of the ticket description. And there is no longer any failure. So the problem has been fixed somewhere in one of the previous py3 tickets.

Believe me, one should close this one and concentrate on the many other py3 tickets..


---

Comment by chapoton created at 2018-02-12 16:44:35

Changing status from needs_info to needs_review.


---

Comment by rws created at 2018-02-12 16:57:54

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-02-12 17:33:08

Indeed, this is fixed now.


---

Comment by embray created at 2018-02-12 17:33:08

Resolution: worksforme
