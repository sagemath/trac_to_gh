# Issue 20200: Misinstallation of Python in Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-04-13 13:57:46

CC:  tscrim gouezel jpflori

I've encountered yet another problem in my quest to get sage building on Cygwin.  I'm surprised this hasn't come up before though which makes me wonder if I'm doing something wrong.

The DLL loader library, libpython2.7.dll.a, gets installed to `$(SAGE_LOCAL)/lib/python2.7/config/` which is not normally on the ld search path (similar on Python 3 I think).

This means that when building extension modules `-lpython2.7` is actually linking against my system Python (in this case the Python that came with cygwin--also Python 2.7.10).  This is of course wrong, but isn't a problem for the majority of modules, including sage itself (at least it wasn't a problem for compiling).  It was actually PIL(low) where this fell apart because it used some `PyUnicode_` functions that were not found in my system libpython because it was compiled with `--enable-unicode=ucs2`, whereas Sage builds Python with `--enable-unicode=ucs4`.

When installing Python, Sage should be making a symlink to `$(SAGE_LOCAL)/lib/python2.7/config/libpython2.7.dll.a` in `$(SAGE_LOCAL)/lib`.

I'm leaning toward calling this an upstream bug--I don't understand why this isn't done automatically by Python's Makefile.  The relevant portion begins [here](https://hg.python.org/cpython/file/v2.7.10/Makefile.pre.in#l916).  It seems that if a DLL is built it _does not_ install a symlink to the loader library in lib/.

For reference, Cygwin's own system package for Python installs this symlink manually...


---

Comment by embray created at 2016-04-13 14:24:00

After applying the following patch, I rebuilt python2, and was subsequently able to build pillow:

```diff
diff --git a/build/pkgs/python2/spkg-install b/build/pkgs/python2/spkg-install
index db35674..b479ba3 100755
--- a/build/pkgs/python2/spkg-install
+++ b/build/pkgs/python2/spkg-install
`@``@` -129,6 +129,9 `@``@` fi
 if [ "$UNAME" = "Darwin" ] && \
     [ `uname -r | cut '-d.' -f1` -gt 9 ]; then
     rm -f "$SAGE_LOCAL/lib/python2.7/config/libpython2.7.a"
+elif [ "$UNAME" = "CYGWIN" ]; then
+    # See http://trac.sagemath.org/ticket/20437
+    ln -sf "python2.7/config/libpython2.7.dll.a" "$SAGE_LOCAL/lib/libpython2.7.dll.a"
 fi

 # Make sure extension modules were built correctly.

```


Should probably do the same for Python 3.


---

Comment by embray created at 2016-04-14 15:46:30

Added a patch for python2 and python2.  Basically the same as the above diff, but slightly enhanced to not use a hard-coded `pythonX.Y` version.
----
New commits:


---

Comment by embray created at 2016-04-14 15:46:30

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-04-14 17:40:07

Hi Eric,

only sided notes (as I am not a Cygwin guy):

- in the ticket, you should always fill the "Authors" field (with your full name). The reason is that patchbots completely ignore tickets where it is not set.

- in a commit it is standard to have one short line description, a linebreak and then an optional description. That way the history is much more readable (e.g. with `git log --oneline`).


---

Comment by embray created at 2016-04-15 12:00:08

Sounds reasonable.


---

Comment by embray created at 2016-04-15 12:04:59

Incidentally, is this documented somewhere?  I don't see anything about this use of the "Authors" field under http://doc.sagemath.org/html/en/developer/trac.html#section-trac-fields or here: https://wiki.sagemath.org/buildbot.  It would be nice if there were a single, easy to point to checklist for tickets--sort of a choose your own adventure story.


---

Comment by git created at 2016-04-15 12:08:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-04-22 12:23:03

Build passed--any comments?


---

Comment by jdemeyer created at 2016-04-22 12:33:06

One detail: you should quote `$SAGE_LOCAL/bin/python` as `"$SAGE_LOCAL/bin/python"` in case of funny characters in `$SAGE_LOCAL`.

Did you report this upstream? The "report upstream" field says "Not yet reported upstream; Will do shortly."


---

Comment by jdemeyer created at 2016-04-22 12:33:06

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-04-22 12:35:54

Replying to [comment:9 jdemeyer]:
> One detail: you should quote `$SAGE_LOCAL/bin/python` as `"$SAGE_LOCAL/bin/python"` in case of funny characters in `$SAGE_LOCAL`.

Sure.

> Did you report this upstream? The "report upstream" field says "Not yet reported upstream; Will do shortly."

I'll do that now.


---

Comment by git created at 2016-04-22 12:39:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-04-22 13:11:37

Changing status from needs_work to needs_review.


---

Comment by gouezel created at 2016-04-23 16:16:19

Works for me. You can set if to positive review in a few days, if there is no answer from upstream.


---

Comment by embray created at 2016-04-25 10:28:09

No response from python-dev yet. I only asked on the mailing list though--might get more response if I opened a bug report instead.  I was just being polite and not assuming it was definitely a bug :)

It's only Monday though, and early yet in the Americas so I'll wait a little longer.


---

Comment by embray created at 2016-06-23 15:23:45

I opened a bug report about this in Python, and included a patch: http://bugs.python.org/issue27374 as this is more likely to at least be acknowledged than my original mailing list post.

I wouldn't be surprised if this isn't acted on, or even if it is it won't be of any immediately help.  So it would be nice to go ahead and get this merged, given a positive review.


---

Comment by gouezel created at 2016-06-23 15:27:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-24 07:26:10

Resolution: fixed
