# Issue 32549: opportunistic caching of elliptic-curve and point orders

Issue created by migration from https://trac.sagemath.org/ticket/32786

Original creator: lorenz

Original creation time: 2021-10-28 06:28:04

CC:  defeo cremona

There are various places in the elliptic-curve code where we could reuse known information about curve and point orders:

- Isogeny codomains (Tate's theorem).
- Base-field extensions.
- Scalar multiplications (Lagrange's theorem).
- Possibly images of points under isogenies, but this is trickier (it requires `order_from_multiple` in general).

Moreover, `EllipticCurvePoint_finite_field` currently _uses_ its `_order` attribute whenever present, but the `.order()` method fails to actively cache `_order` after it's been computed.


---

Comment by lorenz created at 2021-10-28 06:59:31

Changing status from new to needs_review.


---

Comment by git created at 2021-10-28 08:11:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-10-28 12:24:27

Bot is green except for #32737.


---

Comment by git created at 2021-10-30 06:00:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-30 09:15:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-03 02:34:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-03 05:24:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-11 05:44:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2022-01-11 11:45:08

Member function in PARI/GP does not really exist. They only exist in the gp language. For cypari2, they are only available at C-level not from Python. Some of them are wrapped in cypari2 such as [bnf_get_fu](https://github.com/sagemath/cypari2/blob/master/cypari2/gen.pyx#L896). Could you open an issue for cypari2 with the list of member functions that would be desirable to have ? Note that we have a long standing issue about automation https://github.com/sagemath/cypari2/issues/51.


---

Comment by lorenz created at 2022-01-11 12:32:04

That particular comment was about the `no` member of elliptic curves over finite fields. But it looks like these wrappers provide read-only access (since they return copies), right? To make use of this here we'd need a way of setting the value.


---

Comment by git created at 2022-01-18 08:57:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-09 07:57:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-02-09 07:59:53

In any case, I don't really see a reason to wait with the changes here until cypari2 can do the thing we'd like. This patch already produces huge speedups: For example, one of my scripts (dealing with elliptic curves over a finite field of ~160 bits) runs in 9 seconds after the patch compared to 25 seconds before.


---

Comment by tscrim created at 2022-02-15 06:21:31

I agree that it would be good to take what we have in hand (since it is worth more than 2 improvements in the bush). My only comment would be why not use a `super()` call in `_acted_upon_` instead of manually building the action and calling that?


---

Comment by lorenz created at 2022-02-18 05:50:55

Sounds reasonable, but I can't get that to work without causing infinite recursions (the superclass ends up calling back into the `._acted_upon_()` method we're implementing). Did you have any specific way of doing this in mind?


---

Comment by tscrim created at 2022-02-18 06:10:09

Hmm...it seems like the action is implemented in a different way (the base class `_acted_upon_()` is the trivial one that returns `None`). Okay then, how about we directly get the action and use that:

```
Q = self.parent().get_action(ZZ, self_on_left=False)._act_(k, self)
```

This is more future proof in case a specialized action gets implemented (although it is effectively the same code).


---

Comment by lorenz created at 2022-02-18 14:46:30

Same issue: The `.get_action()` call rediscovers the method we're currently in (presumably by calling `.an_element()` on the types first?).

I suppose one thing we could do is to implement `._acted_upon_()` in a parent class of `EllipticCurvePoint_finite_field` and call that directly via `super()`, without going through the coercion system again. Would you prefer that over the current state of the code?


---

Comment by git created at 2022-02-21 06:47:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-22 05:27:24

Right...we are running into this problem because of how the action is implemented (in a very generic way) and this is the first non-generic version. No, this is good. I don't think we need to go to any great lengths for something that might be implemented in the future. Thank you.


---

Comment by tscrim created at 2022-02-22 05:27:24

Changing status from needs_review to positive_review.


---

Comment by lorenz created at 2022-02-22 05:38:12

Great, thank you!


---

Comment by vbraun created at 2022-03-01 21:31:10

Resolution: fixed
