# Issue 24795: Upgrade to MathJax 2.7.3

archive/issues_024795.json:
```json
{
    "body": "CC:  egourgoulhon embray fbissey jdemeyer jhpalmieri kcrisman mmarco novoselt schilly slelievre tmonteil vbraun\n\nKeywords: mathjax\n\nSince #19875, Sage ships MathJax 2.6.1.\n\n[MathJax 2.7.3 was released 2018-02-08](https://www.mathjax.org/news/).\n\nIt brings accessibility improvements, among other things.\n\nFor a more exhaustive list of changes, see the changelogs for\n[MathJax 2.7](https://www.mathjax.org/mathjax-v2-7-now-available/),\n[MathJax 2.7.1](https://www.mathjax.org/cdn-shutting-down/),\n[MathJax 2.7.2](https://www.mathjax.org/mathjax-v2-7-2-now-available/),\n[MathJax 2.7.3](https://www.mathjax.org/mathjax-v2-7-3-now-available/).\n\nIssue created by migration from https://trac.sagemath.org/ticket/25032\n\n",
    "created_at": "2018-03-25T15:45:22Z",
    "labels": [
        "packages: standard",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Upgrade to MathJax 2.7.3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24795",
    "user": "slelievre"
}
```
CC:  egourgoulhon embray fbissey jdemeyer jhpalmieri kcrisman mmarco novoselt schilly slelievre tmonteil vbraun

Keywords: mathjax

Since #19875, Sage ships MathJax 2.6.1.

[MathJax 2.7.3 was released 2018-02-08](https://www.mathjax.org/news/).

It brings accessibility improvements, among other things.

For a more exhaustive list of changes, see the changelogs for
[MathJax 2.7](https://www.mathjax.org/mathjax-v2-7-now-available/),
[MathJax 2.7.1](https://www.mathjax.org/cdn-shutting-down/),
[MathJax 2.7.2](https://www.mathjax.org/mathjax-v2-7-2-now-available/),
[MathJax 2.7.3](https://www.mathjax.org/mathjax-v2-7-3-now-available/).

Issue created by migration from https://trac.sagemath.org/ticket/25032





---

archive/issue_comments_348151.json:
```json
{
    "body": "Cc potentially interested developers.",
    "created_at": "2018-03-25T15:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348151",
    "user": "slelievre"
}
```

Cc potentially interested developers.



---

archive/issue_comments_348152.json:
```json
{
    "body": "On a related note,\n[open MathJax-related tickets](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~mathjax)\ncurrently include:\n\n- #24367 Confusing documentation on MathJax in light of use in Jupyter notebook\n- #22394 MathJax javascript loaded more than once\n- #18596 Don't strip MathJax fonts\n- #1608 Make optional spkg for MathJax png fonts",
    "created_at": "2018-03-25T15:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348152",
    "user": "slelievre"
}
```

On a related note,
[open MathJax-related tickets](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~mathjax)
currently include:

- #24367 Confusing documentation on MathJax in light of use in Jupyter notebook
- #22394 MathJax javascript loaded more than once
- #18596 Don't strip MathJax fonts
- #1608 Make optional spkg for MathJax png fonts



---

archive/issue_comments_348153.json:
```json
{
    "body": "See also\n[other open tickets whose description mentions MathJax](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&description=~mathjax&summary=!~mathjax), currently:\n\n- #25015 Improve introspection capabilities of Sage Jupyter Kernel\n- #23018 Jupyter notebook does not start browser after recent MacOS update\n- #22888 Option configuration from the Jupyter notebook's menus\n- #21943 Add plotting conventions to Developer Manual\n- #21591 Task ticket: Replace use of SAGE_ROOT by more specific environment variables\n- #13905 Dollar signs in documentation\n- #4355 Port latex/asciiArt output for tableaux and all friends from MuPAD-Combinat",
    "created_at": "2018-03-25T16:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348153",
    "user": "slelievre"
}
```

See also
[other open tickets whose description mentions MathJax](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&description=~mathjax&summary=!~mathjax), currently:

- #25015 Improve introspection capabilities of Sage Jupyter Kernel
- #23018 Jupyter notebook does not start browser after recent MacOS update
- #22888 Option configuration from the Jupyter notebook's menus
- #21943 Add plotting conventions to Developer Manual
- #21591 Task ticket: Replace use of SAGE_ROOT by more specific environment variables
- #13905 Dollar signs in documentation
- #4355 Port latex/asciiArt output for tableaux and all friends from MuPAD-Combinat



---

archive/issue_comments_348154.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-03-25T16:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348154",
    "user": "slelievre"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_348155.json:
```json
{
    "body": "Currently in the html doc there is a lot of duplication of the `_static` folders (it seems like some subsections are now links to the top one but still lots of duplicates). Each of these duplicate carries what seems to be an almost full copy of mathjax including fonts. It would be good if we could avoid all that copying. In sage-on-gentoo where we do ship the png fonts with mathjax that's quite a lot of files and space.",
    "created_at": "2018-03-25T20:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348155",
    "user": "fbissey"
}
```

Currently in the html doc there is a lot of duplication of the `_static` folders (it seems like some subsections are now links to the top one but still lots of duplicates). Each of these duplicate carries what seems to be an almost full copy of mathjax including fonts. It would be good if we could avoid all that copying. In sage-on-gentoo where we do ship the png fonts with mathjax that's quite a lot of files and space.



---

archive/issue_comments_348156.json:
```json
{
    "body": "I don't know if there is any way with Sphinx to automatically create these links, but we could do it ourselves in `src/sage_setup/docbuild/__init__.py` after building the documentation. That should be done independently from this ticket. See #25111.",
    "created_at": "2018-04-06T18:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348156",
    "user": "jhpalmieri"
}
```

I don't know if there is any way with Sphinx to automatically create these links, but we could do it ourselves in `src/sage_setup/docbuild/__init__.py` after building the documentation. That should be done independently from this ticket. See #25111.



---

archive/issue_comments_348157.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-05-23T02:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348157",
    "user": "jhpalmieri"
}
```

New commits:



---

archive/issue_comments_348158.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-23T02:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348158",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348159.json:
```json
{
    "body": "Just a question. I see there are two patches here that touch to some matter of configuration. I am wondering if instead of patching it could be moved to a local mathjax configuration inside the sage application itself.",
    "created_at": "2018-05-23T02:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348159",
    "user": "fbissey"
}
```

Just a question. I see there are two patches here that touch to some matter of configuration. I am wondering if instead of patching it could be moved to a local mathjax configuration inside the sage application itself.



---

archive/issue_comments_348160.json:
```json
{
    "body": "Good question. I just kept the old method (modifying one patch so that it still worked), and I haven't looked into that. I may try to investigate, but others should also feel free to do that.",
    "created_at": "2018-05-23T03:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348160",
    "user": "jhpalmieri"
}
```

Good question. I just kept the old method (modifying one patch so that it still worked), and I haven't looked into that. I may try to investigate, but others should also feel free to do that.



---

archive/issue_comments_348161.json:
```json
{
    "body": "One of the patches comes from #18577, which unfortunately includes no explicit examples with which to test, so I have no idea if any changes to that patch will break things.",
    "created_at": "2018-05-23T04:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348161",
    "user": "jhpalmieri"
}
```

One of the patches comes from #18577, which unfortunately includes no explicit examples with which to test, so I have no idea if any changes to that patch will break things.



---

archive/issue_comments_348162.json:
```json
{
    "body": "Theoretically, this might do the job:\n\n```diff\ndiff --git a/build/pkgs/mathjax/patches/extend_maxbuffer.patch b/build/pkgs/mathjax/patches/extend_maxbuffer.patch\ndeleted file mode 100644\nindex 0f96a9a477..0000000000\n--- a/build/pkgs/mathjax/patches/extend_maxbuffer.patch\n+++ /dev/null\n@@ -1,19 +0,0 @@\n-diff --git a/config/TeX-AMS_HTML-full.js.orig b/config/TeX-AMS_HTML-full.js\n-index c98695d..209f71b 100755\n---- a/config/TeX-AMS_HTML-full.js\n-+++ b/config/TeX-AMS_HTML-full.js\n-@@ -35,6 +35,14 @@ MathJax.Ajax.Preloading(\n-   \"[MathJax]/extensions/a11y/accessibility-menu.js\"\n- );\n- \n-+//  This extends the limit on the size of the string being processed by MathJax\n-+//  (whose aim is to avoid infinite loops) up to 50KB, see\n-+//  http://docs.mathjax.org/en/latest/options/TeX.html#the-tex-input-processor\n-+//\n-+//  See trac ticket #18577.\n-+//\n-+MathJax.Hub.Config({TeX: {MAXBUFFER: 50*1024,},});\n-+\n- MathJax.Hub.Config({\n-   extensions: ['[a11y]/accessibility-menu.js']\n- });\ndiff --git a/build/pkgs/mathjax/patches/nopng_config.patch b/build/pkgs/mathjax/patches/nopng_config.patch\ndeleted file mode 100644\nindex eceec63062..0000000000\n--- a/build/pkgs/mathjax/patches/nopng_config.patch\n+++ /dev/null\n@@ -1,12 +0,0 @@\n-diff --git a/config/default.js b/config/default.js\n---- a/config/default.js\n-+++ b/config/default.js\n-@@ -693,7 +693,7 @@ MathJax.Hub.Config({\n-     //  will be required to to download and install either the STIX fonts or the\n-     //  MathJax TeX fonts.\n-     //\n--    imageFont: \"TeX\",\n-+    imageFont: null,\n-     \n-     //\n-     //  This is the font-family CSS value used for characters that are not\ndiff --git a/src/doc/common/themes/sage/static/mathjax_sage.js_t b/src/doc/common/themes/sage/static/mathjax_sage.js_t\nindex adafad53b3..b261f2265a 100644\n--- a/src/doc/common/themes/sage/static/mathjax_sage.js_t\n+++ b/src/doc/common/themes/sage/static/mathjax_sage.js_t\n@@ -10,6 +10,8 @@ MathJax.Hub.Config({\n     }\n   },\n   TeX: {\n+    MAXBUFFER: 50*1024,\n+\n     Macros: {\n      {{ theme_mathjax_macros|join(',\\n') }}\n     }\n```\n\nRegarding the patch which changes `imageFont`, `imageFont` is already set in `mathjax_sage.js_t`, and I hope that's good enough.",
    "created_at": "2018-05-23T04:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348162",
    "user": "jhpalmieri"
}
```

Theoretically, this might do the job:

```diff
diff --git a/build/pkgs/mathjax/patches/extend_maxbuffer.patch b/build/pkgs/mathjax/patches/extend_maxbuffer.patch
deleted file mode 100644
index 0f96a9a477..0000000000
--- a/build/pkgs/mathjax/patches/extend_maxbuffer.patch
+++ /dev/null
@@ -1,19 +0,0 @@
-diff --git a/config/TeX-AMS_HTML-full.js.orig b/config/TeX-AMS_HTML-full.js
-index c98695d..209f71b 100755
---- a/config/TeX-AMS_HTML-full.js
-+++ b/config/TeX-AMS_HTML-full.js
-@@ -35,6 +35,14 @@ MathJax.Ajax.Preloading(
-   "[MathJax]/extensions/a11y/accessibility-menu.js"
- );
- 
-+//  This extends the limit on the size of the string being processed by MathJax
-+//  (whose aim is to avoid infinite loops) up to 50KB, see
-+//  http://docs.mathjax.org/en/latest/options/TeX.html#the-tex-input-processor
-+//
-+//  See trac ticket #18577.
-+//
-+MathJax.Hub.Config({TeX: {MAXBUFFER: 50*1024,},});
-+
- MathJax.Hub.Config({
-   extensions: ['[a11y]/accessibility-menu.js']
- });
diff --git a/build/pkgs/mathjax/patches/nopng_config.patch b/build/pkgs/mathjax/patches/nopng_config.patch
deleted file mode 100644
index eceec63062..0000000000
--- a/build/pkgs/mathjax/patches/nopng_config.patch
+++ /dev/null
@@ -1,12 +0,0 @@
-diff --git a/config/default.js b/config/default.js
---- a/config/default.js
-+++ b/config/default.js
-@@ -693,7 +693,7 @@ MathJax.Hub.Config({
-     //  will be required to to download and install either the STIX fonts or the
-     //  MathJax TeX fonts.
-     //
--    imageFont: "TeX",
-+    imageFont: null,
-     
-     //
-     //  This is the font-family CSS value used for characters that are not
diff --git a/src/doc/common/themes/sage/static/mathjax_sage.js_t b/src/doc/common/themes/sage/static/mathjax_sage.js_t
index adafad53b3..b261f2265a 100644
--- a/src/doc/common/themes/sage/static/mathjax_sage.js_t
+++ b/src/doc/common/themes/sage/static/mathjax_sage.js_t
@@ -10,6 +10,8 @@ MathJax.Hub.Config({
     }
   },
   TeX: {
+    MAXBUFFER: 50*1024,
+
     Macros: {
      {{ theme_mathjax_macros|join(',\n') }}
     }
```

Regarding the patch which changes `imageFont`, `imageFont` is already set in `mathjax_sage.js_t`, and I hope that's good enough.



---

archive/issue_comments_348163.json:
```json
{
    "body": "I say we should try it like that. We shouldn't patch when we can configure.",
    "created_at": "2018-05-23T08:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348163",
    "user": "fbissey"
}
```

I say we should try it like that. We shouldn't patch when we can configure.



---

archive/issue_comments_348164.json:
```json
{
    "body": "With that experimental patch, everything builds and things seem to work: if I disable my internet connection, I can still build and view the documentation, and see LaTeX displayed in the Jupyter notebook. So I will push those changes here.",
    "created_at": "2018-05-23T14:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348164",
    "user": "jhpalmieri"
}
```

With that experimental patch, everything builds and things seem to work: if I disable my internet connection, I can still build and view the documentation, and see LaTeX displayed in the Jupyter notebook. So I will push those changes here.



---

archive/issue_comments_348165.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-23T14:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348165",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_348166.json:
```json
{
    "body": "does somebody here have an idea for #22431#comment:36 ?",
    "created_at": "2018-05-23T15:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348166",
    "user": "chapoton"
}
```

does somebody here have an idea for #22431#comment:36 ?



---

archive/issue_comments_348167.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-23T21:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348167",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348168.json:
```json
{
    "body": "Let's move this on.",
    "created_at": "2018-05-23T21:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348168",
    "user": "fbissey"
}
```

Let's move this on.



---

archive/issue_comments_348169.json:
```json
{
    "body": "Author name...",
    "created_at": "2018-05-24T22:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348169",
    "user": "vbraun"
}
```

Author name...



---

archive/issue_comments_348170.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-24T22:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348170",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_348171.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-05-25T01:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348171",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_348172.json:
```json
{
    "body": "Is there some trac plugin that will prevent a positive review unless the author name and reviewer name are present? I should know better, of course, but Volker shouldn't have to spend his time doing this.",
    "created_at": "2018-05-25T01:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348172",
    "user": "jhpalmieri"
}
```

Is there some trac plugin that will prevent a positive review unless the author name and reviewer name are present? I should know better, of course, but Volker shouldn't have to spend his time doing this.



---

archive/issue_comments_348173.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-27T17:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24795#issuecomment-348173",
    "user": "vbraun"
}
```

Resolution: fixed
