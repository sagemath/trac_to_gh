# Issue 24795: Upgrade to MathJax 2.7.3

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2018-03-25 15:45:22

CC:  egourgoulhon embray fbissey jdemeyer jhpalmieri kcrisman mmarco novoselt schilly slelievre tmonteil vbraun

Keywords: mathjax

Since #19875, Sage ships MathJax 2.6.1.

[MathJax 2.7.3 was released 2018-02-08](https://www.mathjax.org/news/).

It brings accessibility improvements, among other things.

For a more exhaustive list of changes, see the changelogs for
[MathJax 2.7](https://www.mathjax.org/mathjax-v2-7-now-available/),
[MathJax 2.7.1](https://www.mathjax.org/cdn-shutting-down/),
[MathJax 2.7.2](https://www.mathjax.org/mathjax-v2-7-2-now-available/),
[MathJax 2.7.3](https://www.mathjax.org/mathjax-v2-7-3-now-available/).


---

Comment by slelievre created at 2018-03-25 15:47:29

Cc potentially interested developers.


---

Comment by slelievre created at 2018-03-25 15:58:23

On a related note,
[open MathJax-related tickets](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~mathjax)
currently include:

- #24367 Confusing documentation on MathJax in light of use in Jupyter notebook
- #22394 MathJax javascript loaded more than once
- #18596 Don't strip MathJax fonts
- #1608 Make optional spkg for MathJax png fonts


---

Comment by slelievre created at 2018-03-25 16:03:04

See also
[other open tickets whose description mentions MathJax](https://trac.sagemath.org/query?order=id&desc=1&status=!closed&description=~mathjax&summary=!~mathjax), currently:

- #25015 Improve introspection capabilities of Sage Jupyter Kernel
- #23018 Jupyter notebook does not start browser after recent MacOS update
- #22888 Option configuration from the Jupyter notebook's menus
- #21943 Add plotting conventions to Developer Manual
- #21591 Task ticket: Replace use of SAGE_ROOT by more specific environment variables
- #13905 Dollar signs in documentation
- #4355 Port latex/asciiArt output for tableaux and all friends from MuPAD-Combinat


---

Comment by slelievre created at 2018-03-25 16:03:04

Changing type from PLEASE CHANGE to enhancement.


---

Comment by fbissey created at 2018-03-25 20:22:07

Currently in the html doc there is a lot of duplication of the `_static` folders (it seems like some subsections are now links to the top one but still lots of duplicates). Each of these duplicate carries what seems to be an almost full copy of mathjax including fonts. It would be good if we could avoid all that copying. In sage-on-gentoo where we do ship the png fonts with mathjax that's quite a lot of files and space.


---

Comment by jhpalmieri created at 2018-04-06 18:51:13

I don't know if there is any way with Sphinx to automatically create these links, but we could do it ourselves in `src/sage_setup/docbuild/__init__.py` after building the documentation. That should be done independently from this ticket. See #25111.


---

Comment by jhpalmieri created at 2018-05-23 02:08:41

New commits:


---

Comment by jhpalmieri created at 2018-05-23 02:08:41

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-05-23 02:18:25

Just a question. I see there are two patches here that touch to some matter of configuration. I am wondering if instead of patching it could be moved to a local mathjax configuration inside the sage application itself.


---

Comment by jhpalmieri created at 2018-05-23 03:53:24

Good question. I just kept the old method (modifying one patch so that it still worked), and I haven't looked into that. I may try to investigate, but others should also feel free to do that.


---

Comment by jhpalmieri created at 2018-05-23 04:01:32

One of the patches comes from #18577, which unfortunately includes no explicit examples with which to test, so I have no idea if any changes to that patch will break things.


---

Comment by jhpalmieri created at 2018-05-23 04:27:26

Theoretically, this might do the job:

```diff
diff --git a/build/pkgs/mathjax/patches/extend_maxbuffer.patch b/build/pkgs/mathjax/patches/extend_maxbuffer.patch
deleted file mode 100644
index 0f96a9a477..0000000000
--- a/build/pkgs/mathjax/patches/extend_maxbuffer.patch
+++ /dev/null
`@``@` -1,19 +0,0 `@``@`
-diff --git a/config/TeX-AMS_HTML-full.js.orig b/config/TeX-AMS_HTML-full.js
-index c98695d..209f71b 100755
---- a/config/TeX-AMS_HTML-full.js
-+++ b/config/TeX-AMS_HTML-full.js
-`@``@` -35,6 +35,14 `@``@` MathJax.Ajax.Preloading(
-   "[MathJax]/extensions/a11y/accessibility-menu.js"
- );
- 
-+//  This extends the limit on the size of the string being processed by MathJax
-+//  (whose aim is to avoid infinite loops) up to 50KB, see
-+//  http://docs.mathjax.org/en/latest/options/TeX.html#the-tex-input-processor
-+//
-+//  See trac ticket #18577.
-+//
-+MathJax.Hub.Config({TeX: {MAXBUFFER: 50*1024,},});
-+
- MathJax.Hub.Config({
-   extensions: ['[a11y]/accessibility-menu.js']
- });
diff --git a/build/pkgs/mathjax/patches/nopng_config.patch b/build/pkgs/mathjax/patches/nopng_config.patch
deleted file mode 100644
index eceec63062..0000000000
--- a/build/pkgs/mathjax/patches/nopng_config.patch
+++ /dev/null
`@``@` -1,12 +0,0 `@``@`
-diff --git a/config/default.js b/config/default.js
---- a/config/default.js
-+++ b/config/default.js
-`@``@` -693,7 +693,7 `@``@` MathJax.Hub.Config({
-     //  will be required to to download and install either the STIX fonts or the
-     //  MathJax TeX fonts.
-     //
--    imageFont: "TeX",
-+    imageFont: null,
-     
-     //
-     //  This is the font-family CSS value used for characters that are not
diff --git a/src/doc/common/themes/sage/static/mathjax_sage.js_t b/src/doc/common/themes/sage/static/mathjax_sage.js_t
index adafad53b3..b261f2265a 100644
--- a/src/doc/common/themes/sage/static/mathjax_sage.js_t
+++ b/src/doc/common/themes/sage/static/mathjax_sage.js_t
`@``@` -10,6 +10,8 `@``@` MathJax.Hub.Config({
     }
   },
   TeX: {
+    MAXBUFFER: 50*1024,
+
     Macros: {
      {{ theme_mathjax_macros|join(',\n') }}
     }
```

Regarding the patch which changes `imageFont`, `imageFont` is already set in `mathjax_sage.js_t`, and I hope that's good enough.


---

Comment by fbissey created at 2018-05-23 08:33:17

I say we should try it like that. We shouldn't patch when we can configure.


---

Comment by jhpalmieri created at 2018-05-23 14:53:22

With that experimental patch, everything builds and things seem to work: if I disable my internet connection, I can still build and view the documentation, and see LaTeX displayed in the Jupyter notebook. So I will push those changes here.


---

Comment by git created at 2018-05-23 14:54:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-05-23 15:44:48

does somebody here have an idea for #22431#comment:36 ?


---

Comment by fbissey created at 2018-05-23 21:03:51

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-05-23 21:03:51

Let's move this on.


---

Comment by vbraun created at 2018-05-24 22:29:58

Author name...


---

Comment by vbraun created at 2018-05-24 22:29:58

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2018-05-25 01:22:27

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2018-05-25 01:23:41

Is there some trac plugin that will prevent a positive review unless the author name and reviewer name are present? I should know better, of course, but Volker shouldn't have to spend his time doing this.


---

Comment by vbraun created at 2018-05-27 17:01:20

Resolution: fixed
