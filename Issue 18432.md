# Issue 18432: Use PARI to compute rational_diagonal_form()

Issue created by migration from https://trac.sagemath.org/ticket/18669

Original creator: jdemeyer

Original creation time: 2015-06-10 20:02:51

PARI is literally orders of magnitude faster at this.

Note: if you want to use this function on input of moderate to large size (say, dimension > 100), you will need #18435 which reduces the memory consumption of `qfgaussred`.


---

Comment by git created at 2015-06-11 10:00:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-11 11:18:14

Changing status from new to needs_review.


---

Comment by mmarco created at 2015-07-12 11:42:59

Are you sure it always works as expected?

BEfore your changes, we have:


```
sage: Q = matrix(QQ,[[0,1],[1,0]])
sage: F = QuadraticForm(Q)
sage: F.rational_diagonal_form()
Quadratic form in 2 variables over Rational Field with coefficients: 
[ 1 0 ]
[ * -1/4 ]
```


But if we try to do what you propose:


```
sage: Q = matrix(QQ,[[0,1],[1,0]])
sage: F = QuadraticForm(Q)
sage: F.rational_diagonal_form()
Quadratic form in 2 variables over Rational Field with coefficients: 
[ 1 0 ]
[ * -1/4 ]
sage: F._pari_()
[0, 1; 1, 0]
sage: F._pari_().qfgaussred()
[1/2, 1; -1, -1/2]
sage: MS = MatrixSpace(QQ,2,2)
sage: D = MS()
sage: D[0,0] = R[0,0]
sage: D[1,1] = R[1,1]
sage: Q.parent()(D)
[ 1/2    0]
[   0 -1/2]

```



---

Comment by jdemeyer created at 2015-07-12 12:52:49

The rational diagonal form is far from unique, so there is no contradiction.

The quadratic form corresponding to

```
[ 1/2    0]
[   0 -1/2]
```

is

```
Quadratic form in 2 variables over Rational Field with coefficients: 
[ 1/4 0 ]
[ * 1/4 ]
```

which is equivalent to the old result (just rescale the first vector by a factor 2).


---

Comment by mmarco created at 2015-07-12 15:30:11

Ok, i guess i forgot the theory about diagonal forms. It is supposed to be the equivalent to gramm-schmidt form, right?


Anyways, i am having trouble compiling your branch.


---

Comment by jdemeyer created at 2015-07-12 15:41:29

Replying to [comment:7 mmarco]:
> Ok, i guess i forgot the theory about diagonal forms.
In short, given a matrix `A`, you want to find some matrix `X` such that `X^t A X` is a diagonal matrix. There is no guarantee made about which matrix `X` and which diagonal matrix it returns.

> It is supposed to be the equivalent to gramm-schmidt form, right?
I don't really know what you mean.


---

Comment by mmarco created at 2015-07-12 16:53:11

I get the following error while compiling your branch:


```
...
[ 26/416] Cythonizing sage/libs/flint/arith.pyx

Error compiling Cython file:
------------------------------------------------------------
...
include 'sage/ext/interrupt.pxi'

from libc.stdint cimport uint8_t

...
```



---

Comment by jdemeyer created at 2015-07-12 20:35:20

Replying to [comment:9 mmarco]:
> I get the following error while compiling your branch:
> 
> {{{
> ...
> [ 26/416] Cythonizing sage/libs/flint/arith.pyx
> 
> Error compiling Cython file:
> ------------------------------------------------------------
> ...
> include 'sage/ext/interrupt.pxi'
> 
> from libc.stdint cimport uint8_t
> 
> ...
> }}}
That doesn't look like an error message, can you give a bit more context (the lines you removed with `...`)?

And just to be clear: the command which fails is `make`?


---

Attachment

I attached a longer log with the output of the "make" command.


---

Comment by jdemeyer created at 2015-07-13 18:07:53

OK, I know that problem. It was a known issue with some earlier beta, but fixed in #18851. If you merge `6.8.beta8`, the problem will go away.


---

Comment by jdemeyer created at 2015-08-30 10:45:06

Needs rebasing. I will wait for that until #18656 is reviewed.


---

Comment by jdemeyer created at 2015-08-30 10:45:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-10-28 11:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-10-28 11:29:40

Changing status from needs_work to needs_review.


---

Comment by tgaona created at 2015-12-02 17:26:16

Changing status from needs_review to positive_review.


---

Comment by tgaona created at 2015-12-02 17:26:42

Tests passed and it looks good to me.


---

Comment by vbraun created at 2015-12-03 23:23:20

Resolution: fixed
