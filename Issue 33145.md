# Issue 33145: Improve handling of default arguments in interacts library

Issue created by migration from https://trac.sagemath.org/ticket/33382

Original creator: @tobiasdiez

Original creation time: 2022-02-19 19:45:52

CC:  mkoeppe chapoton slelievre klee

While working on using pytest for doctesting, I encountered the following error, which is triggered by the import of `interacts.all`:

```
sage/interacts/all.py:20: in <module>
from . import calculus
sage/interacts/calculus.py:19: in <module>
from .library import taylor_polynomial
sage/interacts/library.py:1030: in <module>
interval_g = input_grid(1,2,default=[[0,8]], label="keyboard: "),
sage/repl/ipython_kernel/widgets_sagenb.py:559: in input_grid
grid = Grid(nrows, ncols, make_widget, **kwds)
sage/repl/ipython_kernel/widgets.py:430: in init
self._update()
sage/repl/ipython_kernel/widgets.py:456: in _update
v[i].append(col.children[i].get_interact_value())
sage/repl/ipython_kernel/widgets.py:154: in get_interact_value
v = self.get_value()
sage/repl/ipython_kernel/widgets.py:196: in get_value
return sage_eval(self.value, get_globals())
sage/repl/user_globals.py:99: in get_globals
_check()
sage/repl/user_globals.py:82: in _check
raise RuntimeError(
E RuntimeError: the user-space globals dictionary has not been initialized. Use initialize_globals() or set_globals() or use a different function which doesn't need these globals
```

The reason for this error is that `interacts.all` imports `interacts/library`, which contains a few methods whose default arguments call methods that have sideeffects (or at least require a certain initialization to happen first). This is fixed by moving the default argument calculation to the body of the method, which I would say is good practice anyway for more involved default arguments. As a nice plus, the startup time of sage is minimally decreased as importing `interacts.all` is now less involved.


---

Comment by @tobiasdiez created at 2022-02-19 19:46:05

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-02-19 20:24:07

Looks like you made all default arguments 1-element tuples, that's probably from copy+paste+black


---

Comment by mkoeppe created at 2022-02-19 20:24:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-23 22:46:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-23 22:46:49

Thanks for spotting this. Was indeed a stupid copy & paste error.


---

Comment by @tobiasdiez created at 2022-02-23 22:46:49

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-24 02:25:00

Patchbot shows failures


---

Comment by mkoeppe created at 2022-02-24 02:25:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-01 12:52:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-01 12:57:31

Should work now.


---

Comment by @tobiasdiez created at 2022-03-01 12:57:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-01 17:31:23

``@`library_interact` is part of the public API; can it still be used in the old way?


---

Comment by @tobiasdiez created at 2022-03-01 18:25:11

Replying to [comment:8 mkoeppe]:
> ``@`library_interact` is part of the public API; can it still be used in the old way?

No, I couldn't come up with a way that would be backwards compatible. I think this shouldn't really be a problem since it's clearly a local helper method (and should probably not even be exposed).


---

Comment by mkoeppe created at 2022-03-01 18:39:43

It's public API. If you can't keep it compatible, create a function with a new name and deprecate the old function.


---

Comment by @tobiasdiez created at 2022-03-01 19:10:26

Any suggestions for a good new name?


---

Comment by git created at 2022-03-02 12:14:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-02 12:15:19

Replying to [comment:8 mkoeppe]:
> ``@`library_interact` is part of the public API; can it still be used in the old way?

I've now found a way to add backwards compatibility of the `library_interact` decorator.


---

Comment by slelievre created at 2022-03-02 14:40:03

I think this test block needs a blank line here:

```diff
     TESTS:
+
     Backwards compatibility::
```



---

Comment by git created at 2022-03-02 16:09:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-02 16:11:14

Thanks, fixed!

Btw, is it on purpose that there doesn't exist an entry for `interacts` in the documentation?


---

Comment by slelievre created at 2022-03-02 16:16:19

Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),
it seems there are two documents:

- [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)
- [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)


---

Comment by slelievre created at 2022-03-02 16:18:53

One can also inspect the output of

```
sage: search_src('interact')
sage: search_doc('interact')
sage: search_def('interact')
```



---

Comment by @tobiasdiez created at 2022-03-02 16:22:31

Replying to [comment:18 slelievre]:
> Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),
> it seems there are two documents:
> 
> - [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)
> - [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)

Thanks! What I meant is that there is no entry under the "Reference manual" https://doc.sagemath.org/html/en/reference/index.html


---

Comment by slelievre created at 2022-03-02 16:40:28

True, that page has a section "User interfaces" with two headings:

- "Command Line Interface", which under "Miscellaneous" has links to
  "Interacts", "Widgets", and a few other Jupyter-related things
- "Jupyter Notebook Interface", which points straight to the official
  Jupyter Notebook documentation

That could probably be improved.


---

Comment by mkoeppe created at 2022-03-04 05:52:25

Wondering if the use of `lambda` is going to create a problem for pickling the interacts.
But it looks like this may already be broken for stock ipywidgets interacts -  https://github.com/jupyter-widgets/ipywidgets/issues/2879


---

Comment by @tobiasdiez created at 2022-03-20 17:53:36

Replying to [comment:21 slelievre]:
> That could probably be improved.

Thanks for the clarification, let's do this in a follow-up ticket.

Anything else to do here?


---

Comment by @tobiasdiez created at 2022-04-08 21:25:20

Ping


---

Comment by @tobiasdiez created at 2022-05-08 09:13:04

Could this ticket please be reviewed? Thanks!


---

Comment by mkoeppe created at 2022-05-08 12:51:39

LGTM


---

Comment by mkoeppe created at 2022-05-08 12:51:39

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-05-08 21:01:24

Thanks!


---

Comment by vbraun created at 2022-05-20 22:27:17

Resolution: fixed
