# Issue 33145: Improve handling of default arguments in interacts library

archive/issues_033145.json:
```json
{
    "body": "CC:  @mkoeppe @fchapoton @slel @kwankyu\n\nWhile working on using pytest for doctesting, I encountered the following error, which is triggered by the import of `interacts.all`:\n\n```\nsage/interacts/all.py:20: in <module>\nfrom . import calculus\nsage/interacts/calculus.py:19: in <module>\nfrom .library import taylor_polynomial\nsage/interacts/library.py:1030: in <module>\ninterval_g = input_grid(1,2,default=[[0,8]], label=\"keyboard: \"),\nsage/repl/ipython_kernel/widgets_sagenb.py:559: in input_grid\ngrid = Grid(nrows, ncols, make_widget, **kwds)\nsage/repl/ipython_kernel/widgets.py:430: in init\nself._update()\nsage/repl/ipython_kernel/widgets.py:456: in _update\nv[i].append(col.children[i].get_interact_value())\nsage/repl/ipython_kernel/widgets.py:154: in get_interact_value\nv = self.get_value()\nsage/repl/ipython_kernel/widgets.py:196: in get_value\nreturn sage_eval(self.value, get_globals())\nsage/repl/user_globals.py:99: in get_globals\n_check()\nsage/repl/user_globals.py:82: in _check\nraise RuntimeError(\nE RuntimeError: the user-space globals dictionary has not been initialized. Use initialize_globals() or set_globals() or use a different function which doesn't need these globals\n```\n\nThe reason for this error is that `interacts.all` imports `interacts/library`, which contains a few methods whose default arguments call methods that have sideeffects (or at least require a certain initialization to happen first). This is fixed by moving the default argument calculation to the body of the method, which I would say is good practice anyway for more involved default arguments. As a nice plus, the startup time of sage is minimally decreased as importing `interacts.all` is now less involved.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33382\n\n",
    "created_at": "2022-02-19T19:45:52Z",
    "labels": [
        "interact",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Improve handling of default arguments in interacts library",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33145",
    "user": "@tobiasdiez"
}
```
CC:  @mkoeppe @fchapoton @slel @kwankyu

While working on using pytest for doctesting, I encountered the following error, which is triggered by the import of `interacts.all`:

```
sage/interacts/all.py:20: in <module>
from . import calculus
sage/interacts/calculus.py:19: in <module>
from .library import taylor_polynomial
sage/interacts/library.py:1030: in <module>
interval_g = input_grid(1,2,default=[[0,8]], label="keyboard: "),
sage/repl/ipython_kernel/widgets_sagenb.py:559: in input_grid
grid = Grid(nrows, ncols, make_widget, **kwds)
sage/repl/ipython_kernel/widgets.py:430: in init
self._update()
sage/repl/ipython_kernel/widgets.py:456: in _update
v[i].append(col.children[i].get_interact_value())
sage/repl/ipython_kernel/widgets.py:154: in get_interact_value
v = self.get_value()
sage/repl/ipython_kernel/widgets.py:196: in get_value
return sage_eval(self.value, get_globals())
sage/repl/user_globals.py:99: in get_globals
_check()
sage/repl/user_globals.py:82: in _check
raise RuntimeError(
E RuntimeError: the user-space globals dictionary has not been initialized. Use initialize_globals() or set_globals() or use a different function which doesn't need these globals
```

The reason for this error is that `interacts.all` imports `interacts/library`, which contains a few methods whose default arguments call methods that have sideeffects (or at least require a certain initialization to happen first). This is fixed by moving the default argument calculation to the body of the method, which I would say is good practice anyway for more involved default arguments. As a nice plus, the startup time of sage is minimally decreased as importing `interacts.all` is now less involved.

Issue created by migration from https://trac.sagemath.org/ticket/33382





---

archive/issue_comments_472240.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-19T19:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472240",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_472241.json:
```json
{
    "body": "Looks like you made all default arguments 1-element tuples, that's probably from copy+paste+black",
    "created_at": "2022-02-19T20:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472241",
    "user": "@mkoeppe"
}
```

Looks like you made all default arguments 1-element tuples, that's probably from copy+paste+black



---

archive/issue_comments_472242.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-19T20:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472242",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_472243.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-23T22:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472243",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472244.json:
```json
{
    "body": "Thanks for spotting this. Was indeed a stupid copy & paste error.",
    "created_at": "2022-02-23T22:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472244",
    "user": "@tobiasdiez"
}
```

Thanks for spotting this. Was indeed a stupid copy & paste error.



---

archive/issue_comments_472245.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-23T22:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472245",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_472246.json:
```json
{
    "body": "Patchbot shows failures",
    "created_at": "2022-02-24T02:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472246",
    "user": "@mkoeppe"
}
```

Patchbot shows failures



---

archive/issue_comments_472247.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-24T02:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472247",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_472248.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-01T12:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472248",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472249.json:
```json
{
    "body": "Should work now.",
    "created_at": "2022-03-01T12:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472249",
    "user": "@tobiasdiez"
}
```

Should work now.



---

archive/issue_comments_472250.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-01T12:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472250",
    "user": "@tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_472251.json:
```json
{
    "body": "``@`library_interact` is part of the public API; can it still be used in the old way?",
    "created_at": "2022-03-01T17:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472251",
    "user": "@mkoeppe"
}
```

``@`library_interact` is part of the public API; can it still be used in the old way?



---

archive/issue_comments_472252.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> ``@`library_interact` is part of the public API; can it still be used in the old way?\n\nNo, I couldn't come up with a way that would be backwards compatible. I think this shouldn't really be a problem since it's clearly a local helper method (and should probably not even be exposed).",
    "created_at": "2022-03-01T18:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472252",
    "user": "@tobiasdiez"
}
```

Replying to [comment:8 mkoeppe]:
> ``@`library_interact` is part of the public API; can it still be used in the old way?

No, I couldn't come up with a way that would be backwards compatible. I think this shouldn't really be a problem since it's clearly a local helper method (and should probably not even be exposed).



---

archive/issue_comments_472253.json:
```json
{
    "body": "It's public API. If you can't keep it compatible, create a function with a new name and deprecate the old function.",
    "created_at": "2022-03-01T18:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472253",
    "user": "@mkoeppe"
}
```

It's public API. If you can't keep it compatible, create a function with a new name and deprecate the old function.



---

archive/issue_comments_472254.json:
```json
{
    "body": "Any suggestions for a good new name?",
    "created_at": "2022-03-01T19:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472254",
    "user": "@tobiasdiez"
}
```

Any suggestions for a good new name?



---

archive/issue_comments_472255.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T12:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472255",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472256.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> ``@`library_interact` is part of the public API; can it still be used in the old way?\n\nI've now found a way to add backwards compatibility of the `library_interact` decorator.",
    "created_at": "2022-03-02T12:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472256",
    "user": "@tobiasdiez"
}
```

Replying to [comment:8 mkoeppe]:
> ``@`library_interact` is part of the public API; can it still be used in the old way?

I've now found a way to add backwards compatibility of the `library_interact` decorator.



---

archive/issue_comments_472257.json:
```json
{
    "body": "I think this test block needs a blank line here:\n\n```diff\n     TESTS:\n+\n     Backwards compatibility::\n```\n",
    "created_at": "2022-03-02T14:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472257",
    "user": "@slel"
}
```

I think this test block needs a blank line here:

```diff
     TESTS:
+
     Backwards compatibility::
```




---

archive/issue_comments_472258.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T16:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472258",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_472259.json:
```json
{
    "body": "Thanks, fixed!\n\nBtw, is it on purpose that there doesn't exist an entry for `interacts` in the documentation?",
    "created_at": "2022-03-02T16:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472259",
    "user": "@tobiasdiez"
}
```

Thanks, fixed!

Btw, is it on purpose that there doesn't exist an entry for `interacts` in the documentation?



---

archive/issue_comments_472260.json:
```json
{
    "body": "Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),\nit seems there are two documents:\n\n- [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)\n- [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)",
    "created_at": "2022-03-02T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472260",
    "user": "@slel"
}
```

Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),
it seems there are two documents:

- [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)
- [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)



---

archive/issue_comments_472261.json:
```json
{
    "body": "One can also inspect the output of\n\n```\nsage: search_src('interact')\nsage: search_doc('interact')\nsage: search_def('interact')\n```\n",
    "created_at": "2022-03-02T16:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472261",
    "user": "@slel"
}
```

One can also inspect the output of

```
sage: search_src('interact')
sage: search_doc('interact')
sage: search_def('interact')
```




---

archive/issue_comments_472262.json:
```json
{
    "body": "Replying to [comment:18 slelievre]:\n> Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),\n> it seems there are two documents:\n> \n> - [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)\n> - [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)\n\nThanks! What I meant is that there is no entry under the \"Reference manual\" https://doc.sagemath.org/html/en/reference/index.html",
    "created_at": "2022-03-02T16:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472262",
    "user": "@tobiasdiez"
}
```

Replying to [comment:18 slelievre]:
> Based on [a quick websearch](https://duckduckgo.com/?q=interact+site%3Adoc.sagemath.org),
> it seems there are two documents:
> 
> - [SageMath reference manual: Interacts for the Sage Jupyter notebook](https://doc.sagemath.org/html/en/reference/repl/sage/repl/ipython_kernel/interact.html)
> - [SageMath tutorials: Sage Interact Quickstart](https://doc.sagemath.org/html/en/prep/Quickstarts/Interact.html)

Thanks! What I meant is that there is no entry under the "Reference manual" https://doc.sagemath.org/html/en/reference/index.html



---

archive/issue_comments_472263.json:
```json
{
    "body": "True, that page has a section \"User interfaces\" with two headings:\n\n- \"Command Line Interface\", which under \"Miscellaneous\" has links to\n  \"Interacts\", \"Widgets\", and a few other Jupyter-related things\n- \"Jupyter Notebook Interface\", which points straight to the official\n  Jupyter Notebook documentation\n\nThat could probably be improved.",
    "created_at": "2022-03-02T16:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472263",
    "user": "@slel"
}
```

True, that page has a section "User interfaces" with two headings:

- "Command Line Interface", which under "Miscellaneous" has links to
  "Interacts", "Widgets", and a few other Jupyter-related things
- "Jupyter Notebook Interface", which points straight to the official
  Jupyter Notebook documentation

That could probably be improved.



---

archive/issue_comments_472264.json:
```json
{
    "body": "Wondering if the use of `lambda` is going to create a problem for pickling the interacts.\nBut it looks like this may already be broken for stock ipywidgets interacts -  https://github.com/jupyter-widgets/ipywidgets/issues/2879",
    "created_at": "2022-03-04T05:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472264",
    "user": "@mkoeppe"
}
```

Wondering if the use of `lambda` is going to create a problem for pickling the interacts.
But it looks like this may already be broken for stock ipywidgets interacts -  https://github.com/jupyter-widgets/ipywidgets/issues/2879



---

archive/issue_comments_472265.json:
```json
{
    "body": "Replying to [comment:21 slelievre]:\n> That could probably be improved.\n\nThanks for the clarification, let's do this in a follow-up ticket.\n\nAnything else to do here?",
    "created_at": "2022-03-20T17:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472265",
    "user": "@tobiasdiez"
}
```

Replying to [comment:21 slelievre]:
> That could probably be improved.

Thanks for the clarification, let's do this in a follow-up ticket.

Anything else to do here?



---

archive/issue_comments_472266.json:
```json
{
    "body": "Ping",
    "created_at": "2022-04-08T21:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472266",
    "user": "@tobiasdiez"
}
```

Ping



---

archive/issue_comments_472267.json:
```json
{
    "body": "Could this ticket please be reviewed? Thanks!",
    "created_at": "2022-05-08T09:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472267",
    "user": "@tobiasdiez"
}
```

Could this ticket please be reviewed? Thanks!



---

archive/issue_comments_472268.json:
```json
{
    "body": "LGTM",
    "created_at": "2022-05-08T12:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472268",
    "user": "@mkoeppe"
}
```

LGTM



---

archive/issue_comments_472269.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-05-08T12:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472269",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_472270.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-05-08T21:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472270",
    "user": "@tobiasdiez"
}
```

Thanks!



---

archive/issue_comments_472271.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-05-20T22:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33145",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33145#issuecomment-472271",
    "user": "@vbraun"
}
```

Resolution: fixed
