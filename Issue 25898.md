# Issue 25898: py3: bug in givaro finite fields

Issue created by migration from https://trac.sagemath.org/ticket/26135

Original creator: chapoton

Original creation time: 2018-08-26 16:12:45

namely

```
sage: x=GF(9,'a').one()
sage: type(x)
<class 'sage.rings.finite_rings.element_givaro.FiniteField_givaroElement'>
sage: x.trace()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-20-402afa39b97f> in <module>()
----> 1 x.trace()

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/element_base.pyx in sage.rings.finite_rings.element_base.FinitePolyExtElement.trace (build/cythonized/sage/rings/finite_rings/element_base.c:8221)()
    481             2
    482         """
--> 483         return self.parent().prime_subfield()(self.__pari__().trace().lift())
    484 
    485     def multiplicative_order(self):

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/element_base.pyx in sage.rings.finite_rings.element_base.FinitePolyExtElement.__pari__ (build/cythonized/sage/rings/finite_rings/element_base.c:6958)()
    332         from sage.libs.pari.all import pari
    333         ffgen = self._parent.modulus()._pari_with_name(var).ffgen()
--> 334         polypari = self.polynomial()._pari_with_name()
    335         # Add ffgen - ffgen to ensure that we really get an FFELT
    336         return polypari.subst("x", ffgen) + ffgen - ffgen

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/element_givaro.pyx in sage.rings.finite_rings.element_givaro.FiniteField_givaroElement.polynomial (build/cythonized/sage/rings/finite_rings/element_givaro.cpp:15456)()
   1527             return PolynomialRing(K.prime_subfield(), name)(ret)
   1528         else:
-> 1529             return K.polynomial_ring()(ret)
   1530 
   1531     def _magma_init_(self, magma):

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)()
    919         if mor is not None:
    920             if no_extra_args:
--> 921                 return mor._call_(x)
    922             else:
    923                 return mor._call_with_args(x, args, kwds)

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)()
    143                 print(type(C), C)
    144                 print(type(C._element_constructor), C._element_constructor)
--> 145             raise
    146 
    147     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)()
    138         cdef Parent C = self._codomain
    139         try:
--> 140             return C._element_constructor(x)
    141         except Exception:
    142             if print_warnings:

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring.py in _element_constructor_(self, x, check, is_gen, construct, **kwds)
    405         C = self.element_class
    406         if isinstance(x, (list, tuple)):
--> 407             return C(self, x, check=check, is_gen=False, construct=construct)
    408         if isinstance(x, range):
    409             return C(self, list(x), check=check, is_gen=False,

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_zmod_flint.pyx in sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_zmod_flint.cpp:14399)()
     98             k = parent._base
     99             if check:
--> 100                 lst = [k(i) for i in x]
    101             else:
    102                 lst = x

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)()
    919         if mor is not None:
    920             if no_extra_args:
--> 921                 return mor._call_(x)
    922             else:
    923                 return mor._call_with_args(x, args, kwds)

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)()
    143                 print(type(C), C)
    144                 print(type(C._element_constructor), C._element_constructor)
--> 145             raise
    146 
    147     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4442)()
    138         cdef Parent C = self._codomain
    139         try:
--> 140             return C._element_constructor(x)
    141         except Exception:
    142             if print_warnings:

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/integer_mod_ring.py in _element_constructor_(self, x)
   1168         """
   1169         try:
-> 1170             return integer_mod.IntegerMod(self, x)
   1171         except (NotImplementedError, PariError):
   1172             raise TypeError("error coercing to finite field")

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/integer_mod.pyx in sage.rings.finite_rings.integer_mod.IntegerMod (build/cythonized/sage/rings/finite_rings/integer_mod.c:4585)()
    195             return a
    196     t = modulus.element_class()
--> 197     return t(parent, value)
    198 
    199 

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/finite_rings/integer_mod.pyx in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.__init__ (build/cythonized/sage/rings/finite_rings/integer_mod.c:5858)()
    364             return
    365         else:
--> 366             z = sage.rings.integer_ring.Z(value)
    367         self.set_from_mpz(z.value)
    368 

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9679)()
    919         if mor is not None:
    920             if no_extra_args:
--> 921                 return mor._call_(x)
    922             else:
    923                 return mor._call_with_args(x, args, kwds)

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4574)()
    143                 print(type(C), C)
    144                 print(type(C._element_constructor), C._element_constructor)
--> 145             raise
    146 
    147     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4436)()
    138         cdef Parent C = self._codomain
    139         try:
--> 140             return C._element_constructor(x)
    141         except Exception:
    142             if print_warnings:

/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6099)()
    686                     mpz_set_pylong(self.value, n)
    687                 else:
--> 688                     raise TypeError("Cannot convert non-integral float to integer")
    689 
    690             elif isinstance(x, pari_gen):

TypeError: Cannot convert non-integral float to integer
```



---

Comment by chapoton created at 2018-08-26 16:14:34

Same traceback with just

```
sage: x.__pari__()
```



---

Comment by chapoton created at 2018-08-26 16:20:19

Same traceback with

```
sage: x.polynomial()
```



---

Comment by chapoton created at 2018-08-26 16:26:05

culprit found and fixed, please review
----
New commits:


---

Comment by chapoton created at 2018-08-26 16:26:05

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-08-26 16:26:24

Changing component from PLEASE CHANGE to python3.


---

Comment by chapoton created at 2018-08-26 16:27:34

Changing keywords from "" to "division".


---

Comment by tscrim created at 2018-08-27 01:47:33

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-08-27 01:47:33

Changing type from PLEASE CHANGE to defect.


---

Comment by tscrim created at 2018-08-27 01:47:33

LGTM


---

Comment by vbraun created at 2018-08-30 22:24:26

Resolution: fixed
