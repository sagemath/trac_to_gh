# Issue 12227: Get pycrypto to build on FreeBSD

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2012-01-31 02:13:28

Assignee: pjeremy

CC:  pjeremy jpflori

Stephen Montgomery-Smith reports:

```
OK, I started working on building sage.  So far I can get all the spkg's to build except:

gap-4.4.12.p6
pycrypto-2.1.0
singular-3-1-3-3.p3
maxima-5.23.2.p3
sage-4.8

The build problem with pycrypto-2.1.0 and singular-3-1-3-3.p3 are easy to fix.  
```

The patch is apparently

```

--- pycrypto-2.1.0/src/src/libtom/tomcrypt_pk.h-orig	2012-01-21 19:43:56.000000000 +0000
+++ pycrypto-2.1.0/src/src/libtom/tomcrypt_pk.h	2012-01-21 19:45:01.000000000 +0000
`@``@` -496,7 +496,7 `@``@`
 int der_printable_value_decode(int v);
 
 /* UTF-8 */
-#if (defined(SIZE_MAX) || __STDC_VERSION__ >= 199901L || defined(WCHAR_MAX) || defined(_WCHAR_T) || defined(_WCHAR_T_DEFINED)) && !defined(LTC_NO_WCHAR)
+#if (defined(SIZE_MAX) || __STDC_VERSION__ >= 199901L || defined(WCHAR_MAX) || defined(_WCHAR_T) || defined(_WCHAR_T_DEFINED) || defined(_GCC_WCHAR_T)) && !defined(LTC_NO_WCHAR)
 #include <wchar.h>
 #else
 typedef ulong32 wchar_t;
```



---

Comment by stephen created at 2012-04-08 14:43:54

I can confirm that this ticket is still required for building sage with FreeBSD.  It should be harmless to all other OS builds.

Add a new file patches/src.libtom.tomcrypt_pk.h (you will have to add the patches directory as well)

```
--- src/src/libtom/tomcrypt_pk.h-orig	2012-01-21 19:43:56.000000000 +0000
+++ src/src/libtom/tomcrypt_pk.h	2012-01-21 19:45:01.000000000 +0000
`@``@` -496,7 +496,7 `@``@`
 int der_printable_value_decode(int v);
 
 /* UTF-8 */
-#if (defined(SIZE_MAX) || __STDC_VERSION__ >= 199901L || defined(WCHAR_MAX) || defined(_WCHAR_T) || defined(_WCHAR_T_DEFINED)) && !defined(LTC_NO_WCHAR)
+#if (defined(SIZE_MAX) || __STDC_VERSION__ >= 199901L || defined(WCHAR_MAX) || defined(_WCHAR_T) || defined(_WCHAR_T_DEFINED) || defined(_GCC_WCHAR_T)) && !defined(LTC_NO_WCHAR)
 #include <wchar.h>
 #else
 typedef ulong32 wchar_t;
```


and patch spkg-install as follows:


```
--- pycrypto-2.1.0/spkg-install-orig	2012-04-08 01:30:47.000000000 +0000
+++ pycrypto-2.1.0/spkg-install	2012-04-08 01:31:41.000000000 +0000
`@``@` -12,6 +12,8 `@``@`
     LDFLAGS="-m64 "; export LDFLAGS
 fi
 
+patch -p0 < patches/src.libtom.tomcrypt_pk.h
+
 CFLAGS="-I$SAGE_LOCAL/include -L$SAGE_LOCAL/lib $CFLAGS"
 export CFLAGS
 
```



---

Comment by stephen created at 2012-04-14 03:42:22

I erased this comment and the following comment as they were wrong.


---

Comment by kcrisman created at 2012-06-20 19:13:01

All that's needed here is a new spkg with an spkg-install that checks whether the patch was applied correctly.


---

Comment by jpflori created at 2013-04-05 11:31:54

The fix is still needed and let pycrypto build on FreeBSD 9.0 x86.
I'll package a spkg this weekend.


---

Comment by jpflori created at 2013-07-04 20:53:13

Changing status from new to needs_review.


---

Comment by jpflori created at 2013-07-04 20:53:13

The week-end was kind of long.
Uploaded a simple spkg.

Follow up ticket to upgrade pycrypto at #14854.
Note the patch should still be needed.
The patched file did not change.
Time for an upstream bug report I guess.


---

Comment by jpflori created at 2013-07-04 20:53:13

Changing keywords from "" to "spkg pycrypto".


---

Attachment

Spkg diff, for review only.


---

Comment by jpflori created at 2013-12-25 16:32:51

I've made a git branch and reported upstream at:
* https://bugs.launchpad.net/pycrypto/+bug/1264130


---

Comment by git created at 2013-12-25 16:36:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2013-12-26 14:49:55

Resolution: fixed
