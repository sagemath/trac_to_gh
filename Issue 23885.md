# Issue 23885: Use echelonize instead of echelon_form in __invert__

archive/issues_023885.json:
```json
{
    "body": "We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24122\n\n",
    "created_at": "2017-10-30T00:12:49Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Use echelonize instead of echelon_form in __invert__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23885",
    "user": "tscrim"
}
```
We do not need to create another copy of the augmented matrix to keep memory usage down (including putting it in a cache) and because it is faster.

Issue created by migration from https://trac.sagemath.org/ticket/24122





---

archive/issue_comments_334794.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334794",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_334795.json:
```json
{
    "body": "Bad branch not based off `develop`. Fixed.",
    "created_at": "2017-10-30T00:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334795",
    "user": "tscrim"
}
```

Bad branch not based off `develop`. Fixed.



---

archive/issue_comments_334796.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-30T00:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334796",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_334797.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-31T02:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334797",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334798.json:
```json
{
    "body": "Changing component from linear algebra to performance.",
    "created_at": "2017-10-31T02:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334798",
    "user": "tscrim"
}
```

Changing component from linear algebra to performance.



---

archive/issue_comments_334799.json:
```json
{
    "body": "This last change nets me ~8% speedup:\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 159 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 28.6 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\nThe slowest run took 24.10 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.27 ms per loop\n```\n\nversus\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 167 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 30.7 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\n1000 loops, best of 3: 1.36 ms per loop\n```\n",
    "created_at": "2017-10-31T02:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334799",
    "user": "tscrim"
}
```

This last change nets me ~8% speedup:

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 159 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 28.6 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
The slowest run took 24.10 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.27 ms per loop
```

versus

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 167 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 30.7 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
1000 loops, best of 3: 1.36 ms per loop
```




---

archive/issue_comments_334800.json:
```json
{
    "body": "Also versus `develop`, which this test is not so good for showing how the first change would improve things as the matrices are relatively tiny:\n\n```\nsage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)\n10 loops, best of 3: 171 ms per loop\nsage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)\n10 loops, best of 3: 30.2 ms per loop\nsage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)\nThe slowest run took 11.65 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.3 ms per loop\n```\n",
    "created_at": "2017-10-31T02:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334800",
    "user": "tscrim"
}
```

Also versus `develop`, which this test is not so good for showing how the first change would improve things as the matrices are relatively tiny:

```
sage: %timeit ~(matrix({(200-i,i): 1/i for i in range(1,200,1)}, sparse=True) + 1)
10 loops, best of 3: 171 ms per loop
sage: %timeit ~(matrix({(100-i,i): 1/i for i in range(1,100,1)}, sparse=True) + 1)
10 loops, best of 3: 30.2 ms per loop
sage: %timeit ~(matrix({(20-i,i): 1/i for i in range(1,20,1)}, sparse=True) + 1)
The slowest run took 11.65 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.3 ms per loop
```




---

archive/issue_comments_334801.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-01T06:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334801",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334802.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-09T00:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334802",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_334803.json:
```json
{
    "body": "This is a bit weird\n\n```\n+        for i in range(nrows):\n+            del data[i,i]\n+        data = {(r,c-nrows): data[r,c] for (r,c) in data}\n```\n\nYou are modifying `data` and then override it. If you can not do the modification inplace, the following looks simpler\n\n```\ndata = {(r,c-nrows): data[r,c] for (r,c) in data if c >= nrows}\n```\n",
    "created_at": "2017-11-10T19:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334803",
    "user": "vdelecroix"
}
```

This is a bit weird

```
+        for i in range(nrows):
+            del data[i,i]
+        data = {(r,c-nrows): data[r,c] for (r,c) in data}
```

You are modifying `data` and then override it. If you can not do the modification inplace, the following looks simpler

```
data = {(r,c-nrows): data[r,c] for (r,c) in data if c >= nrows}
```




---

archive/issue_comments_334804.json:
```json
{
    "body": "Yes, it looks more simple, but it actually takes longer because it has to do the `if` check on every nonzero object. Whereas the version I have just removes objects from the `dict`. I suspect this is more of a micro improvement, but that could be a lot of extra checks for a really big sparse matrix (at least, I have a 62001 x 62001 sparse matrix with 1756951 non-zero entries).\n\nIdeally I would like to modify the data in place and just update the indices, but hash tables are not good for doing that. One of these days, someone (me) should implement another data structure for sparse matrices...",
    "created_at": "2017-11-10T23:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334804",
    "user": "tscrim"
}
```

Yes, it looks more simple, but it actually takes longer because it has to do the `if` check on every nonzero object. Whereas the version I have just removes objects from the `dict`. I suspect this is more of a micro improvement, but that could be a lot of extra checks for a really big sparse matrix (at least, I have a 62001 x 62001 sparse matrix with 1756951 non-zero entries).

Ideally I would like to modify the data in place and just update the indices, but hash tables are not good for doing that. One of these days, someone (me) should implement another data structure for sparse matrices...



---

archive/issue_comments_334805.json:
```json
{
    "body": "Oh, I see.\n\nNote that for matrices over ZZ or QQ, there is a custom C datatype which is an array of sparse vectors. This is not ideal but already faster than dictionaries in most contexts.",
    "created_at": "2017-11-11T10:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334805",
    "user": "vdelecroix"
}
```

Oh, I see.

Note that for matrices over ZZ or QQ, there is a custom C datatype which is an array of sparse vectors. This is not ideal but already faster than dictionaries in most contexts.



---

archive/issue_comments_334806.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-12T20:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334806",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_334807.json:
```json
{
    "body": "Thanks for the review.",
    "created_at": "2017-11-12T22:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334807",
    "user": "tscrim"
}
```

Thanks for the review.



---

archive/issue_comments_334808.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23885#issuecomment-334808",
    "user": "vbraun"
}
```

Resolution: fixed
