# Issue 19525: Ncurses fails to build with gcc-5.2.1

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-12-23 08:55:09


```
gcc -DHAVE_CONFIG_H -I../ncurses -I../../ncurses -I. -I../include -I../../ncurses/..
/include -I/home/ralf/sage/local/include  -D_GNU_SOURCE -DNDEBUG -O2 --param max-inl
ine-insns-single=1200 -fPIC -c ../../ncurses/base/lib_getstr.c -o ../obj_s/lib_getst
r.o 
_31612.c:837:22: error: expected ')' before 'int' 
Makefile:1340: recipe for target '../obj_s/lib_gen.o' failed
```


See https://bbs.archlinux.org/viewtopic.php?id=194029&p=3

"The fix is to add -P to the preprocessor invocation."


---

Comment by jdemeyer created at 2015-12-23 09:09:12

`gcc -dumpversion` and `gcc --version` please...


---

Comment by vbraun created at 2015-12-23 11:09:52

I've been using gcc-5.3.1 to build Sage for a while now, for the record


---

Comment by leif created at 2015-12-23 12:19:56

Changing status from new to needs_info.


---

Comment by leif created at 2015-12-23 12:19:56

Changing component from build: configure to packages: standard.


---

Comment by rws created at 2015-12-23 13:29:42

Replying to [comment:1 jdemeyer]:
> `gcc -dumpversion` and `gcc --version` please...
`5` and `gcc (SUSE Linux) 5.2.1 20150721 [gcc-5-branch revision 226027]`.


---

Comment by leif created at 2015-12-23 13:40:48

Changing status from needs_info to needs_work.


---

Comment by leif created at 2015-12-23 13:40:48

Trivial to fix, but I'd say that's an upstream SuSE bug (the output of `gcc -dumpversion`).


---

Comment by jdemeyer created at 2015-12-23 13:43:07

Just `5`? Interesting...


---

Comment by leif created at 2015-12-23 13:44:09

P.S.:  We could just "invert" the check and add `-P` if the output *doesn't* match `4.*`, say.


---

Comment by leif created at 2015-12-23 13:46:46

... or even apply the patch (add `-P`) unconditionally, since suppressing line numbers there doesn't really hurt.


---

Comment by rws created at 2015-12-23 13:53:01

NOTE: the same happens with `gcc (SUSE Linux) 5.3.1 20151207 [gcc-5-branch revision 231355]` and `sage -p ncurses`. When I try to install the tarball on my system manually with `configure/make` it stops with

```
In file included from ../ncurses/curses.priv.h:321:0,
                 from ../ncurses/lib_gen.c:19:
_14788.c:837:15: error: expected ‘)’ before ‘int’
../include/curses.h:1622:56: note: in definition of macro ‘mouse_trafo’
 #define mouse_trafo(y,x,to_screen) wmouse_trafo(stdscr,y,x,to_screen)
                                                        ^
Makefile:958: recipe for target '../objects/lib_gen.o' failed
```

The same with ncurses-5.9 from the net but not with 6.0.

Setting `export CFLAGS="-P"` before configure of 5.9 will NOT work. I confirm that by giving the compile command and output together:

```
gcc -DHAVE_CONFIG_H -I../ncurses -I.  -D_GNU_SOURCE -DNDEBUG -I. -I../include -P  --param max-inline-insns-single=1200 -c ../ncurses/./base/lib_getch.c -o ../objects/lib_getch.o
In file included from ../ncurses/curses.priv.h:283:0,
                 from ../ncurses/lib_gen.c:19:
_1284.c:835:15: error: expected ‘)’ before ‘int’
../include/curses.h:1594:56: note: in definition of macro ‘mouse_trafo’
 #define mouse_trafo(y,x,to_screen) wmouse_trafo(stdscr,y,x,to_screen)
                                                        ^
Makefile:790: recipe for target '../objects/lib_gen.o' failed
```



---

Comment by jdemeyer created at 2015-12-23 13:53:15

Replying to [comment:8 leif]:
> ... or even apply the patch (add `-P`) unconditionally, since suppressing line numbers there doesn't really hurt.

If that works, I'd vote for that.


---

Comment by rws created at 2015-12-23 14:01:26

Ah ok `CPPFLAGS` not `CFLAGS` should have `-P`.


---

Comment by leif created at 2015-12-23 14:04:14

Replying to [comment:10 jdemeyer]:
> Replying to [comment:8 leif]:
> > ... or even apply the patch (add `-P`) unconditionally, since suppressing line numbers there doesn't really hurt.
> 
> If that works, I'd vote for that.

We should just keep the comment on _why_ we're doing that; if we one day upgrade ncurses, we can remove the patch, but there were other reasons to not upgrade to an ncurses version fixing _this_ issue.


---

Comment by leif created at 2015-12-23 14:08:47

`@`Ralf: You can just modify `build/pkgs/ncurses/patches/work_around_changed_output_of_GNU_cpp_5.x.patch `...


---

Comment by rws created at 2015-12-23 14:31:40

Replying to [comment:14 leif]:
> `@`Ralf: You can just modify `build/pkgs/ncurses/patches/work_around_changed_output_of_GNU_cpp_5.x.patch `...
Now it fails with

```
gcc ../obj_s/tic.o ../obj_s/dump_entry.o ../obj_s/transform.o -L../lib -Wl,-rpath,/h
ome/ralf/sage/local/lib -Wl,-rpath,/home/ralf/sage/local/lib64  -I../progs -I../../p
rogs -DHAVE_CONFIG_H -I. -I../include -I../../progs/../include -I/home/ralf/sage/loc
al/include -P -D_GNU_SOURCE -DNDEBUG -O2 --param max-inline-insns-single=1200 -fPIC  -L../lib  -lncursesw -ltinfow    -o tic
../lib/libncursesw.so: undefined reference to `waddnwstr'
../lib/libncursesw.so: undefined reference to `wbkgrndset'
../lib/libncursesw.so: undefined reference to `wadd_wchnstr'
../lib/libncursesw.so: undefined reference to `wbkgrnd'
collect2: error: ld returned 1 exit status
Makefile:244: recipe for target 'tic' failed
```



---

Comment by leif created at 2015-12-23 14:33:12

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-12-23 14:36:58

Changing status from needs_review to positive_review.


---

Comment by rws created at 2015-12-23 14:36:58

Any hint on the second problem? I get only one fitting link: https://github.com/martanne/dvtm/issues/2


---

Comment by leif created at 2015-12-23 14:40:05

Replying to [comment:17 rws]:
> Any hint on the second problem?

How exactly did you get that?


---

Comment by rws created at 2015-12-23 16:12:19

Replying to [comment:18 leif]:
> Replying to [comment:17 rws]:
> > Any hint on the second problem?
> 
> How exactly did you get that?
Both with your patch and with `export CPPFLAGS="-P"` then configure/make.


---

Comment by vbraun created at 2015-12-24 23:46:38

Resolution: fixed
