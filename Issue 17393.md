# Issue 17393: Further clean up of ATLAS (or equivalent BLAS) linking

archive/issues_017393.json:
```json
{
    "body": "CC:  jdemeyer vbraun fbissey\n\nDifferent pkgs find ATLAS (or equivalent libs e.g. on OS X and Cygwin) libs in different ways.\nIn particular the situation is broken on Cygwin.\n\nThe one we tweak ourselves are:\n* ATLAS when we pass SAGE_ATLAS_LIB to decide what to copy/symlink\n* fflas-ffpack\n* iml\n* the Sage library through SAGE_BLAS and module_list.py and its BLAS/BLAS2 madness\nOther pkgs depend on a BLAS implem but are autonomous.\n\nMy proposal before a pkgconfig solution gets available at #17075 is that when ATLAS spkg-install script is run it decides what should be used once and for all and other packages use this information (like used to be done a little bit when the linbox spkg-install script wrote `echo $LINBOX_BLAS > $SAGE_LOCAL/share/cblas_config`)\n\nIssue created by migration from https://trac.sagemath.org/ticket/17630\n\n",
    "created_at": "2015-01-13T18:13:23Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Further clean up of ATLAS (or equivalent BLAS) linking",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17393",
    "user": "jpflori"
}
```
CC:  jdemeyer vbraun fbissey

Different pkgs find ATLAS (or equivalent libs e.g. on OS X and Cygwin) libs in different ways.
In particular the situation is broken on Cygwin.

The one we tweak ourselves are:
* ATLAS when we pass SAGE_ATLAS_LIB to decide what to copy/symlink
* fflas-ffpack
* iml
* the Sage library through SAGE_BLAS and module_list.py and its BLAS/BLAS2 madness
Other pkgs depend on a BLAS implem but are autonomous.

My proposal before a pkgconfig solution gets available at #17075 is that when ATLAS spkg-install script is run it decides what should be used once and for all and other packages use this information (like used to be done a little bit when the linbox spkg-install script wrote `echo $LINBOX_BLAS > $SAGE_LOCAL/share/cblas_config`)

Issue created by migration from https://trac.sagemath.org/ticket/17630





---

archive/issue_comments_231809.json:
```json
{
    "body": "Info for scipy/numpy:\nhttp://www.scipy.org/scipylib/building/linux.html",
    "created_at": "2015-01-14T17:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231809",
    "user": "jpflori"
}
```

Info for scipy/numpy:
http://www.scipy.org/scipylib/building/linux.html



---

archive/issue_comments_231810.json:
```json
{
    "body": "Fot cvxopt:\nhttp://cvxopt.org/install/",
    "created_at": "2015-01-14T17:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231810",
    "user": "jpflori"
}
```

Fot cvxopt:
http://cvxopt.org/install/



---

archive/issue_comments_231811.json:
```json
{
    "body": "Yes definitely of interest. I think cvxopt 1.1.7 is better at handling things with environment variables so we shouldn't patch anymore, I should update the cvxopt ebuild for gentoo. From cvxopt setup.py\n\n```\nBLAS_NOUNDERSCORES = int(os.environ.get(\"CVXOPT_BLAS_NOUNDERSCORES\",BLAS_NOUNDERSCORES)) == True\nBLAS_LIB = os.environ.get(\"CVXOPT_BLAS_LIB\",BLAS_LIB)\nLAPACK_LIB = os.environ.get(\"CVXOPT_LAPACK_LIB\",LAPACK_LIB)\nBLAS_LIB_DIR = os.environ.get(\"CVXOPT_BLAS_LIB_DIR\",BLAS_LIB_DIR)\nBLAS_EXTRA_LINK_ARGS = os.environ.get(\"CVXOPT_BLAS_EXTRA_LINK_ARGS\",BLAS_EXTRA_LINK_ARGS)\nif type(BLAS_LIB) is str: BLAS_LIB = BLAS_LIB.strip().split(',')\nif type(LAPACK_LIB) is str: LAPACK_LIB = LAPACK_LIB.strip().split(',')\nif type(BLAS_EXTRA_LINK_ARGS) is str: BLAS_EXTRA_LINK_ARGS = BLAS_EXTRA_LINK_ARGS.strip().split(',')\nBUILD_GSL = int(os.environ.get(\"CVXOPT_BUILD_GSL\",BUILD_GSL))\nGSL_LIB_DIR = os.environ.get(\"CVXOPT_GSL_LIB_DIR\",GSL_LIB_DIR)\nGSL_INC_DIR = os.environ.get(\"CVXOPT_GSL_INC_DIR\",GSL_INC_DIR)\nBUILD_FFTW = int(os.environ.get(\"CVXOPT_BUILD_FFTW\",BUILD_FFTW))\nFFTW_LIB_DIR = os.environ.get(\"CVXOPT_FFTW_LIB_DIR\",FFTW_LIB_DIR)\nFFTW_INC_DIR = os.environ.get(\"CVXOPT_FFTW_INC_DIR\",FFTW_INC_DIR)\nBUILD_GLPK = int(os.environ.get(\"CVXOPT_BUILD_GLPK\",BUILD_GLPK))\nGLPK_LIB_DIR = os.environ.get(\"CVXOPT_GLPK_LIB_DIR\",GLPK_LIB_DIR)\nGLPK_INC_DIR = os.environ.get(\"CVXOPT_GLPK_INC_DIR\",GLPK_INC_DIR)\nBUILD_DSDP = int(os.environ.get(\"CVXOPT_BUILD_DSDP\",BUILD_DSDP))\nDSDP_LIB_DIR = os.environ.get(\"CVXOPT_DSDP_LIB_DIR\",DSDP_LIB_DIR)\nDSDP_INC_DIR = os.environ.get(\"CVXOPT_DSDP_INC_DIR\",DSDP_INC_DIR)\n```\n\n\ngsl makes its own cblas (but no fortran blas) and by default libgsl is not linked with any cblas, you are supposed to link with a cblas when you use the library.\nSetting blas/lapack in numpy/scipy makes me crazy half the time. Environment variable or setup.cfg can be used to change the default (currently looking for MKL, ATLAS, netlib and netlib source in that order if I am not mistaken).\nMaking a setup.cfg from pkg-config is hard\n\n```\npc_incdir() {\n\t$(tc-getPKG_CONFIG) --cflags-only-I $@ | \\\n\t\tsed -e 's/^-I//' -e 's/[ ]*-I/:/g' -e 's/[ ]*$//' -e 's|^:||'\n}\n\npc_libdir() {\n\t$(tc-getPKG_CONFIG) --libs-only-L $@ | \\\n\t\tsed -e 's/^-L//' -e 's/[ ]*-L/:/g' -e 's/[ ]*$//' -e 's|^:||'\n}\n\npc_libs() {\n\t$(tc-getPKG_CONFIG) --libs-only-l $@ | \\\n\t\tsed -e 's/[ ]-l*\\(pthread\\|m\\)\\([ ]\\|$\\)//g' \\\n\t\t-e 's/^-l//' -e 's/[ ]*-l/,/g' -e 's/[ ]*$//' \\\n\t\t| tr ',' '\\n' | sort -u | tr '\\n' ',' | sed -e 's|,$||'\n}\n\n\t\tlocal libdir=\"${EPREFIX}\"/usr/$(get_libdir) # local tree\n\t\t# make sure _dotblas.so gets built\n\t\tsed -i -e '/NO_ATLAS_INFO/,+1d' numpy/core/setup.py || die\n\t\tcat >> site.cfg <<-EOF\n\t\t\t[blas]\n\t\t\tinclude_dirs = $(pc_incdir cblas)\n\t\t\tlibrary_dirs = $(pc_libdir cblas blas):${libdir}\n\t\t\tblas_libs = $(pc_libs cblas blas)\n\t\t\t[lapack]\n\t\t\tlibrary_dirs = $(pc_libdir lapack):${libdir}\n\t\t\tlapack_libs = $(pc_libs lapack)\n\t\tEOF\n```\n\n but with the python binding it should be easier.",
    "created_at": "2015-01-15T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231811",
    "user": "fbissey"
}
```

Yes definitely of interest. I think cvxopt 1.1.7 is better at handling things with environment variables so we shouldn't patch anymore, I should update the cvxopt ebuild for gentoo. From cvxopt setup.py

```
BLAS_NOUNDERSCORES = int(os.environ.get("CVXOPT_BLAS_NOUNDERSCORES",BLAS_NOUNDERSCORES)) == True
BLAS_LIB = os.environ.get("CVXOPT_BLAS_LIB",BLAS_LIB)
LAPACK_LIB = os.environ.get("CVXOPT_LAPACK_LIB",LAPACK_LIB)
BLAS_LIB_DIR = os.environ.get("CVXOPT_BLAS_LIB_DIR",BLAS_LIB_DIR)
BLAS_EXTRA_LINK_ARGS = os.environ.get("CVXOPT_BLAS_EXTRA_LINK_ARGS",BLAS_EXTRA_LINK_ARGS)
if type(BLAS_LIB) is str: BLAS_LIB = BLAS_LIB.strip().split(',')
if type(LAPACK_LIB) is str: LAPACK_LIB = LAPACK_LIB.strip().split(',')
if type(BLAS_EXTRA_LINK_ARGS) is str: BLAS_EXTRA_LINK_ARGS = BLAS_EXTRA_LINK_ARGS.strip().split(',')
BUILD_GSL = int(os.environ.get("CVXOPT_BUILD_GSL",BUILD_GSL))
GSL_LIB_DIR = os.environ.get("CVXOPT_GSL_LIB_DIR",GSL_LIB_DIR)
GSL_INC_DIR = os.environ.get("CVXOPT_GSL_INC_DIR",GSL_INC_DIR)
BUILD_FFTW = int(os.environ.get("CVXOPT_BUILD_FFTW",BUILD_FFTW))
FFTW_LIB_DIR = os.environ.get("CVXOPT_FFTW_LIB_DIR",FFTW_LIB_DIR)
FFTW_INC_DIR = os.environ.get("CVXOPT_FFTW_INC_DIR",FFTW_INC_DIR)
BUILD_GLPK = int(os.environ.get("CVXOPT_BUILD_GLPK",BUILD_GLPK))
GLPK_LIB_DIR = os.environ.get("CVXOPT_GLPK_LIB_DIR",GLPK_LIB_DIR)
GLPK_INC_DIR = os.environ.get("CVXOPT_GLPK_INC_DIR",GLPK_INC_DIR)
BUILD_DSDP = int(os.environ.get("CVXOPT_BUILD_DSDP",BUILD_DSDP))
DSDP_LIB_DIR = os.environ.get("CVXOPT_DSDP_LIB_DIR",DSDP_LIB_DIR)
DSDP_INC_DIR = os.environ.get("CVXOPT_DSDP_INC_DIR",DSDP_INC_DIR)
```


gsl makes its own cblas (but no fortran blas) and by default libgsl is not linked with any cblas, you are supposed to link with a cblas when you use the library.
Setting blas/lapack in numpy/scipy makes me crazy half the time. Environment variable or setup.cfg can be used to change the default (currently looking for MKL, ATLAS, netlib and netlib source in that order if I am not mistaken).
Making a setup.cfg from pkg-config is hard

```
pc_incdir() {
	$(tc-getPKG_CONFIG) --cflags-only-I $@ | \
		sed -e 's/^-I//' -e 's/[ ]*-I/:/g' -e 's/[ ]*$//' -e 's|^:||'
}

pc_libdir() {
	$(tc-getPKG_CONFIG) --libs-only-L $@ | \
		sed -e 's/^-L//' -e 's/[ ]*-L/:/g' -e 's/[ ]*$//' -e 's|^:||'
}

pc_libs() {
	$(tc-getPKG_CONFIG) --libs-only-l $@ | \
		sed -e 's/[ ]-l*\(pthread\|m\)\([ ]\|$\)//g' \
		-e 's/^-l//' -e 's/[ ]*-l/,/g' -e 's/[ ]*$//' \
		| tr ',' '\n' | sort -u | tr '\n' ',' | sed -e 's|,$||'
}

		local libdir="${EPREFIX}"/usr/$(get_libdir) # local tree
		# make sure _dotblas.so gets built
		sed -i -e '/NO_ATLAS_INFO/,+1d' numpy/core/setup.py || die
		cat >> site.cfg <<-EOF
			[blas]
			include_dirs = $(pc_incdir cblas)
			library_dirs = $(pc_libdir cblas blas):${libdir}
			blas_libs = $(pc_libs cblas blas)
			[lapack]
			library_dirs = $(pc_libdir lapack):${libdir}
			lapack_libs = $(pc_libs lapack)
		EOF
```

 but with the python binding it should be easier.



---

archive/issue_comments_231812.json:
```json
{
    "body": "This is definitely not really needs_reviex, in particular, OS X surely needs further tweaking, not sure that passing `-lblas` or `lcblas` would always work, or if one sometines needs to pass the `-framework` stuff...\nI've basically tested it on Linux and Cygwin and it looks ok.\n\nAnyway, I won't be able to do anything for at leasr one month, so here is the current state of affair.\nFeel free to finalize and merge it!\n----\nLast 10 new commits:",
    "created_at": "2015-01-17T18:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231812",
    "user": "jpflori"
}
```

This is definitely not really needs_reviex, in particular, OS X surely needs further tweaking, not sure that passing `-lblas` or `lcblas` would always work, or if one sometines needs to pass the `-framework` stuff...
I've basically tested it on Linux and Cygwin and it looks ok.

Anyway, I won't be able to do anything for at leasr one month, so here is the current state of affair.
Feel free to finalize and merge it!
----
Last 10 new commits:



---

archive/issue_comments_231813.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-17T18:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231813",
    "user": "jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_231814.json:
```json
{
    "body": "Also note that part of the changes here have been shamelessly stolen from sage-on-gentoo patches posted on #17075.",
    "created_at": "2015-01-17T18:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231814",
    "user": "jpflori"
}
```

Also note that part of the changes here have been shamelessly stolen from sage-on-gentoo patches posted on #17075.



---

archive/issue_comments_231815.json:
```json
{
    "body": "Replying to [comment:7 jpflori]:\n> Also note that part of the changes here have been shamelessly stolen from sage-on-gentoo patches posted on #17075.\n\nYou didn't go all the way with libdir, but you certainly stole the spirit of it. The libdir part is important if we use an external blas that is not in a standard directory. Hum.... may be I should add a runpath for that case, at the very least LD_LIBRARY_PATH or its equivalent needs to be set.",
    "created_at": "2015-01-17T22:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231815",
    "user": "fbissey"
}
```

Replying to [comment:7 jpflori]:
> Also note that part of the changes here have been shamelessly stolen from sage-on-gentoo patches posted on #17075.

You didn't go all the way with libdir, but you certainly stole the spirit of it. The libdir part is important if we use an external blas that is not in a standard directory. Hum.... may be I should add a runpath for that case, at the very least LD_LIBRARY_PATH or its equivalent needs to be set.



---

archive/issue_comments_231816.json:
```json
{
    "body": "Please note that the idea here is just to clean up how we use our default (and unique) BLAS.\nWe should not try to do everything at once!",
    "created_at": "2015-01-17T22:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231816",
    "user": "jpflori"
}
```

Please note that the idea here is just to clean up how we use our default (and unique) BLAS.
We should not try to do everything at once!



---

archive/issue_comments_231817.json:
```json
{
    "body": "Well, I'd still like to include libdir as forward thinking - that and it makes my life easier sage-on-gentoo side - of course lots of things land in sage that make my life ugly but I'd like to minimize it if I can.",
    "created_at": "2015-01-17T23:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231817",
    "user": "fbissey"
}
```

Well, I'd still like to include libdir as forward thinking - that and it makes my life easier sage-on-gentoo side - of course lots of things land in sage that make my life ugly but I'd like to minimize it if I can.



---

archive/issue_comments_231818.json:
```json
{
    "body": "Any chance to get this merged and go on working in a follow up ticket?",
    "created_at": "2015-02-26T13:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231818",
    "user": "jpflori"
}
```

Any chance to get this merged and go on working in a follow up ticket?



---

archive/issue_comments_231819.json:
```json
{
    "body": "Missed that. Probably to late for 6.6 but we should be able to rebase for early inclusion in 6.7.",
    "created_at": "2015-03-29T01:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231819",
    "user": "fbissey"
}
```

Missed that. Probably to late for 6.6 but we should be able to rebase for early inclusion in 6.7.



---

archive/issue_comments_231820.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T09:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231820",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231821.json:
```json
{
    "body": "Here is what is happening when you try to use Accelerate in R on OS X\n\n```\ngcc -std=gnu99 -dynamiclib -Wl,-headerpad_max_install_names  -undefined dynamic_lookup -single_module -multiply_defined suppress -L../../../lib -L/Users/fbissey/build/sage-6.5.beta1/local/lib/  -o internet.so Rhttpd.o Rsock.o internet.o nanoftp.o nanohttp.o sock.o sockconn.o -lR   -Wl,-framework -Wl,CoreFoundation\nmkdir /Users/fbissey/build/sage-6.5.beta1/local/var/tmp/sage/build/r-3.1.2.p0/src/modules\nmaking Lapack.d from Lapack.c\nmaking vecLibg95c.d from vecLibg95c.c\n<built-in>: warning: subframework include vecLib/vecLib.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vecLibTypes.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vBasicOps.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vBigNum.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vectorOps.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vfp.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vDSP.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/cblas.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/clapack.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/LinearAlgebra.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/base.h conflicts with framework include\nIn file included from /usr/include/os/object.h:27:0,\n                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/LinearAlgebra/base.h:6,\n                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/LinearAlgebra/LinearAlgebra.h:10,\n                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/vecLib.h:65,\n                 from /System/Library/Frameworks/Accelerate.framework/Headers/Accelerate.h:20,\n                 from vecLibg95c.c:8:\n/usr/include/os/base.h:113:20: error: missing binary operator before token \"(\"\n #if __has_extension(attribute_overloadable)\n                    ^\n/usr/include/os/base.h:119:54: error: missing binary operator before token \"(\"\n #if __has_feature(objc_fixed_enum) || __has_extension(cxx_strong_enums)\n                                                      ^\n<built-in>: warning: subframework include vecLib/LinearAlgebra/object.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/matrix.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/vector.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/splat.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/arithmetic.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/linear_systems.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/LinearAlgebra/norms.h conflicts with framework include\n<built-in>: warning: subframework include vecLib/vForce.h conflicts with framework include\nmake[3]: *** [vecLibg95c.d] Error 1\nmake[2]: *** [make.lapack] Error 2\nmake[1]: *** [R] Error 1\nmake: *** [R] Error 1\nError building R.\n```\n\n\nBOOOM!",
    "created_at": "2015-04-17T10:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231821",
    "user": "fbissey"
}
```

Here is what is happening when you try to use Accelerate in R on OS X

```
gcc -std=gnu99 -dynamiclib -Wl,-headerpad_max_install_names  -undefined dynamic_lookup -single_module -multiply_defined suppress -L../../../lib -L/Users/fbissey/build/sage-6.5.beta1/local/lib/  -o internet.so Rhttpd.o Rsock.o internet.o nanoftp.o nanohttp.o sock.o sockconn.o -lR   -Wl,-framework -Wl,CoreFoundation
mkdir /Users/fbissey/build/sage-6.5.beta1/local/var/tmp/sage/build/r-3.1.2.p0/src/modules
making Lapack.d from Lapack.c
making vecLibg95c.d from vecLibg95c.c
<built-in>: warning: subframework include vecLib/vecLib.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vecLibTypes.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vBasicOps.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vBigNum.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vectorOps.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vfp.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vDSP.h conflicts with framework include
<built-in>: warning: subframework include vecLib/cblas.h conflicts with framework include
<built-in>: warning: subframework include vecLib/clapack.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/LinearAlgebra.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/base.h conflicts with framework include
In file included from /usr/include/os/object.h:27:0,
                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/LinearAlgebra/base.h:6,
                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/LinearAlgebra/LinearAlgebra.h:10,
                 from /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Headers/vecLib.h:65,
                 from /System/Library/Frameworks/Accelerate.framework/Headers/Accelerate.h:20,
                 from vecLibg95c.c:8:
/usr/include/os/base.h:113:20: error: missing binary operator before token "("
 #if __has_extension(attribute_overloadable)
                    ^
/usr/include/os/base.h:119:54: error: missing binary operator before token "("
 #if __has_feature(objc_fixed_enum) || __has_extension(cxx_strong_enums)
                                                      ^
<built-in>: warning: subframework include vecLib/LinearAlgebra/object.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/matrix.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/vector.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/splat.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/arithmetic.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/linear_systems.h conflicts with framework include
<built-in>: warning: subframework include vecLib/LinearAlgebra/norms.h conflicts with framework include
<built-in>: warning: subframework include vecLib/vForce.h conflicts with framework include
make[3]: *** [vecLibg95c.d] Error 1
make[2]: *** [make.lapack] Error 2
make[1]: *** [R] Error 1
make: *** [R] Error 1
Error building R.
```


BOOOM!



---

archive/issue_comments_231822.json:
```json
{
    "body": "Ok, so let's not use it.",
    "created_at": "2015-04-17T10:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231822",
    "user": "jpflori"
}
```

Ok, so let's not use it.



---

archive/issue_comments_231823.json:
```json
{
    "body": "If you want to add the \"libdir\" stuff, I'll happily review it.",
    "created_at": "2015-04-17T10:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231823",
    "user": "jpflori"
}
```

If you want to add the "libdir" stuff, I'll happily review it.



---

archive/issue_comments_231824.json:
```json
{
    "body": "Other than that little details:\n* I would prefer cblas (C) and blas (f77) to be stored separately.\n* Do you really want to enable lapack in fflas-ffpack/linbox? Is there a real point to it?\n \nI would like to add the libdir stuff that would make my life easier thank you.\n\nThe point about accelerate on OS X is there was a question in the spkg-install so I set out to find the answer.",
    "created_at": "2015-04-17T10:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231824",
    "user": "fbissey"
}
```

Other than that little details:
* I would prefer cblas (C) and blas (f77) to be stored separately.
* Do you really want to enable lapack in fflas-ffpack/linbox? Is there a real point to it?
 
I would like to add the libdir stuff that would make my life easier thank you.

The point about accelerate on OS X is there was a question in the spkg-install so I set out to find the answer.



---

archive/issue_comments_231825.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> Other than that little details:\n>  * I would prefer cblas (C) and blas (f77) to be stored separately.\nSure, that makes sense.\n>  * Do you really want to enable lapack in fflas-ffpack/linbox? Is there a real point to it?\nIn linbox itself it is not used.\nI don't remember about the fflas-ffpack part...\n\n>  \n> I would like to add the libdir stuff that would make my life easier thank you.\n> \n> The point about accelerate on OS X is there was a question in the spkg-install so I set out to find the answer.\nAh, thanks!",
    "created_at": "2015-04-17T10:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231825",
    "user": "jpflori"
}
```

Replying to [comment:17 fbissey]:
> Other than that little details:
>  * I would prefer cblas (C) and blas (f77) to be stored separately.
Sure, that makes sense.
>  * Do you really want to enable lapack in fflas-ffpack/linbox? Is there a real point to it?
In linbox itself it is not used.
I don't remember about the fflas-ffpack part...

>  
> I would like to add the libdir stuff that would make my life easier thank you.
> 
> The point about accelerate on OS X is there was a question in the spkg-install so I set out to find the answer.
Ah, thanks!



---

archive/issue_comments_231826.json:
```json
{
    "body": "Well, you added lapack to fflas-ffpack and added lapack for linbox in module_list.py. If that doesn't enable any extra functionality or anything we should do away with it.",
    "created_at": "2015-04-17T10:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231826",
    "user": "fbissey"
}
```

Well, you added lapack to fflas-ffpack and added lapack for linbox in module_list.py. If that doesn't enable any extra functionality or anything we should do away with it.



---

archive/issue_comments_231827.json:
```json
{
    "body": "It might enhance performance, I did not check.\nI only know for sure that fflas-ffpack can be configure to (potentially) use LAPACK.\nIf you don't feel safe with this, we can postpone such an inclusion and deal with it in #14390.",
    "created_at": "2015-04-17T10:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231827",
    "user": "jpflori"
}
```

It might enhance performance, I did not check.
I only know for sure that fflas-ffpack can be configure to (potentially) use LAPACK.
If you don't feel safe with this, we can postpone such an inclusion and deal with it in #14390.



---

archive/issue_comments_231828.json:
```json
{
    "body": "I would postpone the fflas-ffpack stuff, don't you have a series of ticket for givaro/fflas-ffpack/linbox update? We could also do that when we get around it.",
    "created_at": "2015-04-17T10:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231828",
    "user": "fbissey"
}
```

I would postpone the fflas-ffpack stuff, don't you have a series of ticket for givaro/fflas-ffpack/linbox update? We could also do that when we get around it.



---

archive/issue_comments_231829.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> I would postpone the fflas-ffpack stuff, don't you have a series of ticket for givaro/fflas-ffpack/linbox update? We could also do that when we get around it.\nYes: #17635 and friends.\nNote we'll have to wait for a fflas-ffpack 2.1 release and linbox x.y release as the current versions of the three libs are not compatible.\nThey should have come out in march, but didn't and Cl\u00e9ment did not answer my latest mail.",
    "created_at": "2015-04-17T11:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231829",
    "user": "jpflori"
}
```

Replying to [comment:21 fbissey]:
> I would postpone the fflas-ffpack stuff, don't you have a series of ticket for givaro/fflas-ffpack/linbox update? We could also do that when we get around it.
Yes: #17635 and friends.
Note we'll have to wait for a fflas-ffpack 2.1 release and linbox x.y release as the current versions of the three libs are not compatible.
They should have come out in march, but didn't and Clément did not answer my latest mail.



---

archive/issue_comments_231830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T11:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231830",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T11:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231831",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T11:39:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231832",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231833.json:
```json
{
    "body": "Do you have further things to commit or should I start putting my own comments into action?",
    "created_at": "2015-04-20T21:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231833",
    "user": "fbissey"
}
```

Do you have further things to commit or should I start putting my own comments into action?



---

archive/issue_comments_231834.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-21T07:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231834",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231835.json:
```json
{
    "body": "I think I've sanitized the situation after my miserable failure to correctly resolve the conflict for numpy `spkg-install` script between this ticket and #18142.\n\nPlease go ahead.",
    "created_at": "2015-04-21T07:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231835",
    "user": "jpflori"
}
```

I think I've sanitized the situation after my miserable failure to correctly resolve the conflict for numpy `spkg-install` script between this ticket and #18142.

Please go ahead.



---

archive/issue_comments_231836.json:
```json
{
    "body": "Is this ticket really `needs_review` or are further changes planned (in the latter case, set the status to `needs_work` please).",
    "created_at": "2015-04-22T09:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231836",
    "user": "jdemeyer"
}
```

Is this ticket really `needs_review` or are further changes planned (in the latter case, set the status to `needs_work` please).



---

archive/issue_comments_231837.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-22T09:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231837",
    "user": "fbissey"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_231838.json:
```json
{
    "body": "There are a couple more changes we are/ I am planning. I should have put it back to \"needs_work\" earlier. I should be able to further work on this ticket tomorrow.",
    "created_at": "2015-04-22T09:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231838",
    "user": "fbissey"
}
```

There are a couple more changes we are/ I am planning. I should have put it back to "needs_work" earlier. I should be able to further work on this ticket tomorrow.



---

archive/issue_comments_231839.json:
```json
{
    "body": "When you think you're done with this ticket, you should really ask Volker to test it on the buildbots.",
    "created_at": "2015-04-22T09:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231839",
    "user": "jdemeyer"
}
```

When you think you're done with this ticket, you should really ask Volker to test it on the buildbots.



---

archive/issue_comments_231840.json:
```json
{
    "body": "Oh, yes indeed.",
    "created_at": "2015-04-22T10:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231840",
    "user": "fbissey"
}
```

Oh, yes indeed.



---

archive/issue_comments_231841.json:
```json
{
    "body": "FYI: this will conflict with #18450.",
    "created_at": "2015-05-20T10:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231841",
    "user": "jdemeyer"
}
```

FYI: this will conflict with #18450.



---

archive/issue_comments_231842.json:
```json
{
    "body": "I think it will be better to rebase on top of #18450 I will have to rebase the corresponding sage-on-gentoo patch anyway and it will be less patching in the end.",
    "created_at": "2015-05-20T10:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231842",
    "user": "fbissey"
}
```

I think it will be better to rebase on top of #18450 I will have to rebase the corresponding sage-on-gentoo patch anyway and it will be less patching in the end.



---

archive/issue_comments_231843.json:
```json
{
    "body": "Fran\u00e7ois, any progress on that front?",
    "created_at": "2015-06-22T23:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231843",
    "user": "jpflori"
}
```

François, any progress on that front?



---

archive/issue_comments_231844.json:
```json
{
    "body": "Sorry but no, I have got side-tracked by the upgrade of matplotlib ticket #17618 and I was thinking bumping numpy to 1.9.2 at #17642 would be trivial but it isn't and I am kind of stuck on it. Working on this ticket could actually be useful distraction but I am busy right now trying to get something scheduling properly on an AIX cluster.",
    "created_at": "2015-06-22T23:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231844",
    "user": "fbissey"
}
```

Sorry but no, I have got side-tracked by the upgrade of matplotlib ticket #17618 and I was thinking bumping numpy to 1.9.2 at #17642 would be trivial but it isn't and I am kind of stuck on it. Working on this ticket could actually be useful distraction but I am busy right now trying to get something scheduling properly on an AIX cluster.



---

archive/issue_comments_231845.json:
```json
{
    "body": "Whenever you work on this ticket, please do it in the spirit of #18450: it is better to define libraries in the `.pxd` files of the libraries if possible.",
    "created_at": "2015-06-23T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231845",
    "user": "jdemeyer"
}
```

Whenever you work on this ticket, please do it in the spirit of #18450: it is better to define libraries in the `.pxd` files of the libraries if possible.



---

archive/issue_comments_231846.json:
```json
{
    "body": "Replying to [comment:37 jdemeyer]:\n> Whenever you work on this ticket, please do it in the spirit of #18450: it is better to define libraries in the `.pxd` files of the libraries if possible.\n\nJust so I am sure I understand correctly:\n\n```\n# distutils: libraries = gmp pari\n```\n\nfor example will add \"-lgmp -lpari\" to the linking line (possibly not in that order since it could break)? Is it possible to read the correct library or import from another file? I am asking because our forward thinking is to move the definition of the blas/lapack stuff to `.pc` files and be able to choose between several implementations that won't all have the same name.",
    "created_at": "2015-06-23T21:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231846",
    "user": "fbissey"
}
```

Replying to [comment:37 jdemeyer]:
> Whenever you work on this ticket, please do it in the spirit of #18450: it is better to define libraries in the `.pxd` files of the libraries if possible.

Just so I am sure I understand correctly:

```
# distutils: libraries = gmp pari
```

for example will add "-lgmp -lpari" to the linking line (possibly not in that order since it could break)? Is it possible to read the correct library or import from another file? I am asking because our forward thinking is to move the definition of the blas/lapack stuff to `.pc` files and be able to choose between several implementations that won't all have the same name.



---

archive/issue_comments_231847.json:
```json
{
    "body": "Replying to [comment:38 fbissey]:\n> Just so I am sure I understand correctly:\n> {{{\n> # distutils: libraries = gmp pari\n> }}}\n> for example will add \"-lgmp -lpari\" to the linking line\nYes indeed.\n\n> possibly not in that order since it could break\nThere is a global order `library_order_list` defined in `src/module_list.py`. Libraries are sorted according to that order, so the order given in the `# distutils` declaration is not relevant (unless the library is *not* listed in `library_order_list`).\n\n> Is it possible to read the correct library or import from another file?\nYes, see the `aliases` variable in `src/module_list.py`\n\nJust define whatever you need in that variable and then use the alias name in the `# distutils` declaration.",
    "created_at": "2015-06-24T07:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231847",
    "user": "jdemeyer"
}
```

Replying to [comment:38 fbissey]:
> Just so I am sure I understand correctly:
> {{{
> # distutils: libraries = gmp pari
> }}}
> for example will add "-lgmp -lpari" to the linking line
Yes indeed.

> possibly not in that order since it could break
There is a global order `library_order_list` defined in `src/module_list.py`. Libraries are sorted according to that order, so the order given in the `# distutils` declaration is not relevant (unless the library is *not* listed in `library_order_list`).

> Is it possible to read the correct library or import from another file?
Yes, see the `aliases` variable in `src/module_list.py`

Just define whatever you need in that variable and then use the alias name in the `# distutils` declaration.



---

archive/issue_comments_231848.json:
```json
{
    "body": "As far as I know, nothing in Sage *directly* uses BLAS, it is only used through external libraries (linbox, numpy, ...)\n\nSo it's a mystery why some extensions in `src/module_list.py` list the BLAS libraries without any other library. And indeed, on my Linux box, Sage still works after the following change:\n\n```diff\ndiff --git a/src/module_list.py b/src/module_list.py\nindex e01cd4b..7d818d6 100755\n--- a/src/module_list.py\n+++ b/src/module_list.py\n@@ -1024,8 +1024,7 @@ ext_modules = [\n               sources = ['sage/matrix/echelon_matrix.pyx']),\n \n     Extension('sage.matrix.change_ring',\n-              sources = ['sage/matrix/change_ring.pyx'],\n-              libraries=[BLAS, BLAS2]),\n+              sources = ['sage/matrix/change_ring.pyx']),\n \n     Extension('sage.matrix.matrix',\n               sources = ['sage/matrix/matrix.pyx']),\n@@ -1040,8 +1039,7 @@ ext_modules = [\n               sources = ['sage/matrix/matrix2.pyx']),\n \n     Extension('sage.matrix.matrix_complex_double_dense',\n-              sources = ['sage/matrix/matrix_complex_double_dense.pyx'],\n-              libraries=[BLAS, BLAS2]),\n+              sources = ['sage/matrix/matrix_complex_double_dense.pyx']),\n \n     Extension('sage.matrix.matrix_cyclo_dense',\n               sources = ['sage/matrix/matrix_cyclo_dense.pyx'],\n@@ -1052,8 +1050,7 @@ ext_modules = [\n               sources = ['sage/matrix/matrix_dense.pyx']),\n \n     Extension('sage.matrix.matrix_double_dense',\n-              sources = ['sage/matrix/matrix_double_dense.pyx'],\n-              libraries=[BLAS, BLAS2]),\n+              sources = ['sage/matrix/matrix_double_dense.pyx']),\n \n     Extension('sage.matrix.matrix_generic_dense',\n               sources = ['sage/matrix/matrix_generic_dense.pyx']),\n@@ -1116,8 +1113,7 @@ ext_modules = [\n               sources = ['sage/matrix/matrix_rational_sparse.pyx']),\n \n     Extension('sage.matrix.matrix_real_double_dense',\n-              sources = ['sage/matrix/matrix_real_double_dense.pyx'],\n-              libraries=[BLAS, BLAS2]),\n+              sources = ['sage/matrix/matrix_real_double_dense.pyx']),\n \n     Extension('sage.matrix.matrix_sparse',\n               sources = ['sage/matrix/matrix_sparse.pyx']),\n@@ -1254,12 +1250,10 @@ ext_modules = [\n               sources = ['sage/modules/module.pyx']),\n \n     Extension('sage.modules.vector_complex_double_dense',\n-              ['sage/modules/vector_complex_double_dense.pyx'],\n-              libraries = [BLAS, BLAS2]),\n+              ['sage/modules/vector_complex_double_dense.pyx']),\n \n     Extension('sage.modules.vector_double_dense',\n-              ['sage/modules/vector_double_dense.pyx'],\n-              libraries = [BLAS, BLAS2]),\n+              ['sage/modules/vector_double_dense.pyx']),\n \n     Extension('sage.modules.vector_integer_dense',\n               sources = ['sage/modules/vector_integer_dense.pyx']),\n@@ -1278,8 +1272,7 @@ ext_modules = [\n               sources = ['sage/modules/vector_rational_dense.pyx']),\n \n     Extension('sage.modules.vector_real_double_dense',\n-              ['sage/modules/vector_real_double_dense.pyx'],\n-              libraries = [BLAS, BLAS2]),\n+              ['sage/modules/vector_real_double_dense.pyx']),\n \n     ################################\n     ##\n```\n\n\nPerhaps those libraries are needed for some reason (I know Linux in particular is very flexible with defining libraries) but it's something to be investigated...",
    "created_at": "2015-06-24T08:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231848",
    "user": "jdemeyer"
}
```

As far as I know, nothing in Sage *directly* uses BLAS, it is only used through external libraries (linbox, numpy, ...)

So it's a mystery why some extensions in `src/module_list.py` list the BLAS libraries without any other library. And indeed, on my Linux box, Sage still works after the following change:

```diff
diff --git a/src/module_list.py b/src/module_list.py
index e01cd4b..7d818d6 100755
--- a/src/module_list.py
+++ b/src/module_list.py
@@ -1024,8 +1024,7 @@ ext_modules = [
               sources = ['sage/matrix/echelon_matrix.pyx']),
 
     Extension('sage.matrix.change_ring',
-              sources = ['sage/matrix/change_ring.pyx'],
-              libraries=[BLAS, BLAS2]),
+              sources = ['sage/matrix/change_ring.pyx']),
 
     Extension('sage.matrix.matrix',
               sources = ['sage/matrix/matrix.pyx']),
@@ -1040,8 +1039,7 @@ ext_modules = [
               sources = ['sage/matrix/matrix2.pyx']),
 
     Extension('sage.matrix.matrix_complex_double_dense',
-              sources = ['sage/matrix/matrix_complex_double_dense.pyx'],
-              libraries=[BLAS, BLAS2]),
+              sources = ['sage/matrix/matrix_complex_double_dense.pyx']),
 
     Extension('sage.matrix.matrix_cyclo_dense',
               sources = ['sage/matrix/matrix_cyclo_dense.pyx'],
@@ -1052,8 +1050,7 @@ ext_modules = [
               sources = ['sage/matrix/matrix_dense.pyx']),
 
     Extension('sage.matrix.matrix_double_dense',
-              sources = ['sage/matrix/matrix_double_dense.pyx'],
-              libraries=[BLAS, BLAS2]),
+              sources = ['sage/matrix/matrix_double_dense.pyx']),
 
     Extension('sage.matrix.matrix_generic_dense',
               sources = ['sage/matrix/matrix_generic_dense.pyx']),
@@ -1116,8 +1113,7 @@ ext_modules = [
               sources = ['sage/matrix/matrix_rational_sparse.pyx']),
 
     Extension('sage.matrix.matrix_real_double_dense',
-              sources = ['sage/matrix/matrix_real_double_dense.pyx'],
-              libraries=[BLAS, BLAS2]),
+              sources = ['sage/matrix/matrix_real_double_dense.pyx']),
 
     Extension('sage.matrix.matrix_sparse',
               sources = ['sage/matrix/matrix_sparse.pyx']),
@@ -1254,12 +1250,10 @@ ext_modules = [
               sources = ['sage/modules/module.pyx']),
 
     Extension('sage.modules.vector_complex_double_dense',
-              ['sage/modules/vector_complex_double_dense.pyx'],
-              libraries = [BLAS, BLAS2]),
+              ['sage/modules/vector_complex_double_dense.pyx']),
 
     Extension('sage.modules.vector_double_dense',
-              ['sage/modules/vector_double_dense.pyx'],
-              libraries = [BLAS, BLAS2]),
+              ['sage/modules/vector_double_dense.pyx']),
 
     Extension('sage.modules.vector_integer_dense',
               sources = ['sage/modules/vector_integer_dense.pyx']),
@@ -1278,8 +1272,7 @@ ext_modules = [
               sources = ['sage/modules/vector_rational_dense.pyx']),
 
     Extension('sage.modules.vector_real_double_dense',
-              ['sage/modules/vector_real_double_dense.pyx'],
-              libraries = [BLAS, BLAS2]),
+              ['sage/modules/vector_real_double_dense.pyx']),
 
     ################################
     ##
```


Perhaps those libraries are needed for some reason (I know Linux in particular is very flexible with defining libraries) but it's something to be investigated...



---

archive/issue_comments_231849.json:
```json
{
    "body": "See #18777.",
    "created_at": "2015-06-24T08:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231849",
    "user": "jdemeyer"
}
```

See #18777.



---

archive/issue_comments_231850.json:
```json
{
    "body": "I did a serious clean-up of the Cython interface to GSL, see #18778.",
    "created_at": "2015-06-24T10:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231850",
    "user": "jdemeyer"
}
```

I did a serious clean-up of the Cython interface to GSL, see #18778.



---

archive/issue_comments_231851.json:
```json
{
    "body": "This is just merging the previous work of Jean-Pierre into 6.8.beta5 and solving the conflict. There are a couple more things I want to do. Then I should explore transferring libraries to `.pxd` files.\n----\nNew commits:",
    "created_at": "2015-06-26T10:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231851",
    "user": "fbissey"
}
```

This is just merging the previous work of Jean-Pierre into 6.8.beta5 and solving the conflict. There are a couple more things I want to do. Then I should explore transferring libraries to `.pxd` files.
----
New commits:



---

archive/issue_comments_231852.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-26T10:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231852",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231853.json:
```json
{
    "body": "I would move `cblas_libs()` to `sage/env.py`, analogous to `sage_include_directories()`.\n\nAnd this\n\n```\nf = open(os.path.join(SAGE_LOCAL, 'share/cblas_config'), 'r')\nlibs = f.readline().split()\nf.close()\nreturn libs\n```\n\ncan be written as\n\n```\nwith open(os.path.join(SAGE_SHARE, 'cblas_config')) as f:\n    return f.readline().split()\n```\n",
    "created_at": "2015-06-26T11:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231853",
    "user": "jdemeyer"
}
```

I would move `cblas_libs()` to `sage/env.py`, analogous to `sage_include_directories()`.

And this

```
f = open(os.path.join(SAGE_LOCAL, 'share/cblas_config'), 'r')
libs = f.readline().split()
f.close()
return libs
```

can be written as

```
with open(os.path.join(SAGE_SHARE, 'cblas_config')) as f:
    return f.readline().split()
```




---

archive/issue_comments_231854.json:
```json
{
    "body": "That's good suggestions. I will do that once I finished my current round of nitpicking.",
    "created_at": "2015-06-26T11:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231854",
    "user": "fbissey"
}
```

That's good suggestions. I will do that once I finished my current round of nitpicking.



---

archive/issue_comments_231855.json:
```json
{
    "body": "One more nitpicking: replace\n\n```\ncat x | sed ...\n```\n\nby\n\n```\nsed ... x\n```\n",
    "created_at": "2015-06-26T11:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231855",
    "user": "jdemeyer"
}
```

One more nitpicking: replace

```
cat x | sed ...
```

by

```
sed ... x
```




---

archive/issue_comments_231856.json:
```json
{
    "body": "I would also like to know the justification for this in `sage-env`:\n\n```diff\n-if [ \"$LDFLAGS\" = \"\" ]; then\n- LDFLAGS=\"\" && export LDFLAGS\n+if [ -z \"$LDFLAGS\" ]; then\n+ unset LDFLAGS\n fi\n```\n",
    "created_at": "2015-06-26T11:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231856",
    "user": "jdemeyer"
}
```

I would also like to know the justification for this in `sage-env`:

```diff
-if [ "$LDFLAGS" = "" ]; then
- LDFLAGS="" && export LDFLAGS
+if [ -z "$LDFLAGS" ]; then
+ unset LDFLAGS
 fi
```




---

archive/issue_comments_231857.json:
```json
{
    "body": "Replying to [comment:49 jdemeyer]:\n> I would also like to know the justification for this in `sage-env`:\n> {{{\n> #!diff\n> -if [ \"$LDFLAGS\" = \"\" ]; then\n> - LDFLAGS=\"\" && export LDFLAGS\n> +if [ -z \"$LDFLAGS\" ]; then\n> + unset LDFLAGS\n>  fi\n> }}}\n\nThat must have come from one of Jean-Pierre's commit. Difference is very subtle and I am not sure it matters but I am wondering about the whole point of the test.",
    "created_at": "2015-06-26T11:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231857",
    "user": "fbissey"
}
```

Replying to [comment:49 jdemeyer]:
> I would also like to know the justification for this in `sage-env`:
> {{{
> #!diff
> -if [ "$LDFLAGS" = "" ]; then
> - LDFLAGS="" && export LDFLAGS
> +if [ -z "$LDFLAGS" ]; then
> + unset LDFLAGS
>  fi
> }}}

That must have come from one of Jean-Pierre's commit. Difference is very subtle and I am not sure it matters but I am wondering about the whole point of the test.



---

archive/issue_comments_231858.json:
```json
{
    "body": "Instead of\n\n```sh\nIML_BLAS=--with-cblas=\"$cblas_libs\"\n\n./configure \"$IML_BLAS\"\n```\n\nwith awkward quoting, why not simply\n\n```\n./configure --with-cblas=\"$cblas_libs\"\n```\n\n(same for `FFLAS_FFPACK_BLAS`)",
    "created_at": "2015-06-26T11:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231858",
    "user": "jdemeyer"
}
```

Instead of

```sh
IML_BLAS=--with-cblas="$cblas_libs"

./configure "$IML_BLAS"
```

with awkward quoting, why not simply

```
./configure --with-cblas="$cblas_libs"
```

(same for `FFLAS_FFPACK_BLAS`)



---

archive/issue_comments_231859.json:
```json
{
    "body": "Also please use `$IML_CONFIGURE` instead of `\"$IML_CONFIGURE\"` (such variables are usually not quoted).",
    "created_at": "2015-06-26T11:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231859",
    "user": "jdemeyer"
}
```

Also please use `$IML_CONFIGURE` instead of `"$IML_CONFIGURE"` (such variables are usually not quoted).



---

archive/issue_comments_231860.json:
```json
{
    "body": "I would also like to know the justification for the removal of\n\n```\nbuild/pkgs/numpy/patches/cygwin-lapack_lite-setup.py.diff\n```\n",
    "created_at": "2015-06-26T11:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231860",
    "user": "jdemeyer"
}
```

I would also like to know the justification for the removal of

```
build/pkgs/numpy/patches/cygwin-lapack_lite-setup.py.diff
```




---

archive/issue_comments_231861.json:
```json
{
    "body": "Replying to [comment:49 jdemeyer]:\n> I would also like to know the justification for this in `sage-env`:\n> {{{\n> #!diff\n> -if [ \"$LDFLAGS\" = \"\" ]; then\n> - LDFLAGS=\"\" && export LDFLAGS\n> +if [ -z \"$LDFLAGS\" ]; then\n> + unset LDFLAGS\n>  fi\n> }}}\nBecause this does not do the same thing :).\nIIRC the first option exports `LDFLAGS = \"\"` when LDFLAGS is not set.\nOr something in this spirit.\nThis can cause trouble later on (and I thing I was hit by that).\n\nWhatsoever IIRC once again, the \"new\" treatment for LDFLAGS is similar to the one for CFLAGS and CPPFLAGS.",
    "created_at": "2015-06-26T11:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231861",
    "user": "jpflori"
}
```

Replying to [comment:49 jdemeyer]:
> I would also like to know the justification for this in `sage-env`:
> {{{
> #!diff
> -if [ "$LDFLAGS" = "" ]; then
> - LDFLAGS="" && export LDFLAGS
> +if [ -z "$LDFLAGS" ]; then
> + unset LDFLAGS
>  fi
> }}}
Because this does not do the same thing :).
IIRC the first option exports `LDFLAGS = ""` when LDFLAGS is not set.
Or something in this spirit.
This can cause trouble later on (and I thing I was hit by that).

Whatsoever IIRC once again, the "new" treatment for LDFLAGS is similar to the one for CFLAGS and CPPFLAGS.



---

archive/issue_comments_231862.json:
```json
{
    "body": "Replying to [comment:51 jdemeyer]:\n> Instead of\n> {{{\n> #!sh\n> IML_BLAS=--with-cblas=\"$cblas_libs\"\n> \n> ./configure \"$IML_BLAS\"\n> }}}\n> with awkward quoting, why not simply\n> {{{\n> ./configure --with-cblas=\"$cblas_libs\"\n> }}}\n> (same for `FFLAS_FFPACK_BLAS`)\nI don't really remember, but both might work as well.\nIIRC FFLAS-FFPACK configure scripts is very sensitive to quoting and spaces and it was a nightmare to make it accept multiple libraries to be linked separated by spaces.",
    "created_at": "2015-06-26T12:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231862",
    "user": "jpflori"
}
```

Replying to [comment:51 jdemeyer]:
> Instead of
> {{{
> #!sh
> IML_BLAS=--with-cblas="$cblas_libs"
> 
> ./configure "$IML_BLAS"
> }}}
> with awkward quoting, why not simply
> {{{
> ./configure --with-cblas="$cblas_libs"
> }}}
> (same for `FFLAS_FFPACK_BLAS`)
I don't really remember, but both might work as well.
IIRC FFLAS-FFPACK configure scripts is very sensitive to quoting and spaces and it was a nightmare to make it accept multiple libraries to be linked separated by spaces.



---

archive/issue_comments_231863.json:
```json
{
    "body": "Same for the removal of\n\n```\nbuild/pkgs/cvxopt/patches/setup.py.patch\n```\n\n\nIt's not at all clear whether these changes are related to BLAS setup. Perhaps all non-BLAS-related changes should be factored out to a different ticket, that would make reviewing easier.",
    "created_at": "2015-06-26T12:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231863",
    "user": "jdemeyer"
}
```

Same for the removal of

```
build/pkgs/cvxopt/patches/setup.py.patch
```


It's not at all clear whether these changes are related to BLAS setup. Perhaps all non-BLAS-related changes should be factored out to a different ticket, that would make reviewing easier.



---

archive/issue_comments_231864.json:
```json
{
    "body": "Replying to [comment:54 jpflori]:\n> Because this does not do the same thing :).\nThat's exactly why such changes shouldn't be smuggled inside a ticket dealing with BLAS.",
    "created_at": "2015-06-26T12:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231864",
    "user": "jdemeyer"
}
```

Replying to [comment:54 jpflori]:
> Because this does not do the same thing :).
That's exactly why such changes shouldn't be smuggled inside a ticket dealing with BLAS.



---

archive/issue_comments_231865.json:
```json
{
    "body": "Replying to [comment:56 jdemeyer]:\n> Same for the removal of\n> {{{\n> build/pkgs/cvxopt/patches/setup.py.patch\n> }}}\n> \n> It's not at all clear whether these changes are related to BLAS setup.\nThis patch is a dirty hack to configure cvxopt to use BLAS related stuff.\n\n> Perhaps all non-BLAS-related changes should be factored out to a different ticket, that would make\n> reviewing easier.\nSure that would be the best way to go.",
    "created_at": "2015-06-26T12:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231865",
    "user": "jpflori"
}
```

Replying to [comment:56 jdemeyer]:
> Same for the removal of
> {{{
> build/pkgs/cvxopt/patches/setup.py.patch
> }}}
> 
> It's not at all clear whether these changes are related to BLAS setup.
This patch is a dirty hack to configure cvxopt to use BLAS related stuff.

> Perhaps all non-BLAS-related changes should be factored out to a different ticket, that would make
> reviewing easier.
Sure that would be the best way to go.



---

archive/issue_comments_231866.json:
```json
{
    "body": "Replying to [comment:53 jdemeyer]:\n> I would also like to know the justification for the removal of\n> {{{\n> build/pkgs/numpy/patches/cygwin-lapack_lite-setup.py.diff\n> }}}\nI just remember this patch looked fishy and useless and I had no problem not applying it.",
    "created_at": "2015-06-26T12:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231866",
    "user": "jpflori"
}
```

Replying to [comment:53 jdemeyer]:
> I would also like to know the justification for the removal of
> {{{
> build/pkgs/numpy/patches/cygwin-lapack_lite-setup.py.diff
> }}}
I just remember this patch looked fishy and useless and I had no problem not applying it.



---

archive/issue_comments_231867.json:
```json
{
    "body": "Replying to [comment:58 jpflori]:\n> Replying to [comment:56 jdemeyer]:\n> > Same for the removal of\n> > {{{\n> > build/pkgs/cvxopt/patches/setup.py.patch\n> > }}}\n> > \n> > It's not at all clear whether these changes are related to BLAS setup.\n> This patch is a dirty hack to configure cvxopt to use BLAS related stuff.\n\nThere is also GSL-related stuff in that patch.",
    "created_at": "2015-06-26T12:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231867",
    "user": "jdemeyer"
}
```

Replying to [comment:58 jpflori]:
> Replying to [comment:56 jdemeyer]:
> > Same for the removal of
> > {{{
> > build/pkgs/cvxopt/patches/setup.py.patch
> > }}}
> > 
> > It's not at all clear whether these changes are related to BLAS setup.
> This patch is a dirty hack to configure cvxopt to use BLAS related stuff.

There is also GSL-related stuff in that patch.



---

archive/issue_comments_231868.json:
```json
{
    "body": "I guess we can split some of the cvxopt stuff to make things clearer. Prior to 1.1.7 it was difficult to set any library properly without patching. `setup.py` was requiring manual edit before installation unless you setup was closely matching the author. 1.1.7 introduced some mechanism to pass library settings from the environment and we just decided to do that at the same time. But a separate ticket is no problem.",
    "created_at": "2015-06-26T12:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231868",
    "user": "fbissey"
}
```

I guess we can split some of the cvxopt stuff to make things clearer. Prior to 1.1.7 it was difficult to set any library properly without patching. `setup.py` was requiring manual edit before installation unless you setup was closely matching the author. 1.1.7 introduced some mechanism to pass library settings from the environment and we just decided to do that at the same time. But a separate ticket is no problem.



---

archive/issue_comments_231869.json:
```json
{
    "body": "Now that you explain the `cvxopt` thing, it's clearer.",
    "created_at": "2015-06-26T12:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231869",
    "user": "jdemeyer"
}
```

Now that you explain the `cvxopt` thing, it's clearer.



---

archive/issue_comments_231870.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-26T13:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231870",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231871.json:
```json
{
    "body": "I'll do some more work over the week end, the last commit is just so that sage with that branch is in a building state.",
    "created_at": "2015-06-26T13:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231871",
    "user": "fbissey"
}
```

I'll do some more work over the week end, the last commit is just so that sage with that branch is in a building state.



---

archive/issue_comments_231872.json:
```json
{
    "body": "For this to work properly, you will need to increase the patchlevel of the ATLAS package, forcing it to be rebuilt. For the other packages, I don't think it's needed if they depend on ATLAS.",
    "created_at": "2015-06-26T21:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231872",
    "user": "jdemeyer"
}
```

For this to work properly, you will need to increase the patchlevel of the ATLAS package, forcing it to be rebuilt. For the other packages, I don't think it's needed if they depend on ATLAS.



---

archive/issue_comments_231873.json:
```json
{
    "body": "Replying to [comment:62 jdemeyer]:\n> Now that you explain the `cvxopt` thing, it's clearer.\n\nDo you still want a separate ticket?",
    "created_at": "2015-06-27T10:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231873",
    "user": "fbissey"
}
```

Replying to [comment:62 jdemeyer]:
> Now that you explain the `cvxopt` thing, it's clearer.

Do you still want a separate ticket?



---

archive/issue_comments_231874.json:
```json
{
    "body": "Replying to [comment:55 jpflori]:\n> Replying to [comment:51 jdemeyer]:\n> > Instead of\n> > {{{\n> > #!sh\n> > IML_BLAS=--with-cblas=\"$cblas_libs\"\n> > \n> > ./configure \"$IML_BLAS\"\n> > }}}\n> > with awkward quoting, why not simply\n> > {{{\n> > ./configure --with-cblas=\"$cblas_libs\"\n> > }}}\n> > (same for `FFLAS_FFPACK_BLAS`)\n> I don't really remember, but both might work as well.\n> IIRC FFLAS-FFPACK configure scripts is very sensitive to quoting and spaces and it was a nightmare to make it accept multiple libraries to be linked separated by spaces.\n\nIn both case the variable is only defined on cygwin/darwin and we rely on autodetection in other cases. I guess we could throw the autodetection throw the window and put the stuff in every case. In fact if we want to be able to use something else than ATLAS in the future it is prudent to do so. So I will throw the particular cases out. If there is a strong case to still keep something for cygwin I am all ears.",
    "created_at": "2015-06-27T10:29:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231874",
    "user": "fbissey"
}
```

Replying to [comment:55 jpflori]:
> Replying to [comment:51 jdemeyer]:
> > Instead of
> > {{{
> > #!sh
> > IML_BLAS=--with-cblas="$cblas_libs"
> > 
> > ./configure "$IML_BLAS"
> > }}}
> > with awkward quoting, why not simply
> > {{{
> > ./configure --with-cblas="$cblas_libs"
> > }}}
> > (same for `FFLAS_FFPACK_BLAS`)
> I don't really remember, but both might work as well.
> IIRC FFLAS-FFPACK configure scripts is very sensitive to quoting and spaces and it was a nightmare to make it accept multiple libraries to be linked separated by spaces.

In both case the variable is only defined on cygwin/darwin and we rely on autodetection in other cases. I guess we could throw the autodetection throw the window and put the stuff in every case. In fact if we want to be able to use something else than ATLAS in the future it is prudent to do so. So I will throw the particular cases out. If there is a strong case to still keep something for cygwin I am all ears.



---

archive/issue_comments_231875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-27T11:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231875",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231876.json:
```json
{
    "body": "I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files. After Jeroen clean up of the other tickets that's a total of 5 files (plus one optional file) so not a big job but I'll probably end with some redundancies on my first go (i.e. stuff that's not needed thanks to other declarations in `.pxd`).",
    "created_at": "2015-06-27T11:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231876",
    "user": "fbissey"
}
```

I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files. After Jeroen clean up of the other tickets that's a total of 5 files (plus one optional file) so not a big job but I'll probably end with some redundancies on my first go (i.e. stuff that's not needed thanks to other declarations in `.pxd`).



---

archive/issue_comments_231877.json:
```json
{
    "body": "Replying to [comment:69 fbissey]:\n> I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.\nI'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.\n\nI might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated \"unset\" and \"set to empty\" equivalently. So such a change shouldn't be made lightly.\n\nTwo other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.",
    "created_at": "2015-06-28T07:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231877",
    "user": "jdemeyer"
}
```

Replying to [comment:69 fbissey]:
> I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.
I'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.

I might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated "unset" and "set to empty" equivalently. So such a change shouldn't be made lightly.

Two other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.



---

archive/issue_comments_231878.json:
```json
{
    "body": "Replying to [comment:70 jdemeyer]:\n> Replying to [comment:69 fbissey]:\n> > I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.\n> I'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.\n\nThat's a fair comment we touched things all over the place and some more will need to be \"aligned\" eventually. \n\n> \n> I might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated \"unset\" and \"set to empty\" equivalently. So such a change shouldn't be made lightly.\n> \n\nI am a bit concerned that there is even a need for these tests and setting/unsetting. It just feel wrong so I am probably not the best person to pass a judgement on that particular change, my own reaction is to make the whole thing disappear.\n\n> Two other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.\n\nI will check the indent ASAP and I was afraid you would ask for that doctest, but I know what to do.\n\n`@`Jean-Pierre, any comments on the last few commits? As can be surmised by comments we'll eventually touch again some packages using `blas/cblas/lapack` to enforce settings in the future. But as Jeroen says there is enough here already.",
    "created_at": "2015-06-28T10:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231878",
    "user": "fbissey"
}
```

Replying to [comment:70 jdemeyer]:
> Replying to [comment:69 fbissey]:
> > I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.
> I'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.

That's a fair comment we touched things all over the place and some more will need to be "aligned" eventually. 

> 
> I might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated "unset" and "set to empty" equivalently. So such a change shouldn't be made lightly.
> 

I am a bit concerned that there is even a need for these tests and setting/unsetting. It just feel wrong so I am probably not the best person to pass a judgement on that particular change, my own reaction is to make the whole thing disappear.

> Two other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.

I will check the indent ASAP and I was afraid you would ask for that doctest, but I know what to do.

`@`Jean-Pierre, any comments on the last few commits? As can be surmised by comments we'll eventually touch again some packages using `blas/cblas/lapack` to enforce settings in the future. But as Jeroen says there is enough here already.



---

archive/issue_comments_231879.json:
```json
{
    "body": "Replying to [comment:71 fbissey]:\n> Replying to [comment:70 jdemeyer]:\n> > Replying to [comment:69 fbissey]:\n> > > I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.\n> > I'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.\n> \n> That's a fair comment we touched things all over the place and some more will need to be \"aligned\" eventually. \n> \n> > \n> > I might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated \"unset\" and \"set to empty\" equivalently. So such a change shouldn't be made lightly.\n> > \n> \n> I am a bit concerned that there is even a need for these tests and setting/unsetting. It just feel wrong so I am probably not the best person to pass a judgement on that particular change, my own reaction is to make the whole thing disappear.\n>\nMy only point is that now `LDFLAGS` just follows what `CFLAGS` does and gave me a better behavior.\nSo I don't agree that we've always treated LDFLAGS and CFLAGS (and CXXFLAGS) in the same way when they are unset and empty.\n\nThe problem with the current behavior of  LDFLAGS, is that if `LDFLAGS` is not set, then whe get `LDFLAGS=\"\"`.\nAnd some packages won't touch LDFLAGS if `LFDLAGS=\"\"`.\nIf you feel worried about this, then just remove this change.\n\nFor the current behavior of CFLAGS, what you get is that if CFLAGS is empty, then it's unset, that might not be the best behavior as well...\n\n> > Two other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.\n> \n> I will check the indent ASAP and I was afraid you would ask for that doctest, but I know what to do.\n> \n> `@`Jean-Pierre, any comments on the last few commits? As can be surmised by comments we'll eventually touch again some packages using `blas/cblas/lapack` to enforce settings in the future. But as Jeroen says there is enough here already.\n\nYeah I generally agree with going step by step even if the current solution is not perfect.\n\nI also spotted a few indentation issues in `atlas/spkg-install` and `src/sage/env.py`",
    "created_at": "2015-06-28T14:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231879",
    "user": "jpflori"
}
```

Replying to [comment:71 fbissey]:
> Replying to [comment:70 jdemeyer]:
> > Replying to [comment:69 fbissey]:
> > > I'll happily field comments on the new changes but I will otherwise start moving libraries to the `.pxd` files.
> > I'd do that in a new ticket. There is already a lot of stuff on this ticket and I wouldn't add anything more.
> 
> That's a fair comment we touched things all over the place and some more will need to be "aligned" eventually. 
> 
> > 
> > I might not have much time these days to look at this ticket, so you can just go ahead. I am still very suspicious about the change to `LDFLAGS` in `sage-env`: it's a seemingly innocent change but with so much potential to break stuff. For handling `CFLAGS`, `LDFLAGS`,... in Sage we have always treated "unset" and "set to empty" equivalently. So such a change shouldn't be made lightly.
> > 
> 
> I am a bit concerned that there is even a need for these tests and setting/unsetting. It just feel wrong so I am probably not the best person to pass a judgement on that particular change, my own reaction is to make the whole thing disappear.
>
My only point is that now `LDFLAGS` just follows what `CFLAGS` does and gave me a better behavior.
So I don't agree that we've always treated LDFLAGS and CFLAGS (and CXXFLAGS) in the same way when they are unset and empty.

The problem with the current behavior of  LDFLAGS, is that if `LDFLAGS` is not set, then whe get `LDFLAGS=""`.
And some packages won't touch LDFLAGS if `LFDLAGS=""`.
If you feel worried about this, then just remove this change.

For the current behavior of CFLAGS, what you get is that if CFLAGS is empty, then it's unset, that might not be the best behavior as well...

> > Two other small things I noticed now: there is some strange indentation in `atlas/spkg-install`, be sure to use mutiples of 4 spaces everywhere. And of course `get_libs_config()` needs a doctest.
> 
> I will check the indent ASAP and I was afraid you would ask for that doctest, but I know what to do.
> 
> `@`Jean-Pierre, any comments on the last few commits? As can be surmised by comments we'll eventually touch again some packages using `blas/cblas/lapack` to enforce settings in the future. But as Jeroen says there is enough here already.

Yeah I generally agree with going step by step even if the current solution is not perfect.

I also spotted a few indentation issues in `atlas/spkg-install` and `src/sage/env.py`



---

archive/issue_comments_231880.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-29T09:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231880",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231881.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-29T09:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231881",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_231882.json:
```json
{
    "body": "Replying to [comment:72 jpflori]:\n> I also spotted a few indentation issues in `atlas/spkg-install` and `src/sage/env.py`\n\nFound some stuff in `spkg-install` but cannot see anything in `env.py`, if there is something you'll have to provide a line number. I am putting this for review now.",
    "created_at": "2015-06-29T09:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231882",
    "user": "fbissey"
}
```

Replying to [comment:72 jpflori]:
> I also spotted a few indentation issues in `atlas/spkg-install` and `src/sage/env.py`

Found some stuff in `spkg-install` but cannot see anything in `env.py`, if there is something you'll have to provide a line number. I am putting this for review now.



---

archive/issue_comments_231883.json:
```json
{
    "body": "[comment:49] hasn't been addressed.",
    "created_at": "2015-06-29T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231883",
    "user": "jdemeyer"
}
```

[comment:49] hasn't been addressed.



---

archive/issue_comments_231884.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-29T09:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231884",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_231885.json:
```json
{
    "body": "Replying to [comment:75 jdemeyer]:\n> [comment:49] hasn't been addressed.\n\nWhile I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive, I'll surrender to the fact that it belongs to another ticket that I'll happily review positively. Waiting for my OS X build to finish before committing that change.",
    "created_at": "2015-06-29T09:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231885",
    "user": "fbissey"
}
```

Replying to [comment:75 jdemeyer]:
> [comment:49] hasn't been addressed.

While I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive, I'll surrender to the fact that it belongs to another ticket that I'll happily review positively. Waiting for my OS X build to finish before committing that change.



---

archive/issue_comments_231886.json:
```json
{
    "body": "Yeah, just postpone it to another ticket (but also make sure that our treatment of LDFLAGS does not break CVXOPT or other package linking to BLAS which need to be fed stuff through LDFLAGS).",
    "created_at": "2015-06-29T10:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231886",
    "user": "jpflori"
}
```

Yeah, just postpone it to another ticket (but also make sure that our treatment of LDFLAGS does not break CVXOPT or other package linking to BLAS which need to be fed stuff through LDFLAGS).



---

archive/issue_comments_231887.json:
```json
{
    "body": "Replying to [comment:76 fbissey]:\n> While I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive\n\nThe treating of `{C,CXX}FLAGS` changed recently in #16149 and I don't understand why that change was needed.\n\nPersonally, I would prefer to not treat empty and non-empty `FOOFLAGS` fundamentally different (i.e. I would revert #16149 and leave `LDFLAGS` as they are).",
    "created_at": "2015-06-29T11:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231887",
    "user": "jdemeyer"
}
```

Replying to [comment:76 fbissey]:
> While I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive

The treating of `{C,CXX}FLAGS` changed recently in #16149 and I don't understand why that change was needed.

Personally, I would prefer to not treat empty and non-empty `FOOFLAGS` fundamentally different (i.e. I would revert #16149 and leave `LDFLAGS` as they are).



---

archive/issue_comments_231888.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-29T12:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231888",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231889.json:
```json
{
    "body": "Replying to [comment:78 jdemeyer]:\n> Replying to [comment:76 fbissey]:\n> > While I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive\n> \n> The treating of `{C,CXX}FLAGS` changed recently in #16149 and I don't understand why that change was needed.\n> \n> Personally, I would prefer to not treat empty and non-empty `FOOFLAGS` fundamentally different (i.e. I would revert #16149 and leave `LDFLAGS` as they are).\nHaving `*FLAGS` empty or unset are two different things.\nMaybe it should be the same, but some libraries deal with it differently.\nE.g. when it's unset it means do whatever you want with `*FLAGS` and if it is empty, it means leave it empty.\nOf course, this is not a universal truth and different libraries behaves differently.\nSo as far as I'm concerned, I would just not touch `*FLAGS` at all.",
    "created_at": "2015-06-29T14:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231889",
    "user": "jpflori"
}
```

Replying to [comment:78 jdemeyer]:
> Replying to [comment:76 fbissey]:
> > While I find the argument that `LDFLAGS` should be treated just the same as `{C,CXX}FLAGS` persuasive
> 
> The treating of `{C,CXX}FLAGS` changed recently in #16149 and I don't understand why that change was needed.
> 
> Personally, I would prefer to not treat empty and non-empty `FOOFLAGS` fundamentally different (i.e. I would revert #16149 and leave `LDFLAGS` as they are).
Having `*FLAGS` empty or unset are two different things.
Maybe it should be the same, but some libraries deal with it differently.
E.g. when it's unset it means do whatever you want with `*FLAGS` and if it is empty, it means leave it empty.
Of course, this is not a universal truth and different libraries behaves differently.
So as far as I'm concerned, I would just not touch `*FLAGS` at all.



---

archive/issue_comments_231890.json:
```json
{
    "body": "Replying to [comment:80 jpflori]:\n> Having `*FLAGS` empty or unset are two different things.\nI know and understand that, but my point is that it shouldn't be two different things.",
    "created_at": "2015-06-29T16:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231890",
    "user": "jdemeyer"
}
```

Replying to [comment:80 jpflori]:
> Having `*FLAGS` empty or unset are two different things.
I know and understand that, but my point is that it shouldn't be two different things.



---

archive/issue_comments_231891.json:
```json
{
    "body": "In any case, can we please *in this ticket* remove the changes to `sage-env` and discuss this somewhere else?",
    "created_at": "2015-06-29T18:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231891",
    "user": "jdemeyer"
}
```

In any case, can we please *in this ticket* remove the changes to `sage-env` and discuss this somewhere else?



---

archive/issue_comments_231892.json:
```json
{
    "body": "Ticket causes problems on OS X, so not ready yet.",
    "created_at": "2015-06-30T05:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231892",
    "user": "fbissey"
}
```

Ticket causes problems on OS X, so not ready yet.



---

archive/issue_comments_231893.json:
```json
{
    "body": "The `sed` command is not doing its job\n\n```\nMirage:sage-6.8.beta5 fbissey$ cat local/share/blas_config|sed 's/\\([^ ]\\+\\)/-l\\1/g'\nblas\n```\n",
    "created_at": "2015-06-30T06:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231893",
    "user": "fbissey"
}
```

The `sed` command is not doing its job

```
Mirage:sage-6.8.beta5 fbissey$ cat local/share/blas_config|sed 's/\([^ ]\+\)/-l\1/g'
blas
```




---

archive/issue_comments_231894.json:
```json
{
    "body": "I believe that `\\+` in `sed` regexps for \"match 1 or more times\" is not portable. But you can replace `X\\+` by `XX*` for any value of `X`.",
    "created_at": "2015-06-30T07:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231894",
    "user": "jdemeyer"
}
```

I believe that `\+` in `sed` regexps for "match 1 or more times" is not portable. But you can replace `X\+` by `XX*` for any value of `X`.



---

archive/issue_comments_231895.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-30T08:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231895",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231896.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-30T09:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231896",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_231897.json:
```json
{
    "body": "Thanks for the portability tip Jeroen, that got me through the stuff using autotools. OS X stuff has been compromised in `numpy` and very likely `scipy`, working on that.",
    "created_at": "2015-06-30T10:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231897",
    "user": "fbissey"
}
```

Thanks for the portability tip Jeroen, that got me through the stuff using autotools. OS X stuff has been compromised in `numpy` and very likely `scipy`, working on that.



---

archive/issue_comments_231898.json:
```json
{
    "body": "I just got an idea: why aren't we using a `pkgconfig` file instead of `local/share/blas_config`? I seems like `pkgconfig` is exactly meant to solve the problems we're having on this ticket.\n\nA typical file looks like\n\n```\n$ cat local/lib/pkgconfig/m4ri.pc \nSAGE_ROOT=/usr/local/src/sage-config\nprefix=${SAGE_ROOT}/local\nexec_prefix=${prefix}\nlibdir=${SAGE_ROOT}/local/lib\nincludedir=${prefix}/include\n\nName: M4RI\nDescription: Dense linear algebra over GF(2).\nVersion: 20140914\nLibs: -L${libdir} -lm4ri -lm\nCflags: -I${includedir}/m4ri  -I${SAGE_ROOT}/local/include -g -fPIC -Wall -pedantic -O2  -mmmx -msse -msse2 -msse3 \n```\n\n\nI am sure we can make a `blas.pc` file using this format.\n\nFrom the shell, you can do for example\n\n```\n(sage-sh) $ pkgconf --libs m4ri\n-lm4ri -lm  \n```\n\nwhich would replace the ugly `sed` script.\n\nThere is also a Python interface:\n\n```\nsage: import pkgconfig\nsage: pkgconfig.libs(\"m4ri\")\nu'-L/usr/local/src/sage-config/local/lib -lm4ri -lm'\n```\n",
    "created_at": "2015-06-30T15:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231898",
    "user": "jdemeyer"
}
```

I just got an idea: why aren't we using a `pkgconfig` file instead of `local/share/blas_config`? I seems like `pkgconfig` is exactly meant to solve the problems we're having on this ticket.

A typical file looks like

```
$ cat local/lib/pkgconfig/m4ri.pc 
SAGE_ROOT=/usr/local/src/sage-config
prefix=${SAGE_ROOT}/local
exec_prefix=${prefix}
libdir=${SAGE_ROOT}/local/lib
includedir=${prefix}/include

Name: M4RI
Description: Dense linear algebra over GF(2).
Version: 20140914
Libs: -L${libdir} -lm4ri -lm
Cflags: -I${includedir}/m4ri  -I${SAGE_ROOT}/local/include -g -fPIC -Wall -pedantic -O2  -mmmx -msse -msse2 -msse3 
```


I am sure we can make a `blas.pc` file using this format.

From the shell, you can do for example

```
(sage-sh) $ pkgconf --libs m4ri
-lm4ri -lm  
```

which would replace the ugly `sed` script.

There is also a Python interface:

```
sage: import pkgconfig
sage: pkgconfig.libs("m4ri")
u'-L/usr/local/src/sage-config/local/lib -lm4ri -lm'
```




---

archive/issue_comments_231899.json:
```json
{
    "body": "Using `pkgconfig` is actually the final destination.\nThis ticket was just a cleanup ticket before #17075.",
    "created_at": "2015-06-30T16:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231899",
    "user": "jpflori"
}
```

Using `pkgconfig` is actually the final destination.
This ticket was just a cleanup ticket before #17075.



---

archive/issue_comments_231900.json:
```json
{
    "body": "What you're doing here on this ticket with `$SAGE_SHARE/blas_config` is very close to `pkgconfig`. So why not just use `pkgconfig` instead?",
    "created_at": "2015-06-30T17:26:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231900",
    "user": "jdemeyer"
}
```

What you're doing here on this ticket with `$SAGE_SHARE/blas_config` is very close to `pkgconfig`. So why not just use `pkgconfig` instead?



---

archive/issue_comments_231901.json:
```json
{
    "body": "I guess that at the time this ticket was opened, pkgconfig was not standard though I could not swear it.",
    "created_at": "2015-06-30T21:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231901",
    "user": "jpflori"
}
```

I guess that at the time this ticket was opened, pkgconfig was not standard though I could not swear it.



---

archive/issue_comments_231902.json:
```json
{
    "body": "When I started talking about #17075 and associated work to be able to use any `blas/lapack` our goal was to use `pkgconfig` and `https://github.com/matze/pkgconfig` as a python interface to it. This is what `sage-on-gentoo` is currently using. The fact that the python interface was also standard escaped me.\n\nWe included `pkgconfig` in sage when we upgraded to `matplotlib-1.3.x` after I determined that it was the only to build it on OS X while reviewing that ticket. That would have been after #17075 but I am not sure if it was before this ticket.\n\nFor reference this is the current sage-on-gentoo patch for 6.8.beta6 https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-6.8-blas-r1.patch\n\nThe librarydir part is for dealing with BLAS/LAPACK installed in less standard location (`/opt`) where they may be out of the library search path when linking. It still relies on said path to be in `ld.so.config` or equivalent. Typical cases are intel MKL and AMD acml. The ability to compile against MKL is one of the key motivation here.\n\nSince we have all the elements, going `.pc` all the way is fine. I'll rewrite the whole thing.\n\nAs mentioned before I spent some time working on OS X and that's also one of my motivation to rewrite some stuff. That's an interesting little story that touch `sage-env` (surprise)....\n\nSo Jean-Pierre put this in `numpy` and `scipy`\n\n```\nif [ -n \"${LDFLAGS+set}\" ]; then\n    if [ \"$UNAME\" != \"Darwin\" ]; then\n        export LDFLAGS=\"-bundle -undefined dynamic_lookup $LDFLAGS\"\n        export CPPFLAGS=\"-D__ACCELERATE__ $CPPFLAGS\"\n    else\n        export LDFLAGS=\"-shared $LDFLAGS\"\n    fi\nfi\n```\n\nWhich definitely looked wrong on first glance but I trusted Jean-Pierre. Well it is wrong and compilation will fail on OS X because somehow you'll have `-bundle` and `-shared` in `LDFLAGS` at the same time. Unless you include Jean-Pierre changes to `sage-env` in which case `numpy` at least compile. I'll hazard that the change to `sage-env` enable compilation under linux as well somehow.\n\nSo there we are the change to `sage-env` was allowing wrong stuff in `numpy` and `scipy` (not on OS X) to work to some extent.\n\nMy local branch is in a bit of a mess and I think I pushed too much stuff on trac so I'll get a clean branch in.",
    "created_at": "2015-07-01T11:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231902",
    "user": "fbissey"
}
```

When I started talking about #17075 and associated work to be able to use any `blas/lapack` our goal was to use `pkgconfig` and `https://github.com/matze/pkgconfig` as a python interface to it. This is what `sage-on-gentoo` is currently using. The fact that the python interface was also standard escaped me.

We included `pkgconfig` in sage when we upgraded to `matplotlib-1.3.x` after I determined that it was the only to build it on OS X while reviewing that ticket. That would have been after #17075 but I am not sure if it was before this ticket.

For reference this is the current sage-on-gentoo patch for 6.8.beta6 https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-6.8-blas-r1.patch

The librarydir part is for dealing with BLAS/LAPACK installed in less standard location (`/opt`) where they may be out of the library search path when linking. It still relies on said path to be in `ld.so.config` or equivalent. Typical cases are intel MKL and AMD acml. The ability to compile against MKL is one of the key motivation here.

Since we have all the elements, going `.pc` all the way is fine. I'll rewrite the whole thing.

As mentioned before I spent some time working on OS X and that's also one of my motivation to rewrite some stuff. That's an interesting little story that touch `sage-env` (surprise)....

So Jean-Pierre put this in `numpy` and `scipy`

```
if [ -n "${LDFLAGS+set}" ]; then
    if [ "$UNAME" != "Darwin" ]; then
        export LDFLAGS="-bundle -undefined dynamic_lookup $LDFLAGS"
        export CPPFLAGS="-D__ACCELERATE__ $CPPFLAGS"
    else
        export LDFLAGS="-shared $LDFLAGS"
    fi
fi
```

Which definitely looked wrong on first glance but I trusted Jean-Pierre. Well it is wrong and compilation will fail on OS X because somehow you'll have `-bundle` and `-shared` in `LDFLAGS` at the same time. Unless you include Jean-Pierre changes to `sage-env` in which case `numpy` at least compile. I'll hazard that the change to `sage-env` enable compilation under linux as well somehow.

So there we are the change to `sage-env` was allowing wrong stuff in `numpy` and `scipy` (not on OS X) to work to some extent.

My local branch is in a bit of a mess and I think I pushed too much stuff on trac so I'll get a clean branch in.



---

archive/issue_comments_231903.json:
```json
{
    "body": "Replying to [comment:94 fbissey]:\n> When I started talking about #17075 and associated work to be able to use any `blas/lapack` our goal was to use `pkgconfig` and `https://github.com/matze/pkgconfig` as a python interface to it. This is what `sage-on-gentoo` is currently using. The fact that the python interface was also standard escaped me.\n> \n> We included `pkgconfig` in sage when we upgraded to `matplotlib-1.3.x` after I determined that it was the only to build it on OS X while reviewing that ticket. That would have been after #17075 but I am not sure if it was before this ticket.\n> \n> For reference this is the current sage-on-gentoo patch for 6.8.beta6 https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-6.8-blas-r1.patch\n> \n> The librarydir part is for dealing with BLAS/LAPACK installed in less standard location (`/opt`) where they may be out of the library search path when linking. It still relies on said path to be in `ld.so.config` or equivalent. Typical cases are intel MKL and AMD acml. The ability to compile against MKL is one of the key motivation here.\n> \n> Since we have all the elements, going `.pc` all the way is fine. I'll rewrite the whole thing.\n> \n> As mentioned before I spent some time working on OS X and that's also one of my motivation to rewrite some stuff. That's an interesting little story that touch `sage-env` (surprise)....\n> \n> So Jean-Pierre put this in `numpy` and `scipy`\n> {{{\n> if [ -n \"${LDFLAGS+set}\" ]; then\n>     if [ \"$UNAME\" != \"Darwin\" ]; then\n>         export LDFLAGS=\"-bundle -undefined dynamic_lookup $LDFLAGS\"\n>         export CPPFLAGS=\"-D__ACCELERATE__ $CPPFLAGS\"\n>     else\n>         export LDFLAGS=\"-shared $LDFLAGS\"\n>     fi\n> fi\n> }}}\n> Which definitely looked wrong on first glance but I trusted Jean-Pierre.\nI wouldn't it definitely looks wrong on non-OS Xes :)\nRead the comment above this part of code.\nIf `LDFLAGS` is set, you need to add `-shared` yourself.\nThis is exactly what is done here.\nAnd yes you are right, this must be the reason for my changes to `sage-env`, as if `LDFLAGS` is set but empty, then `shared` won't be added and the compilation will fail.\nThe easy solution is to unconditionnally add `-shared` to `LDFLAGS` on non-OS X.\n\nAs far as OS X is concerned, I guess I got this from \"the web\" as I don't have access to any OS X machine and cried for testing here before.",
    "created_at": "2015-07-01T12:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231903",
    "user": "jpflori"
}
```

Replying to [comment:94 fbissey]:
> When I started talking about #17075 and associated work to be able to use any `blas/lapack` our goal was to use `pkgconfig` and `https://github.com/matze/pkgconfig` as a python interface to it. This is what `sage-on-gentoo` is currently using. The fact that the python interface was also standard escaped me.
> 
> We included `pkgconfig` in sage when we upgraded to `matplotlib-1.3.x` after I determined that it was the only to build it on OS X while reviewing that ticket. That would have been after #17075 but I am not sure if it was before this ticket.
> 
> For reference this is the current sage-on-gentoo patch for 6.8.beta6 https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/files/sage-6.8-blas-r1.patch
> 
> The librarydir part is for dealing with BLAS/LAPACK installed in less standard location (`/opt`) where they may be out of the library search path when linking. It still relies on said path to be in `ld.so.config` or equivalent. Typical cases are intel MKL and AMD acml. The ability to compile against MKL is one of the key motivation here.
> 
> Since we have all the elements, going `.pc` all the way is fine. I'll rewrite the whole thing.
> 
> As mentioned before I spent some time working on OS X and that's also one of my motivation to rewrite some stuff. That's an interesting little story that touch `sage-env` (surprise)....
> 
> So Jean-Pierre put this in `numpy` and `scipy`
> {{{
> if [ -n "${LDFLAGS+set}" ]; then
>     if [ "$UNAME" != "Darwin" ]; then
>         export LDFLAGS="-bundle -undefined dynamic_lookup $LDFLAGS"
>         export CPPFLAGS="-D__ACCELERATE__ $CPPFLAGS"
>     else
>         export LDFLAGS="-shared $LDFLAGS"
>     fi
> fi
> }}}
> Which definitely looked wrong on first glance but I trusted Jean-Pierre.
I wouldn't it definitely looks wrong on non-OS Xes :)
Read the comment above this part of code.
If `LDFLAGS` is set, you need to add `-shared` yourself.
This is exactly what is done here.
And yes you are right, this must be the reason for my changes to `sage-env`, as if `LDFLAGS` is set but empty, then `shared` won't be added and the compilation will fail.
The easy solution is to unconditionnally add `-shared` to `LDFLAGS` on non-OS X.

As far as OS X is concerned, I guess I got this from "the web" as I don't have access to any OS X machine and cried for testing here before.



---

archive/issue_comments_231904.json:
```json
{
    "body": "In fact the OS X stuff comes from the previous scipy `spkg-install`.\n\nIf think that my idea to test whether `LDFLAGS` is set and only modify it if it is not (differently on OS X and non-OS Xes), is that if `LDFLAGS` is set then the user did it and knows what he did and will know how to fix it if compilation fails.",
    "created_at": "2015-07-01T12:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231904",
    "user": "jpflori"
}
```

In fact the OS X stuff comes from the previous scipy `spkg-install`.

If think that my idea to test whether `LDFLAGS` is set and only modify it if it is not (differently on OS X and non-OS Xes), is that if `LDFLAGS` is set then the user did it and knows what he did and will know how to fix it if compilation fails.



---

archive/issue_comments_231905.json:
```json
{
    "body": "Just a suggestion, feel free to ignore:\n\ndo we really need to change *all* packages using BLAS at the same time? In order to get something in Sage more quickly, could we for example just change ATLAS and the Sage library in this ticket and postpone the other packages to a new ticket?",
    "created_at": "2015-07-02T09:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231905",
    "user": "jdemeyer"
}
```

Just a suggestion, feel free to ignore:

do we really need to change *all* packages using BLAS at the same time? In order to get something in Sage more quickly, could we for example just change ATLAS and the Sage library in this ticket and postpone the other packages to a new ticket?



---

archive/issue_comments_231906.json:
```json
{
    "body": "I approve the motion and that will enable me to move a bit faster and not to deal with the `R` bump. I would very much like to deal with  #17642 next. That and making `cython()` use `distutils` as talked about in #18825",
    "created_at": "2015-07-02T09:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231906",
    "user": "fbissey"
}
```

I approve the motion and that will enable me to move a bit faster and not to deal with the `R` bump. I would very much like to deal with  #17642 next. That and making `cython()` use `distutils` as talked about in #18825



---

archive/issue_comments_231907.json:
```json
{
    "body": "If possible, let's modularize (though I won't personally have time to do anything serious before the 16th or 20th :( ).\nI think we could even make this ticket a task and:\n* write pkgconfig files for ATLAS in #17075,\n* clean up packages using BLAS in dedicated tickets.\n\nAlso note that the new LinBox/FFLAS-FFPACK/Givaro compatible versions should be out very soon (only LinBox 2.x is missing but there is currently a workshop taking place in Grenoble from what I understood).",
    "created_at": "2015-07-02T12:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231907",
    "user": "jpflori"
}
```

If possible, let's modularize (though I won't personally have time to do anything serious before the 16th or 20th :( ).
I think we could even make this ticket a task and:
* write pkgconfig files for ATLAS in #17075,
* clean up packages using BLAS in dedicated tickets.

Also note that the new LinBox/FFLAS-FFPACK/Givaro compatible versions should be out very soon (only LinBox 2.x is missing but there is currently a workshop taking place in Grenoble from what I understood).



---

archive/issue_comments_231908.json:
```json
{
    "body": "I have, I believe, finished the rewrite of ATLAS' `spkg-install` to create `.pc` files. I can push it first thing after breakfast to the right ticket.",
    "created_at": "2015-07-02T12:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231908",
    "user": "fbissey"
}
```

I have, I believe, finished the rewrite of ATLAS' `spkg-install` to create `.pc` files. I can push it first thing after breakfast to the right ticket.



---

archive/issue_comments_231909.json:
```json
{
    "body": "Is this ticket still relevant now that we have #17075?",
    "created_at": "2016-05-09T12:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231909",
    "user": "jdemeyer"
}
```

Is this ticket still relevant now that we have #17075?



---

archive/issue_comments_231910.json:
```json
{
    "body": "I think we can close this one.",
    "created_at": "2017-05-17T09:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231910",
    "user": "jpflori"
}
```

I think we can close this one.



---

archive/issue_comments_231911.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-05-17T09:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231911",
    "user": "jpflori"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_231912.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231912",
    "user": "embray"
}
```

Resolution: wontfix



---

archive/issue_comments_231913.json:
```json
{
    "body": "Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).",
    "created_at": "2017-07-13T07:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17393",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17393#issuecomment-231913",
    "user": "embray"
}
```

Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).
