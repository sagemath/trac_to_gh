# Issue 33172: Size of docker images has increased in 9.5

Issue created by migration from https://trac.sagemath.org/ticket/33409

Original creator: saraedum

Original creation time: 2022-02-23 19:06:31

CC:  tmonteil

In recent years the size of our docker images has increased substantially:

8.4: 579MB
...
9.0: 705MB
...
9.3: 891MB
9.4: 976MB
9.5: 1.45GB

The biggest jump happened with the 9.5 release. The Dockerfile has not really changed in the meantime but something else seems to make that image much bigger than it used to be.


---

Comment by dunfield created at 2022-02-24 03:58:46

Does the Docker script do `make micro_release`?  That tries to strip the binaries of debugging symbols, but with the new `$SAGE_LOCAL/var/lib/sage/venv-python*` directory it misses many of the relevant libraries. For my own Docker image https://github.com/3-manifolds/sagedocker I had to add:

```
find $SAGE_LOCAL/var/lib/sage/venv-python* -type f -exec strip '{}' ';' 2>&1
```

to keep the size of the image from increasing dramatically from 9.4 to 9.5.


---

Comment by saraedum created at 2022-02-24 05:33:02

Thanks for pointing this out. I would not be surprised if that's behind much of the problem.

I am happy to to review a patch to `micro_release`.


---

Comment by slabbe created at 2022-02-24 18:02:37

I know Thierry has experience with trying to get an image of sagemath small (when he builds the SageDebianLive image).


---

Comment by tmonteil created at 2022-02-25 19:55:31

Hi, i could not find any trace of `micro_release`, what is that ?


---

Comment by tmonteil created at 2022-02-25 20:22:12

Replying to [comment:5 tmonteil]:
> Hi, i could not find any trace of `micro_release`, what is that ?

Forget about it, i just found it.


---

Comment by tmonteil created at 2022-02-25 23:44:26

Replying to [comment:3 saraedum]:
> Thanks for pointing this out. I would not be surprised if that's behind much of the problem.
> 
> I am happy to to review a patch to `micro_release`.

Does the current branch fix your issue ?
----
New commits:


---

Comment by slabbe created at 2022-05-05 09:40:44

The 9.5 version available on docker is unusable because it it too big and takes too much time to build (it bust the 60 minutes time limit on the gitlab CI runners, see https://gitlab.com/seblabbe/slabbe/-/pipelines)

It would be nice to see if the change propose here allows to reduce the size and usability of the 9.6 image.


---

Comment by tmonteil created at 2022-06-03 22:09:31

Replying to [comment:10 slabbe]:
> The 9.5 version available on docker is unusable because it it too big and takes too much time to build (it bust the 60 minutes time limit on the gitlab CI runners, see https://gitlab.com/seblabbe/slabbe/-/pipelines)
> 
> It would be nice to see if the change propose here allows to reduce the size and usability of the 9.6 image.

The ticket will not be merged until it is reviewed. What you can do is:
- build Sage 
- run `du -sh SAGE_ROOT/local/`

- run `make micro_release`
- run `du -sh SAGE_ROOT/local/`

- apply this ticket
- run `make micro_release`
- run `du -sh SAGE_ROOT/local/`

and see if each iteration saves some space from the previous one.


---

Comment by slabbe created at 2022-06-23 08:27:51

Ok, before applying this ticket, here is what I get:


```
$ sage -v
SageMath version 9.6.rc4, Release Date: 2022-05-12
```



```
$ du -sh local/
7,0G	local/
$ make micro_release
$ du -sh local/
3,9G	local/
```


And now surprise, that deleted the .git folder ! Luckyly, I think all of my local branches were already pushed on trac.


```
$ git status
fatal: ni ceci ni aucun de ses répertoires parents (jusqu'au point de montage /)
n'est un dépôt git Arrêt à la limite du système de fichiers (GIT_DISCOVERY_ACROSS_FILESYSTEM n'est pas défini).
```



---

Comment by tmonteil created at 2022-06-23 10:18:02

Replying to [comment:12 slabbe]:
> And now surprise, that deleted the .git folder ! Luckyly, I think all of my local branches were already pushed on trac.
> 
> {{{
> $ git status
> fatal: ni ceci ni aucun de ses répertoires parents (jusqu'au point de montage /)
> n'est un dépôt git Arrêt à la limite du système de fichiers (GIT_DISCOVERY_ACROSS_FILESYSTEM n'est pas défini).
> }}}

Argh, i am very sorry i didn't take into account that `make micro_release` does more than just stripping the binaries as i tested within a disposable VM :(


---

Comment by slabbe created at 2022-06-23 12:54:04

Ok, I reinstalled and recompiled this version of sage:

```
$ sage -v
SageMath version 9.7.beta3, Release Date: 2022-06-19
```

The space taken by local is:

```
$ du -sh local
5,8G	local
```


After installing this ticket, I get:

```
$ make micro_release
$ du -sh local
2,4G	local
```


which is better than the above 3.9G (obtained from my daily sage with many optional packages installed).


---

Comment by slabbe created at 2022-06-23 13:00:30

Also, I get this:

```
$ du -sh local/var/lib/sage/*
2,2M	local/var/lib/sage/installed
12K	local/var/lib/sage/scripts
1,2G	local/var/lib/sage/venv-python3.10.3
```

Does it mean that the newly added `local/var/lib/sage/venv-python*` in the proposed branch did not work?


---

Comment by slabbe created at 2022-06-24 08:31:03

To summarize,

**9.7.beta3 without this ticket**:


```
$ sage -v
SageMath version 9.7.beta3, Release Date: 2022-06-19
$ du -sh local/
5,8G	local/
$ make micro_release
$ du -sh local/
3,2G	local/
$ du -sh local/var/lib/sage/*
2,2M	local/var/lib/sage/installed
12K	local/var/lib/sage/scripts
2,0G	local/var/lib/sage/venv-python3.10.3
```


**9.7.beta3 + #33409**:


```
$ sage -v
SageMath version 9.7.beta3, Release Date: 2022-06-19
$ du -sh local
5,8G	local
$ make micro_release
$ du -sh local
2,4G	local
$ du -sh local/var/lib/sage/*
2,2M	local/var/lib/sage/installed
12K	local/var/lib/sage/scripts
1,2G	local/var/lib/sage/venv-python3.10.3
```


Therefore a gain of 800M was done in the size of `local/var/lib/sage/venv-python3.10.3` with the current branch.


---

Comment by slabbe created at 2022-06-26 11:17:10

Before giving a positive review to this ticket, I need to understand something. What are the files that are safe to delete to get a functionnal micro release? Why is `rm -rf local/var/lib/sage/venv-python3.10.3` not a solution as well?


---

Comment by tmonteil created at 2022-06-26 14:43:23

Replying to [comment:17 slabbe]:
> Before giving a positive review to this ticket, I need to understand something. What are the files that are safe to delete to get a functionnal micro release? Why is `rm -rf local/var/lib/sage/venv-python3.10.3` not a solution as well?

No file is removed, but some informations are removed within some binaries, so that those files become smaller, see https://en.wikipedia.org/wiki/Strip_(Unix)


---

Comment by slabbe created at 2022-06-26 15:48:57

ok thank you


---

Comment by slabbe created at 2022-06-26 15:49:15

Changing status from new to needs_review.


---

Comment by slabbe created at 2022-06-26 15:49:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-03 22:06:04

Resolution: fixed
