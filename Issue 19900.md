# Issue 19900: Define "gcc" as standard package

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-02-29 15:47:03

CC:  etn40ff

This ticket is about changing the internal configure/install logic, not about changing behaviour.

"gcc" is a special Sage package because it's currently the only package which is either installed in Sage or used from the system if it's available.

In the future, we probably want more packages like this. It makes sense to mark all these packages as "standard" with some logic in `configure.ac` to skip the installation of certain standard packages.

I propose to define a _standard package_ as a package which will always be available in Sage, either installed by Sage or taken from the system.


---

Comment by jdemeyer created at 2016-02-29 16:04:43

New commits:


---

Comment by git created at 2016-02-29 16:22:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-03-02 09:04:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-03-04 09:13:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-03-04 10:11:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-03-04 10:41:14

Changing status from new to needs_review.


---

Comment by embray created at 2016-03-04 11:25:39

Regarding your `configure.ac` note, if I understand your point correctly, the DebianScience folks have added a set of autoconf rules for detecting many of Sage's packages:

http://anonscm.debian.org/cgit/debian-science/packages/sagemath.git/tree/debian/pruner/configure.ac

It's not exhaustive or fully up to date, and may not be well-enough specified in many cases (i.e. version checks).  But it may provide a nice starting point.  I think though that if more autoconf rules are added for Sage packages they should live in the per-package directories in `build/pkgs` in order to keep things more organized.


---

Comment by embray created at 2016-03-04 11:35:30

As for the actual patch, it looks good to me.

One thing that might be worth considering is rather than setting `$PKG_VAR = \$(INST)/.dummy` for skipped packages, still keep an explicit record of skipped packages in some `$(SKIPPED)/$PKG_VERSION`.  Or maybe better yet determine the version of the package that is being used from the system and write that to a file too.

But I'm not sure--for now it might be YAGNI. But one might also be able to imagine cases where it would be nice to have a record of what Sage *is* using for that package if not the one that was built as part of Sage.


---

Comment by klee created at 2016-03-04 14:35:57

The following sentence in the developer guide is not understood (by me) conforming to the definition of the standard package:

**standard** packages are built by default unless ``configure`` determines that they are not needed.

Shouldn't this be like this:

**standard** packages are built by default unless ``configure`` determines that they are available from the system.

or something close?


---

Comment by git created at 2016-03-04 20:39:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-04 20:43:00

Replying to [comment:12 embray]:
> As for the actual patch, it looks good to me.
Good enough for positive_review?

> One thing that might be worth considering is rather than setting `$PKG_VAR = \$(INST)/.dummy` for skipped packages, still keep an explicit record of skipped packages in some `$(SKIPPED)/$PKG_VERSION`.  Or maybe better yet determine the version of the package that is being used from the system and write that to a file too.
> 
> But I'm not sure--for now it might be YAGNI.
Exactly, I don't really see the point. Moreover, I don't want to assume that this information is constant: it could very well be that Sage is installed and then the system is updated.


---

Comment by vbraun created at 2016-03-05 09:47:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-05 09:47:12

LGTM

It would be nice to use that mechanism for python and mpir as well and then get rid of the SAGE_INSTALL_FETCH_ONLY hack... The source tarball should contain exactly the standard packages.


---

Comment by jdemeyer created at 2016-03-05 09:47:46

Replying to [comment:16 vbraun]:
> It would be nice to use that mechanism for python and mpir as well and then get rid of the SAGE_INSTALL_FETCH_ONLY hack... The source tarball should contain exactly the standard packages.

Of course...


---

Comment by vbraun created at 2016-03-05 12:16:24

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-03-05 12:16:24

There is a doctest for all standard packages:

```
sage -t --long src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 300, in sage.misc.package._package_lists_from_sage_output
Failed example:
    bool(not_installed)
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   1 of   6 in sage.misc.package._package_lists_from_sage_output
    [25 tests, 1 failure, 0.19 s]
```



---

Comment by git created at 2016-03-05 13:33:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-06 17:36:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-06 17:38:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-03-06 17:38:31

I removed that doctest. I also added back `gcc` to the list of packages to download, since GCC may or not be part of `$(STANDARD_PACKAGES)`. The rule `download-for-sdist` should be improved, but not in this ticket.


---

Comment by vbraun created at 2016-03-06 18:41:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-06 23:16:51

Resolution: fixed


---

Comment by embray created at 2016-03-07 09:52:00

Replying to [comment:15 jdemeyer]:
> Replying to [comment:12 embray]:
> > One thing that might be worth considering is rather than setting `$PKG_VAR = \$(INST)/.dummy` for skipped packages, still keep an explicit record of skipped packages in some `$(SKIPPED)/$PKG_VERSION`.  Or maybe better yet determine the version of the package that is being used from the system and write that to a file too.
> > 
> > But I'm not sure--for now it might be YAGNI.
> Exactly, I don't really see the point. Moreover, I don't want to assume that this information is constant: it could very well be that Sage is installed and then the system is updated.

I could make an argument for it. In particular for build dependencies it would be helpful for recording what packages everything was built with--as you say it's not necessarily useful information about what is currently running on the system.

But it would be easy enough to add later if a specific need arises.


---

Comment by vbraun created at 2016-03-07 20:07:18

Changing status from closed to new.


---

Comment by vbraun created at 2016-03-07 20:07:18

Resolution changed from fixed to 


---

Comment by vbraun created at 2016-03-07 20:07:18

This now unconditionally builds GCC; probably because it is in `$(STANDARD_PACKAGES)`.
----
New commits:


---

Comment by jdemeyer created at 2016-03-07 20:50:06

Replying to [comment:25 vbraun]:
> This now unconditionally builds GCC

In "reality" or only on the buildbot? ;-)


---

Comment by git created at 2016-03-07 20:52:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-07 20:52:35

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-03-07 20:52:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-08 12:54:10

Still builds gcc.

The buildbot runs "make start" for the record.


---

Comment by vbraun created at 2016-03-08 12:54:23

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-03-08 13:01:09

Replying to [comment:30 vbraun]:
> Still builds gcc.

I cannot reproduce it. Do you have a link to the full install log?


---

Comment by vbraun created at 2016-03-08 16:11:40

* with this ticket: http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu1510_64s02%20%28Ubuntu%2015.10%2064%20bit%29%20full/builds/32
* without this ticket: http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu1510_64s02%20%28Ubuntu%2015.10%2064%20bit%29%20full/builds/33


---

Comment by jdemeyer created at 2016-03-08 16:20:07

I will have a look on that machine.


---

Comment by jdemeyer created at 2016-03-08 16:25:35

When I'm trying on the same machine, it works as it should.

Can you please keep the build directory (i.e. do not do a new build on that buildbot).


---

Comment by jdemeyer created at 2016-03-08 16:27:44

...or maybe you already did start a new build?


---

Comment by jdemeyer created at 2016-03-08 16:28:12

Can you double-check that you really tested the correct commit of this ticket?


---

Comment by jdemeyer created at 2016-03-08 16:40:56

Please re-test and keep the build directory on the buildbot. I have no idea why it fails on the buildbot...


---

Comment by vbraun created at 2016-03-08 16:41:33

If you look at the stdio of build step 2 "git update" it tells you

```
HEAD is now at b91dec3 Trac #20137: Define "gcc" as standard package
```



---

Comment by vbraun created at 2016-03-08 16:42:27

And I already started a new build, too late...


---

Comment by jdemeyer created at 2016-03-08 16:43:41

What is `b91dec3`? It's not a commit from my branch...


---

Comment by jdemeyer created at 2016-03-08 16:44:58

Normally, this `make` rule should have caused `bootstrap` to run, but it didn't:

```
configure: configure.ac src/bin/sage-version.sh m4/*.m4
    ./bootstrap -d
```

Does the buildbot somehow mess with timestamps?


---

Comment by vbraun created at 2016-03-08 16:53:07

b91dec3 is (was) the merge commit

```
$ git log --graph --oneline b91dec3
*   b91dec3 Trac #20137: Define "gcc" as standard package
* |   6ff2ede Trac #20106: Upgrade to MPFR 3.1.4
* |   e3cdc3e Trac #20172: Matroid Basis Axiom Test has a bug
```



---

Comment by vbraun created at 2016-03-08 16:58:36

And the buildbot doesn't do anything special with timestamps...


---

Comment by jdemeyer created at 2016-03-09 07:29:27

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2016-03-09 07:29:27

I'm setting this back to positive_review in order to test again on the buildbot. I need to see the build directory to understand what the problem is that I cannot reproduce myself.


---

Comment by vbraun created at 2016-03-09 17:31:09

Resolution: fixed


---

Comment by jdemeyer created at 2016-03-09 19:16:25

???


---

Comment by vbraun created at 2016-03-09 20:47:46

Worked this time...
