# Issue 30124: Add pyright config

Issue created by migration from https://trac.sagemath.org/ticket/30361

Original creator: @tobiasdiez

Original creation time: 2020-08-14 20:51:09

CC:  mkoeppe chapoton @mjungmath @kliem

This PR provides a minimal configuration for the static typing checker [pyright](https://github.com/microsoft/pyright). In #29775 typing for the manifolds package is added. As this is currently the only place where typing is used, it's the only source folder for pyright.

There are also quite a few other [code check options](https://github.com/microsoft/pyright/blob/master/docs/configuration.md). These seem to cover similar rules as pyflakes and pycodestyle. Since these two checker have problems with typings (at least in the versions that they are currently used in the patchbot), it might be worthwhile to investigate if they can be completely replaced by pyright.


---

Comment by @tobiasdiez created at 2020-08-14 20:57:31

New commits:


---

Comment by mkoeppe created at 2020-08-14 23:24:31

It would be nice to be able to replicate the style that the current patchbot plugins enforce using these other tools. That would allow developers to form an informed opinion on what tools we should be focusing on...


---

Comment by @tobiasdiez created at 2020-08-16 13:22:32

Pyright is in the first place a static type checker, something that pyflakes does not do (or at least is not designed to do). 

Not that this PR only adds the config file, which aids the developer if he chooses to use pyright locally. It doesn't say that it needs to be used, or is integrated in the build workflow. That can be decided later. Given that pyright relies on node and has superior performance over alternatives as myphy, I could imagine that its good to be used in the build workflow and by developers that use VS code. Python-puristic developers propbably prefer a checker that can be installed via pip.


So I would propose to keep this PR as simple as possible, just add the config file for those people that want to use pyright, and add alternatives / integration with the build workflow later.


---

Comment by mkoeppe created at 2020-08-16 13:49:55

Could you include a comment at the top of this config file with a pointer to documentation or something?


---

Comment by git created at 2020-08-18 08:51:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-18 08:59:00

It's not possible to add comments to json files. But from the name of the file it should be rather clear that it belongs to pyright.

I've extended the pyright config a bit. There are no errors (for the manifolds part), but about 200 warnings. Some of them are false positives due to issues of pyright with cython / lazy import (reported as https://github.com/microsoft/pyright/issues/954 and https://github.com/microsoft/pyright/issues/952), but mostly they are valid things that should be fixed (e.g. possibly unbound variables). If you run pyright across the whole sage code, then there are 400 errors and 20k warnings.

I've also fixed one small issue where a getter was used instead of a setter.


---

Comment by @tobiasdiez created at 2020-08-18 08:59:25

Changing status from new to needs_review.


---

Comment by git created at 2020-08-18 13:46:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-18 13:47:04

How about adding a little section in the developer's guide?


---

Comment by git created at 2020-08-18 15:01:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-20 11:42:22

Done, anything else to do?


---

Comment by mkoeppe created at 2020-08-20 12:51:45

Could you move this new text to the section that I created? `src/doc/en/developer/tools.rst`?


---

Comment by mkoeppe created at 2020-08-20 12:52:45

Also I was hoping for more hands-on documentation -- show what users need to install & type rather than just sending people to the tool's documentation


---

Comment by git created at 2020-08-20 18:51:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-20 18:52:28

Ohh, sorry, I've overlooked that you've already created a new file for it. Thanks!
I've now expanded the documentation.


---

Comment by mkoeppe created at 2020-08-20 22:44:00

Please take a look at #30410 as a possible interface to be advertised in the documentation.


---

Comment by @tobiasdiez created at 2020-08-21 10:38:06

I think it's a good idea to have a consistent interface for running linters and other checks . Thus I welcome the idea of #30410. However, this is rather unrelated to this ticket so I reversed the dependencies.


---

Comment by mkoeppe created at 2020-08-21 16:18:04

pyflakes documentation needs more work


---

Comment by @tobiasdiez created at 2020-08-21 17:30:16

Yeah, I agree but the aim of this ticket wasn't to document the whole lint and testing infrastructure of sage ;-). So let's do this at #30415.


---

Comment by mkoeppe created at 2020-08-21 17:37:34

If you just remove the "......" and the docbuild passes without errors, this is a positive review


---

Comment by git created at 2020-08-21 17:44:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-21 17:45:05

I've removed the dots (previously I thought they have to be there in restructuredtext ;-))
----
New commits:


---

Comment by mkoeppe created at 2020-08-23 23:29:24

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-08-23 23:29:24


```
[dochtml] [manifolds]   File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/matplotlib/sphinxext/plot_directive.py", line 472, in run_code
[dochtml] [manifolds]     exec(code, ns)
[dochtml] [manifolds]   File "<string>", line 11, in <module>
[dochtml] [manifolds]   File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/sage/misc/decorators.py", line 492, in wrapper
[dochtml] [manifolds]     return func(*args, **options)
[dochtml] [manifolds]   File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/site-packages/sage/manifolds/chart.py", line 2931, in plot
[dochtml] [manifolds]     resu.set_aspect_ratio(1)
[dochtml] [manifolds] AttributeError: 'Graphics3dGroup' object has no attribute 'set_aspect_ratio'
[dochtml] [manifolds] The inventory files are in local/share/doc/sage/inventory/en/reference/manifolds.
```



---

Comment by @tobiasdiez created at 2020-08-24 19:36:08

Good that you found this mistake. I've now reverted my changes to the chart.py file.


---

Comment by @tobiasdiez created at 2020-08-24 19:36:30

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-08-24 19:36:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-24 22:03:55


```
[dochtml] OSError: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/doc/en/developer/tools.rst:17: WARNING: Unexpected indentation.
[dochtml] 
```



---

Comment by mkoeppe created at 2020-08-24 22:04:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-25 12:38:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-08-25 12:40:13

The indention should be fixed now. At least I hope so, as I couldn't find any documentation on how to test/validate rst files.


---

Comment by @tobiasdiez created at 2020-08-25 12:40:13

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-25 16:04:01

The only way to validate it is to build the documentation using `make doc-html`...

It would actually be great to have a quick validation which we could plug into tox


---

Comment by mkoeppe created at 2020-08-26 23:40:42

patchbot is green, positive review


---

Comment by mkoeppe created at 2020-08-26 23:40:42

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-27 08:35:00

Some types info has been added in a new code in recent tickets by gh-Ivo-Maffei, e.g. in #30337


Does this mean that `pyrightconfig.json` has to be modified accordingly?


---

Comment by @tobiasdiez created at 2020-08-27 12:38:23

Since pyright is currently not used in the patchbot (or something similar), the configuration file is only important for people that use pyright locally in their development. I would thus suggest that as soon as a bit of typing information has been added in a certain package, than this package should be added to the pyright include statement.

The long term goal should be to set pyrights rules to strict and have all of sage's code tested for each code contribution. I'm not sure what's the most practical way to achieve this.


---

Comment by vbraun created at 2020-09-04 22:56:59

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-09-04 22:56:59

PDF docs don't build


---

Comment by dimpase created at 2020-09-05 07:46:22

The error is 

```
[docpdf] ! You can't use `macro parameter character #' in math mode.
[docpdf] l.7363 ...n <https://github.com/microsoft/pyright#
[docpdf]                                                   installation>\) for details.
[docpdf] ? 
[docpdf] ! Emergency stop.
```



---

Comment by @tobiasdiez created at 2020-09-05 07:53:58

Ok, but what is wrong with this link? Should I remove the `#installation` part?


---

Comment by git created at 2020-09-05 07:57:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-05 07:59:09

a typical issue of weird rst syntax (missing `_`)

cf https://docutils.sourceforge.io/docs/user/rst/quickref.html#hyperlink-targets


---

Comment by @tobiasdiez created at 2020-09-05 08:11:36

Thanks!


---

Comment by dimpase created at 2020-09-05 11:39:16

I'm still checking that the pdf docs build (it requires a more complete install of TexLive than I have, and so takes a while)


---

Comment by dimpase created at 2020-09-05 12:51:21

OK, alles gut/goed, een kleine taaloefening voor \usepackage{babel}


---

Comment by dimpase created at 2020-09-05 12:51:21

Changing status from needs_work to positive_review.


---

Comment by @tobiasdiez created at 2020-09-27 19:27:53

Is there anything that needs to be done from my side for this to be merged?


---

Comment by chapoton created at 2020-09-27 20:10:21

patience, please


---

Comment by vbraun created at 2020-11-07 16:23:08

Resolution: fixed
