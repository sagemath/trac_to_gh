# Issue 29469: Move Extension options from src/module_list.py to "distutils:" directives in the individual files

Issue created by migration from https://trac.sagemath.org/ticket/29706

Original creator: mkoeppe

Original creation time: 2020-05-18 00:46:51

CC:  fbissey dimpase jhpalmieri tscrim @kliem roed vdelecroix vbraun




---

Comment by git created at 2020-05-18 03:41:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-18 05:09:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-18 05:42:18

Changing status from new to needs_review.


---

Comment by git created at 2020-05-18 05:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-18 09:53:53

Aren't all these `extra_compile_args=['-std=c++11']` (and the corresponding cython `#`-directives obsolete (as we now set this globally for the C++ compiler)?


---

Comment by mkoeppe created at 2020-05-18 15:10:32

I would guess so but would prefer to do that on a different ticket


---

Comment by git created at 2020-05-21 05:07:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-05-27 18:17:33

Isn't `src/sage/geometry/triangulation/base.pyx` itself redundant here?


```diff
-# distutils: sources = sage/geometry/triangulation/base.pyx sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
+# distutils: sources = sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
```

Same thing in 
- `/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx`
- `sage/stats/distributions/discrete_gaussian_integer.pyx`)

I think you missed this one. At least I don't find the corresponding file in the diffs.

```
-    Extension('sage.modular.pollack_stevens.dist',
-              sources = ['sage/modular/pollack_stevens/dist.pyx'],
-              libraries = ["gmp", "zn_poly"],
-              extra_compile_args = ["-D_XPG6"]),
```


I don't understand (this is probably reasonable, but I don't have any knowledge about that)


```
    # TODO: Remove Cygwin hack by installing a suitable cblas.pc
    if os.path.exists('/usr/lib/libblas.dll.a'):
        aliases["CBLAS_LIBS"] = ['gslcblas']
```


Everything else looks great to me. However, I didn't test anything yet.


---

Comment by @kliem created at 2020-05-27 18:18:13

Changing keywords from "" to "sd109".


---

Comment by mkoeppe created at 2020-05-29 18:05:37

Replying to [comment:14 gh-kliem]:
> Isn't `src/sage/geometry/triangulation/base.pyx` itself redundant here?
> 
> {{{#!diff
> -# distutils: sources = sage/geometry/triangulation/base.pyx sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
> +# distutils: sources = sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
> }}}
> Same thing in 
> - `/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx`
> - `sage/stats/distributions/discrete_gaussian_integer.pyx`)
> 
> I think you missed this one. At least I don't find the corresponding file in the diffs.
> {{{
> -    Extension('sage.modular.pollack_stevens.dist',
> -              sources = ['sage/modular/pollack_stevens/dist.pyx'],
> -              libraries = ["gmp", "zn_poly"],
> -              extra_compile_args = ["-D_XPG6"]),
> }}}

Quite possible on both of these. If you have time to test and make these fixes, that would be great!

> I don't understand (this is probably reasonable, but I don't have any knowledge about that)
> 
> {{{
>     # TODO: Remove Cygwin hack by installing a suitable cblas.pc
>     if os.path.exists('/usr/lib/libblas.dll.a'):
>         aliases["CBLAS_LIBS"] = ['gslcblas']
> }}}


I don't understand it either, I only it moved it there from its origin.  It's quite likely that it is outdated - this should be addressed on a separate ticket.


---

Comment by @kliem created at 2020-05-30 07:48:44

Ok. I'm testing it now both locally and with github actions.


---

Comment by @kliem created at 2020-05-30 18:54:38

It all worked on my end (`sage -t --all --long`)

Testing it on github reavealed some strange error with debian buster standard.

https://github.com/kliem/sage-test-27122/runs/722743115


```
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage/matrix/__init__.py", line 2, in <module>
  [dochtml]       import sage.matrix.args
  [dochtml]     File "sage/matrix/args.pyx", line 23, in init sage.matrix.args (build/cythonized/sage/matrix/args.c:21224)
  [dochtml]     File "/sage/local/lib/python3.7/site-packages/sage/matrix/matrix_space.py", line 44, in <module>
  [dochtml]       from . import matrix_modn_sparse
  [dochtml]     File "sage/matrix/matrix_integer_sparse.pxd", line 5, in init sage.matrix.matrix_modn_sparse (build/cythonized/sage/matrix/matrix_modn_sparse.cpp:16301)
  [dochtml]   ImportError: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version `GLIBCXX_3.4.26' not found (required by /sage/local/lib/python3.7/site-packages/sage/matrix/matrix_integer_sparse.cpython-
```


How come `numerical`, `rings` etc. wheren't touched?


---

Comment by dimpase created at 2020-05-30 20:46:01

I also see this kind of strange error on GH Actions on buster. Perhaps the buster image used is faulty?


---

Comment by @kliem created at 2020-05-31 05:48:20

Also happens on ubuntu bionic and linuxmint 19.

Overall the testing experience is awful at the moment and it appears to have nothing to do with this ticket: https://github.com/kliem/sage-test-27122/actions/runs/119764262

Except for ubuntu focal and eoan and debian bullseye and sid (all standard not minimal) nothing passes within 6 hours and many failures.


---

Comment by @kliem created at 2020-05-31 05:48:51

In comparison to almost everything succeeding at 9.1 release.


---

Comment by git created at 2020-06-01 23:57:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 00:09:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-02 00:10:40

Replying to [comment:16 mkoeppe]:
> Replying to [comment:14 gh-kliem]:
> > Isn't `src/sage/geometry/triangulation/base.pyx` itself redundant here?
> > 
> > {{{#!diff
> > -# distutils: sources = sage/geometry/triangulation/base.pyx sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
> > +# distutils: sources = sage/geometry/triangulation/functions.cc sage/geometry/triangulation/data.cc sage/geometry/triangulation/triangulations.cc
> > }}}
> > Same thing in 
> > - `/src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx`
> > - `sage/stats/distributions/discrete_gaussian_integer.pyx`)
> > 
> > I think you missed this one. At least I don't find the corresponding file in the diffs.
> > {{{
> > -    Extension('sage.modular.pollack_stevens.dist',
> > -              sources = ['sage/modular/pollack_stevens/dist.pyx'],
> > -              libraries = ["gmp", "zn_poly"],
> > -              extra_compile_args = ["-D_XPG6"]),
> > }}}
> 
> Quite possible on both of these. 

I have made these changes.


---

Comment by mkoeppe created at 2020-06-02 00:14:21

Replying to [comment:18 gh-kliem]:
> How come `numerical`, `rings` etc. weren't touched?
The present ticket only touches top-level packages that do not have `OptionalExtension`s. 
Part 2 will do `OptionalExtension`s. Part 3 all remaining (mixed) ones. I split it up to reduce the potential for merge conflicts.


---

Comment by @kliem created at 2020-06-02 05:38:25

As far as I can see `OptionalExtension` is used only in `graphs`, `interfaces`, `libs` and `matrix`.

`Numerical`, `rings`, `finite_rings`, `number_field`, `padics` and `polynomial` don't seem to have that.

Maybe I'm missing something. We can also split at this point, because we are already touching enough packages.


---

Comment by mkoeppe created at 2020-06-02 05:41:03

It's quite possible that I misremembered and it's just an arbitrary subset.


---

Comment by @kliem created at 2020-06-02 06:00:50

Works for me.

As it apparently also works on your mac and it passes on cygwin https://github.com/kliem/sage-test-27122/actions/runs/119764261 and it works fine on multiple linux instances, the build process seems to work just the same as before.


---

Comment by @kliem created at 2020-06-02 06:00:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-02 06:06:05

Thanks!


---

Comment by vbraun created at 2020-06-05 22:12:42

Resolution: fixed


---

Comment by vbraun created at 2020-06-06 18:07:26

Resolution changed from fixed to 


---

Comment by vbraun created at 2020-06-06 18:07:26

Changing status from closed to new.


---

Comment by vbraun created at 2020-06-06 18:07:26

on OSX:

```
[sagelib-9.2.beta0] cd . && export                                    \
[sagelib-9.2.beta0] 	    SAGE_ROOT=/doesnotexist                               \
[sagelib-9.2.beta0] 	    SAGE_SRC=/doesnotexist                                \
[sagelib-9.2.beta0] 	    SAGE_SRC_ROOT=/doesnotexist                           \
[sagelib-9.2.beta0] 	    SAGE_DOC_SRC=/doesnotexist                            \
[sagelib-9.2.beta0] 	    SAGE_BUILD_DIR=/doesnotexist                          \
[sagelib-9.2.beta0] 	    SAGE_PKGS=/Users/buildbot-sage/slave/sage_git/build/build/pkgs                \
[sagelib-9.2.beta0] 	&& sage-python -u setup.py --no-user-cfg build install
[sagelib-9.2.beta0] /Users/buildbot-sage/slave/sage_git/build/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory
[sagelib-9.2.beta0] Warning: overwriting SAGE_ROOT environment variable:
[sagelib-9.2.beta0] Old SAGE_ROOT=/doesnotexist
[sagelib-9.2.beta0] New SAGE_ROOT=
[sagelib-9.2.beta0] ************************************************************************
[sagelib-9.2.beta0] Traceback (most recent call last):
[sagelib-9.2.beta0]   File "setup.py", line 72, in <module>
[sagelib-9.2.beta0]     from module_list import ext_modules, library_order
[sagelib-9.2.beta0]   File "/Users/buildbot-sage/slave/sage_git/build/src/module_list.py", line 80, in <module>
[sagelib-9.2.beta0]     aliases = cython_aliases()
[sagelib-9.2.beta0]   File "/Users/buildbot-sage/slave/sage_git/build/src/sage/env.py", line 395, in cython_aliases
[sagelib-9.2.beta0]     aliases[var + "CFLAGS"] = pkgconfig.cflags(lib).split()
[sagelib-9.2.beta0]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 144, in cflags
[sagelib-9.2.beta0]     _raise_if_not_exists(package)
[sagelib-9.2.beta0]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
[sagelib-9.2.beta0]     raise PackageNotFoundError(package)
[sagelib-9.2.beta0] pkgconfig.pkgconfig.PackageNotFoundError: zlib not found
[sagelib-9.2.beta0] ************************************************************************
[sagelib-9.2.beta0] Error building the Sage library
[sagelib-9.2.beta0] ************************************************************************
[sagelib-9.2.beta0] Please email sage-devel (http://groups.google.com/group/sage-devel)
[sagelib-9.2.beta0] explaining the problem and including the relevant part of the log file
[sagelib-9.2.beta0]   /Users/buildbot-sage/slave/sage_git/build/logs/pkgs/sagelib-9.2.beta0.log
[sagelib-9.2.beta0] Describe your computer, operating system, etc.
[sagelib-9.2.beta0] ************************************************************************
```



---

Comment by @kliem created at 2020-06-06 19:18:14

That fix looks plausible to me.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-06 19:18:45

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-06-06 19:19:31

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-06 19:25:33

Thanks!


---

Comment by vbraun created at 2020-06-21 19:53:22

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-06-21 19:53:22

Still getting on OSX:

```
[sagelib-9.2.beta1] ************************************************************************
[sagelib-9.2.beta1] Traceback (most recent call last):
[sagelib-9.2.beta1]   File "setup.py", line 72, in <module>
[sagelib-9.2.beta1]     from module_list import ext_modules, library_order
[sagelib-9.2.beta1]   File "/Users/buildbot-sage/slave/sage_git/build/src/module_list.py", line 80, in <module>
[sagelib-9.2.beta1]     aliases = cython_aliases()
[sagelib-9.2.beta1]   File "/Users/buildbot-sage/slave/sage_git/build/src/sage/env.py", line 409, in cython_aliases
[sagelib-9.2.beta1]     aliases[var + "LIBEXTRA"] = list(filter(lambda s: not s.startswith(('-l','-L')), pkgconfig.libs(lib).split()))
[sagelib-9.2.beta1]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 165, in libs
[sagelib-9.2.beta1]     _raise_if_not_exists(package)
[sagelib-9.2.beta1]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
[sagelib-9.2.beta1]     raise PackageNotFoundError(package)
[sagelib-9.2.beta1] pkgconfig.pkgconfig.PackageNotFoundError: zlib not found
[sagelib-9.2.beta1] ************************************************************************
[sagelib-9.2.beta1] Error building the Sage library

```



---

Comment by git created at 2020-06-21 21:13:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-21 21:14:19

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-21 21:14:19

Sorry, here's another fix.


---

Comment by jhpalmieri created at 2020-06-22 05:26:10

Any suggestions for how to reproduce the error? I've tried using the previous version of the branch, and either building with lots of system packages or with very few, but I haven't hit this build error.


---

Comment by mkoeppe created at 2020-06-22 05:28:03

Basically, one needs a macOS without homebrew (which installs .pc files for system libraries). Or do the following to simulate that:

```
  (cd /usr/local/Homebrew/Library/Homebrew/os/mac/ && mv pkgconfig pkgconfig-moved)
```



---

Comment by mkoeppe created at 2020-06-22 05:30:25

I created #29929 (`tox.ini: Add a macos environment without homebrew, conda`) so we can test such a barebones macOS environment on GH Actions


---

Comment by @kliem created at 2020-06-22 09:04:24

Have you tried the current branch with such a system? I am completely clueless, whether the last commit resolves the problem.


---

Comment by mkoeppe created at 2020-06-22 21:34:40

Replying to [comment:52 gh-kliem]:
> Have you tried the current branch with such a system? I am completely clueless, whether the last commit resolves the problem.
Yes, a build from scratch with the manipulation mentioned in comment 50 just finished successfully on my machine.


---

Comment by jhpalmieri created at 2020-06-22 22:04:25

I have not yet been able to reproduce the error, so I can't tell if the most recent change fixes anything. Renaming `/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig` didn't cause breakage, nor did renaming `/usr/local/lib/pkgconfig`. I'm trying on a different machine by just removing homebrew altogether.


---

Comment by jhpalmieri created at 2020-06-22 22:57:43

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-06-22 22:57:43

I can confirm on a machine without Homebrew, I hit the failure that Volker mentioned, and the most recent change fixes it. I'm going to switch to a positive review.


---

Comment by mkoeppe created at 2020-06-22 23:31:48

Thank you!


---

Comment by vbraun created at 2020-06-24 23:38:17

Resolution: fixed
