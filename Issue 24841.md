# Issue 24841: ./sage -f sagelib no longer works

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-04-02 09:53:36

CC:  embray

This used to be a convenient way to force-rebuild the whole Sage library:

```
$ ./sage -f sagelib
...
Error: package 'sagelib' not found
Note: if it is an old-style package, use -p instead of -i to install it
```



---

Comment by embray created at 2018-04-03 10:26:53

This reminds me, it's been on my TODO list to just make "sagelib" another spkg (with some special disposition that allows its "source" to be found and built in a local directory rather than downloaded as a tarball and extracted to a temp dir).  I'm not sure why this would be broken now though.


---

Comment by embray created at 2018-04-03 10:35:21

In `src/bin/sage` there's a kind of hackish "grep" of `build/make/Makefile` to ensure that the argument to `./sage -f` (mostly assumed to be name of an SPKG) is actually a make target.  But it seems from the usage you describe here, really `./sage -f` should work for almost any make target, not just SPKGs. 

I guess either the check could be made more generic or just removed entirely.

Also is this actually documented behavior?  If not I wouldn't consider it a "blocker".  The `--help` just says of `-f` "force build of the given Sage packages".  It's not clear to me whether "sagelib" and "doc" are considered "Sage packages" (per my above comment maybe the should be...)


---

Comment by jdemeyer created at 2018-04-03 20:32:52

Replying to [comment:3 embray]:
> Also is this actually documented behavior?

I don't think so, but it should be. I have certainly recommended running `./sage -f sagelib` to people.


---

Comment by embray created at 2018-04-04 09:09:35

Well how would you suggest handling it?  IMO the actual behavior you desire should be documented before moving forward on fixing it.  What targets should it work for?  Just "sagelib" and "doc"?  Or others as well?  Previously, it technically worked for any target in the Makefile.


---

Comment by jdemeyer created at 2018-04-04 13:29:35

Replying to [comment:5 embray]:
> Previously, it technically worked for any target in the Makefile.

It is actually by design that `./sage -i` works that way. So maybe the easiest fix is removing this check:

```
        # First check that $PKG is actually a Makefile target
        # Since #21524 there is not explicitly
        # a target for the package, but if it has a vers_<pkgname> variable
        # there will also be a generated rule for it
        if ! grep "^vers_$PKG = " build/make/Makefile >/dev/null; then
            echo >&2 "Error: package '$PKG' not found"
            echo >&2 "Note: if it is an old-style package, use -p instead of -i to install it"
            exit 1
        fi
```



---

Comment by jdemeyer created at 2018-04-05 08:40:01

New commits:


---

Comment by jdemeyer created at 2018-04-05 08:40:01

Changing status from new to needs_review.


---

Comment by embray created at 2018-04-05 09:25:11

FWIW I don't think 'build' commands should be combined into Sage's runtime interface at all.  The sole exception might be `sage -i` (or an equivalent) for installing optional packages, and even that has its problems.


---

Comment by embray created at 2018-04-05 09:25:11

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-04-05 09:29:11

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-04-05 09:29:11

Actually, upon testing this I take it back.  This is rather user-hostile because if you run `./sage -i <unknown_or_misspelled_package>` it will still just fire up make, possibly rebuild some other things (as it did for me, since I had to rebuild my toolchain packages due to previous tinkering) and only much later give an error from `make` that the target is not found (and a hard to understand error, at that, if you don't know what you're looking for).


---

Comment by embray created at 2018-04-05 10:04:58

What about something like this?  If you run `make list` it simply prints a list of all the packages the makefile knows about, as well as some additional "packages" listed in the `SAGE_I_TARGETS` variable.  Ccurrently just "sagelib" and "doc" but others could be added--though I don't think _every_ makefile target is necessarily useful or valid in this context.


---

Comment by git created at 2018-04-05 10:05:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-04-05 10:16:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-04-05 10:20:14

I agree with Erik that the misspelt package names are a nuisance, resulting in misleading logs.


---

Comment by embray created at 2018-04-05 12:04:50

I don't think Dima intended to change the branch...
----
New commits:


---

Comment by @dimpase created at 2018-04-05 12:14:24

apologies for messing up the branch.
I forgot that this happens if the ticket was changed in the meantime, and I didn't click somthing (I am hopeless with GUIs in general :-))


---

Comment by embray created at 2018-04-05 14:48:38

No problem I've done that too.


---

Comment by jdemeyer created at 2018-04-11 09:57:48

needs review?


---

Comment by embray created at 2018-04-11 13:13:22

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-04-11 13:13:22

Replying to [comment:18 jdemeyer]:
> needs review?

I guess, if you agree with my general analysis of the situation.  I posted my branch as an offer for an alternative solution, but it only "needs review" if you agree with my previous comments.


---

Comment by jdemeyer created at 2018-04-12 11:36:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-04-12 11:36:15

What's the point of

```
`@`$(MAKE) -q build/make/Makefile >&2
```

Wouldn't it make more sense to actually build `build/make/Makefile`?


---

Comment by jdemeyer created at 2018-04-12 11:38:36

Apart from that, this works fine.


---

Comment by embray created at 2018-04-12 11:48:13

I think you misread that line.  That's exactly what it's doing.


---

Comment by embray created at 2018-04-12 11:48:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-04-12 18:12:18

I think you either misread the `make` manpage or you have a different version of `make` than me.

```
       -q, --question
            ``Question mode''.  Do not run any commands, or print anything; just return an exit status that  is  zero  if  the  specified  targets  are
            already up to date, nonzero otherwise.
```



---

Comment by jdemeyer created at 2018-04-13 07:24:53

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-13 13:45:20

Oops, sorry, you're right.  I had it confused with `-s` for `--silent` (which confusingly can also be spelled `--quiet`, but _not_ `-q`).


---

Comment by git created at 2018-04-13 13:47:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-13 13:50:37

The overall intent was so that in the (unusual) case that `build/make/Makefile` has to be generated in order to produce the list, the only output to stdout would still be the list itself.


---

Comment by embray created at 2018-04-13 13:50:43

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-04-16 08:21:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-04-17 20:29:53

Resolution: fixed
