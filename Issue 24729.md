# Issue 24729: package prime count

Issue created by migration from https://trac.sagemath.org/ticket/24966

Original creator: vdelecroix

Original creation time: 2018-03-13 16:20:05

CC:  jpflori fbissey vklein slelievre

Package Kim Walish prime count package (the Sage version of prime_pi is boggus, #24960). Note that the build system is using cmake.

Upstream issue https://github.com/kimwalisch/primecount/issues/11


---

Comment by @dimpase created at 2018-03-13 22:11:09

We are [told](https://groups.google.com/d/msg/sage-support/hXZmkYwOvfg/4k5TbhGYCAAJ) that this is little-endian only. So this in its present form can at best become an experimental package, AFAIK.


---

Comment by vdelecroix created at 2018-03-14 04:30:05

Thanks for the clarification Dima. It was actually a question that Kim Walish asked on github.


---

Comment by vdelecroix created at 2018-03-14 04:30:05

Changing component from packages: optional to packages: experimental.


---

Comment by ohanar created at 2018-03-14 22:45:44

It appears that Kim has put out a new release of primecount with big-endian support.


---

Comment by @dimpase created at 2018-03-15 00:51:15

I just checked the latest release on (big-endian) SPARC, it appears to work.
(I tried ./primecount 1e11 with different algorithms, it worked)

I didn't test with OpenMP. Should I?


---

Comment by vdelecroix created at 2018-03-18 09:19:43

Changing component from packages: experimental to packages: optional.


---

Comment by vdelecroix created at 2018-03-18 09:19:43

New commits:


---

Comment by vdelecroix created at 2018-03-18 09:19:43

Changing status from new to needs_review.


---

Comment by git created at 2018-03-18 16:18:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-18 16:37:04

This should use the modern style `spkg-install` script with the `sdh_` functions.


---

Comment by jdemeyer created at 2018-03-18 16:37:04

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2018-03-18 16:58:12

In `spkg-check` one needs `$MAKE test` rather than `$MAKE check`. 

Must be another cmake-ism... :-)


---

Comment by git created at 2018-03-18 21:13:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-03-18 21:14:00

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-03-18 21:14:00

It is indeed a cmake-ism. And sadly you have to pass the option at configure time in order to enable the test... it is kind of annoying.


---

Comment by fbissey created at 2018-03-18 21:29:06

Build and passes its test suite on power7 - not inside a sage install, I assume I was requested to see if it was working on the hardware.

I sniffed the `CMakeList.txt` and I want someone to test it inside sage on a mac. I suspect the `install_name` are not set properly but I could miss something, so the proof is in the pudding.


---

Comment by jdemeyer created at 2018-03-19 06:25:53

Replying to [comment:13 fbissey]:
> I sniffed the `CMakeList.txt` and I want someone to test it inside sage on a mac. I suspect the `install_name` are not set properly but I could miss something, so the proof is in the pudding. 

Is there no `libtool` equivalent in the cmake world?


---

Comment by fbissey created at 2018-03-19 06:29:19

cmake knows about OS X but you have to be sure to tell it to do the right thing for a proper install. I didn't see what I think should be there but I could have missed something. `install_name` is not necessary when you just produce an executable, things can get funny when you produce dynamic libraries.


---

Comment by vdelecroix created at 2018-03-19 08:57:13

Though I am not sure that `make test` actually test the linking. I should perhaps start writing #25009 for proper testing within Sage.


---

Comment by jdemeyer created at 2018-03-19 08:59:41

Replying to [comment:16 vdelecroix]:
> Though I am not sure that `make test` actually test the linking. I should perhaps start writing #25009 for proper testing within Sage.

Yes, it would be good to have a minimal test (even just a `%%cython` command) to check that the linking works.


---

Comment by fbissey created at 2018-03-19 09:01:37

Replying to [comment:16 vdelecroix]:
> Though I am not sure that `make test` actually test the linking.

It does - however because test executable are not installed they are not actually linked with the same options as the final installed executable. In fact your executables and libraries may be re-linked at install time.


---

Comment by dimpase created at 2018-03-19 09:10:08

Perhaps testing the installed libs is worth upstream's attention?


---

Comment by vdelecroix created at 2018-03-19 09:12:48

Replying to [comment:19 dimpase]:
> Perhaps testing the installed libs is worth upstream's attention?

Sure but it is up to us to check that it integrates properly within Sage.


---

Comment by git created at 2018-03-19 11:11:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-03-19 11:12:25

I introduced in the last commit an experimental module `sage.arith.prime_pi` that will be clean up in #25009.


---

Comment by rws created at 2018-03-19 14:16:24

Didn't read the last comment, sorry.


---

Comment by git created at 2018-03-19 17:15:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2018-03-19 17:18:57

I'll test in on OSX, building now...


---

Comment by vdelecroix created at 2018-03-19 17:21:31

Replying to [comment:27 dimpase]:
> I'll test in on OSX, building now...

Thanks! (running `$ sage -t arith/prime_pi.pyx` should be enough but check that the tests indeed appears with `sage -t --verbose arith/prime_pi.pyx`).


---

Comment by slelievre created at 2018-03-19 19:27:51

Tested under macOS 10.10.5. The package installs fine, and `sage -t` gives "All tests passed!".


---

Comment by jdemeyer created at 2018-03-19 20:02:30

I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.

Why not use the `OptionalExtension` mechanism for this?


---

Comment by fbissey created at 2018-03-19 20:08:51

Replying to [comment:30 jdemeyer]:
> I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.
> 
> Why not use the `OptionalExtension` mechanism for this?

Further I am opposed to any introduction of that sage-on-distro annoyance that is `is_package_installed` in `setup.py`. We want less of it, not more.


---

Comment by fbissey created at 2018-03-19 20:10:54

Replying to [comment:29 slelievre]:
> Tested under macOS 10.10.5. The package installs fine, and `sage -t` gives "All tests passed!".

Can you give the output of `otool -L local/lib/libprimecount.dylib` (or whatever is the correct name for that library).


---

Comment by jdemeyer created at 2018-03-19 20:14:24

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2018-03-20 00:56:15

This is what I get:

```
$ otool -L local/lib/libprimecount.dylib 
local/lib/libprimecount.dylib:
	@rpath/libprimecount.4.dylib (compatibility version 4.0.0, current version 4.3.0)
	@rpath/libprimesieve.8.dylib (compatibility version 8.0.0, current version 8.4.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 120.1.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1226.10.1)
```



---

Comment by fbissey created at 2018-03-20 01:02:18

Interesting the ``@`rpath` bit is probably helping. What about `otool -D local/lib/libprimecount.dylib`?


---

Comment by slelievre created at 2018-03-20 01:05:14

Here is what I get:

```
$ otool -D local/lib/libprimecount.dylib
local/lib/libprimecount.dylib:
@rpath/libprimecount.4.dylib
```



---

Comment by fbissey created at 2018-03-20 01:07:49

That's unusual but good enough if I believe `ld`'s documentation.


---

Comment by vdelecroix created at 2018-03-20 21:33:20

Replying to [comment:30 jdemeyer]:
> I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.
> 
> Why not use the `OptionalExtension` mechanism for this?

To avoid
- writing two modules instead of one
- indirect calls to primecount via a cython wrapped function


---

Comment by vdelecroix created at 2018-03-20 21:33:44

Replying to [comment:31 fbissey]:
> Replying to [comment:30 jdemeyer]:
> > I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.
> > 
> > Why not use the `OptionalExtension` mechanism for this?
> 
> Further I am opposed to any introduction of that sage-on-distro annoyance that is `is_package_installed` in `setup.py`. We want less of it, not more.

What do you propose then?


---

Comment by fbissey created at 2018-03-21 07:24:53

Replying to [comment:39 vdelecroix]:
> Replying to [comment:31 fbissey]:
> > Replying to [comment:30 jdemeyer]:
> > > I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.
> > > 
> > > Why not use the `OptionalExtension` mechanism for this?
> > 
> > Further I am opposed to any introduction of that sage-on-distro annoyance that is `is_package_installed` in `setup.py`. We want less of it, not more.
> 
> What do you propose then?

Exactly what Jeroen suggests, like 99% of optional packages that build a binding, put a `OptionalExtension` in `module_list_list.py`. We already deal with that particular instance of `is_package_installed` and that's not adding a new one. Look in `module_list.py` for examples of it.


---

Comment by vdelecroix created at 2018-03-21 08:44:17

Replying to [comment:40 fbissey]:
> Replying to [comment:39 vdelecroix]:
> > Replying to [comment:31 fbissey]:
> > > Replying to [comment:30 jdemeyer]:
> > > > I'm not so happy to abuse `compile_time_env` for every optional package. First of all, it leads to ugly code (`IF`s all over the place) and second, it requires a complete reinstallation of the Sage library whenever a new package is installed.
> > > > 
> > > > Why not use the `OptionalExtension` mechanism for this?
> > > 
> > > Further I am opposed to any introduction of that sage-on-distro annoyance that is `is_package_installed` in `setup.py`. We want less of it, not more.
> > 
> > What do you propose then?
> 
> Exactly what Jeroen suggests, like 99% of optional packages that build a binding, put a `OptionalExtension` in `module_list_list.py`. We already deal with that particular instance of `is_package_installed` and that's not adding a new one. Look in `module_list.py` for examples of it.

As I wrote this is a nonsense. This oblige to have a function `prime_pi` in let say `interfaces/primecount.pyx` to provide bindings for primecount and a `prime_pi` in `arith/prime_pi.pyx` calling the former (because we do have other `prime_pi` implementations around). primecount is made of straightforward C++ functions and it should possible to call them directly without the optional extension that you propose.


---

Comment by fbissey created at 2018-03-21 08:56:23

I see. Well, I call what you do a bit of a band aid. But then we all have to start somewhere before learning better. Of course what I am about to suggest will require a significant rewrite.

You should isolate the binding to primecount in its own optional pyx/pxd files. Then, instead of having all those `HAVE_PRIMECOUNT` conditional you use a more pythonic construct 

```
try:
  import primcount_binding
except ....
```

and so on. There may be a case for using stuff from #20382, once it is merged, for this.


---

Comment by vdelecroix created at 2018-03-21 16:17:50

I don't mind significant rewrite. This is about 10 lines of code anyway.

I want to avoid `primecount_binding`. The primecount library is made of C functions `int the_function(int)` that can be directly used without any intermediate useless Python module. Such Python module would look like

```
def the_python_function(int x):
   r"""
   A doctest
   """"
   return the_C_function(x)
```

and calling any of `the_python_function` wil be an extra Python call overhead.


---

Comment by dimpase created at 2018-03-21 18:08:35

I know, it's bikeshedding, but an alternative would be to have a fake `libprimecount` which is always installed, and where every callable by Sage function is a no-op...


---

Comment by git created at 2018-03-30 13:50:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-03-30 13:51:38

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-03-30 13:51:38

- rebased
- now an optional module (no more compilation constant)


---

Comment by vklein created at 2018-04-03 15:55:17

Currently building on macOS 10.12.6


---

Comment by vklein created at 2018-04-04 07:14:12

I get an error during `sage -i prime count`.


```
Found local metadata for primecount-4.3
Using cached file /Users/admin/sage/upstream/primecount-4.3.tar.gz
primecount-4.3
====================================================
Setting up build directory for primecount-4.3
Finished extraction
No patch files found in ../patches
****************************************************
Host system:
Darwin laptop-147-210-128-202.labri.fr 16.7.0 Darwin Kernel Version 16.7.0: Mon Nov 13 21:56:25 PST 2017; root:xnu-3789.72.11~1/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/usr/include/c++/4.2.1
Apple LLVM version 9.0.0 (clang-900.0.39.2)
Target: x86_64-apple-darwin16.7.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
****************************************************
Configuring primecount.
-- The CXX compiler identification is AppleClang 9.0.0.9000039
-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/g++
-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/g++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Performing Test Wno_fallthrough
-- Performing Test Wno_fallthrough - Success
-- Performing Test atomic64
-- Performing Test atomic64 - Success
-- Looking for C++ include pthread.h
-- Looking for C++ include pthread.h - found
-- Looking for pthread_create
-- Looking for pthread_create - found
-- Found Threads: TRUE  
-- Performing Test libdivide
-- Performing Test libdivide - Success
-- Performing Test mpopcnt
-- Performing Test mpopcnt - Success
-- Configuring done
-- Generating done
-- Build files have been written to: /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src
Building primecount-4.3
Scanning dependencies of target libprimesieve
[  4%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratBig.cpp.o
[  4%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/CpuInfo.cpp.o
[  4%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/api-c.cpp.o
[  4%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/api.cpp.o
[  6%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratMedium.cpp.o
[  6%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratSmall.cpp.o
[  7%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/iterator-c.cpp.o
[  7%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/iterator.cpp.o
[  8%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/nthPrime.cpp.o
[  9%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/ParallelPrimeSieve.cpp.o
[ 10%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/popcount.cpp.o
[ 11%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PreSieve.cpp.o
[ 12%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PrimeGenerator.cpp.o
[ 13%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PrimeSieve.cpp.o
[ 14%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/SieveOfEratosthenes.cpp.o
[ 15%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/SievingPrimes.cpp.o
[ 16%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/Wheel.cpp.o
[ 16%] Linking CXX shared library libprimesieve.dylib
dyld: lazy symbol binding failed: Symbol not found: _utimensat
  Referenced from: /Users/admin/sage/local/bin/cmake
  Expected in: /usr/lib/libSystem.B.dylib

dyld: Symbol not found: _utimensat
  Referenced from: /Users/admin/sage/local/bin/cmake
  Expected in: /usr/lib/libSystem.B.dylib

make[4]: *** [lib/primesieve/libprimesieve.dylib] Abort trap: 6
make[4]: *** Deleting file `lib/primesieve/libprimesieve.dylib'
make[3]: *** [lib/primesieve/CMakeFiles/libprimesieve.dir/all] Error 2
make[2]: *** [all] Error 2
********************************************************************************
Error building primecount-4.3
********************************************************************************

real	0m12.842s
user	0m15.293s
sys	0m3.012s
************************************************************************
Error installing package primecount-4.3
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /Users/admin/sage/logs/pkgs/primecount-4.3.log
Describe your computer, operating system, etc.
If you want to try to fix the problem yourself, *don't* just cd to
/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3 and type 'make' or whatever is appropriate.
Instead, the following commands setup all environment variables
correctly and load a subshell for you to debug the error:
  (cd '/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3' && '/Users/admin/sage/sage' --sh)
When you are done debugging, you can type "exit" to leave the subshell.
************************************************************************

```



---

Comment by vklein created at 2018-04-04 07:20:00

It looks like _ultimensat is not available on macOS version < 10.13. I am currently on macOS 10.12.6.


---

Comment by vklein created at 2018-04-04 15:20:59

Changing status from needs_review to needs_work.


---

Comment by vklein created at 2018-04-04 15:20:59

Install and tests works on macOS High Sierra (10.13.4), but i don't have managed to make it work on Sierra (10.12.6)


---

Comment by fbissey created at 2018-04-04 22:00:50

That symbol is not quoted directly in the source code. So it has to be generated, I think something may select the wrong version of OS X as the target. What version of xcode do you actually use? This is probably fixable.

Also and I should have mentioned that earlier can you pass the following option to cmake ` -DCMAKE_VERBOSE_MAKEFILE=ON` so we have a verbose output and see what it is doing during make.


---

Comment by vklein created at 2018-04-05 08:02:50

On Sierra it was xcode 8.3.1.

As i have upgraded to High Sierra i can't do the tests with the verbose option right now. I need to set up a new Sierra environment first.


---

Comment by fbissey created at 2018-04-05 08:05:08

Just for future reference, verbose building is the prefered default. So all packages using cmake should have this option set.


---

Comment by vklein created at 2018-04-05 09:05:36

Changing keywords from "" to "thursdaysbdx".


---

Comment by vklein created at 2018-04-05 14:50:08

Trace for `sage -i primecount` with `-DCMAKE_VERBOSE_MAKEFILE=ON` on sierra (xcode 8.3.1) 

```
Found local metadata for primecount-4.3
Using cached file /Users/admin/sage/upstream/primecount-4.3.tar.gz
primecount-4.3
====================================================
Setting up build directory for primecount-4.3
Finished extraction
No patch files found in ../patches
****************************************************
Host system:
Darwin laptop-147-210-128-61.labri.fr 16.7.0 Darwin Kernel Version 16.7.0: Thu Jan 11 22:59:40 PST 2018; root:xnu-3789.73.8~1/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/usr/include/c++/4.2.1
Apple LLVM version 9.0.0 (clang-900.0.39.2)
Target: x86_64-apple-darwin16.7.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
****************************************************
Configuring primecount.
-- The CXX compiler identification is AppleClang 9.0.0.9000039
-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/g++
-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/g++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Performing Test Wno_fallthrough
-- Performing Test Wno_fallthrough - Success
-- Performing Test atomic64
-- Performing Test atomic64 - Success
-- Looking for C++ include pthread.h
-- Looking for C++ include pthread.h - found
-- Looking for pthread_create
-- Looking for pthread_create - found
-- Found Threads: TRUE  
-- Performing Test libdivide
-- Performing Test libdivide - Success
-- Performing Test mpopcnt
-- Performing Test mpopcnt - Success
-- Configuring done
-- Generating done
-- Build files have been written to: /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src
Building primecount-4.3
/Users/admin/sage/local/bin/cmake -H/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src -B/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src --check-build-system CMakeFiles/Makefile.cmake 0
/Users/admin/sage/local/bin/cmake -E cmake_progress_start /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/CMakeFiles /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/CMakeFiles/progress.marks
make -f CMakeFiles/Makefile2 all
make -f lib/primesieve/CMakeFiles/libprimesieve.dir/build.make lib/primesieve/CMakeFiles/libprimesieve.dir/depend
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src && /Users/admin/sage/local/bin/cmake -E cmake_depends "Unix Makefiles" /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/CMakeFiles/libprimesieve.dir/DependInfo.cmake --color=
Scanning dependencies of target libprimesieve
make -f lib/primesieve/CMakeFiles/libprimesieve.dir/build.make lib/primesieve/CMakeFiles/libprimesieve.dir/build
[  3%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/CpuInfo.cpp.o
[  3%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratBig.cpp.o
[  3%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/api.cpp.o
[  4%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/api-c.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/EratBig.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/EratBig.cpp
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/CpuInfo.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/CpuInfo.cpp
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/api.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/api.cpp
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/api-c.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/api-c.cpp
[  5%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratMedium.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/EratMedium.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/EratMedium.cpp
[  6%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/EratSmall.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -Wno-implicit-fallthrough -o CMakeFiles/libprimesieve.dir/src/EratSmall.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/EratSmall.cpp
[  7%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/iterator-c.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/iterator-c.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/iterator-c.cpp
[  7%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/iterator.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/iterator.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/iterator.cpp
[  8%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/nthPrime.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/nthPrime.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/nthPrime.cpp
[  9%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/ParallelPrimeSieve.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/ParallelPrimeSieve.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/ParallelPrimeSieve.cpp
[ 10%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/popcount.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/popcount.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/popcount.cpp
[ 11%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PreSieve.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/PreSieve.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/PreSieve.cpp
[ 12%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PrimeGenerator.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/PrimeGenerator.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/PrimeGenerator.cpp
[ 13%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/PrimeSieve.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/PrimeSieve.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/PrimeSieve.cpp
[ 14%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/SieveOfEratosthenes.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/SieveOfEratosthenes.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/SieveOfEratosthenes.cpp
[ 15%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/SievingPrimes.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/SievingPrimes.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/SievingPrimes.cpp
[ 16%] Building CXX object lib/primesieve/CMakeFiles/libprimesieve.dir/src/Wheel.cpp.o
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Library/Developer/CommandLineTools/usr/bin/g++  -Dlibprimesieve_EXPORTS -I/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/include  -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -fPIC   -std=gnu++11 -o CMakeFiles/libprimesieve.dir/src/Wheel.cpp.o -c /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve/src/Wheel.cpp
[ 16%] Linking CXX shared library libprimesieve.dylib
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Users/admin/sage/local/bin/cmake -E cmake_link_script CMakeFiles/libprimesieve.dir/link.txt --verbose=1
/Library/Developer/CommandLineTools/usr/bin/g++ -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.13.sdk -mmacosx-version-min=10.9 -dynamiclib -Wl,-headerpad_max_install_names -L/Users/admin/sage/local/lib -Wl,-rpath,/Users/admin/sage/local/lib -compatibility_version 8.0.0 -current_version 8.4.0 -o libprimesieve.8.4.0.dylib -install_name @rpath/libprimesieve.8.dylib CMakeFiles/libprimesieve.dir/src/api-c.cpp.o CMakeFiles/libprimesieve.dir/src/api.cpp.o CMakeFiles/libprimesieve.dir/src/CpuInfo.cpp.o CMakeFiles/libprimesieve.dir/src/EratBig.cpp.o CMakeFiles/libprimesieve.dir/src/EratMedium.cpp.o CMakeFiles/libprimesieve.dir/src/EratSmall.cpp.o CMakeFiles/libprimesieve.dir/src/iterator-c.cpp.o CMakeFiles/libprimesieve.dir/src/iterator.cpp.o CMakeFiles/libprimesieve.dir/src/nthPrime.cpp.o CMakeFiles/libprimesieve.dir/src/ParallelPrimeSieve.cpp.o CMakeFiles/libprimesieve.dir/src/popcount.cpp.o CMakeFiles/libprimesieve.dir/src/PreSieve.cpp.o CMakeFiles/libprimesieve.dir/src/PrimeGenerator.cpp.o CMakeFiles/libprimesieve.dir/src/PrimeSieve.cpp.o CMakeFiles/libprimesieve.dir/src/SieveOfEratosthenes.cpp.o CMakeFiles/libprimesieve.dir/src/SievingPrimes.cpp.o CMakeFiles/libprimesieve.dir/src/Wheel.cpp.o 
cd /Users/admin/sage/local/var/tmp/sage/build/primecount-4.3/src/lib/primesieve && /Users/admin/sage/local/bin/cmake -E cmake_symlink_library libprimesieve.8.4.0.dylib libprimesieve.8.dylib libprimesieve.dylib
dyld: lazy symbol binding failed: Symbol not found: _utimensat
  Referenced from: /Users/admin/sage/local/bin/cmake
  Expected in: /usr/lib/libSystem.B.dylib

dyld: Symbol not found: _utimensat
  Referenced from: /Users/admin/sage/local/bin/cmake
  Expected in: /usr/lib/libSystem.B.dylib

make[4]: *** [lib/primesieve/libprimesieve.dylib] Abort trap: 6
make[4]: *** Deleting file `lib/primesieve/libprimesieve.dylib'
make[3]: *** [lib/primesieve/CMakeFiles/libprimesieve.dir/all] Error 2
make[2]: *** [all] Error 2
********************************************************************************
Error building primecount-4.3
********************************************************************************

real	0m9.857s
user	0m16.100s
sys	0m2.490s
************************************************************************
Error installing package primecount-4.3
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /Users/admin/sage/logs/pkgs/primecount-4.3.log
Describe your computer, operating system, etc.
If you want to try to fix the problem yourself, *don't* just cd to
/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3 and type 'make' or whatever is appropriate.
Instead, the following commands setup all environment variables
correctly and load a subshell for you to debug the error:
  (cd '/Users/admin/sage/local/var/tmp/sage/build/primecount-4.3' && '/Users/admin/sage/sage' --sh)
When you are done debugging, you can type "exit" to leave the subshell.
************************************************************************
```



---

Comment by fbissey created at 2018-04-05 23:41:18

OK I have read other reports. Did you run `xcode-select --install` after installing/upgrading xcode? This unfortunately has to be done regularly after upgrades otherwise some stuff is missing at the root level.


---

Comment by vklein created at 2018-04-06 07:23:45

Replying to [comment:57 fbissey]:
> OK I have read other reports. Did you run `xcode-select --install` after installing/upgrading xcode?

Yes i tried this one. It just say command line tools are already installed. And xcode doesn't appear with `softwareupdate --list`


---

Comment by fbissey created at 2018-04-06 07:49:08

Hum... could be the way cmake is built and installed https://github.com/Homebrew/homebrew-core/issues/15232 https://github.com/Homebrew/homebrew-core/pull/19372 it looks like we need to upgrade cmake to fix this.


---

Comment by vklein created at 2018-04-06 09:28:30

Indeed it works fine after upgrading sage's cmake package to 3.11.0


---

Comment by vklein created at 2018-04-06 15:24:20

Set assignee to vklein.


---

Comment by vklein created at 2018-04-06 15:24:55

Remove assignee vklein.


---

Comment by vdelecroix created at 2018-04-13 08:26:41

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2018-04-13 14:59:44

tests are currently runnings on MacOS 10.13.4 and on Ubuntu 16.04


---

Comment by fbissey created at 2018-04-17 03:45:46

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2018-04-17 03:45:46

I really want to see `-DCMAKE_VERBOSE_MAKEFILE=ON` in `spkg-install`. Once it is done, it is a positive review from me.


---

Comment by git created at 2018-04-17 07:38:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-04-17 07:40:52

great


---

Comment by vdelecroix created at 2018-04-17 07:40:52

Changing status from needs_work to positive_review.


---

Comment by slelievre created at 2018-04-17 08:26:05

The ticket description has this somewhat puzzling statement:

> should work on both big-endian and little-indian
> processors but has been tested successfully

Can someone clarify?


---

Comment by vbraun created at 2018-05-14 17:36:04

Resolution: fixed
