# Issue 32846: System package information / tox.ini / GH Actions for alpine linux

Issue created by migration from https://trac.sagemath.org/ticket/33083

Original creator: mkoeppe

Original creation time: 2021-12-26 20:17:20

CC:  dimpase slelievre frederichan parisse @dkwo @tornaria mjo




---

Comment by mkoeppe created at 2021-12-26 23:11:20

New commits:


---

Comment by git created at 2021-12-26 23:47:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-27 00:01:11

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-27 00:22:17


```
  [r-3.6.3]   ********************************************************************************
  [r-3.6.3]   /sage/build/bin/sage-dist-helpers: line 143: fmt: command not found
  [r-3.6.3]   ********************************************************************************
```



---

Comment by git created at 2021-12-27 00:23:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-27 00:31:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-27 01:54:18

flint

```
In file included from /sage/local/var/tmp/sage/build/flint-2.7.1/src/thread_support.h:16,
                 from /sage/local/var/tmp/sage/build/flint-2.7.1/src/nmod_mat.h:35,
                 from /sage/local/var/tmp/sage/build/flint-2.7.1/src/nmod_poly.h:34,
                 from /sage/local/var/tmp/sage/build/flint-2.7.1/src/fmpz_poly.h:35,
                 from /sage/local/var/tmp/sage/build/flint-2.7.1/src/aprcl.h:18,
                 from config_gauss.c:12:
/sage/local/var/tmp/sage/build/flint-2.7.1/src/thread_pool.h:55:5: error: unknown type name 'cpu_set_t'
   55 |     cpu_set_t original_affinity;
      |     ^~~~~~~~~
```


giac:

```
In file included from History.cc:8:
first.h: In function 'float fgamma(float)':
first.h:546:39: error: 'gammaf' was not declared in this scope; did you mean 'tgammaf'?
  546 | inline float fgamma(float f1){ return gammaf(f1); } // or tgammaf(f1) on some versions of emscripten
      |                                       ^~~~~~
      |                                       tgammaf
make[5]: *** [Makefile:976: History.lo] Error 1
```



---

Comment by dimpase created at 2021-12-27 09:17:25

there is also `mpfr-dev` for `mpfr`.


---

Comment by dimpase created at 2021-12-27 09:31:35

see https://github.com/wbhart/flint2/issues/1054 for Flint error

Probably as a workaround on can put -D_GNU_SOURCE into CFLAGS.


---

Comment by @dkwo created at 2021-12-27 11:14:20

That's indeed what we do on Void linux, see https://github.com/void-linux/void-packages/blob/master/srcpkgs/flintlib/template


---

Comment by git created at 2021-12-27 19:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-27 19:46:17

The `giac` build error was previously mentioned in 
- https://www.mail-archive.com/sage-devel`@`googlegroups.com/msg100176.html
- https://groups.google.com/g/sage-devel/c/kiEh8JgbWeQ/m/Oqe77sQTCAAJ


---

Comment by mkoeppe created at 2021-12-27 19:48:00

From https://www.gnu.org/software/libc/manual/html_node/Special-Functions.html:

Function: double gamma (double x)
Function: float gammaf (float x)
Function: long double gammal (long double x)
Preliminary: | MT-Unsafe race:signgam | AS-Unsafe | AC-Safe | See POSIX Safety Concepts.

These functions exist for compatibility reasons. They are equivalent to lgamma etc. It is better to use lgamma since for one the name reflects better the actual computation, and moreover lgamma is standardized in ISO C99 while gamma is not.


---

Comment by mkoeppe created at 2021-12-27 19:55:16

Has this patch been submitted to upstream `giac`?
- https://github.com/void-linux/void-packages/blob/master/srcpkgs/giac/patches/fgamma.patch


---

Comment by mkoeppe created at 2021-12-27 20:06:07

There seems to be some confusion between gamma and log of gamma here.


---

Comment by @dkwo created at 2021-12-28 18:53:42

Does this test pass on Alpine?


```
sage -t /usr/lib/sage-9.5.beta9/src/sage/matrix/matrix_mod2_dense.pyx # 1 doctest failed
```


It's the last one failing on Void with musl 1.2.2,
where it gives 


```
cysignals.signals.SignalError: matrix allocation failed
```


instead of


```
RuntimeError: matrix allocation failed
```


so I wonder if the result is the same on Alpine,
and whether possibly the test result should be updated.


---

Comment by tornaria created at 2021-12-28 22:33:37

Replying to [comment:18 gh-dkwo]:
> Does this test pass on Alpine?

It looks to me like a bug in `posix_memalign()` in musl 1.2.2, see https://github.com/void-linux/void-packages/pull/34030#issuecomment-1002300676 and the comment before that one.

The cysignals code looks ok to me (specifically `sig_raise_exception` in `signals.pyx`) except that when raising `SignalError` with a custom message there is no way to distinguish `SIGILL`, `SIGSEGV` and `SIGBUS`. Maybe useful to append or prepend `"(SIGILL)"`, etc. to the message to aid debugging.


---

Comment by tornaria created at 2021-12-29 02:13:21

Replying to [comment:17 mkoeppe]:
> There seems to be some confusion between gamma and log of gamma here.

The intention of `fgamma()` seems to be to compute gamma (not log gamma). If I'm not mistaken the patch would be necessary for glibc as much as for musl, but I don't know if there's a way to trigger giac to call `fgamma()` at all.

You may find https://github.com/void-linux/void-packages/blob/master/srcpkgs/giac/patches/malloc.patch useful.


---

Comment by mkoeppe created at 2021-12-29 19:35:44

`@`parisse, could you take a look at the issue with `gamma` (comment:16, comment:21)?


---

Comment by dimpase created at 2022-01-01 10:38:39

some apline system packages listed, e.g. primesieve, is only available in their testing repo. I.e. one needs to make sure that
`/etc/apk/repositories`
contains

```
http://dl-cdn.alpinelinux.org/alpine/edge/testing
```



---

Comment by dimpase created at 2022-01-01 14:36:32

for Flint, `d7b89f1`

```
+# Trac #33083: Needed for cpu_set_t on musl libc
+CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
+export CPPFLAGS
```

does not work. One really needs to use CFLAGS instead. Also, the same is needed for arb,
as it includes flint's headers, and without it it's the same error.


---

Comment by dimpase created at 2022-01-01 15:52:39

Replying to [comment:21 tornaria]:
> Replying to [comment:17 mkoeppe]:
> > There seems to be some confusion between gamma and log of gamma here.
> 
> The intention of `fgamma()` seems to be to compute gamma (not log gamma). If I'm not mistaken the patch would be necessary for glibc as much as for musl, but I don't know if there's a way to trigger giac to call `fgamma()` at all.
> 
> You may find https://github.com/void-linux/void-packages/blob/master/srcpkgs/giac/patches/malloc.patch useful.

From reading giac source, it's obvious that `tgammaf` was meant there. It's just some weirdness of musl or alpine which makes it not to use `tgammaf`, but `gammaf`, where e.g. on Apple it would have been `tgammaf`.

Building with `CPPFLAGS="$CPPFLAGS -DNO_BSD" make giac` succeeds. `NO_BSD` is some strange variable that does not seem to be used anywhere else in giac, so that's tentative.


---

Comment by dimpase created at 2022-01-02 09:00:16

The next problem is with numpy, see #33070 and the attachment there. Apparently numpy currently is a problem on alpine/edge. I'll look up numpy's issues on this.


---

Comment by dimpase created at 2022-01-02 22:01:49

one more package to add - mpc:


```diff
--- /dev/null
+++ b/build/pkgs/mpc/distros/apline.txt
@@ -0,0 +1,2 @@
+mpc1
+mpc1-dev
```



---

Comment by mkoeppe created at 2022-01-02 22:18:18

Feel free to push to branch after fixing the typoe `apline` -> `alpine`


---

Comment by dimpase created at 2022-01-02 23:36:40

Last 10 new commits:


---

Comment by git created at 2022-01-02 23:44:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-09 18:54:52

New commits:


---

Comment by mkoeppe created at 2022-01-09 20:23:34

The problem with `giac` is still unresolved


---

Comment by dimpase created at 2022-01-09 20:47:23

maybe add the workaround from comment:25 ?


---

Comment by git created at 2022-01-09 21:17:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-01-09 21:51:46

how about the numpy problem?

I looked a bit into this - while alpine does provide a numpy package, I had trouble finding their patches/source package.


---

Comment by mkoeppe created at 2022-01-10 02:28:42

Replying to [comment:37 dimpase]:
> how about the numpy problem?

Fixed by #33138.


---

Comment by mkoeppe created at 2022-01-10 02:30:56

Next issue:

```
  [cvxopt-1.2.7]     src/C/umfpack.c:23:10: fatal error: umfpack.h: No such file or directory
  [cvxopt-1.2.7]        23 | #include "umfpack.h"
  [cvxopt-1.2.7]           |          ^~~~~~~~~~~
  [cvxopt-1.2.7]     compilation terminated.
```



---

Comment by mkoeppe created at 2022-01-10 03:53:23

This problem is again - our `build/pkgs/suitesparse/spkg-configure.m4` finds suitesparse but forgets to tell anyone where it was found.


---

Comment by mkoeppe created at 2022-01-10 04:00:35

Similar to #30052.


---

Comment by git created at 2022-01-10 05:23:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2022-01-10 12:09:21

Replying to [comment:40 mkoeppe]:
> This problem is again - our `build/pkgs/suitesparse/spkg-configure.m4` finds suitesparse but forgets to tell anyone where it was found.

Suitesparse found in the system library/header path but cvxopt tries to guess it anyway?

This has been reported a few times,
- https://github.com/cvxopt/cvxopt/issues/156
- https://github.com/cvxopt/cvxopt/issues/174

For now we'll probably be adding another special case to

https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55


---

Comment by dimpase created at 2022-01-10 12:37:48

Replying to [comment:43 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[455e1fa](https://git.sagemath.org/sage.git/commit/?id=455e1fa3187386367b43d0e3869e5d39f5b8101d)||`build/pkgs/numpy/spkg-install.in: Use pip wheel --no-use-pep517`||
> ||[1fe1e85](https://git.sagemath.org/sage.git/commit/?id=1fe1e859086183d0fe6e86cda3b1227ff3a96501)||`Merge #33138`||

This gives a different error:

```
  Running setup.py clean for numpy
  Running command /home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.10/bin/python3 -u -c 'import io, os, sys, setuptools, tokenize; sys.argv[0] = '"'"'/hom
e/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.10/var/tmp/sage/build/numpy-1.21.4/src/setup.py'"'"'; __file__='"'"'/home/dima/sagetrac-mirror/local/var/lib/
sage/venv-python3.10/var/tmp/sage/build/numpy-1.21.4/src/setup.py'"'"';f = getattr(tokenize, '"'"'open'"'"', open)(__file__) if os.path.exists(__file__) else io.Str
ingIO('"'"'from setuptools import setup; setup()'"'"');code = f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))
' clean --all
  /home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.10/var/tmp/sage/build/numpy-1.21.4/src/setup.py:63: RuntimeWarning: NumPy 1.21.4 may not yet support Py
thon 3.10.
    warnings.warn(
  Running from numpy source directory.

  `setup.py clean` is not supported, use one of the following instead:

    - `git clean -xdf` (cleans all files)
    - `git clean -Xdf` (cleans all versioned files, doesn't touch
                        files that aren't checked into the git repo)

  Add `--force` to your command to use it anyway if you must (unsupported).

  ERROR: Failed cleaning build dir for numpy
Failed to build numpy
ERROR: Failed to build one or more wheels
********************************************************************************
Error building a wheel for numpy-1.21.4
```



---

Comment by dimpase created at 2022-01-10 13:57:20

Nor it fixed the already reported numpy error, the `clean` thing is just an extra after


```
[numpy-1.21.4]   creating build/temp.linux-x86_64-3.10/build/src.linux-x86_64-3.10/numpy/core/src/npymath
[numpy-1.21.4]   compile options: '-Ibuild/src.linux-x86_64-3.10/numpy/core/src/npymath -Inumpy/core/include -Ibuild/src.linux-x86_64-3.10/numpy/core/include/numpy -Ibuild/src.linux-x86_64-3.10/numpy/distutils/include -Inumpy/core/src/common -Inumpy/core/src -Inumpy/core -Inumpy/core/src/npymath -Inumpy/core/src/multiarray -Inumpy/core/src/umath -Inumpy/core/src/npysort -Inumpy/core/src/_simd -I/home/dima/sagetrac-mirror/local/var/lib/sage/venv-python3.10/include -I/usr/include/python3.10 -Ibuild/src.linux-x86_64-3.10/numpy/core/src/common -Ibuild/src.linux-x86_64-3.10/numpy/core/src/npymath -c'
[numpy-1.21.4]   extra options: '-msse -msse2 -msse3'
[numpy-1.21.4]   error: [Errno 2] No such file or directory
[numpy-1.21.4] 
[numpy-1.21.4]   ########### CLIB COMPILER OPTIMIZATION ###########
[numpy-1.21.4]   Platform      :
[numpy-1.21.4]     Architecture: x64
[numpy-1.21.4]     Compiler    : gcc
[numpy-1.21.4] 
[numpy-1.21.4]   CPU baseline  :
[numpy-1.21.4]     Requested   : 'min'
[numpy-1.21.4]     Enabled     : SSE SSE2 SSE3
[numpy-1.21.4]     Flags       : -msse -msse2 -msse3
[numpy-1.21.4]     Extra checks: none
```


apline sources for numpy are in https://git.alpinelinux.org/aports/tree/community/py3-numpy - going to try their patch. Note that they just call `python3 setup.py` directly, no pip.


---

Comment by dimpase created at 2022-01-10 14:15:42

Apline patches don't help. They don't build wheels, as far as I can see, either.


---

Comment by dimpase created at 2022-01-10 15:11:02

given that numpy don't distribute wheels for musl libc, it might be something they just can't do at the moment...


---

Comment by dimpase created at 2022-01-10 16:02:35

see https://github.com/numpy/numpy/issues/20780


---

Comment by mkoeppe created at 2022-01-10 17:52:46

Replying to [comment:45 dimpase]:
> Replying to [comment:43 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[455e1fa](https://git.sagemath.org/sage.git/commit/?id=455e1fa3187386367b43d0e3869e5d39f5b8101d)||`build/pkgs/numpy/spkg-install.in: Use pip wheel --no-use-pep517`||
> > ||[1fe1e85](https://git.sagemath.org/sage.git/commit/?id=1fe1e859086183d0fe6e86cda3b1227ff3a96501)||`Merge #33138`||
> 
> This gives a different error

Works fine here. How are you testing this?


---

Comment by dimpase created at 2022-01-11 11:05:06

Replying to [comment:50 mkoeppe]:
> Replying to [comment:45 dimpase]:
> > Replying to [comment:43 git]:
> > > Branch pushed to git repo; I updated commit sha1. New commits:
> > > ||[455e1fa](https://git.sagemath.org/sage.git/commit/?id=455e1fa3187386367b43d0e3869e5d39f5b8101d)||`build/pkgs/numpy/spkg-install.in: Use pip wheel --no-use-pep517`||
> > > ||[1fe1e85](https://git.sagemath.org/sage.git/commit/?id=1fe1e859086183d0fe6e86cda3b1227ff3a96501)||`Merge #33138`||
> > 
> > This gives a different error
> 
> Works fine here. How are you testing this?

running Apline in an lxc container.
Using their Python 3.10, their openblas - I guess that's the only pieces of the config puzzle that matter. 

That's the same error as I get while trying to build numpy wheel without Sage using pip,
just by running `pip wheel -e .` in the unzipped numpy distro. (same error on their master from the repo, too),


---

Comment by mkoeppe created at 2022-01-11 16:36:43

Your installation is broken somehow


---

Comment by dimpase created at 2022-01-11 20:15:47

Maybe, but "No such file or directory" error ought to be traceable...


---

Comment by dimpase created at 2022-01-12 14:46:36

OK, let's get this in. (the lxc container setup might be to blame for the numpy issue I keep seeing)


---

Comment by dimpase created at 2022-01-12 14:46:36

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-01-12 16:29:40

Looks like the added flags break the build of `arb` on Debian variants - https://github.com/mkoeppe/sage/runs/4785815685?check_suite_focus=true


---

Comment by mkoeppe created at 2022-01-12 16:29:40

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-01-17 08:12:14

Replying to [comment:44 mjo]:
> Replying to [comment:40 mkoeppe]:
> > This problem is again - our `build/pkgs/suitesparse/spkg-configure.m4` finds suitesparse but forgets to tell anyone where it was found.
> 
> Suitesparse found in the system library/header path but cvxopt tries to guess it anyway?
> 
> This has been reported a few times,
> - https://github.com/cvxopt/cvxopt/issues/156
> - https://github.com/cvxopt/cvxopt/issues/174
> 
> For now we'll probably be adding another special case to
> 
> https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55

See also #31905


---

Comment by git created at 2022-06-18 22:40:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-07 23:30:20

Branch pushed to git repo; I updated commit sha1. New commits:
