# Issue 28802: Package sage_local

Issue created by migration from https://trac.sagemath.org/ticket/29039

Original creator: mkoeppe

Original creation time: 2020-01-18 17:34:51

CC:  jhpalmieri dimpase fbissey vbraun

This provides an alternative and strictly optional way of installing sage-the-distribution that may be useful for some users who wish to use `pip` to install everything they need.

It establishes a python-less SAGE_LOCAL hierarchy in the installed `package_data` of a new Python package `sage_local`.

It also installs `sage_conf.py` (#29038) to enable installing a sagelib using that SAGE_LOCAL>


---

Comment by mkoeppe created at 2020-06-29 22:16:31

New commits:


---

Comment by git created at 2020-06-30 01:02:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-01 03:45:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-01 06:42:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-03 06:13:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-26 01:41:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-11-26 04:49:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-06 17:45:54

Changing keywords from "" to "sd111".


---

Comment by git created at 2021-02-14 02:24:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-02-14 07:09:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 07:23:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-14 07:25:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-14 08:21:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 08:37:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-14 08:54:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 18:57:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 19:42:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-14 19:47:18

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-02-14 19:47:18

Changing status from new to needs_review.


---

Comment by git created at 2021-02-14 20:18:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 20:32:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 20:39:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-14 22:14:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-07 21:36:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-15 01:04:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-15 01:15:10

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-15 02:16:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-15 03:50:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 06:20:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-04-09 08:52:23

what does the change to `build/pkgs/sagelib/src/MANIFEST.in` mean? is it becoming a symbolic link?


---

Comment by dimpase created at 2021-04-09 09:39:35

after merging 9.3.rc2 in, I get an error (is it from `sh: line 0: .: .homebrew-build-env: file not found`, cf below ?):

```
$ ./bootstrap && (cd src/pkgs/sage_conf-pypi/ && tox -v -v -v)
...
    warning: no previously-included files matching '__pycache__' found anywhere in distribution
    warning: no previously-included files matching '*.pyc' found anywhere in distribution
    writing manifest file '/home/scratch2/dimpase/tmp/pip-modern-metadata-27nf1gz1/sage_conf.egg-info/SOURCES.txt'
    creating '/home/scratch2/dimpase/tmp/pip-modern-metadata-27nf1gz1/sage_conf.dist-info'
    Preparing wheel metadata ... done
  Source in /home/scratch2/dimpase/tmp/pip-req-build-0rrkid61 has version 9.3rc2, which satisfies requirement sage-conf==9.3rc2 from file:///home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3rc2.zip
  Removed sage-conf==9.3rc2 from file:///home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3rc2.zip from build tracker '/home/scratch2/dimpase/tmp/pip-req-tracker-bla_u_md'
Created temporary directory: /home/scratch2/dimpase/tmp/pip-unpack-rwlm13mn
Building wheels for collected packages: sage-conf
  Created temporary directory: /home/scratch2/dimpase/tmp/pip-wheel-k4duer3n
  Destination directory: /home/scratch2/dimpase/tmp/pip-wheel-k4duer3n
  Running command /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_vendor/pep517/_in_process.py build_wheel /home/scratch2/dimpase/tmp/tmpdhib0roj
  running bdist_wheel
  running build
  running build_py
  sh: line 0: .: .homebrew-build-env: file not found
  Running cd /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu && . .homebrew-build-env 2>&1; : && ./configure --prefix=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/local --with-python=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python --with-system-python3=force --disable-notebook --disable-sagelib
  error: configure failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Exception information:
Traceback (most recent call last):
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/commands/install.py", line 361, in run
    ", ".join(pep517_build_failure_names)
pip._internal.exceptions.InstallationError: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Removed build tracker: '/home/scratch2/dimpase/tmp/pip-req-tracker-bla_u_md'
python finish: installpkg after 3.39 seconds
python start: envreport 
setting PATH=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin:/users/dimpase/perl5/bin:/users/dimpase/bin:/usr/libexec/python3-sphinx:/usr/lib64/qt-3.3/bin:/usr/share/Modules/bin:/usr/lib64/ccache:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/users/dimpase/.cabal/bin:/auto/users/dimpase/bin
  /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi$ /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip freeze >/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/log/python-3.log
python finish: envreport after 0.20 seconds
python installed: 
_________________________________________________________________________________________________ summary __________________________________________________________________________________________________
ERROR:   python: InvocationError for command '/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --no-deps -U -v /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3rc2.zip' (exited with code 1)
cleanup /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3rc2.zip
```



---

Comment by dimpase created at 2021-04-09 09:40:24

this is on Fedora 30, in case it matters


---

Comment by dimpase created at 2021-04-09 09:40:24

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-09 16:24:15

Replying to [comment:57 dimpase]:
> what does the change to `build/pkgs/sagelib/src/MANIFEST.in` mean? is it becoming a symbolic link?
Yes, it was duplicated with `SAGE_ROOT/src/MANIFEST.in`, and I replaced it with a symlink


---

Comment by git created at 2021-04-09 16:31:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-09 16:33:32

Replying to [comment:58 dimpase]:
> after merging 9.3.rc2 in, I get an error (is it from `sh: line 0: .: .homebrew-build-env: file not found`, cf below ?):
> {{{
> $ ./bootstrap && (cd src/pkgs/sage_conf-pypi/ && tox -v -v -v)
> ...

Thanks for testing! Is this running in a docker container? Not clear to me why the file would be missing. Anyway I have cherry-picked a related change from #31396 and made another change - please take a look if this gets farther


---

Comment by mkoeppe created at 2021-04-09 16:33:42

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-04-09 19:25:53

no, still the same error:

```
...
Created temporary directory: /home/scratch2/dimpase/tmp/pip-unpack-169y8koj
Building wheels for collected packages: sage-conf
  Created temporary directory: /home/scratch2/dimpase/tmp/pip-wheel-exb6ynmx
  Destination directory: /home/scratch2/dimpase/tmp/pip-wheel-exb6ynmx
  Running command /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_vendor/pep517/_in_process.py build_wheel /home/scratch2/dimpase/tmp/tmpvehv3h0s
  running bdist_wheel
  running build
  running build_py
  sh: line 0: .: .homebrew-build-env: file not found
  Running cd /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu && (. .homebrew-build-env 2>&1 || :) && ./configure --prefix=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/local --with-python=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python --with-system-python3=force --disable-notebook --disable-sagelib
  error: configure failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Exception information:
Traceback (most recent call last):
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pip/_internal/commands/install.py", line 361, in run
    ", ".join(pep517_build_failure_names)
pip._internal.exceptions.InstallationError: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Removed build tracker: '/home/scratch2/dimpase/tmp/pip-req-tracker-_6q2pk49'
python finish: installpkg after 3.35 seconds
python start: envreport 
setting PATH=/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin:/users/dimpase/perl5/bin:/users/dimpase/bin:/usr/libexec/python3-sphinx:/usr/lib64/qt-3.3/bin:/usr/share/Modules/bin:/usr/lib64/ccache:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/users/dimpase/.cabal/bin:/auto/users/dimpase/bin
  /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi$ /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip freeze >/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/log/python-9.log
python finish: envreport after 0.20 seconds
python installed: 
__________________________________________________________________________ summary ___________________________________________________________________________
ERROR:   python: InvocationError for command '/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --no-deps -U -v /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3rc2.zip' (exited with code 1)
```



---

Comment by dimpase created at 2021-04-09 19:26:11

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-09 19:33:29

Could you show what's in `/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu`?


---

Comment by dimpase created at 2021-04-09 19:34:41


```
$ ls -la /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu
total 1196
drwxr-xr-x 6 dimpase staff    4096 Apr  9 20:24 .
drwxr-xr-x 4 dimpase staff    4096 Apr  9 20:24 ..
-rwxr-xr-x 1 dimpase staff      81 Apr  9 20:24 bootstrap
drwxr-xr-x 7 dimpase staff    4096 Apr  9 20:24 build
drwxr-xr-x 2 dimpase staff    4096 Apr  9 20:24 config
-rwxr-xr-x 1 dimpase staff 1126829 Apr  9 20:24 configure
-rw-r--r-- 1 dimpase staff   18020 Apr  9 20:24 configure.ac
-rw-r--r-- 1 dimpase staff    1602 Apr  9 20:24 .homebrew-build-env
drwxr-xr-x 2 dimpase staff    4096 Apr  9 20:24 m4
-rw-r--r-- 1 dimpase staff    9744 Apr  9 20:24 Makefile
-rw-r--r-- 1 dimpase staff   20890 Apr  9 20:24 README.md
drwxr-xr-x 4 dimpase staff    4096 Apr  9 20:24 src
-rw-r--r-- 1 dimpase staff      51 Apr  9 20:24 VERSION.txt
```



---

Comment by git created at 2021-04-10 18:14:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-10 18:15:12

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-04-11 16:18:25

the dependent ticket is not merged in the branch, any reason for this?


---

Comment by git created at 2021-04-11 16:30:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-11 16:31:02

Replying to [comment:70 dimpase]:
> the dependent ticket is not merged in the branch, any reason for this?
Thanks for catching this, the latest version was not merged


---

Comment by mkoeppe created at 2021-04-11 16:36:11

Here on the ticket I am creating things in `src/pkgs/` but in #31577 I have a different proposal for the source layout, comments welcome


---

Comment by dimpase created at 2021-04-11 18:17:56

now I get a failure in building numpy, if I run
`./bootstrap && (cd src/pkgs/sage_conf-pypi/ && tox -v -v -v)`
after distclean.



```
Uninstalling 'numpy' with legacy uninstaller
Package 'numpy' is currently not installed
Traceback (most recent call last):
  File "../lapack_conf.py", line 3, in <module>
    import pkgconfig, os
ModuleNotFoundError: No module named 'pkgconfig'
```


and also weird error with cysignal:

```
checking for std::atomic with OpenMP in C++ code... yes
configure: creating ./config.status
config.status: creating src/cysignals/signals.pxd
config.status: creating src/config.h
config.status: creating src/cysignals/cysignals_config.h
configure: WARNING: unrecognized options: --disable-maintainer-mode, --disable-dependency-tracking
Installing cysignals-1.10.3
WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fda2cad2310>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/cython/
WARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fda2cad2690>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/cython/
WARNING: Retrying (Retry(total=2, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fda2cad2890>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/cython/
WARNING: Retrying (Retry(total=1, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fda2cad2ad0>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/cython/
WARNING: Retrying (Retry(total=0, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x7fda2cad2d10>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/cython/
ERROR: Could not find a version that satisfies the requirement Cython>=0.28
ERROR: No matching distribution found for Cython>=0.28
Traceback (most recent call last):
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/installer.py", line 75, in fetch_build_egg
    subprocess.check_call(cmd)
  File "/usr/lib64/python3.7/subprocess.py", line 363, in check_call
    raise CalledProcessError(retcode, cmd)
subprocess.CalledProcessError: Command '['/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/local/bin/python3', '-m', 'pip', '--disable-pip-version-check', 'wheel', '--no-deps', '-w', '/home/scratch2/dimpase/tmp/tmp772nb9rh', '--quiet', 'Cython>=0.28']' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "setup.py", line 152, in <module>
    cmdclass=dict(build=build, bdist_egg=no_egg),
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/__init__.py", line 152, in setup
    _install_setup_requires(attrs)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/__init__.py", line 147, in _install_setup_requires
    dist.fetch_build_eggs(dist.setup_requires)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/dist.py", line 724, in fetch_build_eggs
    replace_conflicting=True,
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pkg_resources/__init__.py", line 768, in resolve
    replace_conflicting=replace_conflicting
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pkg_resources/__init__.py", line 1051, in best_match
    return self.obtain(req, installer)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/pkg_resources/__init__.py", line 1063, in obtain
    return installer(requirement)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/dist.py", line 780, in fetch_build_egg
    return fetch_build_egg(self, req)
  File "/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.7/site-packages/setuptools/installer.py", line 77, in fetch_build_egg
    raise DistutilsError(str(e)) from e
distutils.errors.DistutilsError: Command '['/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/local/bin/python3', '-m', 'pip', '--disable-pip-version-check', 'wheel', '--no-deps', '-w', '/home/scratch2/dimpase/tmp/tmp772nb9rh', '--quiet', 'Cython>=0.28']' returned non-zero exit status 1.
Error: could not determine package name
```


dependencies issue?


---

Comment by mkoeppe created at 2021-04-11 18:29:22

Note that `make distclean` does not clean stuff in `.tox`, so if you want to start from scratch, use `tox -r`


---

Comment by dimpase created at 2021-04-11 22:50:13

still, after successful `make build`, running the command in the ticket description ends with 

```
  Error building Sage.

  The following package(s) may have failed to build (not necessarily
  during this run of 'make all-build'):

  * package:         numpy-1.19.5
    last build time: Apr 11 22:40
    log file:        /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/logs/pkgs/numpy-1.19.5.log
    build directory: /home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu/local/var/tmp/sage/build/numpy-1.19.5

```

and in the numpy log I see

```
Uninstalling 'numpy' with legacy uninstaller
Package 'numpy' is currently not installed
Traceback (most recent call last):
  File "../lapack_conf.py", line 3, in <module>
    import pkgconfig, os
ModuleNotFoundError: No module named 'pkgconfig'

real    0m0.064s
user    0m0.049s
sys     0m0.010s
************************************************************************
Error installing package numpy-1.19.5
}}} 

a race condition, `pkgconfig` is not installed yet?


---

Comment by dimpase created at 2021-04-11 22:55:45

and this

```
$ ./sage --python
Python 3.7.7 (default, Mar 13 2020, 21:39:43) 
[GCC 9.2.1 20190827 (Red Hat 9.2.1-1)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import pkgconfig
>>> 
```

is OK. Is something weird happening with the Python while building numpy?


---

Comment by dimpase created at 2021-04-11 23:02:04

Oh, I see. The script `lapack_conf.py` calls `sage-bootstrap-python`, which is not Sage's python in this case, it's a python2.


```
clpc171[/home/scratch2/dimpase/sage/sage]$ ./sage --buildsh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/scratch2/dimpase/sage/sage
(sage-buildsh) dimpase@clpc171:sage$ sage-bootstrap-python 
Python 2.7.18 (default, Apr 21 2020, 18:49:31) 
[GCC 9.3.1 20200408 (Red Hat 9.3.1-2)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> 
```



---

Comment by dimpase created at 2021-04-11 23:18:11

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-11 23:20:28

That's really something that we need to fix in a separate ticket!


---

Comment by mkoeppe created at 2021-04-11 23:21:48

No, actually `spkg-install.in` calls `python3`.


---

Comment by mkoeppe created at 2021-04-11 23:24:15

You are interacting with the wrong SAGE_ROOT, by the way. The relevant `SAGE_ROOT` is `/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu`. What's happening in `/home/scratch2/dimpase/sage/sage` is irrelevant.


---

Comment by dimpase created at 2021-04-12 08:25:14

Replying to [comment:81 mkoeppe]:
> No, actually `spkg-install.in` calls `python3`.

well, it calls the failing `lapack_conf.py`, which prescribes a different Python.


---

Comment by mkoeppe created at 2021-04-12 16:19:01

See #31663, where I explain this in more detail


---

Comment by dimpase created at 2021-04-12 22:35:35

Replying to [comment:82 mkoeppe]:
> You are interacting with the wrong SAGE_ROOT, by the way. The relevant `SAGE_ROOT` is `/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu`. What's happening in `/home/scratch2/dimpase/sage/sage` is irrelevant.

OK, so I guess here is the test showing that `pkgconfig` module is not there
(I `cd` to the said `SAGE_ROOT` and run `./local/bin/python3` there):

```
clpc171[/home/scratch2/dimpase/sage/sage/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3.rc2-cpython-37m-x86_64-linux-gnu]$ ./local/bin/python3
Python 3.7.7 (default, Mar 13 2020, 21:39:43) 
[GCC 9.2.1 20190827 (Red Hat 9.2.1-1)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import pkgconfig
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'pkgconfig'
```


(and the same import works for the "usual" SAGE_ROOT just fine)


---

Comment by dimpase created at 2021-04-13 08:58:17

If I pip-install `pkgconfig` and `cython` in the correct SAGE_ROOT, then tox run gets through numpy install just fine, but fails later in a similar way on pplpy.

I guess dependency resolution is shot, or there is a race somewhere, leading to wrong order of installations.


---

Comment by mkoeppe created at 2021-04-13 15:47:36

Thanks for testing! This is very strange...


---

Comment by git created at 2021-05-11 03:01:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-11 17:59:13

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-05-11 17:59:13

It may be worth testing whether at least the built source distribution (https://pypi.org/project/sagemath-standard/) works for you as advertised.


---

Comment by dimpase created at 2021-05-12 09:43:07

it seems to parallelize `make` too aggressively. Just had to reboot a machine I tried this on.
Namely, `top` shows a massive number of `make` instances launched, hundreds. The log is full of

```
make[20]: warning: -j4 forced in submake: resetting jobserver mode.
  make -j4 build/make/Makefile --stop
```




Also, the 1st attempt to run `tox -v -v -v` failed with a message like "packages PEP <something>
are not directly installable" (or something like this). I just started it again, and it went on.


---

Comment by mkoeppe created at 2021-05-12 19:11:23

Replying to [comment:91 dimpase]:
> it seems to parallelize `make` too aggressively. Just had to reboot a machine I tried this on.
This sounds more like an infinite "make" recursion. Could you remove the setting of `-j` from `src/pkgs/sage_conf-pypi/setup.py` (and from your environment) and try what it does then?


---

Comment by dimpase created at 2021-05-13 09:32:22

I still quickly get `make` completely taking over the machine:

```
$ ps -def | grep make | wc -l
1797
```

even after

```diff
diff --git a/src/pkgs/sage_conf-pypi/setup.py b/src/pkgs/sage_conf-pypi/setup.py
index b7646224d6..8ee7211104 100644
--- a/src/pkgs/sage_conf-pypi/setup.py
+++ b/src/pkgs/sage_conf-pypi/setup.py
@@ -52,7 +52,7 @@ class build_py(distutils_build_py):
         # but then a user could use "make build-venv" to build compatible wheels for all Python packages.
         # TODO: A target to only build wheels of tricky packages
         # (that use native libraries shared with other packages).
-        SETMAKE = 'if [ -z "$MAKE" ]; then export MAKE="make -j$(PATH=build/bin:$PATH build/bin/sage-build-num-threads | cut -d" " -f 2)"; fi'
+        SETMAKE = 'if [ -z "$MAKE" ]; then export MAKE="make"; fi'
         cmd = f'cd {SAGE_ROOT} && {SETENV} && {SETMAKE} && $MAKE V=0 build'
         if os.system(cmd) != 0:
             raise DistutilsSetupError("make build-local failed")
```

no more `warning: -j4 forced in submake: resetting jobserver mode` seen, but that's not the root cause. This is with make 4.3.


---

Comment by dimpase created at 2021-05-13 10:27:44

It could be that some wrong links are created by git; if I try to pull this branch I get

```
CONFLICT (directory/file): There is a directory with name build/pkgs/sage_conf/src in HEAD. Adding build/pkgs/sage_conf/src as build/pkgs/sage_conf/src~df2f8d11a2d204b5e5197b968ab1bb8e62486508
Automatic merge failed; fix conflicts and then commit the result.
```

and perhaps I didn't fix conflicts correctly.

It would be good to have something rebased on the develop branch here.


---

Comment by dimpase created at 2021-05-13 13:36:22

OK, on a clean tree checkout I don't get the make issues. Apologies.


---

Comment by dimpase created at 2021-05-13 13:53:44

`./bootstrap && (cd src/pkgs/sage_conf-pypi/ && tox -r -v -v -v)` seems to work, although I had to restart `tox -r -v -v -v` at some moment. Retrying after distclean, to see if I can reproduce this.
I'm getting

```
 make --no-print-directory polytopes_db-no-deps
  sage-logger -p 'SAGE_CHECK=no sage-spkg   polytopes_db-20170220.p0' '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/polytopes_db-20170220.p0.log'
  [polytopes_db-20170220.p0] installing. Log file: /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/polytopes_db-20170220.p0.log
    [polytopes_db-20170220.p0] successfully installed.
  make --no-print-directory singular-no-deps
  sage-logger -p 'SAGE_CHECK=no sage-spkg   singular-4.2.0p1+2021-04-06+sage' '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/singular-4.2.0p1+2021-04-06+sage.log'
  [singular-4.2.0p1+2021-04-06+sage] installing. Log file: /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/singular-4.2.0p1+2021-04-06+sage.log
    [palp-2.11] successfully installed.
  make --no-print-directory ratpoints-no-deps
  make[3]: *** No rule to make target '../pkgs/sage_conf/src/bin/sage-env-config', needed by '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local/var/lib/sage/installed/sage_conf-9.3'.  Stop.
  make[3]: *** Waiting for unfinished jobs....
  sage-logger -p 'SAGE_CHECK=no sage-spkg   ratpoints-2.1.3.p5' '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/ratpoints-2.1.3.p5.log'
  [ratpoints-2.1.3.p5] installing. Log file: /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/ratpoints-2.1.3.p5.log
    [ratpoints-2.1.3.p5] successfully installed.
    [ecl-21.2.1] successfully installed.
    [gap-4.11.0.p1] successfully installed.
    [singular-4.2.0p1+2021-04-06+sage] successfully installed.
  make[2]: *** [Makefile:2150: all-build] Error 2
  make[2]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/build/make'

  real	9m41.134s
  user	24m26.005s
  sys	1m57.351s
  ***************************************************************
  Error building Sage.

  The following package(s) may have failed to build (not necessarily
  during this run of 'make all-build'):

  It is safe to delete any log files and build directories, but they
  contain information that is helpful for debugging build problems.
  WARNING: If you now run 'make' again, the build directory of the
  same version of the package will, by default, be deleted. Set the
  environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

  make[1]: *** [Makefile:39: all-build] Error 1
  make[1]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu'
  make: *** [Makefile:16: build] Error 2
  Running cd /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu && (. ./.homebrew-build-env 2> /dev/null || :) && ./configure --prefix=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local --with-python=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python --enable-build-as-root --with-system-python3=force --disable-notebook --disable-sagelib
  error: make build-local failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Exception information:
Traceback (most recent call last):
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/commands/install.py", line 358, in run
    raise InstallationError(
pip._internal.exceptions.InstallationError: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
WARNING: You are using pip version 21.0.1; however, version 21.1.1 is available.
You should consider upgrading via the '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --upgrade pip' command.
Removed build tracker: '/tmp/pip-req-tracker-edpp7niq'
ERROR: invocation failed (exit code 1)
python finish: installpkg /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip after 622.22 seconds
_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ summary __________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
ERROR:   python: InvocationError for command /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --exists-action w -v .tox/.tmp/package/1/sage_conf-9.3.zip (exited with code 1)
cleanup /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip
```


At this point I can just start `tox -r -v -v -v` again, and it happily continues.
Not sure whether the final result is correct. 

Anyway, the error isn't good.
Looks like a bit of an error in a make rule, it tries to make `../pkgs/sage_conf/src/bin/sage-env-config`.


---

Comment by dimpase created at 2021-05-13 13:58:07

After the restart, I see again

```
make[3]: *** No rule to make target '../pkgs/sage_conf/src/bin/sage-env-config', needed by '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local/var/lib/sage/installed/sage_conf-9.3'.  Stop.
  make[3]: *** Waiting for unfinished jobs....
```

but it does not lead to (immediate) termination.


---

Comment by dimpase created at 2021-05-13 14:45:39

after a while it then errors out with already mentioned

```
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
```

in more detail:

```
...
  [singular-4.2.0p1+2021-04-06+sage] successfully installed.
  make[2]: *** [Makefile:2150: all-build] Error 2
  make[2]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/build/make'

  real	10m35.056s
  user	24m37.840s
  sys	2m0.611s
  ***************************************************************
  Error building Sage.

  The following package(s) may have failed to build (not necessarily
  during this run of 'make all-build'):

  It is safe to delete any log files and build directories, but they
  contain information that is helpful for debugging build problems.
  WARNING: If you now run 'make' again, the build directory of the
  same version of the package will, by default, be deleted. Set the
  environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

  make[1]: *** [Makefile:39: all-build] Error 1
  make[1]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu'
  make: *** [Makefile:16: build] Error 2
  Running cd /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu && (. ./.homebrew-build-env 2> /dev/null || :) && ./configure --prefix=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local --with-python=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python --enable-build-as-root --with-system-python3=force --disable-notebook --disable-sagelib
  error: make build-local failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Exception information:
Traceback (most recent call last):
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/commands/install.py", line 358, in run
    raise InstallationError(
pip._internal.exceptions.InstallationError: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
WARNING: You are using pip version 21.0.1; however, version 21.1.1 is available.
You should consider upgrading via the '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --upgrade pip' command.
Removed build tracker: '/tmp/pip-req-tracker-u1_zy58f'
ERROR: invocation failed (exit code 1)
python finish: installpkg /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip after 675.89 seconds
_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ summary __________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
ERROR:   python: InvocationError for command /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --exists-action w -v .tox/.tmp/package/1/sage_conf-9.3.zip (exited with code 1)
cleanup /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip


---

Comment by dimpase created at 2021-05-13 15:18:56

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-05-13 15:18:56

No, no matter how many times I restart tox, it errors out with 

```
make --no-print-directory singular-no-deps
  sage-logger -p 'SAGE_CHECK=no sage-spkg   singular-4.2.0p1+2021-04-06+sage' '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/singular-4.2.0p1+2021-04-06+sage.log'
  [singular-4.2.0p1+2021-04-06+sage] installing. Log file: /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/singular-4.2.0p1+2021-04-06+sage.log
    [palp-2.11] successfully installed.
  make --no-print-directory ratpoints-no-deps
  make[3]: *** No rule to make target '../pkgs/sage_conf/src/bin/sage-env-config', needed by '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local/var/lib/sage/installed/sage_conf-9.3'.  Stop.
  make[3]: *** Waiting for unfinished jobs....
  sage-logger -p 'SAGE_CHECK=no sage-spkg   ratpoints-2.1.3.p5' '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/ratpoints-2.1.3.p5.log'
  [ratpoints-2.1.3.p5] installing. Log file: /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/logs/pkgs/ratpoints-2.1.3.p5.log
    [ratpoints-2.1.3.p5] successfully installed.
    [ecl-21.2.1] successfully installed.
    [gap-4.11.0.p1] successfully installed.
    [singular-4.2.0p1+2021-04-06+sage] successfully installed.
  make[2]: *** [Makefile:2150: all-build] Error 2
  make[2]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/build/make'

  real	9m16.619s
  user	23m45.919s
  sys	1m54.965s
  ***************************************************************
  Error building Sage.

  The following package(s) may have failed to build (not necessarily
  during this run of 'make all-build'):

  It is safe to delete any log files and build directories, but they
  contain information that is helpful for debugging build problems.
  WARNING: If you now run 'make' again, the build directory of the
  same version of the package will, by default, be deleted. Set the
  environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

  make[1]: *** [Makefile:39: all-build] Error 1
  make[1]: Leaving directory '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu'
  make: *** [Makefile:16: build] Error 2
  Running cd /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu && (. ./.homebrew-build-env 2> /dev/null || :) && ./configure --prefix=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/.sage/sage-9.3-cpython-38-x86_64-linux-gnu/local --with-python=/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python --enable-build-as-root --with-system-python3=force --disable-notebook --disable-sagelib
  error: make build-local failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
ERROR: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
Exception information:
Traceback (most recent call last):
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/base_command.py", line 189, in _main
    status = self.run(options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/cli/req_command.py", line 178, in wrapper
    return func(self, options, args)
  File "/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/lib/python3.8/site-packages/pip/_internal/commands/install.py", line 358, in run
    raise InstallationError(
pip._internal.exceptions.InstallationError: Could not build wheels for sage-conf which use PEP 517 and cannot be installed directly
WARNING: You are using pip version 21.0.1; however, version 21.1.1 is available.
You should consider upgrading via the '/mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --upgrade pip' command.
Removed build tracker: '/tmp/pip-req-tracker-9ti8dn54'
ERROR: invocation failed (exit code 1)
python finish: installpkg /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip after 597.56 seconds
_________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________ summary __________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
ERROR:   python: InvocationError for command /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/python/bin/python -m pip install --exists-action w -v .tox/.tmp/package/1/sage_conf-9.3.zip (exited with code 1)
cleanup /mnt/opt/Sage/sage-clang/src/pkgs/sage_conf-pypi/.tox/.tmp/package/1/sage_conf-9.3.zip
```



---

Comment by git created at 2021-05-26 01:50:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-06 20:13:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 06:14:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 06:19:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-25 06:27:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 18:55:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 19:05:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 19:31:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 20:02:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-25 20:03:01

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-26 00:19:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-28 13:28:42

I tried testing this over a recent pynac 0.7.28 branch, and it errors out as it apparently does not know how to pull upstream tarballs not from the mirrors. Missing `--enable-download-from-upstream-url` missing somewhere?


---

Comment by git created at 2021-06-28 15:48:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-29 15:26:15

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-06-29 15:26:15

OK, this works


---

Comment by mkoeppe created at 2021-06-29 15:48:17

Thank you!


---

Comment by git created at 2021-07-01 22:07:10

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-07-01 22:07:10

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-07-01 22:08:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-01 22:08:40

Changing status from needs_review to positive_review.


---

Comment by git created at 2021-07-24 19:26:14

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-07-24 19:26:14

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-08-12 21:17:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 22:17:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 23:29:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 00:32:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-14 23:37:01

To make it more user-friendly, on a failing configure it should display install instructions for build prereqs.

On a fresh Google Colab:

```
!pip install -v sage-conf
...
  configure: Sorry, the 'm4' command must be in the path to build Sage
  configure: On some systems it can be found in /usr/ccs/bin
  configure: See also http://www.gnu.org/software/m4/
  configure: error: Exiting, as the macro processor 'm4' can not be found.
  Running cd /root/.sage/sage-9.4-cpython-37m-x86_64-linux-gnu && (. ./.homebrew-build-env 2> /dev/null || :) && ./configure --prefix=/root/.sage/sage-9.4-cpython-37m-x86_64-linux-gnu/local --with-python=/usr/bin/python3 --enable-build-as-root --enable-download-from-upstream-url --with-system-python3=force --disable-notebook --disable-sagelib
  error: configure failed
  Building wheel for sage-conf (PEP 517) ... error
  ERROR: Failed building wheel for sage-conf
Failed to build sage-conf
```



---

Comment by git created at 2021-09-15 00:36:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-15 00:46:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-09-15 00:54:47

Better now... but would be better with deferred configure exits (#32060).


```
  -----------------------------------------------------------------------------
  Checking whether SageMath should install SPKG python3...
  checking whether any of bzip2 xz libffi is installed as or will be installed as SPKG... yes; install python3 as well
  configure: error: given --with-system-python3=force but no system package could be used
  configure failed; this may be caused by missing build prerequisites.
  You can install the required build prerequisites using the following shell command

  sudo apt-get install  binutils make m4 perl python3 tar bc gcc g++ ca-certificates

```



---

Comment by git created at 2021-09-15 01:09:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-15 01:36:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-23 14:33:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-26 19:04:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-26 19:20:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-09-26 19:48:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-09-27 21:43:41

A little bit late at this stage to ask for stuff but here it goes. Would it be appropriate to split the file `sage_conf.py` into two parts? 

One that would keep the name and contains the `main` function and doesn't need to be configured, and the second one that just contains the variables and that would be pre-parsed by configure.

The idea being that distro could just provide/configure the second file has they see fit without touching the functionality of the package. Although I am not sure what to do with `sage-env-config` yet in that scenario.


---

Comment by mkoeppe created at 2021-09-27 22:15:10

Yes, this makes sense but I think it would be best done in a follow-up ticket to this ticket and to #31396. Basically a bit of refactoring for the three versions of `sage_conf`.


---

Comment by fbissey created at 2021-09-27 22:26:20

I can wait for that but that would go a long way to ease my adopting it as a new package. 

I am working on splitting sage in sage-on-gentoo on similar lines with some success. I now have a separate sage_setup and sage_docbuild -mostly with the idea that they can be usable by downstream sage package like flatsurf and snappy that I am looking at packaging experimentally. And in the next beta we can expect to have a separate sage-doc to debut. Well "re-debut", it used to be a separate package 10 years ago before I brought back everything in a single coherent unit. Fells a bit like a trip back in time but we are definitely not in the same place as then.


---

Comment by git created at 2021-09-28 00:50:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-28 00:52:08

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-10-29 07:17:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-12 06:08:57

Still waiting for review


---

Comment by fbissey created at 2021-11-12 06:29:20

Right, let's move this forward, it needs a fair bit of bot-testing.


---

Comment by fbissey created at 2021-11-12 06:29:20

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-12 20:41:13

Thanks.

Note that that we currently do not have automatic testing for this by bots or GH Actions.
There are a number of open tickets: #32703, #32570, #32113, #30845 that need attention


---

Comment by git created at 2021-11-19 00:41:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-11-19 00:41:48

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-11-19 00:42:05

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-12-03 20:35:08

Replying to [comment:75 mkoeppe]:
> Note that `make distclean` does not clean stuff in `.tox`, so if you want to start from scratch, use `tox -r`

Should `make distclean` clean stuff in `.tox`? Running `tox -r` might have helped with a problem at https://ask.sagemath.org/question/60029/sage-not-installing-from-source.


---

Comment by mkoeppe created at 2021-12-03 20:55:09

It shouldn't (because .tox is not an artifact of the normal build that is orchestrated by "make"), and this user's problems have nothing to do with tox


---

Comment by mkoeppe created at 2021-12-19 19:33:56

Release script seems to have skipped this ticket


---

Comment by vbraun created at 2021-12-28 21:20:18

This ticket depends on a ticket that has no attached branch, hence it'll never be merged


---

Comment by mkoeppe created at 2021-12-28 21:22:08

Thanks


---

Comment by vbraun created at 2021-12-29 21:43:11

Resolution: fixed


---

Comment by mkoeppe created at 2022-01-01 19:52:06

Replying to [comment:148 fbissey]:
> A little bit late at this stage to ask for stuff but here it goes. Would it be appropriate to split the file `sage_conf.py` into two parts? 
> 
> One that would keep the name and contains the `main` function and doesn't need to be configured, and the second one that just contains the variables and that would be pre-parsed by configure.
> 
> The idea being that distro could just provide/configure the second file has they see fit without touching the functionality of the package.

Done now in #31396. Happy new year!
