# Issue 13357: Supply nice error message when starting $SAGE_ROOT/sage without compiling Sage first

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2012-10-02 22:29:45

Assignee: leif

As title.


---

Comment by jhpalmieri created at 2012-10-02 23:22:36

There used to be such a warning until #11073, and then it was removed. It probably shouldn't have been.


---

Comment by kini created at 2012-10-03 00:14:06

Looks like the message used to be implemented in `$SAGE_ROOT/sage` as this:


```sh
if [ ! -f "$SAGE_ROOT/local/bin/sage-sage" ]; then
cat >&2 <<COMPLAINT
************************************************************************
You must compile Sage first using 'make' in the Sage root directory.
(If you have already compiled Sage, you must set the SAGE_ROOT variable
in the file '$0').
************************************************************************
COMPLAINT
    exit 1
fi
```


What does this have to do with `$SAGE_ROOT`? Do we even still want people to manually hardcode the `$SAGE_ROOT` variable anywhere? Isn't that supposed to be automatically determined these days?

I updated the patch to copy to stderr and use lines of asterisks as in the original message, but retained my new message.


---

Comment by kini created at 2012-10-03 01:01:41

Changed the test condition from `[ -d "$SAGE_LOCAL" ]` to `! grep -r sage- "$SAGE_PACKAGES"/installed/ >& /dev/null`, which I think is maybe more apt. Now to test if this breaks the build...


---

Comment by kini created at 2012-10-03 01:07:42

OK, it does, almost immediately :P


---

Comment by ppurka created at 2012-10-03 05:07:35

Works as advertised. Do you want this to be reviewed or not? :P


---

Comment by kini created at 2012-10-03 05:10:11

It currently breaks the build because the spkg-install script for the sage library tries to run `sage -b` before marking itself as being installed by creating `$SAGE_ROOT/spkg/installed/sage-*`. Don't worry, I'll set it to needs_review when I think it needs review :)


---

Comment by ppurka created at 2012-10-03 05:14:08

Maybe just look for the "spkg/installed" directory? It isn't present on a newly unpacked tarball. Otherwise you could look for "sage" instead of "sage-" in your grep string.


---

Comment by kini created at 2012-10-03 19:35:57

Well, I was hoping to be able to display that error until Sage was in a completely built state. The old code basically checked that the scripts SPKG had been unpacked. Just checking for the `spkg/installed` directory would cause the error to go away as soon as at least one SPKG had been built.


---

Comment by jhpalmieri created at 2012-10-03 20:09:32

Well, you could test whether it's a binary distribution and if not, you could test whether `make` thinks everything is up to date using `make -q build`. Actually, that doesn't seem to work. For a while now, sagetex has been the last spkg to install (because it is the only one which depends on `$(SAGERUNTIME)` in spkg/standard/deps), so you could look for spkg/installed/sagetex-...  By the way, `grep -r` is not portable, so maybe this:

```sh
if [ ! -f "$SAGE_PACKAGES"/standard/.from_bdist ] && ! ls "$SAGE_PACKAGES"/installed | grep sagetex- > /dev/null ; then ...
```

You would need to first check whether spkg/installed exists.


---

Comment by kini created at 2012-10-03 23:44:58

The problem is that currently the sage library SPKG tries to run the main sage executable while installing the sage library, which is fundamentally at odds with the goal of making the main sage executable refuse to run until sage is fully installed. One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.


---

Comment by jhpalmieri created at 2012-10-04 01:07:12

Replying to [comment:10 kini]:
> One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.

Is it just the spkg-install script which needs changing? That makes sense to me anyway, since the sage spkg depends on the scripts spkg, but does not depend (explicitly, anyway) on the root spkg.


---

Comment by kini created at 2012-10-04 21:52:14

As far as I know. On the other hand, I guess Jeroen won't like adding restrictions on when the main Sage executable can be run, because of `sage --sh` and stuff like that. Maybe I'll just stick to checking whether the tarball is totally pristine, and let the executable run if sage has been even partially compiled.


---

Comment by kini created at 2012-10-04 22:04:17

Changing status from new to needs_review.


---

Comment by kini created at 2012-10-04 22:04:17

I'm marking this as needs_review - testing the build right now but it seems like it should work.


---

Comment by jdemeyer created at 2012-10-05 09:03:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-10-05 09:03:22

The following should work without building Sage:

```
jdemeyer`@`arcanis:/usr/local/src/sage-5.4.beta1$ ./sage --sh
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet. Please run `make` in the Sage
root directory first. Read README.txt for more information.
************************************************************************
```


I propose to move the check inside the `sage_setup` function in `spkg/bin/sage` (remember to apply #13459 first!)


---

Comment by jdemeyer created at 2012-10-05 09:04:52

Instead of checking the `local` directory, how about checking the existence of

```
$SAGE_LOCAL/lib/libcsage.so
```

which means that Sage actually has been built.


---

Comment by ppurka created at 2012-11-12 09:08:22

Forgot to upload the updated patch. I compiled 5.4rc4 with [attachment:trac_13561-unbuilt-sage-error-message.2.patch this one], and it seems to work fine.


---

Comment by ppurka created at 2012-11-12 09:08:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-11-12 09:42:37

Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.


---

Comment by ppurka created at 2012-11-12 09:47:22

Replying to [comment:17 jdemeyer]:
> Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.
Why so? Do you expect the file type to change between different versions of Sage?


---

Comment by jdemeyer created at 2012-11-12 09:50:48

Replying to [comment:18 ppurka]:
> Replying to [comment:17 jdemeyer]:
> > Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.
> Why so? Do you expect the file type to change between different versions of Sage?
I don't _expect_ it to change, but it seems strange to *require* that `libcsage.so` is a symbolic link. Also, the `-L` test will succeed if it is a broken symbolic link.


---

Comment by ppurka created at 2012-11-12 09:57:55

Ok. Updated the patch.


---

Comment by jdemeyer created at 2013-01-14 09:11:17

I did not realize that relying on the `.so` extension is not portable (OS X uses `.dylib`).  New patch which uses `local/lib/python/site-packages/sage` instead, also with a slightly extended error message.


---

Attachment

`-d .../sage` doesn't work because it is a symbolic link and not a directory. The other option is to try `-f .../sage`.

Why don't we instead try something like this? It will check if sage can be imported:

```sh
    python -c 'import sage' > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "sage not built blah blah"
        exit 1
    fi
```

I did some tests with this and with checking directory and I don't see much of a difference in the time taken. I ran

```
echo 3 > /proc/sys/vm/drop_caches
```

before every call to the `sage -c` command.

Just the default time taken by a simple command (cold starts, i.e. caches were dropped before every command).

```
~ [1] » time sage -c 'print ""'

sage -c 'print ""'  1.42s user 0.64s system 12% cpu 16.334 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.47s user 0.62s system 9% cpu 22.283 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.49s user 0.65s system 11% cpu 18.610 total
```



The same command after removing the `site-packages/sage` symbolic link, and with the check for `python -c 'import sage'` as written above. "aaaa.." was the echo command (cold starts, i.e. caches were dropped before every command).

```
~» time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.09s user 0.04s system 7% cpu 1.605 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.06s user 0.05s system 8% cpu 1.237 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.07s user 0.05s system 2% cpu 5.046 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.06s user 0.04s system 9% cpu 1.159 total
```


The same command but with the check `-d $SAGE_LOCAL/lib/python/site-packages/sage` (cold starts, i.e. caches were dropped before every command):

```
~» time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 4% cpu 1.703 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.05s system 6% cpu 1.244 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.05s user 0.03s system 7% cpu 1.093 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 1% cpu 4.329 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 6% cpu 1.212 total
```


Maybe there is a very slight slowdown, of the order of 100ms on using the python command (on a cold start), but it is about 10-20ms on a warm start. Compare this with an unpatched sage file.

Unpatched sage file (warm starts, no caches were dropped):

```
~» time sage -c 'print ""'

sage -c 'print ""'  1.17s user 0.32s system 96% cpu 1.546 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.23s user 0.30s system 99% cpu 1.543 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.27s user 0.29s system 98% cpu 1.579 total
```


Patched sage file with `python -c 'import sage'` (warm starts, no caches were dropped):

```
~» time sage -c 'print ""'

sage -c 'print ""'  1.29s user 0.22s system 96% cpu 1.558 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.28s user 0.28s system 99% cpu 1.564 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.20s user 0.35s system 98% cpu 1.563 total
```



---

Comment by jdemeyer created at 2013-01-14 11:33:01

Replying to [comment:22 ppurka]:
> `-d .../sage` doesn't work because it is a symbolic link and not a directory.
Are you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).

It if really doesn't work for you: what is your version of Sage and of `bash`?

And what is the output of

```
ls -ld "$SAGE_LOCAL/lib/python/site-packages/sage"
ls -ld "$SAGE_LOCAL/lib/python/site-packages/sage/../../../../devel/sage/build/sage"
```



---

Comment by ppurka created at 2013-01-14 11:37:43

Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 ppurka]:
> > `-d .../sage` doesn't work because it is a symbolic link and not a directory.
> Are you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).

Whoops, sorry. I got confused with all the testing. It does work.


---

Comment by jdemeyer created at 2013-01-14 14:58:03

So could you formally review my patch then?


---

Comment by ppurka created at 2013-01-14 15:02:22

Yes, sorry. The patch is ok.


---

Comment by ppurka created at 2013-01-14 15:02:22

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-18 07:41:37

Resolution: fixed
