# Issue 13357: Supply nice error message when starting $SAGE_ROOT/sage without compiling Sage first

archive/issues_013357.json:
```json
{
    "body": "Assignee: @nexttime\n\nAs title.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13561\n\n",
    "created_at": "2012-10-02T22:29:45Z",
    "labels": [
        "scripts",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.6",
    "title": "Supply nice error message when starting $SAGE_ROOT/sage without compiling Sage first",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13357",
    "user": "@kini"
}
```
Assignee: @nexttime

As title.

Issue created by migration from https://trac.sagemath.org/ticket/13561





---

archive/issue_comments_164134.json:
```json
{
    "body": "There used to be such a warning until #11073, and then it was removed. It probably shouldn't have been.",
    "created_at": "2012-10-02T23:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164134",
    "user": "@jhpalmieri"
}
```

There used to be such a warning until #11073, and then it was removed. It probably shouldn't have been.



---

archive/issue_comments_164135.json:
```json
{
    "body": "Looks like the message used to be implemented in `$SAGE_ROOT/sage` as this:\n\n\n```sh\nif [ ! -f \"$SAGE_ROOT/local/bin/sage-sage\" ]; then\ncat >&2 <<COMPLAINT\n************************************************************************\nYou must compile Sage first using 'make' in the Sage root directory.\n(If you have already compiled Sage, you must set the SAGE_ROOT variable\nin the file '$0').\n************************************************************************\nCOMPLAINT\n    exit 1\nfi\n```\n\n\nWhat does this have to do with `$SAGE_ROOT`? Do we even still want people to manually hardcode the `$SAGE_ROOT` variable anywhere? Isn't that supposed to be automatically determined these days?\n\nI updated the patch to copy to stderr and use lines of asterisks as in the original message, but retained my new message.",
    "created_at": "2012-10-03T00:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164135",
    "user": "@kini"
}
```

Looks like the message used to be implemented in `$SAGE_ROOT/sage` as this:


```sh
if [ ! -f "$SAGE_ROOT/local/bin/sage-sage" ]; then
cat >&2 <<COMPLAINT
************************************************************************
You must compile Sage first using 'make' in the Sage root directory.
(If you have already compiled Sage, you must set the SAGE_ROOT variable
in the file '$0').
************************************************************************
COMPLAINT
    exit 1
fi
```


What does this have to do with `$SAGE_ROOT`? Do we even still want people to manually hardcode the `$SAGE_ROOT` variable anywhere? Isn't that supposed to be automatically determined these days?

I updated the patch to copy to stderr and use lines of asterisks as in the original message, but retained my new message.



---

archive/issue_comments_164136.json:
```json
{
    "body": "Changed the test condition from `[ -d \"$SAGE_LOCAL\" ]` to `! grep -r sage- \"$SAGE_PACKAGES\"/installed/ >& /dev/null`, which I think is maybe more apt. Now to test if this breaks the build...",
    "created_at": "2012-10-03T01:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164136",
    "user": "@kini"
}
```

Changed the test condition from `[ -d "$SAGE_LOCAL" ]` to `! grep -r sage- "$SAGE_PACKAGES"/installed/ >& /dev/null`, which I think is maybe more apt. Now to test if this breaks the build...



---

archive/issue_comments_164137.json:
```json
{
    "body": "OK, it does, almost immediately :P",
    "created_at": "2012-10-03T01:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164137",
    "user": "@kini"
}
```

OK, it does, almost immediately :P



---

archive/issue_comments_164138.json:
```json
{
    "body": "Works as advertised. Do you want this to be reviewed or not? :P",
    "created_at": "2012-10-03T05:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164138",
    "user": "@ppurka"
}
```

Works as advertised. Do you want this to be reviewed or not? :P



---

archive/issue_comments_164139.json:
```json
{
    "body": "It currently breaks the build because the spkg-install script for the sage library tries to run `sage -b` before marking itself as being installed by creating `$SAGE_ROOT/spkg/installed/sage-*`. Don't worry, I'll set it to needs_review when I think it needs review :)",
    "created_at": "2012-10-03T05:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164139",
    "user": "@kini"
}
```

It currently breaks the build because the spkg-install script for the sage library tries to run `sage -b` before marking itself as being installed by creating `$SAGE_ROOT/spkg/installed/sage-*`. Don't worry, I'll set it to needs_review when I think it needs review :)



---

archive/issue_comments_164140.json:
```json
{
    "body": "Maybe just look for the \"spkg/installed\" directory? It isn't present on a newly unpacked tarball. Otherwise you could look for \"sage\" instead of \"sage-\" in your grep string.",
    "created_at": "2012-10-03T05:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164140",
    "user": "@ppurka"
}
```

Maybe just look for the "spkg/installed" directory? It isn't present on a newly unpacked tarball. Otherwise you could look for "sage" instead of "sage-" in your grep string.



---

archive/issue_comments_164141.json:
```json
{
    "body": "Well, I was hoping to be able to display that error until Sage was in a completely built state. The old code basically checked that the scripts SPKG had been unpacked. Just checking for the `spkg/installed` directory would cause the error to go away as soon as at least one SPKG had been built.",
    "created_at": "2012-10-03T19:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164141",
    "user": "@kini"
}
```

Well, I was hoping to be able to display that error until Sage was in a completely built state. The old code basically checked that the scripts SPKG had been unpacked. Just checking for the `spkg/installed` directory would cause the error to go away as soon as at least one SPKG had been built.



---

archive/issue_comments_164142.json:
```json
{
    "body": "Well, you could test whether it's a binary distribution and if not, you could test whether `make` thinks everything is up to date using `make -q build`. Actually, that doesn't seem to work. For a while now, sagetex has been the last spkg to install (because it is the only one which depends on `$(SAGERUNTIME)` in spkg/standard/deps), so you could look for spkg/installed/sagetex-...  By the way, `grep -r` is not portable, so maybe this:\n\n```sh\nif [ ! -f \"$SAGE_PACKAGES\"/standard/.from_bdist ] && ! ls \"$SAGE_PACKAGES\"/installed | grep sagetex- > /dev/null ; then ...\n```\n\nYou would need to first check whether spkg/installed exists.",
    "created_at": "2012-10-03T20:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164142",
    "user": "@jhpalmieri"
}
```

Well, you could test whether it's a binary distribution and if not, you could test whether `make` thinks everything is up to date using `make -q build`. Actually, that doesn't seem to work. For a while now, sagetex has been the last spkg to install (because it is the only one which depends on `$(SAGERUNTIME)` in spkg/standard/deps), so you could look for spkg/installed/sagetex-...  By the way, `grep -r` is not portable, so maybe this:

```sh
if [ ! -f "$SAGE_PACKAGES"/standard/.from_bdist ] && ! ls "$SAGE_PACKAGES"/installed | grep sagetex- > /dev/null ; then ...
```

You would need to first check whether spkg/installed exists.



---

archive/issue_comments_164143.json:
```json
{
    "body": "The problem is that currently the sage library SPKG tries to run the main sage executable while installing the sage library, which is fundamentally at odds with the goal of making the main sage executable refuse to run until sage is fully installed. One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.",
    "created_at": "2012-10-03T23:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164143",
    "user": "@kini"
}
```

The problem is that currently the sage library SPKG tries to run the main sage executable while installing the sage library, which is fundamentally at odds with the goal of making the main sage executable refuse to run until sage is fully installed. One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.



---

archive/issue_comments_164144.json:
```json
{
    "body": "Replying to [comment:10 kini]:\n> One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.\n\nIs it just the spkg-install script which needs changing? That makes sense to me anyway, since the sage spkg depends on the scripts spkg, but does not depend (explicitly, anyway) on the root spkg.",
    "created_at": "2012-10-04T01:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164144",
    "user": "@jhpalmieri"
}
```

Replying to [comment:10 kini]:
> One could patch the spkg-install script to run scripts in `$SAGE_LOCAL/bin` directly instead of trying to go through the sage command line interface.

Is it just the spkg-install script which needs changing? That makes sense to me anyway, since the sage spkg depends on the scripts spkg, but does not depend (explicitly, anyway) on the root spkg.



---

archive/issue_comments_164145.json:
```json
{
    "body": "As far as I know. On the other hand, I guess Jeroen won't like adding restrictions on when the main Sage executable can be run, because of `sage --sh` and stuff like that. Maybe I'll just stick to checking whether the tarball is totally pristine, and let the executable run if sage has been even partially compiled.",
    "created_at": "2012-10-04T21:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164145",
    "user": "@kini"
}
```

As far as I know. On the other hand, I guess Jeroen won't like adding restrictions on when the main Sage executable can be run, because of `sage --sh` and stuff like that. Maybe I'll just stick to checking whether the tarball is totally pristine, and let the executable run if sage has been even partially compiled.



---

archive/issue_comments_164146.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-04T22:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164146",
    "user": "@kini"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_164147.json:
```json
{
    "body": "I'm marking this as needs_review - testing the build right now but it seems like it should work.",
    "created_at": "2012-10-04T22:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164147",
    "user": "@kini"
}
```

I'm marking this as needs_review - testing the build right now but it seems like it should work.



---

archive/issue_comments_164148.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-10-05T09:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164148",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_164149.json:
```json
{
    "body": "The following should work without building Sage:\n\n```\njdemeyer@arcanis:/usr/local/src/sage-5.4.beta1$ ./sage --sh\n************************************************************************\nIt seems that you are attempting to run Sage from an unpacked source\ntarball, but you have not compiled it yet. Please run `make` in the Sage\nroot directory first. Read README.txt for more information.\n************************************************************************\n```\n\n\nI propose to move the check inside the `sage_setup` function in `spkg/bin/sage` (remember to apply #13459 first!)",
    "created_at": "2012-10-05T09:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164149",
    "user": "@jdemeyer"
}
```

The following should work without building Sage:

```
jdemeyer@arcanis:/usr/local/src/sage-5.4.beta1$ ./sage --sh
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet. Please run `make` in the Sage
root directory first. Read README.txt for more information.
************************************************************************
```


I propose to move the check inside the `sage_setup` function in `spkg/bin/sage` (remember to apply #13459 first!)



---

archive/issue_comments_164150.json:
```json
{
    "body": "Instead of checking the `local` directory, how about checking the existence of\n\n```\n$SAGE_LOCAL/lib/libcsage.so\n```\n\nwhich means that Sage actually has been built.",
    "created_at": "2012-10-05T09:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164150",
    "user": "@jdemeyer"
}
```

Instead of checking the `local` directory, how about checking the existence of

```
$SAGE_LOCAL/lib/libcsage.so
```

which means that Sage actually has been built.



---

archive/issue_comments_164151.json:
```json
{
    "body": "Forgot to upload the updated patch. I compiled 5.4rc4 with [attachment:trac_13561-unbuilt-sage-error-message.2.patch this one], and it seems to work fine.",
    "created_at": "2012-11-12T09:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164151",
    "user": "@ppurka"
}
```

Forgot to upload the updated patch. I compiled 5.4rc4 with [attachment:trac_13561-unbuilt-sage-error-message.2.patch this one], and it seems to work fine.



---

archive/issue_comments_164152.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-11-12T09:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164152",
    "user": "@ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164153.json:
```json
{
    "body": "Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.",
    "created_at": "2012-11-12T09:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164153",
    "user": "@jdemeyer"
}
```

Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.



---

archive/issue_comments_164154.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.\nWhy so? Do you expect the file type to change between different versions of Sage?",
    "created_at": "2012-11-12T09:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164154",
    "user": "@ppurka"
}
```

Replying to [comment:17 jdemeyer]:
> Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.
Why so? Do you expect the file type to change between different versions of Sage?



---

archive/issue_comments_164155.json:
```json
{
    "body": "Replying to [comment:18 ppurka]:\n> Replying to [comment:17 jdemeyer]:\n> > Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.\n> Why so? Do you expect the file type to change between different versions of Sage?\nI don't *expect* it to change, but it seems strange to **require** that `libcsage.so` is a symbolic link. Also, the `-L` test will succeed if it is a broken symbolic link.",
    "created_at": "2012-11-12T09:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164155",
    "user": "@jdemeyer"
}
```

Replying to [comment:18 ppurka]:
> Replying to [comment:17 jdemeyer]:
> > Why are you checking for a symbolic link, we should not rely on that. You should replace `-L` by `-f`.
> Why so? Do you expect the file type to change between different versions of Sage?
I don't *expect* it to change, but it seems strange to **require** that `libcsage.so` is a symbolic link. Also, the `-L` test will succeed if it is a broken symbolic link.



---

archive/issue_comments_164156.json:
```json
{
    "body": "Ok. Updated the patch.",
    "created_at": "2012-11-12T09:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164156",
    "user": "@ppurka"
}
```

Ok. Updated the patch.



---

archive/issue_comments_164157.json:
```json
{
    "body": "I did not realize that relying on the `.so` extension is not portable (OS X uses `.dylib`).  New patch which uses `local/lib/python/site-packages/sage` instead, also with a slightly extended error message.",
    "created_at": "2013-01-14T09:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164157",
    "user": "@jdemeyer"
}
```

I did not realize that relying on the `.so` extension is not portable (OS X uses `.dylib`).  New patch which uses `local/lib/python/site-packages/sage` instead, also with a slightly extended error message.



---

archive/issue_comments_164158.json:
```json
{
    "body": "Attachment [trac_13561-unbuilt-sage-error-message.patch](tarball://root/attachments/some-uuid/ticket13561/trac_13561-unbuilt-sage-error-message.patch) by @ppurka created at 2013-01-14 11:24:00\n\n`-d .../sage` doesn't work because it is a symbolic link and not a directory. The other option is to try `-f .../sage`.\n\nWhy don't we instead try something like this? It will check if sage can be imported:\n\n```sh\n    python -c 'import sage' > /dev/null 2>&1\n    if [ $? -ne 0 ]; then\n        echo \"sage not built blah blah\"\n        exit 1\n    fi\n```\n\nI did some tests with this and with checking directory and I don't see much of a difference in the time taken. I ran\n\n```\necho 3 > /proc/sys/vm/drop_caches\n```\n\nbefore every call to the `sage -c` command.\n\nJust the default time taken by a simple command (cold starts, i.e. caches were dropped before every command).\n\n```\n~ [1] \u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.42s user 0.64s system 12% cpu 16.334 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.47s user 0.62s system 9% cpu 22.283 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.49s user 0.65s system 11% cpu 18.610 total\n```\n\n\n\nThe same command after removing the `site-packages/sage` symbolic link, and with the check for `python -c 'import sage'` as written above. \"aaaa..\" was the echo command (cold starts, i.e. caches were dropped before every command).\n\n```\n~\u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.09s user 0.04s system 7% cpu 1.605 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.06s user 0.05s system 8% cpu 1.237 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.07s user 0.05s system 2% cpu 5.046 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.06s user 0.04s system 9% cpu 1.159 total\n```\n\n\nThe same command but with the check `-d $SAGE_LOCAL/lib/python/site-packages/sage` (cold starts, i.e. caches were dropped before every command):\n\n```\n~\u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.04s user 0.04s system 4% cpu 1.703 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.04s user 0.05s system 6% cpu 1.244 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.05s user 0.03s system 7% cpu 1.093 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.04s user 0.04s system 1% cpu 4.329 total\n~ [1] \u00bb time sage -c 'print \"\"'\naaaaaaaaaaaaaaaaaaaaa\nsage -c 'print \"\"'  0.04s user 0.04s system 6% cpu 1.212 total\n```\n\n\nMaybe there is a very slight slowdown, of the order of 100ms on using the python command (on a cold start), but it is about 10-20ms on a warm start. Compare this with an unpatched sage file.\n\nUnpatched sage file (warm starts, no caches were dropped):\n\n```\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.17s user 0.32s system 96% cpu 1.546 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.23s user 0.30s system 99% cpu 1.543 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.27s user 0.29s system 98% cpu 1.579 total\n```\n\n\nPatched sage file with `python -c 'import sage'` (warm starts, no caches were dropped):\n\n```\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.29s user 0.22s system 96% cpu 1.558 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.28s user 0.28s system 99% cpu 1.564 total\n~\u00bb time sage -c 'print \"\"'\n\nsage -c 'print \"\"'  1.20s user 0.35s system 98% cpu 1.563 total\n```\n",
    "created_at": "2013-01-14T11:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164158",
    "user": "@ppurka"
}
```

Attachment [trac_13561-unbuilt-sage-error-message.patch](tarball://root/attachments/some-uuid/ticket13561/trac_13561-unbuilt-sage-error-message.patch) by @ppurka created at 2013-01-14 11:24:00

`-d .../sage` doesn't work because it is a symbolic link and not a directory. The other option is to try `-f .../sage`.

Why don't we instead try something like this? It will check if sage can be imported:

```sh
    python -c 'import sage' > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "sage not built blah blah"
        exit 1
    fi
```

I did some tests with this and with checking directory and I don't see much of a difference in the time taken. I ran

```
echo 3 > /proc/sys/vm/drop_caches
```

before every call to the `sage -c` command.

Just the default time taken by a simple command (cold starts, i.e. caches were dropped before every command).

```
~ [1] » time sage -c 'print ""'

sage -c 'print ""'  1.42s user 0.64s system 12% cpu 16.334 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.47s user 0.62s system 9% cpu 22.283 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.49s user 0.65s system 11% cpu 18.610 total
```



The same command after removing the `site-packages/sage` symbolic link, and with the check for `python -c 'import sage'` as written above. "aaaa.." was the echo command (cold starts, i.e. caches were dropped before every command).

```
~» time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.09s user 0.04s system 7% cpu 1.605 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.06s user 0.05s system 8% cpu 1.237 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.07s user 0.05s system 2% cpu 5.046 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.06s user 0.04s system 9% cpu 1.159 total
```


The same command but with the check `-d $SAGE_LOCAL/lib/python/site-packages/sage` (cold starts, i.e. caches were dropped before every command):

```
~» time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 4% cpu 1.703 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.05s system 6% cpu 1.244 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.05s user 0.03s system 7% cpu 1.093 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 1% cpu 4.329 total
~ [1] » time sage -c 'print ""'
aaaaaaaaaaaaaaaaaaaaa
sage -c 'print ""'  0.04s user 0.04s system 6% cpu 1.212 total
```


Maybe there is a very slight slowdown, of the order of 100ms on using the python command (on a cold start), but it is about 10-20ms on a warm start. Compare this with an unpatched sage file.

Unpatched sage file (warm starts, no caches were dropped):

```
~» time sage -c 'print ""'

sage -c 'print ""'  1.17s user 0.32s system 96% cpu 1.546 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.23s user 0.30s system 99% cpu 1.543 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.27s user 0.29s system 98% cpu 1.579 total
```


Patched sage file with `python -c 'import sage'` (warm starts, no caches were dropped):

```
~» time sage -c 'print ""'

sage -c 'print ""'  1.29s user 0.22s system 96% cpu 1.558 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.28s user 0.28s system 99% cpu 1.564 total
~» time sage -c 'print ""'

sage -c 'print ""'  1.20s user 0.35s system 98% cpu 1.563 total
```




---

archive/issue_comments_164159.json:
```json
{
    "body": "Replying to [comment:22 ppurka]:\n> `-d .../sage` doesn't work because it is a symbolic link and not a directory.\nAre you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).\n\nIt if really doesn't work for you: what is your version of Sage and of `bash`?\n\nAnd what is the output of\n\n```\nls -ld \"$SAGE_LOCAL/lib/python/site-packages/sage\"\nls -ld \"$SAGE_LOCAL/lib/python/site-packages/sage/../../../../devel/sage/build/sage\"\n```\n",
    "created_at": "2013-01-14T11:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164159",
    "user": "@jdemeyer"
}
```

Replying to [comment:22 ppurka]:
> `-d .../sage` doesn't work because it is a symbolic link and not a directory.
Are you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).

It if really doesn't work for you: what is your version of Sage and of `bash`?

And what is the output of

```
ls -ld "$SAGE_LOCAL/lib/python/site-packages/sage"
ls -ld "$SAGE_LOCAL/lib/python/site-packages/sage/../../../../devel/sage/build/sage"
```




---

archive/issue_comments_164160.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> Replying to [comment:22 ppurka]:\n> > `-d .../sage` doesn't work because it is a symbolic link and not a directory.\n> Are you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).\n\nWhoops, sorry. I got confused with all the testing. It does work.",
    "created_at": "2013-01-14T11:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164160",
    "user": "@ppurka"
}
```

Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 ppurka]:
> > `-d .../sage` doesn't work because it is a symbolic link and not a directory.
> Are you sure it doesn't work?  Being a symbolic link and being a directory are not mutually exclusive (a symbolic link to a directory is both a symbolic link and a directory).

Whoops, sorry. I got confused with all the testing. It does work.



---

archive/issue_comments_164161.json:
```json
{
    "body": "So could you formally review my patch then?",
    "created_at": "2013-01-14T14:58:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164161",
    "user": "@jdemeyer"
}
```

So could you formally review my patch then?



---

archive/issue_comments_164162.json:
```json
{
    "body": "Yes, sorry. The patch is ok.",
    "created_at": "2013-01-14T15:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164162",
    "user": "@ppurka"
}
```

Yes, sorry. The patch is ok.



---

archive/issue_comments_164163.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-14T15:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164163",
    "user": "@ppurka"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164164.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-18T07:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13357#issuecomment-164164",
    "user": "@jdemeyer"
}
```

Resolution: fixed
