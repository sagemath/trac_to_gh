# Issue 33468: "make doc-clean" should remove inventory, doctrees

archive/issues_033468.json:
```json
{
    "body": "CC:  @jhpalmieri @kwankyu\n\nFollowup to #29310, #33104\n\nWe could consider to extend `make doc-clean` so that it also removes `inventory`, `doctrees`.\nThis should suffice to resolve incremental docbuild problems. \n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33705\n\n",
    "created_at": "2022-04-13T17:01:11Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "\"make doc-clean\" should remove inventory, doctrees",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33468",
    "user": "@mkoeppe"
}
```
CC:  @jhpalmieri @kwankyu

Followup to #29310, #33104

We could consider to extend `make doc-clean` so that it also removes `inventory`, `doctrees`.
This should suffice to resolve incremental docbuild problems. 


Issue created by migration from https://trac.sagemath.org/ticket/33705





---

archive/issue_comments_476399.json:
```json
{
    "body": "A related change that may be taken care of, if we follow the proposal on this ticket:\n\n```diff\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex d42b261b3d..75bfa250df 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -340,9 +340,9 @@ doc-html: sagemath_doc_html\n \n # 'doc-html-no-plot': build docs without building the graphics coming\n # from the '.. plot' directive, in case you want to save a few\n-# megabytes of disk space. 'doc-clean' is a prerequisite because the\n+# megabytes of disk space. 'doc-uninstall' is a prerequisite because the\n # presence of graphics is cached in src/doc/output.\n-doc-html-no-plot: doc-clean\n+doc-html-no-plot: doc-uninstall\n        +$(MAKE_REC) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-plot\" doc-html\n \n # Using mathjax is actually the only options, but we keep\n```\n",
    "created_at": "2022-04-14T22:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476399",
    "user": "@jhpalmieri"
}
```

A related change that may be taken care of, if we follow the proposal on this ticket:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index d42b261b3d..75bfa250df 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -340,9 +340,9 @@ doc-html: sagemath_doc_html
 
 # 'doc-html-no-plot': build docs without building the graphics coming
 # from the '.. plot' directive, in case you want to save a few
-# megabytes of disk space. 'doc-clean' is a prerequisite because the
+# megabytes of disk space. 'doc-uninstall' is a prerequisite because the
 # presence of graphics is cached in src/doc/output.
-doc-html-no-plot: doc-clean
+doc-html-no-plot: doc-uninstall
        +$(MAKE_REC) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-plot" doc-html
 
 # Using mathjax is actually the only options, but we keep
```




---

archive/issue_comments_476400.json:
```json
{
    "body": "For typical Sage packages, what is the difference between `make PKG-clean` and `make PKG-uninstall`?",
    "created_at": "2022-04-14T22:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476400",
    "user": "@jhpalmieri"
}
```

For typical Sage packages, what is the difference between `make PKG-clean` and `make PKG-uninstall`?



---

archive/issue_comments_476401.json:
```json
{
    "body": "For normal Sage packages, `make PKG-clean` really uninstalls and should be renamed (with deprecation) to `make PKG-uninstall` (as discussed in #29097).\n\nThere's not really much to clean because the build tree for a package is ephemeral - unless `sage -i -s` was used or a build error occurred. So I suppose at some point in the future we could have `make PKG-clean` remove the build directories for the package in `SAGE_LOCAL/var/tmp/sage/build/`.",
    "created_at": "2022-04-14T23:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476401",
    "user": "@mkoeppe"
}
```

For normal Sage packages, `make PKG-clean` really uninstalls and should be renamed (with deprecation) to `make PKG-uninstall` (as discussed in #29097).

There's not really much to clean because the build tree for a package is ephemeral - unless `sage -i -s` was used or a build error occurred. So I suppose at some point in the future we could have `make PKG-clean` remove the build directories for the package in `SAGE_LOCAL/var/tmp/sage/build/`.



---

archive/issue_comments_476402.json:
```json
{
    "body": "We can do this:\n\n```diff\ndiff --git a/src/doc/Makefile b/src/doc/Makefile\nindex 62fb1cafd18..9bf9a1686dc 100644\n--- a/src/doc/Makefile\n+++ b/src/doc/Makefile\n@@ -16,6 +16,8 @@ clean:\n        rm -rf en/reference/*/sage\n        rm -rf en/reference/sage\n        rm -f common/*.pyc\n+       rm -rf ../../local/share/doc/sage/inventory\n+       rm -rf ../../local/share/doc/sage/doctrees\n \n # Sources generated at build time. (For sources generated at bootstrap time, see bootstrap.)\n doc-src:\n```\n\nI'm not sure how to do this more cleanly without moving the `doc-clean` target into `build/make/Makefile.in`, in which case `./configure` probably gets run when you run `make doc-clean`. The problem is that no helpful environment variables are defined in the top-level `Makefile`.",
    "created_at": "2022-06-16T22:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476402",
    "user": "@jhpalmieri"
}
```

We can do this:

```diff
diff --git a/src/doc/Makefile b/src/doc/Makefile
index 62fb1cafd18..9bf9a1686dc 100644
--- a/src/doc/Makefile
+++ b/src/doc/Makefile
@@ -16,6 +16,8 @@ clean:
        rm -rf en/reference/*/sage
        rm -rf en/reference/sage
        rm -f common/*.pyc
+       rm -rf ../../local/share/doc/sage/inventory
+       rm -rf ../../local/share/doc/sage/doctrees
 
 # Sources generated at build time. (For sources generated at bootstrap time, see bootstrap.)
 doc-src:
```

I'm not sure how to do this more cleanly without moving the `doc-clean` target into `build/make/Makefile.in`, in which case `./configure` probably gets run when you run `make doc-clean`. The problem is that no helpful environment variables are defined in the top-level `Makefile`.



---

archive/issue_comments_476403.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-22T20:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476403",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_476404.json:
```json
{
    "body": "Ready for review.\n\nI don't think we need the change from comment:1, but it does raise a question: if I run `make doc-html-no-plot`, I get an error:\n\n```\nmake[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.\n```\n\nDo `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?\n----\nNew commits:",
    "created_at": "2022-07-22T20:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476404",
    "user": "@jhpalmieri"
}
```

Ready for review.

I don't think we need the change from comment:1, but it does raise a question: if I run `make doc-html-no-plot`, I get an error:

```
make[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.
```

Do `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?
----
New commits:



---

archive/issue_comments_476405.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-22T20:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476405",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_476406.json:
```json
{
    "body": "(Ignore the first bunch of commits. I think this should just be based on `develop`, so that's what I've now done.)",
    "created_at": "2022-07-22T20:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476406",
    "user": "@jhpalmieri"
}
```

(Ignore the first bunch of commits. I think this should just be based on `develop`, so that's what I've now done.)



---

archive/issue_comments_476407.json:
```json
{
    "body": "Oh, OK",
    "created_at": "2022-07-22T21:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476407",
    "user": "@mkoeppe"
}
```

Oh, OK



---

archive/issue_comments_476408.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> if I run `make doc-html-no-plot`, I get an error:\n> {{{\n> make[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.\n> }}}\n> Do `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?\n\nYou can use `(cd $(SAGE_ROOT) && $(MAKE) ....)`",
    "created_at": "2022-07-22T21:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476408",
    "user": "@mkoeppe"
}
```

Replying to [comment:7 jhpalmieri]:
> if I run `make doc-html-no-plot`, I get an error:
> {{{
> make[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.
> }}}
> Do `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?

You can use `(cd $(SAGE_ROOT) && $(MAKE) ....)`



---

archive/issue_comments_476409.json:
```json
{
    "body": "Also, `SAGE_LOCAL` is not set in the top-level Makefile.",
    "created_at": "2022-07-22T21:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476409",
    "user": "@mkoeppe"
}
```

Also, `SAGE_LOCAL` is not set in the top-level Makefile.



---

archive/issue_comments_476410.json:
```json
{
    "body": "Why is `$$SAGE_LOCAL` used in the `clean` target? Should we make this change?\n\n```diff\ndiff --git a/Makefile b/Makefile\nindex 88107dbb37..e4d36a0308 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -98,13 +98,14 @@ pypi-sdists: sage_setup\n \n SAGE_ROOT = $(CURDIR)\n SAGE_SRC = $(SAGE_ROOT)/src\n+SAGE_LOCAL = $(SAGE_ROOT)/local\n \n clean:\n        @echo \"Deleting package build directories...\"\n        if [ -f \"$(SAGE_SRC)\"/bin/sage-env-config ]; then \\\n            . \"$(SAGE_SRC)\"/bin/sage-env-config; \\\n-           if [ -n \"$$SAGE_LOCAL\" ]; then \\\n-               rm -rf \"$$SAGE_LOCAL/var/tmp/sage/build\"; \\\n+           if [ -n \"$(SAGE_LOCAL)\" ]; then \\\n+               rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"; \\\n            fi; \\\n        fi\n \n```\n",
    "created_at": "2022-07-22T21:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476410",
    "user": "@jhpalmieri"
}
```

Why is `$$SAGE_LOCAL` used in the `clean` target? Should we make this change?

```diff
diff --git a/Makefile b/Makefile
index 88107dbb37..e4d36a0308 100644
--- a/Makefile
+++ b/Makefile
@@ -98,13 +98,14 @@ pypi-sdists: sage_setup
 
 SAGE_ROOT = $(CURDIR)
 SAGE_SRC = $(SAGE_ROOT)/src
+SAGE_LOCAL = $(SAGE_ROOT)/local
 
 clean:
        @echo "Deleting package build directories..."
        if [ -f "$(SAGE_SRC)"/bin/sage-env-config ]; then \
            . "$(SAGE_SRC)"/bin/sage-env-config; \
-           if [ -n "$$SAGE_LOCAL" ]; then \
-               rm -rf "$$SAGE_LOCAL/var/tmp/sage/build"; \
+           if [ -n "$(SAGE_LOCAL)" ]; then \
+               rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
            fi; \
        fi
 
```




---

archive/issue_comments_476411.json:
```json
{
    "body": "`SAGE_LOCAL` is set by `sage-env-config` and is not known to `make`. \nSo one needs to do the substitution in the shell",
    "created_at": "2022-07-22T21:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476411",
    "user": "@mkoeppe"
}
```

`SAGE_LOCAL` is set by `sage-env-config` and is not known to `make`. 
So one needs to do the substitution in the shell



---

archive/issue_comments_476412.json:
```json
{
    "body": "Okay, for the purposes of `make doc-clean`, would it be appropriate to set `SAGE_LOCAL` to be `$(SAGE_ROOT)/local`?",
    "created_at": "2022-07-22T21:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476412",
    "user": "@jhpalmieri"
}
```

Okay, for the purposes of `make doc-clean`, would it be appropriate to set `SAGE_LOCAL` to be `$(SAGE_ROOT)/local`?



---

archive/issue_comments_476413.json:
```json
{
    "body": "I think `doc-clean` should use the same method as `clean`: Obtain the correct SAGE_LOCAL via sage-env-config",
    "created_at": "2022-07-22T21:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476413",
    "user": "@mkoeppe"
}
```

I think `doc-clean` should use the same method as `clean`: Obtain the correct SAGE_LOCAL via sage-env-config



---

archive/issue_comments_476414.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-22T21:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476414",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_476415.json:
```json
{
    "body": "Okay, let's try this. This also fixes the bug with `make doc-html-no-plot`.",
    "created_at": "2022-07-22T21:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476415",
    "user": "@jhpalmieri"
}
```

Okay, let's try this. This also fixes the bug with `make doc-html-no-plot`.



---

archive/issue_comments_476416.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-22T21:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476416",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_476417.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-22T22:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476417",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_476418.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-07-23T03:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476418",
    "user": "@jhpalmieri"
}
```

Thank you!



---

archive/issue_comments_476419.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-28T19:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33468",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33468#issuecomment-476419",
    "user": "@vbraun"
}
```

Resolution: fixed
