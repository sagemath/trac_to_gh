# Issue 33468: "make doc-clean" should remove inventory, doctrees

Issue created by migration from https://trac.sagemath.org/ticket/33705

Original creator: mkoeppe

Original creation time: 2022-04-13 17:01:11

CC:  jhpalmieri klee

Followup to #29310, #33104

We could consider to extend `make doc-clean` so that it also removes `inventory`, `doctrees`.
This should suffice to resolve incremental docbuild problems. 



---

Comment by jhpalmieri created at 2022-04-14 22:42:16

A related change that may be taken care of, if we follow the proposal on this ticket:

```diff
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index d42b261b3d..75bfa250df 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -340,9 +340,9 @@ doc-html: sagemath_doc_html
 
 # 'doc-html-no-plot': build docs without building the graphics coming
 # from the '.. plot' directive, in case you want to save a few
-# megabytes of disk space. 'doc-clean' is a prerequisite because the
+# megabytes of disk space. 'doc-uninstall' is a prerequisite because the
 # presence of graphics is cached in src/doc/output.
-doc-html-no-plot: doc-clean
+doc-html-no-plot: doc-uninstall
        +$(MAKE_REC) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-plot" doc-html
 
 # Using mathjax is actually the only options, but we keep
```



---

Comment by jhpalmieri created at 2022-04-14 22:44:20

For typical Sage packages, what is the difference between `make PKG-clean` and `make PKG-uninstall`?


---

Comment by mkoeppe created at 2022-04-14 23:01:44

For normal Sage packages, `make PKG-clean` really uninstalls and should be renamed (with deprecation) to `make PKG-uninstall` (as discussed in #29097).

There's not really much to clean because the build tree for a package is ephemeral - unless `sage -i -s` was used or a build error occurred. So I suppose at some point in the future we could have `make PKG-clean` remove the build directories for the package in `SAGE_LOCAL/var/tmp/sage/build/`.


---

Comment by jhpalmieri created at 2022-06-16 22:14:17

We can do this:

```diff
diff --git a/src/doc/Makefile b/src/doc/Makefile
index 62fb1cafd18..9bf9a1686dc 100644
--- a/src/doc/Makefile
+++ b/src/doc/Makefile
@@ -16,6 +16,8 @@ clean:
        rm -rf en/reference/*/sage
        rm -rf en/reference/sage
        rm -f common/*.pyc
+       rm -rf ../../local/share/doc/sage/inventory
+       rm -rf ../../local/share/doc/sage/doctrees
 
 # Sources generated at build time. (For sources generated at bootstrap time, see bootstrap.)
 doc-src:
```

I'm not sure how to do this more cleanly without moving the `doc-clean` target into `build/make/Makefile.in`, in which case `./configure` probably gets run when you run `make doc-clean`. The problem is that no helpful environment variables are defined in the top-level `Makefile`.


---

Comment by jhpalmieri created at 2022-07-22 20:52:21

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-07-22 20:52:21

Ready for review.

I don't think we need the change from comment:1, but it does raise a question: if I run `make doc-html-no-plot`, I get an error:

```
make[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.
```

Do `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?
----
New commits:


---

Comment by git created at 2022-07-22 20:54:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-07-22 20:55:42

(Ignore the first bunch of commits. I think this should just be based on `develop`, so that's what I've now done.)


---

Comment by mkoeppe created at 2022-07-22 21:10:06

Oh, OK


---

Comment by mkoeppe created at 2022-07-22 21:11:19

Replying to [comment:7 jhpalmieri]:
> if I run `make doc-html-no-plot`, I get an error:
> {{{
> make[1]: *** No rule to make target `doc-clean', needed by `doc-html-no-plot'.  Stop.
> }}}
> Do `make` targets (like `doc-clean`) from the top-level `Makefile` need to reproduced in `build/make/Makefile.in` if we want to refer to them?

You can use `(cd $(SAGE_ROOT) && $(MAKE) ....)`


---

Comment by mkoeppe created at 2022-07-22 21:14:35

Also, `SAGE_LOCAL` is not set in the top-level Makefile.


---

Comment by jhpalmieri created at 2022-07-22 21:21:22

Why is `$$SAGE_LOCAL` used in the `clean` target? Should we make this change?

```diff
diff --git a/Makefile b/Makefile
index 88107dbb37..e4d36a0308 100644
--- a/Makefile
+++ b/Makefile
@@ -98,13 +98,14 @@ pypi-sdists: sage_setup
 
 SAGE_ROOT = $(CURDIR)
 SAGE_SRC = $(SAGE_ROOT)/src
+SAGE_LOCAL = $(SAGE_ROOT)/local
 
 clean:
        @echo "Deleting package build directories..."
        if [ -f "$(SAGE_SRC)"/bin/sage-env-config ]; then \
            . "$(SAGE_SRC)"/bin/sage-env-config; \
-           if [ -n "$$SAGE_LOCAL" ]; then \
-               rm -rf "$$SAGE_LOCAL/var/tmp/sage/build"; \
+           if [ -n "$(SAGE_LOCAL)" ]; then \
+               rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
            fi; \
        fi
 
```



---

Comment by mkoeppe created at 2022-07-22 21:24:53

`SAGE_LOCAL` is set by `sage-env-config` and is not known to `make`. 
So one needs to do the substitution in the shell


---

Comment by jhpalmieri created at 2022-07-22 21:29:00

Okay, for the purposes of `make doc-clean`, would it be appropriate to set `SAGE_LOCAL` to be `$(SAGE_ROOT)/local`?


---

Comment by mkoeppe created at 2022-07-22 21:29:48

I think `doc-clean` should use the same method as `clean`: Obtain the correct SAGE_LOCAL via sage-env-config


---

Comment by git created at 2022-07-22 21:47:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-07-22 21:48:29

Okay, let's try this. This also fixes the bug with `make doc-html-no-plot`.


---

Comment by git created at 2022-07-22 21:49:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-07-22 22:22:45

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-07-23 03:06:35

Thank you!


---

Comment by vbraun created at 2022-07-28 19:10:18

Resolution: fixed
