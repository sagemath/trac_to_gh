# Issue 22333: Various fixes to (lib)GAP workspaces

Issue created by migration from https://trac.sagemath.org/ticket/22570

Original creator: jdemeyer

Original creation time: 2017-03-10 13:46:48

CC:  dimpase vbraun

1. Factor out some common code for creating GAP and libGAP workspaces.

2. Ensure that workspaces are written without race conditions (possible fix for #22536)

3. Consider a workspace up-to-date if its timestamp equals the minimal timestamp (possible fix for #20421)


---

Comment by jdemeyer created at 2017-03-10 15:18:31

New commits:


---

Comment by jdemeyer created at 2017-03-10 15:18:31

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-03-10 15:36:07

How do you handle a (not very likely) scenario of two processes trying to `SaveWorkspace`?


---

Comment by jdemeyer created at 2017-03-10 15:44:31

Replying to [comment:3 dimpase]:
> How do you handle a (not very likely) scenario of two processes trying to `SaveWorkspace`?

I use `atomic_write()` to write the workspaces. Therefore, there should be no race conditions (as long as the workspaces are written from Sage: direct calls from GAP can still do anything).


---

Comment by dimpase created at 2017-03-11 09:31:56

By the way, one more reason for this ticket is that (now removed) `sage -c "gap_reset_workspace()"`
in `spkg-install` of `database_gap` sometimes hanged the installation if kept there, whereas without this call one might have to run `sage -c "gap_reset_workspace()"` separately, as recently witnessed on #22576.


---

Comment by dimpase created at 2017-03-11 09:34:40

As your branch does not reintroduce `sage -c "gap_reset_workspace()"` in  `build/pkgs/database_gap/spkg-install`, I wonder whether the problem mentioned in the previous comment would persist. (Or you really better put it back in?)


---

Comment by jdemeyer created at 2017-03-11 12:52:32

It's not the job of a package install script to do something with _user_ files such as the GAP workspaces. In a multi-user installation, this should be done for every user and `spkg-install` cannot do that.


---

Comment by jdemeyer created at 2017-03-11 13:01:48

Replying to [comment:5 dimpase]:
> one might have to run `sage -c "gap_reset_workspace()"` separately, as recently witnessed on #22576.

I see that as an independent issue. Let's deal with that either on #22576 or on a new ticket.


---

Comment by git created at 2017-03-11 14:24:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-14 22:49:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2017-03-14 23:40:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-15 19:05:32

Resolution: fixed
