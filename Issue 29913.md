# Issue 29913: Upgrade cmake to 3.17.3

Issue created by migration from https://trac.sagemath.org/ticket/30150

Original creator: mkoeppe

Original creation time: 2020-07-15 16:47:54

CC:  novoselt fbissey vdelecroix mjo arojas isuruf

3.18.0 also came out today, but let's avoid .0 releases

https://cmake.org/cmake/help/v3.17/release/3.17.html


---

Comment by mkoeppe created at 2020-07-15 17:48:14

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-15 17:48:14

New commits:


---

Comment by slabbe created at 2020-08-19 13:52:19

I would like to review this ticket. But I have few questions before.

I had in mind to test if I can build cryptominisat using that updated version of cmake. But, I am surprised to see that I have cryptominisat installed, but not cmake in my recent build of sage:


```
$ sage -version
SageMath version 9.2.beta9, Release Date: 2020-08-18
$ sage -optional
...
cmake...................................3.11.0 (not_installed)
coxeter3................................8ac9c71723c8ca5...
cryptominisat...........................5.6.8 (5.6.8)
...
```


But cmake is a dependency of cryptominisat:


```
$ cat build/pkgs/cryptominisat/dependencies 
$(PYTHON) m4ri zlib libpng | cmake sqlite boost_cropped

----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```


Is cmake really used/installed when I compile cryptominisat?

Is it because I wrote `--enable-cryptominisat` but not `--enable-cmake` in my `./configure`? I thought that `cmake` would be automatically enabled?


```
$ head config.log 
This file contains any messages produced by compilers while
running configure, to aid debugging if configure makes a mistake.

It was created by Sage configure 9.2.beta9, which was
generated by GNU Autoconf 2.69.  Invocation command line was

  $ ./configure --enable-experimental-packages --enable-download-from-upstream-url --enable-ccache --enable-dot2tex --enable-rst2ipynb --enable-openssl --enable-cbc --enable-cryptominisat --enable-pycosat --enable-glucose --enable-sage_numerical_backends_coin --enable-pynormaliz --enable-latte_int --enable-awali --enable-fricas

## --------- ##
## Platform. ##
```



---

Comment by mkoeppe created at 2020-08-19 15:51:25

Further down in config.log you can see whether it accepted system cmake. In this case, it does not build its own copy.


---

Comment by slelievre created at 2020-08-19 23:12:36

CMake 3.18.1 and CMake 3.17.4 were released.


---

Comment by slabbe created at 2020-08-20 07:10:47

You are right:

```
$ grep -C2 cmake config.log
...
## ------------------------------------------------------ ##
## Checking whether SageMath should install SPKG cmake... ##
## ------------------------------------------------------ ##
configure:15772: checking for cmake >= 3.4
configure:15849: result: /usr/bin/cmake
configure:15858: will use system package and not install SPKG cmake
...
```


Then how can I make sure that the cmake from Sage is used when compiling cryptominisat? 
Is `.configure --enable-cmake` enough?


---

Comment by slabbe created at 2020-08-20 07:48:16

I managed to install cmake 3.17.3 correctly. I tested that cryptominisat which depends on cmake installs correctly. The following part of the log of cryptominisat install confirms me that it used the version cmake 3.17.3 I just installed:


```
CMake Warning (dev) at /home/slabbe/GitBox/sage/local/share/cmake-3.17/Modules/FindPackageHandleStandardArgs.cmake:272 (message):
  The package name passed to `find_package_handle_standard_args` (VALGRIND)
  does not match the name of the calling package (Valgrind).  This can lead
  to problems in calling code that expects `find_package` result variables
  (e.g., `_FOUND`) to follow a certain pattern.
```


For me it is a positive review. I let Matthias change the status of this ticket to positive review  OR update the branch to 3.17.4 and keep it as needs review.


---

Comment by mkoeppe created at 2020-08-22 03:22:55

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-08-22 03:22:55

Let's go for 3.18.2 which seems to have an important fix for backward compatibility


---

Comment by git created at 2020-08-23 22:41:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-23 22:54:56

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2020-08-25 13:28:02

On Ubuntu 16.04 (yes I know, I update to 20.04 soon:), I confirm that cmake 3.18 builds ok. I also tested that cryptominisat and awali optional packages which depend on cmake build ok.


---

Comment by slabbe created at 2020-08-25 13:28:02

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-27 20:27:34

Thanks!


---

Comment by vbraun created at 2020-08-30 08:39:08

Resolution: fixed
