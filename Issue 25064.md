# Issue 25064: sparse_2term_quotient_only_pm1 gives different results depending on set iteration order

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-05-07 14:00:21

CC:  cremona was davidloeffler klui mderickx pbruin

This function in the `sage.modular.modsym.relation_matrix_pyx` takes a set as input, and gives different results depending on the iteration order of the set (which is arbitrary, and often different on Python 2 vs Python 3).

While this in itself is not at all a bug, but a feature of the algorithm, this has far reaching effect on the results of other computations, resulting in tests that fail on Python 3 since the set ordering is definitely not the same (but the same tests could just as easily fail on Python 2 in principle).

Not sure yet what the best approach is to this.


---

Comment by chapoton created at 2018-10-05 09:42:18

New commits:


---

Comment by git created at 2018-10-05 09:51:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-05 15:33:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-10-05 15:35:23

So the question is : 

should we just change the doctests or try to make them more robust ?

The opinion of some experts in modular symbols and Hecke operators is required..


---

Comment by git created at 2018-10-05 15:37:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-14 07:23:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-11-10 13:11:59

a branch making some doctests more robust was moved to #26673


---

Comment by chapoton created at 2018-12-20 18:01:37

----
New commits:


---

Comment by chapoton created at 2018-12-20 20:32:08

**PLEASE**, opinion from experts of modular symbols is required on the failing doctests!

Tell us if either

(1) the current change only modifies the bases of modular symbols and is harmless. We just need to change the doctests.

or

(2) at least some of the failing doctests are real failures, with bad and wrong answers


---

Comment by chapoton created at 2018-12-20 20:32:41

Changing status from new to needs_info.


---

Comment by cremona created at 2018-12-21 09:44:04

I'll look at it.   (http://homepages.warwick.ac.uk/staff/J.E.Cremona/theses/index.html should qualify me)


---

Comment by cremona created at 2018-12-21 15:38:37

I have started working through these, so far have done 3 out of 5 files in sage/modular and all are OK (i.e. the new output is equally valid).  It will take a while to do the rest and I may not get back to it before the middle of next week for obvious reasons.


---

Comment by cremona created at 2018-12-21 17:08:40

In several places the difference is that a different basis is being used for some vector space, so the matrices of Hecke operators look different.  One plan might be to tag the matrix display as #random but to include the characteristic polynomial in the output.  I am not currently doing this.


---

Comment by cremona created at 2018-12-21 17:59:07

I'm having trouble with the test in line 217 of modular/modform/modular added for #8018 in 2010, authored by R Beezer and reviewed by AlexGhitza.


---

Comment by chapoton created at 2018-12-30 15:11:29

Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.

In comment:15, you mean line 217 of `modular/modform/numerical`, right ?


---

Comment by cremona created at 2019-01-02 09:18:13

Replying to [comment:16 chapoton]:
> Concerning the idea of tagging with `# random`, this should not be necessary: instead one will change the doctests to their new values. The new values will hopefuly work in both python2 and python3 without problem. The only issue is to be sure that nothing got broken by all these changes of bases. This is exactly what you have started to do, thanks a lot.


OK 

> 
> In comment:15, you mean line 217 of `modular/modform/numerical`, right ?
> 

yes

I am getting back to this now.


---

Comment by git created at 2019-01-02 17:02:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2019-01-02 17:08:05

The latest commit fixes all but one doctest in sage/modular, the last one being the one I mentioned above in the numerical section.  It is hard to get a new example which works since the code finds a random linear combination of a few Tp for small p, which is different every time -- yet one needs to find one such which has eigenvalues quite close together.  I will come back to this.

I mostly just replaced the expected output with what the actual output now is, after doing some tests to check that the new output is reasonable.  In a few places I adapted the doctest to be just as useful but more canonical.  In one place I reworded a docstring (when the output of some modular symbol operation is not literally a monomial modular symbol but a linear combination of these).

I'm adding David Loeffler to the notification list since some of the files I touched are (I think) written and/or worked on by him.  Meanwhile I am looking to see if there are any failing doctests outside sage/modular.


---

Comment by cremona created at 2019-01-02 17:10:14

Changing status from needs_info to needs_review.


---

Comment by git created at 2019-01-03 10:01:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2019-01-03 10:02:04

There were 6 files outside sage/modular with doctests which needed changing: done.

That just leaves the numerical one which I will look at again now.


---

Comment by git created at 2019-01-03 10:27:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2019-01-03 10:29:14

OK all done.

I put myself down as a reviewer but we need further review: I only tested with default python, and also it would be good for another pair of eyes to look at all the doctests I changed.


---

Comment by chapoton created at 2019-01-03 10:45:49

Thanks John for your hard work on this ticket, which is of major importance in our progress towards python3.


---

Comment by chapoton created at 2019-01-03 13:46:43

Good, the bot is fully green.


---

Comment by chapoton created at 2019-01-07 13:39:10

And this fixes all doctests in 14 files in python3.

So I am extremely tempted to give it a positive review...


---

Comment by embray created at 2019-01-07 13:50:38


```diff
diff --git a/src/sage/modular/modsym/relation_matrix.py b/src/sage/modular/modsym/relation_matrix.py
index 5e968c3..8e92a7c 100644
--- a/src/sage/modular/modsym/relation_matrix.py
+++ b/src/sage/modular/modsym/relation_matrix.py
`@``@` -496,7 +496,7 `@``@` def relation_matrix_wtk_g0(syms, sign, field, sparse):
         # Let rels = rels union I relations.
         rels.update(modI_relations(syms, sign))
 
-    rels = list(rels)
+    rels = sorted(rels)
     # should be sorted(rels), but this breaks many doctests
 
     if syms._apply_S_only_0pm1() and is_RationalField(field):
```


There's a still a comment saying "should be sorted(rels)" when now it _is_ that.

+1 from me unless there's any good reason not to sort (is this a major performance regression anywhere?  We haven't really gotten anywhere with performance testing so who knows...)


---

Comment by git created at 2019-01-07 13:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-07 20:58:49

In my idea, this change should not impact the performance at all. We are just sorting a bunch of pairs of integers, no big deal.

`@`cremona: do you have some worries on this question of performance regression, John ? What would be a good test to run to make sure that no speed is lost ?


---

Comment by chapoton created at 2019-01-08 09:20:25

Before

```
sage: %timeit ModularSymbols(4691).basis()
1 loop, best of 3: 1.28 s per loop
```

After

```
sage: %timeit ModularSymbols(4691).basis()
1 loop, best of 3: 1.27 s per loop
```

So I do not see any significant difference here.


---

Comment by cremona created at 2019-01-08 09:45:08

Replying to [comment:31 chapoton]:
> Before
> {{{
> sage: %timeit ModularSymbols(4691).basis()
> 1 loop, best of 3: 1.28 s per loop
> }}}
> After
> {{{
> sage: %timeit ModularSymbols(4691).basis()
> 1 loop, best of 3: 1.27 s per loop
> }}}
> So I do not see any significant difference here.

That is just the sort of test I was going to suggest, but 4691 is prime and that is a very special case, so I suggest (as you have the new and old code up and running I think it is easier for you than for me right now) that you also try the following levels:  N with several prime factors (e.g. 2310), larger prime powers, and a combination of the above such as 1680.


---

Comment by chapoton created at 2019-01-08 10:08:32

before:

```
sage: %timeit ModularSymbols(2310).basis()
1 loop, best of 3: 6.53 s per loop
sage: %timeit ModularSymbols(1680).basis()
1 loop, best of 3: 2.06 s per loop
sage: %timeit ModularSymbols(5**5).basis()
1 loop, best of 3: 8.59 s per loop    (fluctuates between 8.59 and 8.65)
```

after:

```
sage: %timeit ModularSymbols(2310).basis()
1 loop, best of 3: 6.52 s per loop         (or 6.53)
sage: %timeit ModularSymbols(1680).basis()
1 loop, best of 3: 2.07 s per loop
sage: %timeit ModularSymbols(5**5).basis()
1 loop, best of 3: 8.68 s per loop    (fluctuates between 8.66 and 8.73)
```

So there is no meaningful difference in the first two cases, I think. The last one for `5**5` fluctuates more than the others, but seems to be consistently slightly slower.


---

Comment by embray created at 2019-01-08 13:44:46

Okay, thank you for checking.  I did not think it would likely make a significant difference, but I wasn't exactly sure how best to benchmark that.


---

Comment by embray created at 2019-01-08 13:44:46

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-15 18:16:10

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by vbraun created at 2019-01-20 00:10:24

On 32-bit:

```
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 75, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.ap(2)  # rel tol 2e-15
Expected:
    [3.0, -1.6180339887498947, 0.6180339887498968]
Got:
    [3.0, -1.6180339887498965, 0.6180339887498943]
Tolerance exceeded in 1 of 3:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 77, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.systems_of_eigenvalues(7)  # rel tol 2e-15
Expected:
    [
    [-1.6180339887498947, 2.2360679774997894, -3.2360679774997894],
    [0.6180339887498968, -2.236067977499788, 1.2360679774997936],
    [3.0, 4.0, 6.0]
    ]
Got:
    [
    [-1.6180339887498965, 2.2360679774997894, -3.236067977499793],
    [0.6180339887498943, -2.2360679774997894, 1.2360679774997887],
    [3.0, 4.0, 6.0]
    ]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15
**********************************************************************
File "src/sage/modular/modform/numerical.py", line 89, in sage.modular.modform.numerical.NumericalEigenforms
Failed example:
    n.eigenvalues([2,3,5])  # rel tol 2e-15
Expected:
    [[3.0, -1.6180339887498947, 0.6180339887498968],
     [4.0, 2.2360679774997894, -2.236067977499788],
     [6.0, -3.2360679774997894, 1.2360679774997936]]
Got:
    [[3.0, -1.6180339887498965, 0.6180339887498943],
     [4.0, 2.2360679774997894, -2.2360679774997894],
     [6.0, -3.236067977499793, 1.2360679774997887]]
Tolerance exceeded in 2 of 9:
    0.6180339887498968 vs 0.6180339887498943, tolerance 4e-15 > 2e-15
    1.2360679774997936 vs 1.2360679774997887, tolerance 4e-15 > 2e-15
**********************************************************************
1 item had failures:
   3 of   7 in sage.modular.modform.numerical.NumericalEigenforms
    [46 tests, 3 failures, 0.46 s]
```



---

Comment by vbraun created at 2019-01-20 00:10:24

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-01-20 10:17:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-20 10:17:50

I have lowered slightly the precision


---

Comment by chapoton created at 2019-01-20 10:17:50

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2019-01-20 10:59:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-24 18:18:04

Resolution: fixed
