# Issue 24747: py3: get rid of some filter in classical geometries

Issue created by migration from https://trac.sagemath.org/ticket/24984

Original creator: chapoton

Original creation time: 2018-03-15 09:18:12

CC:  dimpase




---

Comment by chapoton created at 2018-03-15 09:18:47

New commits:


---

Comment by chapoton created at 2018-03-15 09:18:47

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-03-15 09:37:06

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-03-15 09:37:06

This should also be fixed:

```
    if clique_partition:
        lines = map(lambda x: filter(lambda t: t[0]+x*t[1]==0, V),
                     filter(lambda z: z != 0, Fq))
        return (G, lines, v0)
```

Dima, could you please take care of that ?


---

Comment by jdemeyer created at 2018-03-15 11:41:36

Code like

```
        V = [x for x in libgap.Orbits(g, S, libgap.OnLines) if len(x) == nvert]
        assert len(V) == 1
        V = V[0]
```

can better be written as

```
        (V,) = [x for x in libgap.Orbits(g, S, libgap.OnLines) if len(x) == nvert]
```



---

Comment by git created at 2018-03-15 13:10:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-03-15 13:11:05

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-03-15 13:11:05

ok, done


---

Comment by jdemeyer created at 2018-03-15 13:48:31

positive review if tests pass


---

Comment by @dimpase created at 2018-03-15 14:05:24

Replying to [comment:3 jdemeyer]:
> Code like
> {{{
>         V = [x for x in libgap.Orbits(g, S, libgap.OnLines) if len(x) == nvert]
>         assert len(V) == 1
>         V = V[0]
> }}}
> can better be written as
> {{{
>         (V,) = [x for x in libgap.Orbits(g, S, libgap.OnLines) if len(x) == nvert]
> }}}

Sorry, how is this equivalent? The `assert` there means to be an extra guard against a SNAFU, and now it's gone.


---

Comment by chapoton created at 2018-03-15 14:07:19

the assignement will protest if the list has not the correct expected length, here 1

try

(a,) = (4,5)


---

Comment by @dimpase created at 2018-03-15 14:10:31

By the way, what's wrong with `filter()` in the 1st place?


---

Comment by chapoton created at 2018-03-15 14:12:08

problem in py3, filter is an iterator, and you cannot ask for V[0]


---

Comment by chapoton created at 2018-03-15 14:12:42

by the way, did you manage to get a python3-sage up and running ?


---

Comment by @dimpase created at 2018-03-15 14:21:35

Replying to [comment:10 chapoton]:
> problem in py3, filter is an iterator, and you cannot ask for V[0]

and where does one ask for V[0]?

I'd rather apply `list()` to an iterator; e.g. wouldn't this (from comment 2) work in python3?

```
    if clique_partition:
        lines = map(lambda x: filter(lambda t: t[0]+x*t[1]==0, V),
                     filter(lambda z: z != 0, Fq))
        return (G, list(lines), v0)
```


---------------

No, I'm not python3ised yet, sorry :-)


---

Comment by @dimpase created at 2018-03-15 14:23:11

Replying to [comment:8 chapoton]:
> the assignement will protest if the list has not the correct expected length, here 1
> 
> try
> 
> (a,) = (4,5)
> 
Right, this makes sense, thanks.


---

Comment by chapoton created at 2018-03-15 14:23:40

after the branch here, one does not longer ask for V[0]. Before, one did

In principle, vanilla-sage 8.2.b8 should build and start with python3. Instructions:
(in a separate clone of the git repo)

```
make configure
./configure --with-python=3
make build
```


Give it a try of you can.


---

Comment by @dimpase created at 2018-03-15 14:32:29

this does not look like a right change 

```
-        lines = map(lambda x: filter(lambda t: t[0]+x*t[1]==0, V),
-                     filter(lambda z: z != 0, Fq))
+        lines = [[t for t in V if t[0] + z * t[1] == 0]
+                 for z in Fq if z]
```

`x` from `V` is gone and replaced by `z` from `Fq` in `t[0]+x*t[1]==0`.

This is why I'd rather retain all the filters, you know...


---

Comment by chapoton created at 2018-03-15 14:34:11

well, I did a mistake, please correct it, and let us try to spend only a short time on the ticket, please..


---

Comment by @dimpase created at 2018-03-15 14:44:14

Would you mind if I try installing sage`@`py3 and provide a branch I don't have to wrap my poor brain around unnecessarily? 

Sorry, I am badly jetlagged and still somewhere between Japanese time an GMT...


---

Comment by chapoton created at 2018-03-15 14:45:49

This ticket has no urgency, and I like the branch as it is. Please take a rest, a nap, or a good night sleep. We will look at that later.

EDIT: I have double-checked my changes after `if clique_partition:`, and I think that they are correct.


---

Comment by @dimpase created at 2018-03-15 20:04:00

before working on this, we ought to remedy the root cause of most doctest failures there, namely the fact that libgap is broken. Indeed:

```
sage: libgap.GeneralUnitaryGroup(4, 2)
------------------------------------------------------------------
TypeError                        Traceback (most recent call last)
<ipython-input-1-26e9bcf1ef0f> in <module>()
----> 1 libgap.GeneralUnitaryGroup(Integer(4), Integer(2))

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__getattr__ (build/cythonized/sage/misc/lazy_import.c:3558)()

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.get_object (build/cythonized/sage/misc/lazy_import.c:2210)()

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2480)()

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in init sage.libs.gap.libgap()
    785 
    786 
--> 787 libgap = Gap()

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.__init__ (build/cythonized/sage/libs/gap/libgap.c:5511)()
    615             <class 'sage.libs.gap.libgap.Gap'>
    616         """
--> 617         initialize()
    618         libgap_set_gasman_callback(gasman_callback)
    619         from sage.rings.integer_ring import ZZ

/mnt/opt/Sage/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.initialize (build/cythonized/sage/libs/gap/util.c:4459)()

TypeError: expected bytes, str found
```


It's really baffling kind of errors message...

--------------

I was able to build sage`@`py3 capable of doctesting, following comment 14, with added #24343 and #24922.


---

Comment by chapoton created at 2018-03-15 20:06:51

Well, there are maybe thousands of issues remaining, some small and some big. Unicode problems are a large part of that. If we could fix the 3 tiny problems here quickly, I would prefer.

Bot is morally green.


---

Comment by @dimpase created at 2018-03-15 22:37:38

I believe we should first be able to test that these fixes actually work on py3, too, hence the dependence. Once libgap works, this should be a breeze to fix everything py3-related here.

Moreover I actually like the code using filters, as it is using iterators (on py3) rather than explicit lists, which might lead to various performance gains.
So I am not ready to just give it up, especially as trivial fixes like applying `list()` to an iterator are always possible and are much less intrusive.


---

Comment by chapoton created at 2018-03-16 06:40:39

I do not believe we should wait for any other ticket. _Please_ consider seriously the awful amount of remaining work to get sage fully py3-compatible, and accept to let it go. I promise I will not try to remove filter everywhere else.


---

Comment by dimpase created at 2018-03-16 07:48:24

I am sorry, but indiscriminate replacing of iterators with eager iterable data structures is code vandalism, as it potentially degrades performance, and does more harm than good.

Once the ability to properly test the code arrives, it becomes very easy.


---

Comment by jdemeyer created at 2018-03-16 13:57:17

I'll leave you to it.


---

Comment by git created at 2018-05-07 11:38:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-05-23 13:42:04

Replying to [comment:23 dimpase]:
> I am sorry, but indiscriminate replacing of iterators with eager iterable data structures is code vandalism, as it potentially degrades performance, and does more harm than good.

It's not "code vandalism".  Currently the changes Frédéric has made here is just replacing some code with the exact equivalent (on Python 2) code that also works on Python 3.  If you believe these algorithms can be improved by the use of iterators you're welcome to take a stab at it, but as currently written that is not the case.  I can certainly see a couple small opportunities here, but it is not a priority as there is no regression here--the higher priority right now is getting Python 3 working.


---

Comment by embray created at 2018-05-23 13:42:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-27 17:01:46

Resolution: fixed
