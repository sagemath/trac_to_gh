# Issue 22068: weak_dict.pyx is not python3 compatible

archive/issues_022068.json:
```json
{
    "body": "CC:  jdemeyer chapoton\n\nThe structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed\n\nIssue created by migration from https://trac.sagemath.org/ticket/22305\n\n",
    "created_at": "2017-02-05T11:16:35Z",
    "labels": [
        "python3",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "weak_dict.pyx is not python3 compatible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22068",
    "user": "aapitzsch"
}
```
CC:  jdemeyer chapoton

The structure of `PyDictObject` used by `weak_dict` changed from Python 2 to Python 3, e.g `PyDictEntry` has been removed

Issue created by migration from https://trac.sagemath.org/ticket/22305





---

archive/issue_comments_306606.json:
```json
{
    "body": "The change is significant. CPython3 still uses the same underlying logic, so that should still work, but it looks like it will be difficult to support both Py2 and Py3 with the same source. Do we have conditional compilation flags in cython for such cases? I imagine the transition is smoothest if we can ensure that we can support Py2 and Py3 from a single source, at least for a while.\n\nIf I recall correctly: `PyDict_GetItemWithError` is available in Py3.\n\nFor the rest, it should just be `del_dictitem_by_exact_value` that needs rewriting to account for the renaming of certain structures and, most importantly, dealing with split tables (which is new) as well as combined tables (which are basically the old dict lay-out).\n\nIt may be worth checking if the special trick used to participate in the Python Trashcan is still necessary with Py3.\n\nIteration protection has changed in Py3 as well a bit, so perhaps we don't quite need the protection we're enforcing in deletion anymore.\n\nI think presently the \"contains\" test also reaches into the internal structure. However, \"contains\" doesn't really produce verifiable results on a WeakValueDict anyway, because the member can always disappear between the containment test and retrieval, so we could not override that routine (in the same way that \"len\" is not overridden).\n\nFor me the main issues that prevent me from fixing this issue are that I don't have access to a platform where I can compile cython against python 3 and that I don't know how to make cython source compile conditionally wrt. Py2 vs. Py3. It's probably easier if someone who does know how to deal with those things makes the necessary adjustments. It's not rocket science, but you do have to carefully read dictobject.c\n\nIf we could somehow link to [delitem_common](https://github.com/python/cpython/blob/master/Objects/dictobject.c#L1587) the deletion would almost be taken care of. I'm afraid that's not an exported symbol, though, so we basically have to replicate it.\n\nAlso, perhaps we should always force the WeakValueDict to be \"combined\" (the old-style layout), because split tables don't allow deletion, and triggering reshaping of the dictionary in a weakref callback is probably not a good idea.",
    "created_at": "2017-02-05T17:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306606",
    "user": "nbruin"
}
```

The change is significant. CPython3 still uses the same underlying logic, so that should still work, but it looks like it will be difficult to support both Py2 and Py3 with the same source. Do we have conditional compilation flags in cython for such cases? I imagine the transition is smoothest if we can ensure that we can support Py2 and Py3 from a single source, at least for a while.

If I recall correctly: `PyDict_GetItemWithError` is available in Py3.

For the rest, it should just be `del_dictitem_by_exact_value` that needs rewriting to account for the renaming of certain structures and, most importantly, dealing with split tables (which is new) as well as combined tables (which are basically the old dict lay-out).

It may be worth checking if the special trick used to participate in the Python Trashcan is still necessary with Py3.

Iteration protection has changed in Py3 as well a bit, so perhaps we don't quite need the protection we're enforcing in deletion anymore.

I think presently the "contains" test also reaches into the internal structure. However, "contains" doesn't really produce verifiable results on a WeakValueDict anyway, because the member can always disappear between the containment test and retrieval, so we could not override that routine (in the same way that "len" is not overridden).

For me the main issues that prevent me from fixing this issue are that I don't have access to a platform where I can compile cython against python 3 and that I don't know how to make cython source compile conditionally wrt. Py2 vs. Py3. It's probably easier if someone who does know how to deal with those things makes the necessary adjustments. It's not rocket science, but you do have to carefully read dictobject.c

If we could somehow link to [delitem_common](https://github.com/python/cpython/blob/master/Objects/dictobject.c#L1587) the deletion would almost be taken care of. I'm afraid that's not an exported symbol, though, so we basically have to replicate it.

Also, perhaps we should always force the WeakValueDict to be "combined" (the old-style layout), because split tables don't allow deletion, and triggering reshaping of the dictionary in a weakref callback is probably not a good idea.



---

archive/issue_comments_306607.json:
```json
{
    "body": "build failure looks like that:\n\n```\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1393:3: error: unknown type name 'PyDictEntry'\n[sagelib-7.6.beta4]    PyDictEntry *__pyx_v_ep;\n[sagelib-7.6.beta4]    ^\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'\n[sagelib-7.6.beta4]    PyDictEntry *__pyx_t_2;\n[sagelib-7.6.beta4]    ^\n[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1419:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n```\n",
    "created_at": "2017-02-21T15:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306607",
    "user": "chapoton"
}
```

build failure looks like that:

```
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1393:3: error: unknown type name 'PyDictEntry'
[sagelib-7.6.beta4]    PyDictEntry *__pyx_v_ep;
[sagelib-7.6.beta4]    ^
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'
[sagelib-7.6.beta4]    PyDictEntry *__pyx_t_2;
[sagelib-7.6.beta4]    ^
[sagelib-7.6.beta4] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1419:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
```




---

archive/issue_comments_306608.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2017-02-23T11:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306608",
    "user": "chapoton"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_306609.json:
```json
{
    "body": "This is one of our cython+python3 compilation problems.",
    "created_at": "2017-03-01T20:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306609",
    "user": "chapoton"
}
```

This is one of our cython+python3 compilation problems.



---

archive/issue_comments_306610.json:
```json
{
    "body": "Could somebody do some action on the problem here, please ?",
    "created_at": "2017-04-06T08:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306610",
    "user": "chapoton"
}
```

Could somebody do some action on the problem here, please ?



---

archive/issue_comments_306611.json:
```json
{
    "body": "This is probably the last cython file that does not compile with python3 !!",
    "created_at": "2017-04-07T12:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306611",
    "user": "chapoton"
}
```

This is probably the last cython file that does not compile with python3 !!



---

archive/issue_comments_306612.json:
```json
{
    "body": "Is there an easy way to get a \"cython+python3\" setup on which I can try weak_dict? I do recall how I made it work on py2, so I might be in a reasonable position to adapt it to py3.\n\nDo we need a way to switch between the two? I don't think it will be so easy to make a version that works on both py2 and py3 (given that we reach into dicts beyond what's exposed by the API)",
    "created_at": "2017-04-07T21:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306612",
    "user": "nbruin"
}
```

Is there an easy way to get a "cython+python3" setup on which I can try weak_dict? I do recall how I made it work on py2, so I might be in a reasonable position to adapt it to py3.

Do we need a way to switch between the two? I don't think it will be so easy to make a version that works on both py2 and py3 (given that we reach into dicts beyond what's exposed by the API)



---

archive/issue_comments_306613.json:
```json
{
    "body": "OK, I've made some headway here. The changes are quite manageable. However, we do need the content and memory layout of the `PyDictKeysObject`. That's not part of the API and the layout of the `PyDictKeysObject` struct isn't even exported in `Python.h` (it's in `dict-common.h`, which is an internal, non-exported header file in CPython.).\n\nAs before, this means that this module might need rewriting if CPython decides to change the memory layout (and/or its hash probing).\n\nThe bad news is that they have done exactly that from 3.5 to 3.6 (they added order-preserving properties to dictionaries). So: do we have a particular target we're aiming for with sage? 3.5 vs. 3.6 makes a significant difference (larger than 2.7 vs. 3.5 actually)\n\nOf course, reaching into CPython beyond the official CAPI is questionable. The alternative is to reimplement the entirety of dict in order to have `WeakValueDictionary`. Either that or try to get this thing accepted up-stream (after all, the `WeakValueDictionary` that ships with python (also the one with python 3) has demonstrable problems). Are we comfortable with the added maintenance burden of a module that depends on more than just the CAPI of CPython?",
    "created_at": "2017-04-08T03:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306613",
    "user": "nbruin"
}
```

OK, I've made some headway here. The changes are quite manageable. However, we do need the content and memory layout of the `PyDictKeysObject`. That's not part of the API and the layout of the `PyDictKeysObject` struct isn't even exported in `Python.h` (it's in `dict-common.h`, which is an internal, non-exported header file in CPython.).

As before, this means that this module might need rewriting if CPython decides to change the memory layout (and/or its hash probing).

The bad news is that they have done exactly that from 3.5 to 3.6 (they added order-preserving properties to dictionaries). So: do we have a particular target we're aiming for with sage? 3.5 vs. 3.6 makes a significant difference (larger than 2.7 vs. 3.5 actually)

Of course, reaching into CPython beyond the official CAPI is questionable. The alternative is to reimplement the entirety of dict in order to have `WeakValueDictionary`. Either that or try to get this thing accepted up-stream (after all, the `WeakValueDictionary` that ships with python (also the one with python 3) has demonstrable problems). Are we comfortable with the added maintenance burden of a module that depends on more than just the CAPI of CPython?



---

archive/issue_comments_306614.json:
```json
{
    "body": "OK, I've attached a version of weak_dict.pyx that compiles on python 3.6 and that seems to work too. Some more testing should be done and someone should look into how we can merge this into sage without breaking it on python 2.7",
    "created_at": "2017-04-08T04:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306614",
    "user": "nbruin"
}
```

OK, I've attached a version of weak_dict.pyx that compiles on python 3.6 and that seems to work too. Some more testing should be done and someone should look into how we can merge this into sage without breaking it on python 2.7



---

archive/issue_comments_306615.json:
```json
{
    "body": "Attachment [weak_dict.pyx](tarball://root/attachments/some-uuid/ticket22305/weak_dict.pyx) by nbruin created at 2017-04-11 19:11:09\n\nPython3.6 compatible version of weak_dict.pyx",
    "created_at": "2017-04-11T19:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306615",
    "user": "nbruin"
}
```

Attachment [weak_dict.pyx](tarball://root/attachments/some-uuid/ticket22305/weak_dict.pyx) by nbruin created at 2017-04-11 19:11:09

Python3.6 compatible version of weak_dict.pyx



---

archive/issue_comments_306616.json:
```json
{
    "body": "Some updates. Main thing is that the default lookup function doesn't expect deleted entries, so we should trigger the dict to use the more general lookup.\n\nThere is a dictionary variant that has \"split tables\" (for keys and values, so that it can share the keys between different instances). These should only occur as instance dictionaries of objects so they shouldn't occur for `WeakValueDictionaries`. These don't support deletions either.",
    "created_at": "2017-04-11T19:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306616",
    "user": "nbruin"
}
```

Some updates. Main thing is that the default lookup function doesn't expect deleted entries, so we should trigger the dict to use the more general lookup.

There is a dictionary variant that has "split tables" (for keys and values, so that it can share the keys between different instances). These should only occur as instance dictionaries of objects so they shouldn't occur for `WeakValueDictionaries`. These don't support deletions either.



---

archive/issue_comments_306617.json:
```json
{
    "body": "Ping to chapoton. Did you need a fix urgently? The file attached here does solve the compilation issue on Python3.6.",
    "created_at": "2017-04-13T18:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306617",
    "user": "nbruin"
}
```

Ping to chapoton. Did you need a fix urgently? The file attached here does solve the compilation issue on Python3.6.



---

archive/issue_comments_306618.json:
```json
{
    "body": "i have no available time this week",
    "created_at": "2017-04-13T19:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306618",
    "user": "chapoton"
}
```

i have no available time this week



---

archive/issue_comments_306619.json:
```json
{
    "body": "I made a git branch with your latest patch.\n----\nNew commits:",
    "created_at": "2017-04-16T11:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306619",
    "user": "chapoton"
}
```

I made a git branch with your latest patch.
----
New commits:



---

archive/issue_comments_306620.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-16T11:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306620",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306621.json:
```json
{
    "body": "I made a git branch with your latest patch. \n\n**EDIT**: it was not cythonizing correctly because of a typo. Now corrected in latest commit.",
    "created_at": "2017-04-16T12:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306621",
    "user": "chapoton"
}
```

I made a git branch with your latest patch. 

**EDIT**: it was not cythonizing correctly because of a typo. Now corrected in latest commit.



---

archive/issue_comments_306622.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-16T12:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306622",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306623.json:
```json
{
    "body": "next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.",
    "created_at": "2017-04-16T19:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306623",
    "user": "chapoton"
}
```

next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.



---

archive/issue_comments_306624.json:
```json
{
    "body": "Replying to [comment:19 chapoton]:\n> next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.\n\nYes, I looked into that and came up with nothing either. I got the impression that the `setup.py` file would be the place to set a flag depending on the target, and then use \"IF\" in cython to do a conditional compile. We could separate out the code for `delete_by_exact_value` into a separate file if that makes things a little cleaner. That's the only routine that depends on the implementation details of `dict`.\n\nIt looks like the Cython IF is a little more restricted that the C preprocessor one. I tried \n`IF PY_HEX_VERSION > 0x03060000:` but couldn't get it to work.",
    "created_at": "2017-04-16T21:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306624",
    "user": "nbruin"
}
```

Replying to [comment:19 chapoton]:
> next step here would be to have the old code for python2 and the new for python3. I have no idea how to do that.

Yes, I looked into that and came up with nothing either. I got the impression that the `setup.py` file would be the place to set a flag depending on the target, and then use "IF" in cython to do a conditional compile. We could separate out the code for `delete_by_exact_value` into a separate file if that makes things a little cleaner. That's the only routine that depends on the implementation details of `dict`.

It looks like the Cython IF is a little more restricted that the C preprocessor one. I tried 
`IF PY_HEX_VERSION > 0x03060000:` but couldn't get it to work.



---

archive/issue_comments_306625.json:
```json
{
    "body": "`@`jdemeyer, do you know how to achieve properly this kind of py2/py3 switch in cython code ?",
    "created_at": "2017-04-20T07:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306625",
    "user": "chapoton"
}
```

`@`jdemeyer, do you know how to achieve properly this kind of py2/py3 switch in cython code ?



---

archive/issue_comments_306626.json:
```json
{
    "body": "I'll have a look.",
    "created_at": "2017-04-20T07:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306626",
    "user": "jdemeyer"
}
```

I'll have a look.



---

archive/issue_comments_306627.json:
```json
{
    "body": "Besides: copying all that stuff from Python's sources is really bad style. I would much prefer to patch Python to make whatever you need public.",
    "created_at": "2017-04-20T08:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306627",
    "user": "jdemeyer"
}
```

Besides: copying all that stuff from Python's sources is really bad style. I would much prefer to patch Python to make whatever you need public.



---

archive/issue_comments_306628.json:
```json
{
    "body": "I am not convinced that we need completely separate files for Python 2 and Python 3. There would be a lot of code duplication and that is bad style.\n\nSome changes for Python 3 already make sense in Python 2 (just to give one example: replacing `long` by `Py_hash_t`).",
    "created_at": "2017-04-20T08:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306628",
    "user": "jdemeyer"
}
```

I am not convinced that we need completely separate files for Python 2 and Python 3. There would be a lot of code duplication and that is bad style.

Some changes for Python 3 already make sense in Python 2 (just to give one example: replacing `long` by `Py_hash_t`).



---

archive/issue_comments_306629.json:
```json
{
    "body": "My proposal would be:\n\n1. Make a *separate* ticket to deal with changes to `weak_dict.pyx` which are good to do anyway regardless of Python vesion.\n\n2. Patch Python 3 to make public whatever is needed for the Python 3 version of `weak_dict.pyx`.\n\n3. Finally, use conditional compilation to deal with Python 2/3 differences in `weak_dict.pyx`.",
    "created_at": "2017-04-20T08:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306629",
    "user": "jdemeyer"
}
```

My proposal would be:

1. Make a *separate* ticket to deal with changes to `weak_dict.pyx` which are good to do anyway regardless of Python vesion.

2. Patch Python 3 to make public whatever is needed for the Python 3 version of `weak_dict.pyx`.

3. Finally, use conditional compilation to deal with Python 2/3 differences in `weak_dict.pyx`.



---

archive/issue_comments_306630.json:
```json
{
    "body": "Number 2 is a useful exercise in trying to see if we can get a patch submitted upstream, but realistically I don't think it's very realistic that it will be accepted, given that \"deleting an item from a dict by hash and exact value\" isn't something that fits in the dict data abstraction very well, and might be hard to realize on other implementations than CPython.\n\nRequiring a patched python 3 for sage would really be a step backwards in terms of making sage available via other means than its own distribution packaging, so I don't think we should do that.\n\nI agree we can split out differences quite a bit. Basically, it's just the implementation of `delete_by_exact_value` that will depend on the python version, so we could park that in a separate file at least. We're going to need to differentiate *some* cython compilation on python version, though, and currently I don't know how to achieve that. (that's point 3). Can we clear that up? It shouldn't be necessary to program this stuff directly in C, just to have access to PY_HEX_VERSION ...",
    "created_at": "2017-04-20T17:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306630",
    "user": "nbruin"
}
```

Number 2 is a useful exercise in trying to see if we can get a patch submitted upstream, but realistically I don't think it's very realistic that it will be accepted, given that "deleting an item from a dict by hash and exact value" isn't something that fits in the dict data abstraction very well, and might be hard to realize on other implementations than CPython.

Requiring a patched python 3 for sage would really be a step backwards in terms of making sage available via other means than its own distribution packaging, so I don't think we should do that.

I agree we can split out differences quite a bit. Basically, it's just the implementation of `delete_by_exact_value` that will depend on the python version, so we could park that in a separate file at least. We're going to need to differentiate *some* cython compilation on python version, though, and currently I don't know how to achieve that. (that's point 3). Can we clear that up? It shouldn't be necessary to program this stuff directly in C, just to have access to PY_HEX_VERSION ...



---

archive/issue_comments_306631.json:
```json
{
    "body": "ping ? Jeroen, if you want to make a ticket for your point 1, please do so.",
    "created_at": "2017-04-28T11:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306631",
    "user": "chapoton"
}
```

ping ? Jeroen, if you want to make a ticket for your point 1, please do so.



---

archive/issue_comments_306632.json:
```json
{
    "body": "The mechanism to pass compile-time variables to cython (for use in IF ...) seems to be something along the lines of:\n\n```\nfrom distutils.core import setup\nfrom Cython.Build import cythonize\nfrom sys import version_info\n\nif version_info.major <= 2:\n    env = {'PYTHON_VERSION': 2}\nelif version_info.major == 3 and version_info.minor >= 6:\n    env = {'PYTHON_VERSION': 3}\nelse:\n    raise RuntimeError(\"Unsupported version\")\n\nsetup(\n    name = 'weak_dict',\n    ext_modules = cythonize(\"weak_dict.pyx\",compile_time_env=env),\n)\n```\n\nI have no idea where put this in sage, though. I haven't been able to find the \"setup\" command that is relevant for \"weak_dict\".",
    "created_at": "2017-04-30T08:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306632",
    "user": "nbruin"
}
```

The mechanism to pass compile-time variables to cython (for use in IF ...) seems to be something along the lines of:

```
from distutils.core import setup
from Cython.Build import cythonize
from sys import version_info

if version_info.major <= 2:
    env = {'PYTHON_VERSION': 2}
elif version_info.major == 3 and version_info.minor >= 6:
    env = {'PYTHON_VERSION': 3}
else:
    raise RuntimeError("Unsupported version")

setup(
    name = 'weak_dict',
    ext_modules = cythonize("weak_dict.pyx",compile_time_env=env),
)
```

I have no idea where put this in sage, though. I haven't been able to find the "setup" command that is relevant for "weak_dict".



---

archive/issue_comments_306633.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-01T22:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306633",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_306634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-01T22:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306634",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_306635.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-01T22:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306635",
    "user": "nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_306636.json:
```json
{
    "body": "It seems we can simply add `sys.hexversion` as `PY_VERSION_HEX` (which is the CAPI name of the variable) to the compile-time environment for all sage cythonization. That should be fairly low-cost.\n\nI have split off the python-version-sensitive code into a separate file, which seems to work fine. Code replication is now a lot more limited. If someone sees an economic way of sharing the docstring, that would be great. On the other hand, these two implementations are so different that having different docs (and tests?) for them might make sense.\n\nI have tested compiling it within sage on Py2.7 and directly on Python3.6 via the following setup.py:\n\n```\nfrom distutils.core import setup\nfrom Cython.Build import cythonize\nimport sys\n\nsetup(\n    name = 'weak_dict',\n    ext_modules = cythonize([\"weak_dict.pyx\",\"dict_del_by_value.pyx\"],compile_time_env={'PY_VERSION_HEX':sys.hexversion}),\n)\n```\n\n\nSince this routine breaks the abstraction of \"PyDict\" I am pretty sure the code would not get accepted as an API change. The only thing that I could see happening is that python might accept the routine as an internal one and put `WeakValueDict` in C to use it.\n\nThe only option I see to do this \"cleanly\" outside of Python is to implement our own `WeakValueDict` from scratch, i.e., don't base it on `dict`. I don't think that is less maintenance burden than tracking python's dict, and certainly a larger change than the one on this ticket at this point in sage.",
    "created_at": "2017-05-01T22:15:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306636",
    "user": "nbruin"
}
```

It seems we can simply add `sys.hexversion` as `PY_VERSION_HEX` (which is the CAPI name of the variable) to the compile-time environment for all sage cythonization. That should be fairly low-cost.

I have split off the python-version-sensitive code into a separate file, which seems to work fine. Code replication is now a lot more limited. If someone sees an economic way of sharing the docstring, that would be great. On the other hand, these two implementations are so different that having different docs (and tests?) for them might make sense.

I have tested compiling it within sage on Py2.7 and directly on Python3.6 via the following setup.py:

```
from distutils.core import setup
from Cython.Build import cythonize
import sys

setup(
    name = 'weak_dict',
    ext_modules = cythonize(["weak_dict.pyx","dict_del_by_value.pyx"],compile_time_env={'PY_VERSION_HEX':sys.hexversion}),
)
```


Since this routine breaks the abstraction of "PyDict" I am pretty sure the code would not get accepted as an API change. The only thing that I could see happening is that python might accept the routine as an internal one and put `WeakValueDict` in C to use it.

The only option I see to do this "cleanly" outside of Python is to implement our own `WeakValueDict` from scratch, i.e., don't base it on `dict`. I don't think that is less maintenance burden than tracking python's dict, and certainly a larger change than the one on this ticket at this point in sage.



---

archive/issue_comments_306637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-01T22:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306637",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_306638.json:
```json
{
    "body": "seems to be ok on python2 sage, see patchbot report\n\nI will try with SAGE_PYTHON3=yes",
    "created_at": "2017-05-03T06:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306638",
    "user": "chapoton"
}
```

seems to be ok on python2 sage, see patchbot report

I will try with SAGE_PYTHON3=yes



---

archive/issue_comments_306639.json:
```json
{
    "body": "hum, it seems that latest update to numpy broke the SAGE_PYTHON3 build..",
    "created_at": "2017-05-03T08:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306639",
    "user": "chapoton"
}
```

hum, it seems that latest update to numpy broke the SAGE_PYTHON3 build..



---

archive/issue_comments_306640.json:
```json
{
    "body": "See #22582 for a numpy upgrade which should fix the python 3 build.",
    "created_at": "2017-05-03T15:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306640",
    "user": "jhpalmieri"
}
```

See #22582 for a numpy upgrade which should fix the python 3 build.



---

archive/issue_comments_306641.json:
```json
{
    "body": "a tentative python3-compilation answers the following:\n\n```\ncdef del_dictitem_by_exact_value(PyDictObject *mp, PyObject *value, Py_hash_t ha\nsh)\n                                ^\n------------------------------------------------------------\n\nsage/misc/dict_del_by_value.pxd:5:33: Non-extern C function 'del_dictitem_by_exa\nct_value' declared but not defined\n```\n",
    "created_at": "2017-05-03T15:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306641",
    "user": "chapoton"
}
```

a tentative python3-compilation answers the following:

```
cdef del_dictitem_by_exact_value(PyDictObject *mp, PyObject *value, Py_hash_t ha
sh)
                                ^
------------------------------------------------------------

sage/misc/dict_del_by_value.pxd:5:33: Non-extern C function 'del_dictitem_by_exa
ct_value' declared but not defined
```




---

archive/issue_comments_306642.json:
```json
{
    "body": "Was that on <=python3.5 ? Presently the implementation of dictionaries in CPython 3.0 -- 3.5 is not supported, and as a result dict_del_by_value.pyx dutifully refrains from defining a routine.",
    "created_at": "2017-05-03T16:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306642",
    "user": "nbruin"
}
```

Was that on <=python3.5 ? Presently the implementation of dictionaries in CPython 3.0 -- 3.5 is not supported, and as a result dict_del_by_value.pyx dutifully refrains from defining a routine.



---

archive/issue_comments_306643.json:
```json
{
    "body": "Yes, this is on the current python3 in sage, which is 3.5.1\n\nSo this means that we have to upgrade python3 package, right ?",
    "created_at": "2017-05-03T17:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306643",
    "user": "chapoton"
}
```

Yes, this is on the current python3 in sage, which is 3.5.1

So this means that we have to upgrade python3 package, right ?



---

archive/issue_comments_306644.json:
```json
{
    "body": "Replying to [comment:38 chapoton]:\n> Yes, this is on the current python3 in sage, which is 3.5.1\n> \n> So this means that we have to upgrade python3 package, right ?\n\nYes. I am surprised your earlier experiments worked then. If the code that was here before even compiled against 3.5, it would certainly segfault.\n\n[https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict](https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict)",
    "created_at": "2017-05-03T17:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306644",
    "user": "nbruin"
}
```

Replying to [comment:38 chapoton]:
> Yes, this is on the current python3 in sage, which is 3.5.1
> 
> So this means that we have to upgrade python3 package, right ?

Yes. I am surprised your earlier experiments worked then. If the code that was here before even compiled against 3.5, it would certainly segfault.

[https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict](https://docs.python.org/3/whatsnew/3.6.html#whatsnew36-compactdict)



---

archive/issue_comments_306645.json:
```json
{
    "body": "I have created #22942",
    "created_at": "2017-05-03T19:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306645",
    "user": "chapoton"
}
```

I have created #22942



---

archive/issue_comments_306646.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-19T12:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306646",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306647.json:
```json
{
    "body": "ok, green bot, I am setting to positive.",
    "created_at": "2017-05-19T12:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306647",
    "user": "chapoton"
}
```

ok, green bot, I am setting to positive.



---

archive/issue_comments_306648.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-05-19T12:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306648",
    "user": "chapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_306649.json:
```json
{
    "body": "hmm, does not seem to compile with SAGE_PYTHON3=yes and python3.6.1",
    "created_at": "2017-05-19T12:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306649",
    "user": "chapoton"
}
```

hmm, does not seem to compile with SAGE_PYTHON3=yes and python3.6.1



---

archive/issue_comments_306650.json:
```json
{
    "body": "log:\n\n```\n[sagelib-8.0.beta7] [1/1] gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/chapoton/sage3/local/include -I/home/chapoton/sage3/local/include/python3.6m -I/home/chapoton/sage3/local/lib/python3.6/site-packages/numpy/core/include -I/home/chapoton/sage3/src -I/home/chapoton/sage3/src/sage/ext -I/home/chapoton/sage3/src/build/cythonized -I/home/chapoton/sage3/src/build/cythonized/sage/ext -I/home/chapoton/sage3/local/include/python3.6m -c /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c -o build/temp.linux-x86_64-3.6/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.o -fno-strict-aliasing\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1403:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1424:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_key)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 152, __pyx_L1_error)\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1444:25: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_r = __pyx_v_ep->me_value;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_init_dummy':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1497:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1498:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1503:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1538:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_table;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1558:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'\n[sagelib-8.0.beta7]    __pyx_t_3 = __pyx_v_mp->ma_mask;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1588:29: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_6 = ((__pyx_v_ep->me_key != NULL) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1598:27: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]        __pyx_r = __pyx_v_ep->me_key;\n[sagelib-8.0.beta7]                            ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_del_dictitem_by_exact_value':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1655:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1656:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1660:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_1;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1674:37: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'\n[sagelib-8.0.beta7]    __pyx_v_mask = ((size_t)__pyx_v_mp->ma_mask);\n[sagelib-8.0.beta7]                                      ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1683:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'\n[sagelib-8.0.beta7]    __pyx_t_1 = __pyx_v_mp->ma_table;\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1711:27: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);\n[sagelib-8.0.beta7]                            ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1751:42: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_3 = ((((PyObject *)__pyx_v_ep->me_value) != __pyx_v_value) != 0);\n[sagelib-8.0.beta7]                                           ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1757:29: error: request for member 'me_hash' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_3 = ((__pyx_v_ep->me_hash != __pyx_v_hash) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1787:29: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]      __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);\n[sagelib-8.0.beta7]                              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1839:54: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 0, __pyx_v_ep->me_key); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 258, __pyx_L1_error)\n[sagelib-8.0.beta7]                                                       ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1889:13: error: request for member 'me_key' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_v_ep->me_key = __pyx_v_4sage_4misc_9weak_dict_dummy;\n[sagelib-8.0.beta7]              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1898:54: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 1, __pyx_v_ep->me_value); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 263, __pyx_L1_error)\n[sagelib-8.0.beta7]                                                       ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1907:13: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_v_ep->me_value = NULL;\n[sagelib-8.0.beta7]              ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_pf_4sage_4misc_9weak_dict_19WeakValueDictionary_22__contains__':\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4290:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4294:3: error: unknown type name 'PyDictEntry'\n[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;\n[sagelib-8.0.beta7]    ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4316:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'\n[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_k)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 928, __pyx_L1_error)\n[sagelib-8.0.beta7]                          ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4326:26: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_4 = (__pyx_v_ep->me_value != NULL);\n[sagelib-8.0.beta7]                           ^\n[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4332:46: error: request for member 'me_value' in something not a structure or union\n[sagelib-8.0.beta7]    __pyx_t_4 = (PyWeakref_GetObject(__pyx_v_ep->me_value) != Py_None);\n[sagelib-8.0.beta7]                                               ^\n[sagelib-8.0.beta7] error: command 'gcc' failed with exit status 1\n```\n",
    "created_at": "2017-05-19T12:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306650",
    "user": "chapoton"
}
```

log:

```
[sagelib-8.0.beta7] [1/1] gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/chapoton/sage3/local/include -I/home/chapoton/sage3/local/include/python3.6m -I/home/chapoton/sage3/local/lib/python3.6/site-packages/numpy/core/include -I/home/chapoton/sage3/src -I/home/chapoton/sage3/src/sage/ext -I/home/chapoton/sage3/src/build/cythonized -I/home/chapoton/sage3/src/build/cythonized/sage/ext -I/home/chapoton/sage3/local/include/python3.6m -c /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c -o build/temp.linux-x86_64-3.6/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.o -fno-strict-aliasing
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_PyDict_GetItemWithError':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1398:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1403:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1424:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_key)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 152, __pyx_L1_error)
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1444:25: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_r = __pyx_v_ep->me_value;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_init_dummy':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1497:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1498:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1503:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1538:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_table;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1558:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'
[sagelib-8.0.beta7]    __pyx_t_3 = __pyx_v_mp->ma_mask;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1588:29: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_6 = ((__pyx_v_ep->me_key != NULL) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1598:27: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]        __pyx_r = __pyx_v_ep->me_key;
[sagelib-8.0.beta7]                            ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_f_4sage_4misc_9weak_dict_del_dictitem_by_exact_value':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1655:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep0;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1656:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1660:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_1;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1674:37: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_mask'
[sagelib-8.0.beta7]    __pyx_v_mask = ((size_t)__pyx_v_mp->ma_mask);
[sagelib-8.0.beta7]                                      ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1683:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_table'
[sagelib-8.0.beta7]    __pyx_t_1 = __pyx_v_mp->ma_table;
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1711:27: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);
[sagelib-8.0.beta7]                            ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1751:42: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_3 = ((((PyObject *)__pyx_v_ep->me_value) != __pyx_v_value) != 0);
[sagelib-8.0.beta7]                                           ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1757:29: error: request for member 'me_hash' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_3 = ((__pyx_v_ep->me_hash != __pyx_v_hash) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1787:29: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]      __pyx_t_2 = ((__pyx_v_ep->me_key == NULL) != 0);
[sagelib-8.0.beta7]                              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1839:54: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 0, __pyx_v_ep->me_key); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 258, __pyx_L1_error)
[sagelib-8.0.beta7]                                                       ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1889:13: error: request for member 'me_key' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_v_ep->me_key = __pyx_v_4sage_4misc_9weak_dict_dummy;
[sagelib-8.0.beta7]              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1898:54: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_5 = PyList_SetItem(__pyx_v_T, 1, __pyx_v_ep->me_value); if (unlikely(__pyx_t_5 == -1)) __PYX_ERR(0, 263, __pyx_L1_error)
[sagelib-8.0.beta7]                                                       ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:1907:13: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_v_ep->me_value = NULL;
[sagelib-8.0.beta7]              ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c: In function '__pyx_pf_4sage_4misc_9weak_dict_19WeakValueDictionary_22__contains__':
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4290:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_v_ep;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4294:3: error: unknown type name 'PyDictEntry'
[sagelib-8.0.beta7]    PyDictEntry *__pyx_t_2;
[sagelib-8.0.beta7]    ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4316:25: error: 'PyDictObject {aka struct <anonymous>}' has no member named 'ma_lookup'
[sagelib-8.0.beta7]    __pyx_t_2 = __pyx_v_mp->ma_lookup(__pyx_v_mp, ((PyObject *)((void *)__pyx_v_k)), __pyx_t_1); if (unlikely(__pyx_t_2 == NULL)) __PYX_ERR(0, 928, __pyx_L1_error)
[sagelib-8.0.beta7]                          ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4326:26: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_4 = (__pyx_v_ep->me_value != NULL);
[sagelib-8.0.beta7]                           ^
[sagelib-8.0.beta7] /home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:4332:46: error: request for member 'me_value' in something not a structure or union
[sagelib-8.0.beta7]    __pyx_t_4 = (PyWeakref_GetObject(__pyx_v_ep->me_value) != Py_None);
[sagelib-8.0.beta7]                                               ^
[sagelib-8.0.beta7] error: command 'gcc' failed with exit status 1
```




---

archive/issue_comments_306651.json:
```json
{
    "body": "Are you testing the right branch? `PyDictEntry` doesn't occur in `weak_dict.pyx`. The only references to it are in `dict_del_by_value.pyx` and they don't get exported.",
    "created_at": "2017-05-19T15:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306651",
    "user": "nbruin"
}
```

Are you testing the right branch? `PyDictEntry` doesn't occur in `weak_dict.pyx`. The only references to it are in `dict_del_by_value.pyx` and they don't get exported.



---

archive/issue_comments_306652.json:
```json
{
    "body": "hmm, indeed. I was trying the vanilla develop branch... sorry for the noise..",
    "created_at": "2017-05-19T15:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306652",
    "user": "chapoton"
}
```

hmm, indeed. I was trying the vanilla develop branch... sorry for the noise..



---

archive/issue_comments_306653.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-05-19T15:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306653",
    "user": "tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_306654.json:
```json
{
    "body": "Indeed, it works with SAGE_PYTHON3=yes, so I agree with the positive review.",
    "created_at": "2017-05-19T15:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306654",
    "user": "chapoton"
}
```

Indeed, it works with SAGE_PYTHON3=yes, so I agree with the positive review.



---

archive/issue_comments_306655.json:
```json
{
    "body": "Ah, sorry, I didn't realize you were (re?)checking it. I saw comment:46 and thought you just forgot to flip it back to positive review.",
    "created_at": "2017-05-19T15:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306655",
    "user": "tscrim"
}
```

Ah, sorry, I didn't realize you were (re?)checking it. I saw comment:46 and thought you just forgot to flip it back to positive review.



---

archive/issue_comments_306656.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-20T20:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306656",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_306657.json:
```json
{
    "body": "could the changes made here possibly explain the issue arising there:\n\n```\nTraceback (most recent call last):\n  File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py\", line 604, in _get_from_cache\n    return _cache[key]\n  File \"sage/misc/weak_dict.pyx\", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)\nTypeError: unhashable type: 'ComplexIntervalField_class_with_category'\n```\n\nduring an experimental python3-build of sage ?",
    "created_at": "2017-08-26T13:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306657",
    "user": "chapoton"
}
```

could the changes made here possibly explain the issue arising there:

```
Traceback (most recent call last):
  File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py", line 604, in _get_from_cache
    return _cache[key]
  File "sage/misc/weak_dict.pyx", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)
TypeError: unhashable type: 'ComplexIntervalField_class_with_category'
```

during an experimental python3-build of sage ?



---

archive/issue_comments_306658.json:
```json
{
    "body": "Replying to [comment:51 chapoton]:\n> could the changes made here possibly explain the issue arising there:\n> {{{\n> Traceback (most recent call last):\n>   File \"/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py\", line 604, in _get_from_cache\n>     return _cache[key]\n>   File \"sage/misc/weak_dict.pyx\", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)\n> TypeError: unhashable type: 'ComplexIntervalField_class_with_category'\n> }}}\n> during an experimental python3-build of sage ?\n\nNo.\n\nAlso, it's not such a good idea to ask questions on closed tickets. Probably no-one will read them, unless they happen to be looking at the ticket for reference for something else.",
    "created_at": "2017-09-22T16:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22068",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22068#issuecomment-306658",
    "user": "nbruin"
}
```

Replying to [comment:51 chapoton]:
> could the changes made here possibly explain the issue arising there:
> {{{
> Traceback (most recent call last):
>   File "/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py", line 604, in _get_from_cache
>     return _cache[key]
>   File "sage/misc/weak_dict.pyx", line 699, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/home/chapoton/sage3/src/build/cythonized/sage/misc/weak_dict.c:3507)
> TypeError: unhashable type: 'ComplexIntervalField_class_with_category'
> }}}
> during an experimental python3-build of sage ?

No.

Also, it's not such a good idea to ask questions on closed tickets. Probably no-one will read them, unless they happen to be looking at the ticket for reference for something else.
