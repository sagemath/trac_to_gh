# Issue 28681: Make giacpy_sage a standard package

Issue created by migration from https://trac.sagemath.org/ticket/28918

Original creator: slelievre

Original creation time: 2019-12-28 06:29:07

CC:  frederichan @mwageringel slelievre vdelecroix

As suggested in #28913#comment:3.


---

Comment by @mwageringel created at 2020-02-03 20:12:08

What is required to make this happen?


---

Comment by fbissey created at 2020-02-03 21:38:49

Replying to [comment:2 gh-mwageringel]:
> What is required to make this happen?

Usually a vote on sage-devel. The package has been optional long enough that it should be the only requirement.

For info, the only case new packages go straight to standard without vote or questions is when they are new dependency of a standard package.


---

Comment by slelievre created at 2020-02-03 22:53:17

Launched a poll on sage-devel:

- https://groups.google.com/d/topic/sage-devel/uYXGzG_py28/discussion


---

Comment by frederichan created at 2020-02-04 09:58:51

Thank you for this ticket.
NB: if the vote is favorable we need to remove all the:


```
optional - giacpy_sage
```

in the comments of the doctests in the following files:


```
src/sage/libs/giac.py
src/sage/rings/polynomial/multi_polynomial_ideal.py
```


NB: the *random* and *long time* comments should stay. 

There is also a flag in the following


```
build/pkgs/giacpy_sage/type
```

but I don't know if the ticket should change it or let the Release Manager do it himself.


---

Comment by frederichan created at 2020-02-04 14:37:53

I have found 2 doctest failure in sage 9.1.beta3 due to python3. So we also need to upgrade the upstream source to giacpy_sage-0.7.0.

I have started a new public branch with this upstream fix. But let all the optional flags in the sage code. If the vote turn out to be positive we will have to remove them.


---

Comment by fbissey created at 2020-02-05 00:24:18

Something for upstream, I fail to compile giacpy_sage-0.7.0 with the latest giac (1.5.0.85)

```
building 'giacpy_sage' extension
creating /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7
x86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/usr/lib/python3.7/site-packages/cysignals -I/dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0 -I/usr/lib/python3.7/site-packages/sage/libs/ntl -I/usr/lib/python3.7/site-packages/sage/cpython -I/usr/include -I/usr/lib/python3.7/site-packages -I/usr/lib/python3.7/site-packages/sage/ext -I/usr/include/python3.7m -I/usr/lib/python3.7/site-packages/numpy/core/include -I/usr/include/python3.7m -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7/giacpy_sage.o -std=c++11
In file included from giacpy_sage.cpp:665:
misc.h: In function ‘void archivegen(std::string, const giac::gen&, const giac::context*)’:
misc.h:104:15: error: variable ‘std::ofstream of’ has initializer but incomplete type
  104 |   ofstream of(filename.c_str());
      |               ^~~~~~~~
misc.h: In function ‘giac::gen unarchivegen(std::string, const giac::context*)’:
misc.h:110:14: error: variable ‘std::ifstream f’ has initializer but incomplete type
  110 |   ifstream f(filename.c_str());
      |              ^~~~~~~~
/usr/lib/python3.7/site-packages/Cython/Compiler/Main.py:369: FutureWarning: Cython directive 'language_level' not set, using 2 for now (Py2). This will change in a later release! File: /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0/giacpy_sage.pxd
  tree = Parsing.p_module(s, pxd, full_module_name)
error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```

Any ideas?


---

Comment by fbissey created at 2020-02-05 01:25:00

I actually have the same issue with giacpy_sage 0.6.8.


---

Comment by frederichan created at 2020-02-05 08:14:12

Thank you François, it's a missing include. I will fix it in giacpy.
It seems that between giac-1.5.0.63 and 1.5.0.75 fstream was removed in several places:


```
fred@localhost src]$ grep "<fstream>" *.h
global.h://#include <fstream>
Graph3d.h:#include <fstream>
graphe.h:#include <fstream>
Graph.h:#include <fstream>
help.h://#include <fstream>
monomial.h://#include <fstream>
opengl.h:#include <fstream>
poly.h://#include <fstream>

[fred@localhost src]$ grep "<fstream>" ~/dev/sage/develop/sage/local/include/giac/*.h
/home/fred/dev/sage/develop/sage/local/include/giac/global.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/graphe.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/help.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/monomial.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/poly.h:#include <fstream>

```



---

Comment by git created at 2020-02-05 11:10:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by frederichan created at 2020-02-05 11:14:00

the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1
I have update the branch accordingly.


---

Comment by fbissey created at 2020-02-06 07:51:26

Replying to [comment:11 frederichan]:
> the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1
> I have update the branch accordingly.

Works now. Thanks!


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-07-13 18:33:23

See also #29552


---

Comment by mkoeppe created at 2020-08-10 02:30:39

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-10 18:22:51

Changing status from new to needs_info.


---

Comment by fbissey created at 2020-08-11 00:06:34

I have issues with this going to standard by just flipping the switch. It risks to become a circular dependency madness.

Currently `giacpy_sage` requires sage at build time to figure out the include directory by importing `sage_include_directory` from `sage.env`. That part is not needed and should probably be simplified. If you are installing via `sage -i` the environment should be set correctly for finding the headers. If you are on a distro they also are in reach. Similarly `library_dirs` doesn't need to be set (in fact the current setup is annoying on systems with lib/lib64 split). But sage is needed when compiling the .pyx files as it imports a fair deal of sage bits.

`sage` is needed at runtime and test time.

If `sage` needs the package at runtime or to build the documentation you create a scenario where building sage look like:

1. build sagelib
2. build giacpy_sage
3. optional: test giacpy_sage
4. build sagelib documentation
5. test sagelib

So `giacpy_sage` is inserting itself in the middle of the traditional build cycle. 

`sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib and I believe merging `giacpy_sage` inside sagelib is the only way to get out what looks like circular dependency in the future.


---

Comment by mkoeppe created at 2020-08-11 00:09:32

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-08-11 00:09:32

Yes, I agree that #29171, merging into sagelib, is the way to go.


---

Comment by mkoeppe created at 2020-08-11 00:17:42

Replying to [comment:17 fbissey]:
> `sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib 

This is now #30332


---

Comment by @mwageringel created at 2020-08-13 18:17:11

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-03 02:58:25

Changing priority from critical to major.


---

Comment by slelievre created at 2020-09-03 09:19:10

Resolution: invalid
