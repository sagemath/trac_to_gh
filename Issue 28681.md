# Issue 28681: Make giacpy_sage a standard package

archive/issues_028681.json:
```json
{
    "body": "CC:  frederichan @mwageringel slelievre vdelecroix\n\nAs suggested in #28913#comment:3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28918\n\n",
    "created_at": "2019-12-28T06:29:07Z",
    "labels": [
        "packages: optional",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Make giacpy_sage a standard package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28681",
    "user": "slelievre"
}
```
CC:  frederichan @mwageringel slelievre vdelecroix

As suggested in #28913#comment:3.

Issue created by migration from https://trac.sagemath.org/ticket/28918





---

archive/issue_comments_405088.json:
```json
{
    "body": "What is required to make this happen?",
    "created_at": "2020-02-03T20:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405088",
    "user": "@mwageringel"
}
```

What is required to make this happen?



---

archive/issue_comments_405089.json:
```json
{
    "body": "Replying to [comment:2 gh-mwageringel]:\n> What is required to make this happen?\n\nUsually a vote on sage-devel. The package has been optional long enough that it should be the only requirement.\n\nFor info, the only case new packages go straight to standard without vote or questions is when they are new dependency of a standard package.",
    "created_at": "2020-02-03T21:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405089",
    "user": "fbissey"
}
```

Replying to [comment:2 gh-mwageringel]:
> What is required to make this happen?

Usually a vote on sage-devel. The package has been optional long enough that it should be the only requirement.

For info, the only case new packages go straight to standard without vote or questions is when they are new dependency of a standard package.



---

archive/issue_comments_405090.json:
```json
{
    "body": "Launched a poll on sage-devel:\n\n- https://groups.google.com/d/topic/sage-devel/uYXGzG_py28/discussion",
    "created_at": "2020-02-03T22:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405090",
    "user": "slelievre"
}
```

Launched a poll on sage-devel:

- https://groups.google.com/d/topic/sage-devel/uYXGzG_py28/discussion



---

archive/issue_comments_405091.json:
```json
{
    "body": "Thank you for this ticket.\nNB: if the vote is favorable we need to remove all the:\n\n\n```\noptional - giacpy_sage\n```\n\nin the comments of the doctests in the following files:\n\n\n```\nsrc/sage/libs/giac.py\nsrc/sage/rings/polynomial/multi_polynomial_ideal.py\n```\n\n\nNB: the **random** and **long time** comments should stay. \n\nThere is also a flag in the following\n\n\n```\nbuild/pkgs/giacpy_sage/type\n```\n\nbut I don't know if the ticket should change it or let the Release Manager do it himself.",
    "created_at": "2020-02-04T09:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405091",
    "user": "frederichan"
}
```

Thank you for this ticket.
NB: if the vote is favorable we need to remove all the:


```
optional - giacpy_sage
```

in the comments of the doctests in the following files:


```
src/sage/libs/giac.py
src/sage/rings/polynomial/multi_polynomial_ideal.py
```


NB: the **random** and **long time** comments should stay. 

There is also a flag in the following


```
build/pkgs/giacpy_sage/type
```

but I don't know if the ticket should change it or let the Release Manager do it himself.



---

archive/issue_comments_405092.json:
```json
{
    "body": "I have found 2 doctest failure in sage 9.1.beta3 due to python3. So we also need to upgrade the upstream source to giacpy_sage-0.7.0.\n\nI have started a new public branch with this upstream fix. But let all the optional flags in the sage code. If the vote turn out to be positive we will have to remove them.",
    "created_at": "2020-02-04T14:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405092",
    "user": "frederichan"
}
```

I have found 2 doctest failure in sage 9.1.beta3 due to python3. So we also need to upgrade the upstream source to giacpy_sage-0.7.0.

I have started a new public branch with this upstream fix. But let all the optional flags in the sage code. If the vote turn out to be positive we will have to remove them.



---

archive/issue_comments_405093.json:
```json
{
    "body": "Something for upstream, I fail to compile giacpy_sage-0.7.0 with the latest giac (1.5.0.85)\n\n```\nbuilding 'giacpy_sage' extension\ncreating /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7\nx86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/usr/lib/python3.7/site-packages/cysignals -I/dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0 -I/usr/lib/python3.7/site-packages/sage/libs/ntl -I/usr/lib/python3.7/site-packages/sage/cpython -I/usr/include -I/usr/lib/python3.7/site-packages -I/usr/lib/python3.7/site-packages/sage/ext -I/usr/include/python3.7m -I/usr/lib/python3.7/site-packages/numpy/core/include -I/usr/include/python3.7m -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7/giacpy_sage.o -std=c++11\nIn file included from giacpy_sage.cpp:665:\nmisc.h: In function \u2018void archivegen(std::string, const giac::gen&, const giac::context*)\u2019:\nmisc.h:104:15: error: variable \u2018std::ofstream of\u2019 has initializer but incomplete type\n  104 |   ofstream of(filename.c_str());\n      |               ^~~~~~~~\nmisc.h: In function \u2018giac::gen unarchivegen(std::string, const giac::context*)\u2019:\nmisc.h:110:14: error: variable \u2018std::ifstream f\u2019 has initializer but incomplete type\n  110 |   ifstream f(filename.c_str());\n      |              ^~~~~~~~\n/usr/lib/python3.7/site-packages/Cython/Compiler/Main.py:369: FutureWarning: Cython directive 'language_level' not set, using 2 for now (Py2). This will change in a later release! File: /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0/giacpy_sage.pxd\n  tree = Parsing.p_module(s, pxd, full_module_name)\nerror: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1\n```\n\nAny ideas?",
    "created_at": "2020-02-05T00:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405093",
    "user": "fbissey"
}
```

Something for upstream, I fail to compile giacpy_sage-0.7.0 with the latest giac (1.5.0.85)

```
building 'giacpy_sage' extension
creating /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7
x86_64-pc-linux-gnu-g++ -march=native -O2 -pipe -fPIC -I/usr/lib/python3.7/site-packages/cysignals -I/dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0 -I/usr/lib/python3.7/site-packages/sage/libs/ntl -I/usr/lib/python3.7/site-packages/sage/cpython -I/usr/include -I/usr/lib/python3.7/site-packages -I/usr/lib/python3.7/site-packages/sage/ext -I/usr/include/python3.7m -I/usr/lib/python3.7/site-packages/numpy/core/include -I/usr/include/python3.7m -c giacpy_sage.cpp -o /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0-python3_7/temp.linux-x86_64-3.7/giacpy_sage.o -std=c++11
In file included from giacpy_sage.cpp:665:
misc.h: In function ‘void archivegen(std::string, const giac::gen&, const giac::context*)’:
misc.h:104:15: error: variable ‘std::ofstream of’ has initializer but incomplete type
  104 |   ofstream of(filename.c_str());
      |               ^~~~~~~~
misc.h: In function ‘giac::gen unarchivegen(std::string, const giac::context*)’:
misc.h:110:14: error: variable ‘std::ifstream f’ has initializer but incomplete type
  110 |   ifstream f(filename.c_str());
      |              ^~~~~~~~
/usr/lib/python3.7/site-packages/Cython/Compiler/Main.py:369: FutureWarning: Cython directive 'language_level' not set, using 2 for now (Py2). This will change in a later release! File: /dev/shm/portage/dev-python/giacpy_sage-0.7.0/work/giacpy_sage-0.7.0/giacpy_sage.pxd
  tree = Parsing.p_module(s, pxd, full_module_name)
error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```

Any ideas?



---

archive/issue_comments_405094.json:
```json
{
    "body": "I actually have the same issue with giacpy_sage 0.6.8.",
    "created_at": "2020-02-05T01:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405094",
    "user": "fbissey"
}
```

I actually have the same issue with giacpy_sage 0.6.8.



---

archive/issue_comments_405095.json:
```json
{
    "body": "Thank you Fran\u00e7ois, it's a missing include. I will fix it in giacpy.\nIt seems that between giac-1.5.0.63 and 1.5.0.75 fstream was removed in several places:\n\n\n```\nfred@localhost src]$ grep \"<fstream>\" *.h\nglobal.h://#include <fstream>\nGraph3d.h:#include <fstream>\ngraphe.h:#include <fstream>\nGraph.h:#include <fstream>\nhelp.h://#include <fstream>\nmonomial.h://#include <fstream>\nopengl.h:#include <fstream>\npoly.h://#include <fstream>\n\n[fred@localhost src]$ grep \"<fstream>\" ~/dev/sage/develop/sage/local/include/giac/*.h\n/home/fred/dev/sage/develop/sage/local/include/giac/global.h:#include <fstream>\n/home/fred/dev/sage/develop/sage/local/include/giac/graphe.h:#include <fstream>\n/home/fred/dev/sage/develop/sage/local/include/giac/help.h:#include <fstream>\n/home/fred/dev/sage/develop/sage/local/include/giac/monomial.h:#include <fstream>\n/home/fred/dev/sage/develop/sage/local/include/giac/poly.h:#include <fstream>\n\n```\n",
    "created_at": "2020-02-05T08:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405095",
    "user": "frederichan"
}
```

Thank you François, it's a missing include. I will fix it in giacpy.
It seems that between giac-1.5.0.63 and 1.5.0.75 fstream was removed in several places:


```
fred@localhost src]$ grep "<fstream>" *.h
global.h://#include <fstream>
Graph3d.h:#include <fstream>
graphe.h:#include <fstream>
Graph.h:#include <fstream>
help.h://#include <fstream>
monomial.h://#include <fstream>
opengl.h:#include <fstream>
poly.h://#include <fstream>

[fred@localhost src]$ grep "<fstream>" ~/dev/sage/develop/sage/local/include/giac/*.h
/home/fred/dev/sage/develop/sage/local/include/giac/global.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/graphe.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/help.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/monomial.h:#include <fstream>
/home/fred/dev/sage/develop/sage/local/include/giac/poly.h:#include <fstream>

```




---

archive/issue_comments_405096.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-05T11:10:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405096",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_405097.json:
```json
{
    "body": "the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1\nI have update the branch accordingly.",
    "created_at": "2020-02-05T11:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405097",
    "user": "frederichan"
}
```

the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1
I have update the branch accordingly.



---

archive/issue_comments_405098.json:
```json
{
    "body": "Replying to [comment:11 frederichan]:\n> the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1\n> I have update the branch accordingly.\n\nWorks now. Thanks!",
    "created_at": "2020-02-06T07:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405098",
    "user": "fbissey"
}
```

Replying to [comment:11 frederichan]:
> the missing header with giac >1.5.0.75 reported by francois, should be fixed in giacpy_sage-0.7.1
> I have update the branch accordingly.

Works now. Thanks!



---

archive/issue_comments_405099.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405099",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_405100.json:
```json
{
    "body": "See also #29552",
    "created_at": "2020-07-13T18:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405100",
    "user": "mkoeppe"
}
```

See also #29552



---

archive/issue_comments_405101.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-08-10T02:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405101",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_405102.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-08-10T18:22:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405102",
    "user": "mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_405103.json:
```json
{
    "body": "I have issues with this going to standard by just flipping the switch. It risks to become a circular dependency madness.\n\nCurrently `giacpy_sage` requires sage at build time to figure out the include directory by importing `sage_include_directory` from `sage.env`. That part is not needed and should probably be simplified. If you are installing via `sage -i` the environment should be set correctly for finding the headers. If you are on a distro they also are in reach. Similarly `library_dirs` doesn't need to be set (in fact the current setup is annoying on systems with lib/lib64 split). But sage is needed when compiling the .pyx files as it imports a fair deal of sage bits.\n\n`sage` is needed at runtime and test time.\n\nIf `sage` needs the package at runtime or to build the documentation you create a scenario where building sage look like:\n\n1. build sagelib\n2. build giacpy_sage\n3. optional: test giacpy_sage\n4. build sagelib documentation\n5. test sagelib\n\nSo `giacpy_sage` is inserting itself in the middle of the traditional build cycle. \n\n`sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib and I believe merging `giacpy_sage` inside sagelib is the only way to get out what looks like circular dependency in the future.",
    "created_at": "2020-08-11T00:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405103",
    "user": "fbissey"
}
```

I have issues with this going to standard by just flipping the switch. It risks to become a circular dependency madness.

Currently `giacpy_sage` requires sage at build time to figure out the include directory by importing `sage_include_directory` from `sage.env`. That part is not needed and should probably be simplified. If you are installing via `sage -i` the environment should be set correctly for finding the headers. If you are on a distro they also are in reach. Similarly `library_dirs` doesn't need to be set (in fact the current setup is annoying on systems with lib/lib64 split). But sage is needed when compiling the .pyx files as it imports a fair deal of sage bits.

`sage` is needed at runtime and test time.

If `sage` needs the package at runtime or to build the documentation you create a scenario where building sage look like:

1. build sagelib
2. build giacpy_sage
3. optional: test giacpy_sage
4. build sagelib documentation
5. test sagelib

So `giacpy_sage` is inserting itself in the middle of the traditional build cycle. 

`sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib and I believe merging `giacpy_sage` inside sagelib is the only way to get out what looks like circular dependency in the future.



---

archive/issue_comments_405104.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-08-11T00:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405104",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_405105.json:
```json
{
    "body": "Yes, I agree that #29171, merging into sagelib, is the way to go.",
    "created_at": "2020-08-11T00:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405105",
    "user": "mkoeppe"
}
```

Yes, I agree that #29171, merging into sagelib, is the way to go.



---

archive/issue_comments_405106.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> `sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib \n\nThis is now #30332",
    "created_at": "2020-08-11T00:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405106",
    "user": "mkoeppe"
}
```

Replying to [comment:17 fbissey]:
> `sage_brial` look superficially similar but in its case it can be installed independently of sage so it can go as step 1 (it cannot be tested however). `sage_brial` should in fact be merged into sagelib 

This is now #30332



---

archive/issue_comments_405107.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-13T18:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405107",
    "user": "@mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_405108.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2020-09-03T02:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405108",
    "user": "mkoeppe"
}
```

Changing priority from critical to major.



---

archive/issue_comments_405109.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-09-03T09:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28681",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28681#issuecomment-405109",
    "user": "slelievre"
}
```

Resolution: invalid
