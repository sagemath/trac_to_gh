# Issue 18027: make map_coefficients in modules_with_basis safer or more general

archive/issues_018027.json:
```json
{
    "body": "CC:  zabrocki darij sage-combinat hivert\n\nKeywords: map_coefficients, modules_with_basis, base_ring, check arguments\n\nWe would love to be able to, for example, present a symmetric function with factored coefficients.  But:\n\n```\nsage: f = SymmetricFunctions(ZZ).s()([2,2,1])\nsage: f.map_coefficients(factor)\n0\n```\n\n\nThe result is not against the specification, because `map_coefficients` requires an endofunction.\n\nThere are two issues:\n\n1.) we possibly want to be warned when supplying `map_coefficients` with something that is not an endofunction.  This might be achieved by adding an optional argument `check` with default `True`.\n\n2.) we want some way to factor the coefficients.  Nicolas proposed to make something like\n\n```\nsage: f.map_coefficients(factor, codomain=SR)\n```\n\nor\n\n```\nsage: f.change_base_ring(SR).map_coefficients(factor) \n```\n\nwork.\n\nNote that the `Polynomial` class contains something similar, namely:\n\n```\ndef map_coefficients(self, f, new_base_ring=None)\n```\n\n\nHowever, there might be another tiny problem: it seems that currently it is not possible to make factored integers into a commutative ring.  This should possibly be a separate ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18264\n\n",
    "created_at": "2015-04-21T07:05:08Z",
    "labels": [
        "PLEASE CHANGE",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "make map_coefficients in modules_with_basis safer or more general",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18027",
    "user": "mantepse"
}
```
CC:  zabrocki darij sage-combinat hivert

Keywords: map_coefficients, modules_with_basis, base_ring, check arguments

We would love to be able to, for example, present a symmetric function with factored coefficients.  But:

```
sage: f = SymmetricFunctions(ZZ).s()([2,2,1])
sage: f.map_coefficients(factor)
0
```


The result is not against the specification, because `map_coefficients` requires an endofunction.

There are two issues:

1.) we possibly want to be warned when supplying `map_coefficients` with something that is not an endofunction.  This might be achieved by adding an optional argument `check` with default `True`.

2.) we want some way to factor the coefficients.  Nicolas proposed to make something like

```
sage: f.map_coefficients(factor, codomain=SR)
```

or

```
sage: f.change_base_ring(SR).map_coefficients(factor) 
```

work.

Note that the `Polynomial` class contains something similar, namely:

```
def map_coefficients(self, f, new_base_ring=None)
```


However, there might be another tiny problem: it seems that currently it is not possible to make factored integers into a commutative ring.  This should possibly be a separate ticket.

Issue created by migration from https://trac.sagemath.org/ticket/18264





---

archive/issue_comments_242597.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebra.",
    "created_at": "2015-04-21T07:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242597",
    "user": "mantepse"
}
```

Changing component from PLEASE CHANGE to algebra.



---

archive/issue_comments_242598.json:
```json
{
    "body": "Doing this I noticed that `map_coefficients` did not make use of the `distinct` feature of `sum_of_terms`.  I added this too, assuming that initially an element has distinct monomials.",
    "created_at": "2015-04-21T18:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242598",
    "user": "mantepse"
}
```

Doing this I noticed that `map_coefficients` did not make use of the `distinct` feature of `sum_of_terms`.  I added this too, assuming that initially an element has distinct monomials.



---

archive/issue_comments_242599.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-22T10:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242599",
    "user": "nthiery"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242600.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-22T10:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242600",
    "user": "nthiery"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242601.json:
```json
{
    "body": "Hi Martin!\n\nThanks for taking action; this is looking good!\n\nNow that I am reading actual code: a usual idiom to check that a\ncoefficient is indeed in the base ring is to coerce it back there with\n`R(c)`. I guess that would be a fine behavior: it's faster, and it\ntakes care of all cases where someone passes an int, or something that\nrequires some small coercion to be put back in the base ring.\n\nMaybe the option shall be named `coerce` after all. Comments anyone?\n\nNote by the way that coercing would fail in Mike's original use case,\nso whether we go for `coerce` or `check` don't make a difference\nthere:\n\n```\nsage: ZZ(factor(4))\nTypeError: unable to coerce <class 'sage.structure.factorization_integer.IntegerFactorization'> to an integer\n```\n\n\n\nIf we go for the coerce way, then the simplest would be to pass this\noption down to `sum_of_terms`. This requires updating\n`CombinatorialFreeModule.sum_of_terms` to implement that option, by\npassing it down to respectively `CombinatorialFreeModule._from_dict`\nwhere it's already implemented and `CombinatorialFreeModule.term`\nwhere it would need to be implemented by passing the option down to\n`_from_dict`.\n\nIt's getting a bit bigger of a change than what was planned for\noriginaly; do you feel like handling it?\n\nCheers,\n                        Nicolas",
    "created_at": "2015-04-22T10:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242601",
    "user": "nthiery"
}
```

Hi Martin!

Thanks for taking action; this is looking good!

Now that I am reading actual code: a usual idiom to check that a
coefficient is indeed in the base ring is to coerce it back there with
`R(c)`. I guess that would be a fine behavior: it's faster, and it
takes care of all cases where someone passes an int, or something that
requires some small coercion to be put back in the base ring.

Maybe the option shall be named `coerce` after all. Comments anyone?

Note by the way that coercing would fail in Mike's original use case,
so whether we go for `coerce` or `check` don't make a difference
there:

```
sage: ZZ(factor(4))
TypeError: unable to coerce <class 'sage.structure.factorization_integer.IntegerFactorization'> to an integer
```



If we go for the coerce way, then the simplest would be to pass this
option down to `sum_of_terms`. This requires updating
`CombinatorialFreeModule.sum_of_terms` to implement that option, by
passing it down to respectively `CombinatorialFreeModule._from_dict`
where it's already implemented and `CombinatorialFreeModule.term`
where it would need to be implemented by passing the option down to
`_from_dict`.

It's getting a bit bigger of a change than what was planned for
originaly; do you feel like handling it?

Cheers,
                        Nicolas



---

archive/issue_comments_242602.json:
```json
{
    "body": "Replying to [comment:7 nthiery]:\n\n> If we go for the coerce way, then the simplest would be to pass this\n> option down to `sum_of_terms`. This requires updating\n> `CombinatorialFreeModule.sum_of_terms` to implement that option, by\n> passing it down to respectively `CombinatorialFreeModule._from_dict`\n> where it's already implemented and `CombinatorialFreeModule.term`\n> where it would need to be implemented by passing the option down to\n> `_from_dict`.\n\nI agree and will do that as soon as my sage works again (see sage-devel thread...)",
    "created_at": "2015-04-23T04:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242602",
    "user": "mantepse"
}
```

Replying to [comment:7 nthiery]:

> If we go for the coerce way, then the simplest would be to pass this
> option down to `sum_of_terms`. This requires updating
> `CombinatorialFreeModule.sum_of_terms` to implement that option, by
> passing it down to respectively `CombinatorialFreeModule._from_dict`
> where it's already implemented and `CombinatorialFreeModule.term`
> where it would need to be implemented by passing the option down to
> `_from_dict`.

I agree and will do that as soon as my sage works again (see sage-devel thread...)



---

archive/issue_comments_242603.json:
```json
{
    "body": "Hi there!\n\nI was just about to do what Nicolas suggest -- adding an optional argument `coerce`, but I encountered some things that make me hesitate:\n\n1. to be helpful for the casual user, it's default value would have to be `True` - differently from what we have in `_from_dict`.\n\n2. the docstring would then be something like\n\n\n```\nwhether to try to coerce the result of applying `f` to the coefficient ring.\n```\n\n\n    which is a bit strange, given that we require `f` to be an endofunction.\n\nIf you reassure me, I'll do it.  I'm just not 100% sure myself.",
    "created_at": "2015-04-24T18:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242603",
    "user": "mantepse"
}
```

Hi there!

I was just about to do what Nicolas suggest -- adding an optional argument `coerce`, but I encountered some things that make me hesitate:

1. to be helpful for the casual user, it's default value would have to be `True` - differently from what we have in `_from_dict`.

2. the docstring would then be something like


```
whether to try to coerce the result of applying `f` to the coefficient ring.
```


    which is a bit strange, given that we require `f` to be an endofunction.

If you reassure me, I'll do it.  I'm just not 100% sure myself.



---

archive/issue_comments_242604.json:
```json
{
    "body": "Replying to [comment:10 mantepse]:\n> 1. to be helpful for the casual user, it's default value would have to be `True`\n> - differently from what we have in `_from_dict`.\n\nYeah, I agree; it's not supper consistent. Yet `_from_dict` is a\nprivate method when this one is public; so it's not unreasonable\neither that the typical usage situation differ, inducing different\ndefault behavior.\n\n> 2. the docstring would then be something like\n> \n> {{{\n> whether to try to coerce the result of applying `f` to the coefficient ring.\n> }}}\n> \n>     which is a bit strange, given that we require `f` to be an endofunction.\n\nI see your point. We should be able to find some wording that makes it\nsound natural. Maybe something like:\n\n`Whether to systematically coerce to the coefficient ring the result\nof applying `f`, for additional safety`.\n\nFrom my perspective you can proceed! Feedback anyone else?\n\nCheers,",
    "created_at": "2015-04-24T20:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242604",
    "user": "nthiery"
}
```

Replying to [comment:10 mantepse]:
> 1. to be helpful for the casual user, it's default value would have to be `True`
> - differently from what we have in `_from_dict`.

Yeah, I agree; it's not supper consistent. Yet `_from_dict` is a
private method when this one is public; so it's not unreasonable
either that the typical usage situation differ, inducing different
default behavior.

> 2. the docstring would then be something like
> 
> {{{
> whether to try to coerce the result of applying `f` to the coefficient ring.
> }}}
> 
>     which is a bit strange, given that we require `f` to be an endofunction.

I see your point. We should be able to find some wording that makes it
sound natural. Maybe something like:

`Whether to systematically coerce to the coefficient ring the result
of applying `f`, for additional safety`.

From my perspective you can proceed! Feedback anyone else?

Cheers,



---

archive/issue_comments_242605.json:
```json
{
    "body": "Done (currently testing).\n\nA question: in general, what is the requirement on the coefficients (morally, not enforced...)?\n\n1) they should be in the base ring\n2) they should be coercible to the base ring\n3) you shouldn't expect anything...\n\n1: In the internal representation, the coefficients are supposed to be\nin the base ring and non zero (as tested by `bool(c)` aka\n`c.__nonzero__()`).\n\nI indeed would not be surprised if there were quite a few places in\nthe Sage sources where those assumptions are broken / abused. It would\nbe good to progressively detect and fix them. A step in this direction\nis to find a better speed/safety/flexibility balance for when to run\nsanity checks, or not, as you are doing here.",
    "created_at": "2015-04-25T06:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242605",
    "user": "mantepse"
}
```

Done (currently testing).

A question: in general, what is the requirement on the coefficients (morally, not enforced...)?

1) they should be in the base ring
2) they should be coercible to the base ring
3) you shouldn't expect anything...

1: In the internal representation, the coefficients are supposed to be
in the base ring and non zero (as tested by `bool(c)` aka
`c.__nonzero__()`).

I indeed would not be surprised if there were quite a few places in
the Sage sources where those assumptions are broken / abused. It would
be good to progressively detect and fix them. A step in this direction
is to find a better speed/safety/flexibility balance for when to run
sanity checks, or not, as you are doing here.



---

archive/issue_comments_242606.json:
```json
{
    "body": "As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:\n\n\n```\nFile \"src/sage/combinat/ncsf_qsym/ncsf.py\", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\nFailed example:\n    test_psi(2)\n    ...\n    TypeError: no conversion of this rational to integer\n```\n\n\nThe test which fails looks as follows:\n\n\n```\nsage: NCSF = NonCommutativeSymmetricFunctions(ZZ)\nsage: R = NCSF.R()\nsage: Psi = NCSF.Psi()\nsage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])\nsage: Psi(a)\n```\n\n\nThe expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is \"3\".\n\nMartin",
    "created_at": "2015-04-25T07:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242606",
    "user": "mantepse"
}
```

As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:


```
File "src/sage/combinat/ncsf_qsym/ncsf.py", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
Failed example:
    test_psi(2)
    ...
    TypeError: no conversion of this rational to integer
```


The test which fails looks as follows:


```
sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)
sage: R = NCSF.R()
sage: Psi = NCSF.Psi()
sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])
sage: Psi(a)
```


The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is "3".

Martin



---

archive/issue_comments_242607.json:
```json
{
    "body": "Replying to [comment:13 mantepse]:\n> As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:\n\nOk. Can you post here the test summary with the list of failing files,\njust to get an idea of how bad this is?\n\n> {{{\n> File \"src/sage/combinat/ncsf_qsym/ncsf.py\", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\n> Failed example:\n>     test_psi(2)\n>     ...\n>     TypeError: no conversion of this rational to integer\n> }}}\n> \n> The test which fails looks as follows:\n> \n> {{{\n> sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)\n> sage: R = NCSF.R()\n> sage: Psi = NCSF.Psi()\n> sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])\n> sage: Psi(a)\n> }}}\n> \n> The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is \"3\".\n\nIf some intermediate calculations involve rational coefficients, then\nwe definitely want a failure here. Maybe there is a way to improve the\nncsf code to better support NCSF over integers by sticking to integral\ncomputations.\n\nDarij, Mike, ..., what do you think? Do you have a quick way to improve NCSF's\nhandling of integral coefficients? Or is it ok to switch this test to\n`QQ` or mark it as \"not implemented\" for now?",
    "created_at": "2015-04-25T08:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242607",
    "user": "nthiery"
}
```

Replying to [comment:13 mantepse]:
> As it turns out, I get several failures when I insist on trying to coerce to the base ring!  (I pushed the nonworking branch, to get feedback.) For example:

Ok. Can you post here the test summary with the list of failing files,
just to get an idea of how bad this is?

> {{{
> File "src/sage/combinat/ncsf_qsym/ncsf.py", line 3405, in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
> Failed example:
>     test_psi(2)
>     ...
>     TypeError: no conversion of this rational to integer
> }}}
> 
> The test which fails looks as follows:
> 
> {{{
> sage: NCSF = NonCommutativeSymmetricFunctions(ZZ)
> sage: R = NCSF.R()
> sage: Psi = NCSF.Psi()
> sage: n = 2; a = R.sum([(-1) ** i * R[[1]*i + [n-i]] for i in range(n)])
> sage: Psi(a)
> }}}
> 
> The expected output is `Psi[2]` (literally).  The easy fix would be to add the optional argument `coerce=False` to the calls of `sum_of_terms` in `ncsf.py` everywhere, but I'm not sure whether this is what I should do - because that would mean that the answer to the question in my previous comment is "3".

If some intermediate calculations involve rational coefficients, then
we definitely want a failure here. Maybe there is a way to improve the
ncsf code to better support NCSF over integers by sticking to integral
computations.

Darij, Mike, ..., what do you think? Do you have a quick way to improve NCSF's
handling of integral coefficients? Or is it ok to switch this test to
`QQ` or mark it as "not implemented" for now?



---

archive/issue_comments_242608.json:
```json
{
    "body": "I think it's only\n\n\n```\n2 items had failures:\n   3 of  21 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Phi.Element.verschiebung\n   3 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi\n    [715 tests, 6 failures, 28.15 s]\n----------------------------------------------------------------------\nsage -t --warn-long 97.2 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2015-04-25T11:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242608",
    "user": "mantepse"
}
```

I think it's only


```
2 items had failures:
   3 of  21 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Phi.Element.verschiebung
   3 of   8 in sage.combinat.ncsf_qsym.ncsf.NonCommutativeSymmetricFunctions.Psi
    [715 tests, 6 failures, 28.15 s]
----------------------------------------------------------------------
sage -t --warn-long 97.2 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_242609.json:
```json
{
    "body": "Out of curiosity, I modified `_from_dict` to to always try coercion.  I then get some more failures:\n\n\n\n```\n----------------------------------------------------------------------\nsage -t --warn-long 74.6 src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py  # Timed out\nsage -t --warn-long 74.6 src/sage/algebras/steenrod/steenrod_algebra.py  # 1 doctest failed\nsage -t --warn-long 74.6 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed\nsage -t --warn-long 74.6 src/sage/combinat/sf/macdonald.py  # 4 doctests failed\nsage -t --warn-long 74.6 src/sage/combinat/free_module.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2015-04-25T13:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242609",
    "user": "mantepse"
}
```

Out of curiosity, I modified `_from_dict` to to always try coercion.  I then get some more failures:



```
----------------------------------------------------------------------
sage -t --warn-long 74.6 src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py  # Timed out
sage -t --warn-long 74.6 src/sage/algebras/steenrod/steenrod_algebra.py  # 1 doctest failed
sage -t --warn-long 74.6 src/sage/combinat/ncsf_qsym/ncsf.py  # 6 doctests failed
sage -t --warn-long 74.6 src/sage/combinat/sf/macdonald.py  # 4 doctests failed
sage -t --warn-long 74.6 src/sage/combinat/free_module.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_242610.json:
```json
{
    "body": "Darij put some effort into making sure that `ncsf` and `qsym` worked over the integers in obvious ways.  I believe that this involved a lot of workarounds.\n\nI am concerned about the conflicts with macdonald.py.  I want to check those out carefully because we are in the process of fine tuning that code in #18194\n\nIMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...",
    "created_at": "2015-04-25T13:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242610",
    "user": "zabrocki"
}
```

Darij put some effort into making sure that `ncsf` and `qsym` worked over the integers in obvious ways.  I believe that this involved a lot of workarounds.

I am concerned about the conflicts with macdonald.py.  I want to check those out carefully because we are in the process of fine tuning that code in #18194

IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...



---

archive/issue_comments_242611.json:
```json
{
    "body": "Can you tell me how to exactly reproduce the failing doctests in ncsf.py? I don't have time for the rest, but at least I should see what's going wrong in my code. The test_psi(n) tests, though, have every right to fail. They should be fixed by replacing `Psi(a) == Psi[n]` by `a == R(Psi[n])`.",
    "created_at": "2015-04-25T17:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242611",
    "user": "darij"
}
```

Can you tell me how to exactly reproduce the failing doctests in ncsf.py? I don't have time for the rest, but at least I should see what's going wrong in my code. The test_psi(n) tests, though, have every right to fail. They should be fixed by replacing `Psi(a) == Psi[n]` by `a == R(Psi[n])`.



---

archive/issue_comments_242612.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-25T18:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242612",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242613.json:
```json
{
    "body": "OOps, I thought I pushed, but I actually only pushed just now.\n\nDarij, if you pull the current branch, you'll see the failures.",
    "created_at": "2015-04-25T18:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242613",
    "user": "mantepse"
}
```

OOps, I thought I pushed, but I actually only pushed just now.

Darij, if you pull the current branch, you'll see the failures.



---

archive/issue_comments_242614.json:
```json
{
    "body": "Replying to [comment:18 zabrocki]:\n\n> IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...\n\nI don't think so.  A neat trick we should copy from FriCAS is to have a constructor `Factored` that takes a ring and returns a ring, keeping the elements in factored form.\n\nSo far, however, I do not know how to create a ring in sage...",
    "created_at": "2015-04-25T20:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242614",
    "user": "mantepse"
}
```

Replying to [comment:18 zabrocki]:

> IMO: I think that if you want to allow factor coefficients then the answer to your question is 3) you shouldn't expect anything...

I don't think so.  A neat trick we should copy from FriCAS is to have a constructor `Factored` that takes a ring and returns a ring, keeping the elements in factored form.

So far, however, I do not know how to create a ring in sage...



---

archive/issue_comments_242615.json:
```json
{
    "body": "I investigated the failure in `sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.coproduct`, which is actually not a real failure:\n\n```\nFailed example:\n    SteenrodAlgebra(p=11, profile=((), (2,1,2))).Q(0,2).coproduct()\nExpected:\n    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 - Q_2 # Q_0\nGot:\n    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 + 10*Q_2 # Q_0\n\n```\n\n\nThe `p=11` in the example means that the coefficient ring is the field with 11 elements, so -1 and 10 are actually the same thing.",
    "created_at": "2015-04-25T20:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242615",
    "user": "mantepse"
}
```

I investigated the failure in `sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.coproduct`, which is actually not a real failure:

```
Failed example:
    SteenrodAlgebra(p=11, profile=((), (2,1,2))).Q(0,2).coproduct()
Expected:
    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 - Q_2 # Q_0
Got:
    1 # Q_0 Q_2 + Q_0 # Q_2 + Q_0 Q_2 # 1 + 10*Q_2 # Q_0

```


The `p=11` in the example means that the coefficient ring is the field with 11 elements, so -1 and 10 are actually the same thing.



---

archive/issue_comments_242616.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-28T19:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242616",
    "user": "darij"
}
```

New commits:



---

archive/issue_comments_242617.json:
```json
{
    "body": "I've fixed the doctests in two files.\n\nThe doc failure in macdonald.py seems a real issue. Mike? (Anyone who works on this needs the newest develop version, 6.7.beta3, since the Macdonald functions have undergone a major change in this version.)\n\nAlso the error in free_module.py itself seems to suggest that some optional parameters are being ignored...",
    "created_at": "2015-04-28T19:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242617",
    "user": "darij"
}
```

I've fixed the doctests in two files.

The doc failure in macdonald.py seems a real issue. Mike? (Anyone who works on this needs the newest develop version, 6.7.beta3, since the Macdonald functions have undergone a major change in this version.)

Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...



---

archive/issue_comments_242618.json:
```json
{
    "body": "Replying to [comment:25 darij]:\n> I've fixed the doctests in two files.\n\nThank you!\n\n> Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...\n\nYes, as I mentioned above (I hope), I \"manually\" set `coerce = True` in `_from_dict` to catch errors.",
    "created_at": "2015-04-28T19:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242618",
    "user": "mantepse"
}
```

Replying to [comment:25 darij]:
> I've fixed the doctests in two files.

Thank you!

> Also the error in free_module.py itself seems to suggest that some optional parameters are being ignored...

Yes, as I mentioned above (I hope), I "manually" set `coerce = True` in `_from_dict` to catch errors.



---

archive/issue_comments_242619.json:
```json
{
    "body": "Oh! Does this mean I've built on top of an experimental branch? Sorry!",
    "created_at": "2015-04-28T19:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242619",
    "user": "darij"
}
```

Oh! Does this mean I've built on top of an experimental branch? Sorry!



---

archive/issue_comments_242620.json:
```json
{
    "body": "I'm sorry, I did not warn explicitely enough.\n\nTo get a production branch, simply remove the line `coerce = True` in `_from_dict` and recompile.",
    "created_at": "2015-04-29T04:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242620",
    "user": "mantepse"
}
```

I'm sorry, I did not warn explicitely enough.

To get a production branch, simply remove the line `coerce = True` in `_from_dict` and recompile.



---

archive/issue_comments_242621.json:
```json
{
    "body": "The doctest fixes are now in #19771.",
    "created_at": "2015-12-23T16:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242621",
    "user": "darij"
}
```

The doctest fixes are now in #19771.



---

archive/issue_comments_242622.json:
```json
{
    "body": "Another case where the implementation of `map_coefficients` in `module_with_basis` is called but doesn't work:\n\n```\nsage: vector([1,2]).map_coefficients(lambda x: x+1)\n...\nTypeError: 'sage.rings.integer.Integer' object is not iterable\n```\n",
    "created_at": "2016-04-07T10:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18027",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18027#issuecomment-242622",
    "user": "mmezzarobba"
}
```

Another case where the implementation of `map_coefficients` in `module_with_basis` is called but doesn't work:

```
sage: vector([1,2]).map_coefficients(lambda x: x+1)
...
TypeError: 'sage.rings.integer.Integer' object is not iterable
```

