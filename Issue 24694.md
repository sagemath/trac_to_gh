# Issue 24694: py3: get rid of __cmp__ in real_mpfr.pyx

archive/issues_024694.json:
```json
{
    "body": "Keywords: python3, richcmp\n\npart of #16537\n\nIssue created by migration from https://trac.sagemath.org/ticket/24931\n\n",
    "created_at": "2018-03-08T19:50:01Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: get rid of __cmp__ in real_mpfr.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24694",
    "user": "chapoton"
}
```
Keywords: python3, richcmp

part of #16537

Issue created by migration from https://trac.sagemath.org/ticket/24931





---

archive/issue_comments_346619.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-08T19:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346619",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_346620.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-08T19:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346620",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_346621.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-08T23:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346621",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_346622.json:
```json
{
    "body": "LGTM.",
    "created_at": "2018-03-08T23:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346622",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_346623.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-03-09T07:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346623",
    "user": "chapoton"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_346624.json:
```json
{
    "body": "Hmm, I suspect that one doctest is failing...",
    "created_at": "2018-03-09T07:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346624",
    "user": "chapoton"
}
```

Hmm, I suspect that one doctest is failing...



---

archive/issue_comments_346625.json:
```json
{
    "body": "Some comments from #24930 apply here too.\n\nAnd it seems that the `__richcmp__` is really only meant to check for equality, so I would add\n\n```\nif op != Py_EQ and op != Py_NE:\n    return NotImplemented\n```\n",
    "created_at": "2018-03-09T09:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346625",
    "user": "jdemeyer"
}
```

Some comments from #24930 apply here too.

And it seems that the `__richcmp__` is really only meant to check for equality, so I would add

```
if op != Py_EQ and op != Py_NE:
    return NotImplemented
```




---

archive/issue_comments_346626.json:
```json
{
    "body": "Indeed. I don't think you even need the full `__richcmp__`.  I implemented this just as an `__eq__`, but for that to work requires Cython 0.28 or a patched Cython.",
    "created_at": "2018-03-09T10:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346626",
    "user": "embray"
}
```

Indeed. I don't think you even need the full `__richcmp__`.  I implemented this just as an `__eq__`, but for that to work requires Cython 0.28 or a patched Cython.



---

archive/issue_comments_346627.json:
```json
{
    "body": "I have:\n\n\n```diff\ndiff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx\nindex 91d8ad1..e13efa0 100644\n--- a/src/sage/rings/real_mpfr.pyx\n+++ b/src/sage/rings/real_mpfr.pyx\n@@ -737,7 +738,7 @@ cdef class RealField_class(sage.rings.ring.Field):\n             return self.convert_method_map(S, \"_mpfr_\")\n         return self._coerce_map_via([RLF], S)\n\n-    def __cmp__(self, other):\n+    def __eq__(self, other):\n         \"\"\"\n         Compare two real fields, returning ``True`` if they are equivalent\n         and ``False`` if they are not.\n@@ -748,13 +749,13 @@ cdef class RealField_class(sage.rings.ring.Field):\n             False\n             sage: RealField(10) == RealField(10)\n             True\n-            sage: RealField(10,rnd='RNDN') == RealField(10,rnd='RNDZ')\n+            sage: RealField(10, rnd='RNDN') == RealField(10, rnd='RNDZ')\n             False\n\n         Scientific notation affects only printing, not mathematically how\n         the field works, so this does not affect equality testing::\n\n-            sage: RealField(10,sci_not=True) == RealField(10,sci_not=False)\n+            sage: RealField(10, sci_not=True) == RealField(10, sci_not=False)\n             True\n             sage: RealField(10) == IntegerRing()\n             False\n@@ -769,13 +770,11 @@ cdef class RealField_class(sage.rings.ring.Field):\n             True\n         \"\"\"\n         if not isinstance(other, RealField_class):\n-            return -1\n+            return False\n+\n         cdef RealField_class _other\n         _other = other  # to access C structure\n-        if self.__prec == _other.__prec and self.rnd == _other.rnd: \\\n-               #and self.sci_not == _other.sci_not:\n-            return 0\n-        return 1\n+        return self.__prec == _other.__prec and self.rnd == _other.rnd\n```\n",
    "created_at": "2018-03-09T10:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346627",
    "user": "embray"
}
```

I have:


```diff
diff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx
index 91d8ad1..e13efa0 100644
--- a/src/sage/rings/real_mpfr.pyx
+++ b/src/sage/rings/real_mpfr.pyx
@@ -737,7 +738,7 @@ cdef class RealField_class(sage.rings.ring.Field):
             return self.convert_method_map(S, "_mpfr_")
         return self._coerce_map_via([RLF], S)

-    def __cmp__(self, other):
+    def __eq__(self, other):
         """
         Compare two real fields, returning ``True`` if they are equivalent
         and ``False`` if they are not.
@@ -748,13 +749,13 @@ cdef class RealField_class(sage.rings.ring.Field):
             False
             sage: RealField(10) == RealField(10)
             True
-            sage: RealField(10,rnd='RNDN') == RealField(10,rnd='RNDZ')
+            sage: RealField(10, rnd='RNDN') == RealField(10, rnd='RNDZ')
             False

         Scientific notation affects only printing, not mathematically how
         the field works, so this does not affect equality testing::

-            sage: RealField(10,sci_not=True) == RealField(10,sci_not=False)
+            sage: RealField(10, sci_not=True) == RealField(10, sci_not=False)
             True
             sage: RealField(10) == IntegerRing()
             False
@@ -769,13 +770,11 @@ cdef class RealField_class(sage.rings.ring.Field):
             True
         """
         if not isinstance(other, RealField_class):
-            return -1
+            return False
+
         cdef RealField_class _other
         _other = other  # to access C structure
-        if self.__prec == _other.__prec and self.rnd == _other.rnd: \
-               #and self.sci_not == _other.sci_not:
-            return 0
-        return 1
+        return self.__prec == _other.__prec and self.rnd == _other.rnd
```




---

archive/issue_comments_346628.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> Indeed. I don't think you even need the full `__richcmp__`.  I implemented this just as an `__eq__`, but for that to work requires Cython 0.28 or a patched Cython.\n\nFYI: Cython 0.28 is in beta now (#24111).",
    "created_at": "2018-03-09T10:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346628",
    "user": "jdemeyer"
}
```

Replying to [comment:5 embray]:
> Indeed. I don't think you even need the full `__richcmp__`.  I implemented this just as an `__eq__`, but for that to work requires Cython 0.28 or a patched Cython.

FYI: Cython 0.28 is in beta now (#24111).



---

archive/issue_comments_346629.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-09T18:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346629",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_346630.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-09T18:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346630",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_346631.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-12T15:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346631",
    "user": "embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_346632.json:
```json
{
    "body": "It doesn't make sense to use `rich_to_bool` here at all.  All you need is \n`return (self.__prec == _other.__prec and self.rnd == _other.rnd) == (op == Py_EQ)`",
    "created_at": "2018-03-12T15:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346632",
    "user": "embray"
}
```

It doesn't make sense to use `rich_to_bool` here at all.  All you need is 
`return (self.__prec == _other.__prec and self.rnd == _other.rnd) == (op == Py_EQ)`



---

archive/issue_comments_346633.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-13T07:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346633",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_346634.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-13T07:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346634",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_346635.json:
```json
{
    "body": "thanks, done",
    "created_at": "2018-03-13T07:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346635",
    "user": "chapoton"
}
```

thanks, done



---

archive/issue_comments_346636.json:
```json
{
    "body": "Right now you have:\n\n\n```python\nif not isinstance(other, RealField_class):\n    return NotImplemented\n```\n\n\nwhich I think was Jeroen's suggestion.  The reason for this is that it will delegate comparison to the class of the right-side object if it is not an instance of `RealField_class`.  So that sort of makes sense.  But I'm concerned about making that the general approach.  \n\nFor example, the tests contain:\n\n\n```\n    sage: RealField(10) == IntegerRing()\n    False\n```\n\n\nwhich currently will work.  But why, then, isn't the same logic applied in `IntegerRing`?  Currently its `__richcmp__` is (somewhat arbitrarily?) implemented rather differently:\n\n\n```python\n    def __richcmp__(left, right, int op):\n        \"\"\"\n        Rich comparison of ``left`` and ``right``.\n\n        TESTS::\n\n            sage: from sage.rings.integer_ring import IntegerRing_class\n            sage: ZZ == ZZ\n            True\n            sage: ZZ != QQ\n            True\n        \"\"\"\n        if left is right:\n            return rich_to_bool(op, 0)\n\n        if isinstance(right, IntegerRing_class):\n            return rich_to_bool(op, 0)\n\n        if isinstance(right, sage.rings.rational_field.RationalField):\n            return rich_to_bool(op, -1)\n\n        return op == Py_NE\n```\n\n\nThat sort of grew out of the old implementation of `IntegerRing_class._cmp_`, but I don't think this is really right either.  Just as in the case of `RealField_class`, this seems to mostly just care about equality (though it seems it should also return less than `RationalField`? What's that about?).\n\nIf `IntegerRing_class.__richcmp__` also contained something like `if not isinstance(right, IntegerRing_class): return NotImplemented`, and then you attempted the aforementioned comparison, instead of a boolean result you'll get a `TypeError` exception.\n\nSo my question becomes, should a class always delegate rich comparison to the other object, and if not when should it and when shouldn't it?",
    "created_at": "2018-03-13T11:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346636",
    "user": "embray"
}
```

Right now you have:


```python
if not isinstance(other, RealField_class):
    return NotImplemented
```


which I think was Jeroen's suggestion.  The reason for this is that it will delegate comparison to the class of the right-side object if it is not an instance of `RealField_class`.  So that sort of makes sense.  But I'm concerned about making that the general approach.  

For example, the tests contain:


```
    sage: RealField(10) == IntegerRing()
    False
```


which currently will work.  But why, then, isn't the same logic applied in `IntegerRing`?  Currently its `__richcmp__` is (somewhat arbitrarily?) implemented rather differently:


```python
    def __richcmp__(left, right, int op):
        """
        Rich comparison of ``left`` and ``right``.

        TESTS::

            sage: from sage.rings.integer_ring import IntegerRing_class
            sage: ZZ == ZZ
            True
            sage: ZZ != QQ
            True
        """
        if left is right:
            return rich_to_bool(op, 0)

        if isinstance(right, IntegerRing_class):
            return rich_to_bool(op, 0)

        if isinstance(right, sage.rings.rational_field.RationalField):
            return rich_to_bool(op, -1)

        return op == Py_NE
```


That sort of grew out of the old implementation of `IntegerRing_class._cmp_`, but I don't think this is really right either.  Just as in the case of `RealField_class`, this seems to mostly just care about equality (though it seems it should also return less than `RationalField`? What's that about?).

If `IntegerRing_class.__richcmp__` also contained something like `if not isinstance(right, IntegerRing_class): return NotImplemented`, and then you attempted the aforementioned comparison, instead of a boolean result you'll get a `TypeError` exception.

So my question becomes, should a class always delegate rich comparison to the other object, and if not when should it and when shouldn't it?



---

archive/issue_comments_346637.json:
```json
{
    "body": "Replying to [comment:13 embray]: \n> If `IntegerRing_class.__richcmp__` also contained something like `if not isinstance(right, IntegerRing_class): return NotImplemented`, and then you attempted the aforementioned comparison, instead of a boolean result you'll get a `TypeError` exception.\n\n\nI'm sorry, I was wrong here (though I cannot for the life of me find where this is actually documented).  If both `a.__eq__(b)` and `b.__eq__(a)` return `NotImplemented`, then Python falls back on the default comparison which is by `id()`.  I think that's also the case (in reverse) for `__ne__`.  It's only in the case of the ordering operators where it raises `TypeError`.\n\nI think that clarifies things for me then.  We should probably change `IntegerRing_class.__richcmp__` to be more consistent, but this is fine as is.\n\nEvery time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.",
    "created_at": "2018-03-13T12:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346637",
    "user": "embray"
}
```

Replying to [comment:13 embray]: 
> If `IntegerRing_class.__richcmp__` also contained something like `if not isinstance(right, IntegerRing_class): return NotImplemented`, and then you attempted the aforementioned comparison, instead of a boolean result you'll get a `TypeError` exception.


I'm sorry, I was wrong here (though I cannot for the life of me find where this is actually documented).  If both `a.__eq__(b)` and `b.__eq__(a)` return `NotImplemented`, then Python falls back on the default comparison which is by `id()`.  I think that's also the case (in reverse) for `__ne__`.  It's only in the case of the ordering operators where it raises `TypeError`.

I think that clarifies things for me then.  We should probably change `IntegerRing_class.__richcmp__` to be more consistent, but this is fine as is.

Every time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.



---

archive/issue_comments_346638.json:
```json
{
    "body": "so, positive review ?",
    "created_at": "2018-03-13T12:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346638",
    "user": "chapoton"
}
```

so, positive review ?



---

archive/issue_comments_346639.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> Every time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.\n\nMaybe it's also because it works quite different in Python 2 and Python 3?",
    "created_at": "2018-03-13T13:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346639",
    "user": "jdemeyer"
}
```

Replying to [comment:14 embray]:
> Every time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.

Maybe it's also because it works quite different in Python 2 and Python 3?



---

archive/issue_comments_346640.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-13T13:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346640",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_346641.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> Replying to [comment:14 embray]:\n> > Every time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.\n> \n> Maybe it's also because it works quite different in Python 2 and Python 3?\n\nIt does, and it's hard to keep straight.  I thought the fallback behavior for equality, for example, was only on Python 2 (when in fact I was probably just thinking about the fallback for ordered comparisons).",
    "created_at": "2018-03-13T13:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346641",
    "user": "embray"
}
```

Replying to [comment:16 jdemeyer]:
> Replying to [comment:14 embray]:
> > Every time I think I understand Python's rich comparison it turns out I've forgotten half of what I'd learned.
> 
> Maybe it's also because it works quite different in Python 2 and Python 3?

It does, and it's hard to keep straight.  I thought the fallback behavior for equality, for example, was only on Python 2 (when in fact I was probably just thinking about the fallback for ordered comparisons).



---

archive/issue_comments_346642.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-22T19:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24694#issuecomment-346642",
    "user": "vbraun"
}
```

Resolution: fixed
