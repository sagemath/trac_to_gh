# Issue 32774: Remove __init__.py files for packages designated to be namespace packages

Issue created by migration from https://trac.sagemath.org/ticket/33011

Original creator: mkoeppe

Original creation time: 2021-12-11 04:27:50

CC:  @tobiasdiez klee




---

Comment by mkoeppe created at 2021-12-11 04:45:02

Last 10 new commits:


---

Comment by git created at 2021-12-17 07:07:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-12-17 16:39:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-17 16:43:03

Changing status from new to needs_review.


---

Comment by git created at 2022-01-23 06:26:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 05:46:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 06:05:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-02-14 06:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 07:27:05

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-03-13 09:47:33

Is this supposed to work even in incremental build?

Doing `./configure; make` with the branch, I got

```
[sagelib-9.6.beta5] ************************************************************************
[sagelib-9.6.beta5] Traceback (most recent call last):
[sagelib-9.6.beta5]   File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-standard/setup.py", line 89, in <module>
[sagelib-9.6.beta5]     from sage_setup.find import find_python_sources, is_package_or_namespace_package_dir
[sagelib-9.6.beta5] ImportError: cannot import name 'is_package_or_namespace_package_dir' from 'sage_setup.find' (/Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_setup/find.py)
```



---

Comment by klee created at 2022-03-13 10:00:33

Building from scratch (after `make distclean`) works. Sage starts with no difference. I am running tests. No problem up to now.

I checked removed `__init__.py` files. There is still `src/sage/numerical/__init__.py` file. Is this correct?

What else should I check as a user/reviewer?


---

Comment by klee created at 2022-03-13 10:17:05

A comment perhaps naive and not relevant here:

If a file like `all__sagemath_objects.py` is only to serve

```
# The presence of this file ensures that sage_setup for sagemath-objects
# considers this directory as a namespace package 
```

then a simpler name like `__namespace_package__.py` would not work?


---

Comment by klee created at 2022-03-13 11:17:33

I get these persistent doctest failures

```
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/tests/cmdline.py  # 4 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/structure/element.pyx  # 35 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/misc/cython.py  # 3 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/graphs/connectivity.pyx  # 2 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/misc/cachefunc.pyx  # 23 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/rings/tate_algebra_ideal.pyx  # 6 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/graphs/graph_decompositions/fast_digraph.pyx  # 5 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/rings/polynomial/ore_polynomial_element.pyx  # 6 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/arith/long.pxd  # 14 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/ext/memory_allocator.pxd  # 6 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/ext/memory_allocator.pyx  # 9 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t --warn-long 74.5 --random-seed=209187923013064120554478148791206188460 src/sage_setup/find.py  # 1 doctest failed
```



---

Comment by mkoeppe created at 2022-03-13 17:48:00

Replying to [comment:16 klee]:
> If a file like `all__sagemath_objects.py` is only to serve
> {{{
> # The presence of this file ensures that sage_setup for sagemath-objects
> # considers this directory as a namespace package 
> }}}
> then a simpler name like `__namespace_package__.py` would not work?

It would work, but based on discussion in #28925, I decided to use a file pattern that is already in use in the Sage sources


---

Comment by git created at 2022-03-13 17:49:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-13 17:51:10

Replying to [comment:15 klee]:
> I checked removed `__init__.py` files. There is still `src/sage/numerical/__init__.py` file. Is this correct?

Thanks for catching this! I have removed it now.


---

Comment by git created at 2022-03-13 18:27:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-13 18:28:06

Replying to [comment:14 klee]:
> Is this supposed to work even in incremental build?

I think this is fixed now by the latest commit in #28925


---

Comment by mkoeppe created at 2022-03-13 18:32:00

Replying to [comment:17 klee]:
> I get these persistent doctest failures

Thanks for testing! I cannot reproduce these failures. Maybe they have been resolved by merging the latest beta into the branch already.


---

Comment by mkoeppe created at 2022-03-13 18:34:34

Replying to [comment:15 klee]:
> What else should I check as a user/reviewer?

Nothing special really, there should be no observable change. The dependency #28925 does give some additional things that could be checked regarding the subset distributions *sagemath-objects*, *sagemath-categories*.


---

Comment by klee created at 2022-03-14 00:29:26

Replying to [comment:18 mkoeppe]:
> Replying to [comment:16 klee]:
> > If a file like `all__sagemath_objects.py` is only to serve
> > {{{
> > # The presence of this file ensures that sage_setup for sagemath-objects
> > # considers this directory as a namespace package 
> > }}}
> > then a simpler name like `__namespace_package__.py` would not work?
> 
> It would work, but based on discussion in #28925, I decided to use a file pattern that is already in use in the Sage sources

I don't find any discussion about naming there... Anyway, 

(1) Is it true that the prefix `all__` has nothing to do with the purpose of the file `all.py`?

(2) Should the name depend on the distribution package name (here `sagemath_objects`)? Then is it subject to change depending on how sage library is organized as distribution packages?


---

Comment by mkoeppe created at 2022-03-14 01:05:14

Replying to [comment:26 klee]:
> (1) Is it true that the prefix `all__` has nothing to do with the purpose of the file `all.py`?

Not true. See for example https://github.com/sagemath/sage/blob/develop/src/sage/categories/all__sagemath_objects.py, which is imported in https://github.com/sagemath/sage/blob/develop/src/sage/categories/all.py


---

Comment by mkoeppe created at 2022-03-14 01:09:40

Just the `all__sagemath_objects.py` files added in the present ticket happen to be trivial because the distribution *sagemath-objects* does not put anything from the modules that it contains in the global namespace.


---

Comment by klee created at 2022-03-14 04:24:50

Replying to [comment:27 mkoeppe]:
> Replying to [comment:26 klee]:
> > (1) Is it true that the prefix `all__` has nothing to do with the purpose of the file `all.py`?
> 
> Not true. See for example https://github.com/sagemath/sage/blob/develop/src/sage/categories/all__sagemath_objects.py, which is imported in https://github.com/sagemath/sage/blob/develop/src/sage/categories/all.py
> 

Okay. I see the idea.


---

Comment by klee created at 2022-03-14 08:28:50

With sage built with Volker's branch and #28925, I get these failures only with this branch:

```
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/tests/cmdline.py  # 4 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/misc/sagedoc.py  # 3 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/structure/element.pyx  # 35 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/misc/cachefunc.pyx  # 23 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/misc/cython.py  # 3 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/graphs/connectivity.pyx  # 2 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/rings/tate_algebra_ideal.pyx  # 6 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/graphs/graph_decompositions/fast_digraph.pyx  # 5 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/rings/polynomial/ore_polynomial_element.pyx  # 6 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/arith/long.pxd  # 14 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/ext/memory_allocator.pxd  # 6 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/ext/memory_allocator.pyx  # 9 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage_setup/find.py  # 1 doctest failed
sage -t --warn-long 63.0 --random-seed=176571558312394579781618281386824830468 src/sage/docs/conf.py  # 1 doctest failed
```



---

Comment by git created at 2022-05-30 05:18:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-07 09:02:26

With the current branch, `make distclean; make -j8; sage -tp --all` results in 

```
----------------------------------------------------------------------
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/tests/cmdline.py  # 4 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/sagedoc.py  # 3 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/structure/element.pyx  # 35 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/cython.py  # 3 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/cachefunc.pyx  # 23 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/graphs/connectivity.pyx  # 2 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/graphs/graph_decompositions/fast_digraph.pyx  # 5 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/tate_algebra_ideal.pyx  # 6 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/polynomial/ore_polynomial_element.pyx  # 6 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/ext/memory_allocator.pxd  # 6 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/ext/memory_allocator.pyx  # 9 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/arith/long.pxd  # 14 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/game_theory/normal_form_game.py  # 2 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage_setup/find.py  # 1 doctest failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/game_theory/catalog_normal_form_games.py  # 15 doctests failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage_docbuild/conf.py  # 1 doctest failed
sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/docs/conf.py  # 1 doctest failed
----------------------------------------------------------------------
```

on mac.


---

Comment by klee created at 2022-06-07 09:07:35

This comment 

```
# To build and test in the tox environment:
#
# ./sage -sh -c '(cd pkgs/sagemath-categories/src && tox -v -v -v)'   
```

in `pkgs/sagemath-categories/tox.ini` seems wrong. 

This `./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'` works though.


---

Comment by git created at 2022-06-07 17:45:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-07 19:48:35

Replying to [comment:33 klee]:
> With the current branch, `make distclean; make -j8; sage -tp --all` results in 
> {{{
> ----------------------------------------------------------------------
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/tests/cmdline.py  # 4 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/sagedoc.py  # 3 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/structure/element.pyx  # 35 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/cython.py  # 3 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/cachefunc.pyx  # 23 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/graphs/connectivity.pyx  # 2 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/graphs/graph_decompositions/fast_digraph.pyx  # 5 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/tate_algebra_ideal.pyx  # 6 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/polynomial/ore_polynomial_element.pyx  # 6 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/ext/memory_allocator.pxd  # 6 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/ext/memory_allocator.pyx  # 9 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/arith/long.pxd  # 14 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/rings/integer_fake.pxd  # 1 doctest failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/game_theory/normal_form_game.py  # 2 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage_setup/find.py  # 1 doctest failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/game_theory/catalog_normal_form_games.py  # 15 doctests failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage_docbuild/conf.py  # 1 doctest failed
> sage -t --warn-long 59.6 --random-seed=58674280218506165844967914886745987426 src/sage/docs/conf.py  # 1 doctest failed
> ----------------------------------------------------------------------
> }}}
> on mac.

Could you share the details of these failures please? I cannot reproduce them (also on mac)


---

Comment by mkoeppe created at 2022-06-07 21:23:29

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-06-07 21:23:29

OK, now I do see some failures that come from the runtime use of Cython.


---

Comment by klee created at 2022-06-08 01:43:26

Some doctest failures are caused by the failure of documentation building. Indeed I have 

```
[sagemath_doc_html-none] [graphs   ] The inventory files are in local/share/doc/sage/inventory/en/reference/graphs.
[sagemath_doc_html-none] Build finished. The built documents can be found in /Users/kwankyu/GitHub/sage-temp/local/share/doc/sage/inventory/en/reference/graphs
[sagemath_doc_html-none] Error building the documentation.
[sagemath_doc_html-none] Traceback (most recent call last):
[sagemath_doc_html-none]   File "/usr/local/Cellar/python@3.9/3.9.12/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
[sagemath_doc_html-none]     return _run_code(code, main_globals, None,
[sagemath_doc_html-none]   File "/usr/local/Cellar/python@3.9/3.9.12/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
[sagemath_doc_html-none]     exec(code, run_globals)
[sagemath_doc_html-none]   File "/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 500, in <module>
[sagemath_doc_html-none]     sys.exit(main())
[sagemath_doc_html-none]   File "/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 497, in main
[sagemath_doc_html-none]     builder()
[sagemath_doc_html-none]   File "/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/builders.py", line 814, in _wrapper
[sagemath_doc_html-none]     for module_name in self.get_new_and_updated_modules():
[sagemath_doc_html-none]   File "/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage_docbuild/builders.py", line 1014, in get_new_and_updated_modules
[sagemath_doc_html-none]     if (module_filename.endswith('.pyc') or module_filename.endswith('.pyo')):
[sagemath_doc_html-none] AttributeError: 'NoneType' object has no attribute 'endswith'
[sagemath_doc_html-none] 
[sagemath_doc_html-none]     Note: incremental documentation builds sometimes cause spurious
[sagemath_doc_html-none]     error messages. To be certain that these are real errors, run
[sagemath_doc_html-none]     "make doc-clean doc-uninstall" first and try again.
[sagemath_doc_html-none] cd /Users/kwankyu/GitHub/sage-temp && ./sage --docbuild --no-pdf-links reference/cryptography inventory --no-prune-empty-dirs
[sagemath_doc_html-none] make[6]: *** [doc-inventory--reference-categories] Error 1
[sagemath_doc_html-none] make[6]: *** Waiting for unfinished jobs....
[sagemath_doc_html-none] [asymptoti] no targets are out of date.
```

Do you have no problem in building documentation?


---

Comment by mkoeppe created at 2022-06-08 05:44:02

Now I see that too, sorry. Previously it seems I didn't clean fully


---

Comment by git created at 2022-06-08 06:02:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-08 06:02:58

Here's an attempt to fix the docbuild problem


---

Comment by git created at 2022-06-08 06:32:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-08 06:40:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-08 06:49:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-06-08 06:50:05

Rebased on updated #28925


---

Comment by mkoeppe created at 2022-06-08 07:27:01

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-06-08 09:47:01

Only this one remains:

```
sage -t --random-seed=189805995761835901272169845153382768673 src/sage_setup/find.py
Running doctests with ID 2022-06-08-18-44-23-6fbbcef6.
Using --optional=homebrew,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --warn-long 64.2 --random-seed=189805995761835901272169845153382768673 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 401, in sage_setup.find.installed_files_by_module
Failed example:
    files_by_module['sage.graphs.graph_decompositions']
Expected:
    {...'sage/graphs/graph_decompositions/__init__.py'...}
Got:
    set()
**********************************************************************
1 item had failures:
   1 of  10 in sage_setup.find.installed_files_by_module
    [49 tests, 1 failure, 1.47 s]
```



---

Comment by git created at 2022-06-08 11:24:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-08 11:32:43

Thanks for testing! Fixed now


---

Comment by klee created at 2022-06-08 12:25:06

All tests passed! Also I ran tox tests on sagemath-categories. All passed.

And then I did `pkgs/sagemath-categories/.tox/python/bin/python`, and then 

```
from sage.categories.all import *
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/Users/kwankyu/GitHub/sage-temp/pkgs/sagemath-categories/sage/categories/all.py", line 32, in <module>
    from sage.misc.lazy_import import lazy_import
ModuleNotFoundError: No module named 'sage.misc.lazy_import'
```

Perhaps I did something that I should not do. What are reasonable things to do, to test `sagemath-categories`?


---

Comment by mkoeppe created at 2022-06-08 17:43:33

This works just fine here:

```
$ ./sage -sh -c '(cd pkgs/sagemath-categories && SAGE_NUM_THREADS=16 tox -r -v -v -v -e py39)'
[...]
$ pkgs/sagemath-categories/.tox/py39/bin/python
Python 3.9.10 (v3.9.10:f2f3f53782, Jan 13 2022, 17:02:14) 
[Clang 6.0 (clang-600.0.57)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.categories.all import *
>>> 
```


Did you by any chance run this from the directory `/Users/kwankyu/GitHub/sage-temp/pkgs/sagemath-categories/`?
This won't work because by default `.` is in the front of `PYTHONPATH`. And then the directory in the source tree (`sage`), which does not contain the compiled Cython modules, shadows the installed package `sage`. 

(That's what the comment `# Beware of the treacherous non-src layout` in tox.ini refers to.)


---

Comment by klee created at 2022-06-08 19:03:57

Replying to [comment:51 mkoeppe]:
> Did you by any chance run this from the directory `/Users/kwankyu/GitHub/sage-temp/pkgs/sagemath-categories/`?

Correct.

> This won't work because by default `.` is in the front of `PYTHONPATH`. And then the directory in the source tree (`sage`), which does not contain the compiled Cython modules, shadows the installed package `sage`.

I see.  

> (That's what the comment `# Beware of the treacherous non-src layout` in tox.ini refers to.)

So this would be a common gotcha. Then why not `src` layout? Perhaps this is explained somewhere?


---

Comment by mkoeppe created at 2022-06-09 00:59:04

Replying to [comment:52 klee]:
> > (That's what the comment `# Beware of the treacherous non-src layout` in tox.ini refers to.)
> 
> So this would be a common gotcha. Then why not `src` layout? Perhaps this is explained somewhere?

As far as I can see, there is no consensus in the Python community regarding which of the two layouts should be preferred. To me, the extra `src/` is additional clutter


---

Comment by klee created at 2022-06-09 04:46:11

Replying to [comment:53 mkoeppe]: 
> > So this would be a common gotcha. Then why not `src` layout? Perhaps this is explained somewhere?
> 
> As far as I can see, there is no consensus in the Python community regarding which of the two layouts should be preferred. To me, the extra `src/` is additional clutter

Okay. Not a big deal.


---

Comment by klee created at 2022-06-09 07:52:16

I am working on a ticket on sage merged with the present ticket. When I rebuild sage by `sage -b`, I observe much bigger log, including 

```
...
...
***********************************************
[sagelib-9.7.beta1] Building interpreters for fast_callable
[sagelib-9.7.beta1] Discovering Python/Cython source code....
[sagelib-9.7.beta1] distributions = ['']
[sagelib-9.7.beta1] Discovered Python/Cython sources, time: 5.48 seconds.
[sagelib-9.7.beta1] running build
[sagelib-9.7.beta1] running build_py
[sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/numerical/backends/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/ext/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/arith/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/libs/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/libs/mpfi/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/libs/mpfr/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/libs/polybori/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/libs/mpc/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/sets/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/rings/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/graphs/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/graphs/graph_decompositions/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] copying sage/modules/free_module.py -> build/lib.macosx-12-x86_64-3.9/sage/modules
[sagelib-9.7.beta1] package init file 'sage/categories/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/matrix/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] package init file 'sage/interfaces/__init__.py' not found (or not a regular file)
[sagelib-9.7.beta1] running build_ext
[sagelib-9.7.beta1] running build_cython
[sagelib-9.7.beta1] Enabling Cython debugging support
[sagelib-9.7.beta1] Updating Cython code....
[sagelib-9.7.beta1] Compiling sage/resolutions/free.pyx because it changed.
[sagelib-9.7.beta1] [1/1] Cythonizing sage/resolutions/free.pyx
[sagelib-9.7.beta1] Finished Cythonizing, time: 6.33 seconds.
[sagelib-9.7.beta1] cythonized_files = [('sage/misc', ['./sage/misc/parser.pyx', './sage/misc/classcall_metaclass.pyx', './sage/misc/weak_dict.pyx', './sage/misc/sage_timeit_class.pyx', './sage/misc/lazy_string.pyx', './sage/misc/search.pyx', './sage/misc/c3_controlled.pyx', './sage/misc/instancedoc.pyx', './sage/misc/binary_tree.pxd', './sage/misc/reset.pyx', './sage/misc/sage_ostools.pyx', './sage/misc/function_mangling.pyx', './sage/misc/lazy_list.pyx', './sage/misc/citation.pyx', './sage/misc/nested_class.pxd', './sage/misc/fast_methods.pyx', './sage/misc/misc_c.pxd', './sage/misc/cachefunc.pyx', './sage/misc/session.pyx', './sage/misc/pickle_old.pyx', './sage/misc/allocator.pyx', './sage/misc/inherit_comparison.pxd', './sage/misc/randstate.pxd', './sage/misc/randstate.pyx', './sage/misc/inherit_comparison.pyx', './sage/misc/allocator.pxd', './sage/misc/cachefunc.pxd', './sage/misc/callable_dict.pyx', './sage/misc/fast_methods.pxd', './sage/misc/nested_class.pyx', './sage/misc/derivative.pyx', './sage/misc/misc_c.pyx', './sage/misc/lazy_attribute.pyx', './sage/misc/lazy_list.pxd', './sage/misc/function_mangling.pxd', './sage/misc/lazy_import.pyx', './sage/misc/binary_tree.pyx', './sage/misc/search.pxd', './sage/misc/c3_controlled.pxd', './sage/misc/fpickle.pyx', './sage/misc/lazy_string.pxd', './sage/misc/stopgap.pyx', './sage/misc/persist.pyx', './sage/misc/weak_dict.pxd', './sage/misc/c3.pyx', './sage/misc/constant_function.pyx', './sage/misc/classcall_metaclass.pxd']), ('sage/schemes/hyperelliptic_curves', ['./sage/schemes/hyperelliptic_curves/hypellfrob.pyx']), ('sage/schemes/elliptic_curves', ['./sage/schemes/elliptic_curves/period_lattice_region.pyx', './sage/schemes/elliptic_curves/mod_sym_num.pyx', './sage/schemes/elliptic_curves/descent_two_isogeny.pyx']), ('sage/schemes/toric', ['./sage/schemes/toric/divisor_class.pyx']), ('sage/crypto', ['./sage/crypto/boolean_function.pyx', './sage/crypto/sbox.pyx', './sage/crypto/boolean_function.pxd']), ('sage/data_structures', ['./sage/data_structures/bitset.pyx', './sage/data_structures/bounded_integer_sequences.pyx', './sage/data_structures/bitset_base.pxd', './sage/data_structures/binary_search.pyx', './sage/data_structures/blas_dict.pxd', './sage/data_structures/blas_dict.pyx', './sage/data_structures/binary_matrix.pxd', './sage/data_structures/binary_search.pxd', './sage/data_structures/sparse_bitset.pxd', './sage/data_structures/bitset_base.pyx', './sage/data_structures/bitset.pxd', './sage/data_structures/bounded_integer_sequences.pxd', 'build/cythonized/sage/data_structures/bitset_intrinsics.h']), ('sage/dynamics/complex_dynamics', ['./sage/dynamics/complex_dynamics/mandel_julia_helper.pyx']), ('sage/dynamics/arithmetic_dynamics', ['./sage/dynamics/arithmetic_dynamics/projective_ds_helper.pyx']), ('sage/probability', ['./sage/probability/probability_distribution.pyx']), ('sage/plot', ['./sage/plot/complex_plot.pyx']), ('sage/plot/plot3d', ['./sage/plot/plot3d/point_c.pxi', './sage/plot/plot3d/parametric_surface.pxd', './sage/plot/plot3d/shapes.pyx', './sage/plot/plot3d/index_face_set.pyx', './sage/plot/plot3d/base.pxd', './sage/plot/plot3d/transform.pyx', './sage/plot/plot3d/transform.pxd', './sage/plot/plot3d/base.pyx', './sage/plot/plot3d/implicit_surface.pyx', './sage/plot/plot3d/shapes.pxd', './sage/plot/plot3d/index_face_set.pxd', './sage/plot/plot3d/parametric_surface.pyx']), ('sage/combinat', ['./sage/combinat/permutation_cython.pyx
...
...
long long list of cythonized files!
...
...
[sagelib-9.7.beta1] running install_scripts
[sagelib-9.7.beta1] running egg_info
[sagelib-9.7.beta1] writing sagemath_standard.egg-info/PKG-INFO
[sagelib-9.7.beta1] writing dependency_links to sagemath_standard.egg-info/dependency_links.txt
[sagelib-9.7.beta1] writing requirements to sagemath_standard.egg-info/requires.txt
[sagelib-9.7.beta1] writing top-level names to sagemath_standard.egg-info/top_level.txt
[sagelib-9.7.beta1] reading manifest template 'MANIFEST.in'
[sagelib-9.7.beta1] warning: no files found matching '*.hh' anywhere in distribution
[sagelib-9.7.beta1] warning: no files found matching '*.inc' anywhere in distribution
[sagelib-9.7.beta1] no previously-included directories found matching '.tox'
[sagelib-9.7.beta1] no previously-included directories found matching 'sage_setup'
[sagelib-9.7.beta1] adding license file 'LICENSE.txt'
[sagelib-9.7.beta1] writing manifest file 'sagemath_standard.egg-info/SOURCES.txt'
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-startuptime.py to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-ipynb2rst to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-notebook to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-inline-fortran to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-valgrind to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-coverage to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-run to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-ipython to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-run-cython to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-grep to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-venv-config to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-rebaseall.sh to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-update-version to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-rebase.sh to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-rebaseall.bat to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/math-readline to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-env to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-list-packages to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-callgrind to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-runtests to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-rebase.bat to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-fixdoctests to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-preparse to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-python to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-cleaner to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-omega to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-massif to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-cachegrind to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-grepdoc to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-num-threads.py to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-cython to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-version.sh to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-gdb-commands to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-eval to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage to 755
[sagelib-9.7.beta1] running install_egg_info
[sagelib-9.7.beta1] removing '/Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sagemath_standard-9.7b1-py3.9.egg-info' (and everything under it)
[sagelib-9.7.beta1] Copying sagemath_standard.egg-info to /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sagemath_standard-9.7b1-py3.9.egg-info
[sagelib-9.7.beta1] - cleaning build/lib.macosx-12-x86_64-3.9
[sagelib-9.7.beta1] - cleaning /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages
[sagelib-9.7.beta1] Cleaning up stale file: /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/ext_data/nbconvert/__pycache__/postprocess.cpython-39.pyc
[sagelib-9.7.beta1] Finished cleaning, time: 0.40 seconds.
[sagelib-9.7.beta1] 
[sagelib-9.7.beta1] real	0m22.506s
[sagelib-9.7.beta1] user	0m17.144s
[sagelib-9.7.beta1] sys	0m5.558s

real	0m22.669s
user	0m17.244s
sys	0m5.624s
Sage build/upgrade complete!
```


Without this ticket, the log is comparatively short: 

```
...
...
***********************************************
[sagelib-9.7.beta1] Building interpreters for fast_callable
[sagelib-9.7.beta1] Discovering Python/Cython source code....
[sagelib-9.7.beta1] distributions = ['']
[sagelib-9.7.beta1] Discovered Python/Cython sources, time: 5.70 seconds.
[sagelib-9.7.beta1] running build
[sagelib-9.7.beta1] running build_py
[sagelib-9.7.beta1] copying sage/schemes/product_projective/space.py -> build/lib.macosx-12-x86_64-cpython-39/sage/schemes/product_projective
[sagelib-9.7.beta1] copying sage/schemes/elliptic_curves/ell_curve_isogeny.py -> build/lib.macosx-12-x86_64-cpython-39/sage/schemes/elliptic_curves
[sagelib-9.7.beta1] copying sage/schemes/plane_conics/con_field.py -> build/lib.macosx-12-x86_64-cpython-39/sage/schemes/plane_conics
[sagelib-9.7.beta1] copying sage/schemes/projective/projective_morphism.py -> build/lib.macosx-12-x86_64-cpython-39/sage/schemes/projective
[sagelib-9.7.beta1] copying sage/modules/free_module.py -> build/lib.macosx-12-x86_64-cpython-39/sage/modules
[sagelib-9.7.beta1] running build_ext
[sagelib-9.7.beta1] running build_cython
[sagelib-9.7.beta1] Enabling Cython debugging support
[sagelib-9.7.beta1] INFO: Disabling color, you really want to install colorlog.
[sagelib-9.7.beta1] Disabling color, you really want to install colorlog.
[sagelib-9.7.beta1] Compiling sage/resolutions/free.pyx because it changed.
[sagelib-9.7.beta1] [1/1] Cythonizing sage/resolutions/free.pyx
[sagelib-9.7.beta1] Executing 1 command (using 1 thread)
[sagelib-9.7.beta1] [1/1] build/cythonized/sage/resolutions/free.cpp:8891:18: warning: unused function '__pyx_pw_4sage_9structure_7element_1parent' [-Wunused-function]
[sagelib-9.7.beta1] static PyObject *__pyx_pw_4sage_9structure_7element_1parent(PyObject *__pyx_self, PyObject *__pyx_v_x) {
[sagelib-9.7.beta1]                  ^
[sagelib-9.7.beta1] build/cythonized/sage/resolutions/free.cpp:8890:13: warning: unused variable '__pyx_doc_4sage_9structure_7element_parent' [-Wunused-variable]
[sagelib-9.7.beta1] static char __pyx_doc_4sage_9structure_7element_parent[] = "parent(x)\nFile: sage/structure/element.pxd (starting at line 6)\n\n    Return the parent of the element ``x``.\n\n    Usually, this means the mathematical object of which ``x`` is an\n    element.\n\n    INPUT:\n\n    - ``x`` -- an element\n\n    OUTPUT:\n\n    - If ``x`` is a Sage :class:`Element`, return ``x.parent()``.\n\n    - Otherwise, return ``type(x)``.\n\n    .. SEEALSO::\n\n        `Parents, Conversion and Coercion <http://doc.sagemath.org/html/en/tutorial/tour_coercion.html>`_\n        Section in the Sage Tutorial\n\n    EXAMPLES::\n\n        sage: a = 42\n        sage: parent(a)\n        Integer Ring\n        sage: b = 42/1\n        sage: parent(b)\n        Rational Field\n        sage: c = 42.0\n        sage: parent(c)\n        Real Field with 53 bits of precision\n\n    Some more complicated examples::\n\n        sage: x = Partition([3,2,1,1,1])\n        sage: parent(x)\n        Partitions\n        sage: v = vector(RDF, [1,2,3])\n        sage: parent(v)\n        Vector space of dimension 3 over Real Double Field\n\n    The following are not considered to be elements, so the type is\n    returned::\n\n        sage: d = int(42)  # Python int\n        sage: parent(d)\n        <... 'int'>\n        sage: L = list(range(10))\n        sage: parent(L)\n        <... 'list'>\n    ";
[sagelib-9.7.beta1]             ^
[sagelib-9.7.beta1] build/cythonized/sage/resolutions/free.cpp:9236:18: warning: unused function '__pyx_pw_4sage_9structure_7element_3have_same_parent' [-Wunused-function]
[sagelib-9.7.beta1] static PyObject *__pyx_pw_4sage_9structure_7element_3have_same_parent(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
[sagelib-9.7.beta1]                  ^
[sagelib-9.7.beta1] build/cythonized/sage/resolutions/free.cpp:9235:13: warning: unused variable '__pyx_doc_4sage_9structure_7element_2have_same_parent' [-Wunused-variable]
[sagelib-9.7.beta1] static char __pyx_doc_4sage_9structure_7element_2have_same_parent[] = "have_same_parent(left, right) -> bool\nFile: sage/structure/element.pxd (starting at line 111)\n\n    Return ``True`` if and only if ``left`` and ``right`` have the\n    same parent.\n\n    .. WARNING::\n\n        This function assumes that at least one of the arguments is a\n        Sage :class:`Element`. When in doubt, use the slower\n        ``parent(left) is parent(right)`` instead.\n\n    EXAMPLES::\n\n        sage: from sage.structure.element import have_same_parent\n        sage: have_same_parent(1, 3)\n        True\n        sage: have_same_parent(1, 1/2)\n        False\n        sage: have_same_parent(gap(1), gap(1/2))\n        True\n\n    These have different types but the same parent::\n\n        sage: a = RLF(2)\n        sage: b = exp(a)\n        sage: type(a)\n        <... 'sage.rings.real_lazy.LazyWrapper'>\n        sage: type(b)\n        <... 'sage.rings.real_lazy.LazyNamedUnop'>\n        sage: have_same_parent(a, b)\n        True\n    ";
[sagelib-9.7.beta1]             ^
[sagelib-9.7.beta1] 4 warnings generated.
[sagelib-9.7.beta1] Time to execute 1 command: 4.20 seconds.
[sagelib-9.7.beta1] Total time spent compiling C/C++ extensions: 4.31 seconds.
[sagelib-9.7.beta1] warning: no files found matching '*.inc' anywhere in distribution
[sagelib-9.7.beta1] no previously-included directories found matching 'sage_setup'
[sagelib-9.7.beta1] Cleaning up stale file: /Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/ext_data/nbconvert/__pycache__/postprocess.cpython-39.pyc
[sagelib-9.7.beta1] 
[sagelib-9.7.beta1] real	0m26.868s
[sagelib-9.7.beta1] user	0m19.950s
[sagelib-9.7.beta1] sys	0m6.686s

real	0m27.035s
user	0m20.050s
sys	0m6.750s
Sage build/upgrade complete!
```


I think this is a regression.


---

Comment by klee created at 2022-06-09 07:55:46

It is the same if I repeat rebuilding.


---

Comment by mkoeppe created at 2022-06-09 18:58:11

Replying to [comment:55 klee]:
> When I rebuild sage by `sage -b`, I observe much bigger log, including 
> {{{
> ...
> [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> [...]
> }}}

These messages are normal output when namespace packages are in use.

> {{{
> [sagelib-9.7.beta1] cythonized_files = [('sage/misc', ['./sage/misc/parser.pyx', './sage/misc/classcall_metaclass.pyx', './sage/misc/weak_dict.pyx', './sage/misc/sage_timeit_class.pyx', './sage/misc/lazy_string.pyx', './sage/misc/search.pyx', './sage/misc/c3_controlled.pyx', > ...
> long long list of cythonized files!
> ...
> }}}
> I think this is a regression. 

I agree, this is too much verbosity


---

Comment by git created at 2022-06-09 18:58:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-09 18:58:52

Fixed via #28925


---

Comment by klee created at 2022-06-10 04:30:10

Replying to [comment:57 mkoeppe]:
> Replying to [comment:55 klee]:
> > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > {{{
> > ...
> > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > [...]
> > }}}
> 
> These messages are normal output when namespace packages are in use.

They are not very informative and look like error messages. 

These long list of `changing mode of ...`:

```
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-startuptime.py to 755
[sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-ipynb2rst to 755
...
```

is also not informative. Moreover they look redundant jobs.


---

Comment by klee created at 2022-06-10 04:56:49

Replying to [comment:60 klee]:
> Replying to [comment:57 mkoeppe]:
> > Replying to [comment:55 klee]:
> > > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > > {{{
> > > ...
> > > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > > [...]
> > > }}}
> > 
> > These messages are normal output when namespace packages are in use.
> 
> They are not very informative and look like error messages. 

Is this (googled):

  Because .. doesn’t contain an `__init__.py`, `setuptools.find_packages()` won’t find the sub-package. You must use `setuptools.find_namespace_packages()` instead or explicitly list all packages in your setup.py.

the cause of those warnings?


---

Comment by mkoeppe created at 2022-06-10 05:04:47

Replying to [comment:60 klee]:
> Replying to [comment:57 mkoeppe]:
> > Replying to [comment:55 klee]:
> > > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > > {{{
> > > ...
> > > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > > [...]
> > > }}}
> > 
> > These messages are normal output when namespace packages are in use.
> 
> They are not very informative and look like error messages. 

I agree, but this is an upstream `setuptools` concern. 

> 
> These long list of `changing mode of ...`:
> {{{
> [sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-startuptime.py to 755
> [sagelib-9.7.beta1] changing mode of /Users/kwankyu/GitHub/sage/local/var/lib/sage/venv-python3.9/bin/sage-ipynb2rst to 755
> ...
> }}}
> is also not informative. Moreover they look redundant jobs.

I think this is not new from this ticket. And it's also an upstream `setuptools` concern.


---

Comment by mkoeppe created at 2022-06-10 05:08:00

Replying to [comment:61 klee]:
> Replying to [comment:60 klee]:
> > Replying to [comment:57 mkoeppe]:
> > > Replying to [comment:55 klee]:
> > > > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > > > {{{
> > > > ...
> > > > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > > > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > > > [...]
> > > > }}}
> > > 
> > > These messages are normal output when namespace packages are in use.
> > 
> > They are not very informative and look like error messages. 
> 
> Is this (googled):
> 
>   Because .. doesn’t contain an `__init__.py`, `setuptools.find_packages()` won’t find the sub-package. You must use `setuptools.find_namespace_packages()` instead or explicitly list all packages in your setup.py.
> 
> the cause of those warnings?

No. `find_namespace_packages` lists all directories instead of only directories that have an __init__.py file. It does not change what setuptools complains about.


---

Comment by git created at 2022-07-01 01:57:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-04 03:01:09

Replying to [comment:60 klee]:
> Replying to [comment:57 mkoeppe]:
> > Replying to [comment:55 klee]:
> > > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > > {{{
> > > ...
> > > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > > [...]
> > > }}}
> > 
> > These messages are normal output when namespace packages are in use.
> 
> They are not very informative and look like error messages. 

setuptools 63.1.0 will eliminate them - https://setuptools.pypa.io/en/latest/history.html#v63-1-0


---

Comment by klee created at 2022-07-04 04:18:58

Replying to [comment:65 mkoeppe]:
> Replying to [comment:60 klee]:
> > Replying to [comment:57 mkoeppe]:
> > > Replying to [comment:55 klee]:
> > > > When I rebuild sage by `sage -b`, I observe much bigger log, including 
> > > > {{{
> > > > ...
> > > > [sagelib-9.7.beta1] package init file 'sage/misc/__init__.py' not found (or not a regular file)
> > > > [sagelib-9.7.beta1] package init file 'sage/numerical/__init__.py' not found (or not a regular file)
> > > > [...]
> > > > }}}
> > > 
> > > These messages are normal output when namespace packages are in use.
> > 
> > They are not very informative and look like error messages. 
> 
> setuptools 63.1.0 will eliminate them - https://setuptools.pypa.io/en/latest/history.html#v63-1-0

Nice! 

Those `changing mode of ...` lines are not seen any more already.


---

Comment by git created at 2022-07-11 00:26:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-07-12 04:07:20

I get 

```
sage -t --warn-long 67.8 --random-seed=272636909256794490188818216866457263419 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 406, in sage_setup.find.installed_files_by_module
Failed example:
    files_by_module['sage.graphs.graph_decompositions']
Expected:
    set()
Got:
    {'sage/graphs/graph_decompositions/__init__.py',
     'sage/graphs/graph_decompositions/__pycache__/__init__.cpython-39.pyc'}
**********************************************************************
1 item had failures:
   1 of  10 in sage_setup.find.installed_files_by_module
    [49 tests, 1 failure, 1.77 s]
----------------------------------------------------------------------
sage -t --warn-long 67.8 --random-seed=272636909256794490188818216866457263419 src/sage_setup/find.py  # 1 doctest failed
----------------------------------------------------------------------
```

There is no `__init__.py` in `src/sage/graphs/graph_decompositions`, but there is one in `local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/graph_decompositions`. Even if I delete it, it gets created when I rebuild sage by `sage -b`.

Do I need to `make distclean` first?


---

Comment by mkoeppe created at 2022-07-12 04:13:01

Hm, I guess the `__init__.py` file survives in `pkgs/sagemath-standard/build/lib.*`


---

Comment by mkoeppe created at 2022-07-12 04:15:32

`make distclean` (or just `rm -rf pkgs/sagemath-standard/build`) will solve it. Not sure if there's a good way to make it work with incremental builds


---

Comment by klee created at 2022-07-12 04:32:16

Replying to [comment:70 mkoeppe]:
> Hm, I guess the `__init__.py` file survives in `pkgs/sagemath-standard/build/lib.*`

Yes. it's there.


---

Comment by klee created at 2022-07-12 04:37:52

Replying to [comment:71 mkoeppe]:
> `make distclean` (or just `rm -rf pkgs/sagemath-standard/build`) will solve it. Not sure if there's a good way to make it work with incremental builds

I deleted the directory `pkgs/sagemath-standard/build` and did `make -j8`. This will save time, but I don't know if this is a valid way to build sage.


---

Comment by klee created at 2022-07-12 04:38:56

Replying to [comment:73 klee]:
> Replying to [comment:71 mkoeppe]:
> (or just `rm -rf pkgs/sagemath-standard/build`)

Ah, you mentioned this.


---

Comment by klee created at 2022-07-13 00:48:14

Replying to [comment:69 klee]:
> I get 
> {{{
> sage -t --warn-long 67.8 --random-seed=272636909256794490188818216866457263419 src/sage_setup/find.py
> **********************************************************************
> File "src/sage_setup/find.py", line 406, in sage_setup.find.installed_files_by_module
> Failed example:
>     files_by_module['sage.graphs.graph_decompositions']
> Expected:
>     set()
> Got:
>     {'sage/graphs/graph_decompositions/__init__.py',
>      'sage/graphs/graph_decompositions/__pycache__/__init__.cpython-39.pyc'}

How about adding a comment like 

```
     files_by_module['sage.graphs.graph_decompositions']  # make distclean if failed
```

to guide people what to do to resolve the failure?


---

Comment by git created at 2022-07-13 15:36:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-13 15:37:18

I think I found a proper solution for this


---

Comment by klee created at 2022-07-15 08:43:49

Replying to [comment:77 mkoeppe]:
> I think I found a proper solution for this

Yes. It looks good.

I have some questions. The file `sage/__init__.py` is not deleted yet here. Then can a subpackage of `sage` be a namespace package? I guess the answer is yes, but no two distribution packages can install into the namespace package. Am I right?

Is the complication of removing `sage/__init__.py` still valid?


---

Comment by klee created at 2022-07-15 10:11:14

Replying to [comment:78 klee]:
> Is the complication of removing `sage/__init__.py` still valid?

I am asking this even though I do not understand the complication (I tried to).


---

Comment by mkoeppe created at 2022-07-15 14:26:14

Replying to [comment:78 klee]:
> The file `sage/__init__.py` is not deleted yet here. Then can a subpackage of `sage` be a namespace package? I guess the answer is yes, but no two distribution packages can install into the namespace package. Am I right?

That's right.

> Is the complication of removing `sage/__init__.py` still valid?

Yes, I've opened #34187 for it


---

Comment by klee created at 2022-07-15 14:58:09

I think sage is now ready to get this in.


---

Comment by klee created at 2022-07-15 14:58:09

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-07-15 15:34:48

Thank you!


---

Comment by vbraun created at 2022-07-21 21:12:13

Resolution: fixed
