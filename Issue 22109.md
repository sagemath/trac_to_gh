# Issue 22109: FormalSum should work with non-comparable values

archive/issues_022109.json:
```json
{
    "body": "Keywords: python3, richcmp\n\n`FormalSum` sorts its entries, which is not guaranteed to work, especially on Python 3.\n\n```\nsage: from sage.structure.richcmp import *\nsage: @richcmp_method\n....: class NoCmp(object):\n....:     def __richcmp__(self, other, op):\n....:         if op not in (op_EQ, op_NE):\n....:             raise RuntimeError\nsage: nc = NoCmp()\nsage: FormalSum([(1,nc), (1,1)])\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-23-33e7842a248f> in <module>()\n----> 1 FormalSum([(Integer(1),nc), (Integer(1),Integer(1))])\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/formal_sum.pyc in __init__(self, x, parent, check, reduce)\n    132         assert isinstance(parent, parent.category().parent_class)\n    133         if reduce:  # first reduce\n--> 134             self.reduce()\n    135         if check:   # then check\n    136             k = parent.base_ring()\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/formal_sum.pyc in reduce(self)\n    302             self._data = v\n    303             return\n--> 304         v.sort()\n    305         w = []\n    306         last = v[0][0]\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7887)()\n    961             c = mpz_cmp_d((<Integer>left).value, d)\n    962         else:\n--> 963             return coercion_model.richcmp(left, right, op)\n    964 \n    965         return rich_to_bool_sgn(op, c)\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:20648)()\n   1957         # we would end up trying the same coercion again.\n   1958         if not y_is_Element and Py_TYPE(y).tp_richcompare:\n-> 1959             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))\n   1960             if res is not NotImplemented:\n   1961                 return res\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/richcmp.pyx in sage.structure.richcmp.slot_tp_richcompare (build/cythonized/sage/structure/richcmp.c:1768)()\n    271     Function to put in the ``tp_richcompare`` slot.\n    272     \"\"\"\n--> 273     return self.__richcmp__(other, op)\n    274 \n    275 \n\n<ipython-input-19-9d5470810a1a> in __richcmp__(self, other, op)\n      3     def __richcmp__(self, other, op):\n      4         if op not in (op_EQ, op_NE):\n----> 5             raise RuntimeError\n      6 \n\nRuntimeError:\n```\n\nTo fix this, we do not sort the terms in `reduce()`. Instead, we keep the existing ordering.\n\nThis requires adding a few straightforward `__hash__` functions in `modular`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22346\n\n",
    "closed_at": "2018-12-27T16:04:06Z",
    "created_at": "2017-02-10T14:53:02Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "FormalSum should work with non-comparable values",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22109",
    "user": "https://github.com/jdemeyer"
}
```
Keywords: python3, richcmp

`FormalSum` sorts its entries, which is not guaranteed to work, especially on Python 3.

```
sage: from sage.structure.richcmp import *
sage: @richcmp_method
....: class NoCmp(object):
....:     def __richcmp__(self, other, op):
....:         if op not in (op_EQ, op_NE):
....:             raise RuntimeError
sage: nc = NoCmp()
sage: FormalSum([(1,nc), (1,1)])
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-23-33e7842a248f> in <module>()
----> 1 FormalSum([(Integer(1),nc), (Integer(1),Integer(1))])

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/formal_sum.pyc in __init__(self, x, parent, check, reduce)
    132         assert isinstance(parent, parent.category().parent_class)
    133         if reduce:  # first reduce
--> 134             self.reduce()
    135         if check:   # then check
    136             k = parent.base_ring()

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/formal_sum.pyc in reduce(self)
    302             self._data = v
    303             return
--> 304         v.sort()
    305         w = []
    306         last = v[0][0]

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7887)()
    961             c = mpz_cmp_d((<Integer>left).value, d)
    962         else:
--> 963             return coercion_model.richcmp(left, right, op)
    964 
    965         return rich_to_bool_sgn(op, c)

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:20648)()
   1957         # we would end up trying the same coercion again.
   1958         if not y_is_Element and Py_TYPE(y).tp_richcompare:
-> 1959             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))
   1960             if res is not NotImplemented:
   1961                 return res

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/structure/richcmp.pyx in sage.structure.richcmp.slot_tp_richcompare (build/cythonized/sage/structure/richcmp.c:1768)()
    271     Function to put in the ``tp_richcompare`` slot.
    272     """
--> 273     return self.__richcmp__(other, op)
    274 
    275 

<ipython-input-19-9d5470810a1a> in __richcmp__(self, other, op)
      3     def __richcmp__(self, other, op):
      4         if op not in (op_EQ, op_NE):
----> 5             raise RuntimeError
      6 

RuntimeError:
```

To fix this, we do not sort the terms in `reduce()`. Instead, we keep the existing ordering.

This requires adding a few straightforward `__hash__` functions in `modular`.

Issue created by migration from https://trac.sagemath.org/ticket/22346





---

archive/issue_comments_306774.json:
```json
{
    "body": "Changing keywords from \"\" to \"richcmp\".",
    "created_at": "2018-03-29T12:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306774",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "richcmp".



---

archive/issue_events_058546.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-03-29T13:40:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22109#event-58546"
}
```



---

archive/issue_comments_306775.json:
```json
{
    "body": "Changing keywords from \"richcmp\" to \"python3, richcmp\".",
    "created_at": "2018-07-11T15:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306775",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "richcmp" to "python3, richcmp".



---

archive/issue_comments_306776.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-22T23:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306776",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_306777.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-22T23:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306777",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_306778.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-23T06:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306778",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306779.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-27T16:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22109#issuecomment-306779",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_058547.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-27T16:04:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22109#event-58547"
}
```



---

archive/issue_events_058548.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T13:56:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22109#event-58548"
}
```



---

archive/issue_events_058549.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T13:56:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/22109",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22109#event-58549"
}
```
