# Issue 12722: Add classcall setter in ClasscallMetaclass

archive/issues_012722.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @hivert simonking\n\nKeywords: classcall UniqueRepresentation\n\nThe optimization of ClasscallMetaclass in #12808 prevents dynamically changing the __classcall__ method of a class. This followup adds an appropriate setter to enable this feature.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12894\n\n",
    "created_at": "2012-05-01T21:33:20Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "Add classcall setter in ClasscallMetaclass",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12722",
    "user": "https://github.com/nthiery"
}
```
Assignee: @jasongrout

CC:  @hivert simonking

Keywords: classcall UniqueRepresentation

The optimization of ClasscallMetaclass in #12808 prevents dynamically changing the __classcall__ method of a class. This followup adds an appropriate setter to enable this feature.

Issue created by migration from https://trac.sagemath.org/ticket/12894





---

archive/issue_comments_152160.json:
```json
{
    "body": "Is it ready for review, yet?",
    "created_at": "2012-05-03T13:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152160",
    "user": "https://github.com/simon-king-jena"
}
```

Is it ready for review, yet?



---

archive/issue_comments_152161.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-03T13:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152161",
    "user": "https://github.com/nthiery"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_152162.json:
```json
{
    "body": "Replying to [comment:1 SimonKing]:\n> Is it ready for review, yet?\n\n\nI was just hesitant whether we wanted to aim (in the long run) for one setter for each special method (set_classcall, set_classget, ...), or a single setter for all of them (and in that case what name we want for this setter).\n\nOther than that, yes, needs review!",
    "created_at": "2012-05-03T13:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152162",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:1 SimonKing]:
> Is it ready for review, yet?


I was just hesitant whether we wanted to aim (in the long run) for one setter for each special method (set_classcall, set_classget, ...), or a single setter for all of them (and in that case what name we want for this setter).

Other than that, yes, needs review!



---

archive/issue_comments_152163.json:
```json
{
    "body": "Hi Nicolas,\n\nThanks for this one. I've a request: You should describe the input of\n`_set_classcall__` saying that the function must accept the class itself\nat first argument. I'll try to post a review patch.\n\nI'm also w little worried about the interface: Alternatively we could either\n\n- make the attribute `classcall` public (maybe by renaming it with\n  underscores (I mistyped underscare at first ;-)).\n\n- or use a property to have a real setter allowing to a nicer syntax. I'm\n  pretty sure Cython allows ot too. \n\nFlorent",
    "created_at": "2012-05-05T11:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152163",
    "user": "https://github.com/hivert"
}
```

Hi Nicolas,

Thanks for this one. I've a request: You should describe the input of
`_set_classcall__` saying that the function must accept the class itself
at first argument. I'll try to post a review patch.

I'm also w little worried about the interface: Alternatively we could either

- make the attribute `classcall` public (maybe by renaming it with
  underscores (I mistyped underscare at first ;-)).

- or use a property to have a real setter allowing to a nicer syntax. I'm
  pretty sure Cython allows ot too. 

Florent



---

archive/issue_comments_152164.json:
```json
{
    "body": "Replying to [comment:3 hivert]:\n> I'm also w little worried about the interface: Alternatively we could either\n> \n> - make the attribute `classcall` public (maybe by renaming it with\n>   underscores (I mistyped underscare at first ;-)).\n> \n> - or use a property to have a real setter allowing to a nicer syntax. I'm\n>   pretty sure Cython allows ot too. \n\n\nNicolas: any idea about that ?\n\nFlorent",
    "created_at": "2013-01-30T15:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152164",
    "user": "https://github.com/hivert"
}
```

Replying to [comment:3 hivert]:
> I'm also w little worried about the interface: Alternatively we could either
> 
> - make the attribute `classcall` public (maybe by renaming it with
>   underscores (I mistyped underscare at first ;-)).
> 
> - or use a property to have a real setter allowing to a nicer syntax. I'm
>   pretty sure Cython allows ot too. 


Nicolas: any idea about that ?

Florent



---

archive/issue_comments_152165.json:
```json
{
    "body": "Replying to [comment:4 hivert]:\n> Replying to [comment:3 hivert]:\n> > I'm also w little worried about the interface: Alternatively we could either\n> > \n> > - make the attribute `classcall` public (maybe by renaming it with\n> >   underscores (I mistyped underscare at first ;-)).\n> > \n> > - or use a property to have a real setter allowing to a nicer syntax. I'm\n> >   pretty sure Cython allows ot too. \n \n> \n> Nicolas: any idea about that ?\n\n\nOops, I let that ticket die, whereas I need it soon in Sage for the\nfunctorial constructions. Thanks for the reminder!\n\nIf the property approach can be made to work, it sounds like the one\nthat encapsulates best the details of the caching of the resolution of\nclasscall. So I vote for it. Does it look feasible?\n\nCheers,\n                              Nicolas",
    "created_at": "2013-01-30T16:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152165",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:4 hivert]:
> Replying to [comment:3 hivert]:
> > I'm also w little worried about the interface: Alternatively we could either
> > 
> > - make the attribute `classcall` public (maybe by renaming it with
> >   underscores (I mistyped underscare at first ;-)).
> > 
> > - or use a property to have a real setter allowing to a nicer syntax. I'm
> >   pretty sure Cython allows ot too. 
 
> 
> Nicolas: any idea about that ?


Oops, I let that ticket die, whereas I need it soon in Sage for the
functorial constructions. Thanks for the reminder!

If the property approach can be made to work, it sounds like the one
that encapsulates best the details of the caching of the resolution of
classcall. So I vote for it. Does it look feasible?

Cheers,
                              Nicolas



---

archive/issue_comments_152166.json:
```json
{
    "body": "Replying to [comment:5 nthiery]:\n> Oops, I let that ticket die, whereas I need it soon in Sage for the\n> functorial constructions. Thanks for the reminder!\n> \n> If the property approach can be made to work, it sounds like the one\n> that encapsulates best the details of the caching of the resolution of\n> classcall. So I vote for it. Does it look feasible?\n\n\nSee: http://docs.cython.org/src/userguide/extension_types.html#properties\n\nWe just need to check that we have a sufficiently recent Cython in Sage and\nthat this doesn't induce some unacceptable overhead.\n\nCheers,\n\nFlorent",
    "created_at": "2013-01-30T16:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152166",
    "user": "https://github.com/hivert"
}
```

Replying to [comment:5 nthiery]:
> Oops, I let that ticket die, whereas I need it soon in Sage for the
> functorial constructions. Thanks for the reminder!
> 
> If the property approach can be made to work, it sounds like the one
> that encapsulates best the details of the caching of the resolution of
> classcall. So I vote for it. Does it look feasible?


See: http://docs.cython.org/src/userguide/extension_types.html#properties

We just need to check that we have a sufficiently recent Cython in Sage and
that this doesn't induce some unacceptable overhead.

Cheers,

Florent



---

archive/issue_comments_152167.json:
```json
{
    "body": "Replying to [comment:6 hivert]:\n> Replying to [comment:5 nthiery]:\n> > Oops, I let that ticket die, whereas I need it soon in Sage for the\n> > functorial constructions. Thanks for the reminder!\n> > \n> > If the property approach can be made to work, it sounds like the one\n> > that encapsulates best the details of the caching of the resolution of\n> > classcall. So I vote for it. Does it look feasible?\n  \n> \n> See: http://docs.cython.org/src/userguide/extension_types.html#properties\n> \n> We just need to check that we have a sufficiently recent Cython in Sage and\n> that this doesn't induce some unacceptable overhead.\n\n\nI just looked at this, and it seems we can't make this approach work:\nIndeed, even if we define __classcall__ as a property in\nClasscallMetaclass, any class C which will implement its own\n__classcall__ will overwrite the property. But then,\nC.__classcall__ = ... won't work ...\n\nSo at this point I'd go with just the _set_classcall approach, unless you see a way out.",
    "created_at": "2013-03-26T22:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152167",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:6 hivert]:
> Replying to [comment:5 nthiery]:
> > Oops, I let that ticket die, whereas I need it soon in Sage for the
> > functorial constructions. Thanks for the reminder!
> > 
> > If the property approach can be made to work, it sounds like the one
> > that encapsulates best the details of the caching of the resolution of
> > classcall. So I vote for it. Does it look feasible?
  
> 
> See: http://docs.cython.org/src/userguide/extension_types.html#properties
> 
> We just need to check that we have a sufficiently recent Cython in Sage and
> that this doesn't induce some unacceptable overhead.


I just looked at this, and it seems we can't make this approach work:
Indeed, even if we define __classcall__ as a property in
ClasscallMetaclass, any class C which will implement its own
__classcall__ will overwrite the property. But then,
C.__classcall__ = ... won't work ...

So at this point I'd go with just the _set_classcall approach, unless you see a way out.



---

archive/issue_comments_152168.json:
```json
{
    "body": "Updated patch which uses ``cls`` rather than ``self`` for the first argument of _set_classcall. The interface is not perfect, but that's an internal method and we can change this later on if we get a better idea.",
    "created_at": "2013-03-26T22:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152168",
    "user": "https://github.com/nthiery"
}
```

Updated patch which uses ``cls`` rather than ``self`` for the first argument of _set_classcall. The interface is not perfect, but that's an internal method and we can change this later on if we get a better idea.



---

archive/issue_comments_152169.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-25T14:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152169",
    "user": "https://github.com/hivert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_152170.json:
```json
{
    "body": "Attachment [trac_12894-classcall_setter-nt.patch](tarball://root/attachments/some-uuid/ticket12894/trac_12894-classcall_setter-nt.patch) by @hivert created at 2013-04-25 14:52:30",
    "created_at": "2013-04-25T14:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152170",
    "user": "https://github.com/hivert"
}
```

Attachment [trac_12894-classcall_setter-nt.patch](tarball://root/attachments/some-uuid/ticket12894/trac_12894-classcall_setter-nt.patch) by @hivert created at 2013-04-25 14:52:30



---

archive/issue_comments_152171.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-30T09:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12722#issuecomment-152171",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_035224.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-30T09:38:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12722",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12722#event-35224"
}
```
