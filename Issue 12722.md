# Issue 12722: Add classcall setter in ClasscallMetaclass

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2012-05-01 21:33:20

Assignee: jason

CC:  hivert simonking

Keywords: classcall UniqueRepresentation

The optimization of ClasscallMetaclass in #12808 prevents dynamically changing the __classcall__ method of a class. This followup adds an appropriate setter to enable this feature.


---

Comment by SimonKing created at 2012-05-03 13:41:52

Is it ready for review, yet?


---

Comment by nthiery created at 2012-05-03 13:52:12

Changing status from new to needs_review.


---

Comment by nthiery created at 2012-05-03 13:52:12

Replying to [comment:1 SimonKing]:
> Is it ready for review, yet?

I was just hesitant whether we wanted to aim (in the long run) for one setter for each special method (set_classcall, set_classget, ...), or a single setter for all of them (and in that case what name we want for this setter).

Other than that, yes, needs review!


---

Comment by hivert created at 2012-05-05 11:07:02

Hi Nicolas,

Thanks for this one. I've a request: You should describe the input of
`_set_classcall__` saying that the function must accept the class itself
at first argument. I'll try to post a review patch.

I'm also w little worried about the interface: Alternatively we could either

- make the attribute `classcall` public (maybe by renaming it with
  underscores (I mistyped underscare at first ;-)).

- or use a property to have a real setter allowing to a nicer syntax. I'm
  pretty sure Cython allows ot too. 

Florent


---

Comment by hivert created at 2013-01-30 15:06:39

Replying to [comment:3 hivert]:
> I'm also w little worried about the interface: Alternatively we could either
> 
> - make the attribute `classcall` public (maybe by renaming it with
>   underscores (I mistyped underscare at first ;-)).
> 
> - or use a property to have a real setter allowing to a nicer syntax. I'm
>   pretty sure Cython allows ot too. 

Nicolas: any idea about that ?

Florent


---

Comment by nthiery created at 2013-01-30 16:09:44

Replying to [comment:4 hivert]:
> Replying to [comment:3 hivert]:
> > I'm also w little worried about the interface: Alternatively we could either
> > 
> > - make the attribute `classcall` public (maybe by renaming it with
> >   underscores (I mistyped underscare at first ;-)).
> > 
> > - or use a property to have a real setter allowing to a nicer syntax. I'm
> >   pretty sure Cython allows ot too. 
> 
> Nicolas: any idea about that ?

Oops, I let that ticket die, whereas I need it soon in Sage for the
functorial constructions. Thanks for the reminder!

If the property approach can be made to work, it sounds like the one
that encapsulates best the details of the caching of the resolution of
classcall. So I vote for it. Does it look feasible?

Cheers,
                              Nicolas


---

Comment by hivert created at 2013-01-30 16:15:44

Replying to [comment:5 nthiery]:
> Oops, I let that ticket die, whereas I need it soon in Sage for the
> functorial constructions. Thanks for the reminder!
> 
> If the property approach can be made to work, it sounds like the one
> that encapsulates best the details of the caching of the resolution of
> classcall. So I vote for it. Does it look feasible?

See: http://docs.cython.org/src/userguide/extension_types.html#properties

We just need to check that we have a sufficiently recent Cython in Sage and
that this doesn't induce some unacceptable overhead.

Cheers,

Florent


---

Comment by nthiery created at 2013-03-26 22:48:57

Replying to [comment:6 hivert]:
> Replying to [comment:5 nthiery]:
> > Oops, I let that ticket die, whereas I need it soon in Sage for the
> > functorial constructions. Thanks for the reminder!
> > 
> > If the property approach can be made to work, it sounds like the one
> > that encapsulates best the details of the caching of the resolution of
> > classcall. So I vote for it. Does it look feasible?
> 
> See: http://docs.cython.org/src/userguide/extension_types.html#properties
> 
> We just need to check that we have a sufficiently recent Cython in Sage and
> that this doesn't induce some unacceptable overhead.

I just looked at this, and it seems we can't make this approach work:
Indeed, even if we define __classcall__ as a property in
ClasscallMetaclass, any class C which will implement its own
__classcall__ will overwrite the property. But then,
C.__classcall__ = ... won't work ...

So at this point I'd go with just the _set_classcall approach, unless you see a way out.


---

Comment by nthiery created at 2013-03-26 22:54:18

Updated patch which uses ``cls`` rather than ``self`` for the first argument of _set_classcall. The interface is not perfect, but that's an internal method and we can change this later on if we get a better idea.


---

Comment by hivert created at 2013-04-25 14:52:30

Changing status from needs_review to positive_review.


---

Attachment


---

Comment by jdemeyer created at 2013-04-30 09:38:27

Resolution: fixed
