# Issue 29885: Fix maxima/ecl unicode handling

archive/issues_029885.json:
```json
{
    "body": "CC:  @mwageringel @nbruin @dimpase @spaghettisalat\n\nFollow-up from #30106, where the following was observed:\n\n```\nsage: var('\u03be')._maxima_()\n....: \n<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_\u03be to a base-string>\n```\n\nThe above error is due to a bug in ECL 16.1.2 and 20.4.24:\n\n```\n> (princ-to-string '\u03be)\n\"\u039e\"\n> (setf local-table (copy-readtable nil))\n> (setf (readtable-case local-table) :invert)\n> :INVERT\n> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\nCannot coerce string \u039e to a base-string\n```\n\nThe above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30122\n\n",
    "created_at": "2020-07-12T16:20:19Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Fix maxima/ecl unicode handling",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29885",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @mwageringel @nbruin @dimpase @spaghettisalat

Follow-up from #30106, where the following was observed:

```
sage: var('ξ')._maxima_()
....: 
<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_ξ to a base-string>
```

The above error is due to a bug in ECL 16.1.2 and 20.4.24:

```
> (princ-to-string 'ξ)
"Ξ"
> (setf local-table (copy-readtable nil))
> (setf (readtable-case local-table) :invert)
> :INVERT
> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'ξ))
Cannot coerce string Ξ to a base-string
```

The above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.

Issue created by migration from https://trac.sagemath.org/ticket/30122





---

archive/issue_comments_424023.json:
```json
{
    "body": "The patches are commits from the ECL `develop` branch. I have cherry-picked them to https://github.com/mkoeppe/ecl/tree/20.4.24%2Bsage\n----\nLast 10 new commits:",
    "created_at": "2020-07-13T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424023",
    "user": "https://github.com/mkoeppe"
}
```

The patches are commits from the ECL `develop` branch. I have cherry-picked them to https://github.com/mkoeppe/ecl/tree/20.4.24%2Bsage
----
Last 10 new commits:



---

archive/issue_comments_424024.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-13T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424024",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_424025.json:
```json
{
    "body": "\n```\nsage: var('\u03be')._maxima_()\n_SAGE_VAR_\u03be\n```\n",
    "created_at": "2020-07-13T16:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424025",
    "user": "https://github.com/mkoeppe"
}
```


```
sage: var('ξ')._maxima_()
_SAGE_VAR_ξ
```




---

archive/issue_comments_424026.json:
```json
{
    "body": "This is great. As far as I can tell, this works correctly now. We should add a doctest, but otherwise this looks good to me.\n\nSomewhat surprisingly, this also seems to fix the conversion to Giac:\n\n```\nsage: var('\u03b1')._giac_()\nN1     # before\n\u03b1      # after\n```\n\nbut there is another issue with the Giac interface, for which I have opened #30133.",
    "created_at": "2020-07-13T18:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424026",
    "user": "https://github.com/mwageringel"
}
```

This is great. As far as I can tell, this works correctly now. We should add a doctest, but otherwise this looks good to me.

Somewhat surprisingly, this also seems to fix the conversion to Giac:

```
sage: var('α')._giac_()
N1     # before
α      # after
```

but there is another issue with the Giac interface, for which I have opened #30133.



---

archive/issue_comments_424027.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-13T18:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424027",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_424028.json:
```json
{
    "body": "Replying to [comment:9 gh-mwageringel]:\n> Somewhat surprisingly, this also seems to fix the conversion to Giac\n\nYes, everything depends on everything in Sage",
    "created_at": "2020-07-13T18:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424028",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:9 gh-mwageringel]:
> Somewhat surprisingly, this also seems to fix the conversion to Giac

Yes, everything depends on everything in Sage



---

archive/issue_comments_424029.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-13T19:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424029",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_424030.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-07-13T19:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424030",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_424031.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-25T22:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29885#issuecomment-424031",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_027530.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-07-25T22:50:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29885",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29885#event-27530"
}
```
