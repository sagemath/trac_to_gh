# Issue 29885: Fix maxima/ecl unicode handling

Issue created by migration from https://trac.sagemath.org/ticket/30122

Original creator: mkoeppe

Original creation time: 2020-07-12 16:20:19

CC:  @mwageringel nbruin dimpase @spaghettisalat

Follow-up from #30106, where the following was observed:

```
sage: var('ξ')._maxima_()
....: 
<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_ξ to a base-string>
```

The above error is due to a bug in ECL 16.1.2 and 20.4.24:

```
> (princ-to-string 'ξ)
"Ξ"
> (setf local-table (copy-readtable nil))
> (setf (readtable-case local-table) :invert)
> :INVERT
> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'ξ))
Cannot coerce string Ξ to a base-string
```

The above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.


---

Comment by mkoeppe created at 2020-07-13 16:03:58

The patches are commits from the ECL `develop` branch. I have cherry-picked them to https://github.com/mkoeppe/ecl/tree/20.4.24%2Bsage
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-07-13 16:18:22

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-13 16:41:22


```
sage: var('ξ')._maxima_()
_SAGE_VAR_ξ
```



---

Comment by @mwageringel created at 2020-07-13 18:32:20

This is great. As far as I can tell, this works correctly now. We should add a doctest, but otherwise this looks good to me.

Somewhat surprisingly, this also seems to fix the conversion to Giac:

```
sage: var('α')._giac_()
N1     # before
α      # after
```

but there is another issue with the Giac interface, for which I have opened #30133.


---

Comment by git created at 2020-07-13 18:37:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-13 18:37:59

Replying to [comment:9 gh-mwageringel]:
> Somewhat surprisingly, this also seems to fix the conversion to Giac

Yes, everything depends on everything in Sage


---

Comment by @mwageringel created at 2020-07-13 19:25:24

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-13 19:39:32

Thanks!


---

Comment by vbraun created at 2020-07-25 22:50:59

Resolution: fixed
