# Issue 32464: sage.rings.{real,complex}_double: Remove compile time dependency on cypari2

archive/issues_032464.json:
```json
{
    "body": "CC:  @kliem vdelecroix tscrim lorenz\n\n... like done in #30022\n\nIssue created by migration from https://trac.sagemath.org/ticket/32701\n\n",
    "created_at": "2021-10-16T03:20:55Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "title": "sage.rings.{real,complex}_double: Remove compile time dependency on cypari2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32464",
    "user": "mkoeppe"
}
```
CC:  @kliem vdelecroix tscrim lorenz

... like done in #30022

Issue created by migration from https://trac.sagemath.org/ticket/32701





---

archive/issue_comments_463112.json:
```json
{
    "body": "Here's an attempt but I'm getting doctest errors:\n\n```\nsage -t --random-seed=0 src/sage/rings/polynomial/polynomial_element.pyx\n      File \"sage/rings/complex_double.pyx\", line 387, in sage.rings.complex_double.ComplexDoubleField_class._element_constructor_ (build/cythonized/sage/rings/complex_double.c:6109)\n        return ComplexDoubleElement(x, 0)\n      File \"sage/rings/complex_double.pyx\", line 755, in sage.rings.complex_double.ComplexDoubleElement.__init__ (build/cythonized/sage/rings/complex_double.c:9194)\n        self._complex = gsl_complex_rect(real, imag)\n      File \"cypari2/gen.pyx\", line 2002, in cypari2.gen.Gen.__float__\n      File \"cypari2/handle_error.pyx\", line 213, in cypari2.handle_error._pari_err_handle\n    cypari2.handle_error.PariError: incorrect type in gtodouble [t_REAL expected] (t_COMPLEX)\n```\n\n----\nNew commits:",
    "created_at": "2021-10-22T01:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463112",
    "user": "mkoeppe"
}
```

Here's an attempt but I'm getting doctest errors:

```
sage -t --random-seed=0 src/sage/rings/polynomial/polynomial_element.pyx
      File "sage/rings/complex_double.pyx", line 387, in sage.rings.complex_double.ComplexDoubleField_class._element_constructor_ (build/cythonized/sage/rings/complex_double.c:6109)
        return ComplexDoubleElement(x, 0)
      File "sage/rings/complex_double.pyx", line 755, in sage.rings.complex_double.ComplexDoubleElement.__init__ (build/cythonized/sage/rings/complex_double.c:9194)
        self._complex = gsl_complex_rect(real, imag)
      File "cypari2/gen.pyx", line 2002, in cypari2.gen.Gen.__float__
      File "cypari2/handle_error.pyx", line 213, in cypari2.handle_error._pari_err_handle
    cypari2.handle_error.PariError: incorrect type in gtodouble [t_REAL expected] (t_COMPLEX)
```

----
New commits:



---

archive/issue_comments_463113.json:
```json
{
    "body": "Checking the most obvious thing helped:\n\n```\nsage: from sage.rings.complex_double import pari_gen\nsage: pari_gen\n()\n```\n\n----\nNew commits:",
    "created_at": "2021-10-25T10:32:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463113",
    "user": "@kliem"
}
```

Checking the most obvious thing helped:

```
sage: from sage.rings.complex_double import pari_gen
sage: pari_gen
()
```

----
New commits:



---

archive/issue_comments_463114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-25T13:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463114",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463115.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-25T13:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463115",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463116.json:
```json
{
    "body": "Thank you! Let's wait for the patchbot",
    "created_at": "2021-10-25T15:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463116",
    "user": "mkoeppe"
}
```

Thank you! Let's wait for the patchbot



---

archive/issue_comments_463117.json:
```json
{
    "body": "Testing locally, I am seeing:\n\n```\n[sagelib-9.5.beta4] warning: sage/libs/pari/convert_sage_complex_double.pxd:4:44: Declarations should not be declared inline.\n[sagelib-9.5.beta4] warning: sage/libs/pari/convert_sage_complex_double.pyx:9:6: Function 'pari_to_cdf' previously declared as 'cpdef'\n```\n",
    "created_at": "2021-10-25T21:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463117",
    "user": "mkoeppe"
}
```

Testing locally, I am seeing:

```
[sagelib-9.5.beta4] warning: sage/libs/pari/convert_sage_complex_double.pxd:4:44: Declarations should not be declared inline.
[sagelib-9.5.beta4] warning: sage/libs/pari/convert_sage_complex_double.pyx:9:6: Function 'pari_to_cdf' previously declared as 'cpdef'
```




---

archive/issue_comments_463118.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-25T22:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463118",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463119.json:
```json
{
    "body": "I think this requires some checking for speed regressions because the function is both no longer `inline` nor `cimport`-ed, and I could see this being used in a tight loop.",
    "created_at": "2021-10-26T05:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463119",
    "user": "tscrim"
}
```

I think this requires some checking for speed regressions because the function is both no longer `inline` nor `cimport`-ed, and I could see this being used in a tight loop.



---

archive/issue_comments_463120.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> I think this requires some checking for speed regressions because the function is both no longer `inline` nor `cimport`-ed, and I could see this being used in a tight loop.\n\nThings get about 1\u00b5s slower:\n\nBefore:\n\n\n```\nsage: a = CDF(1,2)\nsage: %timeit a.__pari__()\n199 ns \u00b1 0.214 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit CDF(p)\n310 ns \u00b1 0.827 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: b = RDF(1.3)\nsage: %timeit b.__pari__()\n160 ns \u00b1 0.128 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: p = b.__pari__()\nsage: %timeit RDF(p)\n174 ns \u00b1 2.06 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: %timeit a.eta()\n7.99 \u00b5s \u00b1 12.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each) \nsage: %timeit a.dilog()\n46.2 \u00b5s \u00b1 64.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit a.gamma()\n33.5 \u00b5s \u00b1 59.2 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit a.zeta()\n74.4 \u00b5s \u00b1 726 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nAfter:\n\n\n```\nsage: a = CDF(1,2)\nsage: %timeit a.__pari__()\n736 ns \u00b1 0.283 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit CDF(p)\n327 ns \u00b1 0.544 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: b = RDF(1.3)\nsage: %timeit b.__pari__()\n707 ns \u00b1 0.792 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: p = b.__pari__()\nsage: %timeit RDF(p)\n157 ns \u00b1 0.072 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: %timeit a.eta()\n9.31 \u00b5s \u00b1 32.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit a.dilog()\n48.1 \u00b5s \u00b1 389 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit a.gamma()\n36.8 \u00b5s \u00b1 549 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit a.zeta()\n76.2 \u00b5s \u00b1 1.62 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nI doubt that calling `__pari__` or `_element_constructor_` is the crucial task of some algorithm.\n\nIf the regression is a problem, we could find a faster way to deal with the whole `pari_to_cdf(self.__pari__()...)` calls, e.g.\n\n\n```diff\ndiff --git a/src/sage/libs/pari/convert_sage_complex_double.pyx b/src/sage/libs/pari/convert_sage_complex_double.pyx\nindex 5a04aff7f6..f8859a7dea 100644\n--- a/src/sage/libs/pari/convert_sage_complex_double.pyx\n+++ b/src/sage/libs/pari/convert_sage_complex_double.pyx\n@@ -58,3 +58,6 @@ cpdef Gen new_gen_from_complex_double_element(ComplexDoubleElement self):\n         return new_gen_from_double(self._complex.real)\n     else:\n         return new_t_COMPLEX_from_double(self._complex.real, self._complex.imag)\n+\n+cpdef ComplexDoubleElement complex_double_eta(ComplexDoubleElement self, int flag):\n+    return pari_to_cdf(new_gen_from_complex_double_element(self).eta(flag))\ndiff --git a/src/sage/rings/complex_double.pyx b/src/sage/rings/complex_double.pyx\nindex ecc326b439..0aef6a3aad 100644\n--- a/src/sage/rings/complex_double.pyx\n+++ b/src/sage/rings/complex_double.pyx\n@@ -92,9 +92,11 @@ from sage.structure.coerce cimport is_numpy_type\n try:\n     from cypari2.gen import Gen as pari_gen\n     from sage.libs.pari.convert_sage_complex_double import pari_to_cdf\n+    from sage.libs.pari.convert_sage_complex_double import complex_double_eta\n \n except ImportError:\n     pari_gen = ()\n+    complex_double_eta = None\n \n from . import complex_mpfr\n \n@@ -2241,8 +2243,11 @@ cdef class ComplexDoubleElement(FieldElement):\n             # this, PARI can easily underflow.\n             return ComplexDoubleElement(0,0)\n \n+        if complex_double_eta is None:\n+            raise ImportError(\"pari not found\")\n+\n         cdef int flag = 0 if omit_frac else 1\n-        return pari_to_cdf(self.__pari__().eta(flag))\n+        return complex_double_eta(self, flag)\n```\n\n\nThis is even faster than the original approach with new timing being:\n\n\n```\nsage: a = CDF(1,2)\nsage: %timeit a.eta()\n7.89 \u00b5s \u00b1 9.65 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nThis approach could be used anywhere but to speed up `__pari__` and `_element_constructor_`.",
    "created_at": "2021-10-26T08:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463120",
    "user": "@kliem"
}
```

Replying to [comment:13 tscrim]:
> I think this requires some checking for speed regressions because the function is both no longer `inline` nor `cimport`-ed, and I could see this being used in a tight loop.

Things get about 1µs slower:

Before:


```
sage: a = CDF(1,2)
sage: %timeit a.__pari__()
199 ns ± 0.214 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit CDF(p)
310 ns ± 0.827 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: b = RDF(1.3)
sage: %timeit b.__pari__()
160 ns ± 0.128 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = b.__pari__()
sage: %timeit RDF(p)
174 ns ± 2.06 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.eta()
7.99 µs ± 12.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each) 
sage: %timeit a.dilog()
46.2 µs ± 64.8 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit a.gamma()
33.5 µs ± 59.2 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit a.zeta()
74.4 µs ± 726 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


After:


```
sage: a = CDF(1,2)
sage: %timeit a.__pari__()
736 ns ± 0.283 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit CDF(p)
327 ns ± 0.544 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: b = RDF(1.3)
sage: %timeit b.__pari__()
707 ns ± 0.792 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = b.__pari__()
sage: %timeit RDF(p)
157 ns ± 0.072 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit a.eta()
9.31 µs ± 32.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit a.dilog()
48.1 µs ± 389 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit a.gamma()
36.8 µs ± 549 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit a.zeta()
76.2 µs ± 1.62 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


I doubt that calling `__pari__` or `_element_constructor_` is the crucial task of some algorithm.

If the regression is a problem, we could find a faster way to deal with the whole `pari_to_cdf(self.__pari__()...)` calls, e.g.


```diff
diff --git a/src/sage/libs/pari/convert_sage_complex_double.pyx b/src/sage/libs/pari/convert_sage_complex_double.pyx
index 5a04aff7f6..f8859a7dea 100644
--- a/src/sage/libs/pari/convert_sage_complex_double.pyx
+++ b/src/sage/libs/pari/convert_sage_complex_double.pyx
@@ -58,3 +58,6 @@ cpdef Gen new_gen_from_complex_double_element(ComplexDoubleElement self):
         return new_gen_from_double(self._complex.real)
     else:
         return new_t_COMPLEX_from_double(self._complex.real, self._complex.imag)
+
+cpdef ComplexDoubleElement complex_double_eta(ComplexDoubleElement self, int flag):
+    return pari_to_cdf(new_gen_from_complex_double_element(self).eta(flag))
diff --git a/src/sage/rings/complex_double.pyx b/src/sage/rings/complex_double.pyx
index ecc326b439..0aef6a3aad 100644
--- a/src/sage/rings/complex_double.pyx
+++ b/src/sage/rings/complex_double.pyx
@@ -92,9 +92,11 @@ from sage.structure.coerce cimport is_numpy_type
 try:
     from cypari2.gen import Gen as pari_gen
     from sage.libs.pari.convert_sage_complex_double import pari_to_cdf
+    from sage.libs.pari.convert_sage_complex_double import complex_double_eta
 
 except ImportError:
     pari_gen = ()
+    complex_double_eta = None
 
 from . import complex_mpfr
 
@@ -2241,8 +2243,11 @@ cdef class ComplexDoubleElement(FieldElement):
             # this, PARI can easily underflow.
             return ComplexDoubleElement(0,0)
 
+        if complex_double_eta is None:
+            raise ImportError("pari not found")
+
         cdef int flag = 0 if omit_frac else 1
-        return pari_to_cdf(self.__pari__().eta(flag))
+        return complex_double_eta(self, flag)
```


This is even faster than the original approach with new timing being:


```
sage: a = CDF(1,2)
sage: %timeit a.eta()
7.89 µs ± 9.65 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


This approach could be used anywhere but to speed up `__pari__` and `_element_constructor_`.



---

archive/issue_comments_463121.json:
```json
{
    "body": "Thank you for doing the timings. If someone is using polynomials or matrices over RDF/CDF and then running a PARI algorithm on them and has to convert back and forth, then this could have some noticeable effects on speed. With this, that main thing it would be going through is `__pari__` and `_element_constructor_`. Although my suspicion is that this would not have a major impact, if someone is doing that.\n\nPerhaps this is just the cost of doing business, but I would have expected this to be okay to do. To be precise about \"this\", I mean implementing a Cython conversion to/from a library. How useful is this to modularization?\n\nI am actually more worried about #30022 having an actual impact on calculations because `ZZ` and `QQ` are much more common for base ring computations.",
    "created_at": "2021-10-26T11:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463121",
    "user": "tscrim"
}
```

Thank you for doing the timings. If someone is using polynomials or matrices over RDF/CDF and then running a PARI algorithm on them and has to convert back and forth, then this could have some noticeable effects on speed. With this, that main thing it would be going through is `__pari__` and `_element_constructor_`. Although my suspicion is that this would not have a major impact, if someone is doing that.

Perhaps this is just the cost of doing business, but I would have expected this to be okay to do. To be precise about "this", I mean implementing a Cython conversion to/from a library. How useful is this to modularization?

I am actually more worried about #30022 having an actual impact on calculations because `ZZ` and `QQ` are much more common for base ring computations.



---

archive/issue_comments_463122.json:
```json
{
    "body": "If you really want to be fast, you should with `__pari__` and `_element_constructor_` you can use `pari_to_cdf` or `new_gen_from_complex_double_element` directly:\n\n\n```\nsage: from sage.libs.pari.convert_sage_complex_double import pari_to_cdf, new_gen_from_complex_double_element\nsage: a = CDF(1,2)\nsage: %timeit new_gen_from_complex_double_element(a)\n182 ns \u00b1 0.109 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit pari_to_cdf(p)\n106 ns \u00b1 0.0893 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n```\n\n\nIn that way, this ticket is an improvement. I'm fixing the other use cases and I will also see, whether #30022 can be improved.",
    "created_at": "2021-10-26T11:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463122",
    "user": "@kliem"
}
```

If you really want to be fast, you should with `__pari__` and `_element_constructor_` you can use `pari_to_cdf` or `new_gen_from_complex_double_element` directly:


```
sage: from sage.libs.pari.convert_sage_complex_double import pari_to_cdf, new_gen_from_complex_double_element
sage: a = CDF(1,2)
sage: %timeit new_gen_from_complex_double_element(a)
182 ns ± 0.109 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = a.__pari__()
sage: %timeit pari_to_cdf(p)
106 ns ± 0.0893 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
```


In that way, this ticket is an improvement. I'm fixing the other use cases and I will also see, whether #30022 can be improved.



---

archive/issue_comments_463123.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-26T11:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463123",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_463124.json:
```json
{
    "body": "Before this ticket:\n\n\n```\nsage: a = RDF(2.3)\nsage: %timeit a.__pari__()\n174 ns \u00b1 0.0989 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit RDF(p)\n161 ns \u00b1 0.0978 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: a = CDF(1,1)\nsage: %timeit a.__pari__()\n205 ns \u00b1 0.299 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit CDF(p)\n323 ns \u00b1 0.852 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit a.eta()\n7.38 \u00b5s \u00b1 18.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit a.gamma()\n33.2 \u00b5s \u00b1 74.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nWith this ticket:\n\n\n```\nsage: a = RDF(2.3)\nsage: %timeit a.__pari__()\n173 ns \u00b1 0.137 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit RDF(p)\n170 ns \u00b1 0.109 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: a = CDF(1,1)\nsage: %timeit a.__pari__()\n214 ns \u00b1 0.392 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: p = a.__pari__()\nsage: %timeit CDF(p)\n376 ns \u00b1 0.567 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit a.eta()\n7.41 \u00b5s \u00b1 18.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit a.gamma()\n33.2 \u00b5s \u00b1 42.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n",
    "created_at": "2021-10-26T12:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463124",
    "user": "@kliem"
}
```

Before this ticket:


```
sage: a = RDF(2.3)
sage: %timeit a.__pari__()
174 ns ± 0.0989 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = a.__pari__()
sage: %timeit RDF(p)
161 ns ± 0.0978 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: a = CDF(1,1)
sage: %timeit a.__pari__()
205 ns ± 0.299 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit CDF(p)
323 ns ± 0.852 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.eta()
7.38 µs ± 18.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit a.gamma()
33.2 µs ± 74.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


With this ticket:


```
sage: a = RDF(2.3)
sage: %timeit a.__pari__()
173 ns ± 0.137 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: p = a.__pari__()
sage: %timeit RDF(p)
170 ns ± 0.109 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: a = CDF(1,1)
sage: %timeit a.__pari__()
214 ns ± 0.392 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: p = a.__pari__()
sage: %timeit CDF(p)
376 ns ± 0.567 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit a.eta()
7.41 µs ± 18.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit a.gamma()
33.2 µs ± 42.6 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```




---

archive/issue_comments_463125.json:
```json
{
    "body": "That requires more understanding of the internal workings of Sage, is not local to the parent object, and is not flexible when the parent changes. So I am not sure it is the best path.\n\nHowever, at least with these changes, the effect on the function calls are minimized.",
    "created_at": "2021-10-26T12:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463125",
    "user": "tscrim"
}
```

That requires more understanding of the internal workings of Sage, is not local to the parent object, and is not flexible when the parent changes. So I am not sure it is the best path.

However, at least with these changes, the effect on the function calls are minimized.



---

archive/issue_comments_463126.json:
```json
{
    "body": "Yes, having things fast out of the box without extra tricks is important.",
    "created_at": "2021-10-26T12:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463126",
    "user": "@kliem"
}
```

Yes, having things fast out of the box without extra tricks is important.



---

archive/issue_comments_463127.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n>  How useful is this to modularization?\n\nNot sure if I'm answering this in the right context of your question, but I have expanded the ticket description to explain the motivation for this ticket.",
    "created_at": "2021-10-26T17:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463127",
    "user": "mkoeppe"
}
```

Replying to [comment:15 tscrim]:
>  How useful is this to modularization?

Not sure if I'm answering this in the right context of your question, but I have expanded the ticket description to explain the motivation for this ticket.



---

archive/issue_comments_463128.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-27T00:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463128",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463129.json:
```json
{
    "body": "That was what I was after. Thank you.\n\nThe current version LGTM.",
    "created_at": "2021-10-27T00:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463129",
    "user": "tscrim"
}
```

That was what I was after. Thank you.

The current version LGTM.



---

archive/issue_comments_463130.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2021-10-27T00:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463130",
    "user": "mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_463131.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-29T00:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463131",
    "user": "mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_463132.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-29T00:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463132",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_463133.json:
```json
{
    "body": "I used an old version of the branch, to be redone",
    "created_at": "2021-10-29T00:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463133",
    "user": "mkoeppe"
}
```

I used an old version of the branch, to be redone



---

archive/issue_comments_463134.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-29T00:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463134",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_463135.json:
```json
{
    "body": "Merging 9.5.beta5 pulls in #32607, so corresponding changes need to be made in `src/sage/libs/pari/convert_sage_complex_double.pyx`",
    "created_at": "2021-10-29T00:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463135",
    "user": "mkoeppe"
}
```

Merging 9.5.beta5 pulls in #32607, so corresponding changes need to be made in `src/sage/libs/pari/convert_sage_complex_double.pyx`



---

archive/issue_comments_463136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-29T06:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463136",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463137.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-29T06:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463137",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_463138.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-29T17:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463138",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463139.json:
```json
{
    "body": "Thanks.",
    "created_at": "2021-10-29T17:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463139",
    "user": "mkoeppe"
}
```

Thanks.



---

archive/issue_comments_463140.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-31T22:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32464",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32464#issuecomment-463140",
    "user": "vbraun"
}
```

Resolution: fixed
