# Issue 12593: MPIR doesn't compile with GCC-4.7.0 on ia64

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-03-28 06:58:31

Assignee: tbd

See #12751 for the GCC-4.7.0 metaticket.


---

Comment by leif created at 2012-04-04 20:35:36

Doesn't look like they've already fixed this upstream, they only work around the problem in libffi.

Or did you test some svn version?


---

Comment by jdemeyer created at 2012-04-04 20:48:40

Replying to [comment:4 leif]:
> Doesn't look like they've already fixed this upstream, they only work around the problem in libffi.
> 
> Or did you test some svn version?
I haven't tested anything, I just believed the GCC Bugzilla.


---

Comment by leif created at 2012-04-05 15:46:46

The MPIR 2.4.0.*p2* spkg at #11616 now includes a work-around for this bug (_almost_ completely disabling optimization on Linux ia64 with GCC 4.7.*x*).


---

Comment by leif created at 2012-04-05 17:50:01

Looks like we'd have the same problem with NTL:

```
...
g++ -I../include -I.  -O2 -g -O3 -g -DHONORS_CXXFLAGS  -fPIC -c  FFT.c
In file included from ../include/NTL/ZZ.h:1804:0,
                 from ../include/NTL/FFT.h:7,
                 from FFT.c:3:
../include/NTL/SPMM_ASM.h: In function ‘void NTL::FFT(long int*, const long int*, long int, long int, const long int*)’:
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
make[3]: *** [FFT.o] Error 1
make[3]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/ntl-5.5.2/src/src'
make[2]: *** [libntl.so] Error 2
make[2]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/ntl-5.5.2/src/src'
Error creating ntl shared library.
...
```



---

Comment by leif created at 2012-04-05 18:10:23

... also zn_poly.


---

Comment by leif created at 2012-04-05 18:21:43

Replying to [comment:8 leif]:
> ... also zn_poly.

And overrides `-O0 ...` in `CFLAGS` with `-O3`... >8(


---

Comment by leif created at 2012-04-05 18:29:17

Replying to [comment:7 leif]:
> Looks like we'd have the same problem with NTL:
> {{{
> ...
> g++ -I../include -I.  -O2 -g -O3 -g -DHONORS_CXXFLAGS  -fPIC -c  FFT.c
> In file included from ../include/NTL/ZZ.h:1804:0,
>                  from ../include/NTL/FFT.h:7,
>                  from FFT.c:3:
> ../include/NTL/SPMM_ASM.h: In function ‘void NTL::FFT(long int*, const long int*, long int, long int, const long int*)’:
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> ../include/NTL/SPMM_ASM.h:103:69: error: ‘asm’ operand requires impossible reload
> make[3]: *** [FFT.o] Error 1
> make[3]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/ntl-5.5.2/src/src'
> make[2]: *** [libntl.so] Error 2
> make[2]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/ntl-5.5.2/src/src'
> Error creating ntl shared library.
> ...
> }}}

Despite that, after a second try with `-fno-strict-aliasing -O3` (and again at least parts of these errors), the spkg is reported to have successfully been installed... ?


---

Comment by leif created at 2012-04-05 18:44:26

Replying to [comment:9 leif]:
> Replying to [comment:8 leif]:
> > ... also zn_poly.
> 
> And overrides `-O0 ...` in `CFLAGS` with `-O3`... >8(

And that's _not_ upstream.  From `spkg-install` (which is a mess):

```sh
...
CFLAGS="$CFLAGS -g -fPIC -O3 -L."; export CFLAGS
LDFLAGS="$LDFLAGS"; export LDFLAGS
...
```


OMG.


---

Comment by leif created at 2012-04-05 19:05:38

Furthermore: GMP-ECM, FLINT, MPFR and PARI.


---

Comment by leif created at 2012-04-05 20:22:08

Jeroen, should I open separate (GCC 4.7 on ia64) tickets for these, or perhaps just one meta-ticket?

FLINT and zn_poly are currently "under construction" anyway; Andrew Ohana slightly fixed these just to respect `CC` and `CXX` for the `clang` port, so we could also do (little) changes on those open tickets.

(For FLINT there's also the ARM port ticket, which upgrades to 1.5.2 and thereby makes a couple of changes unnecessary, or at least different, with less effort.  I also have an old, broadly cleaned-up FLINT 1.5.2 spkg, which I believe would need some work, at least some rebasing.)

[GMP-ECM, MPFR and PARI seem to build with `-O0 [-finline-functions -fschedule-insns]` in `C/CPP/CXXFLAGS`, without further changes to their `spkg-install` or Makefiles etc.; haven't yet tried with `SAGE_CHECK=yes` though.]


---

Comment by jdemeyer created at 2012-04-05 20:26:55

Replying to [comment:13 leif]:
> Jeroen, should I open separate (GCC 4.7 on ia64) tickets for these, or perhaps just one meta-ticket?
To be honest, I don't care too much about these issues...  It makes more sense to open a ticket to blacklist GCC-4.7.0 on ia64, i.e. build Sage's GCC-4.6.3 in this case.

I'm currently building an svn version of GCC-4.7.x to see whether the problem is fixed.


---

Comment by jdemeyer created at 2012-04-05 20:28:57

MPFR though is a dependency for GCC, so that's more important.


---

Comment by leif created at 2012-04-05 20:49:01

Replying to [comment:15 jdemeyer]:
> MPFR though is a dependency for GCC, so that's more important.

Yep.


---

Comment by leif created at 2012-04-05 21:12:43

This one is more funny:

```
...
g++: error: unrecognized command line option ‘-m64’
make[2]: *** [gfan] Error 1
make[2]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/gfan-0.4plus.p2/src'
Error building gfan.
...
```



---

Comment by jdemeyer created at 2012-04-05 21:16:58

That's weird because GCC on ia64 never supported `-m64` AFAIK.  So it should fail with any GCC version.


---

Comment by leif created at 2012-04-05 21:39:00

Replying to [comment:17 leif]:
> This one is more funny:
> {{{
> ...
> g++: error: unrecognized command line option ‘-m64’
> make[2]: *** [gfan] Error 1
> make[2]: Leaving directory `/home/leif/Sage/release/build/iras/sage-5.0.beta12-gcc-4.7.0/spkg/build/gfan-0.4plus.p2/src'
> Error building gfan.
> ...
> }}}

The funniest thing being that *that is my fault*... B)

(since I made the p2, apparently without looking at the patched Makefile, and without testing on non-x86_64 systems)


---

Comment by jdemeyer created at 2012-04-06 14:56:51

Replying to [comment:4 leif]:
> Doesn't look like they've already fixed this upstream, they only work around the problem in libffi.

You are right, it is not fixed upsteam (I tried the latest svn version of the 4.7 branch on cleo).


---

Comment by leif created at 2012-04-14 21:53:45

Replying to [comment:11 leif]:
> Replying to [comment:9 leif]:
> > Replying to [comment:8 leif]:
> > > ... also zn_poly.
> > 
> > And overrides `-O0 ...` in `CFLAGS` with `-O3`... >8(
> 
> And that's _not_ upstream.  From `spkg-install` (which is a mess):
> {{{
> #!sh
> ...
> CFLAGS="$CFLAGS -g -fPIC -O3 -L."; export CFLAGS
> LDFLAGS="$LDFLAGS"; export LDFLAGS
> ...
> }}}
> 
> OMG.

Forgot: A fixed zn_poly spkg (not yet taking care of GCC 4.7.0 on ia64 IIRC) is available at #12433, still needing review.  (The main purpose of that ticket was to make zn_poly respect `CC` etc.; it now also does a major clean-up.)


---

Comment by jdemeyer created at 2012-04-30 10:00:29

Resolution: duplicate
