# Issue 24321: exception when creating tensor product

Issue created by migration from Trac.

Original creator: cnassau

Original creation time: 2018-01-18 07:59:40

CC:  vdelecroix tscrim chapoton

The following seems to have been broken by the fix for #13979:

```
sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
sage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
sage: tensor((C,C))
Traceback
...
NotImplementedError: unknown cardinality
```

The category determination for the cartesian product of the involved basis families seems to break.


---

Comment by tscrim created at 2018-01-18 15:55:16

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-01-18 15:55:16

I cannot reproduce this on 8.2.beta2:

```
sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
sage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
sage: tensor((C,C))
Free module generated by {0, 1, -1, 2, -2, ...} over Integer Ring # Free module generated by {0, 1, -1, 2, -2, ...} over Integer Ring
```



---

Comment by chapoton created at 2018-01-18 15:57:06

This fails in 8.2.b3


---

Comment by chapoton created at 2018-01-18 15:57:06

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2018-01-18 16:00:58

Ah, right (I didn't see that beta3 was released; will get today). A full traceback would be useful.


---

Comment by chapoton created at 2018-01-18 16:06:41


```
NotImplementedError                       Traceback (most recent call last)
<ipython-input-1-b14c8eb93bce> in <module>()
      1 from sage.sets.set_from_iterator import EnumeratedSetFromIterator
      2 C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
----> 3 tensor((C,C))

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/covariant_functorial_construction.pyc in __call__(self, args, **kwargs)
    221         assert(all( hasattr(arg, self._functor_name) for arg in args))
    222         assert(len(args) > 0)
--> 223         return getattr(args[0], self._functor_name)(*args[1:], **kwargs)
    224 
    225 class FunctorialConstructionCategory(Category): # Should this be CategoryWithBase?

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in tensor(*parents)
    831                 sage: A.rename(None)
    832             """
--> 833             return parents[0].__class__.Tensor(parents, category = tensor.category_from_parents(parents))
    834 
    835         def cardinality(self):

/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1590)()
    328         """
    329         if cls.classcall is not None:
--> 330             return cls.classcall(cls, *args, **kwds)
    331         else:
    332             # Fast version of type.__call__(cls, *args, **kwds)

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __classcall_private__(cls, modules, **options)
   1309             if all('FiniteDimensional' in M.category().axioms() for M in modules):
   1310                 options['category'] = options['category'].FiniteDimensional()
-> 1311             return super(CombinatorialFreeModule.Tensor, cls).__classcall__(cls, modules, **options)
   1312 
   1313 

/home/chapoton/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6246)()
   1057                 return self.cache[k]
   1058         except KeyError:
-> 1059             w = self.f(*args, **kwds)
   1060             self.cache[k] = w
   1061             return w

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in __classcall__(cls, *args, **options)
   1019             True
   1020         """
-> 1021         instance = typecall(cls, *args, **options)
   1022         assert isinstance( instance, cls )
   1023         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:

/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2040)()
    495             TypeError: Argument 'cls' has incorrect type (expected type, got classobj)
    496     """
--> 497     return (<PyTypeObject*>type).tp_call(cls, args, kwds)
    498 
    499 # Class for timing::

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __init__(self, modules, **options)
   1322             self._sets = modules
   1323             indices = CartesianProduct_iters(*[module.basis().keys()
-> 1324                                                for module in modules]).map(tuple)
   1325             CombinatorialFreeModule.__init__(self, modules[0].base_ring(), indices, **options)
   1326             # the following is not the best option, but it's better than nothing.

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in __init__(self, *iters)
    173         self.iters = iters
    174         self._mrange = xmrange_iter(iters)
--> 175         category = FiniteEnumeratedSets() if self.is_finite() else InfiniteEnumeratedSets()
    176         def iterfunc():
    177             # we can not use self.__iterate__ directly because

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in is_finite(self)
    348             ValueError: Unable to determine whether this product is finite
    349         """
--> 350         finites = [_is_finite(L, fallback=None) for L in self.iters]
    351         if any(f is None for f in finites):
    352             raise ValueError("Unable to determine whether this product is finite")

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _is_finite(L, fallback)
     82 
     83     try:
---> 84         n = _len(L)
     85     except (TypeError, AttributeError):
     86         # We usually assume L is finite for speed reasons

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _len(L)
     45         return L.cardinality()
     46     except AttributeError:
---> 47         return len(L)
     48 
     49 def _is_finite(L, fallback=True):

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in __len__(self)
    486                 return int(c)
    487             except AttributeError:
--> 488                 return len(self.list())
    489 
    490         def list(self):

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in list(self)
    527                     return self._list_from_iterator()
    528             except AttributeError:
--> 529                 raise NotImplementedError('unknown cardinality')
    530         _list_default  = list # needed by the check system.
    531 

NotImplementedError: unknown cardinality
```



---

Comment by tscrim created at 2018-01-20 06:43:45

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-01-20 06:43:45

So probably the easiest and likely best fix is to also catch the `NotImplementedError` in `misc.mrange._is_finite` and then catch the `ValueError` when the cardinality is unknown.
----
New commits:


---

Comment by chapoton created at 2018-01-20 08:38:06

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-01-20 08:38:06

ok


---

Comment by vbraun created at 2018-01-20 10:44:30

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-01-20 10:44:30

Reviewer name...


---

Comment by chapoton created at 2018-01-20 11:33:05

oops


---

Comment by chapoton created at 2018-01-20 11:33:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-01-22 07:58:27

Resolution: fixed
