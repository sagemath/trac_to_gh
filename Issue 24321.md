# Issue 24321: exception when creating tensor product

archive/issues_024321.json:
```json
{
    "body": "CC:  @videlec @tscrim @fchapoton\n\nThe following seems to have been broken by the fix for #13979:\n\n```\nsage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator\nsage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))\nsage: tensor((C,C))\nTraceback\n...\nNotImplementedError: unknown cardinality\n```\nThe category determination for the cartesian product of the involved basis families seems to break.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24558\n\n",
    "created_at": "2018-01-18T07:59:40Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "exception when creating tensor product",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24321",
    "user": "https://github.com/cnassau"
}
```
CC:  @videlec @tscrim @fchapoton

The following seems to have been broken by the fix for #13979:

```
sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
sage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
sage: tensor((C,C))
Traceback
...
NotImplementedError: unknown cardinality
```
The category determination for the cartesian product of the involved basis families seems to break.

Issue created by migration from https://trac.sagemath.org/ticket/24558





---

archive/issue_comments_340100.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-18T15:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340100",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340101.json:
```json
{
    "body": "I cannot reproduce this on 8.2.beta2:\n\n```\nsage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator\nsage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))\nsage: tensor((C,C))\nFree module generated by {0, 1, -1, 2, -2, ...} over Integer Ring # Free module generated by {0, 1, -1, 2, -2, ...} over Integer Ring\n```",
    "created_at": "2018-01-18T15:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340101",
    "user": "https://github.com/tscrim"
}
```

I cannot reproduce this on 8.2.beta2:

```
sage: from sage.sets.set_from_iterator import EnumeratedSetFromIterator
sage: C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
sage: tensor((C,C))
Free module generated by {0, 1, -1, 2, -2, ...} over Integer Ring # Free module generated by {0, 1, -1, 2, -2, ...} over Integer Ring
```



---

archive/issue_events_061928.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-01-18T15:55:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24321#event-61928"
}
```



---

archive/issue_comments_340102.json:
```json
{
    "body": "This fails in 8.2.b3",
    "created_at": "2018-01-18T15:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340102",
    "user": "https://github.com/fchapoton"
}
```

This fails in 8.2.b3



---

archive/issue_comments_340103.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-18T15:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340103",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_061929.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-01-18T16:00:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24321#event-61929"
}
```



---

archive/issue_events_061930.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-01-18T16:00:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24321#event-61930"
}
```



---

archive/issue_comments_340104.json:
```json
{
    "body": "Ah, right (I didn't see that beta3 was released; will get today). A full traceback would be useful.",
    "created_at": "2018-01-18T16:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340104",
    "user": "https://github.com/tscrim"
}
```

Ah, right (I didn't see that beta3 was released; will get today). A full traceback would be useful.



---

archive/issue_comments_340105.json:
```json
{
    "body": "```\nNotImplementedError                       Traceback (most recent call last)\n<ipython-input-1-b14c8eb93bce> in <module>()\n      1 from sage.sets.set_from_iterator import EnumeratedSetFromIterator\n      2 C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))\n----> 3 tensor((C,C))\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/covariant_functorial_construction.pyc in __call__(self, args, **kwargs)\n    221         assert(all( hasattr(arg, self._functor_name) for arg in args))\n    222         assert(len(args) > 0)\n--> 223         return getattr(args[0], self._functor_name)(*args[1:], **kwargs)\n    224 \n    225 class FunctorialConstructionCategory(Category): # Should this be CategoryWithBase?\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in tensor(*parents)\n    831                 sage: A.rename(None)\n    832             \"\"\"\n--> 833             return parents[0].__class__.Tensor(parents, category = tensor.category_from_parents(parents))\n    834 \n    835         def cardinality(self):\n\n/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1590)()\n    328         \"\"\"\n    329         if cls.classcall is not None:\n--> 330             return cls.classcall(cls, *args, **kwds)\n    331         else:\n    332             # Fast version of type.__call__(cls, *args, **kwds)\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __classcall_private__(cls, modules, **options)\n   1309             if all('FiniteDimensional' in M.category().axioms() for M in modules):\n   1310                 options['category'] = options['category'].FiniteDimensional()\n-> 1311             return super(CombinatorialFreeModule.Tensor, cls).__classcall__(cls, modules, **options)\n   1312 \n   1313 \n\n/home/chapoton/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6246)()\n   1057                 return self.cache[k]\n   1058         except KeyError:\n-> 1059             w = self.f(*args, **kwds)\n   1060             self.cache[k] = w\n   1061             return w\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in __classcall__(cls, *args, **options)\n   1019             True\n   1020         \"\"\"\n-> 1021         instance = typecall(cls, *args, **options)\n   1022         assert isinstance( instance, cls )\n   1023         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:\n\n/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2040)()\n    495             TypeError: Argument 'cls' has incorrect type (expected type, got classobj)\n    496     \"\"\"\n--> 497     return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n    498 \n    499 # Class for timing::\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __init__(self, modules, **options)\n   1322             self._sets = modules\n   1323             indices = CartesianProduct_iters(*[module.basis().keys()\n-> 1324                                                for module in modules]).map(tuple)\n   1325             CombinatorialFreeModule.__init__(self, modules[0].base_ring(), indices, **options)\n   1326             # the following is not the best option, but it's better than nothing.\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in __init__(self, *iters)\n    173         self.iters = iters\n    174         self._mrange = xmrange_iter(iters)\n--> 175         category = FiniteEnumeratedSets() if self.is_finite() else InfiniteEnumeratedSets()\n    176         def iterfunc():\n    177             # we can not use self.__iterate__ directly because\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in is_finite(self)\n    348             ValueError: Unable to determine whether this product is finite\n    349         \"\"\"\n--> 350         finites = [_is_finite(L, fallback=None) for L in self.iters]\n    351         if any(f is None for f in finites):\n    352             raise ValueError(\"Unable to determine whether this product is finite\")\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _is_finite(L, fallback)\n     82 \n     83     try:\n---> 84         n = _len(L)\n     85     except (TypeError, AttributeError):\n     86         # We usually assume L is finite for speed reasons\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _len(L)\n     45         return L.cardinality()\n     46     except AttributeError:\n---> 47         return len(L)\n     48 \n     49 def _is_finite(L, fallback=True):\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in __len__(self)\n    486                 return int(c)\n    487             except AttributeError:\n--> 488                 return len(self.list())\n    489 \n    490         def list(self):\n\n/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in list(self)\n    527                     return self._list_from_iterator()\n    528             except AttributeError:\n--> 529                 raise NotImplementedError('unknown cardinality')\n    530         _list_default  = list # needed by the check system.\n    531 \n\nNotImplementedError: unknown cardinality\n```",
    "created_at": "2018-01-18T16:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340105",
    "user": "https://github.com/fchapoton"
}
```

```
NotImplementedError                       Traceback (most recent call last)
<ipython-input-1-b14c8eb93bce> in <module>()
      1 from sage.sets.set_from_iterator import EnumeratedSetFromIterator
      2 C = CombinatorialFreeModule(ZZ,EnumeratedSetFromIterator(Integers))
----> 3 tensor((C,C))

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/covariant_functorial_construction.pyc in __call__(self, args, **kwargs)
    221         assert(all( hasattr(arg, self._functor_name) for arg in args))
    222         assert(len(args) > 0)
--> 223         return getattr(args[0], self._functor_name)(*args[1:], **kwargs)
    224 
    225 class FunctorialConstructionCategory(Category): # Should this be CategoryWithBase?

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in tensor(*parents)
    831                 sage: A.rename(None)
    832             """
--> 833             return parents[0].__class__.Tensor(parents, category = tensor.category_from_parents(parents))
    834 
    835         def cardinality(self):

/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1590)()
    328         """
    329         if cls.classcall is not None:
--> 330             return cls.classcall(cls, *args, **kwds)
    331         else:
    332             # Fast version of type.__call__(cls, *args, **kwds)

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __classcall_private__(cls, modules, **options)
   1309             if all('FiniteDimensional' in M.category().axioms() for M in modules):
   1310                 options['category'] = options['category'].FiniteDimensional()
-> 1311             return super(CombinatorialFreeModule.Tensor, cls).__classcall__(cls, modules, **options)
   1312 
   1313 

/home/chapoton/sage/src/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6246)()
   1057                 return self.cache[k]
   1058         except KeyError:
-> 1059             w = self.f(*args, **kwds)
   1060             self.cache[k] = w
   1061             return w

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.pyc in __classcall__(cls, *args, **options)
   1019             True
   1020         """
-> 1021         instance = typecall(cls, *args, **options)
   1022         assert isinstance( instance, cls )
   1023         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:

/home/chapoton/sage/src/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2040)()
    495             TypeError: Argument 'cls' has incorrect type (expected type, got classobj)
    496     """
--> 497     return (<PyTypeObject*>type).tp_call(cls, args, kwds)
    498 
    499 # Class for timing::

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/free_module.pyc in __init__(self, modules, **options)
   1322             self._sets = modules
   1323             indices = CartesianProduct_iters(*[module.basis().keys()
-> 1324                                                for module in modules]).map(tuple)
   1325             CombinatorialFreeModule.__init__(self, modules[0].base_ring(), indices, **options)
   1326             # the following is not the best option, but it's better than nothing.

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in __init__(self, *iters)
    173         self.iters = iters
    174         self._mrange = xmrange_iter(iters)
--> 175         category = FiniteEnumeratedSets() if self.is_finite() else InfiniteEnumeratedSets()
    176         def iterfunc():
    177             # we can not use self.__iterate__ directly because

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/combinat/cartesian_product.pyc in is_finite(self)
    348             ValueError: Unable to determine whether this product is finite
    349         """
--> 350         finites = [_is_finite(L, fallback=None) for L in self.iters]
    351         if any(f is None for f in finites):
    352             raise ValueError("Unable to determine whether this product is finite")

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _is_finite(L, fallback)
     82 
     83     try:
---> 84         n = _len(L)
     85     except (TypeError, AttributeError):
     86         # We usually assume L is finite for speed reasons

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/misc/mrange.pyc in _len(L)
     45         return L.cardinality()
     46     except AttributeError:
---> 47         return len(L)
     48 
     49 def _is_finite(L, fallback=True):

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in __len__(self)
    486                 return int(c)
    487             except AttributeError:
--> 488                 return len(self.list())
    489 
    490         def list(self):

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/categories/enumerated_sets.pyc in list(self)
    527                     return self._list_from_iterator()
    528             except AttributeError:
--> 529                 raise NotImplementedError('unknown cardinality')
    530         _list_default  = list # needed by the check system.
    531 

NotImplementedError: unknown cardinality
```



---

archive/issue_comments_340106.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-20T06:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340106",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340107.json:
```json
{
    "body": "So probably the easiest and likely best fix is to also catch the `NotImplementedError` in `misc.mrange._is_finite` and then catch the `ValueError` when the cardinality is unknown.\n\n---\nNew commits:",
    "created_at": "2018-01-20T06:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340107",
    "user": "https://github.com/tscrim"
}
```

So probably the easiest and likely best fix is to also catch the `NotImplementedError` in `misc.mrange._is_finite` and then catch the `ValueError` when the cardinality is unknown.

---
New commits:



---

archive/issue_comments_340108.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-20T08:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340108",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340109.json:
```json
{
    "body": "ok",
    "created_at": "2018-01-20T08:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340109",
    "user": "https://github.com/fchapoton"
}
```

ok



---

archive/issue_comments_340110.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-01-20T10:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340110",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_340111.json:
```json
{
    "body": "Reviewer name...",
    "created_at": "2018-01-20T10:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340111",
    "user": "https://github.com/vbraun"
}
```

Reviewer name...



---

archive/issue_comments_340112.json:
```json
{
    "body": "oops",
    "created_at": "2018-01-20T11:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340112",
    "user": "https://github.com/fchapoton"
}
```

oops



---

archive/issue_comments_340113.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-01-20T11:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340113",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_061931.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-22T07:58:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24321#event-61931"
}
```



---

archive/issue_comments_340114.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-22T07:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24321",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24321#issuecomment-340114",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
