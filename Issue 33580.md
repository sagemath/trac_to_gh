# Issue 33580: GH Actions: Add test of the modularized distributions

Issue created by migration from https://trac.sagemath.org/ticket/33817

Original creator: mkoeppe

Original creation time: 2022-05-06 17:59:19

CC:  dimpase saraedum klee jhpalmieri

... as part of the workflow `build.yml`. This is to catch modularization regressions on tickets.

To this end, we add `build/pkgs/sagemath-{objects,categories}/spkg-install` scripts, which build and store wheels (but do not install them!), and add tox environments `python-sagewheels-nopypi` as in `pkg/sagemath-standard/tox.ini`.


---

Comment by git created at 2022-05-06 21:49:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 22:05:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 20:57:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-05-07 21:00:29

How much longer does the build workflow now take?


---

Comment by mkoeppe created at 2022-05-07 21:01:33

Running right now at https://github.com/sagemath/sagetrac-mirror/runs/6336808131?check_suite_focus=true


---

Comment by git created at 2022-05-07 21:30:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 22:02:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 22:25:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 23:07:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 23:19:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 23:44:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 00:58:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 01:07:52

Replying to [comment:8 gh-tobiasdiez]:
> How much longer does the build workflow now take? 

4 minutes longer - 
https://github.com/sagemath/sagetrac-mirror/runs/6337876092?check_suite_focus=true


---

Comment by git created at 2022-05-08 01:52:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 01:57:36

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-05-08 21:00:35

> This step has been truncated due to its large size. Download the full logs from the menu once the workflow run has completed. 

Can you please decrease the verbosity of the install steps (e.g. there is no need to see the verbose logs for the dependencies).

Moreover many tests are actually failing but the step still succeeds. Eg:
> [sagemath_objects-9.6.rc3]     NameError: name 'ZZ' is not defined


---

Comment by @tobiasdiez created at 2022-05-08 21:00:35

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-05-08 21:02:15

Replying to [comment:21 gh-tobiasdiez]:
> Moreover many tests are actually failing but the step still succeeds. Eg:
> > [sagemath_objects-9.6.rc3]     NameError: name 'ZZ' is not defined

Yes, this is normal.


---

Comment by git created at 2022-05-08 21:14:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 21:23:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 21:26:01

Cherry-picked some improvements from #33812


---

Comment by git created at 2022-05-08 21:54:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-08 22:23:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 22:28:31

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-08 22:28:31

Here's a solution, running at https://github.com/sagemath/sagetrac-mirror/runs/6343730808?check_suite_focus=true

I've made the test dependency installs silent and reduced the tests of sagemath-objects to a minimum (as I was doing anyway in #33812).

sagemath-categories continues to run the full test suite of `sage.structure`, showing lots of (ignored) errors. They will be fixed gradually by marking doctests `# optional`


---

Comment by @tobiasdiez created at 2022-05-09 20:43:01

Now the distribution check needs over 10min, is this expected?


---

Comment by mkoeppe created at 2022-05-09 20:49:19

I think these are just random fluctuations. The job looks OK.


---

Comment by @tobiasdiez created at 2022-05-10 18:38:35

Indeed, one a newly triggered run it only takes about 4min. The changes to the build workflow look good to me, I cannot say anything about the rest.


---

Comment by git created at 2022-06-12 18:54:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-18 00:54:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-25 23:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-03 18:24:41

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-07-03 18:25:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-09 23:30:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-11 00:19:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-11 00:21:03

All dependencies have been merged


---

Comment by klee created at 2022-07-25 07:32:24

From Build&Test badge, I see

```
[sagemath_environment-9.7.beta5] using tox.ini: /__w/sagetrac-mirror/sagetrac-mirror/pkgs/sagemath-environment/tox.ini (pid 24071)
[sagemath_environment-9.7.beta5] ERROR: unknown environment 'sagepython-norequirements'
```

Is this normal?


---

Comment by mkoeppe created at 2022-07-25 16:27:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-07-25 16:51:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 18:15:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 18:27:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 18:34:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 20:06:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-25 20:21:32

(last commit cherry-picked from #33812)


---

Comment by git created at 2022-07-25 22:34:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-26 00:14:47

New test running at https://github.com/mkoeppe/sage/actions/runs/2736095948


---

Comment by mkoeppe created at 2022-07-26 00:14:47

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-07-26 01:13:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-07-26 05:26:38

I removed some white spaces.

Other than that, the code looks good to me as far as I can read (not very far as usual).

The new workflow seems work well in github.

But on my machine (mac), I get

```
$ ./configure --editable; make SAGE_CHECK=yes pypi-wheels
...
...
[sagemath_categories-9.7.beta6] WARNING: Discarding $PYTHONPATH from environment, to override specify PYTHONPATH in 'passenv' in your configuration.
[sagemath_categories-9.7.beta6] [40038] /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories$ /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/sagepython-norequirements/bin/python -m pip install --no-deps -U .tox/.tmp/package/1/sagemath_categories-9.7b6-cp39-cp39-macosx_12_0_x86_64.whl >.tox/sagepython-norequirements/log/sagepython-norequirements-2.log
[sagemath_categories-9.7.beta6] ERROR: invocation failed (exit code 1), logfile: /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/sagepython-norequirements/log/sagepython-norequirements-2.log
[sagemath_categories-9.7.beta6] ================================== log start ===================================
[sagemath_categories-9.7.beta6] Looking in links: file:///Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels
[sagemath_categories-9.7.beta6] ERROR: sagemath_categories-9.7b6-cp39-cp39-macosx_12_0_x86_64.whl is not a supported wheel on this platform.
[sagemath_categories-9.7.beta6] 
[sagemath_categories-9.7.beta6] =================================== log end ====================================
[sagemath_categories-9.7.beta6] ___________________________________ summary ____________________________________
[sagemath_categories-9.7.beta6] ERROR:   sagepython-norequirements: InvocationError for command /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/sagepython-norequirements/bin/python -m pip install --no-deps -U .tox/.tmp/package/1/sagemath_categories-9.7b6-cp39-cp39-macosx_12_0_x86_64.whl (exited with code 1)
make[3]: *** [sagemath_categories-SAGE_VENV-no-deps] Error 1
make[2]: *** [/Users/kwankyu/GitHub/sage-dev/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/sagemath_categories-9.7.beta6] Error 2

real	2m58.107s
user	2m41.881s
sys	0m14.927s
***************************************************************
Error building Sage.
```

Is this expected?
----
New commits:


---

Comment by klee created at 2022-07-26 07:11:15

I still get the same even with `make distclean; ./configure; make pypi-wheels`.


---

Comment by mkoeppe created at 2022-07-26 15:20:38

Is this python3.9 from Homebrew? And is this `tox` from Homebrew?


---

Comment by klee created at 2022-07-26 15:27:54

Homebrew python3.9 according to `./configure`,

```
Checking whether SageMath should install SPKG python3...
checking whether any of bzip2 liblzma libffi is installed as or will be installed as SPKG... no
checking for python3 >= 3.8.0, < 3.11.0 with modules sqlite3, ctypes, math, hashlib, crypt, socket, zlib, distutils.core, ssl, ensurepip... 
checking ... whether /usr/local/bin/python3 is good... yes
checking for python3 >= 3.8.0, < 3.11.0 with modules sqlite3, ctypes, math, hashlib, crypt, socket, zlib, distutils.core, ssl, ensurepip... /usr/local/bin/python3
configure: will use system package and not install SPKG python3
checking whether /usr/local/bin/python3 is configured to build multiarch extensions... no
checking whether "-march=native" works with the C/C++ compilers configured for building extensions for /usr/local/bin/python3... yes
```



---

Comment by klee created at 2022-07-26 15:32:02

If I run `tox` from `SAGE_ROOT`, it is the `tox` of Homebrew.


---

Comment by klee created at 2022-07-26 15:34:50

It is Hombrew tox according to ./configure,

```
Checking whether SageMath should install SPKG tox...
checking for tox >= 3.21.4... /usr/local/bin/tox
configure: will use system package and not install SPKG tox
```



---

Comment by mkoeppe created at 2022-07-26 15:41:45

Thanks. I can reproduce this error here. I'll investigate


---

Comment by mkoeppe created at 2022-07-26 18:02:56

OK I solved the same problem before for sagemath-standard. Fix coming up


---

Comment by git created at 2022-07-26 18:09:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-07-26 19:52:21

Replying to [comment:59 klee]:
> But on my machine (mac), I get
> {{{
> $ ./configure --editable; make SAGE_CHECK=yes pypi-wheels
> }}}
> Is this expected?

Did you mean/do `--enable-editable`? For what it's worth, I tend to use `&&` rather than `;` between commands so if the first one fails, it doesn't continue to the second one.


---

Comment by klee created at 2022-07-27 00:09:41

Thanks. This `./configure --enable-editable && make pypi-wheels` now works well.

Then I am positive with this ticket.


---

Comment by mkoeppe created at 2022-07-27 01:34:45

Thank you!


---

Comment by klee created at 2022-07-28 00:23:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-01 20:23:07

Resolution: fixed
