# Issue 28587: make doc-pdf race condition

archive/issues_028587.json:
```json
{
    "body": "CC:  @jhpalmieri @kiwifb @strogdon\n\nI'm hitting pretty reliably a race in the doc-pdf target:\n\n```\n$ make doc-clean && make -j10 doc-pdf\n[...]\n[docpdf] [59 [40\n[docpdf] Runaway definition?\n[docpdf] ->\\bibcite {index \n[docpdf] ! File ended within \\read.\n[...]\n```\n\nRe-running `make doc-pdf` eventually succeeds. Clearly a partially-written bibliography file is somewhere read by another process.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28824\n\n",
    "created_at": "2019-11-30T11:05:22Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "make doc-pdf race condition",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28587",
    "user": "@vbraun"
}
```
CC:  @jhpalmieri @kiwifb @strogdon

I'm hitting pretty reliably a race in the doc-pdf target:

```
$ make doc-clean && make -j10 doc-pdf
[...]
[docpdf] [59 [40
[docpdf] Runaway definition?
[docpdf] ->\bibcite {index 
[docpdf] ! File ended within \read.
[...]
```

Re-running `make doc-pdf` eventually succeeds. Clearly a partially-written bibliography file is somewhere read by another process.

Issue created by migration from https://trac.sagemath.org/ticket/28824





---

archive/issue_comments_403518.json:
```json
{
    "body": "In `local/share/doc/sage/latex/en/reference/rings_standard/rings_standard.log`:\n\n```\nPackage: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)\n)\nPackage xr Info: IMPORTING LABELS FROM ../references/references.aux on input li\nne 35.\n\nRunaway definition?\n->\\bibcite {index \n! File ended within \\read.\n<read 0> \n         \nl.35 \\externalcitedocument\n                          [../references/]{../references/references}\n? \n! Emergency stop.\n<read 0> \n         \nl.35 \\externalcitedocument\n                          [../references/]{../references/references}\nEnd of file on the terminal!\n```\n\nand `local/share/doc/sage/latex/en/reference/references/references.aux` looks just fine after make finishes.",
    "created_at": "2019-11-30T11:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403518",
    "user": "@vbraun"
}
```

In `local/share/doc/sage/latex/en/reference/rings_standard/rings_standard.log`:

```
Package: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)
)
Package xr Info: IMPORTING LABELS FROM ../references/references.aux on input li
ne 35.

Runaway definition?
->\bibcite {index 
! File ended within \read.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
? 
! Emergency stop.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
End of file on the terminal!
```

and `local/share/doc/sage/latex/en/reference/references/references.aux` looks just fine after make finishes.



---

archive/issue_comments_403519.json:
```json
{
    "body": "Possibly due to #28059",
    "created_at": "2019-11-30T11:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403519",
    "user": "@vbraun"
}
```

Possibly due to #28059



---

archive/issue_comments_403520.json:
```json
{
    "body": "hyperref and xr-hyper definitely is not operating atomically on the file system, so the only options are to run LaTeX in serial or use separate aux files.\n\nFor cross references to work in general (and parallel) we'd also have run LaTeX twice on each tex file, first to generate all references and then to build the actual pdf with the cross-references. That is:\n\n* For each tex file `foo.tex`: run `pdflatex foo.tex` to generate `foo.aux`\n* Combine the aux files into a `crossreferences.aux` file\n* For each tex file: run pdflatex again, but this time `\\input{crossreferences.aux}`\n\nIf we only want to include bibitems from the bibliography section then we don't have to do the whole thing, we can just create references.aux and include it in all the other files. This seems to be what is implemented, we should just not use xr-hyper (which will also write to references.aux) and instead manually include the references.aux (read only)",
    "created_at": "2019-11-30T11:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403520",
    "user": "@vbraun"
}
```

hyperref and xr-hyper definitely is not operating atomically on the file system, so the only options are to run LaTeX in serial or use separate aux files.

For cross references to work in general (and parallel) we'd also have run LaTeX twice on each tex file, first to generate all references and then to build the actual pdf with the cross-references. That is:

* For each tex file `foo.tex`: run `pdflatex foo.tex` to generate `foo.aux`
* Combine the aux files into a `crossreferences.aux` file
* For each tex file: run pdflatex again, but this time `\input{crossreferences.aux}`

If we only want to include bibitems from the bibliography section then we don't have to do the whole thing, we can just create references.aux and include it in all the other files. This seems to be what is implemented, we should just not use xr-hyper (which will also write to references.aux) and instead manually include the references.aux (read only)



---

archive/issue_comments_403521.json:
```json
{
    "body": "Actually xr-hyper doesn't write to `references.aux`. The problem is that the sage docbuilder is building first the references before all other ref manual parts (good), but then once more in parallel with all the rest (bad). The second build races, and we just shouldn't do that.",
    "created_at": "2019-11-30T13:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403521",
    "user": "@vbraun"
}
```

Actually xr-hyper doesn't write to `references.aux`. The problem is that the sage docbuilder is building first the references before all other ref manual parts (good), but then once more in parallel with all the rest (bad). The second build races, and we just shouldn't do that.



---

archive/issue_comments_403522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403522",
    "user": "@vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403523.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-11-30T13:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403523",
    "user": "@vbraun"
}
```

New commits:



---

archive/issue_comments_403524.json:
```json
{
    "body": "Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558\n\nCan you try this out Steve?",
    "created_at": "2019-11-30T19:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403524",
    "user": "@kiwifb"
}
```

Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558

Can you try this out Steve?



---

archive/issue_comments_403525.json:
```json
{
    "body": "Replying to [comment:8 fbissey]:\n> Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558\n> \n> Can you try this out Steve?\n\nI'm glad there is the expertise to fix these things. I thought the issue was somewhere under the `docbuild` folder but had no idea where. This allows building of the `pdf-docs` without issue. I'll build once more to save the `build.log` to see if anything odd is there.",
    "created_at": "2019-11-30T21:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403525",
    "user": "@strogdon"
}
```

Replying to [comment:8 fbissey]:
> Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558
> 
> Can you try this out Steve?

I'm glad there is the expertise to fix these things. I thought the issue was somewhere under the `docbuild` folder but had no idea where. This allows building of the `pdf-docs` without issue. I'll build once more to save the `build.log` to see if anything odd is there.



---

archive/issue_comments_403526.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-30T22:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403526",
    "user": "@strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403527.json:
```json
{
    "body": "Built the `pdf-docs` twice with `-j13` without incident. Without this branch the build would fail. Nothing odd in the `.log` file. The present approach looks fine to me.",
    "created_at": "2019-11-30T22:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403527",
    "user": "@strogdon"
}
```

Built the `pdf-docs` twice with `-j13` without incident. Without this branch the build would fail. Nothing odd in the `.log` file. The present approach looks fine to me.



---

archive/issue_comments_403528.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-01T22:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403528",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_403529.json:
```json
{
    "body": "Just to confirm: without this branch, I hit this race condition five times in ten tries. With this branch, ten successful runs in a row.",
    "created_at": "2019-12-01T23:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28587",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28587#issuecomment-403529",
    "user": "@jhpalmieri"
}
```

Just to confirm: without this branch, I hit this race condition five times in ten tries. With this branch, ten successful runs in a row.
