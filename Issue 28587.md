# Issue 28587: make doc-pdf race condition

Issue created by migration from https://trac.sagemath.org/ticket/28824

Original creator: vbraun

Original creation time: 2019-11-30 11:05:22

CC:  jhpalmieri fbissey strogdon

I'm hitting pretty reliably a race in the doc-pdf target:

```
$ make doc-clean && make -j10 doc-pdf
[...]
[docpdf] [59 [40
[docpdf] Runaway definition?
[docpdf] ->\bibcite {index 
[docpdf] ! File ended within \read.
[...]
```

Re-running `make doc-pdf` eventually succeeds. Clearly a partially-written bibliography file is somewhere read by another process.


---

Comment by vbraun created at 2019-11-30 11:08:57

In `local/share/doc/sage/latex/en/reference/rings_standard/rings_standard.log`:

```
Package: xr-hyper 2000/03/22 v6.00beta4 eXternal References (DPC)
)
Package xr Info: IMPORTING LABELS FROM ../references/references.aux on input li
ne 35.

Runaway definition?
->\bibcite {index 
! File ended within \read.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
? 
! Emergency stop.
<read 0> 
         
l.35 \externalcitedocument
                          [../references/]{../references/references}
End of file on the terminal!
```

and `local/share/doc/sage/latex/en/reference/references/references.aux` looks just fine after make finishes.


---

Comment by vbraun created at 2019-11-30 11:10:57

Possibly due to #28059


---

Comment by vbraun created at 2019-11-30 11:54:53

hyperref and xr-hyper definitely is not operating atomically on the file system, so the only options are to run LaTeX in serial or use separate aux files.

For cross references to work in general (and parallel) we'd also have run LaTeX twice on each tex file, first to generate all references and then to build the actual pdf with the cross-references. That is:

* For each tex file `foo.tex`: run `pdflatex foo.tex` to generate `foo.aux`
* Combine the aux files into a `crossreferences.aux` file
* For each tex file: run pdflatex again, but this time `\input{crossreferences.aux}`

If we only want to include bibitems from the bibliography section then we don't have to do the whole thing, we can just create references.aux and include it in all the other files. This seems to be what is implemented, we should just not use xr-hyper (which will also write to references.aux) and instead manually include the references.aux (read only)


---

Comment by vbraun created at 2019-11-30 13:28:03

Actually xr-hyper doesn't write to `references.aux`. The problem is that the sage docbuilder is building first the references before all other ref manual parts (good), but then once more in parallel with all the rest (bad). The second build races, and we just shouldn't do that.


---

Comment by vbraun created at 2019-11-30 13:29:36

Changing status from new to needs_review.


---

Comment by vbraun created at 2019-11-30 13:29:36

New commits:


---

Comment by fbissey created at 2019-11-30 19:35:28

Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558

Can you try this out Steve?


---

Comment by strogdon created at 2019-11-30 21:04:21

Replying to [comment:8 fbissey]:
> Steve Trogdon has been hit by this in sage-on-gentoo but I have been unable of reproducing it myself. https://github.com/cschwan/sage-on-gentoo/issues/558
> 
> Can you try this out Steve?

I'm glad there is the expertise to fix these things. I thought the issue was somewhere under the `docbuild` folder but had no idea where. This allows building of the `pdf-docs` without issue. I'll build once more to save the `build.log` to see if anything odd is there.


---

Comment by strogdon created at 2019-11-30 22:20:32

Changing status from needs_review to positive_review.


---

Comment by strogdon created at 2019-11-30 22:20:32

Built the `pdf-docs` twice with `-j13` without incident. Without this branch the build would fail. Nothing odd in the `.log` file. The present approach looks fine to me.


---

Comment by vbraun created at 2019-12-01 22:50:31

Resolution: fixed


---

Comment by jhpalmieri created at 2019-12-01 23:00:56

Just to confirm: without this branch, I hit this race condition five times in ten tries. With this branch, ten successful runs in a row.
