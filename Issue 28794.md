# Issue 28794: Actions cannot be pickled

Issue created by migration from https://trac.sagemath.org/ticket/29031

Original creator: tscrim

Original creation time: 2020-01-17 08:22:49

CC:  jdemeyer simonking nbruin

Keywords: actions

We cannot pickle actions:

```
sage: V = QQ^3
sage: v = V((1, 2, 3))
sage: cm = get_coercion_model()
sage: a = cm.get_action(V, QQ, operator.mul)
sage: dumps(a)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
[snip]
/home/travis/sage-build/local/lib/python3.7/site-packages/sage/categories/functor.pyx in sage.categories.functor.Functor.__reduce__ (build/cythonized/sage/categories/functor.c:2242)()
    212         """
    213         return (_Functor_unpickle,
--> 214                 (self.__class__, list(self.__dict__.items()),
    215                  self.__domain, self.__codomain))
    216 

AttributeError: 'sage.structure.coerce_actions.RightModuleAction' object has no attribute '__dict__'
```

This might require some custom `__reduce__` methods unless we give the corresponding Cython classes a `__dict__`.


---

Comment by tscrim created at 2020-01-17 08:24:43

Simon, Jeroen, do you have any ideas on how to best do this?


---

Comment by SimonKing created at 2020-01-17 08:38:59

I don't have time right now to look into the code, but if I recall correctly, we have different (cython-)types for different actions. I.e., in each case it is hard-coded what the action does (for instance: "apply the ._lmul_ method of the left factor to the the right factor" or so).

From what I recall, the input data for any action is the pair (acting parent, acted upon parent). Hence, something like

```python
def __reduce__(self):
    return type(self), (the two parents)
```

should work.


---

Comment by tscrim created at 2020-01-18 16:07:04

Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:

```
TypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)
is not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()
```

and I don't know how to get around that with the current attempt (of course, I can fall back to custom `__reduce__` for each class). I also have another issue irregardless, the `weakref` in the `Action.US` slot, and I don't know how to get the object. Any ideas?


---

Comment by nbruin created at 2020-01-18 22:14:23

Replying to [comment:3 tscrim]:
> Okay, so for this I was thinking `Functor` and its subclasses (in particular, `Action`) should mimic `Map` and have an `_extra_slots` and `_update_slots` methods. However, this doesn't work as I get errors of the form:
> {{{
> TypeError: sage.categories.functor.Functor.__new__(sage.structure.coerce_actions.LeftModuleAction)
> is not safe, use sage.structure.coerce_actions.LeftModuleAction.__new__()
> }}}
I think that's because actions have another memory layout. Looking at `coerce_action.pxd`, the problem is `ModuleAction`, so that would probably be the right spot to implement the custom `reduce`.

The fact that there's a weakref indicates the need for a custom reduce anyway, unless there's an established pattern recognized already (so that the reduce can exist higher up): the `US` slot is just a straight-up weakref, so you can dereference it with `self.US()`. If you get `None` than the acted-upon set was already garbage collected. Then the action is defunct and hence unpickleable.

You might be able to get away with the following on `Action`:

```
def __reduce__(self):
    return type(self), (self.G, self.underlying_set())
```

where `underlying_set` derefs the weakref and raises an error if defunct.

In the end, I think it's much safer to pickle these things with a call to the actual constructor than via a `new` and slot manipulations: it's much less implementation-dependent.

For the most part, I don't think these actions SHOULD be pickled anyway, but rather rediscovered. But because they should just be constructible from their actor and set, pickling them via a constructor is fairly straightforward.


---

Comment by tscrim created at 2020-01-19 03:59:00

Thanks for the explanations. I agree that these particular actions should not be pickled, but I was using them as easy examples for when an action is stored as an attribute of an object. In particular, this came up in #25902. I will implement custom `__reduce__` for the relevant classes.


---

Comment by tscrim created at 2020-01-19 04:14:39

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-01-19 04:14:39

Okay, here is the branch with the custom `__reduce__` methods.
----
New commits:


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by git created at 2020-07-14 19:45:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2020-08-14 12:46:43

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2020-08-14 12:46:43

Looks good to me, but it inserts 5 typos. Can you please do the following changes (5 times)?


```diff
-is can 
+can
```



---

Comment by git created at 2020-12-15 20:25:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2020-12-15 20:29:05

Changing status from needs_work to positive_review.


---

Comment by roed created at 2020-12-15 20:29:05

I fixed the documentation typos that slabbe pointed out, so I'm setting this to positive review.


---

Comment by vbraun created at 2020-12-27 00:23:30

Resolution: fixed
