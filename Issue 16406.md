# Issue 16406: integrate() infinite loop

archive/issues_016406.json:
```json
{
    "body": "Keywords: integration, maxima\n\nI interrupted Sage after 5min of churning without result:\n\n```\nsage: f=diff((tan(x)+x)*e^tan(x),x)\n(tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x)\nsage: integrate(f,x)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16643\n\n",
    "created_at": "2014-07-10T13:15:22Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "integrate() infinite loop",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16406",
    "user": "rws"
}
```
Keywords: integration, maxima

I interrupted Sage after 5min of churning without result:

```
sage: f=diff((tan(x)+x)*e^tan(x),x)
(tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x)
sage: integrate(f,x)
```


Issue created by migration from https://trac.sagemath.org/ticket/16643





---

archive/issue_comments_215494.json:
```json
{
    "body": "This may be a reportable issue upstream:\n\n```\nMaxima 5.33.0 http://maxima.sourceforge.net\nusing Lisp ECL 12.12.1\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) display2d: false;\n\n(%o1) false\n(%i2) load(abs_integrate);\n\n(%o2) \"/usr/local/sage/sage-git/local/share/maxima/5.33.0/share/contrib/integration/abs_integrate.mac\"\n(%i3) f: diff((tan(x)+x)*exp(tan(x)),x);\n\n(%o3) %e^tan(x)*sec(x)^2*(tan(x)+x)+%e^tan(x)*(sec(x)^2+1)\n(%i4) integrate(f,x);\n\nMaxima encountered a Lisp error:\n\n In function CAR, the value of the first argument is\n  0\nwhich is not of the expected type LIST\n\nAutomatically continuing.\nTo enable the Lisp debugger set *debugger-hook* to nil.\n```\n\nWithout the `load(abs_integrate)` the code seems to execute fine (by returning the integral unevaluated). This does not fully explain why sage seems to get stuck on it, though. Perhaps a try/except that is a little too agressive in suppressing problems?\n\nAlso, the problem does not arise in Maxima 5.30.0 on SBCL 1.1.8-2, so it may be a problem with maxima-ecl interaction (so it depends a little on how well the maxima-devs want to support ECL)\n\nAlso executing `domain: complex;load(to_poly_solve);load(simplify_sum);` (as we do in sage) doesn't affect the outcome.",
    "created_at": "2014-07-10T14:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215494",
    "user": "nbruin"
}
```

This may be a reportable issue upstream:

```
Maxima 5.33.0 http://maxima.sourceforge.net
using Lisp ECL 12.12.1
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) display2d: false;

(%o1) false
(%i2) load(abs_integrate);

(%o2) "/usr/local/sage/sage-git/local/share/maxima/5.33.0/share/contrib/integration/abs_integrate.mac"
(%i3) f: diff((tan(x)+x)*exp(tan(x)),x);

(%o3) %e^tan(x)*sec(x)^2*(tan(x)+x)+%e^tan(x)*(sec(x)^2+1)
(%i4) integrate(f,x);

Maxima encountered a Lisp error:

 In function CAR, the value of the first argument is
  0
which is not of the expected type LIST

Automatically continuing.
To enable the Lisp debugger set *debugger-hook* to nil.
```

Without the `load(abs_integrate)` the code seems to execute fine (by returning the integral unevaluated). This does not fully explain why sage seems to get stuck on it, though. Perhaps a try/except that is a little too agressive in suppressing problems?

Also, the problem does not arise in Maxima 5.30.0 on SBCL 1.1.8-2, so it may be a problem with maxima-ecl interaction (so it depends a little on how well the maxima-devs want to support ECL)

Also executing `domain: complex;load(to_poly_solve);load(simplify_sum);` (as we do in sage) doesn't affect the outcome.



---

archive/issue_comments_215495.json:
```json
{
    "body": "The following helps perhaps to locate the problematic code. The following fragment does complete (but after considerable time):\n\n```\nfrom sage.interfaces.maxima_lib import *\nargs=((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)\nexpr=EclObject(([max_integrate],[sr_to_max(SR(a)) for a in args]))\nresult=maxima_eval(expr)\nmax_to_sr(result)\n```\n\nthis is the code the integrator would execute, and it does return the integral unevaluated. So somehow we're avoiding the error above.\n\nIndeed, the difference seems to be how you feed the expression. Sage actually DOES return this integral (unevaluated), it just takes longer. The difference is in how you give the integral. The expression for the derivative that maxima computes gives the result above. However, the form computed by sage still works. If you do in maxima\n\n```\n...\n(%i6) f: (tan(x)^2 + 1)*(x + tan(x))*exp(tan(x)) + (tan(x)^2 + 2)*exp(tan(x));\n\n(%o6) %e^tan(x)*(tan(x)^2+2)+%e^tan(x)*(tan(x)+x)*(tan(x)^2+1)\n(%i7) integrate(f,x);\n\n(%o7) 'integrate(%e^tan(x)*(tan(x)^2+2)+%e^tan(x)*(tan(x)+x)*(tan(x)^2+1),x)\n```\n\neverything is fine.\n\nSo the only report for Maxima is the above question why ECL runs into an error for the particular integral given there. This integral is not the one encountered with the original sage script and the sage code does finish correctly (albeit after a rather long time).",
    "created_at": "2014-07-10T15:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215495",
    "user": "nbruin"
}
```

The following helps perhaps to locate the problematic code. The following fragment does complete (but after considerable time):

```
from sage.interfaces.maxima_lib import *
args=((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)
expr=EclObject(([max_integrate],[sr_to_max(SR(a)) for a in args]))
result=maxima_eval(expr)
max_to_sr(result)
```

this is the code the integrator would execute, and it does return the integral unevaluated. So somehow we're avoiding the error above.

Indeed, the difference seems to be how you feed the expression. Sage actually DOES return this integral (unevaluated), it just takes longer. The difference is in how you give the integral. The expression for the derivative that maxima computes gives the result above. However, the form computed by sage still works. If you do in maxima

```
...
(%i6) f: (tan(x)^2 + 1)*(x + tan(x))*exp(tan(x)) + (tan(x)^2 + 2)*exp(tan(x));

(%o6) %e^tan(x)*(tan(x)^2+2)+%e^tan(x)*(tan(x)+x)*(tan(x)^2+1)
(%i7) integrate(f,x);

(%o7) 'integrate(%e^tan(x)*(tan(x)^2+2)+%e^tan(x)*(tan(x)+x)*(tan(x)^2+1),x)
```

everything is fine.

So the only report for Maxima is the above question why ECL runs into an error for the particular integral given there. This integral is not the one encountered with the original sage script and the sage code does finish correctly (albeit after a rather long time).



---

archive/issue_comments_215496.json:
```json
{
    "body": "I changed the title and description, because I found evidence there is no infinite loop involved. Please change back if you're unhappy with the change.",
    "created_at": "2014-07-10T15:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215496",
    "user": "nbruin"
}
```

I changed the title and description, because I found evidence there is no infinite loop involved. Please change back if you're unhappy with the change.



---

archive/issue_comments_215497.json:
```json
{
    "body": "See also #12731.",
    "created_at": "2014-12-08T15:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215497",
    "user": "kcrisman"
}
```

See also #12731.



---

archive/issue_comments_215498.json:
```json
{
    "body": "It's claimed that upstream has this 'fixed' in some sense now.",
    "created_at": "2014-12-15T13:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215498",
    "user": "kcrisman"
}
```

It's claimed that upstream has this 'fixed' in some sense now.



---

archive/issue_comments_215499.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-12-16T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215499",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_215500.json:
```json
{
    "body": "With Maxima 5.34.1 and also with 5.35.1 (see #17514), both integrals are returned unevaluated:\n\n```\nsage: f = diff((tan(x) + x) * e^tan(x), x)\nsage: %time integrate(f, x)\nCPU times: user 5min 32s, sys: 12 ms, total: 5min 32s\nWall time: 5min 33s\nintegrate((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)\nsage: g = e^tan(x) * sec(x)^2 * (tan(x) + x) + e^tan(x) * (sec(x)^2 + 1)\nsage: %time integrate(g,x)\nCPU times: user 4min 43s, sys: 128 ms, total: 4min 44s\nWall time: 4min 44s\nintegrate((x + tan(x))*e^tan(x)*sec(x)^2 + (sec(x)^2 + 1)*e^tan(x), x)\n```\n\nI propose to close this since the ECL error appears to have been fixed upstream and the example takes too long to be a sensible doctest.",
    "created_at": "2014-12-16T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215500",
    "user": "pbruin"
}
```

With Maxima 5.34.1 and also with 5.35.1 (see #17514), both integrals are returned unevaluated:

```
sage: f = diff((tan(x) + x) * e^tan(x), x)
sage: %time integrate(f, x)
CPU times: user 5min 32s, sys: 12 ms, total: 5min 32s
Wall time: 5min 33s
integrate((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)
sage: g = e^tan(x) * sec(x)^2 * (tan(x) + x) + e^tan(x) * (sec(x)^2 + 1)
sage: %time integrate(g,x)
CPU times: user 4min 43s, sys: 128 ms, total: 4min 44s
Wall time: 4min 44s
integrate((x + tan(x))*e^tan(x)*sec(x)^2 + (sec(x)^2 + 1)*e^tan(x), x)
```

I propose to close this since the ECL error appears to have been fixed upstream and the example takes too long to be a sensible doctest.



---

archive/issue_comments_215501.json:
```json
{
    "body": "> some terrifyingly huge trig expression\n\nsays upstream... though I am agnostic on whether to close this, one could repurpose it as \"make this integral faster\" and ask upstream for that (or see if Sympy can do it faster, or whatever).",
    "created_at": "2014-12-16T16:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215501",
    "user": "kcrisman"
}
```

> some terrifyingly huge trig expression

says upstream... though I am agnostic on whether to close this, one could repurpose it as "make this integral faster" and ask upstream for that (or see if Sympy can do it faster, or whatever).



---

archive/issue_comments_215502.json:
```json
{
    "body": "SymPy is much faster to concede defeat.\n\n```\nsage: f=(tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x)\nsage: %time integrate(f,x)\nCPU times: user 5min 45s, sys: 219 ms, total: 5min 45s\nWall time: 5min 45s\nintegrate((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)\nsage: import sympy\nsage: x = sympy.Symbol('x')\nsage: %time sympy.integrate(f,x)\nCPU times: user 9.51 s, sys: 36 ms, total: 9.54 s\nWall time: 9.52 s\nIntegral((x + tan(x))*(tan(x)**2 + 1)*exp(tan(x)) + (tan(x)**2 + 2)*exp(tan(x)), x)\n```\n",
    "created_at": "2015-01-02T07:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215502",
    "user": "rws"
}
```

SymPy is much faster to concede defeat.

```
sage: f=(tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x)
sage: %time integrate(f,x)
CPU times: user 5min 45s, sys: 219 ms, total: 5min 45s
Wall time: 5min 45s
integrate((tan(x)^2 + 1)*(x + tan(x))*e^tan(x) + (tan(x)^2 + 2)*e^tan(x), x)
sage: import sympy
sage: x = sympy.Symbol('x')
sage: %time sympy.integrate(f,x)
CPU times: user 9.51 s, sys: 36 ms, total: 9.54 s
Wall time: 9.52 s
Integral((x + tan(x))*(tan(x)**2 + 1)*exp(tan(x)) + (tan(x)**2 + 2)*exp(tan(x)), x)
```




---

archive/issue_comments_215503.json:
```json
{
    "body": "Yeah, probably can't have a ticket that says \"make integrals that take a long time faster\", too vague.",
    "created_at": "2015-02-03T03:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215503",
    "user": "kcrisman"
}
```

Yeah, probably can't have a ticket that says "make integrals that take a long time faster", too vague.



---

archive/issue_comments_215504.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-03T03:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215504",
    "user": "kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_215505.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2015-02-08T15:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16406",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16406#issuecomment-215505",
    "user": "vbraun"
}
```

Resolution: invalid
