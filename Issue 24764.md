# Issue 24764: gfortran breaks parallel build

Issue created by migration from https://trac.sagemath.org/ticket/25001

Original creator: vbraun

Original creation time: 2018-03-18 10:37:20

CC:  embray

Keywords: random_fail

gfortran overwrites compiler parts non-atomically; This breaks parallel compilation:

```
[gfortran-7.2.0] /bin/sh ../../src/gcc/../mkinstalldirs /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] mkdir /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] /usr/bin/install -c gengtype /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin/gengtype
[gfortran-7.2.0] for file in gnat1 brig1 cc1 cc1plus f951 go1  lto1 cc1obj cc1objplus; do \
[gfortran-7.2.0]          if [ -f $file ] ; then \
[gfortran-7.2.0]            rm -f /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]            /usr/bin/install -c $file /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]          else true; \
[gfortran-7.2.0]          fi; \
[gfortran-7.2.0]        done
[flint-2.5.2.p2] gcc: error trying to exec 'cc1': execvp: No such file or directory
[flint-2.5.2.p2] make[4]: *** [../build/fmpq_poly/test/t-scalar_mul_si] Error 1
[flint-2.5.2.p2] gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include test/t-scalar_mul_ui.c ../build/fmpq_poly/../../test_helpers.o -o ../build/fmpq_poly/test/t-scalar_mul_ui -L/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -MMD -MP -MF ../build/fmpq_poly/test/t-scalar_mul_ui.d -MT "../build/fmpq_poly/test/t-scalar_mul_ui" -MT "../build/fmpq_poly/test/t-scalar_mul_ui.d"
```



---

Comment by jdemeyer created at 2018-03-18 15:37:03

Why is gfortran installing `gcc` in the first place?


---

Comment by fbissey created at 2018-03-18 17:37:00

Because you cannot build gfortran without a minimal gcc at this stage. There is a section at the end of spkg-install that renames it so it is not in the way. Patching to avoid install is hard.


---

Comment by jdemeyer created at 2018-03-18 19:36:07

Replying to [comment:2 fbissey]:
> Because you cannot build gfortran without a minimal gcc at this stage.

Building, I understand. But _installing_?


---

Comment by fbissey created at 2018-03-18 19:43:36

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 fbissey]:
> > Because you cannot build gfortran without a minimal gcc at this stage.
> 
> Building, I understand. But _installing_?

I know what you mean but as far as I know you cannot build it without it being an install target. If you know some more configure/install options feel free to enlighten me. Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system. You could fix something like that in the staging area before merging the install on the system.


---

Comment by fbissey created at 2018-03-18 23:14:39

There is a hack we could use, configure with one of `--program-prefix` or `--program-suffix` and then link the resulting `gfortran` binary to the expected name. Says we pass `--program-prefix=sage` and then we will have `sage-gcc`, `sage-gfortran` and so on installed. As the last step we create a link `gfortran` to `sage-gfortran` and since `sage-{gcc,g++}` is not an expected name for other configure scripts, we should be safe.


---

Comment by vbraun created at 2018-03-19 07:59:42

Or maybe just not compile other stuff until gfortran is complete, like gcc


---

Comment by jdemeyer created at 2018-03-19 08:06:37

Replying to [comment:4 fbissey]:
> Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system.

+1


---

Comment by jdemeyer created at 2018-03-19 08:07:38

I'll try the staged install, just to see whether it might work.


---

Comment by git created at 2018-03-19 08:32:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-19 08:52:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-19 09:03:19

Changing status from new to needs_review.


---

Comment by fbissey created at 2018-03-19 09:08:05

If the bits in `sage-spkg` do their jobs as expected then it looks good to me.


---

Comment by embray created at 2018-03-19 11:13:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-03-21 06:19:11

Resolution: fixed
