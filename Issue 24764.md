# Issue 24764: gfortran breaks parallel build

archive/issues_024764.json:
```json
{
    "body": "CC:  @embray\n\nKeywords: random_fail\n\ngfortran overwrites compiler parts non-atomically; This breaks parallel compilation:\n\n```\n[gfortran-7.2.0] /bin/sh ../../src/gcc/../mkinstalldirs /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin\n[gfortran-7.2.0] mkdir /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin\n[gfortran-7.2.0] /usr/bin/install -c gengtype /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin/gengtype\n[gfortran-7.2.0] for file in gnat1 brig1 cc1 cc1plus f951 go1  lto1 cc1obj cc1objplus; do \\\n[gfortran-7.2.0]          if [ -f $file ] ; then \\\n[gfortran-7.2.0]            rm -f /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \\\n[gfortran-7.2.0]            /usr/bin/install -c $file /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \\\n[gfortran-7.2.0]          else true; \\\n[gfortran-7.2.0]          fi; \\\n[gfortran-7.2.0]        done\n[flint-2.5.2.p2] gcc: error trying to exec 'cc1': execvp: No such file or directory\n[flint-2.5.2.p2] make[4]: *** [../build/fmpq_poly/test/t-scalar_mul_si] Error 1\n[flint-2.5.2.p2] gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include test/t-scalar_mul_ui.c ../build/fmpq_poly/../../test_helpers.o -o ../build/fmpq_poly/test/t-scalar_mul_ui -L/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -MMD -MP -MF ../build/fmpq_poly/test/t-scalar_mul_ui.d -MT \"../build/fmpq_poly/test/t-scalar_mul_ui\" -MT \"../build/fmpq_poly/test/t-scalar_mul_ui.d\"\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25001\n\n",
    "created_at": "2018-03-18T10:37:20Z",
    "labels": [
        "build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "gfortran breaks parallel build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24764",
    "user": "@vbraun"
}
```
CC:  @embray

Keywords: random_fail

gfortran overwrites compiler parts non-atomically; This breaks parallel compilation:

```
[gfortran-7.2.0] /bin/sh ../../src/gcc/../mkinstalldirs /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] mkdir /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin
[gfortran-7.2.0] /usr/bin/install -c gengtype /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/plugin/gengtype
[gfortran-7.2.0] for file in gnat1 brig1 cc1 cc1plus f951 go1  lto1 cc1obj cc1objplus; do \
[gfortran-7.2.0]          if [ -f $file ] ; then \
[gfortran-7.2.0]            rm -f /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]            /usr/bin/install -c $file /Users/buildslave-sage/slave/sage_git/build/local/libexec/gcc/x86_64-apple-darwin17.4.0/7.2.0/$file; \
[gfortran-7.2.0]          else true; \
[gfortran-7.2.0]          fi; \
[gfortran-7.2.0]        done
[flint-2.5.2.p2] gcc: error trying to exec 'cc1': execvp: No such file or directory
[flint-2.5.2.p2] make[4]: *** [../build/fmpq_poly/test/t-scalar_mul_si] Error 1
[flint-2.5.2.p2] gcc -fno-common -ansi -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include test/t-scalar_mul_ui.c ../build/fmpq_poly/../../test_helpers.o -o ../build/fmpq_poly/test/t-scalar_mul_ui -L/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p2/src -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -L/Users/buildslave-sage/slave/sage_git/build/local/lib -lflint -lmpfr -lgmp -lm -lntl -lpthread  -MMD -MP -MF ../build/fmpq_poly/test/t-scalar_mul_ui.d -MT "../build/fmpq_poly/test/t-scalar_mul_ui" -MT "../build/fmpq_poly/test/t-scalar_mul_ui.d"
```


Issue created by migration from https://trac.sagemath.org/ticket/25001





---

archive/issue_comments_347616.json:
```json
{
    "body": "Why is gfortran installing `gcc` in the first place?",
    "created_at": "2018-03-18T15:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347616",
    "user": "@jdemeyer"
}
```

Why is gfortran installing `gcc` in the first place?



---

archive/issue_comments_347617.json:
```json
{
    "body": "Because you cannot build gfortran without a minimal gcc at this stage. There is a section at the end of spkg-install that renames it so it is not in the way. Patching to avoid install is hard.",
    "created_at": "2018-03-18T17:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347617",
    "user": "@kiwifb"
}
```

Because you cannot build gfortran without a minimal gcc at this stage. There is a section at the end of spkg-install that renames it so it is not in the way. Patching to avoid install is hard.



---

archive/issue_comments_347618.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> Because you cannot build gfortran without a minimal gcc at this stage.\n\nBuilding, I understand. But *installing*?",
    "created_at": "2018-03-18T19:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347618",
    "user": "@jdemeyer"
}
```

Replying to [comment:2 fbissey]:
> Because you cannot build gfortran without a minimal gcc at this stage.

Building, I understand. But *installing*?



---

archive/issue_comments_347619.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> Replying to [comment:2 fbissey]:\n> > Because you cannot build gfortran without a minimal gcc at this stage.\n> \n> Building, I understand. But *installing*?\n\nI know what you mean but as far as I know you cannot build it without it being an install target. If you know some more configure/install options feel free to enlighten me. Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system. You could fix something like that in the staging area before merging the install on the system.",
    "created_at": "2018-03-18T19:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347619",
    "user": "@kiwifb"
}
```

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 fbissey]:
> > Because you cannot build gfortran without a minimal gcc at this stage.
> 
> Building, I understand. But *installing*?

I know what you mean but as far as I know you cannot build it without it being an install target. If you know some more configure/install options feel free to enlighten me. Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system. You could fix something like that in the staging area before merging the install on the system.



---

archive/issue_comments_347620.json:
```json
{
    "body": "There is a hack we could use, configure with one of `--program-prefix` or `--program-suffix` and then link the resulting `gfortran` binary to the expected name. Says we pass `--program-prefix=sage` and then we will have `sage-gcc`, `sage-gfortran` and so on installed. As the last step we create a link `gfortran` to `sage-gfortran` and since `sage-{gcc,g++}` is not an expected name for other configure scripts, we should be safe.",
    "created_at": "2018-03-18T23:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347620",
    "user": "@kiwifb"
}
```

There is a hack we could use, configure with one of `--program-prefix` or `--program-suffix` and then link the resulting `gfortran` binary to the expected name. Says we pass `--program-prefix=sage` and then we will have `sage-gcc`, `sage-gfortran` and so on installed. As the last step we create a link `gfortran` to `sage-gfortran` and since `sage-{gcc,g++}` is not an expected name for other configure scripts, we should be safe.



---

archive/issue_comments_347621.json:
```json
{
    "body": "Or maybe just not compile other stuff until gfortran is complete, like gcc",
    "created_at": "2018-03-19T07:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347621",
    "user": "@vbraun"
}
```

Or maybe just not compile other stuff until gfortran is complete, like gcc



---

archive/issue_comments_347622.json:
```json
{
    "body": "Replying to [comment:4 fbissey]:\n> Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system.\n\n+1",
    "created_at": "2018-03-19T08:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347622",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 fbissey]:
> Otherwise this is a perfect scenario for Erik's work on staging the install rather than installing directly on the system.

+1



---

archive/issue_comments_347623.json:
```json
{
    "body": "I'll try the staged install, just to see whether it might work.",
    "created_at": "2018-03-19T08:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347623",
    "user": "@jdemeyer"
}
```

I'll try the staged install, just to see whether it might work.



---

archive/issue_comments_347624.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-19T08:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347624",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347625.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-19T08:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347625",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_347626.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-19T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347626",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_347627.json:
```json
{
    "body": "If the bits in `sage-spkg` do their jobs as expected then it looks good to me.",
    "created_at": "2018-03-19T09:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347627",
    "user": "@kiwifb"
}
```

If the bits in `sage-spkg` do their jobs as expected then it looks good to me.



---

archive/issue_comments_347628.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-19T11:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347628",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_347629.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-21T06:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24764",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24764#issuecomment-347629",
    "user": "@vbraun"
}
```

Resolution: fixed
