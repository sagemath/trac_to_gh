# Issue 21470: Split sage-env into sage-build-env and sage-env

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-10-15 06:08:58

CC:  embray jdemeyer leif fbissey dimpase isuruf arojas infinity0 @timokau mjo jhpalmieri @tobiasdiez

`sage-env` is used by both Sage-the-distribution while building packages,
and by Sage at runtime.

It should be split into two separate scripts.
 - `sage-build-env` should go into `build/bin` and not be installed.
 - `sage-env` should be installed by `src/setup.py` (thus very late in the build process), rather than by `build/make/Makefile`. 

(`sage-env` will be very short and at some point hopefully disappear, if we want sagelib to become a standalone Python library - #21507)

This is a step towards the cleaning of `src/bin` as described in #21569, #21570, #21559.


---

Comment by fbissey created at 2016-10-15 08:54:42

One comment. Currently `sage_setup` is installed because it needs to be installed to be doctested - like the rest of sage. But nothing in `sage_setup` is really needed at runtime and distro can choose not to install it. I don't in sage-on-gentoo. I tend to push for thing not needed at runtime to be moved in there. And that's where I would have put `sage-build-env` but I am not going to fight it going into `build/bin` although I'd like everything used by `setup.py` to be neatly under `src`.


---

Comment by mkoeppe created at 2016-10-15 18:53:56

Thanks - I've updated the description


---

Comment by embray created at 2016-10-17 09:25:04

I agree.

Consider a slight alternative: Rewrite sage-env as a Python script.  This would give it much more flexibility and probably more legibility, including some command-line options for different environments (`--build`, especially).

The output would of course be the shell commands to actually set the variables. So rather than `source sage-env` one would `eval $(sage-env)`.  My one concern is that it would be slower, but ideally it's something that shouldn't happen frequently anyways, but rather only when not already in sage-env.


---

Comment by fbissey created at 2016-10-17 09:30:20

I have a tendency to mix up `sage-env` the script and `sage.env.py`, my comment is really an example of that. However a lot is common between the two.


---

Comment by embray created at 2016-10-17 09:39:48

Right--they could be one in the same.


---

Comment by fbissey created at 2016-10-17 09:46:17

Replying to [comment:6 embray]:
> Right--they could be one in the same.
 I have thought about it often. Of course that really means that you'll have to removing all the build time stuff. But in sage-on-gentoo where I ship a very simplified sage-env (in /etc as well) they are virtually doing the same thing, one in shell, the other in python.


---

Comment by embray created at 2016-10-17 09:55:32

In either case--whether making a single script, or two separate shell scripts, this would be useful for gentoo (and probably other distros as well) then right?


---

Comment by fbissey created at 2016-10-17 09:59:20

Probably, the current `sage-env` is a forest mostly dedicated to the build system. I just discard it and bring my own, it takes less space and maintenance than a mega patch.


---

Comment by mkoeppe created at 2016-10-17 14:34:14

Ideally, the configuration for sagelib runtime should take place in a generated Python file and not involve environment variables at all.


---

Comment by embray created at 2016-10-17 14:40:26

More likely parts of it would be static, and other parts could be generated, but yes, what I meant above in terms of rewriting `sage-env` in Python was that it would not (by default) involve environment variables at all.

But it's still useful for interacting with other tools, especially for build purposes, as well as dropping into `./sage -sh` to be able to set environment variables, which is why I suggest a mode to output a list of variables that can be read from the shell.


---

Comment by mkoeppe created at 2019-05-20 00:31:50

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2019-05-20 00:31:50

New commits:


---

Comment by embray created at 2019-05-21 15:19:50

As-is this is going to conflict with tickets like #27825 that are adding still more environment variables needed at build-time to sage-env-config.

I'm completely in favor of this separation in principle though.  The question is whether we should do this first and then update tickets like #27825 on top of it, or the other way around?


---

Comment by dimpase created at 2019-05-21 15:25:29

I really would like to first get our existing tickets (#27825, #27822) touching sage-env-config in.


---

Comment by mkoeppe created at 2019-05-22 20:34:34

The tickets would be trivial to rebase on top of this one.


---

Comment by mkoeppe created at 2019-05-23 15:08:52

Probably one should introduce a command `sage --buildsh`, which would provide the larger environment.


---

Comment by embray created at 2019-07-01 12:44:57

For the sake of a bit more terseness I wonder if we could call it just `sage-env-build.in` and `sage-env-build`.  The only reason for the `-config` in the other one is to distinguish it from plain `sage-env`.

Now that I look I'm not even entirely sure we need to separate `sage-env-config` from `sage-env`.

I think we could probably have a `sage-env.in` produce `sage-env` and get rid of the separate `sage-env-config` entirely, though it's possible there's some subtlety to that that I'm missing.


---

Comment by embray created at 2019-07-01 12:57:45

Went ahead and rebased on current develop so it could incorporate all the additional variables we've since added.

I didn't change the name of the script yet; I would still prefer to shorten it but if anyone disagrees we can leave it as-is.
----
New commits:


---

Comment by fbissey created at 2019-07-01 20:45:04

The only subtility to `sage-env-config` in my mind, is that you can touch it or even regenerate it without touching `sage-env`. But I am sure you don't need a separate file to achieve your objectives in either case.


---

Comment by embray created at 2019-07-02 12:02:33

No, probably not.  I might try it, though we'll leave that as a separate exercise from this ticket.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-01-15 22:55:43

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-01-15 23:36:44

The run-time environment variables of sage could as well be configured by a Python module `src/sage/env_config.py` - see #29022.


---

Comment by mkoeppe created at 2020-01-15 23:55:47

Replying to [comment:17 mkoeppe]:
> Probably one should introduce a command `sage --buildsh`, which would provide the larger environment.

As an extension of this, there could be `sage --buildsh SPKG`, which would set up the environment in which `spkg-install` runs. This could be useful for testing new versions of packages.


---

Comment by mkoeppe created at 2020-01-18 19:20:14

Replying to [comment:25 mkoeppe]:
> The run-time environment variables of sage could as well be configured by a Python module `src/sage/env_config.py` - see #29022.
Or #29038 - Python package sage_conf: Provides optional configuration information for sagelib


---

Comment by mkoeppe created at 2020-01-19 17:12:56

Changing status from needs_work to needs_info.


---

Comment by mkoeppe created at 2020-01-19 17:12:56

Changing type from enhancement to task.


---

Comment by mkoeppe created at 2020-01-19 17:12:56

Hoping for input from people involved in packaging.


---

Comment by mkoeppe created at 2020-01-20 14:20:34

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-03-29 00:49:46

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-05-27 15:55:55

Changing keywords from "" to "sd109".


---

Comment by @tobiasdiez created at 2020-10-23 22:22:07

Not sure if this is the right place, but I would suggest to use the refactoring process to also convert the environment variables to configuration files. 

The idea would be to have a `toml` file (or `yaml` or whatever you prefer) in some predefined folder (say `src` for the start). This file could be generated e.g by the `configure` script. This config file is then parsed and wrapped by a python class (natural candidate would be the current `sage_conf.py`). The python class also provides reasonable default values in case the config file doesn't exist. 

This has several advantages in my opinion:
- More transparent, as one sees on one glance which variables influence sage.
- Easily editable by the user/developer.
- Local (e.g. think about multiple virtual environments with different configs).
- Type-safe, i.e, it is ensured when parsing the toml file that the types of the config variables is correct.
- Easier for downstream package managers, since they only need to provide a proper config file.
- (Higher security as one cannot inject arbitrary python code, which would be the case if `sage_conf.py` should be edited.)

What do you think?


---

Comment by mkoeppe created at 2020-10-23 22:37:07

`sage_conf` defines an interface already - and the plan is indeed to get rid of dependencies on environment variables using this interface.

How `sage_conf` obtains the configuration is orthogonal to the defined interface.

I am not interested in defining configuration files at the moment.  There is just too much potential on wasting energy on discussions regarding the "best" config file format.


---

Comment by @tobiasdiez created at 2020-10-25 10:37:39

Well, you are actually proposing to add a configuration file in the form of a python file (`sage_conf.py`). One could easily bypass an extensive discussion and follow the arguments of https://www.python.org/dev/peps/pep-0518/#overview-of-file-formats-considered.

But I agree that my suggestion concerning a config file is somewhat out of line with the goal of this ticket. I would still suggest to keep this in mind while designing the interface for `sage_conf`, so that it might be easy in the future to switch to a design based on a config file. In particular, I would replace the module wide variables (like `VERSION`) with methods in a config class (like `Config.get_version`) that can also provide suitable defaults and do slight post-processing.


---

Comment by mkoeppe created at 2020-10-25 15:15:54

Replying to [comment:52 gh-tobiasdiez]:
> Well, you are actually proposing to add a configuration file in the form of a python file (`sage_conf.py`).

Note that `sage_conf.py` is already in use since Sage 9.1


---

Comment by mkoeppe created at 2020-10-25 15:22:39

Replying to [comment:52 gh-tobiasdiez]:
> I would still suggest to keep this in mind while designing the interface for `sage_conf`, so that it might be easy in the future to switch to a design based on a config file. In particular, I would replace the module wide variables (like `VERSION`) with methods in a config class (like `Config.get_version`) that can also provide suitable defaults and do slight post-processing. 

All of this discussion is certainly valid and I am sure that you (and others) have valuable insights there, but now is simply not the right time for it. To get the design right, one needs to know about objectives and constraints. We are in the process of expanding the ways of Sage installation/deployment into several directions, including pip-installability and modularization; and also binary packaging will need an overhaul.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-05 20:10:19

From the discussion in #32904 regarding `sage_conf` at build time (with pip's build isolation) vs. runtime:
- pip specifies "ignore-installed" while constructing the build environment and thus will build sage-conf twice. https://github.com/pypa/pip/blob/main/src/pip/_internal/build_env.py#L221
- The PyPI version `sage_conf` (from #29039) keys the `SAGE_ROOT`/`SAGE_LOCAL` that it creates in `~/.sage` to the version of `sage_conf`
- So if the `sage_conf` version is not completely pinned in the `sagemath-standard` build and install requirements, then different versions (and thus `SAGE_ROOT`s) may end up being used at build and install of `sagemath-standard`


---

Comment by mkoeppe created at 2021-12-05 20:17:54

From #32904#comment:24:
 - Split `sage-conf` into build and runtime configuration. There is still an overlap (and thus duplication) but at built time sage needs less dependencies than at runtime. In addition, maybe directly incorporate the build-time `sage-conf` in the sagemath package.


---

Comment by mkoeppe created at 2021-12-05 20:19:52

Replying to [comment:60 mkoeppe]:
> From gh-tobiasdiez in #32904#comment:24:
>  - Split `sage-conf` into build and runtime configuration. There is still an overlap (and thus duplication) but at build time sage needs less dependencies than at runtime. In addition, maybe directly incorporate the build-time `sage-conf` in the sagemath package.

I think this is an interesting direction
