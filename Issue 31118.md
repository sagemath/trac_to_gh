# Issue 31118: upgrade lrslib to 2.0

Issue created by migration from https://trac.sagemath.org/ticket/31355

Original creator: tmonteil

Original creation time: 2021-02-07 16:27:16

CC:  arojas ​aschilling chapoton ​tscrim @thierry-freebsd mjo mkoeppe fbissey asbuch slelievre

lrslib 2.0 is out https://bitbucket.org/asbuch/lrcalc/src/master/ChangeLog


---

Comment by tmonteil created at 2021-02-07 17:37:20

I get the following error when doctesting:


```
ImportError: /opt/sagemath/sage/local/lib/python3.7/site-packages/sage/libs/lrcalc/lrcalc.cpython-37m-x86_64-linux-gnu.so: undefined symbol: st_new
```

----
New commits:


---

Comment by arojas created at 2021-02-07 17:47:30

This has major API changes. Large parts of lrcalc.pyx needs to be rewritten because the used functions have been removed or modified.


---

Comment by tmonteil created at 2021-02-07 18:29:14

I see, any help welcome !


---

Comment by mjo created at 2021-02-11 01:57:26

The existing spkg-configure.m4 needs to be updated to detect v2.0 (once it actually works), too.


---

Comment by nthiery created at 2021-02-16 06:37:20

Some information from Anders:

> I recently put out a new version of my lrcalc program, much of it is
> rewritten, and some of the most important functions are close to twice as fast
> as before.  Some special cases have also been optimized to run a lot faster.
>
> I have included some (pure) Python3 bindings in the repository, so I think
> this update will be easy.  But I don't understand Sage well enough to do it
> myself.

For reference, some pointers:

- Sage's lrcalc package: https://git.sagemath.org/sage.git/tree/build/pkgs/lrcalc
- Sage's lrcalc bindings: https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/libs/lcalc


---

Comment by @asbuch created at 2021-02-16 22:25:47

The Python bindings are only in the repository and a bit raw, so probably only useful as examples.  But I expect they are easier to start from than the .h files.


---

Comment by arojas created at 2021-02-21 12:05:58

Replying to [comment:10 gh-asbuch]:
> The Python bindings are only in the repository and a bit raw, so probably only useful as examples.  But I expect they are easier to start from than the .h files.

Actually, they are almost equivalent to the current bindings in Sage. The attached branch replaces lrcalc.pyx with a thin wrapper over lrcalc's bindings.

It mostly just translates the output from lrcalc to sage notation. The only function of lrcalc.pyx that isn't straghtforward to port is quantum multiplication: I found no way to recover the q-grading from lrcalc's output, so this is reimplemented in the patch.

The branch needs an update of lrcalc to include python bindings.
----
New commits:


---

Comment by arojas created at 2021-02-21 12:09:30

Replying to [comment:10 gh-asbuch]:
> The Python bindings are only in the repository and a bit raw, so probably only useful as examples.  But I expect they are easier to start from than the .h files.

Since you are here and I can not find a bug tracker for lrcalc: the setup.py is missing metadata, so the egg for lrcalc gets installed as UNKNOWN-0.0.0.0


---

Comment by git created at 2021-02-21 12:39:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @asbuch created at 2021-02-21 14:59:06

If my bindings are used, then that will make it easier to keep things compatible if I make more changes to the C interface.  I should be able to keep the Python interface stable, at least up to reordering of output.

Quantum function: I will add a function mult_quantum_pairs that returns a dict from ((partition),d) to integers, you can switch to that if you want.

setup.py: Does the following include the tags you are looking for?  Suggestions welcome!


```
setup(name='lrcalc',
    version='2.0.0',
    description='Littlewood-Richardson Calculator',
    long_description='Littlewood-Richardson Calculator',
    url='https://math.rutgers.edu/~asbuch/lrcalc',
    author='Anders Skovsted Buch',
    license='GPL3',
    ext_modules = cythonize([
        Extension("lrcalc", ["lrcalc.pyx"],
                  libraries=["lrcalc"])
    ])
)
```



---

Comment by git created at 2021-02-21 17:14:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-02-21 17:17:13

Replying to [comment:15 gh-asbuch]:
> setup.py: Does the following include the tags you are looking for?  Suggestions welcome!
> 
> {{{
> setup(name='lrcalc',
>     version='2.0.0',
>     description='Littlewood-Richardson Calculator',
>     long_description='Littlewood-Richardson Calculator',
>     url='https://math.rutgers.edu/~asbuch/lrcalc',
>     author='Anders Skovsted Buch',
>     license='GPL3',
>     ext_modules = cythonize([
>         Extension("lrcalc", ["lrcalc.pyx"],
>                   libraries=["lrcalc"])
>     ])
> )
> }}}

That works, thanks. Also, although maybe it is a little bit too late for that, it would be good to bump the soversion of the C shared library since the API changed.


---

Comment by @asbuch created at 2021-02-21 17:38:55

Replying to [comment:17 arojas]:
> Replying to [comment:15 gh-asbuch]:
> > setup.py: Does the following include the tags you are looking for?  Suggestions welcome!
> > 
> > {{{
> > setup(name='lrcalc',
> >     version='2.0.0',
> >     description='Littlewood-Richardson Calculator',
> >     long_description='Littlewood-Richardson Calculator',
> >     url='https://math.rutgers.edu/~asbuch/lrcalc',
> >     author='Anders Skovsted Buch',
> >     license='GPL3',
> >     ext_modules = cythonize([
> >         Extension("lrcalc", ["lrcalc.pyx"],
> >                   libraries=["lrcalc"])
> >     ])
> > )
> > }}}
> 
> That works, thanks. Also, although maybe it is a little bit too late for that, it would be good to bump the soversion of the C shared library since the API changed.

I changed the version to "2.0.0" and thought that was in line with [this page](https://www.gnu.org/software/libtool/manual/html_node/Updating-version-info.html).  Please let me know if I am doing something wrong.


---

Comment by arojas created at 2021-02-21 18:01:29

Replying to [comment:18 gh-asbuch]:
> I changed the version to "2.0.0" and thought that was in line with [this page](https://www.gnu.org/software/libtool/manual/html_node/Updating-version-info.html).  Please let me know if I am doing something wrong.

You need to change the -version-info in https://bitbucket.org/asbuch/lrcalc/src/master/src/Makefile.am#lines-23


---

Comment by @asbuch created at 2021-02-21 18:32:33

Replying to [comment:19 arojas]:
> Replying to [comment:18 gh-asbuch]:
> > I changed the version to "2.0.0" and thought that was in line with [this page](https://www.gnu.org/software/libtool/manual/html_node/Updating-version-info.html).  Please let me know if I am doing something wrong.
> 
> You need to change the -version-info in https://bitbucket.org/asbuch/lrcalc/src/master/src/Makefile.am#lines-23

I see, thanks!  According to conventions, is that line in Makefile.am independent from this line in configure.am:


```
AC_INIT([lrcalc],[2.0.0],[asbuch at math rutgers edu])
```



---

Comment by git created at 2021-02-22 11:32:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-22 11:42:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-22 11:50:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-02-22 11:52:06

spkg-configure needs to be updated to check whether the python bindings are installed, and build sage's spkg otherwise.


---

Comment by @asbuch created at 2021-02-22 15:53:04

Sorry for the moving target.  However, 2.1 should bring only more speed and no new problems.

The mult_quantum() function now takes an optional boolean arguments "degrees" that causes it to replace each key part with (part,d).


---

Comment by mkoeppe created at 2021-02-22 16:06:39

Replying to [comment:24 arojas]:
> spkg-configure needs to be updated to check whether the python bindings are installed, and build sage's spkg otherwise.

We cannot use Python packages from the system, see #29023.

An SPKG providing both a library and Python bindings to it should be split into 2 SPKGs.


---

Comment by mkoeppe created at 2021-02-22 16:12:12

Anders, the Python package should declare its build dependencies (in particular Cython) by putting a `pyproject.toml` file next to the `setup.py`; see https://snarky.ca/what-the-heck-is-pyproject-toml/


---

Comment by arojas created at 2021-02-22 16:23:55

Replying to [comment:28 mkoeppe]:
> Replying to [comment:24 arojas]:
> > spkg-configure needs to be updated to check whether the python bindings are installed, and build sage's spkg otherwise.
> 
> We cannot use Python packages from the system, see #29023.
> 
> An SPKG providing both a library and Python bindings to it should be split into 2 SPKGs. 
> 

Then maybe sage shouldn't support using system lrcalc 2.x for now, the bindings and the C library should obviously be kept at the same version.

In any case, the sagelib side should be ready now, please someone else take care of the build side.


---

Comment by mkoeppe created at 2021-02-22 16:40:10

Whether we support system lrcalc or not, non-Python and Python installations need to be split into two separate SPKGs (they can share the same tarball).


---

Comment by @asbuch created at 2021-02-22 18:13:21

Is this the `pyproject.toml` that you need? If so, then I can add that.

```
[build-system]
requires = ["setuptools", "cython"]
build-backend = "setuptools.build_meta"
```


Regarding splitting into SPKGs, I am not familiar with the details of Python's package system. Maybe one day I will read up on this and make it possible to say `pip install lrcalc`, but this is not likely to happen soon. One way to proceed for now is to copy my files `liblrcalc.pxd` and `lrcalc.pyx` to the Sage repository next to Nicolas' files. Changes to `liblrcalc`'s interface are not likely to happen soon, but even if that happened, Sage could be brought up-to-date with another copy command. Not perfect, but maybe still a small improvement to the way `lrcalc` has been integrated in the past?


---

Comment by mkoeppe created at 2021-02-22 18:19:50

Replying to [comment:32 gh-asbuch]:
> Is this the `pyproject.toml` that you need? If so, then I can add that.
> {{{
> [build-system]
> requires = ["setuptools", "cython"]
> build-backend = "setuptools.build_meta"
> }}}

Yes, that's good; best to add `"wheel"` in requires too.

> Regarding splitting into SPKGs, I am not familiar with the details of Python's package system. 

This is actually Sage-specific, not related to Python packaging, so not a task for you as the upstream author.

"Best practices" on your side would be to create a source distribution for the Python library, using `setup.py sdist` and to upload it to PyPI.  On the Sage packaging side, we can then use that as our upstream for a `lrcalc_python` SPKG.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-06-26 09:21:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-06-26 09:23:31

Changing status from new to needs_review.


---

Comment by arojas created at 2021-06-26 09:23:31

Trying to move this forward


---

Comment by mkoeppe created at 2021-06-27 16:51:39

-1 on using a Python package that is not on PyPI


---

Comment by mkoeppe created at 2021-06-27 16:51:39

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by dimpase created at 2021-09-04 09:21:39

Replying to [comment:38 mkoeppe]:
> -1 on using a Python package that is not on PyPI

we have to move forward here, still. So we can either use the non-PyPI package, or facilitate
a release on PyPI...


---

Comment by tmonteil created at 2021-09-04 11:35:35

Replying to [comment:40 dimpase]:
> Replying to [comment:38 mkoeppe]:
> > -1 on using a Python package that is not on PyPI
> 
> we have to move forward here, still. So we can either use the non-PyPI package, or facilitate
> a release on PyPI...

Let me suggest to postpone helping upstream to use PyPI to another ticket.


---

Comment by mkoeppe created at 2021-09-04 16:21:15

It would block the Sage library (`sagemath-standard`) from being pushed to PyPI, so no, that's not a viable approach.


---

Comment by mkoeppe created at 2021-09-04 17:15:43

Replying to [comment:40 dimpase]:
> facilitate a release on PyPI...

Facilitated now by providing this link: https://realpython.com/pypi-publish-python-package/#publishing-to-pypi


---

Comment by dimpase created at 2021-09-10 08:37:25

Someone would probably need to provide a PR for upstream, not just an RTFM link.


---

Comment by mkoeppe created at 2021-09-10 17:45:08

No PR is needed, the upstream maintainer really just needs to type `python3 setup.py sdist && twine upload dist/*`


---

Comment by slelievre created at 2021-09-19 10:04:12

Changing keywords from "" to "upgrade, lrcalc".


---

Comment by slelievre created at 2021-09-19 10:04:12

Cc-ing the lrcalc maintainer (hi Anders!).


---

Comment by asbuch created at 2021-09-19 18:08:01

I would like to have lrcalc available on PyPI, but I have not had time to figure out how to put it there. I don't know how to make sure the Python bindings can find the C library, but if PyPI has some magic that can handle that with the above command, then great. I tried this:


```
python3 setup.py sdist
twine upload --repository testpypi dist/*
```


That appeared to work, and resulted in [https://test.pypi.org/project/lrcalc/](https://test.pypi.org/project/lrcalc/) appearing on TestPyPI. However, when I use the pip command displayed there, I get a lot of errors. I'm not eager to have a defunct project in public view on PyPI.

All that said, I can't help thinking that if Sage was able to include the previous version of lrcalc that did not come with Python bindings, but is unable to include the new version, with or without using the supplied bindings, then something in the project must have gotten less flexible in the last few years.


---

Comment by git created at 2021-09-19 18:23:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-09-19 18:38:19

Replying to [comment:47 asbuch]:
> All that said, I can't help thinking that if Sage was able to include the previous version of lrcalc that did not come with Python bindings, but is unable to include the new version, with or without using the supplied bindings, then something in the project must have gotten less flexible in the last few years.

The thing is that the API changes in lrcalc 2 require an almost complete rewrite of sage's interface, which would essentially make it a duplicate of your python bindings, and doing that doesn't make much sense to me.

Another solution would be to include a copy of your pyx in sage, if the licence allows it.


---

Comment by git created at 2021-09-19 18:42:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-19 18:44:42

Replying to [comment:47 asbuch]:
> I don't know how to make sure the Python bindings can find the C library

No need to worry about this. It is the responsibility of the user to install the C library. This is normal.

But it would be a good idea to explain this in the Python package's README (which would appear in the "Project description" at https://test.pypi.org/project/lrcalc/#description)

See https://pypi.org/project/pplpy/ for inspiration.


---

Comment by mkoeppe created at 2021-09-19 18:49:29

In `lrcalc/python`, probably best to change `README.Python` to either `README.md` or `README.rst`


---

Comment by mkoeppe created at 2021-09-19 18:54:34

The file on TestPyPI does not include the `.pyx` and `.pxd` files but it ships a generated `.c` file that is not needed. To fix this, you can create a file `MANIFEST.in`


---

Comment by asbuch created at 2021-09-19 19:40:23

Replying to [comment:50 arojas]:
> Replying to [comment:47 asbuch]:
> > All that said, I can't help thinking that if Sage was able to include the previous version of lrcalc that did not come with Python bindings, but is unable to include the new version, with or without using the supplied bindings, then something in the project must have gotten less flexible in the last few years.
> 
> The thing is that the API changes in lrcalc 2 require an almost complete rewrite of sage's interface, which would essentially make it a duplicate of your python bindings, and doing that doesn't make much sense to me.
> 
> Another solution would be to include a copy of your pyx in sage, if the licence allows it.

This is what I imagined would happen when I wrote the Python bindings. I think I also suggested it at some point. Lrcalc is GPL v3, is Sage not compatible with that?


---

Comment by mkoeppe created at 2021-09-19 19:41:54

The Sage library is "GPL v2 or later", I don't think we can put a GPL v3-only module in.


---

Comment by mkoeppe created at 2021-09-19 19:45:21

If you relicense the Python bindings to GPL v2 or later, people here on the ticket can probably adapt your code and put it in the Sage library; in this case, we don't need to bother you with Python packaging details.


---

Comment by asbuch created at 2021-09-19 19:45:48

Replying to [comment:54 mkoeppe]:
> The file on TestPyPI does not include the `.pyx` and `.pxd` files but it ships a generated `.c` file that is not needed. To fix this, you can create a file `MANIFEST.in`

Thanks, this is helpful. Do you know a place where I can find a minimal MANIFEST.in to modify?


---

Comment by mkoeppe created at 2021-09-19 19:48:04

https://gitlab.com/videlec/pplpy/-/blob/master/MANIFEST.in is a good example


---

Comment by asbuch created at 2021-09-19 19:48:56

Replying to [comment:56 mkoeppe]:
> The Sage library is "GPL v2 or later", I don't think we can put a GPL v3-only module in.

You can hereby consider any files you need to copy as also licensed "GPL v2 or later". Is this official enough?


---

Comment by asbuch created at 2021-09-19 19:49:42

Replying to [comment:59 mkoeppe]:
> https://gitlab.com/videlec/pplpy/-/blob/master/MANIFEST.in is a good example

Thanks, I will give that a try then.


---

Comment by mkoeppe created at 2021-09-19 19:51:10

Replying to [comment:60 asbuch]:
> Is this official enough?

Pretty sure it is, thanks


---

Comment by asbuch created at 2021-09-19 20:35:03

Replying to [comment:58 asbuch]:
> Replying to [comment:54 mkoeppe]:
> > The file on TestPyPI does not include the `.pyx` and `.pxd` files but it ships a generated `.c` file that is not needed. To fix this, you can create a file `MANIFEST.in`
> 
> Thanks, this is helpful. Do you know a place where I can find a minimal MANIFEST.in to modify?

Now the .pyx and .pxd files are included and the .c file is gone, but I get the same result when I try to install with pip. I have liblrcalc installed in /usr/local/lib.


---

Comment by git created at 2021-09-19 20:41:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-19 20:41:46

Works fine now here on the branch


---

Comment by mkoeppe created at 2021-09-19 20:42:38

Replying to [comment:63 asbuch]:
> I get the same result when I try to install with pip. I have liblrcalc installed in /usr/local/lib.

If you post some logs, I can take a look


---

Comment by git created at 2021-09-19 20:46:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-19 21:09:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asbuch created at 2021-09-19 21:35:14

Replying to [comment:66 mkoeppe]:
> Replying to [comment:63 asbuch]:
> > I get the same result when I try to install with pip. I have liblrcalc installed in /usr/local/lib.
> 
> If you post some logs, I can take a look

Thanks! I created a new Python environment with "mkvirtualenv lrcalc_test", then I tried to install with pip and got the following result:


```
> pip install -i https://test.pypi.org/simple/ lrcalc
Looking in indexes: https://test.pypi.org/simple/
Collecting lrcalc
  Downloading https://test-files.pythonhosted.org/packages/d4/c8/c3988b0714fd225cdc4664f79b57161b8292c43eaad3ff81698d3db58147/lrcalc-2.0.1.tar.gz (15 kB)
  Installing build dependencies ... error
  ERROR: Command errored out with exit status 1:
   command: /home/user/lib/virtualenvs/lrcalc_test/bin/python /home/user/lib/virtualenvs/lrcalc_test/lib/python3.8/site-packages/pip install --ignore-installed --no-user --prefix /tmp/pip-build-env-cz4e5gzo/overlay --no-warn-script-location --no-binary :none: --only-binary :none: -i https://test.pypi.org/simple/ -- setuptools cython wheel
       cwd: None
  Complete output (3 lines):
  Looking in indexes: https://test.pypi.org/simple/
  ERROR: Could not find a version that satisfies the requirement setuptools (from versions: none)
  ERROR: No matching distribution found for setuptools
  ----------------------------------------
ERROR: Command errored out with exit status 1: /home/user/lib/virtualenvs/lrcalc_test/bin/python /home/user/lib/virtualenvs/lrcalc_test/lib/python3.8/site-packages/pip install --ignore-installed --no-user --prefix /tmp/pip-build-env-cz4e5gzo/overlay --no-warn-script-location --no-binary :none: --only-binary :none: -i https://test.pypi.org/simple/ -- setuptools cython wheel Check the logs for full command output.
```



---

Comment by mkoeppe created at 2021-09-19 21:37:35

When you use `-i`, it overrides the default package index URL, so it cannot find `setuptools` any more. (It does not matter that `setuptools` is already installed in your venv -- this is Python's build isolation.)


---

Comment by mkoeppe created at 2021-09-19 21:39:08

You can use `--extra-index-url` instead of `-i`.


---

Comment by asbuch created at 2021-09-19 21:43:12

Replying to [comment:72 mkoeppe]:
> You can use `--extra-index-url` instead of `-i`.

That made a difference, thanks! I hope this problem will go away if I post to PyPI? I assume the PyPI website will show the command "pip install lrcalc"?


---

Comment by mkoeppe created at 2021-09-19 21:51:21

Replying to [comment:73 asbuch]:
> I hope this problem will go away if I post to PyPI? I assume the PyPI website will show the command "pip install lrcalc"?
That's right.


---

Comment by asbuch created at 2021-09-20 01:52:37

Here it is: https://pypi.org/project/lrcalc/

Many thanks to Matthias for all the help with this!


---

Comment by git created at 2021-09-20 03:12:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-20 03:13:05

Replying to [comment:75 asbuch]:
> Here it is: https://pypi.org/project/lrcalc/

Looking great!


---

Comment by mkoeppe created at 2021-09-20 04:02:57

There's one more detail in the actual C library `lrcalc`. In the `lib..._la_LDFLAGS` in `Makefile.am`, it would be good to add the flag `-no-undefined` - similar to this change: https://github.com/dimpase/autocliquer/commit/ea653f1f65fc0cdd656f7be45726f844862f2229

This will enable building a shared library on the Cygwin platform (see #29152, #30814).


---

Comment by mkoeppe created at 2021-09-20 04:06:34

Also the tarballs for the library and the Python sdist have the same name. I have already worked around this on the Sage side by having the library's tarball renamed, so no action is needed. But it might be a good idea to avoid this potential confusion.


---

Comment by mkoeppe created at 2021-09-20 04:07:49

Changing status from needs_work to needs_review.


---

Comment by asbuch created at 2021-09-20 15:50:04

Replying to [comment:80 mkoeppe]:
> Also the tarballs for the library and the Python sdist have the same name. I have already worked around this on the Sage side by having the library's tarball renamed, so no action is needed. But it might be a good idea to avoid this potential confusion.

Thanks for the comments! I added the -no-undefined flag. I may try to change the PyPI tarball name to lrcalc-bindings-x.y.z.tar.gz next time I need to make changes. (Maybe there is an option to setuptools to make this happen automagically?)


---

Comment by mkoeppe created at 2021-09-20 17:51:39

I am not aware of an option to customize it in `setuptools`, I think it's a fixed format that uses the distribution package's name (`lrcalc`). Maybe easier to rename the C library package in configure.ac


---

Comment by asbuch created at 2021-09-20 21:09:43

Replying to [comment:83 mkoeppe]:
> I am not aware of an option to customize it in `setuptools`, I think it's a fixed format that uses the distribution package's name (`lrcalc`). Maybe easier to rename the C library package in configure.ac

Ok, thanks. In that case I will see if it works if I change the name of the .tar.gz before I upload it with twine. I don't want to change the name I have used for the main package for many years. If the name conflict is a problem, then I would rather change the name of the PyPI project.


---

Comment by tscrim created at 2021-10-03 08:40:01

Needs a rebase `:/`


---

Comment by git created at 2021-10-03 16:37:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-10-03 23:52:15

Some comments:

Shouldn't the doc for `def _lrcalc_dict_to_sage(result):` go after the implementation?

I think the extra `dict` call here is unnecessary:

```diff
-return dict({_Partitions(i):Integer(k) for i,k in result.items()})
+return {_Partitions(la): Integer(k) for la,k in result.items()}
```

(I changed the variable to make it more clear that it is a partition being returned.)

```diff
-return dict({tuple(_Partitions(j) for j in i):Integer(k) for i,k in result.items()})
+return {tuple(_Partitions(mu) for mu in la): Integer(k) for la,k in result.items()}
```

Also, is the `list` call necessary here?

```diff
-return dict({Permutation(list(i)):Integer(k) for i,k in result.items()})
+return {Permutation(list(la)): Integer(k) for la,k in result.items()}
```


For speed and memory usage (1 object instead of 2):

```diff
     for i,k in result.items():
-        output[_Partitions(i[0])] = output.get(_Partitions(i[0]), P.zero()) + k*quantum**(i[1])
+        la = _Partitions(i[0])
+        output[la] = output.get(la, P.zero()) + k*quantum**(i[1])
```


I believe this could be simplified:

```diff
-        while True:
-            try:
-                word = Word([i+1 for i in next(iterator)])
-                yield SkewTableaux().from_shape_and_word(shape, word)
-            except StopIteration:
-                break
+        ST = SkewTableaux()
+        for data in iterator:
+            yield ST.from_shape_and_word(shape, Word([i+1 for i in data]))
```

and similarly if `weight` is given. However, I think it would make sense to make `wt = tuple(weight)` and then get the weight of the word (perhaps before even constructing `Word`) first to avoid creating transient objects. We also don't need `word` to be a subclass of `Word`; a `list` is sufficient.


---

Comment by arojas created at 2021-10-10 11:30:44

Replying to [comment:89 tscrim]:
> Some comments:

Thanks for the suggestions, all implemented now.

> Also, is the `list` call necessary here?
> {{{#!diff
> -return dict({Permutation(list(i)):Integer(k) for i,k in result.items()})
> +return {Permutation(list(la)): Integer(k) for la,k in result.items()}
> }}}

Yes, otherwise the Permutation constructor will interpret the tuple input as cycle notation.
----
New commits:


---

Comment by git created at 2021-10-11 16:17:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-20 07:05:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-12 13:39:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-12-12 13:40:43

Ping. Anything else needed here?


---

Comment by dimpase created at 2021-12-12 14:33:18

What is the minimum lrcalc version required by lrcalc_python?


---

Comment by arojas created at 2021-12-12 17:38:06

lrcalc and lrcalc_python come from the same repo, so I suppose the versions need to match.


---

Comment by dimpase created at 2021-12-12 17:46:50

A number of distrbutions have system-wide lrcalc installations, some still version 1.*, and those can be picked up  by Sage.

If these are not compatible they should not be used.


---

Comment by arojas created at 2021-12-12 17:53:17

1.* will not be picked up, the `ivector.h` header was introduced in 2.0. Don't know about 2.0, according to repology only gentoo is shipping that. `@`fbissey, any reason it hasn't been updated to 2.1?


---

Comment by fbissey created at 2021-12-12 18:40:46

I just have been quite busy. And since `@`mjo has migrated a lot of packages to the main tree, I feel less personal pressure to update. We have 2.0 in the main tree but not 2.1 yet. I will have to see what needs to be done.


---

Comment by fbissey created at 2021-12-12 21:33:38

`lrcalc_python/SPKG.rst` claims it is GPL2+ but https://bitbucket.org/asbuch/lrcalc/src/master/python/ and https://bitbucket.org/asbuch/lrcalc/src/master/python/setup.py make it pretty clear that it is GPL3.


---

Comment by git created at 2021-12-12 22:21:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-12-12 22:23:52

Replying to [comment:98 dimpase]:
> A number of distrbutions have system-wide lrcalc installations, some still version 1.*, and those can be picked up  by Sage.
> 
> If these are not compatible they should not be used.

Actually `spkg-configure` didn't work at all because it was using C++ instead of C. Fixed it now and added a check for a header only present in 2.1 so it will fail with older versions.

Fixed the license too, should be ready to go now.


---

Comment by fbissey created at 2021-12-12 22:30:34

I have opened a PR for getting 2.1 in Gentoo and I have an ebuild ready for the python bindings for the sage-on-gentoo overlay just waiting for the PR inclusion before going live [because of dependencies requirements, cannot go in until lrcalc-2.1 is present].


---

Comment by git created at 2021-12-24 09:22:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-09 11:47:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-02-22 20:30:14

Ping, hope to get this in 9.6


---

Comment by tscrim created at 2022-02-23 04:42:07

Does Sage's auto-download mechanism automatically rename the tarballs to their appropriate values. I am worried that both tarballs (lib and python) are called `lrcalc-2.1.tar.gz` on their respective upstream locations.

I made a few other little tweaks and checked the tests. If my changes are good, then it is a positive review.
----
New commits:


---

Comment by mkoeppe created at 2022-02-23 04:52:51

Replying to [comment:109 tscrim]:
> Does Sage's auto-download mechanism automatically rename the tarballs to their appropriate values. I am worried that both tarballs (lib and python) are called `lrcalc-2.1.tar.gz` on their respective upstream locations.

Yes, it is renamed to the value given in the `tarball` field of `checksums.ini`. See comment:80.


---

Comment by arojas created at 2022-02-23 07:43:56

Changing status from needs_review to positive_review.


---

Comment by arojas created at 2022-02-23 07:43:56

Thanks


---

Comment by vbraun created at 2022-02-27 22:00:47

Resolution: fixed
