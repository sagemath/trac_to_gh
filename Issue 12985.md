# Issue 12985: %fortran in the notebook (and fortran.eval on command line) is STILL broken on OS X

archive/issues_012985.json:
```json
{
    "body": "Assignee: was\n\nCC:  kcrisman mvngu flawrence\n\nKeywords: fortran osx\n\nDespite #7465 being closed as \"worksforme\", the following snippet in the notebook in Sage-5.0.1 (official binary) on Mac OS X 10.7.4 fails.\n\n\n```\n%fortran          \t\nC FILE: FIB1.F\n      SUBROUTINE FIB(A,N)\nC\nC     CALCULATE FIRST N FIBONACCI NUMBERS\nC\n      INTEGER N\n      REAL*8 A(N)\n      DO I=1,N\n         IF (I.EQ.1) THEN\n            A(I) = 0.0D0\n         ELSEIF (I.EQ.2) THEN\n            A(I) = 1.0D0\n         ELSE \n            A(I) = A(I-1) + A(I-2)\n         ENDIF\n      ENDDO\n      END\nC END FILE FIB1.F\n```\n\n\nHere is the error in full: http://pastebin.com/iVBkjckp\n\nLooking through the convoluted ticket relationships (#7465, #8010, etc..) it looks like numpy spkg was patched to fix the problem with the `-shared` link flag at some point, and sometime later the numpy was upgraded (perhaps making the patch unnecessary (??)) and now it might be some other issue having to do with the gcc/gfortran spkg. Just a guess.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13157\n\n",
    "created_at": "2012-06-23T17:51:08Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "%fortran in the notebook (and fortran.eval on command line) is STILL broken on OS X",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12985",
    "user": "benjaminfjones"
}
```
Assignee: was

CC:  kcrisman mvngu flawrence

Keywords: fortran osx

Despite #7465 being closed as "worksforme", the following snippet in the notebook in Sage-5.0.1 (official binary) on Mac OS X 10.7.4 fails.


```
%fortran          	
C FILE: FIB1.F
      SUBROUTINE FIB(A,N)
C
C     CALCULATE FIRST N FIBONACCI NUMBERS
C
      INTEGER N
      REAL*8 A(N)
      DO I=1,N
         IF (I.EQ.1) THEN
            A(I) = 0.0D0
         ELSEIF (I.EQ.2) THEN
            A(I) = 1.0D0
         ELSE 
            A(I) = A(I-1) + A(I-2)
         ENDIF
      ENDDO
      END
C END FILE FIB1.F
```


Here is the error in full: http://pastebin.com/iVBkjckp

Looking through the convoluted ticket relationships (#7465, #8010, etc..) it looks like numpy spkg was patched to fix the problem with the `-shared` link flag at some point, and sometime later the numpy was upgraded (perhaps making the patch unnecessary (??)) and now it might be some other issue having to do with the gcc/gfortran spkg. Just a guess.

Issue created by migration from https://trac.sagemath.org/ticket/13157





---

archive/issue_comments_156978.json:
```json
{
    "body": "Umm, there is something really odd here.  The flags passed seem to indicate something went quite wrong.  For instance, one bit is\n\n```\n/var/folders/f4/881mfg491yxdf3zx37ynf5580000gn/T/tmpSLdvBd/Users/bael/.sage/temp/Baels_MacBook_Air.local/2689/tmp_0.o -LUsing built-in specs. COLLECT_GCC=gfortran COLLECT_LTO_WRAPPER=/Users/bael/sage/sage-5.0.1/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper /Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3 -l gfortran -o ./fortran_module_0.so -l gfortran -shared-libgcc\n```\n\nWhat the heck?\n\n```\n-LUsing built-in specs. COLLECT_GCC=gfortran \n```\n\nNo wonder the errors look like\n\n```\ngfortran: error: built-in: No such file or directory\ngfortran: error: specs.: No such file or directory\ngfortran: error: COLLECT_GCC=gfortran: No such file or directory\n```\n\nI don't know how that verbiage got passed there, though.\n\nAnyway, since\n\n```\n/Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3\" -lgfortran -o ./fortran_module_0.so\" failed with exit status 1\n```\n\nthat means it's no surprise that at the end\n\n```\n    os.unlink(name + '.so')\nOSError: [Errno 2] No such file or directory: 'fortran_module_0.so'\n```\n\nthough that is just a symptom.\n\nDoes ticket:8010:attachment:trac-8010_numpy.patch (sorry, can't get the link right) look like it might solve it for you, just on the off chance?  One would have to make a new spkg, of course.  But the patch was never applied, to my knowledge.",
    "created_at": "2012-06-25T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156978",
    "user": "kcrisman"
}
```

Umm, there is something really odd here.  The flags passed seem to indicate something went quite wrong.  For instance, one bit is

```
/var/folders/f4/881mfg491yxdf3zx37ynf5580000gn/T/tmpSLdvBd/Users/bael/.sage/temp/Baels_MacBook_Air.local/2689/tmp_0.o -LUsing built-in specs. COLLECT_GCC=gfortran COLLECT_LTO_WRAPPER=/Users/bael/sage/sage-5.0.1/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper /Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3 -l gfortran -o ./fortran_module_0.so -l gfortran -shared-libgcc
```

What the heck?

```
-LUsing built-in specs. COLLECT_GCC=gfortran 
```

No wonder the errors look like

```
gfortran: error: built-in: No such file or directory
gfortran: error: specs.: No such file or directory
gfortran: error: COLLECT_GCC=gfortran: No such file or directory
```

I don't know how that verbiage got passed there, though.

Anyway, since

```
/Users/bael/sage/sage-5.0.1/local/bin/../lib/gcc/x86_64-apple-darwin10.8.0/4.6.3" -lgfortran -o ./fortran_module_0.so" failed with exit status 1
```

that means it's no surprise that at the end

```
    os.unlink(name + '.so')
OSError: [Errno 2] No such file or directory: 'fortran_module_0.so'
```

though that is just a symptom.

Does ticket:8010:attachment:trac-8010_numpy.patch (sorry, can't get the link right) look like it might solve it for you, just on the off chance?  One would have to make a new spkg, of course.  But the patch was never applied, to my knowledge.



---

archive/issue_comments_156979.json:
```json
{
    "body": "Wait, there is no `sage_fortran` any more, so that doesn't make sense to apply anyway.  And the [current numpy code](https://github.com/numpy/numpy/blob/master/numpy/distutils/fcompiler/gnu.py#L73) has\n\n```\n'linker_so'    : [None, \"-g\", \"-Wall\"],\n```\n\nso the `shared` business can't be the issue, or at least not in exactly the same way.\n\nI can also confirm that this is not just a Lion issue; the same happens on 10.6.",
    "created_at": "2012-06-25T18:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156979",
    "user": "kcrisman"
}
```

Wait, there is no `sage_fortran` any more, so that doesn't make sense to apply anyway.  And the [current numpy code](https://github.com/numpy/numpy/blob/master/numpy/distutils/fcompiler/gnu.py#L73) has

```
'linker_so'    : [None, "-g", "-Wall"],
```

so the `shared` business can't be the issue, or at least not in exactly the same way.

I can also confirm that this is not just a Lion issue; the same happens on 10.6.



---

archive/issue_comments_156980.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156980",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_156981.json:
```json
{
    "body": "Attachment [13157_scripts.patch](tarball://root/attachments/some-uuid/ticket13157/13157_scripts.patch) by jdemeyer created at 2012-08-22 09:34:25",
    "created_at": "2012-08-22T09:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156981",
    "user": "jdemeyer"
}
```

Attachment [13157_scripts.patch](tarball://root/attachments/some-uuid/ticket13157/13157_scripts.patch) by jdemeyer created at 2012-08-22 09:34:25



---

archive/issue_comments_156982.json:
```json
{
    "body": "Attachment [13157_inline_fortran.patch](tarball://root/attachments/some-uuid/ticket13157/13157_inline_fortran.patch) by jdemeyer created at 2012-08-22 09:40:41\n\nThe file `inline_fortan.py` still lacks documentation, but I don't feel like fixing that now. Needs testing and review.",
    "created_at": "2012-08-22T09:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156982",
    "user": "jdemeyer"
}
```

Attachment [13157_inline_fortran.patch](tarball://root/attachments/some-uuid/ticket13157/13157_inline_fortran.patch) by jdemeyer created at 2012-08-22 09:40:41

The file `inline_fortan.py` still lacks documentation, but I don't feel like fixing that now. Needs testing and review.



---

archive/issue_comments_156983.json:
```json
{
    "body": "Tested on Linux, OS X and OpenSolaris, works fine.",
    "created_at": "2012-08-23T12:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156983",
    "user": "jdemeyer"
}
```

Tested on Linux, OS X and OpenSolaris, works fine.



---

archive/issue_comments_156984.json:
```json
{
    "body": "Any reviewers?",
    "created_at": "2012-08-31T08:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156984",
    "user": "jdemeyer"
}
```

Any reviewers?



---

archive/issue_comments_156985.json:
```json
{
    "body": "This works fine on OS X now.  The code changes are minimal and make sense - nice error test.  I only tested this on OS X 10.7, not previous systems; I guess someone should test this doesn't break anything on Linux, and take jdemeyer's word for it on OpenSolaris.\n\nAny reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...",
    "created_at": "2012-08-31T12:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156985",
    "user": "kcrisman"
}
```

This works fine on OS X now.  The code changes are minimal and make sense - nice error test.  I only tested this on OS X 10.7, not previous systems; I guess someone should test this doesn't break anything on Linux, and take jdemeyer's word for it on OpenSolaris.

Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...



---

archive/issue_comments_156986.json:
```json
{
    "body": "I tested this on many platforms and it works.  Is that sufficient for positive review then?\n\nReplying to [comment:8 kcrisman]:\n> Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...\nThe redirection\n\n```\n1>&2 >foo\n```\n\nis equivalent to\n\n```\n>foo\n```\n\nIt's like saying: redirect stdout to stderr.  Oh, never mind, redirect it to `foo` instead.  This doesn't really make sense, so I assume it's a mistake.\n\nWhile\n\n```\n>foo 2>&1\n```\n\nmeans: redirect stdout to `foo`.  Now redirect stderr to the **new** stdout, which is `foo`.  This therefore redirects both stdout and stderr to `foo`.\n\n*Off topic and just for educational value*: the redirection\n\n```\n2>&1 >foo\n```\n\nwould mean: redirect stderr to the **current** stdout.  Now redirect stdout (but not stderr) to `foo`.",
    "created_at": "2012-09-03T12:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156986",
    "user": "jdemeyer"
}
```

I tested this on many platforms and it works.  Is that sufficient for positive review then?

Replying to [comment:8 kcrisman]:
> Any reason for the change of standard error to standard output instead of the previous vice versa?  It does seem more natural given the names of the terms, but I'm not a bash expert...
The redirection

```
1>&2 >foo
```

is equivalent to

```
>foo
```

It's like saying: redirect stdout to stderr.  Oh, never mind, redirect it to `foo` instead.  This doesn't really make sense, so I assume it's a mistake.

While

```
>foo 2>&1
```

means: redirect stdout to `foo`.  Now redirect stderr to the **new** stdout, which is `foo`.  This therefore redirects both stdout and stderr to `foo`.

*Off topic and just for educational value*: the redirection

```
2>&1 >foo
```

would mean: redirect stderr to the **current** stdout.  Now redirect stdout (but not stderr) to `foo`.



---

archive/issue_comments_156987.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-09-04T02:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156987",
    "user": "benjaminfjones"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_156988.json:
```json
{
    "body": "I just tested on OS X 10.7, OS X 10.6, and Debian linux and it looks good to go.",
    "created_at": "2012-09-04T02:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156988",
    "user": "benjaminfjones"
}
```

I just tested on OS X 10.7, OS X 10.6, and Debian linux and it looks good to go.



---

archive/issue_comments_156989.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-09-04T11:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12985",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12985#issuecomment-156989",
    "user": "jdemeyer"
}
```

Resolution: fixed
