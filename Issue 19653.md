# Issue 19653: Improve standardization

Issue created by migration from https://trac.sagemath.org/ticket/19890

Original creator: elixyre

Original creation time: 2016-01-14 21:39:06

CC:  virmaux nthiery

Improvement of the standardization computation

 - the current one:

```
sage: sage: w = list(Words(100, 100000).random_element())
sage: sage: from sage.combinat.permutation import to_standard
sage: sage: %time sig = to_standard(w)
CPU times: user 4min 42s, sys: 2.65 s, total: 4min 45s
Wall time: 4min 53s
```

 - using the merge sort algorithm:

```
sage: sage: w = list(Words(100, 100000).random_element())
sage: sage: from sage.combinat.permutation import to_standard
sage: sage: %time sig = to_standard(w)
CPU times: user 2.33 s, sys: 147 ms, total: 2.47 s
Wall time: 2.5 s
```



---

Comment by elixyre created at 2016-01-14 21:39:53

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-01-14 23:59:33

That is quite the improvement. Here are some comments and suggestions:

- Why do you import `imap`? You don't seem to use it.
- Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.


---

Comment by tscrim created at 2016-01-14 23:59:33

Changing type from PLEASE CHANGE to enhancement.


---

Comment by tscrim created at 2016-01-15 00:00:06

Here are the changes I'd make:
  {{{#!diff
-    def merge(shelves, i=0):
+    def merge(shelves, i):
 
-        if len(shelves) == 0:
+        if not shelves:
             return
+        n = len(shelves)
-        if len(shelves) == 1:
+        if n == 1:
             yield (shelves[0], i)
             return
 
-        n = len(shelves)
-        m = int(n / 2)
+        m = int(n // 2)
 
         L, R = merge(shelves[:m], i), merge(shelves[m:], i+m)
 
         aL, aR = L.next(), R.next()
-        j, k = 1, 1
+        j, k = 0, 0
 
         while True:
             if aL[0] <= aR[0]:
                 yield aL
                 j += 1
-                if j == m+1: break
-                else: aL = L.next()
+                if j == m:
+                    break
+                aL = L.next()
             else:
                 yield aR
                 k += 1
-                if k == n - m + 1: break
-                else: aR = R.next()
+                if k == n - m:
+                    break
+                aR = R.next()
 
-        if j == m+1:
+        if j == m:
-            it = R
             yield aR
+            for a in R:
+                yield a
         else:
-            it = L
             yield aL
+            for a in L:
+                yield a
-        for a in it:
-            yield a
}}}
Here is my reasoning:

- I do not think you should have a default for `i` since you almost always call it with an argument. I would just make the one place where you use the default argument (the `for` loop in the main function) explicitly pass `0`.
- The `if not shelves` is faster than calling `len` and comparing to `0`.
- Moving the `n = len(shelves)` call up typically avoids an extra call to `len` and variable allocation is faster than a function call.
- We should use `//` for integer division.
- If we start at 0, we avoid a number of unnecessary `+1`'s and keeps it more in line with standard python code.
- Standard Python formatting should only have `if` (and `else`) statements on one line.
- By not having the `it` variable and the distinct `for` loops, IMO it makes the code more clear as there are less variables to chase around (and it has the same length).

If you agree and make these changes, you can set a positive review on my behalf.


---

Comment by git created at 2016-01-15 07:22:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-15 07:33:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by elixyre created at 2016-01-15 07:34:11

Replying to [comment:2 tscrim]:
> That is quite the improvement. Here are some comments and suggestions:
> 
> - Why do you import `imap`? You don't seem to use it.

Sorry, it is a mistake... I was to fast and I forgot to remove that.

> - Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.

I deleted the old below and I had it in doctest!


---

Comment by git created at 2016-01-15 07:58:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by virmaux created at 2016-01-15 17:09:20

Hey Jean-Baptiste!

It is probably possible to go even faster using python sort and a dictionnary!

```
sage: w = Words(100, 100000).random_element()
sage: %time a = w.standard_permutation()
CPU times: user 123 ms, sys: 36.7 ms, total: 160 ms
Wall time: 128 ms
```



---

Comment by tscrim created at 2016-01-16 00:27:27

Do you have code that you could push or paste here?


---

Comment by git created at 2016-01-16 07:20:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by elixyre created at 2016-01-16 07:33:53

Thanks Aladin for this idea... It is better now. :-)


```
sage: %time _ = to_standard(w)
CPU times: user 169 ms, sys: 20.7 ms, total: 190 ms
Wall time: 178 ms
```


But I remark there exist a better version in `FiniteWord_class`... (why this implementation is not used there???)

I correct it


---

Comment by git created at 2016-01-16 08:11:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-16 08:15:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by elixyre created at 2016-01-16 08:19:27

The implementation in `finite_word.py` was quite better so I moved it into `permutation.py` and updated the code around. 
(Specially I defined a function `evaluation_dict` in `finite_word` which replace/generalize/improve the `evaluation_dict` method of `finite_word`.)


---

Comment by jdemeyer created at 2016-01-16 13:32:49

standardization of what? The title is very vague, it's not even clear that it's about combinatorics.


---

Comment by tscrim created at 2016-01-24 04:56:34

I made some reviewer changes by adding a little bit more description in the doctests, and I moved `evaluation_dict` to the end of the file as IMO the main classes should be closest to the top of the file. If you're happy with my changes, then positive review. (I added Aladin to the authors since the current algorithm is based upon his idea as per comment:8.)
----
New commits:


---

Comment by tscrim created at 2016-03-09 11:42:47

ping


---

Comment by vdelecroix created at 2016-03-16 13:11:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-20 23:41:42

Resolution: fixed
