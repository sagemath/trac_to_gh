# Issue 19653: Improve standardization

archive/issues_019653.json:
```json
{
    "body": "CC:  virmaux nthiery\n\nImprovement of the standardization computation\n\n- the current one:\n\n```\nsage: sage: w = list(Words(100, 100000).random_element())\nsage: sage: from sage.combinat.permutation import to_standard\nsage: sage: %time sig = to_standard(w)\nCPU times: user 4min 42s, sys: 2.65 s, total: 4min 45s\nWall time: 4min 53s\n```\n\n- using the merge sort algorithm:\n\n```\nsage: sage: w = list(Words(100, 100000).random_element())\nsage: sage: from sage.combinat.permutation import to_standard\nsage: sage: %time sig = to_standard(w)\nCPU times: user 2.33 s, sys: 147 ms, total: 2.47 s\nWall time: 2.5 s\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19890\n\n",
    "created_at": "2016-01-14T21:39:06Z",
    "labels": [
        "combinatorics",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Improve standardization",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19653",
    "user": "elixyre"
}
```
CC:  virmaux nthiery

Improvement of the standardization computation

- the current one:

```
sage: sage: w = list(Words(100, 100000).random_element())
sage: sage: from sage.combinat.permutation import to_standard
sage: sage: %time sig = to_standard(w)
CPU times: user 4min 42s, sys: 2.65 s, total: 4min 45s
Wall time: 4min 53s
```

- using the merge sort algorithm:

```
sage: sage: w = list(Words(100, 100000).random_element())
sage: sage: from sage.combinat.permutation import to_standard
sage: sage: %time sig = to_standard(w)
CPU times: user 2.33 s, sys: 147 ms, total: 2.47 s
Wall time: 2.5 s
```


Issue created by migration from https://trac.sagemath.org/ticket/19890





---

archive/issue_comments_270181.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-14T21:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270181",
    "user": "elixyre"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_270182.json:
```json
{
    "body": "That is quite the improvement. Here are some comments and suggestions:\n\n- Why do you import `imap`? You don't seem to use it.\n- Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.",
    "created_at": "2016-01-14T23:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270182",
    "user": "tscrim"
}
```

That is quite the improvement. Here are some comments and suggestions:

- Why do you import `imap`? You don't seem to use it.
- Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.



---

archive/issue_comments_270183.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-01-14T23:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270183",
    "user": "tscrim"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_270184.json:
```json
{
    "body": "Here are the changes I'd make:\n  {{{#!diff\n-    def merge(shelves, i=0):\n+    def merge(shelves, i):\n \n-        if len(shelves) == 0:\n+        if not shelves:\n             return\n+        n = len(shelves)\n-        if len(shelves) == 1:\n+        if n == 1:\n             yield (shelves[0], i)\n             return\n \n-        n = len(shelves)\n-        m = int(n / 2)\n+        m = int(n // 2)\n \n         L, R = merge(shelves[:m], i), merge(shelves[m:], i+m)\n \n         aL, aR = L.next(), R.next()\n-        j, k = 1, 1\n+        j, k = 0, 0\n \n         while True:\n             if aL[0] <= aR[0]:\n                 yield aL\n                 j += 1\n-                if j == m+1: break\n-                else: aL = L.next()\n+                if j == m:\n+                    break\n+                aL = L.next()\n             else:\n                 yield aR\n                 k += 1\n-                if k == n - m + 1: break\n-                else: aR = R.next()\n+                if k == n - m:\n+                    break\n+                aR = R.next()\n \n-        if j == m+1:\n+        if j == m:\n-            it = R\n             yield aR\n+            for a in R:\n+                yield a\n         else:\n-            it = L\n             yield aL\n+            for a in L:\n+                yield a\n-        for a in it:\n-            yield a\n}}}\nHere is my reasoning:\n\n- I do not think you should have a default for `i` since you almost always call it with an argument. I would just make the one place where you use the default argument (the `for` loop in the main function) explicitly pass `0`.\n- The `if not shelves` is faster than calling `len` and comparing to `0`.\n- Moving the `n = len(shelves)` call up typically avoids an extra call to `len` and variable allocation is faster than a function call.\n- We should use `//` for integer division.\n- If we start at 0, we avoid a number of unnecessary `+1`'s and keeps it more in line with standard python code.\n- Standard Python formatting should only have `if` (and `else`) statements on one line.\n- By not having the `it` variable and the distinct `for` loops, IMO it makes the code more clear as there are less variables to chase around (and it has the same length).\n\nIf you agree and make these changes, you can set a positive review on my behalf.",
    "created_at": "2016-01-15T00:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270184",
    "user": "tscrim"
}
```

Here are the changes I'd make:
  {{{#!diff
-    def merge(shelves, i=0):
+    def merge(shelves, i):
 
-        if len(shelves) == 0:
+        if not shelves:
             return
+        n = len(shelves)
-        if len(shelves) == 1:
+        if n == 1:
             yield (shelves[0], i)
             return
 
-        n = len(shelves)
-        m = int(n / 2)
+        m = int(n // 2)
 
         L, R = merge(shelves[:m], i), merge(shelves[m:], i+m)
 
         aL, aR = L.next(), R.next()
-        j, k = 1, 1
+        j, k = 0, 0
 
         while True:
             if aL[0] <= aR[0]:
                 yield aL
                 j += 1
-                if j == m+1: break
-                else: aL = L.next()
+                if j == m:
+                    break
+                aL = L.next()
             else:
                 yield aR
                 k += 1
-                if k == n - m + 1: break
-                else: aR = R.next()
+                if k == n - m:
+                    break
+                aR = R.next()
 
-        if j == m+1:
+        if j == m:
-            it = R
             yield aR
+            for a in R:
+                yield a
         else:
-            it = L
             yield aL
+            for a in L:
+                yield a
-        for a in it:
-            yield a
}}}
Here is my reasoning:

- I do not think you should have a default for `i` since you almost always call it with an argument. I would just make the one place where you use the default argument (the `for` loop in the main function) explicitly pass `0`.
- The `if not shelves` is faster than calling `len` and comparing to `0`.
- Moving the `n = len(shelves)` call up typically avoids an extra call to `len` and variable allocation is faster than a function call.
- We should use `//` for integer division.
- If we start at 0, we avoid a number of unnecessary `+1`'s and keeps it more in line with standard python code.
- Standard Python formatting should only have `if` (and `else`) statements on one line.
- By not having the `it` variable and the distinct `for` loops, IMO it makes the code more clear as there are less variables to chase around (and it has the same length).

If you agree and make these changes, you can set a positive review on my behalf.



---

archive/issue_comments_270185.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-15T07:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270185",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270186.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-15T07:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270186",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270187.json:
```json
{
    "body": "Replying to [comment:2 tscrim]:\n> That is quite the improvement. Here are some comments and suggestions:\n> \n> - Why do you import `imap`? You don't seem to use it.\n\nSorry, it is a mistake... I was to fast and I forgot to remove that.\n\n> - Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.\n\nI deleted the old below and I had it in doctest!",
    "created_at": "2016-01-15T07:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270187",
    "user": "elixyre"
}
```

Replying to [comment:2 tscrim]:
> That is quite the improvement. Here are some comments and suggestions:
> 
> - Why do you import `imap`? You don't seem to use it.

Sorry, it is a mistake... I was to fast and I forgot to remove that.

> - Are you going to delete the old algorithm or keep it and add an `algorithm` option? I would at least keep the old (naive) algorithm around in a doctest for testing.

I deleted the old below and I had it in doctest!



---

archive/issue_comments_270188.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-15T07:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270188",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270189.json:
```json
{
    "body": "Hey Jean-Baptiste!\n\nIt is probably possible to go even faster using python sort and a dictionnary!\n\n```\nsage: w = Words(100, 100000).random_element()\nsage: %time a = w.standard_permutation()\nCPU times: user 123 ms, sys: 36.7 ms, total: 160 ms\nWall time: 128 ms\n```\n",
    "created_at": "2016-01-15T17:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270189",
    "user": "virmaux"
}
```

Hey Jean-Baptiste!

It is probably possible to go even faster using python sort and a dictionnary!

```
sage: w = Words(100, 100000).random_element()
sage: %time a = w.standard_permutation()
CPU times: user 123 ms, sys: 36.7 ms, total: 160 ms
Wall time: 128 ms
```




---

archive/issue_comments_270190.json:
```json
{
    "body": "Do you have code that you could push or paste here?",
    "created_at": "2016-01-16T00:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270190",
    "user": "tscrim"
}
```

Do you have code that you could push or paste here?



---

archive/issue_comments_270191.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-16T07:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270191",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270192.json:
```json
{
    "body": "Thanks Aladin for this idea... It is better now. :-)\n\n\n```\nsage: %time _ = to_standard(w)\nCPU times: user 169 ms, sys: 20.7 ms, total: 190 ms\nWall time: 178 ms\n```\n\n\nBut I remark there exist a better version in `FiniteWord_class`... (why this implementation is not used there???)\n\nI correct it",
    "created_at": "2016-01-16T07:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270192",
    "user": "elixyre"
}
```

Thanks Aladin for this idea... It is better now. :-)


```
sage: %time _ = to_standard(w)
CPU times: user 169 ms, sys: 20.7 ms, total: 190 ms
Wall time: 178 ms
```


But I remark there exist a better version in `FiniteWord_class`... (why this implementation is not used there???)

I correct it



---

archive/issue_comments_270193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-16T08:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270193",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270194.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-01-16T08:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270194",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_270195.json:
```json
{
    "body": "The implementation in `finite_word.py` was quite better so I moved it into `permutation.py` and updated the code around. \n(Specially I defined a function `evaluation_dict` in `finite_word` which replace/generalize/improve the `evaluation_dict` method of `finite_word`.)",
    "created_at": "2016-01-16T08:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270195",
    "user": "elixyre"
}
```

The implementation in `finite_word.py` was quite better so I moved it into `permutation.py` and updated the code around. 
(Specially I defined a function `evaluation_dict` in `finite_word` which replace/generalize/improve the `evaluation_dict` method of `finite_word`.)



---

archive/issue_comments_270196.json:
```json
{
    "body": "standardization of what? The title is very vague, it's not even clear that it's about combinatorics.",
    "created_at": "2016-01-16T13:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270196",
    "user": "jdemeyer"
}
```

standardization of what? The title is very vague, it's not even clear that it's about combinatorics.



---

archive/issue_comments_270197.json:
```json
{
    "body": "I made some reviewer changes by adding a little bit more description in the doctests, and I moved `evaluation_dict` to the end of the file as IMO the main classes should be closest to the top of the file. If you're happy with my changes, then positive review. (I added Aladin to the authors since the current algorithm is based upon his idea as per comment:8.)\n----\nNew commits:",
    "created_at": "2016-01-24T04:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270197",
    "user": "tscrim"
}
```

I made some reviewer changes by adding a little bit more description in the doctests, and I moved `evaluation_dict` to the end of the file as IMO the main classes should be closest to the top of the file. If you're happy with my changes, then positive review. (I added Aladin to the authors since the current algorithm is based upon his idea as per comment:8.)
----
New commits:



---

archive/issue_comments_270198.json:
```json
{
    "body": "ping",
    "created_at": "2016-03-09T11:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270198",
    "user": "tscrim"
}
```

ping



---

archive/issue_comments_270199.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-16T13:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270199",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_270200.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-20T23:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19653",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19653#issuecomment-270200",
    "user": "vbraun"
}
```

Resolution: fixed
