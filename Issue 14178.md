# Issue 14178: Fix LaTeXing of strings

Issue created by migration from Trac.

Original creator: novoselt

Original creation time: 2013-03-29 15:38:28

Assignee: was

CC:  cremona ddrake jhpalmieri

#11498 made "ASCII-art" strings look reasonably well when displayed via LaTeX methods. One of the changes was damaged in #9774, resulting in invalid LaTeX code that works in MathJax, but not in SageTeX. Let's fix it again.


---

Comment by novoselt created at 2013-03-29 17:30:16

Changing keywords from "" to "latex".


---

Comment by novoselt created at 2013-03-29 17:30:16

Changing status from new to needs_review.


---

Comment by nthiery created at 2013-04-02 02:38:48

You might want to have a look at #13624; it replaces \verb back to \text to help dot2tex. Not really your business, but maybe it would make sense to use \text in the easy cases, with no \phantom's? This is quite more readable!

Cheers,
                            Nicolas


---

Comment by novoselt created at 2013-04-02 02:55:43

I don't think `\phantom{x}` is likely to cause troubles, and I didn't figure out a better way to insert a "monotype width space" compatible with MathJax we use. The method in question here is fallback to when classes do not produce latex code at all, and in this case using verb is the best we can do to preserve formatting: keep line breaks and vertical alignment in case it is important. In particular cases like #13624 there has to be proper latex treatment of strings. The general case has to be uniform, I think, not like in #14256.


---

Comment by jhpalmieri created at 2013-04-02 21:25:00

Can you provide examples that this is supposed to fix? Running SageTeX on a file containing

```
\[
\sage{RubiksCube()}
\]
```

doesn't work either before or after the patch.


---

Comment by jhpalmieri created at 2013-04-02 21:25:40

By the way, line 337 should say `MathJax`, not `jsMath`.


---

Comment by jhpalmieri created at 2013-04-02 21:30:24

Here's a LaTeX file:

```
\documentclass{article}
\usepackage{sagetex}
\begin{document}

Let's try this:
\[
\sage{"1 2"}
\]
Doesn't work.

\end{document}
```

Running latex on this, then sagetex, then latex, I get this error:

```
! Missing } inserted.
<inserted text> 
                }
l.7 \sage{"1 2"}
                
? 
```



---

Comment by ddrake created at 2013-04-02 22:04:03

As long as you have verbatim things, this won't work in TeX documents. The `\sage` macro relies on pulling in the output via a label, and verbatim things don't work well when pushed around with labels and references. (They are "fragile".)

I mentioned this on another ticket, but one problem we have is that we use the LaTeX output for two different environments: for consumption by MathJax, and by regular LaTeX. Those environments are really pretty different.


---

Comment by novoselt created at 2013-04-03 02:09:17

OK, my bad, it still does not work with SageTeX, althoug the generated code is at least valid in LaTeX for copy-pasting, while putting verb inside of phantom is not.

After playing some more, I see that MathJax that we have does support `\tt`, so I'll try to use that instead of verb.


---

Comment by jhpalmieri created at 2013-04-03 02:40:43

I don't think that `\tt` will handle spaces correctly, but maybe I'm wrong.

One option we could consider: use `EMBEDDED_MODE` to detect whether we're using the notebook. Or we could produce output that SageTeX can handle but not MathJax, and then post-process it if using MathJax, converting the relevant string, maybe in the `eval` method for `MathJax`. We used to do this with `jsMath`, if I recall correctly.


---

Comment by novoselt created at 2013-04-03 02:47:43

Actually one of the reasons for using verb was that strings may contain all kinds of special characters and it is tricky to display them all properly. So I think that for MathJax we still are better off using verb, but perhaps in non-embedded mode something else can be done, although special characters still have to be allowed.

A combination of tt and phantom in array can produce proper spacing, it seems, but somehow special characters have different width when escaped, e.g. #


---

Comment by novoselt created at 2013-04-03 02:53:31

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2013-04-03 02:53:31

Ahhh, it seems that `\text{\tt ...}` works quite well, I guess with `\tt` in math mode escaping was switching to a different font. Will try to make another patch this week.


---

Comment by nthiery created at 2013-04-03 03:04:45

Replying to [comment:11 jhpalmieri]:
> One option we could consider: use `EMBEDDED_MODE` to detect whether we're using the notebook.

I did not really think about it, but even in EMBEDDED_MODE one may want to produce latex code for something else than mathjax. So maybe that's not super robust.


---

Comment by novoselt created at 2013-04-04 04:49:25

OK, how about this one: old-style verb in EMBEDDED_MODE and text-tt wrapping otherwise. `RubiksCube()` looks perfect when rendered through SageTeX! (I didn't change documentation/doctests yet.)

Note that both ways generate valid LaTeX code, although verb one does not work in command arguments and text-tt does not work in MathJax... Nevertheless I think it is the way to go - particular cases where this treatment is insufficient should provide adequate handling of LaTeX generation themselves.


---

Comment by jhpalmieri created at 2013-04-04 05:22:24

I think Nicolas's point has some merit. Could we instead have text-tt wrapping in general, and then in the MathJax eval method, do a regular expression search-and-replace to change `\text{\tt{...}}` into `\verb|...|`, or something like that?


---

Comment by novoselt created at 2013-04-17 19:40:32

New version uses text-tt and switches to verb in MathJax. I don't think that regular expressions can be used, since it is necessary to balance braces. There was a code in free modules removing the old verb wrappers - I switched it to using string representation in this case. If this is not what is desired, then I think no fiddling has to be done here at all, since without verb there are no issues with command arguments.


---

Comment by novoselt created at 2013-04-17 19:40:32

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2013-04-17 19:49:37

Also, since verb is now used for MathJax only, I left `\phantom{\verb` which I complained about originally - it is not a valid LaTeX still, but it does give better look in MathJax - `RubiksCube()` looks now perfectly both in the notebook and via SageTeX.


---

Attachment


---

Attachment

Fixed the doctest in tutorials which I missed before (by the way, the patchbot caught the problem in the English version only, not German).


---

Comment by novoselt created at 2013-05-16 20:14:58

Apply trac_14382_fix_latex_of_strings.patch  trac_14382_doctests.patch


---

Comment by novoselt created at 2013-05-17 20:56:23

Things can be simplified after switching to MathJax 2.2:
 * https://github.com/mathjax/MathJax/issues/380
 * https://github.com/mathjax/MathJax/issues/381


---

Comment by novoselt created at 2013-06-17 23:52:45

Spaces in verb are handled correctly with 2.2 in SVG mode, but are still quite off in HTML-CSS, so I think that patches here are still the way to go!


---

Comment by jhpalmieri created at 2013-06-21 21:12:33

With this patch, running `view(RubiksCube())` from the command line produces output in which the numbers are lined up, but the horizontal lines are too short: LaTeX is turning each pair of dashes `--` into an "en-dash". If you want to use this approach, maybe you need to use `{-}{-}` instead of `--`.

From the notebook, I don't see anything useful, but that may be specific to this machine. I'll try it on another machine eventually.

From SageTeX, it works, but it requires the package `amsmath` because of the `\text{...}` command. I'm not sure that's ideal.


---

Comment by novoselt created at 2013-06-21 21:52:46

Interesting, was working fine for me except for the command-line which I didn't think about. Will keep working.


---

Comment by novoselt created at 2013-06-21 21:52:46

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2013-06-21 22:13:38

Does anyone recall any reason to use `\text{\tt }` rather than `\texttt{ }`? The latter should be eventually supported by MathJax (i.e. they plan to do it) while the former is a more general problem of not supporting nested font switches or something like that. Directly from LaTeX it seems to be identical.

I am also puzzled by combining of dashes - it does not happen for hand-written code or via SageTeX, why does it happen for `view`???


---

Comment by jhpalmieri created at 2013-06-21 22:28:56

Probably use `\mathtt` instead of `\texttt`, since LaTeX output in Sage should be in math mode. Otherwise, I don't know why use `\text{\tt }` instead of `\mathtt`. I don't understand the dash issue, either.


---

Comment by novoselt created at 2013-06-21 22:38:04

`\mathtt` is not a monospaced font. I can't see the difference between `\text{\tt }` and `\texttt{ }`, but the latter works without amsmath. On the other hand, without amsmath it does not scale properly, so amsmath is still desirable. I don't really see the problem with it - hard to imagine that someone will use Sage for typesetting math and yet object to loading a standard math package.


---

Comment by jhpalmieri created at 2013-06-21 22:41:46

You shouldn't use `\texttt{...}` within math mode. It might work, but if so, it's taking advantage of a bug.


---

Comment by novoselt created at 2013-06-21 22:44:44

OK, then it seems to me that missing dashes for the command line are the only issue!


---

Comment by novoselt created at 2013-06-21 23:08:33

Use text-tt


---

Attachment

Didn't run tests yet, but they should not be affected by this change, hopefully.


---

Comment by novoselt created at 2013-06-21 23:09:57

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2013-06-30 19:37:54

All tests pass both for me and the patchbot.

John, what exactly was "From the notebook, I don't see anything useful"? Was it indeed something with a single machine or some generic issue? I've had these patches on for a while and didn't experience any problems under Windows and Linux.


---

Comment by jhpalmieri created at 2013-07-26 04:54:52

use \text{\texttt{...}}


---

Attachment

for review only: diff between previous patches and texttt patch


---

Attachment

Looks okay except that `\tt` [is an obsolete command](http://www.ctan.org/tex-archive/info/l2tabu/), and `\texttt` should be used instead. I've attached a new patch which does this, along with a `delta` patch which shows the difference between my patch and your two patches. All tests pass for me and the output looks the same as with `\tt`.


---

Comment by novoselt created at 2013-07-26 06:15:01

Changing status from needs_review to positive_review.


---

Comment by novoselt created at 2013-07-26 06:15:01

Wow, I thought LaTeX is once and for all and only new things can appear without obsolescence! Will keep it in mind for the future, changes are fine with me!


---

Comment by novoselt created at 2013-08-19 18:37:09

Apply trac_14382-texttt.patch​


---

Comment by jdemeyer created at 2013-08-20 12:55:54

Resolution: fixed
