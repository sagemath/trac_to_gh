# Issue 25743: GitLab CI for Windows & OSX

Issue created by migration from Trac.

Original creator: saraedum

Original creation time: 2018-07-31 10:47:25

CC:  embray slelievre

Keywords: osx, windows, CI

Developers currently don't have an easy way to test proposed changes on OSX & Windows if they do not have access to such machines themselves. Given the flakiness of the patchbot on Windows, it would be nice to provision GitLab CI infrastructure for these systems.

We can not use the docker setup unfortunately, as docker on Windows is not ready to run fork-heavy workloads (#25805) and docker on OSX does simply not exist.

The current idea would be to provide SSH runners on Linux machines tagged as `osx` & `nt` that run QEMU/KVM. An incoming CI request would then take an LVM snapshot of an existing Windows/OSX machine, start a QEMU/KVM machine on it, and run its CI via SSH.

CI on the "develop" branch would probably start from a clean OS snapshot and rename the resulting LVM volume to "develop" so the build artifacts can be reused by runs on other branches.

Note that for legal reasons the OSX CI would have to run on Apple hardware. I am not sure if we need official Windows licenses for the Windows CI or whether we could use Windows trials for this. In any case, normal Windows 10 licenses would be good enough.


---

Comment by embray created at 2018-07-31 13:15:37

I have no idea about the legal issues w.r.t. using Windows VM snapshots for testing.  I have a Windows 10 image I created for my own Windows VMs that comes installed with a valid(!) license provided by CNRS for all Windows 10 installs, so I don't know what the limits are, if any, to spinning up VMs that use that license.  In any case I can easily set up a snapshot that already has Cygwin and SSH pre-configured.


---

Comment by saraedum created at 2018-08-01 22:14:55

I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.

I could not get High Sierra to work. I had manged to install it once but it was extremely slow. I am now trying with Sierra which seems much better so far.


---

Comment by saraedum created at 2018-08-02 10:02:47

Sage builds on Sierra running on QEMU on a Linux box. The build took 270 minutes on a dual core with 2GB RAM which sounds quite reasonable to me.


---

Comment by saraedum created at 2018-08-03 12:42:12

embray: Would you mind to comment on the timings in the ticket description? Is that roughly what you see on a native Windows system?


---

Comment by embray created at 2018-08-10 11:18:45

FWIW from my recent build from scratch for the 8.3 release (this is likely with some ccache seeding but probably not for everything):


```
real    332m31.190s
user    515m41.689s
sys 249m16.470s
```


This is with `SAGE_NUM_THREADS=8`.


---

Comment by embray created at 2018-08-10 11:20:08

Replying to [comment:6 saraedum]:
> I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.

This is a bug I've seen sometimes but am not sure how to reproduce, where in fact there are still other packages building in the background, but `make` doesn't switch which job it's following to print to stdout so it looks like it's hanging, while in fact other jobs are still running.


---

Comment by saraedum created at 2018-08-11 00:38:20

On my single core Windows virtual machine I get for `sage -t --long --all`


```
----------------------------------------------------------------------
sage -t --long src/sage/all.py  # 1 doctest failed
sage -t --long src/sage/combinat/matrices/dancing_links.pyx  # 17 doctests failed
sage -t --long src/sage/interfaces/gap.py  # Killed due to kill signal
sage -t --long src/sage/misc/sagedoc.py  # 7 doctests failed
sage -t --long src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --long src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 22189.5 seconds
    cpu time: 16212.7 seconds
    cumulative wall time: 20648.1 seconds

real    370m12.148s
user    260m5.826s
sys     82m50.626s
```



---

Comment by saraedum created at 2018-08-11 00:45:50

embray, how does that compare to native? In any case, it seems very reasonable to me. If we would run eight of these somewhere that could be quite valuable.


---

Comment by embray created at 2018-08-16 13:04:52

Well, I'm running `make ptestlong` for 8.4.beta1 right now on my laptop (I have designated `SAGE_NUM_THREADS=4` for now) so I'll see what that says.

There are a number of tests--the ones you reported as failed being some of the common ones (such as `src/sage/tests/cmdline.py`) that are slow and fail often due to timeout.  Re-running them, or increasing the timeout, usually fixes it.


---

Comment by saraedum created at 2020-01-21 16:04:45

Changing keywords from "osx, windows, CI" to "osx, windows, ContinuousIntegration".


---

Comment by mkoeppe created at 2022-09-10 16:45:45

outdated


---

Comment by mkoeppe created at 2022-09-10 16:45:45

Changing status from new to needs_review.
