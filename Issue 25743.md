# Issue 25743: GitLab CI for Windows & OSX

archive/issues_025743.json:
```json
{
    "body": "CC:  @embray @slel\n\nKeywords: osx, windows, CI\n\nDevelopers currently don't have an easy way to test proposed changes on OSX & Windows if they do not have access to such machines themselves. Given the flakiness of the patchbot on Windows, it would be nice to provision GitLab CI infrastructure for these systems.\n\nWe can not use the docker setup unfortunately, as docker on Windows is not ready to run fork-heavy workloads (#25805) and docker on OSX does simply not exist.\n\nThe current idea would be to provide SSH runners on Linux machines tagged as `osx` & `nt` that run QEMU/KVM. An incoming CI request would then take an LVM snapshot of an existing Windows/OSX machine, start a QEMU/KVM machine on it, and run its CI via SSH.\n\nCI on the \"develop\" branch would probably start from a clean OS snapshot and rename the resulting LVM volume to \"develop\" so the build artifacts can be reused by runs on other branches.\n\nNote that for legal reasons the OSX CI would have to run on Apple hardware. I am not sure if we need official Windows licenses for the Windows CI or whether we could use Windows trials for this. In any case, normal Windows 10 licenses would be good enough.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25980\n\n",
    "created_at": "2018-07-31T10:47:25Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "GitLab CI for Windows & OSX",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25743",
    "user": "https://github.com/saraedum"
}
```
CC:  @embray @slel

Keywords: osx, windows, CI

Developers currently don't have an easy way to test proposed changes on OSX & Windows if they do not have access to such machines themselves. Given the flakiness of the patchbot on Windows, it would be nice to provision GitLab CI infrastructure for these systems.

We can not use the docker setup unfortunately, as docker on Windows is not ready to run fork-heavy workloads (#25805) and docker on OSX does simply not exist.

The current idea would be to provide SSH runners on Linux machines tagged as `osx` & `nt` that run QEMU/KVM. An incoming CI request would then take an LVM snapshot of an existing Windows/OSX machine, start a QEMU/KVM machine on it, and run its CI via SSH.

CI on the "develop" branch would probably start from a clean OS snapshot and rename the resulting LVM volume to "develop" so the build artifacts can be reused by runs on other branches.

Note that for legal reasons the OSX CI would have to run on Apple hardware. I am not sure if we need official Windows licenses for the Windows CI or whether we could use Windows trials for this. In any case, normal Windows 10 licenses would be good enough.

Issue created by migration from https://trac.sagemath.org/ticket/25980





---

archive/issue_comments_362814.json:
```json
{
    "body": "I have no idea about the legal issues w.r.t. using Windows VM snapshots for testing.  I have a Windows 10 image I created for my own Windows VMs that comes installed with a valid(!) license provided by CNRS for all Windows 10 installs, so I don't know what the limits are, if any, to spinning up VMs that use that license.  In any case I can easily set up a snapshot that already has Cygwin and SSH pre-configured.",
    "created_at": "2018-07-31T13:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362814",
    "user": "https://github.com/embray"
}
```

I have no idea about the legal issues w.r.t. using Windows VM snapshots for testing.  I have a Windows 10 image I created for my own Windows VMs that comes installed with a valid(!) license provided by CNRS for all Windows 10 installs, so I don't know what the limits are, if any, to spinning up VMs that use that license.  In any case I can easily set up a snapshot that already has Cygwin and SSH pre-configured.



---

archive/issue_comments_362815.json:
```json
{
    "body": "I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.\n\nI could not get High Sierra to work. I had manged to install it once but it was extremely slow. I am now trying with Sierra which seems much better so far.",
    "created_at": "2018-08-01T22:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362815",
    "user": "https://github.com/saraedum"
}
```

I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.

I could not get High Sierra to work. I had manged to install it once but it was extremely slow. I am now trying with Sierra which seems much better so far.



---

archive/issue_comments_362816.json:
```json
{
    "body": "Sage builds on Sierra running on QEMU on a Linux box. The build took 270 minutes on a dual core with 2GB RAM which sounds quite reasonable to me.",
    "created_at": "2018-08-02T10:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362816",
    "user": "https://github.com/saraedum"
}
```

Sage builds on Sierra running on QEMU on a Linux box. The build took 270 minutes on a dual core with 2GB RAM which sounds quite reasonable to me.



---

archive/issue_comments_362817.json:
```json
{
    "body": "embray: Would you mind to comment on the timings in the ticket description? Is that roughly what you see on a native Windows system?",
    "created_at": "2018-08-03T12:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362817",
    "user": "https://github.com/saraedum"
}
```

embray: Would you mind to comment on the timings in the ticket description? Is that roughly what you see on a native Windows system?



---

archive/issue_comments_362818.json:
```json
{
    "body": "FWIW from my recent build from scratch for the 8.3 release (this is likely with some ccache seeding but probably not for everything):\n\n\n```\nreal    332m31.190s\nuser    515m41.689s\nsys 249m16.470s\n```\n\n\nThis is with `SAGE_NUM_THREADS=8`.",
    "created_at": "2018-08-10T11:18:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362818",
    "user": "https://github.com/embray"
}
```

FWIW from my recent build from scratch for the 8.3 release (this is likely with some ccache seeding but probably not for everything):


```
real    332m31.190s
user    515m41.689s
sys 249m16.470s
```


This is with `SAGE_NUM_THREADS=8`.



---

archive/issue_comments_362819.json:
```json
{
    "body": "Replying to [comment:6 saraedum]:\n> I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.\n\nThis is a bug I've seen sometimes but am not sure how to reproduce, where in fact there are still other packages building in the background, but `make` doesn't switch which job it's following to print to stdout so it looks like it's hanging, while in fact other jobs are still running.",
    "created_at": "2018-08-10T11:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362819",
    "user": "https://github.com/embray"
}
```

Replying to [comment:6 saraedum]:
> I did not manage to build on cygwin in one go due to a `[combinatorial_designs-20140630] Waiting for rebase lock` where it hung forever. Now that I have a primed ccache I'll try again and see how it goes.

This is a bug I've seen sometimes but am not sure how to reproduce, where in fact there are still other packages building in the background, but `make` doesn't switch which job it's following to print to stdout so it looks like it's hanging, while in fact other jobs are still running.



---

archive/issue_comments_362820.json:
```json
{
    "body": "On my single core Windows virtual machine I get for `sage -t --long --all`\n\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/all.py  # 1 doctest failed\nsage -t --long src/sage/combinat/matrices/dancing_links.pyx  # 17 doctests failed\nsage -t --long src/sage/interfaces/gap.py  # Killed due to kill signal\nsage -t --long src/sage/misc/sagedoc.py  # 7 doctests failed\nsage -t --long src/sage/tests/cmdline.py  # 1 doctest failed\nsage -t --long src/doc/common/conf.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 22189.5 seconds\n    cpu time: 16212.7 seconds\n    cumulative wall time: 20648.1 seconds\n\nreal    370m12.148s\nuser    260m5.826s\nsys     82m50.626s\n```\n",
    "created_at": "2018-08-11T00:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362820",
    "user": "https://github.com/saraedum"
}
```

On my single core Windows virtual machine I get for `sage -t --long --all`


```
----------------------------------------------------------------------
sage -t --long src/sage/all.py  # 1 doctest failed
sage -t --long src/sage/combinat/matrices/dancing_links.pyx  # 17 doctests failed
sage -t --long src/sage/interfaces/gap.py  # Killed due to kill signal
sage -t --long src/sage/misc/sagedoc.py  # 7 doctests failed
sage -t --long src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --long src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 22189.5 seconds
    cpu time: 16212.7 seconds
    cumulative wall time: 20648.1 seconds

real    370m12.148s
user    260m5.826s
sys     82m50.626s
```




---

archive/issue_comments_362821.json:
```json
{
    "body": "embray, how does that compare to native? In any case, it seems very reasonable to me. If we would run eight of these somewhere that could be quite valuable.",
    "created_at": "2018-08-11T00:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362821",
    "user": "https://github.com/saraedum"
}
```

embray, how does that compare to native? In any case, it seems very reasonable to me. If we would run eight of these somewhere that could be quite valuable.



---

archive/issue_comments_362822.json:
```json
{
    "body": "Well, I'm running `make ptestlong` for 8.4.beta1 right now on my laptop (I have designated `SAGE_NUM_THREADS=4` for now) so I'll see what that says.\n\nThere are a number of tests--the ones you reported as failed being some of the common ones (such as `src/sage/tests/cmdline.py`) that are slow and fail often due to timeout.  Re-running them, or increasing the timeout, usually fixes it.",
    "created_at": "2018-08-16T13:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362822",
    "user": "https://github.com/embray"
}
```

Well, I'm running `make ptestlong` for 8.4.beta1 right now on my laptop (I have designated `SAGE_NUM_THREADS=4` for now) so I'll see what that says.

There are a number of tests--the ones you reported as failed being some of the common ones (such as `src/sage/tests/cmdline.py`) that are slow and fail often due to timeout.  Re-running them, or increasing the timeout, usually fixes it.



---

archive/issue_comments_362823.json:
```json
{
    "body": "Changing keywords from \"osx, windows, CI\" to \"osx, windows, ContinuousIntegration\".",
    "created_at": "2020-01-21T16:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362823",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "osx, windows, CI" to "osx, windows, ContinuousIntegration".



---

archive/issue_comments_362824.json:
```json
{
    "body": "outdated",
    "created_at": "2022-09-10T16:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362824",
    "user": "https://github.com/mkoeppe"
}
```

outdated



---

archive/issue_comments_362825.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-10T16:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25743",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25743#issuecomment-362825",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.
