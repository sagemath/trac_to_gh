# Issue 17915: Universal Cyclotomic Field implementation using libgap

archive/issues_017915.json:
```json
{
    "body": "CC:  @nthiery stumpc5 @tscrim @vbraun\n\nSage ships an implementation of the Universal Cyclotomic Field (in `sage.rings.universal_cyclotomic_field.*`) that is slower and less reliable than what is in gap. We propose in this ticket an implementation based on libgap.\n\nIt fixes some issues about the old implementation:\n- #14240:  Universal cyclotomic field breaks for moderate order\n- #16631: Universal Cyclotomic Field doesn't handle int and Integer the same\n- #16130: Matrices over Universal Cyclotomic field failing to echelonize/inverse\n\nPossible follow up:\n- switch to Cython\n- implement dense matrices by wrapping libgap matrices\n\nIssue created by migration from https://trac.sagemath.org/ticket/18152\n\n",
    "created_at": "2015-04-09T21:41:20Z",
    "labels": [
        "component: number fields"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Universal Cyclotomic Field implementation using libgap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17915",
    "user": "https://github.com/videlec"
}
```
CC:  @nthiery stumpc5 @tscrim @vbraun

Sage ships an implementation of the Universal Cyclotomic Field (in `sage.rings.universal_cyclotomic_field.*`) that is slower and less reliable than what is in gap. We propose in this ticket an implementation based on libgap.

It fixes some issues about the old implementation:
- #14240:  Universal cyclotomic field breaks for moderate order
- #16631: Universal Cyclotomic Field doesn't handle int and Integer the same
- #16130: Matrices over Universal Cyclotomic field failing to echelonize/inverse

Possible follow up:
- switch to Cython
- implement dense matrices by wrapping libgap matrices

Issue created by migration from https://trac.sagemath.org/ticket/18152





---

archive/issue_comments_240175.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-09T22:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240175",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240176.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-09T22:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240176",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_240177.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-09T22:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240177",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_240178.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-10T04:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240178",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240179.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-10T06:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240179",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240180.json:
```json
{
    "body": "Now all test pass!",
    "created_at": "2015-04-10T07:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240180",
    "user": "https://github.com/videlec"
}
```

Now all test pass!



---

archive/issue_comments_240181.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-10T11:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240181",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240182.json:
```json
{
    "body": "A test file to compare timings",
    "created_at": "2015-04-10T15:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240182",
    "user": "https://github.com/videlec"
}
```

A test file to compare timings



---

archive/issue_comments_240183.json:
```json
{
    "body": "Attachment [ucf_test.py](tarball://root/attachments/some-uuid/ticket18152/ucf_test.py) by @videlec created at 2015-04-10 15:12:20\n\nI did some concrete timings and the conclusion is that in all cases the new implementation is faster by a factor of at least x8 (and it can be up to x20).",
    "created_at": "2015-04-10T15:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240183",
    "user": "https://github.com/videlec"
}
```

Attachment [ucf_test.py](tarball://root/attachments/some-uuid/ticket18152/ucf_test.py) by @videlec created at 2015-04-10 15:12:20

I did some concrete timings and the conclusion is that in all cases the new implementation is faster by a factor of at least x8 (and it can be up to x20).



---

archive/issue_comments_240184.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-10T15:21:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240185.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-10T15:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240185",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_240186.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-10T18:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240187.json:
```json
{
    "body": "Hi!\n\nDid you have a look at #16116? Does it improve also the multiplication of generic cyclotomic matrices?\n\nJean-Philippe",
    "created_at": "2015-04-11T06:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240187",
    "user": "https://github.com/jplab"
}
```

Hi!

Did you have a look at #16116? Does it improve also the multiplication of generic cyclotomic matrices?

Jean-Philippe



---

archive/issue_comments_240188.json:
```json
{
    "body": "Hello Jean-Philippe,\n\nReplying to [comment:14 jipilab]:\n> Did you have a look at #16116? Does it improve also the multiplication of generic cyclotomic matrices?\n\nI guess so. Should be ten times faster. But I copied-pasted the GAP documentation in the top of the file:\n\n```\nArithmetical operations are quite expensive, so the use of\ninternally represented cyclotomics is not recommended for doing\narithmetic over number fields, such as calculations with matrices\nof cyclotomics.\n```\n\n\nBest,\nVincent",
    "created_at": "2015-04-11T08:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240188",
    "user": "https://github.com/videlec"
}
```

Hello Jean-Philippe,

Replying to [comment:14 jipilab]:
> Did you have a look at #16116? Does it improve also the multiplication of generic cyclotomic matrices?

I guess so. Should be ten times faster. But I copied-pasted the GAP documentation in the top of the file:

```
Arithmetical operations are quite expensive, so the use of
internally represented cyclotomics is not recommended for doing
arithmetic over number fields, such as calculations with matrices
of cyclotomics.
```


Best,
Vincent



---

archive/issue_events_051381.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/stumpc5",
    "created_at": "2015-04-15T10:37:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17915#event-51381"
}
```



---

archive/issue_comments_240189.json:
```json
{
    "body": "Hi there!\n\nI kind of feel bad that you plan to remove that much code I wrote in weeks of work -- but I guess that's the way it goes if there is something better...\n\nAnyway my first question would be whether it is really desired to remove an algorithm from Sage and instead use the same algorithm from Gap? Don't you think that working on the cython part of my implementation (maybe even moving to plain C of some core functionality) could get it beyond the speed of the black box (from a Sage point of view) Gap implementation?\n\nSecondly, I remember that I did quite some tests back when I implemented the UCF. And that in the end, the Sage implementation was slower on some parts, while faster on others (one I remember where Sage was quicker was the computation of the Galois conjugates of big elements, in case you want to test, one example might be `E( 2^11 * 3^4 )`). I would really like to redo these tests, but haven't yet been able to get your branch running on my computer. I will get back once that worked out.\n\nI also remember to have found a few bugs in the Gap implementation while implementing UCFs in Sage. That would also not be possible anymore when only relying on the implementation in Gap.\n\n\n\nCheers, Christian",
    "created_at": "2015-04-15T11:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240189",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Hi there!

I kind of feel bad that you plan to remove that much code I wrote in weeks of work -- but I guess that's the way it goes if there is something better...

Anyway my first question would be whether it is really desired to remove an algorithm from Sage and instead use the same algorithm from Gap? Don't you think that working on the cython part of my implementation (maybe even moving to plain C of some core functionality) could get it beyond the speed of the black box (from a Sage point of view) Gap implementation?

Secondly, I remember that I did quite some tests back when I implemented the UCF. And that in the end, the Sage implementation was slower on some parts, while faster on others (one I remember where Sage was quicker was the computation of the Galois conjugates of big elements, in case you want to test, one example might be `E( 2^11 * 3^4 )`). I would really like to redo these tests, but haven't yet been able to get your branch running on my computer. I will get back once that worked out.

I also remember to have found a few bugs in the Gap implementation while implementing UCFs in Sage. That would also not be possible anymore when only relying on the implementation in Gap.



Cheers, Christian



---

archive/issue_comments_240190.json:
```json
{
    "body": "Hello Christian,\n\nThanks for having a look!\n\nReplying to [comment:18 stumpc5]:\n> I kind of feel bad that you plan to remove that much code I wrote in weeks of work -- but I guess that's the way it goes if there is something better...\n\nMe too. I wondered if something were better with your code. But except the documentation I did not find any case were it was faster.\n\n> Anyway my first question would be whether it is really desired to remove an algorithm from Sage and instead use the same algorithm from Gap?\n\nSage should not reinvent the wheel. Gap is now interfaced as a fairly good level and we should try to maximize its usage at what it is good for.\n\nThat being said, it would makes sense to keep your implementation somewhere with more comparisons to the libgap implementation. Especially if you found that the Gap implementation has some bug! But I did not find any relevant example since all tests pass with my branch applied.\n\n> Don't you think that working on the cython part of my implementation (maybe even moving to plain C of some core functionality) could get it beyond the speed of the black box (from a Sage point of view) Gap implementation?\n\nNo idea. And I will not try. It is much more work than proposing what I did. And if you ask me what I would do if I want even more speed, I would link to Gap at an even lower level.\n\n> Secondly, I remember that I did quite some tests back when I implemented the UCF. And that in the end, the Sage implementation was slower on some parts, while faster on others (one I remember were Sage was quicker was the computation of the Galois conjugates of big elements, in case you want to test, one example might be `E( 2^11 * 3^4 )`). I would really like to redo these tests, but haven't yet been able to get your branch running on my computer. I will get back once that worked out.\n\nGreat! I will add this to the `ucf_test.py` that I wrote. If you have other examples in mind, please propose. I am not sure it will make a difference now since big numbers with pexpect implies a lot of parsing and computation. With libgap it is not the case anymore.\n\n> I also remember to have found a few bugs in the Gap implementation while implementing UCFs in Sage. That would also not be possible anymore when only relying on the implementation in Gap.\n\nYou do not remember what they are? Did you report them to Gap? \n\nCheers\nVincent",
    "created_at": "2015-04-15T11:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240190",
    "user": "https://github.com/videlec"
}
```

Hello Christian,

Thanks for having a look!

Replying to [comment:18 stumpc5]:
> I kind of feel bad that you plan to remove that much code I wrote in weeks of work -- but I guess that's the way it goes if there is something better...

Me too. I wondered if something were better with your code. But except the documentation I did not find any case were it was faster.

> Anyway my first question would be whether it is really desired to remove an algorithm from Sage and instead use the same algorithm from Gap?

Sage should not reinvent the wheel. Gap is now interfaced as a fairly good level and we should try to maximize its usage at what it is good for.

That being said, it would makes sense to keep your implementation somewhere with more comparisons to the libgap implementation. Especially if you found that the Gap implementation has some bug! But I did not find any relevant example since all tests pass with my branch applied.

> Don't you think that working on the cython part of my implementation (maybe even moving to plain C of some core functionality) could get it beyond the speed of the black box (from a Sage point of view) Gap implementation?

No idea. And I will not try. It is much more work than proposing what I did. And if you ask me what I would do if I want even more speed, I would link to Gap at an even lower level.

> Secondly, I remember that I did quite some tests back when I implemented the UCF. And that in the end, the Sage implementation was slower on some parts, while faster on others (one I remember were Sage was quicker was the computation of the Galois conjugates of big elements, in case you want to test, one example might be `E( 2^11 * 3^4 )`). I would really like to redo these tests, but haven't yet been able to get your branch running on my computer. I will get back once that worked out.

Great! I will add this to the `ucf_test.py` that I wrote. If you have other examples in mind, please propose. I am not sure it will make a difference now since big numbers with pexpect implies a lot of parsing and computation. With libgap it is not the case anymore.

> I also remember to have found a few bugs in the Gap implementation while implementing UCFs in Sage. That would also not be possible anymore when only relying on the implementation in Gap.

You do not remember what they are? Did you report them to Gap? 

Cheers
Vincent



---

archive/issue_comments_240191.json:
```json
{
    "body": "Hi Vincent,\n\nReplying to [comment:19 vdelecroix]:\n> Me too. I wondered if something were better with your code. But except the documentation I did not find any case were it was faster.\n\nDid you already redo the Galois conjugate test which I remember was slower in Gap back then?\n\n> Great! I will add this to the `ucf_test.py` that I wrote. If you have other examples in mind, please propose. I am not sure it will make a difference now since big numbers with pexpect implies a lot of parsing and computation. With libgap it is not the case anymore.\n\nI just did\n\n\n```\nsage: a = E( 2^11 * 3^4 )\nsage: %time x = a.galois_conjugates()\nCPU times: user 5.52 s, sys: 159 ms, total: 5.68 s\nWall time: 5.66 s\nsage: %time x = a.galois_conjugates()\nCPU times: user 6.81 s, sys: 170 ms, total: 6.98 s\nWall time: 6.99 s\n```\n\n\nand compared it to\n\n\n```\ngap> a := E( 2^11 * 3^4 );;\ngap> L := PrimeResidues(165888);;\ngap> for i in L do\n> x := GaloisCyc(a,i);\n> od;\n```\n\nwhich I had running for 30 sec before I ctrc-c'ed it. (I also believe that in Sage, a big portion of the time is spend of computing the list of coprimes.)\n\n> You do not remember what they are? Did you report them to Gap?\n\nI did report them, and they were fixed.\n\nOnce I get your branch running, I try to get back other tests I did.\n\nCheers, Christian",
    "created_at": "2015-04-15T11:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240191",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

Hi Vincent,

Replying to [comment:19 vdelecroix]:
> Me too. I wondered if something were better with your code. But except the documentation I did not find any case were it was faster.

Did you already redo the Galois conjugate test which I remember was slower in Gap back then?

> Great! I will add this to the `ucf_test.py` that I wrote. If you have other examples in mind, please propose. I am not sure it will make a difference now since big numbers with pexpect implies a lot of parsing and computation. With libgap it is not the case anymore.

I just did


```
sage: a = E( 2^11 * 3^4 )
sage: %time x = a.galois_conjugates()
CPU times: user 5.52 s, sys: 159 ms, total: 5.68 s
Wall time: 5.66 s
sage: %time x = a.galois_conjugates()
CPU times: user 6.81 s, sys: 170 ms, total: 6.98 s
Wall time: 6.99 s
```


and compared it to


```
gap> a := E( 2^11 * 3^4 );;
gap> L := PrimeResidues(165888);;
gap> for i in L do
> x := GaloisCyc(a,i);
> od;
```

which I had running for 30 sec before I ctrc-c'ed it. (I also believe that in Sage, a big portion of the time is spend of computing the list of coprimes.)

> You do not remember what they are? Did you report them to Gap?

I did report them, and they were fixed.

Once I get your branch running, I try to get back other tests I did.

Cheers, Christian



---

archive/issue_comments_240192.json:
```json
{
    "body": "Hi there!\n\nI will also do some tests on the ticket and let you know.\n\nOne thing not to forget is also the number of tickets repaired by this new implementation. If the ticket repairs them and is faster... It's difficult to say no to that.\n\nGr\u00fcsse,\nJP",
    "created_at": "2015-04-15T12:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240192",
    "user": "https://github.com/jplab"
}
```

Hi there!

I will also do some tests on the ticket and let you know.

One thing not to forget is also the number of tickets repaired by this new implementation. If the ticket repairs them and is faster... It's difficult to say no to that.

Grüsse,
JP



---

archive/issue_comments_240193.json:
```json
{
    "body": "Hello,\n\nI pushed an experimental branch with both implementations at `public/18152`. It is certain that most doctest fail but it is not the purpose. With it you can do\n\n```\nsage: UCF_native.<E_native> = UniversalCyclotomicField_native()\nsage: UCF_libgap.<E_libgap> = UniversalCyclotomicField_libgap()\nsage: UCF_native\nUniversal Cyclotomic Field (native)\nsage: UCF_libgap\nUniversal Cyclotomic Field (libgap)\n```\n\nand play around with both implementations.\n\n\nReplying to [comment:20]: it is true that `GaloisCyc` is slow in GAP (and it is not `PrimeResidues` which takes time). I got with a little bit smaller example\n\n```\nsage: a = E_libgap( 2^9 * 3^4 )\nsage: b = E_native( 2^9 * 3^4 )\nsage: %time l = a.galois_conjugates()\nCPU times: user 6.92 s, sys: 4 ms, total: 6.92 s\nWall time: 6.9 s\nsage: %time l = b.galois_conjugates()\nCPU times: user 352 ms, sys: 52 ms, total: 404 ms\nWall time: 387 ms\n```\n\n\nReplying to [comment:21]: I do not think that the issues in the four tickets mentioned in the description are that big (and one of them has a fix).\n\nVincent",
    "created_at": "2015-04-15T15:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240193",
    "user": "https://github.com/videlec"
}
```

Hello,

I pushed an experimental branch with both implementations at `public/18152`. It is certain that most doctest fail but it is not the purpose. With it you can do

```
sage: UCF_native.<E_native> = UniversalCyclotomicField_native()
sage: UCF_libgap.<E_libgap> = UniversalCyclotomicField_libgap()
sage: UCF_native
Universal Cyclotomic Field (native)
sage: UCF_libgap
Universal Cyclotomic Field (libgap)
```

and play around with both implementations.


Replying to [comment:20]: it is true that `GaloisCyc` is slow in GAP (and it is not `PrimeResidues` which takes time). I got with a little bit smaller example

```
sage: a = E_libgap( 2^9 * 3^4 )
sage: b = E_native( 2^9 * 3^4 )
sage: %time l = a.galois_conjugates()
CPU times: user 6.92 s, sys: 4 ms, total: 6.92 s
Wall time: 6.9 s
sage: %time l = b.galois_conjugates()
CPU times: user 352 ms, sys: 52 ms, total: 404 ms
Wall time: 387 ms
```


Replying to [comment:21]: I do not think that the issues in the four tickets mentioned in the description are that big (and one of them has a fix).

Vincent



---

archive/issue_comments_240194.json:
```json
{
    "body": "the branch runs now...\n\nOne issue I see is that it would if my code would not break because a few methods disappeared (such as `field_order` and `min_poly`. But this problem is minor and easy to fix -- worst case is I update my code.\n\nRedoing the following tests `Sage` vs. `libgap`:\n1.\n\n```\nsage: a = E(5)\nsage: %timeit a.conjugate()\n10000 loops, best of 3: 62.4 \u00b5s per loop\n```\n\nvs.\n\n```\nsage: a = E(5)\nsage: %timeit a.conjugate()\n10000 loops, best of 3: 39.9 \u00b5s per loop\n```\n\n2.\n\n```\nsage: a = E( 2^10 )\nsage: %timeit a.conjugate()\n10000 loops, best of 3: 69.1 \u00b5s per loop\n```\n\nvs.\n\n```\nsage: sage: a = E( 2^10 )\nsage: sage: %timeit a.conjugate()\n10000 loops, best of 3: 75.1 \u00b5s per loop\n```\n\n3.\n\n```\nsage: a = E( 2^11 * 3^4 )\nsage: %timeit a.conjugate()\n10000 loops, best of 3: 118 \u00b5s per loop\n```\n\nvs.\n\n```\nsage: a = E( 2^11 * 3^4 )\nsage: sage: %timeit a.conjugate()\n100 loops, best of 3: 9.15 ms per loop\n```\n\nFor the Galois conjugation, the `libgap` implementation doesn't finish in very finite time, see also your example above.",
    "created_at": "2015-04-15T15:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240194",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

the branch runs now...

One issue I see is that it would if my code would not break because a few methods disappeared (such as `field_order` and `min_poly`. But this problem is minor and easy to fix -- worst case is I update my code.

Redoing the following tests `Sage` vs. `libgap`:
1.

```
sage: a = E(5)
sage: %timeit a.conjugate()
10000 loops, best of 3: 62.4 µs per loop
```

vs.

```
sage: a = E(5)
sage: %timeit a.conjugate()
10000 loops, best of 3: 39.9 µs per loop
```

2.

```
sage: a = E( 2^10 )
sage: %timeit a.conjugate()
10000 loops, best of 3: 69.1 µs per loop
```

vs.

```
sage: sage: a = E( 2^10 )
sage: sage: %timeit a.conjugate()
10000 loops, best of 3: 75.1 µs per loop
```

3.

```
sage: a = E( 2^11 * 3^4 )
sage: %timeit a.conjugate()
10000 loops, best of 3: 118 µs per loop
```

vs.

```
sage: a = E( 2^11 * 3^4 )
sage: sage: %timeit a.conjugate()
100 loops, best of 3: 9.15 ms per loop
```

For the Galois conjugation, the `libgap` implementation doesn't finish in very finite time, see also your example above.



---

archive/issue_comments_240195.json:
```json
{
    "body": "`conjugate` actually uses `GaloisCyc` as in http://www.math.rwth-aachen.de/~Greg.Gamble/gap4r3/doc/htm/ref/CHAP058.htm#SSEC002.4.",
    "created_at": "2015-04-15T15:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240195",
    "user": "https://trac.sagemath.org/admin/accounts/users/stumpc5"
}
```

`conjugate` actually uses `GaloisCyc` as in http://www.math.rwth-aachen.de/~Greg.Gamble/gap4r3/doc/htm/ref/CHAP058.htm#SSEC002.4.



---

archive/issue_comments_240196.json:
```json
{
    "body": "I opened #18207 for this slowness.",
    "created_at": "2015-04-15T15:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240196",
    "user": "https://github.com/videlec"
}
```

I opened #18207 for this slowness.



---

archive/issue_comments_240197.json:
```json
{
    "body": "Replying to [comment:25 vdelecroix]:\n> I opened #18207 for this slowness.\n\n(most time seems to be spent in the function `ConvertToBase` in `cyclotom.c`)",
    "created_at": "2015-04-15T15:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240197",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:25 vdelecroix]:
> I opened #18207 for this slowness.

(most time seems to be spent in the function `ConvertToBase` in `cyclotom.c`)



---

archive/issue_comments_240198.json:
```json
{
    "body": "On the other hand your code becomes slower when the element is more complicated\n\n```\nsage: a = sum(E_libgap( 2^8 * 3^4, i) for i in range(0, 2**12, 37))\nsage: b = sum(E_native( 2^8 * 3^4, i) for i in range(0, 2**12, 37))\nsage: %timeit _ = a.conjugate()\n1000 loops, best of 3: 262 \u00b5s per loop\nsage: %timeit _ = b.conjugate()\n1000 loops, best of 3: 793 \u00b5s per loop\n```\n\nSo I would not say that `conjugate` is slower.",
    "created_at": "2015-04-15T16:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240198",
    "user": "https://github.com/videlec"
}
```

On the other hand your code becomes slower when the element is more complicated

```
sage: a = sum(E_libgap( 2^8 * 3^4, i) for i in range(0, 2**12, 37))
sage: b = sum(E_native( 2^8 * 3^4, i) for i in range(0, 2**12, 37))
sage: %timeit _ = a.conjugate()
1000 loops, best of 3: 262 µs per loop
sage: %timeit _ = b.conjugate()
1000 loops, best of 3: 793 µs per loop
```

So I would not say that `conjugate` is slower.



---

archive/issue_comments_240199.json:
```json
{
    "body": "Ok. The whole thing about conjugation just reflects the fact that Gap is using a dense representation where yours is sparse. In `a.conjugate()` Gap just run through **all** coefficients, looking for the nonzero ones. For cyclotomic elements with large conductor **and** few nonzero coefficients, it makes a big difference.\n\nIs there a use case for sparse cyclotomic elements with large conductor?",
    "created_at": "2015-04-15T16:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240199",
    "user": "https://github.com/videlec"
}
```

Ok. The whole thing about conjugation just reflects the fact that Gap is using a dense representation where yours is sparse. In `a.conjugate()` Gap just run through **all** coefficients, looking for the nonzero ones. For cyclotomic elements with large conductor **and** few nonzero coefficients, it makes a big difference.

Is there a use case for sparse cyclotomic elements with large conductor?



---

archive/issue_comments_240200.json:
```json
{
    "body": "Hi,\n\nSo, all test pass on my 6.6.rc3. I went through the files and removed some trailing spaces and blank lines.\n\nReplying to [comment:28 28]: I do not have a use case for sparse cyclotomic out of my head. It is also difficult to guess for the use I have in mind (mainly representation of Coxeter groups). Nonetheless, the matrices will not have large conductor. Thus I would say it is not too bad as it is for the purpose of Coxeter groups.\n\nGoing through the discussion, the current state of affairs is:\n\nThe following tickets are fixed:\n#14240, #16130, #16631, #17117\n\nThe following tickets are follow-ups:\n#16116,#18207\n\nThe ticket looks good to me. It is well doctested with many examples. I would put positive review, nevertheless it would be good if someone else also go over the ticket too, Christian?\n\nBest,\nJP\n----\nNew commits:",
    "created_at": "2015-04-21T12:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240200",
    "user": "https://github.com/jplab"
}
```

Hi,

So, all test pass on my 6.6.rc3. I went through the files and removed some trailing spaces and blank lines.

Replying to [comment:28 28]: I do not have a use case for sparse cyclotomic out of my head. It is also difficult to guess for the use I have in mind (mainly representation of Coxeter groups). Nonetheless, the matrices will not have large conductor. Thus I would say it is not too bad as it is for the purpose of Coxeter groups.

Going through the discussion, the current state of affairs is:

The following tickets are fixed:
#14240, #16130, #16631, #17117

The following tickets are follow-ups:
#16116,#18207

The ticket looks good to me. It is well doctested with many examples. I would put positive review, nevertheless it would be good if someone else also go over the ticket too, Christian?

Best,
JP
----
New commits:



---

archive/issue_comments_240201.json:
```json
{
    "body": "There are merged conflicts on the last beta... Wait a minute, I am doing a rebase. I am doing a rebase.",
    "created_at": "2015-04-21T12:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240201",
    "user": "https://github.com/videlec"
}
```

There are merged conflicts on the last beta... Wait a minute, I am doing a rebase. I am doing a rebase.



---

archive/issue_comments_240202.json:
```json
{
    "body": "Oops, my bad... Should have done it with the 6.6 ...",
    "created_at": "2015-04-21T12:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240202",
    "user": "https://github.com/jplab"
}
```

Oops, my bad... Should have done it with the 6.6 ...



---

archive/issue_comments_240203.json:
```json
{
    "body": "Salut Jean-Phillippe,\n\nThanks for your corrections! The branch is a fast forward. So you have to delete your previous branch. Your commit is preserved (it is now 08df5b4). I added three commits for better compatibility with the previous version:\n- adding a `minpoly` and `field_order` methods as it was requested in [comment:23 comment:23] (see also #18266 for a potential improvement)\n- adding a `__neg__` (it is now faster to do `-E(3)`)\n\nVincent\n----\nNew commits:",
    "created_at": "2015-04-21T13:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240203",
    "user": "https://github.com/videlec"
}
```

Salut Jean-Phillippe,

Thanks for your corrections! The branch is a fast forward. So you have to delete your previous branch. Your commit is preserved (it is now 08df5b4). I added three commits for better compatibility with the previous version:
- adding a `minpoly` and `field_order` methods as it was requested in [comment:23 comment:23] (see also #18266 for a potential improvement)
- adding a `__neg__` (it is now faster to do `-E(3)`)

Vincent
----
New commits:



---

archive/issue_comments_240204.json:
```json
{
    "body": "Replying to [comment:30 jipilab]:\n> The following tickets are fixed:\n> #14240, #16130, #16631, #17117\n\nAnd actually, doctests are already there! So these should be closed as soon as this one gets positively reviewed.\n\nVincent",
    "created_at": "2015-04-21T13:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240204",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:30 jipilab]:
> The following tickets are fixed:
> #14240, #16130, #16631, #17117

And actually, doctests are already there! So these should be closed as soon as this one gets positively reviewed.

Vincent



---

archive/issue_comments_240205.json:
```json
{
    "body": "But there is still the most important question: do we keep both versions (one being sparse the other being dense)?\n\nVincent",
    "created_at": "2015-04-21T13:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240205",
    "user": "https://github.com/videlec"
}
```

But there is still the most important question: do we keep both versions (one being sparse the other being dense)?

Vincent



---

archive/issue_comments_240206.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-21T15:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240206",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_240207.json:
```json
{
    "body": "All right. Updated on the very last 6.7.beta2!",
    "created_at": "2015-04-21T15:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240207",
    "user": "https://github.com/videlec"
}
```

All right. Updated on the very last 6.7.beta2!



---

archive/issue_comments_240208.json:
```json
{
    "body": "Replying to [comment:36 vdelecroix]:\n> But there is still the most important question: do we keep both versions (one being sparse the other being dense)?\n\nIMO, we should keep both with the default being the dense.",
    "created_at": "2015-04-21T16:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240208",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:36 vdelecroix]:
> But there is still the most important question: do we keep both versions (one being sparse the other being dense)?

IMO, we should keep both with the default being the dense.



---

archive/issue_comments_240209.json:
```json
{
    "body": "Replying to [comment:39 tscrim]:\n> Replying to [comment:36 vdelecroix]:\n> > But there is still the most important question: do we keep both versions (one being sparse the other being dense)?\n> \n> IMO, we should keep both with the default being the dense.\n\nI was implictely requiring arguments. We will not keep it just because you think it has to ;-) I do have arguments for both sides, but as I am the ticket author I better not participate.",
    "created_at": "2015-04-21T16:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240209",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:39 tscrim]:
> Replying to [comment:36 vdelecroix]:
> > But there is still the most important question: do we keep both versions (one being sparse the other being dense)?
> 
> IMO, we should keep both with the default being the dense.

I was implictely requiring arguments. We will not keep it just because you think it has to ;-) I do have arguments for both sides, but as I am the ticket author I better not participate.



---

archive/issue_comments_240210.json:
```json
{
    "body": "The main argument I could see for keeping the code around is as follow: The speed balance may evolve in the future, typically if free modules in Sage get optimized, or if new use cases emerge. Of course we could always revive the code then, but it would probably have rotten in the mean time, and we may have completely forgotten about it. It also can be used for testing purposes for comparing two independent implementations of UCF. \n\nThose are not super strong arguments.\n\nThe main argument for not keeping it is that we would not want is wasting time maintaining it. \n\nA sensible approach might be to write a brief comment at the beginning of the file / class stating something like: \"at this point this code is not used much (see ...). If maintaining it becomes a bother in the future, it's ok to discard it\".",
    "created_at": "2015-04-22T09:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240210",
    "user": "https://github.com/nthiery"
}
```

The main argument I could see for keeping the code around is as follow: The speed balance may evolve in the future, typically if free modules in Sage get optimized, or if new use cases emerge. Of course we could always revive the code then, but it would probably have rotten in the mean time, and we may have completely forgotten about it. It also can be used for testing purposes for comparing two independent implementations of UCF. 

Those are not super strong arguments.

The main argument for not keeping it is that we would not want is wasting time maintaining it. 

A sensible approach might be to write a brief comment at the beginning of the file / class stating something like: "at this point this code is not used much (see ...). If maintaining it becomes a bother in the future, it's ok to discard it".



---

archive/issue_comments_240211.json:
```json
{
    "body": "Perhaps one could add a comment/warning in the beginning of the file also to mention that GAP uses a dense representation and a link to the current ticket.\n\nIf there is a use case popping up in the future we could revive the code as Nicolas mentioned.\n\n`@`Christian: In your actual usage (not tests), is sparse faster than the current dense representation of GAP?\n\nAlso: I just updated to 6.7.beta3 on my computer and pulled the ticket. There was a small conflict in the file\n\nsrc/doc/en/reference/rings_standard/index.rst\n\nShould I push the resolution of the conflict here?",
    "created_at": "2015-04-29T09:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240211",
    "user": "https://github.com/jplab"
}
```

Perhaps one could add a comment/warning in the beginning of the file also to mention that GAP uses a dense representation and a link to the current ticket.

If there is a use case popping up in the future we could revive the code as Nicolas mentioned.

`@`Christian: In your actual usage (not tests), is sparse faster than the current dense representation of GAP?

Also: I just updated to 6.7.beta3 on my computer and pulled the ticket. There was a small conflict in the file

src/doc/en/reference/rings_standard/index.rst

Should I push the resolution of the conflict here?



---

archive/issue_comments_240212.json:
```json
{
    "body": "Replying to [comment:42 jipilab]:\n> Also: I just updated to 6.7.beta3 on my computer and pulled the ticket. There was a small conflict in the file\n> \n> src/doc/en/reference/rings_standard/index.rst\n> \n> Should I push the resolution of the conflict here?\n\nYes please.",
    "created_at": "2015-04-29T09:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240212",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:42 jipilab]:
> Also: I just updated to 6.7.beta3 on my computer and pulled the ticket. There was a small conflict in the file
> 
> src/doc/en/reference/rings_standard/index.rst
> 
> Should I push the resolution of the conflict here?

Yes please.



---

archive/issue_comments_240213.json:
```json
{
    "body": "Et voil\u00e0!\n----\nNew commits:",
    "created_at": "2015-04-29T16:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240213",
    "user": "https://github.com/jplab"
}
```

Et voilà!
----
New commits:



---

archive/issue_comments_240214.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-30T08:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240214",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_240215.json:
```json
{
    "body": "Hi,\n\nAll test passed on 6.7.beta3!\n\nCould you add a comment/warning at the beginning of the file mentioning the old implementation and a link to the ticket?\n\nPerhaps it would be good to mention this in the documentation as well?",
    "created_at": "2015-04-30T08:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240215",
    "user": "https://github.com/jplab"
}
```

Hi,

All test passed on 6.7.beta3!

Could you add a comment/warning at the beginning of the file mentioning the old implementation and a link to the ticket?

Perhaps it would be good to mention this in the documentation as well?



---

archive/issue_comments_240216.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-30T12:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240216",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_240217.json:
```json
{
    "body": "Done. I also simplified some imports.\n----\nNew commits:",
    "created_at": "2015-04-30T12:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240217",
    "user": "https://github.com/videlec"
}
```

Done. I also simplified some imports.
----
New commits:



---

archive/issue_comments_240218.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-06T09:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240218",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_240219.json:
```json
{
    "body": "Hi,\n\nThis looks good to go as I see it.\n\nI set it to positive review.",
    "created_at": "2015-05-06T09:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240219",
    "user": "https://github.com/jplab"
}
```

Hi,

This looks good to go as I see it.

I set it to positive review.



---

archive/issue_events_051382.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-06T23:57:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17915#event-51382"
}
```



---

archive/issue_comments_240220.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-06T23:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17915#issuecomment-240220",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
