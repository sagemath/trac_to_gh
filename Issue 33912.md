# Issue 33912: Port documentation building to sphinx 5

Issue created by migration from https://trac.sagemath.org/ticket/34149

Original creator: fbissey

Original creation time: 2022-07-11 08:49:27

CC:  arojas strogdon @collares

Sphinx 5 has been out for a bit and is now stable in Gentoo at least. At this stage there is one identified issue

```
make[1]: Entering directory '/home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc'
python -m sage_docbuild --no-pdf-links reference/references inventory 
[reference] Extension error:
[reference] Could not import extension sage_docbuild.ext.sage_autodoc (exception: cannot import name 'get_module_members' from 'sphinx.ext.autodoc.importer' (/usr/lib/python3.10/site-packages/sphinx/ext/autodoc/importer.py))
```

According to https://www.sphinx-doc.org/en/master/extdev/deprecated.html `get_module_members` was deprecated in sphinx 3.5 and removed in sphinx 5.0.


---

Comment by fbissey created at 2022-07-11 09:55:29

As it turns out, the imported `get_module_members` is overridden by the method of the same name from sage_autodoc own `ModuleDocumenter` class. Simply removing the import is enough.

Next error:

```
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py", line 500, in <module>
    sys.exit(main())
  File "/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py", line 497, in main
    builder()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/builders.py", line 823, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/usr/lib/python3.10/site-packages/sage_docbuild/builders.py", line 167, in f
    runsphinx()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py", line 327, in runsphinx
    sys.stderr.raise_errors()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py", line 263, in raise_errors
    raise OSError(self._error)
OSError: WARNING: extlinks: Sphinx-6.0 will require a caption string to contain exactly one '%s' and all other '%' need to be escaped as '%%'.
```

Warning for upcoming sphinx 6.0 is treated as an error.


---

Comment by fbissey created at 2022-07-11 10:34:11

New commits:


---

Comment by git created at 2022-07-11 11:00:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-07-11 11:01:16

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-07-11 20:58:55

`@`arojas FYI if this doesn't make it in 9.7.


---

Comment by fbissey created at 2022-07-11 21:12:44

`@`Steve I pushed the change in Gentoo last night (NZ time) would be OK to review this?


---

Comment by arojas created at 2022-07-11 22:07:10

Changing status from needs_review to positive_review.


---

Comment by arojas created at 2022-07-11 22:07:10

WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)


---

Comment by fbissey created at 2022-07-11 22:12:03

Replying to [comment:10 arojas]:
> WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)

I haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall.


---

Comment by arojas created at 2022-07-11 22:16:03

Replying to [comment:11 fbissey]:
> I haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall. 

Going through the makefile is now mandatory
https://git.sagemath.org/sage.git/commit/?h=develop&id=7759f3c23b07b56897a691baf57e6f00b98d78b6


---

Comment by fbissey created at 2022-07-11 22:19:53

Yes, I split before my work around for not using the Makefile would break. It looks like that was a good early move. Using the Makefile is good but I could not leave it as is, especially the bits about `SAGE_ROOT`.
https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.7-makefile_and_parallel.patch


---

Comment by vbraun created at 2022-07-11 22:30:37

Merge failure on top of:

73d7bb0aae Trac #34122: Bug in is_planar() method for directed graphs

b9b73ce665 Trac #33160: update Singular to 4.3.1

1dd3b4819f Trac #33134: doctest failure in hilbert_poincare_series with singular 4.2.1

c9cfb5395f Trac #34087: inverse reciprocal trig functions not (back)translated to/from Mathematica

1d6d055563 Trac #34076: pycodestyle cleanup in src/sage/graphs/genus.pyx

043d862b5d Trac #34071: pycodestyle cleanup in asteroidal_triples.pyx, chrompoly.pyx, cliquer.pyx, convexity_properties.pyx

b9b25dc735 Trac #34070: pycodestyle cleanup in src/sage/graphs/centrality.pyx

4ef2c6597d Trac #34069: pycodestyle cleanup in src/sage/graphs/comparability.pyx

5b1146766b Trac #34066: Tachyon help message

798adaa5a3 Trac #34065: pycodestyle cleanup in src/sage/graphs/bliss.pyx

ce62be23a2 Trac #34063: pycodestyle cleanup in src/sage/graphs/base/

a0eadb3e40 Trac #34059: Fix trivial case in conversion of list to number field element

fea0ac50a6 Trac #34057: changes about avoiding double dieses

9eefd5c27e Trac #34145: modernize super in geometry/

01e117dfd8 Trac #34137: modernize super in categories/

6c79334402 Trac #33819: build.yml: In workflow_dispatch, make container and base tag selectable; add doc

6a64ab8d00 Trac #33760: do not update _pos, _pos3d, _embedding on vertex/edge deletions

dbf091dbbb Trac #34139: fix the linter

625ac58151 Updated [SageMath](SageMath) version to 9.7.beta5



reviewer '' does not look right


---

Comment by vbraun created at 2022-07-11 22:30:37

Changing status from positive_review to needs_work.


---

Comment by strogdon created at 2022-07-12 00:42:12

Changing status from needs_work to positive_review.


---

Comment by strogdon created at 2022-07-12 00:42:12

I think this is all that was needed.


---

Comment by fbissey created at 2022-07-12 00:45:05

Thanks Steve, I did not receive an email for the change triggered by Volker.


---

Comment by fbissey created at 2022-07-12 01:33:37

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2022-07-12 01:33:37

Conflict with #34109 which touches exactly the same line in `sagedoc.py`.


---

Comment by git created at 2022-07-12 01:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-07-12 01:43:50

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2022-07-12 01:43:50

Merged with #34109 which is positively reviewed and in the process of being merged - back to positive review.


---

Comment by vbraun created at 2022-07-28 19:10:11

Resolution: fixed
