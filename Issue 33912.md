# Issue 33912: Port documentation building to sphinx 5

archive/issues_033912.json:
```json
{
    "body": "CC:  arojas strogdon @collares\n\nSphinx 5 has been out for a bit and is now stable in Gentoo at least. At this stage there is one identified issue\n\n```\nmake[1]: Entering directory '/home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc'\npython -m sage_docbuild --no-pdf-links reference/references inventory \n[reference] Extension error:\n[reference] Could not import extension sage_docbuild.ext.sage_autodoc (exception: cannot import name 'get_module_members' from 'sphinx.ext.autodoc.importer' (/usr/lib/python3.10/site-packages/sphinx/ext/autodoc/importer.py))\n```\n\nAccording to https://www.sphinx-doc.org/en/master/extdev/deprecated.html `get_module_members` was deprecated in sphinx 3.5 and removed in sphinx 5.0.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34149\n\n",
    "created_at": "2022-07-11T08:49:27Z",
    "labels": [
        "documentation",
        "major",
        "bug"
    ],
    "title": "Port documentation building to sphinx 5",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33912",
    "user": "fbissey"
}
```
CC:  arojas strogdon @collares

Sphinx 5 has been out for a bit and is now stable in Gentoo at least. At this stage there is one identified issue

```
make[1]: Entering directory '/home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc'
python -m sage_docbuild --no-pdf-links reference/references inventory 
[reference] Extension error:
[reference] Could not import extension sage_docbuild.ext.sage_autodoc (exception: cannot import name 'get_module_members' from 'sphinx.ext.autodoc.importer' (/usr/lib/python3.10/site-packages/sphinx/ext/autodoc/importer.py))
```

According to https://www.sphinx-doc.org/en/master/extdev/deprecated.html `get_module_members` was deprecated in sphinx 3.5 and removed in sphinx 5.0.

Issue created by migration from https://trac.sagemath.org/ticket/34149





---

archive/issue_comments_481441.json:
```json
{
    "body": "As it turns out, the imported `get_module_members` is overridden by the method of the same name from sage_autodoc own `ModuleDocumenter` class. Simply removing the import is enough.\n\nNext error:\n\n```\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/lib/python3.10/runpy.py\", line 196, in _run_module_as_main\n    return _run_code(code, main_globals, None,\n  File \"/usr/lib/python3.10/runpy.py\", line 86, in _run_code\n    exec(code, run_globals)\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py\", line 500, in <module>\n    sys.exit(main())\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py\", line 497, in main\n    builder()\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/builders.py\", line 823, in _wrapper\n    getattr(DocBuilder, build_type)(self, *args, **kwds)\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/builders.py\", line 167, in f\n    runsphinx()\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py\", line 327, in runsphinx\n    sys.stderr.raise_errors()\n  File \"/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py\", line 263, in raise_errors\n    raise OSError(self._error)\nOSError: WARNING: extlinks: Sphinx-6.0 will require a caption string to contain exactly one '%s' and all other '%' need to be escaped as '%%'.\n```\n\nWarning for upcoming sphinx 6.0 is treated as an error.",
    "created_at": "2022-07-11T09:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481441",
    "user": "fbissey"
}
```

As it turns out, the imported `get_module_members` is overridden by the method of the same name from sage_autodoc own `ModuleDocumenter` class. Simply removing the import is enough.

Next error:

```
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python3.10/runpy.py", line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "/usr/lib/python3.10/runpy.py", line 86, in _run_code
    exec(code, run_globals)
  File "/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py", line 500, in <module>
    sys.exit(main())
  File "/usr/lib/python3.10/site-packages/sage_docbuild/__main__.py", line 497, in main
    builder()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/builders.py", line 823, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/usr/lib/python3.10/site-packages/sage_docbuild/builders.py", line 167, in f
    runsphinx()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py", line 327, in runsphinx
    sys.stderr.raise_errors()
  File "/usr/lib/python3.10/site-packages/sage_docbuild/sphinxbuild.py", line 263, in raise_errors
    raise OSError(self._error)
OSError: WARNING: extlinks: Sphinx-6.0 will require a caption string to contain exactly one '%s' and all other '%' need to be escaped as '%%'.
```

Warning for upcoming sphinx 6.0 is treated as an error.



---

archive/issue_comments_481442.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-07-11T10:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481442",
    "user": "fbissey"
}
```

New commits:



---

archive/issue_comments_481443.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-11T11:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481443",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481444.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-11T11:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481444",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_481445.json:
```json
{
    "body": "`@`arojas FYI if this doesn't make it in 9.7.",
    "created_at": "2022-07-11T20:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481445",
    "user": "fbissey"
}
```

`@`arojas FYI if this doesn't make it in 9.7.



---

archive/issue_comments_481446.json:
```json
{
    "body": "`@`Steve I pushed the change in Gentoo last night (NZ time) would be OK to review this?",
    "created_at": "2022-07-11T21:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481446",
    "user": "fbissey"
}
```

`@`Steve I pushed the change in Gentoo last night (NZ time) would be OK to review this?



---

archive/issue_comments_481447.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-11T22:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481447",
    "user": "arojas"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_481448.json:
```json
{
    "body": "WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)",
    "created_at": "2022-07-11T22:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481448",
    "user": "arojas"
}
```

WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)



---

archive/issue_comments_481449.json:
```json
{
    "body": "Replying to [comment:10 arojas]:\n> WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)\n\nI haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall.",
    "created_at": "2022-07-11T22:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481449",
    "user": "fbissey"
}
```

Replying to [comment:10 arojas]:
> WFM, thanks (and I just found out that doc building on distros got yet more complicated in 9.7, sigh)

I haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall.



---

archive/issue_comments_481450.json:
```json
{
    "body": "Replying to [comment:11 fbissey]:\n> I haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall. \n\nGoing through the makefile is now mandatory\nhttps://git.sagemath.org/sage.git/commit/?h=develop&id=7759f3c23b07b56897a691baf57e6f00b98d78b6",
    "created_at": "2022-07-11T22:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481450",
    "user": "arojas"
}
```

Replying to [comment:11 fbissey]:
> I haven't experienced trouble so far apart from sphinx just going up under my nose on Gentoo. What do you have problem with? For the record, I ended up splitting sage-doc as its own thing at about sage 9.5 because my work arounds for monolithic build where just looking they could break any time. Splitting has its issue but for documentation building it was positive overall. 

Going through the makefile is now mandatory
https://git.sagemath.org/sage.git/commit/?h=develop&id=7759f3c23b07b56897a691baf57e6f00b98d78b6



---

archive/issue_comments_481451.json:
```json
{
    "body": "Yes, I split before my work around for not using the Makefile would break. It looks like that was a good early move. Using the Makefile is good but I could not leave it as is, especially the bits about `SAGE_ROOT`.\nhttps://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.7-makefile_and_parallel.patch",
    "created_at": "2022-07-11T22:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481451",
    "user": "fbissey"
}
```

Yes, I split before my work around for not using the Makefile would break. It looks like that was a good early move. Using the Makefile is good but I could not leave it as is, especially the bits about `SAGE_ROOT`.
https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage-doc/files/sage-doc-9.7-makefile_and_parallel.patch



---

archive/issue_comments_481452.json:
```json
{
    "body": "Merge failure on top of:\n\n73d7bb0aae Trac #34122: Bug in is_planar() method for directed graphs\n\nb9b73ce665 Trac #33160: update Singular to 4.3.1\n\n1dd3b4819f Trac #33134: doctest failure in hilbert_poincare_series with singular 4.2.1\n\nc9cfb5395f Trac #34087: inverse reciprocal trig functions not (back)translated to/from Mathematica\n\n1d6d055563 Trac #34076: pycodestyle cleanup in src/sage/graphs/genus.pyx\n\n043d862b5d Trac #34071: pycodestyle cleanup in asteroidal_triples.pyx, chrompoly.pyx, cliquer.pyx, convexity_properties.pyx\n\nb9b25dc735 Trac #34070: pycodestyle cleanup in src/sage/graphs/centrality.pyx\n\n4ef2c6597d Trac #34069: pycodestyle cleanup in src/sage/graphs/comparability.pyx\n\n5b1146766b Trac #34066: Tachyon help message\n\n798adaa5a3 Trac #34065: pycodestyle cleanup in src/sage/graphs/bliss.pyx\n\nce62be23a2 Trac #34063: pycodestyle cleanup in src/sage/graphs/base/\n\na0eadb3e40 Trac #34059: Fix trivial case in conversion of list to number field element\n\nfea0ac50a6 Trac #34057: changes about avoiding double dieses\n\n9eefd5c27e Trac #34145: modernize super in geometry/\n\n01e117dfd8 Trac #34137: modernize super in categories/\n\n6c79334402 Trac #33819: build.yml: In workflow_dispatch, make container and base tag selectable; add doc\n\n6a64ab8d00 Trac #33760: do not update _pos, _pos3d, _embedding on vertex/edge deletions\n\ndbf091dbbb Trac #34139: fix the linter\n\n625ac58151 Updated [SageMath](SageMath) version to 9.7.beta5\n\n\n\nreviewer '' does not look right",
    "created_at": "2022-07-11T22:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481452",
    "user": "vbraun"
}
```

Merge failure on top of:

73d7bb0aae Trac #34122: Bug in is_planar() method for directed graphs

b9b73ce665 Trac #33160: update Singular to 4.3.1

1dd3b4819f Trac #33134: doctest failure in hilbert_poincare_series with singular 4.2.1

c9cfb5395f Trac #34087: inverse reciprocal trig functions not (back)translated to/from Mathematica

1d6d055563 Trac #34076: pycodestyle cleanup in src/sage/graphs/genus.pyx

043d862b5d Trac #34071: pycodestyle cleanup in asteroidal_triples.pyx, chrompoly.pyx, cliquer.pyx, convexity_properties.pyx

b9b25dc735 Trac #34070: pycodestyle cleanup in src/sage/graphs/centrality.pyx

4ef2c6597d Trac #34069: pycodestyle cleanup in src/sage/graphs/comparability.pyx

5b1146766b Trac #34066: Tachyon help message

798adaa5a3 Trac #34065: pycodestyle cleanup in src/sage/graphs/bliss.pyx

ce62be23a2 Trac #34063: pycodestyle cleanup in src/sage/graphs/base/

a0eadb3e40 Trac #34059: Fix trivial case in conversion of list to number field element

fea0ac50a6 Trac #34057: changes about avoiding double dieses

9eefd5c27e Trac #34145: modernize super in geometry/

01e117dfd8 Trac #34137: modernize super in categories/

6c79334402 Trac #33819: build.yml: In workflow_dispatch, make container and base tag selectable; add doc

6a64ab8d00 Trac #33760: do not update _pos, _pos3d, _embedding on vertex/edge deletions

dbf091dbbb Trac #34139: fix the linter

625ac58151 Updated [SageMath](SageMath) version to 9.7.beta5



reviewer '' does not look right



---

archive/issue_comments_481453.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-07-11T22:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481453",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_481454.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-07-12T00:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481454",
    "user": "strogdon"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_481455.json:
```json
{
    "body": "I think this is all that was needed.",
    "created_at": "2022-07-12T00:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481455",
    "user": "strogdon"
}
```

I think this is all that was needed.



---

archive/issue_comments_481456.json:
```json
{
    "body": "Thanks Steve, I did not receive an email for the change triggered by Volker.",
    "created_at": "2022-07-12T00:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481456",
    "user": "fbissey"
}
```

Thanks Steve, I did not receive an email for the change triggered by Volker.



---

archive/issue_comments_481457.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-07-12T01:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481457",
    "user": "fbissey"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_481458.json:
```json
{
    "body": "Conflict with #34109 which touches exactly the same line in `sagedoc.py`.",
    "created_at": "2022-07-12T01:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481458",
    "user": "fbissey"
}
```

Conflict with #34109 which touches exactly the same line in `sagedoc.py`.



---

archive/issue_comments_481459.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-12T01:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481459",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_481460.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-07-12T01:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481460",
    "user": "fbissey"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_481461.json:
```json
{
    "body": "Merged with #34109 which is positively reviewed and in the process of being merged - back to positive review.",
    "created_at": "2022-07-12T01:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481461",
    "user": "fbissey"
}
```

Merged with #34109 which is positively reviewed and in the process of being merged - back to positive review.



---

archive/issue_comments_481462.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-28T19:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33912#issuecomment-481462",
    "user": "vbraun"
}
```

Resolution: fixed
