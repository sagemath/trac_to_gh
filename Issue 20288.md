# Issue 20288: failing optional doctests

Issue created by migration from https://trac.sagemath.org/ticket/20525

Original creator: vdelecroix

Original creation time: 2016-05-01 04:09:04

CC:  vbraun dimpase

Since #20182 there are some failing doctests related to optional packages

- `coding/linear_code.py`: related to Guava (gap package)
- `tests/gap_packages.py`: related to gap packages


---

Attachment


---

Comment by jdemeyer created at 2016-05-02 08:43:17

Are you sure that #20182 has anything to do with this? It seems to me that something broke `gap_packages`.


---

Comment by vdelecroix created at 2016-05-02 13:15:54

Reformulation: this was not _visible_ before #20182.


---

Comment by jdemeyer created at 2016-05-02 13:19:09

First of all, what is the _exact command_ that you ran to get those doctest failures?

Replying to [comment:3 vdelecroix]:
> this was not _visible_ before #20182.

Did you actually check this or are you just guessing? I.e. by applying #20182 on top of 7.2.beta5 or reverting #20182 from 7.2.beta6?


---

Comment by jdemeyer created at 2016-05-02 13:24:19

Replying to [comment:4 jdemeyer]:
> First of all, what is the _exact command_ that you ran to get those doctest failures?

And did you verify that the same exact command on Sage 7.2.beta5 did not give failures?


---

Comment by vdelecroix created at 2016-05-02 13:24:53

The exact command I ran was

```
for pkg in A_LOT_OF_THINGS
do
    sage -p $pkg
done

sage -patchbot
```


Note that the failing doctests are optional (precisely `# optional - gap_packages`). The patchbot did not ran those before #20182.


---

Comment by jdemeyer created at 2016-05-02 13:46:37

First of all, using `./sage -p $pkg` to install packages is not at all recommended (use `./sage -i $pkg` instead). Second, not running `make` before starting the patchbot is really wrong.


---

Comment by jdemeyer created at 2016-05-02 13:48:38

Do you know the answer to [comment:5]?


---

Comment by jdemeyer created at 2016-05-02 13:50:45

For the record, I can reproduce the problem. I'm just not convinced that #20182 is to blame.


---

Comment by jdemeyer created at 2016-05-02 13:51:41

Changing component from documentation to packages: optional.


---

Comment by klee created at 2016-05-02 14:06:51

Automatic testing of all installed optional packages was introduced in #18558


---

Comment by klee created at 2016-05-02 14:06:51

Changing component from packages: optional to documentation.


---

Comment by jdemeyer created at 2016-05-02 14:42:17

Changing component from documentation to packages: optional.


---

Comment by jdemeyer created at 2016-05-02 14:42:17

Changing priority from major to blocker.


---

Comment by dimpase created at 2016-05-02 14:57:12

these tests work for me. Must be patchbot madness...


---

Comment by jdemeyer created at 2016-05-02 15:01:28

Replying to [comment:16 dimpase]:
> these tests work for me.

Not for me.

> Must be patchbot madness...

No, this is unrelated to the patchbot.


---

Comment by jdemeyer created at 2016-05-02 15:03:34

Please don't revert the changes I make to the ticket :-)


---

Comment by dimpase created at 2016-05-02 15:18:04

ok: `./spkg-install: line 72: cd: /home/scratch/dimpase/sage/sage/local/gap/latest/pkg/guava-3*: No such file or directory`

but why?! This is expansion of `cd "$PKG_DIR/guava-3*"`. And it seems to work:

```
$ cd /home/scratch/dimpase/sage/sage/local/gap/latest/pkg/guava-3*
clpc171[/home/scratch/dimpase/sage/sage/local/gap/latest/pkg/guava-3.13]$ 
```



---

Comment by dimpase created at 2016-05-02 15:36:38

guava issue fix - see the commit
----
New commits:


---

Comment by dimpase created at 2016-05-02 15:43:18

Changing status from new to needs_review.


---

Comment by dimpase created at 2016-05-02 15:43:18

I cannot reproduce the HAPcryst thing though. I get 

```
$ sage -t --long src/sage/tests/gap_packages.py
Running doctests with ID 2016-05-02-16-39-21-92780109.
Git branch: gappacs
Using --optional=cbc,csdp,database_gap,gap_packages,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 56.7 src/sage/tests/gap_packages.py
    [10 tests, 3.75 s]
----------------------------------------------------------------------
All tests passed!
```

As I get 10 tests run as opposed to 9 above, I probably have more packages installed...

and 

```
$ sage --gap
 ┌───────┐   GAP 4.8.3, 19-Mar-2016, build of 2016-04-06 10:34:11 (BST)
 │  GAP  │   http://www.gap-system.org
 └───────┘   Architecture: x86_64-unknown-linux-gnu-gcc-default64
 Libs used:  gmp, readline
 Loading the library and packages ...
 Components: trans 1.0, prim 2.1, small* 1.0, id* 1.0
 Packages:   Alnuth 3.0.0, AtlasRep 1.5.0, AutPGrp 1.6, CTblLib 1.2.2, FactInt 1.5.3, GAPDoc 1.5.1, LAGUNA 3.7.0, 
             Polycyclic 2.11, TomLib 1.2.5
 Try '?help' for help. See also  '?copyright' and  '?authors'
gap> LoadPackage("HAPcryst");
#I  polymake command not found. Please set POLYMAKE_COMMAND by hand
----------------------------------------------------------------
Loading  polymaking 0.8.1
(A package for using polymake in GAP)
by Marc Roeder
----------------------------------------------------------------
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Loading  Cryst 4.1.12 (Computing with crystallographic groups)
by Bettina Eick (http://www.icm.tu-bs.de/~beick/),
   Franz Gähler (http://www.math.uni-bielefeld.de/~gaehler/), and
   Werner Nickel (http://www.mathematik.tu-darmstadt.de/~nickel/).
Homepage: http://www.math.uni-bielefeld.de/~gaehler/gap45/packages.php
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Loading  CrystCat 1.1.6 (The crystallographic groups catalog)
by Volkmar Felsch (http://www.math.rwth-aachen.de/~Volkmar.Felsch/) and
   Franz Gähler (http://www.math.uni-bielefeld.de/~gaehler/).
Homepage: http://www.math.uni-bielefeld.de/~gaehler/gap45/packages.php
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Loading  AClib 1.2 (Almost Crystallographic Groups - A Library and Algorithms)
by Karel Dekimpe (http://www.kulak.ac.be/~dekimpe) and
   Bettina Eick (http://www.icm.tu-bs.de/~beick).
Homepage: http://www.icm.tu-bs.de/~beick/so.html
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────
#I  HAP warning: Set POLYMAKE_PATH manually if needed. 
#I  MakeReadOnlyGlobal: GradedAlgebraPresentationType no value bound
Loading HAP 1.11.13 ...
----------------------------------------------------------------
This is HAPcryst version 0.1.11
by Marc Roeder
----------------------------------------------------------------
true
gap> 
```

looks OK to me.


---

Comment by vdelecroix created at 2016-05-02 15:45:56

I guess you have polymake working on your computer?


---

Comment by jdemeyer created at 2016-05-02 15:55:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-05-02 15:55:22

You need to bump the patchlevel of the `gap_packages` package to ensure the change has effect.


---

Comment by jdemeyer created at 2016-05-02 15:57:00

Also, you better check the result of that `cd` operation, for example

```
cd "$PKG_DIR"/guava-3* && ./configure "$GAP_DIR"
```



---

Comment by jdemeyer created at 2016-05-02 15:57:34

...or use `set -e`.


---

Comment by dimpase created at 2016-05-02 15:59:03

Replying to [comment:30 vdelecroix]:
> I guess you have polymake working on your computer?
no, I don't have polymake at all.


---

Comment by dimpase created at 2016-05-02 16:01:49

Replying to [comment:31 jdemeyer]:
> You need to bump the patchlevel of the `gap_packages` package to ensure the change has effect.

why? the tarball is the same, no removed/added/changed patches. Since when a change to spkg-install does need a version change?!

(this is an optional package, so it won't magically rebuild by bumping anything, no?)


---

Comment by git created at 2016-05-02 16:21:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-05-02 21:33:25

Replying to [comment:35 dimpase]:
> Since when a change to spkg-install does need a version change?!

Since you need to fix broken installations of `gap_packages`. People who install `gap_packages` today have a broken version of it. Just changing `spkg-install` doesn't fix that: you need to actually reinstall `gap_packages`.


---

Comment by dimpase created at 2016-05-02 22:54:19

Replying to [comment:37 jdemeyer]:
> Replying to [comment:35 dimpase]:
> > Since when a change to spkg-install does need a version change?!
> 
> Since you need to fix broken installations of `gap_packages`. People who install `gap_packages` today have a broken version of it. Just changing `spkg-install` doesn't fix that: you need to actually reinstall `gap_packages`.

yes, but it won't happen without human interaction, would it?


---

Comment by jdemeyer created at 2016-05-03 07:10:27

Replying to [comment:38 dimpase]:
> yes, but it won't happen without human interaction, would it?

Installed optional packages are upgraded just like standard packages are. So, running `make` should be sufficient to rebuild `gap_packages` if it was built before.


---

Comment by git created at 2016-05-03 08:35:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-05-03 08:36:33

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2016-05-03 08:36:33

OK, done.


---

Comment by jdemeyer created at 2016-05-03 08:49:28

This fixes the second issue, but not the first.


---

Comment by dimpase created at 2016-05-03 09:50:32

the first issue is not trivial to reproduce. I managed to do so on OSX, and on UGent's sage4. (But all of that works on my laptop and on my desktop). This has to do with selective GAP packages loading, and is an upstream<sup>2</sup> bug, as far as I can see. (A bug in a GAP package, that is).


---

Comment by dimpase created at 2016-05-03 10:26:18

OK, I see. If database_gap is installed then the error does not occur
(it's because it needs `SmallGroup` functionality, specifically, the error comes from `IdGroup` being of wrong type, a function, not an attribute). Looks like a missing dependence in Hap.
I will make database_gap a dependency of gap_packages.


---

Comment by git created at 2016-05-03 10:32:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-05-03 10:38:53

All works now.
----
New commits:


---

Comment by jdemeyer created at 2016-05-03 11:14:24

Shouldn't this be an order-only dependency `| database_gap`?


---

Comment by jdemeyer created at 2016-05-03 11:14:24

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2016-05-03 11:19:41

I don't understand what this is, an order-only dependency...


---

Comment by jdemeyer created at 2016-05-03 11:25:51

See http://doc.sagemath.org/html/en/developer/packaging.html#package-dependencies or https://www.gnu.org/software/make/manual/html_node/Prerequisite-Types.html


---

Comment by dimpase created at 2016-05-03 13:01:37

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2016-05-03 13:01:37

Replying to [comment:47 jdemeyer]:
> Shouldn't this be an order-only dependency `| database_gap`?
I don't think one wants a stale buggy  version of database_gap lying around, just because it is an order-only dependence.
On a practical side of things, database_gap is updated infrequently, so one would potentially pay very little in efficiency by having it as a normal dependency.


---

Comment by jdemeyer created at 2016-05-03 13:06:43

Replying to [comment:50 dimpase]:
> database_gap is updated infrequently, so one would potentially pay very little in efficiency by having it as a normal dependency. 

One would pay _even less_ by having it an order-only dependency. You could add a dependency of `gap_packages` on `zn_poly` and argue that it doesn't hurt because `zn_poly` is not updated often. But that's besides the point: I just want the dependencies to correctly reflect reality.


---

Comment by jdemeyer created at 2016-05-03 13:06:43

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-05-03 13:08:50

Speaking of dependencies: you should also consider whether `gap_packages` depends on `gap` (I don't know if it does?)


---

Comment by dimpase created at 2016-05-03 13:14:03

Replying to [comment:52 jdemeyer]:
> Speaking of dependencies: you should also consider whether `gap_packages` depends on `gap` (I don't know if it does?)

that's right, gap (and libgap) are dependencies, too. I will add them.


---

Comment by dimpase created at 2016-05-03 13:18:10

Replying to [comment:51 jdemeyer]:
> Replying to [comment:50 dimpase]:
> > database_gap is updated infrequently, so one would potentially pay very little in efficiency by having it as a normal dependency. 
> 
> One would pay _even less_ by having it an order-only dependency. You could add a dependency of `gap_packages` on `zn_poly` and argue that it doesn't hurt because `zn_poly` is not updated often. But that's besides the point: I just want the dependencies to correctly reflect reality.

The reality is that if database_gap has a bug, then an output of gap_packages might be wrong. A new release of gap_packages might silently need an newer database_gap, too. 

Order-only dependencies are invented to deal with completely different scenarios, IMHO.


---

Comment by git created at 2016-05-03 13:29:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-05-03 13:30:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-05-03 13:30:15

Replying to [comment:54 dimpase]:
> A new release of gap_packages might silently need an newer database_gap, too.

Sage always installs the latest version of installed standard and optional packages, so `database_gap` will always be up-to-date. That's not something which affects the dependencies of `gap_packages`.


---

Comment by jdemeyer created at 2016-05-03 13:30:26

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-05-03 13:30:26

The question you need to answer is a different one: if `database_gap` is reinstalled (either because of an upgrade of `database_gap` of because somebody did `sage -f database_gap`), should this force a reinstallation of `gap_packages`?

If the answer is "yes": use a normal dependency

If the answer is "no": use an order-only dependency


---

Comment by dimpase created at 2016-05-03 13:57:04

I read the doc you provided, and it said something else:

_If package A has an order-only dependency on B, it simply means that B must be built before A can be built. The version of B does not matter, only the fact that B is installed matters. This should be used if the dependency is purely a build-time dependency (for example, a dependency on Python simply because the spkg-install file is written in Python)._

Against this background, the answer is that B is a runtime dependency, not a build-time dependency, and thus it should not be order-only.


---

Comment by jdemeyer created at 2016-05-03 14:01:19

Replying to [comment:59 dimpase]:
> This should be used *if* the dependency is purely a build-time dependency

That is an *if*, not *if and only if*.

It's not because it's not a build-time dependency, that it should not be an order-only dependency.


---

Comment by dimpase created at 2016-05-03 14:14:29

I do not know all the details to be sure that an order-only dependency is OK. Probably yes, but not 100% certainly.

Also, regarding the upstream opinion on whether it is a bug, see https://github.com/gap-system/gap/issues/775
They think that non-GPL'd libs in database_gap are parts of "GAP core system", whatever they mean.


---

Comment by dimpase created at 2016-05-03 19:37:19

Changing status from needs_info to needs_review.


---

Comment by fbissey created at 2016-05-03 22:04:29

I think it is time for me to crash the party. First I notice that you made `gap_packages` and `database_gap` depend on `libgap`. Only `gap` is needed.

I think it is time for me to point out that `grape` includes an old version of `nauty` and can use either `nauty` (now a standard package) or `bliss` (now an optional package). Look at `GRAPE_DREADNAUT_EXE` in `grape/lib/grape.g` (and the variable `GRAPE_NAUTY` and `GRAPE_BLISS_EXE` in the same file if you are curious).
I recommend removal of the `configure` and other makefiles in `spkg-src`. The only point of that bit in the `grape` package is to build the `dreadnaut` executable from `nauty`.

I am OK if you want to spin that as a separate ticket.


---

Comment by dimpase created at 2016-05-04 08:14:27

Replying to [comment:63 fbissey]:
> I think it is time for me to crash the party. First I notice that you made `gap_packages` and `database_gap` depend on `libgap`. Only `gap` is needed.

As soon as we start supporting building GAP kernel extensions in libgap, things 
will change, and libgap will be a real dependence. At the moment, as gap and libgap are updated in lockstep, it does not matter anyway.

> 
> I think it is time for me to point out that `grape` includes an old version of `nauty` and can use either `nauty` (now a standard package) or `bliss` (now an optional package). Look at `GRAPE_DREADNAUT_EXE` in `grape/lib/grape.g` (and the variable `GRAPE_NAUTY` and `GRAPE_BLISS_EXE` in the same file if you are curious).
> I recommend removal of the `configure` and other makefiles in `spkg-src`. The only point of that bit in the `grape` package is to build the `dreadnaut` executable from `nauty`.
> 
> I am OK if you want to spin that as a separate ticket.

I don't see why you want to override GRAPE's author on this. He told be that he keeps old nauty as he did not do a lot of tests with the new one, yet.


---

Comment by jdemeyer created at 2016-05-04 09:04:05

> I do not know all the details to be sure that an order-only dependency is OK. Probably yes, but not 100% certainly.

It has always been an order-only dependency (the default dependencies of optional packages is an order-only dependency on every standard package), so I guess it's safe.

> As soon as we start supporting building GAP kernel extensions in libgap, things 
> will change

Then the dependencies of `database_gap` and `gap_packages` should be changed in that ticket. I don't see the point of adding dependencies just in case they will be needed in the future. It reminds me of somebody adding `webassets` to `sagenb` because they planned to use it in the future... which of course never happened.


---

Comment by jdemeyer created at 2016-05-04 09:04:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-05-04 09:29:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2016-05-04 09:31:11

Replying to [comment:65 jdemeyer]:
> > I do not know all the details to be sure that an order-only dependency is OK. Probably yes, but not 100% certainly.
> 
> It has always been an order-only dependency (the default dependencies of optional packages is an order-only dependency on every standard package), so I guess it's safe.

we talk about dependency of one optional package on another.

----
New commits:


---

Comment by dimpase created at 2016-05-04 09:32:18

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2016-05-04 09:32:18

New commits:
----
New commits:


---

Comment by dimpase created at 2016-05-04 10:02:33

gap, libgap, gap_packages, and database_gap are tightly interconnected packages, usually updated all together, and I don't see much harm in declaring them to be a bit more interdependent than might be strictly necessary. Especially in absence of clear, and not open to grammatical (mis)interpretations, guidelines on dependencies in Sage.


---

Comment by jdemeyer created at 2016-05-05 07:52:37

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-05-05 07:52:37

I still think that the current branch is wrong, but let's stop the bikeshedding...


---

Comment by dimpase created at 2016-05-05 07:59:33

I think there are files there that do not need that import from future at all. I don't know whether this import makes it python3-incompatible.


---

Comment by jdemeyer created at 2016-05-05 08:01:35

Replying to [comment:71 dimpase]:
> I think there are files there that do not need that import from future at all. I don't know whether this import makes it python3-incompatible.

I suppose this comment was meant for a different ticket?


---

Comment by dimpase created at 2016-05-05 08:07:11

Replying to [comment:72 jdemeyer]:
> Replying to [comment:71 dimpase]:
> > I think there are files there that do not need that import from future at all. I don't know whether this import makes it python3-incompatible.
> 
> I suppose this comment was meant for a different ticket?

oops, indeed, sorry...


---

Comment by vbraun created at 2016-05-06 22:10:45

Resolution: fixed
