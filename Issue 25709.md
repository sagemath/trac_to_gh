# Issue 25709: py3: fixes for sage.schemes.hyperelliptic_curves

archive/issues_025709.json:
```json
{
    "body": "CC:  @bhutz @JohnCremona @roed314\n\nThe main thing need here was a `__hash__`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25946\n\n",
    "created_at": "2018-07-27T10:26:47Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "py3: fixes for sage.schemes.hyperelliptic_curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25709",
    "user": "https://github.com/embray"
}
```
CC:  @bhutz @JohnCremona @roed314

The main thing need here was a `__hash__`.

Issue created by migration from https://trac.sagemath.org/ticket/25946





---

archive/issue_comments_362473.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-27T10:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362473",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_362474.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-27T12:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362474",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_362475.json:
```json
{
    "body": "Changing keywords from \"\" to \"sagedays@icerm\".",
    "created_at": "2018-07-27T12:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362475",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "sagedays@icerm".



---

archive/issue_comments_362476.json:
```json
{
    "body": "You have too much data in your `__hash__`:\n\n```\nsage: P.<x> = QQ[]\nsage: f0 = 4*x^5 - 30*x^3 + 45*x - 22\nsage: C0 = HyperellipticCurve(f0)\nsage: P.<x> = RR[]\nsage: f1 = 4*x^5 - 30*x^3 + 45*x - 22\nsage: C1 = HyperellipticCurve(f1)\nsage: C1 == C0\nTrue\nsage: hash(C1) == hash(C0)\nFalse\n```\n\nSo you definitely have to remove `_PP` from the hash, and I would probably remove both the `__class__` as subclasses are not used in the `__eq__` comparison.",
    "created_at": "2018-07-27T12:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362476",
    "user": "https://github.com/tscrim"
}
```

You have too much data in your `__hash__`:

```
sage: P.<x> = QQ[]
sage: f0 = 4*x^5 - 30*x^3 + 45*x - 22
sage: C0 = HyperellipticCurve(f0)
sage: P.<x> = RR[]
sage: f1 = 4*x^5 - 30*x^3 + 45*x - 22
sage: C1 = HyperellipticCurve(f1)
sage: C1 == C0
True
sage: hash(C1) == hash(C0)
False
```

So you definitely have to remove `_PP` from the hash, and I would probably remove both the `__class__` as subclasses are not used in the `__eq__` comparison.



---

archive/issue_comments_362477.json:
```json
{
    "body": "I'm not 100% sure about that.  I'd need to double-check what the intention is here.  On Python 2 it was inheriting the flimsy default `__hash__` from `CategoryObject` that just hashes its `__repr__`.  So for this case I was including essentially the same data in the hash that would be needed to differentiate the reprs of two of these objects.\n\nBut maybe that's not necessary.  It just wasn't clear what the intent was (if any) due to the default hash...",
    "created_at": "2018-07-27T14:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362477",
    "user": "https://github.com/embray"
}
```

I'm not 100% sure about that.  I'd need to double-check what the intention is here.  On Python 2 it was inheriting the flimsy default `__hash__` from `CategoryObject` that just hashes its `__repr__`.  So for this case I was including essentially the same data in the hash that would be needed to differentiate the reprs of two of these objects.

But maybe that's not necessary.  It just wasn't clear what the intent was (if any) due to the default hash...



---

archive/issue_comments_362478.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2018-07-27T14:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362478",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_362479.json:
```json
{
    "body": "I completely agree the `repr` hash is bad. I think the data used for equality should be what is used for the `__hash__`, not more. From what you're saying, it seems like we are actually fixing a bug if we only hash `self._hyperelliptic_polynomials`.\n\nMy understanding behind the default hash is that every object has a `repr` and generally two objects that compare equal have equal `repr` output.\n\nI don't use/know this code, so we probably have to ask someone who understands it better to confirm if you're worried enough.",
    "created_at": "2018-07-27T14:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362479",
    "user": "https://github.com/tscrim"
}
```

I completely agree the `repr` hash is bad. I think the data used for equality should be what is used for the `__hash__`, not more. From what you're saying, it seems like we are actually fixing a bug if we only hash `self._hyperelliptic_polynomials`.

My understanding behind the default hash is that every object has a `repr` and generally two objects that compare equal have equal `repr` output.

I don't use/know this code, so we probably have to ask someone who understands it better to confirm if you're worried enough.



---

archive/issue_comments_362480.json:
```json
{
    "body": "I could certainly try a simpler repr to start with and see what happens.  If that works, then I agree with you we should just use what `__eq__` compares.",
    "created_at": "2018-07-27T14:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362480",
    "user": "https://github.com/embray"
}
```

I could certainly try a simpler repr to start with and see what happens.  If that works, then I agree with you we should just use what `__eq__` compares.



---

archive/issue_comments_362481.json:
```json
{
    "body": "Sounds good. Thanks.",
    "created_at": "2018-07-27T14:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362481",
    "user": "https://github.com/tscrim"
}
```

Sounds good. Thanks.



---

archive/issue_comments_362482.json:
```json
{
    "body": "any progress here ?",
    "created_at": "2018-08-10T07:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362482",
    "user": "https://github.com/fchapoton"
}
```

any progress here ?



---

archive/issue_comments_362483.json:
```json
{
    "body": "I mean, clearly not.  I'd prefer if someone who knew this code were to chime in, but otherwise I'll get to it if/when I feel like taking the time to understand this code better.",
    "created_at": "2018-08-10T09:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362483",
    "user": "https://github.com/embray"
}
```

I mean, clearly not.  I'd prefer if someone who knew this code were to chime in, but otherwise I'll get to it if/when I feel like taking the time to understand this code better.



---

archive/issue_comments_362484.json:
```json
{
    "body": "To be clear, I also agree with everything Travis wrote on this ticket; I'm just not in a rush to act on it because I don't feel qualified to make that judgment call w.r.t. this code.",
    "created_at": "2018-08-10T09:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362484",
    "user": "https://github.com/embray"
}
```

To be clear, I also agree with everything Travis wrote on this ticket; I'm just not in a rush to act on it because I don't feel qualified to make that judgment call w.r.t. this code.



---

archive/issue_comments_362485.json:
```json
{
    "body": "Ben, do you know about this code or know who we should cc?",
    "created_at": "2018-08-10T09:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362485",
    "user": "https://github.com/tscrim"
}
```

Ben, do you know about this code or know who we should cc?



---

archive/issue_comments_362486.json:
```json
{
    "body": "I'm not familiar with this code. John may know.",
    "created_at": "2018-08-10T13:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362486",
    "user": "https://github.com/bhutz"
}
```

I'm not familiar with this code. John may know.



---

archive/issue_comments_362487.json:
```json
{
    "body": "I don't know or use the code (except perhaps occasionally) and so I do not really understand the issue here.  I don't think that I have ever written such a has function so do not know what properties it is supposed to have.\n\nWhat exactly was the problem which this patch is intended to fix?",
    "created_at": "2018-08-10T14:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362487",
    "user": "https://github.com/JohnCremona"
}
```

I don't know or use the code (except perhaps occasionally) and so I do not really understand the issue here.  I don't think that I have ever written such a has function so do not know what properties it is supposed to have.

What exactly was the problem which this patch is intended to fix?



---

archive/issue_comments_362488.json:
```json
{
    "body": "I'm really confused about whether or not we should call these hyperelliptic curves equal in the first place. The current code returns true because the polynomials are equal which is because both variables are named `x` even though they are over different fields, are two curves over different fields really _equal_, even if one is just a base change of the other? For contrast\n\n\n```\nsage: P.<x,y>= RR[]\nsage: C0 = Curve(y - x^2  - 1)\nsage: C0\nAffine Plane Curve over Real Field with 53 bits of precision defined by -x^2 + y - 1.00000000000000\nsage: P.<x,y>= QQ[]\nsage: C1 = Curve(y - x^2  - 1)\nsage: C1\nAffine Plane Curve over Rational Field defined by -x^2 + y - 1\nsage: C0 == C1\nFalse\n```\n",
    "created_at": "2018-08-10T15:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362488",
    "user": "https://github.com/alexjbest"
}
```

I'm really confused about whether or not we should call these hyperelliptic curves equal in the first place. The current code returns true because the polynomials are equal which is because both variables are named `x` even though they are over different fields, are two curves over different fields really _equal_, even if one is just a base change of the other? For contrast


```
sage: P.<x,y>= RR[]
sage: C0 = Curve(y - x^2  - 1)
sage: C0
Affine Plane Curve over Real Field with 53 bits of precision defined by -x^2 + y - 1.00000000000000
sage: P.<x,y>= QQ[]
sage: C1 = Curve(y - x^2  - 1)
sage: C1
Affine Plane Curve over Rational Field defined by -x^2 + y - 1
sage: C0 == C1
False
```




---

archive/issue_comments_362489.json:
```json
{
    "body": "Replying to [comment:14 alexjbest]:\n> I'm really confused about whether or not we should call these hyperelliptic curves equal in the first place. The current code returns true because the polynomials are equal which is because both variables are named `x` even though they are over different fields, are two curves over different fields really _equal_, even if one is just a base change of the other?\n\nI had the same doubt before.  There's some inconsistency throughout Sage about when some objects defined over different fields are considered equal under `==`.  In some cases it's quite deliberate, in other cases it's not clear until and unless the original author chimes in.  If the author isn't even sure I would lean against calling them `==`, much less having the same hash.",
    "created_at": "2018-08-10T15:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362489",
    "user": "https://github.com/embray"
}
```

Replying to [comment:14 alexjbest]:
> I'm really confused about whether or not we should call these hyperelliptic curves equal in the first place. The current code returns true because the polynomials are equal which is because both variables are named `x` even though they are over different fields, are two curves over different fields really _equal_, even if one is just a base change of the other?

I had the same doubt before.  There's some inconsistency throughout Sage about when some objects defined over different fields are considered equal under `==`.  In some cases it's quite deliberate, in other cases it's not clear until and unless the original author chimes in.  If the author isn't even sure I would lean against calling them `==`, much less having the same hash.



---

archive/issue_comments_362490.json:
```json
{
    "body": "I agree with Alex: to be equal the fields of definition should equal and the defining polynomials identical.  This is the case with elliptic curves:\n\n```\nsage: E = EllipticCurve([0,1])\nsage: E\nElliptic Curve defined by y^2 = x^3 + 1 over Rational Field\nsage: K.<i> = NumberField(x^2+1)\nsage: EK = E.change_ring(K)\nsage: EK\nElliptic Curve defined by y^2 = x^3 + 1 over Number Field in i with defining polynomial x^2 + 1\nsage: E == EK\nFalse\nsage: hash(E)\n8741953973726\nsage: hash(EK)\n8741951786400\n```\n\nI don't know what this hash function actually does: it calls hash_by_id, whatever that is.  I also don't know how to find out what function is being called by E==EK either!",
    "created_at": "2018-08-10T16:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362490",
    "user": "https://github.com/JohnCremona"
}
```

I agree with Alex: to be equal the fields of definition should equal and the defining polynomials identical.  This is the case with elliptic curves:

```
sage: E = EllipticCurve([0,1])
sage: E
Elliptic Curve defined by y^2 = x^3 + 1 over Rational Field
sage: K.<i> = NumberField(x^2+1)
sage: EK = E.change_ring(K)
sage: EK
Elliptic Curve defined by y^2 = x^3 + 1 over Number Field in i with defining polynomial x^2 + 1
sage: E == EK
False
sage: hash(E)
8741953973726
sage: hash(EK)
8741951786400
```

I don't know what this hash function actually does: it calls hash_by_id, whatever that is.  I also don't know how to find out what function is being called by E==EK either!



---

archive/issue_comments_362491.json:
```json
{
    "body": "`EllipticCurve` is a `UniqueFactory`, so the input (i.e., in part, the field) uniquely identifies the curve. So the `hash` and `==` is obtained by using `id` as there is a unique such object in memory at a given time. Changing the hyperelliptic to suppose the `UniqueRepresentation`-type behavior would be a very invasive and complicated surgery I think.\n\nSo the short-term fix IMO would be deciding an appropriate notion of `__eq__`, and then changing the `__hash__` to match. From what John is saying, we should also introduce a check that the defining fields are equal.\n\nAlso, from `git blame`, \"Nick Alexander\" and \"tornaria\" comes up a lot and David Kohel is listed in the copyright.",
    "created_at": "2018-08-10T23:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362491",
    "user": "https://github.com/tscrim"
}
```

`EllipticCurve` is a `UniqueFactory`, so the input (i.e., in part, the field) uniquely identifies the curve. So the `hash` and `==` is obtained by using `id` as there is a unique such object in memory at a given time. Changing the hyperelliptic to suppose the `UniqueRepresentation`-type behavior would be a very invasive and complicated surgery I think.

So the short-term fix IMO would be deciding an appropriate notion of `__eq__`, and then changing the `__hash__` to match. From what John is saying, we should also introduce a check that the defining fields are equal.

Also, from `git blame`, "Nick Alexander" and "tornaria" comes up a lot and David Kohel is listed in the copyright.



---

archive/issue_comments_362492.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-08-14T08:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362492",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_362493.json:
```json
{
    "body": "I propose a solution : simply remove `__eq__`, `__ne__` and `__hash__` here.\n\nThen they are all provided by the general setting of projective subschemes, which seems to be a good idea. This will compare ambient spaces and defining ideals, which amount to compare base field and polynomials.\n----\nNew commits:",
    "created_at": "2018-08-14T08:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362493",
    "user": "https://github.com/fchapoton"
}
```

I propose a solution : simply remove `__eq__`, `__ne__` and `__hash__` here.

Then they are all provided by the general setting of projective subschemes, which seems to be a good idea. This will compare ambient spaces and defining ideals, which amount to compare base field and polynomials.
----
New commits:



---

archive/issue_comments_362494.json:
```json
{
    "body": "That sounds very sensible to me -- I do not know why the person who implemented these special functions thought it was necessary to override those of the parent class.\n\nAs far as I am concerned this is good to merge assuming that tests all pass.",
    "created_at": "2018-08-14T08:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362494",
    "user": "https://github.com/JohnCremona"
}
```

That sounds very sensible to me -- I do not know why the person who implemented these special functions thought it was necessary to override those of the parent class.

As far as I am concerned this is good to merge assuming that tests all pass.



---

archive/issue_comments_362495.json:
```json
{
    "body": "failing doctests in hyperelliptic_padic_field.py (sigh)",
    "created_at": "2018-08-14T11:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362495",
    "user": "https://github.com/fchapoton"
}
```

failing doctests in hyperelliptic_padic_field.py (sigh)



---

archive/issue_comments_362496.json:
```json
{
    "body": "This seems like a reasonable approach, but it seems that you exposed a poor assumption that was made somewhere else.  I don't know what a `sage.rings.padics.padic_ZZ_pX_CR_element.pAdicZZpXCRElement` is, or why it isn't hashable.  Perhaps it should be?\n\nIf it definitely shouldn't be hashable (e.g. it is not immutable) then maybe the problem is in `MPolynomialIdeal.__richcmp__`'s assumption that the generators of an ideal are definitely hashable (and if not, it should do something else to compare gens).",
    "created_at": "2018-08-14T12:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362496",
    "user": "https://github.com/embray"
}
```

This seems like a reasonable approach, but it seems that you exposed a poor assumption that was made somewhere else.  I don't know what a `sage.rings.padics.padic_ZZ_pX_CR_element.pAdicZZpXCRElement` is, or why it isn't hashable.  Perhaps it should be?

If it definitely shouldn't be hashable (e.g. it is not immutable) then maybe the problem is in `MPolynomialIdeal.__richcmp__`'s assumption that the generators of an ideal are definitely hashable (and if not, it should do something else to compare gens).



---

archive/issue_comments_362497.json:
```json
{
    "body": "There is a `_cache_key` method on these objects inside `src/sage/rings/padics/padic_ZZ_pX_CR_element.pyx`\n\nBut its doc claims that there is no reasonable hash..",
    "created_at": "2018-08-14T12:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362497",
    "user": "https://github.com/fchapoton"
}
```

There is a `_cache_key` method on these objects inside `src/sage/rings/padics/padic_ZZ_pX_CR_element.pyx`

But its doc claims that there is no reasonable hash..



---

archive/issue_comments_362498.json:
```json
{
    "body": "Adding David Roe in CC since he may be able to throw light on the p-adic ring issue.  Note that p-adic rings (as with the reals) are not exact, so comparison between elements is not so easy.",
    "created_at": "2018-08-14T12:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362498",
    "user": "https://github.com/JohnCremona"
}
```

Adding David Roe in CC since he may be able to throw light on the p-adic ring issue.  Note that p-adic rings (as with the reals) are not exact, so comparison between elements is not so easy.



---

archive/issue_comments_362499.json:
```json
{
    "body": "Incidentally, `MPolynomialIdeal.__richcmp__` was last touched by #23920.  The idea to use sets to compare gens was from Travis: #23920#comment:9\n\nPerhaps there should be a try/except around this and attempt direct comparison if comparing by sets raises a `TypeError`.  I'm not sure what the impact is of computing a Groebner basis, or if it can be avoided in some other way as well.",
    "created_at": "2018-08-14T12:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362499",
    "user": "https://github.com/embray"
}
```

Incidentally, `MPolynomialIdeal.__richcmp__` was last touched by #23920.  The idea to use sets to compare gens was from Travis: #23920#comment:9

Perhaps there should be a try/except around this and attempt direct comparison if comparing by sets raises a `TypeError`.  I'm not sure what the impact is of computing a Groebner basis, or if it can be avoided in some other way as well.



---

archive/issue_comments_362500.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-14T12:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362500",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362501.json:
```json
{
    "body": "adding hash from the existing _cache_key seems to fix the failing doctests.. But is this a correct thing to do ?",
    "created_at": "2018-08-14T12:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362501",
    "user": "https://github.com/fchapoton"
}
```

adding hash from the existing _cache_key seems to fix the failing doctests.. But is this a correct thing to do ?



---

archive/issue_comments_362502.json:
```json
{
    "body": "Replying to [comment:27 chapoton]:\n> adding hash from the existing _cache_key seems to fix the failing doctests.. But is this a correct thing to do ?\n\nNo, I don't believe so, and the I think the explanation in the `_cache_key` docs is fairly clear why.  Instead: #25946#comment:25",
    "created_at": "2018-08-14T12:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362502",
    "user": "https://github.com/embray"
}
```

Replying to [comment:27 chapoton]:
> adding hash from the existing _cache_key seems to fix the failing doctests.. But is this a correct thing to do ?

No, I don't believe so, and the I think the explanation in the `_cache_key` docs is fairly clear why.  Instead: #25946#comment:25



---

archive/issue_comments_362503.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-14T13:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362503",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_362504.json:
```json
{
    "body": "ok. So here is my next proposal : when comparing ideals generated by a single polynomial, just compare this generator (no need to wrap by set).",
    "created_at": "2018-08-14T13:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362504",
    "user": "https://github.com/fchapoton"
}
```

ok. So here is my next proposal : when comparing ideals generated by a single polynomial, just compare this generator (no need to wrap by set).



---

archive/issue_comments_362505.json:
```json
{
    "body": "True.  Is that case common enough to merit a special case?  Are there cases of ideals of rings over these types of p-adics whose ideal would be generated by more than one polynomials (and hence would still crash on the existing code)?\n\nWhat I'm saying is just, why not:\n\n\n```python\ntry:\n    same_gens = set(self.gens()) == set(other.gens())\nexcept TypeError:\n    same_gens = False\n\nif same_gens:\n    # Do whatever we do currently\nelse:\n    # Do whatever is necessary to compare the gens (construct a GB, etc).\n```\n",
    "created_at": "2018-08-14T13:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362505",
    "user": "https://github.com/embray"
}
```

True.  Is that case common enough to merit a special case?  Are there cases of ideals of rings over these types of p-adics whose ideal would be generated by more than one polynomials (and hence would still crash on the existing code)?

What I'm saying is just, why not:


```python
try:
    same_gens = set(self.gens()) == set(other.gens())
except TypeError:
    same_gens = False

if same_gens:
    # Do whatever we do currently
else:
    # Do whatever is necessary to compare the gens (construct a GB, etc).
```




---

archive/issue_comments_362506.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-14T14:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362506",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362507.json:
```json
{
    "body": "Replying to [comment:31 embray]:\n> True.  Is that case common enough to merit a special case?  Are there cases of ideals of rings over these types of p-adics whose ideal would be generated by more than one polynomials (and hence would still crash on the existing code)?\n\nCertainly:  in ZZ_p[X] the ideal generated by p and X.  But the number of gens will always be small, so why not sort the gens, however many there are?\n\nThis is an example of a common problem in Sage and other systems.  If I define two ideals (or other structures) in different ways and ask whether they are equal then the test may be very expensive.  But here we just test whether they have been presented in the same way (or with trivial changes such as changing the order of the generators).\n\n\n> \n> What I'm saying is just, why not:\n> \n> {{{\n> #!python\n> try:\n>     same_gens = set(self.gens()) == set(other.gens())\n> except TypeError:\n>     same_gens = False\n> \n> if same_gens:\n>     # Do whatever we do currently\n> else:\n>     # Do whatever is necessary to compare the gens (construct a GB, etc).\n> }}}\n----\nNew commits:",
    "created_at": "2018-08-14T14:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362507",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:31 embray]:
> True.  Is that case common enough to merit a special case?  Are there cases of ideals of rings over these types of p-adics whose ideal would be generated by more than one polynomials (and hence would still crash on the existing code)?

Certainly:  in ZZ_p[X] the ideal generated by p and X.  But the number of gens will always be small, so why not sort the gens, however many there are?

This is an example of a common problem in Sage and other systems.  If I define two ideals (or other structures) in different ways and ask whether they are equal then the test may be very expensive.  But here we just test whether they have been presented in the same way (or with trivial changes such as changing the order of the generators).


> 
> What I'm saying is just, why not:
> 
> {{{
> #!python
> try:
>     same_gens = set(self.gens()) == set(other.gens())
> except TypeError:
>     same_gens = False
> 
> if same_gens:
>     # Do whatever we do currently
> else:
>     # Do whatever is necessary to compare the gens (construct a GB, etc).
> }}}
----
New commits:



---

archive/issue_comments_362508.json:
```json
{
    "body": "Here is another tentative : first compare without set() then compare with set()",
    "created_at": "2018-08-14T14:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362508",
    "user": "https://github.com/fchapoton"
}
```

Here is another tentative : first compare without set() then compare with set()



---

archive/issue_comments_362509.json:
```json
{
    "body": "Replying to [comment:34 chapoton]:\n> Here is another tentative : first compare without set() then compare with set()\n\nThat could still crash.  I don't know the math well enough to construct an interestingexample case, but say you have two copies of the same ideal, but their generators just happen to be in a different order, as in:\n\n\n```\nsage: R.<x,y> = QQ[]\nsage: R.ideal(x, y).gens()\n[x, y]\nsage: R.ideal(y, x).gens()\n```\n\n\nThis is the sort of case, as John wrote, that the `set()` call is intended for in the first place.  But if the elements `x` and `y` are not hashable, then the first test will still fail, and then the second test will be evaluated and will crash.\n\nIMO this comparison of gens() is just a special case shortcut which is fine as-is, but it should account for the possibility that some elements just aren't hashable, that's all.",
    "created_at": "2018-08-14T14:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362509",
    "user": "https://github.com/embray"
}
```

Replying to [comment:34 chapoton]:
> Here is another tentative : first compare without set() then compare with set()

That could still crash.  I don't know the math well enough to construct an interestingexample case, but say you have two copies of the same ideal, but their generators just happen to be in a different order, as in:


```
sage: R.<x,y> = QQ[]
sage: R.ideal(x, y).gens()
[x, y]
sage: R.ideal(y, x).gens()
```


This is the sort of case, as John wrote, that the `set()` call is intended for in the first place.  But if the elements `x` and `y` are not hashable, then the first test will still fail, and then the second test will be evaluated and will crash.

IMO this comparison of gens() is just a special case shortcut which is fine as-is, but it should account for the possibility that some elements just aren't hashable, that's all.



---

archive/issue_comments_362510.json:
```json
{
    "body": "Does hashable imply not sortable?  As I said, the lists of gens will be short normally, so something like testing sorted(s_gens)==sorted(o_gens) might work when the set() constructor does not?  There will still be silly trivial cases such as first giving {x,y} as gens then {x,x,y} and for sure someone will then complain.  But even as it is, we are not returning equality of the ideals (x,y) and (x+y,y).  We are never going to catch all trivial cases (and different users' idea of a trivial case will differ) so just comparing the list of gens with no processing at all is safest and most easily explained.",
    "created_at": "2018-08-14T14:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362510",
    "user": "https://github.com/JohnCremona"
}
```

Does hashable imply not sortable?  As I said, the lists of gens will be short normally, so something like testing sorted(s_gens)==sorted(o_gens) might work when the set() constructor does not?  There will still be silly trivial cases such as first giving {x,y} as gens then {x,x,y} and for sure someone will then complain.  But even as it is, we are not returning equality of the ideals (x,y) and (x+y,y).  We are never going to catch all trivial cases (and different users' idea of a trivial case will differ) so just comparing the list of gens with no processing at all is safest and most easily explained.



---

archive/issue_comments_362511.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-14T14:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362511",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362512.json:
```json
{
    "body": "ok, I have wrapped with \"try / except\".",
    "created_at": "2018-08-14T14:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362512",
    "user": "https://github.com/fchapoton"
}
```

ok, I have wrapped with "try / except".



---

archive/issue_comments_362513.json:
```json
{
    "body": "Replying to [comment:36 cremona]:\n> Does hashable imply not sortable?  As I said, the lists of gens will be short normally, so something like testing sorted(s_gens)==sorted(o_gens) might work when the set() constructor does not?  There will still be silly trivial cases such as first giving {x,y} as gens then {x,x,y} and for sure someone will then complain.  But even as it is, we are not returning equality of the ideals (x,y) and (x+y,y).  We are never going to catch all trivial cases (and different users' idea of a trivial case will differ) so just comparing the list of gens with no processing at all is safest and most easily explained.\n\nI don't think sorting really helps here, because as I found out over in #25948, some elements can be \"sorted\" but the ordering is meaningless and unpredictable.",
    "created_at": "2018-08-14T14:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362513",
    "user": "https://github.com/embray"
}
```

Replying to [comment:36 cremona]:
> Does hashable imply not sortable?  As I said, the lists of gens will be short normally, so something like testing sorted(s_gens)==sorted(o_gens) might work when the set() constructor does not?  There will still be silly trivial cases such as first giving {x,y} as gens then {x,x,y} and for sure someone will then complain.  But even as it is, we are not returning equality of the ideals (x,y) and (x+y,y).  We are never going to catch all trivial cases (and different users' idea of a trivial case will differ) so just comparing the list of gens with no processing at all is safest and most easily explained.

I don't think sorting really helps here, because as I found out over in #25948, some elements can be "sorted" but the ordering is meaningless and unpredictable.



---

archive/issue_comments_362514.json:
```json
{
    "body": "Replying to [comment:37 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[d47fbb3](https://git.sagemath.org/sage.git/commit/?id=d47fbb3f350c6e5ce4d2fdc809a3849699bebdd0)||`wrap with try`||\n\nYou could still get rid of `(s_gens == o_gens)`.  I don't think it's that useful.",
    "created_at": "2018-08-14T14:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362514",
    "user": "https://github.com/embray"
}
```

Replying to [comment:37 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[d47fbb3](https://git.sagemath.org/sage.git/commit/?id=d47fbb3f350c6e5ce4d2fdc809a3849699bebdd0)||`wrap with try`||

You could still get rid of `(s_gens == o_gens)`.  I don't think it's that useful.



---

archive/issue_comments_362515.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> Replying to [comment:37 git]:\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n> > ||[d47fbb3](https://git.sagemath.org/sage.git/commit/?id=d47fbb3f350c6e5ce4d2fdc809a3849699bebdd0)||`wrap with try`||\n> \n> You could still get rid of `(s_gens == o_gens)`.  I don't think it's that useful.\n\nYes it is. It will handle the precise case that we are dealing with in this ticket, hyperelliptic curves over p-adics.",
    "created_at": "2018-08-14T14:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362515",
    "user": "https://github.com/fchapoton"
}
```

Replying to [comment:40 embray]:
> Replying to [comment:37 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[d47fbb3](https://git.sagemath.org/sage.git/commit/?id=d47fbb3f350c6e5ce4d2fdc809a3849699bebdd0)||`wrap with try`||
> 
> You could still get rid of `(s_gens == o_gens)`.  I don't think it's that useful.

Yes it is. It will handle the precise case that we are dealing with in this ticket, hyperelliptic curves over p-adics.



---

archive/issue_comments_362516.json:
```json
{
    "body": "Ok, but I think as written you don't need the `same_gens` variable.  I only wrote it that way in my pseudo-code because I wasn't directly looking at the real code at the time, and didn't consider using a try/except/else.  I don't think we need to worry about `rich_to_bool` raising a `TypeError`.",
    "created_at": "2018-08-14T15:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362516",
    "user": "https://github.com/embray"
}
```

Ok, but I think as written you don't need the `same_gens` variable.  I only wrote it that way in my pseudo-code because I wasn't directly looking at the real code at the time, and didn't consider using a try/except/else.  I don't think we need to worry about `rich_to_bool` raising a `TypeError`.



---

archive/issue_comments_362517.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-14T15:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362518.json:
```json
{
    "body": "like that ?\n----\nNew commits:",
    "created_at": "2018-08-14T15:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362518",
    "user": "https://github.com/fchapoton"
}
```

like that ?
----
New commits:



---

archive/issue_comments_362519.json:
```json
{
    "body": "Yeah, though it would be nice to squash all these commits before we're done here.",
    "created_at": "2018-08-14T15:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362519",
    "user": "https://github.com/embray"
}
```

Yeah, though it would be nice to squash all these commits before we're done here.



---

archive/issue_comments_362520.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-14T15:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362520",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_362521.json:
```json
{
    "body": "done",
    "created_at": "2018-08-14T15:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362521",
    "user": "https://github.com/fchapoton"
}
```

done



---

archive/issue_comments_362522.json:
```json
{
    "body": "Thanks! Well, I'm happy, so you can set positive review if you want, or wait and see if anyone smarter than me wants to weigh on, though it seems like this approach meshes with what the other experts have said so far.",
    "created_at": "2018-08-14T15:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362522",
    "user": "https://github.com/embray"
}
```

Thanks! Well, I'm happy, so you can set positive review if you want, or wait and see if anyone smarter than me wants to weigh on, though it seems like this approach meshes with what the other experts have said so far.



---

archive/issue_comments_362523.json:
```json
{
    "body": "I am happy (and making no claims to be cleverer than anyone else ;)) \n\nI would never have thought of using rich_to_bool() though.  Not clever enough!",
    "created_at": "2018-08-14T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362523",
    "user": "https://github.com/JohnCremona"
}
```

I am happy (and making no claims to be cleverer than anyone else ;)) 

I would never have thought of using rich_to_bool() though.  Not clever enough!



---

archive/issue_comments_362524.json:
```json
{
    "body": "Seems good to me too!",
    "created_at": "2018-08-14T16:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362524",
    "user": "https://github.com/roed314"
}
```

Seems good to me too!



---

archive/issue_comments_362525.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-14T16:07:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362525",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_023922.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-17T21:14:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25709#event-23922"
}
```



---

archive/issue_comments_362526.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-17T21:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25709#issuecomment-362526",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
