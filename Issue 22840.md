# Issue 22840: Fix complex handling of libs/pynac/py_float()

Issue created by migration from https://trac.sagemath.org/ticket/23077

Original creator: rws

Original creation time: 2017-05-25 15:06:50

The goal is to always return some float, either real or complex but:

```
sage: from sage.libs.pynac.pynac import py_float_for_doctests as py_float
sage: py_float(I, {'parent':RealField(10)})
...
TypeError: unable to convert '1.0*I' to a real number
```

The code shows it's only done if there is no parent given:

```
    if kwds is not NULL:
        return (<object>kwds)['parent'](n)
    else:
        try:
            return RR(n)
        except TypeError:
            return CC(n)
```

The ticket should make it possible to fall back on the associated complex field of any parent.


---

Comment by rws created at 2017-05-25 15:24:26

Still one doctest to fix. #18386 depends on this.
----
New commits:


---

Comment by rws created at 2017-05-26 06:16:23

BTW, the numeric doctest changes have better accuracy, so consider it a bug fix for inaccurate results as well.


---

Comment by git created at 2017-05-26 06:25:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-05-26 06:25:53

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-06-03 14:39:28

Is it ever (natually) possible for the parent to not have a `complex_field` method?


---

Comment by rws created at 2017-06-04 06:54:51

Replying to [comment:6 tscrim]:
> Is it ever (natually) possible for the parent to not have a `complex_field` method?

Try `RLF`.


---

Comment by tscrim created at 2017-06-04 07:06:32

So could we get into a situation where this raises an `AttributeError`:

```diff
diff --git a/src/sage/functions/orthogonal_polys.py b/src/sage/functions/orthogonal_polys.py
index 931b247..51da378 100644
--- a/src/sage/functions/orthogonal_polys.py
+++ b/src/sage/functions/orthogonal_polys.py
@@ -1942,7 +1942,10 @@ class Func_jacobi_P(OrthogonalFunction):
         prec = the_parent.precision()
         BF = CBF(prec+5)
         ret = BF(x).jacobi_P(BF(n), BF(a), BF(b))
-        return the_parent(ret)
+        try:
+            return the_parent(ret)
+        except (TypeError, ValueError):
+            return the_parent.complex_field()(ret)
 
 jacobi_P = Func_jacobi_P()
 
```

Should we catch the error?


---

Comment by git created at 2017-06-05 05:47:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-06-05 05:49:46

I agree this should be consistent and did so. Should there be a ticket for `RLF.complex_field()` (I'm no algebraist)?


---

Comment by tscrim created at 2017-06-05 05:58:19

I'm not sure. However, it is good that we are consistent now. Positive review.


---

Comment by tscrim created at 2017-06-05 05:58:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-05 22:50:17


```
[dochtml] [plotting ] File "sage/libs/pynac/pynac.pyx", line 1334, in sage.libs.pynac.pynac.py_float (build/cythonized/sage/libs/pynac/pynac.cpp:15044)
[dochtml] [plotting ] return (<object>kwds)['parent'].complex_field()(n)
[dochtml] [plotting ] AttributeError: type object 'float' has no attribute 'complex_field'
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1642, in main
[dochtml]     builder()
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 316, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 510, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 252, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/mnt/disk/home/release/Sage/local/lib/python2.7/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] OSError: [plotting ] /mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/plot/plot.py:docstring of sage.plot.plot.plot:459: WARNING: Exception occurred in plotting plot-31
```



---

Comment by vbraun created at 2017-06-05 22:50:17

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-06-06 06:31:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-06-06 06:32:33

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-06-06 06:32:33

Also `float` does not have a `complex_field()` member. Code changes make a review necessary. Could you please?


---

Comment by rws created at 2017-06-06 06:35:43

Ah no, further repercussions, sorry.


---

Comment by rws created at 2017-06-06 06:35:43

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-06-06 06:43:16

Reason is interval fields do not have a `_float_()` member---they have `n()` and I consider this a bug.


---

Comment by rws created at 2017-06-06 06:47:38

Oh, ball fields have it neither. Their elements will all fail conversion to float/complex. Seriously.


---

Comment by git created at 2017-06-07 06:22:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-06-07 06:33:31

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-07 13:08:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-13 22:11:05

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-06-13 22:11:05


```
sage -t --long --warn-long 74.0 src/sage/rings/polynomial/polynomial_rational_flint.pyx
**********************************************************************
File "src/sage/rings/polynomial/polynomial_rational_flint.pyx", line 612, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse
Failed example:
    f.reverse(I)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: can not convert complex algebraic number to real interval
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse[17]>", line 1, in <module>
        f.reverse(I)
      File "sage/rings/polynomial/polynomial_rational_flint.pyx", line 632, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse (build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:8018)
        len = <unsigned long> (degree + 1)
      File "sage/symbolic/expression.pyx", line 1104, in sage.symbolic.expression.Expression.__int__ (build/cythonized/sage/symbolic/expression.cpp:9138)
        raise ValueError("cannot convert %s to int" % self)
    ValueError: cannot convert I + 1 to int
**********************************************************************
1 item had failures:
   1 of  20 in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse
    [393 tests, 1 failure, 10.22 s]
----------------------------------------------------------------------
sage -t --long --warn-long 74.0 src/sage/rings/polynomial/polynomial_rational_flint.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 10.3 seconds
    cpu time: 6.3 seconds
    cumulative wall time: 10.2 seconds
```



---

Comment by git created at 2017-06-14 05:41:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-06-14 05:44:32

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-14 12:24:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-15 16:45:30

Resolution: fixed
