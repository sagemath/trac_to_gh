# Issue 29052: Remove support for old-style SPKGs, deprecated in Sage 6.9

archive/issues_029052.json:
```json
{
    "body": "CC:  @dimpase @embray @vbraun @jhpalmieri @orlitzky\n\nOld-style SPKGs were deprecated in #19158, merged in Sage 6.9.\n\nThere is no evidence that any non-broken old-style SPKGs exist.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29289\n\n",
    "created_at": "2020-03-06T22:06:43Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Remove support for old-style SPKGs, deprecated in Sage 6.9",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29052",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @embray @vbraun @jhpalmieri @orlitzky

Old-style SPKGs were deprecated in #19158, merged in Sage 6.9.

There is no evidence that any non-broken old-style SPKGs exist.

Issue created by migration from https://trac.sagemath.org/ticket/29289





---

archive/issue_comments_410736.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-08T07:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410736",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410737.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-06-08T07:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410737",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_410738.json:
```json
{
    "body": "there is also an old style `polytopes_db_4d`, a huge download, 8Gb, see e.g. https://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/palp_database.html\n\nlet me see if I can have a go converting it.",
    "created_at": "2020-06-09T08:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410738",
    "user": "https://github.com/dimpase"
}
```

there is also an old style `polytopes_db_4d`, a huge download, 8Gb, see e.g. https://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/palp_database.html

let me see if I can have a go converting it.



---

archive/issue_comments_410739.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-06-09T08:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410739",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_410740.json:
```json
{
    "body": "see #26029 for the new-style `polytopes_db_4d`\n\nI'll do the same with `cunningham_tables`",
    "created_at": "2020-06-09T21:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410740",
    "user": "https://github.com/dimpase"
}
```

see #26029 for the new-style `polytopes_db_4d`

I'll do the same with `cunningham_tables`



---

archive/issue_comments_410741.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-09T23:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410741",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_410742.json:
```json
{
    "body": "#29834 - converted cunningham_tables",
    "created_at": "2020-06-09T23:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410742",
    "user": "https://github.com/dimpase"
}
```

#29834 - converted cunningham_tables



---

archive/issue_comments_410743.json:
```json
{
    "body": "lgtm - modulo the deps (which are not merged in the branch).",
    "created_at": "2020-06-10T08:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410743",
    "user": "https://github.com/dimpase"
}
```

lgtm - modulo the deps (which are not merged in the branch).



---

archive/issue_comments_410744.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-10T08:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410744",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410745.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-06-10T15:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410745",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_410746.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-06-16T22:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_410747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2020-06-16T22:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410747",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_410748.json:
```json
{
    "body": "Rebased on 9.2.beta1",
    "created_at": "2020-06-16T22:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410748",
    "user": "https://github.com/mkoeppe"
}
```

Rebased on 9.2.beta1



---

archive/issue_comments_410749.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-16T22:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410749",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410750.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-06-18T21:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410750",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_410751.json:
```json
{
    "body": "Fails doctests. From tests/cmdline.py:\n\n```\n        sage: out, err, ret = test_executable([\"sage\", \"-p\", \"--info\", \"--info\", \"sqlite\"])  # optional - build\n        sage: print(out)  # optional - build\n        Found local metadata for sqlite-...\n```\n",
    "created_at": "2020-06-18T21:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410751",
    "user": "https://github.com/jhpalmieri"
}
```

Fails doctests. From tests/cmdline.py:

```
        sage: out, err, ret = test_executable(["sage", "-p", "--info", "--info", "sqlite"])  # optional - build
        sage: print(out)  # optional - build
        Found local metadata for sqlite-...
```




---

archive/issue_comments_410752.json:
```json
{
    "body": "Thanks for catching this!",
    "created_at": "2020-06-18T21:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410752",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for catching this!



---

archive/issue_comments_410753.json:
```json
{
    "body": "Jeroen was a fan of `sage -p`, but I'm not sure why. Does it serve any purpose now? It was used (as in `tests/cmdline.py`) for non-old-style packages. Is it indeed redundant?",
    "created_at": "2020-06-18T21:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410753",
    "user": "https://github.com/jhpalmieri"
}
```

Jeroen was a fan of `sage -p`, but I'm not sure why. Does it serve any purpose now? It was used (as in `tests/cmdline.py`) for non-old-style packages. Is it indeed redundant?



---

archive/issue_comments_410754.json:
```json
{
    "body": "I don't think they serve any purpose at this point, other than to confuse users. All known packages seem to have been converted (Dima did two remaining ones in #26029, #29834), and it's easy to convert a package should another one be spotted in the wild.\n\nI would say that the whole model of encouraging users to distribute their code in a packaging format specific to Sage (in fact, specific to Sage-the-distribution!) is outdated and far from best practices.  Users have found better ways to package code - see https://wiki.sagemath.org/SageMathExternalPackages .",
    "created_at": "2020-06-18T22:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410754",
    "user": "https://github.com/mkoeppe"
}
```

I don't think they serve any purpose at this point, other than to confuse users. All known packages seem to have been converted (Dima did two remaining ones in #26029, #29834), and it's easy to convert a package should another one be spotted in the wild.

I would say that the whole model of encouraging users to distribute their code in a packaging format specific to Sage (in fact, specific to Sage-the-distribution!) is outdated and far from best practices.  Users have found better ways to package code - see https://wiki.sagemath.org/SageMathExternalPackages .



---

archive/issue_comments_410755.json:
```json
{
    "body": "Oh, rereading your comment, are you referring to the use of `sage -p` to install new-style packages?  I was actually not aware that that works, but it seems to do exactly the same as `sage -i`.",
    "created_at": "2020-06-18T22:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410755",
    "user": "https://github.com/mkoeppe"
}
```

Oh, rereading your comment, are you referring to the use of `sage -p` to install new-style packages?  I was actually not aware that that works, but it seems to do exactly the same as `sage -i`.



---

archive/issue_comments_410756.json:
```json
{
    "body": "OK, I see `-p` was documented as `-p [opts] [packages]-- install the given Sage packages, without dependency checking ` ...",
    "created_at": "2020-06-18T22:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410756",
    "user": "https://github.com/mkoeppe"
}
```

OK, I see `-p` was documented as `-p [opts] [packages]-- install the given Sage packages, without dependency checking ` ...



---

archive/issue_comments_410757.json:
```json
{
    "body": "I'll restore this option. Let's figure out if it should be deprecated.",
    "created_at": "2020-06-18T22:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410757",
    "user": "https://github.com/mkoeppe"
}
```

I'll restore this option. Let's figure out if it should be deprecated.



---

archive/issue_comments_410758.json:
```json
{
    "body": "Sounds good. I'm completely fine with getting rid of the old-style packaging machinery, but I also think it's a good idea to keep `sage -p` for now, for its other use.",
    "created_at": "2020-06-18T22:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410758",
    "user": "https://github.com/jhpalmieri"
}
```

Sounds good. I'm completely fine with getting rid of the old-style packaging machinery, but I also think it's a good idea to keep `sage -p` for now, for its other use.



---

archive/issue_comments_410759.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-18T22:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_410760.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-18T22:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410760",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_410761.json:
```json
{
    "body": "It looks like more can be removed. I haven't tested these changes thoroughly; what do you think?\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex c8d800fcae..620925a319 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -255,10 +255,8 @@ if echo \"$PKG_SRC\" | grep / >/dev/null; then\n     echo >&2 \"Error: Installing old-style SPKGs is no longer supported\"\n     exit 1\n fi\n-# PKG_NAME is the last path component without .spkg\n-# This already reduces case 2b to case 2a.\n-PKG_NAME=`basename \"$PKG_SRC\" | sed 's/\\.spkg$//'`\n-PKG_BASE=`echo \"$PKG_NAME\" | sed 's/-.*//'`\n+PKG_NAME=\"$PKG_SRC\"\n+PKG_BASE=`echo \"$PKG_NAME\" | sed 's/-.*//'` # strip version number\n \n # USE_LOCAL_SCRIPTS is a flag that if non-empty will cause\n # this script to try to install the package using local metadata\n@@ -266,39 +264,31 @@ PKG_BASE=`echo \"$PKG_NAME\" | sed 's/-.*//'`\n # the value of this flag is set in the next codeblock\n USE_LOCAL_SCRIPTS=\n \n-if [ -f \"$PKG_SRC\" ]; then\n-    # PKG_SRC is a file.  If it is given by a relative path, prepend `pwd`\n-    # (reduce case 1b to 1a)\n-    if ! echo \"$PKG_SRC\" | grep '^/' >/dev/null; then\n-        PKG_SRC=\"`pwd`/$PKG_SRC\"\n-    fi\n-elif [ -z \"$PKG_HAS_PATH\" ]; then\n-    # If PKG_SRC is not an existing file and doesn't contain a slash,\n-    # we are in case 2a or 3.  If version in 2a matches the version in\n-    # build/pkgs or we are in case 3 use the local scripts, otherwise\n-    # we try to find a package in upstream\n-    PKG_VER=\"${PKG_NAME#${PKG_BASE}}\"\n-    PKG_VER=\"${PKG_VER#-}\"\n-    PKG_SCRIPTS=\"$SAGE_ROOT/build/pkgs/$PKG_BASE\"\n-    LOCAL_PKG_VER=`cat $PKG_SCRIPTS/package-version.txt 2>/dev/null`\n-    if [ -n \"$LOCAL_PKG_VER\" ] && [ -z \"$PKG_VER\" -o \"$PKG_VER\" = \"$LOCAL_PKG_VER\" ]; then\n-        PKG_VER=\"$LOCAL_PKG_VER\"\n-        if [ -z \"$PKG_VER\" ]; then\n-            PKG_NAME=\"${PKG_BASE}\"\n-        else\n-            PKG_NAME=\"${PKG_BASE}-${PKG_VER}\"\n-        fi\n-        USE_LOCAL_SCRIPTS=yes\n-        PKG_BASE_VER=`echo $PKG_VER | sed 's/\\.p[0-9][0-9]*$//'`\n-        PKG_NAME_UPSTREAM=`lookup_param tarball \"$PKG_SCRIPTS/checksums.ini\" | sed \"s/VERSION/$PKG_BASE_VER/\"`\n-        echo \"Found local metadata for $PKG_NAME\"\n-\n-        # Warning for experimental packages\n-        if [ x`cat \"$PKG_SCRIPTS/type\"` = x\"experimental\" -a $INFO = 0 ]; then\n-            if [ $YES != 1 ]; then\n-                # We use /dev/tty here because our output may be redirected\n-                # to a logfile, or line-buffered.\n-                write_to_tty <<EOF\n+# PKG_SRC should look like \"package-VERSION\" or just \"package\".\n+# If VERSION matches the version in build/pkgs or there is no version\n+# specified, use the local scripts; otherwise we try to find a package\n+# in upstream.\n+PKG_VER=\"${PKG_NAME#${PKG_BASE}}\"\n+PKG_VER=\"${PKG_VER#-}\"\n+PKG_SCRIPTS=\"$SAGE_ROOT/build/pkgs/$PKG_BASE\"\n+LOCAL_PKG_VER=`cat $PKG_SCRIPTS/package-version.txt 2>/dev/null`\n+PKG_VER=\"$LOCAL_PKG_VER\"\n+if [ -z \"$PKG_VER\" ]; then\n+    PKG_NAME=\"${PKG_BASE}\"\n+else\n+    PKG_NAME=\"${PKG_BASE}-${PKG_VER}\"\n+fi\n+USE_LOCAL_SCRIPTS=yes\n+PKG_BASE_VER=`echo $PKG_VER | sed 's/\\.p[0-9][0-9]*$//'`\n+PKG_NAME_UPSTREAM=`lookup_param tarball \"$PKG_SCRIPTS/checksums.ini\" | sed \"s/VERSION/$PKG_BASE_VER/\"`\n+echo \"Found local metadata for $PKG_NAME\"\n+\n+# Warning for experimental packages\n+if [ x`cat \"$PKG_SCRIPTS/type\"` = x\"experimental\" -a $INFO = 0 ]; then\n+    if [ $YES != 1 ]; then\n+        # We use /dev/tty here because our output may be redirected\n+        # to a logfile, or line-buffered.\n+        write_to_tty <<EOF\n =========================== WARNING ===========================\n You are about to download and install the experimental package\n $PKG_NAME.  This probably won't work at all for you! There\n@@ -306,36 +296,22 @@ is no guarantee that it will build correctly, or behave as\n expected. Use at your own risk!\n ===============================================================\n EOF\n-                if [ $? -ne 0 ]; then\n-                    echo \"Terminal not available for prompting.  Use 'sage -i -y $PKG_BASE'\"\n-                    echo \"to install experimental packages in non-interactive mode.\"\n-                    YES=-1\n-                fi\n-                if [ $YES != -1 ]; then\n-                    read -p \"Are you sure you want to continue [Y/n]? \" answer < /dev/tty > /dev/tty 2>&1\n-                else\n-                    answer=n\n-                fi\n-                case \"$answer\" in\n-                    n*|N*) exit 1;;\n-                esac\n-                # Confirm the user's input.  (This gives important\n-                # feedback to the user when output is redirected to a logfile.)\n-                echo > /dev/tty \"OK, installing $PKG_NAME now...\"\n-            fi\n+        if [ $? -ne 0 ]; then\n+            echo \"Terminal not available for prompting.  Use 'sage -i -y $PKG_BASE'\"\n+            echo \"to install experimental packages in non-interactive mode.\"\n+            YES=-1\n         fi\n-\n-    else\n-        cd \"$SAGE_DISTFILES\"\n-        for spkg in `ls -1t ${PKG_NAME}.spkg ${PKG_NAME}-*.spkg 2>/dev/null`; do\n-            if [ -f \"$spkg\" ]; then\n-                # Found a good package\n-                echo \"Found package $PKG_NAME in $SAGE_DISTFILES/$spkg\"\n-                PKG_SRC=\"`pwd`/$spkg\"\n-                PKG_NAME=`basename \"$spkg\" | sed 's/\\.spkg$//'`\n-                break\n-            fi\n-        done\n+        if [ $YES != -1 ]; then\n+            read -p \"Are you sure you want to continue [Y/n]? \" answer < /dev/tty > /dev/tty 2>&1\n+        else\n+            answer=n\n+        fi\n+        case \"$answer\" in\n+            n*|N*) exit 1;;\n+        esac\n+        # Confirm the user's input.  (This gives important\n+        # feedback to the user when output is redirected to a logfile.)\n+        echo > /dev/tty \"OK, installing $PKG_NAME now...\"\n     fi\n fi\n \n```\n",
    "created_at": "2020-06-18T23:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410761",
    "user": "https://github.com/jhpalmieri"
}
```

It looks like more can be removed. I haven't tested these changes thoroughly; what do you think?

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index c8d800fcae..620925a319 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -255,10 +255,8 @@ if echo "$PKG_SRC" | grep / >/dev/null; then
     echo >&2 "Error: Installing old-style SPKGs is no longer supported"
     exit 1
 fi
-# PKG_NAME is the last path component without .spkg
-# This already reduces case 2b to case 2a.
-PKG_NAME=`basename "$PKG_SRC" | sed 's/\.spkg$//'`
-PKG_BASE=`echo "$PKG_NAME" | sed 's/-.*//'`
+PKG_NAME="$PKG_SRC"
+PKG_BASE=`echo "$PKG_NAME" | sed 's/-.*//'` # strip version number
 
 # USE_LOCAL_SCRIPTS is a flag that if non-empty will cause
 # this script to try to install the package using local metadata
@@ -266,39 +264,31 @@ PKG_BASE=`echo "$PKG_NAME" | sed 's/-.*//'`
 # the value of this flag is set in the next codeblock
 USE_LOCAL_SCRIPTS=
 
-if [ -f "$PKG_SRC" ]; then
-    # PKG_SRC is a file.  If it is given by a relative path, prepend `pwd`
-    # (reduce case 1b to 1a)
-    if ! echo "$PKG_SRC" | grep '^/' >/dev/null; then
-        PKG_SRC="`pwd`/$PKG_SRC"
-    fi
-elif [ -z "$PKG_HAS_PATH" ]; then
-    # If PKG_SRC is not an existing file and doesn't contain a slash,
-    # we are in case 2a or 3.  If version in 2a matches the version in
-    # build/pkgs or we are in case 3 use the local scripts, otherwise
-    # we try to find a package in upstream
-    PKG_VER="${PKG_NAME#${PKG_BASE}}"
-    PKG_VER="${PKG_VER#-}"
-    PKG_SCRIPTS="$SAGE_ROOT/build/pkgs/$PKG_BASE"
-    LOCAL_PKG_VER=`cat $PKG_SCRIPTS/package-version.txt 2>/dev/null`
-    if [ -n "$LOCAL_PKG_VER" ] && [ -z "$PKG_VER" -o "$PKG_VER" = "$LOCAL_PKG_VER" ]; then
-        PKG_VER="$LOCAL_PKG_VER"
-        if [ -z "$PKG_VER" ]; then
-            PKG_NAME="${PKG_BASE}"
-        else
-            PKG_NAME="${PKG_BASE}-${PKG_VER}"
-        fi
-        USE_LOCAL_SCRIPTS=yes
-        PKG_BASE_VER=`echo $PKG_VER | sed 's/\.p[0-9][0-9]*$//'`
-        PKG_NAME_UPSTREAM=`lookup_param tarball "$PKG_SCRIPTS/checksums.ini" | sed "s/VERSION/$PKG_BASE_VER/"`
-        echo "Found local metadata for $PKG_NAME"
-
-        # Warning for experimental packages
-        if [ x`cat "$PKG_SCRIPTS/type"` = x"experimental" -a $INFO = 0 ]; then
-            if [ $YES != 1 ]; then
-                # We use /dev/tty here because our output may be redirected
-                # to a logfile, or line-buffered.
-                write_to_tty <<EOF
+# PKG_SRC should look like "package-VERSION" or just "package".
+# If VERSION matches the version in build/pkgs or there is no version
+# specified, use the local scripts; otherwise we try to find a package
+# in upstream.
+PKG_VER="${PKG_NAME#${PKG_BASE}}"
+PKG_VER="${PKG_VER#-}"
+PKG_SCRIPTS="$SAGE_ROOT/build/pkgs/$PKG_BASE"
+LOCAL_PKG_VER=`cat $PKG_SCRIPTS/package-version.txt 2>/dev/null`
+PKG_VER="$LOCAL_PKG_VER"
+if [ -z "$PKG_VER" ]; then
+    PKG_NAME="${PKG_BASE}"
+else
+    PKG_NAME="${PKG_BASE}-${PKG_VER}"
+fi
+USE_LOCAL_SCRIPTS=yes
+PKG_BASE_VER=`echo $PKG_VER | sed 's/\.p[0-9][0-9]*$//'`
+PKG_NAME_UPSTREAM=`lookup_param tarball "$PKG_SCRIPTS/checksums.ini" | sed "s/VERSION/$PKG_BASE_VER/"`
+echo "Found local metadata for $PKG_NAME"
+
+# Warning for experimental packages
+if [ x`cat "$PKG_SCRIPTS/type"` = x"experimental" -a $INFO = 0 ]; then
+    if [ $YES != 1 ]; then
+        # We use /dev/tty here because our output may be redirected
+        # to a logfile, or line-buffered.
+        write_to_tty <<EOF
 =========================== WARNING ===========================
 You are about to download and install the experimental package
 $PKG_NAME.  This probably won't work at all for you! There
@@ -306,36 +296,22 @@ is no guarantee that it will build correctly, or behave as
 expected. Use at your own risk!
 ===============================================================
 EOF
-                if [ $? -ne 0 ]; then
-                    echo "Terminal not available for prompting.  Use 'sage -i -y $PKG_BASE'"
-                    echo "to install experimental packages in non-interactive mode."
-                    YES=-1
-                fi
-                if [ $YES != -1 ]; then
-                    read -p "Are you sure you want to continue [Y/n]? " answer < /dev/tty > /dev/tty 2>&1
-                else
-                    answer=n
-                fi
-                case "$answer" in
-                    n*|N*) exit 1;;
-                esac
-                # Confirm the user's input.  (This gives important
-                # feedback to the user when output is redirected to a logfile.)
-                echo > /dev/tty "OK, installing $PKG_NAME now..."
-            fi
+        if [ $? -ne 0 ]; then
+            echo "Terminal not available for prompting.  Use 'sage -i -y $PKG_BASE'"
+            echo "to install experimental packages in non-interactive mode."
+            YES=-1
         fi
-
-    else
-        cd "$SAGE_DISTFILES"
-        for spkg in `ls -1t ${PKG_NAME}.spkg ${PKG_NAME}-*.spkg 2>/dev/null`; do
-            if [ -f "$spkg" ]; then
-                # Found a good package
-                echo "Found package $PKG_NAME in $SAGE_DISTFILES/$spkg"
-                PKG_SRC="`pwd`/$spkg"
-                PKG_NAME=`basename "$spkg" | sed 's/\.spkg$//'`
-                break
-            fi
-        done
+        if [ $YES != -1 ]; then
+            read -p "Are you sure you want to continue [Y/n]? " answer < /dev/tty > /dev/tty 2>&1
+        else
+            answer=n
+        fi
+        case "$answer" in
+            n*|N*) exit 1;;
+        esac
+        # Confirm the user's input.  (This gives important
+        # feedback to the user when output is redirected to a logfile.)
+        echo > /dev/tty "OK, installing $PKG_NAME now..."
     fi
 fi
 
```




---

archive/issue_comments_410762.json:
```json
{
    "body": "I agree, please go ahead and push it to the branch.",
    "created_at": "2020-06-18T23:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410762",
    "user": "https://github.com/mkoeppe"
}
```

I agree, please go ahead and push it to the branch.



---

archive/issue_comments_410763.json:
```json
{
    "body": "This seems to work well.\n----\nNew commits:",
    "created_at": "2020-06-19T00:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410763",
    "user": "https://github.com/mkoeppe"
}
```

This seems to work well.
----
New commits:



---

archive/issue_comments_410764.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-06-19T15:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410764",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review



---

archive/issue_comments_410765.json:
```json
{
    "body": "This works for me, too.",
    "created_at": "2020-06-19T15:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410765",
    "user": "https://github.com/jhpalmieri"
}
```

This works for me, too.



---

archive/issue_comments_410766.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-19T15:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410766",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410767.json:
```json
{
    "body": "Let's move ahead with it.",
    "created_at": "2020-06-19T15:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410767",
    "user": "https://github.com/jhpalmieri"
}
```

Let's move ahead with it.



---

archive/issue_comments_410768.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-06-19T16:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410768",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_410769.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-02T21:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29052#issuecomment-410769",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_026854.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-02T21:30:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29052",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29052#event-26854"
}
```
