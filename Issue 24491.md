# Issue 24491: py3: fix fully the thematic index of methods in graphs

Issue created by migration from https://trac.sagemath.org/ticket/24728

Original creator: chapoton

Original creation time: 2018-02-14 12:50:19

CC:  embray

follow-up of #23823, that did not fix the problem in python3

core issue:

```
sage: hash(getattr(Graph, 'is_long_hole_free'))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-41-8a5746117695> in <module>()
----> 1 hash(getattr(Graph, 'is_long_hole_free'))

TypeError: unhashable type: 'instancemethod'
```



---

Comment by chapoton created at 2018-02-14 12:51:40

Changing component from PLEASE CHANGE to python3.


---

Comment by chapoton created at 2018-02-14 13:11:22

If we compare the two lines

```
from sage.graphs.weakly_chordal import is_long_hole_free, is_long_antihole_free, is_weakly_chordal
from sage.graphs.asteroidal_triples import is_asteroidal_triple_free
```

Both are imported from a pyx file, only the first is problematic.
Comparing:

```
sage: getattr(Graph, "is_asteroidal_triple_free")
<built-in function is_asteroidal_triple_free>
sage: getattr(Graph, "is_long_hole_free")
<instancemethod is_long_hole_free at 0x7fed5c5758b8>
```

and the second one is not hashable. Both come from a "def". What is the difference ?


---

Comment by chapoton created at 2018-02-14 16:06:17

Jeoren, any idea as a cython expert of what could explain the difference in the previous comment ?


---

Comment by jdemeyer created at 2018-02-14 16:28:19

The difference is that `weakly_chordal.pyx` is compiled with `# cython: binding=True` (see the first line of that file).

But really, `is_asteroidal_triple_free` is broken. It doesn't work as a method:

```
sage: Graph(5).is_asteroidal_triple_free()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-79cc7f0a39a3> in <module>()
----> 1 Graph(Integer(5)).is_asteroidal_triple_free()

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6495)()
     80 from sage.ext.memory_allocator cimport MemoryAllocator
     81 
---> 82 def is_asteroidal_triple_free(G, certificate=False):
     83     """
     84     Test if the input graph is asteroidal triple-free

TypeError: is_asteroidal_triple_free() takes at least 1 positional argument (0 given)
```

So don't take `is_asteroidal_triple_free` as example.


---

Comment by jdemeyer created at 2018-02-14 16:42:22

In Python 3, an unbound method is just the function:

```
In [18]: class X:
    ...:     def meth(self): return self

In [19]: X.meth
Out[19]: <function __main__.X.meth>

In [20]: type(X.meth)
Out[20]: function
```

So the fact that Cython gives an `instancemethod` instead of a function might be considered a Cython bug. I'll think about it later.


---

Comment by jdemeyer created at 2018-02-15 10:04:14

Changing type from PLEASE CHANGE to defect.


---

Comment by git created at 2018-02-15 10:51:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-15 13:28:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-15 13:33:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-15 14:00:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-15 19:11:33

To potential reviewers: the dependency on #21509 is just because both tickets add a patch to Cython. If it's hard to review #21509, I could reorganize things. For example, I could put both patches on this ticket and reverse the dependency. Just let me know which pieces of #21509 and #24728 you could give positive review to.


---

Comment by jdemeyer created at 2018-02-22 16:18:51

#21509 is stuck for now.

Regardless, the commits from this ticket can still be reviewed. If this ticket gets positive review, I will reorganize the dependency to make this ticket independent from #21509.


---

Comment by chapoton created at 2018-02-26 20:19:26

Ok, I am ready to give a positive review here. Please disentangle from #21509.


---

Comment by jdemeyer created at 2018-02-27 08:56:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-02-27 08:58:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-27 08:59:27

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-03-04 23:28:58

Resolution: fixed


---

Comment by chapoton created at 2018-03-11 12:14:00

Sadly, this still does not fix the issue number 2 in the description..

So, vanilla sage still does not start with python3..


---

Comment by jdemeyer created at 2018-03-11 13:25:16

I think you need `./sage -f sagelib`


---

Comment by chapoton created at 2018-03-11 13:27:51

Ho, is this stronger than `make build` ? ok, I will try.


---

Comment by jdemeyer created at 2018-03-11 14:50:46

Similar to other packages inside Sage-the-distribution, `./sage -f` forces a complete rebuild of that package, regardless of what was installed before. So `./sage -f sagelib` forces a complete rebuild of the Sage library. In particular, in this ticket we need to run Cython again on the affected file.

`make build` simply builds all of Sage-the-distribution (except doc), but it won't reinstall anything which is already installed.


---

Comment by chapoton created at 2018-03-11 14:54:00

Thanks, it worked. So indeed now sage+python3 does start !


---

Comment by jdemeyer created at 2018-03-11 14:57:46

Replying to [comment:25 chapoton]:
> Thanks, it worked. So indeed now sage+python3 does start !

So I guess we should update the `build-python3` target (and actually start using it!)
