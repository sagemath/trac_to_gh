# Issue 24491: py3: fix fully the thematic index of methods in graphs

archive/issues_024491.json:
```json
{
    "body": "CC:  @embray\n\nfollow-up of #23823, that did not fix the problem in python3\n\ncore issue:\n\n```\nsage: hash(getattr(Graph, 'is_long_hole_free'))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-41-8a5746117695> in <module>()\n----> 1 hash(getattr(Graph, 'is_long_hole_free'))\n\nTypeError: unhashable type: 'instancemethod'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24728\n\n",
    "created_at": "2018-02-14T12:50:19Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: fix fully the thematic index of methods in graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24491",
    "user": "https://github.com/fchapoton"
}
```
CC:  @embray

follow-up of #23823, that did not fix the problem in python3

core issue:

```
sage: hash(getattr(Graph, 'is_long_hole_free'))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-41-8a5746117695> in <module>()
----> 1 hash(getattr(Graph, 'is_long_hole_free'))

TypeError: unhashable type: 'instancemethod'
```


Issue created by migration from https://trac.sagemath.org/ticket/24728





---

archive/issue_comments_343189.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to python3.",
    "created_at": "2018-02-14T12:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343189",
    "user": "https://github.com/fchapoton"
}
```

Changing component from PLEASE CHANGE to python3.



---

archive/issue_comments_343190.json:
```json
{
    "body": "If we compare the two lines\n\n```\nfrom sage.graphs.weakly_chordal import is_long_hole_free, is_long_antihole_free, is_weakly_chordal\nfrom sage.graphs.asteroidal_triples import is_asteroidal_triple_free\n```\n\nBoth are imported from a pyx file, only the first is problematic.\nComparing:\n\n```\nsage: getattr(Graph, \"is_asteroidal_triple_free\")\n<built-in function is_asteroidal_triple_free>\nsage: getattr(Graph, \"is_long_hole_free\")\n<instancemethod is_long_hole_free at 0x7fed5c5758b8>\n```\n\nand the second one is not hashable. Both come from a \"def\". What is the difference ?",
    "created_at": "2018-02-14T13:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343190",
    "user": "https://github.com/fchapoton"
}
```

If we compare the two lines

```
from sage.graphs.weakly_chordal import is_long_hole_free, is_long_antihole_free, is_weakly_chordal
from sage.graphs.asteroidal_triples import is_asteroidal_triple_free
```

Both are imported from a pyx file, only the first is problematic.
Comparing:

```
sage: getattr(Graph, "is_asteroidal_triple_free")
<built-in function is_asteroidal_triple_free>
sage: getattr(Graph, "is_long_hole_free")
<instancemethod is_long_hole_free at 0x7fed5c5758b8>
```

and the second one is not hashable. Both come from a "def". What is the difference ?



---

archive/issue_comments_343191.json:
```json
{
    "body": "Jeoren, any idea as a cython expert of what could explain the difference in the previous comment ?",
    "created_at": "2018-02-14T16:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343191",
    "user": "https://github.com/fchapoton"
}
```

Jeoren, any idea as a cython expert of what could explain the difference in the previous comment ?



---

archive/issue_comments_343192.json:
```json
{
    "body": "The difference is that `weakly_chordal.pyx` is compiled with `# cython: binding=True` (see the first line of that file).\n\nBut really, `is_asteroidal_triple_free` is broken. It doesn't work as a method:\n\n```\nsage: Graph(5).is_asteroidal_triple_free()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-11-79cc7f0a39a3> in <module>()\n----> 1 Graph(Integer(5)).is_asteroidal_triple_free()\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6495)()\n     80 from sage.ext.memory_allocator cimport MemoryAllocator\n     81 \n---> 82 def is_asteroidal_triple_free(G, certificate=False):\n     83     \"\"\"\n     84     Test if the input graph is asteroidal triple-free\n\nTypeError: is_asteroidal_triple_free() takes at least 1 positional argument (0 given)\n```\n\nSo don't take `is_asteroidal_triple_free` as example.",
    "created_at": "2018-02-14T16:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343192",
    "user": "https://github.com/jdemeyer"
}
```

The difference is that `weakly_chordal.pyx` is compiled with `# cython: binding=True` (see the first line of that file).

But really, `is_asteroidal_triple_free` is broken. It doesn't work as a method:

```
sage: Graph(5).is_asteroidal_triple_free()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-11-79cc7f0a39a3> in <module>()
----> 1 Graph(Integer(5)).is_asteroidal_triple_free()

/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6495)()
     80 from sage.ext.memory_allocator cimport MemoryAllocator
     81 
---> 82 def is_asteroidal_triple_free(G, certificate=False):
     83     """
     84     Test if the input graph is asteroidal triple-free

TypeError: is_asteroidal_triple_free() takes at least 1 positional argument (0 given)
```

So don't take `is_asteroidal_triple_free` as example.



---

archive/issue_comments_343193.json:
```json
{
    "body": "In Python 3, an unbound method is just the function:\n\n```\nIn [18]: class X:\n    ...:     def meth(self): return self\n\nIn [19]: X.meth\nOut[19]: <function __main__.X.meth>\n\nIn [20]: type(X.meth)\nOut[20]: function\n```\n\nSo the fact that Cython gives an `instancemethod` instead of a function might be considered a Cython bug. I'll think about it later.",
    "created_at": "2018-02-14T16:42:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343193",
    "user": "https://github.com/jdemeyer"
}
```

In Python 3, an unbound method is just the function:

```
In [18]: class X:
    ...:     def meth(self): return self

In [19]: X.meth
Out[19]: <function __main__.X.meth>

In [20]: type(X.meth)
Out[20]: function
```

So the fact that Cython gives an `instancemethod` instead of a function might be considered a Cython bug. I'll think about it later.



---

archive/issue_comments_343194.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2018-02-15T10:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343194",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_343195.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T10:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343195",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343196.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T13:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-15T13:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343198.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-15T14:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343198",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343199.json:
```json
{
    "body": "To potential reviewers: the dependency on #21509 is just because both tickets add a patch to Cython. If it's hard to review #21509, I could reorganize things. For example, I could put both patches on this ticket and reverse the dependency. Just let me know which pieces of #21509 and #24728 you could give positive review to.",
    "created_at": "2018-02-15T19:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343199",
    "user": "https://github.com/jdemeyer"
}
```

To potential reviewers: the dependency on #21509 is just because both tickets add a patch to Cython. If it's hard to review #21509, I could reorganize things. For example, I could put both patches on this ticket and reverse the dependency. Just let me know which pieces of #21509 and #24728 you could give positive review to.



---

archive/issue_comments_343200.json:
```json
{
    "body": "#21509 is stuck for now.\n\nRegardless, the commits from this ticket can still be reviewed. If this ticket gets positive review, I will reorganize the dependency to make this ticket independent from #21509.",
    "created_at": "2018-02-22T16:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343200",
    "user": "https://github.com/jdemeyer"
}
```

#21509 is stuck for now.

Regardless, the commits from this ticket can still be reviewed. If this ticket gets positive review, I will reorganize the dependency to make this ticket independent from #21509.



---

archive/issue_comments_343201.json:
```json
{
    "body": "Ok, I am ready to give a positive review here. Please disentangle from #21509.",
    "created_at": "2018-02-26T20:19:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343201",
    "user": "https://github.com/fchapoton"
}
```

Ok, I am ready to give a positive review here. Please disentangle from #21509.



---

archive/issue_comments_343202.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-27T08:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343202",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343203.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T08:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343203",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343204.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-27T08:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343204",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_343205.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-04T23:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343205",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_022868.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-03-04T23:28:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24491#event-22868"
}
```



---

archive/issue_comments_343206.json:
```json
{
    "body": "Sadly, this still does not fix the issue number 2 in the description..\n\nSo, vanilla sage still does not start with python3..",
    "created_at": "2018-03-11T12:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343206",
    "user": "https://github.com/fchapoton"
}
```

Sadly, this still does not fix the issue number 2 in the description..

So, vanilla sage still does not start with python3..



---

archive/issue_comments_343207.json:
```json
{
    "body": "I think you need `./sage -f sagelib`",
    "created_at": "2018-03-11T13:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343207",
    "user": "https://github.com/jdemeyer"
}
```

I think you need `./sage -f sagelib`



---

archive/issue_comments_343208.json:
```json
{
    "body": "Ho, is this stronger than `make build` ? ok, I will try.",
    "created_at": "2018-03-11T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343208",
    "user": "https://github.com/fchapoton"
}
```

Ho, is this stronger than `make build` ? ok, I will try.



---

archive/issue_comments_343209.json:
```json
{
    "body": "Similar to other packages inside Sage-the-distribution, `./sage -f` forces a complete rebuild of that package, regardless of what was installed before. So `./sage -f sagelib` forces a complete rebuild of the Sage library. In particular, in this ticket we need to run Cython again on the affected file.\n\n`make build` simply builds all of Sage-the-distribution (except doc), but it won't reinstall anything which is already installed.",
    "created_at": "2018-03-11T14:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343209",
    "user": "https://github.com/jdemeyer"
}
```

Similar to other packages inside Sage-the-distribution, `./sage -f` forces a complete rebuild of that package, regardless of what was installed before. So `./sage -f sagelib` forces a complete rebuild of the Sage library. In particular, in this ticket we need to run Cython again on the affected file.

`make build` simply builds all of Sage-the-distribution (except doc), but it won't reinstall anything which is already installed.



---

archive/issue_comments_343210.json:
```json
{
    "body": "Thanks, it worked. So indeed now sage+python3 does start !",
    "created_at": "2018-03-11T14:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343210",
    "user": "https://github.com/fchapoton"
}
```

Thanks, it worked. So indeed now sage+python3 does start !



---

archive/issue_comments_343211.json:
```json
{
    "body": "Replying to [comment:25 chapoton]:\n> Thanks, it worked. So indeed now sage+python3 does start !\n\nSo I guess we should update the `build-python3` target (and actually start using it!)",
    "created_at": "2018-03-11T14:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24491",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24491#issuecomment-343211",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 chapoton]:
> Thanks, it worked. So indeed now sage+python3 does start !

So I guess we should update the `build-python3` target (and actually start using it!)
