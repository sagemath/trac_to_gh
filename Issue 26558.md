# Issue 26558: Some memory leaks

Issue created by migration from https://trac.sagemath.org/ticket/26795

Original creator: jmantysalo

Original creation time: 2018-12-01 16:22:13

CC:  mkoeppe

(Add more leaks here.)


```
def bad8(n):
    from sage.graphs.independent_sets import IndependentSets
    G = Graph(2)
    for i in range(n):
        x = [0] in IndependentSets(G)
        if i % 10000 == 0:
            print get_memory_usage()

bad8(100000)
```



---

Comment by mantepse created at 2018-12-01 19:15:42

fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)


---

Comment by jmantysalo created at 2018-12-01 19:58:23

Replying to [comment:3 mantepse]:
> fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)

Trying to understand... So every call to `iter()` will create kind of "implicit object" by calling `__iter__()` that by design of `yield` statement will create a state for an iterator. But because it is "implicit", there can no explicit destructor? Then the iterator must add a back-reference to some class variable, I guess. Something like


```
class Foo:
    sometype refs
    def __init__():
        refs = []
    def __iter__():
        x = reserve_memory()
        refs.append(x)
        . . .
    def __dealloc__():
        for x in refs:
            release_memory(x)
```



---

Comment by mantepse created at 2018-12-01 20:05:22

It was actually quite easy, see #26796


---

Comment by jmantysalo created at 2018-12-01 20:14:51

Replying to [comment:5 mantepse]:
> It was actually quite easy, see #26796

Ah, of course. `finally` is always called.


---

Comment by jmantysalo created at 2018-12-02 06:52:17

`add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains


```
col_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))
col_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))
```


Where are those freed?


---

Comment by dimpase created at 2018-12-02 10:58:49

Replying to [comment:7 jmantysalo]:
> `add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains
> 
> {{{
> col_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))
> col_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))
> }}}
> 
> Where are those freed?

it appears they can (and must!) be freed at the end of this function, as glpk copies all that data, and not re-uses it later.


---

Comment by dimpase created at 2018-12-02 12:28:45

I tried running tests with the following patch, and it does not appear to break anything:


```diff
diff --git a/src/sage/numerical/backends/glpk_backend.pyx b/src/sage/numerical/backends/glpk_backend.pyx
index 738365b608..6de416afdf 100644
--- a/src/sage/numerical/backends/glpk_backend.pyx
+++ b/src/sage/numerical/backends/glpk_backend.pyx
@@ -831,6 +831,8 @@ cdef class GLPKBackend(GenericBackend):
 
         glp_set_mat_col(self.lp, n, len(indices), col_i, col_values)
         glp_set_col_bnds(self.lp, n, GLP_LO, 0,0)
+        sig_free(col_i)
+        sig_free(col_values)
 
 
     cpdef int solve(self) except -1:
```



---

Comment by dimpase created at 2018-12-02 12:30:24

Perhaps mkoeppe can confirm whether this is a bug in GLPK backend.


---

Comment by jmantysalo created at 2018-12-02 13:33:37

Replying to [comment:9 dimpase]:

> I tried running tests with the following patch, and it does not appear to break anything:

Is this the one that is responsible for leak in `dimension()` of poset?


---

Comment by dimpase created at 2018-12-02 15:52:07

I think the poset thing is fixed by #26796.

But the patch I just posted is surely needed - you can see it fixes the following leak:

```
sage: def bad99(n):
....:     from sage.numerical.backends.generic_backend import get_solver
....:     for i in range(n):
....:         p = get_solver(solver = "GLPK")
....:         p.add_linear_constraints(5, 0, None)
....:         p.add_col(range(5), range(5))
....:         if i % 10000 == 0:
....:             print get_memory_usage()
....: 
....: bad99(100000)
```



---

Comment by dimpase created at 2018-12-02 16:06:31

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-12-02 16:06:31

New commits:


---

Comment by dimpase created at 2018-12-02 16:11:12

a similar bug seems to be in `add_col` coin backend...


---

Comment by jmantysalo created at 2018-12-02 18:07:55

Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.


---

Comment by jmantysalo created at 2018-12-02 18:07:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-12-02 23:24:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-12-02 23:35:38

Replying to [comment:15 jmantysalo]:
> Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.

Coin backend hopefully fixed too.

Please post the code showing the leak in basis_matroid


---

Comment by jmantysalo created at 2018-12-03 07:09:18

Replying to [comment:17 dimpase]:

> Please post the code showing the leak in basis_matroid


```
from sage.matroids.advanced import *
import gc

i = 0
while True:
    if i%1000==0: print get_memory_usage()
    i += 1
    M = BasisMatroid(matroids.named_matroids.NonFano())
    N = BasisMatroid(matroids.named_matroids.Fano())
    m = {e:e for e in M.groundset()}
    M._is_relaxation(N, m)
    N._is_relaxation(M, m)
```



---

Comment by dimpase created at 2018-12-03 10:30:26

regarding Poset dimension. It seems it's already a problem in the beginning of the function:

```python
import gc
from sage.graphs.comparability import greedy_is_comparability as is_comparability
i = 0                                                                            
for P in Posets(8):
    if i % 1000 == 0:
        gc.collect()
        print get_memory_usage()
    i += 1
    _ = is_comparability(P._hasse_diagram.transitive_closure().to_undirected().complement())            
```


If I remove the call to `is_comparability()` the problem is gone here.


---

Comment by jmantysalo created at 2018-12-03 11:04:33

Replying to [comment:19 dimpase]:

> If I remove the call to `is_comparability()` the problem is gone here.

But if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.


---

Comment by jmantysalo created at 2018-12-03 11:30:10

What's this:


```
import gc

i = 0
GG = graphs()
_ = next(GG); _ = next(GG); 
for P in GG:
    if i > 20000: break
    if i % 1000 == 0:
        _ = gc.collect()
        print get_memory_usage(), P.order()
    i += 1
    _ = P.convexity_properties()
```


??? There is an explicit `__destruct__` in class `ConvexityProperties`.


---

Comment by dimpase created at 2018-12-03 11:47:29

Replying to [comment:20 jmantysalo]:
> Replying to [comment:19 dimpase]:
> 
> > If I remove the call to `is_comparability()` the problem is gone here.
> 
> But if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.

By the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...


---

Comment by jmantysalo created at 2018-12-03 11:51:19

Replying to [comment:22 dimpase]:

> By the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...

Yes, I have noticed that. And sometime the grow stalls for a while and then continues.

I guess that Python runs malloc() at C-level with some kind of heuristics, "the user will propably ask for more soon anyways".


---

Comment by dimpase created at 2018-12-03 12:01:52

Replying to [comment:21 jmantysalo]:
> What's this:
> 
> {{{
> import gc
> 
> i = 0
> GG = graphs()
> _ = next(GG); _ = next(GG); 
> for P in GG:
>     if i > 20000: break
>     if i % 1000 == 0:
>         _ = gc.collect()
>         print get_memory_usage(), P.order()
>     i += 1
>     _ = P.convexity_properties()
> }}}
> 
> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.

I've noticed this one missing:

```diff
diff --git a/src/sage/graphs/convexity_properties.pyx b/src/sage/graphs/convexity_properties.pyx
index 474eb0e4cf..6b66e77a39 100644
--- a/src/sage/graphs/convexity_properties.pyx
+++ b/src/sage/graphs/convexity_properties.pyx
@@ -333,6 +333,7 @@ cdef class ConvexityProperties:
                 if bitset_len(tmp) < self._n:
                     bitset_add(bs, i)
 
+        bitset_free(tmp)
 
     cpdef hull_number(self, value_only=True, verbose=False):
         r"""
```

but it does not seem to matter here.


---

Comment by git created at 2018-12-03 12:12:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-12-03 15:01:57

Replying to [comment:21 jmantysalo]:
> What's this:
> 
> {{{
> import gc
> 
> i = 0
> GG = graphs()
> _ = next(GG); _ = next(GG); 
> for P in GG:
>     if i > 20000: break
>     if i % 1000 == 0:
>         _ = gc.collect()
>         print get_memory_usage(), P.order()
>     i += 1
>     _ = P.convexity_properties()
> }}}
> 
> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.

however, `__destruct__` is not called, as one can see by putting a `print()` there.


---

Comment by git created at 2018-12-03 16:34:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-12-03 16:39:13

OK, the latest commit fixes `convexity_properties` leak.


---

Comment by jmantysalo created at 2018-12-03 19:34:17

Should we now make another ticket about `_is_relaxation()` and try to review and close this one?


---

Comment by dimpase created at 2018-12-03 19:39:51

As you like - you know more about leaks than me :-)


---

Comment by jmantysalo created at 2018-12-03 19:50:18

Replying to [comment:30 dimpase]:
> As you like - you know more about leaks than me :-)

OK, I made #26806. To confirm, is this now ready for review?


---

Comment by dimpase created at 2018-12-03 19:52:11

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2018-12-03 19:52:11

Thanks. Yes, please review!


---

Comment by jmantysalo created at 2018-12-04 07:00:35

This is OK. Thanks for fixes.


---

Comment by jmantysalo created at 2018-12-04 07:00:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-07 12:10:30

Resolution: fixed
