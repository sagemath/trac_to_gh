# Issue 33976: sagelib spkg-install: Unset but do not poison SAGE_LOCAL

Issue created by migration from https://trac.sagemath.org/ticket/34213

Original creator: mkoeppe

Original creation time: 2022-07-22 21:00:55

CC:  jhpalmieri dimpase fbissey

This corrects a change made in #29779 and avoids `ld: warning: directory not found for option '-L/doesnotexist/lib'`


---

Comment by mkoeppe created at 2022-07-22 21:20:36

New commits:


---

Comment by mkoeppe created at 2022-07-22 21:20:36

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-07-28 03:10:12

Under what circumstances will it matter whether `SAGE_LOCAL` is set or unset?


---

Comment by mkoeppe created at 2022-07-28 03:21:15

The function `var` in `sage.env` first takes the value of the environment variable. Only if it is unset, the value is taken from `sage_conf` or the fallback value.

At the time of installation, `sage_setup.setenv` manipulates `CPATH`, `LIBRARY_PATH` etc. based on the value of `SAGE_LOCAL`. This mechanism is not actually needed for installation within the Sage distribution because we have already set all of these environment variables in `sage-build-env`.

The `ld: warning: directory not found ... /doesnotexist/lib` are not really a problem, but I have marked the ticket as critical because these messages have the potential to confuse users.

(However, the Cygwin rebasing really was broken by #29779 and is also restored here.)


---

Comment by jhpalmieri created at 2022-07-28 18:53:05

Sorry, I don't understand. Before #29779, we didn't touch `SAGE_LOCAL`. We have three options:

- `unset SAGE_LOCAL`
- do nothing — the status quo before #29779, I think
- poison `SAGE_LOCAL — causes all of the warning messages

The old comment (deleted in #29779) about not poisoning `SAGE_LOCAL` was deemed no longer valid, although I don't know why. Anyway, I'm happy to avoid poisoning that variable, but is the point here that we want to avoid problems if the user has somehow set `SAGE_LOCAL`? Otherwise, how does unsetting compare to just doing nothing?


---

Comment by mkoeppe created at 2022-07-28 19:16:38

Doing nothing with `SAGE_LOCAL`, i.e., keeping it at the value set by the build environment (`sage-env` + `sage-build-env`) would also work.

My mistake in #29779 was to believe that the comment, "We cannot poison SAGE_LOCAL because the pkg-config script..." gave the *only* reason why we cannot poison it. That was true at the time of writing that comment, but was no longer true after I added the `sage_setup.setenv` mechanism.


---

Comment by mkoeppe created at 2022-07-28 19:21:15

None of the poisoning and none of the unsetting of variables is needed to ensure correct functioning of the installation script: 

All the variables are set to the correct values by `sage-env` + `sage-build-env`. The purpose of poisoning / unsetting is only to make sure that future changes to sagelib's build system do not re-introduce undisciplined data flows.


---

Comment by jhpalmieri created at 2022-07-29 17:27:23

This works for me. The Cygwin fix looks reasonable, but I haven't tested it. Anyone else?


---

Comment by fbissey created at 2022-08-01 01:48:52

The git branch currently has

```
export SAGE_PKG_CONFIG_PATH=/doesnotexist
```

and later

```
+unset SAGE_PKG_CONFIG_PATH
```

please remove the first one like you did with `SAGE_LOCAL`.


---

Comment by mkoeppe created at 2022-08-01 20:12:08

Thanks for spotting this


---

Comment by git created at 2022-08-01 20:16:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-08-01 20:47:53

LGTM


---

Comment by fbissey created at 2022-08-01 20:47:53

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-08-01 20:52:02

Thanks!


---

Comment by vbraun created at 2022-08-04 22:47:05

Resolution: fixed
