# Issue 20848: Blow ups for affine/projective curves

archive/issues_020848.json:
```json
{
    "body": "CC:  @bhutz @miguelmarco\n\nKeywords: gsoc2016\n\nImplement functions to compute the blow up of an affine/projective curve at a point. These functions should describe the blow up in terms of affine patches.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21085\n\n",
    "created_at": "2016-07-24T18:20:34Z",
    "labels": [
        "component: algebraic geometry",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Blow ups for affine/projective curves",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20848",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```
CC:  @bhutz @miguelmarco

Keywords: gsoc2016

Implement functions to compute the blow up of an affine/projective curve at a point. These functions should describe the blow up in terms of affine patches.

Issue created by migration from https://trac.sagemath.org/ticket/21085





---

archive/issue_comments_287867.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-28T08:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-12T07:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287869.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-12T07:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287869",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_287870.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-13T09:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287871.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-13T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287871",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_287872.json:
```json
{
    "body": "I think this is looking good overall. I have a few nits and a couple suggestions.\n\n- you have no examples over `A^3` or higher even though it is in the general curve class\n\n- I'm not sure I like the behavior that you get when you resolve a curve where all the singularities are not rational. You essentially get the curve itself back. Perhaps you should raise an error of the form \"no rational singularities, use extend=True\" or something like that.\n\n  - you should explicitly use the keyword in examples: 'extend=True' instead of just 'True'\n\n- For the extend = True example, here is one that takes < 1s instead of the 3s that yours takes. I didn't look closely at yours, so if it tests additional functionality, then by all means leave it.\n\n```\nC=A.curve(x^4 + 2*x^2 + y^3 + 1)\n```\n\n- I was testing blowup() and really wanted to pass it a point other than the original. Is that a pain, to translate the point and then translate back?\n\n\n- the error cases are not run in the examples and they should be\n\n- in extension(): two code improvements\n\n\n```\nL = [pt[j] for j in range(len(self.ambient_space().gens())) for pt in pts]}}\n```\n\ncan be the simpler\n\n```\nL = [t for pt in pts for t in pt ]\n```\n\n\nand\n\n```\nK = number_field_elements_from_algebraics(L)[0]\nreturn [K, self.base_ring().embeddings(K)[0]]\n```\n\ncan be\n\n```\nK,a,phi = ...\nreturn [K,phi]\n```\n\nsince number_field_elements_from_algebraic returns the embedding it used, so you can return that instead of just the first element of embeddings.",
    "created_at": "2016-08-13T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287872",
    "user": "https://github.com/bhutz"
}
```

I think this is looking good overall. I have a few nits and a couple suggestions.

- you have no examples over `A^3` or higher even though it is in the general curve class

- I'm not sure I like the behavior that you get when you resolve a curve where all the singularities are not rational. You essentially get the curve itself back. Perhaps you should raise an error of the form "no rational singularities, use extend=True" or something like that.

  - you should explicitly use the keyword in examples: 'extend=True' instead of just 'True'

- For the extend = True example, here is one that takes < 1s instead of the 3s that yours takes. I didn't look closely at yours, so if it tests additional functionality, then by all means leave it.

```
C=A.curve(x^4 + 2*x^2 + y^3 + 1)
```

- I was testing blowup() and really wanted to pass it a point other than the original. Is that a pain, to translate the point and then translate back?


- the error cases are not run in the examples and they should be

- in extension(): two code improvements


```
L = [pt[j] for j in range(len(self.ambient_space().gens())) for pt in pts]}}
```

can be the simpler

```
L = [t for pt in pts for t in pt ]
```


and

```
K = number_field_elements_from_algebraics(L)[0]
return [K, self.base_ring().embeddings(K)[0]]
```

can be

```
K,a,phi = ...
return [K,phi]
```

since number_field_elements_from_algebraic returns the embedding it used, so you can return that instead of just the first element of embeddings.



---

archive/issue_comments_287873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-14T07:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287873",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287874.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-14T07:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287874",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_287875.json:
```json
{
    "body": "Thanks! Made most of the changes.\n\nThere were two `A^3` examples in blowup() and resolution_of_singularities() so I left those as is, but I could still add some more higher dim. examples (the output gets long quickly).\n\nFor the extension() function I tried using the composite_fields functionality that number fields have; I think this might be cleaner than the approach I was trying with passing the generator of a number field as a QQbar element to number_field_elements_from_algebraics along with the other QQbar numbers in order to get a bigger field.\n\nI think I could get blowup() to work for arbitrary points. After moving a point to the origin and blowing up, I'm not sure how to transform back though as the blowup will live in a mixed product space. I think maybe just constructing the ideal for the blow up centered at a different point directly might work.\n\nGiven a point `P = (p_1,...,p_n)`, I think the ideal of the blow up at that point would be generated by the polynomials `(x_i - p_i)s_j - (x_j - p_j)s_i` where the `x_i` are the coords for the affine component, and the `s_i` are the coords of the projective component of the product space. I tried something like this in my first attempt at the blowup function, but was unsure whether it was the right construction. Do you think this gives the right ideal? It seems like it should still give the closure of the graph of the rational map defined `(x_1,...,x_n) ---> (x_1 - p_1 :... : x_n - p_n)` which I think is how the blow up at `P` is defined.",
    "created_at": "2016-08-14T07:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287875",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Thanks! Made most of the changes.

There were two `A^3` examples in blowup() and resolution_of_singularities() so I left those as is, but I could still add some more higher dim. examples (the output gets long quickly).

For the extension() function I tried using the composite_fields functionality that number fields have; I think this might be cleaner than the approach I was trying with passing the generator of a number field as a QQbar element to number_field_elements_from_algebraics along with the other QQbar numbers in order to get a bigger field.

I think I could get blowup() to work for arbitrary points. After moving a point to the origin and blowing up, I'm not sure how to transform back though as the blowup will live in a mixed product space. I think maybe just constructing the ideal for the blow up centered at a different point directly might work.

Given a point `P = (p_1,...,p_n)`, I think the ideal of the blow up at that point would be generated by the polynomials `(x_i - p_i)s_j - (x_j - p_j)s_i` where the `x_i` are the coords for the affine component, and the `s_i` are the coords of the projective component of the product space. I tried something like this in my first attempt at the blowup function, but was unsure whether it was the right construction. Do you think this gives the right ideal? It seems like it should still give the closure of the graph of the rational map defined `(x_1,...,x_n) ---> (x_1 - p_1 :... : x_n - p_n)` which I think is how the blow up at `P` is defined.



---

archive/issue_comments_287876.json:
```json
{
    "body": "THis new resolution functionality looks fine to me.\n\nFor the blow-up, yes that should be the correct ideal to blow up not at the origin. That is almost certainly easier than translating.",
    "created_at": "2016-08-14T14:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287876",
    "user": "https://github.com/bhutz"
}
```

THis new resolution functionality looks fine to me.

For the blow-up, yes that should be the correct ideal to blow up not at the origin. That is almost certainly easier than translating.



---

archive/issue_comments_287877.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T00:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-18T04:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287878",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287879.json:
```json
{
    "body": "Ok, I generalized the blowup() function to work for arbitrary points. This simplified some of the code in resolution_of_singularities since there's no longer a need to keep track of change of coordinate maps used to move points to the origin. However, I ran into a couple of issues when testing some higher dimension examples.\n\nIt seems that the way I was trying to isolate the strict transforms of the curves wrt the blow ups isn't always sufficient for higher dimension curves, and sometimes the resulting curves would be reducible even though the original curves were irreducible. To address this, the blowup() function now looks at the irreducible components of the transformed curve (after substituting the relations that hold in a particular chart of the blowup) and ignores any component that lies within the exceptional divisor.\n\nIn implementing the above I noticed another issue which occurs when the transform of the curve coincides with the exceptional divisor. An example of this is when blowing up the line `x` at the origin; in one of the charts the transformed line and the exceptional divisor both seem to be defined by `x`. If I understand correctly the strict transform is the closure of the preimage by the projection map of the line minus the origin, which I think should be empty in that chart. The output in the current implementation is:\n\n\n```\nA.<x,y> = AffineSpace(QQ, 2)\nC = A.curve([x])\nC.blowup([0,0])[0]\n(Closed subscheme of Affine Space of dimension 2 over Rational Field\ndefined by: 1, Affine Plane Curve over Rational Field defined by s0)\n```\n\n\nShould the strict transform be empty in the first chart, and if so, would it be better to leave that chart out of the output?\n\nI also encountered an unrelated issue with applying change_ring to the transition maps when extending the base field. A simplified example of the problem is:\n\n\n```\nK.<a> = QuadraticField(-1)\nA.<x,y> = AffineSpace(K, 2)\nH = End(A)\nphi = H([x/y, y])\nemb = K.embeddings(QQbar)[0]\nphi.change_ring(emb)\n```\n\n\nwhich raises a `TypeError` without any description. This appears to only be an issue when there are actual fraction field elements defining the morphism. The line that breaks is `R = self.coordinate_ring().hom(R, T.ambient_space().coordinate_ring())` in the `change_ring` function for the SchemeMorphism_polynomial class of generic/morphism.py. Is this actually a bug, or perhaps am I just misusing the functionality?",
    "created_at": "2016-08-18T06:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287879",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Ok, I generalized the blowup() function to work for arbitrary points. This simplified some of the code in resolution_of_singularities since there's no longer a need to keep track of change of coordinate maps used to move points to the origin. However, I ran into a couple of issues when testing some higher dimension examples.

It seems that the way I was trying to isolate the strict transforms of the curves wrt the blow ups isn't always sufficient for higher dimension curves, and sometimes the resulting curves would be reducible even though the original curves were irreducible. To address this, the blowup() function now looks at the irreducible components of the transformed curve (after substituting the relations that hold in a particular chart of the blowup) and ignores any component that lies within the exceptional divisor.

In implementing the above I noticed another issue which occurs when the transform of the curve coincides with the exceptional divisor. An example of this is when blowing up the line `x` at the origin; in one of the charts the transformed line and the exceptional divisor both seem to be defined by `x`. If I understand correctly the strict transform is the closure of the preimage by the projection map of the line minus the origin, which I think should be empty in that chart. The output in the current implementation is:


```
A.<x,y> = AffineSpace(QQ, 2)
C = A.curve([x])
C.blowup([0,0])[0]
(Closed subscheme of Affine Space of dimension 2 over Rational Field
defined by: 1, Affine Plane Curve over Rational Field defined by s0)
```


Should the strict transform be empty in the first chart, and if so, would it be better to leave that chart out of the output?

I also encountered an unrelated issue with applying change_ring to the transition maps when extending the base field. A simplified example of the problem is:


```
K.<a> = QuadraticField(-1)
A.<x,y> = AffineSpace(K, 2)
H = End(A)
phi = H([x/y, y])
emb = K.embeddings(QQbar)[0]
phi.change_ring(emb)
```


which raises a `TypeError` without any description. This appears to only be an issue when there are actual fraction field elements defining the morphism. The line that breaks is `R = self.coordinate_ring().hom(R, T.ambient_space().coordinate_ring())` in the `change_ring` function for the SchemeMorphism_polynomial class of generic/morphism.py. Is this actually a bug, or perhaps am I just misusing the functionality?



---

archive/issue_comments_287880.json:
```json
{
    "body": "Yes, that is a bug. In that case the coordinate ring of the map was a fraction field, so it failed to create the hom. It is now fixed in #21285, which needs review.",
    "created_at": "2016-08-18T14:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287880",
    "user": "https://github.com/bhutz"
}
```

Yes, that is a bug. In that case the coordinate ring of the map was a fraction field, so it failed to create the hom. It is now fixed in #21285, which needs review.



---

archive/issue_comments_287881.json:
```json
{
    "body": "This is getting a little beyond my expertise, but what are describing sounds correct to me. As for what to do with the empty chart. I would prefer to return it so that there are 'right' number of charts. It is clearly empty based on the defining equations.\n\nFor the blow-up at points. A couple things. While it is fine to accept a list as input and do the coercision in the function, I think it would be better to pass in actual points in the examples, maybe a curve point for one and an affine space point for another. Also, I'd like to see it default to the origin, so that the point parameter is optional.",
    "created_at": "2016-08-18T15:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287881",
    "user": "https://github.com/bhutz"
}
```

This is getting a little beyond my expertise, but what are describing sounds correct to me. As for what to do with the empty chart. I would prefer to return it so that there are 'right' number of charts. It is clearly empty based on the defining equations.

For the blow-up at points. A couple things. While it is fine to accept a list as input and do the coercision in the function, I think it would be better to pass in actual points in the examples, maybe a curve point for one and an affine space point for another. Also, I'd like to see it default to the origin, so that the point parameter is optional.



---

archive/issue_comments_287882.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-18T15:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287882",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_287883.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-19T08:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287883",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287884.json:
```json
{
    "body": "Alright, I made the changes and did some more functionality testing. So far everything seems to be working as intended on the examples I've come up with, and I think this should be good for review again.\n\nI've also been trying to implement a projective blow up function; for a projective curve defined by `f_1,...,f_m` in `P^n`, I was thinking to use the ideal generated by `f_1,...,f_m, x_i*y_j - x_j*y_i` for `i,j = 0,...,n-1` in the product space `P^n\\times P^{n-1}` to define the blow up of the curve at the point `(0:...:0:1)`, where the `x_i` are the coords for `P^n` and the `y_i` are the coords for `P^{n-1}`. However I'm not sure this is actually the correct ideal, and think it might be better to leave implementing projective blow ups at points for when more general functionality for blowing up along subschemes is implemented.",
    "created_at": "2016-08-21T23:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287884",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Alright, I made the changes and did some more functionality testing. So far everything seems to be working as intended on the examples I've come up with, and I think this should be good for review again.

I've also been trying to implement a projective blow up function; for a projective curve defined by `f_1,...,f_m` in `P^n`, I was thinking to use the ideal generated by `f_1,...,f_m, x_i*y_j - x_j*y_i` for `i,j = 0,...,n-1` in the product space `P^n\times P^{n-1}` to define the blow up of the curve at the point `(0:...:0:1)`, where the `x_i` are the coords for `P^n` and the `y_i` are the coords for `P^{n-1}`. However I'm not sure this is actually the correct ideal, and think it might be better to leave implementing projective blow ups at points for when more general functionality for blowing up along subschemes is implemented.



---

archive/issue_comments_287885.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-21T23:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287885",
    "user": "https://trac.sagemath.org/admin/accounts/users/gjorgenson"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_287886.json:
```json
{
    "body": "This seems fine to me, so I'll mark it positive.\n\nAs for the projective blow-up. Those equations don't really make a lot of sense. I was trying to think of a general form for a projective blow-up, but really, this is a local object and the most natural way to think of it is through affine charts anyway.\n\nSo I'm fine with holding off on projective blow-ups.",
    "created_at": "2016-08-22T16:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287886",
    "user": "https://github.com/bhutz"
}
```

This seems fine to me, so I'll mark it positive.

As for the projective blow-up. Those equations don't really make a lot of sense. I was trying to think of a general form for a projective blow-up, but really, this is a local object and the most natural way to think of it is through affine charts anyway.

So I'm fine with holding off on projective blow-ups.



---

archive/issue_comments_287887.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-22T16:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287887",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_287888.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-24T06:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287888",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_019773.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-08-24T06:45:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20848#event-19773"
}
```



---

archive/issue_comments_287889.json:
```json
{
    "body": "Any chance some of you have a look at #17254#comment:364 ?\nWith the Singular upgrade a few signs changed in the doctests from here and we have no idea if the result is still valid (although it does not look obviously false).",
    "created_at": "2016-09-07T14:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20848#issuecomment-287889",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Any chance some of you have a look at #17254#comment:364 ?
With the Singular upgrade a few signs changed in the doctests from here and we have no idea if the result is still valid (although it does not look obviously false).
