# Issue 22869: Python scripts in src/bin are not ready for Sage + Python 3

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2017-05-30 21:01:07

CC:  jdemeyer embray

Many of the scripts in `src/bin` start with `#!/usr/bin/env python` (which is Python 2) and then try to import from the Sage library. This will not work if Sage has been installed using `SAGE_PYTHON3=yes`.

These scripts need modification, and perhaps there are others:

- sage-cython: `from sage.env import SAGE_SRC` -- could be modified to avoid this import, for example using `os.getenv('SAGE_SRC')`

- sage-eval

- sage-fixdoctests

- sage-ipython: particularly important, since it is used to run Sage.

- sage-list-packages

- sage-notebook

- sage-preparse

- sage-rst2sws

- sage-rst2txt

- sage-run-cython

- sage-runtests

- sage-startuptime.py

- sage-sws2rst



---

Comment by chapoton created at 2017-05-31 12:20:52

Indeed,

```
git grep -c "from sage"
sage-cython:1
sage-env-config.in:1
sage-eval:3
sage-fixdoctests:2
sage-ipython:1
sage-list-packages:1
sage-notebook:5
sage-preparse:3
sage-rst2sws:3
sage-rst2txt:1
sage-run-cython:2
sage-runtests:1
sage-startuptime.py:1
sage-sws2rst:1
```

some of these are in fact `from sagenb` imports


---

Comment by jhpalmieri created at 2017-05-31 22:47:11

- sage-notebook, sage-rst2sws, sage-rst2txt, sage-sws2rst: I would say that we don't touch these files. They all use SageNB, which is not (yet?) compatible with Python 3. SageNB is also slowly being phased out, which makes these a lower priority anyway.

- sage-env-config.in is a false positive: it is a shell script and does no importing of Python modules.

- sage-cython is easy to fix:

```diff
diff --git a/src/bin/sage-cython b/src/bin/sage-cython
index 77ba303b39..ffff293ca2 100755
--- a/src/bin/sage-cython
+++ b/src/bin/sage-cython
`@``@` -3,7 +3,9 `@``@`
 import os, sys
 args = sys.argv[1:]
 
-from sage.env import SAGE_SRC
+if "SAGE_SRC" not in os.environ:
+    raise RuntimeError("The environment variable SAGE_SRC must be set.")
+SAGE_SRC = os.environ["SAGE_SRC"]
 
 # args can have length 0, in case we're printing a usage message (see trac 12207)
 pyx_file = os.path.abspath(args[-1]) if len(args) else None
```


The others may depend on how we approach the Sage + Python 3 runtime question. If we follow the model at #23119, we can create scripts `sage3-eval`, `sage3-preparse`, etc., and call those from the main `sage` script. (The model that I propose at #23119 is that there is a top-level script called "sage", as now, plus a symlink to it called "sage3". They essentially call `src/bin/$0`, which translates to `src/bin/sage` or `src/bin/sage3`, one of which is a symlink of the other. Then that script can call `$0-eval`, `$0-preparse`, etc.)


---

Comment by chapoton created at 2017-08-18 07:44:19

any progress here ?


---

Comment by chapoton created at 2017-08-19 16:31:23

I made #23653 for sage-cython


---

Comment by embray created at 2017-08-21 13:05:37

Most of these just need to be fixed to use `#!/usr/bin/env sage-python23` no?


---

Comment by chapoton created at 2017-08-21 14:14:52

I had the same idea, but was rather not sure of its validity. Here is a branch doing that.
----
New commits:


---

Comment by chapoton created at 2017-08-21 19:51:08

This seems to work smoothly. What do you think ?


---

Comment by chapoton created at 2017-08-21 19:51:08

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-08-22 08:57:18

Should we do the same for the remaining 4

```
sage-notebook
sage-rst2sws
sage-rst2txt
sage-sws2rst
```

?


---

Comment by vdelecroix created at 2017-08-22 11:26:41

naive question: why is `python` pointing to `python2` if Sage has been built with `SAGE_PYTHON3=yes`!?


---

Comment by chapoton created at 2017-08-22 12:31:18

I think Volker once said that one should rather always let python point to python2.

See #22582#comment:31


---

Comment by jhpalmieri created at 2017-08-22 15:13:56

I view `sage-python23` as a build-time tool. Actually, I view the setting of `SAGE_PYTHON3` as something which only affects the Sage build, not necessarily how things are run. The Sage community has not made any decisions about how to actually run Sage using Python 3. As a result, I am somewhat wary of just using `sage-python23` everywhere. I tried to explain this in comment:2.


---

Comment by embray created at 2017-08-24 10:10:14

Replying to [comment:11 chapoton]:
> I think Volker once said that one should rather always let python point to python2.
> 
> See #22582#comment:31

I don't think that makes any sense. It won't be *that* long before Python 2 is deprecated and removed entirely.  `python` should just be whatever the default python is.


---

Comment by embray created at 2017-08-24 10:13:35

Replying to [comment:12 jhpalmieri]:
> I view `sage-python23` as a build-time tool. Actually, I view the setting of `SAGE_PYTHON3` as something which only affects the Sage build, not necessarily how things are run. The Sage community has not made any decisions about how to actually run Sage using Python 3. As a result, I am somewhat wary of just using `sage-python23` everywhere. I tried to explain this in comment:2.

That's a fair point. I think you're right--better it just be `/usr/bin/env python`.  I don't think it makes sense to have side-by-side Python 2 and Python 3 installations of Sage, or the ability to switch between on the fly.  That may be slightly convenient for working on Python 3 compatibility _development_, but that only affects a few people who can probably afford to have two separate builds for those purposes.  One thing I am working with "abstract package" support is a better way (better than setting `SAGE_PYTHON3=yes`) to select the default Python at `./configure` time, but changing that selection still requires a rebuild of anything that depends on Python.


---

Comment by jhpalmieri created at 2017-08-24 15:27:15

Replying to [comment:13 embray]:
> Replying to [comment:11 chapoton]:
> > I think Volker once said that one should rather always let python point to python2.
> > 
> > See #22582#comment:31
> 
> I don't think that makes any sense. It won't be *that* long before Python 2 is deprecated and removed entirely.  `python` should just be whatever the default python is.

To clarify, it's not just that Volker once said it, it's [PEP 394](https://www.python.org/dev/peps/pep-0394/).


---

Comment by embray created at 2017-08-25 15:38:52

Boy, that PEP is a mess.  But I agree it makes sense, for shebang lines at least, that `python2` or `python3` is always specified....


---

Comment by chapoton created at 2017-10-15 07:46:09

This would now start to be really very useful (as sage starts with python3 using the experimental branch).


---

Comment by jhpalmieri created at 2017-10-20 18:50:00

Replying to [comment:17 chapoton]:
> This would now start to be really very useful (as sage starts with python3 using the experimental branch).

I think we need to make a design decision before we can make progress on this ticket. Once you set `SAGE_PYTHON3=yes` (or set the appropriate configure flag, some time in the future), does that forever "pollute" the Sage scripts so that they use python3, or do we want to somehow allow python2 and python3 builds to live side by side? If the former, we need to either save the setting so that future incremental builds in the same directory continue to use SAGE_PYTHON3=yes, or we let users shoot themselves in the foot by building with Python 3 and then a few weeks later upgrading matplotlib and forgetting to set the variable, so it tries to use Python 2 and something goes horribly wrong.

There are a few Sage packages which depend on Python and build libraries which do not reside in `local/lib/python$VERSION/`, and those present obstacles to side-by-side builds.


---

Comment by embray created at 2017-10-23 08:54:55

From a development perspective there's a convenience to allowing simultaneous Python 2 and Python 3 installations to live side-by-side.  But currently this doesn't even work since some libraries, such as Pynac, can't be be installed with Python 2 and Python 3 support simultaneously (this could be fixed, for example, by attaching the Python version to the SONAME of the library, but I don't think that's currently supported).

That said, from a more general user perspective I don't think there's much advantage.  I think it will be much, much simpler if `SAGE_PYTHON3` is treated solely as a built-time variable that indicates what Python should be used to build and run Sage.  And of course it should really be replaced with a `./configure` flag.  I think that makes the whole affair much, much simpler.

One thing that should still be possible is re-configuring with a different `--with-python=` flag, and rebuilding with that Python.  I had some success making that work in my experimental ticket #23465.


---

Comment by chapoton created at 2018-01-09 19:26:40

Changing priority from critical to major.


---

Comment by embray created at 2018-01-10 13:06:08

I've fixed quite a number of these in my branch just by changing the shebang lines to use `sage-python23`.  There _might_ be some cases where this isn't appropriate, but I've found it to b the right way to go in most cases.


---

Comment by embray created at 2018-01-10 13:07:34

Certainly the fixes in the branch attached to this ticket are a good start.  I think we should go ahead and merge it, and leave bigger questions for a separate ticket.


---

Comment by chapoton created at 2018-01-10 13:08:56

so, positive review ?


---

Comment by embray created at 2018-01-10 13:15:40

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-01-10 13:15:40

For me, yeah. I just wasn't sure if there were other objections.


---

Comment by jhpalmieri created at 2018-01-10 18:25:19

To the extent that we want to separate the build process from the runtime process, this should be a temporary solution, right? We either shouldn't be calling `sage-python23` from runtime pieces (since `sage-python23` lives in `build/bin`) or we should move it or have a new script in `src/bin` which does something similar.


---

Comment by vbraun created at 2018-01-13 22:43:00

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-01-13 22:43:00


```
sage -t --long --warn-long 78.8 src/sage/misc/gperftools.py
**********************************************************************
File "src/sage/misc/gperftools.py", line 244, in sage.misc.gperftools.Profiler._executable
Failed example:
    prof._executable()
Expected:
    '.../python'
Got:
    '/mnt/disk/home/release/Sage/local/bin/python2'
**********************************************************************
1 item had failures:
   1 of   4 in sage.misc.gperftools.Profiler._executable
    [36 tests, 1 failure, 0.94 s]
```



---

Comment by git created at 2018-01-16 09:30:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-01-16 09:30:59

New commits:
----
New commits:


---

Comment by chapoton created at 2018-01-16 09:30:59

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-01-16 14:05:33

That fix won't work on Python 3--just put `.../python...` (and consider squashing)


---

Comment by embray created at 2018-01-16 14:05:33

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-01-16 14:08:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-01-16 14:08:58

done
----
New commits:
----
New commits:


---

Comment by embray created at 2018-01-16 14:17:11

Thanks!


---

Comment by embray created at 2018-01-16 14:17:11

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-01-16 14:20:08

Replying to [comment:25 jhpalmieri]:
> To the extent that we want to separate the build process from the runtime process, this should be a temporary solution, right? We either shouldn't be calling `sage-python23` from runtime pieces (since `sage-python23` lives in `build/bin`) or we should move it or have a new script in `src/bin` which does something similar.

I don't particularly care where the scripts live in the source code--I think that scripts are needed at build time living in `src/bin` makes sense, but don't have strong opinions about it.

All that matters to me is what happens at installation.  I think all scripts in `build/bin` should be installed to `$SAGE_LOCAL/bin`.  Similarly I'm of the opinion that most other files in `build/` should be installed somewhere under `$SAGE_LOCAL` so that, for example, one can install new packages for Sage at runtime without having a full sage source tree lying around.  That is, package installations and upgrades fully become a "runtime" feature of Sage.  That's all a much bigger topic beyond this though.


---

Comment by vbraun created at 2018-01-18 18:09:28

Resolution: fixed
