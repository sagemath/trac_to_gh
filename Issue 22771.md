# Issue 22771: floor of NumberFieldElement_quadratic broken

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2017-05-16 09:32:53

CC:  vdelecroix

This is fine:

```
sage: K.<phi> = NumberField(z^2-z-1, 'phi')
sage: floor(phi)
1
```


This is weird:

```
sage: K.<phi> = NumberField(z^2-z-1, 'phi', embedding=QQbar(golden_ratio))
sage: floor(phi)
-1
```


A workaround:

```
sage: phi.n()
1.61803398874989
sage: floor(phi.n())
1
```



---

Comment by chapoton created at 2017-09-03 19:33:37

This could be related to

```
sage: z=polygen(QQ,'z')
sage: K.<phi> = NumberField(z^2-z-1, 'phi', embedding=QQbar(golden
....: _ratio))
sage: K._standard_embedding
False
```

which is True in the 2 other cases.


---

Comment by vdelecroix created at 2017-09-03 20:10:25

Indeed! The constructor of `NumberField_quadratic` got confused (line 10556 of `sage/rings/number_field/number_field.py`)

```
    # we must set the flag _standard_embedding *before* any element creation
    # Note that in the following code, no element is built.
    emb = self.coerce_embedding()
    if emb is not None:
        rootD = number_field_element_quadratic.NumberFieldElement_quadratic(self, (QQ(0),QQ(1)))
        if D > 0:
            from sage.rings.real_double import RDF
            self._standard_embedding = RDF.has_coerce_map_from(self) and RDF(rootD) > 0
        else:
            from sage.rings.complex_double import CDF
            self._standard_embedding = CDF.has_coerce_map_from(self) and CDF(rootD).imag() > 0
```


I think that the simplest solution would be to promote (real) `QQbar` embeddings to `AA` embeddings.


---

Comment by vdelecroix created at 2017-12-16 16:15:17

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-12-16 16:15:17

New commits:


---

Comment by chapoton created at 2017-12-17 20:34:44

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-12-17 20:34:44

green bot and looks good


---

Comment by vbraun created at 2017-12-22 23:29:38

Resolution: fixed
