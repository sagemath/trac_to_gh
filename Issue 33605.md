# Issue 33605: Test ticket: Python 3.11

Issue created by migration from https://trac.sagemath.org/ticket/33842

Original creator: mkoeppe

Original creation time: 2022-05-12 02:48:43

CC:  fbissey arojas nbruin dimpase jhpalmieri




---

Comment by mkoeppe created at 2022-05-12 03:06:00

It builds. First failure: building cython - we need to wait for a version with 3.11 support - https://github.com/cython/cython/commits/0.29.x
----
New commits:


---

Comment by mkoeppe created at 2022-05-18 00:20:01

Cython update in #33864


---

Comment by git created at 2022-05-18 04:19:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-18 04:44:17


```
  [pyzmq-22.3.0]       #include "longintrepr.h"
  [pyzmq-22.3.0]                ^~~~~~~~~~~~~~~
  [pyzmq-22.3.0]     1 error generated.
```

same error as in memory_allocator


---

Comment by mkoeppe created at 2022-05-18 04:46:28

Fix is in 23.0.0 (still beta) https://pyzmq.readthedocs.io/en/latest/changelog.html
https://pypi.org/project/pyzmq/#history


---

Comment by mkoeppe created at 2022-05-18 04:47:30

cypari2:

```
  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -I./cypari2 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/site-packages/cysignals -I/usr/local/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/include/python3.11 -c cypari2/convert.c -o build/temp.macosx-12.4-x86_64-3.11/cypari2/convert.o
  cypari2/convert.c:3347:21: error: cannot take the address of an rvalue of type 'Py_ssize_t' (aka 'long')
    __pyx_v_sizeptr = &Py_SIZE(((PyObject *)__pyx_v_x));
                      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  1 error generated.
```



---

Comment by mkoeppe created at 2022-05-18 04:57:47


```
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/var/tmp/sage/build/jupyter_jsmol-0.2.4/src/setupbase.py", line 630, in _compile_pattern
      return re.compile(res, flags=flags).match
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py", line 225, in compile
      return _compile(pattern, flags)
             ^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py", line 273, in _compile
      p = _compiler.compile(pattern, flags)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_compiler.py", line 759, in compile
      p = _parser.parse(p, flags)
          ^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 979, in parse
      p = _parse_sub(source, state, flags & SRE_FLAG_VERBOSE, 0)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 454, in _parse_sub
      itemsappend(_parse(source, state, verbose, nested + 1,
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 840, in _parse
      raise source.error('global flags not at the start '
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  re.error: global flags not at the start of the expression at position 52
  error: subprocess-exited-with-error
```



---

Comment by malb created at 2022-05-18 10:28:46

This should be fixed in FPyLLL upstream. I can cut new packages?


---

Comment by mkoeppe created at 2022-05-18 15:20:05

Yes please!


---

Comment by git created at 2022-05-27 05:03:55

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by malb created at 2022-05-27 15:40:58

See #33913 for FP(y)LLL


---

Comment by git created at 2022-05-27 21:30:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-06-05 18:52:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-07-10 22:40:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-07-10 23:48:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-10 23:49:26

With 3.11.0b3, another problem with fpylll

```
  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -Isrc/fpylll/fplll -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/cysignals -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/numpy/core/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11 -c build/src/fpylll/fplll/integer_matrix.cpp -o build/temp.macosx-12.4-x86_64-cpython-311/build/src/fpylll/fplll/integer_matrix.o -std=c++11 -g -O2
  In file included from build/src/fpylll/fplll/integer_matrix.cpp:47:
  In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/Python.h:38:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:47:24: error: cannot cast from type 'int' to pointer type '_object *'
                  return static_cast<type>(const_cast<expr_type &>(expr));
                         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  build/src/fpylll/fplll/integer_matrix.cpp:22142:9: note: in instantiation of function template specialization '(anonymous namespace)::_Py_CAST_impl<_object *, int>' requested here
          PyTuple_SET_ITEM(args, 0, 0);
          ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/cpython/tupleobject.h:40:49: note: expanded from macro 'PyTuple_SET_ITEM'
      PyTuple_SET_ITEM(_PyObject_CAST(op), index, _PyObject_CAST(value))
                                                  ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/object.h:107:28: note: expanded from macro '_PyObject_CAST'
  #define _PyObject_CAST(op) _Py_CAST(PyObject*, (op))
                             ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:51:32: note: expanded from macro '_Py_CAST'
  #  define _Py_CAST(type, expr) _Py_CAST_impl<type>(expr)
                                 ^
  1 error generated.
  error: command '/usr/bin/gcc' failed with exit code 1
```



---

Comment by git created at 2022-07-26 04:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-26 04:35:06

Replying to [comment:27 mkoeppe]:
> With 3.11.0b3, another problem with fpylll

This problem has disappeared with 3.11.0b4


---

Comment by git created at 2022-07-27 00:16:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-09 06:49:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-02 06:22:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tornaria created at 2022-10-17 03:25:38

Patch for python-3.11 (see `python-3.11.patch` at https://github.com/void-linux/void-packages/commit/6229f313450ecae88743b4d5e99da2ed4de44e07):

```
--- a/src/sage/cpython/cython_metaclass.h
+++ b/src/sage/cpython/cython_metaclass.h
@@ -66,7 +66,7 @@
         }
 
         /* Now, set t.__class__ to metaclass */
-        Py_TYPE(t) = metaclass;
+        Py_SET_TYPE(t, metaclass);
         PyType_Modified(t);
     }
     else
--- a/src/sage/symbolic/ginac/numeric.cpp
+++ b/src/sage/symbolic/ginac/numeric.cpp
@@ -52,7 +52,6 @@
 #define register
 #define PY_SSIZE_T_CLEAN
 #include <Python.h>
-#include <longintrepr.h>
 #include "flint/fmpz.h"
 #include "flint/fmpz_factor.h"
 
--- a/src/sage/libs/gmp/pylong.pyx
+++ b/src/sage/libs/gmp/pylong.pyx
@@ -32,7 +32,7 @@
 from .mpz cimport *
 
 cdef extern from *:
-    Py_ssize_t* Py_SIZE_PTR "&Py_SIZE"(object)
+    void Py_SET_SIZE(object, Py_ssize_t)
     int hash_bits """
         #ifdef _PyHASH_BITS
         _PyHASH_BITS         /* Python 3 */
@@ -57,10 +57,8 @@
     mpz_export(L.ob_digit, NULL,
             -1, sizeof(digit), 0, PyLong_nails, z)
     if mpz_sgn(z) < 0:
-        # Set correct size (use a pointer to hack around Cython's
-        # non-support for lvalues).
-        sizeptr = Py_SIZE_PTR(L)
-        sizeptr[0] = -pylong_size
+        # Set correct size
+        Py_SET_SIZE(L, -pylong_size)
     return L
 
 
```



---

Comment by mkoeppe created at 2022-10-17 03:29:47

I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8


---

Comment by mkoeppe created at 2022-10-25 03:30:25

Changing priority from major to critical.


---

Comment by git created at 2022-10-26 04:57:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-26 04:59:46

Next error (on startup):

```
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/decorators.py", line 35, in <module>
    from inspect import ArgSpec
ImportError: cannot import name 'ArgSpec' from 'inspect' (/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0/lib/python3.11/inspect.py)
```



---

Comment by mkoeppe created at 2022-10-26 05:05:55

Also

```
  File "sage/misc/cachefunc.pyx", line 2821, in sage.misc.cachefunc.CachedMethod.__get__
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/sageinspect.py", line 1720, in sage_getargspec
    return inspect.ArgSpec(*_sage_getargspec_cython(source))
           ^^^^^^^^^^^^^^^
AttributeError: module 'inspect' has no attribute 'ArgSpec'
```



---

Comment by mkoeppe created at 2022-10-26 05:12:44

From https://docs.python.org/3.11/whatsnew/3.11.html:

  Removed from the inspect module:

  - The getargspec() function, deprecated since Python 3.0; use inspect.signature() or inspect.getfullargspec() instead.

  - The formatargspec() function, deprecated since Python 3.5; use the inspect.signature() function or the inspect.Signature object directly.

See #31309, #30884


---

Comment by git created at 2022-10-26 05:53:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-26 06:41:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-27 00:02:38

Hangs in this doctest:

```
Trying (line 1258):    @weak_cached_function(cache=0)
    def f():
        print("doing a computation")
        return A()
Expecting nothing
ok [0.00 s]
Trying (line 1262):    a = f()
Expecting:
    doing a computation
ok [0.00 s]
Trying (line 1267):    b = f()
Expecting nothing
ok [0.00 s]
Trying (line 1268):    a is b
Expecting:
    True
ok [0.00 s]
Trying (line 1274):    del a
Expecting nothing
ok [0.00 s]
Trying (line 1275):    del b
Expecting nothing
^CKilling test pkgs/sagemath-categories/.tox/sagepython-sagewheels-nopypi-norequirements/lib/python3.11/site-packages/sage/misc/cachefunc.pyx
```



---

Comment by git created at 2022-10-27 00:02:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-27 00:09:51

This likely comes from our weak dictionaries. Running `sage -t --verbose src/sage/misc/weak_dict.pyx` gives:

```
Trying (line 53):    import sage.misc.weak_dict
Expecting nothing
ok [0.00 s]
Trying (line 54):    D = sage.misc.weak_dict.WeakValueDictionary()
Expecting nothing
ok [0.00 s]
Trying (line 55):    for v in ValList:
        D[Keys(v)] = v
Expecting nothing
ok [0.00 s]
Trying (line 57):    len(D)
Expecting:
    10
ok [0.00 s]
Trying (line 59):    del ValList
Expecting nothing
    Killed due to segmentation fault
```



---

Comment by mkoeppe created at 2022-10-27 01:23:06

The layout of dictionaries has changed from 3.10 to 3.11, so src/sage/cpython/dict_del_by_value.pyx will have to be changed


---

Comment by mkoeppe created at 2022-10-27 01:35:58

A previous ticket involving `del_dictitem_by_exact_value`: #28941


---

Comment by @collares created at 2022-10-28 16:49:02

Should `build/pkgs/cypari/patches/trashcan.patch` really be fully removed? Upstream Cython applied a patch (https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92) which replaces the change in `Cython/Utility/ExtensionTypes.c` by the upstream trashcan support, but keeps the `Cython/Compiler/*` trashcan uses added by the original patch untouched.


---

Comment by mkoeppe created at 2022-10-28 17:10:18

That sounds like a better solution, please feel free to push to the branch


---

Comment by mkoeppe created at 2022-10-29 21:17:48

Shouldn't we make this change in cypari2 itself?


---

Comment by tornaria created at 2022-10-30 18:39:03

Replying to [comment:37 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)||`build/pkgs/cypari: Update to 2.1.3`||

Where is cypari 2.1.3? I can't seem to find it. Although the version in the git repo was bumped to 2.1.3 in oct 3, there is no tag. And `https://pypi.io/packages/source/c/cypari2/cypari2-2.1.3.tar.gz` (which, if IIUC, is the URL after this patch) gives 404.

I built sagemath with python 3.11 (using the patch I posted earlier + the patch to fix inspect.argspec). Running sage hangs forever, I'm guessing I have to update cypari2 but I can't find the tarball for 2.1.3.


---

Comment by fbissey created at 2022-10-30 21:46:10

I pushed to sage-on-gentoo master for 9.8.beta3 with a patch for python 3.11 tailored from this branch. This was a bit of a mistake as it broke doc building with python 3.10 (and may be more).
https://github.com/cschwan/sage-on-gentoo/issues/724

What I learned today is that the current branch is not backward compatible :(


---

Comment by fbissey created at 2022-10-30 21:59:48

Actually, I said it was breaking doc building with 3.10, but has anyone build the doc with python 3.11? I may be jumping the gun on backward compatibility, it may just be broken :(


---

Comment by mkoeppe created at 2022-10-30 22:10:31

See comment:35 - current changes here on the branch need to be conditionalized on python >= 3.11


---

Comment by mkoeppe created at 2022-10-30 22:11:12

And comment:48 is still open - this requires major work


---

Comment by mkoeppe created at 2022-10-30 22:12:11

Replying to [comment:53 Gonzalo Tornaría]:
> Replying to [comment:37 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)||`build/pkgs/cypari: Update to 2.1.3`||
> 
> Where is cypari 2.1.3?

I built it from the master branch of cypari2 but did not upload it to PyPI because I haven't tested it yet


---

Comment by fbissey created at 2022-10-30 22:13:14

Replying to [comment:57 Matthias Köppe]:
> And comment:48 is still open - this requires major work

OK, I think this is stuff that breaks the doc building. I think we can infer that from the error messages.


---

Comment by tornaria created at 2022-10-30 23:07:01

I upgraded cypari to 2.1.3 and fixed running tests (see comment:79:ticket:34537).

But I can't even get sage started at all... What am I missing?

Is there a patch to cysignals that I should be applying (I'm using 1.11.2).

On startup I get a backtrace that starts with

```
------------------------------------------------------------------------
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8170)[0x7fc24132e170]
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8228)[0x7fc24132e228]
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0xaa33)[0x7fc241330a33]
/usr/lib/libc.so.6(+0x3d000)[0x7fc241ec5000]
/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/cpython/dict_del_by_value.cpython-311-x86_64-linux-gnu.so(+0x429d)[0x7fc24040e29d]
/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/misc/weak_dict.cpython-311-x86_64-linux-gnu.so(+0xc815)[0x7fc24041f815]
```

So this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...


---

Comment by mkoeppe created at 2022-10-30 23:43:58

Replying to [comment:60 Gonzalo Tornaría]:
> So this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...

No, it does not start. I was testing using sagemath-categories, which loads much less stuff at startup; this helped isolate the problem.


---

Comment by tornaria created at 2022-10-31 01:53:03

Just to have a minimal test case, on python 3.10:

```
$ python -c 'from sage.cpython.dict_del_by_value import test_del_dictitem_by_exact_value ; D = {1:2} ; test_del_dictitem_by_exact_value(D,1,2); print(D); test_del_dictitem_by_exact_value(D,2,1); print(D)'
{1: 2}
{}
```

This hangs with python 3.11.

Note also that `dict_del_by_value.pyx` is completely independent of the rest of sage. In case this helps with logistics (e.g. I have python 3.11 in a particular chroot, and I've recompiled just the python packages )

Maybe it's easy to have a "stupid slow" implementation of `del_dictitem_by_exact_value` to keep moving forward?


---

Comment by tornaria created at 2022-10-31 03:28:57

Just to get going, this seems to do something (possibly a very dumb thing to do, but at least sage starts, I'm getting lots of doctest failures now):

```
diff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx
index d52bedacfa4..930aa31bd1b 100644
--- a/src/sage/misc/weak_dict.pyx
+++ b/src/sage/misc/weak_dict.pyx
@@ -216,7 +216,7 @@ cdef class WeakValueDictEraser:
         if D._guard_level:
             D._pending_removals.append(r)
         else:
-            del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>r, r.key)
+            pass
 
 
 cdef class WeakValueDictionary(dict):
```



---

Comment by tornaria created at 2022-10-31 03:40:54

This seems to get rid of a lot of deprecation warnings:

```
diff --git a/src/sage/rings/polynomial/pbori/gbrefs.py b/src/sage/rings/polynomial/pbori/gbrefs.py
index 76e3924715d..70dc795cbab 100644
--- a/src/sage/rings/polynomial/pbori/gbrefs.py
+++ b/src/sage/rings/polynomial/pbori/gbrefs.py
@@ -1,6 +1,6 @@
 import gzip
 from io import StringIO
-import uu
+import base64 as uu
 import re
 from types import ModuleType
 from .PyPolyBoRi import Polynomial
```



---

Comment by tornaria created at 2022-10-31 09:43:45


```
diff --git a/src/sage/misc/fpickle.pyx b/src/sage/misc/fpickle.pyx
index 502080e2c10..0532e5d2d38 100644
--- a/src/sage/misc/fpickle.pyx
+++ b/src/sage/misc/fpickle.pyx
@@ -44,7 +44,12 @@ def reduce_code(co):
     co_args += (co.co_kwonlyargcount, co.co_nlocals,
                 co.co_stacksize, co.co_flags, co.co_code,
                 co.co_consts, co.co_names, co.co_varnames, co.co_filename,
-                co.co_name, co.co_firstlineno, co.co_lnotab)
+                co.co_name)
+    if sys.version_info.minor >= 11:
+        co_args += (co.co_qualname,)
+    co_args += (co.co_firstlineno, co.co_lnotab)
+    if sys.version_info.minor >= 11:
+        co_args += (co.co_exceptiontable,)
 
     return (code_ctor, co_args)
 
```

This is a mess... it's not even clear where the arguments to `type.CodeType` are documented. I found them by running `type.CodeType?` on sage.


---

Comment by tornaria created at 2022-10-31 11:39:39


```
--- a/src/sage/all.py
+++ b/src/sage/all.py
@@ -104,6 +104,10 @@ warnings.filterwarnings('ignore', category=DeprecationWarning,
                         message='The distutils(.sysconfig module| package) is deprecated',
                         module='Cython|distutils|numpy|sage.env|sage.features')
 
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+                        message="'cgi' is deprecated and slated for removal in Python 3.13",
+                        module='Cython')
+
 ################ end setup warnings ###############################
 
 
```



---

Comment by tornaria created at 2022-10-31 11:41:05


```
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index c753f08232b..619ff6da661 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -1133,7 +1133,7 @@ def _sage_getargspec_from_ast(source):
 
     return inspect.FullArgSpec(args, vararg, kwarg,
                                tuple(defaults) if defaults else None,
-                               kwonlyargs=[], kwonlydefaults={}, annotations={})
+                               kwonlyargs=[], kwonlydefaults=None, annotations={})
 
 
 def _sage_getargspec_cython(source):
@@ -1679,7 +1679,8 @@ def sage_getargspec(obj):
         # Note that this may give a wrong result for the constants!
         try:
             args, varargs, varkw = inspect.getargs(obj.__code__)
-            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__)
+            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__,
+                                       kwonlyargs=[], kwonlydefaults=None, annotations={})
         except (TypeError, AttributeError):
             pass
     if isclassinstance(obj):
@@ -1738,7 +1739,7 @@ def sage_getargspec(obj):
     except AttributeError:
         defaults = None
     return inspect.FullArgSpec(args, varargs, varkw, defaults,
-                               kwonlyargs=[], kwonlydefaults={}, annotations={})
+                               kwonlyargs=[], kwonlydefaults=None, annotations={})
 
 
 def formatannotation(annotation, base_module=None):
@@ -1784,7 +1785,7 @@ def formatannotation(annotation, base_module=None):
 
 
 def sage_formatargspec(args, varargs=None, varkw=None, defaults=None,
-                       kwonlyargs=(), kwonlydefaults={}, annotations={},
+                       kwonlyargs=(), kwonlydefaults=None, annotations={},
                        formatarg=str,
                        formatvarargs=lambda name: '*' + name,
                        formatvarkw=lambda name: '**' + name,
```

plus lots of doctest fixing in `sageinspect.py` which I'm not pasting here.


---

Comment by tornaria created at 2022-11-01 03:17:54

I pushed all my patches in the branch `u/tornaria/py311`:

```
$ git log1 trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311 
6010f52588e (HEAD -> py311, trac/u/tornaria/py311) fix argspec -> fullargspec
21762fa3bc6 warnings: ignore deprecation of importlib.resources.path/read_binary
98598ba0aa3 doctest: message added more info in python 3.11
07acbc4509f doctest: AssertionError message changed in python 3.11
2a4ced7e1a1 changed argspec.keywords -> argspec.varkw
b09c738c6ed doctests: fix more due to ArgSpec -> FullArgSpec
a65553aae06 warnings: ignore deprecation for 'import sre_constants' in pyparsing
f91d711b3c2 Fix FullArgSpec calls after 9eb08f3afde3266bbd667e196513240a0fe245f4
14c91ec77de doctest: fix in sage.misc.sageinspect due to ArgSpec -> FullArgSpec
186d921e70c warnings: ignore deprecation for 'import cgi' in cython
0d34a14717c fix fpickle for python 3.11
a0078320c55 deprecated uu -> base64
bed2c03e6d5 don't use broken del_dictitem_by_exact_value (temporary?)
```


Only a a few remaining doctest failures, most (all?) seem related to the hack I did to get through the `WeakValueDictionary` problem.

If anyone can think of a good workaround (or a proper fix) for `WeakValueDictionary`... It seems void linux wants to upgrade python to 3.11 next week so we would get stuck with a broken sagemath.


---

Comment by tornaria created at 2022-11-01 03:33:22

Test failures remaining:

```
sage/structure/coerce_dict.pyx  # 1 doctest failed
sage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed
sage/misc/weak_dict.pyx  # 11 doctests failed
sage/cpython/dict_del_by_value.pyx  # Timed out
sage/symbolic/function.pyx  # RuntimeError in doctesting framework
```

The first four look related to the weak dict issue. The last one, I'm not sure.


---

Comment by tornaria created at 2022-11-02 12:12:56

Replying to [comment:35 Matthias Köppe]:
> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8

Is it really necessary to support 3.8? It seems the way deprecation/removal works in python is meant to support 3 versions (e.g. new feature added in 3.9, old feature removed in 3.11). There is a similar cadence with the deprecation `importlib.resources.{path,read_binary}`: these are deprecated in 3.11, but the alternative api (`importlib.resources.files`) was introduced in 3.9, so we can't rewrite the code now if we have to support 3.8.

As a point of reference, debian stable ships 3.9.


---

Comment by mkoeppe created at 2022-11-02 17:41:21

Replying to [comment:70 Gonzalo Tornaría]:
> Replying to [comment:35 Matthias Köppe]:
> > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8
> 
> Is it really necessary to support 3.8? 

Yes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table


---

Comment by mkoeppe created at 2022-11-02 17:42:05

For `importlib.resources`, a backport package is available.


---

Comment by tornaria created at 2022-11-02 20:21:12

Replying to [comment:71 Matthias Köppe]:
> Replying to [comment:70 Gonzalo Tornaría]:
> > Replying to [comment:35 Matthias Köppe]:
> > > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8
> > 
> > Is it really necessary to support 3.8? 
> 
> Yes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table

But Sage ships a vendored python so dropping support for python 3.8 does not make it unusable. I'd guess in a system with python 3.8, other python packages required by sage will also be outdated so the difference between using system python or the vendored in one is not that big.


---

Comment by tornaria created at 2022-11-02 20:28:50

Report on the remaining doctest failures:
 - Obviously caused by the change dicts in python 3.11:

```
sage/cpython/dict_del_by_value.pyx  # Timed out`
```

 - These are caused by "the hack" replacing calls to `del_dictitem_by_exact_value` by `pass`:

```
sage/structure/coerce_dict.pyx  # 1 doctest failed
sage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed
sage/misc/weak_dict.pyx  # 11 doctests failed
```

 In fact, I compiled my `u/tornaria/py311` branch using python 3.10 (so, with "the hack"), and I get the exact same failures (meaning all my changes are compatible at least with python 3.10).
 - A failure that is almost surely unrelated:

```
sage/symbolic/function.pyx  # RuntimeError in doctesting framework
```

 This failure does not happen with python 3.10 (even with "the hack"). I will comment more about this.


---

Comment by tornaria created at 2022-11-02 20:38:11

About the last failure, here's a one-liner that causes the runtime error:

```
sage: loads(dumps(function("foo", nargs=0, eval_func=lambda self:0)))()
Unexpected exception formatting exception. Falling back to standard exception
Unexpected exception formatting exception. Falling back to standard exception
Unexpected exception formatting exception. Falling back to standard exception
Error in sys.excepthook:
Traceback (most recent call last):
  File "/usr/lib/python3.11/pathlib.py", line 1250, in is_dir
    return S_ISDIR(self.stat().st_mode)
                   ^^^^^^^^^
AttributeError: 'str' object has no attribute 'stat'

Original exception was:
Traceback (most recent call last):
  File "/usr/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3378, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File "<ipython-input-1-5d60a76861b0>", line 1, in <module>
  File "sage/symbolic/function.pyx", line 547, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:6279)
  File "sage/symbolic/pynac_function_impl.pxi", line 1, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111832)
  File "sage/symbolic/pynac_function_impl.pxi", line 47, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111428)
  File "<ipython-input-1-5d60a76861b0>", line -1, in <lambda>
NameError: name 'Integer' is not defined

During handling of the above exception, another exception occurred:

...
```

If anybody has a clue... please help.

In case it's useful, here is another failure, may be caused by the same bug, that does not cause a runtime error:

```
sage: foo = function("foo", nargs=0, eval_func=lambda self:0)
sage: bar = loads(dumps(foo))
sage: bar == foo
False
```

Of course, the runtime error is there, lurking, if you just do `bar()` you get the same runtime error as above. I tried to follow the code for `bar()` but there's so many indirection layers that my head overflowed in the attempt.


---

Comment by tornaria created at 2022-11-02 21:52:53

I pushed a new commit to my branch `u/tornaria/py311` which fixes the issue from the previous comment:

```
8934024438e (trac/u/tornaria/py311) (corrected) fix fpickle for python 3.11
```

It turns out my previous fix for fpickle was incorrect (I missed that `co_lnotab` had to be changed to `co_linetable`).

I added a test that will (hopefully) catch other mistakes like this.

----

Now all that remains (it seems) is for someone to reimplement `del_dictitem_by_exact_value(...)`. Maybe there's a python way to acomplish the same (delete an item in a dict) even if it's a bit slower...

My hack (using pass) seems to behave ok, other than causing memory leaks. I'd happily trade a small slowdown for fixing this memory leaks. I wonder if there are any benchmarks that show how bad this really is...


---

Comment by tornaria created at 2022-11-03 13:31:13

This seems to work:

```
diff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx
index 930aa31bd1b..724f57f421c 100644
--- a/src/sage/misc/weak_dict.pyx
+++ b/src/sage/misc/weak_dict.pyx
@@ -139,6 +139,10 @@ cdef extern from "Python.h":
     PyObject* PyWeakref_GetObject(PyObject *ref)
     int PyTuple_SetItem(PyObject *op, Py_ssize_t i, PyObject *newitem) except -1
 
+    int _PyDict_DelItem_KnownHash(PyObject *mp, PyObject *key,
+                                  Py_hash_t hash) except -1
+    PyObject* _PyDict_GetItem_KnownHash(PyObject *mp, PyObject *key,
+                                        Py_hash_t hash)
 
 cdef class WeakValueDictEraser:
     """
@@ -212,11 +216,16 @@ cdef class WeakValueDictEraser:
             return
         # The situation is the following:
         # in the underlying dictionary, we have stored a KeyedRef r
-        # under a key k. The attribute r.key is the hash of k.
+        # under a key k. The attribute r.key is (k, hash(k))
         if D._guard_level:
             D._pending_removals.append(r)
         else:
-            pass
+            if _PyDict_GetItem_KnownHash(<PyObject *>D,
+                                         <PyObject *>r.key[0],
+                                         r.key[1]) == <PyObject *>r:
+                _PyDict_DelItem_KnownHash(<PyObject *>D,
+                                          <PyObject *>r.key[0],
+                                          r.key[1])
 
 
 cdef class WeakValueDictionary(dict):
@@ -548,7 +557,7 @@ cdef class WeakValueDictionary(dict):
         add a weak reference to ``v`` under the key ``k`` in the actual
         dict underlying ``self``.
         """
-        PyDict_SetItem(self, k, KeyedRef(v, self.callback, hash(k)))
+        PyDict_SetItem(self, k, KeyedRef(v, self.callback, (k, hash(k))))
 
     # def __delitem__(self, k):
     # we do not really have to override this method.
```


There's a double lookup, but it doesn't seem possible to avoid it using python API. But this seems to work as expected.

All tests pass on python 3.10 and 3.11. Can someone test 3.8 and 3.9? This is all pushed to my branch.

Note: I didn't touch `src/sage/cpython/dict_del_by_value.pyx` so expect (and ignore) a doctest timeout for that file on python 3.11.


---

Comment by tornaria created at 2022-11-04 12:35:35

Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:

```
**********************************************************************
File "/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/rings/finite_rings/residue_field.pyx", line 732, in sage.rings.finite_rings.residue_field.ResidueField_generic.lift_map
Failed example:
    R = QQ[3^(1/3)]
Expected nothing
Got:
    Exception ignored in: <sage.structure.coerce_dict.TripleDictEraser object at 0x7fa2fc27a050>
    Traceback (most recent call last):
      File "sage/structure/coerce_dict.pyx", line 979, in sage.structure.coerce_dict.TripleDictEraser.__call__ (build/cythonized/sage/structure/coerce_dict.c:6393)
    AssertionError: TripleDictEraser: key match but no weakref match
**********************************************************************
```

This only happens when the change of the previous comment is applied.
It looks like some kind of race condition. No clue. Someone please help/comment (Nils?).


---

Comment by tornaria created at 2022-11-06 21:05:41

Here is a current summary of my branch `u/tornaria/py311`:

```
$ git log1 --first-parent  trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311
7b6fa565f42 (trac/u/tornaria/py311) doctests: message added more info in python 3.11
482dd1ac3d2 doctests: AssertionError message changed in python 3.11
44480f4827e doctests: fixes due to ArgSpec -> FullArgSpec change
08e1161c23c warnings: ignore deprecation of importlib.resources.path/read_binary
664fc008ed5 warnings: ignore deprecation for 'import sre_constants' in pyparsing
db45aebfd6b warnings: ignore deprecation for 'import cgi' in cython
8b0dac2322d Fix FullArgSpec usage after 9eb08f3afde3266bbd667e196513240a0fe245f4
dc8e155994a sage.misc.fpickle: fix for python 3.11
014c2ac9a6f deprecated uu -> base64
76040803c8a dict_del_by_value: add internal definitions for python 3.11
8955607c71c dict_del_by_value: move python internal definitions to a separate file
274230f72fa Merge tag '9.8.beta3' into u/mkoeppe/test_ticket__python_3_11
```


With this, I have all tests passing, both python 3.10 (tested on this branch) and 3.11 (tested on sage 9.7).

One exception: there is one failure with python 3.10 in `src/sage/repl/attach.py` due to the last commit (7b6fa565f42). I used `...` to represent "0 or more random lines", but it seems it only represents "1 or more random lines".

In case it is useful, the changes I am applying to 9.7 are all commits listed above (except the merge) plus:

```
9eb08f3afde inspect.ArgSpec -> inspect.FullArgSpec
de38bac21e2 src/sage: Apply python-3.11.patch ...
```



---

Comment by tornaria created at 2022-11-06 21:11:46

Replying to [comment:35 Matthias Köppe]:
> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8

This is what `Doc/whatsnew/3.11.rst` (python source) has to say about it:

```
* Since :c:func:`Py_TYPE()` is changed to a inline static function,
  ``Py_TYPE(obj) = new_type`` must be replaced with
  ``Py_SET_TYPE(obj, new_type)``: see the :c:func:`Py_SET_TYPE()` function
  (available since Python 3.9). For backward compatibility, this macro can be
  used::

      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)
      static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)
      { ob->ob_type = type; }
      #define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)
      #endif

  (Contributed by Victor Stinner in :issue:`39573`.)

* Since :c:func:`Py_SIZE()` is changed to a inline static function,
  ``Py_SIZE(obj) = new_size`` must be replaced with
  ``Py_SET_SIZE(obj, new_size)``: see the :c:func:`Py_SET_SIZE()` function
  (available since Python 3.9). For backward compatibility, this macro can be
  used::

      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)
      static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)
      { ob->ob_size = size; }
      #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)
      #endif

  (Contributed by Victor Stinner in :issue:`39573`.)
```



---

Comment by tornaria created at 2022-11-06 22:02:55

Replying to [comment:78 Gonzalo Tornaría]:
> Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:
> {{{
> **********************************************************************
> ...
>     AssertionError: TripleDictEraser: key match but no weakref match
> **********************************************************************
> }}}
> This only happens when the change of the previous comment is applied.
> It looks like some kind of race condition. No clue. Someone please help/comment (Nils?).

A quick word about this. It seems `PyDict_GetItem*` and friends will be calling `PyObject_RichCompareBool` to compare keys, for some reason this is what breaks the `TripleDictEraser` (I guess when it happens inside a erase callback).

Anyway, I bite the bullet and refactored `del_dictitem_by_exact_value()` in a way that the "internal" python dict definitions needed are all in an external `.h` file //copied verbatim// from python sources. This makes it easier to port it in case of changes in python.  

```
76040803c8a dict_del_by_value: add internal definitions for python 3.11
8955607c71c dict_del_by_value: move python internal definitions to a separate file
```

Here the first commit 8955607c71c does the refactor using definitions copied from python 3.8 and should be functionally noop (still working for python <= 3.10, still broken for python 3.11). The second commit 76040803c8a only changes the external `.h` file to (conditionally) use definitions copied from python 3.11.


---

Comment by mkoeppe created at 2022-11-11 19:24:55

Last 10 new commits:


---

Comment by tornaria created at 2022-11-12 13:46:26

For the record: on void linux we are shipping sagemath 9.7 with python 3.11 (and pari 2.15, gap 4.12) everything seems in working order (x86_64, x86_64-musl, i686, as usual; unfortunately we don't have native builders for aarch64 and some dependencies of sagemath don't cross build).

In case it is useful, our patches:

https://github.com/void-linux/void-packages/tree/master/srcpkgs/sagemath/patches

All of them are in trac: #34669 #33360 #33446 #33842 #34118 #34391 #34465 #34537 #34668.


---

Comment by tornaria created at 2022-11-12 14:45:45

As per comment:80, something like the following should restore support for python 3.8, but I have not tested it. 



```
diff --git a/src/sage/cpython/cython_metaclass.h b/src/sage/cpython/cython_metaclass.h
index 6487342b71e..da06ab75a6b 100644
--- a/src/sage/cpython/cython_metaclass.h
+++ b/src/sage/cpython/cython_metaclass.h
@@ -8,6 +8,13 @@
 *                  http://www.gnu.org/licenses/
 *****************************************************************************/
 
+/* Compatibility for python 3.8, can be removed later */
+#if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)
+static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)
+{ ob->ob_type = type; }
+#define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)
+#endif
+
 /* Tuple (None, None, None), initialized as needed */
 static PyObject* NoneNoneNone;
 
diff --git a/src/sage/libs/gmp/pylong.pyx b/src/sage/libs/gmp/pylong.pyx
index e772b60e3e0..2f7ed35be9d 100644
--- a/src/sage/libs/gmp/pylong.pyx
+++ b/src/sage/libs/gmp/pylong.pyx
@@ -32,6 +32,14 @@ from cpython.longintrepr cimport _PyLong_New, py_long, digit, PyLong_SHIFT
 from .mpz cimport *
 
 cdef extern from *:
+    """
+    /* Compatibility for python 3.8, can be removed later */
+    #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)
+    static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)
+    { ob->ob_size = size; }
+    #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)
+    #endif
+    """
     void Py_SET_SIZE(object, Py_ssize_t)
     int hash_bits """
         #ifdef _PyHASH_BITS
```



---

Comment by git created at 2022-11-12 15:34:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-11-15 00:01:30

New commits:


---

Comment by git created at 2022-11-15 00:02:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-11-15 00:06:34

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-11-15 05:51:36


```
sage -t --random-seed=71448227821214997139645193792530764629 sage/repl/attach.py
**********************************************************************
File "sage/repl/attach.py", line 48, in sage.repl.attach
Failed example:
    try:
        attach(src)
    except Exception:
        traceback.print_exc(file=sys.stdout)
Expected:
    Traceback (most recent call last):
    ...
        exec(code, globals)
      File ".../foobar.sage....py", line ..., in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ...
    ValueError: third
Got:
    Traceback (most recent call last):
      File "<doctest sage.repl.attach[13]>", line 2, in <module>
        attach(src)
      File "sage/misc/lazy_import.pyx", line 404, in sage.misc.lazy_import.LazyImport.__call__
        return self.get_object()(*args, **kwds)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/attach.py", line 361, in attach
        load(filename, globals(), attach=True)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/load.py", line 266, in load
        exec(code, globals)
      File "/tmp/tmpjm2te3w7/foobar.sagelyxej7m9.py", line 7, in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ValueError: third
```



---

Comment by git created at 2022-11-15 05:54:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-11-15 05:56:13


```
[sagemath_doc_html-none] OSError: docstring of sage.misc.fpickle.reduce_code:9: WARNING: Inline emphasis start-string without end-string.
```



---

Comment by git created at 2022-11-15 05:56:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-11-15 07:22:49

Is comment:50 resolved?


---

Comment by git created at 2022-11-15 17:47:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sheerluck created at 2022-11-18 07:37:12

a lot of "slated for removal" messages


---

Comment by mkoeppe created at 2022-11-24 20:59:30

Replying to [comment:99 Andrew]:
> a lot of "slated for removal" messages

Yes, there's a lot of work ahead for python 3.12


---

Comment by mkoeppe created at 2022-11-24 21:09:06

Changing status from needs_review to needs_work.


---

Comment by @collares created at 2022-11-24 21:22:56

Sorry for not pushing the trashcan change. What I did on NixOS was to keep the original `trashcan.patch` that was removed here (well, [the upstream version](https://github.com/cython/cython/commit/f781880b6780117660b2026caadf4a6d7905722f.patch) but that shouldn't matter) and apply https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92.patch on top of it. I don't know if Sage-the-distro would merge the two patches or keep them separate.


---

Comment by git created at 2022-11-24 21:27:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-11-24 21:46:42

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-11-24 23:17:11

Let's get this in


---

Comment by tornaria created at 2022-11-25 01:27:07

We don't apply trashcan patches on void linux. What are we missing?


---

Comment by mkoeppe created at 2022-11-25 01:34:27

see #27267


---

Comment by mkoeppe created at 2022-11-25 02:15:06

Replying to [comment:99 Andrew]:
> a lot of "slated for removal" messages

"imghdr is deprecated and slated for removal in Python 3.13" - https://github.com/sphinx-doc/sphinx/issues/10440 (no upstream fix yet)


---

Comment by mkoeppe created at 2022-11-25 02:17:37


```
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.11/lib/python3.11/site-packages/babel/messages/catalog.py", line 15, in <module>
        from cgi import parse_header
      File "<frozen importlib._bootstrap>", line 1178, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1149, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 940, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/cgi.py", line 57, in <module>
        warnings._deprecated(__name__, remove=(3,13))
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py", line 514, in _deprecated
        warn(msg, DeprecationWarning, stacklevel=3)
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13
```

fixed by https://babel.pocoo.org/en/latest/changelog.html#version-2-11-0


---

Comment by git created at 2022-11-25 02:21:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-11-25 02:40:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-11-29 19:12:17

Seems to build okay. Are the various authors happy with the other authors' changes?


---

Comment by dimpase created at 2022-11-30 18:41:14

lgtm


---

Comment by dimpase created at 2022-11-30 18:41:14

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-11-30 19:55:32

Thanks!


---

Comment by vbraun created at 2022-12-04 20:46:08

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-12-04 20:46:08

Various doctests fail with the `C` locale, that should imho really work as a safe fallback:

```
$ LC_ALL=C ./sage -t --long --random-seed=0 src/doc/en/developer/coding_basics.rst
Running doctests with ID 2022-12-04-21-15-33-272176ee.
Git branch: develop
Git ref: 9.8.beta4-236-gf646e74ba03
Running with SAGE_LOCAL='/home/release/Sage/local' and SAGE_VENV='/home/release/Sage/local/var/lib/sage/venv-python3.11.0'
Using --optional=fedora,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_cubic_hecke,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.misc.cython,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst
**********************************************************************
File "src/doc/en/developer/coding_basics.rst", line 767, in doc.en.developer.coding_basics
Failed example:
    sage_getdoc(foo)              # class docstring
Expected:
    'Construct a Foo.\n'
Got:
    doctest:warning
      File "/home/release/Sage/src/bin/sage-runtests", line 154, in <module>
        err = DC.run()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1384, in run
        self.run_doctests()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1059, in run_doctests
        self.dispatcher.dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2021, in dispatch
        self.parallel_dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 1916, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2190, in start
        super().start()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py", line 281, in _Popen
[...]
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/docutils/utils/error_reporting.py", line 49, in <module>
        locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/locale.py", line 559, in getdefaultlocale
        warnings.warn(
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Use setlocale(), getencoding() and getlocale() instead
    'Construct a Foo.\n'
**********************************************************************
1 item had failures:
   1 of  61 in doc.en.developer.coding_basics
    [44 tests, 1 failure, 0.86 s]
----------------------------------------------------------------------
sage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2022-12-04 20:53:04

This seems to come from `docutils`, which is upgraded in #34795 (please review).


---

Comment by mkoeppe created at 2022-12-04 22:53:08

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2022-12-04 22:53:46

Replying to [comment:117 Matthias Köppe]:
> This seems to come from `docutils`, which is upgraded in #34795 (please review).

I actually see that particular doctest failure in sage-on-gentoo with docutils 0.19 and sphinx 5.3.0. Scratch that, I get a different deprecation warning at the end. So docutils may help with that particular one but there are other for which #34795 may help.


```
      File "/usr/lib/python3.11/site-packages/babel/messages/catalog.py", line 13, in <module>
        from cgi import parse_header
      File "<frozen importlib._bootstrap>", line 1178, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1149, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 940, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.11/cgi.py", line 57, in <module>
        warnings._deprecated(__name__, remove=(3,13))
      File "/usr/lib/python3.11/warnings.py", line 514, in _deprecated
        warn(msg, DeprecationWarning, stacklevel=3)
      File "/usr/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13
    'Construct a Foo.\n'
```



---

Comment by fbissey created at 2022-12-04 23:01:26

Upgrading babel from 2.10.3 to 2.11.0 got rid of that warning. sage is on 2.9.x, may be it is just an issue in 2.10.x.


---

Comment by mkoeppe created at 2022-12-04 23:06:02

The babel 2.11 upgrade is already here on the branch


---

Comment by fbissey created at 2022-12-04 23:07:52

Replying to [comment:121 Matthias Köppe]:
> The babel 2.11 upgrade is already here on the branch

So it is! Sorry for the noise.


---

Comment by vbraun created at 2022-12-10 23:23:22

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-12-10 23:23:22

I'm getting (Debian 11 32-bit)

```
ERROR: Package 'sagemath-standard' requires a different Python: 3.11.0 not in '<3.11,>=3.8'
```



---

Comment by mkoeppe created at 2022-12-10 23:25:20

forgot to run bootstrap?


---

Comment by vbraun created at 2022-12-11 12:00:44

The buildbot doesn't have autotools, so it might have gotten the old version

What I was trying to debug was ginac seemingly not linking with python 3.11

```
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex72.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex120.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex144.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     INFO: gcc: sage/symbolic/ginac/wildcard.cpp
[sagelib-9.8.beta4]     INFO: g++ -std=gnu++11 -shared -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -L. -Wl,-rpath,. -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -g -O2 build/temp.linux-i686-cpython-311/sage/symbolic/expression.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/add.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/archive.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/assume.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/basic.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/cmatcher.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/constant.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/context.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/ex.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expair.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expairseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/exprseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/fderivative.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function_info.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infinity.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infoflagbase.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_comb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_gamma.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperg.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_nstdsums.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_orthopoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trans.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trig.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_zeta.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/lst.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/matrix.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-giac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-singular.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mul.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/normal.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/numeric.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/operators.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/order.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/power.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/print.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/pseries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/py_funcs.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/registrar.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/relational.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/remember.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/sum.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/symbol.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/templates.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/upoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/useries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/utils.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/wildcard.o -L/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -lflint -lgmp -lSingular -ldl -lpolys -lflint -lmpfr -lgmp -lgmp -ldl -lfactory -lflint -lmpfr -lgmp -lntl -lgmp -lomalloc -lsingular_resources -lgsl -lm -lopenblas -lm -o build/lib.linux-i686-cpython-311/sage/symbolic/expression.cpython-311-i386-linux-gnu.so -lpari
[sagelib-9.8.beta4]     error: Command "gcc -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -fPIC -I/var/lib/buildbot/worker/sage_git/build/src -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/numpy/core/include -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -c sage/categories/category_cy_helper.c -o build/temp.linux-i686-cpython-311/sage/categories/category_cy_helper.o" failed with exit status 1
[sagelib-9.8.beta4]     error: subprocess-exited-with-error
[sagelib-9.8.beta4]     
[sagelib-9.8.beta4]     × python setup.py develop did not run successfully.
[sagelib-9.8.beta4]     │ exit code: 1
[sagelib-9.8.beta4]     ╰─> See above for output.
[sagelib-9.8.beta4]     
```

full log at http://build.sagemath.org/#/builders/47/builds/8/steps/9/logs/stdio


---

Comment by mkoeppe created at 2022-12-11 21:07:42

I see more errors in this log:

```
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c: In function ‘__pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer’:
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1425:50: error: ‘PyTrash_UNWIND_LEVEL’ undeclared (first use in this function)
[sagelib-9.8.beta4]      1425 |             if (_tstate->trash_delete_nesting >= PyTrash_UNWIND_LEVEL) {\
[sagelib-9.8.beta4]           |                                                  ^~~~~~~~~~~~~~~~~~~~
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1438:43: note: in expansion of macro ‘__Pyx_TRASHCAN_BEGIN_CONDITION’
[sagelib-9.8.beta4]      1438 | #define __Pyx_TRASHCAN_BEGIN(op, dealloc) __Pyx_TRASHCAN_BEGIN_CONDITION(op,\
[sagelib-9.8.beta4]           |                                           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:4408:3: note: in expansion of macro ‘__Pyx_TRASHCAN_BEGIN’
[sagelib-9.8.beta4]      4408 |   __Pyx_TRASHCAN_BEGIN(o, __pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer)
[sagelib-9.8.beta4]           |   ^~~~~~~~~~~~~~~~~~~~
```



---

Comment by mkoeppe created at 2022-12-11 21:10:31

Is this an incremental build? Note that sagelib switched to the default `--enable-editable`, so you may have Cython artifacts in your source tree


---

Comment by mkoeppe created at 2022-12-11 21:20:50

Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:

```
root@fd2f063d77c6:/sage# ./sage 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Exception ignored in: 'sage.rings.integer_fake.is_Integer'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Exception ignored in: 'sage.rings.integer_fake.is_Integer'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/category_object.pyx", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category
KeyError: '_ComplexField_class__real_field'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/rings/complex_mpfr.pyx", line 398, in sage.rings.complex_mpfr.ComplexField_class._real_field
  File "sage/structure/category_object.pyx", line 833, in sage.structure.category_object.CategoryObject.__getattr__
  File "sage/structure/category_object.pyx", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category
  File "sage/cpython/getattr.pyx", line 361, in sage.cpython.getattr.getattr_from_other_class
AttributeError: 'ComplexField_class' object has no attribute '_ComplexField_class__real_field'

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/category_object.pyx", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category
KeyError: 'Element'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/parent.pyx", line 1976, in sage.structure.parent.Parent.convert_method_map
  File "sage/structure/category_object.pyx", line 833, in sage.structure.category_object.CategoryObject.__getattr__
  File "sage/structure/category_object.pyx", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category
  File "sage/cpython/getattr.pyx", line 361, in sage.cpython.getattr.getattr_from_other_class
AttributeError: 'sage.sets.pythonclass.Set_PythonType_class' object has no attribute '_Hom_'

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/structure/unique_representation.py", line 1007, in __classcall__
    instance = typecall(cls, *args, **options)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
           ^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
                         ^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
           ^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
                         ^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/qqbar.py", line 8625, in <module>
    qq_generator = AlgebraicGenerator(QQ, ANRoot(AAPoly.gen() - 1, RIF(1)))
                                                 ~~~~~~~~~~~~~^~~
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/tate_algebra.py", line 244, in TateAlgebraFactory
    def create_key(self, base, prec=None, log_radii=ZZ(0), names=None, order='degrevlex'):
                                                    ^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/number_field/number_field.py", line 985, in QuadraticField
    D = QQ(D)
        ^^^^^
AssertionError: 
Traceback (most recent call last):
  File "/sage/src/bin/sage-ipython", line 10, in <module>
    banner()
  File "/sage/src/sage/misc/banner.py", line 116, in banner
    print(banner_text(full=True))
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/sage/src/sage/misc/banner.py", line 71, in banner_text
    import sage.all
  File "/sage/src/sage/all.py", line 160, in <module>
    from sage.symbolic.all   import *
  File "/sage/src/sage/symbolic/all.py", line 8, in <module>
    import sage.symbolic.expression  # initialize pynac before .ring
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "sage/symbolic/pynac_impl.pxi", line 2617, in init sage.symbolic.expression
  File "sage/symbolic/pynac_impl.pxi", line 2518, in sage.symbolic.expression.init_pynac_I
  File "/sage/src/sage/rings/number_field/number_field.py", line 1019, in GaussianField
    return QuadraticField(-1, 'I', latex_name='i')
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/sage/src/sage/rings/number_field/number_field.py", line 988, in QuadraticField
    raise ValueError("D must not be a perfect square.")
ValueError: D must not be a perfect square.
```



---

Comment by git created at 2022-12-12 02:44:22

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2022-12-12 02:58:17

Replying to [comment:128 Matthias Köppe]:
> Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:
> {{{
> root`@`fd2f063d77c6:/sage# ./sage 
> AssertionError
> Exception ignored in: 'sage.arith.long.integer_check_long_py'

I think this may be: [bpo-45569](https://bugs.python.org/issue?`@`action=redirect&bpo=45569): "The build now defaults to using 30-bit digits for Python integers. Previously either 15-bit or 30-bit digits would be selected, depending on the platform. 15-bit digits may still be selected using the --enable-big-digits=15 option to the configure script, or by defining PYLONG_BITS_IN_DIGIT in pyconfig.h."


---

Comment by mkoeppe created at 2022-12-12 03:05:37

This means that the following assumption in src/sage/arith/long.pxd is now violated on 32 bit:

```
    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
    # 64-bit system. This is not guaranteed by Python, but it is the
    # default configuration.
    #
    # This way, we know that 1 and 2 digits certainly fit in a C long
    # and 4 or more digits never fit. For 3 digits, we need an explicit
    # overflow check.
```



---

Comment by tornaria created at 2022-12-12 04:05:58

Indeed, I missed this but our i686 sage in void linux is broken (I guess nobody uses it).

Something silly as the following seems to work around the issue (not a proper fix):

```diff
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -213,7 +213,7 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
     # and 4 or more digits never fit. For 3 digits, we need an explicit
     # overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
+    if not (PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
         raise AssertionError
 
     cdef long lead
@@ -227,6 +227,9 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
     elif size == -1:
         value[0] = -dig(D, 0)
         err[0] = 0
+    elif True:
+        # ASSUME OVERFLOW
+        err[0] = ERR_OVERFLOW
     elif size == 2:
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
```


Maybe we could just use `PyLong_AsLongAndOverflow` here (https://docs.python.org/3/c-api/long.html#c.PyLong_AsLongAndOverflow).


---

Comment by tornaria created at 2022-12-13 02:48:27

Possibly better fix (tested only with python 3.11, although the tests `BITS_IN_LONG < 2 * PyLong_SHIFT` should always be false on python <= 3.10 and on 64 bit).

```diff
diff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd
index e3a9f1586e5..e1e71982c86 100644
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         ....:         if err == 0:
         ....:             return value
         ....:         elif err == ERR_OVERFLOW:
-        ....:             raise OverflowError("integer_check_long: overflow")
+        ....:             raise OverflowError(f"integer_check_long: overflow ({x})")
         ....:     elif err == ERR_TYPE:
         ....:         raise TypeError("integer_check_long: wrong type")
         ....:     elif err == ERR_INDEX:
@@ -145,15 +145,15 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         sage: check_long(2^100)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_max() + 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_min() - 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long("hello")
         Traceback (most recent call last):
         ...
@@ -201,22 +201,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         err[0] = ERR_TYPE
         return 0
 
-    # x is a Python "long" (called "int" on Python 3)
+    # x is a Python "int" (aka PyLongObject or py_long in cython)
     cdef const digit* D = (<py_long>x).ob_digit
     cdef Py_ssize_t size = Py_SIZE(x)
 
-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
-    # 64-bit system. This is not guaranteed by Python, but it is the
-    # default configuration.
+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.
+    # This is true in all the default configurations:
+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)
+    # cf. https://trac.sagemath.org/ticket/33842#comment:130
     #
-    # This way, we know that 1 and 2 digits certainly fit in a C long
-    # and 4 or more digits never fit. For 3 digits, we need an explicit
-    # overflow check.
+    # This way, we know that 1 digit certainly fits in a C long
+    # and 4 or more digits never fit.
+    # For 2 or 3 digits, we need an explicit overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
-        raise AssertionError
+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):
+        raise AssertionError(
+                f"PyLong_SHIFT = {PyLong_SHIFT}, "
+                f"BITS_IN_LONG = {BITS_IN_LONG}")
 
     cdef long lead
+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)
     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)
     if size == 0:
         value[0] = 0
@@ -228,9 +234,15 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         value[0] = -dig(D, 0)
         err[0] = 0
     elif size == 2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
     elif size == -2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] > lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = -(dig(D, 0) + dig(D, 1))
         err[0] = 0
     elif size == 3:
```



---

Comment by mkoeppe created at 2022-12-13 08:32:45

This mostly works, but I'm getting a bunch of suspicious doctest failures

```
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/hecke/submodule.py  # 10 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/space.py  # 2 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/ring.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/element.py  # 6 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modsym/space.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/overconvergent/genus0.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_field.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_number_field.py  # 15 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/kraus.py  # 3 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_small_degree.py  # 3 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_class.py  # 9 doctests failed
```



---

Comment by tornaria created at 2022-12-14 00:24:26

My bad, I had a slight mistake so that numbers a little bit smaller than `LONG_MIN` would be mishandled, but only if they are python ints (not ZZ). This seems to be indirectly tested in the docstring for `integer_check_long` but //it is not! //

It seems I have everything working now, I will wrap and try to push soon (maybe add/copy some doctests to the docstring for `integer_check_long_py` so it's //directly// tested).

If you want to try it, only the last chunk in the patch above needs to be changed (I also added some new doctests). All the faulty doctests above seem to be fixed now.

Apologies for copy-pasting instead of making a proper branch, the push will follow when I cleanup.


```diff
diff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd
index e3a9f1586e5..2f863f18f10 100644
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         ....:         if err == 0:
         ....:             return value
         ....:         elif err == ERR_OVERFLOW:
-        ....:             raise OverflowError("integer_check_long: overflow")
+        ....:             raise OverflowError(f"integer_check_long: overflow ({x})")
         ....:     elif err == ERR_TYPE:
         ....:         raise TypeError("integer_check_long: wrong type")
         ....:     elif err == ERR_INDEX:
@@ -140,20 +140,20 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         sage: L = [1, 12345, 10^9, 2^30, long_max()//9, long_max()//3, long_max()]
         sage: L += [-x for x in L] + [0, long_min()]
         sage: for v in L:
-        ....:     for t in (Integer, int):
+        ....:     for t in types:
         ....:         assert check_long(t(v)) == v
         sage: check_long(2^100)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_max() + 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_min() - 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long("hello")
         Traceback (most recent call last):
         ...
@@ -162,6 +162,21 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         Traceback (most recent call last):
         ...
         TypeError: integer_check_long: bad __index__
+
+    Repeat the overflow tests with python integers:
+
+        sage: check_long(int(2^100))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
+        sage: check_long(int(long_max() + 1))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
+        sage: check_long(int(long_min() - 1))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
     """
     cdef int c = integer_check_long_py(x, value, err)
     if c:
@@ -201,22 +216,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         err[0] = ERR_TYPE
         return 0
 
-    # x is a Python "long" (called "int" on Python 3)
+    # x is a Python "int" (aka PyLongObject or py_long in cython)
     cdef const digit* D = (<py_long>x).ob_digit
     cdef Py_ssize_t size = Py_SIZE(x)
 
-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
-    # 64-bit system. This is not guaranteed by Python, but it is the
-    # default configuration.
+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.
+    # This is true in all the default configurations:
+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)
+    # cf. https://trac.sagemath.org/ticket/33842#comment:130
     #
-    # This way, we know that 1 and 2 digits certainly fit in a C long
-    # and 4 or more digits never fit. For 3 digits, we need an explicit
-    # overflow check.
+    # This way, we know that 1 digit certainly fits in a C long
+    # and 4 or more digits never fit.
+    # For 2 or 3 digits, we need an explicit overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
-        raise AssertionError
+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):
+        raise AssertionError(
+                f"PyLong_SHIFT = {PyLong_SHIFT}, "
+                f"BITS_IN_LONG = {BITS_IN_LONG}")
 
     cdef long lead
+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)
     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)
     if size == 0:
         value[0] = 0
@@ -228,9 +249,20 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         value[0] = -dig(D, 0)
         err[0] = 0
     elif size == 2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
     elif size == -2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            if D[0] == 0 and D[1] == lead_2_overflow:
+                # Special case for LONG_MIN
+                value[0] = (<long>-1) << BITS_IN_LONG
+                err[0] = 0
+            else:
+                err[0] = ERR_OVERFLOW
+            return 1
         value[0] = -(dig(D, 0) + dig(D, 1))
         err[0] = 0
     elif size == 3:
```



---

Comment by mkoeppe created at 2022-12-14 00:33:10

Probably we should include doctests for the relevant edge cases


---

Comment by tornaria created at 2022-12-14 03:07:25

Please test.
----
New commits:


---

Comment by tornaria created at 2022-12-14 03:07:25

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-12-14 05:11:39

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-12-14 05:11:39

This works, thanks very much!


---

Comment by vbraun created at 2022-12-19 16:27:45

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-12-19 16:27:45

I still get the 

```
DeprecationWarning: Use setlocale(), getencoding() and getlocale() instead
```

on macOS Big Sur, so I guess it wasn't fixed in #34795

PS: Indeed the offending line is here `site-packages/docutils/io.py:30`

```
     _locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]
```


PPS: Buildbot locale is:

```
buildbot-sage@bigsur-osx build % locale
LANG=""
LC_COLLATE="C"
LC_CTYPE="C"
LC_MESSAGES="C"
LC_MONETARY="C"
LC_NUMERIC="C"
LC_TIME="C"
LC_ALL=
buildbot-sage@bigsur-osx build % ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta5, Release Date: 2022-12-11               │
│ Using Python 3.11.1. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import locale
sage: locale.getlocale()
(None, 'UTF-8')
```



---

Comment by mkoeppe created at 2022-12-19 19:20:34

Thanks for the details. I think we'll have to suppress the warning. I'll also open an issue with docutils


---

Comment by mkoeppe created at 2022-12-19 19:22:19

`locale.getlocale()[1]` is `UTF-8`, so getdefaultlocale shouldn't be called there


---

Comment by mkoeppe created at 2022-12-19 20:56:23

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-12-19 20:56:23

New commits:


---

Comment by mkoeppe created at 2022-12-19 21:11:46

Replying to [comment:140 Matthias Köppe]:
> I'll also open an issue with docutils

That's now https://sourceforge.net/p/docutils/bugs/464/


---

Comment by mkoeppe created at 2022-12-19 23:09:38


```
$ LC_ALL=C ./sage -tp --all --long 
...
All tests passed!
```



---

Comment by mkoeppe created at 2022-12-19 23:09:38

Changing status from needs_review to positive_review.
