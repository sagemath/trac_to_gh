# Issue 33605: Test ticket: Python 3.11

archive/issues_033605.json:
```json
{
    "body": "CC:  @kiwifb @antonio-rojas @nbruin @dimpase @jhpalmieri\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33842\n\n",
    "created_at": "2022-05-12T02:48:43Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Test ticket: Python 3.11",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33605",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kiwifb @antonio-rojas @nbruin @dimpase @jhpalmieri



Issue created by migration from https://trac.sagemath.org/ticket/33842





---

archive/issue_comments_477725.json:
```json
{
    "body": "It builds. First failure: building cython - we need to wait for a version with 3.11 support - https://github.com/cython/cython/commits/0.29.x\n\n---\nNew commits:",
    "created_at": "2022-05-12T03:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477725",
    "user": "https://github.com/mkoeppe"
}
```

It builds. First failure: building cython - we need to wait for a version with 3.11 support - https://github.com/cython/cython/commits/0.29.x

---
New commits:



---

archive/issue_comments_477726.json:
```json
{
    "body": "Cython update in #33864",
    "created_at": "2022-05-18T00:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477726",
    "user": "https://github.com/mkoeppe"
}
```

Cython update in #33864



---

archive/issue_comments_477727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-18T04:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477727",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477728.json:
```json
{
    "body": "```\n  [pyzmq-22.3.0]       #include \"longintrepr.h\"\n  [pyzmq-22.3.0]                ^~~~~~~~~~~~~~~\n  [pyzmq-22.3.0]     1 error generated.\n```\nsame error as in memory_allocator",
    "created_at": "2022-05-18T04:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477728",
    "user": "https://github.com/mkoeppe"
}
```

```
  [pyzmq-22.3.0]       #include "longintrepr.h"
  [pyzmq-22.3.0]                ^~~~~~~~~~~~~~~
  [pyzmq-22.3.0]     1 error generated.
```
same error as in memory_allocator



---

archive/issue_comments_477729.json:
```json
{
    "body": "Fix is in 23.0.0 (still beta) https://pyzmq.readthedocs.io/en/latest/changelog.html\nhttps://pypi.org/project/pyzmq/#history",
    "created_at": "2022-05-18T04:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477729",
    "user": "https://github.com/mkoeppe"
}
```

Fix is in 23.0.0 (still beta) https://pyzmq.readthedocs.io/en/latest/changelog.html
https://pypi.org/project/pyzmq/#history



---

archive/issue_comments_477730.json:
```json
{
    "body": "cypari2:\n\n```\n  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -I./cypari2 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/site-packages/cysignals -I/usr/local/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/include/python3.11 -c cypari2/convert.c -o build/temp.macosx-12.4-x86_64-3.11/cypari2/convert.o\n  cypari2/convert.c:3347:21: error: cannot take the address of an rvalue of type 'Py_ssize_t' (aka 'long')\n    __pyx_v_sizeptr = &Py_SIZE(((PyObject *)__pyx_v_x));\n                      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n  1 error generated.\n```",
    "created_at": "2022-05-18T04:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477730",
    "user": "https://github.com/mkoeppe"
}
```

cypari2:

```
  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -I./cypari2 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/site-packages/cysignals -I/usr/local/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/include/python3.11 -c cypari2/convert.c -o build/temp.macosx-12.4-x86_64-3.11/cypari2/convert.o
  cypari2/convert.c:3347:21: error: cannot take the address of an rvalue of type 'Py_ssize_t' (aka 'long')
    __pyx_v_sizeptr = &Py_SIZE(((PyObject *)__pyx_v_x));
                      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  1 error generated.
```



---

archive/issue_comments_477731.json:
```json
{
    "body": "```\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/var/tmp/sage/build/jupyter_jsmol-0.2.4/src/setupbase.py\", line 630, in _compile_pattern\n      return re.compile(res, flags=flags).match\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py\", line 225, in compile\n      return _compile(pattern, flags)\n             ^^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py\", line 273, in _compile\n      p = _compiler.compile(pattern, flags)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_compiler.py\", line 759, in compile\n      p = _parser.parse(p, flags)\n          ^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py\", line 979, in parse\n      p = _parse_sub(source, state, flags & SRE_FLAG_VERBOSE, 0)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py\", line 454, in _parse_sub\n      itemsappend(_parse(source, state, verbose, nested + 1,\n                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py\", line 840, in _parse\n      raise source.error('global flags not at the start '\n      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  re.error: global flags not at the start of the expression at position 52\n  error: subprocess-exited-with-error\n```",
    "created_at": "2022-05-18T04:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477731",
    "user": "https://github.com/mkoeppe"
}
```

```
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/var/tmp/sage/build/jupyter_jsmol-0.2.4/src/setupbase.py", line 630, in _compile_pattern
      return re.compile(res, flags=flags).match
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py", line 225, in compile
      return _compile(pattern, flags)
             ^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/__init__.py", line 273, in _compile
      p = _compiler.compile(pattern, flags)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_compiler.py", line 759, in compile
      p = _parser.parse(p, flags)
          ^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 979, in parse
      p = _parse_sub(source, state, flags & SRE_FLAG_VERBOSE, 0)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 454, in _parse_sub
      itemsappend(_parse(source, state, verbose, nested + 1,
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b1/lib/python3.11/re/_parser.py", line 840, in _parse
      raise source.error('global flags not at the start '
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  re.error: global flags not at the start of the expression at position 52
  error: subprocess-exited-with-error
```



---

archive/issue_comments_477732.json:
```json
{
    "body": "This should be fixed in FPyLLL upstream. I can cut new packages?",
    "created_at": "2022-05-18T10:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477732",
    "user": "https://github.com/malb"
}
```

This should be fixed in FPyLLL upstream. I can cut new packages?



---

archive/issue_comments_477733.json:
```json
{
    "body": "Yes please!",
    "created_at": "2022-05-18T15:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477733",
    "user": "https://github.com/mkoeppe"
}
```

Yes please!



---

archive/issue_comments_477734.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-05-27T05:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_477735.json:
```json
{
    "body": "See #33913 for FP(y)LLL",
    "created_at": "2022-05-27T15:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477735",
    "user": "https://github.com/malb"
}
```

See #33913 for FP(y)LLL



---

archive/issue_comments_477736.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-05-27T21:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_477737.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-06-05T18:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_477738.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-07-10T22:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_477739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-10T23:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477740.json:
```json
{
    "body": "With 3.11.0b3, another problem with fpylll\n\n```\n  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -Isrc/fpylll/fplll -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/cysignals -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/numpy/core/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11 -c build/src/fpylll/fplll/integer_matrix.cpp -o build/temp.macosx-12.4-x86_64-cpython-311/build/src/fpylll/fplll/integer_matrix.o -std=c++11 -g -O2\n  In file included from build/src/fpylll/fplll/integer_matrix.cpp:47:\n  In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/Python.h:38:\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:47:24: error: cannot cast from type 'int' to pointer type '_object *'\n                  return static_cast<type>(const_cast<expr_type &>(expr));\n                         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n  build/src/fpylll/fplll/integer_matrix.cpp:22142:9: note: in instantiation of function template specialization '(anonymous namespace)::_Py_CAST_impl<_object *, int>' requested here\n          PyTuple_SET_ITEM(args, 0, 0);\n          ^\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/cpython/tupleobject.h:40:49: note: expanded from macro 'PyTuple_SET_ITEM'\n      PyTuple_SET_ITEM(_PyObject_CAST(op), index, _PyObject_CAST(value))\n                                                  ^\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/object.h:107:28: note: expanded from macro '_PyObject_CAST'\n  #define _PyObject_CAST(op) _Py_CAST(PyObject*, (op))\n                             ^\n  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:51:32: note: expanded from macro '_Py_CAST'\n  #  define _Py_CAST(type, expr) _Py_CAST_impl<type>(expr)\n                                 ^\n  1 error generated.\n  error: command '/usr/bin/gcc' failed with exit code 1\n```",
    "created_at": "2022-07-10T23:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477740",
    "user": "https://github.com/mkoeppe"
}
```

With 3.11.0b3, another problem with fpylll

```
  gcc -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -Isrc/fpylll/fplll -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/cysignals -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/lib/python3.11/site-packages/numpy/core/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11 -c build/src/fpylll/fplll/integer_matrix.cpp -o build/temp.macosx-12.4-x86_64-cpython-311/build/src/fpylll/fplll/integer_matrix.o -std=c++11 -g -O2
  In file included from build/src/fpylll/fplll/integer_matrix.cpp:47:
  In file included from /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/Python.h:38:
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:47:24: error: cannot cast from type 'int' to pointer type '_object *'
                  return static_cast<type>(const_cast<expr_type &>(expr));
                         ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  build/src/fpylll/fplll/integer_matrix.cpp:22142:9: note: in instantiation of function template specialization '(anonymous namespace)::_Py_CAST_impl<_object *, int>' requested here
          PyTuple_SET_ITEM(args, 0, 0);
          ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/cpython/tupleobject.h:40:49: note: expanded from macro 'PyTuple_SET_ITEM'
      PyTuple_SET_ITEM(_PyObject_CAST(op), index, _PyObject_CAST(value))
                                                  ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/object.h:107:28: note: expanded from macro '_PyObject_CAST'
  #define _PyObject_CAST(op) _Py_CAST(PyObject*, (op))
                             ^
  /Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0b3/include/python3.11/pyport.h:51:32: note: expanded from macro '_Py_CAST'
  #  define _Py_CAST(type, expr) _Py_CAST_impl<type>(expr)
                                 ^
  1 error generated.
  error: command '/usr/bin/gcc' failed with exit code 1
```



---

archive/issue_comments_477741.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-26T04:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477741",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477742.json:
```json
{
    "body": "Replying to [comment:27 mkoeppe]:\n> With 3.11.0b3, another problem with fpylll\n\n\nThis problem has disappeared with 3.11.0b4",
    "created_at": "2022-07-26T04:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477742",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 mkoeppe]:
> With 3.11.0b3, another problem with fpylll


This problem has disappeared with 3.11.0b4



---

archive/issue_comments_477743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-27T00:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477744.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-09T06:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_088831.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33605#event-88831"
}
```



---

archive/issue_comments_477745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-02T06:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477745",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477746.json:
```json
{
    "body": "Patch for python-3.11 (see `python-3.11.patch` at https://github.com/void-linux/void-packages/commit/6229f313450ecae88743b4d5e99da2ed4de44e07):\n\n```\n--- a/src/sage/cpython/cython_metaclass.h\n+++ b/src/sage/cpython/cython_metaclass.h\n@@ -66,7 +66,7 @@\n         }\n \n         /* Now, set t.__class__ to metaclass */\n-        Py_TYPE(t) = metaclass;\n+        Py_SET_TYPE(t, metaclass);\n         PyType_Modified(t);\n     }\n     else\n--- a/src/sage/symbolic/ginac/numeric.cpp\n+++ b/src/sage/symbolic/ginac/numeric.cpp\n@@ -52,7 +52,6 @@\n #define register\n #define PY_SSIZE_T_CLEAN\n #include <Python.h>\n-#include <longintrepr.h>\n #include \"flint/fmpz.h\"\n #include \"flint/fmpz_factor.h\"\n \n--- a/src/sage/libs/gmp/pylong.pyx\n+++ b/src/sage/libs/gmp/pylong.pyx\n@@ -32,7 +32,7 @@\n from .mpz cimport *\n \n cdef extern from *:\n-    Py_ssize_t* Py_SIZE_PTR \"&Py_SIZE\"(object)\n+    void Py_SET_SIZE(object, Py_ssize_t)\n     int hash_bits \"\"\"\n         #ifdef _PyHASH_BITS\n         _PyHASH_BITS         /* Python 3 */\n@@ -57,10 +57,8 @@\n     mpz_export(L.ob_digit, NULL,\n             -1, sizeof(digit), 0, PyLong_nails, z)\n     if mpz_sgn(z) < 0:\n-        # Set correct size (use a pointer to hack around Cython's\n-        # non-support for lvalues).\n-        sizeptr = Py_SIZE_PTR(L)\n-        sizeptr[0] = -pylong_size\n+        # Set correct size\n+        Py_SET_SIZE(L, -pylong_size)\n     return L\n \n \n```",
    "created_at": "2022-10-17T03:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477746",
    "user": "https://github.com/tornaria"
}
```

Patch for python-3.11 (see `python-3.11.patch` at https://github.com/void-linux/void-packages/commit/6229f313450ecae88743b4d5e99da2ed4de44e07):

```
--- a/src/sage/cpython/cython_metaclass.h
+++ b/src/sage/cpython/cython_metaclass.h
@@ -66,7 +66,7 @@
         }
 
         /* Now, set t.__class__ to metaclass */
-        Py_TYPE(t) = metaclass;
+        Py_SET_TYPE(t, metaclass);
         PyType_Modified(t);
     }
     else
--- a/src/sage/symbolic/ginac/numeric.cpp
+++ b/src/sage/symbolic/ginac/numeric.cpp
@@ -52,7 +52,6 @@
 #define register
 #define PY_SSIZE_T_CLEAN
 #include <Python.h>
-#include <longintrepr.h>
 #include "flint/fmpz.h"
 #include "flint/fmpz_factor.h"
 
--- a/src/sage/libs/gmp/pylong.pyx
+++ b/src/sage/libs/gmp/pylong.pyx
@@ -32,7 +32,7 @@
 from .mpz cimport *
 
 cdef extern from *:
-    Py_ssize_t* Py_SIZE_PTR "&Py_SIZE"(object)
+    void Py_SET_SIZE(object, Py_ssize_t)
     int hash_bits """
         #ifdef _PyHASH_BITS
         _PyHASH_BITS         /* Python 3 */
@@ -57,10 +57,8 @@
     mpz_export(L.ob_digit, NULL,
             -1, sizeof(digit), 0, PyLong_nails, z)
     if mpz_sgn(z) < 0:
-        # Set correct size (use a pointer to hack around Cython's
-        # non-support for lvalues).
-        sizeptr = Py_SIZE_PTR(L)
-        sizeptr[0] = -pylong_size
+        # Set correct size
+        Py_SET_SIZE(L, -pylong_size)
     return L
 
 
```



---

archive/issue_comments_477747.json:
```json
{
    "body": "I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8",
    "created_at": "2022-10-17T03:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477747",
    "user": "https://github.com/mkoeppe"
}
```

I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8



---

archive/issue_comments_477748.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-10-25T03:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477748",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_477749.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-26T04:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477750.json:
```json
{
    "body": "Next error (on startup):\n\n```\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/decorators.py\", line 35, in <module>\n    from inspect import ArgSpec\nImportError: cannot import name 'ArgSpec' from 'inspect' (/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0/lib/python3.11/inspect.py)\n```",
    "created_at": "2022-10-26T04:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477750",
    "user": "https://github.com/mkoeppe"
}
```

Next error (on startup):

```
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/decorators.py", line 35, in <module>
    from inspect import ArgSpec
ImportError: cannot import name 'ArgSpec' from 'inspect' (/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/local/var/lib/sage/venv-python3.11.0/lib/python3.11/inspect.py)
```



---

archive/issue_comments_477751.json:
```json
{
    "body": "Also\n\n```\n  File \"sage/misc/cachefunc.pyx\", line 2821, in sage.misc.cachefunc.CachedMethod.__get__\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/sageinspect.py\", line 1720, in sage_getargspec\n    return inspect.ArgSpec(*_sage_getargspec_cython(source))\n           ^^^^^^^^^^^^^^^\nAttributeError: module 'inspect' has no attribute 'ArgSpec'\n```",
    "created_at": "2022-10-26T05:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477751",
    "user": "https://github.com/mkoeppe"
}
```

Also

```
  File "sage/misc/cachefunc.pyx", line 2821, in sage.misc.cachefunc.CachedMethod.__get__
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-py311/src/sage/misc/sageinspect.py", line 1720, in sage_getargspec
    return inspect.ArgSpec(*_sage_getargspec_cython(source))
           ^^^^^^^^^^^^^^^
AttributeError: module 'inspect' has no attribute 'ArgSpec'
```



---

archive/issue_comments_477752.json:
```json
{
    "body": "From https://docs.python.org/3.11/whatsnew/3.11.html:\n\n  Removed from the inspect module:\n\n- The getargspec() function, deprecated since Python 3.0; use inspect.signature() or inspect.getfullargspec() instead.\n\n- The formatargspec() function, deprecated since Python 3.5; use the inspect.signature() function or the inspect.Signature object directly.\n\nSee #31309, #30884",
    "created_at": "2022-10-26T05:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477752",
    "user": "https://github.com/mkoeppe"
}
```

From https://docs.python.org/3.11/whatsnew/3.11.html:

  Removed from the inspect module:

- The getargspec() function, deprecated since Python 3.0; use inspect.signature() or inspect.getfullargspec() instead.

- The formatargspec() function, deprecated since Python 3.5; use the inspect.signature() function or the inspect.Signature object directly.

See #31309, #30884



---

archive/issue_comments_477753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-26T05:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477754.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-26T06:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477754",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477755.json:
```json
{
    "body": "Hangs in this doctest:\n\n```\nTrying (line 1258):    @weak_cached_function(cache=0)\n    def f():\n        print(\"doing a computation\")\n        return A()\nExpecting nothing\nok [0.00 s]\nTrying (line 1262):    a = f()\nExpecting:\n    doing a computation\nok [0.00 s]\nTrying (line 1267):    b = f()\nExpecting nothing\nok [0.00 s]\nTrying (line 1268):    a is b\nExpecting:\n    True\nok [0.00 s]\nTrying (line 1274):    del a\nExpecting nothing\nok [0.00 s]\nTrying (line 1275):    del b\nExpecting nothing\n^CKilling test pkgs/sagemath-categories/.tox/sagepython-sagewheels-nopypi-norequirements/lib/python3.11/site-packages/sage/misc/cachefunc.pyx\n```",
    "created_at": "2022-10-27T00:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477755",
    "user": "https://github.com/mkoeppe"
}
```

Hangs in this doctest:

```
Trying (line 1258):    @weak_cached_function(cache=0)
    def f():
        print("doing a computation")
        return A()
Expecting nothing
ok [0.00 s]
Trying (line 1262):    a = f()
Expecting:
    doing a computation
ok [0.00 s]
Trying (line 1267):    b = f()
Expecting nothing
ok [0.00 s]
Trying (line 1268):    a is b
Expecting:
    True
ok [0.00 s]
Trying (line 1274):    del a
Expecting nothing
ok [0.00 s]
Trying (line 1275):    del b
Expecting nothing
^CKilling test pkgs/sagemath-categories/.tox/sagepython-sagewheels-nopypi-norequirements/lib/python3.11/site-packages/sage/misc/cachefunc.pyx
```



---

archive/issue_comments_477756.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-27T00:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477757.json:
```json
{
    "body": "This likely comes from our weak dictionaries. Running `sage -t --verbose src/sage/misc/weak_dict.pyx` gives:\n\n```\nTrying (line 53):    import sage.misc.weak_dict\nExpecting nothing\nok [0.00 s]\nTrying (line 54):    D = sage.misc.weak_dict.WeakValueDictionary()\nExpecting nothing\nok [0.00 s]\nTrying (line 55):    for v in ValList:\n        D[Keys(v)] = v\nExpecting nothing\nok [0.00 s]\nTrying (line 57):    len(D)\nExpecting:\n    10\nok [0.00 s]\nTrying (line 59):    del ValList\nExpecting nothing\n    Killed due to segmentation fault\n```",
    "created_at": "2022-10-27T00:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477757",
    "user": "https://github.com/mkoeppe"
}
```

This likely comes from our weak dictionaries. Running `sage -t --verbose src/sage/misc/weak_dict.pyx` gives:

```
Trying (line 53):    import sage.misc.weak_dict
Expecting nothing
ok [0.00 s]
Trying (line 54):    D = sage.misc.weak_dict.WeakValueDictionary()
Expecting nothing
ok [0.00 s]
Trying (line 55):    for v in ValList:
        D[Keys(v)] = v
Expecting nothing
ok [0.00 s]
Trying (line 57):    len(D)
Expecting:
    10
ok [0.00 s]
Trying (line 59):    del ValList
Expecting nothing
    Killed due to segmentation fault
```



---

archive/issue_comments_477758.json:
```json
{
    "body": "The layout of dictionaries has changed from 3.10 to 3.11, so src/sage/cpython/dict_del_by_value.pyx will have to be changed",
    "created_at": "2022-10-27T01:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477758",
    "user": "https://github.com/mkoeppe"
}
```

The layout of dictionaries has changed from 3.10 to 3.11, so src/sage/cpython/dict_del_by_value.pyx will have to be changed



---

archive/issue_comments_477759.json:
```json
{
    "body": "A previous ticket involving `del_dictitem_by_exact_value`: #28941",
    "created_at": "2022-10-27T01:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477759",
    "user": "https://github.com/mkoeppe"
}
```

A previous ticket involving `del_dictitem_by_exact_value`: #28941



---

archive/issue_comments_477760.json:
```json
{
    "body": "Should `build/pkgs/cypari/patches/trashcan.patch` really be fully removed? Upstream Cython applied a patch (https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92) which replaces the change in `Cython/Utility/ExtensionTypes.c` by the upstream trashcan support, but keeps the `Cython/Compiler/*` trashcan uses added by the original patch untouched.",
    "created_at": "2022-10-28T16:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477760",
    "user": "https://github.com/collares"
}
```

Should `build/pkgs/cypari/patches/trashcan.patch` really be fully removed? Upstream Cython applied a patch (https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92) which replaces the change in `Cython/Utility/ExtensionTypes.c` by the upstream trashcan support, but keeps the `Cython/Compiler/*` trashcan uses added by the original patch untouched.



---

archive/issue_comments_477761.json:
```json
{
    "body": "That sounds like a better solution, please feel free to push to the branch",
    "created_at": "2022-10-28T17:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477761",
    "user": "https://github.com/mkoeppe"
}
```

That sounds like a better solution, please feel free to push to the branch



---

archive/issue_comments_477762.json:
```json
{
    "body": "Shouldn't we make this change in cypari2 itself?",
    "created_at": "2022-10-29T21:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477762",
    "user": "https://github.com/mkoeppe"
}
```

Shouldn't we make this change in cypari2 itself?



---

archive/issue_comments_477763.json:
```json
{
    "body": "Replying to [comment:37 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                    |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|\n> |[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)|`build/pkgs/cypari: Update to 2.1.3`|\n\n\nWhere is cypari 2.1.3? I can't seem to find it. Although the version in the git repo was bumped to 2.1.3 in oct 3, there is no tag. And `https://pypi.io/packages/source/c/cypari2/cypari2-2.1.3.tar.gz` (which, if IIUC, is the URL after this patch) gives 404.\n\nI built sagemath with python 3.11 (using the patch I posted earlier + the patch to fix inspect.argspec). Running sage hangs forever, I'm guessing I have to update cypari2 but I can't find the tarball for 2.1.3.",
    "created_at": "2022-10-30T18:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477763",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:37 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                    |
> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
> |[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)|`build/pkgs/cypari: Update to 2.1.3`|


Where is cypari 2.1.3? I can't seem to find it. Although the version in the git repo was bumped to 2.1.3 in oct 3, there is no tag. And `https://pypi.io/packages/source/c/cypari2/cypari2-2.1.3.tar.gz` (which, if IIUC, is the URL after this patch) gives 404.

I built sagemath with python 3.11 (using the patch I posted earlier + the patch to fix inspect.argspec). Running sage hangs forever, I'm guessing I have to update cypari2 but I can't find the tarball for 2.1.3.



---

archive/issue_comments_477764.json:
```json
{
    "body": "I pushed to sage-on-gentoo master for 9.8.beta3 with a patch for python 3.11 tailored from this branch. This was a bit of a mistake as it broke doc building with python 3.10 (and may be more).\nhttps://github.com/cschwan/sage-on-gentoo/issues/724\n\nWhat I learned today is that the current branch is not backward compatible :(",
    "created_at": "2022-10-30T21:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477764",
    "user": "https://github.com/kiwifb"
}
```

I pushed to sage-on-gentoo master for 9.8.beta3 with a patch for python 3.11 tailored from this branch. This was a bit of a mistake as it broke doc building with python 3.10 (and may be more).
https://github.com/cschwan/sage-on-gentoo/issues/724

What I learned today is that the current branch is not backward compatible :(



---

archive/issue_comments_477765.json:
```json
{
    "body": "Actually, I said it was breaking doc building with 3.10, but has anyone build the doc with python 3.11? I may be jumping the gun on backward compatibility, it may just be broken :(",
    "created_at": "2022-10-30T21:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477765",
    "user": "https://github.com/kiwifb"
}
```

Actually, I said it was breaking doc building with 3.10, but has anyone build the doc with python 3.11? I may be jumping the gun on backward compatibility, it may just be broken :(



---

archive/issue_comments_477766.json:
```json
{
    "body": "See comment:35 - current changes here on the branch need to be conditionalized on python >= 3.11",
    "created_at": "2022-10-30T22:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477766",
    "user": "https://github.com/mkoeppe"
}
```

See comment:35 - current changes here on the branch need to be conditionalized on python >= 3.11



---

archive/issue_comments_477767.json:
```json
{
    "body": "And comment:48 is still open - this requires major work",
    "created_at": "2022-10-30T22:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477767",
    "user": "https://github.com/mkoeppe"
}
```

And comment:48 is still open - this requires major work



---

archive/issue_comments_477768.json:
```json
{
    "body": "Replying to [comment:53 Gonzalo Tornar\u00eda]:\n> Replying to [comment:37 git]:\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n> > |                                                                                                                                           |                                    |\n> > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|\n> > |[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)|`build/pkgs/cypari: Update to 2.1.3`|\n\n> \n> Where is cypari 2.1.3?\n\n\nI built it from the master branch of cypari2 but did not upload it to PyPI because I haven't tested it yet",
    "created_at": "2022-10-30T22:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477768",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:53 Gonzalo Tornaría]:
> Replying to [comment:37 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > |                                                                                                                                           |                                    |
> > |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
> > |[a379ea3](https://git.sagemath.org/sage.git/commit/?id=a379ea3a3d4020bf344bf8ed4c562018cacb661d)|`build/pkgs/cypari: Update to 2.1.3`|

> 
> Where is cypari 2.1.3?


I built it from the master branch of cypari2 but did not upload it to PyPI because I haven't tested it yet



---

archive/issue_comments_477769.json:
```json
{
    "body": "Replying to [comment:57 Matthias K\u00f6ppe]:\n> And comment:48 is still open - this requires major work\n\n\nOK, I think this is stuff that breaks the doc building. I think we can infer that from the error messages.",
    "created_at": "2022-10-30T22:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477769",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:57 Matthias Köppe]:
> And comment:48 is still open - this requires major work


OK, I think this is stuff that breaks the doc building. I think we can infer that from the error messages.



---

archive/issue_comments_477770.json:
```json
{
    "body": "I upgraded cypari to 2.1.3 and fixed running tests (see comment:79:ticket:34537).\n\nBut I can't even get sage started at all... What am I missing?\n\nIs there a patch to cysignals that I should be applying (I'm using 1.11.2).\n\nOn startup I get a backtrace that starts with\n\n```\n------------------------------------------------------------------------\n/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8170)[0x7fc24132e170]\n/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8228)[0x7fc24132e228]\n/usr/lib/python3.11/site-packages/cysignals/signals.so(+0xaa33)[0x7fc241330a33]\n/usr/lib/libc.so.6(+0x3d000)[0x7fc241ec5000]\n/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/cpython/dict_del_by_value.cpython-311-x86_64-linux-gnu.so(+0x429d)[0x7fc24040e29d]\n/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/misc/weak_dict.cpython-311-x86_64-linux-gnu.so(+0xc815)[0x7fc24041f815]\n```\nSo this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...",
    "created_at": "2022-10-30T23:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477770",
    "user": "https://github.com/tornaria"
}
```

I upgraded cypari to 2.1.3 and fixed running tests (see comment:79:ticket:34537).

But I can't even get sage started at all... What am I missing?

Is there a patch to cysignals that I should be applying (I'm using 1.11.2).

On startup I get a backtrace that starts with

```
------------------------------------------------------------------------
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8170)[0x7fc24132e170]
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0x8228)[0x7fc24132e228]
/usr/lib/python3.11/site-packages/cysignals/signals.so(+0xaa33)[0x7fc241330a33]
/usr/lib/libc.so.6(+0x3d000)[0x7fc241ec5000]
/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/cpython/dict_del_by_value.cpython-311-x86_64-linux-gnu.so(+0x429d)[0x7fc24040e29d]
/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/misc/weak_dict.cpython-311-x86_64-linux-gnu.so(+0xc815)[0x7fc24041f815]
```
So this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...



---

archive/issue_comments_477771.json:
```json
{
    "body": "Replying to [comment:60 Gonzalo Tornar\u00eda]:\n> So this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...\n\n\nNo, it does not start. I was testing using sagemath-categories, which loads much less stuff at startup; this helped isolate the problem.",
    "created_at": "2022-10-30T23:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477771",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:60 Gonzalo Tornaría]:
> So this seems to be comment:48. Somehow I thought you had sage running and only some tests would break...


No, it does not start. I was testing using sagemath-categories, which loads much less stuff at startup; this helped isolate the problem.



---

archive/issue_comments_477772.json:
```json
{
    "body": "Just to have a minimal test case, on python 3.10:\n\n```\n$ python -c 'from sage.cpython.dict_del_by_value import test_del_dictitem_by_exact_value ; D = {1:2} ; test_del_dictitem_by_exact_value(D,1,2); print(D); test_del_dictitem_by_exact_value(D,2,1); print(D)'\n{1: 2}\n{}\n```\nThis hangs with python 3.11.\n\nNote also that `dict_del_by_value.pyx` is completely independent of the rest of sage. In case this helps with logistics (e.g. I have python 3.11 in a particular chroot, and I've recompiled just the python packages )\n\nMaybe it's easy to have a \"stupid slow\" implementation of `del_dictitem_by_exact_value` to keep moving forward?",
    "created_at": "2022-10-31T01:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477772",
    "user": "https://github.com/tornaria"
}
```

Just to have a minimal test case, on python 3.10:

```
$ python -c 'from sage.cpython.dict_del_by_value import test_del_dictitem_by_exact_value ; D = {1:2} ; test_del_dictitem_by_exact_value(D,1,2); print(D); test_del_dictitem_by_exact_value(D,2,1); print(D)'
{1: 2}
{}
```
This hangs with python 3.11.

Note also that `dict_del_by_value.pyx` is completely independent of the rest of sage. In case this helps with logistics (e.g. I have python 3.11 in a particular chroot, and I've recompiled just the python packages )

Maybe it's easy to have a "stupid slow" implementation of `del_dictitem_by_exact_value` to keep moving forward?



---

archive/issue_comments_477773.json:
```json
{
    "body": "Just to get going, this seems to do something (possibly a very dumb thing to do, but at least sage starts, I'm getting lots of doctest failures now):\n\n```\ndiff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx\nindex d52bedacfa4..930aa31bd1b 100644\n--- a/src/sage/misc/weak_dict.pyx\n+++ b/src/sage/misc/weak_dict.pyx\n@@ -216,7 +216,7 @@ cdef class WeakValueDictEraser:\n         if D._guard_level:\n             D._pending_removals.append(r)\n         else:\n-            del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>r, r.key)\n+            pass\n \n \n cdef class WeakValueDictionary(dict):\n```",
    "created_at": "2022-10-31T03:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477773",
    "user": "https://github.com/tornaria"
}
```

Just to get going, this seems to do something (possibly a very dumb thing to do, but at least sage starts, I'm getting lots of doctest failures now):

```
diff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx
index d52bedacfa4..930aa31bd1b 100644
--- a/src/sage/misc/weak_dict.pyx
+++ b/src/sage/misc/weak_dict.pyx
@@ -216,7 +216,7 @@ cdef class WeakValueDictEraser:
         if D._guard_level:
             D._pending_removals.append(r)
         else:
-            del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>r, r.key)
+            pass
 
 
 cdef class WeakValueDictionary(dict):
```



---

archive/issue_comments_477774.json:
```json
{
    "body": "This seems to get rid of a lot of deprecation warnings:\n\n```\ndiff --git a/src/sage/rings/polynomial/pbori/gbrefs.py b/src/sage/rings/polynomial/pbori/gbrefs.py\nindex 76e3924715d..70dc795cbab 100644\n--- a/src/sage/rings/polynomial/pbori/gbrefs.py\n+++ b/src/sage/rings/polynomial/pbori/gbrefs.py\n@@ -1,6 +1,6 @@\n import gzip\n from io import StringIO\n-import uu\n+import base64 as uu\n import re\n from types import ModuleType\n from .PyPolyBoRi import Polynomial\n```",
    "created_at": "2022-10-31T03:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477774",
    "user": "https://github.com/tornaria"
}
```

This seems to get rid of a lot of deprecation warnings:

```
diff --git a/src/sage/rings/polynomial/pbori/gbrefs.py b/src/sage/rings/polynomial/pbori/gbrefs.py
index 76e3924715d..70dc795cbab 100644
--- a/src/sage/rings/polynomial/pbori/gbrefs.py
+++ b/src/sage/rings/polynomial/pbori/gbrefs.py
@@ -1,6 +1,6 @@
 import gzip
 from io import StringIO
-import uu
+import base64 as uu
 import re
 from types import ModuleType
 from .PyPolyBoRi import Polynomial
```



---

archive/issue_comments_477775.json:
```json
{
    "body": "```\ndiff --git a/src/sage/misc/fpickle.pyx b/src/sage/misc/fpickle.pyx\nindex 502080e2c10..0532e5d2d38 100644\n--- a/src/sage/misc/fpickle.pyx\n+++ b/src/sage/misc/fpickle.pyx\n@@ -44,7 +44,12 @@ def reduce_code(co):\n     co_args += (co.co_kwonlyargcount, co.co_nlocals,\n                 co.co_stacksize, co.co_flags, co.co_code,\n                 co.co_consts, co.co_names, co.co_varnames, co.co_filename,\n-                co.co_name, co.co_firstlineno, co.co_lnotab)\n+                co.co_name)\n+    if sys.version_info.minor >= 11:\n+        co_args += (co.co_qualname,)\n+    co_args += (co.co_firstlineno, co.co_lnotab)\n+    if sys.version_info.minor >= 11:\n+        co_args += (co.co_exceptiontable,)\n \n     return (code_ctor, co_args)\n \n```\nThis is a mess... it's not even clear where the arguments to `type.CodeType` are documented. I found them by running `type.CodeType?` on sage.",
    "created_at": "2022-10-31T09:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477775",
    "user": "https://github.com/tornaria"
}
```

```
diff --git a/src/sage/misc/fpickle.pyx b/src/sage/misc/fpickle.pyx
index 502080e2c10..0532e5d2d38 100644
--- a/src/sage/misc/fpickle.pyx
+++ b/src/sage/misc/fpickle.pyx
@@ -44,7 +44,12 @@ def reduce_code(co):
     co_args += (co.co_kwonlyargcount, co.co_nlocals,
                 co.co_stacksize, co.co_flags, co.co_code,
                 co.co_consts, co.co_names, co.co_varnames, co.co_filename,
-                co.co_name, co.co_firstlineno, co.co_lnotab)
+                co.co_name)
+    if sys.version_info.minor >= 11:
+        co_args += (co.co_qualname,)
+    co_args += (co.co_firstlineno, co.co_lnotab)
+    if sys.version_info.minor >= 11:
+        co_args += (co.co_exceptiontable,)
 
     return (code_ctor, co_args)
 
```
This is a mess... it's not even clear where the arguments to `type.CodeType` are documented. I found them by running `type.CodeType?` on sage.



---

archive/issue_comments_477776.json:
```json
{
    "body": "```\n--- a/src/sage/all.py\n+++ b/src/sage/all.py\n@@ -104,6 +104,10 @@ warnings.filterwarnings('ignore', category=DeprecationWarning,\n                         message='The distutils(.sysconfig module| package) is deprecated',\n                         module='Cython|distutils|numpy|sage.env|sage.features')\n \n+warnings.filterwarnings('ignore', category=DeprecationWarning,\n+                        message=\"'cgi' is deprecated and slated for removal in Python 3.13\",\n+                        module='Cython')\n+\n ################ end setup warnings ###############################\n \n \n```",
    "created_at": "2022-10-31T11:39:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477776",
    "user": "https://github.com/tornaria"
}
```

```
--- a/src/sage/all.py
+++ b/src/sage/all.py
@@ -104,6 +104,10 @@ warnings.filterwarnings('ignore', category=DeprecationWarning,
                         message='The distutils(.sysconfig module| package) is deprecated',
                         module='Cython|distutils|numpy|sage.env|sage.features')
 
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+                        message="'cgi' is deprecated and slated for removal in Python 3.13",
+                        module='Cython')
+
 ################ end setup warnings ###############################
 
 
```



---

archive/issue_comments_477777.json:
```json
{
    "body": "```\ndiff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py\nindex c753f08232b..619ff6da661 100644\n--- a/src/sage/misc/sageinspect.py\n+++ b/src/sage/misc/sageinspect.py\n@@ -1133,7 +1133,7 @@ def _sage_getargspec_from_ast(source):\n \n     return inspect.FullArgSpec(args, vararg, kwarg,\n                                tuple(defaults) if defaults else None,\n-                               kwonlyargs=[], kwonlydefaults={}, annotations={})\n+                               kwonlyargs=[], kwonlydefaults=None, annotations={})\n \n \n def _sage_getargspec_cython(source):\n@@ -1679,7 +1679,8 @@ def sage_getargspec(obj):\n         # Note that this may give a wrong result for the constants!\n         try:\n             args, varargs, varkw = inspect.getargs(obj.__code__)\n-            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__)\n+            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__,\n+                                       kwonlyargs=[], kwonlydefaults=None, annotations={})\n         except (TypeError, AttributeError):\n             pass\n     if isclassinstance(obj):\n@@ -1738,7 +1739,7 @@ def sage_getargspec(obj):\n     except AttributeError:\n         defaults = None\n     return inspect.FullArgSpec(args, varargs, varkw, defaults,\n-                               kwonlyargs=[], kwonlydefaults={}, annotations={})\n+                               kwonlyargs=[], kwonlydefaults=None, annotations={})\n \n \n def formatannotation(annotation, base_module=None):\n@@ -1784,7 +1785,7 @@ def formatannotation(annotation, base_module=None):\n \n \n def sage_formatargspec(args, varargs=None, varkw=None, defaults=None,\n-                       kwonlyargs=(), kwonlydefaults={}, annotations={},\n+                       kwonlyargs=(), kwonlydefaults=None, annotations={},\n                        formatarg=str,\n                        formatvarargs=lambda name: '*' + name,\n                        formatvarkw=lambda name: '**' + name,\n```\nplus lots of doctest fixing in `sageinspect.py` which I'm not pasting here.",
    "created_at": "2022-10-31T11:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477777",
    "user": "https://github.com/tornaria"
}
```

```
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index c753f08232b..619ff6da661 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -1133,7 +1133,7 @@ def _sage_getargspec_from_ast(source):
 
     return inspect.FullArgSpec(args, vararg, kwarg,
                                tuple(defaults) if defaults else None,
-                               kwonlyargs=[], kwonlydefaults={}, annotations={})
+                               kwonlyargs=[], kwonlydefaults=None, annotations={})
 
 
 def _sage_getargspec_cython(source):
@@ -1679,7 +1679,8 @@ def sage_getargspec(obj):
         # Note that this may give a wrong result for the constants!
         try:
             args, varargs, varkw = inspect.getargs(obj.__code__)
-            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__)
+            return inspect.FullArgSpec(args, varargs, varkw, obj.__defaults__,
+                                       kwonlyargs=[], kwonlydefaults=None, annotations={})
         except (TypeError, AttributeError):
             pass
     if isclassinstance(obj):
@@ -1738,7 +1739,7 @@ def sage_getargspec(obj):
     except AttributeError:
         defaults = None
     return inspect.FullArgSpec(args, varargs, varkw, defaults,
-                               kwonlyargs=[], kwonlydefaults={}, annotations={})
+                               kwonlyargs=[], kwonlydefaults=None, annotations={})
 
 
 def formatannotation(annotation, base_module=None):
@@ -1784,7 +1785,7 @@ def formatannotation(annotation, base_module=None):
 
 
 def sage_formatargspec(args, varargs=None, varkw=None, defaults=None,
-                       kwonlyargs=(), kwonlydefaults={}, annotations={},
+                       kwonlyargs=(), kwonlydefaults=None, annotations={},
                        formatarg=str,
                        formatvarargs=lambda name: '*' + name,
                        formatvarkw=lambda name: '**' + name,
```
plus lots of doctest fixing in `sageinspect.py` which I'm not pasting here.



---

archive/issue_comments_477778.json:
```json
{
    "body": "I pushed all my patches in the branch `u/tornaria/py311`:\n\n```\n$ git log1 trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311 \n6010f52588e (HEAD -> py311, trac/u/tornaria/py311) fix argspec -> fullargspec\n21762fa3bc6 warnings: ignore deprecation of importlib.resources.path/read_binary\n98598ba0aa3 doctest: message added more info in python 3.11\n07acbc4509f doctest: AssertionError message changed in python 3.11\n2a4ced7e1a1 changed argspec.keywords -> argspec.varkw\nb09c738c6ed doctests: fix more due to ArgSpec -> FullArgSpec\na65553aae06 warnings: ignore deprecation for 'import sre_constants' in pyparsing\nf91d711b3c2 Fix FullArgSpec calls after 9eb08f3afde3266bbd667e196513240a0fe245f4\n14c91ec77de doctest: fix in sage.misc.sageinspect due to ArgSpec -> FullArgSpec\n186d921e70c warnings: ignore deprecation for 'import cgi' in cython\n0d34a14717c fix fpickle for python 3.11\na0078320c55 deprecated uu -> base64\nbed2c03e6d5 don't use broken del_dictitem_by_exact_value (temporary?)\n```\n\nOnly a a few remaining doctest failures, most (all?) seem related to the hack I did to get through the `WeakValueDictionary` problem.\n\nIf anyone can think of a good workaround (or a proper fix) for `WeakValueDictionary`... It seems void linux wants to upgrade python to 3.11 next week so we would get stuck with a broken sagemath.",
    "created_at": "2022-11-01T03:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477778",
    "user": "https://github.com/tornaria"
}
```

I pushed all my patches in the branch `u/tornaria/py311`:

```
$ git log1 trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311 
6010f52588e (HEAD -> py311, trac/u/tornaria/py311) fix argspec -> fullargspec
21762fa3bc6 warnings: ignore deprecation of importlib.resources.path/read_binary
98598ba0aa3 doctest: message added more info in python 3.11
07acbc4509f doctest: AssertionError message changed in python 3.11
2a4ced7e1a1 changed argspec.keywords -> argspec.varkw
b09c738c6ed doctests: fix more due to ArgSpec -> FullArgSpec
a65553aae06 warnings: ignore deprecation for 'import sre_constants' in pyparsing
f91d711b3c2 Fix FullArgSpec calls after 9eb08f3afde3266bbd667e196513240a0fe245f4
14c91ec77de doctest: fix in sage.misc.sageinspect due to ArgSpec -> FullArgSpec
186d921e70c warnings: ignore deprecation for 'import cgi' in cython
0d34a14717c fix fpickle for python 3.11
a0078320c55 deprecated uu -> base64
bed2c03e6d5 don't use broken del_dictitem_by_exact_value (temporary?)
```

Only a a few remaining doctest failures, most (all?) seem related to the hack I did to get through the `WeakValueDictionary` problem.

If anyone can think of a good workaround (or a proper fix) for `WeakValueDictionary`... It seems void linux wants to upgrade python to 3.11 next week so we would get stuck with a broken sagemath.



---

archive/issue_comments_477779.json:
```json
{
    "body": "Test failures remaining:\n\n```\nsage/structure/coerce_dict.pyx  # 1 doctest failed\nsage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed\nsage/misc/weak_dict.pyx  # 11 doctests failed\nsage/cpython/dict_del_by_value.pyx  # Timed out\nsage/symbolic/function.pyx  # RuntimeError in doctesting framework\n```\nThe first four look related to the weak dict issue. The last one, I'm not sure.",
    "created_at": "2022-11-01T03:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477779",
    "user": "https://github.com/tornaria"
}
```

Test failures remaining:

```
sage/structure/coerce_dict.pyx  # 1 doctest failed
sage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed
sage/misc/weak_dict.pyx  # 11 doctests failed
sage/cpython/dict_del_by_value.pyx  # Timed out
sage/symbolic/function.pyx  # RuntimeError in doctesting framework
```
The first four look related to the weak dict issue. The last one, I'm not sure.



---

archive/issue_comments_477780.json:
```json
{
    "body": "Replying to [comment:35 Matthias K\u00f6ppe]:\n> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8\n\n\nIs it really necessary to support 3.8? It seems the way deprecation/removal works in python is meant to support 3 versions (e.g. new feature added in 3.9, old feature removed in 3.11). There is a similar cadence with the deprecation `importlib.resources.{path,read_binary}`: these are deprecated in 3.11, but the alternative api (`importlib.resources.files`) was introduced in 3.9, so we can't rewrite the code now if we have to support 3.8.\n\nAs a point of reference, debian stable ships 3.9.",
    "created_at": "2022-11-02T12:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477780",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:35 Matthias Köppe]:
> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8


Is it really necessary to support 3.8? It seems the way deprecation/removal works in python is meant to support 3 versions (e.g. new feature added in 3.9, old feature removed in 3.11). There is a similar cadence with the deprecation `importlib.resources.{path,read_binary}`: these are deprecated in 3.11, but the alternative api (`importlib.resources.files`) was introduced in 3.9, so we can't rewrite the code now if we have to support 3.8.

As a point of reference, debian stable ships 3.9.



---

archive/issue_comments_477781.json:
```json
{
    "body": "Replying to [comment:70 Gonzalo Tornar\u00eda]:\n> Replying to [comment:35 Matthias K\u00f6ppe]:\n> > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8\n\n> \n> Is it really necessary to support 3.8? \n\n\nYes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table",
    "created_at": "2022-11-02T17:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477781",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:70 Gonzalo Tornaría]:
> Replying to [comment:35 Matthias Köppe]:
> > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8

> 
> Is it really necessary to support 3.8? 


Yes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table



---

archive/issue_comments_477782.json:
```json
{
    "body": "For `importlib.resources`, a backport package is available.",
    "created_at": "2022-11-02T17:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477782",
    "user": "https://github.com/mkoeppe"
}
```

For `importlib.resources`, a backport package is available.



---

archive/issue_comments_477783.json:
```json
{
    "body": "Replying to [comment:71 Matthias K\u00f6ppe]:\n> Replying to [comment:70 Gonzalo Tornar\u00eda]:\n> > Replying to [comment:35 Matthias K\u00f6ppe]:\n> > > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8\n\n> > \n> > Is it really necessary to support 3.8? \n\n> \n> Yes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table\n\n\nBut Sage ships a vendored python so dropping support for python 3.8 does not make it unusable. I'd guess in a system with python 3.8, other python packages required by sage will also be outdated so the difference between using system python or the vendored in one is not that big.",
    "created_at": "2022-11-02T20:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477783",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:71 Matthias Köppe]:
> Replying to [comment:70 Gonzalo Tornaría]:
> > Replying to [comment:35 Matthias Köppe]:
> > > I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8

> > 
> > Is it really necessary to support 3.8? 

> 
> Yes, I think so. Even NEP 29 only drops 3.8 on Apr 14, 2023. https://numpy.org/neps/nep-0029-deprecation_policy.html#support-table


But Sage ships a vendored python so dropping support for python 3.8 does not make it unusable. I'd guess in a system with python 3.8, other python packages required by sage will also be outdated so the difference between using system python or the vendored in one is not that big.



---

archive/issue_comments_477784.json:
```json
{
    "body": "Report on the remaining doctest failures:\n- Obviously caused by the change dicts in python 3.11:\n\n```\nsage/cpython/dict_del_by_value.pyx  # Timed out`\n```\n- These are caused by \"the hack\" replacing calls to `del_dictitem_by_exact_value` by `pass`:\n\n```\nsage/structure/coerce_dict.pyx  # 1 doctest failed\nsage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed\nsage/misc/weak_dict.pyx  # 11 doctests failed\n```\n In fact, I compiled my `u/tornaria/py311` branch using python 3.10 (so, with \"the hack\"), and I get the exact same failures (meaning all my changes are compatible at least with python 3.10).\n- A failure that is almost surely unrelated:\n\n```\nsage/symbolic/function.pyx  # RuntimeError in doctesting framework\n```\n This failure does not happen with python 3.10 (even with \"the hack\"). I will comment more about this.",
    "created_at": "2022-11-02T20:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477784",
    "user": "https://github.com/tornaria"
}
```

Report on the remaining doctest failures:
- Obviously caused by the change dicts in python 3.11:

```
sage/cpython/dict_del_by_value.pyx  # Timed out`
```
- These are caused by "the hack" replacing calls to `del_dictitem_by_exact_value` by `pass`:

```
sage/structure/coerce_dict.pyx  # 1 doctest failed
sage/modules/free_quadratic_module_integer_symmetric.py  # 1 doctest failed
sage/misc/weak_dict.pyx  # 11 doctests failed
```
 In fact, I compiled my `u/tornaria/py311` branch using python 3.10 (so, with "the hack"), and I get the exact same failures (meaning all my changes are compatible at least with python 3.10).
- A failure that is almost surely unrelated:

```
sage/symbolic/function.pyx  # RuntimeError in doctesting framework
```
 This failure does not happen with python 3.10 (even with "the hack"). I will comment more about this.



---

archive/issue_comments_477785.json:
```json
{
    "body": "About the last failure, here's a one-liner that causes the runtime error:\n\n```\nsage: loads(dumps(function(\"foo\", nargs=0, eval_func=lambda self:0)))()\nUnexpected exception formatting exception. Falling back to standard exception\nUnexpected exception formatting exception. Falling back to standard exception\nUnexpected exception formatting exception. Falling back to standard exception\nError in sys.excepthook:\nTraceback (most recent call last):\n  File \"/usr/lib/python3.11/pathlib.py\", line 1250, in is_dir\n    return S_ISDIR(self.stat().st_mode)\n                   ^^^^^^^^^\nAttributeError: 'str' object has no attribute 'stat'\n\nOriginal exception was:\nTraceback (most recent call last):\n  File \"/usr/lib/python3.11/site-packages/IPython/core/interactiveshell.py\", line 3378, in run_code\n    exec(code_obj, self.user_global_ns, self.user_ns)\n  File \"<ipython-input-1-5d60a76861b0>\", line 1, in <module>\n  File \"sage/symbolic/function.pyx\", line 547, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:6279)\n  File \"sage/symbolic/pynac_function_impl.pxi\", line 1, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111832)\n  File \"sage/symbolic/pynac_function_impl.pxi\", line 47, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111428)\n  File \"<ipython-input-1-5d60a76861b0>\", line -1, in <lambda>\nNameError: name 'Integer' is not defined\n\nDuring handling of the above exception, another exception occurred:\n\n...\n```\nIf anybody has a clue... please help.\n\nIn case it's useful, here is another failure, may be caused by the same bug, that does not cause a runtime error:\n\n```\nsage: foo = function(\"foo\", nargs=0, eval_func=lambda self:0)\nsage: bar = loads(dumps(foo))\nsage: bar == foo\nFalse\n```\nOf course, the runtime error is there, lurking, if you just do `bar()` you get the same runtime error as above. I tried to follow the code for `bar()` but there's so many indirection layers that my head overflowed in the attempt.",
    "created_at": "2022-11-02T20:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477785",
    "user": "https://github.com/tornaria"
}
```

About the last failure, here's a one-liner that causes the runtime error:

```
sage: loads(dumps(function("foo", nargs=0, eval_func=lambda self:0)))()
Unexpected exception formatting exception. Falling back to standard exception
Unexpected exception formatting exception. Falling back to standard exception
Unexpected exception formatting exception. Falling back to standard exception
Error in sys.excepthook:
Traceback (most recent call last):
  File "/usr/lib/python3.11/pathlib.py", line 1250, in is_dir
    return S_ISDIR(self.stat().st_mode)
                   ^^^^^^^^^
AttributeError: 'str' object has no attribute 'stat'

Original exception was:
Traceback (most recent call last):
  File "/usr/lib/python3.11/site-packages/IPython/core/interactiveshell.py", line 3378, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File "<ipython-input-1-5d60a76861b0>", line 1, in <module>
  File "sage/symbolic/function.pyx", line 547, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.c:6279)
  File "sage/symbolic/pynac_function_impl.pxi", line 1, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111832)
  File "sage/symbolic/pynac_function_impl.pxi", line 47, in sage.symbolic.expression.call_registered_function (build/cythonized/sage/symbolic/expression.cpp:111428)
  File "<ipython-input-1-5d60a76861b0>", line -1, in <lambda>
NameError: name 'Integer' is not defined

During handling of the above exception, another exception occurred:

...
```
If anybody has a clue... please help.

In case it's useful, here is another failure, may be caused by the same bug, that does not cause a runtime error:

```
sage: foo = function("foo", nargs=0, eval_func=lambda self:0)
sage: bar = loads(dumps(foo))
sage: bar == foo
False
```
Of course, the runtime error is there, lurking, if you just do `bar()` you get the same runtime error as above. I tried to follow the code for `bar()` but there's so many indirection layers that my head overflowed in the attempt.



---

archive/issue_comments_477786.json:
```json
{
    "body": "I pushed a new commit to my branch `u/tornaria/py311` which fixes the issue from the previous comment:\n\n```\n8934024438e (trac/u/tornaria/py311) (corrected) fix fpickle for python 3.11\n```\nIt turns out my previous fix for fpickle was incorrect (I missed that `co_lnotab` had to be changed to `co_linetable`).\n\nI added a test that will (hopefully) catch other mistakes like this.\n\n---\n\nNow all that remains (it seems) is for someone to reimplement `del_dictitem_by_exact_value(...)`. Maybe there's a python way to acomplish the same (delete an item in a dict) even if it's a bit slower...\n\nMy hack (using pass) seems to behave ok, other than causing memory leaks. I'd happily trade a small slowdown for fixing this memory leaks. I wonder if there are any benchmarks that show how bad this really is...",
    "created_at": "2022-11-02T21:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477786",
    "user": "https://github.com/tornaria"
}
```

I pushed a new commit to my branch `u/tornaria/py311` which fixes the issue from the previous comment:

```
8934024438e (trac/u/tornaria/py311) (corrected) fix fpickle for python 3.11
```
It turns out my previous fix for fpickle was incorrect (I missed that `co_lnotab` had to be changed to `co_linetable`).

I added a test that will (hopefully) catch other mistakes like this.

---

Now all that remains (it seems) is for someone to reimplement `del_dictitem_by_exact_value(...)`. Maybe there's a python way to acomplish the same (delete an item in a dict) even if it's a bit slower...

My hack (using pass) seems to behave ok, other than causing memory leaks. I'd happily trade a small slowdown for fixing this memory leaks. I wonder if there are any benchmarks that show how bad this really is...



---

archive/issue_comments_477787.json:
```json
{
    "body": "This seems to work:\n\n```\ndiff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx\nindex 930aa31bd1b..724f57f421c 100644\n--- a/src/sage/misc/weak_dict.pyx\n+++ b/src/sage/misc/weak_dict.pyx\n@@ -139,6 +139,10 @@ cdef extern from \"Python.h\":\n     PyObject* PyWeakref_GetObject(PyObject *ref)\n     int PyTuple_SetItem(PyObject *op, Py_ssize_t i, PyObject *newitem) except -1\n \n+    int _PyDict_DelItem_KnownHash(PyObject *mp, PyObject *key,\n+                                  Py_hash_t hash) except -1\n+    PyObject* _PyDict_GetItem_KnownHash(PyObject *mp, PyObject *key,\n+                                        Py_hash_t hash)\n \n cdef class WeakValueDictEraser:\n     \"\"\"\n@@ -212,11 +216,16 @@ cdef class WeakValueDictEraser:\n             return\n         # The situation is the following:\n         # in the underlying dictionary, we have stored a KeyedRef r\n-        # under a key k. The attribute r.key is the hash of k.\n+        # under a key k. The attribute r.key is (k, hash(k))\n         if D._guard_level:\n             D._pending_removals.append(r)\n         else:\n-            pass\n+            if _PyDict_GetItem_KnownHash(<PyObject *>D,\n+                                         <PyObject *>r.key[0],\n+                                         r.key[1]) == <PyObject *>r:\n+                _PyDict_DelItem_KnownHash(<PyObject *>D,\n+                                          <PyObject *>r.key[0],\n+                                          r.key[1])\n \n \n cdef class WeakValueDictionary(dict):\n@@ -548,7 +557,7 @@ cdef class WeakValueDictionary(dict):\n         add a weak reference to ``v`` under the key ``k`` in the actual\n         dict underlying ``self``.\n         \"\"\"\n-        PyDict_SetItem(self, k, KeyedRef(v, self.callback, hash(k)))\n+        PyDict_SetItem(self, k, KeyedRef(v, self.callback, (k, hash(k))))\n \n     # def __delitem__(self, k):\n     # we do not really have to override this method.\n```\n\nThere's a double lookup, but it doesn't seem possible to avoid it using python API. But this seems to work as expected.\n\nAll tests pass on python 3.10 and 3.11. Can someone test 3.8 and 3.9? This is all pushed to my branch.\n\nNote: I didn't touch `src/sage/cpython/dict_del_by_value.pyx` so expect (and ignore) a doctest timeout for that file on python 3.11.",
    "created_at": "2022-11-03T13:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477787",
    "user": "https://github.com/tornaria"
}
```

This seems to work:

```
diff --git a/src/sage/misc/weak_dict.pyx b/src/sage/misc/weak_dict.pyx
index 930aa31bd1b..724f57f421c 100644
--- a/src/sage/misc/weak_dict.pyx
+++ b/src/sage/misc/weak_dict.pyx
@@ -139,6 +139,10 @@ cdef extern from "Python.h":
     PyObject* PyWeakref_GetObject(PyObject *ref)
     int PyTuple_SetItem(PyObject *op, Py_ssize_t i, PyObject *newitem) except -1
 
+    int _PyDict_DelItem_KnownHash(PyObject *mp, PyObject *key,
+                                  Py_hash_t hash) except -1
+    PyObject* _PyDict_GetItem_KnownHash(PyObject *mp, PyObject *key,
+                                        Py_hash_t hash)
 
 cdef class WeakValueDictEraser:
     """
@@ -212,11 +216,16 @@ cdef class WeakValueDictEraser:
             return
         # The situation is the following:
         # in the underlying dictionary, we have stored a KeyedRef r
-        # under a key k. The attribute r.key is the hash of k.
+        # under a key k. The attribute r.key is (k, hash(k))
         if D._guard_level:
             D._pending_removals.append(r)
         else:
-            pass
+            if _PyDict_GetItem_KnownHash(<PyObject *>D,
+                                         <PyObject *>r.key[0],
+                                         r.key[1]) == <PyObject *>r:
+                _PyDict_DelItem_KnownHash(<PyObject *>D,
+                                          <PyObject *>r.key[0],
+                                          r.key[1])
 
 
 cdef class WeakValueDictionary(dict):
@@ -548,7 +557,7 @@ cdef class WeakValueDictionary(dict):
         add a weak reference to ``v`` under the key ``k`` in the actual
         dict underlying ``self``.
         """
-        PyDict_SetItem(self, k, KeyedRef(v, self.callback, hash(k)))
+        PyDict_SetItem(self, k, KeyedRef(v, self.callback, (k, hash(k))))
 
     # def __delitem__(self, k):
     # we do not really have to override this method.
```

There's a double lookup, but it doesn't seem possible to avoid it using python API. But this seems to work as expected.

All tests pass on python 3.10 and 3.11. Can someone test 3.8 and 3.9? This is all pushed to my branch.

Note: I didn't touch `src/sage/cpython/dict_del_by_value.pyx` so expect (and ignore) a doctest timeout for that file on python 3.11.



---

archive/issue_comments_477788.json:
```json
{
    "body": "Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:\n\n```\n**********************************************************************\nFile \"/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/rings/finite_rings/residue_field.pyx\", line 732, in sage.rings.finite_rings.residue_field.ResidueField_generic.lift_map\nFailed example:\n    R = QQ[3^(1/3)]\nExpected nothing\nGot:\n    Exception ignored in: <sage.structure.coerce_dict.TripleDictEraser object at 0x7fa2fc27a050>\n    Traceback (most recent call last):\n      File \"sage/structure/coerce_dict.pyx\", line 979, in sage.structure.coerce_dict.TripleDictEraser.__call__ (build/cythonized/sage/structure/coerce_dict.c:6393)\n    AssertionError: TripleDictEraser: key match but no weakref match\n**********************************************************************\n```\nThis only happens when the change of the previous comment is applied.\nIt looks like some kind of race condition. No clue. Someone please help/comment (Nils?).",
    "created_at": "2022-11-04T12:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477788",
    "user": "https://github.com/tornaria"
}
```

Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:

```
**********************************************************************
File "/builddir/sage-9.7/pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311/sage/rings/finite_rings/residue_field.pyx", line 732, in sage.rings.finite_rings.residue_field.ResidueField_generic.lift_map
Failed example:
    R = QQ[3^(1/3)]
Expected nothing
Got:
    Exception ignored in: <sage.structure.coerce_dict.TripleDictEraser object at 0x7fa2fc27a050>
    Traceback (most recent call last):
      File "sage/structure/coerce_dict.pyx", line 979, in sage.structure.coerce_dict.TripleDictEraser.__call__ (build/cythonized/sage/structure/coerce_dict.c:6393)
    AssertionError: TripleDictEraser: key match but no weakref match
**********************************************************************
```
This only happens when the change of the previous comment is applied.
It looks like some kind of race condition. No clue. Someone please help/comment (Nils?).



---

archive/issue_comments_477789.json:
```json
{
    "body": "Here is a current summary of my branch `u/tornaria/py311`:\n\n```\n$ git log1 --first-parent  trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311\n7b6fa565f42 (trac/u/tornaria/py311) doctests: message added more info in python 3.11\n482dd1ac3d2 doctests: AssertionError message changed in python 3.11\n44480f4827e doctests: fixes due to ArgSpec -> FullArgSpec change\n08e1161c23c warnings: ignore deprecation of importlib.resources.path/read_binary\n664fc008ed5 warnings: ignore deprecation for 'import sre_constants' in pyparsing\ndb45aebfd6b warnings: ignore deprecation for 'import cgi' in cython\n8b0dac2322d Fix FullArgSpec usage after 9eb08f3afde3266bbd667e196513240a0fe245f4\ndc8e155994a sage.misc.fpickle: fix for python 3.11\n014c2ac9a6f deprecated uu -> base64\n76040803c8a dict_del_by_value: add internal definitions for python 3.11\n8955607c71c dict_del_by_value: move python internal definitions to a separate file\n274230f72fa Merge tag '9.8.beta3' into u/mkoeppe/test_ticket__python_3_11\n```\n\nWith this, I have all tests passing, both python 3.10 (tested on this branch) and 3.11 (tested on sage 9.7).\n\nOne exception: there is one failure with python 3.10 in `src/sage/repl/attach.py` due to the last commit (7b6fa565f42). I used `...` to represent \"0 or more random lines\", but it seems it only represents \"1 or more random lines\".\n\nIn case it is useful, the changes I am applying to 9.7 are all commits listed above (except the merge) plus:\n\n```\n9eb08f3afde inspect.ArgSpec -> inspect.FullArgSpec\nde38bac21e2 src/sage: Apply python-3.11.patch ...\n```",
    "created_at": "2022-11-06T21:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477789",
    "user": "https://github.com/tornaria"
}
```

Here is a current summary of my branch `u/tornaria/py311`:

```
$ git log1 --first-parent  trac/u/mkoeppe/test_ticket__python_3_11..trac/u/tornaria/py311
7b6fa565f42 (trac/u/tornaria/py311) doctests: message added more info in python 3.11
482dd1ac3d2 doctests: AssertionError message changed in python 3.11
44480f4827e doctests: fixes due to ArgSpec -> FullArgSpec change
08e1161c23c warnings: ignore deprecation of importlib.resources.path/read_binary
664fc008ed5 warnings: ignore deprecation for 'import sre_constants' in pyparsing
db45aebfd6b warnings: ignore deprecation for 'import cgi' in cython
8b0dac2322d Fix FullArgSpec usage after 9eb08f3afde3266bbd667e196513240a0fe245f4
dc8e155994a sage.misc.fpickle: fix for python 3.11
014c2ac9a6f deprecated uu -> base64
76040803c8a dict_del_by_value: add internal definitions for python 3.11
8955607c71c dict_del_by_value: move python internal definitions to a separate file
274230f72fa Merge tag '9.8.beta3' into u/mkoeppe/test_ticket__python_3_11
```

With this, I have all tests passing, both python 3.10 (tested on this branch) and 3.11 (tested on sage 9.7).

One exception: there is one failure with python 3.10 in `src/sage/repl/attach.py` due to the last commit (7b6fa565f42). I used `...` to represent "0 or more random lines", but it seems it only represents "1 or more random lines".

In case it is useful, the changes I am applying to 9.7 are all commits listed above (except the merge) plus:

```
9eb08f3afde inspect.ArgSpec -> inspect.FullArgSpec
de38bac21e2 src/sage: Apply python-3.11.patch ...
```



---

archive/issue_comments_477790.json:
```json
{
    "body": "Replying to [comment:35 Matthias K\u00f6ppe]:\n> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8\n\n\nThis is what `Doc/whatsnew/3.11.rst` (python source) has to say about it:\n\n```\n* Since :c:func:`Py_TYPE()` is changed to a inline static function,\n  ``Py_TYPE(obj) = new_type`` must be replaced with\n  ``Py_SET_TYPE(obj, new_type)``: see the :c:func:`Py_SET_TYPE()` function\n  (available since Python 3.9). For backward compatibility, this macro can be\n  used::\n\n      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)\n      static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)\n      { ob->ob_type = type; }\n      #define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)\n      #endif\n\n  (Contributed by Victor Stinner in :issue:`39573`.)\n\n* Since :c:func:`Py_SIZE()` is changed to a inline static function,\n  ``Py_SIZE(obj) = new_size`` must be replaced with\n  ``Py_SET_SIZE(obj, new_size)``: see the :c:func:`Py_SET_SIZE()` function\n  (available since Python 3.9). For backward compatibility, this macro can be\n  used::\n\n      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)\n      static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)\n      { ob->ob_size = size; }\n      #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)\n      #endif\n\n  (Contributed by Victor Stinner in :issue:`39573`.)\n```",
    "created_at": "2022-11-06T21:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477790",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:35 Matthias Köppe]:
> I think we need to conditionalize this - `Py_SET_TYPE`, `Py_SET_SIZE` were added in 3.9, but we still support 3.8


This is what `Doc/whatsnew/3.11.rst` (python source) has to say about it:

```
* Since :c:func:`Py_TYPE()` is changed to a inline static function,
  ``Py_TYPE(obj) = new_type`` must be replaced with
  ``Py_SET_TYPE(obj, new_type)``: see the :c:func:`Py_SET_TYPE()` function
  (available since Python 3.9). For backward compatibility, this macro can be
  used::

      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)
      static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)
      { ob->ob_type = type; }
      #define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)
      #endif

  (Contributed by Victor Stinner in :issue:`39573`.)

* Since :c:func:`Py_SIZE()` is changed to a inline static function,
  ``Py_SIZE(obj) = new_size`` must be replaced with
  ``Py_SET_SIZE(obj, new_size)``: see the :c:func:`Py_SET_SIZE()` function
  (available since Python 3.9). For backward compatibility, this macro can be
  used::

      #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)
      static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)
      { ob->ob_size = size; }
      #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)
      #endif

  (Contributed by Victor Stinner in :issue:`39573`.)
```



---

archive/issue_comments_477791.json:
```json
{
    "body": "Replying to [comment:78 Gonzalo Tornar\u00eda]:\n> Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:\n> \n> ```\n> **********************************************************************\n> ...\n>     AssertionError: TripleDictEraser: key match but no weakref match\n> **********************************************************************\n> ```\n> This only happens when the change of the previous comment is applied.\n> It looks like some kind of race condition. No clue. Someone please help/comment (Nils?).\n\n\nA quick word about this. It seems `PyDict_GetItem*` and friends will be calling `PyObject_RichCompareBool` to compare keys, for some reason this is what breaks the `TripleDictEraser` (I guess when it happens inside a erase callback).\n\nAnyway, I bite the bullet and refactored `del_dictitem_by_exact_value()` in a way that the \"internal\" python dict definitions needed are all in an external `.h` file //copied verbatim// from python sources. This makes it easier to port it in case of changes in python.  \n\n```\n76040803c8a dict_del_by_value: add internal definitions for python 3.11\n8955607c71c dict_del_by_value: move python internal definitions to a separate file\n```\nHere the first commit 8955607c71c does the refactor using definitions copied from python 3.8 and should be functionally noop (still working for python <= 3.10, still broken for python 3.11). The second commit 76040803c8a only changes the external `.h` file to (conditionally) use definitions copied from python 3.11.",
    "created_at": "2022-11-06T22:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477791",
    "user": "https://github.com/tornaria"
}
```

Replying to [comment:78 Gonzalo Tornaría]:
> Just as a heads up, with the last version all doctests pass for me (both python 3.10 and 3.11) except for the following //ocassional// failure:
> 
> ```
> **********************************************************************
> ...
>     AssertionError: TripleDictEraser: key match but no weakref match
> **********************************************************************
> ```
> This only happens when the change of the previous comment is applied.
> It looks like some kind of race condition. No clue. Someone please help/comment (Nils?).


A quick word about this. It seems `PyDict_GetItem*` and friends will be calling `PyObject_RichCompareBool` to compare keys, for some reason this is what breaks the `TripleDictEraser` (I guess when it happens inside a erase callback).

Anyway, I bite the bullet and refactored `del_dictitem_by_exact_value()` in a way that the "internal" python dict definitions needed are all in an external `.h` file //copied verbatim// from python sources. This makes it easier to port it in case of changes in python.  

```
76040803c8a dict_del_by_value: add internal definitions for python 3.11
8955607c71c dict_del_by_value: move python internal definitions to a separate file
```
Here the first commit 8955607c71c does the refactor using definitions copied from python 3.8 and should be functionally noop (still working for python <= 3.10, still broken for python 3.11). The second commit 76040803c8a only changes the external `.h` file to (conditionally) use definitions copied from python 3.11.



---

archive/issue_comments_477792.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2022-11-11T19:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477792",
    "user": "https://github.com/mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_477793.json:
```json
{
    "body": "For the record: on void linux we are shipping sagemath 9.7 with python 3.11 (and pari 2.15, gap 4.12) everything seems in working order (x86_64, x86_64-musl, i686, as usual; unfortunately we don't have native builders for aarch64 and some dependencies of sagemath don't cross build).\n\nIn case it is useful, our patches:\n\nhttps://github.com/void-linux/void-packages/tree/master/srcpkgs/sagemath/patches\n\nAll of them are in trac: #34669 #33360 #33446 #33842 #34118 #34391 #34465 #34537 #34668.",
    "created_at": "2022-11-12T13:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477793",
    "user": "https://github.com/tornaria"
}
```

For the record: on void linux we are shipping sagemath 9.7 with python 3.11 (and pari 2.15, gap 4.12) everything seems in working order (x86_64, x86_64-musl, i686, as usual; unfortunately we don't have native builders for aarch64 and some dependencies of sagemath don't cross build).

In case it is useful, our patches:

https://github.com/void-linux/void-packages/tree/master/srcpkgs/sagemath/patches

All of them are in trac: #34669 #33360 #33446 #33842 #34118 #34391 #34465 #34537 #34668.



---

archive/issue_comments_477794.json:
```json
{
    "body": "As per comment:80, something like the following should restore support for python 3.8, but I have not tested it. \n\n\n```\ndiff --git a/src/sage/cpython/cython_metaclass.h b/src/sage/cpython/cython_metaclass.h\nindex 6487342b71e..da06ab75a6b 100644\n--- a/src/sage/cpython/cython_metaclass.h\n+++ b/src/sage/cpython/cython_metaclass.h\n@@ -8,6 +8,13 @@\n *                  http://www.gnu.org/licenses/\n *****************************************************************************/\n \n+/* Compatibility for python 3.8, can be removed later */\n+#if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)\n+static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)\n+{ ob->ob_type = type; }\n+#define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)\n+#endif\n+\n /* Tuple (None, None, None), initialized as needed */\n static PyObject* NoneNoneNone;\n \ndiff --git a/src/sage/libs/gmp/pylong.pyx b/src/sage/libs/gmp/pylong.pyx\nindex e772b60e3e0..2f7ed35be9d 100644\n--- a/src/sage/libs/gmp/pylong.pyx\n+++ b/src/sage/libs/gmp/pylong.pyx\n@@ -32,6 +32,14 @@ from cpython.longintrepr cimport _PyLong_New, py_long, digit, PyLong_SHIFT\n from .mpz cimport *\n \n cdef extern from *:\n+    \"\"\"\n+    /* Compatibility for python 3.8, can be removed later */\n+    #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)\n+    static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)\n+    { ob->ob_size = size; }\n+    #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)\n+    #endif\n+    \"\"\"\n     void Py_SET_SIZE(object, Py_ssize_t)\n     int hash_bits \"\"\"\n         #ifdef _PyHASH_BITS\n```",
    "created_at": "2022-11-12T14:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477794",
    "user": "https://github.com/tornaria"
}
```

As per comment:80, something like the following should restore support for python 3.8, but I have not tested it. 


```
diff --git a/src/sage/cpython/cython_metaclass.h b/src/sage/cpython/cython_metaclass.h
index 6487342b71e..da06ab75a6b 100644
--- a/src/sage/cpython/cython_metaclass.h
+++ b/src/sage/cpython/cython_metaclass.h
@@ -8,6 +8,13 @@
 *                  http://www.gnu.org/licenses/
 *****************************************************************************/
 
+/* Compatibility for python 3.8, can be removed later */
+#if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_TYPE)
+static inline void _Py_SET_TYPE(PyObject *ob, PyTypeObject *type)
+{ ob->ob_type = type; }
+#define Py_SET_TYPE(ob, type) _Py_SET_TYPE((PyObject*)(ob), type)
+#endif
+
 /* Tuple (None, None, None), initialized as needed */
 static PyObject* NoneNoneNone;
 
diff --git a/src/sage/libs/gmp/pylong.pyx b/src/sage/libs/gmp/pylong.pyx
index e772b60e3e0..2f7ed35be9d 100644
--- a/src/sage/libs/gmp/pylong.pyx
+++ b/src/sage/libs/gmp/pylong.pyx
@@ -32,6 +32,14 @@ from cpython.longintrepr cimport _PyLong_New, py_long, digit, PyLong_SHIFT
 from .mpz cimport *
 
 cdef extern from *:
+    """
+    /* Compatibility for python 3.8, can be removed later */
+    #if PY_VERSION_HEX < 0x030900A4 && !defined(Py_SET_SIZE)
+    static inline void _Py_SET_SIZE(PyVarObject *ob, Py_ssize_t size)
+    { ob->ob_size = size; }
+    #define Py_SET_SIZE(ob, size) _Py_SET_SIZE((PyVarObject*)(ob), size)
+    #endif
+    """
     void Py_SET_SIZE(object, Py_ssize_t)
     int hash_bits """
         #ifdef _PyHASH_BITS
```



---

archive/issue_comments_477795.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-12T15:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477796.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-15T00:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477796",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_477797.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-15T00:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477798.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-15T00:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477798",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_477799.json:
```json
{
    "body": "```\nsage -t --random-seed=71448227821214997139645193792530764629 sage/repl/attach.py\n**********************************************************************\nFile \"sage/repl/attach.py\", line 48, in sage.repl.attach\nFailed example:\n    try:\n        attach(src)\n    except Exception:\n        traceback.print_exc(file=sys.stdout)\nExpected:\n    Traceback (most recent call last):\n    ...\n        exec(code, globals)\n      File \".../foobar.sage....py\", line ..., in <module>\n        raise ValueError(\"third\")   # this should appear in the source snippet\n    ...\n    ValueError: third\nGot:\n    Traceback (most recent call last):\n      File \"<doctest sage.repl.attach[13]>\", line 2, in <module>\n        attach(src)\n      File \"sage/misc/lazy_import.pyx\", line 404, in sage.misc.lazy_import.LazyImport.__call__\n        return self.get_object()(*args, **kwds)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/attach.py\", line 361, in attach\n        load(filename, globals(), attach=True)\n      File \"/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/load.py\", line 266, in load\n        exec(code, globals)\n      File \"/tmp/tmpjm2te3w7/foobar.sagelyxej7m9.py\", line 7, in <module>\n        raise ValueError(\"third\")   # this should appear in the source snippet\n    ValueError: third\n```",
    "created_at": "2022-11-15T05:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477799",
    "user": "https://github.com/mkoeppe"
}
```

```
sage -t --random-seed=71448227821214997139645193792530764629 sage/repl/attach.py
**********************************************************************
File "sage/repl/attach.py", line 48, in sage.repl.attach
Failed example:
    try:
        attach(src)
    except Exception:
        traceback.print_exc(file=sys.stdout)
Expected:
    Traceback (most recent call last):
    ...
        exec(code, globals)
      File ".../foobar.sage....py", line ..., in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ...
    ValueError: third
Got:
    Traceback (most recent call last):
      File "<doctest sage.repl.attach[13]>", line 2, in <module>
        attach(src)
      File "sage/misc/lazy_import.pyx", line 404, in sage.misc.lazy_import.LazyImport.__call__
        return self.get_object()(*args, **kwds)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/attach.py", line 361, in attach
        load(filename, globals(), attach=True)
      File "/__w/sagetrac-mirror/sagetrac-mirror/src/sage/repl/load.py", line 266, in load
        exec(code, globals)
      File "/tmp/tmpjm2te3w7/foobar.sagelyxej7m9.py", line 7, in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ValueError: third
```



---

archive/issue_comments_477800.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-15T05:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477801.json:
```json
{
    "body": "```\n[sagemath_doc_html-none] OSError: docstring of sage.misc.fpickle.reduce_code:9: WARNING: Inline emphasis start-string without end-string.\n```",
    "created_at": "2022-11-15T05:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477801",
    "user": "https://github.com/mkoeppe"
}
```

```
[sagemath_doc_html-none] OSError: docstring of sage.misc.fpickle.reduce_code:9: WARNING: Inline emphasis start-string without end-string.
```



---

archive/issue_comments_477802.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-15T05:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477802",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477803.json:
```json
{
    "body": "Is comment:50 resolved?",
    "created_at": "2022-11-15T07:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477803",
    "user": "https://github.com/mkoeppe"
}
```

Is comment:50 resolved?



---

archive/issue_comments_477804.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-15T17:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477804",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477805.json:
```json
{
    "body": "a lot of \"slated for removal\" messages",
    "created_at": "2022-11-18T07:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477805",
    "user": "https://github.com/sheerluck"
}
```

a lot of "slated for removal" messages



---

archive/issue_comments_477806.json:
```json
{
    "body": "Replying to [comment:99 Andrew]:\n> a lot of \"slated for removal\" messages\n\n\nYes, there's a lot of work ahead for python 3.12",
    "created_at": "2022-11-24T20:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477806",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:99 Andrew]:
> a lot of "slated for removal" messages


Yes, there's a lot of work ahead for python 3.12



---

archive/issue_comments_477807.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-11-24T21:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477807",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_477808.json:
```json
{
    "body": "Sorry for not pushing the trashcan change. What I did on NixOS was to keep the original `trashcan.patch` that was removed here (well, [the upstream version](https://github.com/cython/cython/commit/f781880b6780117660b2026caadf4a6d7905722f.patch) but that shouldn't matter) and apply https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92.patch on top of it. I don't know if Sage-the-distro would merge the two patches or keep them separate.",
    "created_at": "2022-11-24T21:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477808",
    "user": "https://github.com/collares"
}
```

Sorry for not pushing the trashcan change. What I did on NixOS was to keep the original `trashcan.patch` that was removed here (well, [the upstream version](https://github.com/cython/cython/commit/f781880b6780117660b2026caadf4a6d7905722f.patch) but that shouldn't matter) and apply https://github.com/cython/cython/commit/e337825cdcf5e94d38ba06a0cb0188e99ce0cc92.patch on top of it. I don't know if Sage-the-distro would merge the two patches or keep them separate.



---

archive/issue_comments_477809.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-24T21:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477809",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477810.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-11-24T21:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477810",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_477811.json:
```json
{
    "body": "Let's get this in",
    "created_at": "2022-11-24T23:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477811",
    "user": "https://github.com/mkoeppe"
}
```

Let's get this in



---

archive/issue_comments_477812.json:
```json
{
    "body": "We don't apply trashcan patches on void linux. What are we missing?",
    "created_at": "2022-11-25T01:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477812",
    "user": "https://github.com/tornaria"
}
```

We don't apply trashcan patches on void linux. What are we missing?



---

archive/issue_comments_477813.json:
```json
{
    "body": "see #27267",
    "created_at": "2022-11-25T01:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477813",
    "user": "https://github.com/mkoeppe"
}
```

see #27267



---

archive/issue_comments_477814.json:
```json
{
    "body": "Replying to [comment:99 Andrew]:\n> a lot of \"slated for removal\" messages\n\n\n\"imghdr is deprecated and slated for removal in Python 3.13\" - https://github.com/sphinx-doc/sphinx/issues/10440 (no upstream fix yet)",
    "created_at": "2022-11-25T02:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477814",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:99 Andrew]:
> a lot of "slated for removal" messages


"imghdr is deprecated and slated for removal in Python 3.13" - https://github.com/sphinx-doc/sphinx/issues/10440 (no upstream fix yet)



---

archive/issue_comments_477815.json:
```json
{
    "body": "```\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.11/lib/python3.11/site-packages/babel/messages/catalog.py\", line 15, in <module>\n        from cgi import parse_header\n      File \"<frozen importlib._bootstrap>\", line 1178, in _find_and_load\n      File \"<frozen importlib._bootstrap>\", line 1149, in _find_and_load_unlocked\n      File \"<frozen importlib._bootstrap>\", line 690, in _load_unlocked\n      File \"<frozen importlib._bootstrap_external>\", line 940, in exec_module\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/cgi.py\", line 57, in <module>\n        warnings._deprecated(__name__, remove=(3,13))\n      File \"/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py\", line 514, in _deprecated\n        warn(msg, DeprecationWarning, stacklevel=3)\n      File \"/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13\n```\nfixed by https://babel.pocoo.org/en/latest/changelog.html#version-2-11-0",
    "created_at": "2022-11-25T02:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477815",
    "user": "https://github.com/mkoeppe"
}
```

```
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.11/lib/python3.11/site-packages/babel/messages/catalog.py", line 15, in <module>
        from cgi import parse_header
      File "<frozen importlib._bootstrap>", line 1178, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1149, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 940, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/cgi.py", line 57, in <module>
        warnings._deprecated(__name__, remove=(3,13))
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py", line 514, in _deprecated
        warn(msg, DeprecationWarning, stacklevel=3)
      File "/usr/local/Cellar/python@3.11/3.11.0/Frameworks/Python.framework/Versions/3.11/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13
```
fixed by https://babel.pocoo.org/en/latest/changelog.html#version-2-11-0



---

archive/issue_comments_477816.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-25T02:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477816",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477817.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-25T02:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477817",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_477818.json:
```json
{
    "body": "Seems to build okay. Are the various authors happy with the other authors' changes?",
    "created_at": "2022-11-29T19:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477818",
    "user": "https://github.com/jhpalmieri"
}
```

Seems to build okay. Are the various authors happy with the other authors' changes?



---

archive/issue_comments_477819.json:
```json
{
    "body": "lgtm",
    "created_at": "2022-11-30T18:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477819",
    "user": "https://github.com/dimpase"
}
```

lgtm



---

archive/issue_comments_477820.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-11-30T18:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477820",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_477821.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-11-30T19:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477821",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_477822.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-12-04T20:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477822",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_477823.json:
```json
{
    "body": "Various doctests fail with the `C` locale, that should imho really work as a safe fallback:\n\n```\n$ LC_ALL=C ./sage -t --long --random-seed=0 src/doc/en/developer/coding_basics.rst\nRunning doctests with ID 2022-12-04-21-15-33-272176ee.\nGit branch: develop\nGit ref: 9.8.beta4-236-gf646e74ba03\nRunning with SAGE_LOCAL='/home/release/Sage/local' and SAGE_VENV='/home/release/Sage/local/var/lib/sage/venv-python3.11.0'\nUsing --optional=fedora,pip,sage,sage_spkg\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_cubic_hecke,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.misc.cython,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst\n**********************************************************************\nFile \"src/doc/en/developer/coding_basics.rst\", line 767, in doc.en.developer.coding_basics\nFailed example:\n    sage_getdoc(foo)              # class docstring\nExpected:\n    'Construct a Foo.\\n'\nGot:\n    doctest:warning\n      File \"/home/release/Sage/src/bin/sage-runtests\", line 154, in <module>\n        err = DC.run()\n      File \"/home/release/Sage/src/sage/doctest/control.py\", line 1384, in run\n        self.run_doctests()\n      File \"/home/release/Sage/src/sage/doctest/control.py\", line 1059, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/home/release/Sage/src/sage/doctest/forker.py\", line 2021, in dispatch\n        self.parallel_dispatch()\n      File \"/home/release/Sage/src/sage/doctest/forker.py\", line 1916, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/home/release/Sage/src/sage/doctest/forker.py\", line 2190, in start\n        super().start()\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/process.py\", line 121, in start\n        self._popen = self._Popen(self)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py\", line 224, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py\", line 281, in _Popen\n[...]\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/docutils/utils/error_reporting.py\", line 49, in <module>\n        locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/locale.py\", line 559, in getdefaultlocale\n        warnings.warn(\n      File \"/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: Use setlocale(), getencoding() and getlocale() instead\n    'Construct a Foo.\\n'\n**********************************************************************\n1 item had failures:\n   1 of  61 in doc.en.developer.coding_basics\n    [44 tests, 1 failure, 0.86 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2022-12-04T20:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477823",
    "user": "https://github.com/vbraun"
}
```

Various doctests fail with the `C` locale, that should imho really work as a safe fallback:

```
$ LC_ALL=C ./sage -t --long --random-seed=0 src/doc/en/developer/coding_basics.rst
Running doctests with ID 2022-12-04-21-15-33-272176ee.
Git branch: develop
Git ref: 9.8.beta4-236-gf646e74ba03
Running with SAGE_LOCAL='/home/release/Sage/local' and SAGE_VENV='/home/release/Sage/local/var/lib/sage/venv-python3.11.0'
Using --optional=fedora,pip,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_cubic_hecke,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,msolve,nauty,palp,pandoc,pdf2svg,pdftocairo,phitigra,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.misc.cython,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst
**********************************************************************
File "src/doc/en/developer/coding_basics.rst", line 767, in doc.en.developer.coding_basics
Failed example:
    sage_getdoc(foo)              # class docstring
Expected:
    'Construct a Foo.\n'
Got:
    doctest:warning
      File "/home/release/Sage/src/bin/sage-runtests", line 154, in <module>
        err = DC.run()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1384, in run
        self.run_doctests()
      File "/home/release/Sage/src/sage/doctest/control.py", line 1059, in run_doctests
        self.dispatcher.dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2021, in dispatch
        self.parallel_dispatch()
      File "/home/release/Sage/src/sage/doctest/forker.py", line 1916, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/release/Sage/src/sage/doctest/forker.py", line 2190, in start
        super().start()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/multiprocessing/context.py", line 281, in _Popen
[...]
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/docutils/utils/error_reporting.py", line 49, in <module>
        locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/locale.py", line 559, in getdefaultlocale
        warnings.warn(
      File "/home/release/Sage/local/var/lib/sage/venv-python3.11.0/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Use setlocale(), getencoding() and getlocale() instead
    'Construct a Foo.\n'
**********************************************************************
1 item had failures:
   1 of  61 in doc.en.developer.coding_basics
    [44 tests, 1 failure, 0.86 s]
----------------------------------------------------------------------
sage -t --long --warn-long 37.0 --random-seed=0 src/doc/en/developer/coding_basics.rst  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_477824.json:
```json
{
    "body": "This seems to come from `docutils`, which is upgraded in #34795 (please review).",
    "created_at": "2022-12-04T20:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477824",
    "user": "https://github.com/mkoeppe"
}
```

This seems to come from `docutils`, which is upgraded in #34795 (please review).



---

archive/issue_comments_477825.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-12-04T22:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477825",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_477826.json:
```json
{
    "body": "Replying to [comment:117 Matthias K\u00f6ppe]:\n> This seems to come from `docutils`, which is upgraded in #34795 (please review).\n\n\nI actually see that particular doctest failure in sage-on-gentoo with docutils 0.19 and sphinx 5.3.0. Scratch that, I get a different deprecation warning at the end. So docutils may help with that particular one but there are other for which #34795 may help.\n\n```\n      File \"/usr/lib/python3.11/site-packages/babel/messages/catalog.py\", line 13, in <module>\n        from cgi import parse_header\n      File \"<frozen importlib._bootstrap>\", line 1178, in _find_and_load\n      File \"<frozen importlib._bootstrap>\", line 1149, in _find_and_load_unlocked\n      File \"<frozen importlib._bootstrap>\", line 690, in _load_unlocked\n      File \"<frozen importlib._bootstrap_external>\", line 940, in exec_module\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"/usr/lib/python3.11/cgi.py\", line 57, in <module>\n        warnings._deprecated(__name__, remove=(3,13))\n      File \"/usr/lib/python3.11/warnings.py\", line 514, in _deprecated\n        warn(msg, DeprecationWarning, stacklevel=3)\n      File \"/usr/lib/python3.11/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13\n    'Construct a Foo.\\n'\n```",
    "created_at": "2022-12-04T22:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477826",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:117 Matthias Köppe]:
> This seems to come from `docutils`, which is upgraded in #34795 (please review).


I actually see that particular doctest failure in sage-on-gentoo with docutils 0.19 and sphinx 5.3.0. Scratch that, I get a different deprecation warning at the end. So docutils may help with that particular one but there are other for which #34795 may help.

```
      File "/usr/lib/python3.11/site-packages/babel/messages/catalog.py", line 13, in <module>
        from cgi import parse_header
      File "<frozen importlib._bootstrap>", line 1178, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1149, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 940, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.11/cgi.py", line 57, in <module>
        warnings._deprecated(__name__, remove=(3,13))
      File "/usr/lib/python3.11/warnings.py", line 514, in _deprecated
        warn(msg, DeprecationWarning, stacklevel=3)
      File "/usr/lib/python3.11/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: 'cgi' is deprecated and slated for removal in Python 3.13
    'Construct a Foo.\n'
```



---

archive/issue_comments_477827.json:
```json
{
    "body": "Upgrading babel from 2.10.3 to 2.11.0 got rid of that warning. sage is on 2.9.x, may be it is just an issue in 2.10.x.",
    "created_at": "2022-12-04T23:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477827",
    "user": "https://github.com/kiwifb"
}
```

Upgrading babel from 2.10.3 to 2.11.0 got rid of that warning. sage is on 2.9.x, may be it is just an issue in 2.10.x.



---

archive/issue_comments_477828.json:
```json
{
    "body": "The babel 2.11 upgrade is already here on the branch",
    "created_at": "2022-12-04T23:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477828",
    "user": "https://github.com/mkoeppe"
}
```

The babel 2.11 upgrade is already here on the branch



---

archive/issue_comments_477829.json:
```json
{
    "body": "Replying to [comment:121 Matthias K\u00f6ppe]:\n> The babel 2.11 upgrade is already here on the branch\n\n\nSo it is! Sorry for the noise.",
    "created_at": "2022-12-04T23:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477829",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:121 Matthias Köppe]:
> The babel 2.11 upgrade is already here on the branch


So it is! Sorry for the noise.



---

archive/issue_comments_477830.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-12-10T23:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477830",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_477831.json:
```json
{
    "body": "I'm getting (Debian 11 32-bit)\n\n```\nERROR: Package 'sagemath-standard' requires a different Python: 3.11.0 not in '<3.11,>=3.8'\n```",
    "created_at": "2022-12-10T23:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477831",
    "user": "https://github.com/vbraun"
}
```

I'm getting (Debian 11 32-bit)

```
ERROR: Package 'sagemath-standard' requires a different Python: 3.11.0 not in '<3.11,>=3.8'
```



---

archive/issue_comments_477832.json:
```json
{
    "body": "forgot to run bootstrap?",
    "created_at": "2022-12-10T23:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477832",
    "user": "https://github.com/mkoeppe"
}
```

forgot to run bootstrap?



---

archive/issue_comments_477833.json:
```json
{
    "body": "The buildbot doesn't have autotools, so it might have gotten the old version\n\nWhat I was trying to debug was ginac seemingly not linking with python 3.11\n\n```\n[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: \u2018GiNaC::_ex72.GiNaC::ptr<GiNaC::basic>::p\u2019 is used uninitialized in this function [-Wuninitialized]\n[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }\n[sagelib-9.8.beta4]           |                                     ~~~~~~^\n[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: \u2018GiNaC::_ex120.GiNaC::ptr<GiNaC::basic>::p\u2019 is used uninitialized in this function [-Wuninitialized]\n[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }\n[sagelib-9.8.beta4]           |                                     ~~~~~~^\n[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: \u2018GiNaC::_ex144.GiNaC::ptr<GiNaC::basic>::p\u2019 is used uninitialized in this function [-Wuninitialized]\n[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }\n[sagelib-9.8.beta4]           |                                     ~~~~~~^\n[sagelib-9.8.beta4]     INFO: gcc: sage/symbolic/ginac/wildcard.cpp\n[sagelib-9.8.beta4]     INFO: g++ -std=gnu++11 -shared -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -L. -Wl,-rpath,. -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -g -O2 build/temp.linux-i686-cpython-311/sage/symbolic/expression.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/add.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/archive.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/assume.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/basic.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/cmatcher.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/constant.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/context.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/ex.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expair.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expairseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/exprseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/fderivative.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function_info.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infinity.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infoflagbase.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_comb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_gamma.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperg.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_nstdsums.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_orthopoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trans.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trig.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_zeta.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/lst.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/matrix.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-giac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-singular.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mul.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/normal.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/numeric.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/operators.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/order.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/power.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/print.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/pseries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/py_funcs.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/registrar.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/relational.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/remember.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/sum.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/symbol.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/templates.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/upoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/useries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/utils.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/wildcard.o -L/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -lflint -lgmp -lSingular -ldl -lpolys -lflint -lmpfr -lgmp -lgmp -ldl -lfactory -lflint -lmpfr -lgmp -lntl -lgmp -lomalloc -lsingular_resources -lgsl -lm -lopenblas -lm -o build/lib.linux-i686-cpython-311/sage/symbolic/expression.cpython-311-i386-linux-gnu.so -lpari\n[sagelib-9.8.beta4]     error: Command \"gcc -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -fPIC -I/var/lib/buildbot/worker/sage_git/build/src -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/numpy/core/include -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -c sage/categories/category_cy_helper.c -o build/temp.linux-i686-cpython-311/sage/categories/category_cy_helper.o\" failed with exit status 1\n[sagelib-9.8.beta4]     error: subprocess-exited-with-error\n[sagelib-9.8.beta4]     \n[sagelib-9.8.beta4]     \u00d7 python setup.py develop did not run successfully.\n[sagelib-9.8.beta4]     \u2502 exit code: 1\n[sagelib-9.8.beta4]     \u2570\u2500> See above for output.\n[sagelib-9.8.beta4]     \n```\nfull log at http://build.sagemath.org/#/builders/47/builds/8/steps/9/logs/stdio",
    "created_at": "2022-12-11T12:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477833",
    "user": "https://github.com/vbraun"
}
```

The buildbot doesn't have autotools, so it might have gotten the old version

What I was trying to debug was ginac seemingly not linking with python 3.11

```
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex72.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex120.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     sage/symbolic/ginac/ptr.h:73:43: warning: ‘GiNaC::_ex144.GiNaC::ptr<GiNaC::basic>::p’ is used uninitialized in this function [-Wuninitialized]
[sagelib-9.8.beta4]        73 |  ptr(const ptr & other) throw() : p(other.p) { p->add_reference(); }
[sagelib-9.8.beta4]           |                                     ~~~~~~^
[sagelib-9.8.beta4]     INFO: gcc: sage/symbolic/ginac/wildcard.cpp
[sagelib-9.8.beta4]     INFO: g++ -std=gnu++11 -shared -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -L. -Wl,-rpath,. -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath-link,/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/lib -Wl,-rpath,/var/lib/buildbot/worker/sage_git/build/local/lib -g -O2 build/temp.linux-i686-cpython-311/sage/symbolic/expression.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/add.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/archive.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/assume.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/basic.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/cmatcher.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/constant.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/context.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/ex.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expair.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/expairseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/exprseq.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/fderivative.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/function_info.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infinity.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/infoflagbase.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_comb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_gamma.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperb.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_hyperg.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_nstdsums.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_orthopoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trans.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_trig.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/inifcns_zeta.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/lst.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/matrix.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-giac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly-singular.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mpoly.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/mul.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/normal.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/numeric.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/operators.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/order.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/power.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/print.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/pseries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/py_funcs.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/registrar.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/relational.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/remember.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/sum.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/symbol.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/templates.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/upoly-ginac.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/useries.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/utils.o build/temp.linux-i686-cpython-311/sage/symbolic/ginac/wildcard.o -L/var/lib/buildbot/worker/sage_git/build/local/lib -L/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib -lflint -lgmp -lSingular -ldl -lpolys -lflint -lmpfr -lgmp -lgmp -ldl -lfactory -lflint -lmpfr -lgmp -lntl -lgmp -lomalloc -lsingular_resources -lgsl -lm -lopenblas -lm -o build/lib.linux-i686-cpython-311/sage/symbolic/expression.cpython-311-i386-linux-gnu.so -lpari
[sagelib-9.8.beta4]     error: Command "gcc -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -g -O2 -g -O2 -fPIC -I/var/lib/buildbot/worker/sage_git/build/src -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/lib/python3.11/site-packages/numpy/core/include -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -I/var/lib/buildbot/worker/sage_git/build/local/var/lib/sage/venv-python3.11.0/include/python3.11 -c sage/categories/category_cy_helper.c -o build/temp.linux-i686-cpython-311/sage/categories/category_cy_helper.o" failed with exit status 1
[sagelib-9.8.beta4]     error: subprocess-exited-with-error
[sagelib-9.8.beta4]     
[sagelib-9.8.beta4]     × python setup.py develop did not run successfully.
[sagelib-9.8.beta4]     │ exit code: 1
[sagelib-9.8.beta4]     ╰─> See above for output.
[sagelib-9.8.beta4]     
```
full log at http://build.sagemath.org/#/builders/47/builds/8/steps/9/logs/stdio



---

archive/issue_comments_477834.json:
```json
{
    "body": "I see more errors in this log:\n\n```\n[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c: In function \u2018__pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer\u2019:\n[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1425:50: error: \u2018PyTrash_UNWIND_LEVEL\u2019 undeclared (first use in this function)\n[sagelib-9.8.beta4]      1425 |             if (_tstate->trash_delete_nesting >= PyTrash_UNWIND_LEVEL) {\\\n[sagelib-9.8.beta4]           |                                                  ^~~~~~~~~~~~~~~~~~~~\n[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1438:43: note: in expansion of macro \u2018__Pyx_TRASHCAN_BEGIN_CONDITION\u2019\n[sagelib-9.8.beta4]      1438 | #define __Pyx_TRASHCAN_BEGIN(op, dealloc) __Pyx_TRASHCAN_BEGIN_CONDITION(op,\\\n[sagelib-9.8.beta4]           |                                           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:4408:3: note: in expansion of macro \u2018__Pyx_TRASHCAN_BEGIN\u2019\n[sagelib-9.8.beta4]      4408 |   __Pyx_TRASHCAN_BEGIN(o, __pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer)\n[sagelib-9.8.beta4]           |   ^~~~~~~~~~~~~~~~~~~~\n```",
    "created_at": "2022-12-11T21:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477834",
    "user": "https://github.com/mkoeppe"
}
```

I see more errors in this log:

```
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c: In function ‘__pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer’:
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1425:50: error: ‘PyTrash_UNWIND_LEVEL’ undeclared (first use in this function)
[sagelib-9.8.beta4]      1425 |             if (_tstate->trash_delete_nesting >= PyTrash_UNWIND_LEVEL) {\
[sagelib-9.8.beta4]           |                                                  ^~~~~~~~~~~~~~~~~~~~
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:1438:43: note: in expansion of macro ‘__Pyx_TRASHCAN_BEGIN_CONDITION’
[sagelib-9.8.beta4]      1438 | #define __Pyx_TRASHCAN_BEGIN(op, dealloc) __Pyx_TRASHCAN_BEGIN_CONDITION(op,\
[sagelib-9.8.beta4]           |                                           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-9.8.beta4]     sage/categories/category_cy_helper.c:4408:3: note: in expansion of macro ‘__Pyx_TRASHCAN_BEGIN’
[sagelib-9.8.beta4]      4408 |   __Pyx_TRASHCAN_BEGIN(o, __pyx_tp_dealloc_4sage_10categories_18category_cy_helper_AxiomContainer)
[sagelib-9.8.beta4]           |   ^~~~~~~~~~~~~~~~~~~~
```



---

archive/issue_comments_477835.json:
```json
{
    "body": "Is this an incremental build? Note that sagelib switched to the default `--enable-editable`, so you may have Cython artifacts in your source tree",
    "created_at": "2022-12-11T21:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477835",
    "user": "https://github.com/mkoeppe"
}
```

Is this an incremental build? Note that sagelib switched to the default `--enable-editable`, so you may have Cython artifacts in your source tree



---

archive/issue_comments_477836.json:
```json
{
    "body": "Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:\n\n```\nroot@fd2f063d77c6:/sage# ./sage \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAssertionError: \nAttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)\nException ignored in: 'sage.rings.integer_fake.is_Integer'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAssertionError: \nAttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)\nException ignored in: 'sage.rings.integer_fake.is_Integer'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)\nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 983, in sage.misc.cachefunc.CachedFunction.__call__\n  File \"sage/misc/weak_dict.pyx\", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__\nKeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"sage/structure/category_object.pyx\", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category\nKeyError: '_ComplexField_class__real_field'\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"sage/rings/complex_mpfr.pyx\", line 398, in sage.rings.complex_mpfr.ComplexField_class._real_field\n  File \"sage/structure/category_object.pyx\", line 833, in sage.structure.category_object.CategoryObject.__getattr__\n  File \"sage/structure/category_object.pyx\", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category\n  File \"sage/cpython/getattr.pyx\", line 361, in sage.cpython.getattr.getattr_from_other_class\nAttributeError: 'ComplexField_class' object has no attribute '_ComplexField_class__real_field'\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/cc.py\", line 3, in <module>\n    CC = ComplexField()\n         ^^^^^^^^^^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 983, in sage.misc.cachefunc.CachedFunction.__call__\n  File \"sage/misc/weak_dict.pyx\", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__\nKeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/cc.py\", line 3, in <module>\n    CC = ComplexField()\n         ^^^^^^^^^^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 983, in sage.misc.cachefunc.CachedFunction.__call__\n  File \"sage/misc/weak_dict.pyx\", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__\nKeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/cc.py\", line 3, in <module>\n    CC = ComplexField()\n         ^^^^^^^^^^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 983, in sage.misc.cachefunc.CachedFunction.__call__\n  File \"sage/misc/weak_dict.pyx\", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__\nKeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"sage/structure/category_object.pyx\", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category\nKeyError: 'Element'\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"sage/structure/parent.pyx\", line 1976, in sage.structure.parent.Parent.convert_method_map\n  File \"sage/structure/category_object.pyx\", line 833, in sage.structure.category_object.CategoryObject.__getattr__\n  File \"sage/structure/category_object.pyx\", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category\n  File \"sage/cpython/getattr.pyx\", line 361, in sage.cpython.getattr.getattr_from_other_class\nAttributeError: 'sage.sets.pythonclass.Set_PythonType_class' object has no attribute '_Hom_'\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/structure/unique_representation.py\", line 1007, in __classcall__\n    instance = typecall(cls, *args, **options)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/rings.py\", line 341, in is_zero\n    return self.one() == self.zero()\n           ^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/rings.py\", line 341, in is_zero\n    return self.one() == self.zero()\n                         ^^^^^^^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__\nKeyError: ((0,), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/polynomial/polynomial_element_generic.py\", line 1116, in __init__\n    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__\nKeyError: ((0,), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/polynomial/polynomial_element_generic.py\", line 1116, in __init__\n    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/rings.py\", line 341, in is_zero\n    return self.one() == self.zero()\n           ^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/rings.py\", line 341, in is_zero\n    return self.one() == self.zero()\n                         ^^^^^^^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__\nKeyError: ((0,), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/polynomial/polynomial_element_generic.py\", line 1116, in __init__\n    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)\nAssertionError: \nTraceback (most recent call last):\n  File \"sage/misc/cachefunc.pyx\", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__\nKeyError: ((0,), ())\n\nDuring handling of the above exception, another exception occurred:\n\nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/polynomial/polynomial_element_generic.py\", line 1116, in __init__\n    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/qqbar.py\", line 8625, in <module>\n    qq_generator = AlgebraicGenerator(QQ, ANRoot(AAPoly.gen() - 1, RIF(1)))\n                                                 ~~~~~~~~~~~~~^~~\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/sets_cat.py\", line 1010, in _element_constructor_from_element_class\n    return self.element_class(self, *args, **keywords)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/sets_cat.py\", line 1010, in _element_constructor_from_element_class\n    return self.element_class(self, *args, **keywords)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/sets_cat.py\", line 1010, in _element_constructor_from_element_class\n    return self.element_class(self, *args, **keywords)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/categories/sets_cat.py\", line 1010, in _element_constructor_from_element_class\n    return self.element_class(self, *args, **keywords)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/tate_algebra.py\", line 244, in TateAlgebraFactory\n    def create_key(self, base, prec=None, log_radii=ZZ(0), names=None, order='degrevlex'):\n                                                    ^^^^^\nAssertionError: \nAssertionError\nException ignored in: 'sage.arith.long.integer_check_long_py'\nTraceback (most recent call last):\n  File \"/sage/src/sage/rings/number_field/number_field.py\", line 985, in QuadraticField\n    D = QQ(D)\n        ^^^^^\nAssertionError: \nTraceback (most recent call last):\n  File \"/sage/src/bin/sage-ipython\", line 10, in <module>\n    banner()\n  File \"/sage/src/sage/misc/banner.py\", line 116, in banner\n    print(banner_text(full=True))\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sage/src/sage/misc/banner.py\", line 71, in banner_text\n    import sage.all\n  File \"/sage/src/sage/all.py\", line 160, in <module>\n    from sage.symbolic.all   import *\n  File \"/sage/src/sage/symbolic/all.py\", line 8, in <module>\n    import sage.symbolic.expression  # initialize pynac before .ring\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"sage/symbolic/pynac_impl.pxi\", line 2617, in init sage.symbolic.expression\n  File \"sage/symbolic/pynac_impl.pxi\", line 2518, in sage.symbolic.expression.init_pynac_I\n  File \"/sage/src/sage/rings/number_field/number_field.py\", line 1019, in GaussianField\n    return QuadraticField(-1, 'I', latex_name='i')\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sage/src/sage/rings/number_field/number_field.py\", line 988, in QuadraticField\n    raise ValueError(\"D must not be a perfect square.\")\nValueError: D must not be a perfect square.\n```",
    "created_at": "2022-12-11T21:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477836",
    "user": "https://github.com/mkoeppe"
}
```

Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:

```
root@fd2f063d77c6:/sage# ./sage 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Exception ignored in: 'sage.rings.integer_fake.is_Integer'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Exception ignored in: 'sage.rings.integer_fake.is_Integer'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AttributeError: cannot access submodule 'integer' of module 'sage.rings' (most likely due to a circular import)
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/category_object.pyx", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category
KeyError: '_ComplexField_class__real_field'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/rings/complex_mpfr.pyx", line 398, in sage.rings.complex_mpfr.ComplexField_class._real_field
  File "sage/structure/category_object.pyx", line 833, in sage.structure.category_object.CategoryObject.__getattr__
  File "sage/structure/category_object.pyx", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category
  File "sage/cpython/getattr.pyx", line 361, in sage.cpython.getattr.getattr_from_other_class
AttributeError: 'ComplexField_class' object has no attribute '_ComplexField_class__real_field'

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/cc.py", line 3, in <module>
    CC = ComplexField()
         ^^^^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 983, in sage.misc.cachefunc.CachedFunction.__call__
  File "sage/misc/weak_dict.pyx", line 706, in sage.misc.weak_dict.WeakValueDictionary.__getitem__
KeyError: ((<class 'sage.rings.real_arb.RealBallField'>, 53), ())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/category_object.pyx", line 839, in sage.structure.category_object.CategoryObject.getattr_from_category
KeyError: 'Element'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "sage/structure/parent.pyx", line 1976, in sage.structure.parent.Parent.convert_method_map
  File "sage/structure/category_object.pyx", line 833, in sage.structure.category_object.CategoryObject.__getattr__
  File "sage/structure/category_object.pyx", line 848, in sage.structure.category_object.CategoryObject.getattr_from_category
  File "sage/cpython/getattr.pyx", line 361, in sage.cpython.getattr.getattr_from_other_class
AttributeError: 'sage.sets.pythonclass.Set_PythonType_class' object has no attribute '_Hom_'

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/structure/unique_representation.py", line 1007, in __classcall__
    instance = typecall(cls, *args, **options)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
           ^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
                         ^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
           ^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/rings.py", line 341, in is_zero
    return self.one() == self.zero()
                         ^^^^^^^^^^^
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
Traceback (most recent call last):
  File "sage/misc/cachefunc.pyx", line 1930, in sage.misc.cachefunc.CachedMethodCaller.__call__
KeyError: ((0,), ())

During handling of the above exception, another exception occurred:

AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/polynomial/polynomial_element_generic.py", line 1116, in __init__
    Polynomial_generic_dense.__init__(self, parent, x, check, is_gen)
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/qqbar.py", line 8625, in <module>
    qq_generator = AlgebraicGenerator(QQ, ANRoot(AAPoly.gen() - 1, RIF(1)))
                                                 ~~~~~~~~~~~~~^~~
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/categories/sets_cat.py", line 1010, in _element_constructor_from_element_class
    return self.element_class(self, *args, **keywords)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/tate_algebra.py", line 244, in TateAlgebraFactory
    def create_key(self, base, prec=None, log_radii=ZZ(0), names=None, order='degrevlex'):
                                                    ^^^^^
AssertionError: 
AssertionError
Exception ignored in: 'sage.arith.long.integer_check_long_py'
Traceback (most recent call last):
  File "/sage/src/sage/rings/number_field/number_field.py", line 985, in QuadraticField
    D = QQ(D)
        ^^^^^
AssertionError: 
Traceback (most recent call last):
  File "/sage/src/bin/sage-ipython", line 10, in <module>
    banner()
  File "/sage/src/sage/misc/banner.py", line 116, in banner
    print(banner_text(full=True))
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/sage/src/sage/misc/banner.py", line 71, in banner_text
    import sage.all
  File "/sage/src/sage/all.py", line 160, in <module>
    from sage.symbolic.all   import *
  File "/sage/src/sage/symbolic/all.py", line 8, in <module>
    import sage.symbolic.expression  # initialize pynac before .ring
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "sage/symbolic/pynac_impl.pxi", line 2617, in init sage.symbolic.expression
  File "sage/symbolic/pynac_impl.pxi", line 2518, in sage.symbolic.expression.init_pynac_I
  File "/sage/src/sage/rings/number_field/number_field.py", line 1019, in GaussianField
    return QuadraticField(-1, 'I', latex_name='i')
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/sage/src/sage/rings/number_field/number_field.py", line 988, in QuadraticField
    raise ValueError("D must not be a perfect square.")
ValueError: D must not be a perfect square.
```



---

archive/issue_comments_477837.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-12-12T02:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477837",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_477838.json:
```json
{
    "body": "Replying to [comment:128 Matthias K\u00f6ppe]:\n> Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:\n> \n> ```\n> root@fd2f063d77c6:/sage# ./sage \n> AssertionError\n> Exception ignored in: 'sage.arith.long.integer_check_long_py'\n\n\nI think this may be: [[https://bugs.python.org/issue?@action=redirect&bpo=45569|bpo-45569]]: \"The build now defaults to using 30-bit digits for Python integers. Previously either 15-bit or 30-bit digits would be selected, depending on the platform. 15-bit digits may still be selected using the --enable-big-digits=15 option to the configure script, or by defining PYLONG_BITS_IN_DIGIT in pyconfig.h.\"",
    "created_at": "2022-12-12T02:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477838",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:128 Matthias Köppe]:
> Something else does need to be fixed on 32 bit though. After a successful `make build`, I get the following when starting `./sage`:
> 
> ```
> root@fd2f063d77c6:/sage# ./sage 
> AssertionError
> Exception ignored in: 'sage.arith.long.integer_check_long_py'


I think this may be: [[https://bugs.python.org/issue?@action=redirect&bpo=45569|bpo-45569]]: "The build now defaults to using 30-bit digits for Python integers. Previously either 15-bit or 30-bit digits would be selected, depending on the platform. 15-bit digits may still be selected using the --enable-big-digits=15 option to the configure script, or by defining PYLONG_BITS_IN_DIGIT in pyconfig.h."



---

archive/issue_comments_477839.json:
```json
{
    "body": "This means that the following assumption in src/sage/arith/long.pxd is now violated on 32 bit:\n\n```\n    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a\n    # 64-bit system. This is not guaranteed by Python, but it is the\n    # default configuration.\n    #\n    # This way, we know that 1 and 2 digits certainly fit in a C long\n    # and 4 or more digits never fit. For 3 digits, we need an explicit\n    # overflow check.\n```",
    "created_at": "2022-12-12T03:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477839",
    "user": "https://github.com/mkoeppe"
}
```

This means that the following assumption in src/sage/arith/long.pxd is now violated on 32 bit:

```
    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
    # 64-bit system. This is not guaranteed by Python, but it is the
    # default configuration.
    #
    # This way, we know that 1 and 2 digits certainly fit in a C long
    # and 4 or more digits never fit. For 3 digits, we need an explicit
    # overflow check.
```



---

archive/issue_comments_477840.json:
```json
{
    "body": "Indeed, I missed this but our i686 sage in void linux is broken (I guess nobody uses it).\n\nSomething silly as the following seems to work around the issue (not a proper fix):\n\n```diff\n--- a/src/sage/arith/long.pxd\n+++ b/src/sage/arith/long.pxd\n@@ -213,7 +213,7 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n     # and 4 or more digits never fit. For 3 digits, we need an explicit\n     # overflow check.\n     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1\n-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):\n+    if not (PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):\n         raise AssertionError\n \n     cdef long lead\n@@ -227,6 +227,9 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n     elif size == -1:\n         value[0] = -dig(D, 0)\n         err[0] = 0\n+    elif True:\n+        # ASSUME OVERFLOW\n+        err[0] = ERR_OVERFLOW\n     elif size == 2:\n         value[0] = dig(D, 0) + dig(D, 1)\n         err[0] = 0\n```\n\nMaybe we could just use `PyLong_AsLongAndOverflow` here (https://docs.python.org/3/c-api/long.html#c.PyLong_AsLongAndOverflow).",
    "created_at": "2022-12-12T04:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477840",
    "user": "https://github.com/tornaria"
}
```

Indeed, I missed this but our i686 sage in void linux is broken (I guess nobody uses it).

Something silly as the following seems to work around the issue (not a proper fix):

```diff
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -213,7 +213,7 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
     # and 4 or more digits never fit. For 3 digits, we need an explicit
     # overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
+    if not (PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
         raise AssertionError
 
     cdef long lead
@@ -227,6 +227,9 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
     elif size == -1:
         value[0] = -dig(D, 0)
         err[0] = 0
+    elif True:
+        # ASSUME OVERFLOW
+        err[0] = ERR_OVERFLOW
     elif size == 2:
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
```

Maybe we could just use `PyLong_AsLongAndOverflow` here (https://docs.python.org/3/c-api/long.html#c.PyLong_AsLongAndOverflow).



---

archive/issue_comments_477841.json:
```json
{
    "body": "Possibly better fix (tested only with python 3.11, although the tests `BITS_IN_LONG < 2 * PyLong_SHIFT` should always be false on python <= 3.10 and on 64 bit).\n\n```diff\ndiff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd\nindex e3a9f1586e5..e1e71982c86 100644\n--- a/src/sage/arith/long.pxd\n+++ b/src/sage/arith/long.pxd\n@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n         ....:         if err == 0:\n         ....:             return value\n         ....:         elif err == ERR_OVERFLOW:\n-        ....:             raise OverflowError(\"integer_check_long: overflow\")\n+        ....:             raise OverflowError(f\"integer_check_long: overflow ({x})\")\n         ....:     elif err == ERR_TYPE:\n         ....:         raise TypeError(\"integer_check_long: wrong type\")\n         ....:     elif err == ERR_INDEX:\n@@ -145,15 +145,15 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n         sage: check_long(2^100)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(long_max() + 1)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(long_min() - 1)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(\"hello\")\n         Traceback (most recent call last):\n         ...\n@@ -201,22 +201,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n         err[0] = ERR_TYPE\n         return 0\n \n-    # x is a Python \"long\" (called \"int\" on Python 3)\n+    # x is a Python \"int\" (aka PyLongObject or py_long in cython)\n     cdef const digit* D = (<py_long>x).ob_digit\n     cdef Py_ssize_t size = Py_SIZE(x)\n \n-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a\n-    # 64-bit system. This is not guaranteed by Python, but it is the\n-    # default configuration.\n+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.\n+    # This is true in all the default configurations:\n+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30\n+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)\n+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)\n+    # cf. https://trac.sagemath.org/ticket/33842#comment:130\n     #\n-    # This way, we know that 1 and 2 digits certainly fit in a C long\n-    # and 4 or more digits never fit. For 3 digits, we need an explicit\n-    # overflow check.\n+    # This way, we know that 1 digit certainly fits in a C long\n+    # and 4 or more digits never fit.\n+    # For 2 or 3 digits, we need an explicit overflow check.\n     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1\n-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):\n-        raise AssertionError\n+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):\n+        raise AssertionError(\n+                f\"PyLong_SHIFT = {PyLong_SHIFT}, \"\n+                f\"BITS_IN_LONG = {BITS_IN_LONG}\")\n \n     cdef long lead\n+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)\n     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)\n     if size == 0:\n         value[0] = 0\n@@ -228,9 +234,15 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n         value[0] = -dig(D, 0)\n         err[0] = 0\n     elif size == 2:\n+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:\n+            err[0] = ERR_OVERFLOW\n+            return 1\n         value[0] = dig(D, 0) + dig(D, 1)\n         err[0] = 0\n     elif size == -2:\n+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] > lead_2_overflow:\n+            err[0] = ERR_OVERFLOW\n+            return 1\n         value[0] = -(dig(D, 0) + dig(D, 1))\n         err[0] = 0\n     elif size == 3:\n```",
    "created_at": "2022-12-13T02:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477841",
    "user": "https://github.com/tornaria"
}
```

Possibly better fix (tested only with python 3.11, although the tests `BITS_IN_LONG < 2 * PyLong_SHIFT` should always be false on python <= 3.10 and on 64 bit).

```diff
diff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd
index e3a9f1586e5..e1e71982c86 100644
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         ....:         if err == 0:
         ....:             return value
         ....:         elif err == ERR_OVERFLOW:
-        ....:             raise OverflowError("integer_check_long: overflow")
+        ....:             raise OverflowError(f"integer_check_long: overflow ({x})")
         ....:     elif err == ERR_TYPE:
         ....:         raise TypeError("integer_check_long: wrong type")
         ....:     elif err == ERR_INDEX:
@@ -145,15 +145,15 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         sage: check_long(2^100)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_max() + 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_min() - 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long("hello")
         Traceback (most recent call last):
         ...
@@ -201,22 +201,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         err[0] = ERR_TYPE
         return 0
 
-    # x is a Python "long" (called "int" on Python 3)
+    # x is a Python "int" (aka PyLongObject or py_long in cython)
     cdef const digit* D = (<py_long>x).ob_digit
     cdef Py_ssize_t size = Py_SIZE(x)
 
-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
-    # 64-bit system. This is not guaranteed by Python, but it is the
-    # default configuration.
+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.
+    # This is true in all the default configurations:
+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)
+    # cf. https://trac.sagemath.org/ticket/33842#comment:130
     #
-    # This way, we know that 1 and 2 digits certainly fit in a C long
-    # and 4 or more digits never fit. For 3 digits, we need an explicit
-    # overflow check.
+    # This way, we know that 1 digit certainly fits in a C long
+    # and 4 or more digits never fit.
+    # For 2 or 3 digits, we need an explicit overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
-        raise AssertionError
+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):
+        raise AssertionError(
+                f"PyLong_SHIFT = {PyLong_SHIFT}, "
+                f"BITS_IN_LONG = {BITS_IN_LONG}")
 
     cdef long lead
+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)
     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)
     if size == 0:
         value[0] = 0
@@ -228,9 +234,15 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         value[0] = -dig(D, 0)
         err[0] = 0
     elif size == 2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
     elif size == -2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] > lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = -(dig(D, 0) + dig(D, 1))
         err[0] = 0
     elif size == 3:
```



---

archive/issue_comments_477842.json:
```json
{
    "body": "This mostly works, but I'm getting a bunch of suspicious doctest failures\n\n```\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/hecke/submodule.py  # 10 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/space.py  # 2 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/ring.py  # 1 doctest failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/element.py  # 6 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modsym/space.py  # 1 doctest failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/overconvergent/genus0.py  # 1 doctest failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_field.py  # 1 doctest failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_number_field.py  # 15 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/kraus.py  # 3 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_small_degree.py  # 3 doctests failed\nsage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_class.py  # 9 doctests failed\n```",
    "created_at": "2022-12-13T08:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477842",
    "user": "https://github.com/mkoeppe"
}
```

This mostly works, but I'm getting a bunch of suspicious doctest failures

```
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/hecke/submodule.py  # 10 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/space.py  # 2 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/ring.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modform/element.py  # 6 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/modsym/space.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/modular/overconvergent/genus0.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_field.py  # 1 doctest failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/ell_number_field.py  # 15 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/kraus.py  # 3 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_small_degree.py  # 3 doctests failed
sage -t --random-seed=275402673788319958880996122948129050042 src/sage/schemes/elliptic_curves/isogeny_class.py  # 9 doctests failed
```



---

archive/issue_comments_477843.json:
```json
{
    "body": "My bad, I had a slight mistake so that numbers a little bit smaller than `LONG_MIN` would be mishandled, but only if they are python ints (not ZZ). This seems to be indirectly tested in the docstring for `integer_check_long` but //it is not! //\n\nIt seems I have everything working now, I will wrap and try to push soon (maybe add/copy some doctests to the docstring for `integer_check_long_py` so it's //directly// tested).\n\nIf you want to try it, only the last chunk in the patch above needs to be changed (I also added some new doctests). All the faulty doctests above seem to be fixed now.\n\nApologies for copy-pasting instead of making a proper branch, the push will follow when I cleanup.\n\n```diff\ndiff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd\nindex e3a9f1586e5..2f863f18f10 100644\n--- a/src/sage/arith/long.pxd\n+++ b/src/sage/arith/long.pxd\n@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n         ....:         if err == 0:\n         ....:             return value\n         ....:         elif err == ERR_OVERFLOW:\n-        ....:             raise OverflowError(\"integer_check_long: overflow\")\n+        ....:             raise OverflowError(f\"integer_check_long: overflow ({x})\")\n         ....:     elif err == ERR_TYPE:\n         ....:         raise TypeError(\"integer_check_long: wrong type\")\n         ....:     elif err == ERR_INDEX:\n@@ -140,20 +140,20 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n         sage: L = [1, 12345, 10^9, 2^30, long_max()//9, long_max()//3, long_max()]\n         sage: L += [-x for x in L] + [0, long_min()]\n         sage: for v in L:\n-        ....:     for t in (Integer, int):\n+        ....:     for t in types:\n         ....:         assert check_long(t(v)) == v\n         sage: check_long(2^100)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(long_max() + 1)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(long_min() - 1)\n         Traceback (most recent call last):\n         ...\n-        OverflowError: integer_check_long: overflow\n+        OverflowError: integer_check_long: overflow (...)\n         sage: check_long(\"hello\")\n         Traceback (most recent call last):\n         ...\n@@ -162,6 +162,21 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n         Traceback (most recent call last):\n         ...\n         TypeError: integer_check_long: bad __index__\n+\n+    Repeat the overflow tests with python integers:\n+\n+        sage: check_long(int(2^100))\n+        Traceback (most recent call last):\n+        ...\n+        OverflowError: integer_check_long: overflow (...)\n+        sage: check_long(int(long_max() + 1))\n+        Traceback (most recent call last):\n+        ...\n+        OverflowError: integer_check_long: overflow (...)\n+        sage: check_long(int(long_min() - 1))\n+        Traceback (most recent call last):\n+        ...\n+        OverflowError: integer_check_long: overflow (...)\n     \"\"\"\n     cdef int c = integer_check_long_py(x, value, err)\n     if c:\n@@ -201,22 +216,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n         err[0] = ERR_TYPE\n         return 0\n \n-    # x is a Python \"long\" (called \"int\" on Python 3)\n+    # x is a Python \"int\" (aka PyLongObject or py_long in cython)\n     cdef const digit* D = (<py_long>x).ob_digit\n     cdef Py_ssize_t size = Py_SIZE(x)\n \n-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a\n-    # 64-bit system. This is not guaranteed by Python, but it is the\n-    # default configuration.\n+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.\n+    # This is true in all the default configurations:\n+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30\n+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)\n+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)\n+    # cf. https://trac.sagemath.org/ticket/33842#comment:130\n     #\n-    # This way, we know that 1 and 2 digits certainly fit in a C long\n-    # and 4 or more digits never fit. For 3 digits, we need an explicit\n-    # overflow check.\n+    # This way, we know that 1 digit certainly fits in a C long\n+    # and 4 or more digits never fit.\n+    # For 2 or 3 digits, we need an explicit overflow check.\n     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1\n-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):\n-        raise AssertionError\n+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):\n+        raise AssertionError(\n+                f\"PyLong_SHIFT = {PyLong_SHIFT}, \"\n+                f\"BITS_IN_LONG = {BITS_IN_LONG}\")\n \n     cdef long lead\n+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)\n     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)\n     if size == 0:\n         value[0] = 0\n@@ -228,9 +249,20 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):\n         value[0] = -dig(D, 0)\n         err[0] = 0\n     elif size == 2:\n+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:\n+            err[0] = ERR_OVERFLOW\n+            return 1\n         value[0] = dig(D, 0) + dig(D, 1)\n         err[0] = 0\n     elif size == -2:\n+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:\n+            if D[0] == 0 and D[1] == lead_2_overflow:\n+                # Special case for LONG_MIN\n+                value[0] = (<long>-1) << BITS_IN_LONG\n+                err[0] = 0\n+            else:\n+                err[0] = ERR_OVERFLOW\n+            return 1\n         value[0] = -(dig(D, 0) + dig(D, 1))\n         err[0] = 0\n     elif size == 3:\n```",
    "created_at": "2022-12-14T00:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477843",
    "user": "https://github.com/tornaria"
}
```

My bad, I had a slight mistake so that numbers a little bit smaller than `LONG_MIN` would be mishandled, but only if they are python ints (not ZZ). This seems to be indirectly tested in the docstring for `integer_check_long` but //it is not! //

It seems I have everything working now, I will wrap and try to push soon (maybe add/copy some doctests to the docstring for `integer_check_long_py` so it's //directly// tested).

If you want to try it, only the last chunk in the patch above needs to be changed (I also added some new doctests). All the faulty doctests above seem to be fixed now.

Apologies for copy-pasting instead of making a proper branch, the push will follow when I cleanup.

```diff
diff --git a/src/sage/arith/long.pxd b/src/sage/arith/long.pxd
index e3a9f1586e5..2f863f18f10 100644
--- a/src/sage/arith/long.pxd
+++ b/src/sage/arith/long.pxd
@@ -124,7 +124,7 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         ....:         if err == 0:
         ....:             return value
         ....:         elif err == ERR_OVERFLOW:
-        ....:             raise OverflowError("integer_check_long: overflow")
+        ....:             raise OverflowError(f"integer_check_long: overflow ({x})")
         ....:     elif err == ERR_TYPE:
         ....:         raise TypeError("integer_check_long: wrong type")
         ....:     elif err == ERR_INDEX:
@@ -140,20 +140,20 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         sage: L = [1, 12345, 10^9, 2^30, long_max()//9, long_max()//3, long_max()]
         sage: L += [-x for x in L] + [0, long_min()]
         sage: for v in L:
-        ....:     for t in (Integer, int):
+        ....:     for t in types:
         ....:         assert check_long(t(v)) == v
         sage: check_long(2^100)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_max() + 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long(long_min() - 1)
         Traceback (most recent call last):
         ...
-        OverflowError: integer_check_long: overflow
+        OverflowError: integer_check_long: overflow (...)
         sage: check_long("hello")
         Traceback (most recent call last):
         ...
@@ -162,6 +162,21 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
         Traceback (most recent call last):
         ...
         TypeError: integer_check_long: bad __index__
+
+    Repeat the overflow tests with python integers:
+
+        sage: check_long(int(2^100))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
+        sage: check_long(int(long_max() + 1))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
+        sage: check_long(int(long_min() - 1))
+        Traceback (most recent call last):
+        ...
+        OverflowError: integer_check_long: overflow (...)
     """
     cdef int c = integer_check_long_py(x, value, err)
     if c:
@@ -201,22 +216,28 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         err[0] = ERR_TYPE
         return 0
 
-    # x is a Python "long" (called "int" on Python 3)
+    # x is a Python "int" (aka PyLongObject or py_long in cython)
     cdef const digit* D = (<py_long>x).ob_digit
     cdef Py_ssize_t size = Py_SIZE(x)
 
-    # We assume that PyLong_SHIFT is 15 on a 32-bit system and 30 on a
-    # 64-bit system. This is not guaranteed by Python, but it is the
-    # default configuration.
+    # We assume PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT.
+    # This is true in all the default configurations:
+    # - BITS_IN_LONG = 63, PyLong_SHIFT = 30
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 15 (python <= 3.10)
+    # - BITS_IN_LONG = 31, PyLong_SHIFT = 30 (new in python 3.11)
+    # cf. https://trac.sagemath.org/ticket/33842#comment:130
     #
-    # This way, we know that 1 and 2 digits certainly fit in a C long
-    # and 4 or more digits never fit. For 3 digits, we need an explicit
-    # overflow check.
+    # This way, we know that 1 digit certainly fits in a C long
+    # and 4 or more digits never fit.
+    # For 2 or 3 digits, we need an explicit overflow check.
     cdef int BITS_IN_LONG = 8 * sizeof(long) - 1
-    if not (2 * PyLong_SHIFT <= BITS_IN_LONG < 4 * PyLong_SHIFT):
-        raise AssertionError
+    if not (PyLong_SHIFT <= BITS_IN_LONG <= 3 * PyLong_SHIFT):
+        raise AssertionError(
+                f"PyLong_SHIFT = {PyLong_SHIFT}, "
+                f"BITS_IN_LONG = {BITS_IN_LONG}")
 
     cdef long lead
+    cdef long lead_2_overflow = (<long>1) << (BITS_IN_LONG - PyLong_SHIFT)
     cdef long lead_3_overflow = (<long>1) << (BITS_IN_LONG - 2 * PyLong_SHIFT)
     if size == 0:
         value[0] = 0
@@ -228,9 +249,20 @@ cdef inline bint integer_check_long_py(x, long* value, int* err):
         value[0] = -dig(D, 0)
         err[0] = 0
     elif size == 2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            err[0] = ERR_OVERFLOW
+            return 1
         value[0] = dig(D, 0) + dig(D, 1)
         err[0] = 0
     elif size == -2:
+        if BITS_IN_LONG < 2 * PyLong_SHIFT and D[1] >= lead_2_overflow:
+            if D[0] == 0 and D[1] == lead_2_overflow:
+                # Special case for LONG_MIN
+                value[0] = (<long>-1) << BITS_IN_LONG
+                err[0] = 0
+            else:
+                err[0] = ERR_OVERFLOW
+            return 1
         value[0] = -(dig(D, 0) + dig(D, 1))
         err[0] = 0
     elif size == 3:
```



---

archive/issue_comments_477844.json:
```json
{
    "body": "Probably we should include doctests for the relevant edge cases",
    "created_at": "2022-12-14T00:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477844",
    "user": "https://github.com/mkoeppe"
}
```

Probably we should include doctests for the relevant edge cases



---

archive/issue_comments_477845.json:
```json
{
    "body": "Please test.\n\n---\nNew commits:",
    "created_at": "2022-12-14T03:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477845",
    "user": "https://github.com/tornaria"
}
```

Please test.

---
New commits:



---

archive/issue_comments_477846.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-12-14T03:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477846",
    "user": "https://github.com/tornaria"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_477847.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-14T05:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477847",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_477848.json:
```json
{
    "body": "This works, thanks very much!",
    "created_at": "2022-12-14T05:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477848",
    "user": "https://github.com/mkoeppe"
}
```

This works, thanks very much!



---

archive/issue_comments_477849.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-12-19T16:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477849",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_477850.json:
```json
{
    "body": "I still get the \n\n```\nDeprecationWarning: Use setlocale(), getencoding() and getlocale() instead\n```\non macOS Big Sur, so I guess it wasn't fixed in #34795\n\nPS: Indeed the offending line is here `site-packages/docutils/io.py:30`\n\n```\n     _locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]\n```\n\nPPS: Buildbot locale is:\n\n```\nbuildbot-sage@bigsur-osx build % locale\nLANG=\"\"\nLC_COLLATE=\"C\"\nLC_CTYPE=\"C\"\nLC_MESSAGES=\"C\"\nLC_MONETARY=\"C\"\nLC_NUMERIC=\"C\"\nLC_TIME=\"C\"\nLC_ALL=\nbuildbot-sage@bigsur-osx build % ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.8.beta5, Release Date: 2022-12-11               \u2502\n\u2502 Using Python 3.11.1. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: import locale\nsage: locale.getlocale()\n(None, 'UTF-8')\n```",
    "created_at": "2022-12-19T16:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477850",
    "user": "https://github.com/vbraun"
}
```

I still get the 

```
DeprecationWarning: Use setlocale(), getencoding() and getlocale() instead
```
on macOS Big Sur, so I guess it wasn't fixed in #34795

PS: Indeed the offending line is here `site-packages/docutils/io.py:30`

```
     _locale_encoding = locale.getlocale()[1] or locale.getdefaultlocale()[1]
```

PPS: Buildbot locale is:

```
buildbot-sage@bigsur-osx build % locale
LANG=""
LC_COLLATE="C"
LC_CTYPE="C"
LC_MESSAGES="C"
LC_MONETARY="C"
LC_NUMERIC="C"
LC_TIME="C"
LC_ALL=
buildbot-sage@bigsur-osx build % ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta5, Release Date: 2022-12-11               │
│ Using Python 3.11.1. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import locale
sage: locale.getlocale()
(None, 'UTF-8')
```



---

archive/issue_comments_477851.json:
```json
{
    "body": "Thanks for the details. I think we'll have to suppress the warning. I'll also open an issue with docutils",
    "created_at": "2022-12-19T19:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477851",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for the details. I think we'll have to suppress the warning. I'll also open an issue with docutils



---

archive/issue_comments_477852.json:
```json
{
    "body": "`locale.getlocale()[1]` is `UTF-8`, so getdefaultlocale shouldn't be called there",
    "created_at": "2022-12-19T19:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477852",
    "user": "https://github.com/mkoeppe"
}
```

`locale.getlocale()[1]` is `UTF-8`, so getdefaultlocale shouldn't be called there



---

archive/issue_comments_477853.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-12-19T20:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477853",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_477854.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-12-19T20:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477854",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_477855.json:
```json
{
    "body": "Replying to [comment:140 Matthias K\u00f6ppe]:\n> I'll also open an issue with docutils\n\n\nThat's now https://sourceforge.net/p/docutils/bugs/464/",
    "created_at": "2022-12-19T21:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477855",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:140 Matthias Köppe]:
> I'll also open an issue with docutils


That's now https://sourceforge.net/p/docutils/bugs/464/



---

archive/issue_comments_477856.json:
```json
{
    "body": "```\n$ LC_ALL=C ./sage -tp --all --long \n...\nAll tests passed!\n```",
    "created_at": "2022-12-19T23:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477856",
    "user": "https://github.com/mkoeppe"
}
```

```
$ LC_ALL=C ./sage -tp --all --long 
...
All tests passed!
```



---

archive/issue_comments_477857.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-19T23:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33605#issuecomment-477857",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.
