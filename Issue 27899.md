# Issue 27899: Add number_of_subgroups() method to AbelianGroup

archive/issues_027899.json:
```json
{
    "body": "CC:  @tscrim @fchapoton\n\nKeywords: abelian group fpsac\n\nUsing `len(AbelianGroup(...).subgroups())` to find the number of subgroups of an abelian group is inefficient. Using the function `sage.combinat.q_analogues.q_subgroups_of_abelian_group` should be much faster. This will also allow to find the number of subgroups of a given order.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28136\n\n",
    "created_at": "2019-07-08T15:49:30Z",
    "labels": [
        "group theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Add number_of_subgroups() method to AbelianGroup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27899",
    "user": "@mathzeta"
}
```
CC:  @tscrim @fchapoton

Keywords: abelian group fpsac

Using `len(AbelianGroup(...).subgroups())` to find the number of subgroups of an abelian group is inefficient. Using the function `sage.combinat.q_analogues.q_subgroups_of_abelian_group` should be much faster. This will also allow to find the number of subgroups of a given order.

Issue created by migration from https://trac.sagemath.org/ticket/28136





---

archive/issue_comments_393969.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-12T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393969",
    "user": "@mathzeta"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_393970.json:
```json
{
    "body": "Changing keywords from \"abelian group fpsac\" to \"abelian group fpsac2019\".",
    "created_at": "2019-07-12T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393970",
    "user": "@mathzeta"
}
```

Changing keywords from "abelian group fpsac" to "abelian group fpsac2019".



---

archive/issue_comments_393971.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-12T15:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393971",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393972.json:
```json
{
    "body": "some tests in torsion_subgroup are not testing the right method",
    "created_at": "2019-07-16T19:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393972",
    "user": "@fchapoton"
}
```

some tests in torsion_subgroup are not testing the right method



---

archive/issue_comments_393973.json:
```json
{
    "body": "A few little details in addition to Fr\u00e9d\u00e9ric's comment:\n\nRemove the period at the end here:\n\n```\n        - ``order`` -- (default: ``None``) find the number of subgroups of this\n          order; if ``None``, this defaults to counting all subgroups.\n```\n\n\nTypo: `infinitly` -> `infinitely`\n\nThis is faster:\n\n```diff\n             for p, p_exps in six.iteritems(sylow_types):\n-                p_exps.sort(reverse=True)\n-                p_exps = Partition(p_exps)\n-                orders_by_prime[p] = range(p_exps.size() + 1)\n+                orders_by_prime[p] = range(sum(p_exps) + 1)\n```\n\nthere is no need to create the partition just to get its size.\n\nI don't understand what this code does:\n\n```python\n            for p, p_exps in six.iteritems(sylow_types):\n                p_exps.sort(reverse=True)\n                p_exps = Partition(p_exps)\n                orders_by_prime[p] = [order_exps[p]]\n```\n\n`p_exps` is never used to do any computation. Shouldn't you just remove that part?\n\nI am guessing you are meaning to modify in place the `p_exps`, which the call to `sort` does, but I am pretty sure the `Partition` call does not. In either case, this should be done in the loop you actually use it:\n\n```diff\n         for p, p_exps in six.iteritems(sylow_types):\n             p_result = Integer(0)\n+            p_exps.sort(reverse=True)\n             for i in orders_by_prime[p]:\n                 for mu in Partitions(i, outer=p_exps):\n                     p_result += q_subgroups_of_abelian_group(p_exps, mu, q=p)\n             result *= p_result\n         return result\n```\n",
    "created_at": "2019-07-21T06:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393973",
    "user": "@tscrim"
}
```

A few little details in addition to Frédéric's comment:

Remove the period at the end here:

```
        - ``order`` -- (default: ``None``) find the number of subgroups of this
          order; if ``None``, this defaults to counting all subgroups.
```


Typo: `infinitly` -> `infinitely`

This is faster:

```diff
             for p, p_exps in six.iteritems(sylow_types):
-                p_exps.sort(reverse=True)
-                p_exps = Partition(p_exps)
-                orders_by_prime[p] = range(p_exps.size() + 1)
+                orders_by_prime[p] = range(sum(p_exps) + 1)
```

there is no need to create the partition just to get its size.

I don't understand what this code does:

```python
            for p, p_exps in six.iteritems(sylow_types):
                p_exps.sort(reverse=True)
                p_exps = Partition(p_exps)
                orders_by_prime[p] = [order_exps[p]]
```

`p_exps` is never used to do any computation. Shouldn't you just remove that part?

I am guessing you are meaning to modify in place the `p_exps`, which the call to `sort` does, but I am pretty sure the `Partition` call does not. In either case, this should be done in the loop you actually use it:

```diff
         for p, p_exps in six.iteritems(sylow_types):
             p_result = Integer(0)
+            p_exps.sort(reverse=True)
             for i in orders_by_prime[p]:
                 for mu in Partitions(i, outer=p_exps):
                     p_result += q_subgroups_of_abelian_group(p_exps, mu, q=p)
             result *= p_result
         return result
```




---

archive/issue_comments_393974.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-28T15:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393974",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393975.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> some tests in torsion_subgroup are not testing the right method\n> \nThanks, fixed. Mmmm, that was an embarrassing oversight.\n\nReplying to [comment:4 tscrim]:\n> A few little details in addition to Fr\u00e9d\u00e9ric's comment:\n> \n> Remove the period at the end here:\n> {{{\n>         - ``order`` -- (default: ``None``) find the number of subgroups of this\n>           order; if ``None``, this defaults to counting all subgroups.\n> }}}\n> \n> Typo: `infinitly` -> `infinitely`\n> \n> [...]\nThanks, fixed.\n\nFor the other things, I think I wanted to use the [robustness principle](https://en.wikipedia.org/wiki/Robustness_principle), thinking that `q_subgroups_of_abelian_group` needs to an integer partition for input. Now I removed even importing `Partition` and followed your suggestions.",
    "created_at": "2019-07-28T15:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393975",
    "user": "@mathzeta"
}
```

Replying to [comment:3 chapoton]:
> some tests in torsion_subgroup are not testing the right method
> 
Thanks, fixed. Mmmm, that was an embarrassing oversight.

Replying to [comment:4 tscrim]:
> A few little details in addition to Frédéric's comment:
> 
> Remove the period at the end here:
> {{{
>         - ``order`` -- (default: ``None``) find the number of subgroups of this
>           order; if ``None``, this defaults to counting all subgroups.
> }}}
> 
> Typo: `infinitly` -> `infinitely`
> 
> [...]
Thanks, fixed.

For the other things, I think I wanted to use the [robustness principle](https://en.wikipedia.org/wiki/Robustness_principle), thinking that `q_subgroups_of_abelian_group` needs to an integer partition for input. Now I removed even importing `Partition` and followed your suggestions.



---

archive/issue_comments_393976.json:
```json
{
    "body": "Replying to [comment:6 mathzeta2]:\n> For the other things, I think I wanted to use the [robustness principle](https://en.wikipedia.org/wiki/Robustness_principle), thinking that `q_subgroups_of_abelian_group` needs to an integer partition for input. Now I removed even importing `Partition` and followed your suggestions.\n\nI think my changes might have increased the types of input it could take, but is not so important.\n\nOne last thing I noticed (which should result in a speedup):\n\n```diff\n-            p_result = Integer(0)\n             p_exps.sort(reverse=True)\n-            for i in subgroups_orders_by_prime[p]:\n-                for mu in Partitions(i, outer=p_exps):\n-                    p_result += q_subgroups_of_abelian_group(p_exps, mu, q=p)\n-            result *= p_result\n+            result *= sum(q_subgroups_of_abelian_group(p_exps, mu, q=p)\n+                          for i in subgroups_orders_by_prime[p]\n+                          for mu in Partitions(i, outer=p_exps))\n```\n\nIt would be even faster if you avoided the transient `Partition` objects and just passed a list, but that would mean modifying `q_subgroups_of_abelian_group`, possibly for not much gain. (Definitely a separate ticket.)",
    "created_at": "2019-07-28T18:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393976",
    "user": "@tscrim"
}
```

Replying to [comment:6 mathzeta2]:
> For the other things, I think I wanted to use the [robustness principle](https://en.wikipedia.org/wiki/Robustness_principle), thinking that `q_subgroups_of_abelian_group` needs to an integer partition for input. Now I removed even importing `Partition` and followed your suggestions.

I think my changes might have increased the types of input it could take, but is not so important.

One last thing I noticed (which should result in a speedup):

```diff
-            p_result = Integer(0)
             p_exps.sort(reverse=True)
-            for i in subgroups_orders_by_prime[p]:
-                for mu in Partitions(i, outer=p_exps):
-                    p_result += q_subgroups_of_abelian_group(p_exps, mu, q=p)
-            result *= p_result
+            result *= sum(q_subgroups_of_abelian_group(p_exps, mu, q=p)
+                          for i in subgroups_orders_by_prime[p]
+                          for mu in Partitions(i, outer=p_exps))
```

It would be even faster if you avoided the transient `Partition` objects and just passed a list, but that would mean modifying `q_subgroups_of_abelian_group`, possibly for not much gain. (Definitely a separate ticket.)



---

archive/issue_comments_393977.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-28T22:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393977",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393978.json:
```json
{
    "body": "In general, after trying to use lists instead of `Partition` objects, it always seems like the start of a re-implementation of `Partition`'s methods. I assume speeding up src/sage/combinat/partition.py, for example cythonizing it, will bring more benefit. But that is for a separate ticket, too.\n\nFor `q_subgroups_of_abelian_group`, there is the helper function `sage.combinat.partition.conjugate` which return a list (and is used in `Partition.conjugate`), but it still not enough to remove the convenience of using `Partition`.\n\nInstead of iterating over `Partitions(i, outer=p_exps)` I tried `IntegerListsLex` and there was a speedup. Does the code looks clearer with the \"long\" `sum`? I do not mind making the change.",
    "created_at": "2019-07-28T22:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393978",
    "user": "@mathzeta"
}
```

In general, after trying to use lists instead of `Partition` objects, it always seems like the start of a re-implementation of `Partition`'s methods. I assume speeding up src/sage/combinat/partition.py, for example cythonizing it, will bring more benefit. But that is for a separate ticket, too.

For `q_subgroups_of_abelian_group`, there is the helper function `sage.combinat.partition.conjugate` which return a list (and is used in `Partition.conjugate`), but it still not enough to remove the convenience of using `Partition`.

Instead of iterating over `Partitions(i, outer=p_exps)` I tried `IntegerListsLex` and there was a speedup. Does the code looks clearer with the "long" `sum`? I do not mind making the change.



---

archive/issue_comments_393979.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393979",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_393980.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393980",
    "user": "@mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_393981.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-09T09:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393981",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-09T09:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393982",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393983.json:
```json
{
    "body": "replaced `six.iteritems()` with `.items()`. Ready for review.",
    "created_at": "2020-09-09T09:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393983",
    "user": "@mathzeta"
}
```

replaced `six.iteritems()` with `.items()`. Ready for review.



---

archive/issue_comments_393984.json:
```json
{
    "body": "Put your name down in the author slot so the patchbot will run. Once that comes back green, then positive review. Sorry for loosing track of this.",
    "created_at": "2020-09-09T23:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393984",
    "user": "@tscrim"
}
```

Put your name down in the author slot so the patchbot will run. Once that comes back green, then positive review. Sorry for loosing track of this.



---

archive/issue_comments_393985.json:
```json
{
    "body": "Replying to [comment:16 tscrim]:\n> Put your name down in the author slot so the patchbot will run.\n\nThanks. I forget this, and then wonder why the patchbot did not run.",
    "created_at": "2020-09-09T23:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393985",
    "user": "@mathzeta"
}
```

Replying to [comment:16 tscrim]:
> Put your name down in the author slot so the patchbot will run.

Thanks. I forget this, and then wonder why the patchbot did not run.



---

archive/issue_comments_393986.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-10T15:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393986",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-10T16:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393987",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393988.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-10T21:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393988",
    "user": "@mathzeta"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393989.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-15T21:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27899#issuecomment-393989",
    "user": "@vbraun"
}
```

Resolution: fixed
