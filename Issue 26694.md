# Issue 26694: Predictable sorting in simplicial_complex.py

Issue created by migration from https://trac.sagemath.org/ticket/26931

Original creator: jdemeyer

Original creation time: 2018-12-21 12:50:24

CC:  jhpalmieri




---

Comment by jdemeyer created at 2018-12-21 13:59:21

New commits:


---

Comment by jdemeyer created at 2018-12-21 13:59:21

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2018-12-21 20:14:15

I feel like a need a style guide. Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type? I don't remember seeing that before.

I think that the new doctest

```
+        The vertices can be sorted with a custom key::
+
+            sage: SimplicialComplex([10], sort_facets=str)
+            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
```

should be at the class level so it appears in the reference manual.


---

Comment by jdemeyer created at 2018-12-21 20:18:02

Replying to [comment:5 jhpalmieri]:
> I don't remember seeing that before.

It's implicit in a lot of Cython code. But you're right that maybe no Python code in Sage uses it so far.


---

Comment by jdemeyer created at 2018-12-21 20:25:57

Replying to [comment:5 jhpalmieri]:
> Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type?

It's also generally not needed in Sage since we typically convert to a Sage `Integer`, not a Python `int`. However, `range()` requires an `int`.


---

Comment by git created at 2018-12-22 15:46:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-12-22 15:47:42

Replying to [comment:5 jhpalmieri]:
> I think that the new doctest
> {{{
> +        The vertices can be sorted with a custom key::
> +
> +            sage: SimplicialComplex([10], sort_facets=str)
> +            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
> }}}
> should be at the class level so it appears in the reference manual. 

Done.


---

Comment by jhpalmieri created at 2018-12-22 21:20:14

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2018-12-22 21:20:14

Great, thanks.


---

Comment by vbraun created at 2018-12-23 23:39:25

Resolution: fixed


---

Comment by jhpalmieri created at 2018-12-28 22:33:49

I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.


---

Comment by jdemeyer created at 2018-12-29 10:09:05

Replying to [comment:12 jhpalmieri]:
> I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.

Even then, I still think that this ticket is an improvement. The changes to the code make sense, so it should just be a matter of specifying the appropriate sorting key.


---

Comment by jhpalmieri created at 2018-12-29 19:27:32

Okay, what is the appropriate sorting key? For example, if you take the disjoint union of two simplicial complexes which use different sorting keys, how do you sort the result?

We can put bandaids on this for now, and on one hand, with a few changes, I can decrease the number of failures quite a bit, so that it fixes not just the problems caused by this ticket but (combined with your changes) fixes other problems, too. On the other hand, the whole thing looks very fragile: someone could very easily construct simplicial complexes which break sorting, and once the sorting is lost, homology calculations are unreliable.

So I am not convinced that this ticket as it stands is an improvement. 

One way to fix could be to create new classes for each construction, like `DisjointUnion`, which keeps track of the factors and sorts in each factor separately. I am very much tempted to roll back this ticket and leave it open as a future enhancement.

Here are some methods which need attention:
- product
- join
- disjoint_union
- wedge
- connected_sum
- link
- star
- generated_subcomplex
- alexander_dual
- stellar_subdivision
- n_skeleton
- connected_component
- fixed_complex
- intersection
- `_contractible_subcomplex`
- `_enlarge_subcomplex`
- `__copy__`

and there are probably others
