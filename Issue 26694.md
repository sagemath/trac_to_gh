# Issue 26694: Predictable sorting in simplicial_complex.py

archive/issues_026694.json:
```json
{
    "body": "CC:  @jhpalmieri\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26931\n\n",
    "created_at": "2018-12-21T12:50:24Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "Predictable sorting in simplicial_complex.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26694",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @jhpalmieri



Issue created by migration from https://trac.sagemath.org/ticket/26931





---

archive/issue_comments_374934.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-21T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374934",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_374935.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-21T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374935",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_374936.json:
```json
{
    "body": "I feel like a need a style guide. Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type? I don't remember seeing that before.\n\nI think that the new doctest\n\n```\n+        The vertices can be sorted with a custom key::\n+\n+            sage: SimplicialComplex([10], sort_facets=str)\n+            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}\n```\n\nshould be at the class level so it appears in the reference manual.",
    "created_at": "2018-12-21T20:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374936",
    "user": "https://github.com/jhpalmieri"
}
```

I feel like a need a style guide. Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type? I don't remember seeing that before.

I think that the new doctest

```
+        The vertices can be sorted with a custom key::
+
+            sage: SimplicialComplex([10], sort_facets=str)
+            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
```

should be at the class level so it appears in the reference manual.



---

archive/issue_comments_374937.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> I don't remember seeing that before.\n\nIt's implicit in a lot of Cython code. But you're right that maybe no Python code in Sage uses it so far.",
    "created_at": "2018-12-21T20:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374937",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> I don't remember seeing that before.

It's implicit in a lot of Cython code. But you're right that maybe no Python code in Sage uses it so far.



---

archive/issue_comments_374938.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type?\n\nIt's also generally not needed in Sage since we typically convert to a Sage `Integer`, not a Python `int`. However, `range()` requires an `int`.",
    "created_at": "2018-12-21T20:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374938",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type?

It's also generally not needed in Sage since we typically convert to a Sage `Integer`, not a Python `int`. However, `range()` requires an `int`.



---

archive/issue_comments_374939.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-22T15:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374939",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_374940.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> I think that the new doctest\n> {{{\n> +        The vertices can be sorted with a custom key::\n> +\n> +            sage: SimplicialComplex([10], sort_facets=str)\n> +            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}\n> }}}\n> should be at the class level so it appears in the reference manual. \n\nDone.",
    "created_at": "2018-12-22T15:47:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374940",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> I think that the new doctest
> {{{
> +        The vertices can be sorted with a custom key::
> +
> +            sage: SimplicialComplex([10], sort_facets=str)
> +            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
> }}}
> should be at the class level so it appears in the reference manual. 

Done.



---

archive/issue_comments_374941.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-22T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374941",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_374942.json:
```json
{
    "body": "Great, thanks.",
    "created_at": "2018-12-22T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374942",
    "user": "https://github.com/jhpalmieri"
}
```

Great, thanks.



---

archive/issue_comments_374943.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374943",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_024791.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-12-23T23:39:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26694#event-24791"
}
```



---

archive/issue_comments_374944.json:
```json
{
    "body": "I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.",
    "created_at": "2018-12-28T22:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374944",
    "user": "https://github.com/jhpalmieri"
}
```

I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.



---

archive/issue_comments_374945.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.\n\nEven then, I still think that this ticket is an improvement. The changes to the code make sense, so it should just be a matter of specifying the appropriate sorting key.",
    "created_at": "2018-12-29T10:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374945",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 jhpalmieri]:
> I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.

Even then, I still think that this ticket is an improvement. The changes to the code make sense, so it should just be a matter of specifying the appropriate sorting key.



---

archive/issue_comments_374946.json:
```json
{
    "body": "Okay, what is the appropriate sorting key? For example, if you take the disjoint union of two simplicial complexes which use different sorting keys, how do you sort the result?\n\nWe can put bandaids on this for now, and on one hand, with a few changes, I can decrease the number of failures quite a bit, so that it fixes not just the problems caused by this ticket but (combined with your changes) fixes other problems, too. On the other hand, the whole thing looks very fragile: someone could very easily construct simplicial complexes which break sorting, and once the sorting is lost, homology calculations are unreliable.\n\nSo I am not convinced that this ticket as it stands is an improvement. \n\nOne way to fix could be to create new classes for each construction, like `DisjointUnion`, which keeps track of the factors and sorts in each factor separately. I am very much tempted to roll back this ticket and leave it open as a future enhancement.\n\nHere are some methods which need attention:\n- product\n- join\n- disjoint_union\n- wedge\n- connected_sum\n- link\n- star\n- generated_subcomplex\n- alexander_dual\n- stellar_subdivision\n- n_skeleton\n- connected_component\n- fixed_complex\n- intersection\n- `_contractible_subcomplex`\n- `_enlarge_subcomplex`\n- `__copy__`\n\nand there are probably others",
    "created_at": "2018-12-29T19:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26694#issuecomment-374946",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, what is the appropriate sorting key? For example, if you take the disjoint union of two simplicial complexes which use different sorting keys, how do you sort the result?

We can put bandaids on this for now, and on one hand, with a few changes, I can decrease the number of failures quite a bit, so that it fixes not just the problems caused by this ticket but (combined with your changes) fixes other problems, too. On the other hand, the whole thing looks very fragile: someone could very easily construct simplicial complexes which break sorting, and once the sorting is lost, homology calculations are unreliable.

So I am not convinced that this ticket as it stands is an improvement. 

One way to fix could be to create new classes for each construction, like `DisjointUnion`, which keeps track of the factors and sorts in each factor separately. I am very much tempted to roll back this ticket and leave it open as a future enhancement.

Here are some methods which need attention:
- product
- join
- disjoint_union
- wedge
- connected_sum
- link
- star
- generated_subcomplex
- alexander_dual
- stellar_subdivision
- n_skeleton
- connected_component
- fixed_complex
- intersection
- `_contractible_subcomplex`
- `_enlarge_subcomplex`
- `__copy__`

and there are probably others
