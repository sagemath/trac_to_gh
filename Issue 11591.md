# Issue 11591: Parents for polyhedra

Issue created by migration from https://trac.sagemath.org/ticket/11763

Original creator: vbraun

Original creation time: 2011-08-31 14:13:15

Assignee: mhampton

CC:  robertwb

The Polyhedron class is, so far, free-standing with some sort of coercion for the base ring tacked manually. This ticket strives to add parents for polyhedra and make the base ring coercion work more naturally. 

There will be 3 supported base rings:
  * ZZ (meaning that the polyhedron is a lattice polytope, that is, both H- and V-representation are defined over ZZ)
  * QQ
  * RDF


---

Comment by novoselt created at 2011-08-31 14:58:48

Would there be any benefit in supporting real fields of arbitrary precision?


---

Comment by vbraun created at 2011-08-31 15:05:06

We don't have an implementation of the double description algorithm for other base rings, so we wouldn't be able to compute anything.


---

Attachment

Initial patch


---

Comment by vbraun created at 2011-09-08 17:00:54

Initial patch


---

Attachment

This is now ready for inclusion. Marshall, are you interested in reviewing this patch and its dependency? ;-)


---

Comment by vbraun created at 2011-09-08 17:06:10

Changing status from new to needs_review.


---

Comment by vbraun created at 2012-02-19 02:05:08

Fix comparison of H/V-representation objects:

```
sage: triangle = Polyhedron([(0,0), (1,0), (0,1)])
sage: ieq = triangle.inequality_generator().next()
sage: ieq == copy(ieq)
False
```

Now returns ``True``, as it should.


---

Comment by vbraun created at 2012-02-19 02:06:16

Updated patch


---

Attachment

Rebased for new patch at 11634


---

Attachment

Rebased for new patch at #11634


---

Comment by davidloeffler created at 2012-03-11 14:19:37

The new patch I posted at #11634 broke these, so I rebased them.

Apply trac_11763_ZZ_polyhedron-rebase.patch, trac_11763_parents-rebase.patch


---

Comment by davidloeffler created at 2012-03-11 14:20:37

Apply trac_11763_zz_polyhedron-rebase.patch, trac_11763_parents-rebase.patch 

(bloody patchbot!)


---

Comment by davidloeffler created at 2012-03-11 14:23:25

No matter what I do, the patchbot won't pick up the two patches above, so I've done a single qfolded patch. Hopefully this will now work!


---

Comment by davidloeffler created at 2012-03-12 09:59:47

Apply only this patch. Patch against 5.0.beta7


---

Attachment

Sorry, I made a hash of rebasing the patch, so here's a new version.


---

Comment by mhampton created at 2012-03-12 15:29:00

This changes the behavior of the .vertices() method, returning "sage.geometry.polyhedron.representation.Vertex" objects instead of simple lists of coordinates.  This breaks some code of mine, so I think there should be a deprecation warning before introducing this.  I don't really like the behavior, but I see that .vertices_list() does return a list of lists of coordinates.

This patch also seems to slow things down a bit, but I haven't carefully tested that aspect.


---

Comment by vbraun created at 2012-03-12 18:27:59

The `Vertex` object implements the list interface, so any code that doesn't just test `isinstance(-,list)` should work fine. Plus, you can't really deprecate something unless you want to remove it later. I added the 'vertices_list` method so people can keep their broken code with minimal patching if they want.


---

Comment by mhampton created at 2012-03-12 21:07:57

Well, no, there is quite a bit of my code that does not work fine, and I am not talking about artificial test cases.  Here is a shortened example of something this patch breaks:


```
c = polytopes.n_cube(3)
v = c.vertices()[0]
point(v)
```

This now gives a "TypeError: 'sage.rings.integer.Integer' object does not support indexing".


---

Comment by novoselt created at 2012-03-12 21:19:52

For the record: #12541 and #12544 have a similar situation. I replaced tuples with tuple-like containers and some stuff got broken. As it turned out, it was not too difficult to fix it by eliminating some "hard typechecks", although they are still waiting for an approval. If this is the case here, perhaps it is also not too difficult to fix.

As I understand it, direct typechecking is not welcomed in either Python or Sage, so if the new class implements list interface, it should be OK to use in place of the old one. If it does break some code, it is a bug and it should be fixed before merging, but not a reason for avoiding the change entirely or inventing elaborate deprecation scheme...


---

Comment by davidloeffler created at 2012-03-26 18:11:29

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-26 18:11:29

There is a doctest failing on 5.0.beta10, according to the patchbot (something to do with the new associahedron class from #10817)


---

Comment by vbraun created at 2012-03-29 18:43:12

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-03-29 18:43:12

The associahedron needed to be translated to the parent/element framework as well. I've fixed this. Also, I rediffed trac_11763-polyhedra_coercion_folded.2.patch because it only applied with some fuzz on sage-5.0.beta11


---

Attachment

Updated patch


---

Comment by vbraun created at 2012-03-29 19:01:52

The final patch fixes the `point()` command to not make dumb type checks.


---

Comment by vbraun created at 2012-03-29 20:04:14

I noted a problem in the documentatation build, the updated patch fixes just that.


---

Comment by davidloeffler created at 2012-03-30 12:40:59

Apply trac_11763-polyhedra_coercion_folded.2.patch, trac_11763_fix_associahedron.patch, trac_11763_relax_typechecks.patch

(for patchbot)


---

Comment by novoselt created at 2012-03-30 15:33:39

I thought the point of having "Apply" section in the description was to make the patchbot happy, why does it need to be duplicated?..


---

Comment by davidloeffler created at 2012-03-30 15:50:12

It was previously applying the patches in an order other than that listed on the ticket description (with coercion_folded.2.patch last rather than first). I didn't think to check whether the patches were applying happily anyway; as it happens they were. Sorry for the noise!


---

Comment by novoselt created at 2012-03-30 19:35:58

Oh, I don't complain about your post - I complain about patchbot not figuring out what is the correct order despite a clear description ;-)


---

Comment by chapoton created at 2012-04-26 15:10:49

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2012-04-30 21:30:17

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-04-30 21:30:17

We don't have a policy on trailing white space, so its completely useless bikeshedding to require it one way or another. But since this ticket is the special case where we create a new subdirectory layout, I used a simple sed script to remove trailing whitespace.


---

Comment by chapoton created at 2012-05-04 17:39:47

* There is now an error to be corrected, see bot report for 5.0rc0. This comes from a strange comparison with 'anything', which looks weird.

* Maybe fold all the patches into one ?

* In the part about associahedra, you replaced the sentence "Returns the Cartan type of self." by the sentence "Returns the Cartan type". This seems to be less informative.


---

Comment by chapoton created at 2012-05-04 17:39:47

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2012-05-04 17:58:49

Updated patch


---

Attachment

I've changed the `cmp()` doctest to use `abs(cmp())` to avoid dependence on arbitrary memory positions.

Folding patches is considered harmful since it destroys history without any benefit.

A method always returns information about `self`, you could add "... of self" to every docstring.


---

Comment by vbraun created at 2012-05-04 18:07:06

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-06-11 15:19:42

Rediffed for sage-5.0.beta3 because #12340 introduced a newline in one of the docstrings. No actual code changed.


---

Comment by vbraun created at 2012-06-11 15:31:32

Apply trac_11763-polyhedra_coercion_folded.2.patch, trac_11763_fix_associahedron.patch, trac_11763_relax_typechecks.patch, trac_11763_remove_trailing_whitespace.patch


---

Comment by vbraun created at 2012-07-01 16:13:48

#11310 fixes all the catch-all `except:` clauses, breaking this patch.


---

Comment by novoselt created at 2012-07-25 19:50:31

I'm getting one error when testing:

```
File "/home/novoselt/sage-5.2.rc1/devel/sage-main/sage/libs/ppl.pyx", line 119:
    sage: Polyhedron(vertices=gs, backend='cddr')  # long time (3s on sage.math, 2011)
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.2.rc1/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/novoselt/sage-5.2.rc1/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/novoselt/sage-5.2.rc1/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[37]>", line 1, in <module>
        Polyhedron(vertices=gs, backend='cddr')  # long time (3s on sage.math, 2011)###line 119:
    sage: Polyhedron(vertices=gs, backend='cddr')  # long time (3s on sage.math, 2011)
      File "/home/novoselt/sage-5.2.rc1/local/lib/python/site-packages/sage/misc/decorators.py", line 691, in wrapper
        return func(*args, **kwds)
      File "/home/novoselt/sage-5.2.rc1/local/lib/python/site-packages/sage/geometry/polyhedron/constructor.py", line 325, in Polyhedron
        parent = Polyhedra(base_ring, ambient_dim, backend=backend)
      File "/home/novoselt/sage-5.2.rc1/local/lib/python/site-packages/sage/geometry/polyhedron/parent.py", line 56, in Polyhedra
        ') implemented for given basering (='+str(base_ring)+').')
    ValueError: No such backend (=cddr) implemented for given basering (=Integer Ring).
```



---

Comment by vbraun created at 2012-08-04 18:12:28

I fixed the doctest (its `backend=cdd` not `cddr`) and added documentation to the `sage.geometry.polyhedron.parent.Polyhedra` constructor function.


---

Comment by vbraun created at 2012-08-04 22:47:37

Updated patch fixes one important issue. The inherited comparison for `PolyhedronFace_base` was too lax, which resulted in identical (and not just isomorphic) face lattices in some cases. Fixed now.


---

Comment by vbraun created at 2012-10-22 11:49:36

Rebased for #13638


---

Attachment

Updated patch


---

Comment by vbraun created at 2012-10-23 21:45:56

Updated patch


---

Attachment

I've changed the `PolyhedronFace` class to just derive from `SageObject` this should be clearer. Also, the more trivial patches are folded into the first.

It would be great if this ticket could be reviewed before the heat death of the universe.


---

Comment by vbraun created at 2012-10-24 09:35:23

Rebased for changes in #13638


---

Comment by chapoton created at 2012-10-26 13:34:27

Apply only trac_11763-polyhedra_coercion_folded.2.patch trac_11763_fix_associahedron.patch


---

Comment by chapoton created at 2012-10-26 14:38:59

Ok, let us forget about trailing whitespaces.

But what about the startup plugin which is complaining here ?


---

Comment by vbraun created at 2012-10-26 14:46:36

I agree that using lazy imports would be good. I'll give it a whirl.


---

Comment by vbraun created at 2012-10-26 14:55:44

Patch loads Polyhedron lazily, so we don't import anything on startup.


---

Comment by vbraun created at 2012-10-26 16:32:44

Also lazily import the parent `PolyhedralSets`, plus one typo fix.


---

Comment by chapoton created at 2012-10-26 18:26:24

Apply trac_11763-polyhedra_coercion_folded.2.patch trac_11763_fix_associahedron.patch trac_11763_lazy_import.patch


---

Comment by vbraun created at 2012-11-06 04:02:28

Improved patch


---

Attachment

I switched the order this patch and #13638.


---

Comment by dimpase created at 2012-11-27 04:46:38

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2012-11-27 12:37:12

The patchbot seems to follow the patch order in the Attachments list, rather than in the ticket description Apply list.


---

Comment by dimpase created at 2012-11-27 12:49:26

Replying to [comment:48 dimpase]:
> The patchbot seems to follow the patch order in the Attachments list, rather than in the ticket description Apply list.
If I am reading the [right patchbot source](https://github.com/robertwb/sage-patchbot/blob/master/src/trac.py), it seems that it looks for `apply` in the whole rss feed...


---

Comment by vbraun created at 2012-11-27 16:52:17

For the patchbot:

Apply trac_11763-polyhedra_coercion_folded.2.patch, trac_11763_fix_associahedron.patch, trac_11763_lazy_import.patch


---

Comment by jdemeyer created at 2012-12-18 07:36:41

On some systems, such as OS X >= 10.6 and Itanium:

```
sage -t  --long -force_lib devel/sage/sage/geometry/polyhedron/base.py
**********************************************************************
File "/Users/dehayebuildbot/build/sage/dehaye/dehaye_full/build/sage-5.6.beta0/devel/sage-main/sage/geometry/polyhedron/base.py", line 385:
    sage: cmp(P, 'string')
Expected:
    -1
Got:
    1
**********************************************************************
```



---

Comment by jdemeyer created at 2012-12-18 08:05:10

Changing status from positive_review to needs_work.


---

Attachment

Updated patch


---

Comment by vbraun created at 2012-12-18 10:06:22

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2012-12-18 10:06:22

I've added the trivial fix.


---

Comment by vbraun created at 2012-12-18 10:43:14

And now I noticed that this was already fixed in #12193.


---

Comment by jdemeyer created at 2012-12-21 09:30:41

Resolution: fixed


---

Attachment


---

Comment by jdemeyer created at 2012-12-21 09:41:56

Rebased to sage-5.6.beta0.


---

Comment by novoselt created at 2012-12-24 20:26:05

Hey Volker,

Do you remember what was the reason for this change in `normalize_rays`?

```diff
diff --git a/sage/geometry/cone.py b/sage/geometry/cone.py

Index: sage/geometry/cone.py
===================================================================
--- a/sage/geometry/cone.py
+++ b/sage/geometry/cone.py
@@ -568,7 +568,10 @@
         V = lattice.base_extend(QQ)
         for n, ray in enumerate(rays):
             try:
-                ray = V(ray)
+                if isinstance(ray, (list, tuple, V._element_class)):
+                    ray = V(ray)
+                else:
+                    ray = V(list(ray))
             except TypeError:
                 raise TypeError("cannot convert %s to %s!" % (ray, V))
             if ray.is_zero():
```

It seems that if `V` does not want to take a `ray`, we should not force it.


---

Comment by vbraun created at 2012-12-24 20:34:16

I think the idea is to allow arbitrary iterables in `normalize_rays`. Why not? Its an auxiliary function, and the more general it is the better.


---

Comment by novoselt created at 2012-12-25 02:42:33

I just was wondering what was the particular use case - found this bit because of the fuzz with another patch. I don't mind it, although changing what `V.__call__` accepts seems a more pleasant solution ;-)


---

Comment by vbraun created at 2012-12-25 13:24:17

Replying to [comment:60 novoselt]:
> I don't mind it, although changing what `V.__call__` accepts seems a more pleasant solution ;-)

Wasn't that one of our design decisions, that the ToricLattice should forbid conversion between the lattice and its dual?


---

Comment by novoselt created at 2012-12-28 02:53:46

Replying to [comment:61 vbraun]:
> Wasn't that one of our design decisions, that the ToricLattice should forbid conversion between the lattice and its dual? 

We prohibit coercion, conversion is certainly possible, and here `V` is the spanned vector space anyway. But I've also hit many times a situation when a standard constructor in Sage would not take generators as input, which is probably what has happened here.
