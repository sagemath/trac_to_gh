# Issue 22809: Patch python to allow linking with clang on linux

Issue created by migration from https://trac.sagemath.org/ticket/23046

Original creator: fbissey

Original creation time: 2017-05-22 00:11:42

CC:  jhpalmieri dimapase

Part of #12426. To allow distutils to link when the compiler is clang on linux we need to import the fix for upstream python issue http://bugs.python.org/issue25229

On linux the proper way to pass linking option to the linker is to use `-Wl,-R` but python insist on doing so only for gcc claiming other compiler do not need `-Wl` which is patently false.

```
clang -fno-strict-aliasing -OPT:Olimit=0 -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/home/fbissey/sandbox/git-fork/sage-clang/local/include -Izmq/utils -Izmq/backend/cython -Izmq/devices -c build/temp.linux-x86_64-2.7/scratch/vers.c -o build/temp.linux-x86_64-2.7/scratch/vers.o
    clang build/temp.linux-x86_64-2.7/scratch/vers.o -L/home/fbissey/sandbox/git-fork/sage-clang/local/lib -R/home/fbissey/sandbox/git-fork/sage-clang/local/lib -lzmq -lrt -o build/temp.linux-x86_64-2.7/scratch/vers
    Error running version detection script:

    build/temp.linux-x86_64-2.7/scratch/vers: error while loading shared libraries: libzmq.so.4: cannot open shared object file: No such file or directory


    error: Error running version detection script:

    build/temp.linux-x86_64-2.7/scratch/vers: error while loading shared libraries: libzmq.so.4: cannot open shared object file: No such file or directory
```



---

Comment by fbissey created at 2017-05-22 01:10:27

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-05-22 01:10:27

`@`jhpalmieri would you mind reviewing this?
----
New commits:


---

Comment by jhpalmieri created at 2017-05-22 04:50:06

Can you describe a specific problem that this fixes? (That is, what should I do to test it?)


---

Comment by fbissey created at 2017-05-22 06:12:08

Without that patch compiling `pyzmq` with clang on linux will fail to link. As shown in the description. Building would also fails but you have to compile `pyzmq` first to get there.


---

Comment by jdemeyer created at 2017-05-22 07:11:09

I don't like the fix. It's replacing one dubious hard-coded behaviour (checking for the string `gcc`) by another dubious hard-coded behaviour (checking for `linux` in the platform).


---

Comment by fbissey created at 2017-05-22 07:16:36

Well, as a matter of fact the fix enforce a correct behavior on linux. Can we do better? May be, but then I'll start by taking down the whole section which is of the same quality. Uncorrected code from distutils

```
    def runtime_library_dir_option(self, dir):
        # XXX Hackish, at the very least.  See Python bug #445902:
        # http://sourceforge.net/tracker/index.php
        #   ?func=detail&aid=445902&group_id=5470&atid=105470
        # Linkers on different platforms need different options to
        # specify that directories need to be added to the list of
        # directories searched for dependencies when a dynamic library
        # is sought.  GCC has to be told to pass the -R option through
        # to the linker, whereas other compilers just know this.
        # Other compilers may need something slightly different.  At
        # this time, there's no way to determine this information from
        # the configuration data stored in the Python installation, so
        # we use this hack.
        compiler = os.path.basename(sysconfig.get_config_var("CC"))
        if sys.platform[:6] == "darwin":
            # MacOSX's linker doesn't understand the -R flag at all
            return "-L" + dir
        elif sys.platform[:7] == "freebsd":
            return "-Wl,-rpath=" + dir
        elif sys.platform[:5] == "hp-ux":
            if self._is_gcc(compiler):
                return ["-Wl,+s", "-L" + dir]
            return ["+s", "-L" + dir]
        elif sys.platform[:7] == "irix646" or sys.platform[:6] == "osf1V5":
            return ["-rpath", dir]
        elif self._is_gcc(compiler):
            return "-Wl,-R" + dir
        else:
            return "-R" + dir
```

At least the fix's author is keeping it in the original style :(


---

Comment by jdemeyer created at 2017-05-22 07:54:03

My eyes! It burns! :-)


---

Comment by jdemeyer created at 2017-05-22 09:29:50

OK, I remove my objections...


---

Comment by fbissey created at 2017-05-22 09:35:50

Replying to [comment:7 jdemeyer]:
> OK, I remove my objections...

Thank you. I must say that libtools and cmake are just that ugly when you look too closely under the hood. Some of that stuff is just hard.


---

Comment by jdemeyer created at 2017-05-22 10:15:37

Replying to [comment:8 fbissey]:
> Replying to [comment:7 jdemeyer]:
> > OK, I remove my objections...
> 
> Thank you. I must say that libtools and cmake are just that ugly when you look too closely under the hood.

True, although the autoconf style of actually running stuff (like, run the compiler/linker in various ways and check what works) is superior. This doesn't always work, but it's a good philosophy.


---

Comment by jhpalmieri created at 2017-05-22 16:49:43

I only have access to OS X machines, and pyzmq claims to build without error there (with #12426). So maybe Dima is better for a reviewer, since he uses clang on linux.


---

Comment by fbissey created at 2017-05-22 19:59:33

`@` dima do you have the mean to review this?


---

Comment by dimpase created at 2017-06-23 08:29:51

Replying to [comment:11 fbissey]:
> `@` dima do you have the mean to review this?

right, let me try on Gentoo. Shouldn't this ticket be dependent on #12426 ?
Or, more precisely, anything that is required to specify clang(++) as the C(++) compiler?


---

Comment by dimpase created at 2017-06-23 08:38:03

Does python3 need such a patch too?


---

Comment by fbissey created at 2017-06-23 09:09:11

Yes, the only way to try it is to have #12426 as well. But they can be merged independently because they touch completely different parts of sage.

If you look at the branch, you'll see that both python2 and python3 are patched.


---

Comment by dimpase created at 2017-06-23 10:59:19

Hmm, does this actually require `-stdlib=libc++`? I am trying with `-stdlib=libstdc++`,
and get errors (on Fedora 23), see details on #22646.


---

Comment by fbissey created at 2017-06-29 08:13:07

`@` dima considering your comments on #12426, can you put this to positive review?


---

Comment by dimpase created at 2017-06-29 08:46:07

Looks good with a sufficiently new Linux toolchain (clang 4.0.1).


---

Comment by dimpase created at 2017-06-29 08:46:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-26 22:13:22

Resolution: fixed
