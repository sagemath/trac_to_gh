# Issue 11919: bug in add_constraint to MixedIntegerLinearProgram

Issue created by migration from https://trac.sagemath.org/ticket/12091

Original creator: dimpase

Original creation time: 2011-11-27 17:33:11

Assignee: ncohen

CC:  ncohen kini vbraun

constraints with 0 on one size of an inequality get lost, somehow:

```
sage: p = MixedIntegerLinearProgram(maximization=True)
sage: A = p.new_variable()
sage: p.add_constraint(A[0]==1)
sage: p.add_constraint(0<= A[1]-A[0])
sage: p.show()
Maximization:
 
Constraints:
  1.0 <= x_0 <= 1.0
Variables:
  x_0 is a continuous variable (min=0.0, max=+oo)
  x_1 is a continuous variable (min=0.0, max=+oo)
```


homogenizing the constraint fixes this problem:

```
sage: p.add_constraint(0*A[0]<= A[1]-A[0])
sage: p.show()
Maximization:
 
Constraints:
  1.0 <= x_0 <= 1.0
  x_0 -x_1 <= 0.0
Variables:
  x_0 is a continuous variable (min=0.0, max=+oo)
  x_1 is a continuous variable (min=0.0, max=+oo)
```



---

Comment by ncohen created at 2012-02-20 08:40:01

I spent days already on this problem, so I should at least update the ticket. This does not work because of.... that :

```
sage: p = MixedIntegerLinearProgram()
sage: b = p.new_variable()
sage: b[2] + b[4] >= 5
5 <= x_0 +x_1
sage: 5 <= b[2] + b[4]
True
```


It is as easy as that. And of course, calling ``p.add_constraint(True)`` can not do anything useful. That comes from the fact that the way it is implemented the comparison methods I wrote for the LP variables are totally ignored when there is an integer on the left of the equation.

I went through hell (aka the coercion system) to make it work, and after getting back from hell (writing new classes, using categories, parents objets, elements objects, ...) Sage finally understood that it has to coerce integers to "LinearFunction" objects before applying the ``<=`` operation.

I was happy at this point. And then I noticed that when I typed ``3*b[i]`` in Sage, it first converted the "3" to a ``LinearFunction`` object and then tried to multiply linear functions between themselves. And multiply linear functions is *never* a good idea.

So unless there is a magical way to make it work (without destroying all the code... I mean, even reaching that former point amounted to something like 100 additional lines of code totally exclusively dealing with categories and coercion), I'd stand for big "DO NOT PUT AN INTEGER BY ITSELF ON THE LEFT SIDE OF A LP INEQUALITY" in the doc.

But I'd prefer to find a magical way, of course..

Nathann


---

Comment by dimpase created at 2012-02-20 13:50:17

I might be clueless, but this asks a modification of the Sage pre-parser. The pre-parser might be able to add the crap necessary for the Hell (aka coersion framework) to freeze over and do the right thing...

Dima


---

Comment by ppurka created at 2012-02-20 13:55:32

Replying to [comment:4 dimpase]:
> I might be clueless, but this asks a modification of the Sage pre-parser. The pre-parser might be able to add the crap necessary for the Hell (aka coersion framework) to freeze over and do the right thing...

Not sure about the preparser. But I feel that at least some of the bugs (the examples I added) can be fixed by modifying the Linear* classes I mentioned. I had been hacking it for about a day, but I haven't yet got the right solution. The constants are indeed way more trickier to handle, since there seems to be no way of knowing when we have normal inequalities and when we have LP ones.


---

Comment by dimpase created at 2012-02-20 14:02:39

Replying to [comment:5 ppurka]:
> The constants are indeed way more trickier to handle, since there seems to be no way of knowing when we have normal inequalities and when we have LP ones.

How come? The LP inequalities have LP variables. So one of the tokens will be such a variable...


---

Comment by ppurka created at 2012-02-20 14:18:46

Replying to [comment:6 dimpase]:
> How come? The LP inequalities have LP variables. So one of the tokens will be such a variable...

My understanding is this:

When you start with `5 <= b[0]` your program will see the _number_ 5 not an object from the class `LinearConstraint` or `LinearFunction`. So, `LinearConstraint.__le__` won't be called. This is ok when you have the opposite `b[0] >= 5`.


---

Comment by dimpase created at 2012-02-20 14:22:45

Replying to [comment:7 ppurka]:
> Replying to [comment:6 dimpase]:
> > How come? The LP inequalities have LP variables. So one of the tokens will be such a variable...
> 
> My understanding is this:
> 
> When you start with `5 <= b[0]` your program will see the _number_ 5 not an object from the class `LinearConstraint` or `LinearFunction`. So, `LinearConstraint.__le__` won't be called. This is ok when you have the opposite `b[0] >= 5`.

OK, this just means that the preparser should keep looking further if he sees a constant...
IMHO it's some kind of basic compiler/interpreter piece of technology.


---

Comment by ncohen created at 2012-02-20 14:24:52

Why do you see the problem at the preparser level ? This kind of lines can also appear fron the inside of Sage's code, where the preparser does nothing.. Or am I mistaken ?

Nathann


---

Comment by dimpase created at 2012-02-20 14:27:16

Replying to [comment:9 ncohen]:
> Why do you see the problem at the preparser level ? This kind of lines can also appear fron the inside of Sage's code, where the preparser does nothing.. Or am I mistaken ?

Nothing? Why? Surely you can use symbolic functions in Sage library code, why not? It gets preparsed all right.


---

Comment by ncohen created at 2012-02-20 14:29:13

Oh, I thought the preparser was the piece of code that replaced 5 by Integer(5) when using the console, and that you had to rely on yourself when writing code from the inside of Sage. That's why I was convinced that the only way out of this mess was to deal with the coercion system.

Nathann


---

Comment by ppurka created at 2012-02-20 14:30:41

Replying to [comment:10 dimpase]:
> Replying to [comment:9 ncohen]:
> > Why do you see the problem at the preparser level ? This kind of lines can also appear fron the inside of Sage's code, where the preparser does nothing.. Or am I mistaken ?
> 
> Nothing? Why? Surely you can use symbolic functions in Sage library code, why not? It gets preparsed all right.

Actually no. Not everything gets preparsed. I ran into this problem not long ago, where the `^` wasn't preparsed since it was in a separate file I was importing.


---

Comment by kini created at 2012-02-20 14:34:48

AFAIK nothing gets preparsed from the library. The library is pure Python, not "Sage code" (thankfully).


---

Comment by dimpase created at 2012-02-20 14:43:28

Replying to [comment:13 kini]:
> AFAIK nothing gets preparsed from the library. The library is pure Python, not "Sage code" (thankfully).

I recall in our MTH213 code we certainly used symbolic functions inside .py files. I might be delusional, however...


---

Comment by ncohen created at 2012-02-20 14:45:20

Well I guess you can, but I don't think the manipulation of symbolic variables requires the preparser to do its job. I mean, adding LP variables is already some kind of symbolic computation and all it requires is to define __add__, __mul__, etc ...

Nathann


---

Comment by kini created at 2012-02-20 14:48:47

dimpase: if you mean the syntax


```
f(x) = x^2
```


then no, we definitely did not use it in .py files :) But you certainly don't NEED the preparser for any Sage functionality. Well, unless you count the preparser itself as "Sage functionality". For example the above is equivalent to


```python
f = (x^2).function(x)
```



---

Comment by dimpase created at 2012-02-20 14:58:52

Replying to [comment:16 kini]:
> we definitely did not use it in .py files :) But you certainly don't NEED the preparser for any Sage functionality. Well, unless you count the preparser itself as "Sage functionality". 

well, anyway. Actually, I don't see why Sage library files can't be .sage file, is it some kind of religion?  (OK, you'd need to preparse them once, I guess).

It's obviously makes things unnecessarily verbose to rely upon Python's idea of what a well-formed mathematical expression might be.


---

Comment by ncohen created at 2012-02-20 15:03:24

> well, anyway. Actually, I don't see why Sage library files can't be .sage file, is it some kind of religion?

Yeah, at some point we stopped blaming God for everything. We should do it again `:-D`

> It's obviously makes things unnecessarily verbose to rely upon Python's idea of what a well-formed mathematical expression might be.

+1

That's precisely why I had to create a "Sum" function for LP variables. Because I refused to add n variables in n^2 times, and that it is the only way to do it with __add__ methods. And this "Sum" method fixes the problem but is a bad solution.

Nathann


---

Comment by kini created at 2012-02-20 15:08:19

I disagree. The library should remain Python because "Sage code" is not a well defined language. In fact I would go so far to say that it is a complete ad-hoc hash. I try to avoid using it whenever I can.

Nathann: I don't see how that is an argument for including .sage files in the Sage library... or maybe it wasn't meant that way?


---

Comment by dimpase created at 2012-02-20 15:12:48

Replying to [comment:19 kini]:
> I disagree. The library should remain Python because "Sage code" is not a well defined language. In fact I would go so far to say that it is a complete ad-hoc hash. I try to avoid using it whenever I can.
> 

let's make it well-defined then!


---

Comment by ncohen created at 2012-02-20 15:14:18

> Nathann: I don't see how that is an argument for including .sage files in the Sage library... or maybe it wasn't meant that way?

Oh. Well, my "+1" was just about Dima's remark that what we were fighting in this situation was precisely Python's management of + / * - operators...  Looks like in this situation it is clearly our main problem `:-)`

Nathann


---

Comment by ppurka created at 2012-04-05 14:42:52

The problem with the `a <= b <= c` is actually a problem with python. According to [this](http://www.python.org/dev/peps/pep-0207/), chained inequalities behave as follows:

```
# Trying to do x < y < z
             temp1 = x < y
             if temp1:
               return y < z
             else:
               return temp1
```

According to one of my colleagues this behavior is different in python-3 (and that python-3 has the behavior we want), but I haven't checked (I will need to install python-3).

One workaround is to explicitly group the inequalities. So, instead of inputting `a <= b <= c`, if we do `(a <= b) <= c` then it works. Since we are not moving to python-3 any time soon, the documentation should be updated to either discourage chained inequalities or to use explicitly grouped chained inequalities.


---

Comment by dimpase created at 2012-10-24 16:08:15

This can be closed as a duplicate as soon as #13646 is done.


---

Comment by ppurka created at 2012-10-24 16:09:28

Replying to [comment:23 dimpase]:
> This can be closed as a duplicate as soon as #13646 is done. 
Nope. The problem with the chained inequalities still remains.


---

Comment by dimpase created at 2012-10-24 22:09:02

Changing priority from critical to major.


---

Comment by vbraun created at 2012-10-25 21:22:04

Patch fixes chained constraints:

```
    sage: p = MixedIntegerLinearProgram()
    sage: b = p.new_variable()
    sage: b[0] <= b[1] <= 2
    x_0 <= x_1 <= 2
    sage: list(b[0] <= b[1] <= 2)
    [x_0, x_1, 2]
    sage: 1 >= b[1] >= 2*b[0]
    2*x_0 <= x_1 <= 1
    sage: b[2] >= b[1] >= 2*b[0]
    2*x_0 <= x_1 <= x_2
```



---

Comment by dimpase created at 2012-10-26 09:28:58

Replying to [comment:26 vbraun]:
> Patch fixes chained constraints:
indeed! What about more convoluted cases:

```
sage: b[0] <= 555/11*b[1] >= 2
2 <= x_0 <= 555/11*x_1
sage: b[0] <= 555/11*b[1] == 2
555/11*x_1 == 2
```

the 1st one ought to become 2 inequalities, and the 2nd an inequality and an equation.
In both cases, the behaviour is rather strange...

Well, I don't know how easy is to make these work, or at least throw an error.


---

Comment by vbraun created at 2012-10-26 09:46:50

I agree that it is odd behavior. The whole idea of automatically converting all inequalities into less-or-equal is broken, even before my patch:

```
sage: (b[0] <= b[1]) >= b[2]
x_2 <= x_0 <= x_1
```

Inequalities need to remember `>=` vs. `<=` for us to be able to raise an error. The second example is a bug in my patch.


---

Comment by dimpase created at 2012-10-26 10:32:00

Replying to [comment:28 vbraun]:
> I agree that it is odd behavior. The whole idea of automatically converting all inequalities into less-or-equal is broken, even before my patch:
> {{{
> sage: (b[0] <= b[1]) >= b[2]
> x_2 <= x_0 <= x_1
> }}}
> Inequalities need to remember `>=` vs. `<=` for us to be able to raise an error. 

Anything wrong with having that much more in the inequalities class? 

Potentially one would also want to have `<` and `>` and a proper integration with Sage's polyhedra.

Your patch also inspires a grand plan for [linear matrix inequalities](http://en.wikipedia.org/wiki/Linear_matrix_inequality) in Sage...


---

Comment by ppurka created at 2012-10-26 11:05:24

I think mixed chained inequalities/equalities could be errored out. That would ensure that such obtuse inputs are taken care of.

The reason for providing chained inequalities is to actually give inequalities in the form `2 <= x[0] <= 3` or `2 >= x[1] >= 1`, instead of having to set them separately. These types of inequalities are quite common to encounter, and it helps the user if the mathematical expressions can be transferred to sage in a straightforward manner.

Examples like `x[0] <= x[1] >= x[2]` or `x[0] <= x[1] == 2` are quite unusual. I have never seen such expressions come up naturally. The first example, for instance, says nothing about the relation between `x[0]` and `x[2]` and hence one would typically never encounter inequations (written) like that.


---

Comment by vbraun created at 2012-10-26 11:40:25

I agree that one should raise an error. But to be able to do this you must not auto-convert to less-or-equal. And thats definitely doable ;-)


---

Comment by dimpase created at 2012-10-28 06:51:16

Replying to [comment:31 vbraun]:
> I agree that one should raise an error. But to be able to do this you must not auto-convert to less-or-equal. And thats definitely doable ;-)

Hi Volker, will you work on this? Just to indicate the ticket status right.


---

Comment by dimpase created at 2012-10-28 06:51:16

Changing status from new to needs_info.


---

Comment by vbraun created at 2012-10-28 11:37:45

Probably won't have time to work on this in the next two weeks...


---

Comment by vbraun created at 2012-11-06 17:41:01

Updated patch


---

Attachment

I've removed the "cdef double c" in `show()`, so the following works:

```
            sage: p = MixedIntegerLinearProgram(solver= 'ppl')
            sage: x = p.new_variable()
            sage: p.set_objective(x[1] + 1/2*x[2])
            sage: p.add_constraint(-3/5*x[1] + 2/7*x[2], max=2/5)
            sage: p.show()
            Maximization:
              x_0 + 1/2 x_1
            Constraints:
              constraint_0: -3/5 x_0 + 2/7 x_1 <= 2/5
            Variables:
              x_0 is a continuous variable (min=0, max=+oo)
              x_1 is a continuous variable (min=0, max=+oo)
```



---

Comment by dimpase created at 2012-11-08 15:17:21

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2012-11-08 15:22:07

As far as I am concerned, better parsing of things like `x[0] <= x[1] >= x[2]` or `x[0] <= x[1] == 2` can wait till another ticket.


---

Comment by dimpase created at 2012-11-08 15:22:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2012-11-09 15:26:06

Fair enough but can you make another ticket about invalid combinations? Otherwise its too easy to forget ;-)


---

Comment by dimpase created at 2012-11-10 11:32:00

Replying to [comment:39 vbraun]:
> Fair enough but can you make another ticket about invalid combinations? Otherwise its too easy to forget ;-)
Sure! Please see #13696.


---

Comment by jdemeyer created at 2012-11-17 08:56:28

Resolution: fixed
