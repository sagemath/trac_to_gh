# Issue 29216: Detect and use the system fflas-ffpack

Issue created by migration from https://trac.sagemath.org/ticket/29453

Original creator: mjo

Original creation time: 2020-04-02 23:45:13

CC:  embray dimpase mkoeppe fbissey

This package already has an spkg-configure.m4 file and some distro information, but we can't yet detect and use the system copy. Here's hoping everyone ships the pkg-config file.


---

Comment by mjo created at 2020-04-02 23:52:40

Changing status from new to needs_review.


---

Comment by mjo created at 2020-04-02 23:52:40

Here's a go at this. I picked the lower version bound based on what Debian has on repology.
----
New commits:


---

Comment by mjo created at 2020-04-03 00:52:46

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2020-04-03 00:52:46

Eh, I see what's going on with the MP library stuff. Sage is installing MPIR but with everything named "gmp", so having the mpir SPKG installed does satisfy a "gmp" dependency. I'll have to add mpir to the DEPCHECK.


---

Comment by mjo created at 2020-04-03 10:16:56

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2020-04-03 10:16:56

Oh, I accidentally got this one right.


---

Comment by mkoeppe created at 2020-04-03 14:44:15

"Warning: this doesn't get executed with --without-system-fflas-ffpack"
... can this be fixed?


---

Comment by mjo created at 2020-04-03 15:41:19

Replying to [comment:4 mkoeppe]:
> "Warning: this doesn't get executed with --without-system-fflas-ffpack"
> ... can this be fixed?

The issue is already addressed upstream (but not in a release) by detecting support for `-march=native` and using that instead of a million individual flags. So reporting it upstream isn't going to do any good.

Option 1: I could move that code to the top-level configure.ac. I think it will serve its purpose there, although it will be a bit out of place.

Option 2: we could just disable those flags in spkg-install, and use #27122 to add back `-march=native`.

Option 3: leave it where it is, and count on the fact that nobody will want to build an extra copy of fflas-ffpack.


---

Comment by mkoeppe created at 2020-04-03 16:47:05

Maybe just move to the PRE or POST argument of 
`SAGE_SPKG_CONFIGURE(PACKAGE-NAME,[CHECK],[REQUIRED-CHECK],[PRE],[POST])`


---

Comment by git created at 2020-04-03 17:03:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-04-03 17:04:15

Replying to [comment:6 mkoeppe]:
> Maybe just move to the PRE or POST argument of 
> `SAGE_SPKG_CONFIGURE(PACKAGE-NAME,[CHECK],[REQUIRED-CHECK],[PRE],[POST])`

Good idea, done.


---

Comment by mkoeppe created at 2020-04-08 13:32:53

Tests run at https://github.com/mkoeppe/sage/actions/runs/73584944


---

Comment by mkoeppe created at 2020-04-08 20:34:41

`debian`, `fedora` seem to work

Should add arch: `fflas-ffpack`
and conda: `fflas-ffpack`


---

Comment by mjo created at 2020-04-08 20:44:36

Replying to [comment:10 mkoeppe]:
> 
> Should add arch: `fflas-ffpack`
> and conda: `fflas-ffpack`

Can you just add them? I really don't want to sit through another rebuild after `git checkout` to add two lines of text =)


---

Comment by mkoeppe created at 2020-04-08 20:47:35

Sure, will do


---

Comment by mkoeppe created at 2020-04-08 23:05:22

Tests at https://github.com/mkoeppe/sage/actions/runs/73955490
----
New commits:


---

Comment by dimpase created at 2020-04-09 13:06:03

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-04-09 13:06:03

This does not work on Debian buster, as linbox needs a fresher fflas-ffpack:

```
checking for pkg-config... /usr/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for FFLAS_FFPACK... no
configure: error: Package requirements (fflas-ffpack >= 2.4.0) were not met:

Requested 'fflas-ffpack >= 2.4.0' but version of fflas-ffpack is 2.3.2
You may find new versions of fflas-ffpack at http://github.com/linbox-team/fflas-ffpack

Consider adjusting the PKG_CONFIG_PATH environment variable if you
installed software in a non-standard prefix.

Alternatively, you may set the environment variables FFLAS_FFPACK_CFLAGS
and FFLAS_FFPACK_LIBS to avoid the need to call pkg-config.
See the pkg-config man page for more details.
****************************************************************************************************************************************************
Error configuring linbox-1.6.3
```



---

Comment by mjo created at 2020-04-09 16:04:16

Replying to [comment:15 dimpase]:
> This does not work on Debian buster, as linbox needs a fresher fflas-ffpack:

I guess I'll have to update the minimum version for now. When we're able to use the system linbox, we might be able to accept an older fflas-ffpack again. I'll open the linbox ticket now so we don't forget.


---

Comment by mjo created at 2020-04-09 16:13:30

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2020-04-09 16:13:30

I opened #29484 for linbox, and set the bound on fflas-ffpack to 2.4.0 for now.
----
New commits:


---

Comment by mkoeppe created at 2020-04-11 17:04:03

This seems to work well (https://github.com/mkoeppe/sage/actions/runs/75739694). Only very new distributions have a sufficiently new version, of course.

By the way, on `debian-buster-standard` system `fflas_ffpack` is already not used because its dependency `givaro` is too old.


---

Comment by mkoeppe created at 2020-04-11 17:04:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-16 22:33:18

Resolution: fixed
