# Issue 32119: enhance conversion of piecewise functions to giac

archive/issues_032119.json:
```json
{
    "body": "alas, the backward conversion is more complicated, because we lack a symbolic AND function\n\nIssue created by migration from https://trac.sagemath.org/ticket/32356\n\n",
    "created_at": "2021-08-10T09:58:36Z",
    "labels": [
        "component: calculus"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "enhance conversion of piecewise functions to giac",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32119",
    "user": "https://github.com/fchapoton"
}
```
alas, the backward conversion is more complicated, because we lack a symbolic AND function

Issue created by migration from https://trac.sagemath.org/ticket/32356





---

archive/issue_comments_458107.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-10T09:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458107",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458108.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-10T09:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458108",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458109.json:
```json
{
    "body": "Replying to [ticket:32356 chapoton]:\n> alas, the backward conversion is more complicated, because we lack a symbolic AND function\n... more precisely because our piecewise functions only accept `RealSet` as domains for the pieces, not arbitrary sets...",
    "created_at": "2021-08-10T17:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458109",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32356 chapoton]:
> alas, the backward conversion is more complicated, because we lack a symbolic AND function
... more precisely because our piecewise functions only accept `RealSet` as domains for the pieces, not arbitrary sets...



---

archive/issue_comments_458110.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T19:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458111.json:
```json
{
    "body": "Do you know what condition expressions can occur in giac piecewise?",
    "created_at": "2021-08-12T20:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458111",
    "user": "https://github.com/mkoeppe"
}
```

Do you know what condition expressions can occur in giac piecewise?



---

archive/issue_comments_458112.json:
```json
{
    "body": "We could start by converting back conditions coming from sage. They take the typical form \"x > 0 and x < 4\". The connector \"**and**\" is not recognized by our symbolic ring parser.\n\nHere is an example:\n\n```\nsage: S = RealSet([0,4])                                                          \nsage: S._giac_condition_(x)                                                     \n'((0 <= sageVARx) and (sageVARx <= 4))'\nsage: giac(S._giac_condition_(x))                                               \n((sageVARx>=0) and (4>=sageVARx))\n```\n\nand a more general one, with **or**:\n\n```\nsage: S = RealSet([0,4],[6,9])                                                    \nsage: S._giac_condition_(x)                                                     \n'((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))'\nsage: giac(_)                                                                   \n((((sageVARx>=0) and (4>=sageVARx))) or (((sageVARx>=6) and (9>=sageVARx))))\n```\n",
    "created_at": "2021-08-13T07:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458112",
    "user": "https://github.com/fchapoton"
}
```

We could start by converting back conditions coming from sage. They take the typical form "x > 0 and x < 4". The connector "**and**" is not recognized by our symbolic ring parser.

Here is an example:

```
sage: S = RealSet([0,4])                                                          
sage: S._giac_condition_(x)                                                     
'((0 <= sageVARx) and (sageVARx <= 4))'
sage: giac(S._giac_condition_(x))                                               
((sageVARx>=0) and (4>=sageVARx))
```

and a more general one, with **or**:

```
sage: S = RealSet([0,4],[6,9])                                                    
sage: S._giac_condition_(x)                                                     
'((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))'
sage: giac(_)                                                                   
((((sageVARx>=0) and (4>=sageVARx))) or (((sageVARx>=6) and (9>=sageVARx))))
```




---

archive/issue_comments_458113.json:
```json
{
    "body": "With #31911:\n\n```\nsage: g = giac('((0 <= sageVARx) and (sageVARx <= 4))')                                                                                                                      \nsage: g._sage_()                                                                                                                                                             \nand_symbolic(x >= 0, 4 >= x)\n```\n",
    "created_at": "2021-08-14T03:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458113",
    "user": "https://github.com/mkoeppe"
}
```

With #31911:

```
sage: g = giac('((0 <= sageVARx) and (sageVARx <= 4))')                                                                                                                      
sage: g._sage_()                                                                                                                                                             
and_symbolic(x >= 0, 4 >= x)
```




---

archive/issue_comments_458114.json:
```json
{
    "body": "And:\n\n```\nsage: g = giac('((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))')                                                                             \nsage: g._sage_()                                                                                                                                                             \nor_symbolic(and_symbolic(x >= 0, 4 >= x), and_symbolic(x >= 6, 9 >= x))\n```\n",
    "created_at": "2021-08-14T03:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458114",
    "user": "https://github.com/mkoeppe"
}
```

And:

```
sage: g = giac('((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))')                                                                             
sage: g._sage_()                                                                                                                                                             
or_symbolic(and_symbolic(x >= 0, 4 >= x), and_symbolic(x >= 6, 9 >= x))
```




---

archive/issue_comments_458115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-14T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458115",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458116.json:
```json
{
    "body": "Nitpicking suggestions, feel free to ignore.\n\nApply pep8 spacing in examples to promote good habits:\n\n\n```diff\n-                sage: integral(ex,x,0,100,algorithm='giac')\n+                sage: integral(ex, x, 0, 100, algorithm='giac')\n                 199/100\n-                sage: integral(ex,x,algorithm='giac')\n+                sage: integral(ex, x, algorithm='giac')\n+                piecewise(x|-->x on [0, 1], x|-->-1/x + 2 on (1, +oo); x)\n```\n\n\n\n```diff\n-            sage: RealSet((0,1), [2,3])._giac_condition_(x)\n+            sage: RealSet((0, 1), [2, 3])._giac_condition_(x)\n```\n\n\n\n```diff\n-            sage: RealSet(6,6)._giac_condition_(x)\n+            sage: RealSet(6, 6)._giac_condition_(x)\n             'false'\n-            sage: RealSet([6,6])._giac_condition_(x)\n+            sage: RealSet([6, 6])._giac_condition_(x)\n             'sageVARx == 6'\n```\n\n\nNo need to wrap if we stay under the 80 character limit:\n\n\n```diff\n-            args = [(domain._giac_condition_(variable),\n-                     func._giac_init_())\n+            args = [(domain._giac_condition_(variable), func._giac_init_())\n                     for domain, func in parameters]\n```\n\n\n\n```diff\n+        return ' or '.join(it._giac_condition_(x)\n+                           for it in self._intervals)\n+        return ' or '.join(it._giac_condition_(x) for it in self._intervals)\n```\n\n\nUse f-strings:\n\n\n```diff\n+        return \"((\" + lower_condition + \") and (\" + upper_condition + \"))\"\n+        return f\"(({lower_condition}) and ({upper_condition}))\"\n```\n",
    "created_at": "2021-08-15T09:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458116",
    "user": "https://github.com/slel"
}
```

Nitpicking suggestions, feel free to ignore.

Apply pep8 spacing in examples to promote good habits:


```diff
-                sage: integral(ex,x,0,100,algorithm='giac')
+                sage: integral(ex, x, 0, 100, algorithm='giac')
                 199/100
-                sage: integral(ex,x,algorithm='giac')
+                sage: integral(ex, x, algorithm='giac')
+                piecewise(x|-->x on [0, 1], x|-->-1/x + 2 on (1, +oo); x)
```



```diff
-            sage: RealSet((0,1), [2,3])._giac_condition_(x)
+            sage: RealSet((0, 1), [2, 3])._giac_condition_(x)
```



```diff
-            sage: RealSet(6,6)._giac_condition_(x)
+            sage: RealSet(6, 6)._giac_condition_(x)
             'false'
-            sage: RealSet([6,6])._giac_condition_(x)
+            sage: RealSet([6, 6])._giac_condition_(x)
             'sageVARx == 6'
```


No need to wrap if we stay under the 80 character limit:


```diff
-            args = [(domain._giac_condition_(variable),
-                     func._giac_init_())
+            args = [(domain._giac_condition_(variable), func._giac_init_())
                     for domain, func in parameters]
```



```diff
+        return ' or '.join(it._giac_condition_(x)
+                           for it in self._intervals)
+        return ' or '.join(it._giac_condition_(x) for it in self._intervals)
```


Use f-strings:


```diff
+        return "((" + lower_condition + ") and (" + upper_condition + "))"
+        return f"(({lower_condition}) and ({upper_condition}))"
```




---

archive/issue_comments_458117.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-07T20:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32119",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32119#issuecomment-458117",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
