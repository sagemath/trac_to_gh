# Issue 18870: Do not count 4 times the same solution (up to rotations) in QuantuminoSolver

archive/issues_018870.json:
```json
{
    "body": "CC:  vdelecroix\n\nThe following computation takes a lot of time:\n\n\n```\nsage: from sage.games.quantumino import QuantuminoSolver\nsage: QuantuminoSolver(0).number_of_solutions()  # long time (several days)\n```\n\n\nA solution is a tiling of a 5x8x2 box. Since a 5x8x2 box has four orientation preserving isometries that preserves it, each solution up to rotation is counted four times in the computation above.\n\nIt is possible to avoid to compute 4 times the same solution. This ticket does this by choosing a piece and considering 4 times less positions for that piece.\n\nThis ticket was created from a split into two parts of #18987.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19107\n\n",
    "created_at": "2015-08-27T19:20:10Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Do not count 4 times the same solution (up to rotations) in QuantuminoSolver",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18870",
    "user": "slabbe"
}
```
CC:  vdelecroix

The following computation takes a lot of time:


```
sage: from sage.games.quantumino import QuantuminoSolver
sage: QuantuminoSolver(0).number_of_solutions()  # long time (several days)
```


A solution is a tiling of a 5x8x2 box. Since a 5x8x2 box has four orientation preserving isometries that preserves it, each solution up to rotation is counted four times in the computation above.

It is possible to avoid to compute 4 times the same solution. This ticket does this by choosing a piece and considering 4 times less positions for that piece.

This ticket was created from a split into two parts of #18987.

Issue created by migration from https://trac.sagemath.org/ticket/19107





---

archive/issue_comments_258274.json:
```json
{
    "body": "Initials commits from the split that occured in #18987 (they do not depend on #18987).\n----\nNew commits:",
    "created_at": "2015-08-27T20:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258274",
    "user": "slabbe"
}
```

Initials commits from the split that occured in #18987 (they do not depend on #18987).
----
New commits:



---

archive/issue_comments_258275.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-07T19:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258275",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_258276.json:
```json
{
    "body": "Salut Vincent, I am adding you in cc here since you started the review of that code at #18987.",
    "created_at": "2015-09-07T19:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258276",
    "user": "slabbe"
}
```

Salut Vincent, I am adding you in cc here since you started the review of that code at #18987.



---

archive/issue_comments_258277.json:
```json
{
    "body": "Salut,\n\nThis is bad\n\n```\nH = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]\n```\n\nYou are iterating through the whole group to get the subgroup of diagonal matrices... but you know already what they are!\n\nYou can remove this line\n\n```\nassert MatrixGroup(H).cardinality() == len(H)\n```\n\n\nTo build the cosets, you would better use something smarter\n\n```python\nG_set = set(G)\ncosets = []\nwhile G_set:\n    g = G_set.pop()\n    left_coset = sorted(h*g for h in H)\n    right_coset = sorted(g*h for h in H)\n    assert left_coset == right_coset  # must be a normal subgroup\n    G_set.difference_update(left_coset)\n    cosets.append(left_coset)\n```\n\n\nThere are some trailing whitespaces in ` _rows_modpi`\n\n... more to come",
    "created_at": "2015-09-07T21:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258277",
    "user": "vdelecroix"
}
```

Salut,

This is bad

```
H = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]
```

You are iterating through the whole group to get the subgroup of diagonal matrices... but you know already what they are!

You can remove this line

```
assert MatrixGroup(H).cardinality() == len(H)
```


To build the cosets, you would better use something smarter

```python
G_set = set(G)
cosets = []
while G_set:
    g = G_set.pop()
    left_coset = sorted(h*g for h in H)
    right_coset = sorted(g*h for h in H)
    assert left_coset == right_coset  # must be a normal subgroup
    G_set.difference_update(left_coset)
    cosets.append(left_coset)
```


There are some trailing whitespaces in ` _rows_modpi`

... more to come



---

archive/issue_comments_258278.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-09-07T21:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258278",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_258279.json:
```json
{
    "body": "Replying to [comment:3 vdelecroix]:\n> This is bad\n> {{{\n> H = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]\n> }}}\n\nThe code below would be nice but leads to this bug: #19270.\n\n\n```python\nfrom sage.misc.misc_c import prod  \nit = itertools.product((1,-1), repeat=n)\nif orientation_preserving:     \n    H = [diagonal_matrix(L) for L in it if prod(L) == 1]\nelse:                                                                    \n    H = [diagonal_matrix(L) for L in it]\nH = G.subgroup(H)\n```\n\n\nIf you can find a way of creating `G` and `H` so that `g * h` works and returns an hashable object for all g in G and h in H, tell me.",
    "created_at": "2015-09-22T19:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258279",
    "user": "slabbe"
}
```

Replying to [comment:3 vdelecroix]:
> This is bad
> {{{
> H = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]
> }}}

The code below would be nice but leads to this bug: #19270.


```python
from sage.misc.misc_c import prod  
it = itertools.product((1,-1), repeat=n)
if orientation_preserving:     
    H = [diagonal_matrix(L) for L in it if prod(L) == 1]
else:                                                                    
    H = [diagonal_matrix(L) for L in it]
H = G.subgroup(H)
```


If you can find a way of creating `G` and `H` so that `g * h` works and returns an hashable object for all g in G and h in H, tell me.



---

archive/issue_comments_258280.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-22T20:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258280",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258281.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-09-22T20:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258281",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_258282.json:
```json
{
    "body": "Okay, so I decided to use matrices + `.set_immutable()` instead of `MatrixGroup` elements.\n\nNeeds review!",
    "created_at": "2015-09-22T20:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258282",
    "user": "slabbe"
}
```

Okay, so I decided to use matrices + `.set_immutable()` instead of `MatrixGroup` elements.

Needs review!



---

archive/issue_comments_258283.json:
```json
{
    "body": "Merge conflict in src/sage/combinat/tiling.py",
    "created_at": "2015-10-21T19:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258283",
    "user": "vdelecroix"
}
```

Merge conflict in src/sage/combinat/tiling.py



---

archive/issue_comments_258284.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-10-21T19:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258284",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_258285.json:
```json
{
    "body": "Because of #19260 I guess...",
    "created_at": "2015-10-22T08:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258285",
    "user": "slabbe"
}
```

Because of #19260 I guess...



---

archive/issue_comments_258286.json:
```json
{
    "body": "Replying to [comment:9 slabbe]:\n> Because of #19260 I guess...\n\nIf it is then the merge will be very easy.",
    "created_at": "2015-10-22T09:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258286",
    "user": "vdelecroix"
}
```

Replying to [comment:9 slabbe]:
> Because of #19260 I guess...

If it is then the merge will be very easy.



---

archive/issue_comments_258287.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-10-22T12:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258287",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258288.json:
```json
{
    "body": "> If it is then the merge will be very easy.\n\nIndeed (I was expecting something worse), now needs review.",
    "created_at": "2015-10-22T12:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258288",
    "user": "slabbe"
}
```

> If it is then the merge will be very easy.

Indeed (I was expecting something worse), now needs review.



---

archive/issue_comments_258289.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-10-22T12:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258289",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_258290.json:
```json
{
    "body": "minor comment: The names `XYZ_iterator` is a bit heavy. With Python 3 more stuff is actually returning iterator (like `range`, `zip`) without explicit names. What about `isometric_copies` and `translated_copies`. In that case `canonical_isometric_copies` would better returns an iterator as well.\n\notherwise it looks good to me.",
    "created_at": "2015-11-28T17:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258290",
    "user": "vdelecroix"
}
```

minor comment: The names `XYZ_iterator` is a bit heavy. With Python 3 more stuff is actually returning iterator (like `range`, `zip`) without explicit names. What about `isometric_copies` and `translated_copies`. In that case `canonical_isometric_copies` would better returns an iterator as well.

otherwise it looks good to me.



---

archive/issue_comments_258291.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-28T17:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258291",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_258292.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-30T15:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258292",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258293.json:
```json
{
    "body": "needs review?",
    "created_at": "2015-11-30T15:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258293",
    "user": "vdelecroix"
}
```

needs review?



---

archive/issue_comments_258294.json:
```json
{
    "body": "I renamed the methods. I kept `canonical_isometric_copies` returning a set since it needs to avoid duplicates. And also returning `iter(set(it))` is bad if the user then creates a set out of it...",
    "created_at": "2015-11-30T16:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258294",
    "user": "slabbe"
}
```

I renamed the methods. I kept `canonical_isometric_copies` returning a set since it needs to avoid duplicates. And also returning `iter(set(it))` is bad if the user then creates a set out of it...



---

archive/issue_comments_258295.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-30T16:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258295",
    "user": "slabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_258296.json:
```json
{
    "body": "Replying to [comment:15 vdelecroix]:\n> needs review?\n\nyou're too fast:)",
    "created_at": "2015-11-30T16:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258296",
    "user": "slabbe"
}
```

Replying to [comment:15 vdelecroix]:
> needs review?

you're too fast:)



---

archive/issue_comments_258297.json:
```json
{
    "body": "I am still wondering if `modpi` is the good name for what I mean. Maybe `upto_box_isometries` would be better?",
    "created_at": "2015-11-30T16:02:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258297",
    "user": "slabbe"
}
```

I am still wondering if `modpi` is the good name for what I mean. Maybe `upto_box_isometries` would be better?



---

archive/issue_comments_258298.json:
```json
{
    "body": "- in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`\n- `up_to_box_isometries` is better than `upto_box_isometries`\n- the prefix `mod` makes it clear that you are considering a quotient",
    "created_at": "2015-12-01T19:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258298",
    "user": "vdelecroix"
}
```

- in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`
- `up_to_box_isometries` is better than `upto_box_isometries`
- the prefix `mod` makes it clear that you are considering a quotient



---

archive/issue_comments_258299.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-12-02T10:11:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258299",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258300.json:
```json
{
    "body": "Replying to [comment:19 vdelecroix]:\n> - in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`\n\nThe documentation of both `orientation_preserving` and `mod_box_isometries` are now written in terms of the group of isometries of the n-cube. The first restrict to a subgroup whereas the second is quotient by a subgroup. And they are compatible. Tell me if it is better now.\n\nNeeds review.",
    "created_at": "2015-12-02T10:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258300",
    "user": "slabbe"
}
```

Replying to [comment:19 vdelecroix]:
> - in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`

The documentation of both `orientation_preserving` and `mod_box_isometries` are now written in terms of the group of isometries of the n-cube. The first restrict to a subgroup whereas the second is quotient by a subgroup. And they are compatible. Tell me if it is better now.

Needs review.



---

archive/issue_comments_258301.json:
```json
{
    "body": "Good for me.",
    "created_at": "2015-12-04T01:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258301",
    "user": "vdelecroix"
}
```

Good for me.



---

archive/issue_comments_258302.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-04T01:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258302",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_258303.json:
```json
{
    "body": "Thanks for your review.",
    "created_at": "2015-12-04T09:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258303",
    "user": "slabbe"
}
```

Thanks for your review.



---

archive/issue_comments_258304.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-05T10:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18870#issuecomment-258304",
    "user": "vbraun"
}
```

Resolution: fixed
