# Issue 18870: Do not count 4 times the same solution (up to rotations) in QuantuminoSolver

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2015-08-27 19:20:10

CC:  vdelecroix

The following computation takes a lot of time:


```
sage: from sage.games.quantumino import QuantuminoSolver
sage: QuantuminoSolver(0).number_of_solutions()  # long time (several days)
```


A solution is a tiling of a 5x8x2 box. Since a 5x8x2 box has four orientation preserving isometries that preserves it, each solution up to rotation is counted four times in the computation above.

It is possible to avoid to compute 4 times the same solution. This ticket does this by choosing a piece and considering 4 times less positions for that piece.

This ticket was created from a split into two parts of #18987.


---

Comment by slabbe created at 2015-08-27 20:18:47

Initials commits from the split that occured in #18987 (they do not depend on #18987).
----
New commits:


---

Comment by slabbe created at 2015-09-07 19:02:02

Changing status from new to needs_review.


---

Comment by slabbe created at 2015-09-07 19:02:02

Salut Vincent, I am adding you in cc here since you started the review of that code at #18987.


---

Comment by vdelecroix created at 2015-09-07 21:15:17

Salut,

This is bad

```
H = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]
```

You are iterating through the whole group to get the subgroup of diagonal matrices... but you know already what they are!

You can remove this line

```
assert MatrixGroup(H).cardinality() == len(H)
```


To build the cosets, you would better use something smarter

```python
G_set = set(G)
cosets = []
while G_set:
    g = G_set.pop()
    left_coset = sorted(h*g for h in H)
    right_coset = sorted(g*h for h in H)
    assert left_coset == right_coset  # must be a normal subgroup
    G_set.difference_update(left_coset)
    cosets.append(left_coset)
```


There are some trailing whitespaces in ` _rows_modpi`

... more to come


---

Comment by vdelecroix created at 2015-09-07 21:15:24

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2015-09-22 19:59:43

Replying to [comment:3 vdelecroix]:
> This is bad
> {{{
> H = [h for h in G if all(i==j for (i,j) in h.matrix().nonzero_positions())]
> }}}

The code below would be nice but leads to this bug: #19270.


```python
from sage.misc.misc_c import prod  
it = itertools.product((1,-1), repeat=n)
if orientation_preserving:     
    H = [diagonal_matrix(L) for L in it if prod(L) == 1]
else:                                                                    
    H = [diagonal_matrix(L) for L in it]
H = G.subgroup(H)
```


If you can find a way of creating `G` and `H` so that `g * h` works and returns an hashable object for all g in G and h in H, tell me.


---

Comment by git created at 2015-09-22 20:38:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-09-22 20:40:50

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2015-09-22 20:40:50

Okay, so I decided to use matrices + `.set_immutable()` instead of `MatrixGroup` elements.

Needs review!


---

Comment by vdelecroix created at 2015-10-21 19:54:43

Merge conflict in src/sage/combinat/tiling.py


---

Comment by vdelecroix created at 2015-10-21 19:54:43

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2015-10-22 08:22:07

Because of #19260 I guess...


---

Comment by vdelecroix created at 2015-10-22 09:29:54

Replying to [comment:9 slabbe]:
> Because of #19260 I guess...

If it is then the merge will be very easy.


---

Comment by git created at 2015-10-22 12:16:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-10-22 12:18:14

> If it is then the merge will be very easy.

Indeed (I was expecting something worse), now needs review.


---

Comment by slabbe created at 2015-10-22 12:18:14

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-11-28 17:10:56

minor comment: The names `XYZ_iterator` is a bit heavy. With Python 3 more stuff is actually returning iterator (like `range`, `zip`) without explicit names. What about `isometric_copies` and `translated_copies`. In that case `canonical_isometric_copies` would better returns an iterator as well.

otherwise it looks good to me.


---

Comment by vdelecroix created at 2015-11-28 17:10:56

Changing status from needs_review to needs_info.


---

Comment by git created at 2015-11-30 15:57:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-30 15:59:17

needs review?


---

Comment by slabbe created at 2015-11-30 16:00:09

I renamed the methods. I kept `canonical_isometric_copies` returning a set since it needs to avoid duplicates. And also returning `iter(set(it))` is bad if the user then creates a set out of it...


---

Comment by slabbe created at 2015-11-30 16:00:09

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2015-11-30 16:00:29

Replying to [comment:15 vdelecroix]:
> needs review?

you're too fast:)


---

Comment by slabbe created at 2015-11-30 16:02:09

I am still wondering if `modpi` is the good name for what I mean. Maybe `upto_box_isometries` would be better?


---

Comment by vdelecroix created at 2015-12-01 19:55:03

- in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`
- `up_to_box_isometries` is better than `upto_box_isometries`
- the prefix `mod` makes it clear that you are considering a quotient


---

Comment by git created at 2015-12-02 10:11:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-12-02 10:14:31

Replying to [comment:19 vdelecroix]:
> - in any case you should be clearer in the documentation that its meaning somehow depends on the other argument `orientation_preserving`

The documentation of both `orientation_preserving` and `mod_box_isometries` are now written in terms of the group of isometries of the n-cube. The first restrict to a subgroup whereas the second is quotient by a subgroup. And they are compatible. Tell me if it is better now.

Needs review.


---

Comment by vdelecroix created at 2015-12-04 01:10:37

Good for me.


---

Comment by vdelecroix created at 2015-12-04 01:10:37

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2015-12-04 09:27:25

Thanks for your review.


---

Comment by vbraun created at 2015-12-05 10:01:14

Resolution: fixed
