# Issue 18010: MPIR's configure fails with GCC 5

archive/issues_018010.json:
```json
{
    "body": "CC:  wbhart fbissey\n\nKeywords: GNUC STDC __inline__\n\n\n```\n...\nchecking whether gcc-5.0 is gcc... yes\nchecking compiler gcc-5.0 -m64 ... no, long long reliability test 1\nconfigure: error: could not find a working compiler, see config.log for details\nError configuring MPIR (with CFLAGS unset).\n```\n\n\nThis test already failed with Clang (cf. #13948); now that GCC (5.x) defaults to STDC inlining (as opposed to GNUC inlining) semantics, we have to adapt the test (which is supposed to detect an unrelated bug in older GCC versions) again.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18247\n\n",
    "created_at": "2015-04-18T19:41:40Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "title": "MPIR's configure fails with GCC 5",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18010",
    "user": "leif"
}
```
CC:  wbhart fbissey

Keywords: GNUC STDC __inline__


```
...
checking whether gcc-5.0 is gcc... yes
checking compiler gcc-5.0 -m64 ... no, long long reliability test 1
configure: error: could not find a working compiler, see config.log for details
Error configuring MPIR (with CFLAGS unset).
```


This test already failed with Clang (cf. #13948); now that GCC (5.x) defaults to STDC inlining (as opposed to GNUC inlining) semantics, we have to adapt the test (which is supposed to detect an unrelated bug in older GCC versions) again.


Issue created by migration from https://trac.sagemath.org/ticket/18247





---

archive/issue_comments_242319.json:
```json
{
    "body": "The following patch to `configure` fixes the issue:\n\n```diff\n--- src/configure.orig\t2014-09-14 21:59:13.000000000 +0200\n+++ src/configure\t2015-04-18 21:21:22.170454397 +0200\n@@ -5663,6 +5663,9 @@\n \n #if defined(__GNUC__) && !defined(__clang__)\n typedef unsigned long long t1;typedef t1*t2;\n+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */\n+extern\n+#endif\n __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)\n {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}\n f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;\n@@ -6977,6 +6980,9 @@\n \n #if defined(__GNUC__) && !defined(__clang__)\n typedef unsigned long long t1;typedef t1*t2;\n+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */\n+extern\n+#endif\n __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)\n {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}\n f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;\n```\n\n\n(Haven't messed with `configure.ac`, its source, yet.)",
    "created_at": "2015-04-18T19:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242319",
    "user": "leif"
}
```

The following patch to `configure` fixes the issue:

```diff
--- src/configure.orig	2014-09-14 21:59:13.000000000 +0200
+++ src/configure	2015-04-18 21:21:22.170454397 +0200
@@ -5663,6 +5663,9 @@
 
 #if defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */
+extern
+#endif
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
 f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;
@@ -6977,6 +6980,9 @@
 
 #if defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */
+extern
+#endif
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
 f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;
```


(Haven't messed with `configure.ac`, its source, yet.)



---

archive/issue_comments_242320.json:
```json
{
    "body": "P.S.:  `__GNUC_STDC_INLINE__` is implied by `-std=gnu11` (and `-std=gnu99`), which is GCC 5.x's default, while all older versions defaulted to `-std=gnu89` (implying `__GNUC_GNU_INLINE__`).",
    "created_at": "2015-04-19T01:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242320",
    "user": "leif"
}
```

P.S.:  `__GNUC_STDC_INLINE__` is implied by `-std=gnu11` (and `-std=gnu99`), which is GCC 5.x's default, while all older versions defaulted to `-std=gnu89` (implying `__GNUC_GNU_INLINE__`).



---

archive/issue_comments_242321.json:
```json
{
    "body": "Attachment [MPIR-2.7.0_fix_configure_with_GCC_5.x.upstream.patch](tarball://root/attachments/some-uuid/ticket18247/MPIR-2.7.0_fix_configure_with_GCC_5.x.upstream.patch) by leif created at 2015-04-26 17:59:12\n\nPatch submitted upstream. (Only fixes `acinclude.m4`, not `configure`.)",
    "created_at": "2015-04-26T17:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242321",
    "user": "leif"
}
```

Attachment [MPIR-2.7.0_fix_configure_with_GCC_5.x.upstream.patch](tarball://root/attachments/some-uuid/ticket18247/MPIR-2.7.0_fix_configure_with_GCC_5.x.upstream.patch) by leif created at 2015-04-26 17:59:12

Patch submitted upstream. (Only fixes `acinclude.m4`, not `configure`.)



---

archive/issue_comments_242322.json:
```json
{
    "body": "Just noticed there are bugs w.r.t. `$SAGE_LOCAL/share/mp_config` in both MPIR's `spkg-install` and `$SAGE_ROOT/build/install`, but that's for another ticket.\n\n(E.g. if I install MPIR with `sage -i ...` before I've ever run `make`, MPIR is built without GMP compatibility, due to a syntax error caused by improper quoting.  Also, MPIR should **always** get configured with `--enable-gmpcompat` if we're bootstrapping GCC.  I'd also add an explicit message on whether GMP compatibility is enabled or not.  Not sure whether we should also handle the whole stuff after a successful installation if GMP compatibility was enabled in MPIR's `spkg-install`, and also GMP's `spkg-install`, i.e., when the default MP library *changed* by manual installation of the packages.)",
    "created_at": "2015-04-26T18:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242322",
    "user": "leif"
}
```

Just noticed there are bugs w.r.t. `$SAGE_LOCAL/share/mp_config` in both MPIR's `spkg-install` and `$SAGE_ROOT/build/install`, but that's for another ticket.

(E.g. if I install MPIR with `sage -i ...` before I've ever run `make`, MPIR is built without GMP compatibility, due to a syntax error caused by improper quoting.  Also, MPIR should **always** get configured with `--enable-gmpcompat` if we're bootstrapping GCC.  I'd also add an explicit message on whether GMP compatibility is enabled or not.  Not sure whether we should also handle the whole stuff after a successful installation if GMP compatibility was enabled in MPIR's `spkg-install`, and also GMP's `spkg-install`, i.e., when the default MP library *changed* by manual installation of the packages.)



---

archive/issue_comments_242323.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-26T19:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242323",
    "user": "leif"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242324.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-26T19:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242324",
    "user": "leif"
}
```

New commits:



---

archive/issue_comments_242325.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-04-28T08:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242325",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_242326.json:
```json
{
    "body": "Why not unconditionally use `static __inline__`? I think that should work on all compilers.",
    "created_at": "2015-04-28T08:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242326",
    "user": "jdemeyer"
}
```

Why not unconditionally use `static __inline__`? I think that should work on all compilers.



---

archive/issue_comments_242327.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Why not unconditionally use `static __inline__`? I think that should work on all compilers.\n\nThought of that, too (already when we were fixing the test for `clang`), but this way it's more explicit, and more importantly doesn't change the test at all for older compilers.\n\nAfter all, upstream will decide...",
    "created_at": "2015-04-28T17:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242327",
    "user": "leif"
}
```

Replying to [comment:8 jdemeyer]:
> Why not unconditionally use `static __inline__`? I think that should work on all compilers.

Thought of that, too (already when we were fixing the test for `clang`), but this way it's more explicit, and more importantly doesn't change the test at all for older compilers.

After all, upstream will decide...



---

archive/issue_comments_242328.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-04-28T17:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242328",
    "user": "leif"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_242329.json:
```json
{
    "body": "P.S.:  I didn't \"bump\" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)",
    "created_at": "2015-04-28T17:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242329",
    "user": "leif"
}
```

P.S.:  I didn't "bump" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)



---

archive/issue_comments_242330.json:
```json
{
    "body": "On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?",
    "created_at": "2015-04-29T10:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242330",
    "user": "jdemeyer"
}
```

On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?



---

archive/issue_comments_242331.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-04-29T10:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242331",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_242332.json:
```json
{
    "body": "Replying to [comment:10 leif]:\n> P.S.:  I didn't \"bump\" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)\n\nSince this is purely about a package not compiling, there is not even a need to bump the patchlevel:\n- if a user already managed to compile `mpir`, there is no need for this fix.\n- if a user did not manage to compile `mpir`, the version number doesn't matter anyway.",
    "created_at": "2015-04-29T10:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242332",
    "user": "jdemeyer"
}
```

Replying to [comment:10 leif]:
> P.S.:  I didn't "bump" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)

Since this is purely about a package not compiling, there is not even a need to bump the patchlevel:
- if a user already managed to compile `mpir`, there is no need for this fix.
- if a user did not manage to compile `mpir`, the version number doesn't matter anyway.



---

archive/issue_comments_242333.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?\n\nBike-shedding?\n\nThis test is solely for GCC.  Other compilers may pretend they're GCC, but then they should also define the respective macros.  (We explicitly exclude `clang`, we could in principle exclude ICC as well, but that's something upstream should eventually decide, and not at all an issue for Sage.  I'm not aware of any other relevant compiler identifying as GCC.)\n\nFeel free to submit some other patch upstream.",
    "created_at": "2015-04-29T13:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242333",
    "user": "leif"
}
```

Replying to [comment:12 jdemeyer]:
> On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?

Bike-shedding?

This test is solely for GCC.  Other compilers may pretend they're GCC, but then they should also define the respective macros.  (We explicitly exclude `clang`, we could in principle exclude ICC as well, but that's something upstream should eventually decide, and not at all an issue for Sage.  I'm not aware of any other relevant compiler identifying as GCC.)

Feel free to submit some other patch upstream.



---

archive/issue_comments_242334.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-04-29T13:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242334",
    "user": "leif"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_242335.json:
```json
{
    "body": "P.S.:  Using `static __inline__` would actually **modify** the test, so it wouldn't be guaranteed that it catches the situation it was written for (namely a bug in *older GCC versions*).",
    "created_at": "2015-04-29T13:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242335",
    "user": "leif"
}
```

P.S.:  Using `static __inline__` would actually **modify** the test, so it wouldn't be guaranteed that it catches the situation it was written for (namely a bug in *older GCC versions*).



---

archive/issue_comments_242336.json:
```json
{
    "body": "Replying to [comment:14 leif]:\n> This test is solely for GCC.\nI missed this part. I still don't like your patch (in fact, I don't even like the test), but I can accept it.",
    "created_at": "2015-04-29T14:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242336",
    "user": "jdemeyer"
}
```

Replying to [comment:14 leif]:
> This test is solely for GCC.
I missed this part. I still don't like your patch (in fact, I don't even like the test), but I can accept it.



---

archive/issue_comments_242337.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-29T14:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242337",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242338.json:
```json
{
    "body": "Replying to [comment:16 jdemeyer]:\n> I still don't like your patch (in fact, I don't even like the test), but I can accept it.\n\nI don't like the test either; I'd simply require some minimal version of GCC.\n\nBut as I said, it's IMHO up to upstream to clean up / decide on the tests...\n\n\n\n\n> but I can accept it.\n\nThanks.  We can discuss again when finally a new upstream release gets out... ;-)\n\nI just don't want to have a Sage 6.7 that cannot even bootstrap Sage's GCC 4.9.2 with GCC 5.x for no real reason; distros with GCC 5.1 will presumably pop up soon.",
    "created_at": "2015-04-29T15:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242338",
    "user": "leif"
}
```

Replying to [comment:16 jdemeyer]:
> I still don't like your patch (in fact, I don't even like the test), but I can accept it.

I don't like the test either; I'd simply require some minimal version of GCC.

But as I said, it's IMHO up to upstream to clean up / decide on the tests...




> but I can accept it.

Thanks.  We can discuss again when finally a new upstream release gets out... ;-)

I just don't want to have a Sage 6.7 that cannot even bootstrap Sage's GCC 4.9.2 with GCC 5.x for no real reason; distros with GCC 5.1 will presumably pop up soon.



---

archive/issue_comments_242339.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-01T18:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18010#issuecomment-242339",
    "user": "vbraun"
}
```

Resolution: fixed
