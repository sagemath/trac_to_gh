# Issue 18010: MPIR's configure fails with GCC 5

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2015-04-18 19:41:40

CC:  wbhart fbissey

Keywords: GNUC STDC __inline__


```
...
checking whether gcc-5.0 is gcc... yes
checking compiler gcc-5.0 -m64 ... no, long long reliability test 1
configure: error: could not find a working compiler, see config.log for details
Error configuring MPIR (with CFLAGS unset).
```


This test already failed with Clang (cf. #13948); now that GCC (5.x) defaults to STDC inlining (as opposed to GNUC inlining) semantics, we have to adapt the test (which is supposed to detect an unrelated bug in older GCC versions) again.



---

Comment by leif created at 2015-04-18 19:44:47

The following patch to `configure` fixes the issue:

```diff
--- src/configure.orig	2014-09-14 21:59:13.000000000 +0200
+++ src/configure	2015-04-18 21:21:22.170454397 +0200
`@``@` -5663,6 +5663,9 `@``@`
 
 #if defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */
+extern
+#endif
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
 f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;
`@``@` -6977,6 +6980,9 `@``@`
 
 #if defined(__GNUC__) && !defined(__clang__)
 typedef unsigned long long t1;typedef t1*t2;
+#if defined(__GNUC_STDC_INLINE__)  /* e.g. GCC 5.x default */
+extern
+#endif
 __inline__ t1 e(t2 rp,t2 up,int n,t1 v0)
 {t1 c,x,r;int i;if(v0){c=1;for(i=1;i<n;i++){x=up[i];r=x+1;rp[i]=r;}}return c;}
 f(){static const struct{t1 n;t1 src[9];t1 want[9];}d[]={{1,{0},{1}},};t1 got[9];int i;
```


(Haven't messed with `configure.ac`, its source, yet.)


---

Comment by leif created at 2015-04-19 01:10:06

P.S.:  `__GNUC_STDC_INLINE__` is implied by `-std=gnu11` (and `-std=gnu99`), which is GCC 5.x's default, while all older versions defaulted to `-std=gnu89` (implying `__GNUC_GNU_INLINE__`).


---

Attachment

Patch submitted upstream. (Only fixes `acinclude.m4`, not `configure`.)


---

Comment by leif created at 2015-04-26 18:57:51

Just noticed there are bugs w.r.t. `$SAGE_LOCAL/share/mp_config` in both MPIR's `spkg-install` and `$SAGE_ROOT/build/install`, but that's for another ticket.

(E.g. if I install MPIR with `sage -i ...` before I've ever run `make`, MPIR is built without GMP compatibility, due to a syntax error caused by improper quoting.  Also, MPIR should *always* get configured with `--enable-gmpcompat` if we're bootstrapping GCC.  I'd also add an explicit message on whether GMP compatibility is enabled or not.  Not sure whether we should also handle the whole stuff after a successful installation if GMP compatibility was enabled in MPIR's `spkg-install`, and also GMP's `spkg-install`, i.e., when the default MP library _changed_ by manual installation of the packages.)


---

Comment by leif created at 2015-04-26 19:27:38

Changing status from new to needs_review.


---

Comment by leif created at 2015-04-26 19:27:38

New commits:


---

Comment by jdemeyer created at 2015-04-28 08:02:16

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-04-28 08:02:16

Why not unconditionally use `static __inline__`? I think that should work on all compilers.


---

Comment by leif created at 2015-04-28 17:30:21

Replying to [comment:8 jdemeyer]:
> Why not unconditionally use `static __inline__`? I think that should work on all compilers.

Thought of that, too (already when we were fixing the test for `clang`), but this way it's more explicit, and more importantly doesn't change the test at all for older compilers.

After all, upstream will decide...


---

Comment by leif created at 2015-04-28 17:30:21

Changing status from needs_info to needs_review.


---

Comment by leif created at 2015-04-28 17:53:28

P.S.:  I didn't "bump" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)


---

Comment by jdemeyer created at 2015-04-29 10:29:45

On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?


---

Comment by jdemeyer created at 2015-04-29 10:29:45

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-04-29 10:32:11

Replying to [comment:10 leif]:
> P.S.:  I didn't "bump" the patch level because MPIR 2.7.0-alpha12 didn't have one, although it was already patched before (meanwhile, in Sage 6.7.beta3, even twice)... ;-)

Since this is purely about a package not compiling, there is not even a need to bump the patchlevel:
- if a user already managed to compile `mpir`, there is no need for this fix.
- if a user did not manage to compile `mpir`, the version number doesn't matter anyway.


---

Comment by leif created at 2015-04-29 13:48:14

Replying to [comment:12 jdemeyer]:
> On the other hand, with `static __inline__` I will be more at ease regarding other (non-GCC) compilers. Here, you are fixing the test just for GCC but what about other compilers with potentially the same problem?

Bike-shedding?

This test is solely for GCC.  Other compilers may pretend they're GCC, but then they should also define the respective macros.  (We explicitly exclude `clang`, we could in principle exclude ICC as well, but that's something upstream should eventually decide, and not at all an issue for Sage.  I'm not aware of any other relevant compiler identifying as GCC.)

Feel free to submit some other patch upstream.


---

Comment by leif created at 2015-04-29 13:48:14

Changing status from needs_info to needs_review.


---

Comment by leif created at 2015-04-29 13:59:02

P.S.:  Using `static __inline__` would actually *modify* the test, so it wouldn't be guaranteed that it catches the situation it was written for (namely a bug in _older GCC versions_).


---

Comment by jdemeyer created at 2015-04-29 14:58:54

Replying to [comment:14 leif]:
> This test is solely for GCC.
I missed this part. I still don't like your patch (in fact, I don't even like the test), but I can accept it.


---

Comment by jdemeyer created at 2015-04-29 14:58:54

Changing status from needs_review to positive_review.


---

Comment by leif created at 2015-04-29 15:27:38

Replying to [comment:16 jdemeyer]:
> I still don't like your patch (in fact, I don't even like the test), but I can accept it.

I don't like the test either; I'd simply require some minimal version of GCC.

But as I said, it's IMHO up to upstream to clean up / decide on the tests...




> but I can accept it.

Thanks.  We can discuss again when finally a new upstream release gets out... ;-)

I just don't want to have a Sage 6.7 that cannot even bootstrap Sage's GCC 4.9.2 with GCC 5.x for no real reason; distros with GCC 5.1 will presumably pop up soon.


---

Comment by vbraun created at 2015-05-01 18:46:04

Resolution: fixed
