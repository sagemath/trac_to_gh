# Issue 15675: pretty print too slow with long lists

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2014-03-08 15:04:46

Keywords: pretty, output, lists, factorial

Assume a student who, in a mood of serendipity, plays with Sage. While both pari and Sage use on the order of 10ms to compute the divisors of 20!:


```
? divisors(20!)

sage: divisors(Integer(20).factorial())
```


the actual time for screen output is much different, where I would estimate pari with less than 100ms but Sage with about 2.5 sec in a terminal on a 3GHz machine. The list has 41040 entries. Sage seems to buffer the stuff somewhere before actual output, and this appears to take a lot of CPU.

You can imagine what happens with 30! where both Sage and pari need 1-2 sec for computation. I had to interrupt Sage after a minute to see this backtrace:


```
/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    236             self.start_displayhook()
    237             self.write_output_prompt()
--> 238             format_dict = self.compute_format_data(result)
    239             self.write_format_data(format_dict)
    240             self.update_user_ns(result)

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)
    148             MIME type representation of the object.
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     def write_format_data(self, format_dict):

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in format(self, obj, include, exclude)
    124                     continue
    125             try:
--> 126                 data = formatter(obj)
    127             except:
    128                 # FIXME: log the exception

/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/displayhook.pyc in __call__(self, obj)
    508         s = self.try_format_obj(obj)
    509         if s is None:
--> 510             s = super(SagePlainTextFormatter, self).__call__(obj)
    511         return s
    512 

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in __call__(self, obj)
    445                 type_pprinters=self.type_printers,
    446                 deferred_pprinters=self.deferred_printers)
--> 447             printer.pretty(obj)
    448             printer.flush()
    449             return stream.getvalue()

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)
    343                 if cls in self.type_pprinters:
    344                     # printer registered in self.type_pprinters
--> 345                     return self.type_pprinters[cls](obj, self, cycle)
    346                 else:
    347                     # deferred printer

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in inner(obj, p, cycle)
    527                 p.text(',')
    528                 p.breakable()
--> 529             p.pretty(x)
    530         if len(obj) == 1 and type(obj) is tuple:
    531             # Special case for 1-item tuples.

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)
    346                 else:
    347                     # deferred printer
--> 348                     printer = self._in_deferred_types(cls)
    349                     if printer is not None:
    350                         return printer(obj, self, cycle)

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in _in_deferred_types(self, cls)
    372         """
    373         mod = getattr(cls, '__module__', None)
--> 374         name = getattr(cls, '__name__', None)
    375         key = (mod, name)
    376         printer = None

/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sage_python_check_interrupt (sage/ext/c_lib.c:1634)()

/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:835)()

KeyboardInterrupt:
```

The student was not exactly encouraged to continue using Sage.


---

Comment by nkprasad12 created at 2014-03-13 02:37:22

This looks to me like a problem with IPython's functions, not Sage directly.


---

Comment by rws created at 2014-03-13 08:56:11

It seems ipython's behaviour is different if I say in ipython:

```
print range(10**6)       # case 1, fraction of a second, output in ONE line

range(10**6)             # case 2, ten seconds, 10^6 lines
```

and the difference is not due to the actual output, but presumably the formatting of the one-value-per-line output.

So, at least people wanting to catch a big output can work around the issue by saying `print` or giving the command.

```
sage: %pprint
Pretty printing has been turned OFF
```



---

Comment by rws created at 2014-03-13 09:01:30

https://github.com/ipython/ipython/issues/5347


---

Comment by rws created at 2014-04-15 08:29:47

Fixed in IPython 2.0, see #16053.


---

Comment by rws created at 2014-11-02 15:11:03

Now that we have IPython-2.3 the `range(10**6)` issue mentioned is indeed fixed there, but `divisors(...)` is still much slower than `print divisors(...)`.
