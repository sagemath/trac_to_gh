# Issue 15675: pretty print too slow with long lists

archive/issues_015675.json:
```json
{
    "body": "Keywords: pretty, output, lists, factorial\n\nAssume a student who, in a mood of serendipity, plays with Sage. While both pari and Sage use on the order of 10ms to compute the divisors of 20!:\n\n\n```\n? divisors(20!)\n\nsage: divisors(Integer(20).factorial())\n```\n\n\nthe actual time for screen output is much different, where I would estimate pari with less than 100ms but Sage with about 2.5 sec in a terminal on a 3GHz machine. The list has 41040 entries. Sage seems to buffer the stuff somewhere before actual output, and this appears to take a lot of CPU.\n\nYou can imagine what happens with 30! where both Sage and pari need 1-2 sec for computation. I had to interrupt Sage after a minute to see this backtrace:\n\n\n```\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n    236             self.start_displayhook()\n    237             self.write_output_prompt()\n--> 238             format_dict = self.compute_format_data(result)\n    239             self.write_format_data(format_dict)\n    240             self.update_user_ns(result)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)\n    148             MIME type representation of the object.\n    149         \"\"\"\n--> 150         return self.shell.display_formatter.format(result)\n    151 \n    152     def write_format_data(self, format_dict):\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in format(self, obj, include, exclude)\n    124                     continue\n    125             try:\n--> 126                 data = formatter(obj)\n    127             except:\n    128                 # FIXME: log the exception\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/displayhook.pyc in __call__(self, obj)\n    508         s = self.try_format_obj(obj)\n    509         if s is None:\n--> 510             s = super(SagePlainTextFormatter, self).__call__(obj)\n    511         return s\n    512 \n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in __call__(self, obj)\n    445                 type_pprinters=self.type_printers,\n    446                 deferred_pprinters=self.deferred_printers)\n--> 447             printer.pretty(obj)\n    448             printer.flush()\n    449             return stream.getvalue()\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)\n    343                 if cls in self.type_pprinters:\n    344                     # printer registered in self.type_pprinters\n--> 345                     return self.type_pprinters[cls](obj, self, cycle)\n    346                 else:\n    347                     # deferred printer\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in inner(obj, p, cycle)\n    527                 p.text(',')\n    528                 p.breakable()\n--> 529             p.pretty(x)\n    530         if len(obj) == 1 and type(obj) is tuple:\n    531             # Special case for 1-item tuples.\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)\n    346                 else:\n    347                     # deferred printer\n--> 348                     printer = self._in_deferred_types(cls)\n    349                     if printer is not None:\n    350                         return printer(obj, self, cycle)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in _in_deferred_types(self, cls)\n    372         \"\"\"\n    373         mod = getattr(cls, '__module__', None)\n--> 374         name = getattr(cls, '__name__', None)\n    375         key = (mod, name)\n    376         printer = None\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sage_python_check_interrupt (sage/ext/c_lib.c:1634)()\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:835)()\n\nKeyboardInterrupt:\n```\n\nThe student was not exactly encouraged to continue using Sage.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15912\n\n",
    "created_at": "2014-03-08T15:04:46Z",
    "labels": [
        "performance",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "pretty print too slow with long lists",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15675",
    "user": "rws"
}
```
Keywords: pretty, output, lists, factorial

Assume a student who, in a mood of serendipity, plays with Sage. While both pari and Sage use on the order of 10ms to compute the divisors of 20!:


```
? divisors(20!)

sage: divisors(Integer(20).factorial())
```


the actual time for screen output is much different, where I would estimate pari with less than 100ms but Sage with about 2.5 sec in a terminal on a 3GHz machine. The list has 41040 entries. Sage seems to buffer the stuff somewhere before actual output, and this appears to take a lot of CPU.

You can imagine what happens with 30! where both Sage and pari need 1-2 sec for computation. I had to interrupt Sage after a minute to see this backtrace:


```
/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    236             self.start_displayhook()
    237             self.write_output_prompt()
--> 238             format_dict = self.compute_format_data(result)
    239             self.write_format_data(format_dict)
    240             self.update_user_ns(result)

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)
    148             MIME type representation of the object.
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     def write_format_data(self, format_dict):

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in format(self, obj, include, exclude)
    124                     continue
    125             try:
--> 126                 data = formatter(obj)
    127             except:
    128                 # FIXME: log the exception

/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/displayhook.pyc in __call__(self, obj)
    508         s = self.try_format_obj(obj)
    509         if s is None:
--> 510             s = super(SagePlainTextFormatter, self).__call__(obj)
    511         return s
    512 

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/core/formatters.pyc in __call__(self, obj)
    445                 type_pprinters=self.type_printers,
    446                 deferred_pprinters=self.deferred_printers)
--> 447             printer.pretty(obj)
    448             printer.flush()
    449             return stream.getvalue()

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)
    343                 if cls in self.type_pprinters:
    344                     # printer registered in self.type_pprinters
--> 345                     return self.type_pprinters[cls](obj, self, cycle)
    346                 else:
    347                     # deferred printer

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in inner(obj, p, cycle)
    527                 p.text(',')
    528                 p.breakable()
--> 529             p.pretty(x)
    530         if len(obj) == 1 and type(obj) is tuple:
    531             # Special case for 1-item tuples.

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in pretty(self, obj)
    346                 else:
    347                     # deferred printer
--> 348                     printer = self._in_deferred_types(cls)
    349                     if printer is not None:
    350                         return printer(obj, self, cycle)

/home/ralf/sage/local/lib/python2.7/site-packages/IPython/lib/pretty.pyc in _in_deferred_types(self, cls)
    372         """
    373         mod = getattr(cls, '__module__', None)
--> 374         name = getattr(cls, '__name__', None)
    375         key = (mod, name)
    376         printer = None

/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sage_python_check_interrupt (sage/ext/c_lib.c:1634)()

/home/ralf/sage/local/lib/python2.7/site-packages/sage/ext/c_lib.so in sage.ext.c_lib.sig_raise_exception (sage/ext/c_lib.c:835)()

KeyboardInterrupt:
```

The student was not exactly encouraged to continue using Sage.

Issue created by migration from https://trac.sagemath.org/ticket/15912





---

archive/issue_comments_202864.json:
```json
{
    "body": "This looks to me like a problem with IPython's functions, not Sage directly.",
    "created_at": "2014-03-13T02:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15675",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15675#issuecomment-202864",
    "user": "nkprasad12"
}
```

This looks to me like a problem with IPython's functions, not Sage directly.



---

archive/issue_comments_202865.json:
```json
{
    "body": "It seems ipython's behaviour is different if I say in ipython:\n\n```\nprint range(10**6)       # case 1, fraction of a second, output in ONE line\n\nrange(10**6)             # case 2, ten seconds, 10^6 lines\n```\n\nand the difference is not due to the actual output, but presumably the formatting of the one-value-per-line output.\n\nSo, at least people wanting to catch a big output can work around the issue by saying `print` or giving the command.\n\n```\nsage: %pprint\nPretty printing has been turned OFF\n```\n",
    "created_at": "2014-03-13T08:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15675",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15675#issuecomment-202865",
    "user": "rws"
}
```

It seems ipython's behaviour is different if I say in ipython:

```
print range(10**6)       # case 1, fraction of a second, output in ONE line

range(10**6)             # case 2, ten seconds, 10^6 lines
```

and the difference is not due to the actual output, but presumably the formatting of the one-value-per-line output.

So, at least people wanting to catch a big output can work around the issue by saying `print` or giving the command.

```
sage: %pprint
Pretty printing has been turned OFF
```




---

archive/issue_comments_202866.json:
```json
{
    "body": "https://github.com/ipython/ipython/issues/5347",
    "created_at": "2014-03-13T09:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15675",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15675#issuecomment-202866",
    "user": "rws"
}
```

https://github.com/ipython/ipython/issues/5347



---

archive/issue_comments_202867.json:
```json
{
    "body": "Fixed in IPython 2.0, see #16053.",
    "created_at": "2014-04-15T08:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15675",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15675#issuecomment-202867",
    "user": "rws"
}
```

Fixed in IPython 2.0, see #16053.



---

archive/issue_comments_202868.json:
```json
{
    "body": "Now that we have IPython-2.3 the `range(10**6)` issue mentioned is indeed fixed there, but `divisors(...)` is still much slower than `print divisors(...)`.",
    "created_at": "2014-11-02T15:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15675",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15675#issuecomment-202868",
    "user": "rws"
}
```

Now that we have IPython-2.3 the `range(10**6)` issue mentioned is indeed fixed there, but `divisors(...)` is still much slower than `print divisors(...)`.
