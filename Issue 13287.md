# Issue 13287: sage_setup() in spkg/bin/sage: do not change directory

archive/issues_013287.json:
```json
{
    "body": "Assignee: leif\n\nFor some unclear reason, there is a\n\n```\ncd \"$SAGE_ROOT/local/bin\"\n```\n\nin the `sage_setup()` function in `spkg/bin/sage`.  Remove this.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13459\n\n",
    "created_at": "2012-09-13T13:52:17Z",
    "labels": [
        "scripts",
        "major",
        "enhancement"
    ],
    "title": "sage_setup() in spkg/bin/sage: do not change directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13287",
    "user": "jdemeyer"
}
```
Assignee: leif

For some unclear reason, there is a

```
cd "$SAGE_ROOT/local/bin"
```

in the `sage_setup()` function in `spkg/bin/sage`.  Remove this.

Issue created by migration from https://trac.sagemath.org/ticket/13459





---

archive/issue_comments_163092.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-09-13T15:16:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163092",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_163093.json:
```json
{
    "body": "Attachment [13459_no_cd.patch](tarball://root/attachments/some-uuid/ticket13459/13459_no_cd.patch) by jdemeyer created at 2012-09-16 19:04:09",
    "created_at": "2012-09-16T19:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163093",
    "user": "jdemeyer"
}
```

Attachment [13459_no_cd.patch](tarball://root/attachments/some-uuid/ticket13459/13459_no_cd.patch) by jdemeyer created at 2012-09-16 19:04:09



---

archive/issue_comments_163094.json:
```json
{
    "body": "There is a problem with\n\n```\nimport sage\n```\n\nwhen the current directory is `$SAGE_ROOT/devel/sage` (or more generally, when a directory `sage` exists).",
    "created_at": "2012-09-19T06:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163094",
    "user": "jdemeyer"
}
```

There is a problem with

```
import sage
```

when the current directory is `$SAGE_ROOT/devel/sage` (or more generally, when a directory `sage` exists).



---

archive/issue_comments_163095.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-09-19T06:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163095",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_163096.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-09-25T19:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163096",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_163097.json:
```json
{
    "body": "Why are there still some \"cd\"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.",
    "created_at": "2012-09-25T22:30:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163097",
    "user": "jhpalmieri"
}
```

Why are there still some "cd"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.



---

archive/issue_comments_163098.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> Why are there still some \"cd\"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.\nI wanted to err on the safe side.  When unsure, I put the `cd` statement (or left it).  `bdist` seems to require the `cd`, for the rest I don't know.",
    "created_at": "2012-09-25T22:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163098",
    "user": "jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> Why are there still some "cd"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.
I wanted to err on the safe side.  When unsure, I put the `cd` statement (or left it).  `bdist` seems to require the `cd`, for the rest I don't know.



---

archive/issue_comments_163099.json:
```json
{
    "body": "Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.",
    "created_at": "2012-09-26T23:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163099",
    "user": "jhpalmieri"
}
```

Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.



---

archive/issue_comments_163100.json:
```json
{
    "body": "Replying to [comment:7 jhpalmieri]:\n> Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.\n\nWhen running Sage through IPython (but not through plain Python when running a script for example), the current working directory is always added to `sys.path` (the empty string is added as zeroth entry, which means the current working directory).  So when doing\n\n```\nimport sage    # or sage.foo.bar....\n```\n\nthe *current working directory* will be checked first for the existence of a \"sage\" module.  If the current working directory happens to be `$SAGE_ROOT/devel/sage`, that contains a \"sage\" subdirectory which Python will happily import.  But this is the wrong directory, it should be imported from `site-packages` instead.  This creates problems for Cython modules, as these exist *only* in `site-packages`.\n\nSo we avoid this problem by first fixing `sys.path`, then importing Sage so any future imports of Sage submodules will work fine.",
    "created_at": "2012-09-27T06:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163100",
    "user": "jdemeyer"
}
```

Replying to [comment:7 jhpalmieri]:
> Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.

When running Sage through IPython (but not through plain Python when running a script for example), the current working directory is always added to `sys.path` (the empty string is added as zeroth entry, which means the current working directory).  So when doing

```
import sage    # or sage.foo.bar....
```

the *current working directory* will be checked first for the existence of a "sage" module.  If the current working directory happens to be `$SAGE_ROOT/devel/sage`, that contains a "sage" subdirectory which Python will happily import.  But this is the wrong directory, it should be imported from `site-packages` instead.  This creates problems for Cython modules, as these exist *only* in `site-packages`.

So we avoid this problem by first fixing `sys.path`, then importing Sage so any future imports of Sage submodules will work fine.



---

archive/issue_comments_163101.json:
```json
{
    "body": "Attachment [13459_no_cd_scripts.patch](tarball://root/attachments/some-uuid/ticket13459/13459_no_cd_scripts.patch) by jdemeyer created at 2012-09-27 06:54:34",
    "created_at": "2012-09-27T06:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163101",
    "user": "jdemeyer"
}
```

Attachment [13459_no_cd_scripts.patch](tarball://root/attachments/some-uuid/ticket13459/13459_no_cd_scripts.patch) by jdemeyer created at 2012-09-27 06:54:34



---

archive/issue_comments_163102.json:
```json
{
    "body": "I just realized that there is no need to change `sys.path` in `sage-ipython`, because we simply import `sage` before IPython is started.  I also added some more comments, needs_review.",
    "created_at": "2012-09-27T06:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163102",
    "user": "jdemeyer"
}
```

I just realized that there is no need to change `sys.path` in `sage-ipython`, because we simply import `sage` before IPython is started.  I also added some more comments, needs_review.



---

archive/issue_comments_163103.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-09-27T19:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163103",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_163104.json:
```json
{
    "body": "Okay, this looks pretty good to me. I might prefer some more comments in spkg/bin/sage, for example pointing out that sage-bdist needs to be run from SAGE_ROOT. (I'm not actually sure that it does, actually: if run from somewhere else, it just creates the temporary directories in the current working directory, but maybe it will still work. I guess for the principle of least surprise, we shouldn't change the behavior of building in SAGE_ROOT/tmp/.)",
    "created_at": "2012-09-27T19:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163104",
    "user": "jhpalmieri"
}
```

Okay, this looks pretty good to me. I might prefer some more comments in spkg/bin/sage, for example pointing out that sage-bdist needs to be run from SAGE_ROOT. (I'm not actually sure that it does, actually: if run from somewhere else, it just creates the temporary directories in the current working directory, but maybe it will still work. I guess for the principle of least surprise, we shouldn't change the behavior of building in SAGE_ROOT/tmp/.)



---

archive/issue_comments_163105.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-09-28T07:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13287",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13287#issuecomment-163105",
    "user": "jdemeyer"
}
```

Resolution: fixed
