# Issue 13287: sage_setup() in spkg/bin/sage: do not change directory

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-09-13 13:52:17

Assignee: leif

For some unclear reason, there is a

```
cd "$SAGE_ROOT/local/bin"
```

in the `sage_setup()` function in `spkg/bin/sage`.  Remove this.


---

Comment by jdemeyer created at 2012-09-13 15:16:12

Changing status from new to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-09-19 06:41:54

There is a problem with

```
import sage
```

when the current directory is `$SAGE_ROOT/devel/sage` (or more generally, when a directory `sage` exists).


---

Comment by jdemeyer created at 2012-09-19 06:41:54

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-09-25 19:47:56

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-09-25 22:30:01

Why are there still some "cd"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.


---

Comment by jdemeyer created at 2012-09-25 22:35:38

Replying to [comment:5 jhpalmieri]:
> Why are there still some "cd"s in spkg/bin/sage? At least some of them (sync-build, bdist, upgrade) don't look like they're needed. I don't know about the patchbot.
I wanted to err on the safe side.  When unsure, I put the `cd` statement (or left it).  `bdist` seems to require the `cd`, for the rest I don't know.


---

Comment by jhpalmieri created at 2012-09-26 23:12:10

Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.


---

Comment by jdemeyer created at 2012-09-27 06:47:24

Replying to [comment:7 jhpalmieri]:
> Can you explain the change in sage-ipython? I don't see any lines corresponding to `import sage` in the old version. I guess I don't know the mechanics of how sage gets imported when you run `sage` from the command line.

When running Sage through IPython (but not through plain Python when running a script for example), the current working directory is always added to `sys.path` (the empty string is added as zeroth entry, which means the current working directory).  So when doing

```
import sage    # or sage.foo.bar....
```

the _current working directory_ will be checked first for the existence of a "sage" module.  If the current working directory happens to be `$SAGE_ROOT/devel/sage`, that contains a "sage" subdirectory which Python will happily import.  But this is the wrong directory, it should be imported from `site-packages` instead.  This creates problems for Cython modules, as these exist _only_ in `site-packages`.

So we avoid this problem by first fixing `sys.path`, then importing Sage so any future imports of Sage submodules will work fine.


---

Attachment


---

Comment by jdemeyer created at 2012-09-27 06:55:26

I just realized that there is no need to change `sys.path` in `sage-ipython`, because we simply import `sage` before IPython is started.  I also added some more comments, needs_review.


---

Comment by jhpalmieri created at 2012-09-27 19:03:04

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-09-27 19:03:04

Okay, this looks pretty good to me. I might prefer some more comments in spkg/bin/sage, for example pointing out that sage-bdist needs to be run from SAGE_ROOT. (I'm not actually sure that it does, actually: if run from somewhere else, it just creates the temporary directories in the current working directory, but maybe it will still work. I guess for the principle of least surprise, we shouldn't change the behavior of building in SAGE_ROOT/tmp/.)


---

Comment by jdemeyer created at 2012-09-28 07:49:18

Resolution: fixed
