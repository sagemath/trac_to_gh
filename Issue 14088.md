# Issue 14088: Race conditions in doctester

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-03-17 11:42:58

Assignee: mvngu




---

Comment by roed created at 2013-03-17 18:27:57

What exactly goes wrong?  Loading and saving stats is done in `DocTestController`, so there aren't multiple processes trying to write to the same file...


---

Comment by jdemeyer created at 2013-03-17 22:20:08

Replying to [comment:2 roed]:
> so there aren't multiple processes trying to write to the same file...
There could be when testing the doctester in parallel. Anyway I have a patch ready but it's on `sage.math` which is currently down.


---

Comment by roed created at 2013-03-28 22:46:23

Changing component from doctest to doctest framework.


---

Comment by roed created at 2013-03-28 22:46:23

Changing assignee from mvngu to roed.


---

Comment by jdemeyer created at 2013-04-04 12:18:05

OK, I managed to recover the data from `sage.math` including this patch. It's not the final version, but it shows the main idea.


---

Comment by jdemeyer created at 2013-04-04 13:17:14

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-04-04 13:58:34

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2013-04-04 14:01:27

Its good to have a general solution to this recurring problem. But writing via a temporary file is an ugly workaround for file locking, which is what we really want to do. It is also likely to hide race conditions. Also, on Win32 (and possibly other non-posix platforms) there is no atomic replace. File locking is also useful as a simple synchronization tool for clusters with a shared file system.


---

Comment by jdemeyer created at 2013-04-04 14:39:35

Replying to [comment:8 vbraun]:
> But writing via a temporary file is an ugly workaround for file locking
Not always. Locking has different goals. Locks should be held as short as possible, which cannot be guaranteed (for example when writing the GAP workspace). My solution also solves the problem of exceptions/crashes during the write and it doesn't need any changes to the reading of files.


---

Comment by jdemeyer created at 2013-04-04 14:41:13

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-04-04 14:49:04

But we really do want locking when creating the gap workspace instead of 10 processes creating the workspace 10 times and then fighting over the workspace file (last process standing wins).


---

Comment by jdemeyer created at 2013-04-04 15:02:58

Does Python have _portable_ file locking commands?


---

Comment by vbraun created at 2013-04-04 15:08:54

Not natively, but e.g. https://github.com/smontanaro/pylockfile looks quite sane to me.


---

Comment by jdemeyer created at 2013-04-04 15:29:21

Volker, I don't object to using that, but I still think this patch here is ready for review. I would rather use file locking _in addition_ to the current patch such that we can have all advantages of both approaches.


---

Comment by vbraun created at 2013-04-04 15:43:32

I agree that using a temp file is good enough for now. But it would be nice if we could rename `write_via_temp` to something that embodies the underlying idea instead of the implementation. Then we could improve the implementation later without having to change the usage. Maybe `write_safely` or `write_threadsafe`.


---

Comment by jdemeyer created at 2013-04-04 17:24:06

If you prefer `write_safely`, that's fine for me. However, I do think that using locking and using a temporary file are two different solutions which are sufficiently different to warrant different names. Given this, perhaps it is better to be explicit about the implementation.


---

Comment by vbraun created at 2013-04-04 18:03:39

Well if your goal is to eventually have both proper locking and atomic writing separately then thats fine. But the name should still convey why we are doing that, not how. 

Obviously many Sage developers are not familiar with which file system operations are atomic, so they will rightfully be confused when they see code that writes a cache with `write_via_temp`. Clearly there is an optimization where you take out that extra step ;-)

How about `atomic_write`?


---

Comment by jdemeyer created at 2013-04-04 18:26:53

Do you agree with the patch, modulo the naming of `write_via_temp`?


---

Comment by vbraun created at 2013-04-04 18:33:09

Yes, I think its great to use a with block and the actual implementation seems fine. With the caveat that Windows can't do atomic replace, but then there is nothing we can do about it.


---

Attachment


---

Comment by jdemeyer created at 2013-04-05 09:24:21

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-05 09:24:21

OK, renamed to `atomic_write`.


---

Comment by jdemeyer created at 2013-04-06 14:49:55

Resolution: fixed
