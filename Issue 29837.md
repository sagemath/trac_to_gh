# Issue 29837: Speedups for symbolic assumptions

archive/issues_029837.json:
```json
{
    "body": "CC:  egourgoulhon slelievre\n\nAs a follow-up from #30065, \nwe cache `GenericDeclaration`, maintain the current assumptions as an `OrderedDict` instead of a list, and rework `GenericDeclaration.assume` so it reuses maxima contexts.\n\nThe examples from #30065 become near-instantaneous.\n\nThe example from #30061, previously 32.8 s, becomes much faster:\n\n```\nsage: %time EuclideanSpace(80)\nCPU times: user 1.76 s, sys: 194 ms, total: 1.95 s\nWall time: 1.63 s\n80-dimensional Euclidean space E^80\n```\n\n\nAlso `./sage -btp src/sage/symbolic/ src/sage/manifolds/ src/sage/calculus/` shows modest improvements.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30074\n\n",
    "created_at": "2020-07-06T06:53:11Z",
    "labels": [
        "symbolics",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Speedups for symbolic assumptions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29837",
    "user": "mkoeppe"
}
```
CC:  egourgoulhon slelievre

As a follow-up from #30065, 
we cache `GenericDeclaration`, maintain the current assumptions as an `OrderedDict` instead of a list, and rework `GenericDeclaration.assume` so it reuses maxima contexts.

The examples from #30065 become near-instantaneous.

The example from #30061, previously 32.8 s, becomes much faster:

```
sage: %time EuclideanSpace(80)
CPU times: user 1.76 s, sys: 194 ms, total: 1.95 s
Wall time: 1.63 s
80-dimensional Euclidean space E^80
```


Also `./sage -btp src/sage/symbolic/ src/sage/manifolds/ src/sage/calculus/` shows modest improvements.

Issue created by migration from https://trac.sagemath.org/ticket/30074





---

archive/issue_comments_423828.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-06T06:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423828",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423829.json:
```json
{
    "body": "I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:\n\n```\nsage: from collections import OrderedDict\nsage: d = OrderedDict()\nsage: for i in range(10):\n....:     d[i] = None\nsage: x = set(range(10))\n\nsage: def test_iter(X):\n....:     for i in X:\n....:         pass\n....: def test_access(X):\n....:     for i in range(20):\n....:         if i in X:\n....:             pass\n\nsage: %timeit test_iter(d)\n1000000 loops, best of 5: 293 ns per loop\nsage: %timeit test_iter(x)\n10000000 loops, best of 5: 173 ns per loop\n\nsage: %timeit test_access(d)\n1000000 loops, best of 5: 786 ns per loop\nsage: %timeit test_access(x)\n1000000 loops, best of 5: 761 ns per loop\n```\n\nAlthough this micro-optimization probably doesn't matter too much.\n----\nNew commits:",
    "created_at": "2020-07-07T01:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423829",
    "user": "tscrim"
}
```

I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:

```
sage: from collections import OrderedDict
sage: d = OrderedDict()
sage: for i in range(10):
....:     d[i] = None
sage: x = set(range(10))

sage: def test_iter(X):
....:     for i in X:
....:         pass
....: def test_access(X):
....:     for i in range(20):
....:         if i in X:
....:             pass

sage: %timeit test_iter(d)
1000000 loops, best of 5: 293 ns per loop
sage: %timeit test_iter(x)
10000000 loops, best of 5: 173 ns per loop

sage: %timeit test_access(d)
1000000 loops, best of 5: 786 ns per loop
sage: %timeit test_access(x)
1000000 loops, best of 5: 761 ns per loop
```

Although this micro-optimization probably doesn't matter too much.
----
New commits:



---

archive/issue_comments_423830.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:\n\nRight, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. \n\nOrdered because I wanted to preserve the behavior of the previous code using lists to reduce the potential for changes from the order of operations. In this untyped symbolics business, it's best to tread very carefully.\n\nThe small constant factor between `set` and `OrderDict` does not matter much, I would think.",
    "created_at": "2020-07-07T01:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423830",
    "user": "mkoeppe"
}
```

Replying to [comment:3 tscrim]:
> I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:

Right, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. 

Ordered because I wanted to preserve the behavior of the previous code using lists to reduce the potential for changes from the order of operations. In this untyped symbolics business, it's best to tread very carefully.

The small constant factor between `set` and `OrderDict` does not matter much, I would think.



---

archive/issue_comments_423831.json:
```json
{
    "body": "Then let it be so.",
    "created_at": "2020-07-07T01:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423831",
    "user": "tscrim"
}
```

Then let it be so.



---

archive/issue_comments_423832.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-07T01:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423832",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423833.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-07-07T01:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423833",
    "user": "mkoeppe"
}
```

Thank you!



---

archive/issue_comments_423834.json:
```json
{
    "body": "Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that \"UniqueRepresentation\" is used just for caching behaviour here. That's not what UniqueRepresentation is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for \"CachedRepresentation\".\n\nIn either case, the caching comes with a heavy price to pay: the construction parameters used for CachedRepresentation and UniqueRepresentation get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.",
    "created_at": "2020-07-07T05:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423834",
    "user": "nbruin"
}
```

Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that "UniqueRepresentation" is used just for caching behaviour here. That's not what UniqueRepresentation is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for "CachedRepresentation".

In either case, the caching comes with a heavy price to pay: the construction parameters used for CachedRepresentation and UniqueRepresentation get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.



---

archive/issue_comments_423835.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2020-07-07T05:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423835",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_423836.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> Replying to [comment:3 tscrim]:\n> > I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:\n> \n> Right, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. \n\nAs of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.",
    "created_at": "2020-07-07T06:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423836",
    "user": "@mwageringel"
}
```

Replying to [comment:4 mkoeppe]:
> Replying to [comment:3 tscrim]:
> > I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:
> 
> Right, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. 

As of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.



---

archive/issue_comments_423837.json:
```json
{
    "body": "Considering that the inputs are a symbolic variable and a string, I would be very surprised if any memory leaks were ever created.\n\nHowever, one benefit is the equality checks and hashing becomes really quick for the `UniqueRepresentation`.",
    "created_at": "2020-07-07T06:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423837",
    "user": "tscrim"
}
```

Considering that the inputs are a symbolic variable and a string, I would be very surprised if any memory leaks were ever created.

However, one benefit is the equality checks and hashing becomes really quick for the `UniqueRepresentation`.



---

archive/issue_comments_423838.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-07T16:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423838",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423839.json:
```json
{
    "body": "Replying to [comment:8 gh-mwageringel]:\n> As of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.\n\nThanks, done.",
    "created_at": "2020-07-07T16:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423839",
    "user": "mkoeppe"
}
```

Replying to [comment:8 gh-mwageringel]:
> As of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.

Thanks, done.



---

archive/issue_comments_423840.json:
```json
{
    "body": "Replying to [comment:7 nbruin]:\n> Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that `UniqueRepresentation` is used just for caching behaviour here. That's not what `UniqueRepresentation` is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for `CachedRepresentation`.\n> \n> In either case, the caching comes with a heavy price to pay: the construction parameters used for `CachedRepresentation` and `UniqueRepresentation` get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.\n\nThanks for the discussion. This is an important point.\n\nI am using `UniqueRepresentation` here in the same way as I would use `INTERN` in Lisp. \n\nNote that `SR` variable names already have indefinite lifetime: `SR.var` adds them to the dictionary `SR.symbols`; even `reset()` does not remove them. \n\nBefore this ticket, a `GenericDeclaration` is associated with a Maxima context after calling `.assume()` for the first time. The context is never killed or collected. Repeated assumptions as illustrated in the examples in #30065 lead to unbounded growth and slowdown.\n\nIn this ticket, by using `UniqueRepresentation` for `GenericDeclaration`, I manage the resource \"Maxima context\" explicitly; it's not just caching. Effectively I give indefinite lifetime to pairs of an `SR` variable and a declaration - this matches the indefinite lifetime of Maxima contexts that was already present. But now repeated assumptions no longer lead to growth.",
    "created_at": "2020-07-07T16:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423840",
    "user": "mkoeppe"
}
```

Replying to [comment:7 nbruin]:
> Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that `UniqueRepresentation` is used just for caching behaviour here. That's not what `UniqueRepresentation` is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for `CachedRepresentation`.
> 
> In either case, the caching comes with a heavy price to pay: the construction parameters used for `CachedRepresentation` and `UniqueRepresentation` get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.

Thanks for the discussion. This is an important point.

I am using `UniqueRepresentation` here in the same way as I would use `INTERN` in Lisp. 

Note that `SR` variable names already have indefinite lifetime: `SR.var` adds them to the dictionary `SR.symbols`; even `reset()` does not remove them. 

Before this ticket, a `GenericDeclaration` is associated with a Maxima context after calling `.assume()` for the first time. The context is never killed or collected. Repeated assumptions as illustrated in the examples in #30065 lead to unbounded growth and slowdown.

In this ticket, by using `UniqueRepresentation` for `GenericDeclaration`, I manage the resource "Maxima context" explicitly; it's not just caching. Effectively I give indefinite lifetime to pairs of an `SR` variable and a declaration - this matches the indefinite lifetime of Maxima contexts that was already present. But now repeated assumptions no longer lead to growth.



---

archive/issue_comments_423841.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-07-07T16:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423841",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_423842.json:
```json
{
    "body": "Any more thoughts on this one?",
    "created_at": "2020-07-10T18:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423842",
    "user": "mkoeppe"
}
```

Any more thoughts on this one?



---

archive/issue_comments_423843.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-14T19:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423843",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423844.json:
```json
{
    "body": "Nils, are you okay with the current version and justifications? If so, then I would set a positive review.",
    "created_at": "2020-07-15T00:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423844",
    "user": "tscrim"
}
```

Nils, are you okay with the current version and justifications? If so, then I would set a positive review.



---

archive/issue_comments_423845.json:
```json
{
    "body": "It's me again, complaining about pyflakes warnings, again. Due to the new use of `UniqueRepresentation`, the import of `SageObject` is not necessary anymore.",
    "created_at": "2020-07-15T04:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423845",
    "user": "@mjungmath"
}
```

It's me again, complaining about pyflakes warnings, again. Due to the new use of `UniqueRepresentation`, the import of `SageObject` is not necessary anymore.



---

archive/issue_comments_423846.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-15T05:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423846",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423847.json:
```json
{
    "body": "Green bot, so I am setting a positive review.",
    "created_at": "2020-07-18T23:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423847",
    "user": "tscrim"
}
```

Green bot, so I am setting a positive review.



---

archive/issue_comments_423848.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-18T23:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423848",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423849.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-07-18T23:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423849",
    "user": "mkoeppe"
}
```

Thank you!



---

archive/issue_comments_423850.json:
```json
{
    "body": "Modifying ticket description which still mentioned `OrderedDict`.",
    "created_at": "2020-07-26T01:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423850",
    "user": "slelievre"
}
```

Modifying ticket description which still mentioned `OrderedDict`.



---

archive/issue_comments_423851.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-28T22:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29837#issuecomment-423851",
    "user": "vbraun"
}
```

Resolution: fixed
