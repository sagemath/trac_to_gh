# Issue 29837: Speedups for symbolic assumptions

Issue created by migration from https://trac.sagemath.org/ticket/30074

Original creator: mkoeppe

Original creation time: 2020-07-06 06:53:11

CC:  egourgoulhon slelievre

As a follow-up from #30065, 
we cache `GenericDeclaration`, maintain the current assumptions as an `OrderedDict` instead of a list, and rework `GenericDeclaration.assume` so it reuses maxima contexts.

The examples from #30065 become near-instantaneous.

The example from #30061, previously 32.8 s, becomes much faster:

```
sage: %time EuclideanSpace(80)
CPU times: user 1.76 s, sys: 194 ms, total: 1.95 s
Wall time: 1.63 s
80-dimensional Euclidean space E^80
```


Also `./sage -btp src/sage/symbolic/ src/sage/manifolds/ src/sage/calculus/` shows modest improvements.


---

Comment by mkoeppe created at 2020-07-06 06:53:39

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-07-07 01:06:36

I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:

```
sage: from collections import OrderedDict
sage: d = OrderedDict()
sage: for i in range(10):
....:     d[i] = None
sage: x = set(range(10))

sage: def test_iter(X):
....:     for i in X:
....:         pass
....: def test_access(X):
....:     for i in range(20):
....:         if i in X:
....:             pass

sage: %timeit test_iter(d)
1000000 loops, best of 5: 293 ns per loop
sage: %timeit test_iter(x)
10000000 loops, best of 5: 173 ns per loop

sage: %timeit test_access(d)
1000000 loops, best of 5: 786 ns per loop
sage: %timeit test_access(x)
1000000 loops, best of 5: 761 ns per loop
```

Although this micro-optimization probably doesn't matter too much.
----
New commits:


---

Comment by mkoeppe created at 2020-07-07 01:34:59

Replying to [comment:3 tscrim]:
> I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:

Right, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. 

Ordered because I wanted to preserve the behavior of the previous code using lists to reduce the potential for changes from the order of operations. In this untyped symbolics business, it's best to tread very carefully.

The small constant factor between `set` and `OrderDict` does not matter much, I would think.


---

Comment by tscrim created at 2020-07-07 01:51:26

Then let it be so.


---

Comment by tscrim created at 2020-07-07 01:51:26

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-07 01:52:19

Thank you!


---

Comment by nbruin created at 2020-07-07 05:26:56

Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that "UniqueRepresentation" is used just for caching behaviour here. That's not what UniqueRepresentation is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for "CachedRepresentation".

In either case, the caching comes with a heavy price to pay: the construction parameters used for CachedRepresentation and UniqueRepresentation get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.


---

Comment by nbruin created at 2020-07-07 05:26:56

Changing status from positive_review to needs_info.


---

Comment by @mwageringel created at 2020-07-07 06:06:56

Replying to [comment:4 mkoeppe]:
> Replying to [comment:3 tscrim]:
> > I wonder a little bit if `OrderedDict` is really the best data structure. It feels like it really should be a `set`, but I guess `OrderedDict` has more guaranteed consistency across different sessions. Note that iterating over a `set` is actually faster:
> 
> Right, I actually would have wanted an `OrderedSet` here except that there is no such thing in the standard library. 

As of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.


---

Comment by tscrim created at 2020-07-07 06:07:50

Considering that the inputs are a symbolic variable and a string, I would be very surprised if any memory leaks were ever created.

However, one benefit is the equality checks and hashing becomes really quick for the `UniqueRepresentation`.


---

Comment by git created at 2020-07-07 16:20:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-07 16:20:59

Replying to [comment:8 gh-mwageringel]:
> As of Python 3.6.x, regular dicts preserve the insertion order, so in most cases `OrderedDict` is not needed anymore.

Thanks, done.


---

Comment by mkoeppe created at 2020-07-07 16:34:15

Replying to [comment:7 nbruin]:
> Perhaps this point can be cleared quickly, but I think it deserves addressing. It seems here that `UniqueRepresentation` is used just for caching behaviour here. That's not what `UniqueRepresentation` is for!! It imposes very specific semantics! If it's just the caching, perhaps you're looking for `CachedRepresentation`.
> 
> In either case, the caching comes with a heavy price to pay: the construction parameters used for `CachedRepresentation` and `UniqueRepresentation` get global references to them for the lifetime of the created object. This can create very non-obvious memory leaks. For instance, you have to make absolutely sure that the construction parameters never support a reference chain pointing to the created object. Furthermore, you have to make absolutely sure that the created object is immutable, because unrelated pieces of code can end up sharing a reference to the object.

Thanks for the discussion. This is an important point.

I am using `UniqueRepresentation` here in the same way as I would use `INTERN` in Lisp. 

Note that `SR` variable names already have indefinite lifetime: `SR.var` adds them to the dictionary `SR.symbols`; even `reset()` does not remove them. 

Before this ticket, a `GenericDeclaration` is associated with a Maxima context after calling `.assume()` for the first time. The context is never killed or collected. Repeated assumptions as illustrated in the examples in #30065 lead to unbounded growth and slowdown.

In this ticket, by using `UniqueRepresentation` for `GenericDeclaration`, I manage the resource "Maxima context" explicitly; it's not just caching. Effectively I give indefinite lifetime to pairs of an `SR` variable and a declaration - this matches the indefinite lifetime of Maxima contexts that was already present. But now repeated assumptions no longer lead to growth.


---

Comment by mkoeppe created at 2020-07-07 16:35:12

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-07-10 18:11:57

Any more thoughts on this one?


---

Comment by git created at 2020-07-14 19:54:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-15 00:32:10

Nils, are you okay with the current version and justifications? If so, then I would set a positive review.


---

Comment by @mjungmath created at 2020-07-15 04:24:18

It's me again, complaining about pyflakes warnings, again. Due to the new use of `UniqueRepresentation`, the import of `SageObject` is not necessary anymore.


---

Comment by git created at 2020-07-15 05:02:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-18 23:24:15

Green bot, so I am setting a positive review.


---

Comment by tscrim created at 2020-07-18 23:24:15

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-07-18 23:29:46

Thank you!


---

Comment by slelievre created at 2020-07-26 01:18:11

Modifying ticket description which still mentioned `OrderedDict`.


---

Comment by vbraun created at 2020-07-28 22:31:47

Resolution: fixed
