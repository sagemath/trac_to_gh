# Issue 27775: py3: import certain things from collections.abc

Issue created by migration from https://trac.sagemath.org/ticket/28012

Original creator: slelievre

Original creation time: 2019-06-19 00:18:42

CC:  chapoton jhpalmieri slelievre vdelecroix tscrim

Keywords: days101

As the [Python 3 documentation for the `collections` module](https://docs.python.org/3.7/library/collections.html) explains,
some [Collections Abstract Base Classes](https://docs.python.org/3.7/library/collections.abc.html#collections-abstract-base-classes)
moved to the [`collections.abc`](https://docs.python.org/3.7/library/collections.abc.html#module-collections.abc) module, staying visible in `collections` through Python 3.7.

These "Collections Abstract Base Classes" currently include
`AsyncGenerator`, `AsyncIterable`, `AsyncIterator`, `Awaitable`,
`Bytestring`, `Callable`, `Collection`, `Container`, `Coroutine`,
`Generator`, `Hashable`, `ItemsView`, `Iterable`, `Iterator`, `KeysView`,
`Mapping`, `MappingView`, `MutableMapping`, `MutableSequence`,
`MutableSet`, `Reversible`, `Sequence`, `Set`, `Sized`, `ValuesView`.

In Python 3.8 importing them from `collections` will stop working.
In Python 3.3 to 3.7, they can be imported from `collections` or
from `collections.abc` (it gives the exact same classes).
In Python 3.7, importing them from `collections` prints a
deprecation warning, since Python 3.8 is getting near.

In Python 2 they can only be imported from 'collections',
not from 'collections.abc'.

In Sage we have a few such imports:
`Iterable`, `Iterator`, `MutableMapping`, `Sequence`.

We deal with this using a try/except block:

```
try:  # works in Python >= 3.3
    from collections.abc import Sequence
except ImportError:  # Python 2, Python <= 3.2
    from collections import Sequence
```


We can then revert the silencing of warnings from #28002.


---

Comment by slelievre created at 2019-06-19 00:20:51

Changing keywords from "days101" to "days101, py3".


---

Comment by slelievre created at 2019-06-19 00:20:51

New commits:


---

Comment by slelievre created at 2019-06-19 00:21:49

Changing status from new to needs_review.


---

Comment by slelievre created at 2019-06-19 00:25:20

Note: to check where such changes were needed I followed advice in a comment at #28002 and did

```
$ git grep "from collections import"
```



---

Comment by slelievre created at 2019-06-19 00:27:59

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2019-06-19 00:27:59

More changes are needed, as revealed by

```
$ git grep "collections\."
```

I'll push a commit.


---

Comment by slelievre created at 2019-06-19 00:34:39

The relevant lines in the output of `git grep "collections\."` seem to be:

```
src/sage/arith/misc.py:    if isinstance(ks[0], collections.Iterable):
src/sage/combinat/finite_state_machine.py:                         collections.Iterator):
src/sage/combinat/ranker.py:    from collections.abc import Iterable, Sequence
src/sage/combinat/ranker.py:    tuple (or more generally a :class:`collections.Sequence`), an
src/sage/combinat/ranker.py:    :class:`collections.Iterable`). See :trac:`15919`.
src/sage/combinat/ranker.py:    Lists, tuples, and other :class:`sequences <collections.Sequence>`::
src/sage/combinat/shuffle.py:        assert(isinstance(l1, collections.Iterable) and
src/sage/combinat/shuffle.py:               isinstance(l2, collections.Iterable)
src/sage/combinat/shuffle.py:        assert(all(isinstance(elem, collections.Iterable) for elem in l1))
src/sage/combinat/shuffle.py:        assert(all(isinstance(elem, collections.Iterable) for elem in l2))
src/sage/combinat/shuffle.py:        assert(isinstance(l1, collections.Iterable) and
src/sage/combinat/shuffle.py:               isinstance(l2, collections.Iterable)
src/sage/databases/conway.py:class DictInMapping(collections.Mapping):
src/sage/databases/conway.py:class ConwayPolynomials(collections.Mapping):
src/sage/game_theory/normal_form_game.py:    from collections.abc import MutableMapping
src/sage/geometry/cone.py:                            collections.Hashable,
src/sage/geometry/cone.py:                            collections.Iterable):
src/sage/geometry/cone.py:                                   collections.Container):
src/sage/geometry/fan.py:                            collections.Callable,
src/sage/geometry/fan.py:                            collections.Container):
src/sage/geometry/lattice_polytope.py:class LatticePolytopeClass(SageObject, collections.Hashable):
src/sage/geometry/lattice_polytope.py:                   collections.Hashable):
src/sage/matrix/matrix_integer_sparse.pyx:    from collections.abc import Iterator, Sequence
src/sage/matrix/matrix_modn_sparse.pyx:    from collections.abc import Iterator, Sequence
src/sage/misc/converting_dict.py:            if isinstance(arg, collections.Mapping):
src/sage/modules/with_basis/morphism.py:        if not isinstance(diagonal, collections.Callable):
src/sage/plot/colors.py:class Colormaps(collections.MutableMapping):
src/sage/plot/point.py:    if isinstance(points, collections.Iterator):
src/sage/repl/ipython_kernel/interact.py:    from collections.abc import Iterable, Iterator
src/sage/repl/ipython_kernel/widgets_sagenb.py:    from collections.abc import Iterable, Sequence
```



---

Comment by jhpalmieri created at 2019-06-19 01:24:36

Two comments: there may be instances of this in other packages, like matplotlib. Also, it's not just warnings silenced in #28002, but an older silencing in `sage/all.py`.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-22 00:57:19

Now that we don't support py2 any more, the try/except approach is not needed any more.


---

Comment by slelievre created at 2020-08-22 05:56:54

Changing keywords from "days101, py3" to "days101, py3, collections.abc".


---

Comment by slelievre created at 2020-08-22 05:56:54

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2020-08-22 05:56:54

Sorry for letting over a year pass by. Here is a new branch. Please review.

The file `finite_state_machine.py` has `import collections`
and then `collections.defaultdict`, `collections.OrderedDict`,
`collections.deque`, `collections.namedtuple`, `collections.abc.Iterator`.

Would there be an advantage, or a disadvantage, to doing the following instead:

```
from collections import defaultdict, deque, namedtuple, OrderedDict
from collections.abc import Iterator
```

and then using `defaultdict`, `OrderedDict`, `deque`, `namedtuple`, `Iterator`?

I changed to that style in some other files.
----
New commits:


---

Comment by git created at 2020-08-22 06:07:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2020-08-22 06:08:07

I had left one file out, I forced push.


---

Comment by slelievre created at 2020-08-22 06:48:10

Vincent, I now see you already did the work at #28315 a year ago.

Sorry for delaying this. Would you like to review?


---

Comment by git created at 2020-09-05 09:25:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2020-09-05 09:28:17

Rebased on 9.2.beta11
----
New commits:


---

Comment by jhpalmieri created at 2020-09-05 17:33:06

I'm getting some deprecation warnings. Some can be fixed by this:

```diff
diff --git a/src/sage/repl/ipython_kernel/interact.py b/src/sage/repl/ipython_kernel/interact.py
index 5fb318a6e4..ac0376ca63 100644
--- a/src/sage/repl/ipython_kernel/interact.py
+++ b/src/sage/repl/ipython_kernel/interact.py
@@ -35,7 +35,8 @@ EXAMPLES::
 
 from ipywidgets.widgets import SelectionSlider, ValueWidget, ToggleButtons
 from ipywidgets.widgets.interaction import interactive, signature
-from collections import Iterable, Iterator, OrderedDict
+from collections.abc import Iterable, Iterator
+from collections import OrderedDict
 from .widgets import EvalText, SageColorPicker
 from .widgets_sagenb import input_grid
 from sage.structure.element import parent
```

Some are coming from other Python packages, though. (This is with a Sage build using a system Python 3.7.) For example, one doctest fails because of

```
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta11/local/lib/python3.7/site-packages/babel/localedata.py", line 17, in <module>
        from collections import MutableMapping
```

another with

```
      File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.2.beta11/local/lib/python3.7/site-packages/requests/packages/urllib3/util/selectors.py", line 11, in <module>
        from collections import namedtuple, Mapping
```

Maybe we need to delay the suppression of the silencing of the deprecation warning. ;)


---

Comment by slelievre created at 2020-09-05 20:10:01

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2020-09-05 20:10:01

I agree:

- `src/repl_ipython_kernel/interact.py` does need the change you say
- suppressing the silencing of the warnings does need to be delayed

I will take care of that. Any advice about my question in [comment:15]?


---

Comment by jhpalmieri created at 2020-09-05 20:22:33

The typical (but not universal) Sage style seems to be "from blah import foo" and then "foo(...)" rather than "import blah" and then "blah.foo(...)". So that's what I would choose, as you suggested.


---

Comment by git created at 2020-09-07 22:27:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-09-07 22:41:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2020-09-07 22:43:20

Fixed and rebased on 9.2.beta12. Sorry for one more force-push.


---

Comment by slelievre created at 2020-09-07 22:43:20

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2020-09-08 03:44:59

Still needs work. Almost there. Will push shortly.


---

Comment by slelievre created at 2020-09-08 03:44:59

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-09-10 17:58:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2020-09-10 17:59:41

Please review.


---

Comment by slelievre created at 2020-09-10 17:59:41

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-09-10 20:34:10

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-09-10 20:34:10

Looks good to me.


---

Comment by vbraun created at 2020-09-15 21:58:51

Resolution: fixed


---

Comment by slelievre created at 2020-10-13 22:32:02

Follow-up at #30768 for unsilencing the deprecation warning.
