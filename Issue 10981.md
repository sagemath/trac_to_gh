# Issue 10981: Re-fix #4434 (merging broken on OS X) using MergeToolConfiguration in Mercurial 1.x

Issue created by migration from https://trac.sagemath.org/ticket/11120

Original creator: kini

Original creation time: 2011-04-04 08:37:12

Assignee: tbd

Keywords: mercurial, os x

#4434 should be backed out and fixed (if even still necessary) in a more modern fashion. In the newer versions of Mercurial currently shipped with sage, hgmerge is obsolete (and in fact has been since 1.0, which might explain why no script at all was being copied over, as mentioned in the description of #4434). It's not a good idea to rely on outdated functionality.

See http://mercurial.selenic.com/wiki/hgmerge :

>Before Mercurial 1.0, a script named hgmerge was installed by default. As of Mercurial 1.0, hgmerge is no longer installed (and it should not be distributed with Mercurial), but hg still uses it, if it's present on the system and no other merge tools are configured. See [MergeToolConfiguration](http://mercurial.selenic.com/wiki/MergeToolConfiguration) for the new mechanism.

Hopefully removing this hgmerge file will simply work on OS X - otherwise, a solution should be made using hgrc as described at [MergeToolConfiguration](http://mercurial.selenic.com/wiki/MergeToolConfiguration).


---

Comment by dimpase created at 2011-04-04 14:05:49

hmm, how does one check that removing hgmerge does not break things?
reading #4434 says it's about a 3-way graphical thing, of which I am clueless...


---

Comment by kini created at 2011-04-04 16:37:34

As we talked about in person, I guess the way to test it would be to try using `sage -hg` to merge files which cannot be automatically merged. I created [this minimal example of such a repository and such a file](http://sage.math.washington.edu/home/keshav/temp/hgmerge-test/), which you then pulled and tried out, using `sage -hg` with `$SAGE_ROOT/bin/hgmerge` removed. This worked just as well as it works on my Linux machine:


```
keshav@esterhazy ~/temp/hgmerge-test $ sage -hg log --style=compact
2[tip]:0   212fc073ffa9   2011-04-04 08:10 -0700   kini
  Three

1   478fc08a9390   2011-04-04 08:09 -0700   kini
  Two

0   a8cccf400996   2011-04-04 08:08 -0700   kini
  One

keshav@esterhazy ~/temp/hgmerge-test $ sage -hg merge
merging somefile
warning: conflicts during merge.
merging somefile failed!
0 files updated, 0 files merged, 0 files removed, 1 files unresolved
use 'hg resolve' to retry unresolved file merges or 'hg update -C' to abandon
keshav@esterhazy ~/temp/hgmerge-test $ 
```


Note that this is not really an _error_ - it's just the lack of a default merge program being installed. Could it be possible that the problem that occasioned #4474 is present on Linux as well?

There is actually a sort of "merge tool autodect script" (actually just some configuration entries making mercurial smarter about where to find a range of common merging tools) which is provided but not installed by the upstream distribution of Mercurial, and which lies in the file `src/contrib/mergetools.rc` within the spkg's root directory. Putting this in `$SAGE_LOCAL/etc/mercurial/hgrc.d/` should cause merge program problems to go away. I'll write a patch...


---

Comment by kini created at 2011-04-05 10:19:45

Changing status from new to needs_review.


---

Comment by dimpase created at 2011-04-05 10:47:51

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2011-04-05 10:47:51

Replying to [comment:4 kini]:

```
applying trac_11120-re-fix-trac_4434.mercurial-spkg.patch
patching file spkg-install
Hunk #1 succeeded at 37 with fuzz 1 (offset -30 lines).
now at: trac_11120-re-fix-trac_4434.mercurial-spkg.patch
```

why do I see fuzz? I'm applying it to the mercurial spkg that comes with sage- 4.7.alpha3

As well, it seems that your patch either wasn't tested, or was tested against a diffrent spkg. Indeed, I get:

```
...
riting /usr/local/src/sage/sage-4.7.alpha3/local/lib/python/mercurial-1.6.4-py2.6.egg-info
cp: contrib/mergetools.rc: No such file or directory
Error installing mergetools.rc
Deleting dead links
...
```

at the end of the sage -f mecurial....
indeed, it should be "src/contrib/" rather than just "contrib/" in the argument of "cp".


---

Comment by dimpase created at 2011-04-05 11:01:34

Replying to [comment:5 dimpase]:

OK, this depends on #11121, which isn't ready yet. Oops...


---

Comment by kini created at 2011-04-05 12:38:30

Yes, you're right, it depends on #11121 (specifically on the patch there which applies to the mercurial spkg). Sorry, I'll make that more prominent in the ticket description. As for the error actually copying the file, it's actually because the filename is wrong. It still needs to be called `mergetools.rc` (or at least something`.rc`) in order to work, but in the vanilla Mercurial source distribution it is actually called `contrib/mergetools.hgrc` for some reason. It needs to be renamed during the copy over. I think I had renamed it in my sandbox by mistake at some point when trying to fiddle with it to test different diff viewers - stupid oversight on my part. I'll fix it. Sorry for the inconvenience.


---

Comment by kini created at 2011-04-06 14:18:24

Changing status from needs_work to needs_review.


---

Comment by kini created at 2011-04-06 14:18:24

Now that I've upgraded to and rebuilt alpha3 I can confirm that the spkg installs nicely and does what it's supposed to do after applying the patch. Marking as needs_review . Should I upload a new spkg file to sage.math.washington.edu, or does the release manager make the new spkg by applying a patch I upload to trac? I'll do both for now.

Replying to [comment:2 kini]:
> Note that this is not really an _error_ - it's just the lack of a default merge program being installed. Could it be possible that the problem that occasioned #4474 is present on Linux as well?

I of course meant #4434 here -- oops.


---

Comment by kini created at 2011-04-06 14:19:00

apply to mercurial spkg's repository


---

Attachment

Keshav: a request: while you're working on mercurial issues on OS X, could you also take a look at #10171?


---

Comment by kini created at 2011-04-06 18:07:23

John: I only made this ticket because I happened across the patch of #4434 while trying to fix #11121 :) I'm running Debian Wheezy and don't have a Mac... I see that Dmitrii is on the case, however.


---

Comment by kini created at 2011-04-22 11:25:01

(testing #10966)


---

Comment by kini created at 2011-06-14 02:46:42

I'll fix this along with #10594, hopefully.


---

Comment by kini created at 2011-06-14 02:46:42

Changing status from needs_review to needs_work.


---

Comment by kini created at 2011-06-14 06:30:56

Changing keywords from "mercurial, os x" to "mercurial osx sd31".


---

Comment by kini created at 2011-06-14 06:30:56

This should be fixed by [this spkg](http://sage.math.washington.edu/home/keshav/files/mercurial-1.8.4.spkg). Please review!


---

Comment by kini created at 2011-06-14 06:30:56

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-06-22 00:01:23

Two things: first, I'm not sure how to test this.  Second, during an upgrade on OS X, the file hgmerge is still present in SAGE_LOCAL/bin.  Is that going to be a problem, or will the settings in hgrc.d/mergetools.rc override it?


---

Comment by kini created at 2011-06-22 01:17:55

`hgmerge` remaining in SAGE_LOCAL/bin is not a problem; `mergetools.rc` overrides it. I guess the best way to test this is to try to replicate #4434 with the new spkg installed - it should be impossible.

By the way, I guess I should also eradicate `sage -hgmerge` - I'll submit a patch (not to the Mercurial spkg but to Sage) in a bit.


---

Comment by jhpalmieri created at 2011-07-01 18:21:34

Okay, if you can patch the scripts repo to get rid of "sage -hgmerge", then I think this can get a positive review.


---

Comment by jhpalmieri created at 2011-08-03 22:20:50

Here's a patch to the scripts repo to remove the "sage -hgmerge" command.


---

Attachment

apply to scripts repo


---

Comment by kini created at 2011-09-11 08:48:15

Changing status from needs_review to positive_review.


---

Comment by kini created at 2011-09-11 08:48:15

Looks fine. All doctests pass (though I doubt `hgmerge` was doctested anyway...). Grepping for "hgmerge" doesn't find anything significant. Eradication successful! Positive review from me.


---

Comment by dimpase created at 2011-09-11 09:29:52

Replying to [comment:20 kini]:
> Looks fine. All doctests pass (though I doubt `hgmerge` was doctested anyway...). Grepping for "hgmerge" doesn't find anything significant. Eradication successful! Positive review from me.

would be good to state clearly in the ticket description  which patches should be applied, and which should not be applied.
I.e, is trac_11120-re-fix-trac_4434.mercurial-spkg.patch needed?


---

Comment by kini created at 2011-09-11 09:40:31

It is clearly stated in the ticket description is it not? Read the bottom. No, that patch is not needed.


---

Comment by leif created at 2011-09-13 10:59:44

Resolution: fixed


---

Comment by leif created at 2011-09-13 10:59:44

Changing component from packages to scripts.
