# Issue 31326: Upgrade giac to 1.7.0

Issue created by migration from https://trac.sagemath.org/ticket/31563

Original creator: mkoeppe

Original creation time: 2021-03-26 01:22:41

CC:  mjo fbissey arojas frederichan parisse tmonteil dimpase

https://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source/

Previous update: #30537


---

Comment by arojas created at 2021-03-26 08:34:09

FTR, this is straightforward and requires no changes to sagelib.


---

Comment by mjo created at 2021-04-02 13:35:55

I've updated the system version check in #31594 because it should be a trivial review.


---

Attachment


---

Comment by mkoeppe created at 2021-09-02 19:42:58

I have made a new tarball using `spkg-src`. Patches in `build/pkgs/giac/patches/` still need updating/review, help welcome
----
New commits:


---

Comment by mkoeppe created at 2021-09-03 19:03:03

These are the current patches:
https://github.com/sagemath/sage/tree/develop/build/pkgs/giac/patches
(I have already taken care of the ones in `autotools/`)


---

Comment by fbissey created at 2021-09-26 23:27:02

I just tested the latest giac (1.7.0.33) against sage 9.5.beta2. The only doctests failing are

```
sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/functions/min_max.py
too many failed tests, not using stored timings
Running doctests with ID 2021-09-27-12-21-06-b85d81e2.
Using --optional=dochtml,pip,sage
Doctesting 1 file.
sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/functions/min_max.py
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/functions/min_max.py", line 236, in sage.functions.min_max.MaxSymbolic._evalf_
Failed example:
    r
Expected:
    sqrt(2) - cos(1)
Got:
    0.873911256505000
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/functions/min_max.py", line 238, in sage.functions.min_max.MaxSymbolic._evalf_
Failed example:
    r.n()
Expected:
    0.873911256504955
Got:
    0.873911256505000
**********************************************************************
1 item had failures:
   2 of  11 in sage.functions.min_max.MaxSymbolic._evalf_
    [69 tests, 2 failures, 0.53 s]
```


I'll note that recent giac unconditionally look for usb connecting libraries. It seems to be related to giac being able to go in embedded devices as far as I can tell. No real impact on the maths but the functionality is not clearly or cleanly separated.


---

Comment by fbissey created at 2021-10-18 22:08:56

1.7.0.39 out. Did anyone notice that it was looking for `curl` before or is it recent?

```
dnl AC_CHECK_LIB(curl, main)
CONFIG_CURL="yes"
AC_ARG_ENABLE([curl],
	[AS_HELP_STRING([--enable-curl], [Use CURL [[default=yes]]])],
	[if test "$enableval" = "no"; then CONFIG_CURL="no"; fi], [])

if test "$CONFIG_CURL" = "yes"; then
	AC_CHECK_HEADER(curl/curl.h, [], [CONFIG_CURL="no"])
  fi
if test "$CONFIG_CURL" = "yes"; then
	AC_CHECK_LIB(curl, main, [], [CONFIG_CURL="no"])
  fi
AC_SUBST(CONFIG_CURL)
AC_SUBST(CURL_LIBS)
AM_CONDITIONAL(CONFIG_CURL, [test "$CONFIG_CURL" = "yes"])
```

It may have been there some time because it is an alternative to a code branch that can never be reached (pragma constant `EMCC` and `EMCC2` are never defined anywhere).


---

Comment by fbissey created at 2021-10-18 22:10:11

`curl` is in my dependency list in Gentoo, so I just didn't look properly the first _couple_ of times.


---

Comment by parisse created at 2021-10-19 13:01:30

curl is used for the read command, if the argument is a string beginning with http.
For example read("https://www-fourier.univ-grenoble-alpes.fr/~parisse/numworks/py.py")


---

Comment by fbissey created at 2021-10-19 20:29:11

Replying to [comment:14 parisse]:
> curl is used for the read command, if the argument is a string beginning with http.
> For example read("https://www-fourier.univ-grenoble-alpes.fr/~parisse/numworks/py.py")

That's certainly an interesting option. What about all that EMCC(2) code for emscript all around it that has no way of being enabled. Is it dead code or something in gestation?


---

Comment by fbissey created at 2021-10-19 21:04:18

Replying to [comment:10 fbissey]:
> I just tested the latest giac (1.7.0.33) against sage 9.5.beta2. The only doctests failing are
> {{{
> sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/functions/min_max.py
> too many failed tests, not using stored timings
> Running doctests with ID 2021-09-27-12-21-06-b85d81e2.
> Using --optional=dochtml,pip,sage
> Doctesting 1 file.
> sage -t --long --random-seed=0 /usr/lib/python3.9/site-packages/sage/functions/min_max.py
> **********************************************************************
> File "/usr/lib/python3.9/site-packages/sage/functions/min_max.py", line 236, in sage.functions.min_max.MaxSymbolic._evalf_
> Failed example:
>     r
> Expected:
>     sqrt(2) - cos(1)
> Got:
>     0.873911256505000
> **********************************************************************
> File "/usr/lib/python3.9/site-packages/sage/functions/min_max.py", line 238, in sage.functions.min_max.MaxSymbolic._evalf_
> Failed example:
>     r.n()
> Expected:
>     0.873911256504955
> Got:
>     0.873911256505000
> **********************************************************************
> 1 item had failures:
>    2 of  11 in sage.functions.min_max.MaxSymbolic._evalf_
>     [69 tests, 2 failures, 0.53 s]
> }}}

This is really bizarre. `min_max` uses sympy not giac - at least directly. The only thing I can think of, is that giac is used to perform the integral and the result is numerical instead of symbolic. See the context of the failing tests

```
            sage: f = max_symbolic(sin(x), cos(x))
            sage: r = integral(f, x, 0, 1)
            ...
            sage: r
            sqrt(2) - cos(1)
            sage: r.n()
            0.873911256504955
```



---

Comment by parisse created at 2021-10-20 06:09:19

Replying to [comment:15 fbissey]:
> Replying to [comment:14 parisse]:
> > curl is used for the read command, if the argument is a string beginning with http.
> > For example read("https://www-fourier.univ-grenoble-alpes.fr/~parisse/numworks/py.py")
> 
> That's certainly an interesting option. What about all that EMCC(2) code for emscript all around it that has no way of being enabled. Is it dead code or something in gestation?

It's not dead, it is enabled by commandline -D options, or by the compiler itself (emcc).
Try this [url=https://www-fourier.univ-grenoble-alpes.fr/%7eparisse/xcasen.html#exec&filename=%40session&python=1&radian=1&cas=0,0,read(%22https%3A%2F%2Fwww-fourier.univ-grenoble-alpes.fr%2F~parisse%2Fnumworks%2Fpy.py%22)&cas=0,200,go(f1)&cas=0,400,%3B&]session Xcas[/url]


---

Comment by tornaria created at 2021-11-25 23:16:09

The test failure above seems to be a regression in giac 1.7.0:

- giac 1.6.0 (as compiled by sage)

```
0>> int(max(sin(x),cos(x)), x, 0, 1)
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [abs(sin(x)-cos(x))]
Discontinuities at zeroes of sin(x)-cos(x) were not checked
sqrt(2)-cos(1)
// Time 0.11

```

- giac 1.7.0 (void linux)

```
0>> int(max(sin(x),cos(x)), x, 0, 1)
Piecewise definite integration: can only handle linear < or > condition
0.873911256505
// Time 0.01
```


Note that sympy_integrator is able to correctly evaluate this integral, but the order is maxima, then giac, then sympy.

```
sage: f = max_symbolic(sin(x), cos(x))
sage: sage.symbolic.integration.external.sympy_integrator(f, x, 0, 1)
sqrt(2) - cos(1)
```



---

Comment by arojas created at 2021-11-26 07:02:02

Replying to [comment:18 tornaria]:
> The test failure above seems to be a regression in giac 1.7.0:

Yes, more precisely it's a regression in 1.7.0-29. Since their forum is a gated community, it would be nice if someone with an account could report it.


---

Comment by parisse created at 2021-11-26 08:16:47

This is a consequence of the fact that certified definite integration is hard. For this example [Xcas session](https://www-fourier.univ-grenoble-alpes.fr/%7eparisse/xcasen.html#exec&filename=session&python=0&radian=1&xcas=0,0,f%3A%3Dint(max(sin(x)%2Ccos(x))%2C%20x)&xcas=0,200,f(x%3D1)-f(x%3D0)&xcas=0,400,limit(f%2Cx%2Cpi%2F4%2C-1)-f(x%3D0)&xcas=400,0,f(x%3D1)-limit(f%2Cx%2Cpi%2F4%2C1)&)
there is only one point of discontinuity and it can easily be found by solving sin(x)=cos(x) on x=0..1, but for a large interval (say x=0..10000) or for a more complicated equation it's not the case. In order to make sure that I do not return a false answer, I have decided to return an exact answer only if I'm certain I did not miss a discontinuity in the antiderivative. It's certainly possible to improve, but not easy...


---

Comment by tornaria created at 2021-11-26 14:16:13

OTOH, this still works on 1.7.0-39

```
0>> int((sin(x)+cos(x)+abs(cos(x)-sin(x)))/2, x, 0, 1)
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [abs(cos(x)-sin(x))]
Discontinuities at zeroes of cos(x)-sin(x) were not checked
sqrt(2)-cos(1)
// Time 0.14
```



---

Comment by tornaria created at 2021-11-26 14:20:24

Note that the warnings get through into sage

```
sage: integral((cos(x)+sin(x)+abs(cos(x)-sin(x)))/2, x, 0, 1)
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [abs(cos(sageVARx)-sin(sageVARx))]
Discontinuities at zeroes of cos(sageVARx)-sin(sageVARx) were not checked
sqrt(2) - cos(1)
```

Would it be possible to integrate max(A,B) with a similar warning?


---

Comment by tornaria created at 2021-11-26 14:28:55

BTW, did you notice that sage is reading giac output with less than 53-bit precision? We are getting 0.873911256505000 instead of 0.873911256504955, not because giac answer is incorrect but because its output is rounded to 0.873911256505 (which is correct rounding but less than 53-bit).

Is there a simple way to setup giac with more output precision so that sage gets the right answer correctly rounded?


---

Comment by parisse created at 2021-11-26 19:37:29

max is translated internally to piecewise, it does not use the formula with max, and the checks differ.
If you run Digits:=14, you will get 14 digits printed. You can not get 53 bits of mantissa without multiprecision floats in giac, because the generic type of giac stores double in 8 bytes, and 5 bits are used to store the type -> the mantissa is rounded to 0 with 48 bits precision.


---

Comment by tornaria created at 2021-12-13 17:20:45

Since there doesn't seem to be a fix available, I'm patching out the two failing doctests as follows:

```
--- a/src/sage/functions/min_max.py
+++ b/src/sage/functions/min_max.py
@@ -233,9 +233,9 @@ class MaxSymbolic(MinMax_base):
             sage: f = max_symbolic(sin(x), cos(x))
             sage: r = integral(f, x, 0, 1)
             ...
-            sage: r
+            sage: r             # not tested -- broken with giac 1.7.0
             sqrt(2) - cos(1)
-            sage: r.n()
+            sage: r.n()         # not tested -- broken with giac 1.7.0
             0.873911256504955
         """
         return max_symbolic(args)
```

I don't know if this is acceptable for including it in sagemath, but I can't downgrade giac and I rather skip this failing doctests. Is there a way to label a doctest as "expected fail" instead of "not tested" ?


---

Comment by mjo created at 2021-12-13 18:06:02

Ironically, I think this test was added to showcase the fact that, given a difficult integral, sage would iterate through its available backends until it got an answer it liked. It seems now that giac is evolving towards the status quo, and refusing to give a possibly-incorrect exact answer.

We should still test the fallback behavior somehow, but these integrals have given us headaches for decades. I think we should stop promising to integrate them exactly, i.e. change/delete the tests.


---

Comment by mkoeppe created at 2022-02-01 00:29:28

Changing priority from major to critical.


---

Attachment

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-02-01 07:39:31

Ran `spkg-src` for the latest upstream. Patches still need work (anyone?)


---

Comment by git created at 2022-02-01 07:54:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-01 07:55:12

OK, now all patches apply. Haven't checked anything else


---

Comment by mkoeppe created at 2022-02-01 07:58:40


```
[giac-1.7.0.47p0] quickjs.c:11282:9: error: implicit declaration of function 'fesetround' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
[giac-1.7.0.47p0]         fesetround(rounding_mode);
```



---

Comment by arojas created at 2022-02-01 08:06:49

Replying to [comment:34 mkoeppe]:
> {{{
> [giac-1.7.0.47p0] quickjs.c:11282:9: error: implicit declaration of function 'fesetround' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
> [giac-1.7.0.47p0]         fesetround(rounding_mode);
> }}}

Who is setting `-Werror`? It's not coming from upstream as far as I can see.


---

Comment by mkoeppe created at 2022-02-01 08:23:54

There's no `-Werror`. The full command line is `/bin/bash ../libtool  --tag=CC   --mode=compile gcc -DHAVE_CONFIG_H -I. -I..  -DIN_GIAC -I. -I.. -I. -I..     -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/local/include   -g -O2 -g -O2 -D_GNU_SOURCE -DQUICKJS -DCONFIG_BIGNUM -DCONFIG_VERSION=\"2020-11-08\" -c -o quickjs.lo quickjs.c`

and what's happening here is that the file `fenv.h` in the same directory shadows the system-provided header file


---

Comment by mkoeppe created at 2022-02-01 08:25:55


```
$ gcc -E -DHAVE_CONFIG_H -I. -I..  -DIN_GIAC -I. -I.. -I. -I..     -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/local/include   -g -O2 -g -O2 -D_GNU_SOURCE -DQUICKJS -DCONFIG_BIGNUM -DCONFIG_VERSION=\"2020-11-08\" -Wp,-v - < /dev/null
clang -cc1 version 13.0.0 (clang-1300.0.29.30) default target x86_64-apple-darwin20.6.0
ignoring nonexistent directory "/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/local/include"
ignoring nonexistent directory "/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/Library/Frameworks"
ignoring duplicate directory "."
ignoring duplicate directory ".."
ignoring duplicate directory "."
ignoring duplicate directory ".."
ignoring duplicate directory "/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/local/include"
ignoring duplicate directory "/usr/local/include"
#include "..." search starts here:
#include <...> search starts here:
 .
 ..
 /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/local/include
 /usr/local/opt/primesieve/include
 /usr/local/opt/bdw-gc/include
 /usr/local/opt/libpng/include
 /usr/local/opt/polymake/include
 /usr/local/opt/ntl/include
 /usr/local/opt/bzip2/include
 /usr/local/opt/readline/include
 /usr/local/include
 /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/include
 /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include
 /Library/Developer/CommandLineTools/usr/include
 /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/System/Library/Frameworks (framework directory)
End of search list.
# 1 "<stdin>"
# 1 "<built-in>" 1
# 1 "<built-in>" 3
# 368 "<built-in>" 3
# 1 "<command line>" 1
# 1 "<built-in>" 2
# 1 "<stdin>" 2
```



---

Comment by mkoeppe created at 2022-02-01 08:28:48

We may have discussed this before - do we need this quickjs stuff for Sage or should we use `configure --disable-quickjs`?


---

Comment by fbissey created at 2022-02-01 08:34:00

I am fairly sure we don't need it https://bellard.org/quickjs/. That being said, I missed a few versions, I don't remember a disable switch.


---

Comment by git created at 2022-02-01 08:44:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-01 08:46:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-02-01 08:46:08

OK, this builds here on macOS.


---

Comment by arojas created at 2022-02-01 08:57:09

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2022-02-01 08:57:09

The failure in comment:18 still needs to be addressed


---

Comment by mkoeppe created at 2022-02-01 08:59:58

Replying to [comment:44 arojas]:
> The failure in comment:18 still needs to be addressed

Does it affect also system installations of giac 1.7.x?


---

Comment by arojas created at 2022-02-01 09:04:44

Replying to [comment:46 mkoeppe]:
> Replying to [comment:44 arojas]:
> > The failure in comment:18 still needs to be addressed
> 
> Does it affect also system installations of giac 1.7.x?

Yes, it's a (intentional) regression in giac itself, see comment:20


---

Comment by arojas created at 2022-02-01 12:00:37

Changing status from needs_work to needs_review.


---

Comment by arojas created at 2022-02-01 12:00:37

Replying to [comment:44 arojas]:
> The failure in comment:18 still needs to be addressed

It's done in #33226 apparently


---

Comment by mjo created at 2022-02-01 13:29:02

Replying to [comment:49 arojas]:
> Replying to [comment:44 arojas]:
> > The failure in comment:18 still needs to be addressed
> 
> It's done in #33226 apparently

I don't know why we were testing that result anyway. It's in the docstring of an `_evalf_` method. What we really want is the numerical answer.


---

Comment by mkoeppe created at 2022-02-02 06:19:15

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-02 06:19:15

Fails on Cygwin - https://github.com/mkoeppe/sage/runs/5031119487?check_suite_focus=true


---

Comment by mkoeppe created at 2022-02-02 06:22:43


```
/usr/bin/bash ../libtool  --tag=CXX   --mode=link g++ -std=gnu++11  -g -O2 -g -O2 -fno-strict-aliasing -DGIAC_GENERIC_CONSTANTS -DTIMEOUT -no-undefined -L/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib -Wl,-rpath,/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib -L/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib -Wl,-rpath,/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib  -o libgiac.la -rpath /opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib input_lexer.lo sym2poly.lo gausspol.lo threaded.lo moyal.lo maple.lo ti89.lo mathml.lo misc.lo permu.lo quater.lo desolve.lo input_parser.lo symbolic.lo index.lo modpoly.lo modfactor.lo ezgcd.lo derive.lo solve.lo intg.lo intgab.lo risch.lo lin.lo series.lo subst.lo vecteur.lo sparse.lo csturm.lo tex.lo global.lo ifactor.lo alg_ext.lo gauss.lo isom.lo plot.lo plot3d.lo rpn.lo prog.lo pari.lo cocoa.lo unary.lo usual.lo identificateur.lo gen.lo tinymt32.lo first.lo TmpLESystemSolver.lo TmpFGLM.lo help.lo lpsolve.lo optimization.lo signalprocessing.lo graphe.lo graphtheory.lo nautywrapper.lo markup.lo kdisplay.lo kadd.lo caseval.lo cutils.lo graphic.lo libbf.lo libregexp.lo libunicode.lo qjsgiac.lo quickjs.lo quickjs-libc.lo js.lo -lntl  -lpari -lgsl -lopenblas -lm  -lopenblas  -lopenblas  -lrt -lpthread -lcurl -lglpk -ldl -lm -lmpfi -lmpfr -lgmp 
libtool: link: g++ -std=gnu++11 -shared -nostdlib /usr/lib/gcc/x86_64-pc-cygwin/11/crtbeginS.o  .libs/input_lexer.o .libs/sym2poly.o .libs/gausspol.o .libs/threaded.o .libs/moyal.o .libs/maple.o .libs/ti89.o .libs/mathml.o .libs/misc.o .libs/permu.o .libs/quater.o .libs/desolve.o .libs/input_parser.o .libs/symbolic.o .libs/index.o .libs/modpoly.o .libs/modfactor.o .libs/ezgcd.o .libs/derive.o .libs/solve.o .libs/intg.o .libs/intgab.o .libs/risch.o .libs/lin.o .libs/series.o .libs/subst.o .libs/vecteur.o .libs/sparse.o .libs/csturm.o .libs/tex.o .libs/global.o .libs/ifactor.o .libs/alg_ext.o .libs/gauss.o .libs/isom.o .libs/plot.o .libs/plot3d.o .libs/rpn.o .libs/prog.o .libs/pari.o .libs/cocoa.o .libs/unary.o .libs/usual.o .libs/identificateur.o .libs/gen.o .libs/tinymt32.o .libs/first.o .libs/TmpLESystemSolver.o .libs/TmpFGLM.o .libs/help.o .libs/lpsolve.o .libs/optimization.o .libs/signalprocessing.o .libs/graphe.o .libs/graphtheory.o .libs/nautywrapper.o .libs/markup.o .libs/kdisplay.o .libs/kadd.o .libs/caseval.o .libs/cutils.o .libs/graphic.o .libs/libbf.o .libs/libregexp.o .libs/libunicode.o .libs/qjsgiac.o .libs/quickjs.o .libs/quickjs-libc.o .libs/js.o   -L/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib -lntl -lpari -lgsl -lopenblas -lrt -lpthread -lcurl -lglpk -ldl -lmpfi -lmpfr -lgmp -L/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib/../lib -L/usr/lib/gcc/x86_64-pc-cygwin/11 -L/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/lib/../lib -L/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../lib -L/lib/../lib -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/lib -L/usr/lib/gcc/x86_64-pc-cygwin/11/../../.. -lstdc++ -lgcc_s -lgcc -lcygwin -ladvapi32 -lshell32 -luser32 -lkernel32 -lgcc_s -lgcc /usr/lib/gcc/x86_64-pc-cygwin/11/crtend.o  -g -O2 -g -O2 -Wl,-rpath -Wl,/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib -Wl,-rpath -Wl,/opt/sage-628803ef0f0817c0876342b66da54660ce208124/lib   -o .libs/cyggiac-0.dll -Wl,--enable-auto-image-base -Xlinker --out-implib -Xlinker .libs/libgiac.dll.a
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:215: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:236: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:2163: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o: in function `giac::r2sym(giac::gen const&, giac::index_m const&, giac::dbgprint_vector<giac::gen> const&, giac::context const*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:2009: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:194: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/sym2poly.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/sym2poly.cc:199: more undefined references to `libintl_gettext' follow
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o: in function `giac::init_geogebra(bool, giac::context const*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/global.cc:6823: undefined reference to `libintl_setlocale'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o: in function `giac::gen::gen(void*, short)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.h:597: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o: in function `giac::thread_eval(giac::gen const&, int, giac::context*, void (*)(giac::context*))':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/global.cc:5620: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: /opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/global.cc:5642: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o: in function `giac::gen::gen(void*, short)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.h:597: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o: in function `giac::check_thread(giac::context*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/global.cc:5534: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/global.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/global.cc:5550: more undefined references to `libintl_gettext' follow
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o: in function `giac::chartab2gen(char*, giac::context const*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:12084: undefined reference to `libintl_setlocale'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: /opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:12085: undefined reference to `libintl_setlocale'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: /opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:12087: undefined reference to `libintl_setlocale'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o: in function `giac::irem(giac::gen const&, giac::gen const&, giac::gen&)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:11245: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o: in function `giac::operator_plus(giac::gen const&, giac::gen const&, unsigned int, giac::context const*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:4727: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:4579: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:4479: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o: in function `giac::operator_plus(giac::gen const&, giac::gen const&, unsigned int, giac::context const*)':
/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:4761: undefined reference to `libintl_gettext'
/usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: .libs/gen.o:/opt/sage-628803ef0f0817c0876342b66da54660ce208124/var/tmp/sage/build/giac-1.7.0.47p0/src/src/gen.cc:4707: more undefined references to `libintl_gettext' follow
collect2: error: ld returned 1 exit status
```



---

Comment by mkoeppe created at 2022-02-02 17:54:20

`@`parisse Is there a public repository for giac? The link to the geogebra SVN in https://www-fourier.ujf-grenoble.fr/~parisse/giac_compile.html is broken.


---

Comment by slelievre created at 2022-02-02 19:23:31

https://dev.geogebra.org/svn/trunk/geogebra/giac/src/giac/


---

Comment by mkoeppe created at 2022-02-02 20:04:00

This repo does not seem to have all of giac, in particular the autotools build system (configure.ac, ...)


---

Comment by slelievre created at 2022-02-04 12:02:17

GeoGebra moved to Git:

- https://github.com/geogebra/giac/


---

Comment by git created at 2022-04-16 18:46:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-16 22:50:25

The branch `upstream` of https://salsa.debian.org/science-team/giac tracks the upstream releases nicely


---

Comment by git created at 2022-04-16 22:53:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-16 23:23:04

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-04-16 23:23:04

Running the cygwin tests at https://github.com/sagemath/sagetrac-mirror/actions/runs/2178226151


---

Comment by mkoeppe created at 2022-04-17 08:15:15

Still getting the same linker errors on cygwin: https://github.com/sagemath/sagetrac-mirror/runs/6051870023?check_suite_focus=true


---

Comment by mkoeppe created at 2022-04-17 17:24:55

Changing status from needs_review to needs_work.


---

Comment by @nasser1 created at 2022-06-25 07:51:16

What is the status of this? Latest 9.7 beta still does not have latest giac 1.9 in it. Will the final 9.7 sagemath release have giac 1.9 included?


---

Comment by fbissey created at 2022-06-28 21:41:16

And of course 1.9.0-11 came out just after I updated the description to 1.9.0-7. Testing in sage-on-gentoo shortly.


---

Comment by fbissey created at 2022-06-29 00:30:12

Doctest failure with 1.9.0-11

```
sage -t --long --random-seed=207046070893293649350070796495889591871 /usr/lib/python3.10/site-packages/sage/libs/giac/giac.pyx
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/libs/giac/giac.pyx", line 415, in sage.libs.giac.giac._giac
Failed example:
    libgiac.fMax(f,'x=-0..pi').simplify()
Expected:
    pi/4,3*pi/4
Got:
    0,pi/2,pi
**********************************************************************
```

this is a fairly weird result. Either a bug has been introduced in giac or the meaning of something changed.


---

Comment by fbissey created at 2022-06-29 00:45:21

The section tested is

```
        sage: x = libgiac('x')
        sage: f = 1/(5+cos(4*x))
        sage: oldrep = 1/2/(2*sqrt(6))*(atan(2*tan(4*x/2)/sqrt(6))+pi*floor(4*x/2/pi+1/2))
        sage: newrep = 1/2/(2*sqrt(6))*(atan((-sqrt(6)*sin(4*x)+2*sin(4*x))/(sqrt(6)*cos(4*x)+sqrt(6)-2*cos(4*x)+2))+4*x/2)
        sage: ((f.int(x) - newrep)*(f.int(x)-oldrep)).normal()
        0
        sage: libgiac.fMax(f,'x=-0..pi').simplify()
        pi/4,3*pi/4
        sage: libgiac.fMax.help()  # doctest: +SKIP
        "Returns the abscissa of the maximum of the expression.
```

and I plotted `f`. The previous answer are the correct maxima over the interval, the new answer are actually the minima.

I'll also note

```
sage: libgiac.fMax.help()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Input In [6], in <cell line: 1>()
----> 1 libgiac.fMax.help()

TypeError: 'str' object is not callable
sage: libgiac.fMax.help
'"Description: Returns the abscissa of the maximum of the expression.\nRelated: fMin\nExamples:\nfMax(-x^2+2*x+1,x);fMax(-x^2+2*x+1,x=1..2)"'
```

So the skipped doctest is not written correctly in the first place which mean documentation is showing something incorrect.


---

Comment by @nasser1 created at 2022-06-29 02:40:26

How do you if you are running 1.9-05 or 1.9-11? The version number just says 1.9.

This giac is so confusing. I go to https://www-fourier.ujf-grenoble.fr/~parisse/giac.html and it says at the top 1.9.0-11 but when I click to download the source from https://www-fourier.ujf-grenoble.fr/~parisse/giac/giac_stable.tgz  which is the link on same page, it says giac_stable.tgz. I downloaded now and build the source, but when I say



```
>which giac
/usr/local/bin/giac
>giac --version
// Using locale /usr/local/share/locale/
// C.UTF-8
// /usr/local/share/locale/
// giac
// UTF-8
// Maximum number of parallel threads 24
// (c) 2001, 2021 B. Parisse & others
1.9.0
>

```


So I have no idea now if I am using 1.9-05 or 1.9-11

How do you know that sagemath is using the correct version 1.9-11 then? Do you have another way to check?

Strange that giac has no  github website so one know what they version are downloading for sure.


---

Comment by fbissey created at 2022-06-29 02:44:20

I (and all other giac packagers that I know) am downloading from here http://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source/


---

Comment by @nasser1 created at 2022-06-29 02:49:58

Ok, thanks for this link. This is the not the same at the website https://www-fourier.ujf-grenoble.fr/~parisse/giac.html  there (near the top) which is only one I knew about. 

Is the link you show known because it shows on some web page? I looked at all the pages such as  https://www-fourier.ujf-grenoble.fr/~parisse/install_en#new  and could not find another link to the current sources.

But I will use the one you showed now and rebuild again.

Thanks


---

Comment by fbissey created at 2022-06-29 04:13:35

Replying to [comment:76 gh-nasser1]:
> Is the link you show known because it shows on some web page? I looked at all the pages such as  https://www-fourier.ujf-grenoble.fr/~parisse/install_en#new  and could not find another link to the current sources.

It is findable from that web page, but it is not obvious and includes a hop to another page first. Under the heading "Developers" click on "C++ source" which lead to the following page
https://www-fourier.ujf-grenoble.fr/~parisse/giac_compile.html and under "Compiling Giac from source" the entry "stable source" has two links. The first one to `giac_stable.tgz` and the other one to the page I quoted with the archive of all source tarballs.

So, it is there but requires a bit of digging.


---

Comment by git created at 2022-06-30 22:38:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @nasser1 created at 2022-07-04 06:25:34

Fyi, 

on https://www-fourier.ujf-grenoble.fr/~parisse/debian/dists/stable/main/source/   there is now 	giac_1.9.0-13.tar.gz


---

Comment by fbissey created at 2022-07-05 00:37:48

Thanks for the heads up on the version bump. The issue in `libs/giac/giac.pyx` is still present with that version.


---

Comment by frederichan created at 2022-07-05 05:39:53

I am reporting this in giac's forum:
https://xcas.univ-grenoble-alpes.fr/forum/viewtopic.php?f=3&t=2788


---

Comment by @sheerluck created at 2022-07-09 06:34:09

Replying to [comment:81 frederichan]:
> I am reporting this in giac's forum:
> https://xcas.univ-grenoble-alpes.fr/forum/viewtopic.php?f=3&t=2788
I applied that patch to 1.9.0.13 and `libgiac.fMax(f,'x=-0..pi').simplify()` is `pi/4,3*pi/4` again


---

Comment by fbissey created at 2022-07-09 07:25:03

Hopefully it got in 1.9.0-15 released a couple of days ago while that commit is from 4 days ago. Let's test this.


---

Comment by fbissey created at 2022-07-09 07:41:07

Yes, 1.9.0-15 seems to include the fix. The doctest passes now.


---

Comment by git created at 2022-07-09 08:08:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-09 08:20:07

The tarball has grown, it now contains some large files (*.js, *.wasm) - do we need them?


---

Comment by fbissey created at 2022-07-09 08:20:55

No.


---

Comment by git created at 2022-07-09 08:34:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-09 08:46:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-09 08:47:21

on macOS: 

```
[giac-1.9.0.15p0] /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/sys/cdefs.h:208:48: note: expanded from macro '__deprecated_msg'
[giac-1.9.0.15p0]         #define __deprecated_msg(_msg) __attribute__((__deprecated__(_msg)))
[giac-1.9.0.15p0]                                                       ^
[giac-1.9.0.15p0] icas.cc:1435:9: error: no member named 'localisation' in namespace 'xcas'
[giac-1.9.0.15p0]   xcas::localisation(); // change by L. Marohnić
[giac-1.9.0.15p0]   ~~~~~~^
```



---

Attachment

Same error with `tox -e docker-ubuntu-jammy-standard -- giac`


---

Comment by @nasser1 created at 2022-07-09 09:06:56

Replying to [comment:91 mkoeppe]:
> on macOS: 
> {{{
> [giac-1.9.0.15p0] /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/sys/cdefs.h:208:48: note: expanded from macro '__deprecated_msg'
> [giac-1.9.0.15p0]         #define __deprecated_msg(_msg) __attribute__((__deprecated__(_msg)))
> [giac-1.9.0.15p0]                                                       ^
> [giac-1.9.0.15p0] icas.cc:1435:9: error: no member named 'localisation' in namespace 'xcas'
> [giac-1.9.0.15p0]   xcas::localisation(); // change by L. Marohnić
> [giac-1.9.0.15p0]   ~~~~~~^
> }}}


FYI
I've reported this error xcas::localisation(); few days ago to giac forum. Here is the link


https://xcas.univ-grenoble-alpes.fr/forum/viewtopic.php?f=3&t=2789

--Nasser


---

Comment by fbissey created at 2022-07-09 09:07:39

I didn't spot that one before because I always build with fltk support. And that part is in a "#else` block when fltk is not requested. Blocks with `xcas::localisation` have very funny guards

```
#ifndef USE_OBJET_BIDON
xcas::localisation(); // change by L. Marohnić
#endif
```

literally "use fake object". Passing `-DUSE_OBJET_BIDON` may help.


---

Comment by fbissey created at 2022-07-09 09:22:06

Yes, I compiled it without fltk by adding `-DUSE_OBJET_BIDON=1` to `CPPFLAGS`. Be careful "OBJET" without a "C", this is french and google translate will tell you that "bidon" is a "can", but colloquially it means "something that isn't what it seems", the can may look big but inside it is just empty.


---

Comment by git created at 2022-07-09 16:52:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-09 16:53:25

Thanks both, this builds now


---

Comment by mkoeppe created at 2022-07-09 16:53:37

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-07-09 16:55:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-11 04:01:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-11 15:54:13

Still fails on cygwin with same error as shown in comment:55 - https://github.com/mkoeppe/sage/runs/7274399777?check_suite_focus=true


---

Comment by mkoeppe created at 2022-07-11 21:00:41

The other platforms looks OK.
I'd suggest that we ignore Cygwin for now and merge the ticket.


---

Comment by fbissey created at 2022-07-11 21:05:37

Cygwin is low on my own priority list but it feels a bit of a shame. If giac 1.7 builds on cygwin this is clearly a regression, but while we upgrade the package here, there is nothing that prevent the use of 1.7 or specifically require 1.9, so if someone wants to build on cygwin, they can bring their own giac 1.7.


---

Comment by mkoeppe created at 2022-07-11 21:08:51

I think it will be easy to fix the Cygwin build failure in a follow up ticket. Best done in one go together with other current failures of the platform.


---

Comment by fbissey created at 2022-07-11 21:11:01

I am OK with that plan. I am OK being a positive reviewer for this.


---

Comment by mkoeppe created at 2022-07-11 23:38:34

Thanks!


---

Comment by fbissey created at 2022-07-12 00:38:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-21 21:12:21

Resolution: fixed


---

Comment by mkoeppe created at 2022-08-03 16:58:49

Replying to [comment:106 mkoeppe]:
> I think it will be easy to fix the Cygwin build failure in a follow up ticket. Best done in one go together with other current failures of the platform. 

This is now #34269.
