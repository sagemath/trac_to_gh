# Issue 30166: Docker build is broken

Issue created by migration from https://trac.sagemath.org/ticket/30403

Original creator: saraedum

Original creation time: 2020-08-20 10:56:16

CC:  embray @tobiasdiez dimpase slelievre

Since 9.2.beta4 the docker build is failing:

```
[zlib-1.2.11.p0] Setting up build directory for zlib-1.2.11.p0
[zlib-1.2.11.p0] Finished extraction
[zlib-1.2.11.p0] Applying patches from ../patches...
[zlib-1.2.11.p0] Applying ../patches/cygwin-gzopen_w.patch
[zlib-1.2.11.p0] patching file gzguts.h
[zlib-1.2.11.p0] patching file win32/zlib.def
[zlib-1.2.11.p0] Hunk #1 FAILED at 91 (different line endings).
[zlib-1.2.11.p0] 1 out of 1 hunk FAILED -- saving rejects to file win32/zlib.def.rej
[zlib-1.2.11.p0] Error applying '../patches/cygwin-gzopen_w.patch'
```


See https://gitlab.com/sagemath/sage/-/pipelines for details. To see full logs, click on a build step; on the next page, browse the build artifacts on the right to see full output.


---

Comment by saraedum created at 2020-08-20 10:57:31

Changing keywords from "" to "gitlab, docker".


---

Comment by mkoeppe created at 2020-08-31 06:14:33

The patch has a mixture of LF and CRLF lineendings, to patch the file `win32/zlib.def.rej`, which has CRLF lineendings.

`.gitattributes` was added in #29733 and may have caused something to break here.


---

Comment by vbraun created at 2020-09-08 07:48:38

Changing priority from blocker to critical.


---

Comment by vbraun created at 2020-09-08 07:48:38

Surely thats a problem with how the docker image is built?


---

Comment by saraedum created at 2020-09-08 11:46:37

I think it means that you cannot build from a fresh git clone if you do not have zlib installed.


---

Comment by saraedum created at 2020-09-08 11:47:41

vbraun: What's the meaning of "blocker"? Us not being able to ship for one of the platforms sounds like a blocker to me.


---

Comment by mkoeppe created at 2020-09-08 17:46:59

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2020-09-08 17:46:59

I think it's a blocker because a standard package is broken on a supported platform


---

Comment by dimpase created at 2020-09-08 21:13:51

why is that a problem to fix this? I'll post a branch with uniform endings


---

Comment by dimpase created at 2020-09-08 21:26:14

it's actually "fun". The patch touches 2 files, one is OK, the other is with Windows (CRLF) line endings, and git version 2.20.1 on Linux produces a diff with mixed line endings!!!

```
$ git diff win32/zlib.def >/tmp/p2
dimpase@penguin:~/sage/upstream/zlib-1.2.11$ file /tmp/p2
/tmp/p2: unified diff output, ASCII text, with CRLF, LF line terminators
```

a bug in git? or maybe there is an option to use here...


---

Comment by mkoeppe created at 2020-09-08 21:40:14

I think something like `-text` to .gitattributes for this file could help


---

Comment by dimpase created at 2020-09-08 22:07:19

the problem is that applying a patch is a problem, nothing to do with git.
(unless I add `--binary` option)

```
$ cat /tmp/pp
diff --git a/win32/zlib.def b/win32/zlib.def
index 784b138..b69fa3e 100644
--- a/win32/zlib.def
+++ b/win32/zlib.def
@@ -91,4 +91,3 @@ EXPORTS
     inflateCodesUsed
     inflateResetKeep
     deflateResetKeep
-    gzopen_w
$ file /tmp/pp
/tmp/pp: unified diff output, ASCII text, with CRLF line terminators
$ patch --dry-run -p1 --posix </tmp/pp
(Stripping trailing CRs from patch; use --binary to disable.)
checking file win32/zlib.def
Hunk #1 FAILED at 91 (different line endings).
1 out of 1 hunk FAILED
$ patch --dry-run -p1 --posix --binary </tmp/pp # this works
checking file win32/zlib.def
$ dos2unix /tmp/pp
dos2unix: converting file /tmp/pp to Unix format...
dimpase@penguin:~/sage/upstream/zlib-1.2.11$ patch --dry-run -p1 --posix  </tmp/pp
checking file win32/zlib.def
Hunk #1 FAILED at 91 (different line endings).
1 out of 1 hunk FAILED
```



---

Comment by dimpase created at 2020-09-08 22:22:05

New commits:


---

Comment by dimpase created at 2020-09-08 22:26:06

This didn't work as needed, as `cygwin-windef.diff` got different line endings as I was checking it into the git repo... Arrgh...


---

Comment by git created at 2020-09-08 22:50:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-09-08 22:52:53

hmm, no, while locally the endings are OK, pulling from the repo mixes them up :-(


---

Comment by dimpase created at 2020-09-08 23:23:26

I will try to declare that diff file as binary in .gitattributes


---

Comment by git created at 2020-09-09 06:24:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-09 06:39:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-09-09 06:40:08

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-09-09 06:40:08

OK, try this please (only tested on Linux)


---

Comment by vbraun created at 2020-09-09 07:22:38

When applying patches with `--ignore-whitespace` this should work automatically, but only if the diff has LF endings (patch is biased towards unix endings)


---

Comment by dimpase created at 2020-09-09 21:40:54

if this is so them I suppose we can just add this option to the patch call in
`build/bin/sage-apply-patches` and done with?


---

Comment by dimpase created at 2020-09-09 22:34:01

Replying to [comment:22 vbraun]:
> When applying patches with `--ignore-whitespace` this should work automatically, but only if the diff has LF endings (patch is biased towards unix endings)

no, it does not work - on Debian 10 with its patch I get `different line endings` error.
So the current solution is more or less the only way.

I suppose we might not want to apply all our patches with `--binary`. 

But we can also modify `build/bin/sage-apply-patches` to deal with binary patches (say, files with a particular suffix) by treating them as patches that must be applied with `--binary`.


---

Comment by vbraun created at 2020-09-09 23:01:16

Did you convert the patch to LF endings only? because right now its mixed, and `--ignore-whitespace` only works with pure LF endings:

```
$ file build/pkgs/zlib/patches/cygwin-gzopen_w.patch
build/pkgs/zlib/patches/cygwin-gzopen_w.patch: unified diff output, ASCII text, with CRLF, LF line terminators
```



---

Comment by dimpase created at 2020-09-10 08:15:38

Replying to [comment:25 vbraun]:
> Did you convert the patch to LF endings only? because right now its mixed, and `--ignore-whitespace` only works with pure LF endings:

certainly, I tried it on the converted to the LF-endings patch `build/pkgs/zlib/patches/cygwin-windef.diff_bin` in the branch.

It's seriosly platform-dependent. As you might know, e.g. on macOS the original patch just works.
I won't be surprised if it works on some Linuxes, too.


---

Comment by dimpase created at 2020-09-10 08:46:00

Perhaps you are confused by `--ignore-whitespace` option of `git apply`, which indeed allows to ignore different EOLs. This is not the case with `patch`.


---

Comment by mkoeppe created at 2020-09-10 16:55:25

I guess someone should push this to gitlab or something to trigger the Docker build?


---

Comment by saraedum created at 2020-09-12 10:51:01

Since our runner has been down for ten days nothing gets built on [GitLab](GitLab) anymore currently: https://zulip.sagemath.org/#narrow/stream/117-docker/topic/GitLab.20runners.20are.20gone

Otherwise, it would  have been that one already https://gitlab.com/sagemath/dev/trac/-/jobs/728299492


---

Comment by mkoeppe created at 2020-09-12 16:48:56

Tested at https://github.com/mkoeppe/sage/actions/runs/250810929 that this change does not break any of our platforms


---

Comment by mkoeppe created at 2020-09-12 16:48:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-15 21:58:23

Resolution: fixed
