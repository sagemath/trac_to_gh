# Issue 30278: implement string formatting for elements in RR and CC

Issue created by migration from https://trac.sagemath.org/ticket/30515

Original creator: @mwageringel

Original creation time: 2020-09-06 12:09:20

CC:  slelievre @jcamp0x2a

Following #29514 (see also #27788 and #29212), this ticket implements `__format__` for real and complex numbers.

```
sage: '{:.4f}'.format(1.2)
'1.2000'
sage: '{:.4f}'.format(CC(1.2, 0))
'1.2000 + 0.0000*I'
```


The complex case is implemented by reusing the code from `CDF`.

The real case is implemented by delegating to Python's arbitrary precision `Decimal` numbers. This works quite well, but has the caveat that the output is not completely the same as for the `repr` of real numbers. Compare for example:


```
sage: from decimal import Decimal
sage: '{!r} {!s}'.format(RR(oo), Decimal(float(oo)))
'+infinity Infinity'
sage: '{!r} {!s}'.format(RR(-oo), Decimal(float(-oo)))
'-infinity -Infinity'
sage: '{!r} {!s}'.format(RR(0), Decimal(str(RR(0))))
'0.00000000000000 0E-15'
sage: '{!r} {:.10}'.format(RR(1e10), Decimal(float(1e10)))
'1.00000000000000e10 1.000000000E+10'
```


It looks like this can only be avoided by a custom implementation of the [format specification](https://docs.python.org/3/library/string.html#formatspec), rather than delegating to `Decimal`, which is quite a complex task.


---

Comment by @mwageringel created at 2020-09-06 12:12:30

Replying to [ticket:30515 gh-mwageringel]:
> It looks like this can only be avoided by a custom implementation of the [format specification](https://docs.python.org/3/library/string.html#formatspec), rather than delegating to `Decimal`, which is quite a complex task.

As those differences are small, I would suggest to leave that for a follow-up ticket and merge this ticket as is.
----
New commits:


---

Comment by @mwageringel created at 2020-09-06 12:12:30

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-09-06 12:12:30

Changing keywords from "" to "format".


---

Comment by dimpase created at 2020-09-08 11:22:36

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-09-08 11:22:36

lgtm


---

Comment by @mwageringel created at 2020-09-08 17:09:15

Thanks.


---

Comment by vbraun created at 2020-09-23 21:27:23

Resolution: fixed


---

Comment by arojas created at 2020-10-01 13:45:38

I'm getting two test failures on my distro package, using system python 3.8.5

```
sage -t --long --random-seed=0 /usr/lib/python3.8/site-packages/sage/rings/complex_number.pyx
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/rings/complex_number.pyx", line 574, in sage.rings.complex_number.ComplexNumber.__format__
Failed example:
    format(CC(3, 0), '#.4g')
Expected:
    Traceback (most recent call last):
    ...
    ValueError: invalid format string
Got:
    '3.000 + 0.e-15*I'
**********************************************************************
File "/usr/lib/python3.8/site-packages/sage/rings/complex_number.pyx", line 578, in sage.rings.complex_number.ComplexNumber.__format__
Failed example:
    format(CC(0, 0), '+#.4')
Expected:
    Traceback (most recent call last):
    ...
    ValueError: invalid format string
Got:
    '+0.E-15'
**********************************************************************
```



---

Comment by @mwageringel created at 2020-10-01 18:28:26

#30689 should fix this. It is nice to see that the format specification seems to be more fully implemented in your Python version. On my end, I cannot reproduce it with 3.8.5 though.
