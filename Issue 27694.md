# Issue 27694: fix LazyPowerSeriesRing in other variable than x

archive/issues_027694.json:
```json
{
    "body": "\n```\nsage: LazyPowerSeriesRing(QQ, 'z').gen()\n```\n\ngives an error.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27931\n\n",
    "created_at": "2019-06-04T15:56:43Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "title": "fix LazyPowerSeriesRing in other variable than x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27694",
    "user": "dkrenn"
}
```

```
sage: LazyPowerSeriesRing(QQ, 'z').gen()
```

gives an error.

Issue created by migration from https://trac.sagemath.org/ticket/27931





---

archive/issue_comments_390964.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-04T16:02:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390964",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_390965.json:
```json
{
    "body": "Did also some small cleanup.",
    "created_at": "2019-06-04T16:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390965",
    "user": "dkrenn"
}
```

Did also some small cleanup.



---

archive/issue_comments_390966.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-04T16:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390966",
    "user": "dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_390967.json:
```json
{
    "body": "I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.\n\nSo there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow. While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.",
    "created_at": "2019-06-04T23:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390967",
    "user": "tscrim"
}
```

I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.

So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow. While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.



---

archive/issue_comments_390968.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n> I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.\n\nYes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)\n \n> So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.\n\nReally?....my feeling was that storing zero in each element seems somehow a waste.\n\nWhat if we store it in the parent and call it by `self._parent._zero_base_ring` or so?\n\n While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.\n\nGetting this zero should clearly be done via the parent as it is not something that depends on the particular element.",
    "created_at": "2019-06-05T00:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390968",
    "user": "dkrenn"
}
```

Replying to [comment:4 tscrim]:
> I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.

Yes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)
 
> So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.

Really?....my feeling was that storing zero in each element seems somehow a waste.

What if we store it in the parent and call it by `self._parent._zero_base_ring` or so?

 While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.

Getting this zero should clearly be done via the parent as it is not something that depends on the particular element.



---

archive/issue_comments_390969.json:
```json
{
    "body": "Replying to [comment:5 dkrenn]:\n> Replying to [comment:4 tscrim]:\n> > I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.\n> \n> Yes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)\n\nI see the problem: It is using the old-style parent still. This is something that should be fixed, but that would be much more invasive than should be on this ticket.\n\n> > So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.\n> \n> Really?....my feeling was that storing zero in each element seems somehow a waste.\n> \n> What if we store it in the parent and call it by `self._parent._zero_base_ring` or so?\n> \n>  While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.\n> \n> Getting this zero should clearly be done via the parent as it is not something that depends on the particular element.\n\nThis is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of \"real-world\" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.",
    "created_at": "2019-06-05T01:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390969",
    "user": "tscrim"
}
```

Replying to [comment:5 dkrenn]:
> Replying to [comment:4 tscrim]:
> > I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.
> 
> Yes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)

I see the problem: It is using the old-style parent still. This is something that should be fixed, but that would be much more invasive than should be on this ticket.

> > So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.
> 
> Really?....my feeling was that storing zero in each element seems somehow a waste.
> 
> What if we store it in the parent and call it by `self._parent._zero_base_ring` or so?
> 
>  While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.
> 
> Getting this zero should clearly be done via the parent as it is not something that depends on the particular element.

This is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of "real-world" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.



---

archive/issue_comments_390970.json:
```json
{
    "body": "Replying to [comment:6 tscrim]:\n> This is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of \"real-world\" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.\n\nSo somehow I am not very successful today... In \nhttps://git.sagemath.org/sage.git/commit/?h=57ae6a712e9929247f8bcd2e420b66fba5e83404\nI get\n\n```\nAttributeError: type object 'LazyPowerSeriesRing_with_category' has no attribute '_zero_base_ring'\n```\n\nand don't see why. (I got a problem when using `_parent`, but I though it might was because of Cythonizing. But now I get it for this argument as well.)\nProbably I just overlook something. I also consider simply reverting the zero change and get this ticket done...",
    "created_at": "2019-06-05T01:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390970",
    "user": "dkrenn"
}
```

Replying to [comment:6 tscrim]:
> This is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of "real-world" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.

So somehow I am not very successful today... In 
https://git.sagemath.org/sage.git/commit/?h=57ae6a712e9929247f8bcd2e420b66fba5e83404
I get

```
AttributeError: type object 'LazyPowerSeriesRing_with_category' has no attribute '_zero_base_ring'
```

and don't see why. (I got a problem when using `_parent`, but I though it might was because of Cythonizing. But now I get it for this argument as well.)
Probably I just overlook something. I also consider simply reverting the zero change and get this ticket done...



---

archive/issue_comments_390971.json:
```json
{
    "body": "Because `zero` is a method of the parent:\n\n```diff\n@@ -268,7 +269,7 @@ class LazyPowerSeriesRing(Algebra):\n             sage: L.zero()\n             0\n         \"\"\"\n-        return self.term(self.base_ring().zero(), 0)\n+        return self.term(self.parent()._zero_base_ring, 0)\n \n     def identity_element(self):\n         \"\"\"\n```\n\nSo change this to `return self.term(self._zero_base_ring, 0)`.",
    "created_at": "2019-06-05T02:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390971",
    "user": "tscrim"
}
```

Because `zero` is a method of the parent:

```diff
@@ -268,7 +269,7 @@ class LazyPowerSeriesRing(Algebra):
             sage: L.zero()
             0
         """
-        return self.term(self.base_ring().zero(), 0)
+        return self.term(self.parent()._zero_base_ring, 0)
 
     def identity_element(self):
         """
```

So change this to `return self.term(self._zero_base_ring, 0)`.



---

archive/issue_comments_390972.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-05T02:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390972",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_390973.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> Because `zero` is a method of the parent:\n> [...]\n> So change this to `return self.term(self._zero_base_ring, 0)`.\n\nOf course, I was inpatent and overlooked this. Thank you. Fixed now.",
    "created_at": "2019-06-05T02:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390973",
    "user": "dkrenn"
}
```

Replying to [comment:8 tscrim]:
> Because `zero` is a method of the parent:
> [...]
> So change this to `return self.term(self._zero_base_ring, 0)`.

Of course, I was inpatent and overlooked this. Thank you. Fixed now.



---

archive/issue_comments_390974.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-05T04:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390974",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_390975.json:
```json
{
    "body": "Let it be so.",
    "created_at": "2019-06-05T04:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390975",
    "user": "tscrim"
}
```

Let it be so.



---

archive/issue_comments_390976.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-06T22:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27694",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27694#issuecomment-390976",
    "user": "vbraun"
}
```

Resolution: fixed
