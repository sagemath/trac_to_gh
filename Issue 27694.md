# Issue 27694: fix LazyPowerSeriesRing in other variable than x

Issue created by migration from https://trac.sagemath.org/ticket/27931

Original creator: dkrenn

Original creation time: 2019-06-04 15:56:43


```
sage: LazyPowerSeriesRing(QQ, 'z').gen()
```

gives an error.


---

Comment by git created at 2019-06-04 16:02:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dkrenn created at 2019-06-04 16:03:02

Did also some small cleanup.


---

Comment by dkrenn created at 2019-06-04 16:03:02

Changing status from new to needs_review.


---

Comment by tscrim created at 2019-06-04 23:03:44

I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.

So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow. While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.


---

Comment by dkrenn created at 2019-06-05 00:54:54

Replying to [comment:4 tscrim]:
> I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.

Yes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)
 
> So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.

Really?....my feeling was that storing zero in each element seems somehow a waste.

What if we store it in the parent and call it by `self._parent._zero_base_ring` or so?

 While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.

Getting this zero should clearly be done via the parent as it is not something that depends on the particular element.


---

Comment by tscrim created at 2019-06-05 01:14:41

Replying to [comment:5 dkrenn]:
> Replying to [comment:4 tscrim]:
> > I think we should actually go a bit further and make thing proper. Set the class-level attribute `Element` and deprecate the `element_class` input.
> 
> Yes, I agree. Tried that yesterday while working on this ticket, and then gave up after an hour or so... (There were a lot of strange error messages, infinite recursion loops etc. That all not in `series.py` which worked perfectly, but in `species.py` and `generating_series.py` which I tried to adapt as well.)

I see the problem: It is using the old-style parent still. This is something that should be fixed, but that would be much more invasive than should be on this ticket.

> > So there is a reason for storing `self._zero`, each of those indirections `self.parent().base_ring().zero()` is a (python?) function call, which is relatively slow.
> 
> Really?....my feeling was that storing zero in each element seems somehow a waste.
> 
> What if we store it in the parent and call it by `self._parent._zero_base_ring` or so?
> 
>  While I am not entirely sure this makes that much of a difference, it does seem to be called with some frequency, thus it might have some non-trivial effect. There is no real harm in having this (hidden) attribute IMO.
> 
> Getting this zero should clearly be done via the parent as it is not something that depends on the particular element.

This is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of "real-world" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.


---

Comment by dkrenn created at 2019-06-05 01:41:42

Replying to [comment:6 tscrim]:
> This is just one pointer, so it is such a small thing in terms of memory for something that is used with some frequency by the element. So I think there is a benefit to doing this here. However, my suspicion is that this is not going to matter too much in terms of "real-world" computations. If you do put it in the parent with simple attribute indirections, then that is a good compromise. I don't have too strong of an opinion on this matter.

So somehow I am not very successful today... In 
https://git.sagemath.org/sage.git/commit/?h=57ae6a712e9929247f8bcd2e420b66fba5e83404
I get

```
AttributeError: type object 'LazyPowerSeriesRing_with_category' has no attribute '_zero_base_ring'
```

and don't see why. (I got a problem when using `_parent`, but I though it might was because of Cythonizing. But now I get it for this argument as well.)
Probably I just overlook something. I also consider simply reverting the zero change and get this ticket done...


---

Comment by tscrim created at 2019-06-05 02:42:52

Because `zero` is a method of the parent:

```diff
@@ -268,7 +269,7 @@ class LazyPowerSeriesRing(Algebra):
             sage: L.zero()
             0
         """
-        return self.term(self.base_ring().zero(), 0)
+        return self.term(self.parent()._zero_base_ring, 0)
 
     def identity_element(self):
         """
```

So change this to `return self.term(self._zero_base_ring, 0)`.


---

Comment by git created at 2019-06-05 02:51:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2019-06-05 02:52:24

Replying to [comment:8 tscrim]:
> Because `zero` is a method of the parent:
> [...]
> So change this to `return self.term(self._zero_base_ring, 0)`.

Of course, I was inpatent and overlooked this. Thank you. Fixed now.


---

Comment by tscrim created at 2019-06-05 04:56:28

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-06-05 04:56:28

Let it be so.


---

Comment by vbraun created at 2019-06-06 22:26:31

Resolution: fixed
