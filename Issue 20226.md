# Issue 20226: Pari segfault on Sage startup in Cygwin (2)

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-04-19 07:58:26

This is the same issue as #11551, but as that issue was closed several years ago (with no satisfying resolution) it was suggested I open a new ticket.  The code has changed a little bit since then too.  Most notably as of [ade4f752](http://git.sagemath.org/sage.git/commit/src/sage/libs/pari/decl.pxi?h=develop&id=ade4f7521ad77c03e9791bc3768d9a9e3a2daca4) there are no longer `bot`, `top` and `avma` global variables in `paridecl.pxi` (then `decl.pxi`).  Now there is a single struct `pari_mainstack` with these pointers as elements.  I don't think that makes an enormous difference though, but it does change the discussion somewhat.

Otherwise the !Python/Cython level stacktrace is almost the same as before.  The segfault occurs on [this line](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/real_mpfr.pyx?h=976c0f3d0f9f0ac744e535ea734dadf2e7918991#n3138) which I guess happens to be reached the first time any PARI object is created during import.  I haven't debugged deeper than that yet but I'm guessing it's the same issue as in the original ticket--that the PARI stack somehow hasn't been initialized yet.

[Incidentally, one thing that did seem to work is cysignals--it caught the segfault and raised a Python exception for it. So I don't *think* cysignals is related here but I wouldn't necessarily rule it out either.]


---

Comment by embray created at 2016-05-12 13:47:26

Changing status from new to needs_review.


---

Comment by embray created at 2016-05-12 13:47:26

Changing keywords from "" to "cygwin windows".


---

Comment by embray created at 2016-05-12 13:47:26

I have discovered what I think is the cause of this issue, and have reported it upstream--I believe it to be an issue in Cygwin: https://cygwin.com/ml/cygwin/2016-05/msg00140.html

I've attached a workaround for the issue from the Sage end.  I'm not terribly happy with it, because if I understand correctly PARI will automatically grow its stack size as needed, and if it grows beyond 4GB this bug _could_ still occur (though I haven't tested this yet--anyone want to suggest to me a good way to test it?)

I'm not sure how best to work around that though without completely taking over PARI's stack management.  Probably fine just to leave it as a known issue until there's a fix in Cygwin. It's more important that we don't immediately segfault as soon as the first PARI number is created.
----
New commits:


---

Comment by git created at 2016-05-12 13:48:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-05-12 13:49:59

(Oops, had a typo in the original commit)


---

Comment by jdemeyer created at 2016-05-12 15:05:29

Replying to [comment:1 embray]:
> if I understand correctly PARI will automatically grow its stack size as needed

PARI will automatically grow its stack up to some user-provided maximum. The function is

```
paristack_setsize(size, vsize)       
```

where `size` is the actual size and `vsize` the maximum size.


---

Comment by jdemeyer created at 2016-05-12 15:06:52

...which implies that the correct work-around for Cygwin is simply to limit the second argument of `paristack_setsize()`.


---

Comment by jdemeyer created at 2016-05-12 15:06:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-05-12 15:14:39

Note also that _not_ calling `paristack_setsize()` is not really an option: you would end up with a small stack which cannot be increased. I'm pretty sure that some Sage functionality assumes a PARI stack which is larger than the default size.


---

Comment by jdemeyer created at 2016-05-12 20:22:24

We should probably also report this to upstream PARI (I guess the problem can be reproduced inside PARI/GP itself), such that they might apply the workaround.


---

Comment by embray created at 2016-05-13 09:30:28

I was under the assumption that it would grow automatically as needed, but maybe I shouldn't assume that it works nicely....


---

Comment by embray created at 2016-05-31 13:50:29

I have an update to this patch somewhere, I just haven't gotten around to pushing it yet.

In the meantime Cygwin has acknowledged the bug and pushed the fix.  I just confirmed that the fix seems to work (there's no segfault, at least): https://www.cygwin.com/ml/cygwin/2016-05/msg00240.html

Not sure yet when the fix will be in a release.  I may update this to include a version check on Cygwin once it makes sense to.


---

Comment by embray created at 2016-05-31 13:53:40

Per [this commit](https://sourceware.org/git/gitweb.cgi?p=newlib-cygwin.git;a=blobdiff;f=winsup/cygwin/release/2.5.2;h=c60f0fc032e08ddbf3d5bb293afad10f777e7f06;hp=0ea77206faa62491b185f5a35200b389139548ed;hb=4e434bf223c301cd2690a3fe1cde2a84c0d5b624;hpb=0aa738220bb9dea2ad479e484560767b36701947), the fix for this should appear in Cygwin v2.5.2.


---

Comment by embray created at 2016-05-31 14:00:27

If I were to put in a constant or function to get the Cygwin version (where relevant) where would be a good place to put that?  `sage.env`, maybe?


---

Comment by git created at 2016-06-30 16:38:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-06-30 16:39:19

Now always calls `paristack_setsize()`, but to a smaller value on platforms with this issue.

Also added an explicit check on the cygwin version, and does not invoke the workaround for Cygwin v2.5.2 where this is fixed.


---

Comment by embray created at 2016-06-30 16:39:26

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-07-27 09:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-07-27 10:34:44

I would prefer something along the lines of

```
sizemax = mem.virtual_memory_limit() // 4

if USING_BROKEN_VERSION_OF_CYGWIN and sizemax > KNOWN_WORKING_SIZE:
    # Cygwin's mmap is broken for large mmaps (>~ 4GB):
    # * #20463
    # * https://cygwin.com/ml/cygwin/2016-05/msg00140.html
    #
    # The underlying issue is fixed in Cygwin v2.5.2
    sizemax = KNOWN_WORKING_SIZE

paristack_setsize(size, sizemax)
```



---

Comment by jdemeyer created at 2016-07-27 10:34:44

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-07-27 11:00:48

That's fine, but you don't literally mean `USING_BROKEN_VERSION_OF_CYGWIN` do you?  The explicit version check that's there is much clearer.


---

Comment by jdemeyer created at 2016-07-27 12:29:36

No, not literal. Replace `USING_BROKEN_VERSION_OF_CYGWIN` and `KNOWN_WORKING_SIZE` by whatever you want.


---

Comment by git created at 2016-08-16 13:40:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-08-16 13:40:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-08-16 14:17:34

Yes, this is better.

I just don't understand why you talk of a limit of 4GB but then use 1GB (actually0x3fffffff) in the code?


---

Comment by jdemeyer created at 2016-08-16 14:17:34

Changing status from needs_review to needs_info.


---

Comment by embray created at 2016-08-16 14:35:15

To be honest I'm not exactly sure why either, though I might have been at one time (it's not like I've really worked on this recently.  I know that for starters I was just going by how the default takes `mem.virtual_memory_limit() // 4` so I also divided by 4.  And then when I went much over that it still crashed so I just kept it at 1GB (minus 1)


---

Comment by jdemeyer created at 2016-08-16 14:44:52

Replying to [comment:24 embray]:
> I was just going by how the default takes `mem.virtual_memory_limit() // 4`

That division by 4 is simply to determine how much memory should be used. It is a totally arbitrary number and it should be unrelated to the limit on Cygwin.

Did you run full doctests (`make ptestlong`) on Cygwin with this patch?


---

Comment by embray created at 2016-08-16 14:52:57

`make ptestlog` is kind of useless right now because many other tests are failing (though I'm closing to having them all fixed now).  That said, with this patch I haven't gotten any further segfaults from the Pari interface.

I'll have to double check on the actual limit.  IIRC using just under 4 GB still didn't work, although possibly due to page alignment requirements, etc.  It's been a while since I experimented with it.  Another problem I remember having was there was a heisenbug where the pari interface segfaults _only_ in gdb unless I remove the `paristack_setsize` call entirely.  Outside the debugger though it works.


---

Comment by jdemeyer created at 2016-08-16 14:56:59

Would a limit of, say `0xf0000000` (3.75 GB) work?


---

Comment by git created at 2016-09-05 12:29:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-09-05 12:29:47

Confirmed that `0xf0000000` works, so that's close enough.
----
New commits:


---

Comment by embray created at 2016-09-05 12:29:47

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2016-09-05 13:46:57

This comment does not really makes sense, I suggest to delete these 2 lines:

```
            # So we will just let the pari stack size grow as needed; if
            # it grows beyond 4GB this issue could still be triggered
```

The stack will only grow "as needed" up to the virtual stack size, which is at most `0xf0000000`.


---

Comment by embray created at 2016-09-06 07:54:10

Oh, you're right. That's from an older version of the patch where it wasn't setting a max stack size at all.


---

Comment by git created at 2016-09-06 07:58:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-06 22:21:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-10 09:00:27

Resolution: fixed
