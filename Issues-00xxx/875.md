# Issue 875: [with patch] further work needed on fast Sage --> PARI int conversion

archive/issues_000875.json:
```json
{
    "body": "This is further work needed after #467.\n\n```\n22:42 < cwitty_> I was looking at #467, and I just crashed SAGE with a PARI stack overflow.\n22:43 < cwitty_> I thought the stack was supposed to resize automatically, or something?  (Or at least\n                 not crash SAGE.)\n22:44 < cwitty_> sage: n = 10^10000000\n22:44 < cwitty_> sage: %time _ = pari(n)\n22:44 < cwitty_>   ***   the PARI stack overflows !\n22:44 < cwitty_>   current stack size: 8000000 (7.629 Mbytes)\n22:44 < cwitty_>   [hint] you can increase GP stack with allocatemem()\n22:44 < cwitty_> /home/cwitty/sage/local/bin/sage-sage: line 205: 25703 Aborted\n                 sage-ipython -c \"$SAGE_STARTUP_COMMAND;\" \"$@\"\n22:44 < cwitty_> (This is after I applied the patch from #467.)\n22:45 < williamstein> weird.\n22:45 < williamstein> it should automatically double *if* the author correctly uses _sig_on/_sig_off\n22:47 < cwitty_> This is the ZZ->Pari fast coercion patch, and I'm pretty sure (from skimming the patch)\n                 that he never touches _sig_on/_sig_off.  So that's probably it.\n```\n\n*THE SOLUTION*\n\nNeed to move code for _pari_c to gen.pyx as a method off of the Pari object.\nThen wrap the call to the function in convert.c in _sig_on / _sig_off.\nThe _sig_on / _sig_off macros are specially constructed *only* in gen.pyx \nto automatically double the pari stack if we run out of memory.\n\nALSO -- I think #467 should be better documented. Craig explained\nto me how he is \"hacking with the internals\" of the python/c api.  This should be explained even more in the code. \n\n\nAssignee: @craigcitro\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/875\n\n",
    "closed_at": "2007-10-27T19:45:45Z",
    "created_at": "2007-10-13T06:22:51Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-2.8.10",
    "title": "[with patch] further work needed on fast Sage --> PARI int conversion",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/875",
    "user": "https://github.com/williamstein"
}
```
This is further work needed after #467.

```
22:42 < cwitty_> I was looking at #467, and I just crashed SAGE with a PARI stack overflow.
22:43 < cwitty_> I thought the stack was supposed to resize automatically, or something?  (Or at least
                 not crash SAGE.)
22:44 < cwitty_> sage: n = 10^10000000
22:44 < cwitty_> sage: %time _ = pari(n)
22:44 < cwitty_>   ***   the PARI stack overflows !
22:44 < cwitty_>   current stack size: 8000000 (7.629 Mbytes)
22:44 < cwitty_>   [hint] you can increase GP stack with allocatemem()
22:44 < cwitty_> /home/cwitty/sage/local/bin/sage-sage: line 205: 25703 Aborted
                 sage-ipython -c "$SAGE_STARTUP_COMMAND;" "$@"
22:44 < cwitty_> (This is after I applied the patch from #467.)
22:45 < williamstein> weird.
22:45 < williamstein> it should automatically double *if* the author correctly uses _sig_on/_sig_off
22:47 < cwitty_> This is the ZZ->Pari fast coercion patch, and I'm pretty sure (from skimming the patch)
                 that he never touches _sig_on/_sig_off.  So that's probably it.
```

*THE SOLUTION*

Need to move code for _pari_c to gen.pyx as a method off of the Pari object.
Then wrap the call to the function in convert.c in _sig_on / _sig_off.
The _sig_on / _sig_off macros are specially constructed *only* in gen.pyx 
to automatically double the pari stack if we run out of memory.

ALSO -- I think #467 should be better documented. Craig explained
to me how he is "hacking with the internals" of the python/c api.  This should be explained even more in the code. 


Assignee: @craigcitro

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/875





---

archive/issue_comments_005577.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+This is further work needed after #467.\n+\n ```\n 22:42 < cwitty_> I was looking at #467, and I just crashed SAGE with a PARI stack overflow.\n 22:43 < cwitty_> I thought the stack was supposed to resize automatically, or something?  (Or at least\n@@ -23,7 +25,9 @@\n The _sig_on / _sig_off macros are specially constructed *only* in gen.pyx \n to automatically double the pari stack if we run out of memory.\n \n-Assignee: somebody\n+ALSO -- I think #467 should be better documented. Craig explained\n+to me how he is \"hacking with the internals\" of the python/c api.  This should be explained even more in the code. \n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2007-10-13T06:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5577",
    "user": "https://github.com/williamstein"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+This is further work needed after #467.
+
 ```
 22:42 < cwitty_> I was looking at #467, and I just crashed SAGE with a PARI stack overflow.
 22:43 < cwitty_> I thought the stack was supposed to resize automatically, or something?  (Or at least
@@ -23,7 +25,9 @@
 The _sig_on / _sig_off macros are specially constructed *only* in gen.pyx 
 to automatically double the pari stack if we run out of memory.
 
-Assignee: somebody
+ALSO -- I think #467 should be better documented. Craig explained
+to me how he is "hacking with the internals" of the python/c api.  This should be explained even more in the code. 
+
 
 Comment: 1
 
``````




---

archive/issue_comments_005578.json:
```json
{
    "body": "Changing status from new to assigned.",
    "created_at": "2007-10-13T15:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5578",
    "user": "https://github.com/craigcitro"
}
```

Changing status from new to assigned.



---

archive/issue_comments_005579.json:
```json
{
    "body": "Changing assignee from somebody to @craigcitro.",
    "created_at": "2007-10-13T15:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5579",
    "user": "https://github.com/craigcitro"
}
```

Changing assignee from somebody to @craigcitro.



---

archive/issue_comments_005580.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2007-10-20T22:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5580",
    "user": "https://github.com/williamstein"
}
```

Changing type from defect to enhancement.



---

archive/issue_events_002439.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2007-10-21T03:20:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/875#event-2439"
}
```



---

archive/issue_events_002440.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2007-10-25T01:09:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/875#event-2440"
}
```



---

archive/issue_events_002441.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2007-10-25T01:09:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "milestone": "sage-2.8.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/875#event-2441"
}
```



---

archive/issue_comments_005581.json:
```json
{
    "body": "<a id='comment:7'></a>This patch fixes the problem above, and adds a doctest about it. It took a bit of fiddling to get this to work -- the point is that you need to load the Integer type in order to make this work in gen.pyx, but you can't do that at compile time (it would be a circular dependency). This is further compounded by the fact that the code in gen.pyx actually gets *used* in the process of loading other parts of the Sage library -- that is, you create and use Sage's PariInstance in the process of loading various modules, so things had to be touched up in a few places to get things to load.\n\nAlso, re: William's note above about \"hacking the Python/C API\" -- that's not for this patch, that's for the upcoming patch on ticket 864. That might have to wait until 2.9 at the rate our new versions are coming these days, though. ;)",
    "created_at": "2007-10-27T08:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5581",
    "user": "https://github.com/craigcitro"
}
```

<a id='comment:7'></a>This patch fixes the problem above, and adds a doctest about it. It took a bit of fiddling to get this to work -- the point is that you need to load the Integer type in order to make this work in gen.pyx, but you can't do that at compile time (it would be a circular dependency). This is further compounded by the fact that the code in gen.pyx actually gets *used* in the process of loading other parts of the Sage library -- that is, you create and use Sage's PariInstance in the process of loading various modules, so things had to be touched up in a few places to get things to load.

Also, re: William's note above about "hacking the Python/C API" -- that's not for this patch, that's for the upcoming patch on ticket 864. That might have to wait until 2.9 at the rate our new versions are coming these days, though. ;)



---

archive/issue_events_002442.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/cwitty",
    "created_at": "2007-10-27T19:45:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/875#event-2442"
}
```



---

archive/issue_comments_005582.json:
```json
{
    "body": "<a id='comment:8'></a>Attachment [trac_875.hg](tarball://root/attachments/some-uuid/ticket875/trac_875.hg) by cwitty created at 2007-10-27 19:45:45",
    "created_at": "2007-10-27T19:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5582",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

<a id='comment:8'></a>Attachment [trac_875.hg](tarball://root/attachments/some-uuid/ticket875/trac_875.hg) by cwitty created at 2007-10-27 19:45:45



---

archive/issue_comments_005583.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2007-10-27T19:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/875",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/875#issuecomment-5583",
    "user": "https://trac.sagemath.org/admin/accounts/users/cwitty"
}
```

Resolution: fixed
