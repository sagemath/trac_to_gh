# Issue 174: Implement a modular Hermite Normal Form algorithm

archive/issues_000174.json:
```json
{
    "body": "Hermite Normal form is the analogue of echelon form over the integers.\nIt's crucial for almost all efficient computations with Z-modules (infinite \nabelian groups, finite abelian groups, lattices, modular abelian varieties\nvia lattices, etc).  \n\nMAGMA is 50 times faster even for small examples, and asymptotically\nmuch faster than GAP, PARI, and NTL. \n\nSee this page http://magma.maths.usyd.edu.au/users/allan/mat/hermite.html\nwhich is mirrored here:\nhttp://sage.math.washington.edu/sage/misc/hermite.html\n\n\n\n\n**Assignee:** @williamstein\n\n**CC:**  @burcin\n\nIssue created by migration from https://trac.sagemath.org/ticket/174\n\n",
    "closed_at": "2008-02-21T03:10:40Z",
    "created_at": "2006-12-01T02:15:15Z",
    "labels": [
        "component: linear algebra",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-2.10.2",
    "title": "Implement a modular Hermite Normal Form algorithm",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/174",
    "user": "https://github.com/williamstein"
}
```
Hermite Normal form is the analogue of echelon form over the integers.
It's crucial for almost all efficient computations with Z-modules (infinite 
abelian groups, finite abelian groups, lattices, modular abelian varieties
via lattices, etc).  

MAGMA is 50 times faster even for small examples, and asymptotically
much faster than GAP, PARI, and NTL. 

See this page http://magma.maths.usyd.edu.au/users/allan/mat/hermite.html
which is mirrored here:
http://sage.math.washington.edu/sage/misc/hermite.html




**Assignee:** @williamstein

**CC:**  @burcin

Issue created by migration from https://trac.sagemath.org/ticket/174





---

archive/issue_comments_000649.json:
```json
{
    "body": "a student paper on fast HNF algorithms (and there are other papers out there)",
    "created_at": "2006-12-01T02:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-649",
    "user": "https://github.com/williamstein"
}
```

a student paper on fast HNF algorithms (and there are other papers out there)



---

archive/attachments_000039.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "HermiteNormalForm_1.tex",
    "asset_url": "tarball://root/attachments/some-uuid/ticket174/HermiteNormalForm_1.tex",
    "created_at": "2007-01-13T01:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.tex",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_000650.json:
```json
{
    "body": "<a id='comment:1'></a>\n",
    "created_at": "2007-01-13T01:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-650",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>




---

archive/issue_comments_000651.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe attached paper by students describes the super-fast algorithm in MAGMA, and should\nbe reasonably easy to implement in SAGE given what we now have.",
    "created_at": "2007-03-08T10:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-651",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
The attached paper by students describes the super-fast algorithm in MAGMA, and should
be reasonably easy to implement in SAGE given what we now have.



---

archive/issue_events_000371.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "rename": {
        "from": "all existing open source Hermite Normal Form implementations totally SUCK.",
        "to": "Implement a modular Hermite Normal Form algorithm"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/174#event-371"
}
```



---

archive/issue_events_000372.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2007-09-10T02:57:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/174#event-372"
}
```



---

archive/attachments_000040.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-174.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket174/trac-174.patch",
    "created_at": "2008-02-08T16:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_000652.json:
```json
{
    "body": "",
    "created_at": "2008-02-08T16:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-652",
    "user": "https://github.com/williamstein"
}
```





---

archive/attachments_000041.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "hnfrow.sage",
    "asset_url": "tarball://root/attachments/some-uuid/ticket174/hnfrow.sage",
    "created_at": "2008-02-08T16:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.sage",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_000653.json:
```json
{
    "body": "",
    "created_at": "2008-02-08T16:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-653",
    "user": "https://github.com/williamstein"
}
```





---

archive/attachments_000042.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-174-part2.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket174/trac-174-part2.patch",
    "created_at": "2008-02-08T16:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_000654.json:
```json
{
    "body": "",
    "created_at": "2008-02-08T16:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-654",
    "user": "https://github.com/williamstein"
}
```





---

archive/attachments_000043.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac-174-part3.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket174/trac-174-part3.patch",
    "created_at": "2008-02-17T01:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/williamstein"
}
```



---

archive/issue_comments_000655.json:
```json
{
    "body": "<a id='comment:5'></a>\nI've put the final hnf.hg bundle here:\n\n  http://sage.math.washington.edu/home/was/patches/hnf.hg\n\nThis is a bundle that I made by cleanly applying all my relevant\npatches to 2.10.2.alpha0, then do hg_sage.send(...). \n\nThe code is well documented, works well (very well tested with\nautomated testing and doctstrings), but has a HUGE MEMORY LEAK somewhere:\n\n```\nsage: a = random_matrix(ZZ,200,x=0,y=9)\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\n'234M+'\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\n'239M+'\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\n'244M+'\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\n'249M+'\n```\n\nI suspect the memleak is in the optimized GMP code I added to matrix_integer_dense, and will find out soon...",
    "created_at": "2008-02-17T01:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-655",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:5'></a>
I've put the final hnf.hg bundle here:

  http://sage.math.washington.edu/home/was/patches/hnf.hg

This is a bundle that I made by cleanly applying all my relevant
patches to 2.10.2.alpha0, then do hg_sage.send(...). 

The code is well documented, works well (very well tested with
automated testing and doctstrings), but has a HUGE MEMORY LEAK somewhere:

```
sage: a = random_matrix(ZZ,200,x=0,y=9)
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
'234M+'
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
'239M+'
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
'244M+'
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
'249M+'
```

I suspect the memleak is in the optimized GMP code I added to matrix_integer_dense, and will find out soon...



---

archive/issue_events_000373.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-02-17T01:28:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/174#event-373"
}
```



---

archive/issue_events_000374.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2008-02-17T01:28:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "milestone": "sage-2.10.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/174#event-374"
}
```



---

archive/issue_comments_000656.json:
```json
{
    "body": "<a id='comment:6'></a>\nHere's a big leak:\n\n```\nsage: a = random_matrix(ZZ,200,x=0,y=9); e = a.hermite_form(proof=False); p = a.pivots()\nsage: get_memory_usage()\n'192M+'\nsage: w = e._add_row_and_maintain_echelon_form(random_matrix(ZZ,1,200), p)\nsage: get_memory_usage()\n'210M+'\n```",
    "created_at": "2008-02-17T01:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-656",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:6'></a>
Here's a big leak:

```
sage: a = random_matrix(ZZ,200,x=0,y=9); e = a.hermite_form(proof=False); p = a.pivots()
sage: get_memory_usage()
'192M+'
sage: w = e._add_row_and_maintain_echelon_form(random_matrix(ZZ,1,200), p)
sage: get_memory_usage()
'210M+'
```



---

archive/issue_comments_000657.json:
```json
{
    "body": "<a id='comment:7'></a>\nok, the file at http://sage.math.washington.edu/home/was/patches/hnf.hg has all the HNF stuff all working with no known issues.\n\n finally!",
    "created_at": "2008-02-17T03:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-657",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>
ok, the file at http://sage.math.washington.edu/home/was/patches/hnf.hg has all the HNF stuff all working with no known issues.

 finally!



---

archive/issue_comments_000658.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2008-02-17T03:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-658",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_000659.json:
```json
{
    "body": "<a id='comment:8'></a>\nOk, running the final bundle under valgrind with \n\n```\nsage: a = random_matrix(ZZ,200,x=0,y=9)\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\nsage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()\n```\ndoesn't leak at all. Excellent. So positive review on memory leak issues.\n\nCheers,\n\nMichael",
    "created_at": "2008-02-17T03:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-659",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:8'></a>
Ok, running the final bundle under valgrind with 

```
sage: a = random_matrix(ZZ,200,x=0,y=9)
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
sage: a._clear_cache(); e = a.hermite_form(proof=False); get_memory_usage()
```
doesn't leak at all. Excellent. So positive review on memory leak issues.

Cheers,

Michael



---

archive/issue_comments_000660.json:
```json
{
    "body": "<a id='comment:9'></a>\nFYI: The code has been merged, but still needs \"official\" review by a third party.\n\nCheers,\n\nMichael",
    "created_at": "2008-02-17T11:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-660",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:9'></a>
FYI: The code has been merged, but still needs "official" review by a third party.

Cheers,

Michael



---

archive/issue_comments_000661.json:
```json
{
    "body": "<a id='comment:10'></a>\nThe bundle has been extensively tested and I have verified via valgrind that it doesn't leak memory. While nobody external ever did a formal review  I am giving this a positive review due to the excessive amount of testing. Feel free to do a formal review, but please open another ticket in case  you come up with any issues.\n\nCheers,\n\nMichael",
    "created_at": "2008-02-21T03:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-661",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:10'></a>
The bundle has been extensively tested and I have verified via valgrind that it doesn't leak memory. While nobody external ever did a formal review  I am giving this a positive review due to the excessive amount of testing. Feel free to do a formal review, but please open another ticket in case  you come up with any issues.

Cheers,

Michael



---

archive/issue_comments_000662.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2008-02-21T03:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-662",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_000663.json:
```json
{
    "body": "<a id='comment:11'></a>\nMerged in Sage 2.10.2.alpha1",
    "created_at": "2008-02-21T03:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/174#issuecomment-663",
    "user": "https://trac.sagemath.org/admin/accounts/users/mabshoff"
}
```

<a id='comment:11'></a>
Merged in Sage 2.10.2.alpha1



---

archive/issue_events_000375.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2008-02-21T03:10:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/174",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/174#event-375"
}
```
