# Issue 938: graph_database.py has some mysterious problems.

archive/issues_000938.json:
```json
{
    "body": "The graph_database.py file has lots of problems now that I've removed the sage.:'s.  This needs to be fixed, and I don't know enough about the code to fix it. \n\n**Assignee:** @williamstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/938\n\n",
    "closed_at": "2007-10-27T02:42:49Z",
    "created_at": "2007-10-20T06:44:05Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-2.8.10",
    "title": "graph_database.py has some mysterious problems.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/938",
    "user": "https://github.com/williamstein"
}
```
The graph_database.py file has lots of problems now that I've removed the sage.:'s.  This needs to be fixed, and I don't know enough about the code to fix it. 

**Assignee:** @williamstein

Issue created by migration from https://trac.sagemath.org/ticket/938





---

archive/issue_comments_005110.json:
```json
{
    "body": "<a id='comment:1'></a>\nOn a fresh copy of 2.8.8.1, I removed the nodoctest at the top, searched for sage.:'s, found none, and tried testing:\n\n```\nsha:~/sage-2.8.8.1 robert$ ./sage -t devel/sage/sage/graphs/graph_database.py \nsage -t  devel/sage-db/sage/graphs/graph_database.py        \n         [62.1 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 62.1 seconds\n```\n\nThat's pretty mysterious!",
    "created_at": "2007-10-22T02:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5110",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:1'></a>
On a fresh copy of 2.8.8.1, I removed the nodoctest at the top, searched for sage.:'s, found none, and tried testing:

```
sha:~/sage-2.8.8.1 robert$ ./sage -t devel/sage/sage/graphs/graph_database.py 
sage -t  devel/sage-db/sage/graphs/graph_database.py        
         [62.1 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 62.1 seconds
```

That's pretty mysterious!



---

archive/issue_comments_005111.json:
```json
{
    "body": "<a id='comment:2'></a>\nPS - this was on a macbook pro...",
    "created_at": "2007-10-22T02:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5111",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:2'></a>
PS - this was on a macbook pro...



---

archive/issue_events_002896.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2007-10-24T00:31:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2896"
}
```



---

archive/issue_events_002897.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "rename": {
        "from": "graph_database.py has some mysterious problems.",
        "to": "[doesn't seem valid] graph_database.py has some mysterious problems."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2897"
}
```



---

archive/issue_comments_005112.json:
```json
{
    "body": "<a id='comment:4'></a>\nI think William fixed all of these.",
    "created_at": "2007-10-24T00:45:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5112",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:4'></a>
I think William fixed all of these.



---

archive/issue_events_002898.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2007-10-24T01:09:11Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2898"
}
```



---

archive/issue_events_002899.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2007-10-24T01:09:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2899"
}
```



---

archive/issue_comments_005113.json:
```json
{
    "body": "<a id='comment:5'></a>\nNo, actually this isn't fixed. The doctests pass, but that's because the expected output is <html>..., in other words, anything that starts with <html> will pass. There was a change that William made, leaving the comment\n            # TODO: this line is a HACK to get around something\n            # being broken with the database/query system.  \nwhich is unfortunate, because now not a single value is returned by the query (they are all \"?\"). Is a completely broken doctest that passes better? I'd like to know why those changes were made, and what they were supposed to get around...\n\nIf we change things back to before this change, then we can get the failures William was talking about, which seems a lot closer to the problem...\n\nI'm moving this back to 2.9.",
    "created_at": "2007-10-24T01:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5113",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:5'></a>
No, actually this isn't fixed. The doctests pass, but that's because the expected output is <html>..., in other words, anything that starts with <html> will pass. There was a change that William made, leaving the comment
            # TODO: this line is a HACK to get around something
            # being broken with the database/query system.  
which is unfortunate, because now not a single value is returned by the query (they are all "?"). Is a completely broken doctest that passes better? I'd like to know why those changes were made, and what they were supposed to get around...

If we change things back to before this change, then we can get the failures William was talking about, which seems a lot closer to the problem...

I'm moving this back to 2.9.



---

archive/issue_events_002900.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "rename": {
        "from": "[doesn't seem valid] graph_database.py has some mysterious problems.",
        "to": "graph_database.py has some mysterious problems."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2900"
}
```



---

archive/issue_comments_005114.json:
```json
{
    "body": "<a id='comment:6'></a>\nOk, here's the problem. On the old way of thinking, before the big \"database class\" thingy, the argument query was just a plain string sqlite3 query. Now it's a highfalutin' python class object: line 1302 forward:\n\n```\nif ( query is None):\n    param = None\n    query = __query_string__(graph6=graph6, num_vertices=num_vertices, num_edges=num_edges, num_cycles=num_cycles, num_hamiltonian_cycles=num_hamiltonian_cycles, eulerian=eulerian, planar=planar, perfect=perfect, lovasz_number=lovasz_number, complement_graph6=complement_graph6, aut_grp_size=aut_grp_size, num_orbits=num_orbits, num_fixed_points=num_fixed_points, vertex_transitive=vertex_transitive, edge_transitive=edge_transitive, degree_sequence=degree_sequence, min_degree=min_degree, max_degree=max_degree, average_degree=average_degree, degrees_sd=degrees_sd, regular=regular, vertex_connectivity=vertex_connectivity, edge_connectivity=edge_connectivity, num_components=num_components, girth=girth, radius=radius, diameter=diameter, clique_number=clique_number, independence_number=independence_number, num_cut_vertices=num_cut_vertices, min_vertex_cover_size=min_vertex_cover_size, num_spanning_trees=num_spanning_trees, induced_subgraphs=induced_subgraphs, spectrum=spectrum, min_eigenvalue=min_eigenvalue, max_eigenvalue=max_eigenvalue, eigenvalues_sd=eigenvalues_sd, energy=energy)\n    query = re.sub('INNER JOIN .* WHERE','INNER JOIN aut_grp on aut_grp.graph_id=graph_data.graph_id INNER JOIN degrees on degrees.graph_id=graph_data.graph_id INNER JOIN misc on misc.graph_id=graph_data.graph_id INNER JOIN spectrum on spectrum.graph_id=graph_data.graph_id WHERE',query)\n    query = re.sub('FROM graph_data WHERE','FROM graph_data INNER JOIN aut_grp on aut_grp.graph_id=graph_data.graph_id INNER JOIN degrees on degrees.graph_id=graph_data.graph_id INNER JOIN misc on misc.graph_id=graph_data.graph_id INNER JOIN spectrum on spectrum.graph_id=graph_data.graph_id WHERE',query)\n    query = re.sub('SELECT graph_data.graph6','SELECT graph_data.graph6,graph_data.num_vertices,degrees.regular,aut_grp.aut_grp_size,graph_data.num_edges,degrees.min_degree,aut_grp.num_orbits,graph_data.num_cycles,degrees.max_degree,aut_grp.num_fixed_points,graph_data.num_hamiltonian_cycles,degrees.average_degree,aut_grp.vertex_transitive,graph_data.eulerian,degrees.degrees_sd,aut_grp.edge_transitive,graph_data.planar,degrees.degree_sequence,misc.vertex_connectivity,graph_data.perfect,spectrum.min_eigenvalue,misc.edge_connectivity,graph_data.lovasz_number,misc.girth,spectrum.max_eigenvalue,misc.num_cut_vertices,misc.independence_number,misc.radius,spectrum.eigenvalues_sd,misc.min_vertex_cover_size,misc.clique_number,misc.diameter,spectrum.energy,misc.num_spanning_trees,misc.num_components,graph_data.complement_graph6,spectrum.spectrum,misc.induced_subgraphs',query)\nelse:\n    # Deal only with the string:\n    param = query.__param_tuple__\n    query = query.__query_string__\n```\n\n\nThe problem is in the else block, where query is something. The problem is, this else block is confused about what that is.",
    "created_at": "2007-10-24T01:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5114",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:6'></a>
Ok, here's the problem. On the old way of thinking, before the big "database class" thingy, the argument query was just a plain string sqlite3 query. Now it's a highfalutin' python class object: line 1302 forward:

```
if ( query is None):
    param = None
    query = __query_string__(graph6=graph6, num_vertices=num_vertices, num_edges=num_edges, num_cycles=num_cycles, num_hamiltonian_cycles=num_hamiltonian_cycles, eulerian=eulerian, planar=planar, perfect=perfect, lovasz_number=lovasz_number, complement_graph6=complement_graph6, aut_grp_size=aut_grp_size, num_orbits=num_orbits, num_fixed_points=num_fixed_points, vertex_transitive=vertex_transitive, edge_transitive=edge_transitive, degree_sequence=degree_sequence, min_degree=min_degree, max_degree=max_degree, average_degree=average_degree, degrees_sd=degrees_sd, regular=regular, vertex_connectivity=vertex_connectivity, edge_connectivity=edge_connectivity, num_components=num_components, girth=girth, radius=radius, diameter=diameter, clique_number=clique_number, independence_number=independence_number, num_cut_vertices=num_cut_vertices, min_vertex_cover_size=min_vertex_cover_size, num_spanning_trees=num_spanning_trees, induced_subgraphs=induced_subgraphs, spectrum=spectrum, min_eigenvalue=min_eigenvalue, max_eigenvalue=max_eigenvalue, eigenvalues_sd=eigenvalues_sd, energy=energy)
    query = re.sub('INNER JOIN .* WHERE','INNER JOIN aut_grp on aut_grp.graph_id=graph_data.graph_id INNER JOIN degrees on degrees.graph_id=graph_data.graph_id INNER JOIN misc on misc.graph_id=graph_data.graph_id INNER JOIN spectrum on spectrum.graph_id=graph_data.graph_id WHERE',query)
    query = re.sub('FROM graph_data WHERE','FROM graph_data INNER JOIN aut_grp on aut_grp.graph_id=graph_data.graph_id INNER JOIN degrees on degrees.graph_id=graph_data.graph_id INNER JOIN misc on misc.graph_id=graph_data.graph_id INNER JOIN spectrum on spectrum.graph_id=graph_data.graph_id WHERE',query)
    query = re.sub('SELECT graph_data.graph6','SELECT graph_data.graph6,graph_data.num_vertices,degrees.regular,aut_grp.aut_grp_size,graph_data.num_edges,degrees.min_degree,aut_grp.num_orbits,graph_data.num_cycles,degrees.max_degree,aut_grp.num_fixed_points,graph_data.num_hamiltonian_cycles,degrees.average_degree,aut_grp.vertex_transitive,graph_data.eulerian,degrees.degrees_sd,aut_grp.edge_transitive,graph_data.planar,degrees.degree_sequence,misc.vertex_connectivity,graph_data.perfect,spectrum.min_eigenvalue,misc.edge_connectivity,graph_data.lovasz_number,misc.girth,spectrum.max_eigenvalue,misc.num_cut_vertices,misc.independence_number,misc.radius,spectrum.eigenvalues_sd,misc.min_vertex_cover_size,misc.clique_number,misc.diameter,spectrum.energy,misc.num_spanning_trees,misc.num_components,graph_data.complement_graph6,spectrum.spectrum,misc.induced_subgraphs',query)
else:
    # Deal only with the string:
    param = query.__param_tuple__
    query = query.__query_string__
```


The problem is in the else block, where query is something. The problem is, this else block is confused about what that is.



---

archive/attachments_000607.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "7087.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket938/7087.patch",
    "created_at": "2007-10-24T01:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/rlmill"
}
```



---

archive/issue_comments_005115.json:
```json
{
    "body": "<a id='comment:7'></a>\n",
    "created_at": "2007-10-24T01:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5115",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:7'></a>




---

archive/issue_events_002901.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2007-10-24T01:58:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2901"
}
```



---

archive/issue_events_002902.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2007-10-24T01:58:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2902"
}
```



---

archive/issue_events_002903.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2007-10-25T01:09:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2903"
}
```



---

archive/issue_events_002904.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mabshoff",
    "created_at": "2007-10-25T01:09:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "milestone": "sage-2.8.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2904"
}
```



---

archive/issue_comments_005116.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis patches cleanly onto 2.8.9.",
    "created_at": "2007-10-25T19:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/938#issuecomment-5116",
    "user": "https://github.com/rlmill"
}
```

<a id='comment:10'></a>
This patches cleanly onto 2.8.9.



---

archive/issue_events_002905.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/cwitty",
    "created_at": "2007-10-27T02:42:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/938",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/938#event-2905"
}
```
