# Issue 27347: Characteristic Classes

Issue created by migration from https://trac.sagemath.org/ticket/27584

Original creator: @DeRhamSource

Original creation time: 2019-03-31 22:17:48

CC:  egourgoulhon tscrim




---

Comment by @DeRhamSource created at 2019-03-31 22:35:24

Changing keywords from "" to "characteristic classes, manifolds".


---

Comment by @DeRhamSource created at 2019-03-31 22:35:24

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @DeRhamSource created at 2019-03-31 22:35:24

Changing component from PLEASE CHANGE to geometry.


---

Comment by git created at 2019-04-03 11:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-04-03 12:41:32

Here is the answer to the question raised in https://groups.google.com/d/msg/sage-devel/hwsQWuLN0nc/1_8LjLL4AgAJ, namely when `a` is a differential form (from previously existing `DiffForm` class) and `A` is a mixed form (as introduced in this ticket), why do we get

```
sage: a.__mul__(A)
Mixed differential form A/\a on the 2-dimensional differentiable manifold M
```

I think this results from a clash between (i) the operator `__mul__` being used to denote the wedge product for mixed differential forms and (ii) the operator `__mul__` being used to denote tensor product for differential forms. Indeed `a.__mul__(A)`  calls the method `__mul__` implemented in line 2169 of `src/sage/manifolds/differentiable/tensorfield.py`, which is devoted to the tensor product (the differential form `a` being considered as a tensor field of type (0,p), where p=degree(a)). As you can see in line 2269, if `A` does not belong to the class `TensorField`, one assumes that `A` is a scalar field (the only possible case until this ticket) and the code return `A*a`, i.e. `A.wedge(a)`. 

A possible solution could be to change the lines 2269-2271 of `tensorfield.py` to

```
if isinstance(other, MixedForm):
    return other.parent()(self)._mul_(other)
elif not isinstance(other, TensorField):
    # Multiplication by a scalar field or a number
    return other * self
```

A better way would be to redefine `__mul__` in `DiffForm`, falling back to the tensor field version if `other` is not a mixed form.


---

Comment by git created at 2019-04-03 14:18:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-04-04 14:03:19

Your code looks nice, as well as the demo notebook! 

Just a remark at this stage: you should not put any Jupyter notebook in the ticket's git branch. Indeed, when the ticket gets a positive review, the branch is merged into Sage's main branch, which must contain only source code (it is already very large just with sources). It is of course a good idea to share notebooks during the development process, but you should put them to a public repository (e.g. GitHub) and simply add a link to them in some comment on the ticket.


---

Comment by tscrim created at 2019-04-04 14:21:57

The other thing you could do is add the notebook file as an attachment (but note that you cannot delete it afterwards).


---

Comment by @DeRhamSource created at 2019-04-04 14:24:24

Oh I'm sorry, I didn't realize that. How can I delete this file from the ticket?

In the next step, I will translate the notebook to english and add Doctests to the main files. Then, I guess, it's ready for review.


---

Comment by egourgoulhon created at 2019-04-04 14:57:03

Replying to [comment:12 gh-DeRhamSource]:
> Oh I'm sorry, I didn't realize that. How can I delete this file from the ticket?
> 

Since the file is not very large, I guess it suffices to run

```
git rm scripts/MixedAlgebra.ipynb
```

before your next commit. 
Otherwise (i.e. for a large file), I would have recommended to delete the branch and to start a brand new one. 
> In the next step, I will translate the notebook to english and add Doctests to the main files. Then, I guess, it's ready for review.

OK very good!


---

Comment by git created at 2019-04-04 15:05:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-05 15:15:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-04-05 15:20:46

I added a link to my public github repo for the demo notebook in the description.


---

Comment by git created at 2019-04-06 16:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-04-06 16:44:46

There is now a full doctest implemented in mixed_form_algebra.py. However, I've encountered another problem while coding the doctest of mixed_form.py. Namely an issue with coercions from the symbolic ring:


```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: A = M.mixed_form_algebra()
sage: A._element_constructor_(x).disp(X.frame())
[x] + [0] + [0]
sage: A(x).disp(X.frame())
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-84-7bd889258762> in <module>()
----> 1 A(x).disp(X.frame())

AttributeError: 'NoneType' object has no attribute 'disp'
```


How is that possible? Shouldn't A(.) invoke the method A._element_constructor_?


---

Comment by tscrim created at 2019-04-06 22:56:41

It does, but only after checking for a coercion. So my guess is something is going strange with the coercion. Posting the full traceback would be useful.

A few unrelated comments:

`isinstance(comp, (int, Integer))` -> `comp in ZZ` because it also catches cases like `2/1` (which is in `QQ`).

A few of your example blocks should be `TESTS::` and `EXAMPLES::` when followed immediately by doctests, which should also be indentent 1 level.


---

Comment by @DeRhamSource created at 2019-04-06 23:31:40

Thanks! :)

The snippet `isinstance(comp, (int, Integer))` is adapted from `diff_form_module.py`. Should I apply your suggestion in that file as well for this branch, then?

More feedback and suggestions are very welcome! :)

Unfortunately, there is no error message or traceback:


```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: A = M.mixed_form_algebra()
sage: A(x)
```


The coercion is already known:


```
sage: M.mixed_form_algebra().has_coerce_map_from(SR)
True
```


So, I have really no idea why it won't work. But for scalar fields, it does:


```
sage: f = M.scalar_field_algebra()(x); f
Scalar field on the 2-dimensional differentiable manifold M
```



---

Comment by tscrim created at 2019-04-06 23:44:59

Hmm...so the output of `A(x)` really is `None`...that is very strange. What does `coercion_model.explain(x, A)` result in?


---

Comment by @DeRhamSource created at 2019-04-06 23:50:51


```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: A = M.mixed_form_algebra()
sage: coercion_model.explain(x, A)
Coercion on left operand via
    Generic morphism:
      From: Symbolic Ring
      To:   Graded algebra Omega^*(M) of mixed differential forms on the 2-dimensional differentiable manifold M
Arithmetic performed after coercions.
Result lives in Graded algebra Omega^*(M) of mixed differential forms on the 2-dimensional differentiable manifold M
```



---

Comment by tscrim created at 2019-04-07 00:27:00

What is the result of

```
sage: phi = A.coerce_map_from_(SR)
sage: phi
sage: type(phi)
sage: phi(x)
```



---

Comment by @DeRhamSource created at 2019-04-07 07:34:53


```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: A = M.mixed_form_algebra()
sage: phi = A.coerce_map_from(SR)
sage: phi
Generic morphism:
  From: Symbolic Ring
  To:   Graded algebra Omega^*(M) of mixed differential forms on the 2-dimensional differentiable manifold M
sage: type(phi)
<type 'sage.categories.morphism.SetMorphism'>
sage: phi(x)
sage: type(phi(x))
<type 'NoneType'>
```



---

Comment by tscrim created at 2019-04-07 07:37:32

That was what I was expecting. Basically what is happening is when it goes through the coercion framework, the result is `None`. So you need to look into that coercion morphism and what function it is calling and why that is not returning the proper object.


---

Comment by @DeRhamSource created at 2019-04-07 08:40:41

I'm sorry: How do I manage that?


---

Comment by tscrim created at 2019-04-07 13:33:52

You will have to explore the properties of the morphism, such as `phi._function`, and maybe also add a `print()` statement or two for debugging in the `_element_constructor_` to see what is happening.


---

Comment by egourgoulhon created at 2019-04-07 17:18:30

I think the issue arises because `SR` is the base ring of the algebra `A`:

```
sage: A.base_ring()
Symbolic Ring
```

If I am correct, in such a case, the coercion `SR` --> `A` is implemented via the algebra operation `x * A.one()`, not via `_element_constructor_`. In the present case, `x * A.one()` fails:

```
sage: x * A.one()
...
RuntimeError: BUG in map, returned None x <type 'sage.categories.morphism.SetMorphism'> Generic morphism:
  From: Symbolic Ring
  To:   Graded algebra Omega^*(M) of mixed differential forms on the 2-dimensional differentiable manifold M
```

To make it work, you should implement the method `_lmul_` in class `MixedForm` and add the line 

```
    if other is SR:
        return True
```

in `MixedFormAlgebra._coerce_map_from_`. At least, this is what is done for the algebras of scalar fields: see line 512 of `src/sage/manifolds/scalarfield_algebra.py` and the definition of `_lmul_` in line 2449 of `src/sage/manifolds/scalarfield.py`.


---

Comment by @DeRhamSource created at 2019-04-07 18:19:22

Yes, perfect. That solved the problem. Thanks! :)


---

Comment by tscrim created at 2019-04-08 12:21:49

Replying to [comment:29 egourgoulhon]:
> To make it work, you should implement the method `_lmul_` in class `MixedForm` and add the line 
> {{{
>     if other is SR:
>         return True
> }}}
> in `MixedFormAlgebra._coerce_map_from_`. At least, this is what is done for the algebras of scalar fields: see line 512 of `src/sage/manifolds/scalarfield_algebra.py` and the definition of `_lmul_` in line 2449 of `src/sage/manifolds/scalarfield.py`.

I am a little worried about this. What about `_rmul_`? This also makes the dependence too strong on the base ring being `SR`. Can we use `if other is self.base_ring()` or something like that?


---

Comment by egourgoulhon created at 2019-04-08 12:56:46

Replying to [comment:31 tscrim]:
> 
> I am a little worried about this. What about `_rmul_`? 
>
I am puzzled now about the scalar field algebra implementation. Why do we have `_lmul_` and not `_rmul_`? Indeed, `__rmul__` is the standard Python operator for reflected operands and `__lmul__` does not exist in Python. What's exactly the role of `_lmul_` in Sage? I guess it is there for noncommutative base rings but I could not find a good place in the documentation explaining this... 
In the present case, both for scalar field and mixed form algebras, we are dealing with a base ring that is commutative (since it is a field), so shouldn't we have only `_rmul_`?


---

Comment by git created at 2019-04-08 14:54:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-04-08 14:59:24

Changing status from new to needs_review.


---

Comment by @DeRhamSource created at 2019-04-08 15:23:06

Replying to [comment:29 egourgoulhon]:
> To make it work, you should implement the method `_lmul_` in class `MixedForm` and add the line 
> {{{
>     if other is SR:
>         return True
> }}}
> in `MixedFormAlgebra._coerce_map_from_`. At least, this is what is done for the algebras of scalar fields: see line 512 of `src/sage/manifolds/scalarfield_algebra.py` and the definition of `_lmul_` in line 2449 of `src/sage/manifolds/scalarfield.py`.

I managed the coercion detection via


```
        if self._domain.scalar_field_algebra().has_coerce_map_from(S):
            return True
```


Does that also eliminate your doubts concerning the strong dependencies on SR, Travis?


---

Comment by egourgoulhon created at 2019-04-08 15:23:24

Replying to [comment:32 egourgoulhon]:
> Replying to [comment:31 tscrim]:
> > 
> > I am a little worried about this. What about `_rmul_`? 
> >
> I am puzzled now about the scalar field algebra implementation. Why do we have `_lmul_` and not `_rmul_`? Indeed, `__rmul__` is the standard Python operator for reflected operands and `__lmul__` does not exist in Python. What's exactly the role of `_lmul_` in Sage? I guess it is there for noncommutative base rings but I could not find a good place in the documentation explaining this... 
> In the present case, both for scalar field and mixed form algebras, we are dealing with a base ring that is commutative (since it is a field), so shouldn't we have only `_rmul_`?

I see in line 2394 of `src/sage/structure/element.pyx` that `_rmul_` falls back to `_lmul_`, which is not implemented at the `ModuleElement` level (actually returns `None`). This leaves the impression that when implementing a new module element class over a commutative ring, one shall actually implement `_lmul_` and not `_rmul_`...  Accordingly, my understanding at the moment is that in Sage, we have 
- `_mul_(self, other)` when `self` and `other` have the same parent
- `_lmul_(self, other)` when `self` and `other` have distinct parents
- `_rmul_(self, other)` is inherited from  `ModuleElement` (if not redefined) and falls back to `_lmul_`

Travis, do you confirm?


---

Comment by tscrim created at 2019-04-08 22:25:40

Replying to [comment:36 egourgoulhon]:
> Replying to [comment:32 egourgoulhon]:
> > Replying to [comment:31 tscrim]:
> > > 
> > > I am a little worried about this. What about `_rmul_`? 
> > >
> > I am puzzled now about the scalar field algebra implementation. Why do we have `_lmul_` and not `_rmul_`? Indeed, `__rmul__` is the standard Python operator for reflected operands and `__lmul__` does not exist in Python. What's exactly the role of `_lmul_` in Sage? I guess it is there for noncommutative base rings but I could not find a good place in the documentation explaining this... 
> > In the present case, both for scalar field and mixed form algebras, we are dealing with a base ring that is commutative (since it is a field), so shouldn't we have only `_rmul_`?
> 
> I see in line 2394 of `src/sage/structure/element.pyx` that `_rmul_` falls back to `_lmul_`, which is not implemented at the `ModuleElement` level (actually returns `None`). This leaves the impression that when implementing a new module element class over a commutative ring, one shall actually implement `_lmul_` and not `_rmul_`...  Accordingly, my understanding at the moment is that in Sage, we have 
> - `_mul_(self, other)` when `self` and `other` have the same parent
> - `_lmul_(self, other)` when `self` and `other` have distinct parents
> - `_rmul_(self, other)` is inherited from  `ModuleElement` (if not redefined) and falls back to `_lmul_`
> 
> Travis, do you confirm?

Ah, right, I forgot that generic `_rmul_` was implemented in `ModuleElement`.

So Sage's `_rmul_` should not be confused with Python's `__rmul__`.

Python's `__rmul__` is for when `self` knows how to multiply with `other` when `self` is on the right, but `other` does not. For instance, it handles `5 * self` because we cannot override the `int` type (which means the "standard `int.__mul__`" fails), but `self` knows what to do.

Sage's `_rmul_` and `_lmul_` play the same role, just on different sides. They are there to implement actions of `other` on `self` on the right or left, and thus are used by the coercion framework (in particular, they check if coercions can be applied).


---

Comment by tscrim created at 2019-04-08 22:27:17

Replying to [comment:35 gh-DeRhamSource]:
> Replying to [comment:29 egourgoulhon]:
> > To make it work, you should implement the method `_lmul_` in class `MixedForm` and add the line 
> > {{{
> >     if other is SR:
> >         return True
> > }}}
> > in `MixedFormAlgebra._coerce_map_from_`. At least, this is what is done for the algebras of scalar fields: see line 512 of `src/sage/manifolds/scalarfield_algebra.py` and the definition of `_lmul_` in line 2449 of `src/sage/manifolds/scalarfield.py`.
> 
> I managed the coercion detection via
> 
> {{{
>         if self._domain.scalar_field_algebra().has_coerce_map_from(S):
>             return True
> }}}
> 
> Does that also eliminate your doubts concerning the strong dependencies on SR, Travis?

Yes, I think that is better. Generally, I do not think it is a good idea to hardcode a ring unless you really only want to work with that ring (and my understanding is that this could be made more flexible in the future).


---

Comment by egourgoulhon created at 2019-04-09 22:32:05

There was a merge conflict with Sage 8.8.beta1 in the file `src/sage/manifolds/differentiable/manifold.py`. This was due to #27581 (initialization of the components of a tensor field while declaring it), which changed that file. The conflict is solved in the attached branch (since I am the author of #27581, it was probably easier that I solved this conflict, hence the new branch).
----
New commits:


---

Comment by egourgoulhon created at 2019-04-10 06:18:27

If you click on the patchbot button (marked "8.8.beta1") located at the right of the ticket title, you will access to the [patchbot reports](https://patchbot.sagemath.org/ticket/27584/). One of them is useless, due to some patchbot issue (the one marked "BuildFailed"). The most relevant one is from the patchbot "zancara". It indicates "TestFailed", but if you click either on "log" or "shortlog", you'll see that the failure occurs in a source file that has not been touched by this ticket: `src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py`. So this is more an issue on the patchbot size. The only relevant issue is the _pyflakes_ error marked by a red cross in the plugin list at the right of the summary of zancara's report: if you click on "diff", you get 

```
src/sage/manifolds/differentiable/mixed_form_algebra.py:31: 
'sage.rings.integer.Integer' imported but unused
```

Can you please correct this?
Note that you shall update your Sage version to 8.8.beta1. If this is not done already, it suffices to pull the new ticket branch and run 
`MAKE="make -j8" make`.


---

Comment by egourgoulhon created at 2019-04-10 06:30:58

Regarding the documentation: you have added doctests in the Python sources but the documentation is not generated since there is no entry to it in the sources of the reference manual. You shall modify/add files in `src/doc/en/reference/manifolds`, for instance in a way similar to what is done for differential forms, i.e. create a file `mixed_diff_form.rst` and add a pointer to it in `diff_manifold.rst`. To generate the documentation in a fast way, i.e. without having Sage process the whole reference manual, run

```
sage -docbuild reference/manifolds html
```



---

Comment by egourgoulhon created at 2019-04-10 08:13:45

Side remark: the bug that you've reported in https://groups.google.com/d/msg/sage-devel/EfLYpAxl_jU/ShlCS9L4BgAJ is fixed in Sage 8.8.beta1 (since #25576 has been merged in it).


---

Comment by @DeRhamSource created at 2019-04-10 13:16:55

Replying to [comment:41 egourgoulhon]:
> Regarding the documentation: you have added doctests in the Python sources but the documentation is not generated since there is no entry to it in the sources of the reference manual. You shall modify/add files in `src/doc/en/reference/manifolds`, for instance in a way similar to what is done for differential forms, i.e. create a file `mixed_diff_form.rst` and add a pointer to it in `diff_manifold.rst`. To generate the documentation in a fast way, i.e. without having Sage process the whole reference manual, run
> {{{
> sage -docbuild reference/manifolds html
> }}}

Unfortunately, I get some errors:



```
[manifolds] /home/michi/GitProjects/sage/src/sage_setup/docbuild/ext/sage_autodoc.py:1170: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature instead.
[manifolds]   return formatargspec(initmeth, *argspec)
[manifolds] /home/michi/GitProjects/sage/src/sage_setup/docbuild/ext/sage_autodoc.py:1406: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature instead.
[manifolds]   args = formatargspec(self.object, *argspec)
[manifolds] /home/michi/GitProjects/sage/src/sage_setup/docbuild/ext/sage_autodoc.py:1072: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature instead.
[manifolds]   args = formatargspec(self.object, *argspec)
...
OSError: /home/michi/GitProjects/sage/src/doc/en/reference/manifolds/index.rst:4: WARNING: undefined label: tensors-on-free-modules (if the link has no caption the label must precede a section header)
```


However, what comes next?


---

Comment by git created at 2019-04-10 13:35:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-10 13:38:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-10 13:57:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-04-12 08:38:13

Some debugging will be needed (if you haven't fixed them already). Also you should rebase this (and force push) to have more professional commit messages. `;)`


---

Comment by @DeRhamSource created at 2019-04-12 09:31:17

What should be debugged? I mean, the error above does not seem to have to do something with my implementation. Or does it?

Long story short: There is no error occuring anymore regarding the mixed algebra while building the doc.


---

Comment by egourgoulhon created at 2019-04-12 11:42:54

Replying to [comment:48 gh-DeRhamSource]:
> What should be debugged? I mean, the error above does not seem to have to do something with my implementation. Or does it?
> 
> Long story short: There is no error occuring anymore regarding the mixed algebra while building the doc. 

Yes but some parts of the documentation require some debugging: 

- a formula is not displayed because `.. MATH:` should be `.. MATH::` in line 45 of `mixed_form.py`
- in line 60 of the same file, there is an extra backquote around `comp`
- at the top of `mixed_form.py` you may want to replace `\Phi` by `\varphi` to be consistent with the rest of the text, as well as with `mixed_form_algebra.py`


---

Comment by git created at 2019-04-12 12:34:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-04-12 12:43:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @DeRhamSource created at 2019-04-12 12:48:14

My apologies for these confusing commits. I'm quite new to it.

However, I fixed the aforementioned issues.


---

Comment by tscrim created at 2019-04-12 23:37:47

I have a couple more comments, most of them are fairly minor:

In `_richcmp_`:

```
        from sage.structure.richcmp import richcmp

        # Compare all elements separately:
        for j in range(0, self._max_deg + 1):
```

move the import statement to the top-level (this is for speed reasons) and make `range(0, foo)` -> `range(foo)`.

Make `_mul_ = wedge` and maybe combine or reduce the doctests.

`degree $k$ along `\varphi`` replace `&` with ```.

Instead of using `self.__class__`, I have been told it is better to use `type(self)`.

Instead of `\`, my understanding is it is better to use `()` as that is guaranteed to generate an error if misused (as opposed to possibly a strange bug). For example

```diff
-                error_msg = "input must be a " \
-                            "differential form of degree {}".format(deg)
+                error_msg = ("input must be a "
+                             "differential form of degree {}".format(deg))
```


Typo: `datailed` -> `detailed`

I don't think you need the `self._populate_coercion_lists_()`.


---

Comment by git created at 2019-04-13 09:11:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-13 09:17:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-13 10:21:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-13 10:33:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-13 11:45:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-04-13 11:51:11

Thanks for your patience so far. Again, I changed a lot. Please check.

However, I noticed another error message that should not occur:


```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: f = M.scalar_field(x, name='f')
sage: f in M.diff_form_module(1)
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-38-9654b754d2bc> in <module>()
      2 X = M.chart(names=('x', 'y',)); (x, y,) = X._first_ngens(2)
      3 f = M.scalar_field(x, name='f')
----> 4 f in M.diff_form_module(Integer(1))

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__contains__ (build/cythonized/sage/structure/parent.c:9885)()
   1090             return True
   1091         try:
-> 1092             x2 = self(x)
   1093             EQ = (x2 == x)
   1094             if EQ is True:

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9219)()
    898         if mor is not None:
    899             if no_extra_args:
--> 900                 return mor._call_(x)
    901             else:
    902                 return mor._call_with_args(x, args, kwds)

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4551)()
    160                 print(type(C), C)
    161                 print(type(C._element_constructor), C._element_constructor)
--> 162             raise
    163 
    164     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4443)()
    155         cdef Parent C = self._codomain
    156         try:
--> 157             return C._element_constructor(x)
    158         except Exception:
    159             if print_warnings:

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/differentiable/diff_form_module.pyc in _element_constructor_(self, comp, frame, name, latex_name)
    818         resu = self.element_class(self._fmodule, self._degree, name=name,
    819                                   latex_name=latex_name)
--> 820         if comp != []:
    821             resu.set_comp(frame)[:] = comp
    822         return resu

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/scalarfield.pyc in __ne__(self, other)
   1285 
   1286         """
-> 1287         return not (self == other)
   1288 
   1289     ####### End of required methods for an algebra element (beside arithmetic) #######

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/scalarfield.pyc in __eq__(self, other)
   1244                 return False
   1245             try:
-> 1246                 other = self.parent()(other)  # conversion to a scalar field
   1247             except TypeError:
   1248                 return False

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9219)()
    898         if mor is not None:
    899             if no_extra_args:
--> 900                 return mor._call_(x)
    901             else:
    902                 return mor._call_with_args(x, args, kwds)

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4551)()
    160                 print(type(C), C)
    161                 print(type(C._element_constructor), C._element_constructor)
--> 162             raise
    163 
    164     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4443)()
    155         cdef Parent C = self._codomain
    156         try:
--> 157             return C._element_constructor(x)
    158         except Exception:
    159             if print_warnings:

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/scalarfield_algebra.pyc in _element_constructor_(self, coord_expression, chart, name, latex_name)
    470                                       coord_expression=coord_expression,
    471                                       name=name, latex_name=latex_name,
--> 472                                       chart=chart)
    473         return resu
    474 

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/differentiable/scalarfield.pyc in __init__(self, parent, coord_expression, chart, name, latex_name)
    630         """
    631         ScalarField.__init__(self, parent, coord_expression=coord_expression,
--> 632                              chart=chart, name=name, latex_name=latex_name)
    633         self._tensor_type = (0,0)
    634 

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/scalarfield.pyc in __init__(self, parent, coord_expression, chart, name, latex_name)
   1101                         self._express[ch] = ch.function(coord_expression)
   1102                 else:
-> 1103                     self._express[chart] = chart.function(coord_expression)
   1104         self._init_derived()   # initialization of derived quantities
   1105 

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/chart.pyc in function(self, expression, calc_method, expansion_symbol, order)
   1087         return parent.element_class(parent, expression, calc_method=calc_method,
   1088                                     expansion_symbol=expansion_symbol,
-> 1089                                     order=order)
   1090 
   1091     def zero_function(self):

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/chart_func.pyc in __init__(self, parent, expression, calc_method, expansion_symbol, order)
    360                 calc_method = self._calc_method._current
    361             self._express[calc_method] = self._calc_method._tranf[calc_method](
--> 362                                                                     expression)
    363         # Derived quantities:
    364         self._der = None  # list of partial derivatives (to be set by diff()

/home/michi/GitProjects/sage/local/lib/python2.7/site-packages/sage/manifolds/calculus_method.pyc in _Sympy_to_SR(expression)
    106         # If SR cannot transform a sympy expression this is because it is a
    107         # sympy abstract function
--> 108         a = expression._sage_()
    109         # As all sage objects have a ._sage_ operator, they have to be
    110         # catched

AttributeError: 'list' object has no attribute '_sage_'
```



---

Comment by git created at 2019-04-13 17:16:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-13 21:49:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-04-14 00:28:26

Does that second to last commit fix the issue in comment:59?


---

Comment by @DeRhamSource created at 2019-04-14 08:04:43

Replying to [comment:62 tscrim]:
> Does that second to last commit fix the issue in comment:59?

No. But now, I guess this has nothing to do with the mixed algebra. I already reported it in [sage-devel](https://groups.google.com/d/msg/sage-devel/wcIRe8UjuPo/mMRe-OR4CwAJ).


---

Comment by egourgoulhon created at 2019-04-14 09:06:59

Replying to [comment:63 gh-DeRhamSource]:
> Replying to [comment:62 tscrim]:
> > Does that second to last commit fix the issue in comment:59?
> 
> No. But now, I guess this has nothing to do with the mixed algebra. I already reported it in [sage-devel](https://groups.google.com/d/msg/sage-devel/wcIRe8UjuPo/mMRe-OR4CwAJ).

I confirm the error. I've opened #27658 for it.


---

Comment by egourgoulhon created at 2019-04-14 09:14:08

Replying to [comment:64 egourgoulhon]:
> Replying to [comment:63 gh-DeRhamSource]:
> > Replying to [comment:62 tscrim]:
> > > Does that second to last commit fix the issue in comment:59?
> > 
> > No. But now, I guess this has nothing to do with the mixed algebra. I already reported it in [sage-devel](https://groups.google.com/d/msg/sage-devel/wcIRe8UjuPo/mMRe-OR4CwAJ).
> 
> I confirm the error. I've opened #27658 for it.

While this is definitely a bug, you can get rid of it by replacing

```
f in M.diff_form_module(n)
```

by

```
f.domain() is M and f.degree() == n
```

for any integer `n`. Moreover the second form is must faster.


---

Comment by @DeRhamSource created at 2019-04-14 09:29:43

Fortunately, this issue is not directly relevant for my code anymore (since the error message was deleted). I've encountered the problem while debugging. :)


---

Comment by egourgoulhon created at 2019-04-14 09:48:39

Replying to [comment:66 gh-DeRhamSource]:
> Fortunately, this issue is not directly relevant for my code anymore (since the error message was deleted). I've encountered the problem while debugging. :)

Good!


---

Comment by @DeRhamSource created at 2019-04-16 09:11:17

Patchbot says no. :(

Though, there is no obvious error. So, what's the matter?

Any further suggestions?


---

Comment by tscrim created at 2019-04-16 12:55:20

That error from the patchbot looks unrelated, so I would treat the patchbot as coming back green.

Sorry, one more nitpick for readability:

```diff
-            return self._domain.is_subset(
-                S._domain) and self._ambient_domain.is_subset(S._ambient_domain)
+            return (self._domain.is_subset(S._domain)
+                    and self._ambient_domain.is_subset(S._ambient_domain))
```


Eric, any other comments?


---

Comment by egourgoulhon created at 2019-04-16 14:58:42

Replying to [comment:69 tscrim]:
> 
> Eric, any other comments?

Yes, there is a doctest error with Python3-built Sage: 

```
sage -t --long --warn-long 48.2 src/sage/manifolds/differentiable/mixed_form.py
**********************************************************************
File "src/sage/manifolds/differentiable/mixed_form.py", line 479, in sage.manifolds.differentiable.mixed_form.MixedForm.set_name
Failed example:
    F.set_name(name='fancy', latex_name='\eta'); F
Expected:
    Mixed differential form fancy on the 4-dimensional differentiable
     manifold M
Got:
    doctest:warning
    ...
    DeprecationWarning: invalid escape sequence \e
    Mixed differential form fancy on the 4-dimensional differentiable manifold M
**********************************************************************
```

You should replace `'\eta'` by `r'\eta'`. 

Apart from this, everything is OK for me.


---

Comment by git created at 2019-04-17 08:27:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DeRhamSource created at 2019-04-17 08:30:51

Anything else? :)

Otherwise I'd start programming the next part - namely characteristic classes.


---

Comment by egourgoulhon created at 2019-04-17 09:13:12

Replying to [comment:72 gh-DeRhamSource]:
> Anything else? :)
> 
> Otherwise I'd start programming the next part - namely characteristic classes.

Thanks for the update and your work on this. I am OK for the positive review. Travis, do you agree?


---

Comment by tscrim created at 2019-04-17 10:31:05

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-04-17 10:31:05

I concur.


---

Comment by vbraun created at 2019-04-18 19:56:42

Resolution: fixed
