# Issue 30268: tox.ini: Add `wsl` as a technology, to complement `local` and `docker`

archive/issues_030268.json:
```json
{
    "body": "CC:  @tobiasdiez tmonteil\n\nThis is for portability testing of the Sage distribution when developing on Windows, as an alternative to using Docker.\n\n`wsl` would be a \"technology\", like `local` or `docker` -\nhttps://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-docker-based-build-testing-using-tox\n\n(follow-up from #30216)\n\nIssue created by migration from https://trac.sagemath.org/ticket/30505\n\n",
    "created_at": "2020-09-04T15:04:31Z",
    "labels": [
        "porting",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "tox.ini: Add `wsl` as a technology, to complement `local` and `docker`",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30268",
    "user": "mkoeppe"
}
```
CC:  @tobiasdiez tmonteil

This is for portability testing of the Sage distribution when developing on Windows, as an alternative to using Docker.

`wsl` would be a "technology", like `local` or `docker` -
https://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-docker-based-build-testing-using-tox

(follow-up from #30216)

Issue created by migration from https://trac.sagemath.org/ticket/30505





---

archive/issue_comments_431596.json:
```json
{
    "body": "gh-tobiasdiez at https://github.com/sagemath/sage/pull/97:\nhttps://github.com/sagemath/sage/pull/97:\n\n> mkoeppe wrote:\n> > In the long run (on some follow up ticket), I think it would actually be good to push wsl provisioning down one level, into tox.ini, by defining environments such as wsl-ubuntu-focal-standard (in analogy to docker-ubuntu-focal-standard). So that on a Windows box, you would be able to just invoke tox to create an isolated wsl container that is only used for testing.\n>\n> I'm not sure how helpful it is to push it to the tox.ini. For me as a Windows user, WSL is the most convenient way to run sage. But for this I have a central WSL which I setup once and then reuse. Moreover, VS Code can connect to this WSL instance and run all commands trough it as needed. Thus, the workflow is different than say with docker containers.\n\nThis ticket is for a different purpose, namely portability testing - where you run Sage against various Linux distributions (and configurations, i.e., what system packages are installed). We do this with Docker, but on a Windows development box it may be more convenient to do it with isolated WSL instances instead.",
    "created_at": "2020-09-04T15:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431596",
    "user": "mkoeppe"
}
```

gh-tobiasdiez at https://github.com/sagemath/sage/pull/97:
https://github.com/sagemath/sage/pull/97:

> mkoeppe wrote:
> > In the long run (on some follow up ticket), I think it would actually be good to push wsl provisioning down one level, into tox.ini, by defining environments such as wsl-ubuntu-focal-standard (in analogy to docker-ubuntu-focal-standard). So that on a Windows box, you would be able to just invoke tox to create an isolated wsl container that is only used for testing.
>
> I'm not sure how helpful it is to push it to the tox.ini. For me as a Windows user, WSL is the most convenient way to run sage. But for this I have a central WSL which I setup once and then reuse. Moreover, VS Code can connect to this WSL instance and run all commands trough it as needed. Thus, the workflow is different than say with docker containers.

This ticket is for a different purpose, namely portability testing - where you run Sage against various Linux distributions (and configurations, i.e., what system packages are installed). We do this with Docker, but on a Windows development box it may be more convenient to do it with isolated WSL instances instead.



---

archive/issue_comments_431597.json:
```json
{
    "body": "Tobias, can we try to get this ticket going? Basically I want to add to the top-level tox.ini a way to create a new (isolated) WSL instance (with several options for the Linux distribution to use).",
    "created_at": "2020-11-14T23:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431597",
    "user": "mkoeppe"
}
```

Tobias, can we try to get this ticket going? Basically I want to add to the top-level tox.ini a way to create a new (isolated) WSL instance (with several options for the Linux distribution to use).



---

archive/issue_comments_431598.json:
```json
{
    "body": "What exactly do you want to accomplish? Do you want to add a tox command that downloads a given ubuntu distro, installs it as a wsl, installs sage including all dependencies and then run all tests in this wsl?\n\nIf that's the case, why do you want to manage the wsl installation from within tox? For integration tests, it would be easier to install wsl with a given linux distro in the github action and then run tox relative to this wsl. For development, it is also easier to let the user setup the initial wsl and reuse it. \n\n(By the way, the same also applies to docker images where you can easily run the github action jobs in a docker container and don't need to manage the container from tox, https://www.petefreitag.com/item/903.cfm. This should also somewhat speedup the workflow as github caches the container.)",
    "created_at": "2020-11-15T13:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431598",
    "user": "@tobiasdiez"
}
```

What exactly do you want to accomplish? Do you want to add a tox command that downloads a given ubuntu distro, installs it as a wsl, installs sage including all dependencies and then run all tests in this wsl?

If that's the case, why do you want to manage the wsl installation from within tox? For integration tests, it would be easier to install wsl with a given linux distro in the github action and then run tox relative to this wsl. For development, it is also easier to let the user setup the initial wsl and reuse it. 

(By the way, the same also applies to docker images where you can easily run the github action jobs in a docker container and don't need to manage the container from tox, https://www.petefreitag.com/item/903.cfm. This should also somewhat speedup the workflow as github caches the container.)



---

archive/issue_comments_431599.json:
```json
{
    "body": "Replying to [comment:6 gh-tobiasdiez]:\n> What exactly do you want to accomplish? Do you want to add a tox command that downloads a given ubuntu distro, installs it as a wsl, installs sage including all dependencies and then run all tests in this wsl?\n> \n> If that's the case, why do you want to manage the wsl installation from within tox? \n\nFor local testing and debugging of portability issues. GH Actions only goes so far, at some point one needs to get an actual local installation.\n\n> For development, it is also easier to let the user setup the initial wsl and reuse it. \n\nNo, the point is that the tox command will automate this step so that one has a reproducible way to set up a (disposable) wsl copy.  In other words, there is not \"the\" initial wsl but perhaps a dozen wsls with different configurations.  By default, a wsl would be reused but the developer would be able to set it up from scratch using `tox -r`.\n\nIt's the same automation win that the existing `docker-...` tox environments give us: Of course I can set up a Docker container, install packages with apt-get, and then run my tests of the Sage build in it. But with the tox this just becomes one command, `tox -e docker-ubuntu-bionic-standard`.",
    "created_at": "2020-11-15T18:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431599",
    "user": "mkoeppe"
}
```

Replying to [comment:6 gh-tobiasdiez]:
> What exactly do you want to accomplish? Do you want to add a tox command that downloads a given ubuntu distro, installs it as a wsl, installs sage including all dependencies and then run all tests in this wsl?
> 
> If that's the case, why do you want to manage the wsl installation from within tox? 

For local testing and debugging of portability issues. GH Actions only goes so far, at some point one needs to get an actual local installation.

> For development, it is also easier to let the user setup the initial wsl and reuse it. 

No, the point is that the tox command will automate this step so that one has a reproducible way to set up a (disposable) wsl copy.  In other words, there is not "the" initial wsl but perhaps a dozen wsls with different configurations.  By default, a wsl would be reused but the developer would be able to set it up from scratch using `tox -r`.

It's the same automation win that the existing `docker-...` tox environments give us: Of course I can set up a Docker container, install packages with apt-get, and then run my tests of the Sage build in it. But with the tox this just becomes one command, `tox -e docker-ubuntu-bionic-standard`.



---

archive/issue_comments_431600.json:
```json
{
    "body": "One question that I am unsure about: Where would `tox` come from in a typical Windows developer's system, and what shell would be used to execute the tox commands?",
    "created_at": "2020-11-15T18:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431600",
    "user": "mkoeppe"
}
```

One question that I am unsure about: Where would `tox` come from in a typical Windows developer's system, and what shell would be used to execute the tox commands?



---

archive/issue_comments_431601.json:
```json
{
    "body": "Thanks for your explanation. But I still don't really get why you need/want to manage the wsl installation via tox. If tox is able to configure a normal linux install, then it's only one additional step for the user to create a wsl installation with the said linux.\n\nMoreover, typical WSL installs are of the order of 2 to 5gb (mine is 22gb, which is used exclusively for sage). That's not something you would use in a use-once-then-throw-away spirit, like docker images.\n\nBut, of course, you could move the current code in the github wsl workflow to a new tox environment. As a first step towards this, and what I would find actually more important, is to have `local-ubuntu` environments similar to `local-homebrew`.\nThen you can simply install ubuntu in wsl via the Windows store, and run\n\n```\nwsl\n> tox -e local-ubuntu-standard\n```\n\nThat's the same amount of characters as `tox -e local-wsl-ubuntu-standard` ;-)\n\n\nReplying to [comment:8 mkoeppe]:\n> One question that I am unsure about: Where would `tox` come from in a typical Windows developer's system, and what shell would be used to execute the tox commands?\n\nYou would need to have a python installed in windows, then install tox via pip. Tox would usually be invoked from the \"Windows Command line\" or powershell console.",
    "created_at": "2020-11-15T23:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431601",
    "user": "@tobiasdiez"
}
```

Thanks for your explanation. But I still don't really get why you need/want to manage the wsl installation via tox. If tox is able to configure a normal linux install, then it's only one additional step for the user to create a wsl installation with the said linux.

Moreover, typical WSL installs are of the order of 2 to 5gb (mine is 22gb, which is used exclusively for sage). That's not something you would use in a use-once-then-throw-away spirit, like docker images.

But, of course, you could move the current code in the github wsl workflow to a new tox environment. As a first step towards this, and what I would find actually more important, is to have `local-ubuntu` environments similar to `local-homebrew`.
Then you can simply install ubuntu in wsl via the Windows store, and run

```
wsl
> tox -e local-ubuntu-standard
```

That's the same amount of characters as `tox -e local-wsl-ubuntu-standard` ;-)


Replying to [comment:8 mkoeppe]:
> One question that I am unsure about: Where would `tox` come from in a typical Windows developer's system, and what shell would be used to execute the tox commands?

You would need to have a python installed in windows, then install tox via pip. Tox would usually be invoked from the "Windows Command line" or powershell console.



---

archive/issue_comments_431602.json:
```json
{
    "body": "Replying to [comment:9 gh-tobiasdiez]:\n> of course, you could move the current code in the github wsl workflow to a new tox environment. As a first step towards this, and what I would find actually more important, is to have `local-ubuntu` environments similar to `local-homebrew`.\n> Then you can simply install ubuntu in wsl via the Windows store, and run\n> {{{\n> wsl\n> > tox -e local-ubuntu-standard\n> }}}\n> That's the same amount of characters as `tox -e local-wsl-ubuntu-standard` ;-)\n\nOK, sounds good, let's do this as the first step. That's now #30923",
    "created_at": "2020-11-15T23:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431602",
    "user": "mkoeppe"
}
```

Replying to [comment:9 gh-tobiasdiez]:
> of course, you could move the current code in the github wsl workflow to a new tox environment. As a first step towards this, and what I would find actually more important, is to have `local-ubuntu` environments similar to `local-homebrew`.
> Then you can simply install ubuntu in wsl via the Windows store, and run
> {{{
> wsl
> > tox -e local-ubuntu-standard
> }}}
> That's the same amount of characters as `tox -e local-wsl-ubuntu-standard` ;-)

OK, sounds good, let's do this as the first step. That's now #30923



---

archive/issue_comments_431603.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30268#issuecomment-431603",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
