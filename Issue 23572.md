# Issue 23572: Fix normalization for morphisms defined over QQbar in canonical_height

archive/issues_023572.json:
```json
{
    "body": "CC:  @bhutz\n\nKeywords: canonical height\n\nGiven a projective dynamical system defined over QQbar, when we compute the canonical height of a point, we first find a number field where the point and function are both defined. Unfortunately while the resultant of this map was normalized, its coordinates were not necessarily normalized. This resulted in errors like this:\n\n```python\nm=3\nK.<v>=CyclotomicField(m)\nP.<x,y>=ProjectiveSpace(K,1)\nH=End(P)\nf=DynamicalSystem_projective([3*y^2,-3*x^2])\nf.is_post_critically_finite() # returns true \nf.change_ring(QQbar)\nf.is_post_critically_finite() # returns false\n```\n\nThe reason is that when the function is defined over K, and then changed to QQbar, it remains in the form (3x^2, -3y^2), but when the resultant is computed with normalize=True, we are really computing the resultant of (x<sup>2,-y</sup>2), which is what normalize_coordinates on f should have returned, but did not. As a result, when computing the local height of the critical points:\n\n```python\nP, Q = f.critical_points()\nf.canonical_height(P) # returns log(3) = 1.0642806546472312635391438233\n#when it should be 0\n```\n\nWe fix this behavior by normalizing the coordinates of f after defining it over the appropriate number field. \n\nWe also optimize a bit by checking if Wells' algorithm over QQ can be used *after* converting from QQbar to a number field, rather than *before* as it used to do. \n\nIssue created by migration from https://trac.sagemath.org/ticket/23809\n\n",
    "created_at": "2017-09-08T18:46:20Z",
    "labels": [
        "dynamics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fix normalization for morphisms defined over QQbar in canonical_height",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23572",
    "user": "@pfili"
}
```
CC:  @bhutz

Keywords: canonical height

Given a projective dynamical system defined over QQbar, when we compute the canonical height of a point, we first find a number field where the point and function are both defined. Unfortunately while the resultant of this map was normalized, its coordinates were not necessarily normalized. This resulted in errors like this:

```python
m=3
K.<v>=CyclotomicField(m)
P.<x,y>=ProjectiveSpace(K,1)
H=End(P)
f=DynamicalSystem_projective([3*y^2,-3*x^2])
f.is_post_critically_finite() # returns true 
f.change_ring(QQbar)
f.is_post_critically_finite() # returns false
```

The reason is that when the function is defined over K, and then changed to QQbar, it remains in the form (3x^2, -3y^2), but when the resultant is computed with normalize=True, we are really computing the resultant of (x<sup>2,-y</sup>2), which is what normalize_coordinates on f should have returned, but did not. As a result, when computing the local height of the critical points:

```python
P, Q = f.critical_points()
f.canonical_height(P) # returns log(3) = 1.0642806546472312635391438233
#when it should be 0
```

We fix this behavior by normalizing the coordinates of f after defining it over the appropriate number field. 

We also optimize a bit by checking if Wells' algorithm over QQ can be used *after* converting from QQbar to a number field, rather than *before* as it used to do. 

Issue created by migration from https://trac.sagemath.org/ticket/23809





---

archive/issue_comments_330246.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-08T18:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330246",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330247.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-08T18:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330247",
    "user": "@pfili"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_330248.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-08T21:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330248",
    "user": "@bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_330249.json:
```json
{
    "body": "Just one thing here. I think returning a negative value is not good. If the negative value is within error bound of 0, I'd be tempted to return 0. If the negative value is beyond the error, then some kind of error should be raised as something went very wrong.",
    "created_at": "2017-09-08T21:49:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330249",
    "user": "@bhutz"
}
```

Just one thing here. I think returning a negative value is not good. If the negative value is within error bound of 0, I'd be tempted to return 0. If the negative value is beyond the error, then some kind of error should be raised as something went very wrong.



---

archive/issue_comments_330250.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-09T16:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330250",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330251.json:
```json
{
    "body": "Thanks for the suggestion, Ben! I have included code to handle the case of Wells' algorithm returning a negative value now. (It does a sanity check that the negative is within the error from 0 as well and raises a ValueError in the hopefully impossible case of it begin less than -error_bound.)",
    "created_at": "2017-09-09T17:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330251",
    "user": "@pfili"
}
```

Thanks for the suggestion, Ben! I have included code to handle the case of Wells' algorithm returning a negative value now. (It does a sanity check that the negative is within the error from 0 as well and raises a ValueError in the hopefully impossible case of it begin less than -error_bound.)



---

archive/issue_comments_330252.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-09T17:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330252",
    "user": "@pfili"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_330253.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-09T17:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330253",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330254.json:
```json
{
    "body": "Doc tests have been updated, this should be good to go.",
    "created_at": "2017-09-09T17:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330254",
    "user": "@pfili"
}
```

Doc tests have been updated, this should be good to go.



---

archive/issue_comments_330255.json:
```json
{
    "body": "This looks fine to me except I think an assertion is better. If this is fine with you go ahead and mark it positive.\n----\nNew commits:",
    "created_at": "2017-09-09T18:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330255",
    "user": "@bhutz"
}
```

This looks fine to me except I think an assertion is better. If this is fine with you go ahead and mark it positive.
----
New commits:



---

archive/issue_comments_330256.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-09T18:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330256",
    "user": "@pfili"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330257.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-09-11T23:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330257",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_330258.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-09-11T23:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330258",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_330259.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-11T23:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330259",
    "user": "@bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_330260.json:
```json
{
    "body": "merge conflict",
    "created_at": "2017-09-11T23:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330260",
    "user": "@bhutz"
}
```

merge conflict



---

archive/issue_comments_330261.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-11T23:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330261",
    "user": "@bhutz"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_330262.json:
```json
{
    "body": "Paul, Just double check I didn't mess it up fixing the merge conflict",
    "created_at": "2017-09-11T23:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330262",
    "user": "@bhutz"
}
```

Paul, Just double check I didn't mess it up fixing the merge conflict



---

archive/issue_comments_330263.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-14T15:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330263",
    "user": "@pfili"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330264.json:
```json
{
    "body": "Looks good!",
    "created_at": "2017-09-14T15:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330264",
    "user": "@pfili"
}
```

Looks good!



---

archive/issue_comments_330265.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-18T22:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23572#issuecomment-330265",
    "user": "@vbraun"
}
```

Resolution: fixed
