# Issue 23572: Fix normalization for morphisms defined over QQbar in canonical_height

Issue created by migration from https://trac.sagemath.org/ticket/23809

Original creator: paulfili

Original creation time: 2017-09-08 18:46:20

CC:  bhutz

Keywords: canonical height

Given a projective dynamical system defined over QQbar, when we compute the canonical height of a point, we first find a number field where the point and function are both defined. Unfortunately while the resultant of this map was normalized, its coordinates were not necessarily normalized. This resulted in errors like this:

```python
m=3
K.<v>=CyclotomicField(m)
P.<x,y>=ProjectiveSpace(K,1)
H=End(P)
f=DynamicalSystem_projective([3*y^2,-3*x^2])
f.is_post_critically_finite() # returns true 
f.change_ring(QQbar)
f.is_post_critically_finite() # returns false
```

The reason is that when the function is defined over K, and then changed to QQbar, it remains in the form (3x^2, -3y^2), but when the resultant is computed with normalize=True, we are really computing the resultant of (x<sup>2,-y</sup>2), which is what normalize_coordinates on f should have returned, but did not. As a result, when computing the local height of the critical points:

```python
P, Q = f.critical_points()
f.canonical_height(P) # returns log(3) = 1.0642806546472312635391438233
#when it should be 0
```

We fix this behavior by normalizing the coordinates of f after defining it over the appropriate number field. 

We also optimize a bit by checking if Wells' algorithm over QQ can be used *after* converting from QQbar to a number field, rather than *before* as it used to do. 


---

Comment by git created at 2017-09-08 18:47:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulfili created at 2017-09-08 18:48:27

Changing status from new to needs_review.


---

Comment by bhutz created at 2017-09-08 21:49:17

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2017-09-08 21:49:17

Just one thing here. I think returning a negative value is not good. If the negative value is within error bound of 0, I'd be tempted to return 0. If the negative value is beyond the error, then some kind of error should be raised as something went very wrong.


---

Comment by git created at 2017-09-09 16:58:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulfili created at 2017-09-09 17:00:05

Thanks for the suggestion, Ben! I have included code to handle the case of Wells' algorithm returning a negative value now. (It does a sanity check that the negative is within the error from 0 as well and raises a ValueError in the hopefully impossible case of it begin less than -error_bound.)


---

Comment by paulfili created at 2017-09-09 17:00:05

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-09-09 17:46:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulfili created at 2017-09-09 17:48:17

Doc tests have been updated, this should be good to go.


---

Comment by bhutz created at 2017-09-09 18:12:54

This looks fine to me except I think an assertion is better. If this is fine with you go ahead and mark it positive.
----
New commits:


---

Comment by paulfili created at 2017-09-09 18:18:12

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-09-11 23:33:34

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-09-11 23:33:34

Changing status from positive_review to needs_review.


---

Comment by bhutz created at 2017-09-11 23:34:05

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2017-09-11 23:34:05

merge conflict


---

Comment by bhutz created at 2017-09-11 23:34:33

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2017-09-11 23:34:33

Paul, Just double check I didn't mess it up fixing the merge conflict


---

Comment by paulfili created at 2017-09-14 15:07:04

Changing status from needs_review to positive_review.


---

Comment by paulfili created at 2017-09-14 15:07:04

Looks good!


---

Comment by vbraun created at 2017-09-18 22:15:29

Resolution: fixed
