# Issue 25590: py3: some care for round

archive/issues_025590.json:
```json
{
    "body": "CC:  jdemeyer tscrim\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25827\n\n",
    "created_at": "2018-07-11T15:49:24Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "title": "py3: some care for round",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25590",
    "user": "chapoton"
}
```
CC:  jdemeyer tscrim



Issue created by migration from https://trac.sagemath.org/ticket/25827





---

archive/issue_comments_360759.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-11T15:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360759",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_360760.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-11T15:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360760",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_360761.json:
```json
{
    "body": "Not sure what to do. This is not curing the disease. It seems that python3 builtin \"round\" is looking for `__round__`, unlike python2.",
    "created_at": "2018-07-12T09:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360761",
    "user": "chapoton"
}
```

Not sure what to do. This is not curing the disease. It seems that python3 builtin "round" is looking for `__round__`, unlike python2.



---

archive/issue_comments_360762.json:
```json
{
    "body": "failing doctests",
    "created_at": "2018-07-12T13:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360762",
    "user": "chapoton"
}
```

failing doctests



---

archive/issue_comments_360763.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-12T13:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360763",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_360764.json:
```json
{
    "body": "I've implemented a few `__round__` in my python3 branch.  I'll see about making a ticket for those.",
    "created_at": "2018-07-26T16:35:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360764",
    "user": "embray"
}
```

I've implemented a few `__round__` in my python3 branch.  I'll see about making a ticket for those.



---

archive/issue_comments_360765.json:
```json
{
    "body": "`@`embray, where is your latest python3 branch ? could you please provide a branch for here, with the implemented `__round__` ?",
    "created_at": "2018-09-03T19:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360765",
    "user": "chapoton"
}
```

`@`embray, where is your latest python3 branch ? could you please provide a branch for here, with the implemented `__round__` ?



---

archive/issue_comments_360766.json:
```json
{
    "body": "Ok, I'll try to get back to you about that soon.",
    "created_at": "2018-09-04T09:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360766",
    "user": "embray"
}
```

Ok, I'll try to get back to you about that soon.



---

archive/issue_comments_360767.json:
```json
{
    "body": "I think we need to think about exactly how to implement Sage's `round()` built-in as well.  Currently, some types in Sage have a `.round()` method which takes no arguments, and only rounds to an integer--in particular it always rounds up, it seems.\n\nI find this a bit odd, but maybe there's a good reason. I wonder, because I find it surprising that `RealNumber.round()` does *not* take into account the MPFR rounding mode of the parent field.  Why is that?  Is it just for consistency's sake--that all real and floating-point numbers round up the same way?\n\nI implemented a `RealNumber.__round__()` which takes into account the parent field's rounding mode, and works quite nicely, though it's *incompatible* with Sage's `round()` built-in which just calls `RealNumber.round()` for integer results.  So when rounding to the nearest int you get one rounding behavior, but in other cases you get a different rounding behavior.\n\nSo two questions:\n\n1. Is there any reason to have a `RealNumber.__round__()` that respects the parent field's rounding mode?  It seems to make sense, but maybe it contradicts other assumptions in Sage that I'm not aware of.\n\n2. Should we add an argument to `.round()` methods and make them equivalent to `.__round__()`?  Or do we add a separate `.__round__()`, and make `.round()` just a special case equivalent to calling `__round__()` with no arguments?",
    "created_at": "2018-09-04T10:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360767",
    "user": "embray"
}
```

I think we need to think about exactly how to implement Sage's `round()` built-in as well.  Currently, some types in Sage have a `.round()` method which takes no arguments, and only rounds to an integer--in particular it always rounds up, it seems.

I find this a bit odd, but maybe there's a good reason. I wonder, because I find it surprising that `RealNumber.round()` does *not* take into account the MPFR rounding mode of the parent field.  Why is that?  Is it just for consistency's sake--that all real and floating-point numbers round up the same way?

I implemented a `RealNumber.__round__()` which takes into account the parent field's rounding mode, and works quite nicely, though it's *incompatible* with Sage's `round()` built-in which just calls `RealNumber.round()` for integer results.  So when rounding to the nearest int you get one rounding behavior, but in other cases you get a different rounding behavior.

So two questions:

1. Is there any reason to have a `RealNumber.__round__()` that respects the parent field's rounding mode?  It seems to make sense, but maybe it contradicts other assumptions in Sage that I'm not aware of.

2. Should we add an argument to `.round()` methods and make them equivalent to `.__round__()`?  Or do we add a separate `.__round__()`, and make `.round()` just a special case equivalent to calling `__round__()` with no arguments?



---

archive/issue_comments_360768.json:
```json
{
    "body": "So far in sage, almost no round method takes a second argument:\n\n```\ngit grep \" round(self\" src/sage\nsrc/sage/matrix/matrix_double_dense.pyx:    def round(self, ndigits=0):\nsrc/sage/rings/complex_arb.pyx:    def round(self):\nsrc/sage/rings/number_field/number_field_element.pyx:    def round(self):\nsrc/sage/rings/number_field/number_field_element_quadratic.pyx:    def round(self):\nsrc/sage/rings/qqbar.py:    def round(self):\nsrc/sage/rings/real_arb.pyx:    def round(self):\nsrc/sage/rings/real_double.pyx:    def round(self):\nsrc/sage/rings/real_mpfi.pyx:    def round(self):\nsrc/sage/rings/real_mpfr.pyx:    def round(self):\nsrc/sage/symbolic/expression.pyx:    def round(self):\n```\n",
    "created_at": "2018-09-11T19:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360768",
    "user": "chapoton"
}
```

So far in sage, almost no round method takes a second argument:

```
git grep " round(self" src/sage
src/sage/matrix/matrix_double_dense.pyx:    def round(self, ndigits=0):
src/sage/rings/complex_arb.pyx:    def round(self):
src/sage/rings/number_field/number_field_element.pyx:    def round(self):
src/sage/rings/number_field/number_field_element_quadratic.pyx:    def round(self):
src/sage/rings/qqbar.py:    def round(self):
src/sage/rings/real_arb.pyx:    def round(self):
src/sage/rings/real_double.pyx:    def round(self):
src/sage/rings/real_mpfi.pyx:    def round(self):
src/sage/rings/real_mpfr.pyx:    def round(self):
src/sage/symbolic/expression.pyx:    def round(self):
```




---

archive/issue_comments_360769.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-03T14:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360769",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360770.json:
```json
{
    "body": "ok, here is a new branch, just adding some aliases `__round__` redirecting to `round`. I propose to simply do that for the moment, in order to advance the move towards python3.\n\n**EDIT**: still missing would be `__round__` for Integer class",
    "created_at": "2018-10-03T14:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360770",
    "user": "chapoton"
}
```

ok, here is a new branch, just adding some aliases `__round__` redirecting to `round`. I propose to simply do that for the moment, in order to advance the move towards python3.

**EDIT**: still missing would be `__round__` for Integer class



---

archive/issue_comments_360771.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-10-03T14:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360771",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_360772.json:
```json
{
    "body": "I would really rather think about this more carefully, and perhaps rework how Sage's built-in `round()` function works (or maybe even get rid of it entirely, at least on Python 3, if the new `__round__` special makes it obsolete.  Not clear.  And thoughts on my last comment?",
    "created_at": "2018-10-03T15:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360772",
    "user": "embray"
}
```

I would really rather think about this more carefully, and perhaps rework how Sage's built-in `round()` function works (or maybe even get rid of it entirely, at least on Python 3, if the new `__round__` special makes it obsolete.  Not clear.  And thoughts on my last comment?



---

archive/issue_comments_360773.json:
```json
{
    "body": "> So far in sage, almost no round method takes a second argument:\n\nThat's because it's really meant to mean round-to-the-nearest-integer, which is simpler than what Python's built-in round does, which can return a float truncated to N digits, or an integer.  Just making `__round__` point to some of these class's old `round` methods is broken.\n\nThere's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.",
    "created_at": "2018-10-03T15:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360773",
    "user": "embray"
}
```

> So far in sage, almost no round method takes a second argument:

That's because it's really meant to mean round-to-the-nearest-integer, which is simpler than what Python's built-in round does, which can return a float truncated to N digits, or an integer.  Just making `__round__` point to some of these class's old `round` methods is broken.

There's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.



---

archive/issue_comments_360774.json:
```json
{
    "body": "> There's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.\n\nThose do not appear in the python3 log.",
    "created_at": "2018-10-03T15:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360774",
    "user": "chapoton"
}
```

> There's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.

Those do not appear in the python3 log.



---

archive/issue_comments_360775.json:
```json
{
    "body": "FWIW here's my implementation for MPFR reals:\n\n\n```diff\ndiff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx\nindex 9b90c88..a82c4eb 100644\n--- a/src/sage/rings/real_mpfr.pyx\n+++ b/src/sage/rings/real_mpfr.pyx\n@@ -3040,6 +3040,38 @@ cdef class RealNumber(sage.structure.element.RingElement)\n         \"\"\"\n         return mpfr_get_d(self.value, (<RealField_class>self._parent).rnd)\n+    def __round__(self, ndigits=0):\n+        \"\"\"\n+        Implement support for Python 3's `round` builtin.\n+\n+        This is mostly equivalent to simply calling ``round(float(x),\n+        ndigits)`` where ``x`` is a `RealNumber`.  The difference is that it is\n+        still returns an arbitrary-precision `RealNumber` of precision\n+        equivalent to ``self`` (or an `Integer` if ``ndigits=0``).  It also\n+        uses the rounding mode specified on the parent field.\n+\n+        EXAMPLES::\n+\n+            TODO\n+        \"\"\"\n+        cdef Integer z\n+        cdef RealNumber r\n+        cdef char* s\n+\n+        if ndigits < 0:\n+            return (<RealField_class>self._parent).zero()\n+        elif ndigits == 0:\n+            z = PY_NEW(Integer)\n+            mpfr_get_z(z.value, self.value, (<RealField_class>self._parent).rnd\n+            return z\n+        else:\n+            rnd = (<RealField_class>self._parent).rnd\n+            mpfr_asprintf(&s, \"%.*R*f\", <int>ndigits, rnd, self.value)\n+            r = self._new()\n+            mpfr_set_str(r.value, s, 10, rnd)\n+            mpfr_free_str(s)\n+            return r\n+\n```\n\n\nBut I'm not 100% sure if it makes sense to do things this way or not (and it needs examples).  However, it's broken with Sage's `round()` global built-in, because that tries to call a class's `.round()` method first if it exists.  And in fact `RealNumber` does have an existing `.round()` method that's different and doesn't take into account the field's rounding mode as my above implementation does.\n\nIf anything `.round()` should be the same as `.__round__(n=0)`; that or `.round()` grows an optional extra argument.",
    "created_at": "2018-10-03T15:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360775",
    "user": "embray"
}
```

FWIW here's my implementation for MPFR reals:


```diff
diff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx
index 9b90c88..a82c4eb 100644
--- a/src/sage/rings/real_mpfr.pyx
+++ b/src/sage/rings/real_mpfr.pyx
@@ -3040,6 +3040,38 @@ cdef class RealNumber(sage.structure.element.RingElement)
         """
         return mpfr_get_d(self.value, (<RealField_class>self._parent).rnd)
+    def __round__(self, ndigits=0):
+        """
+        Implement support for Python 3's `round` builtin.
+
+        This is mostly equivalent to simply calling ``round(float(x),
+        ndigits)`` where ``x`` is a `RealNumber`.  The difference is that it is
+        still returns an arbitrary-precision `RealNumber` of precision
+        equivalent to ``self`` (or an `Integer` if ``ndigits=0``).  It also
+        uses the rounding mode specified on the parent field.
+
+        EXAMPLES::
+
+            TODO
+        """
+        cdef Integer z
+        cdef RealNumber r
+        cdef char* s
+
+        if ndigits < 0:
+            return (<RealField_class>self._parent).zero()
+        elif ndigits == 0:
+            z = PY_NEW(Integer)
+            mpfr_get_z(z.value, self.value, (<RealField_class>self._parent).rnd
+            return z
+        else:
+            rnd = (<RealField_class>self._parent).rnd
+            mpfr_asprintf(&s, "%.*R*f", <int>ndigits, rnd, self.value)
+            r = self._new()
+            mpfr_set_str(r.value, s, 10, rnd)
+            mpfr_free_str(s)
+            return r
+
```


But I'm not 100% sure if it makes sense to do things this way or not (and it needs examples).  However, it's broken with Sage's `round()` global built-in, because that tries to call a class's `.round()` method first if it exists.  And in fact `RealNumber` does have an existing `.round()` method that's different and doesn't take into account the field's rounding mode as my above implementation does.

If anything `.round()` should be the same as `.__round__(n=0)`; that or `.round()` grows an optional extra argument.



---

archive/issue_comments_360776.json:
```json
{
    "body": "Perhaps it is a question that needs to be brought up on sage-devel, if we don't know the answers.\n\nFor example, why does Sage have its own `round()` built-in in the first place (at least part of the answer to that question seems to be exactly that something like `__round__` did not exist in the first place)?  Do we still need it, or at least, do we need it with Python 3?  Do we like the semantics of Python's round or would we rather replace it with something else?  To what extent do we want to support those semantics of different class's `.round()` *methods*?  Etc...",
    "created_at": "2018-10-03T15:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360776",
    "user": "embray"
}
```

Perhaps it is a question that needs to be brought up on sage-devel, if we don't know the answers.

For example, why does Sage have its own `round()` built-in in the first place (at least part of the answer to that question seems to be exactly that something like `__round__` did not exist in the first place)?  Do we still need it, or at least, do we need it with Python 3?  Do we like the semantics of Python's round or would we rather replace it with something else?  To what extent do we want to support those semantics of different class's `.round()` *methods*?  Etc...



---

archive/issue_comments_360777.json:
```json
{
    "body": "I have made #26412 for the same thing in integer.pyx",
    "created_at": "2018-10-05T11:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360777",
    "user": "chapoton"
}
```

I have made #26412 for the same thing in integer.pyx



---

archive/issue_comments_360778.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-14T10:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360778",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_360779.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-20T13:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360779",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_360780.json:
```json
{
    "body": "new tentative based on Erik's suggested patch\n----\nNew commits:",
    "created_at": "2018-12-20T13:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360780",
    "user": "chapoton"
}
```

new tentative based on Erik's suggested patch
----
New commits:



---

archive/issue_comments_360781.json:
```json
{
    "body": "bot is morally green..",
    "created_at": "2018-12-30T10:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360781",
    "user": "chapoton"
}
```

bot is morally green..



---

archive/issue_comments_360782.json:
```json
{
    "body": "I'm happy with the `__round__` implementation of course, since I wrote it.  But part of why I never submitted it in the first place is that I'm not totally confident with this course of action.\n\nIn particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?\n\nThere's also a problem  that this `__round__` is ignored anyways (as you can see by writing the tests to use the `round()` global instead of calling `__round__()` directly).  The problem is that Sage's `round()` just ends up calling `RealNumber.round()` instead of `RealNumber.__round__()` and thus ignores the rounding mode, so this code effectively never gets used.\n\nThis is why I keep saying we maybe need to rethink the behavior of Sage's built-in `round()`.  I'm starting to think that for Python 3 we might opt to just remove it entirely, or make it an alias for the Python built-in `round()`, since now we can override its behavior on different types by supplying `__round__()`, whereas previously we had to use this hack to override rounding on different types.",
    "created_at": "2018-12-31T11:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360782",
    "user": "embray"
}
```

I'm happy with the `__round__` implementation of course, since I wrote it.  But part of why I never submitted it in the first place is that I'm not totally confident with this course of action.

In particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?

There's also a problem  that this `__round__` is ignored anyways (as you can see by writing the tests to use the `round()` global instead of calling `__round__()` directly).  The problem is that Sage's `round()` just ends up calling `RealNumber.round()` instead of `RealNumber.__round__()` and thus ignores the rounding mode, so this code effectively never gets used.

This is why I keep saying we maybe need to rethink the behavior of Sage's built-in `round()`.  I'm starting to think that for Python 3 we might opt to just remove it entirely, or make it an alias for the Python built-in `round()`, since now we can override its behavior on different types by supplying `__round__()`, whereas previously we had to use this hack to override rounding on different types.



---

archive/issue_comments_360783.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-12-31T11:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360783",
    "user": "embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_360784.json:
```json
{
    "body": "I also think that the test for this should demonstrate the fact that parent's rounding mode is considered.  For example, demonstrate that with `RNDN` 2.5 is rounded to 2, while with `RNDU` it is rounded to 3.",
    "created_at": "2018-12-31T11:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360784",
    "user": "embray"
}
```

I also think that the test for this should demonstrate the fact that parent's rounding mode is considered.  For example, demonstrate that with `RNDN` 2.5 is rounded to 2, while with `RNDU` it is rounded to 3.



---

archive/issue_comments_360785.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-31T19:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360785",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360786.json:
```json
{
    "body": "Would it be ok to make the current `round` method an alias for the new `__round__` method (just in this file for this kind of real numbers) ?",
    "created_at": "2019-01-09T12:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360786",
    "user": "chapoton"
}
```

Would it be ok to make the current `round` method an alias for the new `__round__` method (just in this file for this kind of real numbers) ?



---

archive/issue_comments_360787.json:
```json
{
    "body": "Try it and see.  I believe it would work--look at the definition of `round` in `sage.misc.functional`.\n\nIt still doesn't answer my question though:\n\n> In particular, why does `RealNumber.round` ignore the rounding mode of the parent field? Is there some good reason for that? If so, then why would `RealNumber.__round__` not ignore it?\n\nI think that what you propose makes sense, but it would be a change in behavior (see the `round(2.5)` case) which I wouldn't want to make lightly unless nobody can provide a good explanation for the current behavior.  This is what I keep trying to tell you.  If neither of us know a reason for the current behavior then we need to find out who does know and ask them.",
    "created_at": "2019-01-09T14:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360787",
    "user": "embray"
}
```

Try it and see.  I believe it would work--look at the definition of `round` in `sage.misc.functional`.

It still doesn't answer my question though:

> In particular, why does `RealNumber.round` ignore the rounding mode of the parent field? Is there some good reason for that? If so, then why would `RealNumber.__round__` not ignore it?

I think that what you propose makes sense, but it would be a change in behavior (see the `round(2.5)` case) which I wouldn't want to make lightly unless nobody can provide a good explanation for the current behavior.  This is what I keep trying to tell you.  If neither of us know a reason for the current behavior then we need to find out who does know and ask them.



---

archive/issue_comments_360788.json:
```json
{
    "body": "Replying to [comment:23 embray]:\n> In particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?\n\nMy understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to *integers*, each in the way (\u2248 with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.",
    "created_at": "2019-02-01T12:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360788",
    "user": "mmezzarobba"
}
```

Replying to [comment:23 embray]:
> In particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?

My understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to *integers*, each in the way (≈ with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.



---

archive/issue_comments_360789.json:
```json
{
    "body": "Replying to [comment:28 mmezzarobba]:\n> Replying to [comment:23 embray]:\n> > In particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?\n> \n> My understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to *integers*, each in the way (\u2248 with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.\n\nCould you please be more specific?  Are you talking about the Python stdlib or Sage?  The fact is that the `round()` function in Python (and by extension in Sage) does allow rounding to N decimal digits.\n\nI appreciate the effort to bring clarity to this question but to me this comment only muddies the waters.",
    "created_at": "2019-02-01T13:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360789",
    "user": "embray"
}
```

Replying to [comment:28 mmezzarobba]:
> Replying to [comment:23 embray]:
> > In particular, why does `RealNumber.round` *ignore* the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?
> 
> My understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to *integers*, each in the way (≈ with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.

Could you please be more specific?  Are you talking about the Python stdlib or Sage?  The fact is that the `round()` function in Python (and by extension in Sage) does allow rounding to N decimal digits.

I appreciate the effort to bring clarity to this question but to me this comment only muddies the waters.



---

archive/issue_comments_360790.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> Could you please be more specific?  Are you talking about the Python stdlib or Sage?\n\nBoth, I guess. What I'm trying to say (and I think it answers your question, but I haven't read the rest of the ticket, so perhaps I'm misunderstanding the issue) is that:\n* The `round()` *functions* (both the builtin and the one in `sage.functional`) round to a given precision. From my point of view, making them honor the parent's rounding mode when their argument already is a `RealNumber` would be an improvement.\n* The `round()` *methods* of `RealNumber` and several other element classes, however, are unrelated. They are for rounding to the nearest integer; and rounding up or down or whatever else is done with other methods.",
    "created_at": "2019-02-01T13:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360790",
    "user": "mmezzarobba"
}
```

Replying to [comment:29 embray]:
> Could you please be more specific?  Are you talking about the Python stdlib or Sage?

Both, I guess. What I'm trying to say (and I think it answers your question, but I haven't read the rest of the ticket, so perhaps I'm misunderstanding the issue) is that:
* The `round()` *functions* (both the builtin and the one in `sage.functional`) round to a given precision. From my point of view, making them honor the parent's rounding mode when their argument already is a `RealNumber` would be an improvement.
* The `round()` *methods* of `RealNumber` and several other element classes, however, are unrelated. They are for rounding to the nearest integer; and rounding up or down or whatever else is done with other methods.



---

archive/issue_comments_360791.json:
```json
{
    "body": "Okay, thank you.  That's a bit clearer.  Though I don't quite understand \"rounding up or down or whatever else is done with other methods\".  Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)\n\nAnd should the `round()` *function* ever call an element's `.round()` *method*?",
    "created_at": "2019-02-01T14:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360791",
    "user": "embray"
}
```

Okay, thank you.  That's a bit clearer.  Though I don't quite understand "rounding up or down or whatever else is done with other methods".  Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)

And should the `round()` *function* ever call an element's `.round()` *method*?



---

archive/issue_comments_360792.json:
```json
{
    "body": "Replying to [comment:31 embray]:\n> Okay, thank you.  That's a bit clearer.  Though I don't quite understand \"rounding up or down or whatever else is done with other methods\". Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)\n\nI missed that part of your question, sorry. Even when the rounding mode is \u201cto nearest\u201d, there are two (three?) competing conventions (up, or perhaps away from zero, in everyday life, vs to even). FWIW:\n* IEEE-754 specifies both a floating-point to integer conversion that rounds to nearest with halfway cases rounding to even and one with halfway cases rounding away from zero;\n* in C99/POSIX2001, `round()` rounds halfway cases *away from zero* regardless of the rounding mode.\nSo I'd say it is best *not* take the rounding mode into account to decide what to do with ties, and we should round *the absolute value* up. But I have no strong opinion on the matter, really. That's just my understanding of the consensus.\n\n> And should the `round()` *function* ever call an element's `.round()` *method*?\n\nAs far as I understand, no.",
    "created_at": "2019-02-01T14:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360792",
    "user": "mmezzarobba"
}
```

Replying to [comment:31 embray]:
> Okay, thank you.  That's a bit clearer.  Though I don't quite understand "rounding up or down or whatever else is done with other methods". Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)

I missed that part of your question, sorry. Even when the rounding mode is “to nearest”, there are two (three?) competing conventions (up, or perhaps away from zero, in everyday life, vs to even). FWIW:
* IEEE-754 specifies both a floating-point to integer conversion that rounds to nearest with halfway cases rounding to even and one with halfway cases rounding away from zero;
* in C99/POSIX2001, `round()` rounds halfway cases *away from zero* regardless of the rounding mode.
So I'd say it is best *not* take the rounding mode into account to decide what to do with ties, and we should round *the absolute value* up. But I have no strong opinion on the matter, really. That's just my understanding of the consensus.

> And should the `round()` *function* ever call an element's `.round()` *method*?

As far as I understand, no.



---

archive/issue_comments_360793.json:
```json
{
    "body": "It would be good if somebody more knowledgeable than me would now take over this ticket and manage to push it into success. This problem with `round` is now one of the major source of doctest failures in py3-sage.",
    "created_at": "2019-02-25T16:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360793",
    "user": "chapoton"
}
```

It would be good if somebody more knowledgeable than me would now take over this ticket and manage to push it into success. This problem with `round` is now one of the major source of doctest failures in py3-sage.



---

archive/issue_comments_360794.json:
```json
{
    "body": "I think it would be good to bring it up, yet again, on the mailing list.",
    "created_at": "2019-02-26T13:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360794",
    "user": "embray"
}
```

I think it would be good to bring it up, yet again, on the mailing list.



---

archive/issue_comments_360795.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360795",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_360796.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360796",
    "user": "embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_360797.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360797",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_360798.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360798",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_360799.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360799",
    "user": "mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_360800.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360800",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_360801.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-10-18T23:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25590",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25590#issuecomment-360801",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_work.
