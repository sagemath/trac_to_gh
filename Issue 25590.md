# Issue 25590: py3: some care for round

Issue created by migration from https://trac.sagemath.org/ticket/25827

Original creator: chapoton

Original creation time: 2018-07-11 15:49:24

CC:  jdemeyer tscrim




---

Comment by chapoton created at 2018-07-11 15:50:02

New commits:


---

Comment by chapoton created at 2018-07-11 15:50:02

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-07-12 09:42:57

Not sure what to do. This is not curing the disease. It seems that python3 builtin "round" is looking for `__round__`, unlike python2.


---

Comment by chapoton created at 2018-07-12 13:37:13

failing doctests


---

Comment by chapoton created at 2018-07-12 13:37:13

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-07-26 16:35:42

I've implemented a few `__round__` in my python3 branch.  I'll see about making a ticket for those.


---

Comment by chapoton created at 2018-09-03 19:39:40

`@`embray, where is your latest python3 branch ? could you please provide a branch for here, with the implemented `__round__` ?


---

Comment by embray created at 2018-09-04 09:42:38

Ok, I'll try to get back to you about that soon.


---

Comment by embray created at 2018-09-04 10:16:18

I think we need to think about exactly how to implement Sage's `round()` built-in as well.  Currently, some types in Sage have a `.round()` method which takes no arguments, and only rounds to an integer--in particular it always rounds up, it seems.

I find this a bit odd, but maybe there's a good reason. I wonder, because I find it surprising that `RealNumber.round()` does _not_ take into account the MPFR rounding mode of the parent field.  Why is that?  Is it just for consistency's sake--that all real and floating-point numbers round up the same way?

I implemented a `RealNumber.__round__()` which takes into account the parent field's rounding mode, and works quite nicely, though it's _incompatible_ with Sage's `round()` built-in which just calls `RealNumber.round()` for integer results.  So when rounding to the nearest int you get one rounding behavior, but in other cases you get a different rounding behavior.

So two questions:

1. Is there any reason to have a `RealNumber.__round__()` that respects the parent field's rounding mode?  It seems to make sense, but maybe it contradicts other assumptions in Sage that I'm not aware of.

2. Should we add an argument to `.round()` methods and make them equivalent to `.__round__()`?  Or do we add a separate `.__round__()`, and make `.round()` just a special case equivalent to calling `__round__()` with no arguments?


---

Comment by chapoton created at 2018-09-11 19:07:18

So far in sage, almost no round method takes a second argument:

```
git grep " round(self" src/sage
src/sage/matrix/matrix_double_dense.pyx:    def round(self, ndigits=0):
src/sage/rings/complex_arb.pyx:    def round(self):
src/sage/rings/number_field/number_field_element.pyx:    def round(self):
src/sage/rings/number_field/number_field_element_quadratic.pyx:    def round(self):
src/sage/rings/qqbar.py:    def round(self):
src/sage/rings/real_arb.pyx:    def round(self):
src/sage/rings/real_double.pyx:    def round(self):
src/sage/rings/real_mpfi.pyx:    def round(self):
src/sage/rings/real_mpfr.pyx:    def round(self):
src/sage/symbolic/expression.pyx:    def round(self):
```



---

Comment by git created at 2018-10-03 14:47:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-10-03 14:48:56

ok, here is a new branch, just adding some aliases `__round__` redirecting to `round`. I propose to simply do that for the moment, in order to advance the move towards python3.

*EDIT*: still missing would be `__round__` for Integer class


---

Comment by chapoton created at 2018-10-03 14:48:56

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-10-03 15:27:29

I would really rather think about this more carefully, and perhaps rework how Sage's built-in `round()` function works (or maybe even get rid of it entirely, at least on Python 3, if the new `__round__` special makes it obsolete.  Not clear.  And thoughts on my last comment?


---

Comment by embray created at 2018-10-03 15:34:21

> So far in sage, almost no round method takes a second argument:

That's because it's really meant to mean round-to-the-nearest-integer, which is simpler than what Python's built-in round does, which can return a float truncated to N digits, or an integer.  Just making `__round__` point to some of these class's old `round` methods is broken.

There's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.


---

Comment by chapoton created at 2018-10-03 15:35:45

> There's also now `__trunc__`, `__floor__`, and `__ceil__` and I'm not sure if we want to implement them or not: [https://docs.python.org/3.6/reference/datamodel.html#object.__round__](https://docs.python.org/3.6/reference/datamodel.html#object.__round__) but perhaps that can be left as a separate issue.

Those do not appear in the python3 log.


---

Comment by embray created at 2018-10-03 15:39:47

FWIW here's my implementation for MPFR reals:


```diff
diff --git a/src/sage/rings/real_mpfr.pyx b/src/sage/rings/real_mpfr.pyx
index 9b90c88..a82c4eb 100644
--- a/src/sage/rings/real_mpfr.pyx
+++ b/src/sage/rings/real_mpfr.pyx
@@ -3040,6 +3040,38 @@ cdef class RealNumber(sage.structure.element.RingElement)
         """
         return mpfr_get_d(self.value, (<RealField_class>self._parent).rnd)
+    def __round__(self, ndigits=0):
+        """
+        Implement support for Python 3's `round` builtin.
+
+        This is mostly equivalent to simply calling ``round(float(x),
+        ndigits)`` where ``x`` is a `RealNumber`.  The difference is that it is
+        still returns an arbitrary-precision `RealNumber` of precision
+        equivalent to ``self`` (or an `Integer` if ``ndigits=0``).  It also
+        uses the rounding mode specified on the parent field.
+
+        EXAMPLES::
+
+            TODO
+        """
+        cdef Integer z
+        cdef RealNumber r
+        cdef char* s
+
+        if ndigits < 0:
+            return (<RealField_class>self._parent).zero()
+        elif ndigits == 0:
+            z = PY_NEW(Integer)
+            mpfr_get_z(z.value, self.value, (<RealField_class>self._parent).rnd
+            return z
+        else:
+            rnd = (<RealField_class>self._parent).rnd
+            mpfr_asprintf(&s, "%.*R*f", <int>ndigits, rnd, self.value)
+            r = self._new()
+            mpfr_set_str(r.value, s, 10, rnd)
+            mpfr_free_str(s)
+            return r
+
```


But I'm not 100% sure if it makes sense to do things this way or not (and it needs examples).  However, it's broken with Sage's `round()` global built-in, because that tries to call a class's `.round()` method first if it exists.  And in fact `RealNumber` does have an existing `.round()` method that's different and doesn't take into account the field's rounding mode as my above implementation does.

If anything `.round()` should be the same as `.__round__(n=0)`; that or `.round()` grows an optional extra argument.


---

Comment by embray created at 2018-10-03 15:59:53

Perhaps it is a question that needs to be brought up on sage-devel, if we don't know the answers.

For example, why does Sage have its own `round()` built-in in the first place (at least part of the answer to that question seems to be exactly that something like `__round__` did not exist in the first place)?  Do we still need it, or at least, do we need it with Python 3?  Do we like the semantics of Python's round or would we rather replace it with something else?  To what extent do we want to support those semantics of different class's `.round()` _methods_?  Etc...


---

Comment by chapoton created at 2018-10-05 11:39:47

I have made #26412 for the same thing in integer.pyx


---

Comment by chapoton created at 2018-12-14 10:28:58

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-12-20 13:38:31

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-12-20 13:38:31

new tentative based on Erik's suggested patch
----
New commits:


---

Comment by chapoton created at 2018-12-30 10:16:09

bot is morally green..


---

Comment by embray created at 2018-12-31 11:31:23

I'm happy with the `__round__` implementation of course, since I wrote it.  But part of why I never submitted it in the first place is that I'm not totally confident with this course of action.

In particular, why does `RealNumber.round` _ignore_ the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?

There's also a problem  that this `__round__` is ignored anyways (as you can see by writing the tests to use the `round()` global instead of calling `__round__()` directly).  The problem is that Sage's `round()` just ends up calling `RealNumber.round()` instead of `RealNumber.__round__()` and thus ignores the rounding mode, so this code effectively never gets used.

This is why I keep saying we maybe need to rethink the behavior of Sage's built-in `round()`.  I'm starting to think that for Python 3 we might opt to just remove it entirely, or make it an alias for the Python built-in `round()`, since now we can override its behavior on different types by supplying `__round__()`, whereas previously we had to use this hack to override rounding on different types.


---

Comment by embray created at 2018-12-31 11:31:23

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-12-31 11:35:17

I also think that the test for this should demonstrate the fact that parent's rounding mode is considered.  For example, demonstrate that with `RNDN` 2.5 is rounded to 2, while with `RNDU` it is rounded to 3.


---

Comment by git created at 2018-12-31 19:13:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-01-09 12:33:45

Would it be ok to make the current `round` method an alias for the new `__round__` method (just in this file for this kind of real numbers) ?


---

Comment by embray created at 2019-01-09 14:22:15

Try it and see.  I believe it would work--look at the definition of `round` in `sage.misc.functional`.

It still doesn't answer my question though:

> In particular, why does `RealNumber.round` ignore the rounding mode of the parent field? Is there some good reason for that? If so, then why would `RealNumber.__round__` not ignore it?

I think that what you propose makes sense, but it would be a change in behavior (see the `round(2.5)` case) which I wouldn't want to make lightly unless nobody can provide a good explanation for the current behavior.  This is what I keep trying to tell you.  If neither of us know a reason for the current behavior then we need to find out who does know and ask them.


---

Comment by mmezzarobba created at 2019-02-01 12:53:31

Replying to [comment:23 embray]:
> In particular, why does `RealNumber.round` _ignore_ the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?

My understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to _integers_, each in the way (≈ with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.


---

Comment by embray created at 2019-02-01 13:20:49

Replying to [comment:28 mmezzarobba]:
> Replying to [comment:23 embray]:
> > In particular, why does `RealNumber.round` _ignore_ the rounding mode of the parent field?  Is there some good reason for that?  If so, then why would `RealNumber.__round__` not ignore it?
> 
> My understanding is that `round()`, `floor()`, `ceil()`, and `trunc()` are for rounding reals to _integers_, each in the way (≈ with the rounding mode) indicated by the name of the method. The parent's rounding mode only tells you how to round the results of inexact operations in that parent, and has no role to play here. That rounding to a certain precision can also be done with a function called `round()` is an accident, the two are unrelated.

Could you please be more specific?  Are you talking about the Python stdlib or Sage?  The fact is that the `round()` function in Python (and by extension in Sage) does allow rounding to N decimal digits.

I appreciate the effort to bring clarity to this question but to me this comment only muddies the waters.


---

Comment by mmezzarobba created at 2019-02-01 13:35:05

Replying to [comment:29 embray]:
> Could you please be more specific?  Are you talking about the Python stdlib or Sage?

Both, I guess. What I'm trying to say (and I think it answers your question, but I haven't read the rest of the ticket, so perhaps I'm misunderstanding the issue) is that:
* The `round()` _functions_ (both the builtin and the one in `sage.functional`) round to a given precision. From my point of view, making them honor the parent's rounding mode when their argument already is a `RealNumber` would be an improvement.
* The `round()` _methods_ of `RealNumber` and several other element classes, however, are unrelated. They are for rounding to the nearest integer; and rounding up or down or whatever else is done with other methods.


---

Comment by embray created at 2019-02-01 14:19:33

Okay, thank you.  That's a bit clearer.  Though I don't quite understand "rounding up or down or whatever else is done with other methods".  Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)

And should the `round()` _function_ ever call an element's `.round()` _method_?


---

Comment by mmezzarobba created at 2019-02-01 14:46:03

Replying to [comment:31 embray]:
> Okay, thank you.  That's a bit clearer.  Though I don't quite understand "rounding up or down or whatever else is done with other methods". Given a `RealNumber(2.5)` should it round up or down (typically up I know, but why?)

I missed that part of your question, sorry. Even when the rounding mode is “to nearest”, there are two (three?) competing conventions (up, or perhaps away from zero, in everyday life, vs to even). FWIW:
* IEEE-754 specifies both a floating-point to integer conversion that rounds to nearest with halfway cases rounding to even and one with halfway cases rounding away from zero;
* in C99/POSIX2001, `round()` rounds halfway cases _away from zero_ regardless of the rounding mode.
So I'd say it is best _not_ take the rounding mode into account to decide what to do with ties, and we should round _the absolute value_ up. But I have no strong opinion on the matter, really. That's just my understanding of the consensus.

> And should the `round()` _function_ ever call an element's `.round()` _method_?

As far as I understand, no.


---

Comment by chapoton created at 2019-02-25 16:50:12

It would be good if somebody more knowledgeable than me would now take over this ticket and manage to push it into success. This problem with `round` is now one of the major source of doctest failures in py3-sage.


---

Comment by embray created at 2019-02-26 13:50:42

I think it would be good to bring it up, yet again, on the mailing list.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-10-18 23:40:40

Changing status from needs_info to needs_work.
