# Issue 16330: Use libsingular for polynomial rings over function fields

archive/issues_016330.json:
```json
{
    "body": "CC:  @malb @miguelmarco simonking @dimpase sbulygin @bhutz @torrencem @tscrim @jdemeyer jpflori @embray @enderwannabe\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16567\n\n",
    "created_at": "2014-06-27T14:24:05Z",
    "labels": [],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Use libsingular for polynomial rings over function fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16330",
    "user": "https://github.com/simon-king-jena"
}
```
CC:  @malb @miguelmarco simonking @dimpase sbulygin @bhutz @torrencem @tscrim @jdemeyer jpflori @embray @enderwannabe



Issue created by migration from https://trac.sagemath.org/ticket/16567





---

archive/issue_comments_213760.json:
```json
{
    "body": "Changing keywords from \"\" to \"function field, libsingular\".",
    "created_at": "2014-06-27T14:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213760",
    "user": "https://github.com/simon-king-jena"
}
```

Changing keywords from "" to "function field, libsingular".



---

archive/issue_comments_213761.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to commutative algebra.",
    "created_at": "2014-06-27T14:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213761",
    "user": "https://github.com/simon-king-jena"
}
```

Changing component from PLEASE CHANGE to commutative algebra.



---

archive/issue_comments_213762.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2014-06-27T14:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213762",
    "user": "https://github.com/simon-king-jena"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_213763.json:
```json
{
    "body": "It is not a big deal to create the `MPolynomialRing_libsingular` with parameters. However, I need to find out how to create a Singular `number` with parameters. Martin, can you give me a pointer to a relevant file of the Singular sources?",
    "created_at": "2014-06-28T07:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213763",
    "user": "https://github.com/simon-king-jena"
}
```

It is not a big deal to create the `MPolynomialRing_libsingular` with parameters. However, I need to find out how to create a Singular `number` with parameters. Martin, can you give me a pointer to a relevant file of the Singular sources?



---

archive/issue_comments_213764.json:
```json
{
    "body": "Looks like you want `kernel/longtrans.h`:\n\n```\n/*\n* ABSTRACT:   numbers in transcendental field extensions,\n              i.e., in rational function fields\n*/\n```",
    "created_at": "2014-06-28T15:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213764",
    "user": "https://github.com/malb"
}
```

Looks like you want `kernel/longtrans.h`:

```
/*
* ABSTRACT:   numbers in transcendental field extensions,
              i.e., in rational function fields
*/
```



---

archive/issue_comments_213765.json:
```json
{
    "body": "Replying to [comment:3 malb]:\n> Looks like you want `kernel/longtrans.h`:\n> \n> \n> ```\n> /*\n> * ABSTRACT:   numbers in transcendental field extensions,\n>               i.e., in rational function fields\n> */\n> ```\n\n\nThank you, Martin!\n\nSo far, I only found `number (*nPar)(int i)`. If I understand correctly, it returns the `i`-th parameter as a number. But this would probably be cumbersome to use for transforming an element of a Sage function field resp. of a Sage quotient field of polynomial ring.",
    "created_at": "2014-06-28T16:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213765",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:3 malb]:
> Looks like you want `kernel/longtrans.h`:
> 
> 
> ```
> /*
> * ABSTRACT:   numbers in transcendental field extensions,
>               i.e., in rational function fields
> */
> ```


Thank you, Martin!

So far, I only found `number (*nPar)(int i)`. If I understand correctly, it returns the `i`-th parameter as a number. But this would probably be cumbersome to use for transforming an element of a Sage function field resp. of a Sage quotient field of polynomial ring.



---

archive/issue_comments_213766.json:
```json
{
    "body": "Seems like one actually needs to construct a `number` by starting with `nPar(i)` (which is a function pointer to `ntPar`, IIUC) and conversion of integers, and then add, multiply and divide. Or is there a way to directly convert a polynomial in variables `a,b,c` into a number in parameters `a,b,c`? After all, there is this globally accessible ring `nacRing` hosting numerator and denominator of a function field element.",
    "created_at": "2014-06-28T17:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213766",
    "user": "https://github.com/simon-king-jena"
}
```

Seems like one actually needs to construct a `number` by starting with `nPar(i)` (which is a function pointer to `ntPar`, IIUC) and conversion of integers, and then add, multiply and divide. Or is there a way to directly convert a polynomial in variables `a,b,c` into a number in parameters `a,b,c`? After all, there is this globally accessible ring `nacRing` hosting numerator and denominator of a function field element.



---

archive/issue_comments_213767.json:
```json
{
    "body": "I'd assume there should be a way to convert a polynomial to a number as these numbers are polynomials internally as far as I know. Maybe ask on libsingular-devel?",
    "created_at": "2014-06-28T17:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213767",
    "user": "https://github.com/malb"
}
```

I'd assume there should be a way to convert a polynomial to a number as these numbers are polynomials internally as far as I know. Maybe ask on libsingular-devel?



---

archive/issue_comments_213768.json:
```json
{
    "body": "Miguel asked me to push the basic steps that I did for this ticket.\n\nAll what works is to set up polynomial rings over \"fraction fields of polynomial rings\" as libsingular polynomial rings with parameters. What is missing is everything else. In particular: the element constructor must be modified so that elements of quotient fields of polynomial rings are converted into libsingular numbers.\n\n---\nNew commits:",
    "created_at": "2014-07-24T11:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213768",
    "user": "https://github.com/simon-king-jena"
}
```

Miguel asked me to push the basic steps that I did for this ticket.

All what works is to set up polynomial rings over "fraction fields of polynomial rings" as libsingular polynomial rings with parameters. What is missing is everything else. In particular: the element constructor must be modified so that elements of quotient fields of polynomial rings are converted into libsingular numbers.

---
New commits:



---

archive/issue_events_048626.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16330#event-48626"
}
```



---

archive/issue_comments_213769.json:
```json
{
    "body": "Ping!\n\nI am trying (once again) to work on this. I also got to the point of creating the ring, and am stuck in the point of translating the coefficients.\n\nI have started with conversion from sage coefficients to singular ones (the `sa2si` function in `singular.pyx`; but for some reason i don't understand, the generated .c code does not import the definitions from `transext.h`.",
    "created_at": "2021-10-04T16:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213769",
    "user": "https://github.com/miguelmarco"
}
```

Ping!

I am trying (once again) to work on this. I also got to the point of creating the ring, and am stuck in the point of translating the coefficients.

I have started with conversion from sage coefficients to singular ones (the `sa2si` function in `singular.pyx`; but for some reason i don't understand, the generated .c code does not import the definitions from `transext.h`.



---

archive/issue_comments_213770.json:
```json
{
    "body": "Also, i am not sure if i am dealing with the pointers correctly. It could use some review freom someone with more c/cython experience.",
    "created_at": "2021-10-04T16:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213770",
    "user": "https://github.com/miguelmarco"
}
```

Also, i am not sure if i am dealing with the pointers correctly. It could use some review freom someone with more c/cython experience.



---

archive/issue_comments_213771.json:
```json
{
    "body": "It's a little easier if the branch you're talking about is actually attached.\n\nThe cython docs for \"cimport extern\" is here:\n\nhttps://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#referencing-c-header-files\n\nIt actually does say there that the extern declaration should let cython generate an `#include \"singular/polys/ext_fields/transext.h\"`. However, cython with take it on blind fate that the cython declarations given in the block itself somehow correspond to something that makes sense in C, because cython will not generate any declarations to define the types you specify: the \"extern\" promises that this is somehow resolved (by the given include or something else). So you should probably check that the generated C file indeed has an `#include` included. Otherwise, if you made a subtle typo compared with what's in C, the error would only arise in the C compiler, so you should probably carefully read the error that the C compiler generates and check that your spelling of everything matches up. Hope this helps?",
    "created_at": "2021-10-04T19:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213771",
    "user": "https://github.com/nbruin"
}
```

It's a little easier if the branch you're talking about is actually attached.

The cython docs for "cimport extern" is here:

https://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#referencing-c-header-files

It actually does say there that the extern declaration should let cython generate an `#include "singular/polys/ext_fields/transext.h"`. However, cython with take it on blind fate that the cython declarations given in the block itself somehow correspond to something that makes sense in C, because cython will not generate any declarations to define the types you specify: the "extern" promises that this is somehow resolved (by the given include or something else). So you should probably check that the generated C file indeed has an `#include` included. Otherwise, if you made a subtle typo compared with what's in C, the error would only arise in the C compiler, so you should probably carefully read the error that the C compiler generates and check that your spelling of everything matches up. Hope this helps?



---

archive/issue_comments_213772.json:
```json
{
    "body": "Thanks for the answer!\n\nI did check that: the generated .cpp file has this line\n\n```\n#include \"singular/polys/ext_fields/transext.h\"\n```\n\nand the file `SAGE_LOCAL/local/include/singular/polys/ext_fields/transext.h`  has the following declarations:\n\n```\nstruct fractionObject\n{\n  poly numerator;\n  poly denominator;\n  int complexity;\n};\n\ntypedef struct fractionObject * fraction;\n```\n\nSo I still have no idea about what could be going on.\n\n\nOne possible guess is that the generated file is a `.cpp`, that is, no pure C, but C++. Maybe some problem with scopes?",
    "created_at": "2021-10-04T20:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213772",
    "user": "https://github.com/miguelmarco"
}
```

Thanks for the answer!

I did check that: the generated .cpp file has this line

```
#include "singular/polys/ext_fields/transext.h"
```

and the file `SAGE_LOCAL/local/include/singular/polys/ext_fields/transext.h`  has the following declarations:

```
struct fractionObject
{
  poly numerator;
  poly denominator;
  int complexity;
};

typedef struct fractionObject * fraction;
```

So I still have no idea about what could be going on.


One possible guess is that the generated file is a `.cpp`, that is, no pure C, but C++. Maybe some problem with scopes?



---

archive/issue_comments_213773.json:
```json
{
    "body": "I think I finally got it. This branch seems to work.\n\nStill needs some polishing (documentation, cleanup, and check that we are handling memory correctly... which means lots of testing).\n\nSo please be welcome to take a look and stress-test it.",
    "created_at": "2021-10-06T15:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213773",
    "user": "https://github.com/miguelmarco"
}
```

I think I finally got it. This branch seems to work.

Still needs some polishing (documentation, cleanup, and check that we are handling memory correctly... which means lots of testing).

So please be welcome to take a look and stress-test it.



---

archive/issue_events_048627.json:
```json
{
    "actor": "https://github.com/miguelmarco",
    "created_at": "2021-10-06T15:34:40Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16330#event-48627"
}
```



---

archive/issue_events_048628.json:
```json
{
    "actor": "https://github.com/miguelmarco",
    "created_at": "2021-10-06T15:34:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16330#event-48628"
}
```



---

archive/issue_comments_213774.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-06T17:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213774",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_213775.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-06T17:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213775",
    "user": "https://github.com/miguelmarco"
}
```

New commits:



---

archive/issue_comments_213776.json:
```json
{
    "body": "I found a subtle bug:\n\n```\nsage: F = PolynomialRing(QQ,'t').fraction_field()\nsage: FA = FreeAlgebra(F, 6, 'x1,x2,x3,x4,x5,x6')\nsage: N = FA.g_algebra({FA.gen(j)*FA.gen(i):-FA.gen(i)*FA.gen(j) for i in range(5) for j in range(i+1,6)})\nsage: I = N.ideal([g^2 for g in N.gens()],side='twosided')\nsage: N.inject_variables()\nDefining x1, x2, x3, x4, x5, x6\nsage: I.reduce(x1*x2*x3 + x2^2*x4)\nx1*x2*x3 + x2^2*x4\n```\n\nNote that it doesn't cancel out the square of `x2`.  It is very subtle, since:\n\n```\nsage: I.reduce(x1*x2*x3)\nx1*x2*x3\nsage: I.reduce(x2^2*x4)\n0\n```\n\nthat is, the summands are correctly reduced. Moreover\n\n```\nsage: I.reduce(x3*x2*x6 + x2^2*x4)\n-x2*x3*x6\nsage: I.reduce(x1*x2*x4 + x2^2*x4)\nx1*x2*x4 + x2^2*x4\nsage: I.reduce(x1*x2*x5 + x2^2*x4)\nx1*x2*x5\nsage: I.reduce(x1*x2*x6 + x2^2*x4)\nx1*x2*x6\nsage: I.reduce(x3*x2*x6 + x2^2*x4)\n-x2*x3*x6\nsage: I.reduce(x3*x2*x5 + x2^2*x4)\n-x2*x3*x5\n```\n\nThe bug only appears with a very precise set of possibilities for the summands.\n\n\nIt feels that it would be very hard to investigate this bug, but it doesn't appear in the previously affected fields:\n\n```\nsage: FA = FreeAlgebra(QQ, 6, 'x1,x2,x3,x4,x5,x6')\nsage: N = FA.g_algebra({FA.gen(j)*FA.gen(i):-FA.gen(i)*FA.gen(j) for i in range(5) for j in range(i+1,6)})\nsage: I = N.ideal([g^2 for g in N.gens()],side='twosided')\nsage: N.inject_variables()\nDefining x1, x2, x3, x4, x5, x6\nsage: I.reduce(x1*x2*x3 + x2^2*x4)\nx1*x2*x3\n```\n\nSo this code doesn't really introduce a bug in previous functionalities.\n\n---\nNew commits:",
    "created_at": "2021-10-08T00:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213776",
    "user": "https://github.com/miguelmarco"
}
```

I found a subtle bug:

```
sage: F = PolynomialRing(QQ,'t').fraction_field()
sage: FA = FreeAlgebra(F, 6, 'x1,x2,x3,x4,x5,x6')
sage: N = FA.g_algebra({FA.gen(j)*FA.gen(i):-FA.gen(i)*FA.gen(j) for i in range(5) for j in range(i+1,6)})
sage: I = N.ideal([g^2 for g in N.gens()],side='twosided')
sage: N.inject_variables()
Defining x1, x2, x3, x4, x5, x6
sage: I.reduce(x1*x2*x3 + x2^2*x4)
x1*x2*x3 + x2^2*x4
```

Note that it doesn't cancel out the square of `x2`.  It is very subtle, since:

```
sage: I.reduce(x1*x2*x3)
x1*x2*x3
sage: I.reduce(x2^2*x4)
0
```

that is, the summands are correctly reduced. Moreover

```
sage: I.reduce(x3*x2*x6 + x2^2*x4)
-x2*x3*x6
sage: I.reduce(x1*x2*x4 + x2^2*x4)
x1*x2*x4 + x2^2*x4
sage: I.reduce(x1*x2*x5 + x2^2*x4)
x1*x2*x5
sage: I.reduce(x1*x2*x6 + x2^2*x4)
x1*x2*x6
sage: I.reduce(x3*x2*x6 + x2^2*x4)
-x2*x3*x6
sage: I.reduce(x3*x2*x5 + x2^2*x4)
-x2*x3*x5
```

The bug only appears with a very precise set of possibilities for the summands.


It feels that it would be very hard to investigate this bug, but it doesn't appear in the previously affected fields:

```
sage: FA = FreeAlgebra(QQ, 6, 'x1,x2,x3,x4,x5,x6')
sage: N = FA.g_algebra({FA.gen(j)*FA.gen(i):-FA.gen(i)*FA.gen(j) for i in range(5) for j in range(i+1,6)})
sage: I = N.ideal([g^2 for g in N.gens()],side='twosided')
sage: N.inject_variables()
Defining x1, x2, x3, x4, x5, x6
sage: I.reduce(x1*x2*x3 + x2^2*x4)
x1*x2*x3
```

So this code doesn't really introduce a bug in previous functionalities.

---
New commits:



---

archive/issue_comments_213777.json:
```json
{
    "body": "Replying to [comment:18 mmarco]:\n\nA hint might be that it doesn't happen whoth more that one parameter. So it might be related to how we treat that case (it is treated differently since by default univariate polynomial rings in sage are not wrapped around singular).",
    "created_at": "2021-10-08T01:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213777",
    "user": "https://github.com/miguelmarco"
}
```

Replying to [comment:18 mmarco]:

A hint might be that it doesn't happen whoth more that one parameter. So it might be related to how we treat that case (it is treated differently since by default univariate polynomial rings in sage are not wrapped around singular).



---

archive/issue_comments_213778.json:
```json
{
    "body": "Replying to [comment:19 mmarco]:\n> Replying to [comment:18 mmarco]:\n> \n> A hint might be that it doesn't happen whoth more that one parameter. So it might be related to how we treat that case (it is treated differently since by default univariate polynomial rings in sage are not wrapped around singular).\n\n\nSorry, this is not correct. The bug appears with several parameters as well.",
    "created_at": "2021-10-08T01:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213778",
    "user": "https://github.com/miguelmarco"
}
```

Replying to [comment:19 mmarco]:
> Replying to [comment:18 mmarco]:
> 
> A hint might be that it doesn't happen whoth more that one parameter. So it might be related to how we treat that case (it is treated differently since by default univariate polynomial rings in sage are not wrapped around singular).


Sorry, this is not correct. The bug appears with several parameters as well.



---

archive/issue_comments_213779.json:
```json
{
    "body": "We saw this \"not reducing x<sup>2</sup>\" thing in #27508 - a ticket that shows that we don't fully understand how linsingular works, and the only documentation on it is basically source code, or whatever you can extract from the upstream author...",
    "created_at": "2021-10-08T09:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213779",
    "user": "https://github.com/dimpase"
}
```

We saw this "not reducing x<sup>2</sup>" thing in #27508 - a ticket that shows that we don't fully understand how linsingular works, and the only documentation on it is basically source code, or whatever you can extract from the upstream author...



---

archive/issue_comments_213780.json:
```json
{
    "body": "Thanks that was actually very helpful!\n\nThe solution to #27508 (to force `noTailReduction = False`) was only applied to `GroebnerStrategy`. We just have to apply it to `NCGroebnerStrategy` as well\n\n---\nNew commits:",
    "created_at": "2021-10-08T09:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213780",
    "user": "https://github.com/miguelmarco"
}
```

Thanks that was actually very helpful!

The solution to #27508 (to force `noTailReduction = False`) was only applied to `GroebnerStrategy`. We just have to apply it to `NCGroebnerStrategy` as well

---
New commits:



---

archive/issue_comments_213781.json:
```json
{
    "body": "I am doing the final touches before it is ready, but running the whole test suite I got the following error:\n\n```\nsage -t --warn-long 67.8 --random-seed=0 src/sage/schemes/generic/morphism.py\n**********************************************************************\nFile \"src/sage/schemes/generic/morphism.py\", line 1605, in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization\nFailed example:\n    f.specialization({alpha:5,beta:10})\nException raised:\n    Traceback (most recent call last):\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization[32]>\", line 1, in <module>\n        f.specialization({alpha:Integer(5),beta:Integer(10)})\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/generic_ds.py\", line 334, in specialization\n        F = self.as_scheme_morphism().specialization(D, phi, homset)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/schemes/generic/morphism.py\", line 1618, in specialization\n        phi = FractionSpecializationMorphism(self[0].parent(), D)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py\", line 663, in __init__\n        self._specialization = SpecializationMorphism(domain.base(), D)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py\", line 540, in __init__\n        raise NameError(\"argument \" + str(var) + \" is not a generator anywhere in the polynomial tower\")\n    NameError: argument (alpha) is not a generator anywhere in the polynomial tower\n**********************************************************************\nFile \"src/sage/schemes/generic/morphism.py\", line 1609, in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization\nFailed example:\n    f.specialization({alpha:5}).specialization({beta:10}) == f.specialization({alpha:5,beta:10})\nException raised:\n    Traceback (most recent call last):\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization[33]>\", line 1, in <module>\n        f.specialization({alpha:Integer(5)}).specialization({beta:Integer(10)}) == f.specialization({alpha:Integer(5),beta:Integer(10)})\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/generic_ds.py\", line 334, in specialization\n        F = self.as_scheme_morphism().specialization(D, phi, homset)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/schemes/generic/morphism.py\", line 1618, in specialization\n        phi = FractionSpecializationMorphism(self[0].parent(), D)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py\", line 663, in __init__\n        self._specialization = SpecializationMorphism(domain.base(), D)\n      File \"/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py\", line 540, in __init__\n        raise NameError(\"argument \" + str(var) + \" is not a generator anywhere in the polynomial tower\")\n    NameError: argument (alpha) is not a generator anywhere in the polynomial tower\n**********************************************************************\n1 item had failures:\n   2 of  35 in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization\n    [476 tests, 2 failures, 1.00 s]\n```\n\n\nWhich actually comes from the behaviour of FlatteningMorphism in `src/sage/rings/polynomial/flatten.py`\n\nFor some reason, it did work with the previous (pexpect) singular interface, but breaks with this branch. I will try to sort it out, but I am not sure it does make any mathematical sense to have this kind of morphisms.\n\nI mean: If I understand correctly, the flattening morphism is suposed to be constructed from, say the ring QQ(a,b)[x,y] and  the dictionary {a:3}, and will return a \"morphism\" from QQ(a,b)[x,y] to QQ(b)[x,y], given by substituting a=3.\n\nBut that is not defined for all elements of QQ(a,b)[x,y]:\n\n```\nsage: from sage.rings.polynomial.flatten import SpecializationMorphism\nsage: F = PolynomialRing(QQ,'a,b').fraction_field()\nsage: F.inject_variables()\nDefining a, b\nR.<x,y> = F[]\nsage: phi = SpecializationMorphism(R, {a:3})\nsage: phi\nphi = SpecializationMorphism(R, {a:3})\n\nphi\n\nSpecialization morphism:\n  From: Multivariate Polynomial Ring in x, y over Fraction Field of Multivariate Polynomial Ring in a, b over Rational Field\n  To:   Multivariate Polynomial Ring in x, y over Fraction Field of Univariate Polynomial Ring in b over Rational Field\nsage: el = (1/(3-a))*x\nsage: el.parent()\nMultivariate Polynomial Ring in x, y over Fraction Field of Multivariate Polynomial Ring in a, b over Rational Field\nsage: phi(el)    #   booom!!\n---------------------------------------------------------------------------\nZeroDivisionError                         Traceback (most recent call last)\n...\nZeroDivisionError: fraction field element division by zero\n``` \n\n\nSo, do you think this is ok to have (even if it is not really a morphism), or should we just eliminate it?\n\n---\nNew commits:",
    "created_at": "2021-10-09T21:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213781",
    "user": "https://github.com/miguelmarco"
}
```

I am doing the final touches before it is ready, but running the whole test suite I got the following error:

```
sage -t --warn-long 67.8 --random-seed=0 src/sage/schemes/generic/morphism.py
**********************************************************************
File "src/sage/schemes/generic/morphism.py", line 1605, in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization
Failed example:
    f.specialization({alpha:5,beta:10})
Exception raised:
    Traceback (most recent call last):
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization[32]>", line 1, in <module>
        f.specialization({alpha:Integer(5),beta:Integer(10)})
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/generic_ds.py", line 334, in specialization
        F = self.as_scheme_morphism().specialization(D, phi, homset)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/schemes/generic/morphism.py", line 1618, in specialization
        phi = FractionSpecializationMorphism(self[0].parent(), D)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py", line 663, in __init__
        self._specialization = SpecializationMorphism(domain.base(), D)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py", line 540, in __init__
        raise NameError("argument " + str(var) + " is not a generator anywhere in the polynomial tower")
    NameError: argument (alpha) is not a generator anywhere in the polynomial tower
**********************************************************************
File "src/sage/schemes/generic/morphism.py", line 1609, in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization
Failed example:
    f.specialization({alpha:5}).specialization({beta:10}) == f.specialization({alpha:5,beta:10})
Exception raised:
    Traceback (most recent call last):
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization[33]>", line 1, in <module>
        f.specialization({alpha:Integer(5)}).specialization({beta:Integer(10)}) == f.specialization({alpha:Integer(5),beta:Integer(10)})
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/dynamics/arithmetic_dynamics/generic_ds.py", line 334, in specialization
        F = self.as_scheme_morphism().specialization(D, phi, homset)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/schemes/generic/morphism.py", line 1618, in specialization
        phi = FractionSpecializationMorphism(self[0].parent(), D)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py", line 663, in __init__
        self._specialization = SpecializationMorphism(domain.base(), D)
      File "/home/mmarco/sage/local/lib/python3.9/site-packages/sage/rings/polynomial/flatten.py", line 540, in __init__
        raise NameError("argument " + str(var) + " is not a generator anywhere in the polynomial tower")
    NameError: argument (alpha) is not a generator anywhere in the polynomial tower
**********************************************************************
1 item had failures:
   2 of  35 in sage.schemes.generic.morphism.SchemeMorphism_polynomial.specialization
    [476 tests, 2 failures, 1.00 s]
```


Which actually comes from the behaviour of FlatteningMorphism in `src/sage/rings/polynomial/flatten.py`

For some reason, it did work with the previous (pexpect) singular interface, but breaks with this branch. I will try to sort it out, but I am not sure it does make any mathematical sense to have this kind of morphisms.

I mean: If I understand correctly, the flattening morphism is suposed to be constructed from, say the ring QQ(a,b)[x,y] and  the dictionary {a:3}, and will return a "morphism" from QQ(a,b)[x,y] to QQ(b)[x,y], given by substituting a=3.

But that is not defined for all elements of QQ(a,b)[x,y]:

```
sage: from sage.rings.polynomial.flatten import SpecializationMorphism
sage: F = PolynomialRing(QQ,'a,b').fraction_field()
sage: F.inject_variables()
Defining a, b
R.<x,y> = F[]
sage: phi = SpecializationMorphism(R, {a:3})
sage: phi
phi = SpecializationMorphism(R, {a:3})

phi

Specialization morphism:
  From: Multivariate Polynomial Ring in x, y over Fraction Field of Multivariate Polynomial Ring in a, b over Rational Field
  To:   Multivariate Polynomial Ring in x, y over Fraction Field of Univariate Polynomial Ring in b over Rational Field
sage: el = (1/(3-a))*x
sage: el.parent()
Multivariate Polynomial Ring in x, y over Fraction Field of Multivariate Polynomial Ring in a, b over Rational Field
sage: phi(el)    #   booom!!
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
...
ZeroDivisionError: fraction field element division by zero
``` 


So, do you think this is ok to have (even if it is not really a morphism), or should we just eliminate it?

---
New commits:



---

archive/issue_comments_213782.json:
```json
{
    "body": "Regardles of what we do with the previous \"morphisms\", this last patch solves the underlying issues (related to the fact that the same variable was represented differently depending on weather it was considered in the  base field or in the polynomial ring).\n\nAll doctests pass in my machine, so I think it is ready for review.\n\n---\nNew commits:",
    "created_at": "2021-10-10T09:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213782",
    "user": "https://github.com/miguelmarco"
}
```

Regardles of what we do with the previous "morphisms", this last patch solves the underlying issues (related to the fact that the same variable was represented differently depending on weather it was considered in the  base field or in the polynomial ring).

All doctests pass in my machine, so I think it is ready for review.

---
New commits:



---

archive/issue_comments_213783.json:
```json
{
    "body": "Weighing on the goals of the Flattening-Specialization framework.\n\nThe idea is that given a family of objects under some parameterization. It is incredibly useful to have a way to specialize to a specific member of that family (by choosing a value of one of the parameters). This is obtained in the .specialization() functions available for various objects. It is not at all surprising the you can choose parameter values for which the specialized member is not defined. The error returned to the user should be understandable in this case.\n\nTo implement this well, a number of structures needed to be created. The Flatenning structures take a stacked polynomial ring tower such as K[a,b][c,d] and create the polynomial ring K[a,b,c,d]. A value can then be substituted in for one of the variables as a specialization and the tower rebuilt with Unflattening.\n\nSo Flattening doesn't go from QQ[a,b][x,y] to QQ(b)[x,y] as mentioned above. Rather it just goes from Q[a,b][x,y] to QQ[a,b,x,y]. (How function fields are dealt with in specialization is a little more complicated, but essentially flattening the poly ring and specializing the numerator/denominator, then rebuilding correctly).\n\nLooks like this issues mentioned were already resolved.\n\n---\nNew commits:",
    "created_at": "2021-10-11T00:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213783",
    "user": "https://github.com/bhutz"
}
```

Weighing on the goals of the Flattening-Specialization framework.

The idea is that given a family of objects under some parameterization. It is incredibly useful to have a way to specialize to a specific member of that family (by choosing a value of one of the parameters). This is obtained in the .specialization() functions available for various objects. It is not at all surprising the you can choose parameter values for which the specialized member is not defined. The error returned to the user should be understandable in this case.

To implement this well, a number of structures needed to be created. The Flatenning structures take a stacked polynomial ring tower such as K[a,b][c,d] and create the polynomial ring K[a,b,c,d]. A value can then be substituted in for one of the variables as a specialization and the tower rebuilt with Unflattening.

So Flattening doesn't go from QQ[a,b][x,y] to QQ(b)[x,y] as mentioned above. Rather it just goes from Q[a,b][x,y] to QQ[a,b,x,y]. (How function fields are dealt with in specialization is a little more complicated, but essentially flattening the poly ring and specializing the numerator/denominator, then rebuilding correctly).

Looks like this issues mentioned were already resolved.

---
New commits:



---

archive/issue_comments_213784.json:
```json
{
    "body": "Yes, I found that the reason that the previous fail was that the flattening process depended on the string representation of variables, and libsingular represents parameters in polynomial rinms with parenthesis. Changing that representation fixed that problem.\n\nThere was another problem caused by the fact that univariate polynomials are usually a sifferent class than multivariate ones. To make use of libsingular over rings with one parameter, a \"multivariate\" polynomial ring with just one variable has to be created. Then some subtlety in the way morphisms work ended giving the fraction field element constructor a list as an input, instead of an element. Adding that option to the element constructor fixed that second problem.\n\nI see the usefulness of the specialization morphisms. My concerns is more a conceptual one, about them being no \"real\" morphisms in the mathematical sense when fraction fields are involved, since a morphism should be defined by all values of the domain. But it might be that the usefulness overwheights the mathematical inacuracy",
    "created_at": "2021-10-11T01:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213784",
    "user": "https://github.com/miguelmarco"
}
```

Yes, I found that the reason that the previous fail was that the flattening process depended on the string representation of variables, and libsingular represents parameters in polynomial rinms with parenthesis. Changing that representation fixed that problem.

There was another problem caused by the fact that univariate polynomials are usually a sifferent class than multivariate ones. To make use of libsingular over rings with one parameter, a "multivariate" polynomial ring with just one variable has to be created. Then some subtlety in the way morphisms work ended giving the fraction field element constructor a list as an input, instead of an element. Adding that option to the element constructor fixed that second problem.

I see the usefulness of the specialization morphisms. My concerns is more a conceptual one, about them being no "real" morphisms in the mathematical sense when fraction fields are involved, since a morphism should be defined by all values of the domain. But it might be that the usefulness overwheights the mathematical inacuracy



---

archive/issue_comments_213785.json:
```json
{
    "body": "Replying to [comment:26 mmarco]:\n> I see the usefulness of the specialization morphisms. My concerns is more a conceptual one, about them being no \"real\" morphisms in the mathematical sense when fraction fields are involved, since a morphism should be defined by all values of the domain. But it might be that the usefulness overwheights the mathematical inacuracy\n\n\nThe domain of definition for such specializations would be some relevant local ring. I think it will be easier to handle these using a partial homomorphism as is done now. Perhaps a doctest and a comment on that these maps may be partial.",
    "created_at": "2021-10-11T07:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213785",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:26 mmarco]:
> I see the usefulness of the specialization morphisms. My concerns is more a conceptual one, about them being no "real" morphisms in the mathematical sense when fraction fields are involved, since a morphism should be defined by all values of the domain. But it might be that the usefulness overwheights the mathematical inacuracy


The domain of definition for such specializations would be some relevant local ring. I think it will be easier to handle these using a partial homomorphism as is done now. Perhaps a doctest and a comment on that these maps may be partial.



---

archive/issue_comments_213786.json:
```json
{
    "body": "Ok then. Maybe that comment could be handled in a different ticket (maybe we could even try to implement localization rings)?. \n\nThis one already has plenty of code to review.",
    "created_at": "2021-10-11T12:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213786",
    "user": "https://github.com/miguelmarco"
}
```

Ok then. Maybe that comment could be handled in a different ticket (maybe we could even try to implement localization rings)?. 

This one already has plenty of code to review.



---

archive/issue_comments_213787.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-14T11:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213787",
    "user": "https://github.com/miguelmarco"
}
```

New commits:



---

archive/issue_comments_213788.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-19T09:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213788",
    "user": "https://github.com/miguelmarco"
}
```

New commits:



---

archive/issue_comments_213789.json:
```json
{
    "body": "I found that there was a branch problem with the branch name starting with a slash. I changed it and now git trac seems to work ok.\n\nSorry to those that had problems trying to check it out.",
    "created_at": "2021-10-19T09:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213789",
    "user": "https://github.com/miguelmarco"
}
```

I found that there was a branch problem with the branch name starting with a slash. I changed it and now git trac seems to work ok.

Sorry to those that had problems trying to check it out.



---

archive/issue_comments_213790.json:
```json
{
    "body": "Some minor things:\n\n- Not that it matters too much since they are `cdef` functions, but in `si2sa_QQ` and similar methods, the `INPUT:` and `OUTPUT:` blocks should not be indented, and it should be\n  {{{\n    - ``_ ring`` -- a (pointer to) a singular ring, in whose coefficient field\n      lives ``n``\n  }}}\n- It would be nice to get rid of some of the blanklines between blocks in the documentation. For example, in `sa2si_transext_FF`.\n- These parentheses are extraneous: `if (nMapFuncPtr is NULL):`.\n- Is it possible to combine these `if` statements?\n  {{{#!diff\n+    elif (isinstance(elem._parent, FractionField_generic)\n+          and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field))\n+        if isinstance(elem._parent.base().base_ring(), RationalField):\n             return sa2si_transext_QQ(elem, _ring)\n+        elif isinstance(elem._parent.base().base_ring(), FiniteField_prime_modn):\n+            return sa2si_transext_FF(elem, _ring)\n-    elif isinstance(elem._parent, FractionField_generic) and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field)) and isinstance(elem._parent.base().base_ring(), RationalField):\n-        return sa2si_transext_QQ(elem, _ring)\n-\n-    elif isinstance(elem._parent, FractionField_generic) and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field)) and isinstance(elem._parent.base().base_ring(), FiniteField_prime_modn):\n-        return sa2si_transext_FF(elem, _ring)\n  }}}\n  They are checking all but the last condition, and I don't think a failure of the last one. Then remove the `else:` (but keeping the `raise ValueError` of course). This makes it more clear about how the code should work.",
    "created_at": "2021-10-27T05:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213790",
    "user": "https://github.com/tscrim"
}
```

Some minor things:

- Not that it matters too much since they are `cdef` functions, but in `si2sa_QQ` and similar methods, the `INPUT:` and `OUTPUT:` blocks should not be indented, and it should be
  {{{
    - ``_ ring`` -- a (pointer to) a singular ring, in whose coefficient field
      lives ``n``
  }}}
- It would be nice to get rid of some of the blanklines between blocks in the documentation. For example, in `sa2si_transext_FF`.
- These parentheses are extraneous: `if (nMapFuncPtr is NULL):`.
- Is it possible to combine these `if` statements?
  {{{#!diff
+    elif (isinstance(elem._parent, FractionField_generic)
+          and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field))
+        if isinstance(elem._parent.base().base_ring(), RationalField):
             return sa2si_transext_QQ(elem, _ring)
+        elif isinstance(elem._parent.base().base_ring(), FiniteField_prime_modn):
+            return sa2si_transext_FF(elem, _ring)
-    elif isinstance(elem._parent, FractionField_generic) and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field)) and isinstance(elem._parent.base().base_ring(), RationalField):
-        return sa2si_transext_QQ(elem, _ring)
-
-    elif isinstance(elem._parent, FractionField_generic) and isinstance(elem._parent.base(), (MPolynomialRing_libsingular, PolynomialRing_field)) and isinstance(elem._parent.base().base_ring(), FiniteField_prime_modn):
-        return sa2si_transext_FF(elem, _ring)
  }}}
  They are checking all but the last condition, and I don't think a failure of the last one. Then remove the `else:` (but keeping the `raise ValueError` of course). This makes it more clear about how the code should work.



---

archive/issue_comments_213791.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-27T17:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_213792.json:
```json
{
    "body": "Thanks for the review.",
    "created_at": "2021-10-27T17:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213792",
    "user": "https://github.com/miguelmarco"
}
```

Thanks for the review.



---

archive/issue_comments_213793.json:
```json
{
    "body": "Setting the author so the patchbot will run.",
    "created_at": "2021-11-03T08:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213793",
    "user": "https://github.com/tscrim"
}
```

Setting the author so the patchbot will run.



---

archive/issue_comments_213794.json:
```json
{
    "body": "Linter complains about an unused variable in a method for matrix groups, which is rewriten to use this interface in #19391.\n\nAnyways, in the current implementation, that assignation is necesary to create the corresponding singular ring, even if the python variable is not used later. The linter is just not smart enough in this case.",
    "created_at": "2021-11-04T16:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213794",
    "user": "https://github.com/miguelmarco"
}
```

Linter complains about an unused variable in a method for matrix groups, which is rewriten to use this interface in #19391.

Anyways, in the current implementation, that assignation is necesary to create the corresponding singular ring, even if the python variable is not used later. The linter is just not smart enough in this case.



---

archive/issue_comments_213795.json:
```json
{
    "body": "There are some failures reported by the patchbot:\n\n```\nsage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 1 doctest failed\nsage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/combinat/root_system/non_symmetric_macdonald_polynomials.py  # 1 doctest failed\nsage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/interfaces/expect.py  # 2 doctests failed\n```",
    "created_at": "2021-11-06T01:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213795",
    "user": "https://github.com/tscrim"
}
```

There are some failures reported by the patchbot:

```
sage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 1 doctest failed
sage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/combinat/root_system/non_symmetric_macdonald_polynomials.py  # 1 doctest failed
sage -t --long --random-seed=65607106580737169923545380617831998347 src/sage/interfaces/expect.py  # 2 doctests failed
```



---

archive/issue_comments_213796.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-06T01:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213796",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_213797.json:
```json
{
    "body": "I can't reproduce the error in pexpect or projective_ds.py (I suspect somehow the file i am testing is different from the one in the patchbot).\n\nAbout the error in macdonald polynomials, I found that it is due to one function creating polynomials in x0, x1... and the other on x1, x2 ...    Will look into it.",
    "created_at": "2021-11-06T12:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213797",
    "user": "https://github.com/miguelmarco"
}
```

I can't reproduce the error in pexpect or projective_ds.py (I suspect somehow the file i am testing is different from the one in the patchbot).

About the error in macdonald polynomials, I found that it is due to one function creating polynomials in x0, x1... and the other on x1, x2 ...    Will look into it.



---

archive/issue_comments_213798.json:
```json
{
    "body": "By rebasing to the newest develop version, I can reproduce the error in `src/sage/dynamics/arithmetic_dynamics/projective_ds.py`. It has to do with code added in #31994. \n\nI am trying to debug it, but it is quite complicated. Adding the people involved in that ticket to cc for help.",
    "created_at": "2021-11-06T21:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213798",
    "user": "https://github.com/miguelmarco"
}
```

By rebasing to the newest develop version, I can reproduce the error in `src/sage/dynamics/arithmetic_dynamics/projective_ds.py`. It has to do with code added in #31994. 

I am trying to debug it, but it is quite complicated. Adding the people involved in that ticket to cc for help.



---

archive/issue_comments_213799.json:
```json
{
    "body": "I've traced the error to the `affine_patch` function in src/sage/schemes/projective/projective_subscheme.py. The error is caused by code equivalent to the following\n\n```\nsage: T.<c,d> = QQ[]\nsage: F = FractionField(T)\nsage: R.<x,y,z> = F[]\nsage: Q = F['x', 'z']\nsage: f = R(d*z^2 + c*y*z^2)\nsage: f((Q.gens()[0], 1, Q.gens()[1]))\nTypeError\n```\nMy usual workaround here is to create a dictionary and attempt `f.subs()`, however,\n\n```\nf.subs({x: Q.gens()[0], y: 1, z:Q.gens()[1]})\n```\ncrashes Sage.",
    "created_at": "2021-11-07T03:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213799",
    "user": "https://github.com/EnderWannabe"
}
```

I've traced the error to the `affine_patch` function in src/sage/schemes/projective/projective_subscheme.py. The error is caused by code equivalent to the following

```
sage: T.<c,d> = QQ[]
sage: F = FractionField(T)
sage: R.<x,y,z> = F[]
sage: Q = F['x', 'z']
sage: f = R(d*z^2 + c*y*z^2)
sage: f((Q.gens()[0], 1, Q.gens()[1]))
TypeError
```
My usual workaround here is to create a dictionary and attempt `f.subs()`, however,

```
f.subs({x: Q.gens()[0], y: 1, z:Q.gens()[1]})
```
crashes Sage.



---

archive/issue_comments_213800.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-07T17:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_213801.json:
```json
{
    "body": "Thanks for the hint. I could pinpoint the origin of both problems. This should solve it. \n\nI still can't reproduce the error in `expect.py`. Can somebody confirm it happens?",
    "created_at": "2021-11-07T17:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213801",
    "user": "https://github.com/miguelmarco"
}
```

Thanks for the hint. I could pinpoint the origin of both problems. This should solve it. 

I still can't reproduce the error in `expect.py`. Can somebody confirm it happens?



---

archive/issue_comments_213802.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-07T17:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213802",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_213803.json:
```json
{
    "body": "One of the patchbot passes all tests, and complains only abut the unused variable (that is actually needed to prevent gargage collection). The other patchbots have what seem to be unrelated problems.\n\nIs it ok to merge this in this state? or should I do some dummy operation with the variable to make pyflakes happy?",
    "created_at": "2021-11-12T12:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213803",
    "user": "https://github.com/miguelmarco"
}
```

One of the patchbot passes all tests, and complains only abut the unused variable (that is actually needed to prevent gargage collection). The other patchbots have what seem to be unrelated problems.

Is it ok to merge this in this state? or should I do some dummy operation with the variable to make pyflakes happy?



---

archive/issue_comments_213804.json:
```json
{
    "body": "Then it is a spurious error. I wouldn't worry about the pyflakes error. Thank you.",
    "created_at": "2021-11-12T13:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213804",
    "user": "https://github.com/tscrim"
}
```

Then it is a spurious error. I wouldn't worry about the pyflakes error. Thank you.



---

archive/issue_comments_213805.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-12T13:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213805",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_213806.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-11-13T17:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213806",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_213807.json:
```json
{
    "body": "On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/rings/polynomial/polydict.pyx\", line 1628, in sage.rings.polynomial.polydict.ETuple.eadd\nFailed example:\n    y^(2^32)\nExpected:\n    Traceback (most recent call last):\n    ...\n    OverflowError: exponent overflow (...)\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.polynomial.polydict.ETuple.eadd[6]>\", line 1, in <module>\n        y**(Integer(2)**Integer(32))\n      File \"sage/rings/polynomial/multi_polynomial_libsingular.pyx\", line 2467, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__ (build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:23166)\n        singular_polynomial_pow(&_p, self._poly, exp, _ring)\n    OverflowError: Python int too large to convert to C unsigned long\n**********************************************************************\n1 item had failures:\n   1 of   8 in sage.rings.polynomial.polydict.ETuple.eadd\n    [276 tests, 1 failure, 0.26 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=307417638528231788267817062701073757912 src/sage/rings/polynomial/polydict.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2021-11-13T17:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213807",
    "user": "https://github.com/vbraun"
}
```

On 32-bit:

```
**********************************************************************
File "src/sage/rings/polynomial/polydict.pyx", line 1628, in sage.rings.polynomial.polydict.ETuple.eadd
Failed example:
    y^(2^32)
Expected:
    Traceback (most recent call last):
    ...
    OverflowError: exponent overflow (...)
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.polydict.ETuple.eadd[6]>", line 1, in <module>
        y**(Integer(2)**Integer(32))
      File "sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 2467, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomial_libsingular.__pow__ (build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:23166)
        singular_polynomial_pow(&_p, self._poly, exp, _ring)
    OverflowError: Python int too large to convert to C unsigned long
**********************************************************************
1 item had failures:
   1 of   8 in sage.rings.polynomial.polydict.ETuple.eadd
    [276 tests, 1 failure, 0.26 s]
----------------------------------------------------------------------
sage -t --long --random-seed=307417638528231788267817062701073757912 src/sage/rings/polynomial/polydict.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_213808.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-13T22:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213808",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_213809.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-11-14T00:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213809",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_213810.json:
```json
{
    "body": "LGTM.",
    "created_at": "2021-11-14T00:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213810",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_events_048629.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-11-15T23:16:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16330#event-48629"
}
```



---

archive/issue_comments_213811.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-11-15T23:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16330#issuecomment-213811",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
