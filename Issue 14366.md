# Issue 14366: cythonize out of tree

Issue created by migration from Trac.

Original creator: ohanar

Original creation time: 2013-05-12 06:27:21

Assignee: GeorgSWeber

CC:  leif robertwb jdemeyer

Nice for at least two reasons:

1. Can grep through source code and not pick up any matches from autogenerated c files
1. (mostly for git) Don't have to have all c/cpp files ignored by revision control


---

Comment by ohanar created at 2013-05-12 06:42:04

Changing status from new to needs_review.


---

Attachment

spkg diff


---

Comment by jdemeyer created at 2013-05-15 10:41:58

Doesn't

```
cdef extern from *:
```

work instead of "empty.h"?


---

Comment by ohanar created at 2013-05-15 22:50:38

apply to sage library


---

Attachment

yup, new patch does that instead


---

Comment by jdemeyer created at 2013-05-17 08:31:40

Why are some `c_lib` header files copied to `build/cythonized/c_lib`, is that supposed to be? I'm not saying it is a bad thing, I am just trying to understand what is happening.

```
buildbot`@`sage sage$ ls -l devel/sage/build/cythonized/c_lib/include/
total 74k
4.1k -rw-r--r-- 2 buildbot buildbot  254 2013-05-16 23:52 convert.h
4.1k -rw-r--r-- 2 buildbot buildbot 3.8k 2013-05-16 23:52 ginac_wrap.h
4.1k -rw-r--r-- 2 buildbot buildbot  545 2013-05-16 23:52 gmp_globals.h
 17k -rw-r--r-- 2 buildbot buildbot  15k 2013-05-16 23:52 interrupt.h
4.1k -rw-r--r-- 2 buildbot buildbot  128 2013-05-16 23:52 mpz_longlong.h
4.1k -rw-r--r-- 2 buildbot buildbot  380 2013-05-16 23:52 mpz_pylong.h
 17k -rw-r--r-- 2 buildbot buildbot  13k 2013-05-16 23:52 ntl_wrap.h
8.2k -rw-r--r-- 2 buildbot buildbot 6.1k 2013-05-16 23:52 pb_wrap.h
8.2k -rw-r--r-- 2 buildbot buildbot 5.2k 2013-05-16 23:52 stdsage.h
4.1k -rw-r--r-- 2 buildbot buildbot 1.2k 2013-05-16 23:52 ZZ_pylong.h
```



---

Comment by ohanar created at 2013-05-17 09:23:37

Every file that is in `SAGE_SRC` that is detected as a dependency or source file for an extension module will be copied to `SAGE_SRC/build/cythonized` (this is to make sure that including with relative paths still works). Since `SAGE_LOCAL/include/csage` is symlinked to a subdirectory of `SAGE_SRC`, these particular files appear. They won't actually be used during compilation since these files were never included using a relative path (at least as far as I'm aware).


---

Comment by jdemeyer created at 2013-05-19 10:42:45

Resolution: fixed


---

Comment by leif created at 2013-05-31 04:44:30

Oh, boys...

This completely breaks `sage -sync-build`! >8O


---

Comment by leif created at 2013-06-01 14:01:14

We should probably wait with this feature until Cython supports a true `VPATH`, or at least symlinks the source files instead of copying all of them.

P.S.: GNU `grep` supports inclusion / exclusion of files / dirs /  filename patterns, to be specified on the command line or taken from a file (similar to `tar`).  And (probably dynamically) generating `.gitignore` files shouldn't be too hard either.


---

Comment by jdemeyer created at 2013-06-11 19:56:31

Reverting this patch in #14721.


---

Comment by felixs created at 2013-06-12 07:33:34

gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.

once sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.

if the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.


---

Comment by jdemeyer created at 2013-06-12 09:09:46

Replying to [comment:12 felixs]:
> gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.
> 
> once sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.
> 
> if the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.

This kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage.


---

Comment by jdemeyer created at 2013-06-12 09:13:38

Also note that Python doesn't use `automake` either. So what you ask might not easily be doable.


---

Comment by felixs created at 2013-06-15 15:53:35

Replying to [comment:13 jdemeyer]:
> This kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage. 

The build system choice is clearly on the sage side. Just because the
"build system" that cython provides lacks functionality, doesn't mean
that I expect them to fix it.

Replying to [comment:14 jdemeyer]:
> Also note that Python doesn't use `automake` either. 

What are you trying to say (I dont want python to use automake.)?

Do you agree that
- Sage is built mostly by cython and gcc,
- gcc does not use distutils and
- Sage is not python?

> So what you ask might not easily be doable.

I am not asking for anything. Its just a proposal on how to fix it.

Most things are implemented and ready-to-use within autotools, much more
than distutils can ever dream of. Currently, just cython build rules
need to be added manually (and are supported like any other custom build
rules). native support for pyx->c->so within autotools is just a
question of time.

Note that one alternative would be autogenerating setup.py and
module_list.py from templates with autoconf (yes, autoconf implements
the checks we need). I doubt that this can either be as functional nor
maintainable as a clean-room autotools-based implementation...

And yes, it's doable with autotools. Any better ideas?


---

Comment by jdemeyer created at 2013-06-16 09:03:26

Replying to [comment:15 felixs]:
> The build system choice is clearly on the sage side. Just because the "build system" that cython provides lacks functionality, doesn't mean that I expect them to fix it. 
Sage uses Cython's `cythonize()` as build system. There is Cython-the-compiler and `cythonize+distutils`-the-build-system.

> Do you agree that
> - Sage is built mostly by cython and gcc,
For different meanings of "built by": yes.


---

Comment by jdemeyer created at 2013-06-16 09:04:42

Replying to [comment:15 felixs]:
> Most things are implemented and ready-to-use within autotools
Really, does autotools support Cython dependency checking?


---

Comment by felixs created at 2013-06-16 09:09:50

Replying to [comment:17 jdemeyer]:
> Really, does autotools support Cython dependency checking?

Thats a question of wheter cython supports writing out dependencies. See #14728 for a patch.
