# Issue 14366: cythonize out of tree

archive/issues_014366.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  leif robertwb jdemeyer\n\nNice for at least two reasons:\n\n1. Can grep through source code and not pick up any matches from autogenerated c files\n2. (mostly for git) Don't have to have all c/cpp files ignored by revision control\n\nIssue created by migration from https://trac.sagemath.org/ticket/14570\n\n",
    "created_at": "2013-05-12T06:27:21Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "cythonize out of tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14366",
    "user": "ohanar"
}
```
Assignee: GeorgSWeber

CC:  leif robertwb jdemeyer

Nice for at least two reasons:

1. Can grep through source code and not pick up any matches from autogenerated c files
2. (mostly for git) Don't have to have all c/cpp files ignored by revision control

Issue created by migration from https://trac.sagemath.org/ticket/14570





---

archive/issue_comments_181480.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-12T06:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181480",
    "user": "ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_181481.json:
```json
{
    "body": "Attachment [cython-0.19.1.p0.diff](tarball://root/attachments/some-uuid/ticket14570/cython-0.19.1.p0.diff) by ohanar created at 2013-05-12 06:42:16\n\nspkg diff",
    "created_at": "2013-05-12T06:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181481",
    "user": "ohanar"
}
```

Attachment [cython-0.19.1.p0.diff](tarball://root/attachments/some-uuid/ticket14570/cython-0.19.1.p0.diff) by ohanar created at 2013-05-12 06:42:16

spkg diff



---

archive/issue_comments_181482.json:
```json
{
    "body": "Doesn't\n\n```\ncdef extern from *:\n```\n\nwork instead of \"empty.h\"?",
    "created_at": "2013-05-15T10:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181482",
    "user": "jdemeyer"
}
```

Doesn't

```
cdef extern from *:
```

work instead of "empty.h"?



---

archive/issue_comments_181483.json:
```json
{
    "body": "apply to sage library",
    "created_at": "2013-05-15T22:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181483",
    "user": "ohanar"
}
```

apply to sage library



---

archive/issue_comments_181484.json:
```json
{
    "body": "Attachment [trac14570.patch](tarball://root/attachments/some-uuid/ticket14570/trac14570.patch) by ohanar created at 2013-05-15 22:51:00\n\nyup, new patch does that instead",
    "created_at": "2013-05-15T22:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181484",
    "user": "ohanar"
}
```

Attachment [trac14570.patch](tarball://root/attachments/some-uuid/ticket14570/trac14570.patch) by ohanar created at 2013-05-15 22:51:00

yup, new patch does that instead



---

archive/issue_comments_181485.json:
```json
{
    "body": "Why are some `c_lib` header files copied to `build/cythonized/c_lib`, is that supposed to be? I'm not saying it is a bad thing, I am just trying to understand what is happening.\n\n```\nbuildbot@sage sage$ ls -l devel/sage/build/cythonized/c_lib/include/\ntotal 74k\n4.1k -rw-r--r-- 2 buildbot buildbot  254 2013-05-16 23:52 convert.h\n4.1k -rw-r--r-- 2 buildbot buildbot 3.8k 2013-05-16 23:52 ginac_wrap.h\n4.1k -rw-r--r-- 2 buildbot buildbot  545 2013-05-16 23:52 gmp_globals.h\n 17k -rw-r--r-- 2 buildbot buildbot  15k 2013-05-16 23:52 interrupt.h\n4.1k -rw-r--r-- 2 buildbot buildbot  128 2013-05-16 23:52 mpz_longlong.h\n4.1k -rw-r--r-- 2 buildbot buildbot  380 2013-05-16 23:52 mpz_pylong.h\n 17k -rw-r--r-- 2 buildbot buildbot  13k 2013-05-16 23:52 ntl_wrap.h\n8.2k -rw-r--r-- 2 buildbot buildbot 6.1k 2013-05-16 23:52 pb_wrap.h\n8.2k -rw-r--r-- 2 buildbot buildbot 5.2k 2013-05-16 23:52 stdsage.h\n4.1k -rw-r--r-- 2 buildbot buildbot 1.2k 2013-05-16 23:52 ZZ_pylong.h\n```\n",
    "created_at": "2013-05-17T08:31:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181485",
    "user": "jdemeyer"
}
```

Why are some `c_lib` header files copied to `build/cythonized/c_lib`, is that supposed to be? I'm not saying it is a bad thing, I am just trying to understand what is happening.

```
buildbot@sage sage$ ls -l devel/sage/build/cythonized/c_lib/include/
total 74k
4.1k -rw-r--r-- 2 buildbot buildbot  254 2013-05-16 23:52 convert.h
4.1k -rw-r--r-- 2 buildbot buildbot 3.8k 2013-05-16 23:52 ginac_wrap.h
4.1k -rw-r--r-- 2 buildbot buildbot  545 2013-05-16 23:52 gmp_globals.h
 17k -rw-r--r-- 2 buildbot buildbot  15k 2013-05-16 23:52 interrupt.h
4.1k -rw-r--r-- 2 buildbot buildbot  128 2013-05-16 23:52 mpz_longlong.h
4.1k -rw-r--r-- 2 buildbot buildbot  380 2013-05-16 23:52 mpz_pylong.h
 17k -rw-r--r-- 2 buildbot buildbot  13k 2013-05-16 23:52 ntl_wrap.h
8.2k -rw-r--r-- 2 buildbot buildbot 6.1k 2013-05-16 23:52 pb_wrap.h
8.2k -rw-r--r-- 2 buildbot buildbot 5.2k 2013-05-16 23:52 stdsage.h
4.1k -rw-r--r-- 2 buildbot buildbot 1.2k 2013-05-16 23:52 ZZ_pylong.h
```




---

archive/issue_comments_181486.json:
```json
{
    "body": "Every file that is in `SAGE_SRC` that is detected as a dependency or source file for an extension module will be copied to `SAGE_SRC/build/cythonized` (this is to make sure that including with relative paths still works). Since `SAGE_LOCAL/include/csage` is symlinked to a subdirectory of `SAGE_SRC`, these particular files appear. They won't actually be used during compilation since these files were never included using a relative path (at least as far as I'm aware).",
    "created_at": "2013-05-17T09:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181486",
    "user": "ohanar"
}
```

Every file that is in `SAGE_SRC` that is detected as a dependency or source file for an extension module will be copied to `SAGE_SRC/build/cythonized` (this is to make sure that including with relative paths still works). Since `SAGE_LOCAL/include/csage` is symlinked to a subdirectory of `SAGE_SRC`, these particular files appear. They won't actually be used during compilation since these files were never included using a relative path (at least as far as I'm aware).



---

archive/issue_comments_181487.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-19T10:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181487",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_181488.json:
```json
{
    "body": "Oh, boys...\n\nThis completely breaks `sage -sync-build`! >8O",
    "created_at": "2013-05-31T04:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181488",
    "user": "leif"
}
```

Oh, boys...

This completely breaks `sage -sync-build`! >8O



---

archive/issue_comments_181489.json:
```json
{
    "body": "We should probably wait with this feature until Cython supports a true `VPATH`, or at least symlinks the source files instead of copying all of them.\n\nP.S.: GNU `grep` supports inclusion / exclusion of files / dirs /  filename patterns, to be specified on the command line or taken from a file (similar to `tar`).  And (probably dynamically) generating `.gitignore` files shouldn't be too hard either.",
    "created_at": "2013-06-01T14:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181489",
    "user": "leif"
}
```

We should probably wait with this feature until Cython supports a true `VPATH`, or at least symlinks the source files instead of copying all of them.

P.S.: GNU `grep` supports inclusion / exclusion of files / dirs /  filename patterns, to be specified on the command line or taken from a file (similar to `tar`).  And (probably dynamically) generating `.gitignore` files shouldn't be too hard either.



---

archive/issue_comments_181490.json:
```json
{
    "body": "Reverting this patch in #14721.",
    "created_at": "2013-06-11T19:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181490",
    "user": "jdemeyer"
}
```

Reverting this patch in #14721.



---

archive/issue_comments_181491.json:
```json
{
    "body": "gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.\n\nonce sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.\n\nif the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.",
    "created_at": "2013-06-12T07:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181491",
    "user": "felixs"
}
```

gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.

once sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.

if the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.



---

archive/issue_comments_181492.json:
```json
{
    "body": "Replying to [comment:12 felixs]:\n> gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.\n> \n> once sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.\n> \n> if the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.\n\nThis kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage.",
    "created_at": "2013-06-12T09:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181492",
    "user": "jdemeyer"
}
```

Replying to [comment:12 felixs]:
> gnu autotools has VPATH support. it should be implemented with the usual interface, not with ad-hoc hacks.
> 
> once sage (the distribution) is configurable (im working on it...) it will be extemely convenient to be able to have differently configured sage builds without complicating/breaking the internal sage build logic even more.
> 
> if the cythonize doesnt support VPATH cleanly (yet?) use autotools for the build. it's much simpler, straightforward, faster and well designed. no need to reinvent the wheel.

This kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage.



---

archive/issue_comments_181493.json:
```json
{
    "body": "Also note that Python doesn't use `automake` either. So what you ask might not easily be doable.",
    "created_at": "2013-06-12T09:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181493",
    "user": "jdemeyer"
}
```

Also note that Python doesn't use `automake` either. So what you ask might not easily be doable.



---

archive/issue_comments_181494.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> This kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage. \n\nThe build system choice is clearly on the sage side. Just because the\n\"build system\" that cython provides lacks functionality, doesn't mean\nthat I expect them to fix it.\n\nReplying to [comment:14 jdemeyer]:\n> Also note that Python doesn't use `automake` either. \n\nWhat are you trying to say (I dont want python to use automake.)?\n\nDo you agree that\n- Sage is built mostly by cython and gcc,\n- gcc does not use distutils and\n- Sage is not python?\n\n> So what you ask might not easily be doable.\n\nI am not asking for anything. Its just a proposal on how to fix it.\n\nMost things are implemented and ready-to-use within autotools, much more\nthan distutils can ever dream of. Currently, just cython build rules\nneed to be added manually (and are supported like any other custom build\nrules). native support for pyx->c->so within autotools is just a\nquestion of time.\n\nNote that one alternative would be autogenerating setup.py and\nmodule_list.py from templates with autoconf (yes, autoconf implements\nthe checks we need). I doubt that this can either be as functional nor\nmaintainable as a clean-room autotools-based implementation...\n\nAnd yes, it's doable with autotools. Any better ideas?",
    "created_at": "2013-06-15T15:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181494",
    "user": "felixs"
}
```

Replying to [comment:13 jdemeyer]:
> This kind of feedback should really be directed to Cython upstream. If somebody is reinventing the wheel here, it's Cython, not Sage. 

The build system choice is clearly on the sage side. Just because the
"build system" that cython provides lacks functionality, doesn't mean
that I expect them to fix it.

Replying to [comment:14 jdemeyer]:
> Also note that Python doesn't use `automake` either. 

What are you trying to say (I dont want python to use automake.)?

Do you agree that
- Sage is built mostly by cython and gcc,
- gcc does not use distutils and
- Sage is not python?

> So what you ask might not easily be doable.

I am not asking for anything. Its just a proposal on how to fix it.

Most things are implemented and ready-to-use within autotools, much more
than distutils can ever dream of. Currently, just cython build rules
need to be added manually (and are supported like any other custom build
rules). native support for pyx->c->so within autotools is just a
question of time.

Note that one alternative would be autogenerating setup.py and
module_list.py from templates with autoconf (yes, autoconf implements
the checks we need). I doubt that this can either be as functional nor
maintainable as a clean-room autotools-based implementation...

And yes, it's doable with autotools. Any better ideas?



---

archive/issue_comments_181495.json:
```json
{
    "body": "Replying to [comment:15 felixs]:\n> The build system choice is clearly on the sage side. Just because the \"build system\" that cython provides lacks functionality, doesn't mean that I expect them to fix it. \nSage uses Cython's `cythonize()` as build system. There is Cython-the-compiler and `cythonize+distutils`-the-build-system.\n\n> Do you agree that\n> - Sage is built mostly by cython and gcc,\nFor different meanings of \"built by\": yes.",
    "created_at": "2013-06-16T09:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181495",
    "user": "jdemeyer"
}
```

Replying to [comment:15 felixs]:
> The build system choice is clearly on the sage side. Just because the "build system" that cython provides lacks functionality, doesn't mean that I expect them to fix it. 
Sage uses Cython's `cythonize()` as build system. There is Cython-the-compiler and `cythonize+distutils`-the-build-system.

> Do you agree that
> - Sage is built mostly by cython and gcc,
For different meanings of "built by": yes.



---

archive/issue_comments_181496.json:
```json
{
    "body": "Replying to [comment:15 felixs]:\n> Most things are implemented and ready-to-use within autotools\nReally, does autotools support Cython dependency checking?",
    "created_at": "2013-06-16T09:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181496",
    "user": "jdemeyer"
}
```

Replying to [comment:15 felixs]:
> Most things are implemented and ready-to-use within autotools
Really, does autotools support Cython dependency checking?



---

archive/issue_comments_181497.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Really, does autotools support Cython dependency checking?\n\nThats a question of wheter cython supports writing out dependencies. See #14728 for a patch.",
    "created_at": "2013-06-16T09:09:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14366#issuecomment-181497",
    "user": "felixs"
}
```

Replying to [comment:17 jdemeyer]:
> Really, does autotools support Cython dependency checking?

Thats a question of wheter cython supports writing out dependencies. See #14728 for a patch.
