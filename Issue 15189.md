# Issue 15189: Performance of casting ZZ[x] to Qp[x]

archive/issues_015189.json:
```json
{
    "body": "CC:  roed caruso\n\nKeywords: performance padic polynomial casting\n\nOne probably expects that casting ZZ[x] to Qp[x] is at least as fast as casting QQ[x] to Q[x].\nThis appeared not to be the case:\n\n```\nsage: prim=primes_first_n(1000)\nsage: ZZX=ZZ['x']\nsage: QQX=QQ['x']\nsage: polysZZ = [ ZZX(prim[i:i+30]) for i in range(1,900)]\nsage: polysQQ = [ QQX(prim[i:i+30]) for i in range(1,900)]\nsage: QP=Qp(3,30);\nsage: QPX=QP['x']\n\nsage: def test1(PR,l):\n    return [PR(P) for P in l];\nsage: %timeit test1(QPX,polysZZ)\n1 loops, best of 3: 395 ms per loop\nsage: %timeit test1(QPX,polysQQ)\n1 loops, best of 3: 244 ms per loop\n```\n\nThis appears to have been caused by unneccisary repeat virtual function calls in polynomial_padic_capped_relative_dense::_comp_valaddeds. The number of excess calls was proportional to the degree of the polynomial, hence this likely does not cause noticeable performance issue for very low degree polynomials.\n\nThe attached patch should correct this, I have new timings\n\n```\nsage: %timeit test1(QPX,polysZZ)\n1 loops, best of 3: 171 ms per loop\nsage: %timeit test1(QPX,polysQQ)\n1 loops, best of 3: 256 ms per loop\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15426\n\n",
    "created_at": "2013-11-16T13:25:07Z",
    "labels": [
        "performance",
        "minor",
        "enhancement"
    ],
    "title": "Performance of casting ZZ[x] to Qp[x]",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15189",
    "user": "afiori"
}
```
CC:  roed caruso

Keywords: performance padic polynomial casting

One probably expects that casting ZZ[x] to Qp[x] is at least as fast as casting QQ[x] to Q[x].
This appeared not to be the case:

```
sage: prim=primes_first_n(1000)
sage: ZZX=ZZ['x']
sage: QQX=QQ['x']
sage: polysZZ = [ ZZX(prim[i:i+30]) for i in range(1,900)]
sage: polysQQ = [ QQX(prim[i:i+30]) for i in range(1,900)]
sage: QP=Qp(3,30);
sage: QPX=QP['x']

sage: def test1(PR,l):
    return [PR(P) for P in l];
sage: %timeit test1(QPX,polysZZ)
1 loops, best of 3: 395 ms per loop
sage: %timeit test1(QPX,polysQQ)
1 loops, best of 3: 244 ms per loop
```

This appears to have been caused by unneccisary repeat virtual function calls in polynomial_padic_capped_relative_dense::_comp_valaddeds. The number of excess calls was proportional to the degree of the polynomial, hence this likely does not cause noticeable performance issue for very low degree polynomials.

The attached patch should correct this, I have new timings

```
sage: %timeit test1(QPX,polysZZ)
1 loops, best of 3: 171 ms per loop
sage: %timeit test1(QPX,polysQQ)
1 loops, best of 3: 256 ms per loop
```



Issue created by migration from https://trac.sagemath.org/ticket/15426





---

archive/issue_comments_195058.json:
```json
{
    "body": "Eliminate unnecessary function calls",
    "created_at": "2013-11-16T13:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195058",
    "user": "afiori"
}
```

Eliminate unnecessary function calls



---

archive/issue_comments_195059.json:
```json
{
    "body": "Attachment [PadicPolyCastingInt.patch](tarball://root/attachments/some-uuid/ticket15426/PadicPolyCastingInt.patch) by vbraun_spam created at 2014-01-30 21:20:52",
    "created_at": "2014-01-30T21:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195059",
    "user": "vbraun_spam"
}
```

Attachment [PadicPolyCastingInt.patch](tarball://root/attachments/some-uuid/ticket15426/PadicPolyCastingInt.patch) by vbraun_spam created at 2014-01-30 21:20:52



---

archive/issue_comments_195060.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-01T08:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195060",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195061.json:
```json
{
    "body": "I have made the suggested change. It does not seem to have nay impact on the speed. Maybe worth doing nevertheless. Also some other small changes, that should be good for speed.\n----\nNew commits:",
    "created_at": "2019-06-01T08:48:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195061",
    "user": "chapoton"
}
```

I have made the suggested change. It does not seem to have nay impact on the speed. Maybe worth doing nevertheless. Also some other small changes, that should be good for speed.
----
New commits:



---

archive/issue_comments_195062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-01T08:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195062",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_195063.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195063",
    "user": "embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_195064.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-12-05T08:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195064",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_195065.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195065",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_195066.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195066",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_195067.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195067",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_195068.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195068",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_195069.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-05-27T19:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195069",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_195070.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-05-27T19:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195070",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_195071.json:
```json
{
    "body": "bot is morally green, so please review !",
    "created_at": "2022-05-28T18:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195071",
    "user": "chapoton"
}
```

bot is morally green, so please review !



---

archive/issue_comments_195072.json:
```json
{
    "body": "It's not completely clear to me what really changed but it looks okay.",
    "created_at": "2022-06-02T08:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195072",
    "user": "caruso"
}
```

It's not completely clear to me what really changed but it looks okay.



---

archive/issue_comments_195073.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-06-02T08:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195073",
    "user": "caruso"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_195074.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-06-12T12:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15189",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15189#issuecomment-195074",
    "user": "vbraun"
}
```

Resolution: fixed
