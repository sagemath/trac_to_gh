# Issue 15189: Performance of casting ZZ[x] to Qp[x]

Issue created by migration from https://trac.sagemath.org/ticket/15426

Original creator: afiori

Original creation time: 2013-11-16 13:25:07

CC:  roed caruso

Keywords: performance padic polynomial casting

One probably expects that casting ZZ[x] to Qp[x] is at least as fast as casting QQ[x] to Q[x].
This appeared not to be the case:

```
sage: prim=primes_first_n(1000)
sage: ZZX=ZZ['x']
sage: QQX=QQ['x']
sage: polysZZ = [ ZZX(prim[i:i+30]) for i in range(1,900)]
sage: polysQQ = [ QQX(prim[i:i+30]) for i in range(1,900)]
sage: QP=Qp(3,30);
sage: QPX=QP['x']

sage: def test1(PR,l):
    return [PR(P) for P in l];
sage: %timeit test1(QPX,polysZZ)
1 loops, best of 3: 395 ms per loop
sage: %timeit test1(QPX,polysQQ)
1 loops, best of 3: 244 ms per loop
```

This appears to have been caused by unneccisary repeat virtual function calls in polynomial_padic_capped_relative_dense::_comp_valaddeds. The number of excess calls was proportional to the degree of the polynomial, hence this likely does not cause noticeable performance issue for very low degree polynomials.

The attached patch should correct this, I have new timings

```
sage: %timeit test1(QPX,polysZZ)
1 loops, best of 3: 171 ms per loop
sage: %timeit test1(QPX,polysQQ)
1 loops, best of 3: 256 ms per loop
```




---

Comment by afiori created at 2013-11-16 13:25:45

Eliminate unnecessary function calls


---

Attachment


---

Comment by chapoton created at 2019-06-01 08:48:58

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-06-01 08:48:58

I have made the suggested change. It does not seem to have nay impact on the speed. Maybe worth doing nevertheless. Also some other small changes, that should be good for speed.
----
New commits:


---

Comment by git created at 2019-06-01 08:49:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by chapoton created at 2019-12-05 08:33:16

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by chapoton created at 2022-05-27 19:55:19

New commits:


---

Comment by chapoton created at 2022-05-27 19:55:19

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2022-05-28 18:25:54

bot is morally green, so please review !


---

Comment by caruso created at 2022-06-02 08:55:44

It's not completely clear to me what really changed but it looks okay.


---

Comment by caruso created at 2022-06-02 08:55:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-06-12 12:16:41

Resolution: fixed
