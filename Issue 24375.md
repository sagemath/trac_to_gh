# Issue 24375: Bug in coercion of subgroups into ambient group

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2018-01-30 09:09:11

Keywords: coercion subgroup

We have

```
sage: S4 = SymmetricGroup(4)
sage: S4.has_coerce_map_from(S4.subgroups()[19])
True
```

and thus the following multiplication of an element of the ambient group with an element of the subgroup works:

```
sage: S4[1]*S4.subgroups()[19][1]
(1,4,2,3)
```


However, the opposite product doesn't work:

```
sage: S4.subgroups()[19][1]*S4[1]
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-12-0cb3cb3f749a> in <module>()
----> 1 S4.subgroups()[Integer(19)][Integer(1)]*S4[Integer(1)]

/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12205)()
   1525             return (<Element>left)._mul_(right)
   1526         if BOTH_ARE_ELEMENT(cl):
-> 1527             return coercion_model.bin_op(left, right, mul)
   1528 
   1529         cdef long value

/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:10655)()
   1131         # We should really include the underlying error.
   1132         # This causes so much headache.
-> 1133         raise bin_op_exception(op, x, y)
   1134 
   1135     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for *: 'Subgroup of (Symmetric group of order 4! as a permutation group) generated by [(1,3)(2,4), (1,4,3,2)]' and 'Symmetric group of order 4! as a permutation group'
```


I am aware that a coercion into the left factor's parent is chosen, if there are coercions in _both_ directions. However, a coercion into the right factor's parent is supposed to be used, if the opposite coercion doesn't exist.


---

Comment by SimonKing created at 2018-01-30 09:21:53

Aha! So, the problem is that Sage thinks there is a coercion from the group to the subgroup, and not only from the subgroup to the group? That would indeed explain the current behaviour (multiplying a group element with a subgroup element works, multiplying a subgroup element by a group element doesn't work).


---

Comment by jdemeyer created at 2018-06-12 13:39:37

Permutation groups still use the old coercion model. So moving to the new coercion model (unfortunately a non-trivial operation) is almost certainly going to fix this.


---

Comment by tscrim created at 2018-06-30 11:59:38

New commits:


---

Comment by tscrim created at 2018-06-30 11:59:38

Changing keywords from "coercion subgroup" to "coercion subgroup, days94".


---

Comment by tscrim created at 2018-06-30 11:59:38

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-06-30 16:39:40

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2018-06-30 17:48:30

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-06-30 17:48:30

New commits:


---

Comment by jdemeyer created at 2018-07-03 10:12:00

Why this in `_element_constructor_`?

```
        if isinstance(x, PermutationGroupElement):
            x_parent = x.parent()
            if (isinstance(x_parent, PermutationGroup_subgroup)
                and x_parent._ambient_group is self):
                return self.element_class(x.cycle_tuples(), self, check=False)

            from sage.groups.perm_gps.permgroup_named import SymmetricGroup
            compatible_domains = all(point in self._domain_to_gap
                                     for point in x_parent.domain())
            if compatible_domains and (isinstance(self, SymmetricGroup)
                                       or x._gap_() in self._gap_()):
                return self.element_class(x.cycle_tuples(), self, check=False)
```


All tests in `src/sage/groups` pass when removing that block of code.


---

Comment by jdemeyer created at 2018-07-03 10:12:00

Changing status from needs_review to needs_info.


---

Comment by git created at 2018-07-03 10:15:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-07-03 10:16:08

That is to support the old "coercions" as conversions that were previously supported. I don't think such a thing was explicitly tested, but I wanted to mitigate the number of behavioral changes.


---

Comment by git created at 2018-07-03 10:37:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-07-03 10:37:52

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2018-07-03 10:41:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-07 01:34:43

Resolution: fixed
