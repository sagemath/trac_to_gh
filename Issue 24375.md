# Issue 24375: Bug in coercion of subgroups into ambient group

archive/issues_024375.json:
```json
{
    "body": "Keywords: coercion subgroup\n\nWe have\n\n```\nsage: S4 = SymmetricGroup(4)\nsage: S4.has_coerce_map_from(S4.subgroups()[19])\nTrue\n```\n\nand thus the following multiplication of an element of the ambient group with an element of the subgroup works:\n\n```\nsage: S4[1]*S4.subgroups()[19][1]\n(1,4,2,3)\n```\n\n\nHowever, the opposite product doesn't work:\n\n```\nsage: S4.subgroups()[19][1]*S4[1]\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-12-0cb3cb3f749a> in <module>()\n----> 1 S4.subgroups()[Integer(19)][Integer(1)]*S4[Integer(1)]\n\n/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12205)()\n   1525             return (<Element>left)._mul_(right)\n   1526         if BOTH_ARE_ELEMENT(cl):\n-> 1527             return coercion_model.bin_op(left, right, mul)\n   1528 \n   1529         cdef long value\n\n/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:10655)()\n   1131         # We should really include the underlying error.\n   1132         # This causes so much headache.\n-> 1133         raise bin_op_exception(op, x, y)\n   1134 \n   1135     cpdef canonical_coercion(self, x, y):\n\nTypeError: unsupported operand parent(s) for *: 'Subgroup of (Symmetric group of order 4! as a permutation group) generated by [(1,3)(2,4), (1,4,3,2)]' and 'Symmetric group of order 4! as a permutation group'\n```\n\n\nI am aware that a coercion into the left factor's parent is chosen, if there are coercions in *both* directions. However, a coercion into the right factor's parent is supposed to be used, if the opposite coercion doesn't exist.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24612\n\n",
    "created_at": "2018-01-30T09:09:11Z",
    "labels": [
        "component: coercion",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Bug in coercion of subgroups into ambient group",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24375",
    "user": "https://github.com/simon-king-jena"
}
```
Keywords: coercion subgroup

We have

```
sage: S4 = SymmetricGroup(4)
sage: S4.has_coerce_map_from(S4.subgroups()[19])
True
```

and thus the following multiplication of an element of the ambient group with an element of the subgroup works:

```
sage: S4[1]*S4.subgroups()[19][1]
(1,4,2,3)
```


However, the opposite product doesn't work:

```
sage: S4.subgroups()[19][1]*S4[1]
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-12-0cb3cb3f749a> in <module>()
----> 1 S4.subgroups()[Integer(19)][Integer(1)]*S4[Integer(1)]

/home/king/Sage/git/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12205)()
   1525             return (<Element>left)._mul_(right)
   1526         if BOTH_ARE_ELEMENT(cl):
-> 1527             return coercion_model.bin_op(left, right, mul)
   1528 
   1529         cdef long value

/home/king/Sage/git/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:10655)()
   1131         # We should really include the underlying error.
   1132         # This causes so much headache.
-> 1133         raise bin_op_exception(op, x, y)
   1134 
   1135     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for *: 'Subgroup of (Symmetric group of order 4! as a permutation group) generated by [(1,3)(2,4), (1,4,3,2)]' and 'Symmetric group of order 4! as a permutation group'
```


I am aware that a coercion into the left factor's parent is chosen, if there are coercions in *both* directions. However, a coercion into the right factor's parent is supposed to be used, if the opposite coercion doesn't exist.

Issue created by migration from https://trac.sagemath.org/ticket/24612





---

archive/issue_comments_341092.json:
```json
{
    "body": "Aha! So, the problem is that Sage thinks there is a coercion from the group to the subgroup, and not only from the subgroup to the group? That would indeed explain the current behaviour (multiplying a group element with a subgroup element works, multiplying a subgroup element by a group element doesn't work).",
    "created_at": "2018-01-30T09:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341092",
    "user": "https://github.com/simon-king-jena"
}
```

Aha! So, the problem is that Sage thinks there is a coercion from the group to the subgroup, and not only from the subgroup to the group? That would indeed explain the current behaviour (multiplying a group element with a subgroup element works, multiplying a subgroup element by a group element doesn't work).



---

archive/issue_comments_341093.json:
```json
{
    "body": "Permutation groups still use the old coercion model. So moving to the new coercion model (unfortunately a non-trivial operation) is almost certainly going to fix this.",
    "created_at": "2018-06-12T13:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341093",
    "user": "https://github.com/jdemeyer"
}
```

Permutation groups still use the old coercion model. So moving to the new coercion model (unfortunately a non-trivial operation) is almost certainly going to fix this.



---

archive/issue_events_062015.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-06-30T11:59:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24375#event-62015"
}
```



---

archive/issue_comments_341094.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-30T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341094",
    "user": "https://github.com/tscrim"
}
```

New commits:



---

archive/issue_comments_341095.json:
```json
{
    "body": "Changing keywords from \"coercion subgroup\" to \"coercion subgroup, days94\".",
    "created_at": "2018-06-30T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341095",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "coercion subgroup" to "coercion subgroup, days94".



---

archive/issue_comments_341096.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-30T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341096",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_341097.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-30T16:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341097",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_341098.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-30T17:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341098",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_341099.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-30T17:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341099",
    "user": "https://github.com/tscrim"
}
```

New commits:



---

archive/issue_comments_341100.json:
```json
{
    "body": "Why this in `_element_constructor_`?\n\n```\n        if isinstance(x, PermutationGroupElement):\n            x_parent = x.parent()\n            if (isinstance(x_parent, PermutationGroup_subgroup)\n                and x_parent._ambient_group is self):\n                return self.element_class(x.cycle_tuples(), self, check=False)\n\n            from sage.groups.perm_gps.permgroup_named import SymmetricGroup\n            compatible_domains = all(point in self._domain_to_gap\n                                     for point in x_parent.domain())\n            if compatible_domains and (isinstance(self, SymmetricGroup)\n                                       or x._gap_() in self._gap_()):\n                return self.element_class(x.cycle_tuples(), self, check=False)\n```\n\n\nAll tests in `src/sage/groups` pass when removing that block of code.",
    "created_at": "2018-07-03T10:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341100",
    "user": "https://github.com/jdemeyer"
}
```

Why this in `_element_constructor_`?

```
        if isinstance(x, PermutationGroupElement):
            x_parent = x.parent()
            if (isinstance(x_parent, PermutationGroup_subgroup)
                and x_parent._ambient_group is self):
                return self.element_class(x.cycle_tuples(), self, check=False)

            from sage.groups.perm_gps.permgroup_named import SymmetricGroup
            compatible_domains = all(point in self._domain_to_gap
                                     for point in x_parent.domain())
            if compatible_domains and (isinstance(self, SymmetricGroup)
                                       or x._gap_() in self._gap_()):
                return self.element_class(x.cycle_tuples(), self, check=False)
```


All tests in `src/sage/groups` pass when removing that block of code.



---

archive/issue_comments_341101.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-07-03T10:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341101",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_341102.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-03T10:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341102",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341103.json:
```json
{
    "body": "That is to support the old \"coercions\" as conversions that were previously supported. I don't think such a thing was explicitly tested, but I wanted to mitigate the number of behavioral changes.",
    "created_at": "2018-07-03T10:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341103",
    "user": "https://github.com/tscrim"
}
```

That is to support the old "coercions" as conversions that were previously supported. I don't think such a thing was explicitly tested, but I wanted to mitigate the number of behavioral changes.



---

archive/issue_comments_341104.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-03T10:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341104",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_341105.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-07-03T10:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341105",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_341106.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-03T10:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341106",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_341107.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-07T01:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24375#issuecomment-341107",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_062016.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-07-07T01:34:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24375",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24375#event-62016"
}
```
