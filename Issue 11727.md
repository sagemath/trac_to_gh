# Issue 11727: Simplify some very long doctests

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-10-05 08:35:31

Assignee: mvngu

CC:  leif

Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.


---

Comment by leif created at 2011-10-05 10:26:45

And on some machines the PExpect interfaces are very slow, or frequently hang...
(There's some ticket by Simon King alleviating this in a couple of cases; don't recall the ticket number right now.)

Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.


---

Comment by jdemeyer created at 2011-10-05 10:33:32

Replying to [comment:1 leif]:
> Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.

In principle I agree, but I don't think that is implementable in a good and portable way.


---

Comment by leif created at 2011-10-05 10:42:41

P.S.: If you want to see _which line_ of a doctest takes how long, you can

```sh
$ cd $SAGE_ROOT/local/bin
$ mv ncadoctest.py ncadoctest.py.orig
$ cp -p sage:/home/leif/Sage/scripts/ncadoctest-v0.3.py ncadoctest.py
```

and test the file(s) in verbose mode.

There's no patch worth to get merged yet; I'll _one day_<sup>TM</sup> develop this further and implement this behaviour as a separate option to `sage -t ...`.

Note that with this version of `ncadoctest.py` the output when a doctest fails _in non-verbose mode_ also differs.


---

Comment by leif created at 2011-10-05 10:44:57

s/`cp`/`scp`/


---

Comment by leif created at 2011-10-05 11:08:36

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 leif]:
> > We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time [...]
> 
> In principle I agree, but I don't think that is implementable in a good and portable way.

We could use `setrlimit()` in `sage-doctest.py` (which tests just a single file, i.e., each doctested file has its own instance), or add appropriate code (e.g. setting `SIGALRM`, and checking the consumed CPU time with `getrusage()`) to the generated temporary files with the examples that get run by Python. Emitting such extra code could be optional, too.

As a first step, we could in addition print the CPU time a doctest (of a complete file) took, by using `getrusage()` in `sage-test.py` / `sage-ptest.py`


---

Comment by jdemeyer created at 2011-10-05 11:26:23

Replying to [comment:5 leif]:
> We could use `setrlimit()` in `sage-doctest.py`
This only works for one process, so it will not work well with pexpect interfaces which spawn several child processes.


---

Comment by jdemeyer created at 2011-10-05 13:30:03

Most of these timings seem to be regressions, see sage-devel.


---

Comment by jdemeyer created at 2011-10-30 14:26:06

Changing status from new to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Attachment

rebased previous patch against 4.8.alpha3


---

Comment by saraedum created at 2011-12-18 15:11:10

Apply only 11899_2.patch

(will set this to positive review when the doctests have finished)


---

Comment by saraedum created at 2011-12-18 18:22:24

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2011-12-21 15:23:56

Changing keywords from "" to "sd35".


---

Comment by jdemeyer created at 2011-12-22 13:05:45

Resolution: fixed
