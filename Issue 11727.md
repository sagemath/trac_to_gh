# Issue 11727: Simplify some very long doctests

archive/issues_011727.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  leif\n\nThroughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11899\n\n",
    "created_at": "2011-10-05T08:35:31Z",
    "labels": [
        "doctest coverage",
        "minor",
        "enhancement"
    ],
    "title": "Simplify some very long doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11727",
    "user": "jdemeyer"
}
```
Assignee: mvngu

CC:  leif

Throughout Sage, there are a few doctests taking a very long time (more than 30 seconds) but sometimes these can easily be simplified to take less time.

Issue created by migration from https://trac.sagemath.org/ticket/11899





---

archive/issue_comments_133020.json:
```json
{
    "body": "And on some machines the PExpect interfaces are very slow, or frequently hang...\n(There's some ticket by Simon King alleviating this in a couple of cases; don't recall the ticket number right now.)\n\nSlightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.",
    "created_at": "2011-10-05T10:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133020",
    "user": "leif"
}
```

And on some machines the PExpect interfaces are very slow, or frequently hang...
(There's some ticket by Simon King alleviating this in a couple of cases; don't recall the ticket number right now.)

Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.



---

archive/issue_comments_133021.json:
```json
{
    "body": "Replying to [comment:1 leif]:\n> Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.\n\nIn principle I agree, but I don't think that is implementable in a good and portable way.",
    "created_at": "2011-10-05T10:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133021",
    "user": "jdemeyer"
}
```

Replying to [comment:1 leif]:
> Slightly related: We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time, since often doctests timeout just because they don't get enough CPU when doctesting with (more or less) many threads [and] on an already loaded machine.

In principle I agree, but I don't think that is implementable in a good and portable way.



---

archive/issue_comments_133022.json:
```json
{
    "body": "P.S.: If you want to see *which line* of a doctest takes how long, you can\n\n```sh\n$ cd $SAGE_ROOT/local/bin\n$ mv ncadoctest.py ncadoctest.py.orig\n$ cp -p sage:/home/leif/Sage/scripts/ncadoctest-v0.3.py ncadoctest.py\n```\n\nand test the file(s) in verbose mode.\n\nThere's no patch worth to get merged yet; I'll *one day*<sup>TM</sup> develop this further and implement this behaviour as a separate option to `sage -t ...`.\n\nNote that with this version of `ncadoctest.py` the output when a doctest fails *in non-verbose mode* also differs.",
    "created_at": "2011-10-05T10:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133022",
    "user": "leif"
}
```

P.S.: If you want to see *which line* of a doctest takes how long, you can

```sh
$ cd $SAGE_ROOT/local/bin
$ mv ncadoctest.py ncadoctest.py.orig
$ cp -p sage:/home/leif/Sage/scripts/ncadoctest-v0.3.py ncadoctest.py
```

and test the file(s) in verbose mode.

There's no patch worth to get merged yet; I'll *one day*<sup>TM</sup> develop this further and implement this behaviour as a separate option to `sage -t ...`.

Note that with this version of `ncadoctest.py` the output when a doctest fails *in non-verbose mode* also differs.



---

archive/issue_comments_133023.json:
```json
{
    "body": "s/`cp`/`scp`/",
    "created_at": "2011-10-05T10:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133023",
    "user": "leif"
}
```

s/`cp`/`scp`/



---

archive/issue_comments_133024.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Replying to [comment:1 leif]:\n> > We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time [...]\n> \n> In principle I agree, but I don't think that is implementable in a good and portable way.\n\nWe could use `setrlimit()` in `sage-doctest.py` (which tests just a single file, i.e., each doctested file has its own instance), or add appropriate code (e.g. setting `SIGALRM`, and checking the consumed CPU time with `getrusage()`) to the generated temporary files with the examples that get run by Python. Emitting such extra code could be optional, too.\n\nAs a first step, we could in addition print the CPU time a doctest (of a complete file) took, by using `getrusage()` in `sage-test.py` / `sage-ptest.py`",
    "created_at": "2011-10-05T11:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133024",
    "user": "leif"
}
```

Replying to [comment:2 jdemeyer]:
> Replying to [comment:1 leif]:
> > We should IMHO make it such that the timeouts for doctests (perhaps optionally, or in addition) do not refer to wall but actual CPU time [...]
> 
> In principle I agree, but I don't think that is implementable in a good and portable way.

We could use `setrlimit()` in `sage-doctest.py` (which tests just a single file, i.e., each doctested file has its own instance), or add appropriate code (e.g. setting `SIGALRM`, and checking the consumed CPU time with `getrusage()`) to the generated temporary files with the examples that get run by Python. Emitting such extra code could be optional, too.

As a first step, we could in addition print the CPU time a doctest (of a complete file) took, by using `getrusage()` in `sage-test.py` / `sage-ptest.py`



---

archive/issue_comments_133025.json:
```json
{
    "body": "Replying to [comment:5 leif]:\n> We could use `setrlimit()` in `sage-doctest.py`\nThis only works for one process, so it will not work well with pexpect interfaces which spawn several child processes.",
    "created_at": "2011-10-05T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133025",
    "user": "jdemeyer"
}
```

Replying to [comment:5 leif]:
> We could use `setrlimit()` in `sage-doctest.py`
This only works for one process, so it will not work well with pexpect interfaces which spawn several child processes.



---

archive/issue_comments_133026.json:
```json
{
    "body": "Most of these timings seem to be regressions, see sage-devel.",
    "created_at": "2011-10-05T13:30:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133026",
    "user": "jdemeyer"
}
```

Most of these timings seem to be regressions, see sage-devel.



---

archive/issue_comments_133027.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-30T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133027",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133028.json:
```json
{
    "body": "Attachment [11899.patch](tarball://root/attachments/some-uuid/ticket11899/11899.patch) by jdemeyer created at 2011-10-30 14:26:06",
    "created_at": "2011-10-30T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133028",
    "user": "jdemeyer"
}
```

Attachment [11899.patch](tarball://root/attachments/some-uuid/ticket11899/11899.patch) by jdemeyer created at 2011-10-30 14:26:06



---

archive/issue_comments_133029.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133029",
    "user": "jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_133030.json:
```json
{
    "body": "Attachment [11899_2.patch](tarball://root/attachments/some-uuid/ticket11899/11899_2.patch) by saraedum created at 2011-12-18 15:09:37\n\nrebased previous patch against 4.8.alpha3",
    "created_at": "2011-12-18T15:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133030",
    "user": "saraedum"
}
```

Attachment [11899_2.patch](tarball://root/attachments/some-uuid/ticket11899/11899_2.patch) by saraedum created at 2011-12-18 15:09:37

rebased previous patch against 4.8.alpha3



---

archive/issue_comments_133031.json:
```json
{
    "body": "Apply only 11899_2.patch\n\n(will set this to positive review when the doctests have finished)",
    "created_at": "2011-12-18T15:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133031",
    "user": "saraedum"
}
```

Apply only 11899_2.patch

(will set this to positive review when the doctests have finished)



---

archive/issue_comments_133032.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-12-18T18:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133032",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_133033.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd35\".",
    "created_at": "2011-12-21T15:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133033",
    "user": "saraedum"
}
```

Changing keywords from "" to "sd35".



---

archive/issue_comments_133034.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-12-22T13:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11727",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11727#issuecomment-133034",
    "user": "jdemeyer"
}
```

Resolution: fixed
