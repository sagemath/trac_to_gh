# Issue 32041: Add support for B-terms in Asymptotic Ring

Issue created by migration from https://trac.sagemath.org/ticket/32278

Original creator: @thhagelmayer

Original creation time: 2021-07-26 13:41:30

CC:  cheuberg behackl dkrenn




---

Comment by @thhagelmayer created at 2021-07-26 13:54:22

Changing component from PLEASE CHANGE to asymptotic expansions.


---

Comment by @thhagelmayer created at 2021-07-26 13:54:22

Changing keywords from "" to "gsoc21, asymptotics".


---

Comment by @thhagelmayer created at 2021-07-26 13:54:22

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @thhagelmayer created at 2021-07-27 16:43:15

Changing status from new to needs_info.


---

Comment by @thhagelmayer created at 2021-07-27 16:43:15

I have implemented the initial functions for the usage of `B-terms` in `AsymptoticRing`.

I have three doctest errors:


```
File "src/sage/rings/asymptotic/asymptotic_ring.py", line 4691, in sage.rings.asymptotic.asymptotic_ring.AsymptoticRing.B
Failed example:
    A.B(2*x^3, {x: 5})
Exception raised:
    Traceback (most recent call last):
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.asymptotic.asymptotic_ring.AsymptoticRing.B[1]>", line 1, in <module>
        A.B(Integer(2)*x**Integer(3), {x: Integer(5)})
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/rings/asymptotic/asymptotic_ring.py", line 4694, in B
        return self.B(valid_from)
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/rings/asymptotic/asymptotic_ring.py", line 3400, in B
        return sum(self.parent().create_summand('B', growth=element, valid_from=valid_from)
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/rings/asymptotic/asymptotic_ring.py", line 3400, in <genexpr>
        return sum(self.parent().create_summand('B', growth=element, valid_from=valid_from)
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/rings/asymptotic/asymptotic_ring.py", line 4612, in create_summand
        return self(TM(data, **kwds), simplify=False, convert=False)
      File "sage/structure/parent.pyx", line 900, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9365)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5153)
        raise
      File "sage/structure/coerce_maps.pyx", line 170, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:4943)
        return C._element_constructor(x, **kwds)
      File "/home/thhagelmayer/sagemath-trac-mirror/local/lib/python3.8/site-packages/sage/rings/asymptotic/term_monoid.py", line 1829, in _element_constructor_
        return self._create_element_(data.growth, data.coefficient)
    TypeError: _create_element_() missing 1 required positional argument: 'valid_from'
```


The other two are the same from `src/sage/rings/asymptotic/asymptotic_ring.py", line 3379` and `src/sage/rings/asymptotic/asymptotic_ring.py", line 3381`.
----
Last 10 new commits:


---

Comment by dkrenn created at 2021-07-27 19:11:12

Replying to [comment:3 gh-thhagelmayer]:
> I have implemented the initial functions for the usage of `B-terms` in `AsymptoticRing`.
> 
> I have three doctest errors:
> 
> {{{
> File "src/sage/rings/asymptotic/asymptotic_ring.py", line 4691, in sage.rings.asymptotic.asymptotic_ring.AsymptoticRing.B
> Failed example:
>     A.B(2*x^3, {x: 5})
> Exception raised:
>     Traceback (most recent call last):
>     ...
>     TypeError: _create_element_() missing 1 required positional argument: 'valid_from'
> }}}
> 
> The other two are the same from `src/sage/rings/asymptotic/asymptotic_ring.py", line 3379` and `src/sage/rings/asymptotic/asymptotic_ring.py", line 3381`.

My guess, it seems like they could go away by #32229. (But anyways, it would need to be `A.B(2*x^3, valid_from={x: 5})`.


---

Comment by git created at 2021-08-07 18:34:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @thhagelmayer created at 2021-08-07 18:36:27

Changing status from needs_info to needs_review.


---

Comment by @thhagelmayer created at 2021-08-07 18:36:27

I merged #32229 into this ticket. Afterwards I could fix the doctests which were failing.
----
Last 10 new commits:


---

Comment by git created at 2021-08-11 15:16:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @thhagelmayer created at 2021-08-11 15:19:18

I moved the logic from `asymptotic_ring` to `term_monoid` and fixed the doctests.


---

Comment by tscrim created at 2021-08-12 00:50:00

Changing keywords from "gsoc21, asymptotics" to "gsoc2021, asymptotics".


---

Comment by behackl created at 2021-08-18 11:55:08

Changing status from needs_review to needs_work.


---

Comment by behackl created at 2021-08-18 11:55:08

This looks pretty functional already. Here are some remarks:

1. `AsymptoticExpansion.B`: The tests in the docstring use `AsymptoticRing.B` (which is fine in principle, but the corresponding lines should be marked with `# indirect doctest` then) -- either do this, or alternatively rewrite the tests to use `AsymptoticExpansion.B`.

2. `AsymptoticExpansion.B`, `AsymptoticRing.B`, `BTerm`: The docstring, in particular: the description of `valid_from`, should mention the "short syntax" where passing a number instead of a dictionary uses the number as the lower bound for all variables occurring in the term.

3. `AsymptoticExpansion.B` - Is there a particular reason that `valid_from` is just a positional argument, and not a keyword argument with default value 0 (like for `AsymptoticRing.B`?)

4. `NotImplementedBZeroError`: Maybe add a straightforward test like
    {{{
    sage: AR.<n> = AsymptoticRing('n^QQ', QQ)
    sage: AR(0).B(42)
    Traceback (most recent call last):
    ...
    NotImplementedBZero: got B(0)
    The error term B(0) means 0 for sufficiently large n.
    }}}


---

Comment by git created at 2021-08-18 14:39:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @thhagelmayer created at 2021-08-18 14:45:51

Replying to [comment:10 behackl]:

Thank you for the comments.

> 3. `AsymptoticExpansion.B` - Is there a particular reason that `valid_from` is just a positional argument, and not a keyword argument with default value 0 (like for `AsymptoticRing.B`?)
I thought it is not important to make the `valid_from` a keyword argument in `AsymptoticExpansion.B`, since it is already a keyword argument in `AsymptoticRing.B`. I changed it now, because I think it is more correct to have it this way.


---

Comment by @thhagelmayer created at 2021-08-18 14:45:51

Changing status from needs_work to needs_review.


---

Comment by behackl created at 2021-08-18 16:10:05

Changing status from needs_review to needs_work.


---

Comment by behackl created at 2021-08-18 16:10:05

> since it is already a keyword argument in `AsymptoticRing.B`

I see. I think it makes sense to make sure the type of arguments are consistent across the methods.


5. `sage: (2*x).B({x: 20}) # indirect doctest` -- this is actually not indirect, there you do use `AsymptoticExpansion.B`.

6. "If you pass only a number as `valid_from`": I suggest to rephrase this as "If a number is passed to `valid_from`, ...".

7. (2., continued): The docstring of `BTerm` should also be changed accordingly.


---

Comment by git created at 2021-08-19 16:12:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @thhagelmayer created at 2021-08-19 16:14:56

> 5. `sage: (2*x).B({x: 20}) # indirect doctest` -- this is actually not indirect, there you do use `AsymptoticExpansion.B`.
> 
> 6. "If you pass only a number as `valid_from`": I suggest to rephrase this as "If a number is passed to `valid_from`, ...".
> 
> 7. (2., continued): The docstring of `BTerm` should also be changed accordingly.
I have addressed these items.


---

Comment by @thhagelmayer created at 2021-08-19 16:14:56

Changing status from needs_work to needs_review.


---

Comment by behackl created at 2021-08-20 08:55:33

I've added one small commit to resolve a wording problem in the docstring, please cross-check.

Otherwise, this looks good to me now, thank you.
----
New commits:


---

Comment by behackl created at 2021-08-20 08:55:33

Changing status from needs_review to positive_review.


---

Comment by git created at 2021-08-20 09:25:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by git created at 2021-08-20 09:25:59

Changing status from positive_review to needs_review.


---

Comment by behackl created at 2021-08-20 09:26:44

Changing status from needs_review to positive_review.


---

Comment by behackl created at 2021-08-20 09:26:44

Merged latest version of dependencies.


---

Comment by cheuberg created at 2021-09-12 17:45:22

Replying to [comment:10 behackl]:
> 4. `NotImplementedBZeroError`: Maybe add a straightforward test like
>     {{{
>     sage: AR.<n> = AsymptoticRing('n^QQ', QQ)
>     sage: AR(0).B(42)
>     Traceback (most recent call last):
>     ...
>     NotImplementedBZero: got B(0)
>     The error term B(0) means 0 for sufficiently large n.
>     }}}

Minor remark concerning this error message: "sufficiently large n" could be replaced by `|n| >= 42`, because we actually know what "sufficiently large" means.


---

Comment by behackl created at 2021-11-23 09:14:36

I'm still not sure what causes the patchbot failure. Would it make sense to move this to the latest beta?


---

Comment by cheuberg created at 2021-12-19 07:36:46

Replying to [comment:21 behackl]:
> I'm still not sure what causes the patchbot failure. Would it make sense to move this to the latest beta?

A merge conflict has to be resolved, so moving to the latest beta is probably a good idea.


---

Comment by vbraun created at 2021-12-19 11:47:49

Resolution: fixed
