# Issue 25874: Implement faster iterator for Lyndon words

archive/issues_025874.json:
```json
{
    "body": "CC:  sage-combinat mantepse vdelecroix\n\nHaving an iterator for Lyndon words with a fixed length and alphabet size is useful that does not return elements (e.g., the free Lie algebra). Moreover, by having less transient objects, we can also improve the speed.\n\nCurrent branch:\n\n```\nsage: LW = LyndonWords(11,6)\nsage: %time for x in LW: pass\nCPU times: user 2.17 s, sys: 40 ms, total: 2.21 s\nWall time: 2.17 s\n\nsage: LW = LyndonWords(11,7)\nsage: %time for x in LW: pass\nCPU times: user 20.7 s, sys: 20 ms, total: 20.7 s\nWall time: 20.7 s\n```\n\nvs old version:\n\n```\nsage: LW = LyndonWords(11,6)\nsage: %time for x in LW: pass\nCPU times: user 2.86 s, sys: 12 ms, total: 2.87 s\nWall time: 2.85 s\n\nsage: LW = LyndonWords(11,7)\nsage: %time for x in LW: pass\nCPU times: user 26.8 s, sys: 12 ms, total: 26.8 s\nWall time: 26.7 s\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26111\n\n",
    "created_at": "2018-08-23T00:34:13Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Implement faster iterator for Lyndon words",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25874",
    "user": "tscrim"
}
```
CC:  sage-combinat mantepse vdelecroix

Having an iterator for Lyndon words with a fixed length and alphabet size is useful that does not return elements (e.g., the free Lie algebra). Moreover, by having less transient objects, we can also improve the speed.

Current branch:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 2.17 s, sys: 40 ms, total: 2.21 s
Wall time: 2.17 s

sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 20.7 s, sys: 20 ms, total: 20.7 s
Wall time: 20.7 s
```

vs old version:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 2.86 s, sys: 12 ms, total: 2.87 s
Wall time: 2.85 s

sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 26.8 s, sys: 12 ms, total: 26.8 s
Wall time: 26.7 s
```


Issue created by migration from https://trac.sagemath.org/ticket/26111





---

archive/issue_comments_365223.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-08-23T00:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365223",
    "user": "tscrim"
}
```

New commits:



---

archive/issue_comments_365224.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-23T00:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365224",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_365225.json:
```json
{
    "body": "Given #25262, it would be good to add a \"long\" doctest, so we can avoid performance regressions in future.",
    "created_at": "2018-08-23T03:31:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365225",
    "user": "mantepse"
}
```

Given #25262, it would be good to add a "long" doctest, so we can avoid performance regressions in future.



---

archive/issue_comments_365226.json:
```json
{
    "body": "Notes to myself:\n\nThere seem to be Gray codes available, eg:\n\n* https://hal.inria.fr/hal-00966527/document\n* http://www.cis.uoguelph.ca/~sawada/papers/bubble4.pdf\n\n(Note that the very simple iterative algorithm on page 217 of Ruskey's book visits also the necklaces.)",
    "created_at": "2018-08-23T03:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365226",
    "user": "mantepse"
}
```

Notes to myself:

There seem to be Gray codes available, eg:

* https://hal.inria.fr/hal-00966527/document
* http://www.cis.uoguelph.ca/~sawada/papers/bubble4.pdf

(Note that the very simple iterative algorithm on page 217 of Ruskey's book visits also the necklaces.)



---

archive/issue_comments_365227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-23T07:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365227",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365228.json:
```json
{
    "body": "Replying to [comment:2 mantepse]:\n> Given #25262, it would be good to add a \"long\" doctest, so we can avoid performance regressions in future.\n\nThat is not really how #25262 is suppose to work, and I don't believe is a better way to catch regressions (there will be less noise, but the noise will still be there). However, I've added it.",
    "created_at": "2018-08-23T07:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365228",
    "user": "tscrim"
}
```

Replying to [comment:2 mantepse]:
> Given #25262, it would be good to add a "long" doctest, so we can avoid performance regressions in future.

That is not really how #25262 is suppose to work, and I don't believe is a better way to catch regressions (there will be less noise, but the noise will still be there). However, I've added it.



---

archive/issue_comments_365229.json:
```json
{
    "body": "Here is a naive implementation of the iterative FKM algorithm from Ruskey's book. I couldn't get http://puma.dimai.unifi.it/17_1_2/weston.pdf to work, and I haven't checked what it's advantage would be.\n\nI won't steel the joy of timing this from you :-)\n\n```\ndef FKM_iterativ(k, n):\n    a = [0]*(n+1)\n    if n == 1:\n        yield a[:]\n    i = n;\n    while True:\n        a[i] += 1\n        for j in range(1, n-i+1):\n            a[j + i] = a[j]\n        if n == i:            \n            yield a[:]\n        i = n\n        while a[i] == k-1:\n            i -= 1\n        if i == 0:\n            break\n```\n",
    "created_at": "2018-08-23T19:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365229",
    "user": "mantepse"
}
```

Here is a naive implementation of the iterative FKM algorithm from Ruskey's book. I couldn't get http://puma.dimai.unifi.it/17_1_2/weston.pdf to work, and I haven't checked what it's advantage would be.

I won't steel the joy of timing this from you :-)

```
def FKM_iterativ(k, n):
    a = [0]*(n+1)
    if n == 1:
        yield a[:]
    i = n;
    while True:
        a[i] += 1
        for j in range(1, n-i+1):
            a[j + i] = a[j]
        if n == i:            
            yield a[:]
        i = n
        while a[i] == k-1:
            i -= 1
        if i == 0:
            break
```




---

archive/issue_comments_365230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-08-24T00:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365230",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_365231.json:
```json
{
    "body": "The \"joy\" of timing...sure...\n\nAnyways...that was a good find. The FKM algorithm is *much* faster than what was previously there (approximately 4x faster):\n\n```\nsage: %time for l in generate_lyndon_words(11,6): pass\nCPU times: user 1.74 s, sys: 36 ms, total: 1.78 s\nWall time: 1.76 s\nsage: %time for l in FKM_iterative(11,6): pass\nCPU times: user 452 ms, sys: 32 ms, total: 484 ms\nWall time: 432 ms\n\nsage: %time for l in generate_lyndon_words(11,7): pass\nCPU times: user 16.7 s, sys: 28 ms, total: 16.7 s\nWall time: 16.7 s\nsage: %time for l in FKM_iterative(11,7): pass\nCPU times: user 3.75 s, sys: 28 ms, total: 3.78 s\nWall time: 3.74 s\n```\n\n\nWith Cython (approximate another 10x speedup):\n\n```\nsage: %time for l in FKM_iterative_cython(11,6): pass\nCPU times: user 36 ms, sys: 20 ms, total: 56 ms\nWall time: 40.7 ms\nsage: %time for l in FKM_iterative_cython(11,7): pass\nCPU times: user 340 ms, sys: 12 ms, total: 352 ms\nWall time: 322 ms\n```\n\n\nI have merged in #25462 and added the Cython code in such a way as to not (add) conflict with #25659.",
    "created_at": "2018-08-24T00:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365231",
    "user": "tscrim"
}
```

The "joy" of timing...sure...

Anyways...that was a good find. The FKM algorithm is *much* faster than what was previously there (approximately 4x faster):

```
sage: %time for l in generate_lyndon_words(11,6): pass
CPU times: user 1.74 s, sys: 36 ms, total: 1.78 s
Wall time: 1.76 s
sage: %time for l in FKM_iterative(11,6): pass
CPU times: user 452 ms, sys: 32 ms, total: 484 ms
Wall time: 432 ms

sage: %time for l in generate_lyndon_words(11,7): pass
CPU times: user 16.7 s, sys: 28 ms, total: 16.7 s
Wall time: 16.7 s
sage: %time for l in FKM_iterative(11,7): pass
CPU times: user 3.75 s, sys: 28 ms, total: 3.78 s
Wall time: 3.74 s
```


With Cython (approximate another 10x speedup):

```
sage: %time for l in FKM_iterative_cython(11,6): pass
CPU times: user 36 ms, sys: 20 ms, total: 56 ms
Wall time: 40.7 ms
sage: %time for l in FKM_iterative_cython(11,7): pass
CPU times: user 340 ms, sys: 12 ms, total: 352 ms
Wall time: 322 ms
```


I have merged in #25462 and added the Cython code in such a way as to not (add) conflict with #25659.



---

archive/issue_comments_365232.json:
```json
{
    "body": "Great! (sorry, I actually did think that you would enjoy the timing)\n\nOne thing I do not yet understand: on my laptop, FKM is roughly 12 times faster than the original iterator (i.e., without this ticket).\n\nI'll try this ticket now to check.",
    "created_at": "2018-08-24T08:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365232",
    "user": "mantepse"
}
```

Great! (sorry, I actually did think that you would enjoy the timing)

One thing I do not yet understand: on my laptop, FKM is roughly 12 times faster than the original iterator (i.e., without this ticket).

I'll try this ticket now to check.



---

archive/issue_comments_365233.json:
```json
{
    "body": "Dear Travis!\n\nThe following cuts the time by a half, but I'm not sure whether it's correct...  What do you think?  (more precisely: should it really be `FiniteWord_char`?)\n\n```diff\ndiff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py\nindex 880dd4139c..15d0f56d41 100644\n--- a/src/sage/combinat/lyndon_word.py\n+++ b/src/sage/combinat/lyndon_word.py\n@@ -457,8 +457,9 @@ class LyndonWords_nk(UniqueRepresentation, Parent):\n             sage: sum(1 for lw in LyndonWords(11, 6))  # long time\n             295020\n         \"\"\"\n+        from sage.combinat.words.word import FiniteWord_char\n         for lw in generate_lyndon_words(self._n, self._k):\n-            yield self._words([i+1 for i in lw], check=False)\n+            yield FiniteWord_char(self._words, [i+1 for i in lw])\n \n def StandardBracketedLyndonWords(n, k):\n     \"\"\"\n```\n",
    "created_at": "2018-08-24T17:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365233",
    "user": "mantepse"
}
```

Dear Travis!

The following cuts the time by a half, but I'm not sure whether it's correct...  What do you think?  (more precisely: should it really be `FiniteWord_char`?)

```diff
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 880dd4139c..15d0f56d41 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
@@ -457,8 +457,9 @@ class LyndonWords_nk(UniqueRepresentation, Parent):
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
         """
+        from sage.combinat.words.word import FiniteWord_char
         for lw in generate_lyndon_words(self._n, self._k):
-            yield self._words([i+1 for i in lw], check=False)
+            yield FiniteWord_char(self._words, [i+1 for i in lw])
 
 def StandardBracketedLyndonWords(n, k):
     """
```




---

archive/issue_comments_365234.json:
```json
{
    "body": "To be nicer with the words code use\n\n```\nself._words.element_classes['char'](self._words, [i+1 for i in lw])\n```\n\nThat should roughly be the same. And you can even keep a reference `W = self._words.element_classes['char']` to save extra micro seconds.",
    "created_at": "2018-08-24T17:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365234",
    "user": "vdelecroix"
}
```

To be nicer with the words code use

```
self._words.element_classes['char'](self._words, [i+1 for i in lw])
```

That should roughly be the same. And you can even keep a reference `W = self._words.element_classes['char']` to save extra micro seconds.



---

archive/issue_comments_365235.json:
```json
{
    "body": "Thank you Vincent!\n\nHowever, it turns out that \"char\" is probably incorrect:\n\n```\nsage: list(LyndonWords(1000,1))\nOverflowError: value too large to convert to unsigned char\n```\n\nSo it should be\n\n\n```diff\ndiff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py\nindex 880dd4139c..8c0f49cfdd 100644\n--- a/src/sage/combinat/lyndon_word.py\n+++ b/src/sage/combinat/lyndon_word.py\n@@ -457,8 +457,9 @@ class LyndonWords_nk(UniqueRepresentation, Parent):\n             sage: sum(1 for lw in LyndonWords(11, 6))  # long time\n             295020\n         \"\"\"\n+        W = self._words._element_classes['list']\n         for lw in generate_lyndon_words(self._n, self._k):\n-            yield self._words([i+1 for i in lw], check=False)\n+            yield W(self._words, [i+1 for i in lw])\n \n def StandardBracketedLyndonWords(n, k):\n     \"\"\"\n```\n\n\nThis doesn't seem to be essentially slower than \"char\"...",
    "created_at": "2018-08-24T18:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365235",
    "user": "mantepse"
}
```

Thank you Vincent!

However, it turns out that "char" is probably incorrect:

```
sage: list(LyndonWords(1000,1))
OverflowError: value too large to convert to unsigned char
```

So it should be


```diff
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 880dd4139c..8c0f49cfdd 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
@@ -457,8 +457,9 @@ class LyndonWords_nk(UniqueRepresentation, Parent):
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
         """
+        W = self._words._element_classes['list']
         for lw in generate_lyndon_words(self._n, self._k):
-            yield self._words([i+1 for i in lw], check=False)
+            yield W(self._words, [i+1 for i in lw])
 
 def StandardBracketedLyndonWords(n, k):
     """
```


This doesn't seem to be essentially slower than "char"...



---

archive/issue_comments_365236.json:
```json
{
    "body": "`@`Travis, a tiny thing:\n\n\n```diff\ndiff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py\nindex 1d0665d225..49fcf058c9 100644\n--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py\n+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py\n@@ -809,7 +809,7 @@ class FreeLieAlgebra(Parent, UniqueRepresentation):\n             n = len(self._indices)\n             ret = []\n             for lw in generate_lyndon_words(n, k):\n-                b = self._standard_bracket(tuple([names[i] for i in lw]))\n+                b = self._standard_bracket(tuple(names[i] for i in lw))\n                 ret.append(self.element_class(self, {b: one}))\n             return tuple(ret)\n```\n",
    "created_at": "2018-08-24T18:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365236",
    "user": "mantepse"
}
```

`@`Travis, a tiny thing:


```diff
diff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py
index 1d0665d225..49fcf058c9 100644
--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py
+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py
@@ -809,7 +809,7 @@ class FreeLieAlgebra(Parent, UniqueRepresentation):
             n = len(self._indices)
             ret = []
             for lw in generate_lyndon_words(n, k):
-                b = self._standard_bracket(tuple([names[i] for i in lw]))
+                b = self._standard_bracket(tuple(names[i] for i in lw))
                 ret.append(self.element_class(self, {b: one}))
             return tuple(ret)
```




---

archive/issue_comments_365237.json:
```json
{
    "body": "Another one:\n\n```diff\ndiff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py\nindex 1d0665d225..1ef05a7f4f 100644\n--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py\n+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py\n@@ -774,13 +774,13 @@ class FreeLieAlgebra(Parent, UniqueRepresentation):\n                  [x0, [[x0, x1], x1]],\n                  [x0, [x0, [x1, x2]]],\n                  [x0, [[x0, x2], x1]],\n-                 [[x0, x1], [x0, x2]],\n                  [x0, [[x0, x2], x2]],\n+                 [[x0, x1], [x0, x2]],\n                  [[[x0, x1], x1], x1],\n                  [x0, [x1, [x1, x2]]],\n                  [[x0, [x1, x2]], x1],\n-                 [[[x0, x2], x1], x1],\n                  [x0, [[x1, x2], x2]],\n+                 [[[x0, x2], x1], x1],\n                  [[x0, x2], [x1, x2]],\n                  [[[x0, x2], x2], x1],\n                  [[[x0, x2], x2], x2],\n```\n",
    "created_at": "2018-08-24T18:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365237",
    "user": "mantepse"
}
```

Another one:

```diff
diff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py
index 1d0665d225..1ef05a7f4f 100644
--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py
+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py
@@ -774,13 +774,13 @@ class FreeLieAlgebra(Parent, UniqueRepresentation):
                  [x0, [[x0, x1], x1]],
                  [x0, [x0, [x1, x2]]],
                  [x0, [[x0, x2], x1]],
-                 [[x0, x1], [x0, x2]],
                  [x0, [[x0, x2], x2]],
+                 [[x0, x1], [x0, x2]],
                  [[[x0, x1], x1], x1],
                  [x0, [x1, [x1, x2]]],
                  [[x0, [x1, x2]], x1],
-                 [[[x0, x2], x1], x1],
                  [x0, [[x1, x2], x2]],
+                 [[[x0, x2], x1], x1],
                  [[x0, x2], [x1, x2]],
                  [[[x0, x2], x2], x1],
                  [[[x0, x2], x2], x2],
```




---

archive/issue_comments_365238.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-24T21:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365238",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365239.json:
```json
{
    "body": "The change in comment:13 is actually slower in both Python and Cython. It has something to do with how Python constructs these things internally (but I agree that it is counter-intuitive).\n\nWith comment:12:\n\n```\nsage: LW = LyndonWords(11,6)\nsage: %time for x in LW: pass\nCPU times: user 200 ms, sys: 21.3 ms, total: 222 ms\nWall time: 201 ms\nsage: LW = LyndonWords(11,7)\nsage: %time for x in LW: pass\nCPU times: user 1.85 s, sys: 8.12 ms, total: 1.85 s\nWall time: 1.84 s\n```\n\nvs old\n\n```\nsage: LW = LyndonWords(11,6)\nsage: %time for x in LW: pass\nCPU times: user 475 ms, sys: 42.2 ms, total: 518 ms\nWall time: 465 ms\nsage: LW = LyndonWords(11,7)\nsage: %time for x in LW: pass\nCPU times: user 4.25 s, sys: 17.8 ms, total: 4.27 s\nWall time: 4.24 s\n```\n",
    "created_at": "2018-08-24T21:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365239",
    "user": "tscrim"
}
```

The change in comment:13 is actually slower in both Python and Cython. It has something to do with how Python constructs these things internally (but I agree that it is counter-intuitive).

With comment:12:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 200 ms, sys: 21.3 ms, total: 222 ms
Wall time: 201 ms
sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 1.85 s, sys: 8.12 ms, total: 1.85 s
Wall time: 1.84 s
```

vs old

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 475 ms, sys: 42.2 ms, total: 518 ms
Wall time: 465 ms
sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 4.25 s, sys: 17.8 ms, total: 4.27 s
Wall time: 4.24 s
```




---

archive/issue_comments_365240.json:
```json
{
    "body": "One more doctest, a pyflakes thing, and a corner case:\n\n`sum(1 for lw in LyndonWords(1, 1000))` is stupid, but (with this patch) it kills my computer by filling up the memory really quickly.  Without this patch, it hits the recursion limit, whereas it gives `0` (which is correct) up to and including length 988.\n\n\n```diff\n\ndiff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx\nindex 1a53431a5a..227e5d8900 100644\n--- a/src/sage/combinat/combinat_cython.pyx\n+++ b/src/sage/combinat/combinat_cython.pyx\n@@ -168,6 +168,9 @@ def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):\n \n         sage: list(generate_lyndon_words(5, 0))\n         []\n+\n+        sage: list(generate_lyndon_words(1, 1000))\n+        []\n     \"\"\"\n     cdef Py_ssize_t i, j\n     if k == 0:\n@@ -176,6 +179,8 @@ def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):\n         for i in range(n):\n             yield [i]\n         return\n+    if n == 1:\n+        return\n \n     cdef list a = [0] * (k+1)\n     i = k\ndiff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py\nindex 8c0f49cfdd..306f7a3cf9 100644\n--- a/src/sage/combinat/lyndon_word.py\n+++ b/src/sage/combinat/lyndon_word.py\n@@ -23,7 +23,6 @@ from sage.arith.all import factorial, divisors, gcd, moebius\n from sage.misc.all import prod\n \n from . import necklace\n-from sage.combinat.integer_vector import IntegerVectors, integer_vectors_nk_fast_iter\n from sage.combinat.words.words import FiniteWords\n from sage.combinat.combinat_cython import generate_lyndon_words\n \n@@ -456,6 +455,12 @@ class LyndonWords_nk(UniqueRepresentation, Parent):\n \n             sage: sum(1 for lw in LyndonWords(11, 6))  # long time\n             295020\n+\n+            sage: sum(1 for lw in LyndonWords(1000, 1))\n+            1000\n+\n+            sage: sum(1 for lw in LyndonWords(1, 1000))\n+            0\n         \"\"\"\n         W = self._words._element_classes['list']\n         for lw in generate_lyndon_words(self._n, self._k):\n```\n",
    "created_at": "2018-08-25T07:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365240",
    "user": "mantepse"
}
```

One more doctest, a pyflakes thing, and a corner case:

`sum(1 for lw in LyndonWords(1, 1000))` is stupid, but (with this patch) it kills my computer by filling up the memory really quickly.  Without this patch, it hits the recursion limit, whereas it gives `0` (which is correct) up to and including length 988.


```diff

diff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx
index 1a53431a5a..227e5d8900 100644
--- a/src/sage/combinat/combinat_cython.pyx
+++ b/src/sage/combinat/combinat_cython.pyx
@@ -168,6 +168,9 @@ def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
 
         sage: list(generate_lyndon_words(5, 0))
         []
+
+        sage: list(generate_lyndon_words(1, 1000))
+        []
     """
     cdef Py_ssize_t i, j
     if k == 0:
@@ -176,6 +179,8 @@ def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
         for i in range(n):
             yield [i]
         return
+    if n == 1:
+        return
 
     cdef list a = [0] * (k+1)
     i = k
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 8c0f49cfdd..306f7a3cf9 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
@@ -23,7 +23,6 @@ from sage.arith.all import factorial, divisors, gcd, moebius
 from sage.misc.all import prod
 
 from . import necklace
-from sage.combinat.integer_vector import IntegerVectors, integer_vectors_nk_fast_iter
 from sage.combinat.words.words import FiniteWords
 from sage.combinat.combinat_cython import generate_lyndon_words
 
@@ -456,6 +455,12 @@ class LyndonWords_nk(UniqueRepresentation, Parent):
 
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
+
+            sage: sum(1 for lw in LyndonWords(1000, 1))
+            1000
+
+            sage: sum(1 for lw in LyndonWords(1, 1000))
+            0
         """
         W = self._words._element_classes['list']
         for lw in generate_lyndon_words(self._n, self._k):
```




---

archive/issue_comments_365241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-25T07:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365241",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365242.json:
```json
{
    "body": "Fixed and added. I also added more doctests for the other corner case of `LyndonWords(1,1)`.",
    "created_at": "2018-08-25T07:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365242",
    "user": "tscrim"
}
```

Fixed and added. I also added more doctests for the other corner case of `LyndonWords(1,1)`.



---

archive/issue_comments_365243.json:
```json
{
    "body": "Good catch! Funny that the `# long` disappeared :-)\n\nI have a few hopefully final questions/requests: \n\n* since it is very likely that more and more fundamental iterators are cythonized in a similar way (eg. #25864 would probably make a lot of sense), I think it would be good to create and stick to a good naming scheme.  It might be a pain to do that later.  In short, I think `lyndon_word_iterator` would be better.\n\n* there is a typo in the docstring of the iterator, I propose the following instead:\n\n```diff\n\ndiff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx\nindex a3e98d3f94..84e707ce7a 100644\n--- a/src/sage/combinat/combinat_cython.pyx\n+++ b/src/sage/combinat/combinat_cython.pyx\n@@ -144,14 +144,14 @@ def _stirling_number2(n, k):\n \n def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):\n     \"\"\"\n-    Generate all Lyndon words with of length ``k`` with ``n`` letters.\n+    Generate the Lyndon words of fixed length `k` over the alphabet `{0, 1, ..., n-1}`.\n \n     The resulting Lyndon words will be words represented as lists\n     whose alphabet is ``range(n)``.\n \n     ALGORITHM:\n \n-    The FKM algorithm from *Combinatorial Generation* by Ruskey.\n+    The iterative FKM Algorithm 7.2 from *Combinatorial Generation* by Ruskey.\n \n     EXAMPLES::\n```\n\n\n* in the documentation of the module `lyndon_word.py`, `k` and `n` are swapped in the docstrings `class LyndonWords_nk` and `__init__` just thereafter.  Should this be fixed in a separate ticket - I think it's easier to do it now.\n\nOtherwise, I think it is ready to go.",
    "created_at": "2018-08-25T13:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365243",
    "user": "mantepse"
}
```

Good catch! Funny that the `# long` disappeared :-)

I have a few hopefully final questions/requests: 

* since it is very likely that more and more fundamental iterators are cythonized in a similar way (eg. #25864 would probably make a lot of sense), I think it would be good to create and stick to a good naming scheme.  It might be a pain to do that later.  In short, I think `lyndon_word_iterator` would be better.

* there is a typo in the docstring of the iterator, I propose the following instead:

```diff

diff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx
index a3e98d3f94..84e707ce7a 100644
--- a/src/sage/combinat/combinat_cython.pyx
+++ b/src/sage/combinat/combinat_cython.pyx
@@ -144,14 +144,14 @@ def _stirling_number2(n, k):
 
 def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
     """
-    Generate all Lyndon words with of length ``k`` with ``n`` letters.
+    Generate the Lyndon words of fixed length `k` over the alphabet `{0, 1, ..., n-1}`.
 
     The resulting Lyndon words will be words represented as lists
     whose alphabet is ``range(n)``.
 
     ALGORITHM:
 
-    The FKM algorithm from *Combinatorial Generation* by Ruskey.
+    The iterative FKM Algorithm 7.2 from *Combinatorial Generation* by Ruskey.
 
     EXAMPLES::
```


* in the documentation of the module `lyndon_word.py`, `k` and `n` are swapped in the docstrings `class LyndonWords_nk` and `__init__` just thereafter.  Should this be fixed in a separate ticket - I think it's easier to do it now.

Otherwise, I think it is ready to go.



---

archive/issue_comments_365244.json:
```json
{
    "body": "You can make and push changes too. :) I am going to bed now, but can do it in the morning.",
    "created_at": "2018-08-25T13:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365244",
    "user": "tscrim"
}
```

You can make and push changes too. :) I am going to bed now, but can do it in the morning.



---

archive/issue_comments_365245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-25T14:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365245",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365246.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-25T21:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365246",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_365247.json:
```json
{
    "body": "Thank you. I made a few other small changes: I make Ruskey into an actual reference and the 1-line description of `lyndon_word_iterator` just use `n` as code because the alphabet description is given in the main body (and I prefer to use code format as much as possible in the 1-line descriptions for methods).\n\nIf my changes are good, then positive review.",
    "created_at": "2018-08-25T21:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365247",
    "user": "tscrim"
}
```

Thank you. I made a few other small changes: I make Ruskey into an actual reference and the 1-line description of `lyndon_word_iterator` just use `n` as code because the alphabet description is given in the main body (and I prefer to use code format as much as possible in the 1-line descriptions for methods).

If my changes are good, then positive review.



---

archive/issue_comments_365248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-25T21:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365248",
    "user": "mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_365249.json:
```json
{
    "body": "Thank you.",
    "created_at": "2018-08-25T21:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365249",
    "user": "tscrim"
}
```

Thank you.



---

archive/issue_comments_365250.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-29T22:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25874",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25874#issuecomment-365250",
    "user": "vbraun"
}
```

Resolution: fixed
