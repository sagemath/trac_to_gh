# Issue 25874: Implement faster iterator for Lyndon words

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2018-08-23 00:34:13

CC:  sage-combinat mantepse vdelecroix

Having an iterator for Lyndon words with a fixed length and alphabet size is useful that does not return elements (e.g., the free Lie algebra). Moreover, by having less transient objects, we can also improve the speed.

Current branch:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 2.17 s, sys: 40 ms, total: 2.21 s
Wall time: 2.17 s

sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 20.7 s, sys: 20 ms, total: 20.7 s
Wall time: 20.7 s
```

vs old version:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 2.86 s, sys: 12 ms, total: 2.87 s
Wall time: 2.85 s

sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 26.8 s, sys: 12 ms, total: 26.8 s
Wall time: 26.7 s
```



---

Comment by tscrim created at 2018-08-23 00:34:35

New commits:


---

Comment by tscrim created at 2018-08-23 00:34:35

Changing status from new to needs_review.


---

Comment by mantepse created at 2018-08-23 03:31:32

Given #25262, it would be good to add a "long" doctest, so we can avoid performance regressions in future.


---

Comment by mantepse created at 2018-08-23 03:45:03

Notes to myself:

There seem to be Gray codes available, eg:

* https://hal.inria.fr/hal-00966527/document
* http://www.cis.uoguelph.ca/~sawada/papers/bubble4.pdf

(Note that the very simple iterative algorithm on page 217 of Ruskey's book visits also the necklaces.)


---

Comment by git created at 2018-08-23 07:27:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-08-23 07:31:01

Replying to [comment:2 mantepse]:
> Given #25262, it would be good to add a "long" doctest, so we can avoid performance regressions in future.

That is not really how #25262 is suppose to work, and I don't believe is a better way to catch regressions (there will be less noise, but the noise will still be there). However, I've added it.


---

Comment by mantepse created at 2018-08-23 19:19:10

Here is a naive implementation of the iterative FKM algorithm from Ruskey's book. I couldn't get http://puma.dimai.unifi.it/17_1_2/weston.pdf to work, and I haven't checked what it's advantage would be.

I won't steel the joy of timing this from you :-)

```
def FKM_iterativ(k, n):
    a = [0]*(n+1)
    if n == 1:
        yield a[:]
    i = n;
    while True:
        a[i] += 1
        for j in range(1, n-i+1):
            a[j + i] = a[j]
        if n == i:            
            yield a[:]
        i = n
        while a[i] == k-1:
            i -= 1
        if i == 0:
            break
```



---

Comment by git created at 2018-08-24 00:13:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by tscrim created at 2018-08-24 00:14:54

The "joy" of timing...sure...

Anyways...that was a good find. The FKM algorithm is _much_ faster than what was previously there (approximately 4x faster):

```
sage: %time for l in generate_lyndon_words(11,6): pass
CPU times: user 1.74 s, sys: 36 ms, total: 1.78 s
Wall time: 1.76 s
sage: %time for l in FKM_iterative(11,6): pass
CPU times: user 452 ms, sys: 32 ms, total: 484 ms
Wall time: 432 ms

sage: %time for l in generate_lyndon_words(11,7): pass
CPU times: user 16.7 s, sys: 28 ms, total: 16.7 s
Wall time: 16.7 s
sage: %time for l in FKM_iterative(11,7): pass
CPU times: user 3.75 s, sys: 28 ms, total: 3.78 s
Wall time: 3.74 s
```


With Cython (approximate another 10x speedup):

```
sage: %time for l in FKM_iterative_cython(11,6): pass
CPU times: user 36 ms, sys: 20 ms, total: 56 ms
Wall time: 40.7 ms
sage: %time for l in FKM_iterative_cython(11,7): pass
CPU times: user 340 ms, sys: 12 ms, total: 352 ms
Wall time: 322 ms
```


I have merged in #25462 and added the Cython code in such a way as to not (add) conflict with #25659.


---

Comment by mantepse created at 2018-08-24 08:33:49

Great! (sorry, I actually did think that you would enjoy the timing)

One thing I do not yet understand: on my laptop, FKM is roughly 12 times faster than the original iterator (i.e., without this ticket).

I'll try this ticket now to check.


---

Comment by mantepse created at 2018-08-24 17:01:35

Dear Travis!

The following cuts the time by a half, but I'm not sure whether it's correct...  What do you think?  (more precisely: should it really be `FiniteWord_char`?)

```diff
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 880dd4139c..15d0f56d41 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
`@``@` -457,8 +457,9 `@``@` class LyndonWords_nk(UniqueRepresentation, Parent):
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
         """
+        from sage.combinat.words.word import FiniteWord_char
         for lw in generate_lyndon_words(self._n, self._k):
-            yield self._words([i+1 for i in lw], check=False)
+            yield FiniteWord_char(self._words, [i+1 for i in lw])
 
 def StandardBracketedLyndonWords(n, k):
     """
```



---

Comment by vdelecroix created at 2018-08-24 17:27:23

To be nicer with the words code use

```
self._words.element_classes['char'](self._words, [i+1 for i in lw])
```

That should roughly be the same. And you can even keep a reference `W = self._words.element_classes['char']` to save extra micro seconds.


---

Comment by mantepse created at 2018-08-24 18:54:53

Thank you Vincent!

However, it turns out that "char" is probably incorrect:

```
sage: list(LyndonWords(1000,1))
OverflowError: value too large to convert to unsigned char
```

So it should be


```diff
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 880dd4139c..8c0f49cfdd 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
`@``@` -457,8 +457,9 `@``@` class LyndonWords_nk(UniqueRepresentation, Parent):
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
         """
+        W = self._words._element_classes['list']
         for lw in generate_lyndon_words(self._n, self._k):
-            yield self._words([i+1 for i in lw], check=False)
+            yield W(self._words, [i+1 for i in lw])
 
 def StandardBracketedLyndonWords(n, k):
     """
```


This doesn't seem to be essentially slower than "char"...


---

Comment by mantepse created at 2018-08-24 18:55:45

`@`Travis, a tiny thing:


```diff
diff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py
index 1d0665d225..49fcf058c9 100644
--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py
+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py
`@``@` -809,7 +809,7 `@``@` class FreeLieAlgebra(Parent, UniqueRepresentation):
             n = len(self._indices)
             ret = []
             for lw in generate_lyndon_words(n, k):
-                b = self._standard_bracket(tuple([names[i] for i in lw]))
+                b = self._standard_bracket(tuple(names[i] for i in lw))
                 ret.append(self.element_class(self, {b: one}))
             return tuple(ret)
```



---

Comment by mantepse created at 2018-08-24 18:59:34

Another one:

```diff
diff --git a/src/sage/algebras/lie_algebras/free_lie_algebra.py b/src/sage/algebras/lie_algebras/free_lie_algebra.py
index 1d0665d225..1ef05a7f4f 100644
--- a/src/sage/algebras/lie_algebras/free_lie_algebra.py
+++ b/src/sage/algebras/lie_algebras/free_lie_algebra.py
`@``@` -774,13 +774,13 `@``@` class FreeLieAlgebra(Parent, UniqueRepresentation):
                  [x0, [[x0, x1], x1]],
                  [x0, [x0, [x1, x2]]],
                  [x0, [[x0, x2], x1]],
-                 [[x0, x1], [x0, x2]],
                  [x0, [[x0, x2], x2]],
+                 [[x0, x1], [x0, x2]],
                  [[[x0, x1], x1], x1],
                  [x0, [x1, [x1, x2]]],
                  [This is the Trac macro *x0, [x1, x2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#x0, [x1, x2-macro), x1],
-                 [[[x0, x2], x1], x1],
                  [x0, [[x1, x2], x2]],
+                 [[[x0, x2], x1], x1],
                  [[x0, x2], [x1, x2]],
                  [[[x0, x2], x2], x1],
                  [[[x0, x2], x2], x2],
```



---

Comment by git created at 2018-08-24 21:43:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-08-24 21:44:25

The change in comment:13 is actually slower in both Python and Cython. It has something to do with how Python constructs these things internally (but I agree that it is counter-intuitive).

With comment:12:

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 200 ms, sys: 21.3 ms, total: 222 ms
Wall time: 201 ms
sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 1.85 s, sys: 8.12 ms, total: 1.85 s
Wall time: 1.84 s
```

vs old

```
sage: LW = LyndonWords(11,6)
sage: %time for x in LW: pass
CPU times: user 475 ms, sys: 42.2 ms, total: 518 ms
Wall time: 465 ms
sage: LW = LyndonWords(11,7)
sage: %time for x in LW: pass
CPU times: user 4.25 s, sys: 17.8 ms, total: 4.27 s
Wall time: 4.24 s
```



---

Comment by mantepse created at 2018-08-25 07:41:31

One more doctest, a pyflakes thing, and a corner case:

`sum(1 for lw in LyndonWords(1, 1000))` is stupid, but (with this patch) it kills my computer by filling up the memory really quickly.  Without this patch, it hits the recursion limit, whereas it gives `0` (which is correct) up to and including length 988.


```diff

diff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx
index 1a53431a5a..227e5d8900 100644
--- a/src/sage/combinat/combinat_cython.pyx
+++ b/src/sage/combinat/combinat_cython.pyx
`@``@` -168,6 +168,9 `@``@` def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
 
         sage: list(generate_lyndon_words(5, 0))
         []
+
+        sage: list(generate_lyndon_words(1, 1000))
+        []
     """
     cdef Py_ssize_t i, j
     if k == 0:
`@``@` -176,6 +179,8 `@``@` def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
         for i in range(n):
             yield [i]
         return
+    if n == 1:
+        return
 
     cdef list a = [0] * (k+1)
     i = k
diff --git a/src/sage/combinat/lyndon_word.py b/src/sage/combinat/lyndon_word.py
index 8c0f49cfdd..306f7a3cf9 100644
--- a/src/sage/combinat/lyndon_word.py
+++ b/src/sage/combinat/lyndon_word.py
`@``@` -23,7 +23,6 `@``@` from sage.arith.all import factorial, divisors, gcd, moebius
 from sage.misc.all import prod
 
 from . import necklace
-from sage.combinat.integer_vector import IntegerVectors, integer_vectors_nk_fast_iter
 from sage.combinat.words.words import FiniteWords
 from sage.combinat.combinat_cython import generate_lyndon_words
 
`@``@` -456,6 +455,12 `@``@` class LyndonWords_nk(UniqueRepresentation, Parent):
 
             sage: sum(1 for lw in LyndonWords(11, 6))  # long time
             295020
+
+            sage: sum(1 for lw in LyndonWords(1000, 1))
+            1000
+
+            sage: sum(1 for lw in LyndonWords(1, 1000))
+            0
         """
         W = self._words._element_classes['list']
         for lw in generate_lyndon_words(self._n, self._k):
```



---

Comment by git created at 2018-08-25 07:50:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-08-25 07:51:09

Fixed and added. I also added more doctests for the other corner case of `LyndonWords(1,1)`.


---

Comment by mantepse created at 2018-08-25 13:40:15

Good catch! Funny that the `# long` disappeared :-)

I have a few hopefully final questions/requests: 

* since it is very likely that more and more fundamental iterators are cythonized in a similar way (eg. #25864 would probably make a lot of sense), I think it would be good to create and stick to a good naming scheme.  It might be a pain to do that later.  In short, I think `lyndon_word_iterator` would be better.

* there is a typo in the docstring of the iterator, I propose the following instead:

```diff

diff --git a/src/sage/combinat/combinat_cython.pyx b/src/sage/combinat/combinat_cython.pyx
index a3e98d3f94..84e707ce7a 100644
--- a/src/sage/combinat/combinat_cython.pyx
+++ b/src/sage/combinat/combinat_cython.pyx
`@``@` -144,14 +144,14 `@``@` def _stirling_number2(n, k):
 
 def generate_lyndon_words(Py_ssize_t n, Py_ssize_t k):
     """
-    Generate all Lyndon words with of length ``k`` with ``n`` letters.
+    Generate the Lyndon words of fixed length `k` over the alphabet `{0, 1, ..., n-1}`.
 
     The resulting Lyndon words will be words represented as lists
     whose alphabet is ``range(n)``.
 
     ALGORITHM:
 
-    The FKM algorithm from *Combinatorial Generation* by Ruskey.
+    The iterative FKM Algorithm 7.2 from *Combinatorial Generation* by Ruskey.
 
     EXAMPLES::
```


* in the documentation of the module `lyndon_word.py`, `k` and `n` are swapped in the docstrings `class LyndonWords_nk` and `__init__` just thereafter.  Should this be fixed in a separate ticket - I think it's easier to do it now.

Otherwise, I think it is ready to go.


---

Comment by tscrim created at 2018-08-25 13:42:14

You can make and push changes too. :) I am going to bed now, but can do it in the morning.


---

Comment by git created at 2018-08-25 14:54:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-25 21:25:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-08-25 21:28:10

Thank you. I made a few other small changes: I make Ruskey into an actual reference and the 1-line description of `lyndon_word_iterator` just use `n` as code because the alphabet description is given in the main body (and I prefer to use code format as much as possible in the 1-line descriptions for methods).

If my changes are good, then positive review.


---

Comment by mantepse created at 2018-08-25 21:35:52

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-08-25 21:45:11

Thank you.


---

Comment by vbraun created at 2018-08-29 22:31:24

Resolution: fixed
