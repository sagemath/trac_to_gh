# Issue 31088: Upgrade ecm to 7.0.5

Issue created by migration from https://trac.sagemath.org/ticket/31325

Original creator: mkoeppe

Original creation time: 2021-02-02 17:14:41

CC:  zimmerma dimpase fbissey tornaria

(from #30600)


---

Comment by zimmerma created at 2021-02-02 17:31:46

warning, 7.0.5 is not yet released! And the release number might change...


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-04-25 06:33:29

New commits:


---

Comment by mkoeppe created at 2022-04-25 06:37:16


```
[ecm-7.0.5-dev] gcc -DHAVE_CONFIG_H -I.  -DOUTSIDE_LIBECM   -g -march=native -g -O2 -fPIC -c -o ecm-main.o `test -f 'main.c' || echo './'`main.c
[ecm-7.0.5-dev] main.c:55:10: fatal error: 'torsions.h' file not found
[ecm-7.0.5-dev] #include "torsions.h" /* to benefit from more torsion groups */
[ecm-7.0.5-dev]          ^~~~~~~~~~~~
[ecm-7.0.5-dev] 1 error generated.
```



---

Comment by mkoeppe created at 2022-04-25 06:41:59

Is https://github.com/sethtroisi/gmp-ecm the official repo?


---

Comment by chapoton created at 2022-04-25 06:47:35

in the README

note: this file is outdated now that GMP-ECM moved to gitlab


---

Comment by chapoton created at 2022-04-25 06:48:51

https://gitlab.inria.fr/zimmerma/ecm


---

Comment by git created at 2022-04-25 07:13:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-04-25 10:33:10

It would be good to have 7.0.5 tagged on the git repo.


---

Comment by dimpase created at 2022-04-25 10:38:37

the tarball is missing `https://gitlab.inria.fr/zimmerma/ecm/-/raw/master/torsions.h`


---

Comment by zimmerma created at 2022-04-25 14:19:21

I've put a new tarball at https://members.loria.fr/PZimmermann/ecm-7.0.5a-dev.tar.gz. Is it better?


---

Comment by git created at 2022-04-25 17:59:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-25 18:00:37

Builds and passes the test suite on macOS 12.3.1 (Intel)


---

Comment by fbissey created at 2022-04-25 19:54:45

I am not keen to package something that is not a proper release. Any plans or roadmap to the next `ecm` release?


---

Comment by dimpase created at 2022-04-29 11:27:47

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-04-29 11:27:47

on Debian stable x86_64 I get

```
sage -t --warn-long 111.0 --random-seed=252573809850839320636415076260300606363 src/sage/interfaces/ecm.py
**********************************************************************
File "src/sage/interfaces/ecm.py", line 717, in sage.interfaces.ecm.ECM.time
Failed example:
    ecm.time(n, 35)                  # random output
Exception raised:
    Traceback (most recent call last):
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.ecm.ECM.time[1]>", line 1, in <module>
        ecm.time(n, Integer(35))                  # random output
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/ecm.py", line 770, in time
        while next(out_lines) != title_curves:
    StopIteration
**********************************************************************
File "src/sage/interfaces/ecm.py", line 720, in sage.interfaces.ecm.ECM.time
Failed example:
    ecm.time(n, 30, verbose=True)     # random output
Exception raised:
    Traceback (most recent call last):
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.ecm.ECM.time[2]>", line 1, in <module>
        ecm.time(n, Integer(30), verbose=True)     # random output
      File "/home/dimpase/work/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/ecm.py", line 770, in time
        while next(out_lines) != title_curves:
    StopIteration
**********************************************************************
1 item had failures:
   2 of   4 in sage.interfaces.ecm.ECM.time
    [47 tests, 2 failures, 4.13 s]
----------------------------------------------------------------------
sage -t --warn-long 111.0 --random-seed=252573809850839320636415076260300606363 src/sage/interfaces/ecm.py  # 2 doctests failed
```



---

Comment by dimpase created at 2022-04-29 11:35:05

Changing status from needs_review to needs_work.


---

Comment by zimmerma created at 2022-05-02 13:26:58

if these failures are due to upstream, please report them: https://gitlab.inria.fr/zimmerma/ecm


---

Comment by dimpase created at 2022-05-02 14:37:24

Has anything changed in ECM's time API since 7.0.4?


---

Comment by zimmerma created at 2022-05-02 14:46:27

Replying to [comment:24 dimpase]:
> Has anything changed in ECM's time API since 7.0.4?

which "time API" do you mean? In ecm.h there is no time function.


---

Comment by zimmerma created at 2022-05-02 15:03:48

Replying to [comment:20 fbissey]:
> I am not keen to package something that is not a proper release. Any plans or roadmap to the next `ecm` release?

I plan to release 7.0.5 soon.


---

Comment by dimpase created at 2022-05-02 15:18:06

OK, what changed a bit is the output of ECM, thus we need to do

```diff
--- a/src/sage/interfaces/ecm.py
+++ b/src/sage/interfaces/ecm.py
@@ -754,7 +754,7 @@ class ECM(SageObject):
             <BLANKLINE>
             Expected curves: 4911, Expected time: 32.25m
         """
-        title_curves = 'Expected number of curves to find a factor of n digits:'
+        title_curves = 'Expected number of curves to find a factor of n digits'
         title_time = 'Expected time to find a factor of n digits:'
         n = self._validate(n)
         B1 = self.recommended_B1(factor_digits)
@@ -767,7 +767,7 @@ class ECM(SageObject):
             return
 
         out_lines = iter(out.splitlines())
-        while next(out_lines) != title_curves:
+        while next(out_lines)[:len(title_curves)] != title_curves:
             pass
         header_curves = next(out_lines)
         curve_count_table = next(out_lines)
```

to let these tests pass (it prints a bit more there now). 

No issue on ECM side.


---

Comment by dimpase created at 2022-05-02 17:17:26

New commits:


---

Comment by dimpase created at 2022-05-02 17:17:26

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-05-02 17:17:59

added the patch from comment:27, rebased over rc3


---

Comment by zimmerma created at 2022-05-05 11:58:49

I've made a proper release (https://gitlab.inria.fr/zimmerma/ecm/uploads/89f6f0d65d3e980cef33dc922004e4b2/ecm-7.0.5.tar.gz) with tag 7.0.5 in the git repo


---

Comment by git created at 2022-05-05 13:44:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-05 13:46:02

Is there a way to skip these long hashes in the URL? Anyhow, this is the update, tested on macOS so far.


---

Comment by zimmerma created at 2022-05-05 14:35:30

Replying to [comment:32 dimpase]:
> Is there a way to skip these long hashes in the URL? Anyhow, this is the update, tested on macOS so far.

I believe no. If you look at https://gitlab.inria.fr/zimmerma/ecm/-/releases/7.0.5 you first see "Source code" tarballs made automatically by gitlab, but they are of no use since they do no contain a configure file (the autotools were not run).

The "release tarball" was added manually by me, and the long hash was given to me by gitlab.


---

Comment by dimpase created at 2022-05-11 11:57:50

lgtm


---

Comment by dimpase created at 2022-05-11 11:57:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-11 17:00:36

I think this should be run on GH Actions first, perhaps on top of #33316 for the platform updates


---

Comment by dimpase created at 2022-05-12 15:14:52

tests running on https://github.com/dimpase/sage/actions/runs/2314328253
(on top on #32937 and #33316)


---

Comment by mkoeppe created at 2022-05-17 02:53:24

Does it need #33861 as a dependency?


---

Comment by mkoeppe created at 2022-05-17 02:53:24

Changing status from positive_review to needs_review.


---

Comment by tornaria created at 2022-05-17 03:22:50

Replying to [comment:38 mkoeppe]:
> Does it need #33861 as a dependency?

Indeed https://git.sagemath.org/sage.git/commit?id=f2619864f27c34b751e84d6a4d41d77cfbe39d9a seems to do similar as my patch, so you can just keep this ticket and ignore mine.

This shows that trac search is not very good: https://trac.sagemath.org/search?q=ecm doesn't show this ticket (no, I didn't look at the second page, given that the first page shows nothing relevant; yes, searching "upgrade ecm" gives this as the first hit).


---

Comment by mkoeppe created at 2022-05-17 03:25:49

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-05-17 03:25:49

Then let's mark this one here as critical.


---

Comment by zimmerma created at 2022-05-17 07:14:32

since #33861 was marked as duplicate, maybe we can turn this ticket back as "positive review"?


---

Comment by mkoeppe created at 2022-05-17 07:31:37

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-05-17 17:32:46

Replying to [comment:39 tornaria]:
>
> This shows that trac search is not very good:
> https://trac.sagemath.org/search?q=ecm
> doesn't show this ticket

The Trac "query" engine often beats its "search" engine.

https://trac.sagemath.org/query?order=id&desc=1&summary=~ecm

I added a few custom search engines to my browser
to send trac queries like the above, querying fields
"summary", "description", "author", "reviewer", etc.

Then typing `sagetracsummary ecm` (choose your keyword)
in the url bar goes to the above.

Or to query only non-closed tickets:

https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~ecm


---

Comment by vbraun created at 2022-05-18 22:19:02

Resolution: fixed
