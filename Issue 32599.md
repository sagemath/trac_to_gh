# Issue 32599: System executables in PATH not overriden

Issue created by migration from https://trac.sagemath.org/ticket/32836

Original creator: mjo

Original creation time: 2021-11-07 18:29:55

CC:  mkoeppe dimpase

I'm pretty sure this is a new problem, otherwise I would have hit it with lcalc-2.x before. These tests were done on a clean 9.5.beta5 build.

When I start sage, my `PATH` looks correct, in that `SAGE_LOCAL/bin` comes before the usual system paths (in particular `/usr/bin`):


```
sage: os.environ["PATH"].split(":")
['/home/mjo/src/sage.git/build/bin',
 '/home/mjo/src/sage.git/src/bin',
 '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin',
 '/home/mjo/src/sage.git/local/bin',
 '/usr/local/sbin',
 '/usr/local/bin',
 '/usr/sbin',
 '/usr/bin',
 '/sbin',
 '/bin',
 '/opt/bin',
 '/usr/lib/llvm/12/bin',
 '/home/mjo/bin',
 '/home/mjo/bin']
```


And if I use `shutil.which` to find the "lcalc" program, it finds the right one:


```
sage: from shutil import which
sage: which("lcalc")
'/home/mjo/src/sage.git/local/bin/lcalc'
sage: os.system(which("lcalc") + " --version")
lcalc 1.22 July 14, 2009
0
```


But... that's not the one that sage itself wants to use:


```
sage: os.system("lcalc --version")
lcalc 2.0.3
0
sage: from sage.lfunctions.lcalc import LCalc
sage: lc = LCalc()
sage: lc("--version")
'lcalc 2.0.3'
```


This is causing all doctests that run "lcalc" to fail, because they're picking up lcalc-2.x from `/usr/bin` instead of the one in `SAGE_LOCAL/bin` that the SPKG installed.



---

Comment by mjo created at 2021-11-07 18:40:55

Interestingly enough, `sage -python` gets it right:


```
$ sage -python
Python 3.9.7 (default, Nov  2 2021, 01:20:36) 
[GCC 10.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import os
>>> os.system("lcalc --version")
lcalc 1.22 July 14, 2009
0
```



---

Comment by mjo created at 2021-11-07 18:59:19

There's a big warning on https://docs.python.org/3/library/subprocess.html that basically tells you to use `shutil.which()`, but it would be nice to know what's happening before implementing that.


---

Comment by mjo created at 2021-11-08 12:45:56

I'm also getting this, new, failure, and a few others like it:


```
File "src/sage/plot/plot.py", line 513, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    Traceback (most recent call last):
      File "/home/mjo/src/sage.git/src/bin/sage-eval", line 4, in <module>
        from sage.all import *
    ModuleNotFoundError: No module named 'sage'
    256
```


It looks like anything that execs a shell is having environment problems. The lcalc stuff is using `os.popen` instead of `subprocess.Popen`, and the former passes `shell=True` to the latter. If I use `subprocess.Popen(..., shell=False)` directly, the problem goes away.

I'd still like to know _why_ this stopped working, though.


---

Comment by mjo created at 2021-11-09 18:00:59

Changing priority from major to blocker.


---

Comment by mjo created at 2021-11-09 18:00:59

libSingular is doing this... it looks like `feInitResources()` is being called during sage's `init_libsingular()`, and that results in,


```
char* path = feResource('p');
...
if (path != NULL) setenv("PATH", path, 1);
```


Now the 'p' resource is,


```
{"Path",      'p',    feResPath,  NULL,                   "%b;%P;$PATH",             (char *)""}
```


And that matches what I'm seeing in exec'd shells:


```
sage: os.system("echo $PATH")
/usr/bin:/usr/bin/../libexec/singular/MOD:/usr/libexec/singular/MOD:/home/mjo/src/sage.git/build/bin:/home/mjo/src/sage.git/src/bin:/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin:/home/mjo/src/sage.git/local/bin:/usr/local/bin:/usr/sbin:/sbin:/bin:/usr/lib/llvm/12/bin:/home/mjo/bin
```


To confirm, commenting out the `init_libsingular()` line in `sage/libs/singular/singular.pyx` does fix the issue.

This is certainly a Singular bug. If anything, it should be appending those paths to the end of `$PATH`. But we've gotta do something to work around it in sage for now. Here's my it's-not-stupid-if-it-works entry:


```diff
diff --git a/src/sage/libs/singular/singular.pyx b/src/sage/libs/singular/singular.pyx
index ce93c3b8cb..8c32e750f5 100644
--- a/src/sage/libs/singular/singular.pyx
+++ b/src/sage/libs/singular/singular.pyx
@@ -804,7 +804,9 @@ cdef init_libsingular():
     error_messages = []

 # call the init routine
+saved_PATH = os.environ["PATH"]
 init_libsingular()
+os.environ["PATH"] = saved_PATH

 cdef void libsingular_error_callback(const_char_ptr s):
     _s = char_to_str(s)



```



---

Comment by mkoeppe created at 2021-11-09 18:04:50

Which version of singular are you using?


---

Comment by mjo created at 2021-11-09 18:09:26

4.2.0 installed, but reading the source on github.


---

Comment by mjo created at 2021-11-09 18:12:38

https://github.com/Singular/Singular/issues/1119


---

Comment by mkoeppe created at 2021-11-09 18:23:23

The workaround in comment:4 looks reasonable to me


---

Comment by mjo created at 2021-11-09 21:48:28

Leaving as new until ptestlong passes, but this seems to have solved all of my problems.
----
New commits:


---

Comment by mjo created at 2021-11-10 12:39:16

Well, well, well:


```
sage -t --long --warn-long 72.0 --random-seed=298205556719577584311334618093435422205 src/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "src/sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```


And this on a branch with no python fuckery.


---

Comment by mkoeppe created at 2021-11-10 16:02:53

That looks like it's coming from your experiments in #32832


---

Comment by mjo created at 2021-11-10 16:39:17

Replying to [comment:11 mkoeppe]:
> That looks like it's coming from your experiments in #32832

That was my first thought of course, but I couldn't figure out what precisely went wrong. I think I forgot to clean up the installed cython package from that branch, which would have made pip refuse to reinstall what it thought was the same version of cython. I've convinced myself that it isn't due to some `PATH` issue anyway.


---

Comment by mjo created at 2021-11-10 16:39:17

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-10 16:41:17

You forgot to change the patch level of cython in #32832, so there's nothing that triggers reinstallation


---

Comment by mkoeppe created at 2021-11-10 16:41:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-11-12 21:27:49

Resolution: fixed
