# Issue 32599: System executables in PATH not overriden

archive/issues_032599.json:
```json
{
    "body": "CC:  @mkoeppe @dimpase\n\nI'm pretty sure this is a new problem, otherwise I would have hit it with lcalc-2.x before. These tests were done on a clean 9.5.beta5 build.\n\nWhen I start sage, my `PATH` looks correct, in that `SAGE_LOCAL/bin` comes before the usual system paths (in particular `/usr/bin`):\n\n\n```\nsage: os.environ[\"PATH\"].split(\":\")\n['/home/mjo/src/sage.git/build/bin',\n '/home/mjo/src/sage.git/src/bin',\n '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin',\n '/home/mjo/src/sage.git/local/bin',\n '/usr/local/sbin',\n '/usr/local/bin',\n '/usr/sbin',\n '/usr/bin',\n '/sbin',\n '/bin',\n '/opt/bin',\n '/usr/lib/llvm/12/bin',\n '/home/mjo/bin',\n '/home/mjo/bin']\n```\n\n\nAnd if I use `shutil.which` to find the \"lcalc\" program, it finds the right one:\n\n\n```\nsage: from shutil import which\nsage: which(\"lcalc\")\n'/home/mjo/src/sage.git/local/bin/lcalc'\nsage: os.system(which(\"lcalc\") + \" --version\")\nlcalc 1.22 July 14, 2009\n0\n```\n\n\nBut... that's not the one that sage itself wants to use:\n\n\n```\nsage: os.system(\"lcalc --version\")\nlcalc 2.0.3\n0\nsage: from sage.lfunctions.lcalc import LCalc\nsage: lc = LCalc()\nsage: lc(\"--version\")\n'lcalc 2.0.3'\n```\n\n\nThis is causing all doctests that run \"lcalc\" to fail, because they're picking up lcalc-2.x from `/usr/bin` instead of the one in `SAGE_LOCAL/bin` that the SPKG installed.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32836\n\n",
    "created_at": "2021-11-07T18:29:55Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "System executables in PATH not overriden",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32599",
    "user": "https://github.com/orlitzky"
}
```
CC:  @mkoeppe @dimpase

I'm pretty sure this is a new problem, otherwise I would have hit it with lcalc-2.x before. These tests were done on a clean 9.5.beta5 build.

When I start sage, my `PATH` looks correct, in that `SAGE_LOCAL/bin` comes before the usual system paths (in particular `/usr/bin`):


```
sage: os.environ["PATH"].split(":")
['/home/mjo/src/sage.git/build/bin',
 '/home/mjo/src/sage.git/src/bin',
 '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin',
 '/home/mjo/src/sage.git/local/bin',
 '/usr/local/sbin',
 '/usr/local/bin',
 '/usr/sbin',
 '/usr/bin',
 '/sbin',
 '/bin',
 '/opt/bin',
 '/usr/lib/llvm/12/bin',
 '/home/mjo/bin',
 '/home/mjo/bin']
```


And if I use `shutil.which` to find the "lcalc" program, it finds the right one:


```
sage: from shutil import which
sage: which("lcalc")
'/home/mjo/src/sage.git/local/bin/lcalc'
sage: os.system(which("lcalc") + " --version")
lcalc 1.22 July 14, 2009
0
```


But... that's not the one that sage itself wants to use:


```
sage: os.system("lcalc --version")
lcalc 2.0.3
0
sage: from sage.lfunctions.lcalc import LCalc
sage: lc = LCalc()
sage: lc("--version")
'lcalc 2.0.3'
```


This is causing all doctests that run "lcalc" to fail, because they're picking up lcalc-2.x from `/usr/bin` instead of the one in `SAGE_LOCAL/bin` that the SPKG installed.


Issue created by migration from https://trac.sagemath.org/ticket/32836





---

archive/issue_comments_464415.json:
```json
{
    "body": "Interestingly enough, `sage -python` gets it right:\n\n\n```\n$ sage -python\nPython 3.9.7 (default, Nov  2 2021, 01:20:36) \n[GCC 10.3.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import os\n>>> os.system(\"lcalc --version\")\nlcalc 1.22 July 14, 2009\n0\n```\n",
    "created_at": "2021-11-07T18:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464415",
    "user": "https://github.com/orlitzky"
}
```

Interestingly enough, `sage -python` gets it right:


```
$ sage -python
Python 3.9.7 (default, Nov  2 2021, 01:20:36) 
[GCC 10.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import os
>>> os.system("lcalc --version")
lcalc 1.22 July 14, 2009
0
```




---

archive/issue_comments_464416.json:
```json
{
    "body": "There's a big warning on https://docs.python.org/3/library/subprocess.html that basically tells you to use `shutil.which()`, but it would be nice to know what's happening before implementing that.",
    "created_at": "2021-11-07T18:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464416",
    "user": "https://github.com/orlitzky"
}
```

There's a big warning on https://docs.python.org/3/library/subprocess.html that basically tells you to use `shutil.which()`, but it would be nice to know what's happening before implementing that.



---

archive/issue_comments_464417.json:
```json
{
    "body": "I'm also getting this, new, failure, and a few others like it:\n\n\n```\nFile \"src/sage/plot/plot.py\", line 513, in sage.plot.plot\nFailed example:\n    os.system(\"sage -c \\\"if 'matplotlib' in sys.modules: sys.exit(1)\\\"\") # long time\nExpected:\n    0\nGot:\n    Traceback (most recent call last):\n      File \"/home/mjo/src/sage.git/src/bin/sage-eval\", line 4, in <module>\n        from sage.all import *\n    ModuleNotFoundError: No module named 'sage'\n    256\n```\n\n\nIt looks like anything that execs a shell is having environment problems. The lcalc stuff is using `os.popen` instead of `subprocess.Popen`, and the former passes `shell=True` to the latter. If I use `subprocess.Popen(..., shell=False)` directly, the problem goes away.\n\nI'd still like to know *why* this stopped working, though.",
    "created_at": "2021-11-08T12:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464417",
    "user": "https://github.com/orlitzky"
}
```

I'm also getting this, new, failure, and a few others like it:


```
File "src/sage/plot/plot.py", line 513, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    Traceback (most recent call last):
      File "/home/mjo/src/sage.git/src/bin/sage-eval", line 4, in <module>
        from sage.all import *
    ModuleNotFoundError: No module named 'sage'
    256
```


It looks like anything that execs a shell is having environment problems. The lcalc stuff is using `os.popen` instead of `subprocess.Popen`, and the former passes `shell=True` to the latter. If I use `subprocess.Popen(..., shell=False)` directly, the problem goes away.

I'd still like to know *why* this stopped working, though.



---

archive/issue_comments_464418.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2021-11-09T18:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464418",
    "user": "https://github.com/orlitzky"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_464419.json:
```json
{
    "body": "libSingular is doing this... it looks like `feInitResources()` is being called during sage's `init_libsingular()`, and that results in,\n\n\n```\nchar* path = feResource('p');\n...\nif (path != NULL) setenv(\"PATH\", path, 1);\n```\n\n\nNow the 'p' resource is,\n\n\n```\n{\"Path\",      'p',    feResPath,  NULL,                   \"%b;%P;$PATH\",             (char *)\"\"}\n```\n\n\nAnd that matches what I'm seeing in exec'd shells:\n\n\n```\nsage: os.system(\"echo $PATH\")\n/usr/bin:/usr/bin/../libexec/singular/MOD:/usr/libexec/singular/MOD:/home/mjo/src/sage.git/build/bin:/home/mjo/src/sage.git/src/bin:/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin:/home/mjo/src/sage.git/local/bin:/usr/local/bin:/usr/sbin:/sbin:/bin:/usr/lib/llvm/12/bin:/home/mjo/bin\n```\n\n\nTo confirm, commenting out the `init_libsingular()` line in `sage/libs/singular/singular.pyx` does fix the issue.\n\nThis is certainly a Singular bug. If anything, it should be appending those paths to the end of `$PATH`. But we've gotta do something to work around it in sage for now. Here's my it's-not-stupid-if-it-works entry:\n\n\n```diff\ndiff --git a/src/sage/libs/singular/singular.pyx b/src/sage/libs/singular/singular.pyx\nindex ce93c3b8cb..8c32e750f5 100644\n--- a/src/sage/libs/singular/singular.pyx\n+++ b/src/sage/libs/singular/singular.pyx\n@@ -804,7 +804,9 @@ cdef init_libsingular():\n     error_messages = []\n\n # call the init routine\n+saved_PATH = os.environ[\"PATH\"]\n init_libsingular()\n+os.environ[\"PATH\"] = saved_PATH\n\n cdef void libsingular_error_callback(const_char_ptr s):\n     _s = char_to_str(s)\n\n\n\n```\n",
    "created_at": "2021-11-09T18:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464419",
    "user": "https://github.com/orlitzky"
}
```

libSingular is doing this... it looks like `feInitResources()` is being called during sage's `init_libsingular()`, and that results in,


```
char* path = feResource('p');
...
if (path != NULL) setenv("PATH", path, 1);
```


Now the 'p' resource is,


```
{"Path",      'p',    feResPath,  NULL,                   "%b;%P;$PATH",             (char *)""}
```


And that matches what I'm seeing in exec'd shells:


```
sage: os.system("echo $PATH")
/usr/bin:/usr/bin/../libexec/singular/MOD:/usr/libexec/singular/MOD:/home/mjo/src/sage.git/build/bin:/home/mjo/src/sage.git/src/bin:/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin:/home/mjo/src/sage.git/local/bin:/usr/local/bin:/usr/sbin:/sbin:/bin:/usr/lib/llvm/12/bin:/home/mjo/bin
```


To confirm, commenting out the `init_libsingular()` line in `sage/libs/singular/singular.pyx` does fix the issue.

This is certainly a Singular bug. If anything, it should be appending those paths to the end of `$PATH`. But we've gotta do something to work around it in sage for now. Here's my it's-not-stupid-if-it-works entry:


```diff
diff --git a/src/sage/libs/singular/singular.pyx b/src/sage/libs/singular/singular.pyx
index ce93c3b8cb..8c32e750f5 100644
--- a/src/sage/libs/singular/singular.pyx
+++ b/src/sage/libs/singular/singular.pyx
@@ -804,7 +804,9 @@ cdef init_libsingular():
     error_messages = []

 # call the init routine
+saved_PATH = os.environ["PATH"]
 init_libsingular()
+os.environ["PATH"] = saved_PATH

 cdef void libsingular_error_callback(const_char_ptr s):
     _s = char_to_str(s)



```




---

archive/issue_comments_464420.json:
```json
{
    "body": "Which version of singular are you using?",
    "created_at": "2021-11-09T18:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464420",
    "user": "https://github.com/mkoeppe"
}
```

Which version of singular are you using?



---

archive/issue_comments_464421.json:
```json
{
    "body": "4.2.0 installed, but reading the source on github.",
    "created_at": "2021-11-09T18:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464421",
    "user": "https://github.com/orlitzky"
}
```

4.2.0 installed, but reading the source on github.



---

archive/issue_comments_464422.json:
```json
{
    "body": "https://github.com/Singular/Singular/issues/1119",
    "created_at": "2021-11-09T18:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464422",
    "user": "https://github.com/orlitzky"
}
```

https://github.com/Singular/Singular/issues/1119



---

archive/issue_comments_464423.json:
```json
{
    "body": "The workaround in comment:4 looks reasonable to me",
    "created_at": "2021-11-09T18:23:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464423",
    "user": "https://github.com/mkoeppe"
}
```

The workaround in comment:4 looks reasonable to me



---

archive/issue_comments_464424.json:
```json
{
    "body": "Leaving as new until ptestlong passes, but this seems to have solved all of my problems.\n----\nNew commits:",
    "created_at": "2021-11-09T21:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464424",
    "user": "https://github.com/orlitzky"
}
```

Leaving as new until ptestlong passes, but this seems to have solved all of my problems.
----
New commits:



---

archive/issue_comments_464425.json:
```json
{
    "body": "Well, well, well:\n\n\n```\nsage -t --long --warn-long 72.0 --random-seed=298205556719577584311334618093435422205 src/sage/cpython/dict_del_by_value.pyx\n**********************************************************************\nFile \"src/sage/cpython/dict_del_by_value.pyx\", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, ZZ, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2442)\n        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n```\n\n\nAnd this on a branch with no python fuckery.",
    "created_at": "2021-11-10T12:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464425",
    "user": "https://github.com/orlitzky"
}
```

Well, well, well:


```
sage -t --long --warn-long 72.0 --random-seed=298205556719577584311334618093435422205 src/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "src/sage/cpython/dict_del_by_value.pyx", line 268, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 275, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2442)
        del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```


And this on a branch with no python fuckery.



---

archive/issue_comments_464426.json:
```json
{
    "body": "That looks like it's coming from your experiments in #32832",
    "created_at": "2021-11-10T16:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464426",
    "user": "https://github.com/mkoeppe"
}
```

That looks like it's coming from your experiments in #32832



---

archive/issue_comments_464427.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> That looks like it's coming from your experiments in #32832\n\nThat was my first thought of course, but I couldn't figure out what precisely went wrong. I think I forgot to clean up the installed cython package from that branch, which would have made pip refuse to reinstall what it thought was the same version of cython. I've convinced myself that it isn't due to some `PATH` issue anyway.",
    "created_at": "2021-11-10T16:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464427",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:11 mkoeppe]:
> That looks like it's coming from your experiments in #32832

That was my first thought of course, but I couldn't figure out what precisely went wrong. I think I forgot to clean up the installed cython package from that branch, which would have made pip refuse to reinstall what it thought was the same version of cython. I've convinced myself that it isn't due to some `PATH` issue anyway.



---

archive/issue_comments_464428.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-10T16:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464428",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464429.json:
```json
{
    "body": "You forgot to change the patch level of cython in #32832, so there's nothing that triggers reinstallation",
    "created_at": "2021-11-10T16:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464429",
    "user": "https://github.com/mkoeppe"
}
```

You forgot to change the patch level of cython in #32832, so there's nothing that triggers reinstallation



---

archive/issue_comments_464430.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-10T16:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464430",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464431.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-11-12T21:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32599",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32599#issuecomment-464431",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
