# Issue 30943: Add snappy as a pip package

archive/issues_030943.json:
```json
{
    "body": "CC:  @NathanDunfield @culler @dimpase @videlec @slel\n\nFollowing the instructions from #31176.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31180\n\n",
    "created_at": "2021-01-04T18:30:15Z",
    "labels": [
        "component: packages: optional"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Add snappy as a pip package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30943",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @NathanDunfield @culler @dimpase @videlec @slel

Following the instructions from #31176.

Issue created by migration from https://trac.sagemath.org/ticket/31180





---

archive/issue_comments_441462.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-04T18:38:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441462",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_441463.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-04T18:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441463",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_441464.json:
```json
{
    "body": "Unfortunately `--no-deps` is not valid syntax in `requirements.txt` files",
    "created_at": "2021-01-04T18:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441464",
    "user": "https://github.com/mkoeppe"
}
```

Unfortunately `--no-deps` is not valid syntax in `requirements.txt` files



---

archive/issue_comments_441465.json:
```json
{
    "body": "The full list of outside dependencies for `snappy` are:\n\n```\npypng\ndecorator\nfuture\nipython\ncypari|cypari2\n```\n\nso just using `snappy spherogram plink FXrays pypng` should do the trick (note I forgot about `pypng` in my post on #31176).  But maybe include `decorator` and `future` just in case those aren't part of some future version of Sage.",
    "created_at": "2021-01-04T18:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441465",
    "user": "https://github.com/NathanDunfield"
}
```

The full list of outside dependencies for `snappy` are:

```
pypng
decorator
future
ipython
cypari|cypari2
```

so just using `snappy spherogram plink FXrays pypng` should do the trick (note I forgot about `pypng` in my post on #31176).  But maybe include `decorator` and `future` just in case those aren't part of some future version of Sage.



---

archive/issue_comments_441466.json:
```json
{
    "body": "Hmm, I see what you mean by `--no-deps`.  I guess one can only give that flag to `pip` but not embed it in `requirements.txt`.",
    "created_at": "2021-01-04T19:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441466",
    "user": "https://github.com/NathanDunfield"
}
```

Hmm, I see what you mean by `--no-deps`.  I guess one can only give that flag to `pip` but not embed it in `requirements.txt`.



---

archive/issue_comments_441467.json:
```json
{
    "body": "Looking at snappy's `setup.py`, I see that you are already trying to conditionalize away the issue with `cypari`.\n\n```\n install_requires = ['plink>=2.3.1', 'spherogram>=1.8.3', 'FXrays>=1.3',\n                    'pypng', 'decorator', 'future', 'snappy_manifolds>=1.1.1']\ntry:\n    import sage\nexcept ImportError:\n    install_requires.append('cypari>=2.2')\n    install_requires.append('ipython>=0.13')\n    if sys.version_info < (3, 4):\n        install_requires.append('ipython<6.0')\n    if sys.platform == 'win32':\n        install_requires.append('pyreadline>=2.0')\n```\n\nUnfortunately I think the presence of wheels for `snappy` on PyPI will circumvent it.",
    "created_at": "2021-01-04T19:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441467",
    "user": "https://github.com/mkoeppe"
}
```

Looking at snappy's `setup.py`, I see that you are already trying to conditionalize away the issue with `cypari`.

```
 install_requires = ['plink>=2.3.1', 'spherogram>=1.8.3', 'FXrays>=1.3',
                    'pypng', 'decorator', 'future', 'snappy_manifolds>=1.1.1']
try:
    import sage
except ImportError:
    install_requires.append('cypari>=2.2')
    install_requires.append('ipython>=0.13')
    if sys.version_info < (3, 4):
        install_requires.append('ipython<6.0')
    if sys.platform == 'win32':
        install_requires.append('pyreadline>=2.0')
```

Unfortunately I think the presence of wheels for `snappy` on PyPI will circumvent it.



---

archive/issue_comments_441468.json:
```json
{
    "body": "Would making the cypari dependency an `extras_require` in `snappy` be an acceptable way forward for you?",
    "created_at": "2021-01-04T19:06:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441468",
    "user": "https://github.com/mkoeppe"
}
```

Would making the cypari dependency an `extras_require` in `snappy` be an acceptable way forward for you?



---

archive/issue_comments_441469.json:
```json
{
    "body": "Yeah, with binary wheels the `install_requires` are baked in and our tests in `setup.py` are of no help.\n\nI don't think `extras_require` helps here as `cypari*` is a core dependency for `snappy` and so is in no sense optional.",
    "created_at": "2021-01-05T01:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441469",
    "user": "https://github.com/NathanDunfield"
}
```

Yeah, with binary wheels the `install_requires` are baked in and our tests in `setup.py` are of no help.

I don't think `extras_require` helps here as `cypari*` is a core dependency for `snappy` and so is in no sense optional.



---

archive/issue_comments_441470.json:
```json
{
    "body": "It's inelegant, but I suspect that, in light of `pip`'s limitations, the best thing is simply to make `requirements.txt` be the single line `snappy`.  If wheels are available, this will result in a completely unused `cypari` package, but this will not interfere with anything and just wastes 30M (on linux, unpacked), which is small in context `snappy` (165 M), much less Sage itself (2G+).  (If instead `pip` ends up building from source, then there is no issue at all because of our `setup.py`.)\n\nThis also has the advantage it makes it less likely that this Sage pip package will need updating.\n\nThis argument is especially compelling if we throw in the optional database `snappy_15_knots` into this Sage pip package, as that is another 110M uncompressed.",
    "created_at": "2021-01-05T02:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441470",
    "user": "https://github.com/NathanDunfield"
}
```

It's inelegant, but I suspect that, in light of `pip`'s limitations, the best thing is simply to make `requirements.txt` be the single line `snappy`.  If wheels are available, this will result in a completely unused `cypari` package, but this will not interfere with anything and just wastes 30M (on linux, unpacked), which is small in context `snappy` (165 M), much less Sage itself (2G+).  (If instead `pip` ends up building from source, then there is no issue at all because of our `setup.py`.)

This also has the advantage it makes it less likely that this Sage pip package will need updating.

This argument is especially compelling if we throw in the optional database `snappy_15_knots` into this Sage pip package, as that is another 110M uncompressed.



---

archive/issue_comments_441471.json:
```json
{
    "body": "I am not sure. It does not seem like a very robust solution. \n\nJust as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.\n\n```\nBuilding wheels for collected packages: cypari\n  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  Building wheel for cypari (setup.py) ...   Destination directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' bdist_wheel -d /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  running bdist_wheel\n  running build\n  running build_py\n  creating build\n  creating build/lib.macosx-10.15-x86_64-3.9\n  creating build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/version.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/memory.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/__init__.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/test.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/py3tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/py2tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  running build_ext\n  error: [Errno 2] No such file or directory: 'cypari/_pari_py3.c' -> 'cypari/_pari.c'\nerror\n  ERROR: Failed building wheel for cypari\n...\nInstalling collected packages: cypari\n  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr\n    Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari\n    running install\n    running build\n    running build_py\n    running build_ext\n    Building gmp ...\n    rm -f gp-dyn\n    /Library/Developer/CommandLineTools/usr/bin/ld  -o gp-dyn -L\"/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/build/pari_src/Odarwin-x86_64\" -search_paths_first -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib  emacs.o gp.o gp_rl.o texmacs.o whatnow.o plotX.o  -lreadline -lpari -L/usr/X11R6/lib -lX11\n    ld: unknown option: -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib\n    make: *** [gp-dyn] Error 1\n    ***Failed to build PARI library***\n    Running setup.py install for cypari ... error\nERROR: Command errored out with exit status 1: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari Check the logs for full command output.\nException information:\nTraceback (most recent call last):\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/req/req_install.py\", line 838, in install\n    success = install_legacy(\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/operations/install/legacy.py\", line 86, in install\n    raise LegacyInstallFailure\npip._internal.operations.install.legacy.LegacyInstallFailure\n```\n",
    "created_at": "2021-01-05T17:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441471",
    "user": "https://github.com/mkoeppe"
}
```

I am not sure. It does not seem like a very robust solution. 

Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.

```
Building wheels for collected packages: cypari
  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  Building wheel for cypari (setup.py) ...   Destination directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' bdist_wheel -d /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  running bdist_wheel
  running build
  running build_py
  creating build
  creating build/lib.macosx-10.15-x86_64-3.9
  creating build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/version.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/memory.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/__init__.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/test.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/py3tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/py2tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  running build_ext
  error: [Errno 2] No such file or directory: 'cypari/_pari_py3.c' -> 'cypari/_pari.c'
error
  ERROR: Failed building wheel for cypari
...
Installing collected packages: cypari
  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr
    Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari
    running install
    running build
    running build_py
    running build_ext
    Building gmp ...
    rm -f gp-dyn
    /Library/Developer/CommandLineTools/usr/bin/ld  -o gp-dyn -L"/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/build/pari_src/Odarwin-x86_64" -search_paths_first -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib  emacs.o gp.o gp_rl.o texmacs.o whatnow.o plotX.o  -lreadline -lpari -L/usr/X11R6/lib -lX11
    ld: unknown option: -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib
    make: *** [gp-dyn] Error 1
    ***Failed to build PARI library***
    Running setup.py install for cypari ... error
ERROR: Command errored out with exit status 1: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari Check the logs for full command output.
Exception information:
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/req/req_install.py", line 838, in install
    success = install_legacy(
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/operations/install/legacy.py", line 86, in install
    raise LegacyInstallFailure
pip._internal.operations.install.legacy.LegacyInstallFailure
```




---

archive/issue_comments_441472.json:
```json
{
    "body": "Also `./sage -pip install -v -v snappy` on the same system gives:\n\n```\n  ...\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c kernel/kernel_code/Dirichlet.c -o build/temp.macosx-10.15-x86_64-3.9/kernel/kernel_code/Dirichlet.o\n  kernel/kernel_code/Dirichlet.c:83:10: warning: non-portable path to file '\"dirichlet.h\"'; specified path differs in case from file name on disk [-Wnonportable-include-path]\n  #include \"Dirichlet.h\"\n           ^~~~~~~~~~~~~\n           \"dirichlet.h\"\n  kernel/kernel_code/Dirichlet.c:118:91: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static void         array_to_matrix_pair_list(O31Matrix generators[], int num_generators, MatrixPairList *gen_list);\n                                                                                            ^~~~~~~~~~~~~~\n                                                                                            MatrixParity\n  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here\n  } MatrixParity;\n    ^\n  kernel/kernel_code/Dirichlet.c:119:52: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static Boolean      is_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);\n                                                     ^~~~~~~~~~~~~~\n                                                     MatrixParity\n  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here\n  } MatrixParity;\n    ^\n  kernel/kernel_code/Dirichlet.c:120:56: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static void         insert_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);\n                                                         ^~~~~~~~~~~~~~\n                                                         MatrixParity\n```\n",
    "created_at": "2021-01-05T17:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441472",
    "user": "https://github.com/mkoeppe"
}
```

Also `./sage -pip install -v -v snappy` on the same system gives:

```
  ...
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c kernel/kernel_code/Dirichlet.c -o build/temp.macosx-10.15-x86_64-3.9/kernel/kernel_code/Dirichlet.o
  kernel/kernel_code/Dirichlet.c:83:10: warning: non-portable path to file '"dirichlet.h"'; specified path differs in case from file name on disk [-Wnonportable-include-path]
  #include "Dirichlet.h"
           ^~~~~~~~~~~~~
           "dirichlet.h"
  kernel/kernel_code/Dirichlet.c:118:91: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static void         array_to_matrix_pair_list(O31Matrix generators[], int num_generators, MatrixPairList *gen_list);
                                                                                            ^~~~~~~~~~~~~~
                                                                                            MatrixParity
  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here
  } MatrixParity;
    ^
  kernel/kernel_code/Dirichlet.c:119:52: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static Boolean      is_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);
                                                     ^~~~~~~~~~~~~~
                                                     MatrixParity
  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here
  } MatrixParity;
    ^
  kernel/kernel_code/Dirichlet.c:120:56: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static void         insert_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);
                                                         ^~~~~~~~~~~~~~
                                                         MatrixParity
```




---

archive/issue_comments_441473.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> I am not sure. It does not seem like a very robust solution. \n\nNot that it means much, but we haven't had any reports of problems with `sage -pip install snappy` as our default install instructions.\n\nI agree it would be preferable just to pass the `--no-deps` flag to `pip`, but my understanding is that this is not possible in the context of a \"sage pip package\"?\n\n> Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.\n\nOuch, that's a bug on our part, it seems we broke the sdist tarball in 2.4.0, on all platforms, no less: we moved some files around and forgot to update `MANIFEST.in`.  We'll release 2.4.1 to fix this shortly.",
    "created_at": "2021-01-05T23:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441473",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:12 mkoeppe]:
> I am not sure. It does not seem like a very robust solution. 

Not that it means much, but we haven't had any reports of problems with `sage -pip install snappy` as our default install instructions.

I agree it would be preferable just to pass the `--no-deps` flag to `pip`, but my understanding is that this is not possible in the context of a "sage pip package"?

> Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.

Ouch, that's a bug on our part, it seems we broke the sdist tarball in 2.4.0, on all platforms, no less: we moved some files around and forgot to update `MANIFEST.in`.  We'll release 2.4.1 to fix this shortly.



---

archive/issue_comments_441474.json:
```json
{
    "body": "Replying to [comment:13 mkoeppe]:\n> Also `./sage -pip install -v -v snappy` on the same system gives:\n\nMarc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.",
    "created_at": "2021-01-06T16:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441474",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:13 mkoeppe]:
> Also `./sage -pip install -v -v snappy` on the same system gives:

Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.



---

archive/issue_comments_441475.json:
```json
{
    "body": "Replying to [comment:15 dunfield]:\n> Replying to [comment:13 mkoeppe]:\n> > Also `./sage -pip install -v -v snappy` on the same system gives:\n> \n> Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.\n\nI think it's actually coming from `/usr/local/include/` on my system (from homebrew's arb). \n\nThe question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)",
    "created_at": "2021-01-06T18:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441475",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:15 dunfield]:
> Replying to [comment:13 mkoeppe]:
> > Also `./sage -pip install -v -v snappy` on the same system gives:
> 
> Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.

I think it's actually coming from `/usr/local/include/` on my system (from homebrew's arb). 

The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)



---

archive/issue_comments_441476.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-06T19:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441476",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441477.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-06T19:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441477",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441478.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-06T19:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441478",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441479.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)\n\nOn my macOS 10.15 box, with Python in /Frameworks from Python.org, I get:\n\n```\ngcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -arch x86_64 -g \n   -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type \n   -I/Library/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c \n   kernel/addl_code/get_gluing_equations.c -o build/temp.macosx-10.9-x86_64-3.9/kernel/addl_code/get_gluing_equations.o\n```\n\nIn particular, the includes start with the SnapPy specific ones and then the location of `Python.h` as desired.  Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.",
    "created_at": "2021-01-07T02:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441479",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:16 mkoeppe]:
> The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)

On my macOS 10.15 box, with Python in /Frameworks from Python.org, I get:

```
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -arch x86_64 -g 
   -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type 
   -I/Library/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c 
   kernel/addl_code/get_gluing_equations.c -o build/temp.macosx-10.9-x86_64-3.9/kernel/addl_code/get_gluing_equations.o
```

In particular, the includes start with the SnapPy specific ones and then the location of `Python.h` as desired.  Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.



---

archive/issue_comments_441480.json:
```json
{
    "body": "Replying to [comment:20 dunfield]:\n> Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.\n\nAssuming you're using homebrew's Python, the above seems quite likely as there I get:\n\n```\n$ /usr/local/Cellar/python@3.9/3.9.0_1/bin/python3\n>>> import sysconfig\n>>> sysconfig.get_config_var('CFLAGS')\n'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall \n-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include \n-I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'",
    "created_at": "2021-01-07T02:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441480",
    "user": "https://github.com/NathanDunfield"
}
```

Replying to [comment:20 dunfield]:
> Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.

Assuming you're using homebrew's Python, the above seems quite likely as there I get:

```
$ /usr/local/Cellar/python@3.9/3.9.0_1/bin/python3
>>> import sysconfig
>>> sysconfig.get_config_var('CFLAGS')
'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall 
-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include 
-I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'



---

archive/issue_comments_441481.json:
```json
{
    "body": "Yes, my python3 is (Sage's venv over) homebrew python3.9 -- so this (the `CFLAGS` from `sysconfig`, not the environment) is how the `-I/usr/local/include` is entering on my system. \n\nThis is rather unfortunate and may also be the cause of the issues reported in #31132.",
    "created_at": "2021-01-07T03:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441481",
    "user": "https://github.com/mkoeppe"
}
```

Yes, my python3 is (Sage's venv over) homebrew python3.9 -- so this (the `CFLAGS` from `sysconfig`, not the environment) is how the `-I/usr/local/include` is entering on my system. 

This is rather unfortunate and may also be the cause of the issues reported in #31132.



---

archive/issue_comments_441482.json:
```json
{
    "body": "I have opened https://github.com/3-manifolds/SnapPy/issues/21 and\ncommented on https://github.com/fredrik-johansson/arb/issues/239 - where the issue of arb header names was already brought up as causing problems.",
    "created_at": "2021-01-07T09:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441482",
    "user": "https://github.com/dimpase"
}
```

I have opened https://github.com/3-manifolds/SnapPy/issues/21 and
commented on https://github.com/fredrik-johansson/arb/issues/239 - where the issue of arb header names was already brought up as causing problems.



---

archive/issue_comments_441483.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-09T00:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441484.json:
```json
{
    "body": "With the fix from #31132 (rejecting broken homebrew python3) and rejecting the broken cypari 2.4.0 via `requirements.txt`, this now seems to work well here on macOS.",
    "created_at": "2021-01-09T01:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441484",
    "user": "https://github.com/mkoeppe"
}
```

With the fix from #31132 (rejecting broken homebrew python3) and rejecting the broken cypari 2.4.0 via `requirements.txt`, this now seems to work well here on macOS.



---

archive/issue_comments_441485.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-09T01:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441485",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_441486.json:
```json
{
    "body": "Waiting for review",
    "created_at": "2021-01-26T20:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441486",
    "user": "https://github.com/mkoeppe"
}
```

Waiting for review



---

archive/issue_comments_441487.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-27T04:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441487",
    "user": "https://github.com/NathanDunfield"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_441488.json:
```json
{
    "body": "Tried it out, `sage -i snappy` installs working `snappy` as expected, setting positive review.",
    "created_at": "2021-01-27T04:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441488",
    "user": "https://github.com/NathanDunfield"
}
```

Tried it out, `sage -i snappy` installs working `snappy` as expected, setting positive review.



---

archive/issue_comments_441489.json:
```json
{
    "body": "I am very glad that we will have better support for snappy in Sage!",
    "created_at": "2021-01-27T12:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441489",
    "user": "https://github.com/videlec"
}
```

I am very glad that we will have better support for snappy in Sage!



---

archive/issue_comments_441490.json:
```json
{
    "body": "This probably makes #20739 obsolete.",
    "created_at": "2021-03-07T03:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441490",
    "user": "https://github.com/slel"
}
```

This probably makes #20739 obsolete.



---

archive/issue_comments_441491.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-07T17:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30943",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30943#issuecomment-441491",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
