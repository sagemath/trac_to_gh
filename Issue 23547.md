# Issue 23547: p-adic Gamma function breaks on zero input

Issue created by migration from Trac.

Original creator: kedlaya

Original creation time: 2017-09-05 04:37:36

Keywords: p-adic Gamma function

By construction, the p-adic Gamma function equals 1 when evaluated at 0. However, this is currently broken:

```
sage: F = Qp(7)
sage: F(0).gamma() # should return F(1)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-38-6f124d83fb80> in <module>()
----> 1 F(Integer(0)).gamma()

/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8619)()
    823         parent = self.parent()
    824         if algorithm == 'pari':
--> 825             return parent(self.__pari__().gamma())
    826         elif algorithm == 'sage':
    827             from sage.misc.all import prod

cypari2/auto_gen.pxi in cypari2.gen.Gen_auto.gamma (cypari2/gen.c:45723)()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle (cypari2/handle_error.c:2075)()

PariError: domain error in gamma: argument = non-positive integer
```

Using Sage's internal code is no better:

```
sage: F(0).gamma(algorithm='sage')
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-41-b5818b2c6ffe> in <module>()
----> 1 F(Integer(0)).gamma(algorithm='sage')

/home/kedlaya/sage-complete/src/sage/rings/padics/padic_generic_element.pyx in sage.rings.padics.padic_generic_element.pAdicGenericElement.gamma (/home/kedlaya/sage-complete/src/build/cythonized/sage/rings/padics/padic_generic_element.c:8784)()
    828             p = parent.prime()
    829             n = self.precision_absolute()
--> 830             bd = n + 2*n//p
    831             if self.is_padic_unit():
    832                 k = Integer(self.residue())  # leading coefficient of self, non-zero

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13179)()
   1769             return (<Element>left)._floordiv_(right)
   1770         if BOTH_ARE_ELEMENT(cl):
-> 1771             return coercion_model.bin_op(left, right, floordiv)
   1772 
   1773         try:

/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9350)()
   1054             if xy is not None:
   1055                 # The error was in calling, not coercing
-> 1056                 raise
   1057             self._record_exception()
   1058 

/home/kedlaya/sage-complete/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/coerce.c:9288)()
   1050         try:
   1051             xy = self.canonical_coercion(x,y)
-> 1052             return PyObject_CallObject(op, xy)
   1053         except TypeError as err:
   1054             if xy is not None:

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element.__floordiv__ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13144)()
   1767         cdef int cl = classify_elements(left, right)
   1768         if HAVE_SAME_PARENT(cl):
-> 1769             return (<Element>left)._floordiv_(right)
   1770         if BOTH_ARE_ELEMENT(cl):
   1771             return coercion_model.bin_op(left, right, floordiv)

/home/kedlaya/sage-complete/src/sage/structure/element.pyx in sage.structure.element.Element._floordiv_ (/home/kedlaya/sage-complete/src/build/cythonized/sage/structure/element.c:13470)()
   1802             python_op = (<object>self)._floordiv_
   1803         except AttributeError:
-> 1804             raise bin_op_exception('//', self, other)
   1805         else:
   1806             return python_op(other)

TypeError: unsupported operand parent(s) for //: 'The Infinity Ring' and 'The Infinity Ring'
```

In both case, the problem is that the input really should be treated as an inexact zero, not an exact zero:

```
sage: F(0+O(7^20)).gamma()
1 + O(7^20)
sage: F(0+O(7^20)).gamma(algorithm='sage')
1 + O(7^20)
```



---

Comment by roed created at 2017-09-05 06:31:44

New commits:


---

Comment by roed created at 2017-09-05 06:31:44

Changing status from new to needs_review.


---

Comment by kedlaya created at 2017-09-05 08:18:33

Looks good to me, and patchbot doesn't show any genuine doctest failures. Positive review.


---

Comment by kedlaya created at 2017-09-05 08:18:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-10 11:56:44

Resolution: fixed
