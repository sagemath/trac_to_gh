# Issue 21506: Crash when stdin is not a tty

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2016-10-22 19:48:38


```
$ echo 1+1 | sage
```

crashes in IPython's prompt_toolkit


---

Comment by vbraun created at 2016-10-22 20:13:45

New commits:


---

Comment by vbraun created at 2016-10-22 20:13:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-10-22 20:52:37

Is it possible to add a doctest (running `echo 1+1 | sage` for example)


---

Comment by vbraun created at 2016-10-22 21:01:19

Yes thats already in the branch


---

Comment by jdemeyer created at 2016-10-24 20:50:32

`output` -> `out` in the doctest :-)


```
sage -t --long src/sage/repl/configuration.py
**********************************************************************
File "src/sage/repl/configuration.py", line 14, in sage.repl.configuration
Failed example:
    'In [1]: \n1299709' in out
Exception raised:
    Traceback (most recent call last):
      File "/home/sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.configuration[2]>", line 1, in <module>
        'In [1]: \n1299709' in out
    NameError: name 'out' is not defined
**********************************************************************
}}}}


---

Comment by jdemeyer created at 2016-10-24 20:50:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-10-25 12:03:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-10-25 12:03:59

oops, fixed


---

Comment by jdemeyer created at 2016-10-25 12:18:08

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-25 12:25:15

The doctest doesn't really test this ticket properly, since the stdout of that doctest isn't a tty either. So the doctest passes even without this ticket. Maybe it's better to run the test in a `pexpect` session instead of a `subprocess`.


---

Comment by git created at 2016-10-25 12:55:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-10-26 02:17:15

With this ticket single lines are piping fine, but a multiline one is not:

```
sc_work`@`sagecell:~$ echo "
> (1+
> 1);
> " | /home/sc_serv/sage/sage
mkdir: cannot create directory ‘/home/sc_work/.sage//R’: Permission denied
/home/sc_serv/sage/src/bin/sage-env: line 465: /home/sc_work/.sage//R/Makevars.user: No such file or directory
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.5.beta0, Release Date: 2016-10-21               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
In [1]: In [1]:   File "<ipython-input-1-44a78680af87>", line 1
    (Integer(1)+
                ^
SyntaxError: unexpected EOF while parsing

In [2]:   File "<ipython-input-2-414b1b3315a2>", line 1
    Integer(1));
              ^
SyntaxError: invalid syntax

In [3]: In [3]: Exiting Sage (CPU time 0m0.04s, Wall time 0m0.06s).
```



---

Comment by novoselt created at 2016-10-26 02:17:15

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-10-26 04:56:33

Replying to [comment:11 novoselt]:
> With this ticket single lines are piping fine, but a multiline one is not:

See related discussion in #21227 and #21558.


---

Comment by jdemeyer created at 2016-10-26 07:12:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-10-26 07:12:39

True, but that's not what this ticket is about.


---

Comment by jdemeyer created at 2016-10-26 18:27:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-31 12:32:35

Resolution: fixed
