# Issue 22543: Hecke operators on spaces of modular forms of level 1 are wrong

archive/issues_022543.json:
```json
{
    "body": "CC:  alexghitza was\n\nKeywords: hecke operator\n\nThe following bug was reported to me by Sander Dahmen and Joey van Langen:\n\n```\nsage: M = ModularForms(SL2Z, 12)\nsage: Delta = M.basis()[0]; Delta\nq - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6)\nsage: T2 = M.hecke_operator(2)\nsage: T2(Delta) == -24*Delta\nFalse\n```\n\nThis happens because (apparently since #9749) the Hecke matrix is computed with respect to a different basis than `M.q_expansion_basis()`:\n\n```\nsage: M._compute_hecke_matrix(2)\n[  2049 196560]\n[     0    -24]\n```\n\nThe correct answer is\n\n```\n[ -24    0]\n[   0 2049]\n```\n\nCompare the following:\n\n```\nsage: M.q_expansion_basis()\n[\nq - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6),\n1 + 65520/691*q + 134250480/691*q^2 + 11606736960/691*q^3 + 274945048560/691*q^4 + 3199218815520/691*q^5 + O(q^6)\n]\nsage: hecke_operator_on_basis(M.q_expansion_basis(), 2, 12)\n[ -24    0]\n[   0 2049]\n```\n\nvs.\n\n```\nsage: victor_miller_basis(12)\n[\n1 + 196560*q^2 + 16773120*q^3 + 398034000*q^4 + 4629381120*q^5 + 34417656000*q^6 + 187489935360*q^7 + 814879774800*q^8 + 2975551488000*q^9 + O(q^10),\nq - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 - 6048*q^6 - 16744*q^7 + 84480*q^8 - 113643*q^9 + O(q^10)\n]\nsage: hecke_operator_on_basis(victor_miller_basis(12), 2, 12)\n[  2049 196560]\n[     0    -24]\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22780\n\n",
    "created_at": "2017-04-07T17:12:45Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "title": "Hecke operators on spaces of modular forms of level 1 are wrong",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22543",
    "user": "pbruin"
}
```
CC:  alexghitza was

Keywords: hecke operator

The following bug was reported to me by Sander Dahmen and Joey van Langen:

```
sage: M = ModularForms(SL2Z, 12)
sage: Delta = M.basis()[0]; Delta
q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6)
sage: T2 = M.hecke_operator(2)
sage: T2(Delta) == -24*Delta
False
```

This happens because (apparently since #9749) the Hecke matrix is computed with respect to a different basis than `M.q_expansion_basis()`:

```
sage: M._compute_hecke_matrix(2)
[  2049 196560]
[     0    -24]
```

The correct answer is

```
[ -24    0]
[   0 2049]
```

Compare the following:

```
sage: M.q_expansion_basis()
[
q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6),
1 + 65520/691*q + 134250480/691*q^2 + 11606736960/691*q^3 + 274945048560/691*q^4 + 3199218815520/691*q^5 + O(q^6)
]
sage: hecke_operator_on_basis(M.q_expansion_basis(), 2, 12)
[ -24    0]
[   0 2049]
```

vs.

```
sage: victor_miller_basis(12)
[
1 + 196560*q^2 + 16773120*q^3 + 398034000*q^4 + 4629381120*q^5 + 34417656000*q^6 + 187489935360*q^7 + 814879774800*q^8 + 2975551488000*q^9 + O(q^10),
q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 - 6048*q^6 - 16744*q^7 + 84480*q^8 - 113643*q^9 + O(q^10)
]
sage: hecke_operator_on_basis(victor_miller_basis(12), 2, 12)
[  2049 196560]
[     0    -24]
```



Issue created by migration from https://trac.sagemath.org/ticket/22780





---

archive/issue_comments_314240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-20T18:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314240",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314241.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-20T18:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314241",
    "user": "davidloeffler"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_314242.json:
```json
{
    "body": "Here is a fix (which is also a tiny bit faster than the old code).",
    "created_at": "2017-11-20T18:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314242",
    "user": "davidloeffler"
}
```

Here is a fix (which is also a tiny bit faster than the old code).



---

archive/issue_comments_314243.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-20T18:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314243",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314244.json:
```json
{
    "body": "OK, now zero-dimensional spaces should work as well.",
    "created_at": "2017-11-20T18:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314244",
    "user": "davidloeffler"
}
```

OK, now zero-dimensional spaces should work as well.



---

archive/issue_comments_314245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-21T08:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314245",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314246.json:
```json
{
    "body": "Patchbot picked up some failing doctests. I had run all tests in sage/modular/modform, but I didn't realise there were tests in sage/modular/hecke that also depend on this code.\n----\nNew commits:",
    "created_at": "2017-11-21T08:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314246",
    "user": "davidloeffler"
}
```

Patchbot picked up some failing doctests. I had run all tests in sage/modular/modform, but I didn't realise there were tests in sage/modular/hecke that also depend on this code.
----
New commits:



---

archive/issue_comments_314247.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-22T08:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314247",
    "user": "pbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314248.json:
```json
{
    "body": "Looks good to me and tests pass.  Thanks for fixing this!",
    "created_at": "2017-11-22T08:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314248",
    "user": "pbruin"
}
```

Looks good to me and tests pass.  Thanks for fixing this!



---

archive/issue_comments_314249.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22543#issuecomment-314249",
    "user": "vbraun"
}
```

Resolution: fixed
