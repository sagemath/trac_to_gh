# Issue 24392: fix R build on Solaris 11

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2018-02-01 01:45:47

CC:  jdemeyer

it depends (unnecessarily on this platform - system provides a good one) on broken (on the platform, see #24628) Sage pcre.

further, there are linking errors to sort out.


---

Comment by dimpase created at 2018-02-01 01:51:45

This is where it is stuck if using system's pcre rather than the broken Sage pcre:

```
building package 'graphics'
mkdir -p -- ../../../library/graphics
make[6]: Entering directory '/datapool/dima/Sage/sagetrac-mirror/local/var/tmp/sage/build/r-3.4.3/src/src/library/graphics'
mkdir -p -- ../../../library/graphics/R
make[6]: Leaving directory '/datapool/dima/Sage/sagetrac-mirror/local/var/tmp/sage/build/r-3.4.3/src/src/library/graphics'
make[6]: Entering directory '/datapool/dima/Sage/sagetrac-mirror/local/var/tmp/sage/build/r-3.4.3/src/src/library/graphics'
make[7]: Entering directory '/datapool/dima/Sage/sagetrac-mirror/local/var/tmp/sage/build/r-3.4.3/src/src/library/graphics/src'
making init.d from init.c
making base.d from base.c
making graphics.d from graphics.c
making par.d from par.c
making plot.d from plot.c
making plot3d.d from plot3d.c
making stem.d from stem.c
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c init.c -o init.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c base.c -o base.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c graphics.c -o graphics.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c par.c -o par.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c plot.c -o plot.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c plot3d.c -o plot3d.o
gcc -I../../../../include -DNDEBUG -I../../../include -I../../../../src/include -DHAVE_CONFIG_H -I../../../../src/main    -fvisibility=hidden -fPIC  -m64 -g -O
2 -D_XPG6  -c stem.c -o stem.o
gcc -shared -L../../../../lib -m64 -L/datapool/dima/Sage/sagetrac-mirror/local/lib -Wl,-rpath,/datapool/dima/Sage/sagetrac-mirror/local/lib -o graphics.so init
.o base.o graphics.o par.o plot.o plot3d.o stem.o -L../../../../lib -lR
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_info; c
annot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file graphics.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_inf
o; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
ld: warning: relocation error: R_SPARC_UA64: file base.o: symbol baseRegisterIndex: external symbolic relocation against non-allocatable section .debug_loc; cannot be processed at runtime: relocation ignored
Undefined                       first referenced
 symbol                             in file
baseRegisterIndex                   (null)  (symbol scope specifies local binding)
ld: fatal: symbol referencing errors
collect2: error: ld returned 1 exit status
make[7]: *** [../../../../share/make/shlib.mk:6: graphics.so] Error 1
```


perhaps building without `-g` might help?


---

Comment by dimpase created at 2018-02-01 12:12:36

without `-g`, the warnings `ld: warning: relocation error: R_SPARC_UA64: file base.o:..` are gone, but the error

```
Undefined                       first referenced
 symbol                             in file
baseRegisterIndex                   (null)  (symbol scope specifies local binding)
```

is still there. It might be due to `baseRegisterIndex` being a global variable in `base.c`, and the parameter `-fvisibility=hidden` used while compiling `base.c`.


---

Comment by dimpase created at 2018-02-01 19:50:52

Disabling visibility control on  package 'graphics' by

```
diff --git a/src/library/graphics/src/Makefile.in b/src/library/graphics/src/Makefile.in
index 9f6a490..ea3cd46 100644
--- a/src/library/graphics/src/Makefile.in
+++ b/src/library/graphics/src/Makefile.in
`@``@` -18,7 +18,7 `@``@` SOURCES_C = init.c base.c graphics.c par.c plot.c plot3d.c stem.c
 DEPENDS = $(SOURCES_C:.c=.d)
 OBJECTS = $(SOURCES_C:.c=.o)
 
-PKG_CFLAGS = $(C_VISIBILITY)
+PKG_CFLAGS =
 
 SHLIB = $(pkg)`@`SHLIB_EXT`@`
```

makes R build.

----

Better solution is in the ticket description.


---

Comment by dimpase created at 2018-02-05 15:28:58

branch coming soon.


---

Comment by jdemeyer created at 2018-02-05 16:17:42

Branch coming soon from me too... sorry I didn't know you were working on this.


---

Comment by jdemeyer created at 2018-02-05 16:21:54

New commits:


---

Comment by jdemeyer created at 2018-02-05 16:22:20

#24628 is not strictly a dependency.


---

Comment by jdemeyer created at 2018-02-05 16:26:46

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-02-05 17:11:20

oh dear, I indicated that I certainly cannot do the pexpect thing...

And I've been just writing a long email to R-devel, as I don't have an account on their bugzilla :-(


---

Comment by dimpase created at 2018-02-05 17:12:52

And what do you mean by saying that it does not depend on #24628 - of course it does, for without it you get nasty segfaults while building R...


---

Comment by dimpase created at 2018-02-05 17:19:10

By the way, you bugzilla report could mention
https://bugs.r-project.org/bugzilla/show_bug.cgi?id=16633
which is certainly the same sort of trouble


---

Comment by dimpase created at 2018-02-05 17:39:01

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-02-05 17:39:01

OK, that's basically what's in my patch too :-)


---

Comment by vbraun created at 2018-02-09 08:03:46

Resolution: fixed


---

Comment by dimpase created at 2018-02-15 23:50:45

upstream reacted on a mailing list and said it's been commited:


```
$ svn log -v -r HEAD:\{`date +%Y-%m-%d`\} https://svn.r-project.org/R
------------------------------------------------------------------------
r74258 | murrell | 2018-02-15 21:20:12 +0000 (Thu, 15 Feb 2018) | 1 line
Changed paths:
   M /trunk/src/include/GraphicsBase.h

added extern for baseRegisterIndex in GraphicsBase.h (#17385)
```



---

Comment by dimpase created at 2018-04-09 09:15:26

Although R 3.4.4 still have not included this patch. Oh well, sooner or later...
