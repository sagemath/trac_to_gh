# Issue 13632: PiecewisePolynomial.critical_points() results depend on variable of function

Issue created by migration from Trac.

Original creator: christiankuper

Original creation time: 2012-12-16 16:38:36

Assignee: burcin

CC:  wdj pbutler kcrisman

Keywords: Piecewise, critical_points

When using the example in the documentation of the function the following results are displayed for critical points:


```
sage: R.<x> = QQ[]
sage: f1 = x^0
sage: f2 = 10*x - x^2
sage: f3 = 3*x^4 - 156*x^3 + 3036*x^2 - 26208*x
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```


When doing the same with y instead of x as a variable an empty list is returned as a result:


```
sage: R.<y> = QQ[]                                        
sage: f1 = y^0                                            
sage: f2 = 10*y - y^2                                     
sage: f3 = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y           
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()                                 
[]
```


This behavior does not change even if y is explicitly defined as the variable:


```
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]],y)
sage: f.critical_points()                                   
[]
```


IMHO it should be possible to optain correct results no matter what the name of the variable is.


---

Attachment


---

Comment by afleckenstein created at 2012-12-17 14:25:23

Yes, the code practically forced x to be the variable. It should be fine now, the fix was simple.


---

Comment by afleckenstein created at 2012-12-17 14:31:08

Changing status from new to needs_review.


---

Comment by burcin created at 2012-12-17 14:45:29

Changing status from needs_review to needs_work.


---

Comment by burcin created at 2012-12-17 14:45:29

Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.

It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.


---

Attachment


---

Comment by afleckenstein created at 2012-12-18 00:14:52

Replying to [comment:3 burcin]:
> Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.
> 
> It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.

I put in the doctests in the ...withdoc.patch, as well as a testing of the `var` argument and the `default_variable()` function, it worked surprisingly well :-D


---

Comment by afleckenstein created at 2012-12-21 14:12:56

Changing status from needs_work to needs_review.


---

Comment by christiankuper created at 2012-12-22 14:26:12

Hello Andrew,

thank you for the patch. It indeed seems to solve the reported problem. However, allow me to make a few remarks:

* I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches
* I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial. I can do the following:


```
sage: f1(y) = y^0
sage: f2(y) = 10*y - y^2
sage: f3(y) = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
sage: z = var("z")                                           
sage: g = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], z)
sage: g.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```

* From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.
* The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:

```

sage: f2(y) = e^2*y - y^2
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
...
ValueError: No differentiation variable specified.

```


* I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):

```
sage: g.derivative()
Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
```


Christian


---

Comment by christiankuper created at 2012-12-22 14:26:41

Changing status from needs_review to needs_work.


---

Comment by afleckenstein created at 2012-12-22 21:04:17

I was going to change laplace too, but after looking at it more closely I decided to leave it alone.
I had no idea what to do with convolution().

Replying to [comment:6 christiankuper]:
> * I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches
No, it was a mistake, sorry.
> * I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial.
I put this in the doctest because Burcin suggested I made sure that default_variable() worked well, but it does seem a little redundant.
> * From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.
Fixed this.
> * The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:
> {{{
> 
> sage: f2(y) = e^2*y - y^2
> sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
> sage: f.critical_points()
> ...
> ValueError: No differentiation variable specified.
> 
> }}}
> 
This also fails if you try to do it in the current version of SAGE (with x as a variable). So yes, it is a bug in maxima. Also, I get the error

```
TypeError: ECL says: Error executing code in Maxima: allroots: expected
a polynomial in one variable; found variables [%e,x]
```

instead of a ValueError.
> * I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):
> {{{
> sage: g.derivative()
> Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
> }}}
Changed the description to reflect this.


---

Comment by afleckenstein created at 2012-12-25 17:30:17

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2013-01-04 14:05:39

Could you please 

* fold the patches into one patch

* replace everywhere the sentence "trac #13836" by the automatic link `:trac:`13836``


---

Comment by afleckenstein created at 2013-01-04 14:23:30

Replying to [comment:11 chapoton]:
> * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`
I'm not sure where I need to do this. Do you mean in the doctests?


---

Comment by kcrisman created at 2013-01-04 14:59:44

> > * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`
> I'm not sure where I need to do this. Do you mean in the doctests?
Correct, in attachment:trac_13836_piecewise_critpoints_withdoc.patch and attachment:trac_13836_piecewise_var_fix.patch there are three references to `#13836`.

Or is only attachment:trac_13836_piecewise_var_fix.patch needed?  You should make that clear in the ticket Description.


---

Comment by chapoton created at 2013-01-06 09:06:05

Sorry, the syntax of the `:trac:` is not quite correct in the latest patch. It should contain ``` symbols, namely `:trac:`13836``

You should check that it gives a good result when asking for the doc in the notebook.


---

Comment by christiankuper created at 2013-01-07 14:51:37

Hello Andrew,

I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.

What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.

Christian


---

Comment by christiankuper created at 2013-01-07 14:51:37

Changing status from needs_review to needs_work.


---

Comment by afleckenstein created at 2013-01-14 14:13:37

Replying to [comment:17 christiankuper]:
> Hello Andrew,
> 
> I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.
> 
> What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.
> 
> Christian
I fixed the critical_points inconsistency, thank you for pointing that out. As for the default_variable(), I was just using what was already written for the purpose, I think it's rather helpful. If var is undefined, we have to end up using default_variable() anyway, so IMHO it would be better to keep it a little simpler.

Andrew

P.S., I fixed a small grammatical error in the docstring for default_variable().


---

Comment by afleckenstein created at 2013-01-14 14:41:18

Changing status from needs_work to needs_review.


---

Comment by christiankuper created at 2013-02-10 16:45:55

Hello Andrew,

sorry for the long silence but now finally I find time to look into your patch. Running the doctest I currently get one failure:


```
**********************************************************************
File "/opt/sage-dev3/devel/sage-main/sage/functions/piecewise.py", line 501:
    sage: f.trapezoid(4)
Expected:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*y], [(1/2, 1), 9/2*y - 2], [(1, 3/2), 1/2*y + 2], [(3/2, 2), -7/2*y + 8]]
Got:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*x], [(1/2, 1), 9/2*x - 2], [(1, 3/2), 1/2*x + 2], [(3/2, 2), -7/2*x + 8]]
**********************************************************************
```


I am not sure why this is happening but will try to look into it.

Christian


---

Comment by christiankuper created at 2013-02-10 16:46:35

Changing status from needs_review to needs_work.


---

Comment by afleckenstein created at 2013-02-10 23:11:09

Replying to [comment:20 christiankuper]:
> Running the doctest I currently get one failure:

That's weird, because when I test piecewise.py everything passes:


```
andrew`@`andrew-laptop ~/sage-5.6/devel/sage $ ../../sage -t --long sage/functions/piecewise.py 
sage -t --long "devel/sage-main/sage/functions/piecewise.py"
	 [26.7 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 26.7 seconds

```


I also manually tested the code, (which I assumed to be my addition to the trapezoid docstring) and achieved the expected results.


---

Comment by christiankuper created at 2013-02-11 18:48:48

Hmm, that really is weird. Hopefully I loaded the correct patch (trac_13836_piecewise_var_fix.patch?).


---

Comment by christiankuper created at 2013-03-03 12:59:44

Hello Andrew,

finally found the time to study this patch again. Meanwhile I updated to 5.7 and could not reproduce the error I reported. However, two new ones popped up, although the second one IMHO is just related to me not having build the complete doc.


```
The following tests failed:


	sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
	sage -t  --long -force_lib "devel/sage/sage/misc/sagedoc.py"
```


The details from the log file:


```
sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
**********************************************************************
File "/opt/sage-dev3/devel/sage/doc/en/constructions/calculus.rst", line 377:
    sage: f.fourier_series_partial_sum(3,pi)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_16[7]>", line 1, in <module>
        f.fourier_series_partial_sum(Integer(3),pi)###line 377:
    sage: f.fourier_series_partial_sum(3,pi)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1192, in fourier_series_partial_sum
        return self._fourier_series_helper(N, L, lambda n: 1)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1161, in _fourier_series_helper
        x = self.default_variable()
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 719, in default_variable
        fun = SR(fun)
      File "parent.pyx", line 834, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7415)
      File "coerce_maps.pyx", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3583)
      File "coerce_maps.pyx", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3485)
      File "ring.pyx", line 284, in sage.symbolic.ring.SymbolicRing._element_constructor_ (sage/symbolic/ring.cpp:4879)
    TypeError
```


I believe that the error is caused by the fact that piecewise.default_variable() raises a TypeError when lambda functions are used (the example in calculus.rst uses lambda functions). Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

So I do not know whether this patch can be set to positive review or whether that bug needs to be fixed first.

Christian


---

Comment by afleckenstein created at 2013-03-14 12:40:00

Replying to [comment:24 christiankuper]:
> Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

I don't know any better than you do, perhaps we could get someone else's opinion?


---

Comment by christiankuper created at 2013-03-29 17:02:40

Just spent a few hours testing and looking into this patch. Forget what I said before: This error  IS caused by this patch. After applying the patch piecewise.py cannot handle lambda functions any more.

Christian


---

Comment by christiankuper created at 2013-03-29 18:14:15

Catch errors due to lambda functions


---

Attachment


---

Comment by christiankuper created at 2013-03-29 18:32:32

Hello Andrew,

I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?

Christian


---

Comment by afleckenstein created at 2013-04-01 14:24:07

Replying to [comment:28 christiankuper]:
> Hello Andrew,
> 
> I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?
> 
> Christian

Looks good to me! Thanks for figuring it out, I was kind of lost at this part.

Andrew


---

Comment by christiankuper created at 2013-04-01 17:46:41

> 
> Looks good to me! Thanks for figuring it out, I was kind of lost at this part.
> 
> Andrew

I would suggest you put the ticket to 'needs_review' then.


---

Comment by afleckenstein created at 2013-04-01 17:47:55

Changing status from needs_work to needs_review.


---

Comment by christiankuper created at 2013-04-07 12:29:28

As I could find no more bugs I will put the patch on positive_review. Thanks for the fix.

Christian


---

Comment by christiankuper created at 2013-04-07 12:29:28

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-08 08:32:16

[attachment:trac_13836-rev.patch] needs a proper commit message.


---

Comment by jdemeyer created at 2013-04-08 10:46:14

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-04-08 10:46:14

The documentation doesn't build properly:

```
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.critical_points:23: WARNING: Literal block expected; none found.
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.trapezoid:36: WARNING: Literal block expected; none found.
```



---

Attachment


---

Attachment


---

Comment by afleckenstein created at 2013-04-17 12:40:23

Changing status from needs_work to needs_review.


---

Comment by afleckenstein created at 2013-05-15 13:30:53

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-19 08:38:01

Resolution: fixed
