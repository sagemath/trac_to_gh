# Issue 13632: PiecewisePolynomial.critical_points() results depend on variable of function

archive/issues_013632.json:
```json
{
    "body": "Assignee: burcin\n\nCC:  wdj pbutler kcrisman\n\nKeywords: Piecewise, critical_points\n\nWhen using the example in the documentation of the function the following results are displayed for critical points:\n\n\n```\nsage: R.<x> = QQ[]\nsage: f1 = x^0\nsage: f2 = 10*x - x^2\nsage: f3 = 3*x^4 - 156*x^3 + 3036*x^2 - 26208*x\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])\nsage: f.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\n```\n\n\nWhen doing the same with y instead of x as a variable an empty list is returned as a result:\n\n\n```\nsage: R.<y> = QQ[]                                        \nsage: f1 = y^0                                            \nsage: f2 = 10*y - y^2                                     \nsage: f3 = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y           \nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])\nsage: f.critical_points()                                 \n[]\n```\n\n\nThis behavior does not change even if y is explicitly defined as the variable:\n\n\n```\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]],y)\nsage: f.critical_points()                                   \n[]\n```\n\n\nIMHO it should be possible to optain correct results no matter what the name of the variable is.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13836\n\n",
    "created_at": "2012-12-16T16:38:36Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "PiecewisePolynomial.critical_points() results depend on variable of function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13632",
    "user": "christiankuper"
}
```
Assignee: burcin

CC:  wdj pbutler kcrisman

Keywords: Piecewise, critical_points

When using the example in the documentation of the function the following results are displayed for critical points:


```
sage: R.<x> = QQ[]
sage: f1 = x^0
sage: f2 = 10*x - x^2
sage: f3 = 3*x^4 - 156*x^3 + 3036*x^2 - 26208*x
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```


When doing the same with y instead of x as a variable an empty list is returned as a result:


```
sage: R.<y> = QQ[]                                        
sage: f1 = y^0                                            
sage: f2 = 10*y - y^2                                     
sage: f3 = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y           
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]])
sage: f.critical_points()                                 
[]
```


This behavior does not change even if y is explicitly defined as the variable:


```
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]],y)
sage: f.critical_points()                                   
[]
```


IMHO it should be possible to optain correct results no matter what the name of the variable is.

Issue created by migration from https://trac.sagemath.org/ticket/13836





---

archive/issue_comments_168658.json:
```json
{
    "body": "Attachment [trac_13836_piecewise_critpoints_fix.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_critpoints_fix.patch) by afleckenstein created at 2012-12-17 14:20:56",
    "created_at": "2012-12-17T14:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168658",
    "user": "afleckenstein"
}
```

Attachment [trac_13836_piecewise_critpoints_fix.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_critpoints_fix.patch) by afleckenstein created at 2012-12-17 14:20:56



---

archive/issue_comments_168659.json:
```json
{
    "body": "Yes, the code practically forced x to be the variable. It should be fine now, the fix was simple.",
    "created_at": "2012-12-17T14:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168659",
    "user": "afleckenstein"
}
```

Yes, the code practically forced x to be the variable. It should be fine now, the fix was simple.



---

archive/issue_comments_168660.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-12-17T14:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168660",
    "user": "afleckenstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_168661.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-12-17T14:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168661",
    "user": "burcin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_168662.json:
```json
{
    "body": "Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.\n\nIt would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.",
    "created_at": "2012-12-17T14:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168662",
    "user": "burcin"
}
```

Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.

It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.



---

archive/issue_comments_168663.json:
```json
{
    "body": "Attachment [trac_13836_piecewise_critpoints_withdoc.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch) by afleckenstein created at 2012-12-18 00:13:06",
    "created_at": "2012-12-18T00:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168663",
    "user": "afleckenstein"
}
```

Attachment [trac_13836_piecewise_critpoints_withdoc.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_critpoints_withdoc.patch) by afleckenstein created at 2012-12-18 00:13:06



---

archive/issue_comments_168664.json:
```json
{
    "body": "Replying to [comment:3 burcin]:\n> Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.\n> \n> It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.\n\nI put in the doctests in the ...withdoc.patch, as well as a testing of the `var` argument and the `default_variable()` function, it worked surprisingly well :-D",
    "created_at": "2012-12-18T00:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168664",
    "user": "afleckenstein"
}
```

Replying to [comment:3 burcin]:
> Thanks for the quick patch. Can you add doctests to demonstrate the fix? The example in the description should be enough.
> 
> It would be good to make sure this plays well with the `var` argument of the `PiecewisePolynomial` constructor and the `default_variable()` function. I don't think this is necessary for a positive review though.

I put in the doctests in the ...withdoc.patch, as well as a testing of the `var` argument and the `default_variable()` function, it worked surprisingly well :-D



---

archive/issue_comments_168665.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-12-21T14:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168665",
    "user": "afleckenstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168666.json:
```json
{
    "body": "Hello Andrew,\n\nthank you for the patch. It indeed seems to solve the reported problem. However, allow me to make a few remarks:\n\n* I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches\n* I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial. I can do the following:\n\n\n```\nsage: f1(y) = y^0\nsage: f2(y) = 10*y - y^2\nsage: f3(y) = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\nsage: f.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\nsage: z = var(\"z\")                                           \nsage: g = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], z)\nsage: g.critical_points()\n[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]\n```\n\n* From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.\n* The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:\n\n```\n\nsage: f2(y) = e^2*y - y^2\nsage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\nsage: f.critical_points()\n...\nValueError: No differentiation variable specified.\n\n```\n\n\n* I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):\n\n```\nsage: g.derivative()\nPiecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]\n```\n\n\nChristian",
    "created_at": "2012-12-22T14:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168666",
    "user": "christiankuper"
}
```

Hello Andrew,

thank you for the patch. It indeed seems to solve the reported problem. However, allow me to make a few remarks:

* I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches
* I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial. I can do the following:


```
sage: f1(y) = y^0
sage: f2(y) = 10*y - y^2
sage: f3(y) = 3*y^4 - 156*y^3 + 3036*y^2 - 26208*y
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
sage: z = var("z")                                           
sage: g = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], z)
sage: g.critical_points()
[5.0, 12.000000000000124, 12.999999999999725, 14.000000000000151]
```

* From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.
* The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:

```

sage: f2(y) = e^2*y - y^2
sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
sage: f.critical_points()
...
ValueError: No differentiation variable specified.

```


* I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):

```
sage: g.derivative()
Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
```


Christian



---

archive/issue_comments_168667.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-12-22T14:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168667",
    "user": "christiankuper"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_168668.json:
```json
{
    "body": "I was going to change laplace too, but after looking at it more closely I decided to leave it alone.\nI had no idea what to do with convolution().\n\nReplying to [comment:6 christiankuper]:\n> * I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches\nNo, it was a mistake, sorry.\n> * I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial.\nI put this in the doctest because Burcin suggested I made sure that default_variable() worked well, but it does seem a little redundant.\n> * From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.\nFixed this.\n> * The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:\n> {{{\n> \n> sage: f2(y) = e^2*y - y^2\n> sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)\n> sage: f.critical_points()\n> ...\n> ValueError: No differentiation variable specified.\n> \n> }}}\n> \nThis also fails if you try to do it in the current version of SAGE (with x as a variable). So yes, it is a bug in maxima. Also, I get the error\n\n```\nTypeError: ECL says: Error executing code in Maxima: allroots: expected\na polynomial in one variable; found variables [%e,x]\n```\n\ninstead of a ValueError.\n> * I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):\n> {{{\n> sage: g.derivative()\n> Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]\n> }}}\nChanged the description to reflect this.",
    "created_at": "2012-12-22T21:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168668",
    "user": "afleckenstein"
}
```

I was going to change laplace too, but after looking at it more closely I decided to leave it alone.
I had no idea what to do with convolution().

Replying to [comment:6 christiankuper]:
> * I am not sure whether you intentionally put the patch and the doctest for the patch in two seperate patches
No, it was a mistake, sorry.
> * I think the second part of your doctest does not proove anything as y is the only variable in your PiecewisePolynomial.
I put this in the doctest because Burcin suggested I made sure that default_variable() worked well, but it does seem a little redundant.
> * From personal experience: I would avoid doctests with precion outputs like this because they might fail due to slightly different results on 32 bit machines.
Fixed this.
> * The following modification results in an error, although e is a constant and not a variable. However, I think this is (also) a problem related to maxima. At least the exception raised currently is misleading. I modified the f2 in the example above:
> {{{
> 
> sage: f2(y) = e^2*y - y^2
> sage: f = Piecewise([[(0,3),f1],[(3,10),f2],[(10,20),f3]], y)
> sage: f.critical_points()
> ...
> ValueError: No differentiation variable specified.
> 
> }}}
> 
This also fails if you try to do it in the current version of SAGE (with x as a variable). So yes, it is a bug in maxima. Also, I get the error

```
TypeError: ECL says: Error executing code in Maxima: allroots: expected
a polynomial in one variable; found variables [%e,x]
```

instead of a ValueError.
> * I looked through the piecewise.py module to see whether there are other instances of forcing the variable to x. There are indeed, but the errors they are causing are different (see example below). Do you think it would be sensible to deal with these cases also in this patch (as they are related to the same root cause)? Here is an example were the output is basically correct but the variable is wrong (g is the function defined above):
> {{{
> sage: g.derivative()
> Piecewise defined function with 3 parts, [[(0, 3), x |--> 0], [(3, 10), x |--> 0], [(10, 20), x |--> 0]]
> }}}
Changed the description to reflect this.



---

archive/issue_comments_168669.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-12-25T17:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168669",
    "user": "afleckenstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168670.json:
```json
{
    "body": "Could you please \n\n* fold the patches into one patch\n\n* replace everywhere the sentence \"trac #13836\" by the automatic link `:trac:`13836``",
    "created_at": "2013-01-04T14:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168670",
    "user": "chapoton"
}
```

Could you please 

* fold the patches into one patch

* replace everywhere the sentence "trac #13836" by the automatic link `:trac:`13836``



---

archive/issue_comments_168671.json:
```json
{
    "body": "Replying to [comment:11 chapoton]:\n> * replace everywhere the sentence \"trac #13836\" by the automatic link :trac:`13836`\nI'm not sure where I need to do this. Do you mean in the doctests?",
    "created_at": "2013-01-04T14:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168671",
    "user": "afleckenstein"
}
```

Replying to [comment:11 chapoton]:
> * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`
I'm not sure where I need to do this. Do you mean in the doctests?



---

archive/issue_comments_168672.json:
```json
{
    "body": "> > * replace everywhere the sentence \"trac #13836\" by the automatic link :trac:`13836`\n> I'm not sure where I need to do this. Do you mean in the doctests?\nCorrect, in attachment:trac_13836_piecewise_critpoints_withdoc.patch and attachment:trac_13836_piecewise_var_fix.patch there are three references to `#13836`.\n\nOr is only attachment:trac_13836_piecewise_var_fix.patch needed?  You should make that clear in the ticket Description.",
    "created_at": "2013-01-04T14:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168672",
    "user": "kcrisman"
}
```

> > * replace everywhere the sentence "trac #13836" by the automatic link :trac:`13836`
> I'm not sure where I need to do this. Do you mean in the doctests?
Correct, in attachment:trac_13836_piecewise_critpoints_withdoc.patch and attachment:trac_13836_piecewise_var_fix.patch there are three references to `#13836`.

Or is only attachment:trac_13836_piecewise_var_fix.patch needed?  You should make that clear in the ticket Description.



---

archive/issue_comments_168673.json:
```json
{
    "body": "Sorry, the syntax of the `:trac:` is not quite correct in the latest patch. It should contain ``` symbols, namely `:trac:`13836``\n\nYou should check that it gives a good result when asking for the doc in the notebook.",
    "created_at": "2013-01-06T09:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168673",
    "user": "chapoton"
}
```

Sorry, the syntax of the `:trac:` is not quite correct in the latest patch. It should contain ``` symbols, namely `:trac:`13836``

You should check that it gives a good result when asking for the doc in the notebook.



---

archive/issue_comments_168674.json:
```json
{
    "body": "Hello Andrew,\n\nI think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using \"x\" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.\n\nWhat would be even nicer than using the default_variable IMHO would be the use of the \"var\" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.\n\nChristian",
    "created_at": "2013-01-07T14:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168674",
    "user": "christiankuper"
}
```

Hello Andrew,

I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.

What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.

Christian



---

archive/issue_comments_168675.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-07T14:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168675",
    "user": "christiankuper"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_168676.json:
```json
{
    "body": "Replying to [comment:17 christiankuper]:\n> Hello Andrew,\n> \n> I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using \"x\" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.\n> \n> What would be even nicer than using the default_variable IMHO would be the use of the \"var\" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.\n> \n> Christian\nI fixed the critical_points inconsistency, thank you for pointing that out. As for the default_variable(), I was just using what was already written for the purpose, I think it's rather helpful. If var is undefined, we have to end up using default_variable() anyway, so IMHO it would be better to keep it a little simpler.\n\nAndrew\n\nP.S., I fixed a small grammatical error in the docstring for default_variable().",
    "created_at": "2013-01-14T14:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168676",
    "user": "afleckenstein"
}
```

Replying to [comment:17 christiankuper]:
> Hello Andrew,
> 
> I think there is still a small inconsistency in your code: In most methods you use the default_variable as the parameter. However, in critical_points() you just deleted old asignment of using "x" as the variable. While the other methods work with expressions with more than variable, critical_points() raises a TypeError.
> 
> What would be even nicer than using the default_variable IMHO would be the use of the "var" parameter in the constructor (if defined). What do yout think? Or maybe this would be something for a nother patch.
> 
> Christian
I fixed the critical_points inconsistency, thank you for pointing that out. As for the default_variable(), I was just using what was already written for the purpose, I think it's rather helpful. If var is undefined, we have to end up using default_variable() anyway, so IMHO it would be better to keep it a little simpler.

Andrew

P.S., I fixed a small grammatical error in the docstring for default_variable().



---

archive/issue_comments_168677.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-14T14:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168677",
    "user": "afleckenstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168678.json:
```json
{
    "body": "Hello Andrew,\n\nsorry for the long silence but now finally I find time to look into your patch. Running the doctest I currently get one failure:\n\n\n```\n**********************************************************************\nFile \"/opt/sage-dev3/devel/sage-main/sage/functions/piecewise.py\", line 501:\n    sage: f.trapezoid(4)\nExpected:\n    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*y], [(1/2, 1), 9/2*y - 2], [(1, 3/2), 1/2*y + 2], [(3/2, 2), -7/2*y + 8]]\nGot:\n    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*x], [(1/2, 1), 9/2*x - 2], [(1, 3/2), 1/2*x + 2], [(3/2, 2), -7/2*x + 8]]\n**********************************************************************\n```\n\n\nI am not sure why this is happening but will try to look into it.\n\nChristian",
    "created_at": "2013-02-10T16:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168678",
    "user": "christiankuper"
}
```

Hello Andrew,

sorry for the long silence but now finally I find time to look into your patch. Running the doctest I currently get one failure:


```
**********************************************************************
File "/opt/sage-dev3/devel/sage-main/sage/functions/piecewise.py", line 501:
    sage: f.trapezoid(4)
Expected:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*y], [(1/2, 1), 9/2*y - 2], [(1, 3/2), 1/2*y + 2], [(3/2, 2), -7/2*y + 8]]
Got:
    Piecewise defined function with 4 parts, [[(0, 1/2), 1/2*x], [(1/2, 1), 9/2*x - 2], [(1, 3/2), 1/2*x + 2], [(3/2, 2), -7/2*x + 8]]
**********************************************************************
```


I am not sure why this is happening but will try to look into it.

Christian



---

archive/issue_comments_168679.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-02-10T16:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168679",
    "user": "christiankuper"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_168680.json:
```json
{
    "body": "Replying to [comment:20 christiankuper]:\n> Running the doctest I currently get one failure:\n\nThat's weird, because when I test piecewise.py everything passes:\n\n\n```\nandrew@andrew-laptop ~/sage-5.6/devel/sage $ ../../sage -t --long sage/functions/piecewise.py \nsage -t --long \"devel/sage-main/sage/functions/piecewise.py\"\n\t [26.7 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 26.7 seconds\n\n```\n\n\nI also manually tested the code, (which I assumed to be my addition to the trapezoid docstring) and achieved the expected results.",
    "created_at": "2013-02-10T23:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168680",
    "user": "afleckenstein"
}
```

Replying to [comment:20 christiankuper]:
> Running the doctest I currently get one failure:

That's weird, because when I test piecewise.py everything passes:


```
andrew@andrew-laptop ~/sage-5.6/devel/sage $ ../../sage -t --long sage/functions/piecewise.py 
sage -t --long "devel/sage-main/sage/functions/piecewise.py"
	 [26.7 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 26.7 seconds

```


I also manually tested the code, (which I assumed to be my addition to the trapezoid docstring) and achieved the expected results.



---

archive/issue_comments_168681.json:
```json
{
    "body": "Hmm, that really is weird. Hopefully I loaded the correct patch (trac_13836_piecewise_var_fix.patch?).",
    "created_at": "2013-02-11T18:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168681",
    "user": "christiankuper"
}
```

Hmm, that really is weird. Hopefully I loaded the correct patch (trac_13836_piecewise_var_fix.patch?).



---

archive/issue_comments_168682.json:
```json
{
    "body": "Hello Andrew,\n\nfinally found the time to study this patch again. Meanwhile I updated to 5.7 and could not reproduce the error I reported. However, two new ones popped up, although the second one IMHO is just related to me not having build the complete doc.\n\n\n```\nThe following tests failed:\n\n\n\tsage -t  --long -force_lib \"devel/sage/doc/en/constructions/calculus.rst\"\n\tsage -t  --long -force_lib \"devel/sage/sage/misc/sagedoc.py\"\n```\n\n\nThe details from the log file:\n\n\n```\nsage -t  --long -force_lib \"devel/sage/doc/en/constructions/calculus.rst\"\n**********************************************************************\nFile \"/opt/sage-dev3/devel/sage/doc/en/constructions/calculus.rst\", line 377:\n    sage: f.fourier_series_partial_sum(3,pi)\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage-dev3/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/opt/sage-dev3/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/opt/sage-dev3/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_16[7]>\", line 1, in <module>\n        f.fourier_series_partial_sum(Integer(3),pi)###line 377:\n    sage: f.fourier_series_partial_sum(3,pi)\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 1192, in fourier_series_partial_sum\n        return self._fourier_series_helper(N, L, lambda n: 1)\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 1161, in _fourier_series_helper\n        x = self.default_variable()\n      File \"/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py\", line 719, in default_variable\n        fun = SR(fun)\n      File \"parent.pyx\", line 834, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7415)\n      File \"coerce_maps.pyx\", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3583)\n      File \"coerce_maps.pyx\", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3485)\n      File \"ring.pyx\", line 284, in sage.symbolic.ring.SymbolicRing._element_constructor_ (sage/symbolic/ring.cpp:4879)\n    TypeError\n```\n\n\nI believe that the error is caused by the fact that piecewise.default_variable() raises a TypeError when lambda functions are used (the example in calculus.rst uses lambda functions). Correct me if I am worng but I don't think this is related to anything you changed in piecewise.\n\nSo I do not know whether this patch can be set to positive review or whether that bug needs to be fixed first.\n\nChristian",
    "created_at": "2013-03-03T12:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168682",
    "user": "christiankuper"
}
```

Hello Andrew,

finally found the time to study this patch again. Meanwhile I updated to 5.7 and could not reproduce the error I reported. However, two new ones popped up, although the second one IMHO is just related to me not having build the complete doc.


```
The following tests failed:


	sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
	sage -t  --long -force_lib "devel/sage/sage/misc/sagedoc.py"
```


The details from the log file:


```
sage -t  --long -force_lib "devel/sage/doc/en/constructions/calculus.rst"
**********************************************************************
File "/opt/sage-dev3/devel/sage/doc/en/constructions/calculus.rst", line 377:
    sage: f.fourier_series_partial_sum(3,pi)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/opt/sage-dev3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_16[7]>", line 1, in <module>
        f.fourier_series_partial_sum(Integer(3),pi)###line 377:
    sage: f.fourier_series_partial_sum(3,pi)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1192, in fourier_series_partial_sum
        return self._fourier_series_helper(N, L, lambda n: 1)
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 1161, in _fourier_series_helper
        x = self.default_variable()
      File "/opt/sage-dev3/local/lib/python/site-packages/sage/functions/piecewise.py", line 719, in default_variable
        fun = SR(fun)
      File "parent.pyx", line 834, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7415)
      File "coerce_maps.pyx", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3583)
      File "coerce_maps.pyx", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3485)
      File "ring.pyx", line 284, in sage.symbolic.ring.SymbolicRing._element_constructor_ (sage/symbolic/ring.cpp:4879)
    TypeError
```


I believe that the error is caused by the fact that piecewise.default_variable() raises a TypeError when lambda functions are used (the example in calculus.rst uses lambda functions). Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

So I do not know whether this patch can be set to positive review or whether that bug needs to be fixed first.

Christian



---

archive/issue_comments_168683.json:
```json
{
    "body": "Replying to [comment:24 christiankuper]:\n> Correct me if I am worng but I don't think this is related to anything you changed in piecewise.\n\nI don't know any better than you do, perhaps we could get someone else's opinion?",
    "created_at": "2013-03-14T12:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168683",
    "user": "afleckenstein"
}
```

Replying to [comment:24 christiankuper]:
> Correct me if I am worng but I don't think this is related to anything you changed in piecewise.

I don't know any better than you do, perhaps we could get someone else's opinion?



---

archive/issue_comments_168684.json:
```json
{
    "body": "Just spent a few hours testing and looking into this patch. Forget what I said before: This error  IS caused by this patch. After applying the patch piecewise.py cannot handle lambda functions any more.\n\nChristian",
    "created_at": "2013-03-29T17:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168684",
    "user": "christiankuper"
}
```

Just spent a few hours testing and looking into this patch. Forget what I said before: This error  IS caused by this patch. After applying the patch piecewise.py cannot handle lambda functions any more.

Christian



---

archive/issue_comments_168685.json:
```json
{
    "body": "Catch errors due to lambda functions",
    "created_at": "2013-03-29T18:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168685",
    "user": "christiankuper"
}
```

Catch errors due to lambda functions



---

archive/issue_comments_168686.json:
```json
{
    "body": "Attachment [trac_13836-rev.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836-rev.patch) by christiankuper created at 2013-03-29 18:16:31",
    "created_at": "2013-03-29T18:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168686",
    "user": "christiankuper"
}
```

Attachment [trac_13836-rev.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836-rev.patch) by christiankuper created at 2013-03-29 18:16:31



---

archive/issue_comments_168687.json:
```json
{
    "body": "Hello Andrew,\n\nI added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?\n\nChristian",
    "created_at": "2013-03-29T18:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168687",
    "user": "christiankuper"
}
```

Hello Andrew,

I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?

Christian



---

archive/issue_comments_168688.json:
```json
{
    "body": "Replying to [comment:28 christiankuper]:\n> Hello Andrew,\n> \n> I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?\n> \n> Christian\n\nLooks good to me! Thanks for figuring it out, I was kind of lost at this part.\n\nAndrew",
    "created_at": "2013-04-01T14:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168688",
    "user": "afleckenstein"
}
```

Replying to [comment:28 christiankuper]:
> Hello Andrew,
> 
> I added a little piece of code causing piecewise.default_variable() to default to 'x' if lambda functions are used. This removes the doctest errors. Waht do you think?
> 
> Christian

Looks good to me! Thanks for figuring it out, I was kind of lost at this part.

Andrew



---

archive/issue_comments_168689.json:
```json
{
    "body": "> \n> Looks good to me! Thanks for figuring it out, I was kind of lost at this part.\n> \n> Andrew\n\nI would suggest you put the ticket to 'needs_review' then.",
    "created_at": "2013-04-01T17:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168689",
    "user": "christiankuper"
}
```

> 
> Looks good to me! Thanks for figuring it out, I was kind of lost at this part.
> 
> Andrew

I would suggest you put the ticket to 'needs_review' then.



---

archive/issue_comments_168690.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-01T17:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168690",
    "user": "afleckenstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168691.json:
```json
{
    "body": "As I could find no more bugs I will put the patch on positive_review. Thanks for the fix.\n\nChristian",
    "created_at": "2013-04-07T12:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168691",
    "user": "christiankuper"
}
```

As I could find no more bugs I will put the patch on positive_review. Thanks for the fix.

Christian



---

archive/issue_comments_168692.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-07T12:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168692",
    "user": "christiankuper"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_168693.json:
```json
{
    "body": "[attachment:trac_13836-rev.patch] needs a proper commit message.",
    "created_at": "2013-04-08T08:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168693",
    "user": "jdemeyer"
}
```

[attachment:trac_13836-rev.patch] needs a proper commit message.



---

archive/issue_comments_168694.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-04-08T10:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168694",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_168695.json:
```json
{
    "body": "The documentation doesn't build properly:\n\n```\ndochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.critical_points:23: WARNING: Literal block expected; none found.\ndochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.trapezoid:36: WARNING: Literal block expected; none found.\n```\n",
    "created_at": "2013-04-08T10:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168695",
    "user": "jdemeyer"
}
```

The documentation doesn't build properly:

```
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.critical_points:23: WARNING: Literal block expected; none found.
dochtml.log:[functions] /mazur/release/merger/sage-5.9.rc0/local/lib/python2.7/site-packages/sage/functions/piecewise.py:docstring of sage.functions.piecewise.PiecewisePolynomial.trapezoid:36: WARNING: Literal block expected; none found.
```




---

archive/issue_comments_168696.json:
```json
{
    "body": "Attachment [trac_13836-rev-commit.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836-rev-commit.patch) by afleckenstein created at 2013-04-17 12:38:57",
    "created_at": "2013-04-17T12:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168696",
    "user": "afleckenstein"
}
```

Attachment [trac_13836-rev-commit.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836-rev-commit.patch) by afleckenstein created at 2013-04-17 12:38:57



---

archive/issue_comments_168697.json:
```json
{
    "body": "Attachment [trac_13836_piecewise_var_fix.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_var_fix.patch) by afleckenstein created at 2013-04-17 12:40:23",
    "created_at": "2013-04-17T12:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168697",
    "user": "afleckenstein"
}
```

Attachment [trac_13836_piecewise_var_fix.patch](tarball://root/attachments/some-uuid/ticket13836/trac_13836_piecewise_var_fix.patch) by afleckenstein created at 2013-04-17 12:40:23



---

archive/issue_comments_168698.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-17T12:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168698",
    "user": "afleckenstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168699.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-15T13:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168699",
    "user": "afleckenstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_168700.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-19T08:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13632#issuecomment-168700",
    "user": "jdemeyer"
}
```

Resolution: fixed
