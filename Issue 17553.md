# Issue 17553: BuiltinFunction doesn't pass non-SR-coercible arguments to function code

archive/issues_017553.json:
```json
{
    "body": "CC:  jdemeyer\n\nThis affects authors of function code but shows also in:\n\n```\nsage: binomial(Qp(5)(8),3)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-1-43da6d5c56db> in <module>()\n----> 1 binomial(Qp(Integer(5))(Integer(8)),Integer(3))\n\n/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9048)()\n    842             (0, Integer Ring)\n    843         \"\"\"\n--> 844         res = super(GinacFunction, self).__call__(*args, **kwds)\n    845 \n    846         # Convert to Integer if the output was of type \"int\" and any of\n\n/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:10572)()\n    991             res = self._evalf_try_(*args)\n    992             if res is None:\n--> 993                 res = super(BuiltinFunction, self).__call__(\n    994                         *args, coerce=coerce, hold=hold)\n    995 \n\n/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6301)()\n    485                             nargs[i] = SR.coerce(carg)\n    486                         except Exception:\n--> 487                             raise TypeError, \"cannot coerce arguments: %s\"%(err)\n    488                 args = nargs\n    489         else: # coerce == False\n\nTypeError: cannot coerce arguments: no canonical coercion from 5-adic Field with capped relative precision 20 to Symbolic Ring\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17790\n\n",
    "created_at": "2015-02-17T06:45:33Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "BuiltinFunction doesn't pass non-SR-coercible arguments to function code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17553",
    "user": "rws"
}
```
CC:  jdemeyer

This affects authors of function code but shows also in:

```
sage: binomial(Qp(5)(8),3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-43da6d5c56db> in <module>()
----> 1 binomial(Qp(Integer(5))(Integer(8)),Integer(3))

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9048)()
    842             (0, Integer Ring)
    843         """
--> 844         res = super(GinacFunction, self).__call__(*args, **kwds)
    845 
    846         # Convert to Integer if the output was of type "int" and any of

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:10572)()
    991             res = self._evalf_try_(*args)
    992             if res is None:
--> 993                 res = super(BuiltinFunction, self).__call__(
    994                         *args, coerce=coerce, hold=hold)
    995 

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6301)()
    485                             nargs[i] = SR.coerce(carg)
    486                         except Exception:
--> 487                             raise TypeError, "cannot coerce arguments: %s"%(err)
    488                 args = nargs
    489         else: # coerce == False

TypeError: cannot coerce arguments: no canonical coercion from 5-adic Field with capped relative precision 20 to Symbolic Ring
```


Issue created by migration from https://trac.sagemath.org/ticket/17790





---

archive/issue_comments_234282.json:
```json
{
    "body": "So, either it's a problem of p-adics not being coercible into `SR` (which they should be?), or there should not be coercion but conversion in `function.pyx`.",
    "created_at": "2015-03-05T09:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234282",
    "user": "rws"
}
```

So, either it's a problem of p-adics not being coercible into `SR` (which they should be?), or there should not be coercion but conversion in `function.pyx`.



---

archive/issue_comments_234283.json:
```json
{
    "body": "It was the latter alternative, as there is no coercion. Please review.\n----\nNew commits:",
    "created_at": "2015-03-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234283",
    "user": "rws"
}
```

It was the latter alternative, as there is no coercion. Please review.
----
New commits:



---

archive/issue_comments_234284.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-05T15:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234284",
    "user": "rws"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_234285.json:
```json
{
    "body": "The recent #17852 makes `binomial(Qp(2)(9),5)` fail in this branch with `TypeError: function did not return a symbolic expression or an element that can be coerced into a symbolic expression`. Reason: `rings.arith.binomial` now returns (correctly) `1 + 5 + 2*5^2 + O(5^20)` instead of `56`.\n\nSo what should `Function` do when `self.eval` returns something not coercible?",
    "created_at": "2015-04-21T06:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234285",
    "user": "rws"
}
```

The recent #17852 makes `binomial(Qp(2)(9),5)` fail in this branch with `TypeError: function did not return a symbolic expression or an element that can be coerced into a symbolic expression`. Reason: `rings.arith.binomial` now returns (correctly) `1 + 5 + 2*5^2 + O(5^20)` instead of `56`.

So what should `Function` do when `self.eval` returns something not coercible?



---

archive/issue_comments_234286.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-21T06:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234286",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_234287.json:
```json
{
    "body": "`@`Jeroen, what reason is there in the respective snippet of `Function::__call__` l.478-491 not to do the following:\n\n```\n                nargs = [None]*len(args)\n                for i in range(len(args)):\n                    carg = args[i]\n                    try:\n                        nargs[i] = SR.coerce(carg)\n                    except Exception:\n                        nargs[i] = SR(carg)\n```\n\ni.e. not throwing at all. I keep needing exceptions like the `Qp` of this ticket.\n\nDo we have a fundamental problem here? Why can `rings.arith...` handle this differently?",
    "created_at": "2015-07-01T06:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234287",
    "user": "rws"
}
```

`@`Jeroen, what reason is there in the respective snippet of `Function::__call__` l.478-491 not to do the following:

```
                nargs = [None]*len(args)
                for i in range(len(args)):
                    carg = args[i]
                    try:
                        nargs[i] = SR.coerce(carg)
                    except Exception:
                        nargs[i] = SR(carg)
```

i.e. not throwing at all. I keep needing exceptions like the `Qp` of this ticket.

Do we have a fundamental problem here? Why can `rings.arith...` handle this differently?



---

archive/issue_comments_234288.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-17T13:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234288",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_234289.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-21T06:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234289",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_234290.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-05T08:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234290",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_234291.json:
```json
{
    "body": "one failing doctest see patchbot report",
    "created_at": "2016-08-18T16:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234291",
    "user": "chapoton"
}
```

one failing doctest see patchbot report



---

archive/issue_comments_234292.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-19T06:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234292",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_234293.json:
```json
{
    "body": "I think this ticket is wontfix because a better solution would be to write a global Python function accepting everything (as in rings.arith...) and dispatch to the symbolic function for symbolic arguments.\n\nIn the ticket case just do\n\n```\nsage: from sage.arith.misc import binomial\nsage: binomial(Qp(5)(8),3)\n1 + 5 + 2*5^2 + O(5^20)\n```\n",
    "created_at": "2017-11-09T08:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234293",
    "user": "rws"
}
```

I think this ticket is wontfix because a better solution would be to write a global Python function accepting everything (as in rings.arith...) and dispatch to the symbolic function for symbolic arguments.

In the ticket case just do

```
sage: from sage.arith.misc import binomial
sage: binomial(Qp(5)(8),3)
1 + 5 + 2*5^2 + O(5^20)
```




---

archive/issue_comments_234294.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-11-09T08:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234294",
    "user": "rws"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_234295.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2017-12-12T08:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17553",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17553#issuecomment-234295",
    "user": "embray"
}
```

Resolution: wontfix
