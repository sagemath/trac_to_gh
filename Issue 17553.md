# Issue 17553: BuiltinFunction doesn't pass non-SR-coercible arguments to function code

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2015-02-17 06:45:33

CC:  jdemeyer

This affects authors of function code but shows also in:

```
sage: binomial(Qp(5)(8),3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-43da6d5c56db> in <module>()
----> 1 binomial(Qp(Integer(5))(Integer(8)),Integer(3))

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9048)()
    842             (0, Integer Ring)
    843         """
--> 844         res = super(GinacFunction, self).__call__(*args, **kwds)
    845 
    846         # Convert to Integer if the output was of type "int" and any of

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:10572)()
    991             res = self._evalf_try_(*args)
    992             if res is None:
--> 993                 res = super(BuiltinFunction, self).__call__(
    994                         *args, coerce=coerce, hold=hold)
    995 

/home/ralf/sage/src/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6301)()
    485                             nargs[i] = SR.coerce(carg)
    486                         except Exception:
--> 487                             raise TypeError, "cannot coerce arguments: %s"%(err)
    488                 args = nargs
    489         else: # coerce == False

TypeError: cannot coerce arguments: no canonical coercion from 5-adic Field with capped relative precision 20 to Symbolic Ring
```



---

Comment by rws created at 2015-03-05 09:23:14

So, either it's a problem of p-adics not being coercible into `SR` (which they should be?), or there should not be coercion but conversion in `function.pyx`.


---

Comment by rws created at 2015-03-05 15:26:41

It was the latter alternative, as there is no coercion. Please review.
----
New commits:


---

Comment by rws created at 2015-03-05 15:26:41

Changing status from new to needs_review.


---

Comment by rws created at 2015-04-21 06:45:56

The recent #17852 makes `binomial(Qp(2)(9),5)` fail in this branch with `TypeError: function did not return a symbolic expression or an element that can be coerced into a symbolic expression`. Reason: `rings.arith.binomial` now returns (correctly) `1 + 5 + 2*5^2 + O(5^20)` instead of `56`.

So what should `Function` do when `self.eval` returns something not coercible?


---

Comment by rws created at 2015-04-21 06:45:56

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-07-01 06:50:03

`@`Jeroen, what reason is there in the respective snippet of `Function::__call__` l.478-491 not to do the following:

```
                nargs = [None]*len(args)
                for i in range(len(args)):
                    carg = args[i]
                    try:
                        nargs[i] = SR.coerce(carg)
                    except Exception:
                        nargs[i] = SR(carg)
```

i.e. not throwing at all. I keep needing exceptions like the `Qp` of this ticket.

Do we have a fundamental problem here? Why can `rings.arith...` handle this differently?


---

Comment by git created at 2016-06-17 13:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2016-06-21 06:31:26

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-08-05 08:04:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-18 16:18:04

one failing doctest see patchbot report


---

Comment by rws created at 2016-08-19 06:40:44

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-11-09 08:45:04

I think this ticket is wontfix because a better solution would be to write a global Python function accepting everything (as in rings.arith...) and dispatch to the symbolic function for symbolic arguments.

In the ticket case just do

```
sage: from sage.arith.misc import binomial
sage: binomial(Qp(5)(8),3)
1 + 5 + 2*5^2 + O(5^20)
```



---

Comment by rws created at 2017-11-09 08:45:04

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
