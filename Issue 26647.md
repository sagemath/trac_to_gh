# Issue 26647: Replace Combinatorial Object to Clonable List in DickWords

archive/issues_026647.json:
```json
{
    "body": "CC:  vklein hivert\n\nPart of #26883 meta-ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26884\n\n",
    "created_at": "2018-12-12T16:27:42Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Replace Combinatorial Object to Clonable List in DickWords",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26647",
    "user": "boussica"
}
```
CC:  vklein hivert

Part of #26883 meta-ticket.

Issue created by migration from https://trac.sagemath.org/ticket/26884





---

archive/issue_comments_374394.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-12T16:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374394",
    "user": "vklein"
}
```

New commits:



---

archive/issue_comments_374395.json:
```json
{
    "body": "rebase on 8.5.rc0\n----\nNew commits:",
    "created_at": "2018-12-12T17:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374395",
    "user": "vklein"
}
```

rebase on 8.5.rc0
----
New commits:



---

archive/issue_comments_374396.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-14T15:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374396",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_374397.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-14T17:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374397",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_374398.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-14T17:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374398",
    "user": "hivert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_374399.json:
```json
{
    "body": "one pyflakes warning (see patchbot plugins); coverage not 100%",
    "created_at": "2018-12-15T08:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374399",
    "user": "chapoton"
}
```

one pyflakes warning (see patchbot plugins); coverage not 100%



---

archive/issue_comments_374400.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-15T08:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374400",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_374401.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-16T00:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374401",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_374402.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-16T00:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374402",
    "user": "hivert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_374403.json:
```json
{
    "body": "-1 on going through an essentially trivial `_element_constructor_` in internal code that should give valid output. At the very least, you should not run the checks when constructing objects from internal code.\n\nI am also a little skeptical of this change:\n\n```diff\n-        if isinstance(word, DyckWord) and word.parent() is self:\n+        D = DyckWords_all()\n+        if isinstance(word, DyckWord) and word.parent() is D:\n             return word\n-        return self.element_class(self, list(word))\n+        return D.element_class(D, word)\n```\n\n`_element_constructor_` should return an element of ``self`` as these are not fa\u00e7ade parents. (Actually, the first check here can be removed because the coercion framework would have already caught that case before it got to the `_element_constructor_`.)\n\nGiven this change, I am very nervous about the resulting parent of the Dyck path. I suspect you are doing this because `ClonableList` also includes the parent in the check and you are subsequently forcing everything to be elements of the `DyckWords_all` to have comparisons work. This is bad practice and can mask a host of other subtle issues, especially when mixing fa\u00e7ade parents with code that is making a parent act like a fa\u00e7ade parent.\n\nThis looks like a bug to me:\n\n```diff\n                 sage: DyckWords().height_poset().an_element()   # indirect doctest\n-                [1, 0, 1, 0, 1, 0, 1, 0, 1, 0]\n+                [1, 0, 1, 0, 1, 0, 1, 0, 1, 1]\n```\n",
    "created_at": "2018-12-16T01:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374403",
    "user": "tscrim"
}
```

-1 on going through an essentially trivial `_element_constructor_` in internal code that should give valid output. At the very least, you should not run the checks when constructing objects from internal code.

I am also a little skeptical of this change:

```diff
-        if isinstance(word, DyckWord) and word.parent() is self:
+        D = DyckWords_all()
+        if isinstance(word, DyckWord) and word.parent() is D:
             return word
-        return self.element_class(self, list(word))
+        return D.element_class(D, word)
```

`_element_constructor_` should return an element of ``self`` as these are not façade parents. (Actually, the first check here can be removed because the coercion framework would have already caught that case before it got to the `_element_constructor_`.)

Given this change, I am very nervous about the resulting parent of the Dyck path. I suspect you are doing this because `ClonableList` also includes the parent in the check and you are subsequently forcing everything to be elements of the `DyckWords_all` to have comparisons work. This is bad practice and can mask a host of other subtle issues, especially when mixing façade parents with code that is making a parent act like a façade parent.

This looks like a bug to me:

```diff
                 sage: DyckWords().height_poset().an_element()   # indirect doctest
-                [1, 0, 1, 0, 1, 0, 1, 0, 1, 0]
+                [1, 0, 1, 0, 1, 0, 1, 0, 1, 1]
```




---

archive/issue_comments_374404.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-16T01:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374404",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_374405.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374405",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_374406.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374406",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_374407.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374407",
    "user": "embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_374408.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> -1 on going through an essentially trivial `_element_constructor_` in internal code that should give valid output. At the very least, you should not run the checks when constructing objects from internal code.\n\nThis is something that we need to discuss in relation with set factories. The idea of those is to allow the user to change the class and parent on an enumerating algorithm. Here you hardcoded the class and the parent. I strongly disagree with that. I'm using  `_element_constructor_` as a single entry point to allows for customisation.\n \n> `_element_constructor_` should return an element of ``self`` as these are not fa\u00e7ade parents. (Actually, the first check here can be removed because the coercion framework would have already caught that case before it got to the `_element_constructor_`.)\n\nAgain this is something that shoul'nt be hard coded.\n\n> I suspect you are doing this because `ClonableList` also includes the parent in the check and you are subsequently forcing everything to be elements of the `DyckWords_all` to have comparisons work. \n\nI'm not doing anything particular with parent for comparison that following the standard `element.__richcmp__` mechanism which compare the parent or use a coercion mechanism to ensure that the elements have the same parent. It seem that you decided to change this overall policy for some particular combinatorial objects which confuses me. \n\n> This is bad practice and can mask a host of other subtle issues, especially when mixing fa\u00e7ade parents with code that is making a parent act like a fa\u00e7ade parent. \n\nAny examples ?",
    "created_at": "2019-06-21T08:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374408",
    "user": "hivert"
}
```

Replying to [comment:12 tscrim]:
> -1 on going through an essentially trivial `_element_constructor_` in internal code that should give valid output. At the very least, you should not run the checks when constructing objects from internal code.

This is something that we need to discuss in relation with set factories. The idea of those is to allow the user to change the class and parent on an enumerating algorithm. Here you hardcoded the class and the parent. I strongly disagree with that. I'm using  `_element_constructor_` as a single entry point to allows for customisation.
 
> `_element_constructor_` should return an element of ``self`` as these are not façade parents. (Actually, the first check here can be removed because the coercion framework would have already caught that case before it got to the `_element_constructor_`.)

Again this is something that shoul'nt be hard coded.

> I suspect you are doing this because `ClonableList` also includes the parent in the check and you are subsequently forcing everything to be elements of the `DyckWords_all` to have comparisons work. 

I'm not doing anything particular with parent for comparison that following the standard `element.__richcmp__` mechanism which compare the parent or use a coercion mechanism to ensure that the elements have the same parent. It seem that you decided to change this overall policy for some particular combinatorial objects which confuses me. 

> This is bad practice and can mask a host of other subtle issues, especially when mixing façade parents with code that is making a parent act like a façade parent. 

Any examples ?



---

archive/issue_comments_374409.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374409",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_374410.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374410",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_374411.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374411",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_374412.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26647#issuecomment-374412",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
