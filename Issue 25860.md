# Issue 25860: Py3: Some fix in knot.link.py

Issue created by migration from Trac.

Original creator: vklein

Original creation time: 2018-08-20 12:24:07

CC:  embray




---

Comment by vklein created at 2018-08-20 12:44:44

New commits:


---

Comment by git created at 2018-08-20 12:53:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-08-20 13:16:08

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-08-20 15:50:38

beware of #25768, closed but not yet in the latest beta..


---

Comment by vklein created at 2018-08-20 16:10:41

Replying to [comment:7 chapoton]:
> beware of #25768, closed but not yet in the latest beta..
Nice ! I was currently on the `connected_components()` problem ( and have not think of just avoiding the `sort()`).

That being said it look like these two tickets can be automatically merged.


---

Comment by chapoton created at 2018-08-26 16:55:03

I think that the problem with doctests having a dictionary as result should rather be fixed globally in the doctest framework. 

Maybe Erik has ideas about that ? or already a fix in general ??


---

Comment by vklein created at 2018-08-27 12:38:49

I get the idea but i see one drawback: If the doctest framework manage to set a standard output order it might be confusing for the user because he might obtain another result order when copy/pasting the doctest in the sage interpreter.


---

Comment by embray created at 2018-08-28 15:04:04

Replying to [comment:9 chapoton]:
> I think that the problem with doctests having a dictionary as result should rather be fixed globally in the doctest framework. 
> 
> Maybe Erik has ideas about that ? or already a fix in general ??

IIRC just a plain dict is generally not a problem because its repr is already pprinted in ipython.  It's only a problem if the keys are heterogeneous.


---

Comment by embray created at 2018-08-28 15:10:05

FWIW on my python 3 branch I get:


```
$ ./sage -t src/sage/knots/
too many failed tests, not using stored timings
Running doctests with ID 2018-08-28-15-07-02-267ca96a.
Git branch: python3
Using --optional=meataxe,mpir,python2,sage
Doctesting 4 files.
sage -t src/sage/knots/knot.py
    [42 tests, 8.48 s]
sage -t src/sage/knots/__init__.py
    [0 tests, 0.00 s]
sage -t src/sage/knots/all.py
    [0 tests, 0.00 s]
sage -t src/sage/knots/link.py
**********************************************************************
File "src/sage/knots/link.py", line 1995, in sage.knots.link.Link.regions
Failed example:
    L.regions()
Expected:
    [[1, 7, -4], [2, -5, -7], [3, -8, 5], [4, 8], [6, -1, -3], [-2, -6]]
Got:
    [[1, 7, -4], [2, -5, -7], [3, -8, 5], [4, 8], [6, -1, -3], [-6, -2]]
**********************************************************************
File "src/sage/knots/link.py", line 2002, in sage.knots.link.Link.regions
Failed example:
    L.regions()
Expected:
    [[1, 3, 5], [2, -1], [4, -3], [6, -5], [-2, -6, -4]]
Got:
    [[1, 3, 5], [2, -1], [4, -3], [6, -5], [-6, -4, -2]]
**********************************************************************
File "src/sage/knots/link.py", line 2005, in sage.knots.link.Link.regions
Failed example:
    L.regions()
Expected:
    [[1, -5], [2, -8, 4, 5], [3, 8], [6, -9, -2], [7, -3, 9], [10, -4, -7], [-10, -6, -1]]
Got:
    [[1, -5],
     [2, -8, 4, 5],
     [3, 8],
     [6, -9, -2],
     [7, -3, 9],
     [10, -4, -7],
     [-1, -10, -6]]
**********************************************************************
File "src/sage/knots/link.py", line 2008, in sage.knots.link.Link.regions
Failed example:
    L.regions()
Expected:
    [[-3], [-4], [-6], [-8], [1, 2, 5, 7], [-2, 3, -1, 8, -7, 6, -5, 4]]
Got:
    [[-3], [-4], [-6], [-8], [1, 2, 5, 7], [-1, 8, -7, 6, -5, 4, -2, 3]]
**********************************************************************
1 item had failures:
   4 of  17 in sage.knots.link.Link.regions
    [413 tests, 4 failures, 8.36 s]
----------------------------------------------------------------------
sage -t src/sage/knots/link.py  # 4 doctests failed
----------------------------------------------------------------------
Total time for all tests: 17.1 seconds
    cpu time: 9.1 seconds
    cumulative wall time: 16.8 seconds
```


So I think some of these other tests are fixed elsewhere.


---

Comment by vklein created at 2018-08-29 07:45:50

Replying to [comment:12 embray]:
> FWIW on my python 3 branch I get:
> 
> So I think some of these other tests are fixed elsewhere.

It might be something on your branch because i still get `_directions_of_edges` doctests error with sage version 8.4.beta2.



```
$ sage -t --long src/sage/knots/link.py
...
2 items had failures:
   3 of   7 in sage.knots.link.Link._directions_of_edges
   4 of  17 in sage.knots.link.Link.regions
    [414 tests, 7 failures, 5.01 s]

```



---

Comment by embray created at 2018-08-29 09:57:26

True, that one might be just luck, because I'm not sure why it would appear "fixed" otherwise.  However, normally a plain dict as output should not be a problem--in this case it might fail only because it's a tuple of dicts.  I _think_ it would work if the tests were changed to something (which I find more instructive anyways) like:


```
sage: tails, heads = L._directions_of_edges()
sage: tails
...
sage: heads
...
```


in other words, printing each dict individually should work.


---

Comment by vklein created at 2018-08-29 12:18:12

Replying to [comment:14 embray]:
> in other words, printing each dict individually should work.

Sadly, if i am not missing something, it doesn't : 

Py2

```
sage: L = Link([[1, 3, 2, 4], [2, 3, 1, 4]])
sage: tails, heads = L._directions_of_edges()
sage: tails
{1: [2, 3, 1, 4], 2: [1, 3, 2, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}
sage: heads
{1: [1, 3, 2, 4], 2: [2, 3, 1, 4], 3: [2, 3, 1, 4], 4: [1, 3, 2, 4]}
```


Py3


```
...
sage: tails
{2: [1, 3, 2, 4], 1: [2, 3, 1, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}
sage: heads
{2: [2, 3, 1, 4], 1: [1, 3, 2, 4], 3: [2, 3, 1, 4], 4: [1, 3, 2, 4]}
```


Anyway i think your idea of printing each dict separately is better than having a `for` loop.


---

Comment by git created at 2018-08-29 12:55:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vklein created at 2018-08-29 12:57:12

Rebased on 8.4.beta2


---

Comment by git created at 2018-08-29 12:59:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2018-08-29 13:11:22

`b3f8dd2` doctest each dict separately with a `pprint` call

`@`embray Do you know a way to force sage to use pprint for dict `__repr__` ?

> just a plain dict is generally not a problem because its repr is already pprinted in ipython

Maybe it's ipython version dependent. I will check that.


---

Comment by embray created at 2018-08-29 13:13:33

Replying to [comment:19 vklein]:
> > just a plain dict is generally not a problem because its repr is already pprinted in ipython
> 
> Maybe it's ipython version dependent. I will check that.

I don't think that's it.  I think it may just be that the doctests don't pass through the IPython output formatting.  Perhaps they should.


---

Comment by vklein created at 2018-08-29 13:34:31

Yes.

Or the problem can be that ipython's lib.pretty is not consistent between py2 and py3 :

In py3

```
sage: from IPython.lib.pretty import pprint
sage: pprint(tails)
{2: [1, 3, 2, 4], 1: [2, 3, 1, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}
sage: from pprint import pprint
sage: pprint(tails)
{1: [2, 3, 1, 4], 2: [1, 3, 2, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}
```


In Py2


```
sage: from IPython.lib.pretty import pprint
sage: pprint(tails)
{1: [2, 3, 1, 4], 2: [1, 3, 2, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}
sage: from pprint import pprint
sage: pprint(tails)
{1: [2, 3, 1, 4], 2: [1, 3, 2, 4], 3: [1, 3, 2, 4], 4: [2, 3, 1, 4]}

```



---

Comment by chapoton created at 2018-08-29 18:35:46

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-08-29 18:35:46

ok, let it be. Merci !


---

Comment by vbraun created at 2018-08-30 22:24:34

Resolution: fixed


---

Comment by embray created at 2018-09-03 09:47:21

I don't really like this as is, but okay.

I didn't realize that IPython wasn't using the standard `pprint.pprint`.  If its `pprint` is broken on Python 3 we should fix that.
