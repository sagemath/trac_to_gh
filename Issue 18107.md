# Issue 18107: fix some case issues in sage-fix-pkg-checksums

Issue created by migration from https://trac.sagemath.org/ticket/18344

Original creator: jhpalmieri

Original creation time: 2015-04-30 18:32:28

The Sage developer's guide insists that the directories in `build/pkgs` should be all lowercase. At the same time, we have started allowing tarballs in `upstream` which have mixed case (e.g., Pillow and Sphinx). The script `sage-fix-pkg-checksums` should allow for this, converting the tarball name to lowercase before looking for the corresponding directory.



---

Comment by jhpalmieri created at 2015-04-30 18:34:20

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2015-04-30 18:34:20

Since we want to support OS X, we cannot allow different files whose names are the same except for case differences. So I hope this change is safe.
----
New commits:


---

Comment by leif created at 2015-05-01 23:59:09

While your patch apparently fixes the issue _with uppercase letters_ in upstream tarballs (haven't tested it yet though), I don't like the concept of the script, which is pretty upside-down:  Instead of iterating over `build/pkgs/*` and taking the name of the upstream tarball from there, it does the opposite.

I'd rather have

  `sage-pkg-checksums [--verbose] [--create|--check|--update] [<package name>]*`

with useful information about missing upstream tarballs, checksum mismatches etc., but that's presumably beyond this ticket.

(And we have a wild mixture of `tr`, `sed`, `shopt -s nocaseglob`, and shell parameter expansion in various shell scripts...  The Python script `sage-pkg` also seems to be obsolete or at least not yet suited for "new style" spkgs.)


---

Comment by leif created at 2015-05-02 00:52:00

Changing status from needs_review to positive_review.


---

Comment by leif created at 2015-05-02 01:02:25

P.S.:  How am I supposed to call that script btw.?  It relies on `SAGE_ROOT` being set, and doesn't even check whether that's the case.

`./sage -fix-pkg-checksums` doesn't work (and isn't documented), so one has to enter a Sage subshell or, as I did, for example run

```sh
SAGE_ROOT=. src/bin/sage-fix-pkg-checksums
```


`./sage --sh -c sage-fix-pkg-checksums` isn't less cryptic or tedious either.


---

Comment by leif created at 2015-05-02 01:19:18

... we could at least add

```sh
if [ -z "$SAGE_ROOT" ]; then
    if [ -d upstream ]; then # probably add further sanity checks
        SAGE_ROOT=`pwd`
    else
        echo >&2 "Error: SAGE_ROOT not set."
        exit 1
    fi
fi
```


Otherwise the script does nothing and exits without an error, even when we're in the Sage root directory but `SAGE_ROOT` isn't set (just because `[ -d /build/pkgs/... ]` usually yields `false`).


---

Comment by jhpalmieri created at 2015-05-02 02:33:33

Replying to [comment:5 leif]:
> P.S.:  How am I supposed to call that script btw.?  It relies on `SAGE_ROOT` being set, and doesn't even check whether that's the case.

The developer's guide says to do

```
$ sage -sh sage-fix-pkg-checksums
```

Anyway, feel free to open another ticket with general cleanup of the script.


---

Comment by vbraun created at 2015-05-02 14:22:31

Resolution: fixed


---

Comment by jdemeyer created at 2015-05-10 08:13:24

What's the point of this

```
 ** Note: case mismatch between upstream/Pillow-2.2.2.tar.gz and build/pkgs/pillow. **
```



---

Comment by leif created at 2015-05-10 12:53:38

Replying to [comment:9 jdemeyer]:
> What's the point of this
> {{{
>  ** Note: case mismatch between upstream/Pillow-2.2.2.tar.gz and build/pkgs/pillow. **
> }}}

It's a note.

(On partially case-insensitive filesystems, using uppercase letters in tarball names might be unintentional, I think.  It's not an error though, since we can deal with such.  But we IMHO shouldn't randomly change case upon upgrades.)


---

Comment by jhpalmieri created at 2015-05-10 15:22:40

One point behind the note is to somehow warn people that because of OS X, we can't have packages whose names depend on case. So at least this way they see that "Pillow.tar.gz" is associated with the directory "pillow". Maybe if someone tries to create a package "GAP", in addition to the "gap" package, rather than have things perhaps mysteriously break during building, a message like this will pop up earlier letting them know something is going on.


---

Comment by jdemeyer created at 2015-05-11 07:40:01

I don't really like notes which don't seem to have any meaning...

Is it a warning? Is there a problem? Should I avoid that?

Do you agree to remove that note in a follow-up ticket?


---

Comment by jdemeyer created at 2015-05-11 07:42:52

Replying to [comment:11 jhpalmieri]:
> Maybe if someone tries to create a package "GAP", in addition to the "gap" package, rather than have things perhaps mysteriously break during building, a message like this will pop up earlier letting them know something is going on.

Let me explain this one more time: `sage-fix-pkg-checksums` has *nothing* to do with building Sage. It's a development tool and only that.


---

Comment by jhpalmieri created at 2015-05-11 21:48:34

Replying to [comment:13 jdemeyer]:
> Replying to [comment:11 jhpalmieri]:
> > Maybe if someone tries to create a package "GAP", in addition to the "gap" package, rather than have things perhaps mysteriously break during building, a message like this will pop up earlier letting them know something is going on.
> 
> Let me explain this one more time: `sage-fix-pkg-checksums` has *nothing* to do with building Sage. It's a development tool and only that.

Do I need to explain that, presumably, someone developing a new package for Sage will try to build Sage with that package? That was the context for my comment: I want to provide some feedback when they are still developing the package (and therefore running `sage-fix-pkg-checksums`), before they even get to the building/testing stage. And there may be developers who never use OS X and are unaware of how it treats case.


---

Comment by jhpalmieri created at 2015-05-11 21:50:20

In any case, I don't care too much about the note, so if you want to remove it, go ahead.


---

Comment by jdemeyer created at 2015-05-12 07:37:07

Replying to [comment:14 jhpalmieri]:
> I want to provide some feedback when they are still developing the package (and therefore running `sage-fix-pkg-checksums`), before they even get to the building/testing stage. And there may be developers who never use OS X and are unaware of how it treats case.

OK, got it. But the current note is completely meaningless: I still don't understand what it really is trying to tell me...

Follow-up at #18402
