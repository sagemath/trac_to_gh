# Issue 25055: Upgrade to Cython 0.29

Issue created by migration from https://trac.sagemath.org/ticket/25292

Original creator: jdemeyer

Original creation time: 2018-05-04 15:12:23

CC:  fbissey embray saraedum

There is no Cython 0.29 yet, but consider this as a metaticket for Cython issues which would be fixed by that.

- #25284: Move some declarations from Sage to Cython
- #25288: Enable Cython caching again


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by git created at 2018-10-04 15:09:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-14 21:08:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-10-15 08:02:11

Changing status from new to needs_review.


---

Attachment

Running `make distclean && make cython` with `SAGE_CHECK=yes`, I'm reproducibly getting one test failing (see log).

(The two failing tests in #26450 don't seem to be an issue anymore in 0.29.)


---

Comment by git created at 2018-10-23 09:06:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-10-23 09:08:33

Replying to [comment:13 Konrad127123]:
> Running `make distclean && make cython` with `SAGE_CHECK=yes`, I'm reproducibly getting one test failing (see log).

Fixed by https://github.com/cython/cython/pull/2674


---

Comment by Konrad127123 created at 2018-10-23 12:28:00

Replying to [comment:16 jdemeyer]:
> Replying to [comment:13 Konrad127123]:
> > Running `make distclean && make cython` with `SAGE_CHECK=yes`, I'm reproducibly getting one test failing (see log).
> 
> Fixed by https://github.com/cython/cython/pull/2674

I can confirm that cython now builds with `SAGE_CHECK=yes`. I've not tested it apart from that.


---

Comment by jdemeyer created at 2018-10-29 22:11:02

Can somebody review this please? There are follow-up tickets depending on this one.


---

Comment by embray created at 2018-10-31 12:29:51

Does this mean Cython 0.29 will become a hard dependency of Sage?  I don't mind that ofc, but maybe the tickets that depend on it can be done in such a way that checks this (e.g., checks the Cython version before enabling those features).

I'm going to give this a quick check on Cygwin, but I doubt there will be any problem, so positive_review from me if it that works.


---

Comment by tscrim created at 2018-11-06 05:05:51

Erik, any updates? This works for me, and I am ready to set a positive review.


---

Comment by embray created at 2018-11-06 10:04:01

Works for me, AFAICT.  I think my previous question "Does this mean Cython 0.29 will become a hard dependency of Sage?" should be answered though.


---

Comment by saraedum created at 2018-11-06 12:31:52

I can only really talk about the cycache ticket. There we could of course only enable caching when we find that it actually works.

I guess the same could be done for the other ticket but I do not know enough about it.

Anyway, sure, let's keep that in mind!


---

Comment by jdemeyer created at 2018-11-06 12:50:49

Replying to [comment:23 embray]:
> Does this mean Cython 0.29 will become a hard dependency of Sage?

Yes. But I don't see why that should be a problem.


---

Comment by embray created at 2018-11-06 13:10:25

It's not necessarily a problem.  It just means that the Cython package on any system that packages Sage must also be updated to 0.29.  This would be a good thing to do anyways: it's just not obvious that it's so simple.  Sage tests Cython very well, but rebuilding every debian package that relies on Cython is an even bigger test.  I think it will probably go fine but we do need to make sure it gets done...


---

Comment by jdemeyer created at 2018-11-06 13:26:32

With only this ticket applied (not the follow-up tickets), it requires only minor adjustments to support both Cython 0.28 and Cython 0.29.

So what you are saying is maybe more an argument to postpone the follow-up tickets until we know for sure that Debian is ready for Cython 0.29.


---

Comment by embray created at 2018-11-08 15:32:40

Replying to [comment:27 jdemeyer]:
> With only this ticket applied (not the follow-up tickets), it requires only minor adjustments to support both Cython 0.28 and Cython 0.29.
> 
> So what you are saying is maybe more an argument to postpone the follow-up tickets until we know for sure that Debian is ready for Cython 0.29.

That might be wise, as annoying as it might be.  Hopefully it won't be long though.  Also I'm just using Debian as a general barometer.


---

Comment by @timokau created at 2018-11-26 21:34:36

For what its worth, [here is the status of cython on various distros](https://repology.org/metapackage/cython/versions) and [these are the distros that package sage](https://repology.org/metapackage/sagemath/versions). Debian Unstable hasn't upgraded yet. Arch and Nix have. Gentoo isn't listed for some reason.


---

Comment by fbissey created at 2018-11-26 21:36:31

Replying to [comment:29 gh-timokau]:
> For what its worth, [here is the status of cython on various distros](https://repology.org/metapackage/cython/versions) and [these are the distros that package sage](https://repology.org/metapackage/sagemath/versions). Debian Unstable hasn't upgraded yet. Arch and Nix have. Gentoo isn't listed for some reason.

Gentoo main tree, doesn't have it yet. But the sage-on-gentoo repo does have a package ready for when this ticket makes it regardless of the main tree.


---

Comment by Konrad127123 created at 2018-11-26 22:24:16

Note that Cython 0.29.1 has now been released.


---

Comment by fbissey created at 2018-11-26 23:00:12

Actually the Gentoo main tree caught up to me yesterday and 0.29.1 is in the main tree.


---

Comment by jdemeyer created at 2018-11-27 08:51:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-11-27 09:10:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-11-27 09:11:18

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-11-27 09:11:18

Not tested yet...


---

Comment by embray created at 2018-11-27 10:17:24

Replying to [comment:29 gh-timokau]:
> For what its worth, [here is the status of cython on various distros](https://repology.org/metapackage/cython/versions) and [these are the distros that package sage](https://repology.org/metapackage/sagemath/versions). Debian Unstable hasn't upgraded yet. Arch and Nix have. Gentoo isn't listed for some reason.

That's a cool site--I was not aware of it before.  It doesn't look like it tracks conda-forge or cygwin packages either.  I wonder how hard it would be to add trackers for new repositories to the site...


---

Comment by @timokau created at 2018-11-27 14:15:24

Replying to [comment:36 embray]:
> Replying to [comment:29 gh-timokau]:
> > For what its worth, [here is the status of cython on various distros](https://repology.org/metapackage/cython/versions) and [these are the distros that package sage](https://repology.org/metapackage/sagemath/versions). Debian Unstable hasn't upgraded yet. Arch and Nix have. Gentoo isn't listed for some reason.
> 
> That's a cool site--I was not aware of it before.  It doesn't look like it tracks conda-forge or cygwin packages either.  I wonder how hard it would be to add trackers for new repositories to the site...

Yeah its pretty neat. Nix uses a bot that automatically generates trivial package update PRs based on repology data. I think adding support for another repo would basically sonsist of (1) finding a relibale data source that gives current metadata about all packages and (2) converting that datasource into the format repology expects. There are already issues for [conda-forge](https://github.com/repology/repology/issues/518) and [cygwin](https://github.com/repology/repology/issues/269).


---

Comment by @timokau created at 2018-11-27 14:15:54

Replying to [comment:27 jdemeyer]:
> With only this ticket applied (not the follow-up tickets), it requires only minor adjustments to support both Cython 0.28 and Cython 0.29.
> 
> So what you are saying is maybe more an argument to postpone the follow-up tickets until we know for sure that Debian is ready for Cython 0.29.

Back to topic: So in its current state this ticket is not backwards compatible?


---

Comment by fbissey created at 2018-11-27 19:53:49

Replying to [comment:29 gh-timokau]:
> For what its worth, [here is the status of cython on various distros](https://repology.org/metapackage/cython/versions) and [these are the distros that package sage](https://repology.org/metapackage/sagemath/versions). Debian Unstable hasn't upgraded yet. Arch and Nix have. Gentoo isn't listed for some reason.

The curating is imperfect and for some distros it is listed under "cython" and for other under "python:cython" https://repology.org/metapackage/python:cython/versions not much you can do about that.


---

Comment by @timokau created at 2018-11-27 22:58:55

You can report it (I just did). Every time I've done that it has been resolved within a couple of hours.


---

Comment by jdemeyer created at 2018-11-28 11:27:52

Replying to [comment:38 gh-timokau]:
> Back to topic: So in its current state this ticket is not backwards compatible?

No, it is not. The difference is really small though, packagers that insist on Cython 0.28 can easily revert this patch.


---

Comment by @timokau created at 2018-11-28 11:34:09

Okay since the majority have already switched (all but debian I think) and its very possible that debian will have switched by the time 8.5 is released, I think we can go forward. Any other opinions?


---

Comment by embray created at 2018-11-29 09:35:28

Replying to [comment:41 jdemeyer]:
> Replying to [comment:38 gh-timokau]:
> > Back to topic: So in its current state this ticket is not backwards compatible?
> 
> No, it is not. The difference is really small though, packagers that insist on Cython 0.28 can easily revert this patch.

I think that's a bit presumptuous.  But I agree there's no reason for anyone to hold back up on updating Cython and that it should/will happen before long so I don't object to moving forward on this.


---

Comment by @timokau created at 2018-11-29 09:39:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-30 23:33:49

Resolution: fixed
