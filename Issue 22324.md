# Issue 22324: iterating over a Pari t_POL creates an infinite loop.

archive/issues_022324.json:
```json
{
    "body": "CC:  defeo vdelecroix\n\nKeywords: cypari2\n\nThe following reasonable and apparently innocuous code sends Sage into an infinite loop:\n\nsage: p = pari('x^2 + x + 1')\nsage: list(p)\n\nThe reason is that the gen object has no `__iter__` method, but it has a `__getitem__` method which accepts any integer index and returns 0 for indices larger than the degree of the polynomial.  Since there is no `__iter__` method, python builds an iterator using `__getitem__`.\n\nThere is a simple fix: `__getitem__` should raise an `IndexError` when the index is larger than the degree.  I also think it should raise an `IndexError` when the index is negative.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22561\n\n",
    "created_at": "2017-03-09T23:15:12Z",
    "labels": [
        "number fields",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "iterating over a Pari t_POL creates an infinite loop.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22324",
    "user": "culler"
}
```
CC:  defeo vdelecroix

Keywords: cypari2

The following reasonable and apparently innocuous code sends Sage into an infinite loop:

sage: p = pari('x^2 + x + 1')
sage: list(p)

The reason is that the gen object has no `__iter__` method, but it has a `__getitem__` method which accepts any integer index and returns 0 for indices larger than the degree of the polynomial.  Since there is no `__iter__` method, python builds an iterator using `__getitem__`.

There is a simple fix: `__getitem__` should raise an `IndexError` when the index is larger than the degree.  I also think it should raise an `IndexError` when the index is negative.

Issue created by migration from https://trac.sagemath.org/ticket/22561





---

archive/issue_comments_310305.json:
```json
{
    "body": "patch",
    "created_at": "2017-03-09T23:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310305",
    "user": "culler"
}
```

patch



---

archive/issue_comments_310306.json:
```json
{
    "body": "Changing component from number fields to interfaces.",
    "created_at": "2017-03-10T10:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310306",
    "user": "jdemeyer"
}
```

Changing component from number fields to interfaces.



---

archive/issue_comments_310307.json:
```json
{
    "body": "Attachment [gen_pyx.patch](tarball://root/attachments/some-uuid/ticket22561/gen_pyx.patch) by jdemeyer created at 2017-03-10 10:55:30\n\nI think it would be better to implement `__iter__` instead.",
    "created_at": "2017-03-10T10:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310307",
    "user": "jdemeyer"
}
```

Attachment [gen_pyx.patch](tarball://root/attachments/some-uuid/ticket22561/gen_pyx.patch) by jdemeyer created at 2017-03-10 10:55:30

I think it would be better to implement `__iter__` instead.



---

archive/issue_comments_310308.json:
```json
{
    "body": "What about `__len__`?",
    "created_at": "2017-03-10T10:59:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310308",
    "user": "vdelecroix"
}
```

What about `__len__`?



---

archive/issue_comments_310309.json:
```json
{
    "body": "`__len__` already exists.",
    "created_at": "2017-03-10T11:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310309",
    "user": "jdemeyer"
}
```

`__len__` already exists.



---

archive/issue_comments_310310.json:
```json
{
    "body": "There are various doctest failures in `src/sage/rings` involving Galois permutations. I don't have time to look at those right now, so if somebody else wants to continue, please do.\n----\nNew commits:",
    "created_at": "2017-03-10T13:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310310",
    "user": "jdemeyer"
}
```

There are various doctest failures in `src/sage/rings` involving Galois permutations. I don't have time to look at those right now, so if somebody else wants to continue, please do.
----
New commits:



---

archive/issue_comments_310311.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-11T21:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310311",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310312.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-11T21:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310312",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_310313.json:
```json
{
    "body": "Implementing `__iter__` was definitely the right thing to do, and this implementation works great for me, testing in `CyPari`.  Thanks!\n\nAlthough it is wonderful to have `__iter__`, I still think that `__getitem__` should raise an `IndexError` if one tries to access a t_POL coefficient with negative index, or index larger than the degree. This just makes sense, and also is consistent with how it works for power series.\n\nI ran into a minor compatibility issue (i.e. a Cython bug) with Python 3.5 on Ubuntu 16.04: `Cython 0.25.2` had trouble parsing the f\"...\" formatted strings passed to warn or `TypeError`.  The error looks like this:\n\n```\n            from warnings import warn\n            warn(f\"iterating a PARI {self.type()} is deprecated\", DeprecationWarning)\n                 ^\n------------------------------------------------------------\n\ncypari_src/gen.pyx:320:18: Expected ')', found 'BEGIN_STRING'\n```\n\nThis did not happen on macOS using Python 3.6.",
    "created_at": "2017-03-13T22:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310313",
    "user": "culler"
}
```

Implementing `__iter__` was definitely the right thing to do, and this implementation works great for me, testing in `CyPari`.  Thanks!

Although it is wonderful to have `__iter__`, I still think that `__getitem__` should raise an `IndexError` if one tries to access a t_POL coefficient with negative index, or index larger than the degree. This just makes sense, and also is consistent with how it works for power series.

I ran into a minor compatibility issue (i.e. a Cython bug) with Python 3.5 on Ubuntu 16.04: `Cython 0.25.2` had trouble parsing the f"..." formatted strings passed to warn or `TypeError`.  The error looks like this:

```
            from warnings import warn
            warn(f"iterating a PARI {self.type()} is deprecated", DeprecationWarning)
                 ^
------------------------------------------------------------

cypari_src/gen.pyx:320:18: Expected ')', found 'BEGIN_STRING'
```

This did not happen on macOS using Python 3.6.



---

archive/issue_comments_310314.json:
```json
{
    "body": "Replying to [comment:10 culler]:\n> Although it is wonderful to have `__iter__`, I still think that `__getitem__` should raise an `IndexError` if one tries to access a t_POL coefficient with negative index, or index larger than the degree. This just makes sense, and also is consistent with how it works for power series.\n\nFor the power series `1 + O(x^5)`, the `__getitem__` should only raise `IndexError` for indices greater or equal than `5`. It is not related to the actual degree of the underlying polynomial but the precision. One can think of a polynomial as `p + O(x^infinity)` and hence no `IndexError` looks the most appropriate to me.",
    "created_at": "2017-03-14T09:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310314",
    "user": "vdelecroix"
}
```

Replying to [comment:10 culler]:
> Although it is wonderful to have `__iter__`, I still think that `__getitem__` should raise an `IndexError` if one tries to access a t_POL coefficient with negative index, or index larger than the degree. This just makes sense, and also is consistent with how it works for power series.

For the power series `1 + O(x^5)`, the `__getitem__` should only raise `IndexError` for indices greater or equal than `5`. It is not related to the actual degree of the underlying polynomial but the precision. One can think of a polynomial as `p + O(x^infinity)` and hence no `IndexError` looks the most appropriate to me.



---

archive/issue_comments_310315.json:
```json
{
    "body": "Replying to [comment:10 culler]:\n> I ran into a minor compatibility issue (i.e. a Cython bug) with Python 3.5 on Ubuntu 16.04: `Cython 0.25.2` had trouble parsing the f\"...\" formatted strings\n\nSorry to ask, but can you please double-check that this was indeed using Cython 0.25.2 and not some earlier version? Support for `f`-strings was added only recently to Cython.",
    "created_at": "2017-03-14T09:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310315",
    "user": "jdemeyer"
}
```

Replying to [comment:10 culler]:
> I ran into a minor compatibility issue (i.e. a Cython bug) with Python 3.5 on Ubuntu 16.04: `Cython 0.25.2` had trouble parsing the f"..." formatted strings

Sorry to ask, but can you please double-check that this was indeed using Cython 0.25.2 and not some earlier version? Support for `f`-strings was added only recently to Cython.



---

archive/issue_comments_310316.json:
```json
{
    "body": "You are right, Jeroen.  Sorry!  My build system had cython 0.25.2 installed.  But Python 3 uses cython3, not cython, and cython3 was an older version.",
    "created_at": "2017-03-14T14:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310316",
    "user": "culler"
}
```

You are right, Jeroen.  Sorry!  My build system had cython 0.25.2 installed.  But Python 3 uses cython3, not cython, and cython3 was an older version.



---

archive/issue_comments_310317.json:
```json
{
    "body": "Vincent, I am having trouble following your logic.  Why should it be correct to ask for the coefficient of `x^-3` in a polynomial?  I agree that if a polynomial were a special case of a power series (with infinite precision) then it might make sense to pretend that there were coefficients of all positive degrees.  You might similarly argue that a polynomial is a special case of a Laurent polynomial, or Laurent series.  But we are talking about how to model these concepts as Python objects.  We expect Python subclasses to override methods of their parent class in a way which reflects how the structure of the subclass differs from that of the parent. So we should expect polynomials to override `__getitem__` and `__len__` in a way which reflects the differences between a polynomial and a power series or Laurent polynomial or Laurent series.\n\nCan you give an example of a Python container which allows `X[n]` for `n > len(X)`??",
    "created_at": "2017-03-14T14:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310317",
    "user": "culler"
}
```

Vincent, I am having trouble following your logic.  Why should it be correct to ask for the coefficient of `x^-3` in a polynomial?  I agree that if a polynomial were a special case of a power series (with infinite precision) then it might make sense to pretend that there were coefficients of all positive degrees.  You might similarly argue that a polynomial is a special case of a Laurent polynomial, or Laurent series.  But we are talking about how to model these concepts as Python objects.  We expect Python subclasses to override methods of their parent class in a way which reflects how the structure of the subclass differs from that of the parent. So we should expect polynomials to override `__getitem__` and `__len__` in a way which reflects the differences between a polynomial and a power series or Laurent polynomial or Laurent series.

Can you give an example of a Python container which allows `X[n]` for `n > len(X)`??



---

archive/issue_comments_310318.json:
```json
{
    "body": "Replying to [comment:14 culler]:\n> Can you give an example of a Python container which allows `X[n]` for `n > len(X)`??\n\nA polynomial is not a container.",
    "created_at": "2017-03-14T14:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310318",
    "user": "jdemeyer"
}
```

Replying to [comment:14 culler]:
> Can you give an example of a Python container which allows `X[n]` for `n > len(X)`??

A polynomial is not a container.



---

archive/issue_comments_310319.json:
```json
{
    "body": "IMHO, when you say len(p) or p[5] you are treating p as if it were a container for its coefficients.",
    "created_at": "2017-03-14T14:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310319",
    "user": "culler"
}
```

IMHO, when you say len(p) or p[5] you are treating p as if it were a container for its coefficients.



---

archive/issue_comments_310320.json:
```json
{
    "body": "Replying to [comment:14 culler]:\n> Can you give an example of a Python container which allows `X[n]` for `n > len(X)`??\n\nThe dictionary `{2: 'hello'}` :-P. More seriously, polynomials in GP behave that way\n\n```\n? p = x^3 + 2\n%1 = x^3 + 2\n? length(p)\n%2 = 4\n? polcoeff(p, 5) \n%3 = 0\n? polcoeff(p, -3)\n%4 = 0\n```\n",
    "created_at": "2017-03-14T14:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310320",
    "user": "vdelecroix"
}
```

Replying to [comment:14 culler]:
> Can you give an example of a Python container which allows `X[n]` for `n > len(X)`??

The dictionary `{2: 'hello'}` :-P. More seriously, polynomials in GP behave that way

```
? p = x^3 + 2
%1 = x^3 + 2
? length(p)
%2 = 4
? polcoeff(p, 5) 
%3 = 0
? polcoeff(p, -3)
%4 = 0
```




---

archive/issue_comments_310321.json:
```json
{
    "body": "On a related note, see that integers have numerators and denominators!\n\n```\nsage: 12.numerator()\n12\nsage: 12.denominator()\n1\n```\n\nIn a CAS, you certainly want some combatibility between embeddings of structures (like `ZZ c QQ` or `R[x] c R((X))`).",
    "created_at": "2017-03-14T14:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310321",
    "user": "vdelecroix"
}
```

On a related note, see that integers have numerators and denominators!

```
sage: 12.numerator()
12
sage: 12.denominator()
1
```

In a CAS, you certainly want some combatibility between embeddings of structures (like `ZZ c QQ` or `R[x] c R((X))`).



---

archive/issue_comments_310322.json:
```json
{
    "body": "True, GP does handle polynomial coefficients that way.  But the job of modeling GP belongs to the pari object, and its behavior would not be changed.\n\n\n```\nsage: p = pari('x^2 + x + 1')\nsage: p.polcoeff(25)\n0\n\n>>> from cypari import *\n>>> p = pari('x^2 + x + 1')\n>>> p.polcoeff(25)\n0\n```\n",
    "created_at": "2017-03-14T14:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310322",
    "user": "culler"
}
```

True, GP does handle polynomial coefficients that way.  But the job of modeling GP belongs to the pari object, and its behavior would not be changed.


```
sage: p = pari('x^2 + x + 1')
sage: p.polcoeff(25)
0

>>> from cypari import *
>>> p = pari('x^2 + x + 1')
>>> p.polcoeff(25)
0
```




---

archive/issue_comments_310323.json:
```json
{
    "body": "I guess the bottom line here is that Sage's polynomial ring handles polynomial coefficients that way:\n\n```\nsage: R.<x> = PolynomialRing(ZZ)\nsage: p = R(x^2 - 3*x + 2)\nsage: p[25]\n0\nsage: p[-2]\n0\n```\n\n\nTo me, that is a convincing argument for why pari polynomials should behave the same way. Components of Sage should certainly be consistent with Sage itself. So I will stop clogging up trac with discussions of this. :^)",
    "created_at": "2017-03-14T15:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310323",
    "user": "culler"
}
```

I guess the bottom line here is that Sage's polynomial ring handles polynomial coefficients that way:

```
sage: R.<x> = PolynomialRing(ZZ)
sage: p = R(x^2 - 3*x + 2)
sage: p[25]
0
sage: p[-2]
0
```


To me, that is a convincing argument for why pari polynomials should behave the same way. Components of Sage should certainly be consistent with Sage itself. So I will stop clogging up trac with discussions of this. :^)



---

archive/issue_comments_310324.json:
```json
{
    "body": "Seems to me there are no more objections to this ticket. Thanks everyone.",
    "created_at": "2017-03-14T19:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310324",
    "user": "defeo"
}
```

Seems to me there are no more objections to this ticket. Thanks everyone.



---

archive/issue_comments_310325.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-14T19:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310325",
    "user": "defeo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310326.json:
```json
{
    "body": "Changing keywords from \"cypari2\" to \"cypari2, days85\".",
    "created_at": "2017-03-14T19:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310326",
    "user": "defeo"
}
```

Changing keywords from "cypari2" to "cypari2, days85".



---

archive/issue_comments_310327.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22324",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22324#issuecomment-310327",
    "user": "vbraun"
}
```

Resolution: fixed
