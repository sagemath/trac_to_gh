# Issue 13375: test_executable security risk

archive/issues_013375.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  jdemeyer\n\n`test_executable` runs various executables in `/tmp`. Since Python has `.` in `sys.path`, it is trivial for any user to have code executed by the user running the doctests. For example:\n\n```\n[eviluser@hostname ~]$ echo 'print \"EVIL!!\"' > /tmp/socket.py\n...\n[vbraun@hostname ~]$ sage -t -force_lib devel/sage/sage/tests/cmdline.py\nsage -t -force_lib \"devel/sage/sage/tests/cmdline.py\"       \n**********************************************************************\nFile \"/home/vbraun/opt/sage-5.4.beta1/devel/sage/sage/tests/cmdline.py\", line 248:\n    sage: print out\nExpected:\n    1\nGot:\n    EVIL!!\n```\n\n`test_executable` should securely create a temp directory and run the executable in there.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13579\n\n",
    "created_at": "2012-10-07T15:32:57Z",
    "labels": [
        "doctest coverage",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.4",
    "title": "test_executable security risk",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13375",
    "user": "vbraun"
}
```
Assignee: mvngu

CC:  jdemeyer

`test_executable` runs various executables in `/tmp`. Since Python has `.` in `sys.path`, it is trivial for any user to have code executed by the user running the doctests. For example:

```
[eviluser@hostname ~]$ echo 'print "EVIL!!"' > /tmp/socket.py
...
[vbraun@hostname ~]$ sage -t -force_lib devel/sage/sage/tests/cmdline.py
sage -t -force_lib "devel/sage/sage/tests/cmdline.py"       
**********************************************************************
File "/home/vbraun/opt/sage-5.4.beta1/devel/sage/sage/tests/cmdline.py", line 248:
    sage: print out
Expected:
    1
Got:
    EVIL!!
```

`test_executable` should securely create a temp directory and run the executable in there.

Issue created by migration from https://trac.sagemath.org/ticket/13579





---

archive/issue_comments_164391.json:
```json
{
    "body": "Attachment [13579_secure_tmp.patch](tarball://root/attachments/some-uuid/ticket13579/13579_secure_tmp.patch) by vbraun created at 2012-10-08 09:33:52\n\nOops, looks like we did it at the same time.",
    "created_at": "2012-10-08T09:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164391",
    "user": "vbraun"
}
```

Attachment [13579_secure_tmp.patch](tarball://root/attachments/some-uuid/ticket13579/13579_secure_tmp.patch) by vbraun created at 2012-10-08 09:33:52

Oops, looks like we did it at the same time.



---

archive/issue_comments_164392.json:
```json
{
    "body": "I'm fine with your patch. All doctests pass with both patches applied.",
    "created_at": "2012-10-08T13:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164392",
    "user": "vbraun"
}
```

I'm fine with your patch. All doctests pass with both patches applied.



---

archive/issue_comments_164393.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-08T13:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164393",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_164394.json:
```json
{
    "body": "I'd say that the function `get_tmpdir()` is a bit overkill.\n\nWhy not simply put\n\n```\nsage: test_tmpdir = tmp_dir('cmdline_test_')\n```\n\ninside the doctest?",
    "created_at": "2012-10-08T13:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164394",
    "user": "jdemeyer"
}
```

I'd say that the function `get_tmpdir()` is a bit overkill.

Why not simply put

```
sage: test_tmpdir = tmp_dir('cmdline_test_')
```

inside the doctest?



---

archive/issue_comments_164395.json:
```json
{
    "body": "In the doctests there is also the case where you check that you can read from the current dir, so you need to create a file in the tmp dir and execute in the same dir. Hence its important that the name is cached in `sage.tests.cmdline`...",
    "created_at": "2012-10-08T13:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164395",
    "user": "vbraun"
}
```

In the doctests there is also the case where you check that you can read from the current dir, so you need to create a file in the tmp dir and execute in the same dir. Hence its important that the name is cached in `sage.tests.cmdline`...



---

archive/issue_comments_164396.json:
```json
{
    "body": "Replying to [comment:7 vbraun]:\n> execute in the same dir.\nI don't think we should supply an explicit working directory in `Popen()`.  I think the explicit `os.chdir()` statements in the doctest are clearer.\n\nThere are various other things which I'd like to change, so I'll prepare a reviewer patch.",
    "created_at": "2012-10-08T14:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164396",
    "user": "jdemeyer"
}
```

Replying to [comment:7 vbraun]:
> execute in the same dir.
I don't think we should supply an explicit working directory in `Popen()`.  I think the explicit `os.chdir()` statements in the doctest are clearer.

There are various other things which I'd like to change, so I'll prepare a reviewer patch.



---

archive/issue_comments_164397.json:
```json
{
    "body": "I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.",
    "created_at": "2012-10-08T14:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164397",
    "user": "vbraun"
}
```

I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.



---

archive/issue_comments_164398.json:
```json
{
    "body": "Replying to [comment:9 vbraun]:\n> I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.\nThe insecurity is not because of `test_executable`, but because of Python.  So such a check should be added in `spkg/bin/sage` before running `sage-run`.",
    "created_at": "2012-10-09T15:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164398",
    "user": "jdemeyer"
}
```

Replying to [comment:9 vbraun]:
> I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.
The insecurity is not because of `test_executable`, but because of Python.  So such a check should be added in `spkg/bin/sage` before running `sage-run`.



---

archive/issue_comments_164399.json:
```json
{
    "body": "Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. \n\nI'm in favor of removing cwd from `sys.path` in `sage-env` if it is not a subdirectory of the users home directory. Thats a pretty specific measure that keeps the convenience of easy importing while keeping use pretty safe. But that should be an additional security measure, and is definitely not the solution to the issue here.\n\n`test_executable` has to be implemented in a manner that its safety is not dependent on other scripts, or we will see the same issue crop up again at a later time.",
    "created_at": "2012-10-09T16:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164399",
    "user": "vbraun"
}
```

Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 

I'm in favor of removing cwd from `sys.path` in `sage-env` if it is not a subdirectory of the users home directory. Thats a pretty specific measure that keeps the convenience of easy importing while keeping use pretty safe. But that should be an additional security measure, and is definitely not the solution to the issue here.

`test_executable` has to be implemented in a manner that its safety is not dependent on other scripts, or we will see the same issue crop up again at a later time.



---

archive/issue_comments_164400.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. \nHow about checking that the script is owned by the same user as the directory it is contained in?  I think that would work pretty well.\n\n> But that should be an additional security measure, and is definitely not the solution to the issue here.\nI disagree.  I think `sage-run` is the real issue and that adding stuff to `test_executable` is simply a work-around.",
    "created_at": "2012-10-10T06:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164400",
    "user": "jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 
How about checking that the script is owned by the same user as the directory it is contained in?  I think that would work pretty well.

> But that should be an additional security measure, and is definitely not the solution to the issue here.
I disagree.  I think `sage-run` is the real issue and that adding stuff to `test_executable` is simply a work-around.



---

archive/issue_comments_164401.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:11 vbraun]:\n> > Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model.\nI think all systems on which Sage runs have at least the classic unix security model.  Additions like SELinux mostly affect system services, and normally have no impact on normal users.  As far as Python or Sage is concerned, I think we can still check the standard Unix permissions.",
    "created_at": "2012-10-10T10:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164401",
    "user": "jdemeyer"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 vbraun]:
> > Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model.
I think all systems on which Sage runs have at least the classic unix security model.  Additions like SELinux mostly affect system services, and normally have no impact on normal users.  As far as Python or Sage is concerned, I think we can still check the standard Unix permissions.



---

archive/issue_comments_164402.json:
```json
{
    "body": "Well `test_executable` doesn't just run Sage, it will run other programs as well. Which may or may not look at files relative to cwd, or may introduce such a misfeature in a future version. Or a user might just import the sage library into their own python interpreter. There is only one way to be absolutely safe, and that is by controlling the path explicitly. Hence the design of my patch.",
    "created_at": "2012-10-10T10:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164402",
    "user": "vbraun"
}
```

Well `test_executable` doesn't just run Sage, it will run other programs as well. Which may or may not look at files relative to cwd, or may introduce such a misfeature in a future version. Or a user might just import the sage library into their own python interpreter. There is only one way to be absolutely safe, and that is by controlling the path explicitly. Hence the design of my patch.



---

archive/issue_comments_164403.json:
```json
{
    "body": "I think this should be reported upstream to Python.  Volker, do you intend to do this or shall I?",
    "created_at": "2012-10-10T10:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164403",
    "user": "jdemeyer"
}
```

I think this should be reported upstream to Python.  Volker, do you intend to do this or shall I?



---

archive/issue_comments_164404.json:
```json
{
    "body": "CPython handles this already, cwd is not in the path if it is run non-interactively:\n\n```\n[vbraun@laptop ~]$ cat /tmp/test.py\n#!/usr/bin/env  python\nimport sys\nprint sys.path\n\n[vbraun@laptop ~]$ /tmp/test.py \n['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n\n[vbraun@laptop ~]$ python /tmp/test.py \n['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n\n[vbraun@laptop tmp]$ python\nPython 2.7.3 (default, Jul 24 2012, 10:05:38) \n[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> sys.path\n['', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]\n```\n\nCPython doesn't check for permissions of the script directory, though arguably you want the script directory in the path if you put the script there in the first place.",
    "created_at": "2012-10-10T10:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164404",
    "user": "vbraun"
}
```

CPython handles this already, cwd is not in the path if it is run non-interactively:

```
[vbraun@laptop ~]$ cat /tmp/test.py
#!/usr/bin/env  python
import sys
print sys.path

[vbraun@laptop ~]$ /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun@laptop ~]$ python /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun@laptop tmp]$ python
Python 2.7.3 (default, Jul 24 2012, 10:05:38) 
[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.path
['', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]
```

CPython doesn't check for permissions of the script directory, though arguably you want the script directory in the path if you put the script there in the first place.



---

archive/issue_comments_164405.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> CPython handles this already, cwd is not in the path if it is run non-interactively:\nThe script directory (`/tmp` in this case) is in `sys.path`.  That's the problem.",
    "created_at": "2012-10-10T11:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164405",
    "user": "jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> CPython handles this already, cwd is not in the path if it is run non-interactively:
The script directory (`/tmp` in this case) is in `sys.path`.  That's the problem.



---

archive/issue_comments_164406.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> arguably you want the script directory in the path if you put the script there in the first place.\nI think it is very unexpected (to me at least) that CPython suddenly reads other files in the directory where the script lives.  If I create a shell script in `/tmp`, it's not going to magically add `/tmp` to the `$PATH`.  That's fail-safe and that's how it should be.",
    "created_at": "2012-10-10T11:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164406",
    "user": "jdemeyer"
}
```

Replying to [comment:16 vbraun]:
> arguably you want the script directory in the path if you put the script there in the first place.
I think it is very unexpected (to me at least) that CPython suddenly reads other files in the directory where the script lives.  If I create a shell script in `/tmp`, it's not going to magically add `/tmp` to the `$PATH`.  That's fail-safe and that's how it should be.



---

archive/issue_comments_164407.json:
```json
{
    "body": "Python programs often consist of multiple files that need to be imported, whereas shell scripts don't. So you can't really compare the two cases.\n\nI'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it.",
    "created_at": "2012-10-10T12:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164407",
    "user": "vbraun"
}
```

Python programs often consist of multiple files that need to be imported, whereas shell scripts don't. So you can't really compare the two cases.

I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it.



---

archive/issue_comments_164408.json:
```json
{
    "body": "Replying to [comment:19 vbraun]:\n> I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it. \nI'm not sure whether upstream is really aware of the security consequences of their `sys.path` handling.\n\nMy proposal would not disable the \"script directory\" situation completely: I would add the script directory to `sys.path` **only if it is safe** to do so.  In normal situations (a script with 0755 permissions in a directory with 0755 permissions owned by the same user), I would keep the current `sys.path` handling.",
    "created_at": "2012-10-10T12:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164408",
    "user": "jdemeyer"
}
```

Replying to [comment:19 vbraun]:
> I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it. 
I'm not sure whether upstream is really aware of the security consequences of their `sys.path` handling.

My proposal would not disable the "script directory" situation completely: I would add the script directory to `sys.path` **only if it is safe** to do so.  In normal situations (a script with 0755 permissions in a directory with 0755 permissions owned by the same user), I would keep the current `sys.path` handling.



---

archive/issue_comments_164409.json:
```json
{
    "body": "I've added a patch to `sage-run` that matches the plain Python behavior, and will print a warning if the user is not the owner of the script directory.",
    "created_at": "2012-10-10T12:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164409",
    "user": "vbraun"
}
```

I've added a patch to `sage-run` that matches the plain Python behavior, and will print a warning if the user is not the owner of the script directory.



---

archive/issue_comments_164410.json:
```json
{
    "body": "I plan to add a patch to the Python spkg fixing the root cause of this issue.",
    "created_at": "2012-10-10T12:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164410",
    "user": "jdemeyer"
}
```

I plan to add a patch to the Python spkg fixing the root cause of this issue.



---

archive/issue_comments_164411.json:
```json
{
    "body": "The Python behaviour is explicitly specified here http://docs.python.org/library/sys.html#sys.path\n\nI also found the following Gentoo bug report that discusses exactly this issue: https://bugs.gentoo.org/show_bug.cgi?id=224925",
    "created_at": "2012-10-10T12:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164411",
    "user": "vbraun"
}
```

The Python behaviour is explicitly specified here http://docs.python.org/library/sys.html#sys.path

I also found the following Gentoo bug report that discusses exactly this issue: https://bugs.gentoo.org/show_bug.cgi?id=224925



---

archive/issue_comments_164412.json:
```json
{
    "body": "Updated patch",
    "created_at": "2012-10-10T12:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164412",
    "user": "vbraun"
}
```

Updated patch



---

archive/issue_comments_164413.json:
```json
{
    "body": "Attachment [trac_13579_fix_test_executable.patch](tarball://root/attachments/some-uuid/ticket13579/trac_13579_fix_test_executable.patch) by jason created at 2012-10-10 13:27:51\n\nThat new import function in the gentoo bug report seems reasonable.  In fact, we can also check all of the sys.path entries and make sure they start with SAGE_ROOT before running the test script.",
    "created_at": "2012-10-10T13:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164413",
    "user": "jason"
}
```

Attachment [trac_13579_fix_test_executable.patch](tarball://root/attachments/some-uuid/ticket13579/trac_13579_fix_test_executable.patch) by jason created at 2012-10-10 13:27:51

That new import function in the gentoo bug report seems reasonable.  In fact, we can also check all of the sys.path entries and make sure they start with SAGE_ROOT before running the test script.



---

archive/issue_comments_164414.json:
```json
{
    "body": "The patch in the gentoo bug report was rejected because it breaks the Python specified behavior. In fact, its possible that somebody's code relies on the Python specified behavior and will become a security threat if the script directory is not in `sys.path[0]`. I'd strongly advise against breaking the Python specs just because you don't like them.",
    "created_at": "2012-10-10T13:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164414",
    "user": "vbraun"
}
```

The patch in the gentoo bug report was rejected because it breaks the Python specified behavior. In fact, its possible that somebody's code relies on the Python specified behavior and will become a security threat if the script directory is not in `sys.path[0]`. I'd strongly advise against breaking the Python specs just because you don't like them.



---

archive/issue_comments_164415.json:
```json
{
    "body": "Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from `import foobar`?",
    "created_at": "2012-10-10T13:46:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164415",
    "user": "vbraun"
}
```

Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from `import foobar`?



---

archive/issue_comments_164416.json:
```json
{
    "body": "Replying to [comment:25 vbraun]:\n> The patch in the gentoo bug report was rejected because it breaks the Python specified behavior.\nAs I said, that's not what I what do.  I would check permissions/owners of the script and its directory and act on that.",
    "created_at": "2012-10-10T13:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164416",
    "user": "jdemeyer"
}
```

Replying to [comment:25 vbraun]:
> The patch in the gentoo bug report was rejected because it breaks the Python specified behavior.
As I said, that's not what I what do.  I would check permissions/owners of the script and its directory and act on that.



---

archive/issue_comments_164417.json:
```json
{
    "body": "Replying to [comment:26 vbraun]:\n> Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from import foobar?\nSure, but doing something like\n\n```\nimport sys\n```\n\nis very common in Python-land.  I don't think you can blame the user for doing that.",
    "created_at": "2012-10-10T14:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164417",
    "user": "jdemeyer"
}
```

Replying to [comment:26 vbraun]:
> Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from import foobar?
Sure, but doing something like

```
import sys
```

is very common in Python-land.  I don't think you can blame the user for doing that.



---

archive/issue_comments_164418.json:
```json
{
    "body": "Even putting the script directory *last* instead of first in `sys.path` would help a lot.",
    "created_at": "2012-10-10T14:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164418",
    "user": "jdemeyer"
}
```

Even putting the script directory *last* instead of first in `sys.path` would help a lot.



---

archive/issue_comments_164419.json:
```json
{
    "body": "Replying to [comment:25 vbraun]:\n> I'd strongly advise against breaking the Python specs just because you don't like them.\nThat's a very silly advise when the specs are inherently unsafe.  If the specs are bad, I don't mind breaking them.  Especially if my proposal would not change anything for most use cases.",
    "created_at": "2012-10-10T14:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164419",
    "user": "jdemeyer"
}
```

Replying to [comment:25 vbraun]:
> I'd strongly advise against breaking the Python specs just because you don't like them.
That's a very silly advise when the specs are inherently unsafe.  If the specs are bad, I don't mind breaking them.  Especially if my proposal would not change anything for most use cases.



---

archive/issue_comments_164420.json:
```json
{
    "body": "What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`). If you want to silently drop `sys.path[0]` then you are just teaching unsafe habits, and tears will be shed later when your student uses an unpatched Python...",
    "created_at": "2012-10-10T14:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164420",
    "user": "vbraun"
}
```

What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`). If you want to silently drop `sys.path[0]` then you are just teaching unsafe habits, and tears will be shed later when your student uses an unpatched Python...



---

archive/issue_comments_164421.json:
```json
{
    "body": "I was suggesting that for running tests, we could modify import.\n\nA separate suggestion is to modify import always, and insist that the user use relative imports when they really want to import something in the current directory.  That definitely breaks python behavior, but it is more explicit and secure.",
    "created_at": "2012-10-10T14:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164421",
    "user": "jason"
}
```

I was suggesting that for running tests, we could modify import.

A separate suggestion is to modify import always, and insist that the user use relative imports when they really want to import something in the current directory.  That definitely breaks python behavior, but it is more explicit and secure.



---

archive/issue_comments_164422.json:
```json
{
    "body": "Replying to [comment:31 vbraun]:\n> What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`).\n\nOK, so how about printing a warning and dropping `sys.path[0]`?",
    "created_at": "2012-10-10T14:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164422",
    "user": "jdemeyer"
}
```

Replying to [comment:31 vbraun]:
> What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`).

OK, so how about printing a warning and dropping `sys.path[0]`?



---

archive/issue_comments_164423.json:
```json
{
    "body": "Replying to [comment:33 jdemeyer]:\n> OK, so how about printing a warning and dropping `sys.path[0]`?\n\nWell if you desperately want it then knock yourself out, but I don't see any benefit over just printing a warning.\n\nThe reason for why Python acts the way it does is such that the admin can globally install Python programs. Which will generally be in a root-owned directory (just like /tmp but without `o+w`).",
    "created_at": "2012-10-10T19:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164423",
    "user": "vbraun"
}
```

Replying to [comment:33 jdemeyer]:
> OK, so how about printing a warning and dropping `sys.path[0]`?

Well if you desperately want it then knock yourself out, but I don't see any benefit over just printing a warning.

The reason for why Python acts the way it does is such that the admin can globally install Python programs. Which will generally be in a root-owned directory (just like /tmp but without `o+w`).



---

archive/issue_comments_164424.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-10-11T13:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164424",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_164425.json:
```json
{
    "body": "Do the write permissions on the directory actually say anything about security? Imagine the following:\n\n```\n$ su A\n$ mkdir /tmp/test\n$ chmod a+wrx /tmp/test\n$ mkdir /tmp/test/secure\n$ chmod go-w /tmp/test/secure\n$ cp python_test.py /tmp/test/secure\n$ /tmp/test/secure/python_test.py\n[...]\n```\n\nNow (from a different terminal):\n\n```\n$ su B\n$ mkdir /tmp/test/new\n$ cp -R /tmp/test/secure /tmp/test/new\n$ cp evil_sys.py /tmp/test/new/sys.py\n$ mv /tmp/test/secure /tmp/test/secure_bak; mv /tmp/test/new /tmp/test/secure\n```\n\nAny open files for the running `python_test.py` will remain, but any files that are newly looked up by (absolute) path name will be found in what used to be `/tmp/test/new`. In particular a late `import sys`.\n\nOf course, this is why there's a `t` flag on `/tmp`.\n\nIn any case, apparently python comes with a caution: Don't run scripts in directories writeable by people you don't trust, not even `t` flagged ones.\n\nWe're changing that caution to: Don't run scripts in directories that have components in their path that are writeable by people you don't trust, although `t` flagged is fine lower down. We'll warn you if the top level is writeable, since that is particularly easy to exploit.\n\nThe proposed change fixes the particular issue for Sage, but with the formulation above, I don't think there's any chance of this getting accepted upstream. It doesn't look like a real solution. It's just kicking the ball a little further (far enough for us).",
    "created_at": "2012-10-11T15:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164425",
    "user": "nbruin"
}
```

Do the write permissions on the directory actually say anything about security? Imagine the following:

```
$ su A
$ mkdir /tmp/test
$ chmod a+wrx /tmp/test
$ mkdir /tmp/test/secure
$ chmod go-w /tmp/test/secure
$ cp python_test.py /tmp/test/secure
$ /tmp/test/secure/python_test.py
[...]
```

Now (from a different terminal):

```
$ su B
$ mkdir /tmp/test/new
$ cp -R /tmp/test/secure /tmp/test/new
$ cp evil_sys.py /tmp/test/new/sys.py
$ mv /tmp/test/secure /tmp/test/secure_bak; mv /tmp/test/new /tmp/test/secure
```

Any open files for the running `python_test.py` will remain, but any files that are newly looked up by (absolute) path name will be found in what used to be `/tmp/test/new`. In particular a late `import sys`.

Of course, this is why there's a `t` flag on `/tmp`.

In any case, apparently python comes with a caution: Don't run scripts in directories writeable by people you don't trust, not even `t` flagged ones.

We're changing that caution to: Don't run scripts in directories that have components in their path that are writeable by people you don't trust, although `t` flagged is fine lower down. We'll warn you if the top level is writeable, since that is particularly easy to exploit.

The proposed change fixes the particular issue for Sage, but with the formulation above, I don't think there's any chance of this getting accepted upstream. It doesn't look like a real solution. It's just kicking the ball a little further (far enough for us).



---

archive/issue_comments_164426.json:
```json
{
    "body": "I think there is no way you can expect any degree of safety if you manually make a directory world-writeable and then execute things in there. You should be allowed to shoot your own foot if you desperately want to. In particular, even if Python would check every directory permission there is still a race before `chmod go-w /tmp/test/secure`.\n\nIt would still be good to get rid of some of the sharp edges in Python wrt. execution in /tmp; But Jeroen's current patch would e.g. prevent you from giving file ownership of a script directory to `nobody`. IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).",
    "created_at": "2012-10-11T16:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164426",
    "user": "vbraun"
}
```

I think there is no way you can expect any degree of safety if you manually make a directory world-writeable and then execute things in there. You should be allowed to shoot your own foot if you desperately want to. In particular, even if Python would check every directory permission there is still a race before `chmod go-w /tmp/test/secure`.

It would still be good to get rid of some of the sharp edges in Python wrt. execution in /tmp; But Jeroen's current patch would e.g. prevent you from giving file ownership of a script directory to `nobody`. IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).



---

archive/issue_comments_164427.json:
```json
{
    "body": "I agree with Volker.  Nils's issue isn't a Python issue.  It's an obvious consequence of creating subdirectories of a world-writable directory and Unix's permission system.  When you do stuff in (subdirectories of) a world-writable directory, you get what you deserve.  Similarly, Python cannot (and should not) protect a user from exectuting a script with `-rwxrwxrwx` permissions.",
    "created_at": "2012-10-11T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164427",
    "user": "jdemeyer"
}
```

I agree with Volker.  Nils's issue isn't a Python issue.  It's an obvious consequence of creating subdirectories of a world-writable directory and Unix's permission system.  When you do stuff in (subdirectories of) a world-writable directory, you get what you deserve.  Similarly, Python cannot (and should not) protect a user from exectuting a script with `-rwxrwxrwx` permissions.



---

archive/issue_comments_164428.json:
```json
{
    "body": "Replying to [comment:38 vbraun]:\n>  IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).\nEven that may be intentional. Many linux distributions by default make a separate group for each individual. On a machine where you trust every account, `o+w` would not necessarily indicate a security hole.\n\nThat being said, I think the proposed patch provides an acceptable workaround and I don't have any better ideas.",
    "created_at": "2012-10-11T18:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164428",
    "user": "nbruin"
}
```

Replying to [comment:38 vbraun]:
>  IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).
Even that may be intentional. Many linux distributions by default make a separate group for each individual. On a machine where you trust every account, `o+w` would not necessarily indicate a security hole.

That being said, I think the proposed patch provides an acceptable workaround and I don't have any better ideas.



---

archive/issue_comments_164429.json:
```json
{
    "body": "I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault. \n\nA case can be made for tests, but it seems it would be better to simple place test executables in a better place.",
    "created_at": "2012-10-11T19:25:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164429",
    "user": "robertwb"
}
```

I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault. 

A case can be made for tests, but it seems it would be better to simple place test executables in a better place.



---

archive/issue_comments_164430.json:
```json
{
    "body": "Replying to [comment:41 robertwb]:\n> A case can be made for tests, but it seems it would be better to simple place test executables in a better place. \n\n+1",
    "created_at": "2012-10-11T19:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164430",
    "user": "jason"
}
```

Replying to [comment:41 robertwb]:
> A case can be made for tests, but it seems it would be better to simple place test executables in a better place. 

+1



---

archive/issue_comments_164431.json:
```json
{
    "body": "Replying to [comment:41 robertwb]:\n> I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault.\nAs I already argued, I totally disagree with this.  If the spec is bad then the spec must be fixed.\n\nI'll report this upstream and see what happens...",
    "created_at": "2012-10-11T19:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164431",
    "user": "jdemeyer"
}
```

Replying to [comment:41 robertwb]:
> I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault.
As I already argued, I totally disagree with this.  If the spec is bad then the spec must be fixed.

I'll report this upstream and see what happens...



---

archive/issue_comments_164432.json:
```json
{
    "body": "I consider the Python spkg to be ready for review.",
    "created_at": "2012-10-12T08:06:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164432",
    "user": "jdemeyer"
}
```

I consider the Python spkg to be ready for review.



---

archive/issue_comments_164433.json:
```json
{
    "body": "Concerning the Sage library patch: why did you change `doc/common/builder.py`?",
    "created_at": "2012-10-12T08:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164433",
    "user": "jdemeyer"
}
```

Concerning the Sage library patch: why did you change `doc/common/builder.py`?



---

archive/issue_comments_164434.json:
```json
{
    "body": "Replying to [comment:47 jdemeyer]:\n> Concerning the Sage library patch: why did you change `doc/common/builder.py`?\n\nThe new `tmp_filename` and `tmp_dir` create a file/directory (the only safe way to deal with temporaries), but the doctest wanted a non-existing directory name. Needless to say, a function that returns a not-yet-existing filename is just a race condition in the making.",
    "created_at": "2012-10-12T09:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164434",
    "user": "vbraun"
}
```

Replying to [comment:47 jdemeyer]:
> Concerning the Sage library patch: why did you change `doc/common/builder.py`?

The new `tmp_filename` and `tmp_dir` create a file/directory (the only safe way to deal with temporaries), but the doctest wanted a non-existing directory name. Needless to say, a function that returns a not-yet-existing filename is just a race condition in the making.



---

archive/issue_comments_164435.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-12T13:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164435",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164436.json:
```json
{
    "body": "Case (B): (script dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)\n\nCase (C): (script dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.\n\nIn fact, if the dir is `go-w` and owned by a different UID, the script is very likely also owned by a different UID. The security risk really isn't in the imports in that case (if there is any at all)\n\nNone of these affect correct functioning of sage with the patch, since the required paths are explicitly added to sys.path, but it does illustrate that your detection heuristics are not very accurate.\n\nAs pointed out before, even `o+w` isn't necessarily a security risk, but since `/tmp` likely is, I'd find that an acceptable compromise. The other cases are harder to work around if they bite you. Really, the import behaviour only causes additional security risks on directories writeable by untrusted people *and the sticky bit set*. Otherwise, you can't trust the script you're running in the first place! Would it be possible to only do these checks in the presence of a sticky bit?",
    "created_at": "2012-10-12T16:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164436",
    "user": "nbruin"
}
```

Case (B): (script dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)

Case (C): (script dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.

In fact, if the dir is `go-w` and owned by a different UID, the script is very likely also owned by a different UID. The security risk really isn't in the imports in that case (if there is any at all)

None of these affect correct functioning of sage with the patch, since the required paths are explicitly added to sys.path, but it does illustrate that your detection heuristics are not very accurate.

As pointed out before, even `o+w` isn't necessarily a security risk, but since `/tmp` likely is, I'd find that an acceptable compromise. The other cases are harder to work around if they bite you. Really, the import behaviour only causes additional security risks on directories writeable by untrusted people *and the sticky bit set*. Otherwise, you can't trust the script you're running in the first place! Would it be possible to only do these checks in the presence of a sticky bit?



---

archive/issue_comments_164437.json:
```json
{
    "body": "Replying to [comment:51 nbruin]:\n> Case (B): (current dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)\nThen it's likely that *both* the Python script and the directory containing it are group-writable by the same group, which is allowed by my patch.\n\n> Case (C): (current dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.\nMy patch allows a directory owned by the same user as the Python executable.  In fact, I precisely had this scenario in mind, that's why I added this check.",
    "created_at": "2012-10-12T16:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164437",
    "user": "jdemeyer"
}
```

Replying to [comment:51 nbruin]:
> Case (B): (current dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)
Then it's likely that *both* the Python script and the directory containing it are group-writable by the same group, which is allowed by my patch.

> Case (C): (current dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.
My patch allows a directory owned by the same user as the Python executable.  In fact, I precisely had this scenario in mind, that's why I added this check.



---

archive/issue_comments_164438.json:
```json
{
    "body": "Replying to [comment:51 nbruin]:\n> Would it be possible to only do these checks in the presence of a sticky bit?\nI have no idea about the portability of \"sticky bit\" behaviour.  If you know for sure that every Unix system supports the sticky bit in the same way as Linux, that's fine for me.",
    "created_at": "2012-10-12T16:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164438",
    "user": "jdemeyer"
}
```

Replying to [comment:51 nbruin]:
> Would it be possible to only do these checks in the presence of a sticky bit?
I have no idea about the portability of "sticky bit" behaviour.  If you know for sure that every Unix system supports the sticky bit in the same way as Linux, that's fine for me.



---

archive/issue_comments_164439.json:
```json
{
    "body": "Attachment [13579_review.patch](tarball://root/attachments/some-uuid/ticket13579/13579_review.patch) by jdemeyer created at 2012-10-12 17:00:22",
    "created_at": "2012-10-12T17:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164439",
    "user": "jdemeyer"
}
```

Attachment [13579_review.patch](tarball://root/attachments/some-uuid/ticket13579/13579_review.patch) by jdemeyer created at 2012-10-12 17:00:22



---

archive/issue_comments_164440.json:
```json
{
    "body": "The \"sticky bit\" S_ISVTX is documented by POSIX, see [http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02](http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02).\n\nBased on this, I will change my patch.",
    "created_at": "2012-10-14T13:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164440",
    "user": "jdemeyer"
}
```

The "sticky bit" S_ISVTX is documented by POSIX, see [http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02](http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02).

Based on this, I will change my patch.



---

archive/issue_comments_164441.json:
```json
{
    "body": "New version, needs review.",
    "created_at": "2012-10-14T19:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164441",
    "user": "jdemeyer"
}
```

New version, needs review.



---

archive/issue_comments_164442.json:
```json
{
    "body": "First of all, the discussion on the Python bugtracker shows that this version of the patch is not going to be upstream. I would prefer a minimal patch that just adds a warning while keeping the old behavior that could be incorporated upstream. Having said that, I don't mind if we try out this patch in Sage until the next upstream release.\n* Error messages don't clearly state that this is a security risk. The \"not adding directory to sys.path since the write permissions are too loose\" implies that its OK to run scripts off `/tmp` and therefore implicitly encourages insecure behavior.\n* Since many packages (including some in the stdlib) re-add `cwd` if it is missing, the patch doesn't actually guarantee safe execution in `/tmp`.\n\nA short & sweet **Warning: It is not safe to run scripts in a world-writeable directory (including /tmp)** would be better ihmo.",
    "created_at": "2012-10-15T09:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164442",
    "user": "vbraun"
}
```

First of all, the discussion on the Python bugtracker shows that this version of the patch is not going to be upstream. I would prefer a minimal patch that just adds a warning while keeping the old behavior that could be incorporated upstream. Having said that, I don't mind if we try out this patch in Sage until the next upstream release.
* Error messages don't clearly state that this is a security risk. The "not adding directory to sys.path since the write permissions are too loose" implies that its OK to run scripts off `/tmp` and therefore implicitly encourages insecure behavior.
* Since many packages (including some in the stdlib) re-add `cwd` if it is missing, the patch doesn't actually guarantee safe execution in `/tmp`.

A short & sweet **Warning: It is not safe to run scripts in a world-writeable directory (including /tmp)** would be better ihmo.



---

archive/issue_comments_164443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-15T09:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164443",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164444.json:
```json
{
    "body": "I don't mind changing the warning message to something more severe.  Something like\n\n`RuntimeWarning: not adding directory '%s' to sys.path since the write permissions are too loose. Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory.`",
    "created_at": "2012-10-15T10:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164444",
    "user": "jdemeyer"
}
```

I don't mind changing the warning message to something more severe.  Something like

`RuntimeWarning: not adding directory '%s' to sys.path since the write permissions are too loose. Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory.`



---

archive/issue_comments_164445.json:
```json
{
    "body": "Attachment [sys_path_security.patch](tarball://root/attachments/some-uuid/ticket13579/sys_path_security.patch) by jdemeyer created at 2012-10-15 20:45:52\n\nPatch added to the Python sources",
    "created_at": "2012-10-15T20:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164445",
    "user": "jdemeyer"
}
```

Attachment [sys_path_security.patch](tarball://root/attachments/some-uuid/ticket13579/sys_path_security.patch) by jdemeyer created at 2012-10-15 20:45:52

Patch added to the Python sources



---

archive/issue_comments_164446.json:
```json
{
    "body": "I updated the spkg with the new longer warning message.\n\nVolker, just to be clear: can you confirm that your \"positive_review\" also covers [attachment:13579_review.patch]?",
    "created_at": "2012-10-15T20:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164446",
    "user": "jdemeyer"
}
```

I updated the spkg with the new longer warning message.

Volker, just to be clear: can you confirm that your "positive_review" also covers [attachment:13579_review.patch]?



---

archive/issue_comments_164447.json:
```json
{
    "body": "As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution. Why are you so desperate to teach bad habits and booby-trap it for future users? When I changed it in my patch, it was precisely to be free of this hidden assumption. And you undid that for no good reason.\n\nI agree that its safe the way the testsuite currently uses `test_executable`, so if you really want to ship it its at least better than before.",
    "created_at": "2012-10-15T21:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164447",
    "user": "vbraun"
}
```

As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution. Why are you so desperate to teach bad habits and booby-trap it for future users? When I changed it in my patch, it was precisely to be free of this hidden assumption. And you undid that for no good reason.

I agree that its safe the way the testsuite currently uses `test_executable`, so if you really want to ship it its at least better than before.



---

archive/issue_comments_164448.json:
```json
{
    "body": "Replying to [comment:59 vbraun]:\n> As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution.\nSerious question: why do you consider `test_executable()` as much more dangerous than other doctesting?  I.e. you seem to say that it's okay to run doctests in `/tmp` except for `test_executable()`.\n\nI think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.\n\nThe problem I have with your approach is that it unexpectedly changes directory.  In some cases, you might want to run a test from a given directory, but that's impossible with your patch.\n\nWould you accept a patch which checks in `test_executable()` (or maybe `sage-doctest`?) that the current directory is not world-writable and raises an exception if it is?",
    "created_at": "2012-10-16T06:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164448",
    "user": "jdemeyer"
}
```

Replying to [comment:59 vbraun]:
> As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution.
Serious question: why do you consider `test_executable()` as much more dangerous than other doctesting?  I.e. you seem to say that it's okay to run doctests in `/tmp` except for `test_executable()`.

I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

The problem I have with your approach is that it unexpectedly changes directory.  In some cases, you might want to run a test from a given directory, but that's impossible with your patch.

Would you accept a patch which checks in `test_executable()` (or maybe `sage-doctest`?) that the current directory is not world-writable and raises an exception if it is?



---

archive/issue_comments_164449.json:
```json
{
    "body": "Given what we learned in this ticket, I think **the only safe way to use `Popen` is by supplying a `cwd=` argument** with a directory that you set up (even if its just `SAGE_TMP`). Perhaps with the exception of posix standard binaries like `ls` or binaries that you wrote yourself. Its a simple pattern, easy to communicate and enforce, and will absolutely prevent this kind of problem. Basically, it forces the programmer to think about the choice of working directory.\n\nSure, you can make this whole issue more difficult to exploit by checking that the directory is not world-writable. But that does't plug the underlying issue. \n\nAlso, the Sage testsuite never ran a test in a specific directory. Its hard to imagine how that would be portable, to start with. But in the hypothetical case that one would need such a functionality, it could be added as an optional keyword parameter to `test_executable`.\n\nI don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`.",
    "created_at": "2012-10-16T12:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164449",
    "user": "vbraun"
}
```

Given what we learned in this ticket, I think **the only safe way to use `Popen` is by supplying a `cwd=` argument** with a directory that you set up (even if its just `SAGE_TMP`). Perhaps with the exception of posix standard binaries like `ls` or binaries that you wrote yourself. Its a simple pattern, easy to communicate and enforce, and will absolutely prevent this kind of problem. Basically, it forces the programmer to think about the choice of working directory.

Sure, you can make this whole issue more difficult to exploit by checking that the directory is not world-writable. But that does't plug the underlying issue. 

Also, the Sage testsuite never ran a test in a specific directory. Its hard to imagine how that would be portable, to start with. But in the hypothetical case that one would need such a functionality, it could be added as an optional keyword parameter to `test_executable`.

I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`.



---

archive/issue_comments_164450.json:
```json
{
    "body": "Replying to [comment:61 vbraun]:\n> I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`. \nI agree with this, so I think we should stop focusing on `test_executable()`.  I'm preparing a patch, stay tuned...",
    "created_at": "2012-10-16T14:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164450",
    "user": "jdemeyer"
}
```

Replying to [comment:61 vbraun]:
> I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`. 
I agree with this, so I think we should stop focusing on `test_executable()`.  I'm preparing a patch, stay tuned...



---

archive/issue_comments_164451.json:
```json
{
    "body": "Attachment [13579_scripts.patch](tarball://root/attachments/some-uuid/ticket13579/13579_scripts.patch) by jdemeyer created at 2012-10-17 07:11:18",
    "created_at": "2012-10-17T07:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164451",
    "user": "jdemeyer"
}
```

Attachment [13579_scripts.patch](tarball://root/attachments/some-uuid/ticket13579/13579_scripts.patch) by jdemeyer created at 2012-10-17 07:11:18



---

archive/issue_comments_164452.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-10-17T07:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164452",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_164453.json:
```json
{
    "body": "Attachment [13579_test_permissions.patch](tarball://root/attachments/some-uuid/ticket13579/13579_test_permissions.patch) by jdemeyer created at 2012-10-17 07:13:32",
    "created_at": "2012-10-17T07:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164453",
    "user": "jdemeyer"
}
```

Attachment [13579_test_permissions.patch](tarball://root/attachments/some-uuid/ticket13579/13579_test_permissions.patch) by jdemeyer created at 2012-10-17 07:13:32



---

archive/issue_comments_164454.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-17T07:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164454",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164455.json:
```json
{
    "body": "Volker, I added a patch for `sage-test` and `sage-ptest` (why are these 2 different files anyway?) such that they will refuse to run *any* doctests from an unsafe directory.  I think this makes much more sense than fixing \"only\" `test_executable()`.\n\nNeeds review",
    "created_at": "2012-10-17T07:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164455",
    "user": "jdemeyer"
}
```

Volker, I added a patch for `sage-test` and `sage-ptest` (why are these 2 different files anyway?) such that they will refuse to run *any* doctests from an unsafe directory.  I think this makes much more sense than fixing "only" `test_executable()`.

Needs review



---

archive/issue_comments_164456.json:
```json
{
    "body": "They're getting deleted by #12415.  Now I need to update 12415_script.patch again....\n\nI will make sure this behavior is incorporated into the #12415 framework.",
    "created_at": "2012-10-17T07:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164456",
    "user": "roed"
}
```

They're getting deleted by #12415.  Now I need to update 12415_script.patch again....

I will make sure this behavior is incorporated into the #12415 framework.



---

archive/issue_comments_164457.json:
```json
{
    "body": "What did you do to `13579_test_permissions.patch`?  I'm happy to sign off on the patch to the scripts repo.",
    "created_at": "2012-10-17T07:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164457",
    "user": "roed"
}
```

What did you do to `13579_test_permissions.patch`?  I'm happy to sign off on the patch to the scripts repo.



---

archive/issue_comments_164458.json:
```json
{
    "body": "Replying to [comment:67 roed]:\n> What did you do to `13579_test_permissions.patch`?\nWhat do you mean, I don't understand your question.",
    "created_at": "2012-10-17T11:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164458",
    "user": "jdemeyer"
}
```

Replying to [comment:67 roed]:
> What did you do to `13579_test_permissions.patch`?
What do you mean, I don't understand your question.



---

archive/issue_comments_164459.json:
```json
{
    "body": "The timestamp said that 13579_test_permissions.patch changed after you marked it as needs work the most recent time.  That's all.",
    "created_at": "2012-10-17T16:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164459",
    "user": "roed"
}
```

The timestamp said that 13579_test_permissions.patch changed after you marked it as needs work the most recent time.  That's all.



---

archive/issue_comments_164460.json:
```json
{
    "body": "I thought that file had existed before.  Anyway, it looks fine, so I'll give a positive review.",
    "created_at": "2012-10-17T16:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164460",
    "user": "roed"
}
```

I thought that file had existed before.  Anyway, it looks fine, so I'll give a positive review.



---

archive/issue_comments_164461.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-17T16:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164461",
    "user": "roed"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164462.json:
```json
{
    "body": "Volker, I hope you can be happy with these patches.  I know `test_executable()` isn't as secure as you wanted, but I think that problem is solved by doing the tests before allowing doctesting at all.",
    "created_at": "2012-10-17T20:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164462",
    "user": "jdemeyer"
}
```

Volker, I hope you can be happy with these patches.  I know `test_executable()` isn't as secure as you wanted, but I think that problem is solved by doing the tests before allowing doctesting at all.



---

archive/issue_comments_164463.json:
```json
{
    "body": "Attachment [13579_sagelib.patch](tarball://root/attachments/some-uuid/ticket13579/13579_sagelib.patch) by jdemeyer created at 2012-10-18 12:13:11\n\nAll Sage library patches folded",
    "created_at": "2012-10-18T12:13:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164463",
    "user": "jdemeyer"
}
```

Attachment [13579_sagelib.patch](tarball://root/attachments/some-uuid/ticket13579/13579_sagelib.patch) by jdemeyer created at 2012-10-18 12:13:11

All Sage library patches folded



---

archive/issue_comments_164464.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-10-18T19:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164464",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_164465.json:
```json
{
    "body": "Replying to [comment:60 jdemeyer]:\n\n> I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.\n\nI did this many times. (But of course I grew up with an idea that the worst thing that can happen to your program is that the stack of punchcards it is contained in is dropped on the floor and messed up :-))",
    "created_at": "2012-10-19T00:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164465",
    "user": "dimpase"
}
```

Replying to [comment:60 jdemeyer]:

> I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

I did this many times. (But of course I grew up with an idea that the worst thing that can happen to your program is that the stack of punchcards it is contained in is dropped on the floor and messed up :-))



---

archive/issue_comments_164466.json:
```json
{
    "body": "The patch breaks my patchbot, even though it is running in a safe directory. Details at #13631",
    "created_at": "2012-10-20T13:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164466",
    "user": "vbraun"
}
```

The patch breaks my patchbot, even though it is running in a safe directory. Details at #13631



---

archive/issue_comments_164467.json:
```json
{
    "body": "Yo, dudes, you missed a place for temp files.\n\n```\nfrom sage.misc.temporary_file import tmp_filename, tmp_dir\n```\n\nin animate.py wasn't enough - see [this ask.sagemath.org question](http://ask.sagemath.org/question/2065/module-object-has-no-attribute-graphics_filename).  I've opened #13807 for this.",
    "created_at": "2012-12-07T13:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164467",
    "user": "kcrisman"
}
```

Yo, dudes, you missed a place for temp files.

```
from sage.misc.temporary_file import tmp_filename, tmp_dir
```

in animate.py wasn't enough - see [this ask.sagemath.org question](http://ask.sagemath.org/question/2065/module-object-has-no-attribute-graphics_filename).  I've opened #13807 for this.



---

archive/issue_comments_164468.json:
```json
{
    "body": "Copy-pasted from sage-release:\n\n\n```\n$ env SAGE_TESTDIR=/tmp ./sage -t devel/sage/sage/tests/cmdline.py\nsage -t  \"devel/sage/sage/tests/cmdline.py\"\nsys:1: RuntimeWarning: not adding directory '/private/tmp' to sys.path since everybody can write to it.\nUntrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 312:\n    sage: ret\nExpected:\n    0\nGot:\n    128\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 314:\n    sage: out.find(\"All tests passed!\") >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 317:\n    sage: ret\nExpected:\n    0\nGot:\n    128\n**********************************************************************\nFile \"/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py\", line 319:\n    sage: out.find(\"All tests passed!\") >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 items had failures:\n   4 of 203 in __main__.example_1\n***Test Failed*** 4 failures.\nFor whitespace errors, see the file /tmp/cmdline_77447.py\n     [84.3 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n    sage -t  \"devel/sage/sage/tests/cmdline.py\"\nTotal time for all tests: 84.4 seconds\n\n\nSame with 'make testlong'; './sage -tp 1 ...' and 'make ptestlong' in contrast work.\n```\n",
    "created_at": "2013-01-12T17:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164468",
    "user": "leif"
}
```

Copy-pasted from sage-release:


```
$ env SAGE_TESTDIR=/tmp ./sage -t devel/sage/sage/tests/cmdline.py
sage -t  "devel/sage/sage/tests/cmdline.py"
sys:1: RuntimeWarning: not adding directory '/private/tmp' to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 312:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 314:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 317:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 319:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
   4 of 203 in __main__.example_1
***Test Failed*** 4 failures.
For whitespace errors, see the file /tmp/cmdline_77447.py
     [84.3 s]

----------------------------------------------------------------------
The following tests failed:


    sage -t  "devel/sage/sage/tests/cmdline.py"
Total time for all tests: 84.4 seconds


Same with 'make testlong'; './sage -tp 1 ...' and 'make ptestlong' in contrast work.
```




---

archive/issue_comments_164469.json:
```json
{
    "body": "As Volker explained, that's a feature, not a bug.",
    "created_at": "2013-01-12T18:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164469",
    "user": "jdemeyer"
}
```

As Volker explained, that's a feature, not a bug.



---

archive/issue_comments_164470.json:
```json
{
    "body": "Replying to [comment:79 jdemeyer]:\n> As Volker explained, that's a feature, not a bug.\n\nNope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).",
    "created_at": "2013-01-12T18:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164470",
    "user": "leif"
}
```

Replying to [comment:79 jdemeyer]:
> As Volker explained, that's a feature, not a bug.

Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).



---

archive/issue_comments_164471.json:
```json
{
    "body": "Replying to [comment:80 leif]:\n> Replying to [comment:79 jdemeyer]:\n> > As Volker explained, that's a feature, not a bug.\n> \n> Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).\n\n```\n...\n    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create\n    a file and preparse it::\n\n        sage: s = '\\\"\\\"\\\"\\nThis is a test file.\\n\\\"\\\"\\\"\\ndef my_add(a,b):\\n    \\\"\\\"\\\"\\n    Add a to b.\\n\\n        EXAMPLES::\\n\\n            sage: my_add(2,2)\\n            4\\n        \\\"\\\"\\\"\\n    return a+b\\n'\n        sage: script = os.path.join(tmp_dir(), 'my_script.sage')\n        sage: script_py = script[:-5] + '.py'\n        sage: F = open(script, 'w')\n        sage: F.write(s)\n        sage: F.close()\n        sage: (out, err, ret) = test_executable([\"sage\", \"--preparse\", script])\n        sage: ret\n        0\n        sage: os.path.isfile(script_py)\n        True\n\n    Now test my_script.sage and the preparsed version my_script.py::\n\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", script])\n        sage: ret\n        0\n        sage: out.find(\"All tests passed!\") >= 0\n        True\n        sage: (out, err, ret) = test_executable([\"sage\", \"-t\", script_py])\n        sage: ret\n        0\n        sage: out.find(\"All tests passed!\") >= 0\n        True\n...\n```\n\n\nThe latter four tests failed.",
    "created_at": "2013-01-12T18:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164471",
    "user": "leif"
}
```

Replying to [comment:80 leif]:
> Replying to [comment:79 jdemeyer]:
> > As Volker explained, that's a feature, not a bug.
> 
> Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).

```
...
    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create
    a file and preparse it::

        sage: s = '\"\"\"\nThis is a test file.\n\"\"\"\ndef my_add(a,b):\n    \"\"\"\n    Add a to b.\n\n        EXAMPLES::\n\n            sage: my_add(2,2)\n            4\n        \"\"\"\n    return a+b\n'
        sage: script = os.path.join(tmp_dir(), 'my_script.sage')
        sage: script_py = script[:-5] + '.py'
        sage: F = open(script, 'w')
        sage: F.write(s)
        sage: F.close()
        sage: (out, err, ret) = test_executable(["sage", "--preparse", script])
        sage: ret
        0
        sage: os.path.isfile(script_py)
        True

    Now test my_script.sage and the preparsed version my_script.py::

        sage: (out, err, ret) = test_executable(["sage", "-t", script])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
        sage: (out, err, ret) = test_executable(["sage", "-t", script_py])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
...
```


The latter four tests failed.



---

archive/issue_comments_164472.json:
```json
{
    "body": "You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.",
    "created_at": "2013-01-12T18:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164472",
    "user": "vbraun"
}
```

You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.



---

archive/issue_comments_164473.json:
```json
{
    "body": "Replying to [comment:82 vbraun]:\n> You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.\n\nThat's unrelated.  It's IMHO pretty ok to have `SAGE_TESTDIR=/tmp` (or whatever world-writable scratch directory; same for `SAGE_TMP`).\n\nThe test just shouldn't write the script into that directory, but instead into a \"safe\" subdir, just where all other doctest scripts end up.\n\nOrthogonal to the safety issue, the test could just fail because different test instances (in this case, on different machines, but sharing the test directory) use the same file at the same time.",
    "created_at": "2013-01-12T19:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164473",
    "user": "leif"
}
```

Replying to [comment:82 vbraun]:
> You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.

That's unrelated.  It's IMHO pretty ok to have `SAGE_TESTDIR=/tmp` (or whatever world-writable scratch directory; same for `SAGE_TMP`).

The test just shouldn't write the script into that directory, but instead into a "safe" subdir, just where all other doctest scripts end up.

Orthogonal to the safety issue, the test could just fail because different test instances (in this case, on different machines, but sharing the test directory) use the same file at the same time.



---

archive/issue_comments_164474.json:
```json
{
    "body": "Can we get rid of this patch during the Python 3 upgrade by using Python's isolated mode (`-I`)? There's an unanswered question about this at https://bugs.python.org/issue16202 btw.",
    "created_at": "2018-08-24T01:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164474",
    "user": "saraedum"
}
```

Can we get rid of this patch during the Python 3 upgrade by using Python's isolated mode (`-I`)? There's an unanswered question about this at https://bugs.python.org/issue16202 btw.



---

archive/issue_comments_164475.json:
```json
{
    "body": "There is a followup now at #26457.",
    "created_at": "2018-10-10T12:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13375#issuecomment-164475",
    "user": "saraedum"
}
```

There is a followup now at #26457.
