# Issue 13375: test_executable security risk

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2012-10-07 15:32:57

Assignee: mvngu

CC:  jdemeyer

`test_executable` runs various executables in `/tmp`. Since Python has `.` in `sys.path`, it is trivial for any user to have code executed by the user running the doctests. For example:

```
[eviluser`@`hostname ~]$ echo 'print "EVIL!!"' > /tmp/socket.py
...
[vbraun`@`hostname ~]$ sage -t -force_lib devel/sage/sage/tests/cmdline.py
sage -t -force_lib "devel/sage/sage/tests/cmdline.py"       
**********************************************************************
File "/home/vbraun/opt/sage-5.4.beta1/devel/sage/sage/tests/cmdline.py", line 248:
    sage: print out
Expected:
    1
Got:
    EVIL!!
```

`test_executable` should securely create a temp directory and run the executable in there.


---

Attachment

Oops, looks like we did it at the same time.


---

Comment by vbraun created at 2012-10-08 13:31:52

I'm fine with your patch. All doctests pass with both patches applied.


---

Comment by vbraun created at 2012-10-08 13:31:52

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-10-08 13:37:50

I'd say that the function `get_tmpdir()` is a bit overkill.

Why not simply put

```
sage: test_tmpdir = tmp_dir('cmdline_test_')
```

inside the doctest?


---

Comment by vbraun created at 2012-10-08 13:45:52

In the doctests there is also the case where you check that you can read from the current dir, so you need to create a file in the tmp dir and execute in the same dir. Hence its important that the name is cached in `sage.tests.cmdline`...


---

Comment by jdemeyer created at 2012-10-08 14:08:51

Replying to [comment:7 vbraun]:
> execute in the same dir.
I don't think we should supply an explicit working directory in `Popen()`.  I think the explicit `os.chdir()` statements in the doctest are clearer.

There are various other things which I'd like to change, so I'll prepare a reviewer patch.


---

Comment by vbraun created at 2012-10-08 14:25:01

I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.


---

Comment by jdemeyer created at 2012-10-09 15:03:39

Replying to [comment:9 vbraun]:
> I'm against including a function that is unsafe by default, thats just asking for trouble. `test_executable` either has to `chdir` to ensure that the user did not forget it, or refuse to run if `cwd` is writeable by anybody but the user.
The insecurity is not because of `test_executable`, but because of Python.  So such a check should be added in `spkg/bin/sage` before running `sage-run`.


---

Comment by vbraun created at 2012-10-09 16:43:16

Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 

I'm in favor of removing cwd from `sys.path` in `sage-env` if it is not a subdirectory of the users home directory. Thats a pretty specific measure that keeps the convenience of easy importing while keeping use pretty safe. But that should be an additional security measure, and is definitely not the solution to the issue here.

`test_executable` has to be implemented in a manner that its safety is not dependent on other scripts, or we will see the same issue crop up again at a later time.


---

Comment by jdemeyer created at 2012-10-10 06:42:38

Replying to [comment:11 vbraun]:
> Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model. 
How about checking that the script is owned by the same user as the directory it is contained in?  I think that would work pretty well.

> But that should be an additional security measure, and is definitely not the solution to the issue here.
I disagree.  I think `sage-run` is the real issue and that adding stuff to `test_executable` is simply a work-around.


---

Comment by jdemeyer created at 2012-10-10 10:11:07

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 vbraun]:
> > Its pretty difficult to reliably determine if others have write access to the directory. Your system might not use the traditional u/g/o security model but rely on one of the SELinux ACMs, or even a completely different security model.
I think all systems on which Sage runs have at least the classic unix security model.  Additions like SELinux mostly affect system services, and normally have no impact on normal users.  As far as Python or Sage is concerned, I think we can still check the standard Unix permissions.


---

Comment by vbraun created at 2012-10-10 10:14:33

Well `test_executable` doesn't just run Sage, it will run other programs as well. Which may or may not look at files relative to cwd, or may introduce such a misfeature in a future version. Or a user might just import the sage library into their own python interpreter. There is only one way to be absolutely safe, and that is by controlling the path explicitly. Hence the design of my patch.


---

Comment by jdemeyer created at 2012-10-10 10:16:52

I think this should be reported upstream to Python.  Volker, do you intend to do this or shall I?


---

Comment by vbraun created at 2012-10-10 10:59:27

CPython handles this already, cwd is not in the path if it is run non-interactively:

```
[vbraun`@`laptop ~]$ cat /tmp/test.py
#!/usr/bin/env  python
import sys
print sys.path

[vbraun`@`laptop ~]$ /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun`@`laptop ~]$ python /tmp/test.py 
['/tmp', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]

[vbraun`@`laptop tmp]$ python
Python 2.7.3 (default, Jul 24 2012, 10:05:38) 
[GCC 4.7.0 20120507 (Red Hat 4.7.0-5)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.path
['', '/usr/lib64/python27.zip', '/usr/lib64/python2.7', ...]
```

CPython doesn't check for permissions of the script directory, though arguably you want the script directory in the path if you put the script there in the first place.


---

Comment by jdemeyer created at 2012-10-10 11:26:34

Replying to [comment:16 vbraun]:
> CPython handles this already, cwd is not in the path if it is run non-interactively:
The script directory (`/tmp` in this case) is in `sys.path`.  That's the problem.


---

Comment by jdemeyer created at 2012-10-10 11:32:47

Replying to [comment:16 vbraun]:
> arguably you want the script directory in the path if you put the script there in the first place.
I think it is very unexpected (to me at least) that CPython suddenly reads other files in the directory where the script lives.  If I create a shell script in `/tmp`, it's not going to magically add `/tmp` to the `$PATH`.  That's fail-safe and that's how it should be.


---

Comment by vbraun created at 2012-10-10 12:08:17

Python programs often consist of multiple files that need to be imported, whereas shell scripts don't. So you can't really compare the two cases.

I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it.


---

Comment by jdemeyer created at 2012-10-10 12:18:07

Replying to [comment:19 vbraun]:
> I'm not saying that I'm entirely happy with how Python handles this, but it shows that upstream is aware of the issue and thats how they decided to deal with it. 
I'm not sure whether upstream is really aware of the security consequences of their `sys.path` handling.

My proposal would not disable the "script directory" situation completely: I would add the script directory to `sys.path` *only if it is safe* to do so.  In normal situations (a script with 0755 permissions in a directory with 0755 permissions owned by the same user), I would keep the current `sys.path` handling.


---

Comment by vbraun created at 2012-10-10 12:20:23

I've added a patch to `sage-run` that matches the plain Python behavior, and will print a warning if the user is not the owner of the script directory.


---

Comment by jdemeyer created at 2012-10-10 12:27:00

I plan to add a patch to the Python spkg fixing the root cause of this issue.


---

Comment by vbraun created at 2012-10-10 12:30:29

The Python behaviour is explicitly specified here http://docs.python.org/library/sys.html#sys.path

I also found the following Gentoo bug report that discusses exactly this issue: https://bugs.gentoo.org/show_bug.cgi?id=224925


---

Comment by vbraun created at 2012-10-10 12:34:08

Updated patch


---

Attachment

That new import function in the gentoo bug report seems reasonable.  In fact, we can also check all of the sys.path entries and make sure they start with SAGE_ROOT before running the test script.


---

Comment by vbraun created at 2012-10-10 13:40:35

The patch in the gentoo bug report was rejected because it breaks the Python specified behavior. In fact, its possible that somebody's code relies on the Python specified behavior and will become a security threat if the script directory is not in `sys.path[0]`. I'd strongly advise against breaking the Python specs just because you don't like them.


---

Comment by vbraun created at 2012-10-10 13:46:58

Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from `import foobar`?


---

Comment by jdemeyer created at 2012-10-10 13:58:45

Replying to [comment:25 vbraun]:
> The patch in the gentoo bug report was rejected because it breaks the Python specified behavior.
As I said, that's not what I what do.  I would check permissions/owners of the script and its directory and act on that.


---

Comment by jdemeyer created at 2012-10-10 14:01:14

Replying to [comment:26 vbraun]:
> Also, if you had a shell script in `/tmp` then you wouldn't put `source foobar` into it. But if its a Python script then somehow the Python fairy is supposed to save you from import foobar?
Sure, but doing something like

```
import sys
```

is very common in Python-land.  I don't think you can blame the user for doing that.


---

Comment by jdemeyer created at 2012-10-10 14:01:47

Even putting the script directory _last_ instead of first in `sys.path` would help a lot.


---

Comment by jdemeyer created at 2012-10-10 14:03:23

Replying to [comment:25 vbraun]:
> I'd strongly advise against breaking the Python specs just because you don't like them.
That's a very silly advise when the specs are inherently unsafe.  If the specs are bad, I don't mind breaking them.  Especially if my proposal would not change anything for most use cases.


---

Comment by vbraun created at 2012-10-10 14:13:39

What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`). If you want to silently drop `sys.path[0]` then you are just teaching unsafe habits, and tears will be shed later when your student uses an unpatched Python...


---

Comment by jason created at 2012-10-10 14:21:03

I was suggesting that for running tests, we could modify import.

A separate suggestion is to modify import always, and insist that the user use relative imports when they really want to import something in the current directory.  That definitely breaks python behavior, but it is more explicit and secure.


---

Comment by jdemeyer created at 2012-10-10 14:50:56

Replying to [comment:31 vbraun]:
> What is your proposal? IMHO its ok to refuse to run or to print a warning (as in my patch to `sage-run`).

OK, so how about printing a warning and dropping `sys.path[0]`?


---

Comment by vbraun created at 2012-10-10 19:21:03

Replying to [comment:33 jdemeyer]:
> OK, so how about printing a warning and dropping `sys.path[0]`?

Well if you desperately want it then knock yourself out, but I don't see any benefit over just printing a warning.

The reason for why Python acts the way it does is such that the admin can globally install Python programs. Which will generally be in a root-owned directory (just like /tmp but without `o+w`).


---

Comment by jdemeyer created at 2012-10-11 13:41:48

Changing status from needs_review to needs_work.


---

Comment by nbruin created at 2012-10-11 15:47:45

Do the write permissions on the directory actually say anything about security? Imagine the following:

```
$ su A
$ mkdir /tmp/test
$ chmod a+wrx /tmp/test
$ mkdir /tmp/test/secure
$ chmod go-w /tmp/test/secure
$ cp python_test.py /tmp/test/secure
$ /tmp/test/secure/python_test.py
[...]
```

Now (from a different terminal):

```
$ su B
$ mkdir /tmp/test/new
$ cp -R /tmp/test/secure /tmp/test/new
$ cp evil_sys.py /tmp/test/new/sys.py
$ mv /tmp/test/secure /tmp/test/secure_bak; mv /tmp/test/new /tmp/test/secure
```

Any open files for the running `python_test.py` will remain, but any files that are newly looked up by (absolute) path name will be found in what used to be `/tmp/test/new`. In particular a late `import sys`.

Of course, this is why there's a `t` flag on `/tmp`.

In any case, apparently python comes with a caution: Don't run scripts in directories writeable by people you don't trust, not even `t` flagged ones.

We're changing that caution to: Don't run scripts in directories that have components in their path that are writeable by people you don't trust, although `t` flagged is fine lower down. We'll warn you if the top level is writeable, since that is particularly easy to exploit.

The proposed change fixes the particular issue for Sage, but with the formulation above, I don't think there's any chance of this getting accepted upstream. It doesn't look like a real solution. It's just kicking the ball a little further (far enough for us).


---

Comment by vbraun created at 2012-10-11 16:33:10

I think there is no way you can expect any degree of safety if you manually make a directory world-writeable and then execute things in there. You should be allowed to shoot your own foot if you desperately want to. In particular, even if Python would check every directory permission there is still a race before `chmod go-w /tmp/test/secure`.

It would still be good to get rid of some of the sharp edges in Python wrt. execution in /tmp; But Jeroen's current patch would e.g. prevent you from giving file ownership of a script directory to `nobody`. IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).


---

Comment by jdemeyer created at 2012-10-11 16:36:04

I agree with Volker.  Nils's issue isn't a Python issue.  It's an obvious consequence of creating subdirectories of a world-writable directory and Unix's permission system.  When you do stuff in (subdirectories of) a world-writable directory, you get what you deserve.  Similarly, Python cannot (and should not) protect a user from exectuting a script with `-rwxrwxrwx` permissions.


---

Comment by nbruin created at 2012-10-11 18:49:09

Replying to [comment:38 vbraun]:
>  IMHO it would be enough to check that parent dir is not o+w, anything else might actually be intentional (e.g. you might have set up a special group so you can collaborate on a Python program).
Even that may be intentional. Many linux distributions by default make a separate group for each individual. On a machine where you trust every account, `o+w` would not necessarily indicate a security hole.

That being said, I think the proposed patch provides an acceptable workaround and I don't have any better ideas.


---

Comment by robertwb created at 2012-10-11 19:25:36

I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault. 

A case can be made for tests, but it seems it would be better to simple place test executables in a better place.


---

Comment by jason created at 2012-10-11 19:29:32

Replying to [comment:41 robertwb]:
> A case can be made for tests, but it seems it would be better to simple place test executables in a better place. 

+1


---

Comment by jdemeyer created at 2012-10-11 19:31:19

Replying to [comment:41 robertwb]:
> I agree with Volker, we shouldn't be modifying the default behavior for Python imports to break their spec. A Python program implicitly includes all sibling .py files. If you place a file in a world- (or group-) writable location and then execute it, that's your fault.
As I already argued, I totally disagree with this.  If the spec is bad then the spec must be fixed.

I'll report this upstream and see what happens...


---

Comment by jdemeyer created at 2012-10-12 08:06:15

I consider the Python spkg to be ready for review.


---

Comment by jdemeyer created at 2012-10-12 08:06:39

Concerning the Sage library patch: why did you change `doc/common/builder.py`?


---

Comment by vbraun created at 2012-10-12 09:25:21

Replying to [comment:47 jdemeyer]:
> Concerning the Sage library patch: why did you change `doc/common/builder.py`?

The new `tmp_filename` and `tmp_dir` create a file/directory (the only safe way to deal with temporaries), but the doctest wanted a non-existing directory name. Needless to say, a function that returns a not-yet-existing filename is just a race condition in the making.


---

Comment by jdemeyer created at 2012-10-12 13:38:35

Changing status from needs_work to needs_review.


---

Comment by nbruin created at 2012-10-12 16:08:23

Case (B): (script dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)

Case (C): (script dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.

In fact, if the dir is `go-w` and owned by a different UID, the script is very likely also owned by a different UID. The security risk really isn't in the imports in that case (if there is any at all)

None of these affect correct functioning of sage with the patch, since the required paths are explicitly added to sys.path, but it does illustrate that your detection heuristics are not very accurate.

As pointed out before, even `o+w` isn't necessarily a security risk, but since `/tmp` likely is, I'd find that an acceptable compromise. The other cases are harder to work around if they bite you. Really, the import behaviour only causes additional security risks on directories writeable by untrusted people _and the sticky bit set_. Otherwise, you can't trust the script you're running in the first place! Would it be possible to only do these checks in the presence of a sticky bit?


---

Comment by jdemeyer created at 2012-10-12 16:49:34

Replying to [comment:51 nbruin]:
> Case (B): (current dir group writeable) - It's perfectly safe to make directories group writeable, provided the group is sufficiently restricted. In fact, it's a very conceivable setup if you have multiple administrators that you want to give a lot of latitude, short of root (e.g., because your filesystem is NFS with root-squash)
Then it's likely that _both_ the Python script and the directory containing it are group-writable by the same group, which is allowed by my patch.

> Case (C): (current dir only user writable but by different UID): That's how I install packages like sage! Because they need frequent updates, they're not owned by root but by a dedicated maintenance account.
My patch allows a directory owned by the same user as the Python executable.  In fact, I precisely had this scenario in mind, that's why I added this check.


---

Comment by jdemeyer created at 2012-10-12 16:56:39

Replying to [comment:51 nbruin]:
> Would it be possible to only do these checks in the presence of a sticky bit?
I have no idea about the portability of "sticky bit" behaviour.  If you know for sure that every Unix system supports the sticky bit in the same way as Linux, that's fine for me.


---

Attachment


---

Comment by jdemeyer created at 2012-10-14 13:11:13

The "sticky bit" S_ISVTX is documented by POSIX, see [http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02](http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_02).

Based on this, I will change my patch.


---

Comment by jdemeyer created at 2012-10-14 19:11:05

New version, needs review.


---

Comment by vbraun created at 2012-10-15 09:49:42

First of all, the discussion on the Python bugtracker shows that this version of the patch is not going to be upstream. I would prefer a minimal patch that just adds a warning while keeping the old behavior that could be incorporated upstream. Having said that, I don't mind if we try out this patch in Sage until the next upstream release.
  * Error messages don't clearly state that this is a security risk. The "not adding directory to sys.path since the write permissions are too loose" implies that its OK to run scripts off `/tmp` and therefore implicitly encourages insecure behavior.
  * Since many packages (including some in the stdlib) re-add `cwd` if it is missing, the patch doesn't actually guarantee safe execution in `/tmp`.

A short & sweet **Warning: It is not safe to run scripts in a world-writeable directory (including /tmp)** would be better ihmo.


---

Comment by vbraun created at 2012-10-15 09:49:42

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-10-15 10:34:12

I don't mind changing the warning message to something more severe.  Something like

`RuntimeWarning: not adding directory '%s' to sys.path since the write permissions are too loose. Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory.`


---

Attachment

Patch added to the Python sources


---

Comment by jdemeyer created at 2012-10-15 20:47:14

I updated the spkg with the new longer warning message.

Volker, just to be clear: can you confirm that your "positive_review" also covers [attachment:13579_review.patch]?


---

Comment by vbraun created at 2012-10-15 21:34:53

As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution. Why are you so desperate to teach bad habits and booby-trap it for future users? When I changed it in my patch, it was precisely to be free of this hidden assumption. And you undid that for no good reason.

I agree that its safe the way the testsuite currently uses `test_executable`, so if you really want to ship it its at least better than before.


---

Comment by jdemeyer created at 2012-10-16 06:39:26

Replying to [comment:59 vbraun]:
> As I've explained before, its a terrible idea to have `test_executable` rely on the hidden premise that somebody chdir'ed to a safe directory before execution.
Serious question: why do you consider `test_executable()` as much more dangerous than other doctesting?  I.e. you seem to say that it's okay to run doctests in `/tmp` except for `test_executable()`.

I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

The problem I have with your approach is that it unexpectedly changes directory.  In some cases, you might want to run a test from a given directory, but that's impossible with your patch.

Would you accept a patch which checks in `test_executable()` (or maybe `sage-doctest`?) that the current directory is not world-writable and raises an exception if it is?


---

Comment by vbraun created at 2012-10-16 12:02:06

Given what we learned in this ticket, I think **the only safe way to use `Popen` is by supplying a `cwd=` argument** with a directory that you set up (even if its just `SAGE_TMP`). Perhaps with the exception of posix standard binaries like `ls` or binaries that you wrote yourself. Its a simple pattern, easy to communicate and enforce, and will absolutely prevent this kind of problem. Basically, it forces the programmer to think about the choice of working directory.

Sure, you can make this whole issue more difficult to exploit by checking that the directory is not world-writable. But that does't plug the underlying issue. 

Also, the Sage testsuite never ran a test in a specific directory. Its hard to imagine how that would be portable, to start with. But in the hypothetical case that one would need such a functionality, it could be added as an optional keyword parameter to `test_executable`.

I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`.


---

Comment by jdemeyer created at 2012-10-16 14:54:09

Replying to [comment:61 vbraun]:
> I don't think that `test_executable` is the only dangerous function. In fact I'm pretty sure that there are other nuggets hidden if you manage to trick somebody into executing Sage in `/tmp`. 
I agree with this, so I think we should stop focusing on `test_executable()`.  I'm preparing a patch, stay tuned...


---

Attachment


---

Comment by jdemeyer created at 2012-10-17 07:13:32

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2012-10-17 07:13:44

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-10-17 07:15:29

Volker, I added a patch for `sage-test` and `sage-ptest` (why are these 2 different files anyway?) such that they will refuse to run _any_ doctests from an unsafe directory.  I think this makes much more sense than fixing "only" `test_executable()`.

Needs review


---

Comment by roed created at 2012-10-17 07:32:01

They're getting deleted by #12415.  Now I need to update 12415_script.patch again....

I will make sure this behavior is incorporated into the #12415 framework.


---

Comment by roed created at 2012-10-17 07:40:21

What did you do to `13579_test_permissions.patch`?  I'm happy to sign off on the patch to the scripts repo.


---

Comment by jdemeyer created at 2012-10-17 11:32:02

Replying to [comment:67 roed]:
> What did you do to `13579_test_permissions.patch`?
What do you mean, I don't understand your question.


---

Comment by roed created at 2012-10-17 16:31:59

The timestamp said that 13579_test_permissions.patch changed after you marked it as needs work the most recent time.  That's all.


---

Comment by roed created at 2012-10-17 16:33:56

I thought that file had existed before.  Anyway, it looks fine, so I'll give a positive review.


---

Comment by roed created at 2012-10-17 16:33:56

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-10-17 20:50:06

Volker, I hope you can be happy with these patches.  I know `test_executable()` isn't as secure as you wanted, but I think that problem is solved by doing the tests before allowing doctesting at all.


---

Attachment

All Sage library patches folded


---

Comment by jdemeyer created at 2012-10-18 19:09:41

Resolution: fixed


---

Comment by dimpase created at 2012-10-19 00:24:59

Replying to [comment:60 jdemeyer]:

> I think it's quite unlikely that somebody would doctest the Sage library from `/tmp`.

I did this many times. (But of course I grew up with an idea that the worst thing that can happen to your program is that the stack of punchcards it is contained in is dropped on the floor and messed up :-))


---

Comment by vbraun created at 2012-10-20 13:52:02

The patch breaks my patchbot, even though it is running in a safe directory. Details at #13631


---

Comment by kcrisman created at 2012-12-07 13:22:10

Yo, dudes, you missed a place for temp files.

```
from sage.misc.temporary_file import tmp_filename, tmp_dir
```

in animate.py wasn't enough - see [this ask.sagemath.org question](http://ask.sagemath.org/question/2065/module-object-has-no-attribute-graphics_filename).  I've opened #13807 for this.


---

Comment by leif created at 2013-01-12 17:40:45

Copy-pasted from sage-release:


```
$ env SAGE_TESTDIR=/tmp ./sage -t devel/sage/sage/tests/cmdline.py
sage -t  "devel/sage/sage/tests/cmdline.py"
sys:1: RuntimeWarning: not adding directory '/private/tmp' to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 312:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 314:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 317:
    sage: ret
Expected:
    0
Got:
    128
**********************************************************************
File "/Users/leif/Sage/sage-5.6.beta3-vanilla/devel/sage/sage/tests/cmdline.py", line 319:
    sage: out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
   4 of 203 in __main__.example_1
***Test Failed*** 4 failures.
For whitespace errors, see the file /tmp/cmdline_77447.py
     [84.3 s]

----------------------------------------------------------------------
The following tests failed:


    sage -t  "devel/sage/sage/tests/cmdline.py"
Total time for all tests: 84.4 seconds


Same with 'make testlong'; './sage -tp 1 ...' and 'make ptestlong' in contrast work.
```



---

Comment by jdemeyer created at 2013-01-12 18:12:57

As Volker explained, that's a feature, not a bug.


---

Comment by leif created at 2013-01-12 18:19:29

Replying to [comment:79 jdemeyer]:
> As Volker explained, that's a feature, not a bug.

Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).


---

Comment by leif created at 2013-01-12 18:25:00

Replying to [comment:80 leif]:
> Replying to [comment:79 jdemeyer]:
> > As Volker explained, that's a feature, not a bug.
> 
> Nope, the doctest shouldn't put files there (which isn't safe for simultaneous testing anyway).

```
...
    Testing ``sage --preparse FILE`` and ``sage -t FILE``.  First create
    a file and preparse it::

        sage: s = '\"\"\"\nThis is a test file.\n\"\"\"\ndef my_add(a,b):\n    \"\"\"\n    Add a to b.\n\n        EXAMPLES::\n\n            sage: my_add(2,2)\n            4\n        \"\"\"\n    return a+b\n'
        sage: script = os.path.join(tmp_dir(), 'my_script.sage')
        sage: script_py = script[:-5] + '.py'
        sage: F = open(script, 'w')
        sage: F.write(s)
        sage: F.close()
        sage: (out, err, ret) = test_executable(["sage", "--preparse", script])
        sage: ret
        0
        sage: os.path.isfile(script_py)
        True

    Now test my_script.sage and the preparsed version my_script.py::

        sage: (out, err, ret) = test_executable(["sage", "-t", script])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
        sage: (out, err, ret) = test_executable(["sage", "-t", script_py])
        sage: ret
        0
        sage: out.find("All tests passed!") >= 0
        True
...
```


The latter four tests failed.


---

Comment by vbraun created at 2013-01-12 18:37:05

You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.


---

Comment by leif created at 2013-01-12 19:23:30

Replying to [comment:82 vbraun]:
> You'll always be able to make doctests fail if you point `SAGE_TESTDIR` at an ill-suited directory. Try `SAGE_TESTDIR=/proc`.

That's unrelated.  It's IMHO pretty ok to have `SAGE_TESTDIR=/tmp` (or whatever world-writable scratch directory; same for `SAGE_TMP`).

The test just shouldn't write the script into that directory, but instead into a "safe" subdir, just where all other doctest scripts end up.

Orthogonal to the safety issue, the test could just fail because different test instances (in this case, on different machines, but sharing the test directory) use the same file at the same time.


---

Comment by saraedum created at 2018-08-24 01:13:18

Can we get rid of this patch during the Python 3 upgrade by using Python's isolated mode (`-I`)? There's an unanswered question about this at https://bugs.python.org/issue16202 btw.


---

Comment by saraedum created at 2018-10-10 12:24:17

There is a followup now at #26457.
