# Issue 14481: error in the computing of the approximate order in LazyPowerSeries

archive/issues_014481.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  mantepse\n\nKeywords: LazyPowerSeries aorder approximate order\n\nHi,\n\nI found a bug in the LazyPowerSeries class of package combinat.\nThere is mistake in the computing of the approximate order of a serie.\nA demonstration of the bug :\n\n```\nsage: R = LazyPowerSeriesRing(QQ)\nsage: B = R([0,0,0,1,0])\nsage: B.aorder\n0\nsage: B.coefficients(10)\n[0, 0, 0, 1, 0, 0, 0, 0, 0, 0]\nsage: B.aorder\n1\n```\n\n\nHere, a patch :\n\n```\ndiff --git a/sage/combinat/species/series.py b/sage/combinat/species/series.py\n--- a/sage/combinat/species/series.py\n+++ b/sage/combinat/species/series.py\n@@ -631,6 +631,7 @@\n                         self.aorder += 1\n                         ao += 1\n                     else:\n+                        self.order = ao\n                         break\n \n             #Try to recognize the zero series\n@@ -643,8 +644,17 @@\n                     self.order  = inf\n                     return\n                 \n-            if ao < n:\n-                self.order = ao\n+            if self.order == unk:\n+                while ao < n:\n+                    if self._stream[ao] == 0:\n+                        self.aorder += 1\n+                        ao += 1\n+                    else:\n+                        self.order = ao\n+                        break\n+\n+            # if ao < n:\n+            #     self.order = ao\n             \n     \n         if hasattr(self, '_reference') and self._reference is not None:\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14685\n\n",
    "created_at": "2013-06-04T16:15:22Z",
    "labels": [
        "combinatorics",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "error in the computing of the approximate order in LazyPowerSeries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14481",
    "user": "MatthieuDien"
}
```
Assignee: sage-combinat

CC:  mantepse

Keywords: LazyPowerSeries aorder approximate order

Hi,

I found a bug in the LazyPowerSeries class of package combinat.
There is mistake in the computing of the approximate order of a serie.
A demonstration of the bug :

```
sage: R = LazyPowerSeriesRing(QQ)
sage: B = R([0,0,0,1,0])
sage: B.aorder
0
sage: B.coefficients(10)
[0, 0, 0, 1, 0, 0, 0, 0, 0, 0]
sage: B.aorder
1
```


Here, a patch :

```
diff --git a/sage/combinat/species/series.py b/sage/combinat/species/series.py
--- a/sage/combinat/species/series.py
+++ b/sage/combinat/species/series.py
@@ -631,6 +631,7 @@
                         self.aorder += 1
                         ao += 1
                     else:
+                        self.order = ao
                         break
 
             #Try to recognize the zero series
@@ -643,8 +644,17 @@
                     self.order  = inf
                     return
                 
-            if ao < n:
-                self.order = ao
+            if self.order == unk:
+                while ao < n:
+                    if self._stream[ao] == 0:
+                        self.aorder += 1
+                        ao += 1
+                    else:
+                        self.order = ao
+                        break
+
+            # if ao < n:
+            #     self.order = ao
             
     
         if hasattr(self, '_reference') and self._reference is not None:
```


Issue created by migration from https://trac.sagemath.org/ticket/14685





---

archive/issue_comments_183273.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2013-06-04T16:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183273",
    "user": "MatthieuDien"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_183274.json:
```json
{
    "body": "Bienvenue \u00e0 bord !\n\nYour patch does not looks good: it contains three times the same thing. It is necessary to make it again in a more clean way.\n\nIt is not clear to me what the expected result should be in the example given above. Which answer is correct and which one is not ?\n\nApart from that, it would be good to add a test to check that the error is corrected. Something like\n\n```\nOne checks that :trac:`14685` is solved::\n\n    sage: R = LazyPowerSeriesRing(QQ)\n```\n\nand then the appropriate example.",
    "created_at": "2013-06-05T20:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183274",
    "user": "chapoton"
}
```

Bienvenue à bord !

Your patch does not looks good: it contains three times the same thing. It is necessary to make it again in a more clean way.

It is not clear to me what the expected result should be in the example given above. Which answer is correct and which one is not ?

Apart from that, it would be good to add a test to check that the error is corrected. Something like

```
One checks that :trac:`14685` is solved::

    sage: R = LazyPowerSeriesRing(QQ)
```

and then the appropriate example.



---

archive/issue_comments_183275.json:
```json
{
    "body": "Hello,\n\nthe corrected behaviour should be added **to the code**, in the documentation at the start of the function.\n\nYour patch still looks strange. How do you make it ?\n\nYou should\n\n```\n1) cd to the directory sage-5.9/devel/sage-main/\n2) create a patch with hg qnew trac_xxxxx_name_of_the_patch.patch\n3) edit the sources\n4) put the changes into the patch by hg qrefresh (then either go to step 3 or step 5)\n5) edit the header of the patch by hg qrefresh -e\n6) export the patch by hg export tip > filename (for example $HOME/trac_xxxxx_name_of_the_patch.patch)\n7) put this exported file in trac\n```\n",
    "created_at": "2013-06-07T11:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183275",
    "user": "chapoton"
}
```

Hello,

the corrected behaviour should be added **to the code**, in the documentation at the start of the function.

Your patch still looks strange. How do you make it ?

You should

```
1) cd to the directory sage-5.9/devel/sage-main/
2) create a patch with hg qnew trac_xxxxx_name_of_the_patch.patch
3) edit the sources
4) put the changes into the patch by hg qrefresh (then either go to step 3 or step 5)
5) edit the header of the patch by hg qrefresh -e
6) export the patch by hg export tip > filename (for example $HOME/trac_xxxxx_name_of_the_patch.patch)
7) put this exported file in trac
```




---

archive/issue_comments_183276.json:
```json
{
    "body": "Hi!\n\nThanks for working on the lazy power series code; it needs some love.\n\nJust one thing to be careful with; I haven't looked in detail in your code, so maybe it takes care of this already:\n\nThe method might be passed as argument a lazy power series implemented by a function f(n) which returns always 0; or some non zero coefficient but only for n very large. In such a case we don't want to run forever: this is about computing an approximation of the order, and often, knowing that the order is at least 1 or at least 2 is sufficient for the purpose (initializing the recurrence for computing series defined recursively). \n\nOf course, there are case where we do want the exact order, even at the price of running for a long time.\n\nIts possible that the interface needs a bit of cleaning up so that the distinction between approximate order and order would be well exposed (and by the way maybe this should really be called valuation rather than order).",
    "created_at": "2013-06-07T12:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183276",
    "user": "nthiery"
}
```

Hi!

Thanks for working on the lazy power series code; it needs some love.

Just one thing to be careful with; I haven't looked in detail in your code, so maybe it takes care of this already:

The method might be passed as argument a lazy power series implemented by a function f(n) which returns always 0; or some non zero coefficient but only for n very large. In such a case we don't want to run forever: this is about computing an approximation of the order, and often, knowing that the order is at least 1 or at least 2 is sufficient for the purpose (initializing the recurrence for computing series defined recursively). 

Of course, there are case where we do want the exact order, even at the price of running for a long time.

Its possible that the interface needs a bit of cleaning up so that the distinction between approximate order and order would be well exposed (and by the way maybe this should really be called valuation rather than order).



---

archive/issue_comments_183277.json:
```json
{
    "body": "for chapoton :\n\nI made the patch with a **diff -Naur ** but I will fix this.\nThank you for the detailed method.\n\nfor nthiery :\n\nI am not sure to understand what you said :\ncurrently the computing of the approximate order cost is amortized on every request for a serie's term (and it's a little cost). Normally, the order should be known when the approximate order reaches him.\n\nThe patch keeps this behavior.\nThis was your question ?\n\nMoreover, the current version do not compute the right order too :\n {{{\n sage: R = LazyPowerSeriesRing(QQ)\n sage: B = R([0,0,0,1,0])\n sage: B.order\n Unknown series order\n sage: B.coefficients(10)\n [0, 0, 0, 1, 0, 0, 0, 0, 0, 0]\n sage: B.aorder\n 0   #instead of 3\n }}}",
    "created_at": "2013-06-07T13:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183277",
    "user": "MatthieuDien"
}
```

for chapoton :

I made the patch with a **diff -Naur ** but I will fix this.
Thank you for the detailed method.

for nthiery :

I am not sure to understand what you said :
currently the computing of the approximate order cost is amortized on every request for a serie's term (and it's a little cost). Normally, the order should be known when the approximate order reaches him.

The patch keeps this behavior.
This was your question ?

Moreover, the current version do not compute the right order too :
 {{{
 sage: R = LazyPowerSeriesRing(QQ)
 sage: B = R([0,0,0,1,0])
 sage: B.order
 Unknown series order
 sage: B.coefficients(10)
 [0, 0, 0, 1, 0, 0, 0, 0, 0, 0]
 sage: B.aorder
 0   #instead of 3
 }}}



---

archive/issue_comments_183278.json:
```json
{
    "body": "I posted a version of the patch which fixes the commit message.  This looks good to me, and I agree with Matthieu's assessment of the amortized costs.",
    "created_at": "2013-06-21T13:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183278",
    "user": "mhansen"
}
```

I posted a version of the patch which fixes the commit message.  This looks good to me, and I agree with Matthieu's assessment of the amortized costs.



---

archive/issue_comments_183279.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-21T13:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183279",
    "user": "mhansen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_183280.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-06-21T13:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183280",
    "user": "mhansen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_183281.json:
```json
{
    "body": "Replying to [comment:11 mhansen]:\nThank you !",
    "created_at": "2013-06-22T11:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183281",
    "user": "MatthieuDien"
}
```

Replying to [comment:11 mhansen]:
Thank you !



---

archive/issue_comments_183282.json:
```json
{
    "body": "Attachment [trac_14685_bug_aorder_lazypowerseries.patch](tarball://root/attachments/some-uuid/ticket14685/trac_14685_bug_aorder_lazypowerseries.patch) by mhansen created at 2013-07-21 19:19:16\n\nThe new patch should apply.",
    "created_at": "2013-07-21T19:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183282",
    "user": "mhansen"
}
```

Attachment [trac_14685_bug_aorder_lazypowerseries.patch](tarball://root/attachments/some-uuid/ticket14685/trac_14685_bug_aorder_lazypowerseries.patch) by mhansen created at 2013-07-21 19:19:16

The new patch should apply.



---

archive/issue_comments_183283.json:
```json
{
    "body": "Apply trac_14685_bug_aorder_lazypowerseries.patch\u200b",
    "created_at": "2013-07-21T21:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183283",
    "user": "mhansen"
}
```

Apply trac_14685_bug_aorder_lazypowerseries.patch​



---

archive/issue_comments_183284.json:
```json
{
    "body": "What's going wrong?\n\n\n```\ndarij@travis-virtualbox:~/sage-5.11.beta3/devel/sage-main/sage/combinat$ hg qpush\napplying trac_14685_bug_aorder_lazypowerseries.patch\npatching file sage/combinat/species/series.py\nHunk #2 FAILED at 641\nHunk #3 FAILED at 660\n2 out of 3 hunks FAILED -- saving rejects to file sage/combinat/species/series.py.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh trac_14685_bug_aorder_lazypowerseries.patch\ndarij@travis-virtualbox:~/sage-5.11.beta3/devel/sage-main/sage/combinat$ \n```\n\n\nSeries file:\n\n\n```\ntrac_14808-recoils_of_permutations-ts.patch\ntrac_14117-jordan_normal_form-dg-v3.patch\ntrac_7983-major_index_and_other_tableau_fixes-dg.patch\ntrac_14748_deprecationwarning.patch\ntrac_14136-p_partition_enumerator_folded.patch\ntrac_14507-tropical_semiring-ts.patch\ntrac_14775-symmetric_functions_extended-dg.patch\ntrac_14783-toggles_on_order_ideals-jsdg.patch\ntrac_14516-crystals_speedup-ts.2.patch\ntrac_14519-cynthonize_element_wrapper-ts.patch\ntrac_8386_really_just_moving-fc.patch\ntrac_8386_big_clean_fc.patch\ntrac_8386_assert_removal.patch\ntrac_14772-remove_cc_permutations-ts.patch\ntrac_13589-categories-c3_under_control-nt.patch\ntrac_14884-tableau_times_id-dg.patch\ntrac_14883-remove_times_id-dg.patch\ntrac_14101-remove_cc_skew-ts.patch\ntrac_14882-backtrack_longtime-dg-v2.patch\ntrac_14881-symmetric_group_algebra_rebased-dg.patch\ntrac_13214_hom_finite_field.patch\ntrac_14860-bug-binary-trees-vp.patch\ntrac_12571-shifted_shuffle_of_permutations-reviewed.patch\ntrac_14685_bug_aorder_lazypowerseries.patch\n```\n",
    "created_at": "2013-07-22T10:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183284",
    "user": "darij"
}
```

What's going wrong?


```
darij@travis-virtualbox:~/sage-5.11.beta3/devel/sage-main/sage/combinat$ hg qpush
applying trac_14685_bug_aorder_lazypowerseries.patch
patching file sage/combinat/species/series.py
Hunk #2 FAILED at 641
Hunk #3 FAILED at 660
2 out of 3 hunks FAILED -- saving rejects to file sage/combinat/species/series.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh trac_14685_bug_aorder_lazypowerseries.patch
darij@travis-virtualbox:~/sage-5.11.beta3/devel/sage-main/sage/combinat$ 
```


Series file:


```
trac_14808-recoils_of_permutations-ts.patch
trac_14117-jordan_normal_form-dg-v3.patch
trac_7983-major_index_and_other_tableau_fixes-dg.patch
trac_14748_deprecationwarning.patch
trac_14136-p_partition_enumerator_folded.patch
trac_14507-tropical_semiring-ts.patch
trac_14775-symmetric_functions_extended-dg.patch
trac_14783-toggles_on_order_ideals-jsdg.patch
trac_14516-crystals_speedup-ts.2.patch
trac_14519-cynthonize_element_wrapper-ts.patch
trac_8386_really_just_moving-fc.patch
trac_8386_big_clean_fc.patch
trac_8386_assert_removal.patch
trac_14772-remove_cc_permutations-ts.patch
trac_13589-categories-c3_under_control-nt.patch
trac_14884-tableau_times_id-dg.patch
trac_14883-remove_times_id-dg.patch
trac_14101-remove_cc_skew-ts.patch
trac_14882-backtrack_longtime-dg-v2.patch
trac_14881-symmetric_group_algebra_rebased-dg.patch
trac_13214_hom_finite_field.patch
trac_14860-bug-binary-trees-vp.patch
trac_12571-shifted_shuffle_of_permutations-reviewed.patch
trac_14685_bug_aorder_lazypowerseries.patch
```




---

archive/issue_comments_183285.json:
```json
{
    "body": "This doesn't apply to sage-5.11.beta3:\n\n```\napplying /release/merger/patches/trac_14685_bug_aorder_lazypowerseries.patch\npatching file sage/combinat/species/series.py\nHunk #2 FAILED at 641\nHunk #3 FAILED at 660\n2 out of 3 hunks FAILED -- saving rejects to file sage/combinat/species/series.py.rej\nabort: patch failed to apply\n```\n",
    "created_at": "2013-07-24T07:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183285",
    "user": "jdemeyer"
}
```

This doesn't apply to sage-5.11.beta3:

```
applying /release/merger/patches/trac_14685_bug_aorder_lazypowerseries.patch
patching file sage/combinat/species/series.py
Hunk #2 FAILED at 641
Hunk #3 FAILED at 660
2 out of 3 hunks FAILED -- saving rejects to file sage/combinat/species/series.py.rej
abort: patch failed to apply
```




---

archive/issue_comments_183286.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-07-24T07:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183286",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_183287.json:
```json
{
    "body": "Attachment [trac_14685-darijs_mod.patch](tarball://root/attachments/some-uuid/ticket14685/trac_14685-darijs_mod.patch) by darij created at 2013-07-29 16:05:52\n\nAlternative version of the patch, which applies on my system",
    "created_at": "2013-07-29T16:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183287",
    "user": "darij"
}
```

Attachment [trac_14685-darijs_mod.patch](tarball://root/attachments/some-uuid/ticket14685/trac_14685-darijs_mod.patch) by darij created at 2013-07-29 16:05:52

Alternative version of the patch, which applies on my system



---

archive/issue_comments_183288.json:
```json
{
    "body": "I've attached a modified version of the patch that applies on my system. Since Jeroen, me and the patchbot seem to be stumbling over the same error, I assume this might be of some help. All I've changed were deleted lines, which gives me some hope I didn't break anything, so I'm going to be blunt:\n\nPatchbot:\n\napply trac_14685-darijs_mod.patch\u200b",
    "created_at": "2013-07-29T16:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183288",
    "user": "darij"
}
```

I've attached a modified version of the patch that applies on my system. Since Jeroen, me and the patchbot seem to be stumbling over the same error, I assume this might be of some help. All I've changed were deleted lines, which gives me some hope I didn't break anything, so I'm going to be blunt:

Patchbot:

apply trac_14685-darijs_mod.patch​



---

archive/issue_comments_183289.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-07-29T16:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183289",
    "user": "darij"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_183290.json:
```json
{
    "body": "A fix is in #15673",
    "created_at": "2014-01-14T17:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183290",
    "user": "mhansen"
}
```

A fix is in #15673



---

archive/issue_comments_183291.json:
```json
{
    "body": "Needs a working git branch",
    "created_at": "2015-02-23T19:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183291",
    "user": "chapoton"
}
```

Needs a working git branch



---

archive/issue_comments_183292.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-23T19:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183292",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_183293.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-12T01:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183293",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_183294.json:
```json
{
    "body": "I propose closing this as invalid since this is only meant to be the approximate order, not the actual order. So as long as `aorder <= order`, then it is correct. (Although it might be considered a missed optimization.)\n\nThis is also set to be replaced soon; see #31651.",
    "created_at": "2021-08-12T01:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14481#issuecomment-183294",
    "user": "tscrim"
}
```

I propose closing this as invalid since this is only meant to be the approximate order, not the actual order. So as long as `aorder <= order`, then it is correct. (Although it might be considered a missed optimization.)

This is also set to be replaced soon; see #31651.
