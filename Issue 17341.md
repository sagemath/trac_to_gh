# Issue 17341: Use Parent/Element for Manin symbols

Issue created by migration from https://trac.sagemath.org/ticket/17578

Original creator: pbruin

Original creation time: 2015-01-02 19:17:37

CC:  jdemeyer jpflori was

Keywords: Manin symbol

The classes `ManinSymbolList` and `ManinSymbol` (in `sage.modular.modsym.manin_symbols`) do not inherit from `Parent` and `Element`.  This causes trouble when applying both #10513 and #10962.


---

Comment by pbruin created at 2015-01-02 19:23:15

Changing status from new to needs_review.


---

Comment by pbruin created at 2015-01-02 19:23:15

The only real changes are in commit `a9da048`; the first two move the class `ManinSymbol` up in the file to allow `Element = ManinSymbol` in `ManinSymbolList`.


---

Comment by tscrim created at 2015-01-02 21:20:50

I've made some more substantial changes making `ManinSymbolList` a proper parent in `FiniteEnumeratedSets`. In particular, there is a backwards incompatible change in that `m[i]` returns a `ManinSymbol` instance (of `m`) rather than a tuple. Also I changed the `_list` attribute to `_symbol_list` since `FiniteEnumeratedSets` uses `_list` internally. Lastly I've added a method `symbol_list` to get the explicit list of symbols (the indexing tuples).

I'm thinking we should post something to sage-devel stating this (proposed) change. Sound good?
----
New commits:


---

Comment by pbruin created at 2015-01-03 08:43:56

Replying to [comment:2 tscrim]:
> I've made some more substantial changes making `ManinSymbolList` a proper parent in `FiniteEnumeratedSets`. In particular, there is a backwards incompatible change in that `m[i]` returns a `ManinSymbol` instance (of `m`) rather than a tuple. Also I changed the `_list` attribute to `_symbol_list` since `FiniteEnumeratedSets` uses `_list` internally. Lastly I've added a method `symbol_list` to get the explicit list of symbols (the indexing tuples).
> 
> I'm thinking we should post something to sage-devel stating this (proposed) change. Sound good?
I don't mind too much, but given that this ticket is a dependency of #10513, which already has positive review, wouldn't it make sense to do this on a different ticket?  (I currently don't have enough time to review your changes.)


---

Comment by jdemeyer created at 2015-01-03 10:20:48

This will almost certainly conflict with the already-merged #15015.


---

Comment by jdemeyer created at 2015-01-03 15:14:24

I moved the "moving" part to #17579 (merging #15015). I'll let you decide which commits from here to cherry-pick on top of #17579.


---

Comment by tscrim created at 2015-01-04 07:02:07

sage-devel: http://groups.google.com/forum/#!topic/sage-devel/JlPnmjA1PCg


---

Comment by git created at 2015-01-04 07:08:13

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by tscrim created at 2015-01-04 07:10:06

I merged in #17579, but kept the version from here.


---

Comment by pbruin created at 2015-01-04 08:53:54

In the meantime I already rebased the branch (I think this is a better solution than merging in this case) and reverted the more substantial changes from Travis's commit, so that this ticket can be merged as soon as possible in view of #10513.


---

Comment by tscrim created at 2015-01-04 14:56:03

I strongly disagree with doing this (IMO) dirty hack of parents just to merge it quickly. It creates parents without a category and elements not created from the parent, both of which are abuses of `Parent`.

Also from my understanding, since this branch was published and I based my branch on it, it was not good to rebase the branch. Merge commits don't hurt anyone.


---

Comment by tscrim created at 2015-01-15 20:42:58

I'm creating the following for the test:

```
sage: from sage.modular.modsym.manin_symbols import ManinSymbolList_gamma0
sage: m = ManinSymbolList_gamma0(5,8)
```

Previously we have:

```
sage: %time L = m.manin_symbol_list()
CPU times: user 560 µs, sys: 84 µs, total: 644 µs
Wall time: 494 µs
sage: %time L = m.manin_symbol_list()
CPU times: user 48 µs, sys: 4 µs, total: 52 µs
Wall time: 68.9 µs
```

With my branch:

```
sage: %time L = m.manin_symbol_list()
CPU times: user 644 µs, sys: 90 µs, total: 734 µs
Wall time: 747 µs
sage: %time L = m.manin_symbol_list()
CPU times: user 56 µs, sys: 7 µs, total: 63 µs
Wall time: 64.8 µs
```

With Peter's branch:

```
sage: %time L = m.manin_symbol_list()
CPU times: user 792 µs, sys: 99 µs, total: 891 µs
Wall time: 828 µs
sage: %time L = m.manin_symbol_list()
CPU times: user 49 µs, sys: 6 µs, total: 55 µs
Wall time: 66 µs
```

So there is a slowdown with creating the instances of `ManinSymbol` that comes from the new branch and Peters by creating instances of `Element`. Hence this is a slowdown we might just have to deal with (assuming one is actually wanting the `ManinSymbol`, not the indexing tuple which can be grabbed by `symbol_list`).
----
New commits:


---

Comment by was created at 2015-01-15 21:12:35

If I'm reading your test, that's not just "a slowdown...we might just have to deal with", it's an *epic slowdown*, by a full factor of 10.   Am I reading that right?  If so, then this is definitely seriously worrisome.


---

Comment by tscrim created at 2015-01-15 21:34:51

Replying to [comment:13 was]:
> If I'm reading your test, that's not just "a slowdown...we might just have to deal with", it's an *epic slowdown*, by a full factor of 10.   Am I reading that right?  If so, then this is definitely seriously worrisome.

The first line is the actual creation, the second is when the caching comes into effect. However the slowdown is by ~1.4x due to the overhead. Thus if we want to fix the probthese without the overhead from the category, we need an entirely different approach. Do you think you could run a timing in a more realistic computation or post such a computation?


---

Comment by pbruin created at 2015-03-20 13:26:20

Here is a new branch incorporating my original fix, Travis's improvements, and a restructuring of the module `sage.modular.modsym.manin_symbols` into two new modules `sage.modular.modsym.manin_symbol` (Cython) and `sage.modular.modsym.manin_symbol` (Python).

The creation of the list in Travis's example goes down from 191 µs to 150 µs on the system on which I tested this.

(I have decided to rebase my branch; it has been inactive for months and I wanted to start with a clean slate.  In particular, I found the duplicate commits in the Git history extremely annoying.)


---

Comment by tscrim created at 2015-03-20 16:21:37

Overall I'm happy with the changes (especially the speedup, which was the sticking point for getting this in). Quick question, could any of those methods for the `ManinSymbol` class be declared `cpdef` and get a speed boost? If not (or you don't think it's necessary to do now), you can set this to a positive review.


---

Comment by pbruin created at 2015-03-20 20:43:42

Replying to [comment:16 tscrim]:
> Overall I'm happy with the changes (especially the speedup, which was the sticking point for getting this in).
Thanks!
> Quick question, could any of those methods for the `ManinSymbol` class be declared `cpdef` and get a speed boost? If not (or you don't think it's necessary to do now), you can set this to a positive review.
I prefer to do this later if and when it becomes necessary.


---

Comment by pbruin created at 2015-03-20 20:43:42

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-03-20 20:49:05

Alright. Thanks for your work on this (and on improving the modules!!!).


---

Comment by vbraun created at 2015-03-21 12:37:53

Resolution: fixed
