# Issue 22060: py3 remove cmp() in element.pyx

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-02-03 09:51:05

CC:  tscrim jdemeyer aapitzsch jhpalmieri

as another step to py3

here just remove an useless piece of code


---

Comment by chapoton created at 2017-02-03 09:51:42

let us wait for the bots
----
New commits:


---

Comment by chapoton created at 2017-02-03 09:51:42

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-02-03 11:10:52

This is obviously not correct: you cannot just remove that branch.


---

Comment by jdemeyer created at 2017-02-03 11:10:52

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-02-03 12:28:39

could you please explain why ? no doctest fail.


---

Comment by chapoton created at 2017-02-04 07:50:54

bot is green.


---

Comment by jdemeyer created at 2017-02-04 14:10:24

Replying to [comment:3 chapoton]:
> could you please explain why ? no doctest fail.

That's not how it works.  _You_ have to explain me why the change that you made makes sense. And "no doctest fail" is never a good explanation.

I'm not even saying that the change is wrong, but it certainly needs to be justified.


---

Comment by jdemeyer created at 2017-02-04 14:16:12

Replying to [comment:5 jdemeyer]:
> I'm not even saying that the change is wrong

Well, ok, I _did_ say that, but that might have been too harsh.


---

Comment by jdemeyer created at 2017-02-04 16:07:40

If you really want to forward to Python 3, why not remove `__cmp__` completely?


---

Comment by git created at 2017-02-04 18:29:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-02-04 18:30:03

This doesn't really work because there are Element classes which have _different_ semantics for `__cmp__` and `__richcmp__`. So it's not easy to do this.


---

Comment by chapoton created at 2017-02-04 22:37:19

so, can I put back my branch and set it to needs review ?

it seems to me that what I remove can never happen (because this is a method of the element class, self is an Element)


---

Comment by jdemeyer created at 2017-02-05 08:02:46

Replying to [comment:11 chapoton]:
> so, can I put back my branch and set it to needs review ?
> it seems to me that what I remove can never happen (because this is a method of the element class, self is an Element)

I looked at your branch and it is wrong because it happens _after_ coercion. There is no guarantee that the result of coercion will be Sage elements.


---

Comment by jdemeyer created at 2017-02-05 08:05:57

Anyway, I think it's a bad idea to try to remove those 3 lines. You should look at `__cmp__` as a whole and fix that. It makes little sense to do a micro-change like what you suggest.


---

Comment by chapoton created at 2017-02-05 12:45:40

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 chapoton]:
> > so, can I put back my branch and set it to needs review ?
> > it seems to me that what I remove can never happen (because this is a method of the element class, self is an Element)
> 
> I looked at your branch and it is wrong because it happens _after_ coercion. There is no guarantee that the result of coercion will be Sage elements.

oh ! really ? I thought that when things have a parent, they are elements. Would you
have an example where this is not the case ?

Other possibilities that come to my mind : what would you think of replacing "`cmp(left, right)`" by "`left.__cmp__(right)`" (I have not yet tried if it works) ? or maybe by "`raise TypeError('coercion should build members of Element class')`" ?

This is one of the latest calls to cmp() in a cython file. I would really like to be able to cythonize all the pxy files with python3.


---

Comment by chapoton created at 2017-02-05 20:51:40

Replying to [comment:10 jdemeyer]:
> This doesn't really work because there are Element classes which have _different_ semantics for `__cmp__` and `__richcmp__`. So it's not easy to do this.

Do you remember how many failures there are, and where ? how many classes are concerned by this bad double semantic ? I would suspect that this happens at least in symbolic ring and real numbers. This may also be the cause of the problems in #22257.


---

Comment by jdemeyer created at 2017-02-06 08:35:13

Replying to [comment:14 chapoton]:
> oh ! really ? I thought that when things have a parent, they are elements.

Of course. That's trivially true, since a parent is a concept which was invented for the `Element`/`Parent` classes.

> Would you have an example where this is not the case ?
Not right away, but I know that it's possible.

> Other possibilities that come to my mind : what would you think of replacing "`cmp(left, right)`" by "`left.__cmp__(right)`"

I don't really like that, but this might be the least bad thing to do.

> "`raise TypeError('coercion should build members of Element class')`" ?

Certainly not this.


---

Comment by jdemeyer created at 2017-02-06 09:27:21

Replying to [comment:14 chapoton]:
> oh ! really ? I thought that when things have a parent, they are elements. Would you
> have an example where this is not the case ?

OK, I have an example: the coercion of `RealField(54)(1)` and `float(1.0)` gives a `float`.

This _might_ be considered a bug though...


---

Comment by git created at 2017-02-07 08:34:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-02-07 08:35:58

Oops, wrong ticket...


---

Comment by jdemeyer created at 2017-02-07 11:54:39

Replying to [comment:15 chapoton]:
> Replying to [comment:10 jdemeyer]:
> > This doesn't really work because there are Element classes which have _different_ semantics for `__cmp__` and `__richcmp__`. So it's not easy to do this.
> 
> Do you remember how many failures there are, and where ?

I didn't really keep track. Certainly intervals too.


---

Comment by chapoton created at 2017-02-10 12:54:14

putting Jeroen's branch back, so that one can run a bot on it
----
New commits:


---

Comment by chapoton created at 2017-02-10 12:58:24

trying with another branch, that just remove blankly `__cmp__`

this is a test branch, so that one can run a patchbot on it
----
New commits:


---

Comment by chapoton created at 2017-02-25 21:17:09

some preparation work done in #22446, #22447, #22448


---

Comment by chapoton created at 2017-03-31 11:58:59

some of the problems (including the ones in Coxeter groups and heegner.py) reduces to the following one:

```
sage: A1=QuadraticField(5)
sage: A2=QuadraticField(5)
sage: A1==A2
False
```

or the existing doctest

```
QuadraticField(-11, 'a') is QuadraticField(-11, 'a')
```

In turn, this seems to come from problems in RealLazyField.

```
from sage.rings.number_field.number_field import NumberFieldFactory
nff = NumberFieldFactory("number_field_factory")
sage: R.<x> = QQ[]
a1=nff.create_object(None, (QQ, x^2 -2, ('a',), RLF(sqrt(2)), None, None, False, None), check=False)
a2=nff.create_object(None, (QQ, x^2 -2, ('a',), RLF(sqrt(2)), None, None, False, None), check=False)
a1 == a2
```

where the failure of equality comes from the RLF terms.


---

Comment by chapoton created at 2017-03-31 19:37:28

so we probably really should fix #22257 first


---

Comment by chapoton created at 2017-05-14 11:46:25

now waiting at least for #22890, #22815 and #22907


---

Comment by git created at 2017-05-19 12:23:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-19 14:50:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-06-02 19:16:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-06-03 08:01:48

another preparation step is #23133


---

Comment by git created at 2017-06-12 08:48:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-19 17:21:00

maybe the last preparation step is #23273


---

Comment by chapoton created at 2017-06-23 06:10:43

this should be ready, let us wait for a patchbot report


---

Comment by chapoton created at 2017-06-23 06:10:43

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-06-23 11:38:04

ok, bot is essentially green. Please review.


---

Comment by jdemeyer created at 2017-06-23 11:50:27

Great news!

One detail: you should keep the doctest (changing `cmp` and `__cmp__` to rich comparisons accordingly). Perhaps move that doctest to `_richcmp_`.


---

Comment by jdemeyer created at 2017-06-23 11:50:27

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-23 11:51:34

Also, only this

```
            left_cmp = left.__cmp__
```

should be inside the `try` statement.


---

Comment by git created at 2017-06-23 12:28:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-23 12:30:03

ok for the doctest. I also did something for the try statement, but was not sure of what you meant.


---

Comment by jdemeyer created at 2017-06-23 12:37:20

I meant something like

```
        try:
            left_cmp = left.__cmp__
        except AttributeError:
            pass
        else:
            if isinstance(left_cmp, MethodType):
                return left_cmp(right)
```

but I'm wondering if we still the check `if isinstance(left_cmp, MethodType):`. Maybe this would work too:

```
        try:
            left_cmp = left.__cmp__
        except AttributeError:
            pass
        else:
            return left_cmp(right)
```



---

Comment by git created at 2017-06-23 12:40:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-23 12:41:04

oh, I see. I did not know this syntax.

Let us try without the isinstance check then.


---

Comment by chapoton created at 2017-06-23 12:46:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-06-23 13:16:17

You don't need `left_cmp = None`, just write `pass` in the `except` clause.


---

Comment by git created at 2017-06-23 13:17:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-23 13:18:16

done, sorry


---

Comment by chapoton created at 2017-06-24 12:54:11

bot is morally green

**EDIT** now squarely green


---

Comment by jdemeyer created at 2017-06-26 11:35:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-29 06:46:46

Resolution: fixed
