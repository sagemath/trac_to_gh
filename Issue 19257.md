# Issue 19257: Make finite word method nb_subword_occurences_in much faster

archive/issues_019257.json:
```json
{
    "body": "This computation takes years in Sage, but it can be done in some ms with this ticket:\n\n\n```\nsage: u = words.ThueMorseWord()[:1000] \nsage: w = Word([0,1,0,1])              \nsage: w.nb_subword_occurrences_in(u)   \n2604124996                             \n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19494\n\n",
    "created_at": "2015-10-28T17:18:50Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Make finite word method nb_subword_occurences_in much faster",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19257",
    "user": "https://github.com/seblabbe"
}
```
This computation takes years in Sage, but it can be done in some ms with this ticket:


```
sage: u = words.ThueMorseWord()[:1000] 
sage: w = Word([0,1,0,1])              
sage: w.nb_subword_occurrences_in(u)   
2604124996                             
```


Issue created by migration from https://trac.sagemath.org/ticket/19494





---

archive/issue_comments_263942.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-28T17:22:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263942",
    "user": "https://github.com/seblabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_263943.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-10-28T17:22:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263943",
    "user": "https://github.com/seblabbe"
}
```

New commits:



---

archive/issue_comments_263944.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-10-29T12:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263944",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_263945.json:
```json
{
    "body": "If I understand correctly `u.binomial(v)` is the same thing as `v.nb_subword_occurrences_in(u)`. Why two distinct terminologies? Words currently have `is_prefix` and `has_prefix` which I found much clearer.\n\nWith your function, you are creating some `n x n` matrices where `n` is the length of the small word `v`. Could you check that `u` and `v` are roughyl of the same length (say 12 and 10 or 100 and 90) your new code is still better. In your examples there are only occurrences where `v` is much smaller than `u`.\n\nOne drawback in the above case might also be memory usage and complexity of dense matrix multiplication. You might need `n^3` space (for `n` dense matrices of size `n x n`) and if `n` is big, multiplying `n x n` dense matrices is expensive. Using sparse matrices in some corner case might be useful, e.g.\n\n```\nsage: W = Words(NN)\nsage: v = W(range(100))\nsage: u = W(randint(0,99) for _ in range(200))\nsage: u.binomial(v)\n```\n\nIn the above case, I do not expect that the result of `prod(...)` being that much dense. But perhaps I am wrong. Could you test it and if relevant add an argument `sparse` (that would be `False` by default)?\n\nVincent",
    "created_at": "2015-10-29T12:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263945",
    "user": "https://github.com/videlec"
}
```

If I understand correctly `u.binomial(v)` is the same thing as `v.nb_subword_occurrences_in(u)`. Why two distinct terminologies? Words currently have `is_prefix` and `has_prefix` which I found much clearer.

With your function, you are creating some `n x n` matrices where `n` is the length of the small word `v`. Could you check that `u` and `v` are roughyl of the same length (say 12 and 10 or 100 and 90) your new code is still better. In your examples there are only occurrences where `v` is much smaller than `u`.

One drawback in the above case might also be memory usage and complexity of dense matrix multiplication. You might need `n^3` space (for `n` dense matrices of size `n x n`) and if `n` is big, multiplying `n x n` dense matrices is expensive. Using sparse matrices in some corner case might be useful, e.g.

```
sage: W = Words(NN)
sage: v = W(range(100))
sage: u = W(randint(0,99) for _ in range(200))
sage: u.binomial(v)
```

In the above case, I do not expect that the result of `prod(...)` being that much dense. But perhaps I am wrong. Could you test it and if relevant add an argument `sparse` (that would be `False` by default)?

Vincent



---

archive/issue_comments_263946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-01T20:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263947.json:
```json
{
    "body": "That binomial was introduced by Jacques Sakarovitch as the theme of a chapter in the (first?) Lothaire book. It generalizes the binomial since `a<sup>n.binomial(a</sup>k)` is equal to `n.binomial(k)`. Ok, I agree that too many methods is too many. I removed it in the last commit.\n\nI added a new commit allowing easier reviewing and comparison of implementations. I still believe we will need one more commit to clean this up if finally we think that one implementation is useless or if one argument is useless. We will see.\n\nAbout using sparse matrices. A first remark is that matrices computed are upper triangular. So using sparse will lead eventually to saving half the space at least.\n\nIf the size of the alphabet is low, using sparse matrices is about 10 times slower:\n\n\n```\nsage: u = words.ThueMorseWord()[:1000]                       \nsage: L = list(u)                                            \nsage:                                                        \nsage: %time u[:20].nb_subword_occurrences_in(u, sparse=False)\nCPU times: user 130 ms, sys: 1.37 ms, total: 131 ms          \nWall time: 131 ms                                            \n347151814258896164694010210266438495                         \nsage: %time u[:20].nb_subword_occurrences_in(u, sparse=True) \nCPU times: user 979 ms, sys: 5.88 ms, total: 984 ms          \nWall time: 986 ms                                            \n347151814258896164694010210266438495                         \n```\n\n\nIf the size of alphabet is bigger (computation done with 201x201 matrices): then sparse or not seems about the same too:\n\n```\nsage: u = Word(range(200))                     \nsage: %time u.nb_subword_occurrences_in(u*u*u, sparse=True) \nCPU times: user 16.1 s, sys: 27.1 ms, total: 16.1 s         \nWall time: 16.2 s                                           \n20301                                                       \nsage: %time u.nb_subword_occurrences_in(u*u*u, sparse=False)\nCPU times: user 16.6 s, sys: 169 ms, total: 16.7 s          \nWall time: 16.7 s                                           \n20301                                                       \n```\n\n\nIn comparison, here is the longest word (following the previous example construction) the original algorithm can handle in less then 16s:\n\n```\nsage: u = Word(range(60))                                           \nsage: %time u.nb_subword_occurrences_in(u*u*u, algorithm='original')\nCPU times: user 12.1 s, sys: 13 ms, total: 12.1 s                   \nWall time: 12.1 s                                                   \n1891\n```\n\nI never found an example where the original implementation is better. So, that's why I would suggest to just delete it. Or we like the idea of having two distinct implementations.",
    "created_at": "2015-11-01T20:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263947",
    "user": "https://github.com/seblabbe"
}
```

That binomial was introduced by Jacques Sakarovitch as the theme of a chapter in the (first?) Lothaire book. It generalizes the binomial since `a<sup>n.binomial(a</sup>k)` is equal to `n.binomial(k)`. Ok, I agree that too many methods is too many. I removed it in the last commit.

I added a new commit allowing easier reviewing and comparison of implementations. I still believe we will need one more commit to clean this up if finally we think that one implementation is useless or if one argument is useless. We will see.

About using sparse matrices. A first remark is that matrices computed are upper triangular. So using sparse will lead eventually to saving half the space at least.

If the size of the alphabet is low, using sparse matrices is about 10 times slower:


```
sage: u = words.ThueMorseWord()[:1000]                       
sage: L = list(u)                                            
sage:                                                        
sage: %time u[:20].nb_subword_occurrences_in(u, sparse=False)
CPU times: user 130 ms, sys: 1.37 ms, total: 131 ms          
Wall time: 131 ms                                            
347151814258896164694010210266438495                         
sage: %time u[:20].nb_subword_occurrences_in(u, sparse=True) 
CPU times: user 979 ms, sys: 5.88 ms, total: 984 ms          
Wall time: 986 ms                                            
347151814258896164694010210266438495                         
```


If the size of alphabet is bigger (computation done with 201x201 matrices): then sparse or not seems about the same too:

```
sage: u = Word(range(200))                     
sage: %time u.nb_subword_occurrences_in(u*u*u, sparse=True) 
CPU times: user 16.1 s, sys: 27.1 ms, total: 16.1 s         
Wall time: 16.2 s                                           
20301                                                       
sage: %time u.nb_subword_occurrences_in(u*u*u, sparse=False)
CPU times: user 16.6 s, sys: 169 ms, total: 16.7 s          
Wall time: 16.7 s                                           
20301                                                       
```


In comparison, here is the longest word (following the previous example construction) the original algorithm can handle in less then 16s:

```
sage: u = Word(range(60))                                           
sage: %time u.nb_subword_occurrences_in(u*u*u, algorithm='original')
CPU times: user 12.1 s, sys: 13 ms, total: 12.1 s                   
Wall time: 12.1 s                                                   
1891
```

I never found an example where the original implementation is better. So, that's why I would suggest to just delete it. Or we like the idea of having two distinct implementations.



---

archive/issue_comments_263948.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-01T20:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263948",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_263949.json:
```json
{
    "body": "Hola Sebastien,\n\nHere is an example where `original` is much faster\n\n```\nsage: u = Word([randint(0,30) for _ in range(600)])\nsage: v = Word(range(30))\nsage: %time v.nb_subword_occurrences_in(u, algorithm='original')\nCPU times: user 4 ms, sys: 0 ns, total: 4 ms\nWall time: 3.16 ms\n0\nsage: %time v.nb_subword_occurrences_in(u, algorithm='matrices')\nCPU times: user 132 ms, sys: 0 ns, total: 132 ms\nWall time: 123 ms\n0\n```\n\nSo we should definitely keep it.\n\nFor sparsity of matrices I was a bit wrong. In the situation I presented, there is a big product of sparse matrices (each matrix contains exactly `n+1` ones) but the product itself will **not** be sparse. Hence using sparse matrices might not be the good strategy (depends on how the product is implemented there). From your experiments it seems that we win nothing which is definitely strange theoretically.\n\nNote that the old implementation suffers several problems to be really competitive:\n- it is recursive (which is always slow in Python)\n- it constructs a lot of prefixes and suffixes of words which is costly (creation of Python objects)\n\nWhat do you think?\n\nVincent",
    "created_at": "2015-11-01T21:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263949",
    "user": "https://github.com/videlec"
}
```

Hola Sebastien,

Here is an example where `original` is much faster

```
sage: u = Word([randint(0,30) for _ in range(600)])
sage: v = Word(range(30))
sage: %time v.nb_subword_occurrences_in(u, algorithm='original')
CPU times: user 4 ms, sys: 0 ns, total: 4 ms
Wall time: 3.16 ms
0
sage: %time v.nb_subword_occurrences_in(u, algorithm='matrices')
CPU times: user 132 ms, sys: 0 ns, total: 132 ms
Wall time: 123 ms
0
```

So we should definitely keep it.

For sparsity of matrices I was a bit wrong. In the situation I presented, there is a big product of sparse matrices (each matrix contains exactly `n+1` ones) but the product itself will **not** be sparse. Hence using sparse matrices might not be the good strategy (depends on how the product is implemented there). From your experiments it seems that we win nothing which is definitely strange theoretically.

Note that the old implementation suffers several problems to be really competitive:
- it is recursive (which is always slow in Python)
- it constructs a lot of prefixes and suffixes of words which is costly (creation of Python objects)

What do you think?

Vincent



---

archive/issue_comments_263950.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-01T21:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263950",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_263951.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-02T13:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263951",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263952.json:
```json
{
    "body": "Replying to [comment:7 vdelecroix]:\n> Hola Sebastien,\n\nHola !! Como esta tu en el Chile ahora!?\n\n> Here is an example where `original` is much faster\n\nHow did you come up with this example? I mean what should be the heuristic for when using the recursive or the matrices implementation?\n\n> So we should definitely keep it.\n\nI renamed it `'recursive'`.\n\n> For sparsity of matrices I was a bit wrong. \n\nOk. I removed the sparse argument.\n\n> Note that the old implementation suffers several problems \n\nYes. I have seen that...\n\n> What do you think?\n\nOk, let me take a deeper look at it and see if I can remove bad Python uses.",
    "created_at": "2015-11-02T13:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263952",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:7 vdelecroix]:
> Hola Sebastien,

Hola !! Como esta tu en el Chile ahora!?

> Here is an example where `original` is much faster

How did you come up with this example? I mean what should be the heuristic for when using the recursive or the matrices implementation?

> So we should definitely keep it.

I renamed it `'recursive'`.

> For sparsity of matrices I was a bit wrong. 

Ok. I removed the sparse argument.

> Note that the old implementation suffers several problems 

Yes. I have seen that...

> What do you think?

Ok, let me take a deeper look at it and see if I can remove bad Python uses.



---

archive/issue_comments_263953.json:
```json
{
    "body": "Replying to [comment:9 slabbe]:\n> Replying to [comment:7 vdelecroix]:\n> > Hola Sebastien,\n> \n> Hola !! Como esta tu en el Chile ahora!?\n> \n> > Here is an example where `original` is much faster\n> \n> How did you come up with this example? I mean what should be the heuristic for when using the recursive or the matrices implementation?\n\nIf the result is 0 then the recursive version is likely to be much faster. Roughly speaking, for matrices the computational time is independent on the size of the result whereas for the recursive version it is proportional to it.\n\nHowever, the default should definitely be with matrices.\n\n> > So we should definitely keep it.\n> \n> I renamed it `'recursive'`.\n> \n> > Note that the old implementation suffers several problems \n> \n> Yes. I have seen that...\n> \n> > What do you think?\n> \n> Ok, let me take a deeper look at it and see if I can remove bad Python uses.\n\nDoes not matter so much for the sake of this ticket. You can add a comment somewhere that the code can be improved.",
    "created_at": "2015-11-03T02:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263953",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 slabbe]:
> Replying to [comment:7 vdelecroix]:
> > Hola Sebastien,
> 
> Hola !! Como esta tu en el Chile ahora!?
> 
> > Here is an example where `original` is much faster
> 
> How did you come up with this example? I mean what should be the heuristic for when using the recursive or the matrices implementation?

If the result is 0 then the recursive version is likely to be much faster. Roughly speaking, for matrices the computational time is independent on the size of the result whereas for the recursive version it is proportional to it.

However, the default should definitely be with matrices.

> > So we should definitely keep it.
> 
> I renamed it `'recursive'`.
> 
> > Note that the old implementation suffers several problems 
> 
> Yes. I have seen that...
> 
> > What do you think?
> 
> Ok, let me take a deeper look at it and see if I can remove bad Python uses.

Does not matter so much for the sake of this ticket. You can add a comment somewhere that the code can be improved.



---

archive/issue_comments_263954.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-04T08:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263954",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_263955.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-04T08:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263955",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_263956.json:
```json
{
    "body": "Found a new simple way to code it. But, it turns out to be slower. Did other improvements to the code. Folded the 4 commits into a new public branch. Needs review.\n----\nNew commits:",
    "created_at": "2015-11-04T08:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263956",
    "user": "https://github.com/seblabbe"
}
```

Found a new simple way to code it. But, it turns out to be slower. Did other improvements to the code. Folded the 4 commits into a new public branch. Needs review.
----
New commits:



---

archive/issue_comments_263957.json:
```json
{
    "body": "All right. It is possible to compute the matrices *without* computing them ;-) See the attached branch.\n\nVincent\n----\nNew commits:",
    "created_at": "2015-11-04T12:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263957",
    "user": "https://github.com/videlec"
}
```

All right. It is possible to compute the matrices *without* computing them ;-) See the attached branch.

Vincent
----
New commits:



---

archive/issue_comments_263958.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-05T09:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263958",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_263959.json:
```json
{
    "body": "For reviewing purposes, I updated my branch with your code as a fourth algorithm.\n\nI found some cases where the matrices algorithm is faster:\n\n\n```\nsage: u = words.ThueMorseWord()[:10000]\nsage: v = Word([0,1,0,1])\nsage: %time v.nb_subword_occurrences_in(u, 'vincent')\nCPU times: user 214 ms, sys: 38.9 ms, total: 253 ms\nWall time: 233 ms\n26041662500000\nsage: %time v.nb_subword_occurrences_in(u, 'matrices')\nCPU times: user 182 ms, sys: 7.84 ms, total: 190 ms\nWall time: 192 ms\n26041662500000\n```\n\n\n\n```\nsage: u = words.ThueMorseWord()[:100000]\nsage: %time v.nb_subword_occurrences_in(u, 'vincent')\nCPU times: user 2.08 s, sys: 64.7 ms, total: 2.15 s\nWall time: 2.13 s\n260416666250000000\nsage: %time v.nb_subword_occurrences_in(u, 'matrices')\nCPU times: user 1.82 s, sys: 86 ms, total: 1.9 s\nWall time: 1.86 s\n260416666250000000\n```\n\n\nWhy? When is your algorithm faster than the matrix algorithm?\n\nI also found a case where the two algorithms do no return the same answer:\n\n\n```\nsage: v = Word([0,1,0,1,1,0])\nsage: %time v.nb_subword_occurrences_in(u, 'matrices')\nCPU times: user 2.23 s, sys: 72.7 ms, total: 2.31 s\nWall time: 2.27 s\n21700086762157985968744680\nsage: %time v.nb_subword_occurrences_in(u, 'vincent')\nCPU times: user 719 ms, sys: 49 ms, total: 768 ms\nWall time: 742 ms\n21702690928814235968754680L\n```\n\n\nYou might want to use defaultdict instead which simplifies both loops:\n\n\n```python\n# record the position of letters in self\nfrom collections import defaultdict\npos = defaultdict(list)\nfor i,a in enumerate(self):\n    pos[a].append(i)\n\n# compute the occurrences of all prefixes of self as subwords in other\nocc = [0] * (len(self)+1)\nocc[0] = 1\nfor a in other:\n    for i in pos[a]:\n       occ[i+1] += occ[i]\n\n# return only the number of occurrences of self\nreturn occ[-1]\n```\n\n----\nNew commits:",
    "created_at": "2015-11-05T09:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263959",
    "user": "https://github.com/seblabbe"
}
```

For reviewing purposes, I updated my branch with your code as a fourth algorithm.

I found some cases where the matrices algorithm is faster:


```
sage: u = words.ThueMorseWord()[:10000]
sage: v = Word([0,1,0,1])
sage: %time v.nb_subword_occurrences_in(u, 'vincent')
CPU times: user 214 ms, sys: 38.9 ms, total: 253 ms
Wall time: 233 ms
26041662500000
sage: %time v.nb_subword_occurrences_in(u, 'matrices')
CPU times: user 182 ms, sys: 7.84 ms, total: 190 ms
Wall time: 192 ms
26041662500000
```



```
sage: u = words.ThueMorseWord()[:100000]
sage: %time v.nb_subword_occurrences_in(u, 'vincent')
CPU times: user 2.08 s, sys: 64.7 ms, total: 2.15 s
Wall time: 2.13 s
260416666250000000
sage: %time v.nb_subword_occurrences_in(u, 'matrices')
CPU times: user 1.82 s, sys: 86 ms, total: 1.9 s
Wall time: 1.86 s
260416666250000000
```


Why? When is your algorithm faster than the matrix algorithm?

I also found a case where the two algorithms do no return the same answer:


```
sage: v = Word([0,1,0,1,1,0])
sage: %time v.nb_subword_occurrences_in(u, 'matrices')
CPU times: user 2.23 s, sys: 72.7 ms, total: 2.31 s
Wall time: 2.27 s
21700086762157985968744680
sage: %time v.nb_subword_occurrences_in(u, 'vincent')
CPU times: user 719 ms, sys: 49 ms, total: 768 ms
Wall time: 742 ms
21702690928814235968754680L
```


You might want to use defaultdict instead which simplifies both loops:


```python
# record the position of letters in self
from collections import defaultdict
pos = defaultdict(list)
for i,a in enumerate(self):
    pos[a].append(i)

# compute the occurrences of all prefixes of self as subwords in other
occ = [0] * (len(self)+1)
occ[0] = 1
for a in other:
    for i in pos[a]:
       occ[i+1] += occ[i]

# return only the number of occurrences of self
return occ[-1]
```

----
New commits:



---

archive/issue_comments_263960.json:
```json
{
    "body": "Note that infinite words have a cache. So `iter` is much faster the second time...",
    "created_at": "2015-11-05T14:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263960",
    "user": "https://github.com/videlec"
}
```

Note that infinite words have a cache. So `iter` is much faster the second time...



---

archive/issue_comments_263961.json:
```json
{
    "body": "In particular your example where 'vincent' is slower is not an example\n\n```\nsage: v = Word([0,1,0,1])\nsage: u = words.ThueMorseWord()[:100000]\nsage: %time v.nb_subword_occurrences_in(u, 'vincent')\nCPU times: user 428 ms, sys: 20 ms, total: 448 ms\nWall time: 410 ms\n260416666250000000\nsage: %time v.nb_subword_occurrences_in(u, 'vincent')\nCPU times: user 148 ms, sys: 40 ms, total: 188 ms\nWall time: 151 ms\n260416666250000000\nsage: %time v.nb_subword_occurrences_in(u, 'matrices')\nCPU times: user 312 ms, sys: 12 ms, total: 324 ms\nWall time: 297 ms\n260416666250000000\n```\n\nThough, it would be better to make it return Sage integers instead of Python integers.",
    "created_at": "2015-11-05T14:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263961",
    "user": "https://github.com/videlec"
}
```

In particular your example where 'vincent' is slower is not an example

```
sage: v = Word([0,1,0,1])
sage: u = words.ThueMorseWord()[:100000]
sage: %time v.nb_subword_occurrences_in(u, 'vincent')
CPU times: user 428 ms, sys: 20 ms, total: 448 ms
Wall time: 410 ms
260416666250000000
sage: %time v.nb_subword_occurrences_in(u, 'vincent')
CPU times: user 148 ms, sys: 40 ms, total: 188 ms
Wall time: 151 ms
260416666250000000
sage: %time v.nb_subword_occurrences_in(u, 'matrices')
CPU times: user 312 ms, sys: 12 ms, total: 324 ms
Wall time: 297 ms
260416666250000000
```

Though, it would be better to make it return Sage integers instead of Python integers.



---

archive/issue_comments_263962.json:
```json
{
    "body": "Replying to [comment:15 vdelecroix]:\n> Note that infinite words have a cache. So `iter` is much faster the second time...\n\nYou are right. I took attention to this earlier this week but not this morning.\n\nSo we only need to fix the other issue. Maybe I would keep two implementations : yours and the matrices one. The recursive one, we can delete. And the original loop recursive one too I think.",
    "created_at": "2015-11-05T14:43:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263962",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:15 vdelecroix]:
> Note that infinite words have a cache. So `iter` is much faster the second time...

You are right. I took attention to this earlier this week but not this morning.

So we only need to fix the other issue. Maybe I would keep two implementations : yours and the matrices one. The recursive one, we can delete. And the original loop recursive one too I think.



---

archive/issue_comments_263963.json:
```json
{
    "body": "Replying to [comment:17 slabbe]:\n> Replying to [comment:15 vdelecroix]:\n> > Note that infinite words have a cache. So `iter` is much faster the second time...\n> \n> You are right. I took attention to this earlier this week but not this morning.\n> \n> So we only need to fix the other issue. Maybe I would keep two implementations : yours and the matrices one. The recursive one, we can delete. And the original loop recursive one too I think.\n\nWhy would you like to keep the matrices? I am just applying matrices implicitely in mine. These are exactly the same computations except that I am just applying matrices to vectors instead of multiplying matrices together.",
    "created_at": "2015-11-05T14:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263963",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:17 slabbe]:
> Replying to [comment:15 vdelecroix]:
> > Note that infinite words have a cache. So `iter` is much faster the second time...
> 
> You are right. I took attention to this earlier this week but not this morning.
> 
> So we only need to fix the other issue. Maybe I would keep two implementations : yours and the matrices one. The recursive one, we can delete. And the original loop recursive one too I think.

Why would you like to keep the matrices? I am just applying matrices implicitely in mine. These are exactly the same computations except that I am just applying matrices to vectors instead of multiplying matrices together.



---

archive/issue_comments_263964.json:
```json
{
    "body": "If you can change the code and prove that it always gives the same result as the matrices algorithm, then I agree. For now, it does not.",
    "created_at": "2015-11-05T15:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263964",
    "user": "https://github.com/seblabbe"
}
```

If you can change the code and prove that it always gives the same result as the matrices algorithm, then I agree. For now, it does not.



---

archive/issue_comments_263965.json:
```json
{
    "body": "What is your example where it does not?",
    "created_at": "2015-11-05T15:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263965",
    "user": "https://github.com/videlec"
}
```

What is your example where it does not?



---

archive/issue_comments_263966.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-11-05T15:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263966",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_263967.json:
```json
{
    "body": "The code is right now!",
    "created_at": "2015-11-05T15:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263967",
    "user": "https://github.com/videlec"
}
```

The code is right now!



---

archive/issue_comments_263968.json:
```json
{
    "body": "> What is your example where it does not?\n\nThe one in comment:14. But, it should be okay now that you use ZZ.one() and ZZ.zero(). I did not check yet.",
    "created_at": "2015-11-05T19:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263968",
    "user": "https://github.com/seblabbe"
}
```

> What is your example where it does not?

The one in comment:14. But, it should be okay now that you use ZZ.one() and ZZ.zero(). I did not check yet.



---

archive/issue_comments_263969.json:
```json
{
    "body": "5 quick comments after looking at the code:\n\n- I suggest to replace `'vincent'` by `'vector'`.\n- I suggest to change the default argument to `'vector'`.\n- The doctest testing all algorithms should test all algorithms.\n- How many of the four algorithms do we want to keep?\n- If only one, then none of the above comments applies.\n- Maybe better to import defaultdict inside the method?",
    "created_at": "2015-11-05T19:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263969",
    "user": "https://github.com/seblabbe"
}
```

5 quick comments after looking at the code:

- I suggest to replace `'vincent'` by `'vector'`.
- I suggest to change the default argument to `'vector'`.
- The doctest testing all algorithms should test all algorithms.
- How many of the four algorithms do we want to keep?
- If only one, then none of the above comments applies.
- Maybe better to import defaultdict inside the method?



---

archive/issue_comments_263970.json:
```json
{
    "body": "I suggest to keep only one algorithm (now that it is right). The problem did not come from `0` vs `ZZ.zero()` but from the fact that you need the list to be sorted the other way around (I introduced a `list.reverse()`) in my commit).\n\nIt takes time to import inside a method, I would prefer to not do it. But it is possible to import the module `collections` and not `defaultdict`.\n\nThere is an interesant thing with this simple algorithm, it actually computes the number of occurrences of all prefixes of `u` in all prefixes of `v`! But we currently ignore them. People might be interested in more information... but they can also implement that by themselves.",
    "created_at": "2015-11-05T20:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263970",
    "user": "https://github.com/videlec"
}
```

I suggest to keep only one algorithm (now that it is right). The problem did not come from `0` vs `ZZ.zero()` but from the fact that you need the list to be sorted the other way around (I introduced a `list.reverse()`) in my commit).

It takes time to import inside a method, I would prefer to not do it. But it is possible to import the module `collections` and not `defaultdict`.

There is an interesant thing with this simple algorithm, it actually computes the number of occurrences of all prefixes of `u` in all prefixes of `v`! But we currently ignore them. People might be interested in more information... but they can also implement that by themselves.



---

archive/issue_comments_263971.json:
```json
{
    "body": "Replying to [comment:25 vdelecroix]:\n> I suggest to keep only one algorithm (now that it is right). \n\nI agree.\n\n> The problem did not come from `0` vs `ZZ.zero()` but from the fact that you need the list to be sorted the other way around (I introduced a `list.reverse()`) in my commit).\n\nOk, I see! The doctest was fine because 0110 is a palindrome or something? Maybe we should change that first doctest then...\n\n> It takes time to import inside a method, I would prefer to not do it. But it is possible to import the module `collections` and not `defaultdict`.\n\nOK.\n\n> There is an interesant thing with this simple algorithm, it actually computes the number of occurrences of all prefixes of `u` in all prefixes of `v`! But we currently ignore them. People might be interested in more information... but they can also implement that by themselves.\n\nMaybe, we can add a `..NOTE::` about it.",
    "created_at": "2015-11-05T21:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263971",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:25 vdelecroix]:
> I suggest to keep only one algorithm (now that it is right). 

I agree.

> The problem did not come from `0` vs `ZZ.zero()` but from the fact that you need the list to be sorted the other way around (I introduced a `list.reverse()`) in my commit).

Ok, I see! The doctest was fine because 0110 is a palindrome or something? Maybe we should change that first doctest then...

> It takes time to import inside a method, I would prefer to not do it. But it is possible to import the module `collections` and not `defaultdict`.

OK.

> There is an interesant thing with this simple algorithm, it actually computes the number of occurrences of all prefixes of `u` in all prefixes of `v`! But we currently ignore them. People might be interested in more information... but they can also implement that by themselves.

Maybe, we can add a `..NOTE::` about it.



---

archive/issue_comments_263972.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-05T23:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263972",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_263973.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-11-05T23:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263973",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_263974.json:
```json
{
    "body": "Sorry for the last two days, I needed to update my old sage installation on my personnal computer. I tested all of the tests we posted on the ticket. Your implementation is clearly efficient.\n\nI changed the `.. NOTE::` and posted that on `public/19494` overwritting what was there.\n\nIf you agreee with my last commit, then this is a positive review.\n----\nNew commits:",
    "created_at": "2015-11-07T13:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263974",
    "user": "https://github.com/seblabbe"
}
```

Sorry for the last two days, I needed to update my old sage installation on my personnal computer. I tested all of the tests we posted on the ticket. Your implementation is clearly efficient.

I changed the `.. NOTE::` and posted that on `public/19494` overwritting what was there.

If you agreee with my last commit, then this is a positive review.
----
New commits:



---

archive/issue_comments_263975.json:
```json
{
    "body": "To justify my commit: I felt that `one can extract much more information from it rather than only the total number of occurrences` was repeating the information of the first sentence of the note.",
    "created_at": "2015-11-07T13:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263975",
    "user": "https://github.com/seblabbe"
}
```

To justify my commit: I felt that `one can extract much more information from it rather than only the total number of occurrences` was repeating the information of the first sentence of the note.



---

archive/issue_comments_263976.json:
```json
{
    "body": "Good! It is much clearer now.\n\nBy the way, I did remove you from the authors of the ticket and it is not very fair...",
    "created_at": "2015-11-07T13:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263976",
    "user": "https://github.com/videlec"
}
```

Good! It is much clearer now.

By the way, I did remove you from the authors of the ticket and it is not very fair...



---

archive/issue_comments_263977.json:
```json
{
    "body": "Replying to [comment:30 vdelecroix]:\n> Good! It is much clearer now.\n\nOk, so I change it to positive review.\n\n> By the way, I did remove you from the authors of the ticket and it is not very fair...\n\nYou are the author of the best implementation. So, I understood why you changed it. I'm fine either way. Let's say I was the author of the idea of improving the method and some lines of doc!?",
    "created_at": "2015-11-07T21:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263977",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:30 vdelecroix]:
> Good! It is much clearer now.

Ok, so I change it to positive review.

> By the way, I did remove you from the authors of the ticket and it is not very fair...

You are the author of the best implementation. So, I understood why you changed it. I'm fine either way. Let's say I was the author of the idea of improving the method and some lines of doc!?



---

archive/issue_comments_263978.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-07T21:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263978",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_263979.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-08T15:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19257#issuecomment-263979",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_018357.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2015-11-08T15:56:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/19257",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/19257#event-18357"
}
```
