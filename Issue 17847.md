# Issue 17847: Fix bad library uses if var()

archive/issues_017847.json:
```json
{
    "body": "Sage library code should **not** use `var()`!\n\nIssue created by migration from https://trac.sagemath.org/ticket/18084\n\n",
    "created_at": "2015-03-29T19:49:03Z",
    "labels": [
        "symbolics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Fix bad library uses if var()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17847",
    "user": "@jdemeyer"
}
```
Sage library code should **not** use `var()`!

Issue created by migration from https://trac.sagemath.org/ticket/18084





---

archive/issue_comments_239342.json:
```json
{
    "body": "I assume you mean `sage.calculus.calculus.var.var`. Searching the source for `calculus.var` shows that the only files at risk for doing so are:\n\n```\ncalculus/calculus.py:1532:        sage: sage.calculus.calculus.var_cmp(x,x)\ncalculus/calculus.py:1534:        sage: sage.calculus.calculus.var_cmp(x,var('z'))\ncalculus/calculus.py:1536:        sage: sage.calculus.calculus.var_cmp(x,var('a'))\ncalculus/desolvers.py:1162:        from sage.calculus.var import var\nmisc/sageinspect.py:188:       'sage/calculus/var.pyx'\ncrypto/lwe.py:99:from sage.calculus.var import var\nsymbolic/random_tests.py:275:    vars = [(1.0, sage.calculus.calculus.var('v%d' % (n+1))) for n in range(nvars)]\nmatroids/catalog.py:46:from sage.calculus.var import var\ngeometry/riemannian_manifolds/parametrized_surface3d.py:1508:        from sage.calculus.var import var\ngeometry/riemannian_manifolds/parametrized_surface3d.py:1621:        from sage.calculus.var import var\ncombinat/finite_state_machine.py:820:from sage.calculus.var import var\ncombinat/sf/jack.py:38:from sage.calculus.var import var\ncombinat/sf/hall_littlewood.py:28:from sage.calculus.var import var\ncombinat/sf/llt.py:33:from sage.calculus.var import var\ncombinat/sf/macdonald.py:49:from sage.calculus.var import var\n```\n\nunless someone has gone out of their way to obfuscate the incantation.",
    "created_at": "2015-03-29T20:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239342",
    "user": "@nbruin"
}
```

I assume you mean `sage.calculus.calculus.var.var`. Searching the source for `calculus.var` shows that the only files at risk for doing so are:

```
calculus/calculus.py:1532:        sage: sage.calculus.calculus.var_cmp(x,x)
calculus/calculus.py:1534:        sage: sage.calculus.calculus.var_cmp(x,var('z'))
calculus/calculus.py:1536:        sage: sage.calculus.calculus.var_cmp(x,var('a'))
calculus/desolvers.py:1162:        from sage.calculus.var import var
misc/sageinspect.py:188:       'sage/calculus/var.pyx'
crypto/lwe.py:99:from sage.calculus.var import var
symbolic/random_tests.py:275:    vars = [(1.0, sage.calculus.calculus.var('v%d' % (n+1))) for n in range(nvars)]
matroids/catalog.py:46:from sage.calculus.var import var
geometry/riemannian_manifolds/parametrized_surface3d.py:1508:        from sage.calculus.var import var
geometry/riemannian_manifolds/parametrized_surface3d.py:1621:        from sage.calculus.var import var
combinat/finite_state_machine.py:820:from sage.calculus.var import var
combinat/sf/jack.py:38:from sage.calculus.var import var
combinat/sf/hall_littlewood.py:28:from sage.calculus.var import var
combinat/sf/llt.py:33:from sage.calculus.var import var
combinat/sf/macdonald.py:49:from sage.calculus.var import var
```

unless someone has gone out of their way to obfuscate the incantation.



---

archive/issue_comments_239343.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-30T06:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239343",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_239344.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-30T06:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239344",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_239345.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-30T06:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239345",
    "user": "@rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_239346.json:
```json
{
    "body": "Looks good and passes tests in specific main categories.",
    "created_at": "2015-03-30T06:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239346",
    "user": "@rwst"
}
```

Looks good and passes tests in specific main categories.



---

archive/issue_comments_239347.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2015-03-30T17:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239347",
    "user": "@kcrisman"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_239348.json:
```json
{
    "body": "\n```diff\n             sage: Sym = SymmetricFunctions(FractionField(QQ['t'])).macdonald()\n             Traceback (most recent call last):\n             ...\n-            ValueError: parameter q must be in the base ring\n+            TypeError: unable to convert string\n```\n\nIs this a regression in terms of the error message, an improvement, or just a change?  To me it seems more confusing but maybe that's an appropriate message for users of this material.",
    "created_at": "2015-03-30T17:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239348",
    "user": "@kcrisman"
}
```


```diff
             sage: Sym = SymmetricFunctions(FractionField(QQ['t'])).macdonald()
             Traceback (most recent call last):
             ...
-            ValueError: parameter q must be in the base ring
+            TypeError: unable to convert string
```

Is this a regression in terms of the error message, an improvement, or just a change?  To me it seems more confusing but maybe that's an appropriate message for users of this material.



---

archive/issue_comments_239349.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-03-30T20:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239349",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_239350.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> {{{#!diff\n>              sage: Sym = SymmetricFunctions(FractionField(QQ['t'])).macdonald()\n>              Traceback (most recent call last):\n>              ...\n> -            ValueError: parameter q must be in the base ring\n> +            TypeError: unable to convert string\n> }}}\n> Is this a regression in terms of the error message, an improvement, or just a change?\nProbably all three. In any case, the code is more clear, the exception type (`TypeError` instead of `ValueError`) is surely better. The error message is less clear, but that's something which can be fixed independent of this ticket.\n\n(As a personal pet peeve, I really dislike excessive exception raising code. Moreover, I prefer a good traceback over a good error message.)",
    "created_at": "2015-03-30T20:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239350",
    "user": "@jdemeyer"
}
```

Replying to [comment:6 kcrisman]:
> {{{#!diff
>              sage: Sym = SymmetricFunctions(FractionField(QQ['t'])).macdonald()
>              Traceback (most recent call last):
>              ...
> -            ValueError: parameter q must be in the base ring
> +            TypeError: unable to convert string
> }}}
> Is this a regression in terms of the error message, an improvement, or just a change?
Probably all three. In any case, the code is more clear, the exception type (`TypeError` instead of `ValueError`) is surely better. The error message is less clear, but that's something which can be fixed independent of this ticket.

(As a personal pet peeve, I really dislike excessive exception raising code. Moreover, I prefer a good traceback over a good error message.)



---

archive/issue_comments_239351.json:
```json
{
    "body": "`@`kcrisman: I can improve the \"unable to convert string\" error message on a new ticket, but only if somebody (you?) commits to reviewing it.",
    "created_at": "2015-03-30T20:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239351",
    "user": "@jdemeyer"
}
```

`@`kcrisman: I can improve the "unable to convert string" error message on a new ticket, but only if somebody (you?) commits to reviewing it.



---

archive/issue_comments_239352.json:
```json
{
    "body": "Until the end of the semester I can commit to nearly nothing, unfortunately, and in any case I don't know that code at all so I'd be reluctant to say what a \"good\" message would be :-(",
    "created_at": "2015-03-31T01:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239352",
    "user": "@kcrisman"
}
```

Until the end of the semester I can commit to nearly nothing, unfortunately, and in any case I don't know that code at all so I'd be reluctant to say what a "good" message would be :-(



---

archive/issue_comments_239353.json:
```json
{
    "body": "Replying to [comment:9 kcrisman]:\n> Until the end of the semester I can commit to nearly nothing, unfortunately, and in any case I don't know that code at all so I'd be reluctant to say what a \"good\" message would be :-(\nWould you be willing to just accept the change on this ticket then?",
    "created_at": "2015-03-31T03:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239353",
    "user": "@jdemeyer"
}
```

Replying to [comment:9 kcrisman]:
> Until the end of the semester I can commit to nearly nothing, unfortunately, and in any case I don't know that code at all so I'd be reluctant to say what a "good" message would be :-(
Would you be willing to just accept the change on this ticket then?



---

archive/issue_comments_239354.json:
```json
{
    "body": "> Moreover, I prefer a good traceback over a good error message.\nWell, most people who don't know programming would probably prefer the opposite.\n\nActually, upon reading the code I think that this is definitely a regression.  The only reason it complains about a string is because one doesn't do `var('q')`; surely there is a way to check whether the string `'q'` will be a variable in the given ring.  I agree that the way the original code was written is not optimal with such a default, but given that the documentation does directly refer to a parameter `q` (and `t`) this change is not good.  Surely there is some way to at least use\n\n```\nself.q = Sym.base_ring()(q)\n```\n\nor something like it to try to convert the string and then give a sensible error if it's not possible, since this is clearly how it's designed.  The new error message makes it sound like you aren't supposed to use a string, which is manifestly not the case - especially since the string is the *default*!\n\nThat said, I am happy with anything that raises an error that the user can actually understand, so I'm not suggesting one has to go back to the previous.  Perhaps\n\n```\ntry:\n    self.q, self.t do their thing\nexcept TypeError:\n    do something with SR.var\n```\n\nand then all other errors are as they should be, instead of raising the message error as previously.",
    "created_at": "2015-03-31T13:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239354",
    "user": "@kcrisman"
}
```

> Moreover, I prefer a good traceback over a good error message.
Well, most people who don't know programming would probably prefer the opposite.

Actually, upon reading the code I think that this is definitely a regression.  The only reason it complains about a string is because one doesn't do `var('q')`; surely there is a way to check whether the string `'q'` will be a variable in the given ring.  I agree that the way the original code was written is not optimal with such a default, but given that the documentation does directly refer to a parameter `q` (and `t`) this change is not good.  Surely there is some way to at least use

```
self.q = Sym.base_ring()(q)
```

or something like it to try to convert the string and then give a sensible error if it's not possible, since this is clearly how it's designed.  The new error message makes it sound like you aren't supposed to use a string, which is manifestly not the case - especially since the string is the *default*!

That said, I am happy with anything that raises an error that the user can actually understand, so I'm not suggesting one has to go back to the previous.  Perhaps

```
try:
    self.q, self.t do their thing
except TypeError:
    do something with SR.var
```

and then all other errors are as they should be, instead of raising the message error as previously.



---

archive/issue_comments_239355.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-31T13:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239355",
    "user": "@kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_239356.json:
```json
{
    "body": "Replying to [comment:11 kcrisman]:\n> > Moreover, I prefer a good traceback over a good error message.\n> Well, most people who don't know programming would probably prefer the opposite.\nI get your point. In Python 2, this is difficult to get right. In Python 3, there is [https://www.python.org/dev/peps/pep-3134/](https://www.python.org/dev/peps/pep-3134/).",
    "created_at": "2015-03-31T13:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239356",
    "user": "@jdemeyer"
}
```

Replying to [comment:11 kcrisman]:
> > Moreover, I prefer a good traceback over a good error message.
> Well, most people who don't know programming would probably prefer the opposite.
I get your point. In Python 2, this is difficult to get right. In Python 3, there is [https://www.python.org/dev/peps/pep-3134/](https://www.python.org/dev/peps/pep-3134/).



---

archive/issue_comments_239357.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-02T16:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239357",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_239358.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-02T16:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239358",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_239359.json:
```json
{
    "body": "The error message is now\n\n```\nTypeError: unable to evaluate 'q' in Fraction Field of Univariate Polynomial Ring in t over Rational Field\n```\n",
    "created_at": "2015-04-02T16:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239359",
    "user": "@jdemeyer"
}
```

The error message is now

```
TypeError: unable to evaluate 'q' in Fraction Field of Univariate Polynomial Ring in t over Rational Field
```




---

archive/issue_comments_239360.json:
```json
{
    "body": "The change message here lgtm, thanks for updating that.  I'll look briefly at #18110 as well.",
    "created_at": "2015-04-02T16:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239360",
    "user": "@kcrisman"
}
```

The change message here lgtm, thanks for updating that.  I'll look briefly at #18110 as well.



---

archive/issue_comments_239361.json:
```json
{
    "body": "I guess that was all I needed to review - if it still passes tests I have no further objections.",
    "created_at": "2015-04-02T16:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239361",
    "user": "@kcrisman"
}
```

I guess that was all I needed to review - if it still passes tests I have no further objections.



---

archive/issue_comments_239362.json:
```json
{
    "body": "OK, so positive_review modulo #18110.",
    "created_at": "2015-04-02T21:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239362",
    "user": "@jdemeyer"
}
```

OK, so positive_review modulo #18110.



---

archive/issue_comments_239363.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-02T21:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239363",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_239364.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-14T19:43:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17847#issuecomment-239364",
    "user": "@vbraun"
}
```

Resolution: fixed
