# Issue 13012: Some Homset are not unique parents

Issue created by migration from Trac.

Original creator: caruso

Original creation time: 2012-06-29 19:34:52

Assignee: nthiery

CC:  caruso simonking nbruin

Keywords: homset unique parent

I guess it is a bug:


```
sage: k = GF(5) 
sage: H = Hom(k,k)
sage: H2 = Hom(k,k)
sage: H is H2
False
```


I don't know what is the correct way to fix this problem.

More precisely, in sage.categories.homset (l. 223-227), one can read:


```
try:
    # Apparently X._Hom_ is supposed to be cached
    return X._Hom_(Y, category)
except (AttributeError, TypeError):
     pass
```


However, in this particular case, k._Hom_ is apparently not cached. IMHO, caching should be the job of sage.categories.homset.Hom is all cases, but I might be wrong.


---

Attachment

I've attached a small patch fixing the problem.


---

Comment by caruso created at 2012-07-08 09:10:12

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-07-27 20:39:21

Please fill in your real name as Author.


---

Attachment

added .patch to the existing patch so the patchbot picks it up


---

Comment by tscrim created at 2012-12-04 19:05:53

Sage does not run with the patch applied:

```
/home/travis/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/categories/homset.pyc in Hom(X, Y, category)
    239         # To be investigated
    240         H = X._Hom_(Y,category)
--> 241         _cache[key] = weakref.ref(H)
    242         return H
    243     except (AttributeError, TypeError):

NameError: global name 'weakref' is not defined
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```



---

Comment by tscrim created at 2012-12-04 19:05:53

Changing status from needs_review to needs_work.


---

Comment by caruso created at 2012-12-07 10:11:19

Changing status from needs_work to needs_review.


---

Comment by caruso created at 2012-12-07 10:11:19

I don't understand exactly why you got this error.

Nevertheless, I noticed that ticket #11521 was merged in sage-5.5.beta0 resulting in some important modifications in `sage/categories/homset.py`. As a consequence, my patch does not apply in versions >= 5.5.beta0. So, I attach a new patch to apply to these recent versions.


---

Attachment


---

Comment by tscrim created at 2012-12-07 23:46:26

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2012-12-07 23:46:26

Same error. I'm running `5.5.rc0`. The patchbot agreed with me on the previous version as well (all doctests basically fail), and I suspect it will agree with me on the new patch. Do you have any patches applied in your queue, or if are running something before `5.5.rc0`, do you have every patch which modifies `homset.py` applied before the patch in the queue?

Thanks,

Travis

PS - it's generally not a good idea to have periods in your filenames since they are used for extension types; typically people replace them with underscores.

For patchbot:

Apply only: trac_13184_sage_5.5.0.beta.patch


---

Comment by chapoton created at 2013-03-28 21:12:34

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2013-03-28 21:12:34

here is a rebased and slightly modified patch

for the bot:

apply trac_13184_sage_5.9.beta.patch


---

Comment by chapoton created at 2013-03-29 08:22:37

ok, just one little failing doctest, needs to be investigated


---

Comment by chapoton created at 2013-03-29 08:22:37

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2013-03-29 19:39:54

ok, this new patch should pass all tests. Let us wait and see


---

Comment by chapoton created at 2013-03-30 10:36:29

for the bot:

apply trac_13184_sage_5.9.beta.patch


---

Comment by chapoton created at 2013-04-03 19:30:15

ok, the bot is *green*. There now remains the question whether or not this is the right thing to do. 

Any opinion, somebody ?


---

Comment by tscrim created at 2013-04-04 00:05:45

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2013-04-04 00:05:45

I'm cc-ing Simon to see if he can find a memory leak that I couldn't. However it looks good to me.


---

Comment by SimonKing created at 2013-04-04 06:00:42

Is this orthogonal to #14214 and #14279? In any case, I can not review it now, since I am afraid I have to be in holidays.


---

Comment by tscrim created at 2013-04-04 16:13:23

I believe so, however because of the file rename done in #14214, there will be a dependency one way or the other. I'm cc-ing Nils to let him know about this ticket. Enjoy your holiday Simon.

Nils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?

Thanks,

Travis


---

Comment by nbruin created at 2013-04-04 18:32:26

Replying to [comment:18 tscrim]:
> Nils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?

If Simon's away you should probably slide this ticket under there. #14214 doesn't fix a bug, it's an enhancement. And I think it needs a little work.


---

Comment by tscrim created at 2013-04-04 20:34:07

I've made this a dependency of #14214. Thanks Nils.

Frederic, could you change

```
_cache[key] = KeyedRef(H, _cache.eraser, (signed_id(X),signed_id(Y),signed_id(category)))
```

to

```
_cache[key] = H
```

following #14159 (and remove the commented out line following it)? Thanks.


---

Attachment

here is a patch applying above #14159, where I have made the required change

for the bot :  apply trac_13184_sage_5.9.beta.patch


---

Comment by tscrim created at 2013-04-05 12:45:57

Thank you.


---

Comment by tscrim created at 2013-04-05 12:45:57

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-13 13:48:42

Resolution: fixed
