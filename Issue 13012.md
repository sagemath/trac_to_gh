# Issue 13012: Some Homset are not unique parents

archive/issues_013012.json:
```json
{
    "body": "Assignee: @nthiery\n\nCC:  @xcaruso simonking @nbruin\n\nKeywords: homset unique parent\n\nI guess it is a bug:\n\n```\nsage: k = GF(5) \nsage: H = Hom(k,k)\nsage: H2 = Hom(k,k)\nsage: H is H2\nFalse\n```\n\nI don't know what is the correct way to fix this problem.\n\nMore precisely, in sage.categories.homset (l. 223-227), one can read:\n\n```\ntry:\n    # Apparently X._Hom_ is supposed to be cached\n    return X._Hom_(Y, category)\nexcept (AttributeError, TypeError):\n     pass\n```\n\nHowever, in this particular case, k._Hom_ is apparently not cached. IMHO, caching should be the job of sage.categories.homset.Hom is all cases, but I might be wrong.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13184\n\n",
    "created_at": "2012-06-29T19:34:52Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "Some Homset are not unique parents",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13012",
    "user": "https://github.com/xcaruso"
}
```
Assignee: @nthiery

CC:  @xcaruso simonking @nbruin

Keywords: homset unique parent

I guess it is a bug:

```
sage: k = GF(5) 
sage: H = Hom(k,k)
sage: H2 = Hom(k,k)
sage: H is H2
False
```

I don't know what is the correct way to fix this problem.

More precisely, in sage.categories.homset (l. 223-227), one can read:

```
try:
    # Apparently X._Hom_ is supposed to be cached
    return X._Hom_(Y, category)
except (AttributeError, TypeError):
     pass
```

However, in this particular case, k._Hom_ is apparently not cached. IMHO, caching should be the job of sage.categories.homset.Hom is all cases, but I might be wrong.

Issue created by migration from https://trac.sagemath.org/ticket/13184





---

archive/issue_comments_157077.json:
```json
{
    "body": "Attachment [trac_13184_homset_unique_parent](tarball://root/attachments/some-uuid/ticket13184/trac_13184_homset_unique_parent) by @xcaruso created at 2012-07-08 09:09:22\n\nI've attached a small patch fixing the problem.",
    "created_at": "2012-07-08T09:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157077",
    "user": "https://github.com/xcaruso"
}
```

Attachment [trac_13184_homset_unique_parent](tarball://root/attachments/some-uuid/ticket13184/trac_13184_homset_unique_parent) by @xcaruso created at 2012-07-08 09:09:22

I've attached a small patch fixing the problem.



---

archive/issue_comments_157078.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-08T09:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157078",
    "user": "https://github.com/xcaruso"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157079.json:
```json
{
    "body": "Please fill in your real name as Author.",
    "created_at": "2012-07-27T20:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157079",
    "user": "https://github.com/jdemeyer"
}
```

Please fill in your real name as Author.



---

archive/issue_comments_157080.json:
```json
{
    "body": "Attachment [trac_13184.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184.patch) by @saraedum created at 2012-11-22 13:30:59\n\nadded .patch to the existing patch so the patchbot picks it up",
    "created_at": "2012-11-22T13:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157080",
    "user": "https://github.com/saraedum"
}
```

Attachment [trac_13184.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184.patch) by @saraedum created at 2012-11-22 13:30:59

added .patch to the existing patch so the patchbot picks it up



---

archive/issue_comments_157081.json:
```json
{
    "body": "Sage does not run with the patch applied:\n\n```\n/home/travis/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/categories/homset.pyc in Hom(X, Y, category)\n    239         # To be investigated\n    240         H = X._Hom_(Y,category)\n--> 241         _cache[key] = weakref.ref(H)\n    242         return H\n    243     except (AttributeError, TypeError):\n\nNameError: global name 'weakref' is not defined\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n```",
    "created_at": "2012-12-04T19:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157081",
    "user": "https://github.com/tscrim"
}
```

Sage does not run with the patch applied:

```
/home/travis/sage-5.5.rc0/local/lib/python2.7/site-packages/sage/categories/homset.pyc in Hom(X, Y, category)
    239         # To be investigated
    240         H = X._Hom_(Y,category)
--> 241         _cache[key] = weakref.ref(H)
    242         return H
    243     except (AttributeError, TypeError):

NameError: global name 'weakref' is not defined
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```



---

archive/issue_comments_157082.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-12-04T19:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157082",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_157083.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-12-07T10:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157083",
    "user": "https://github.com/xcaruso"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_157084.json:
```json
{
    "body": "I don't understand exactly why you got this error.\n\nNevertheless, I noticed that ticket #11521 was merged in sage-5.5.beta0 resulting in some important modifications in `sage/categories/homset.py`. As a consequence, my patch does not apply in versions >= 5.5.beta0. So, I attach a new patch to apply to these recent versions.",
    "created_at": "2012-12-07T10:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157084",
    "user": "https://github.com/xcaruso"
}
```

I don't understand exactly why you got this error.

Nevertheless, I noticed that ticket #11521 was merged in sage-5.5.beta0 resulting in some important modifications in `sage/categories/homset.py`. As a consequence, my patch does not apply in versions >= 5.5.beta0. So, I attach a new patch to apply to these recent versions.



---

archive/issue_comments_157085.json:
```json
{
    "body": "Attachment [trac_13184_sage_5.5.0.beta.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184_sage_5.5.0.beta.patch) by @xcaruso created at 2012-12-07 10:12:13",
    "created_at": "2012-12-07T10:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157085",
    "user": "https://github.com/xcaruso"
}
```

Attachment [trac_13184_sage_5.5.0.beta.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184_sage_5.5.0.beta.patch) by @xcaruso created at 2012-12-07 10:12:13



---

archive/issue_comments_157086.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-12-07T23:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157086",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_157087.json:
```json
{
    "body": "Same error. I'm running `5.5.rc0`. The patchbot agreed with me on the previous version as well (all doctests basically fail), and I suspect it will agree with me on the new patch. Do you have any patches applied in your queue, or if are running something before `5.5.rc0`, do you have every patch which modifies `homset.py` applied before the patch in the queue?\n\nThanks,\n\nTravis\n\nPS - it's generally not a good idea to have periods in your filenames since they are used for extension types; typically people replace them with underscores.\n\nFor patchbot:\n\nApply only: trac_13184_sage_5.5.0.beta.patch",
    "created_at": "2012-12-07T23:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157087",
    "user": "https://github.com/tscrim"
}
```

Same error. I'm running `5.5.rc0`. The patchbot agreed with me on the previous version as well (all doctests basically fail), and I suspect it will agree with me on the new patch. Do you have any patches applied in your queue, or if are running something before `5.5.rc0`, do you have every patch which modifies `homset.py` applied before the patch in the queue?

Thanks,

Travis

PS - it's generally not a good idea to have periods in your filenames since they are used for extension types; typically people replace them with underscores.

For patchbot:

Apply only: trac_13184_sage_5.5.0.beta.patch



---

archive/issue_comments_157088.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-28T21:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157088",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_157089.json:
```json
{
    "body": "here is a rebased and slightly modified patch\n\nfor the bot:\n\napply trac_13184_sage_5.9.beta.patch",
    "created_at": "2013-03-28T21:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157089",
    "user": "https://github.com/fchapoton"
}
```

here is a rebased and slightly modified patch

for the bot:

apply trac_13184_sage_5.9.beta.patch



---

archive/issue_comments_157090.json:
```json
{
    "body": "ok, just one little failing doctest, needs to be investigated",
    "created_at": "2013-03-29T08:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157090",
    "user": "https://github.com/fchapoton"
}
```

ok, just one little failing doctest, needs to be investigated



---

archive/issue_comments_157091.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-29T08:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157091",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_157092.json:
```json
{
    "body": "ok, this new patch should pass all tests. Let us wait and see",
    "created_at": "2013-03-29T19:39:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157092",
    "user": "https://github.com/fchapoton"
}
```

ok, this new patch should pass all tests. Let us wait and see



---

archive/issue_comments_157093.json:
```json
{
    "body": "for the bot:\n\napply trac_13184_sage_5.9.beta.patch",
    "created_at": "2013-03-30T10:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157093",
    "user": "https://github.com/fchapoton"
}
```

for the bot:

apply trac_13184_sage_5.9.beta.patch



---

archive/issue_comments_157094.json:
```json
{
    "body": "ok, the bot is **green**. There now remains the question whether or not this is the right thing to do. \n\nAny opinion, somebody ?",
    "created_at": "2013-04-03T19:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157094",
    "user": "https://github.com/fchapoton"
}
```

ok, the bot is **green**. There now remains the question whether or not this is the right thing to do. 

Any opinion, somebody ?



---

archive/issue_comments_157095.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-04T00:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157095",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_157096.json:
```json
{
    "body": "I'm cc-ing Simon to see if he can find a memory leak that I couldn't. However it looks good to me.",
    "created_at": "2013-04-04T00:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157096",
    "user": "https://github.com/tscrim"
}
```

I'm cc-ing Simon to see if he can find a memory leak that I couldn't. However it looks good to me.



---

archive/issue_comments_157097.json:
```json
{
    "body": "Is this orthogonal to #14214 and #14279? In any case, I can not review it now, since I am afraid I have to be in holidays.",
    "created_at": "2013-04-04T06:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157097",
    "user": "https://github.com/simon-king-jena"
}
```

Is this orthogonal to #14214 and #14279? In any case, I can not review it now, since I am afraid I have to be in holidays.



---

archive/issue_comments_157098.json:
```json
{
    "body": "I believe so, however because of the file rename done in #14214, there will be a dependency one way or the other. I'm cc-ing Nils to let him know about this ticket. Enjoy your holiday Simon.\n\nNils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?\n\nThanks,\n\nTravis",
    "created_at": "2013-04-04T16:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157098",
    "user": "https://github.com/tscrim"
}
```

I believe so, however because of the file rename done in #14214, there will be a dependency one way or the other. I'm cc-ing Nils to let him know about this ticket. Enjoy your holiday Simon.

Nils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?

Thanks,

Travis



---

archive/issue_comments_157099.json:
```json
{
    "body": "Replying to [comment:18 tscrim]:\n> Nils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?\n\n\nIf Simon's away you should probably slide this ticket under there. #14214 doesn't fix a bug, it's an enhancement. And I think it needs a little work.",
    "created_at": "2013-04-04T18:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157099",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:18 tscrim]:
> Nils, what is the review status of #14214 and it's dependency #14159, and perhaps you can find a memory leak that I didn't?


If Simon's away you should probably slide this ticket under there. #14214 doesn't fix a bug, it's an enhancement. And I think it needs a little work.



---

archive/issue_comments_157100.json:
```json
{
    "body": "I've made this a dependency of #14214. Thanks Nils.\n\nFrederic, could you change\n\n```\n_cache[key] = KeyedRef(H, _cache.eraser, (signed_id(X),signed_id(Y),signed_id(category)))\n```\nto\n\n```\n_cache[key] = H\n```\nfollowing #14159 (and remove the commented out line following it)? Thanks.",
    "created_at": "2013-04-04T20:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157100",
    "user": "https://github.com/tscrim"
}
```

I've made this a dependency of #14214. Thanks Nils.

Frederic, could you change

```
_cache[key] = KeyedRef(H, _cache.eraser, (signed_id(X),signed_id(Y),signed_id(category)))
```
to

```
_cache[key] = H
```
following #14159 (and remove the commented out line following it)? Thanks.



---

archive/issue_comments_157101.json:
```json
{
    "body": "Attachment [trac_13184_sage_5.9.beta.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184_sage_5.9.beta.patch) by @fchapoton created at 2013-04-05 08:49:44\n\nhere is a patch applying above #14159, where I have made the required change\n\nfor the bot :  apply trac_13184_sage_5.9.beta.patch",
    "created_at": "2013-04-05T08:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157101",
    "user": "https://github.com/fchapoton"
}
```

Attachment [trac_13184_sage_5.9.beta.patch](tarball://root/attachments/some-uuid/ticket13184/trac_13184_sage_5.9.beta.patch) by @fchapoton created at 2013-04-05 08:49:44

here is a patch applying above #14159, where I have made the required change

for the bot :  apply trac_13184_sage_5.9.beta.patch



---

archive/issue_comments_157102.json:
```json
{
    "body": "Thank you.",
    "created_at": "2013-04-05T12:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157102",
    "user": "https://github.com/tscrim"
}
```

Thank you.



---

archive/issue_comments_157103.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-05T12:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157103",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_036336.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-05T13:35:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "milestone": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13012#event-36336"
}
```



---

archive/issue_events_036337.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-13T13:48:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13012#event-36337"
}
```



---

archive/issue_comments_157104.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-13T13:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13012",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13012#issuecomment-157104",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
