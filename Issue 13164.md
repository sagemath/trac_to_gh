# Issue 13164: farey_symbol.pyx fails to build on Cygwin

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2012-08-04 08:52:06

Assignee: tbd

Missing gmpxx and gmp dependencies and use of --enable-auto-import for the linker.


---

Comment by dimpase created at 2012-08-04 11:32:35

with these flags on, I still get

```
g++ -shared -Wl,--enable-auto-image-base -L/home/Dima/sage-5.2.rc1/local/lib build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/sl2z.o -L/home/Dima/sage-5.2.rc1/local/lib -L/home/Dima/sage-5.2.rc1/local/lib/python2.7/config -lcsage -lgmp -lgmpxx -lstdc++ -lntl -lpython2.7 -o build/lib.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey_symbol.dll -Wl,--enable-auto-import
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK18is_element_general9is_memberERK4SL2Z':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:183: undefined reference to `__imp__convert_to_SL2Z'
[... etc ...]
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:655: undefined reference to `__imp__convert_to_cusp'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol13get_fractionsEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:664: undefined reference to `__imp__convert_to_rational'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `_ZNK11FareySymbol20get_pairing_matricesEv':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:705: undefined reference to `__imp__convert_to_SL2Z'
build/temp.cygwin-1.7.16-i686-2.7/sage/modular/arithgroup/farey.o: In function `is_element_GammaH':
/home/Dima/sage-5.2.rc1/devel/sage/sage/modular/arithgroup/farey.cpp:132: undefined reference to `__imp__convert_to_long'
collect2: ld returned 1 exit status
```

So it looks like that the linker cannot find objects which are part of the Farey module (i.e. from sl2z.o, etc)?! 

Looks like some g++/dll linking weirdness to me.


---

Comment by jpflori created at 2012-08-04 18:44:54

Yes...
In fact we'll get the same problem later with the wrapper_* things in ext/interpreter.

What's strange is that I don't remember getting it here the last time.
But I kind of so much tweaked the files back then that it must have been that as well.

I think the problem is as follows:
As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
But when you want to directly link farey_symbol.o and farey.o together, ld whines...


---

Comment by jpflori created at 2012-08-04 18:45:28

And obviously I've deleted my 5.1.rc1 install so I have to figure out what let the files compile the last time :)


---

Comment by jpflori created at 2012-08-04 19:01:18

Replying to [comment:2 jpflori]:
> I think the problem is as follows:
> As convert_* are declared extern in farey_symbol.h (from the public modifier in farey_symbol.pyx) g++ adds _ _ imp _ _ prefixes in farey.o.
> Then if you actually build a dll of farey_symbol.cpp alone and link a dll of farey.o alone to it ld is fine.
> But when you want to directly link farey_symbol.o and farey.o together, ld whines...

This seems to be the problem.
If you remove the DL_IMPORT lines in farey_symbol.h (generated by Cython), you'll link correctly.

I've got some ideas from here:
http://stackoverflow.com/questions/3704374/linking-error-lnk2019-in-msvc-unresolved-symbols-with-imp-prefix-but-shoul


---

Comment by jpflori created at 2012-08-04 19:06:42

Patch coming.


---

Attachment

Fix linking problem.


---

Comment by jpflori created at 2012-08-04 19:10:29

Changing keywords from "" to "cygwin linking".


---

Comment by jpflori created at 2012-08-04 19:10:29

Changing status from new to needs_review.


---

Comment by dimpase created at 2012-08-05 03:51:32

OK, this does the trick here. I'll give it a positive review as soon as the patchbot gives OK.
The next stop looks like a ginac-related problem at #13337


---

Comment by dimpase created at 2012-08-08 04:10:59

Looks good.


---

Comment by dimpase created at 2012-08-08 04:10:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-08-12 19:02:44

Resolution: fixed


---

Comment by jdemeyer created at 2017-05-15 16:43:04

Real Cython fix in #23004.
