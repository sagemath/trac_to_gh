# Issue 23676: Doctest failures with GMP

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-09-21 13:42:52

CC:  fbissey mderickx

With GMP is used instead of MPIR, there are two doctest failures because of error checking that GMP does but MPIR does not:

```
**********************************************************************
File "src/sage/rings/integer.pyx", line 6099, in sage.rings.integer.Integer._shift_helper
Failed example:
    1 << (2^60)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```

and

```
sage -t --warn-long 61.3 src/sage/ext/memory.pyx
**********************************************************************
File "src/sage/ext/memory.pyx", line 9, in sage.ext.memory
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes  
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.ext.memory[0]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "sage/rings/integer.pyx", line 2067, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14173)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
```

Upstream GMP provides no way to hook this error: https://gmplib.org/list-archives/gmp-discuss/2017-September/006144.html


---

Comment by mderickx created at 2017-09-25 20:23:58

Since both mpir and gmp are optional packages couldn't we also implement a fix by having


```
2^(2^63-2) #optional mpir
some error
2^(2^63-2) #optional gmp
another error
```


in the mean time? If someone here at this ticket thinks that it is a good idea, then I will create a ticket with the relatively easy patch for it.


---

Comment by fbissey created at 2017-09-25 20:34:28

That's an interesting idea considering that by default tests are run with `--optional=mpir,python2,sage` so the default behavior isn't changed. But I am not sure what happens when `gmp` is selected. But I think that is a good approach.


---

Comment by mderickx created at 2017-09-25 21:06:31

The default argument for optional is actually determined programmatically. `sage` is always there and the rest is just a list of optional packages. It just happens that python2 and mpir are optional packages that are installed by default. If you would build sage with python3 and gmp instead it will be `--optional=gmp,python3,sage` instead.


---

Comment by fbissey created at 2017-09-25 21:08:10

I was not sure of the mechanics but it makes sense for it be that way. Your solution should work. I'll be waiting to see your suggested branch.


---

Comment by mderickx created at 2017-09-26 21:29:25

Ok, I created a branch with how I think the fix should look like. But I did not put it to needs review yet because I do not understand how to check that it works, the main problem is that I do not now how to properly build sage with gmp.

I tried just:

```
sage -i gmp
```

in a sage that was already build since I was hoping to save time, but this does not work (it is running the optional gmp test and not the mpir one, but the test result is that of mpir). Should I do:

```
sage -i gmp
make build
```

Or do I need to do:

```
make distclean
make gmp 
make build
```

----
New commits:


---

Comment by fbissey created at 2017-09-26 21:34:41

I am not sure from an existing sage I am afraid, rebuilding is necessary and there could be stray libraries in the way. It would better and much cleaner - but unfortunately more time consuming - to do

```
./configure --with-mp=gmp
make
```



---

Comment by mderickx created at 2017-09-26 21:36:21

Changing status from new to needs_info.


---

Comment by mderickx created at 2017-09-26 21:44:45

I got an error that configure was not found in a clean install, so I had to do


```
make configure
./configure --with-mp=gmp
make
```


I am now building and waiting for how the tests turn out. If you already have an install with gmp lying around and you test this branch there then you will probably know the results before I do.


---

Comment by mderickx created at 2017-09-26 21:44:45

Changing status from needs_info to needs_work.


---

Attachment


---

Comment by mderickx created at 2017-09-26 22:00:08

The commands:

```
make configure
./configure --with-mp=gmp
make
```

resulted in the failure building of mpfr on OS X 10.12.4 with Xcode 8.3.3 before gcc was build. I've attached the log, so I still don't know how to test it on this machine. I can test it on Ubuntu tomorrow.


---

Comment by fbissey created at 2017-09-26 22:01:23

That's still a problem thanks for pointing it out. We didn't notice it on the `gmp` upgrade ticket but we should have.


---

Comment by fbissey created at 2017-09-26 22:09:48

Ok, I have now noticed something. You are not using the latest `gmp` from the `gmp` upgrade ticket. It would be best if that was the case. Since it is not in a beta yet you should depend on #19706 and merge its branch with the one in this ticket. It looks like there is an issue with the produced libgmp with your version of xcode and it is quite possible it is fixed by the gmp version of #19706.


---

Comment by mderickx created at 2017-09-26 23:15:56

It took me longer then it should to figure out how to pull #19706, but it now works and gets me past mpfr. The build is now at the point of building gcc.  I'll report back tomorrow.


---

Comment by fbissey created at 2017-09-26 23:17:14

Good, that means that `gmp` before the upgrade was broken on OS X anyway, so it was high time to upgrade it.


---

Comment by jdemeyer created at 2017-09-27 09:11:20

Your patch makes sense, but you will need to special-case 32-bit. I'm pretty sure that the 32-bit result is an `OverflowError` both with `mpir` and with `gmp`.


---

Comment by mderickx created at 2017-09-27 17:30:57

Thanks for pointing this out, I am now building sage with the gmp from #19706 on a 32bit machine as well to see what the exact error message looks like.


---

Comment by jdemeyer created at 2017-09-27 17:33:44

The `OverflowError` is raised by Cython, so it would be the same for `mpir` and `gmp`.


---

Comment by git created at 2017-09-28 00:38:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mderickx created at 2017-09-28 01:02:24

Changing status from needs_work to needs_review.


---

Comment by mderickx created at 2017-09-28 01:02:24

Ok, I tested the current branch on:

- 32-bit gmp + #19706
- 32-bit mpir
- 64-bit mpir

I still need to test 64-bit gmp + #19706 since the build on my laptop got interrupted a few times, I think it should pass but I am not 100% sure. I am hesitant to put it into needs review before I know this case passes, however if either of you can verify that this case also passes then feel free to review this ticket.

I don't think this ticket needs a dependency on #19706 since it merges cleanly with it.


---

Comment by mderickx created at 2017-09-28 04:29:31

Ok the case: 64-bit gmp + #19706 failed.  I didn't realise that the doctesting framework only sees errors as errors if the error is thrown on the first line.

So the expected/got in 

```
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate ... bytes   
Got:
    gmp: overflow in mpz type
    Traceback (most recent call last):
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/jdemeyer/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer._shift_helper[8]>", line 1, in <module>
        Integer(1) << (Integer(2)**Integer(60))
      File "sage/rings/integer.pyx", line 6177, in sage.rings.integer.Integer.__lshift__ (build/cythonized/sage/rings/integer.c:39270)
        return (<Integer>x)._shift_helper(y, 1)
      File "sage/rings/integer.pyx", line 6138, in sage.rings.integer.Integer._shift_helper (build/cythonized/sage/rings/integer.c:39014)
        sig_on()
    RuntimeError: Aborted
```

Is a bit misleading since for the passing doctest for this is without the "gmp: overflow in mpz type" line.

```
    Traceback (most recent call last):
    ...
    RuntimeError: Aborted
```

anyway. It now passes in all 4 cases for me, so ready for review.
----
New commits:


---

Comment by jdemeyer created at 2017-09-28 20:34:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-01 00:18:58

Resolution: fixed
