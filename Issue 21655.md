# Issue 21655: Memory leak in BooleanPolynomialRing

Issue created by migration from https://trac.sagemath.org/ticket/21892

Original creator: nbruin

Original creation time: 2016-11-17 23:06:12

CC:  simonking jpflori asante

From https://ask.sagemath.org/question/35623/memory-leak-when-doing-anf-of-boolean-functions/ :

```
sage: import gc
....: BPR=sage.rings.polynomial.pbori.BooleanPolynomialRing
....: print "PBR objects:",len([a for a in gc.get_objects() if type(a) is BPR])
....: for i in range(1,51):
....:   B=BooleanPolynomialRing(i,"x")
....: del B
....: _=gc.collect()
....: print "PBR objects:",len([a for a in gc.get_objects() if type(a) is BPR])
PBR objects: 0
PBR objects: 50
```

These objects leak.


---

Comment by nbruin created at 2016-11-17 23:24:55

The problem is that upon creation:

```
    B=BooleanPolynomialRing(3,"x")
```

the code

```
    self._monom_monoid = BooleanMonomialMonoid(self)
```

is executed. A `BooleanMonomialMonoid` is `UniqueRepresentation`, so `B` goes as a key into a global `WeakValueDictionary`, with value the monoid `M`. So `B` will not be garbage collected while `M` exists (the strong reference in the global dict will only be erased on the weakvalue callback upon M's deallocation)

But `B` stores a reference to `M` in `B._nomom_monoid`, so `M` will not be deallocated until `B` is deallocated. Hence, the memory leak.

Possible strategies:
 - Remove `UniqueRepresentation` from `BooleanMonomialMonoid`. I don't think there are any drawback from this solution.
 - remove the strong reference `B._nomom_monoid` and instead rely on the `UniqueRepresention` property to reconstruct the thing every time. I suspect this will slow things down.
 - change the construction parameters of `BooleanMonomialMonoid` to be just strings etc. and not refer to `B` at all. This is easy to get wrong.

By the way, the code from the asksage question referred to unovers the following additional bug, which made the memory leak noticeable.

`sage.rings.polynomial.pbori.BooleanPolynomialRing` is not `UniqueRepresentation` and instead relies on `sage.rings.polynomial.polynomial_ring_constructor.BooleanPolynomialRing_constructor` to get uniqueness. 

In 
`sage.crypto.boolean_function.BooleanFunction.algebraic_normal_form`
the class is called directly, so we end up with many equal-but-not-identical rings (which is not a problem in its own right)


---

Comment by nbruin created at 2016-11-18 03:58:23

Changing type from PLEASE CHANGE to defect.


---

Comment by nbruin created at 2016-11-18 03:58:23

Changing component from PLEASE CHANGE to memleak.


---

Comment by nbruin created at 2016-11-18 03:58:23

As it turns out, the `UniqueRepresentation` was introduced to solve a pickling problem:

https://trac.sagemath.org/ticket/9138#comment:46

It seems that removing the `UniqueRepresentation` only makes the pickling problems reappear, so if we can find a different solution for the pickling problem we might be good to go.

CC-ing the author of #9138, Simon. Perhaps he remembers an alternative.


---

Comment by tscrim created at 2016-11-18 15:51:48

So if we remove the `UniqueRepresentation` behavior from the `BooleanMonomialMonoid`, we would probably have to manually implement some form of pickling.

Actually, from a quick glance through the code, I don't see a point to having `BooleanMonomialMonoid`, we are not really using that it is a parent. We essentially just need the element class and we can mimic what we do for usual polynomials, have `monomials()` return elements in the polynomial ring. It's more work to fix, but I think the net result will be much cleaner and simpler code. It shouldn't result in a slowdown unless you are using `monomials` or iterating over polynomials, and even then, it shouldn't have a noticeable effect...


---

Comment by nbruin created at 2017-05-17 13:20:13

Dupe of #14549 ?

Perhaps we should just merge the branch there and leave this ticket.


---

Comment by nbruin created at 2017-05-17 13:20:13

Changing status from new to needs_review.


---

Comment by nbruin created at 2017-05-17 13:24:41

Changing status from needs_review to needs_info.


---

Comment by asante created at 2017-05-17 13:29:58

+1 for merging that #14549 branch and leaving this ticket for the "real" fix.


---

Comment by asante created at 2018-02-16 11:17:02

So just to make this clear:

The favorable solution is what tcsrim above writes:
Remove `BooleanMonomialMonoid` and replace it with the default behavior of other Polynomial classes?


---

Comment by asante created at 2018-02-16 11:17:02

Changing status from needs_info to needs_work.


---

Comment by asante created at 2018-06-29 08:55:13

Set assignee to asante.


---

Comment by asante created at 2018-06-29 08:55:13

Changing keywords from "" to "memory leak, BooleanFunction, days94".


---

Comment by asante created at 2018-06-29 08:55:13

New commits:


---

Comment by mathzeta2 created at 2018-06-29 13:39:16

Small stylistic corrections in convert_to_pE:
1. "definig" should be "defining".
1. ``p = cE.get_pc()`` should be ```p = cE.get_pc()```
1. I think that English prefers "vice versa" over "viceversa", unlike Italian or Spanish.

In lift_to_polynomial() and lift_to_polynomial_rational_reconstruction() "poly" seems weird. Maybe just "Compute a lift to a polynomial ring `R` using rational reconstruction."
Also "recontruction" should be "reconstruction", and ``self`` should be ```self``` in few places.

In both gcd() methods the default value for the algorithm keyword should come first:

```
    - ``pari`` - use pari routines.
    - ``modular`` - (default) modular algorithm using NTL.
```


In Polynomial_absolute_number_field_dense at

```
raise ValueError("unknown algorithm %s" % (algorithm))
```

The string format should be `(algorithm, )`.


---

Comment by asante created at 2018-06-29 15:45:52

Replying to [comment:11 mathzeta2]:
> Small stylistic corrections in convert_to_pE:
> 
> [...]
> 
> The string format should be `(algorithm, )`.

Err.. does this ended up in a wrong ticket? I cannot find anything of the above mentioned in `src/sage/rings/polynomial/pbori.pyx`.


---

Comment by git created at 2018-06-29 15:51:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2018-06-29 16:04:57

After discussing with Travis again, we decided that it's best not to remove `BooleanMonomialMonoid`, as it looks like its often used implicitly in the code.

Instead we decided to do the following:
 * `BooleanPolynomialRing_constructor` should create the `BooleanMonomialMonoid` and pass a reference of this object to `BooleanPolynomialRing.__init__` (replacing the `n` and `names` arguments).
 * `BooleanPolynomialRing` stores this reference, instead of creating the `BooleanMonomialMonoid` itself.
 * Delete the reference to `BooleanPolynomialRing` from `BooleanMonomialMonoid` and thus rewrite all lines where this reference is used.
 * To clean things up, move the caching done in `BooleanPolynomialRing_constructor` to `BooleanPolynomialRing.__init__`.


---

Comment by asante created at 2018-07-26 10:02:46

Remove assignee asante.


---

Comment by asante created at 2018-07-26 10:02:46

At the moment, this ticket is a bit above my head.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4
