# Issue 14979: Parking functions reject their offspring

Issue created by migration from Trac.

Original creator: darij

Original creation time: 2013-09-22 01:44:50

CC:  tscrim sage-combinat zabrocki slelievre

Keywords: sage-combinat, parking function, combinatorialclass


```
sage: [1,1,1] in ParkingFunctions(3)
True
sage: ParkingFunctions(3)([1,1,1]) in ParkingFunctions(3)
False
sage: ParkingFunctions(3)([1,1,1]) in ParkingFunctions()
False
sage: ParkingFunctions()([1,1,1]) in ParkingFunctions()
False
sage: ParkingFunctions(3)(ParkingFunctions(3)([1,1,1]))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-57-e5b6b3a9c099> in <module>()
----> 1 ParkingFunctions(Integer(3))(ParkingFunctions(Integer(3))([Integer(1),Integer(1),Integer(1)]))

/home/darij/sage-5.12.beta5/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __call__(self, x)
   1371             return self._element_constructor_(x)
   1372         else:
-> 1373             raise ValueError, "%s not in %s"%(x, self)
   1374 
   1375     Element = CombinatorialObject # mostly for backward compatibility

ValueError: [1, 1, 1] not in Parking functions of size 3
sage: ParkingFunctions()(ParkingFunctions()([1,1,1]))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-58-39833821920e> in <module>()
----> 1 ParkingFunctions()(ParkingFunctions()([Integer(1),Integer(1),Integer(1)]))

/home/darij/sage-5.12.beta5/local/lib/python2.7/site-packages/sage/combinat/combinat.pyc in __call__(self, x)
   1371             return self._element_constructor_(x)
   1372         else:
-> 1373             raise ValueError, "%s not in %s"%(x, self)
   1374 
   1375     Element = CombinatorialObject # mostly for backward compatibility

ValueError: [1, 1, 1] not in Parking functions
```


Also, the docstring of `ParkingFunction` is wrong; this method returns elements, not the class.

The call `ParkingFunction([1]).diagonal_reading_word()` results in a ValueError; I don't think it should. That, and its docstring shouldn't refer to its pretty print for the definition.

Travis, are you planning to give `parking_function.py` the #12913 treatment?


---

Comment by tscrim created at 2013-09-27 22:49:07

At some point I'll give it the #12913 treatment (it needs it), but not anytime soon I think. So if someone else wants to do it, I can offer wisdom and reviews.


---

Comment by chapoton created at 2014-07-02 14:54:10

see also #16595


---

Comment by elixyre created at 2014-07-09 04:13:39

New commits:


---

Comment by chapoton created at 2014-07-19 13:24:08

needs rebase, and coordination with #16595


---

Comment by elixyre created at 2014-09-22 14:18:40

New commits:


---

Comment by elixyre created at 2014-09-22 14:23:06

I'm really not sure about what i did... There is no conflict in *parking_functions.py* and each tests seems to be ok but... I don't understand what's append with others files (I did not touch).

Cheers,
Jean-Baptiste


---

Comment by chapoton created at 2021-03-23 19:47:35

Here is a new tentative. Travis, I need your help for the 2 remaining doctest failures in TestSuite, please.
----
New commits:


---

Comment by tscrim created at 2021-03-23 23:01:50

My guess is the problem is elements aren't being created with the right parent:
`ParkingFunctions_all.__iter__`: (I also prefer to avoid iteration over `NN` as it is simple to implement)

```diff
-        for n in NN:
-            yield from ParkingFunctions_n(n).__iter__()
+        n = 0
+        while True:
+            for pf in ParkingFunctions_n(n):
+                yield self.element_class(self, list(pf))
+            n += 1
```

`ParkingFunctions_n.__iter__`:

```diff
-yield ParkingFunction(list(pi))
+yield self.element_class(self, list(pi))
```

`ParkingFunctions_n.random_element`:

```diff
-return ParkingFunction([(i - free[0]).lift() for i in fun])
+return self.element_class(self, [(i - free[0]).lift() for i in fun])
```


Also, in `ParkingFunction`, this is bad:

```
    if pf is not None:
        return ParkingFunction_class(None, pf)
```

Everything should have a parent.

One drawback is that parking functions for different parents will not be comparable (unless a coercion is implemented); in particular for the `all` and the `n` parents.


---

Comment by git created at 2021-03-24 10:22:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-03-24 10:22:54

ok, things seem to be working now. Thanks a lot for your help !


---

Comment by chapoton created at 2021-03-24 10:50:12

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-03-24 17:22:52

green bot, please review


---

Comment by tscrim created at 2021-03-24 21:30:30

A few last little details:

This is (still) bad:

```
+    return ParkingFunction_class(None,
+                                 [L.index(i) + 1 - D[L.index(i)]
                                   for i in range(1, len(L) + 1)])
```

You could construct a parent (probably all parking functions) and pass the list to that.

`def __repr__` -> `def _repr_`

It is better to put `UniqueRepresentation` before `Parent` in the MRO so the equality/hashing/etc. is called earlier.

`.. warning::` -> `.. WARNING::`

Something that I prefer is to not have a separate function `ParkingFunction` and element class `ParkingFunction_class`, but instead just have a `ParkingFunction` class that uses `__classcall_private__` for direct construction (see, e.g., `Partition`). I think this is less confusing for the user and is a more logical grouping (at the small expense of an indirection for someone new to the code/mechanism). I can do this if you want.


---

Comment by git created at 2021-03-25 06:27:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-25 06:53:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-03-25 06:56:17

Thanks, Travis.

I would rather postpone further refactoring to another ticket. Unless you are really motivated to do the job, of course.

Calling `ParkingFunction_class` with `None` as parent will set a correct parent automatically, namely `ParkingFunctions_n`. So in my mind, it is not so bad.


---

Comment by git created at 2021-03-25 07:20:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-03-27 12:16:41

green bot. Travis, please ?


---

Comment by tscrim created at 2021-03-27 21:50:46

I am motivated to make a few other changes I mentioned. I will be doing this tomorrow. I feel it is easier to do this in one go.


---

Comment by tscrim created at 2021-03-29 07:24:10

Okay, I did the refactoring. I think this becomes a lot easier for users because then they can do `if isinstance(PF, ParkingFunction)` and not wonder why this is always `False`. This also gives consistent documentation.

I also fixed a bug with the containment check.

Cleanup-wise, I fixed another `.. warning::`, removed `self` as an input, and a few other 80 chars/line.

If all of my changes are good, then you can set a positive review.
----
New commits:


---

Comment by chapoton created at 2021-03-29 11:54:36

This seems to break something in the findstat interface


---

Comment by git created at 2021-03-29 16:53:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-03-29 19:00:17

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-03-29 19:00:17

ok, bot is green, good to go


---

Comment by tscrim created at 2021-03-30 00:05:06

Thank you for fixing that!


---

Comment by vbraun created at 2021-05-27 20:30:41

Resolution: fixed
