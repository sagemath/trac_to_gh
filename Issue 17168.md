# Issue 17168: solve_right with matrix right hand side fails over RDF and CDF

archive/issues_017168.json:
```json
{
    "body": "Solving `AX=B` for a matrix `B` using `solve_right` or `\\` works over many rings, but not `RDF` or `CDF`. Example:\n\n\n```\nsage: MatrixSpace(QQ,10,10,).random_element() \\ MatrixSpace(QQ,10,1).random_element()\n[   -783/1145]\n[ 15697/18320]\n[ -4647/18320]\n[  -2599/7328]\n[ 20289/73280]\n[ -3791/18320]\n[-70107/36640]\n[-12407/36640]\n[  -1588/1145]\n[  -7059/9160]\nsage: MatrixSpace(RR,10,10,).random_element() \\ MatrixSpace(RR,10,1).random_element()\n[ 0.0620590489221758]\n[ -0.584548090301576]\n[ -0.106165379993850]\n[   1.52004291094317]\n[  -1.03573096808637]\n[ 0.0822404955372452]\n[ -0.145002162865055]\n[  0.262055581969539]\n[   1.35298542346484]\n[-0.0727293754429877]\nsage: MatrixSpace(RDF,10,10,).random_element() \\ MatrixSpace(RDF,10,1).random_element()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-16-0286e0222123> in <module>()\n----> 1 MatrixSpace(RDF,Integer(10),Integer(10),).random_element()  * BackslashOperator() * MatrixSpace(RDF,Integer(10),Integer(1)).random_element()\n\n/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/misc/preparser.pyc in __mul__(self, right)\n   1413             (0.0, 0.5, 1.0, 1.5, 2.0)\n   1414         \"\"\"\n-> 1415         return self.left._backslash_(right)\n   1416 \n   1417 \n\n/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix._backslash_ (build/cythonized/sage/matrix/matrix2.c:4193)()\n\n/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/matrix/matrix_double_dense.so in sage.matrix.matrix_double_dense.Matrix_double_dense.solve_right (build/cythonized/sage/matrix/matrix_double_dense.c:11896)()\n\nTypeError: vector of constants over Real Double Field incompatible with matrix over Real Double Field\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17405\n\n",
    "created_at": "2014-11-26T17:08:02Z",
    "labels": [
        "linear algebra",
        "minor",
        "bug"
    ],
    "title": "solve_right with matrix right hand side fails over RDF and CDF",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17168",
    "user": "fredrik.johansson"
}
```
Solving `AX=B` for a matrix `B` using `solve_right` or `\` works over many rings, but not `RDF` or `CDF`. Example:


```
sage: MatrixSpace(QQ,10,10,).random_element() \ MatrixSpace(QQ,10,1).random_element()
[   -783/1145]
[ 15697/18320]
[ -4647/18320]
[  -2599/7328]
[ 20289/73280]
[ -3791/18320]
[-70107/36640]
[-12407/36640]
[  -1588/1145]
[  -7059/9160]
sage: MatrixSpace(RR,10,10,).random_element() \ MatrixSpace(RR,10,1).random_element()
[ 0.0620590489221758]
[ -0.584548090301576]
[ -0.106165379993850]
[   1.52004291094317]
[  -1.03573096808637]
[ 0.0822404955372452]
[ -0.145002162865055]
[  0.262055581969539]
[   1.35298542346484]
[-0.0727293754429877]
sage: MatrixSpace(RDF,10,10,).random_element() \ MatrixSpace(RDF,10,1).random_element()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-16-0286e0222123> in <module>()
----> 1 MatrixSpace(RDF,Integer(10),Integer(10),).random_element()  * BackslashOperator() * MatrixSpace(RDF,Integer(10),Integer(1)).random_element()

/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/misc/preparser.pyc in __mul__(self, right)
   1413             (0.0, 0.5, 1.0, 1.5, 2.0)
   1414         """
-> 1415         return self.left._backslash_(right)
   1416 
   1417 

/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix._backslash_ (build/cythonized/sage/matrix/matrix2.c:4193)()

/home/fredrik/sage-6.3/local/lib/python2.7/site-packages/sage/matrix/matrix_double_dense.so in sage.matrix.matrix_double_dense.Matrix_double_dense.solve_right (build/cythonized/sage/matrix/matrix_double_dense.c:11896)()

TypeError: vector of constants over Real Double Field incompatible with matrix over Real Double Field
```


Issue created by migration from https://trac.sagemath.org/ticket/17405





---

archive/issue_comments_228224.json:
```json
{
    "body": "I attached a patch to this ticket.\n\nFollowing the pattern set by the solve_right and solve_left in src/sage/matrix/matrix2.pyx, I tweaked the code in src/sage/matrix/matrix_double_dense.pyx to make solve_right and solve_left for RDF and CDF matrices accept matrices for b. If b is given as a matrix, the answer x will be returned as a matrix.\n\nPlease note:\n1. The solve_left in matrix2 uses solve_right, to reduce redundancy; while the solve_left in matrix_double_dense does NOT use solve_right, and instead duplicates some code.\n2. The solve_left and solve_right in matrix_double_dense are now more lenient than those in matrix2, since they accept not just vectors and matrices for b, but also things that can be coerced into vectors (like Python lists).\n\nI didn't try to fix either of those issues.",
    "created_at": "2015-03-20T21:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228224",
    "user": "peterwicksstringfield"
}
```

I attached a patch to this ticket.

Following the pattern set by the solve_right and solve_left in src/sage/matrix/matrix2.pyx, I tweaked the code in src/sage/matrix/matrix_double_dense.pyx to make solve_right and solve_left for RDF and CDF matrices accept matrices for b. If b is given as a matrix, the answer x will be returned as a matrix.

Please note:
1. The solve_left in matrix2 uses solve_right, to reduce redundancy; while the solve_left in matrix_double_dense does NOT use solve_right, and instead duplicates some code.
2. The solve_left and solve_right in matrix_double_dense are now more lenient than those in matrix2, since they accept not just vectors and matrices for b, but also things that can be coerced into vectors (like Python lists).

I didn't try to fix either of those issues.



---

archive/issue_comments_228225.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-20T21:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228225",
    "user": "peterwicksstringfield"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_228226.json:
```json
{
    "body": "Why the restriction that the right hand side only has one column?",
    "created_at": "2015-03-21T00:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228226",
    "user": "fredrik.johansson"
}
```

Why the restriction that the right hand side only has one column?



---

archive/issue_comments_228227.json:
```json
{
    "body": "Because it did not even occur to me that the right hand side could have more than one. Thanks for pointing that out.\n\nI let b, the right hand side, have more columns.\n\nI fixed a bug that is in apparently dead code and wouldn't matter even if it wasn't.\n\nI made a branch for this ticket because that seems to be the proper way to do things here.\n\nAlso it seems like for non-square matrices the RDF/CDF right_solve and left_solve could just lean on the generic right_solve and left_solve? (The scipy solver needs square matrices, so right now the RDF/CDF code rejects them.) Anyway that would be for a different ticket if it even matters.\n\nEDIT: I think I may have made the branch wrong? Sorry :(.\nEDIT2: Figured it out. Branch is now correct.",
    "created_at": "2015-03-23T04:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228227",
    "user": "peterwicksstringfield"
}
```

Because it did not even occur to me that the right hand side could have more than one. Thanks for pointing that out.

I let b, the right hand side, have more columns.

I fixed a bug that is in apparently dead code and wouldn't matter even if it wasn't.

I made a branch for this ticket because that seems to be the proper way to do things here.

Also it seems like for non-square matrices the RDF/CDF right_solve and left_solve could just lean on the generic right_solve and left_solve? (The scipy solver needs square matrices, so right now the RDF/CDF code rejects them.) Anyway that would be for a different ticket if it even matters.

EDIT: I think I may have made the branch wrong? Sorry :(.
EDIT2: Figured it out. Branch is now correct.



---

archive/issue_comments_228228.json:
```json
{
    "body": "Set assignee to peterwicksstringfield.",
    "created_at": "2015-03-23T04:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228228",
    "user": "peterwicksstringfield"
}
```

Set assignee to peterwicksstringfield.



---

archive/issue_comments_228229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-29T19:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228229",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_228230.json:
```json
{
    "body": "Hello,\n\n1. You should not try to change the ring if it is already the good one as it performs a copy of the matrix\n\n```\nsage: m = matrix(ZZ,3,4,range(12))\nsage: m.change_ring(ZZ) is m\nFalse\nsage: %timeit m.change_ring(ZZ)\n1000000 loops, best of 3: 988 ns per loop\nsage: m = matrix(ZZ,10,10,range(100))\nsage: %timeit m.change_ring(ZZ)\n100000 loops, best of 3: 1.51 \u00b5s per loop\n```\n\n  This is bad since linear system might involve huge matrices.\n\n2. In your example, there is no need to print the input matrices `A` and `B` (though it is not very bad).\n\nVincent",
    "created_at": "2015-08-10T09:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228230",
    "user": "vdelecroix"
}
```

Hello,

1. You should not try to change the ring if it is already the good one as it performs a copy of the matrix

```
sage: m = matrix(ZZ,3,4,range(12))
sage: m.change_ring(ZZ) is m
False
sage: %timeit m.change_ring(ZZ)
1000000 loops, best of 3: 988 ns per loop
sage: m = matrix(ZZ,10,10,range(100))
sage: %timeit m.change_ring(ZZ)
100000 loops, best of 3: 1.51 µs per loop
```

  This is bad since linear system might involve huge matrices.

2. In your example, there is no need to print the input matrices `A` and `B` (though it is not very bad).

Vincent



---

archive/issue_comments_228231.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-10T09:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228231",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_228232.json:
```json
{
    "body": "Having a look at this.",
    "created_at": "2016-03-31T12:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228232",
    "user": "jdemeyer"
}
```

Having a look at this.



---

archive/issue_comments_228233.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-31T14:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228233",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_228234.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> Hello,\n> \n> 1. You should not try to change the ring if it is already the good one as it performs a copy of the matrix\n\nI have updated the branch to use the coercion framework to figure out a common parent for `A` and `B` and made some minor improvements to the documentation.\n\nI also added a deprecation for the case in which the argument `b` is not a vector or matrix, which was undocumented behavior and just complicates things for little gain.\n\nIn the future, `solve_right` for `RDF`/`CDF` should be updated to also handle the case of a non-square matrix `A`, which is already supported by generic matrices.\n----\nNew commits:",
    "created_at": "2020-02-20T17:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228234",
    "user": "@mwageringel"
}
```

Replying to [comment:5 vdelecroix]:
> Hello,
> 
> 1. You should not try to change the ring if it is already the good one as it performs a copy of the matrix

I have updated the branch to use the coercion framework to figure out a common parent for `A` and `B` and made some minor improvements to the documentation.

I also added a deprecation for the case in which the argument `b` is not a vector or matrix, which was undocumented behavior and just complicates things for little gain.

In the future, `solve_right` for `RDF`/`CDF` should be updated to also handle the case of a non-square matrix `A`, which is already supported by generic matrices.
----
New commits:



---

archive/issue_comments_228235.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-20T17:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228235",
    "user": "@mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_228236.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2020-02-20T17:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228236",
    "user": "@mwageringel"
}
```

Changing priority from minor to major.



---

archive/issue_comments_228237.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-21T08:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228237",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_228238.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-22T21:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17168#issuecomment-228238",
    "user": "vbraun"
}
```

Resolution: fixed
