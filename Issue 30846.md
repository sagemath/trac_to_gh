# Issue 30846: Fix for potential good reduction for dynamical systems

Issue created by migration from https://trac.sagemath.org/ticket/31083

Original creator: @EnderWannabe

Original creation time: 2020-12-19 19:09:50

CC:  bhutz paulfili

The function `potential_good_reduction` states that it returns a dynamical system with good reduction at a specified prime.

Currently, the following example returns a dynamical system:

```
P.<x,y> = ProjectiveSpace(QQ, 1)
system = DynamicalSystem_projective([3^5*x^3 + x^2*y - 3^5*x*y^2 , -3^5*x^2*y + x*y^2 + 3^5*y^3])
system.potential_good_reduction(3)
```


However, it is proved in [https://arxiv.org/pdf/1304.1201.pdf](https://arxiv.org/pdf/1304.1201.pdf) that this dynamical system does not have potential good reduction at 3.

Following the criterion in [https://arxiv.org/pdf/1311.6695.pdf](https://arxiv.org/pdf/1311.6695.pdf), a fix is implemented by first checking the valuation of the resultant of the conjugate system before returning.


---

Comment by @EnderWannabe created at 2020-12-19 19:29:13

Changing status from new to needs_review.


---

Comment by @EnderWannabe created at 2020-12-19 19:29:13

New commits:


---

Comment by bhutz created at 2021-01-30 17:36:47

I took a look at this (finally) and it looks fine to me. If I'm understanding the references correctly, the conjugation you are producing must be the one that gives good reduction, so you check if the resulting map does, otherwise it does not.

Maybe this is not the place to discuss this, but I'm a little concerned about the fact that this function returns different types depending on the result.  I'd be a little inclined to change the returns to

True, dynamicalsystem

False, None

Although, why is there no option to return the conjugation? So perhaps as a second option

True, DS, PGL

False, None, None

That way the returns are always consistent.

Since this is not yet in a released version, we're still free to change such things without having to worry about deprecation.


---

Comment by git created at 2021-02-01 01:59:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-02-01 02:07:27

Replying to [comment:3 bhutz]:
> Maybe this is not the place to discuss this, but I'm a little concerned about the fact that this function returns different types depending on the result. 

Implemented the change suggested, and updated the ticket description. Should we consider separating these changes into two separate tickets?


---

Comment by bhutz created at 2021-02-02 19:58:28

These are both small fixes to the same function under beta, so I'm ok doing them both here.

Paul it looks like you reviewed the original function. Are you ok with the new return types?


---

Comment by bhutz created at 2021-02-03 21:05:13

fyi, the docs fail to build


```
/arithmetic_dynamics/projective_ds.py:docstring of sage.dynamics.arithmetic_dynamics.projective_ds.DynamicalSystem_projective_field.potential_good_reduction:37: WARNING: Unexpected indentation.
Makefile:1873: recipe for target 'doc-html' failed
```



---

Comment by git created at 2021-02-06 17:46:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-02-06 17:46:50

Docs should build now.


---

Comment by bhutz created at 2021-02-11 19:18:33

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2021-02-11 19:18:33

This looks good to me. Just one further tweak I'd like. A test that checks that the conjugation returned actually gives the model with good reduction.


---

Comment by git created at 2021-02-27 17:52:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-27 17:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-27 18:09:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-02-27 18:11:14

Added the desired example.

I found an example which failed causing an embedding error:


```
P.<x,y> = ProjectiveSpace(QQ, 1)
system = DynamicalSystem_projective([3*x^2 + x*y+y^2, 9*y^2])
prime = system.field_of_definition_periodic(1).prime_above(3)
system.potential_good_reduction(prime)
```


The most recent pushes fixes this and add it as a test. Some of the code I wrote to fix it, however, I am unhappy with.

Since the change ring on projective points doesn't let me pass an embedding, I tried to use the embedding by hand on line 7076. Check that line to see if I missed something there.

Also, I resorted to checking if an embedding is defined on line 7094. Is that good practice? I couldn't come up with another approach, as using the identity when embedding_preimage was not defined failed tests.


---

Comment by bhutz created at 2021-03-04 16:26:07

err..why can't you pass en embedding into the projective point change_ring. I'm under the impression this works and changing your code to (7075-7076)


```
            system = system.change_ring(embedding_preimage)
            point = point.change_ring(embedding_preimage)
```


does not cause any doctest failures. Could you give me an example that is failing under this?

btw, you have at least one doctest failure in general that needs to be fixed (7029: does not have the return value to check against.)


---

Comment by git created at 2021-03-07 00:42:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @EnderWannabe created at 2021-03-07 00:44:01

Thanks for the suggestion, that works much better. I didn't realize I could just pass the embedding.

Failing doctest fixed! I'm going to change the status to needs review, as I think all the current issues have been addressed.


---

Comment by @EnderWannabe created at 2021-03-07 00:44:15

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-03-09 01:44:35

I actually meant checking that you are getting the actual map you return not just that it has the correct resultant. See the test I added.

Otherwise, I'm fine with this ticket as is. If you are also fine with the doctest I added, we can mark this positive.
----
New commits:


---

Comment by @EnderWannabe created at 2021-03-13 15:12:33

Looks good to me! Marked as positive review.


---

Comment by @EnderWannabe created at 2021-03-13 15:12:39

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-03-13 20:15:46

reviewer name should be full real name, please


---

Comment by bhutz created at 2021-03-15 16:34:30

sorry. Thanks for updating it.


---

Comment by vbraun created at 2021-03-16 23:26:49

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-03-16 23:26:49

Merge conflict


---

Comment by @EnderWannabe created at 2021-03-19 19:20:22

Changing status from needs_work to needs_review.


---

Comment by @EnderWannabe created at 2021-03-19 19:20:22

New commits:


---

Comment by bhutz created at 2021-03-20 00:51:15

err...that didn't fix the merge conflict. Try this one.


---

Comment by chapoton created at 2021-03-22 15:53:27

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2021-03-22 15:53:27

red branch => needs work


---

Comment by git created at 2021-03-22 18:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2021-03-22 19:06:51

Apparently I failed to commit the merge conflict fix. I've done so now.


---

Comment by bhutz created at 2021-03-22 19:06:51

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2021-03-28 00:11:09

ping


---

Comment by @EnderWannabe created at 2021-03-28 20:52:30

Changing status from needs_review to positive_review.


---

Comment by @EnderWannabe created at 2021-03-28 20:52:30

Looks good. Hopefully that resolves this merge conflict


---

Comment by chapoton created at 2021-05-10 11:05:05

milestone to 9.4, as 9.3 has been released


---

Comment by mkoeppe created at 2021-07-24 18:37:19


```
             return gccc, m * mc * mc2, psi
         return gccc
 
-    def potential_good_reduction(self, prime):
+    def potential_good_reduction(self, prime, return_conjugation=False):
         r"""
-        Return if this dynamical system has potential good reduction at ``prime``.
+        Return ``True`` if this dynamical system has potential good reduction at ``prime``.
 
         A dynamical system has good reduction at ``prime`` if after the coefficients
```

In light of the discussion in #32205, this could proactively be changed to 
`def potential_good_reduction(self, prime, *, return_conjugation=False)`, to declare `return_conjugation` to be a keyword-only argument.


---

Comment by mkoeppe created at 2021-07-24 18:43:15

Changing priority from minor to major.


---

Comment by mkoeppe created at 2021-07-24 18:43:15

Promoting 5 tickets that fix defects to "major" so that they have a chance to get merged


---

Comment by vbraun created at 2021-07-25 13:27:04

Resolution: fixed
