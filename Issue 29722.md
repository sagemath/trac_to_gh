# Issue 29722: Extended the construction of BIBDs to allow for \lambda different from 1

Issue created by migration from https://trac.sagemath.org/ticket/29959

Original creator: @Ivo-Maffei

Original creation time: 2020-06-24 16:19:38

CC:  dimpase

Keywords: bibd combinatorial-designs

Extended the function `balanced_incomplete_block_design` to allow arbitrary values for the parameter `\lambda`.


---

Comment by @Ivo-Maffei created at 2020-06-24 16:20:11

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-06-25 08:21:49

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-06-25 08:21:49

looks great, adds a lot of nice stuff, but error messages need to be adjusted
(lambda=1 is fixed there I suppose):

```
sage: designs.balanced_incomplete_block_design(79,13,2)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-5-1a5677b9322f> in <module>()
----> 1 designs.balanced_incomplete_block_design(Integer(79),Integer(13),Integer(2))

/mnt/opt/Sage/sage-clang/local/lib/python3.7/site-packages/sage/combinat/designs/bibd.py in balanced_incomplete_block_design(v, k, lambd, existence, use_LJCR)
    271         return Unknown
    272     else:
--> 273         raise NotImplementedError("I don't know how to build a ({},{},1)-BIBD!".format(v, k))
    274 
    275 def steiner_triple_system(n):

NotImplementedError: I don't know how to build a (79,13,1)-BIBD!
```


(BIBD(79,13,2) is a largest known biplane (cf. https://en.wikipedia.org/wiki/Block_design#Biplanes), so it would eventually be nice to have, but not on this ticket.


---

Comment by dimpase created at 2020-06-25 08:24:57

here is the fix - and also a fix for 2 typos:

```diff
--- a/src/sage/combinat/designs/bibd.py
+++ b/src/sage/combinat/designs/bibd.py
@@ -162,7 +162,7 @@ def balanced_incomplete_block_design(v, k, lambd=1, existence=False, use_LJCR=Fa
         sage: designs.balanced_incomplete_block_design(1171,10)
         (1171,10,1)-Balanced Incomplete Block Design
 
-    And we know some inexistence results::
+    And we know some nonexistence results::
 
         sage: designs.balanced_incomplete_block_design(21,6,existence=True)
         False
@@ -176,7 +176,7 @@ def balanced_incomplete_block_design(v, k, lambd=1, existence=False, use_LJCR=Fa
         sage: designs.balanced_incomplete_block_design(37,9,8)
         (37,9,8)-Balanced Incomplete Block Design
         sage: designs.balanced_incomplete_block_design(15,7,3)
-        g(15,7,3)-Balanced Incomplete Block Design
+        (15,7,3)-Balanced Incomplete Block Design
     """
 
     # Trivial BIBD
@@ -270,7 +270,7 @@ def balanced_incomplete_block_design(v, k, lambd=1, existence=False, use_LJCR=Fa
     if existence:
         return Unknown
     else:
-        raise NotImplementedError("I don't know how to build a ({},{},1)-BIBD!".format(v, k))
+        raise NotImplementedError("I don't know how to build a ({},{},{})-BIBD!".format(v, k, lambd))
 
 def steiner_triple_system(n):
     r"""
```



---

Comment by dimpase created at 2020-06-25 08:29:36

the typo with extra `g` tells me that you didn't run doctests :-)


---

Comment by git created at 2020-06-25 09:51:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-06-25 09:56:10

Thanks for the review. The dockets pass, the issue with the `g` is that I often start typing "git" before the os has fully switch from the editor to the console. I should definitely be more careful, but they are tricky to catch as I have run all tests before I use git.

I'll try and implement the biplane now, otherwise I will end up forgetting.


---

Comment by @Ivo-Maffei created at 2020-06-25 09:56:27

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-06-25 10:34:30

not all doctests pass - namely, the following gets broken by this branch on Sage 9.1.beta2

```
sage -t --warn-long 67.2 src/sage/graphs/strongly_regular_db.pyx
**********************************************************************
File "src/sage/graphs/strongly_regular_db.pyx", line 487, in sage.graphs.strongly_regular_db.is_goethals_seidel
Failed example:
    g = t[0](*t[1:]); g
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-clang/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 680, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/opt/Sage/sage-clang/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1104, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.strongly_regular_db.is_goethals_seidel[5]>", line 1, in <module>
        g = t[Integer(0)](*t[Integer(1):]); g
      File "/mnt/opt/Sage/sage-clang/local/lib/python3.7/site-packages/sage/graphs/generators/families.py", line 1287, in GoethalsSeidelGraph
        for i in row])
      File "/mnt/opt/Sage/sage-clang/local/lib/python3.7/site-packages/sage/graphs/generators/families.py", line 1287, in <listcomp>
        for i in row])
    IndexError: pop from empty list
```



---

Comment by dimpase created at 2020-06-25 10:34:47

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-06-25 10:57:14

you managed to break incidence_matrix:

```
sage: designs.balanced_incomplete_block_design(16,2).incidence_matrix()
16 x 240 sparse matrix over Integer Ring (use the '.str()' method to see the entries)
```

it should be 16x120.


---

Comment by dimpase created at 2020-06-25 11:04:26

or perhaps just blocks in such a trivial case:

```
sage: d=designs.balanced_incomplete_block_design(3,2,1)
sage: d.blocks()
[[0, 1], [0, 1], [0, 2], [0, 2], [1, 2], [1, 2]]
```



---

Comment by @Ivo-Maffei created at 2020-06-25 11:20:28

I have fixed the issue. However, I think I'm missing something when running the doctests.
Usually, I execute `sage -t src/sage/combinat/designs/bibd.py`. How did you end up testing `strongly_regular_db`?
Do I need to run all doctests (`make ptest`) or is there a way to only test the dependencies?


---

Comment by dimpase created at 2020-06-25 11:25:46

I ran `sage -tp src/sage/combinat/` and `sage -tp src/sage/graphs/`
Yes, ideally you should run `make ptestlong` - takes time.


---

Comment by dimpase created at 2020-06-25 12:03:01

don't forget to push the fixes.


---

Comment by git created at 2020-06-25 12:59:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-06-25 13:00:41

I run `make ptest` this time and all seem to work.


---

Comment by @Ivo-Maffei created at 2020-06-25 13:00:59

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-06-25 15:04:32

Replying to [comment:7 gh-Ivo-Maffei]:
> I'll try and implement the biplane now, otherwise I will end up forgetting.

in any event, it makes sense to implement https://en.wikipedia.org/wiki/Bruck%E2%80%93Ryser%E2%80%93Chowla_theorem
to rule out sets of parameters for symmetric BIBDs - so far it is only done in Sage for 
pojective planes, see `projective_plane` in `src/sage/combinat/designs/block_design.py`


---

Comment by dimpase created at 2020-06-25 16:05:17

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-25 16:05:17

OK, good.


---

Comment by slelievre created at 2020-06-26 17:50:02

The patchbots report pyflakes and pycodestyles errors.


---

Comment by slelievre created at 2020-06-26 17:50:02

Changing status from positive_review to needs_work.


---

Comment by @Ivo-Maffei created at 2020-06-26 19:18:10

If I interpret the pyflakes report correctly, it complains about ".block_design.BlockDesign imported but unused".
That's wrong as `BlockDesign` is used at line 227. However, I think we could (and should) use `BalancedIncompleteBlockDesign` there.
I'm now running the doctests to make sure I'm not wrong.

I fixed the pycodestyle errors, but I personally believe that code (especially the 10 lines of if ... else if ...) looked better before.
Anyway, I'll push the changes as soon as the tests pass.


---

Comment by slelievre created at 2020-06-26 23:15:31

Thanks for explaining. I don't feel strongly about it, feel free to set back to positive review.


---

Comment by dimpase created at 2020-06-27 22:00:35

OK.


---

Comment by dimpase created at 2020-06-27 22:00:35

Changing status from needs_work to positive_review.


---

Comment by git created at 2020-06-29 10:23:26

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-06-29 10:23:26

Changing status from positive_review to needs_review.


---

Comment by @Ivo-Maffei created at 2020-06-29 10:27:45

I apologise for the delay, but I finally got round to swap the `BlockDesign` use to `BalancedIncompleteBlockDesign`. It took longer than expected as some tests were failing, but they are completely unrelated.


---

Comment by git created at 2020-06-29 10:35:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-01 10:52:29

a typo in docstring:

```
In particular, Sage can build a `(v,k,1)`-BIBD when one exists for all `k\leq
```


there should be `\lambda` instead of `1`.


---

Comment by dimpase created at 2020-07-01 10:55:53

a typo in docstring:

```
In particular, Sage can build a `(v,k,1)`-BIBD when one exists for all `k\leq
```


there should be `\lambda` instead of `1`.

Also, change the previous line

```
    sage: BIBD = designs.balanced_incomplete_block_design(7,3)
```

to use `(7,3,1)`.


---

Comment by @Ivo-Maffei created at 2020-07-01 11:25:08

I'll change the `(7,3,1)`, but I'm not sure the other sentence should be changed. 
On my computer `designs.balanced_incomplete_block_design(6,3,2)` raises a `NotImplementedError` and Wikipedia states that there is such a BIBD (https://en.wikipedia.org/wiki/Block_design#Examples).


---

Comment by git created at 2020-07-01 13:02:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-07-01 14:18:29

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-07-01 14:18:43

OK


---

Comment by dimpase created at 2020-07-01 14:34:09

Bibd(6,3,2) is probably another story. Not sure how it is built from what we have already


---

Comment by vbraun created at 2020-07-08 19:33:18

Resolution: fixed
