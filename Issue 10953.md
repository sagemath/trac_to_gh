# Issue 10953: remove the spkg/base repo?

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-03-28 19:52:55

Assignee: GeorgSWeber

CC:  jdemeyer kini leif was

Keywords: scripts base hg

Given the creation of the Sage root repo (see #9433), perhaps the repository in SAGE_ROOT/spkg/base should be combined with it.  See [this page](http://mercurial.selenic.com/wiki/MergingUnrelatedRepositories) for one way to merge Mercurial repositories; another option would be to keep the base repo as a [subrepository](http://mercurial.selenic.com/wiki/Subrepository) of the root repo.

Is there a good way to avoid the current duplication between SAGE_ROOT/local/bin and SAGE_ROOT/spkg/base?  Right now, both contain identical copies of the scripts sage-env, sage-spkg, and sage-make_relative, courtesy of the sage-sdist script, but if the copies somehow get out of sync, then building from scratch tends to break.

One small issue which should be fixed regardless: from SAGE_ROOT:

```
$ cd spkg/base
$ hg status
? sage-check-64
```

The script sage-check-64 should be removed from this directory.  (It was added, but .hgignore wasn't modified, when #10303 was merged, and then it wasn't removed when #10303 was backed out.)


---

Comment by jdemeyer created at 2011-03-28 20:02:04

I will take care of removing `spkg/base/sage-check-64` in sage-4.7.alpha3.


---

Comment by drkirkby created at 2011-03-28 21:48:45

I never realised this was this duplication - it is clearly very stupid. If nothing else, copies could be replaced with links, but it would be better to do away with the repository if possible. 

If the repositories can be merged, then I think that's a good idea. I don't like the idea of having a repository as a suppository of another - I think it would just add unnecessary complications. From reading about the [subrepositories](http://mercurial.selenic.com/wiki/Subrepository), I don't feel they are designed to address a need we have.


---

Comment by kini created at 2011-04-03 05:53:57

From what I understand of such things, using subrepositories is a huge mess. The "proper" usage case of a subrepository is basically what the `src/` directory inside an spkg is - i.e. a repository that is bolted on but comes from some "upstream" place. When you commit changes to your repository, if you've modified anything in the subrepository, it automatically commits to the subrepository too (or at least tortoisehg does on windows, if I recall correctly from when I was messing with this stuff a year ago or so), allowing you to send changesets upstream with `hg push` or what-have-you, and when someone pulls from your repository, their mercurial pulls the latest version of its subrepository from the upstream URL rather than from your copy of it, I think. Though we sage developers have a pretty non-standard mercurial workflow - nobody ever pulls from anywhere, really - so I don't know how much this matters. Still, as drkirkby says, it would just needlessly complicate matters.

*tl;dr* I too support merging the repositories or getting rid of one of them over maintaining one as a subrepository of the other.


---

Comment by jdemeyer created at 2011-04-12 13:15:46

Changing priority from minor to blocker.


---

Comment by jhpalmieri created at 2011-04-12 19:26:28

Dave: in the base repository, can you explain what the files stdint.h_Solaris9, testcc.sh, and testcxx.sh are for?  I know what the last two do, but are they actually used anywhere?  I can't find any reference to them in SAGE_ROOT/local/bin or SAGE_ROOT/spkg.  Are they called by various spkg-install files?

Right now, testcc.sh and testcxx.sh are copied (by the file spkg/install) to SAGE_ROOT/local/bin. If we're doing away with the base repository, should they be tracked in the Sage root repository or the scripts repository?  Since they're scripts which might be useful in general, the scripts repo might make sense.  But if they're only used in the installation process -- I don't know where they're used -- maybe the root repo makes sense.  Any opinions?


---

Comment by drkirkby created at 2011-04-12 23:20:37

Replying to [comment:6 jhpalmieri]:
> Dave: in the base repository, can you explain what the files stdint.h_Solaris9, testcc.sh, and testcxx.sh are for?  I know what the last two do, but are they actually used anywhere?  I can't find any reference to them in SAGE_ROOT/local/bin or SAGE_ROOT/spkg.  Are they called by various spkg-install files?

I'm not aware of what stdint.h_Solaris9 was supposed to do. I think Micheal added that. It's pretty dumb, as it forces a long to be 4 bytes with:


```
typedef unsigned long       int_fast32_t;
```


which is obviously invalid on 64-bit builds. I recall having to create a ticket to stop including that file, as it was screwing up attempts to build Sage 64-bit on Solaris. 

Given Solaris 10 came out in 2005, I don't think there's much point in worrying about Solaris 9 anyway.

As such, I think that stdint.h_Solaris9 should be deleted and if there is any issues it creates, we fix them. But I don't think it will create any problems. 

The testcc.sh and testcxx.sh scripts are used in a few .spkg files. There's several .spkg files which have tests for the compilers, which would be much simplified if replaced by those scripts. 

> Right now, testcc.sh and testcxx.sh are copied (by the file spkg/install) to SAGE_ROOT/local/bin. If we're doing away with the base repository, should they be tracked in the Sage root repository or the scripts repository?  Since they're scripts which might be useful in general, the scripts repo might make sense.  But if they're only used in the installation process -- I don't know where they're used -- maybe the root repo makes sense.  Any opinions?

I think the scrips repository will be ok. If nothing else, it is consistent with much of the rest of Sage. I don't think either of those scripts gets used before the sage-scripts package is installed, but I'm not 100% sure on that.


---

Comment by jdemeyer created at 2011-04-13 07:41:26

Replying to [comment:7 drkirkby]:
> It's pretty dumb, as it forces a long to be 4 bytes with:
> 
> {{{
> typedef unsigned long       int_fast32_t;
> }}}
> 
> which is obviously invalid on 64-bit builds.

It is invalid, but not for the reason you state.

The problem is that `int_fast32_t` is supposed to be *signed*, while `unsigned long` is *unsigned*.  As for size, the type `int_fast32_t` is required to be _at least_ 32 bits, not _exactly_ 32 bits, so the following would be correct, both on 32-bit and 64-bit machines:

```
typedef long            int_fast32_t;
```


In fact, on my 64-bit Linux laptop, the types `int_fast16_t` and `int_fast32_t` are `typedef`ed to be 64-bit `long`s.


---

Comment by jhpalmieri created at 2011-04-13 14:22:45

I tried grepping through all of the spkgs and the rest of Sage.  I find no mention of stdint.h_Solaris9, so I think we should delete it.  testcxx.sh doesn't get used anywhere, but it could be useful, so we'll keep it.  testcc.sh gets used in the spkg-install file for libm4ri, so if we add testcc.sh to the scripts repo, then we need to make sure that the scripts spkg is a prerequisite for libm4ri.


---

Comment by jhpalmieri created at 2011-04-13 16:20:25

Regarding the files sage-env, sage-make_relative, and sage-spkg: these are currently in the scripts repo (and it makes a lot of sense for them to be there), but they get used in the Sage build process right from the start.  (There have been complaints about the role of sage-make_relative, and those might have some validity to them, but this is not the ticket to deal with that.)  Right now, the script sage-sdist copies them from the scripts repo to the base directory so they're in the right place in a new source distribution.  One of the first things that spkg/install does is to copy them back to local/bin/ so they're in the right place to be executed.

So: what should be done with these?  Move them to root repo and put links to them in local/bin?  That seems to make a lot of sense, but it doesn't feel right for some reason.  Any other ideas?


---

Comment by kini created at 2011-04-14 03:11:15

Assuming I understand correctly what is going on here, why don't we keep them in local/bin and copy them to spkg/base during the -sdist process without putting the copies under revision control? spkg/install will copy them back to local/bin when building a new sage installation from source, but once we install the scripts repo, they will sync with the copy we keep under revision control in local/bin anyway. If we take `hg merge` out of local/bin/sage-spkg-install and put in `hg update -C` instead, which I think is a good idea, then we have even less to worry about.


---

Comment by jdemeyer created at 2011-04-14 07:18:19

Replying to [comment:10 jhpalmieri]:
> Move them to root repo and put links to them in local/bin?  That seems to make a lot of sense, but it doesn't feel right for some reason.

If feels right to me...


---

Comment by drkirkby created at 2011-04-14 08:47:31

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 drkirkby]:
> > It's pretty dumb, as it forces a long to be 4 bytes with:
> > 
> > {{{
> > typedef unsigned long       int_fast32_t;
> > }}}
> > 
> > which is obviously invalid on 64-bit builds.
> 
> It is invalid, but not for the reason you state.
> 
> The problem is that `int_fast32_t` is supposed to be *signed*, while `unsigned long` is *unsigned*.  As for size, the type `int_fast32_t` is required to be _at least_ 32 bits, not _exactly_ 32 bits, so the following would be correct, both on 32-bit and 64-bit machines:
> {{{
> typedef long            int_fast32_t;
> }}}

On Solaris the int_fast_32 remains at 32-bits, even on 64-bit code, so what actually caused Sage to fail to compile was certainly the size rather than the sign. 

That little bit of header file was included in Sage well after Sage built reliably 32-bit. It was only when I tried a 64-bit build of Sage that this became a problem. (I think a 64-bit Sage on Solaris is looking further away now, as we don't have a good solution for making sure modules are initialized properly before anything is imported from them.)

## Test program

```
drkirkby`@`laptop:~$ cat test.c
#include <stdio.h>
#include <stdlib.h>
#include <sys/int_types.h>

int main() {
  printf("sizeof(int)=%d\n",sizeof(int));
  printf("sizeof(long)=%d\n",sizeof(long));
  printf("sizeof(int_fast32_t)=%d\n",sizeof(int_fast32_t));
  exit(0);
}
```

## Create a 32-bit executable and execute it

```
drkirkby`@`laptop:~$ gcc  test.c
drkirkby`@`laptop:~$ ./a.out
sizeof(int)=4
sizeof(long)=4
sizeof(int_fast32_t)=4
```

## Create a 64-bit executable and execute it

```
drkirkby`@`laptop:~$ gcc  -m64 test.c
drkirkby`@`laptop:~$ ./a.out
sizeof(int)=4
sizeof(long)=8
sizeof(int_fast32_t)=4
```


> In fact, on my 64-bit Linux laptop, the types `int_fast16_t` and `int_fast32_t` are `typedef`ed to be 64-bit `long`s.

As you can see, that's not so on Solaris, int_fast32_t remains 32-bits, even in 64-bit code. 

I recall using a Cray Y-MP with Unicos, where

```
sizeof(char)=1
sizeof(short)=8
sizeof(int)=8
sizeof(long)=8
```

The Cray is the only system I've come across where shorts are 64-bit. That tripped me up, as some code I'd written assumed shorts were 2 bytes. 

Dave


---

Comment by drkirkby created at 2011-04-14 09:12:31

Replying to [comment:9 jhpalmieri]:
>  testcc.sh gets used in the spkg-install file for libm4ri, so if we add testcc.sh to the scripts repo, then we need to make sure that the scripts spkg is a prerequisite for libm4ri.

Having thought about this more, I think it would be better if they were in the root repository. 

There are lots of bits of code in Sage which are testing if the compilers are Sun or GNU. Those bits could be dramatically simplified by using the `testcc.sh` and `testcxx.sh` scripts. Look in rubiks for example. There are probably 20 or more spkg-install scripts which are using some test for the Sun compiler in one form or another. I've just never got around to re-writing them to use those scripts, but long-term it would be more sensible to remove a lot of things from numerous spkg-install scripts and use the more portable and robust scripts. 

As such, I think it might be better if those scripts were available early on, which would be achieved by having them in the root repository.


---

Comment by vbraun created at 2011-05-30 03:07:33

Copying files between root and scripts repositories is horrible. We can't make relative symlinks from `$SAGE_LOCAL` to `$SAGE_ROOT` since they might be unrelated directories. I think the best solution is to have small shell scripts in the scripts repository that call the script in the sage root repository. It seems that this is only `sage-env` and the `testcc.sh`, `testcxx.sh` scripts.

Patch instructions:

1) remove everything but the tar archives from spkg/base

```
cd $SAGE_ROOT/spkg/base
rm -rf .hg *-install README.txt sage-* test*sh stdint.h_Solaris9
```


2) apply trac_11073_remove_base_repo.patch to the root repo

3) apply trac_11073_stop_copying_stuff.patch to the root repo

4) apply trac_11073_stubs_for_base.patch to the scripts repo

Some notes about files formerly in the spkg/base repository:
  * `stdint.h_Solaris9`: deleted
  * `sage-spkg`: deleted from sage_scripts, should live in sage_root only. 
  * `sage-env`: replaced by stub in sage_scripts. 
  * `testcc.sh`, `testcxx.sh`: replaced by stub in sage_scripts
  * `sage-make_relative`: was a Python script, but base doesn't have Python yet ?!?. Deleted.


---

Comment by vbraun created at 2011-05-30 03:17:06

Changing status from new to needs_review.


---

Comment by vbraun created at 2011-05-30 16:11:46

Forgot to delete `SAGE_ROOT/spkg/base/.hgignore`, instructions moved to ticket description so they can be edited.


---

Attachment

Updated patch


---

Comment by vbraun created at 2011-05-30 19:32:00

Updated patch


---

Attachment

Updated patch


---

Comment by vbraun created at 2011-05-30 19:32:32

Updated for Sage-4.7.1.alpha1


---

Comment by vbraun created at 2011-05-31 13:04:47

Upgrading doesn't work, the sage_root repository is upgraded near the end of the upgrade process since the spkg depends on mercurial...


---

Comment by vbraun created at 2011-05-31 13:04:47

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-06-14 20:35:26

Changing priority from blocker to major.


---

Comment by leif created at 2011-07-03 18:04:38

Replying to [comment:15 vbraun]:
>   * `sage-make_relative`: was a Python script, but base doesn't have Python yet ?!?. Deleted.

For the record: This funny [...] script is called from `sage-spkg`:

```sh
...
echo "Making Sage/Python scripts relocatable..."

cd "$SAGE_LOCAL"/bin
./sage-make_relative

echo "Finished installing $PKG_NAME.spkg" 

# It's OK if the above fails -- in fact it will until Python
# itself gets installed. That's fine. 
exit 0   
```



---

Comment by kini created at 2011-08-11 01:58:01

Any more news here? I'm about to submit a patch to #3052 that adds files to the spkg/base repo :(


---

Comment by jhpalmieri created at 2011-08-11 16:38:30

See #10970 for a somewhat related ticket (at least the discussion there touches on similar issues with the Sage root repo).


---

Comment by leif created at 2011-11-06 01:34:10

Replying to [comment:21 leif]:
> Replying to [comment:15 vbraun]:
> >   * `sage-make_relative`: was a Python script, but base doesn't have Python yet ?!?. Deleted.
> 
> For the record: This funny [...] script is called from `sage-spkg`:

```sh
...
echo "Making Sage/Python scripts relocatable..."

cd "$SAGE_LOCAL"/bin
./sage-make_relative

echo "Finished installing $PKG_NAME.spkg" 

# It's OK if the above fails -- in fact it will until Python
# itself gets installed. That's fine. 
exit 0   
```


I recall having changed this (such that `sage-make_relative` only gets called if Sage's Python is already installed), but it's not yet in 4.7.2, and I don't recall the ticket.

Anyway, `sage-make_relative` itself should be present from the beginning, although we could do the same thing (and a bit smarter) directly in `sage-spkg`, AFAIK the only script from where it's used.


---

Comment by leif created at 2011-11-06 01:42:20

Replying to [comment:25 leif]:
> I recall having changed this (such that `sage-make_relative` only gets called if Sage's Python is already installed), but it's not yet in 4.7.2, and I don't recall the ticket.

Ah, #9992, merged into Sage 4.8.alpha0, formerly known as 4.7.3.alpha0.


---

Comment by jdemeyer created at 2011-11-30 11:12:35

Simpler solution instead of making stubs in `SAGE_ROOT/local/bin`:
 1. Create a new directory `SAGE_ROOT/spkg/bin`
 1. Put `sage-env`, `sage-spkg`,... there and not in `sage_scripts`, nor stubs in `sage_scripts`
 1. In `sage-env`, add `SAGE_ROOT/spkg/bin` to the path
 1. Make `sage-sage` and `sage-spkg` find the new `sage-env`


---

Comment by jdemeyer created at 2011-12-02 10:13:06

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2011-12-02 10:13:06

Changing assignee from GeorgSWeber to jdemeyer.


---

Comment by jhpalmieri created at 2011-12-06 18:07:37

In root-spkg-install, line 18, from [attachment:11073_root_after.patch], should the last character be deleted?

```
rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh ) 
```



---

Comment by jdemeyer created at 2011-12-06 19:39:15

Replying to [comment:38 jhpalmieri]:
> In root-spkg-install, line 18, from [attachment:11073_root_after.patch], should the last character be deleted?
> {{{
> rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh ) 
> }}}
Yes, thanks.

I believe this ticket is almost ready, it builds and tests fine, sdist and bdist work.  The main thing still left to do is to test upgrading.


---

Comment by jdemeyer created at 2011-12-06 21:06:57

Can anybody here please review #12122: it adds a short doctest that `sage-make_relative` is functional.  I created it while working on this ticket because at some point `sage-make_relative` broke without me realizing it.


---

Comment by jdemeyer created at 2011-12-08 22:42:53

Upgrading to sage-4.7.2 failed because of trying to "hg merge" on top of a hg-untracked file:

```
****************************************************
nothing changed
pulling from /mnt/usb1/scratch/jdemeyer/sage-4.7.2/spkg/build/sage_root-4.8.alpha3-remove-base
searching for changes
adding changesets
adding manifests
adding file changes
added 17 changesets with 40 changes to 21 files (+1 heads)
(run 'hg heads' to see heads, 'hg merge' to merge)
abort: untracked file in working directory differs from file in requested revision: 'spkg/bin/sage-env'
nothing changed
abort: crosses branches (merge branches or use --check to force update)
'hg update' failed

real    0m0.922s
user    0m0.610s
sys     0m0.260s
sage: An error occurred while installing sage_root-4.8.alpha3-remove-base
```



---

Comment by jdemeyer created at 2011-12-09 23:47:48

Wow, I just realized that the base repo was never actually updated on upgrade.  We cannot retro-actively fix the `sage-update` script of previous Sage versions to fix this.  So this is going to remain.


---

Attachment


---

Comment by jhpalmieri created at 2011-12-10 06:52:15

Replying to [comment:44 jdemeyer]:
> Wow, I just realized that the base repo was never actually updated on upgrade.  We cannot retro-actively fix the `sage-update` script of previous Sage versions to fix this.  So this is going to remain.

I'm not sure what you mean.  We can modify the `sage-update` script: it gets run twice during the upgrade process, so it will be modified the second time through, so we might be able to make relevant changes there.  But upgrading seems complicated to me, and I've made mistakes trying to modify the update script before.


---

Comment by jdemeyer created at 2011-12-10 09:59:43

There is no compelling need to upgrade the `base` packages: an old bzip2 and old prereq (which only does some checks AFAIK) should do just fine.

But yes, we _could_ do it, I didn't realize that `sage-upgrade` was run twice.


---

Comment by jdemeyer created at 2011-12-10 10:46:44

I succesfully:
 1. built from scratch, testlong
 2. create sdist, build from that, testlong
 3. create bdist, testlong
 4. upgrade from sage-4.5, testlong
 5. upgrade from sage-4.7.2, testlong

Everything worked.


---

Comment by jdemeyer created at 2011-12-10 10:46:44

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-12-11 11:57:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-14 21:24:34

I see no reason to keep `sage-make_relative` in the root repo.  It would be perfectly fine to keep it only in the scripts repo.

This would break relocating a Sage install *during* installation, but I don't think that's a problem...


---

Comment by jdemeyer created at 2011-12-15 22:11:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-12-20 23:17:51

Because of the discussion at #12206: any objections to moving `$SAGE_LOCAL/bin/sage-sage` to `$SAGE_ROOT/spkg/bin/sage` (or some other file in the root repo)?


---

Comment by jdemeyer created at 2011-12-21 10:12:31

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-12-24 01:24:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-12-24 01:24:35

Now that `sage-sage` is moved to `spkg/bin/sage`, the commands `sage -sh` and `sage -i ...` work immediately, directly from the extracted source tarball.  So this makes #12206 obsolete.


---

Comment by jdemeyer created at 2012-01-02 20:50:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-09 22:48:17

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-09 22:48:17

Needs review (again).


---

Attachment

Add `spkg/base/prereq-0.7-install` and `spkg/base/prereq-0.8-install` to `.hgignore` for upgrades from old Sage versions.


---

Comment by jdemeyer created at 2012-01-15 09:30:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-15 09:30:03

Because of #12311, we should still copy `testcc.sh` and `testcxx.sh` to `$SAGE_LOCAL/bin`.  This can then truly be fixed in #12311.


---

Comment by jdemeyer created at 2012-01-15 09:44:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-16 19:48:35

Upgrading from sage-4.4.4 failed gracefully, as expected.

Doubly-upgrading sage-4.4.4 -> sage-4.8.rc0 -> sage-5.0.prealpha2 worked fine.


---

Comment by jhpalmieri created at 2012-01-17 02:14:24

Needs work: as pointed out by was on sage-devel, the Makefile still refers to local/bin/sage-env in a few places.


---

Comment by jdemeyer created at 2012-01-17 07:48:00

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-17 07:48:00

I couldn't find that sage-devel post, but you're right.  How could I miss that?


---

Comment by jdemeyer created at 2012-01-17 08:15:33

Okay, I did a grep of `sage-env`, `sage-sage` and `sage-spkg` in the whole Sage tree, including spkgs.  The following are fixed now:

 * Top-level `Makefile`
 * `data/extcode/sage/ext/mac-app/start-sage.sh`
 * `devel/sage/doc/en/developer/coding_in_python.rst`

There is a remaining reference in a *comment* in the `cliquer` spkg (can be fixed in #12311) and in *comments* in the R spkg (should be taken of in #9906).


---

Attachment


---

Comment by jdemeyer created at 2012-01-17 08:26:29

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2012-01-17 14:56:27

Replying to [comment:73 jdemeyer]:
> Okay, I did a grep of `sage-env`, `sage-sage` and `sage-spkg` in the whole Sage tree, including spkgs.  The following are fixed now:
> 
>  * Top-level `Makefile`
>  * `data/extcode/sage/ext/mac-app/start-sage.sh`

So for positive review, I guess someone would have to build the Mac app and make sure it functions properly.


---

Comment by jdemeyer created at 2012-01-17 16:12:40

I will have the buildbot build a "Mac app" for the _unreleased_ sage-5.0.beta1, which includes the latest version of this ticket.


---

Comment by was created at 2012-01-18 17:14:41

Changing status from needs_review to needs_work.


---

Comment by was created at 2012-01-18 17:14:41

COMMENTS:

 1. In this code (and anything similar?):

```
        17	cd "$SAGE_ROOT/spkg/base" 
 	18	rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh 
```

can we have an error check after the cd, before "rm -rf", since if something went wrong (even a control-c at the wrong moment, or the spkg/base directory is already gone!), then the "rm -rf" *will* cause some serious pain, e.g., deleting the .hg repo from SAGE_ROOT.   Any time I see an "rm -rf" in a script I'm very paranoid.  This is the sort of situation where Python would be better.  

 2. Many people -- e.g., me on the seemingly dozens of machines I have Sage installed on -- will have a "sage" script that is from before this patch.  That script will *not* be upgraded when we upgrade our Sage install, since that script is in local/bin/ (say), not in `SAGE_ROOT` (and it need not be a symlink).  That older script explicitly calls "local/bin/sage-sage", so it will now be totally broken, since this ticket deletes sage-sage.     For this reason, I think it is absolutely essential that sage-sage not be deleted.  The sage-sage script needs to remain, but could either be a 1-liner that calls `$SAGE_ROOT/spkg/bin/sage` *or* it could produce a nice useful error message explaining that the user must update their sage script by copying over the one from SAGE_ROOT, and edit the path, or create a symbolic link. 

 3. As far as I can tell, I'm happy with everything else about the new scripts added 33 hours ago.  They fix the issue I reported on sage-devel.


---

Comment by jdemeyer created at 2012-01-18 19:50:39

Replying to [comment:78 was]:
> COMMENTS:
> 
>  1. In this code (and anything similar?):
> {{{
>         17	cd "$SAGE_ROOT/spkg/base" 
>  	18	rm -rf .hg* json_bundle.py stdint.h_Solaris9 sage-* text-* *.sh 
> }}}
> can we have an error check after the cd
Good point!


---

Comment by jdemeyer created at 2012-01-18 19:55:20

Replying to [comment:78 was]:
> For this reason, I think it is absolutely essential that sage-sage not be deleted.  The sage-sage script needs to remain, but could either be a 1-liner that calls `$SAGE_ROOT/spkg/bin/sage` *or* it could produce a nice useful error message explaining that the user must update their sage script by copying over the one from SAGE_ROOT, and edit the path, or create a symbolic link. 

Also a good point.  I would go for a warning with explanation and then

```
exec "$SAGE_ROOT/spkg/bin/sage" "$`@`"
```



---

Comment by jdemeyer created at 2012-01-18 19:56:33

William or somebody else with OS X 10.6: please test the Mac App at
[http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.beta1-OSX-64bit-10.6-x86_64-Darwin-app.dmg](http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.beta1-OSX-64bit-10.6-x86_64-Darwin-app.dmg)
The point is really to test whether the "App" part works, not to "make (p)test(long)" or anything.


---

Comment by was created at 2012-01-18 19:59:33

I'm testing the app bundle right now...


---

Comment by jdemeyer created at 2012-01-18 20:06:04

Replying to [comment:78 was]:
> or the spkg/base directory is already gone!
Just to clarify: we never remove the `spkg/base` directory.  Things like `prereq-0.9-install` would still live  in that directory, but now as part of the root repository.

> This is the sort of situation where Python would be better.
Or `set -e`, see my sage-devel post.


---

Comment by jdemeyer created at 2012-01-18 21:14:15

Changing status from needs_work to needs_review.


---

Attachment

William, I implemented the changes you asked.  I solved the "cd" followed by "rm -rf" problem by using "cd && rm".  I also made this change in an unrelated part of `sage-bdist`.


---

Attachment


---

Comment by was created at 2012-01-18 23:27:59

The app bundle *almost* works (on OS X 10.7 even), but does not quite.  Basically it goes to this URL:

```
http://localhost:0/new_worksheet
```

and

```
http://localhost:0
```

This of course does not work at all.  Changing the 0 to 8000 works.  Everything else seems to work fine though. 

I'm happy with your change for "rm -rf".  If the port got fixed (to 8000), I think this should get a positive review.


---

Comment by jhpalmieri created at 2012-01-18 23:47:58

I think it looks good, too.


---

Comment by jdemeyer created at 2012-01-19 08:14:27

Replying to [comment:85 was]:
> The app bundle *almost* works (on OS X 10.7 even), but does not quite.  Basically it goes to this URL:
> {{{
> http://localhost:0/new_worksheet
> }}}
> and
> {{{
> http://localhost:0
> }}}
> This of course does not work at all.
Is this a regression due to this ticket?  Looks unlikely to me.


---

Comment by jdemeyer created at 2012-01-19 10:07:30

Replying to [comment:85 was]:
> The app bundle *almost* works (on OS X 10.7 even), but does not quite.  Basically it goes to this URL:
> {{{
> http://localhost:0/new_worksheet
> }}}
> and
> {{{
> http://localhost:0
> }}}
> This of course does not work at all.
Does `sage -n` from the command-line work?


---

Comment by jdemeyer created at 2012-01-19 10:54:25

Does the 4.8.rc0 Mac App work:
[http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-4.8.rc0-OSX-64bit-10.6-x86_64-Darwin-app.dmg](http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-4.8.rc0-OSX-64bit-10.6-x86_64-Darwin-app.dmg)


---

Comment by was created at 2012-01-19 16:44:28

> Does sage -n from the command-line work?

Yes, perfectly.


---

Comment by was created at 2012-01-19 17:16:05

Replying to [comment:89 jdemeyer]:
> Does the 4.8.rc0 Mac App work:
> [http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-4.8.rc0-OSX-64bit-10.6-x86_64-Darwin-app.dmg](http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-4.8.rc0-OSX-64bit-10.6-x86_64-Darwin-app.dmg)

Yes, it appears to work perfectly.


---

Comment by jhpalmieri created at 2012-01-20 00:50:46

Replying to [comment:85 was]:
> The app bundle *almost* works (on OS X 10.7 even), but does not quite.

I'd like to test this out, too. Can you explain what you mean by the app bundle?  Do you mean "sage --bdist ..." with "SAGE_APP_BUNDLE=yes" on a Mac?


---

Comment by kcrisman created at 2012-01-20 01:37:13

> I'd like to test this out, too. Can you explain what you mean by the app bundle?  Do you mean "sage --bdist ..." with "SAGE_APP_BUNDLE=yes" on a Mac?
Yes.


---

Comment by jhpalmieri created at 2012-01-20 04:20:41

When I use the app bundle, I see this in the log file:

```
/Users/palmieri/Desktop/Sage-5.0.pa1.app/Contents/Resources/start-sage.sh: line 41: ./local/bin/sage-env: No such file or directory
```

I wonder if there should be a place-holder script local/bin/sage-env which runs spkg/bin/sage-env.  Otherwise, the file `SAGE_ROOT/data/extcode/sage/ext/mac-app/start-sage.sh` will have to be changed. 

I do not see the wrong port, though: I see `8000`, not `0`.


---

Comment by jhpalmieri created at 2012-01-20 04:20:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-20 08:25:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-20 08:25:38

Replying to [comment:94 jhpalmieri]:
> The file `SAGE_ROOT/data/extcode/sage/ext/mac-app/start-sage.sh` will have to be changed.
I fixed precisely that error in [attachment:11073_extcode.patch].  I assume you have an older version without that patch?


---

Comment by jdemeyer created at 2012-01-20 08:26:59

Mac App testers: please test
[http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.prealpha3-OSX-64bit-10.6-x86_64-Darwin-app.dmg](http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.prealpha3-OSX-64bit-10.6-x86_64-Darwin-app.dmg)

This includes the latest version of this ticket.


---

Comment by jdemeyer created at 2012-01-20 09:16:31

If it's just the Mac App holding us back, I would prefer to have this ticket set to positive_review.  The best way to further test this ticket is to merge it in sage-5.0.beta0.  Any small remaining issues can still be fixed in later betas.


---

Comment by iandrus created at 2012-01-20 11:39:26

Replying to [comment:96 jdemeyer]:
> Mac App testers: please test
> [http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.prealpha3-OSX-64bit-10.6-x86_64-Darwin-app.dmg](http://boxen.math.washington.edu/home/buildbot/binaries/sage/sage-5.0.prealpha3-OSX-64bit-10.6-x86_64-Darwin-app.dmg)
> 
> This includes the latest version of this ticket.

It worked for me, but only after I realized that I could no longer use an older external sage distribution because of the `local/bin/sage-env` to `spkg/bin/sage-env` change.  I think we should load `spkg/bin/sage-env` or if it doesn't exist then source `local/bin/sage-env`.  Of course I'm probably the only one who uses external sage distributions so I won't insist. :-)


---

Comment by jdemeyer created at 2012-01-20 12:41:26

Replying to [comment:98 iandrus]:
> It worked for me, but only after I realized that I could no longer use an older external sage distribution
What's an "external sage distribution"?


---

Comment by iandrus created at 2012-01-20 14:12:10

Replying to [comment:99 jdemeyer]:
> Replying to [comment:98 iandrus]:
> > It worked for me, but only after I realized that I could no longer use an older external sage distribution
> What's an "external sage distribution"?

Sorry for being unclear.  You can point the app at any sage directory you want (SAGE_ROOT) instead of the one built in.   I do this since when I build a new app for development I don't want to copy sage into it.  It also allows me to upgrade sage independently of Sage.app.  

So I had told it to use an unpatched sage 4.7.2 which won't work.


---

Comment by jdemeyer created at 2012-01-20 14:22:59

iandrus: If that's what you do, I don't find it a problem that the Apps for sage-4.x and sage-5.x are incompatible.


---

Comment by jhpalmieri created at 2012-01-20 17:52:57

I think it's very nice to be able to point the app at any Sage directory.  It seems easy to avoid breaking that feature, so if not here, then we should have a follow-up ticket which tries `spkg/bin/sage-env` and if that doesn't exist, then it uses `local/bin/sage-env`.  Can we just do something like this?

```diff
diff --git a/sage/ext/mac-app/start-sage.sh b/sage/ext/mac-app/start-sage.sh
--- a/sage/ext/mac-app/start-sage.sh
+++ b/sage/ext/mac-app/start-sage.sh
`@``@` -38,7 +38,8 `@``@` cd /tmp/sage-mac-app || exit 1
 
 # Set (i.e. "source") SAGE_ROOT and all the other environment settings
 echo Setting environment variables >> "$SAGE_LOG"
-. ./spkg/bin/sage-env >> "$SAGE_LOG" 2>> "$SAGE_LOG"
+. ./spkg/bin/sage-env >> "$SAGE_LOG" 2>> "$SAGE_LOG" || \
+. ./local/bin/sage-env >> "$SAGE_LOG" 2>> "$SAGE_LOG"
 export SAGE_ROOT
 
 # Mac OS X app bundles are *intended* to be moved around, and/or given away
```

Should we fix this here or on a followup?

jdemeyer: you're right, I missed that patch.  I read it and thought it made sense, but then forgot about it and didn't apply it.


---

Comment by jdemeyer created at 2012-01-20 22:36:30

OKay, new extcode patch for the Mac App, totally untested (I don't have a Mac).


---

Attachment

This works for me.  With an old version of Sage, a message about spkg/bin/sage-env not existing still shows up, but the server starts anyway, as it should.

Any objections to giving this a positive review?


---

Comment by jdemeyer created at 2012-01-22 13:11:58

Resolution: fixed


---

Comment by jdemeyer created at 2012-01-22 13:11:58

Let's give this positive_review and release sage-5.0.beta0.
