# Issue 10499: Allow symbolic matrices to be simplified elementwise

archive/issues_010499.json:
```json
{
    "body": "Assignee: burcin\n\nCC:  jason rbeezer\n\nKeywords: matrix symbolic simplify expand\n\nAs with [several](http://ask.sagemath.org/question/211/is-there-a-way-to-simplify_full-and-trig_reduce-a) [questions](http://ask.sagemath.org/question/273/reduce_trig-for-matrices) at ask.sagemath.  Mike Hansen's answer at the first one seems like a good start:\n\n```\nage: m = matrix([[sin(x), cos(x)], [sin(x), cos(x)]]); m\n[sin(x) cos(x)]\n[sin(x) cos(x)]\nsage: o = m*m.transpose(); o\n[sin(x)^2 + cos(x)^2 sin(x)^2 + cos(x)^2]\n[sin(x)^2 + cos(x)^2 sin(x)^2 + cos(x)^2]\nsage: o.apply_map(lambda x: x.trig_reduce())\n[1 1]\n[1 1]\n```\n\nbut it seems reasonable for matrices with symbolic elements to have some of these methods (also vectors, I suppose) without having to use any special terminology.  \n\nOpen to suggestions on how that might be accomplished without creating a myriad of special methods, but by somehow piggybacking on `symbolic.expression.Expression` methods done elementwise...\n\nPutting this under symbolics because it isn't really linear algebra, but that doesn't seem right either.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10552\n\n",
    "created_at": "2011-01-04T03:01:09Z",
    "labels": [
        "symbolics",
        "minor",
        "enhancement"
    ],
    "title": "Allow symbolic matrices to be simplified elementwise",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10499",
    "user": "kcrisman"
}
```
Assignee: burcin

CC:  jason rbeezer

Keywords: matrix symbolic simplify expand

As with [several](http://ask.sagemath.org/question/211/is-there-a-way-to-simplify_full-and-trig_reduce-a) [questions](http://ask.sagemath.org/question/273/reduce_trig-for-matrices) at ask.sagemath.  Mike Hansen's answer at the first one seems like a good start:

```
age: m = matrix([[sin(x), cos(x)], [sin(x), cos(x)]]); m
[sin(x) cos(x)]
[sin(x) cos(x)]
sage: o = m*m.transpose(); o
[sin(x)^2 + cos(x)^2 sin(x)^2 + cos(x)^2]
[sin(x)^2 + cos(x)^2 sin(x)^2 + cos(x)^2]
sage: o.apply_map(lambda x: x.trig_reduce())
[1 1]
[1 1]
```

but it seems reasonable for matrices with symbolic elements to have some of these methods (also vectors, I suppose) without having to use any special terminology.  

Open to suggestions on how that might be accomplished without creating a myriad of special methods, but by somehow piggybacking on `symbolic.expression.Expression` methods done elementwise...

Putting this under symbolics because it isn't really linear algebra, but that doesn't seem right either.

Issue created by migration from https://trac.sagemath.org/ticket/10552





---

archive/issue_comments_109500.json:
```json
{
    "body": "In the code written for #10132 (metric surfaces in 3D), we compute a lot of symbolic matrices with complicated entries which eventually need to be simplified.  The current patch adds a method `simplify_full` to the symbolic matrix class, which simply calls the same method on each of the matrix elements.",
    "created_at": "2011-05-16T06:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109500",
    "user": "jvkersch"
}
```

In the code written for #10132 (metric surfaces in 3D), we compute a lot of symbolic matrices with complicated entries which eventually need to be simplified.  The current patch adds a method `simplify_full` to the symbolic matrix class, which simply calls the same method on each of the matrix elements.



---

archive/issue_comments_109501.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-05-16T06:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109501",
    "user": "jvkersch"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_109502.json:
```json
{
    "body": "Thanks for the patch!  I am not in a position to review it right now, but it seems fine at a glance.\n\nTwo comments:\n* The ticket actually asks for access to all simplification methods, if possible.  Possibly also for vectors.  It's okay if you are aiming a little lower, but then we'll want to open another ticket for the more general thing.  (Or that new ticket could be connected to this one so that people fixing this one knew about it.  Or whatever.)\n* The commit message is a little long for that first line; we want it to be about 80 characters or less so that it looks nice in a terminal.  You can add additional lines that are as long as you like, of course.",
    "created_at": "2011-05-16T12:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109502",
    "user": "kcrisman"
}
```

Thanks for the patch!  I am not in a position to review it right now, but it seems fine at a glance.

Two comments:
* The ticket actually asks for access to all simplification methods, if possible.  Possibly also for vectors.  It's okay if you are aiming a little lower, but then we'll want to open another ticket for the more general thing.  (Or that new ticket could be connected to this one so that people fixing this one knew about it.  Or whatever.)
* The commit message is a little long for that first line; we want it to be about 80 characters or less so that it looks nice in a terminal.  You can add additional lines that are as long as you like, of course.



---

archive/issue_comments_109503.json:
```json
{
    "body": "Ah, sorry to overlook the other simplification methods!  I'll get onto it.   Also, the code for vectors is now #11335, and I'll update that patch in tandem with this one.\n\nOne thing that I noticed in the symbolic matrix class is that (for instance) the ``simplify_trig`` method duplicates the code from the elementwise trig simplification.  Presumably we want the matrix method to call the simplification method on the elements?  This doesn't result too much of a performance loss (47.4ms for elementwise calls, 32.7ms for the duplicate code), so I'll just go ahead and rewrite all of the simplification methods.  However, if there's a good reason for doing things the way they are, please let me know and I'll revert.",
    "created_at": "2011-05-16T17:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109503",
    "user": "jvkersch"
}
```

Ah, sorry to overlook the other simplification methods!  I'll get onto it.   Also, the code for vectors is now #11335, and I'll update that patch in tandem with this one.

One thing that I noticed in the symbolic matrix class is that (for instance) the ``simplify_trig`` method duplicates the code from the elementwise trig simplification.  Presumably we want the matrix method to call the simplification method on the elements?  This doesn't result too much of a performance loss (47.4ms for elementwise calls, 32.7ms for the duplicate code), so I'll just go ahead and rewrite all of the simplification methods.  However, if there's a good reason for doing things the way they are, please let me know and I'll revert.



---

archive/issue_comments_109504.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-05-16T17:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109504",
    "user": "jvkersch"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_109505.json:
```json
{
    "body": "Huh, I didn't even notice that these already existed - I should have, and probably even helped review it... sigh.  \n\nI think the difference here is that we're using Maxima to simplify the whole matrix, instead of doing it elementwise.    Maybe that would be better, since Maxima might be faster (especially once we are using the library interface).   So the real question is whether there are any simplifications that are better done elementwise than all at once by Maxima.\n\nIn fact, my guess is that Maxima just does them elementwise in any case, in which case they should all look like they already do - it would be faster, as you point out.\n\nSo this ticket really is asking to increase the number of methods available. `simplify_full` is a notable missing method, but notice that while `simplify_trig` is available, `trig_reduce` and `reduce_trig` are not.  Though I guess those are technically different, looking at the underlying code...",
    "created_at": "2011-05-16T19:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109505",
    "user": "kcrisman"
}
```

Huh, I didn't even notice that these already existed - I should have, and probably even helped review it... sigh.  

I think the difference here is that we're using Maxima to simplify the whole matrix, instead of doing it elementwise.    Maybe that would be better, since Maxima might be faster (especially once we are using the library interface).   So the real question is whether there are any simplifications that are better done elementwise than all at once by Maxima.

In fact, my guess is that Maxima just does them elementwise in any case, in which case they should all look like they already do - it would be faster, as you point out.

So this ticket really is asking to increase the number of methods available. `simplify_full` is a notable missing method, but notice that while `simplify_trig` is available, `trig_reduce` and `reduce_trig` are not.  Though I guess those are technically different, looking at the underlying code...



---

archive/issue_comments_109506.json:
```json
{
    "body": "Replying to [comment:4 kcrisman]:\n\n> I think the difference here is that we're using Maxima to simplify the whole matrix, instead of doing it elementwise.    Maybe that would be better, since Maxima might be faster (especially once we are using the library interface).   So the real question is whether there are any simplifications that are better done elementwise than all at once by Maxima.\n\nGood point.  I did some comparisons for various matrix sizes of simplify_trig elementwise versus by passing the whole matrix to Maxima, and it seems passing the matrix directly to maxima is about 50% faster.  For large-ish matrices (say, 10x10) this is already considerable (1 sec. vs 450 ms. for a random matrix involving sines and cosines). I will therefore use the matrix version wherever available.",
    "created_at": "2011-05-16T22:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109506",
    "user": "jvkersch"
}
```

Replying to [comment:4 kcrisman]:

> I think the difference here is that we're using Maxima to simplify the whole matrix, instead of doing it elementwise.    Maybe that would be better, since Maxima might be faster (especially once we are using the library interface).   So the real question is whether there are any simplifications that are better done elementwise than all at once by Maxima.

Good point.  I did some comparisons for various matrix sizes of simplify_trig elementwise versus by passing the whole matrix to Maxima, and it seems passing the matrix directly to maxima is about 50% faster.  For large-ish matrices (say, 10x10) this is already considerable (1 sec. vs 450 ms. for a random matrix involving sines and cosines). I will therefore use the matrix version wherever available.



---

archive/issue_comments_109507.json:
```json
{
    "body": "Robert Bradshaw proposed a nice way at #11381 of implementing elementwise methods by using the corresponding functionality in ``Expression`` but I don't think this trick will work for matrices, as they are cdef classes.  So I went ahead and just implemented the elementwise methods piece by piece.  It's not exactly rocket science, but we can always replace these elementwise methods by something more clever later on...",
    "created_at": "2011-05-31T02:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109507",
    "user": "jvkersch"
}
```

Robert Bradshaw proposed a nice way at #11381 of implementing elementwise methods by using the corresponding functionality in ``Expression`` but I don't think this trick will work for matrices, as they are cdef classes.  So I went ahead and just implemented the elementwise methods piece by piece.  It's not exactly rocket science, but we can always replace these elementwise methods by something more clever later on...



---

archive/issue_comments_109508.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-05-31T02:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109508",
    "user": "jvkersch"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_109509.json:
```json
{
    "body": "Simplification methods for matrices",
    "created_at": "2011-05-31T02:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109509",
    "user": "jvkersch"
}
```

Simplification methods for matrices



---

archive/issue_comments_109510.json:
```json
{
    "body": "Attachment [sage-symb-matrices.patch](tarball://root/attachments/some-uuid/ticket10552/sage-symb-matrices.patch) by kcrisman created at 2011-06-16 04:43:47\n\nWe can probably open another ticket for all the expand methods...",
    "created_at": "2011-06-16T04:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109510",
    "user": "kcrisman"
}
```

Attachment [sage-symb-matrices.patch](tarball://root/attachments/some-uuid/ticket10552/sage-symb-matrices.patch) by kcrisman created at 2011-06-16 04:43:47

We can probably open another ticket for all the expand methods...



---

archive/issue_comments_109511.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-06-16T04:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109511",
    "user": "kcrisman"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_109512.json:
```json
{
    "body": "Good examples, good methods, comprehensive.  Passes tests.\n\n**But** there are optional arguments to some of these, which we might as well allow now.  For instance `simplify_trig` has an `expand=True` option.  These should all be added, just for completeness.\n\nOtherwise, really nice.",
    "created_at": "2011-06-16T04:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109512",
    "user": "kcrisman"
}
```

Good examples, good methods, comprehensive.  Passes tests.

**But** there are optional arguments to some of these, which we might as well allow now.  For instance `simplify_trig` has an `expand=True` option.  These should all be added, just for completeness.

Otherwise, really nice.



---

archive/issue_comments_109513.json:
```json
{
    "body": "Thanks a lot for agreeing to review this!\n\nI was going over the optional arguments, and for the element-wise methods this is easy to incorporate.  However, for the methods that pass the whole matrix to Maxima, I don't know if it's feasible to have the same optional arguments, as that would amount to duplicating the code from the corresponding method in `Expression`.  So I could either leave those methods as is, or replace them with element-wise methods that have the same calling convention but are somewhat slower.\n\nSecondly, I can easily add *all* element-wise methods, but that would amount to a big increase in not-so-interesting code.  As you write in the description, it would be really cool to have a mechanism for adding the corresponding methods from ``Expression`` directly (similar to #11381 but this doesn't work for cdef classes).",
    "created_at": "2011-06-17T00:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109513",
    "user": "jvkersch"
}
```

Thanks a lot for agreeing to review this!

I was going over the optional arguments, and for the element-wise methods this is easy to incorporate.  However, for the methods that pass the whole matrix to Maxima, I don't know if it's feasible to have the same optional arguments, as that would amount to duplicating the code from the corresponding method in `Expression`.  So I could either leave those methods as is, or replace them with element-wise methods that have the same calling convention but are somewhat slower.

Secondly, I can easily add *all* element-wise methods, but that would amount to a big increase in not-so-interesting code.  As you write in the description, it would be really cool to have a mechanism for adding the corresponding methods from ``Expression`` directly (similar to #11381 but this doesn't work for cdef classes).



---

archive/issue_comments_109514.json:
```json
{
    "body": "Instead of duplicating code, it would be better to move the simplification code in `expression.pyx` to the relevant class in the maxima interface. For example move it to a method `MaximaElement`, then call that from symbolic matrices and expressions. I don't know the exact place where these should go in the maxima interface after the transition to libMaxima though.",
    "created_at": "2011-06-17T01:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109514",
    "user": "burcin"
}
```

Instead of duplicating code, it would be better to move the simplification code in `expression.pyx` to the relevant class in the maxima interface. For example move it to a method `MaximaElement`, then call that from symbolic matrices and expressions. I don't know the exact place where these should go in the maxima interface after the transition to libMaxima though.



---

archive/issue_comments_109515.json:
```json
{
    "body": "Yes, that's a good idea, but how does Maxima simplify these guys?  Do they do it elementwise?",
    "created_at": "2011-06-17T01:41:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109515",
    "user": "kcrisman"
}
```

Yes, that's a good idea, but how does Maxima simplify these guys?  Do they do it elementwise?



---

archive/issue_comments_109516.json:
```json
{
    "body": "Attachment [trac-10552-symbolic-matrices.patch](tarball://root/attachments/some-uuid/ticket10552/trac-10552-symbolic-matrices.patch) by jvkersch created at 2011-06-19 04:18:28\n\nNew version of simplify patch",
    "created_at": "2011-06-19T04:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109516",
    "user": "jvkersch"
}
```

Attachment [trac-10552-symbolic-matrices.patch](tarball://root/attachments/some-uuid/ticket10552/trac-10552-symbolic-matrices.patch) by jvkersch created at 2011-06-19 04:18:28

New version of simplify patch



---

archive/issue_comments_109517.json:
```json
{
    "body": "I really like the suggestion of moving the simplification methods to somewhere closer to the maxima interface.  I would like to look into this, as it would give me a good chance of learning a more complex part of Sage.  \n\nIn the meantime, I've uploaded a new version of the patch (I changed the filename to include the patch number -- the other patch can be deleted), but I'm still in two minds about optional parameters.  Adding the `expand=True` parameter to `simplify_trig` was easy as it just involved one line of extra code, but for the other methods we run into the problems mentioned earlier, and we would have to choose between duplicating the code in `symbolic.expression.Expression` or calling the methods element-wise.  Hopefully the proposed change to the maxima interface will resolve this...",
    "created_at": "2011-06-19T04:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109517",
    "user": "jvkersch"
}
```

I really like the suggestion of moving the simplification methods to somewhere closer to the maxima interface.  I would like to look into this, as it would give me a good chance of learning a more complex part of Sage.  

In the meantime, I've uploaded a new version of the patch (I changed the filename to include the patch number -- the other patch can be deleted), but I'm still in two minds about optional parameters.  Adding the `expand=True` parameter to `simplify_trig` was easy as it just involved one line of extra code, but for the other methods we run into the problems mentioned earlier, and we would have to choose between duplicating the code in `symbolic.expression.Expression` or calling the methods element-wise.  Hopefully the proposed change to the maxima interface will resolve this...



---

archive/issue_comments_109518.json:
```json
{
    "body": "Replying to [comment:12 jvkersch]:\n> I really like the suggestion of moving the simplification methods to somewhere closer to the maxima interface.  I would like to look into this, as it would give me a good chance of learning a more complex part of Sage.  \n\nIIRC, Nils Bruin did this for integration, summation, limits, etc. in the library interface to maxima. You can look in the file `sage/interfaces/maxima_lib.py` for examples.",
    "created_at": "2011-06-19T08:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109518",
    "user": "burcin"
}
```

Replying to [comment:12 jvkersch]:
> I really like the suggestion of moving the simplification methods to somewhere closer to the maxima interface.  I would like to look into this, as it would give me a good chance of learning a more complex part of Sage.  

IIRC, Nils Bruin did this for integration, summation, limits, etc. in the library interface to maxima. You can look in the file `sage/interfaces/maxima_lib.py` for examples.



---

archive/issue_comments_109519.json:
```json
{
    "body": "See also #12162.  Perhaps this should supersede that.",
    "created_at": "2013-03-13T15:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10499#issuecomment-109519",
    "user": "kcrisman"
}
```

See also #12162.  Perhaps this should supersede that.
