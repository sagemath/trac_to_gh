# Issue 11951: Bug in convolution

archive/issues_011951.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @wdjoyner @kcrisman @jondo @vbraun @slel @mkoeppe @eviatarbach @rwst\n\n\n```\n\nsage: x = PolynomialRing(QQ,'x').gen()\nsage: f = Piecewise([[(-2, 2), 2 * x^0]])\nsage: g = Piecewise([[(0, 2), 3/4 * x^0]])\nsage: n = f.convolution(g)\n\nsage: n\nPiecewise defined function with 3 parts, [[(-2, 0), 3/2*x + 3], [(0, 2), 6], [(2, 4), -3/2*x + 6]]\n```\n\nBut the middle piece should be 3, not 6, apparently.\n\nSee the original report at [this ask.sagemath.org question](http://ask.sagemath.org/question/965/convolution-got-the-wrong-result).\n\nIssue created by migration from https://trac.sagemath.org/ticket/12123\n\n",
    "created_at": "2011-12-06T19:35:29Z",
    "labels": [
        "calculus",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Bug in convolution",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11951",
    "user": "@kcrisman"
}
```
Assignee: @burcin

CC:  @wdjoyner @kcrisman @jondo @vbraun @slel @mkoeppe @eviatarbach @rwst


```

sage: x = PolynomialRing(QQ,'x').gen()
sage: f = Piecewise([[(-2, 2), 2 * x^0]])
sage: g = Piecewise([[(0, 2), 3/4 * x^0]])
sage: n = f.convolution(g)

sage: n
Piecewise defined function with 3 parts, [[(-2, 0), 3/2*x + 3], [(0, 2), 6], [(2, 4), -3/2*x + 6]]
```

But the middle piece should be 3, not 6, apparently.

See the original report at [this ask.sagemath.org question](http://ask.sagemath.org/question/965/convolution-got-the-wrong-result).

Issue created by migration from https://trac.sagemath.org/ticket/12123





---

archive/issue_comments_137456.json:
```json
{
    "body": "The fix is to fix the following\n\n```\n    cmd1 = \"integrate((%s)*(%s),%s,%s,%s)\"%(i1,i2, uu, a1,    tt-b1)    ## if a1+b1 < tt < a2+b1\n    cmd2 = \"integrate((%s)*(%s),%s,%s,%s)\"%(i1,i2, uu, tt-b2, tt-b1)    ## if a1+b2 < tt < a2+b1\n    cmd3 = \"integrate((%s)*(%s),%s,%s,%s)\"%(i1,i2, uu, tt-b2, a2)       ## if a1+b2 < tt < a2+b2\n    cmd4 = \"integrate((%s)*(%s),%s,%s,%s)\"%(i1,i2, uu, a1, a2)          ## if a2+b1 < tt < a1+b2\n    <snip>\n    if a1-b1<a2-b2:\n        if a2+b1!=a1+b2:\n           h = Piecewise([[(a1+b1,a1+b2),fg1],[(a1+b2,a2+b1),fg4],[(a2+b1,a2+b2),fg3]])\n```\n\nto have `f2` instead of `f4`. There is a parallel part as well in the other branch of the if, where `fg2` should be `fg4`, it appears.\n\nThis should be fixed quickly, but should also be checked to make sure it really does do the right thing! The code is not really commented enough to show what is going on with all these different mini-convolutions, one has to really think about it.",
    "created_at": "2011-12-06T19:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137456",
    "user": "@kcrisman"
}
```

The fix is to fix the following

```
    cmd1 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, a1,    tt-b1)    ## if a1+b1 < tt < a2+b1
    cmd2 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, tt-b2, tt-b1)    ## if a1+b2 < tt < a2+b1
    cmd3 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, tt-b2, a2)       ## if a1+b2 < tt < a2+b2
    cmd4 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, a1, a2)          ## if a2+b1 < tt < a1+b2
    <snip>
    if a1-b1<a2-b2:
        if a2+b1!=a1+b2:
           h = Piecewise([[(a1+b1,a1+b2),fg1],[(a1+b2,a2+b1),fg4],[(a2+b1,a2+b2),fg3]])
```

to have `f2` instead of `f4`. There is a parallel part as well in the other branch of the if, where `fg2` should be `fg4`, it appears.

This should be fixed quickly, but should also be checked to make sure it really does do the right thing! The code is not really commented enough to show what is going on with all these different mini-convolutions, one has to really think about it.



---

archive/issue_comments_137457.json:
```json
{
    "body": "[Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.\n\n```\nx = PolynomialRing(QQ, 'x').gen()\nf1 = Piecewise([[(-1, 1), 1*x^0]])\nf2 = Piecewise([[(0, 1), x], [(1, 2), -x + 2]])\ng = f2.convolution(f1)\nPiecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x +1/2], [(0, 1), -1/2*x^2 + 3*x], [(1, 2), -1/2*x^2 - x + 4], [(2, 3), 1/2*x^2 - 3*x + 9/2]].\n```\n\nbut probably should be (according to the report)\n\n```\nPiecewise defined function with 3 parts, [[(-1, 0), 0.5*x^2 + x + 0.5], [(0, 2), -0.5*x^2 + x + 0.5], [(2, 3), 0.5*x^2 - 3*x + 4.5]\n```\n",
    "created_at": "2014-04-03T19:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137457",
    "user": "@kcrisman"
}
```

[Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.

```
x = PolynomialRing(QQ, 'x').gen()
f1 = Piecewise([[(-1, 1), 1*x^0]])
f2 = Piecewise([[(0, 1), x], [(1, 2), -x + 2]])
g = f2.convolution(f1)
Piecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x +1/2], [(0, 1), -1/2*x^2 + 3*x], [(1, 2), -1/2*x^2 - x + 4], [(2, 3), 1/2*x^2 - 3*x + 9/2]].
```

but probably should be (according to the report)

```
Piecewise defined function with 3 parts, [[(-1, 0), 0.5*x^2 + x + 0.5], [(0, 2), -0.5*x^2 + x + 0.5], [(2, 3), 0.5*x^2 - 3*x + 4.5]
```




---

archive/issue_comments_137458.json:
```json
{
    "body": "In fact,\n\n```\n    if a1-b1<a2-b2:\n        if a2+b1!=a1+b2:\n```\n\ndoesn't even make sense; if the former is true, so is the latter?  What on earth is going on here?  I think an extra branch snuck in, in addition to the typo.",
    "created_at": "2014-04-04T02:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137458",
    "user": "@kcrisman"
}
```

In fact,

```
    if a1-b1<a2-b2:
        if a2+b1!=a1+b2:
```

doesn't even make sense; if the former is true, so is the latter?  What on earth is going on here?  I think an extra branch snuck in, in addition to the typo.



---

archive/issue_comments_137459.json:
```json
{
    "body": "See also #14801, though I don't know that will help with this.",
    "created_at": "2014-04-08T01:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137459",
    "user": "@kcrisman"
}
```

See also #14801, though I don't know that will help with this.



---

archive/issue_comments_137460.json:
```json
{
    "body": "See #17793 (possible dup)",
    "created_at": "2015-02-17T18:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137460",
    "user": "@kcrisman"
}
```

See #17793 (possible dup)



---

archive/issue_comments_137461.json:
```json
{
    "body": "Replying to [comment:4 kcrisman]:\n> [Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.\nThe two curve parts before addition look like this\n<img src=\"http://s18.postimg.org/uptxg06pl/tmp_hd_MODX.png\" 300px>\nA working implementation should make sure that, when they are added, only three intervals remain.\n\n```\nsage: f = Piecewise([[(0, 1), -1/2*x^2 + x],[(1, 2), 1/2],[(2, 3), 1/2*x^2 - 3*x + 9/2]])\nsage: g = Piecewise([[(-1, 0), 1/2*x^2 + x + 1/2],[(0, 1), 1/2],[(1, 2), -1/2*x^2 + x]])\nsage: f+g\nPiecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x + 1/2], [(0, 1), -1/2*x^2 + x + 1/2], [(1, 2), -1/2*x^2 + x + 1/2], [(2, 3), 1/2*x^2 - 3*x + 9/2]]\n```\n",
    "created_at": "2015-02-19T09:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137461",
    "user": "@rwst"
}
```

Replying to [comment:4 kcrisman]:
> [Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.
The two curve parts before addition look like this
<img src="http://s18.postimg.org/uptxg06pl/tmp_hd_MODX.png" 300px>
A working implementation should make sure that, when they are added, only three intervals remain.

```
sage: f = Piecewise([[(0, 1), -1/2*x^2 + x],[(1, 2), 1/2],[(2, 3), 1/2*x^2 - 3*x + 9/2]])
sage: g = Piecewise([[(-1, 0), 1/2*x^2 + x + 1/2],[(0, 1), 1/2],[(1, 2), -1/2*x^2 + x]])
sage: f+g
Piecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x + 1/2], [(0, 1), -1/2*x^2 + x + 1/2], [(1, 2), -1/2*x^2 + x + 1/2], [(2, 3), 1/2*x^2 - 3*x + 9/2]]
```




---

archive/issue_comments_137462.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2016-06-25T17:45:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137462",
    "user": "@mkoeppe"
}
```

Changing priority from major to minor.



---

archive/issue_comments_137463.json:
```json
{
    "body": "Changing keywords from \"\" to \"piecewise\".",
    "created_at": "2016-06-25T17:45:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137463",
    "user": "@mkoeppe"
}
```

Changing keywords from "" to "piecewise".



---

archive/issue_comments_137464.json:
```json
{
    "body": "Description modified to comment that this seems fixed in the new `piecewise` (#14801).",
    "created_at": "2016-06-25T17:45:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137464",
    "user": "@mkoeppe"
}
```

Description modified to comment that this seems fixed in the new `piecewise` (#14801).



---

archive/issue_comments_137465.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-10T19:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137465",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_137466.json:
```json
{
    "body": "piecewise_old will be removed in #26865",
    "created_at": "2018-12-10T19:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137466",
    "user": "@fchapoton"
}
```

piecewise_old will be removed in #26865



---

archive/issue_comments_137467.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-12T02:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137467",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_137468.json:
```json
{
    "body": "Presuming these are all correctly reviewed as either duplicate, invalid, or wontfix.",
    "created_at": "2019-02-26T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137468",
    "user": "@embray"
}
```

Presuming these are all correctly reviewed as either duplicate, invalid, or wontfix.



---

archive/issue_comments_137469.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2019-02-26T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11951",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11951#issuecomment-137469",
    "user": "@embray"
}
```

Resolution: invalid
