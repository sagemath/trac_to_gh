# Issue 11951: Bug in convolution

Issue created by migration from https://trac.sagemath.org/ticket/12123

Original creator: kcrisman

Original creation time: 2011-12-06 19:35:29

Assignee: burcin

CC:  wdj kcrisman jondo vbraun slelievre mkoeppe eviatarbach rws


```

sage: x = PolynomialRing(QQ,'x').gen()
sage: f = Piecewise([[(-2, 2), 2 * x^0]])
sage: g = Piecewise([[(0, 2), 3/4 * x^0]])
sage: n = f.convolution(g)

sage: n
Piecewise defined function with 3 parts, [[(-2, 0), 3/2*x + 3], [(0, 2), 6], [(2, 4), -3/2*x + 6]]
```

But the middle piece should be 3, not 6, apparently.

See the original report at [this ask.sagemath.org question](http://ask.sagemath.org/question/965/convolution-got-the-wrong-result).


---

Comment by kcrisman created at 2011-12-06 19:38:37

The fix is to fix the following

```
    cmd1 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, a1,    tt-b1)    ## if a1+b1 < tt < a2+b1
    cmd2 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, tt-b2, tt-b1)    ## if a1+b2 < tt < a2+b1
    cmd3 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, tt-b2, a2)       ## if a1+b2 < tt < a2+b2
    cmd4 = "integrate((%s)*(%s),%s,%s,%s)"%(i1,i2, uu, a1, a2)          ## if a2+b1 < tt < a1+b2
    <snip>
    if a1-b1<a2-b2:
        if a2+b1!=a1+b2:
           h = Piecewise([[(a1+b1,a1+b2),fg1],[(a1+b2,a2+b1),fg4],[(a2+b1,a2+b2),fg3]])
```

to have `f2` instead of `f4`. There is a parallel part as well in the other branch of the if, where `fg2` should be `fg4`, it appears.

This should be fixed quickly, but should also be checked to make sure it really does do the right thing! The code is not really commented enough to show what is going on with all these different mini-convolutions, one has to really think about it.


---

Comment by kcrisman created at 2014-04-03 19:40:10

[Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.

```
x = PolynomialRing(QQ, 'x').gen()
f1 = Piecewise([[(-1, 1), 1*x^0]])
f2 = Piecewise([[(0, 1), x], [(1, 2), -x + 2]])
g = f2.convolution(f1)
Piecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x +1/2], [(0, 1), -1/2*x^2 + 3*x], [(1, 2), -1/2*x^2 - x + 4], [(2, 3), 1/2*x^2 - 3*x + 9/2]].
```

but probably should be (according to the report)

```
Piecewise defined function with 3 parts, [[(-1, 0), 0.5*x^2 + x + 0.5], [(0, 2), -0.5*x^2 + x + 0.5], [(2, 3), 0.5*x^2 - 3*x + 4.5]
```



---

Comment by kcrisman created at 2014-04-04 02:20:21

In fact,

```
    if a1-b1<a2-b2:
        if a2+b1!=a1+b2:
```

doesn't even make sense; if the former is true, so is the latter?  What on earth is going on here?  I think an extra branch snuck in, in addition to the typo.


---

Comment by kcrisman created at 2014-04-08 01:17:55

See also #14801, though I don't know that will help with this.


---

Comment by kcrisman created at 2015-02-17 18:43:26

See #17793 (possible dup)


---

Comment by rws created at 2015-02-19 09:49:30

Replying to [comment:4 kcrisman]:
> [Here's another report](http://math.stackexchange.com/questions/362055) that is almost certainly the same thing.
The two curve parts before addition look like this
<img src="http://s18.postimg.org/uptxg06pl/tmp_hd_MODX.png" 300px>
A working implementation should make sure that, when they are added, only three intervals remain.

```
sage: f = Piecewise([[(0, 1), -1/2*x^2 + x],[(1, 2), 1/2],[(2, 3), 1/2*x^2 - 3*x + 9/2]])
sage: g = Piecewise([[(-1, 0), 1/2*x^2 + x + 1/2],[(0, 1), 1/2],[(1, 2), -1/2*x^2 + x]])
sage: f+g
Piecewise defined function with 4 parts, [[(-1, 0), 1/2*x^2 + x + 1/2], [(0, 1), -1/2*x^2 + x + 1/2], [(1, 2), -1/2*x^2 + x + 1/2], [(2, 3), 1/2*x^2 - 3*x + 9/2]]
```



---

Comment by mkoeppe created at 2016-06-25 17:45:36

Changing priority from major to minor.


---

Comment by mkoeppe created at 2016-06-25 17:45:36

Changing keywords from "" to "piecewise".


---

Comment by mkoeppe created at 2016-06-25 17:45:36

Description modified to comment that this seems fixed in the new `piecewise` (#14801).


---

Comment by chapoton created at 2018-12-10 19:34:37

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-12-10 19:34:37

piecewise_old will be removed in #26865


---

Comment by tscrim created at 2018-12-12 02:47:43

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-02-26 13:58:00

Presuming these are all correctly reviewed as either duplicate, invalid, or wontfix.


---

Comment by embray created at 2019-02-26 13:58:00

Resolution: invalid
