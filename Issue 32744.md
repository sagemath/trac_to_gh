# Issue 32744: Reduce --warn-long limit for normal (not long-time) test runs

Issue created by migration from https://trac.sagemath.org/ticket/32981

Original creator: mjo

Original creation time: 2021-12-06 12:58:24

CC:  vbraun tornaria

As discussed in #32973, the default value of `--warn-long` is roughly a minute, independent of the `--long` flag. Our developers' guide suggests that even a "long time" test should complete in under five seconds,

https://doc.sagemath.org/html/en/developer/doctesting.html#optional-arguments

so I think it's fair to warn about non-long-time tests that take longer than (say) ten seconds.


---

Comment by mjo created at 2021-12-06 13:18:14

Volker, any idea why we used wall time for the limit rather than CPU time? It's making it a bit awkward to pick a multiplier when no timing information is available (which is usually the case for me).


---

Comment by git created at 2021-12-08 14:37:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-12-08 14:38:45

This is a bit too lenient IMO... allowing 15s for a non-long test when no timing information is available. Still, it's an improvement.


---

Comment by mjo created at 2021-12-08 14:38:45

Changing status from new to needs_review.


---

Comment by mjo created at 2021-12-08 17:42:19

I'm just going to put in the effort to switch this to CPU time, which makes a lot more sense for a time measurement that needs to be consistent across machines.


---

Comment by mjo created at 2021-12-08 17:42:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-12-08 21:08:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-12-08 21:09:43

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-12-08 21:09:43

New commits:


---

Comment by @mwageringel created at 2022-02-08 21:47:17

One reason for using wall time instead of CPU time might be that it works better for computations that use external processes like Pexpect:

```
sage: R = PolynomialRing(GF(101), 'x', 8)
....: J = sage.rings.ideal.Cyclic(R)
....: %time gb = J.groebner_basis(algorithm='singular')
CPU times: user 917 ms, sys: 52.6 ms, total: 969 ms
Wall time: 33.2 s
```



---

Comment by jhpalmieri created at 2022-02-08 22:05:41

Maybe measure both and pay attention to wall time only if it is much longer than CPU time. I don't know if "much longer" should be a raw time (5 seconds longer) or a multiple (10 times as long). We want informative messages, so this doesn't have to be flawless.


---

Comment by mjo created at 2022-02-08 22:15:24

Well.. that's embarrassing. I'll have to think about it.


---

Comment by mjo created at 2022-02-08 22:15:24

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2022-02-08 22:31:39

Oh, we just have to pass `subprocesses=True` inside the doctest timer. I guess nobody noticed until now because the cputime wasn't reported anyway. I'll update the branch once I'm sure it works correctly.


---

Comment by git created at 2022-02-09 15:53:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-02-09 16:26:34

That fixed the immediate problem, but caused several more. Doctesting the doctest framework using the sage pexpect interface to itself is pretty fragile, who would've thought...


---

Comment by git created at 2022-02-09 21:26:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-10 00:05:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-02-10 14:54:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-02-10 15:07:38

Well, at least I know why Volker chose to use walltime now. Several times yesterday I almost quit and wandered into the woods.

Using the existing `cputime(subprocesses=True)` isn't going to work. Our pexpect interfaces are flaky, and we have a lot of doctests that check for low-level "incidental" details that appear when using them. Moreover most don't actually implement `cputime()`. And that's just for standard packages -- the optional ones should be much worse.

I was able to get the tests passing, but only by introducing twice as many WTFs as I discovered. I wouldn't commit such an atrocity, nor do I have the time to properly investigate and fix all of the underlying issues. Instead, I've reverted back to where the branch was two days ago, and added a commit that reliably computes the cputime for all subprocesses.... but only on Linux/BSD. The same information is probably available on macOS, but I don't have it in front of me to poke around.

While platform-specific code is lame, I think this may be a reasonable trade-off, especially if we can get it working on macOS. We only need *someone* to notice & fix long tests, not *everyone*. And the missing information can only hurt for (a) pexpect tests, that (b) happen to run long. So it's not like the entire test suite will have incorrect timing information on e.g. Cygwin.


---

Comment by mkoeppe created at 2022-02-10 18:25:53

If only there were a Python package for that...


---

Comment by mjo created at 2022-02-10 19:00:56

Replying to [comment:19 mkoeppe]:
> If only there were a Python package for that...

If you're referring to psutil, it's mainly a C package and consists of nothing BUT platform-specific code. The version we had was almost five years out of date and required a huge unmaintained patch that was rejected entirely by upstream. I'll take the ten lines we have now instead.

Worst case, we can get the information from the OSX kernel with a another five lines of code.


---

Comment by mjo created at 2022-02-10 19:54:04

The information we need can be obtained from `proc_pidinfo(pid, PROC_PIDTASKINFO,...)` in libproc on macOS. I found a gist that might serve as inspiration:

  https://gist.github.com/nguyen-phillip/de66b0ea2144e20ddd844c41c9d93eb9

In theory all we need to do is get a `proc_taskinfo` struct from that call, and read its `pti_total_user` and `pti_total_system` fields. But I don't have a mac to test on so someone else will have to take this step.


---

Comment by mkoeppe created at 2022-02-10 20:25:09

Replying to [comment:20 mjo]:
> The version we had was almost five years out of date and required a huge unmaintained patch 

We needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.


---

Comment by mjo created at 2022-02-10 21:16:01

Replying to [comment:23 mkoeppe]:
> Replying to [comment:20 mjo]:
> > The version we had was almost five years out of date and required a huge unmaintained patch 
> 
> We needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.

Yes but if mkoeppe ever gets hit by a bus, the rest of us will be crushed under 25 hours/day of package upgrades and maintenance. I appreciate all you do, but there's a huge cost to every additional dependency measured over the years.


---

Comment by mkoeppe created at 2022-02-10 21:20:01

It's a well-maintained package and using it beats maintaining Sage-specific system code ... which is not even written yet ...


---

Comment by mjo created at 2022-02-10 21:40:33

There's a point after which I agree, but assuming that the package itself causes zero problems: every distro needs to package it and keep it upgraded, and every user needs to install it every time they build sage (wasting time, space, and bandwidth), and every upstream release usually gets a ticket->branch->test->review cycle within sage itself.

The total amount of code we're talking about is less than the text files in `build/pkgs/psutil` contained. It's in a non-critical location in a pseudo-private, non-user-facing function. We'll go years without ever thinking about it.


---

Comment by mkoeppe created at 2022-02-10 21:43:55

Replying to [comment:26 mjo]:
> every distro needs to package

https://repology.org/project/python:psutil/versions


---

Comment by mjo created at 2022-02-10 21:51:26

Replying to [comment:27 mkoeppe]:
> 
> https://repology.org/project/python:psutil/versions

That's not the hard part. The Gentoo package is available on amd64, arm, arm64, hppa, ppc, ppc64, sparc, x86, alpha, ia64, riscv, m68k, mips, and s390. Every new version has to be tested, and stabilized, and most introduce new bugs that have to be triaged, upstreamed, patched, etc. If psutil is not used by sage, I don't have to care about any of that. If it is, I often have to step in to ensure that the distro package is compatible with that sage expects. Repeat two-hundred-some times on however-many distros and you have a never-ending stream of work.


---

Comment by mkoeppe created at 2022-02-10 22:01:20

https://gitweb.gentoo.org/repo/gentoo.git/log/dev-python/psutil doesn't look particularly dramatic


---

Comment by mjo created at 2022-02-10 22:18:28

You'd get a better idea from the bug tracker, but I don't know what point we're arguing. Sage was stuck on the same version of psutil for five years. That naturally did not require much maintenance either within sage or without.


---

Comment by mkoeppe created at 2022-02-11 00:10:25

You were trying to argue that somehow creating new homegrown platform-dependent code is a better strategy than just using an existing upstream project (for which we have no particular version requirements and never had).


---

Comment by mjo created at 2022-02-11 01:49:33

headline: man who doesn't do dishes thinks it's more elegant to use a different spoon for each ravioli


---

Comment by git created at 2022-03-12 18:48:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-12 18:54:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-14 14:22:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2022-03-26 01:31:41

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2022-03-26 01:31:41

I ran this on GH but the actions page has been failing to load for a week. I've reported it to GH and a fix is "being worked on." Aside from that, I think it's ready for review.

In the spirit of "do no harm," I have avoided outputting CPU time statistics wherever possible to avoid outputting confusing numbers on macOS. Nevertheless, in context, the lack of fast CPU time for subprocesses on macOS is not a deal-breaker: the only situation where it will be missed is if a subprocess takes a lot of CPU and would normally violate the `--warn-long` limit, and instead appears to run fast on macOS. But the status quo is that using wall time already makes `--warn-long` useless; and false negatives are not harmful. If the purpose of `--warn-long` is to prevent slow tests from being added to sage, then we only need `--warn-long` to trigger _somewhere_ (e.g. the patchbots), and not _everywhere_. Overlooking the occasional warning for certain tests on one platform isn't contrary to that goal, and in any case is not worse than what we already have -- no usable warnings at all.

Of course I'll open a follow-up ticket for adding the macOS accounting should anyone care to do it.


---

Comment by dimpase created at 2022-03-26 11:32:19

In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?


---

Comment by mjo created at 2022-03-26 11:54:51

Replying to [comment:37 dimpase]:
> In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?

It uses wall time for its timeouts and slow test warnings.


---

Comment by mjo created at 2022-03-30 01:07:33

FWIW the GH action results are now visible and look OK.


---

Comment by dimpase created at 2022-06-09 08:51:31

a rebase is due


---

Comment by mjo created at 2022-06-09 12:59:50

I've lost interest.


---

Comment by mjo created at 2022-06-09 12:59:50

Changing status from needs_review to needs_work.
