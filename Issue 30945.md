# Issue 30945: Mutability class and pickling

Issue created by migration from https://trac.sagemath.org/ticket/31182

Original creator: @mjungmath

Original creation time: 2021-01-04 20:06:40

CC:  tscrim mkoeppe @tobiasdiez nbruin

If the class `Mutability` is used as mixin for mutability features, the pickling goes wrong (see [here](https://trac.sagemath.org/ticket/30261#comment:9)).

This is an attempt to fix this.


---

Comment by @mjungmath created at 2021-01-04 20:09:09

Turns out that


```diff
from sage.misc.decorators import sage_wraps
+cimport cython

+@cython.auto_pickle(True)
cdef class Mutability:
```


helps.

But I cannot really tell why that is and if that's a reasonable approach. I am not a pickling expert.

See https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#controlling-pickling.


---

Comment by @mjungmath created at 2021-01-06 12:41:53

New commits:


---

Comment by @mjungmath created at 2021-01-06 12:42:12

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-01-06 19:55:39

Patchbot is green. The change works with ticket #30310 and according changes.


---

Comment by @mjungmath created at 2021-01-09 15:23:16

Would be nice if anyone could give adequate feedback, or cc someone who ought to be an expert. Many tickets depend on it (see #30261).


---

Comment by @mjungmath created at 2021-01-10 10:59:17

Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.

If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?


---

Comment by tscrim created at 2021-01-12 00:17:22

Replying to [comment:12 gh-mjungmath]:
> Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.

This makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well. You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.

> If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?

For speed, pure and simple.


---

Comment by tscrim created at 2021-01-13 07:17:28

Replying to [comment:16 gh-mjungmath]:
> Replying to [comment:13 tscrim]:
> > Replying to [comment:12 gh-mjungmath]:
> > > Why is it a Cython class anyway? Multiple inheritances among Cython classes are not going to work and for Python classes it seems to cause some troubles. I'd vote for turning `Mutability` into a pure Python mix-in class.
> > 
> > This makes no sense. Having this be a Cython class does not influence whether another class *Python* class can inherit this, which can be done in Cython as well.
> 
> Right, it should work, and somehow the pickling is affected.

That is likely an issue with how the pickling is implemented and affects all C/Python classes equally. This likely requires implementations of `__reduce__` in the corresponding classes that use it. It's been awhile since I've looked this closely at a pickling issue. There might be some better/more general way to do it.

> > You run into the exact same problem if you want another `cdef` class to inherit from this and another `cdef` class, which is actually worse because a `cdef` class cannot inherit from a Python class.
> 
> I tend to disagree.

What I said isn't an opinion but a fact.

> The class `Mutability` is intended to be mixed in, right? Every class in Sage must inherit from `SageObject`, either directly or within an inheritance tree. In order to use `Mutability`, we need therefore two inheritances since `Mutability` does _not_ inherit from `SageObject`. But a second inheritance is not allowed if the subsequent class is a Cython class as well. Having `class Sequence(SageObject, Mutability)` on the other hand is allowed but _only_ if `Mutability` is a Python class (see [here](https://cython.readthedocs.io/en/latest/src/userguide/extension_types.html#subclassing) for details).

There is a key difference here: the class being an *extension type*, i.e., a `cdef` class. If you don't believe me, try it. Here is a minimal example:

```
sage: %%cython
....: cdef class Foo:
....:     pass
....: cdef class Bar:
....:     pass
....: class MyClass(Foo, Bar):  # Change to cdef class to see it fail
....:     pass
....:
sage: C = MyClass()
```


> My point is, classes which inherit from another Cython class, in particular any `cdef` class, can therefore _never_ benefit from this mix in class if `Mutability` stays Cythonic (this should hold true for almost every class in Sage).

This is not true. In fact, there are lots of examples in Sage that use `Parent` and `WithEqualityById` via `UniqueRepresentation`.

> On top of it all, the class as it is right now has no use at all. It's neither working on Python classes due to the above error nor on Cython classes due to its inheritance behavior.
> 
> > 
> > > If one really needs the functionality on Cython level, what about a class `SageObjectWithMutability` instead?
> > 
> > For speed, pure and simple.
> 
> I see the need of a speed-up. And I mean, we can keep this class as `cdef` as it is if we get the above bug to work. Then it can only be used in a very limited range of classes in Sage.

See above.

> In any case, due to the above reasons, I suggest a class `SageObjectWithMutability` inheriting from `SageObject` implementing the mutability feature. That would be useful for `Sequence`, `BundleConnection`, `AffineConnection` and probably even more.

Strong -1. See above.


---

Comment by @mjungmath created at 2021-01-13 08:28:26

Ah shit! I remember, we had the same discussion in #30261. For some reason, it was burnt into my head that it wasn't supposed to work. Big sorry and thanks for your patience! #shameonme #embarrassed


---

Comment by @mjungmath created at 2021-01-17 14:12:46

`@`Travis: What about that?


```python
    def __getstate__(self):
        state = self.__dict__
        state['_is_immutable'] = self._is_immutable
        return state
```


Works perfectly.


---

Comment by git created at 2021-01-17 16:46:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-17 16:52:14

Replying to [comment:20 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[1c5d47d](https://git.sagemath.org/sage.git/commit/?id=1c5d47d8c9f1ccca7bafcd45eb6f67d4f71c64db)||`Trac #31182: __getstate__ and __setstate__`||

Here we go. Please check this out. Works perfectly with #30284.


---

Comment by git created at 2021-01-17 20:59:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-01-17 21:02:47

If this approach gets a positive review as well as #30284 based upon that, I'll add an explicit doctest for the pickling with #30284 to this file.

If I understand this correctly, `__setstate__` and `__getstate__` are high level methods so that any implementation of `__reduce__` would overwrite their behavior, which is exactly what we want.


---

Comment by git created at 2021-01-18 08:17:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-01-18 09:28:47

This would work for any Python class I guess. If they implement their own version, then they are already taking responsibility for handling the mutability. It is a little hacky, but it is not so bad and it works for what is likely most cases. Let's see what the patchbot says.


---

Comment by @mjungmath created at 2021-01-18 10:01:37

I tried to write a test into the docstring:


```
sage: class A(SageObject, Mutability):
....:     def __init__(self, val):
....:         self._val = val
....:     def change(self, val):
....:         self._require_mutable()
....:         self._val = val
....:     def __hash__(self):
....:         self._require_immutable()
....:         return hash(self._val)
sage: a = A(4)
sage: loads(dumps(a))
```


The doctest fails with:


```
Failed example:
    loads(dumps(a))
Exception raised:
    Traceback (most recent call last):
      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.mutability.Mutability.__getstate__[2]>", line 1, in <module>
        loads(dumps(a))
      File "sage/misc/persist.pyx", line 291, in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4284)
        return obj.dumps(compress)
      File "sage/structure/sage_object.pyx", line 476, in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3789)
        return _base_dumps(self, compress=compress)
      File "sage/misc/persist.pyx", line 264, in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:4012)
        gherkin = SagePickler.dumps(obj)
      File "sage/misc/persist.pyx", line 771, in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6801)
        pickler.dump(obj)
    _pickle.PicklingError: Can't pickle <class '__main__.A'>: attribute lookup A on __main__ failed

```


It is a bit odd since it works perfectly within a usual Sage instance. Only as a doctest this fails. Doctests where `Mutability` is included in #30284 on the other hand work perfectly again.


---

Comment by @mjungmath created at 2021-01-18 10:15:24

Okay, seems to be perfectly normal, see `_test_pickling` in `sage_object.pyx`:


```

            sage: class Bla(SageObject): pass
            sage: Bla()._test_pickling()
            Traceback (most recent call last):
            ...
            PicklingError: Can't pickle <class '__main__.Bla'>: attribute
            lookup ... failed

        TODO: for a stronger test, this could send the object to a
        remote Sage session, and get it back.
```


I'll just add, as already suggested, some tests from #30284 as soon as this ticket is ready, too.


---

Comment by @mjungmath created at 2021-01-18 21:42:05

Patchbot is satisfied here, too. :)


---

Comment by tscrim created at 2021-01-21 06:55:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-01-21 06:55:06

This will work for now. We can revisit this if further problems arise as we use this class more frequently.


---

Comment by vbraun created at 2021-03-07 17:05:57

Resolution: fixed
