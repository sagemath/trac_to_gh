# Issue 18004: Great speedup in polytopes construction with generic backend

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-04-17 14:24:46

CC:  vbraun ncohen

Construction of polytopes with number field coordinates are very slow. There are several reasons for that:
  - quadratic number field element hash is slow (already solved in #18215)
  - `NumberField.__cmp__` is slow
  - we can avoid many useless copies and recomputation in the algorithm `Vrep2Hrep` and `Hrep2Vrep`

After applying the branch the speedup is really cool...

Before

```
sage: %runfile polyhedron_test.py
sage: %time gr = great_rhombicuboctahedron()
CPU times: user 4.66 s, sys: 24 ms, total: 4.68 s
Wall time: 4.66 s
```

After

```
sage: %runfile polyhedron_test.py
sage: %time gr = great_rhombicuboctahedron()
CPU times: user 292 ms, sys: 28 ms, total: 320 ms
Wall time: 306 ms
```


(But I am still not able to build the [600-cell](http://en.wikipedia.org/wiki/600-cell))


---

Comment by vdelecroix created at 2015-04-17 14:26:58

New commits:


---

Comment by vdelecroix created at 2015-04-17 14:26:58

Changing status from new to needs_review.


---

Attachment


---

Comment by ncohen created at 2015-04-18 08:39:08

Could you say in the ticket's description what the branch does?

Every single thing that you do without explanation, the reviewer has to figure out from the diff file.


---

Comment by vdelecroix created at 2015-04-18 09:27:15

Replying to [comment:3 ncohen]:
> Could you say in the ticket's description what the branch does?
> 
> Every single thing that you do without explanation, the reviewer has to figure out from the diff file.

done!


---

Comment by ncohen created at 2015-04-18 10:27:56

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-04-18 10:27:56

Looks like your mutable object is also hashable
 {{{
sage: DD.__hash__()
1042963791458606606
sage: DD.add_inequality(vector([1,0,0]))
sage: DD.__hash__()
-1000165618804906370
}}}


---

Comment by vdelecroix created at 2015-04-18 10:39:38

Replying to [comment:5 ncohen]:
> Looks like your mutable object is also hashable
>  {{{
> sage: DD.__hash__()
> 1042963791458606606
> sage: DD.add_inequality(vector([1,0,0]))
> sage: DD.__hash__()
> -1000165618804906370
> }}}

F!**!**!** Sage objects!

```
cdef class SageObject:
...
    def __hash__(self):
        return hash(self.__repr__())
```



---

Comment by ncohen created at 2015-04-18 10:42:12

Unless all SageObject must be immutable, I guess that it should be removed (in another ticket that will become another war)


---

Comment by ncohen created at 2015-04-18 10:44:34

Actually, no... 


```
sage: class A:
....:     pass
sage: hash(A())
-9223363253024015589
```


We should probably make `SageObject.__hash__` raise a `NotImplementedError`


---

Comment by vdelecroix created at 2015-04-18 10:46:43

Replying to [comment:8 ncohen]:
> Actually, no... 
> 
> {{{
> sage: class A:
> ....:     pass
> sage: hash(A())
> -9223363253024015589
> }}}
> 
> We should probably make `SageObject.__hash__` raise a `NotImplementedError`

Or

```
class A:
    __hash__ = None
```



---

Comment by git created at 2015-04-18 10:55:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 10:55:41

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-18 13:27:24

About this branch:

- `zero_set`: why don't you just call `DD.zero_set.clear_cache()` instead of rewriting the caching mechanism? If you do want to keep this `self.cache` please make the name more specific.

- `A_matrix` : returns a pointer toward a mutable internal object.

- Err
  {{{
  Add an inequality to the double description with the inequality ``a``
  added.
  }}}

- I do not like this '_matrix' function very much. Its name is not very clear (`matrix_from_cached_vector_space`?) but what about just doing this 'if' twice (it is called twice)?

Nathann


---

Comment by vdelecroix created at 2015-04-18 13:41:05

Replying to [comment:12 ncohen]:
> About this branch:
> 
> - `zero_set`: why don't you just call `DD.zero_set.clear_cache()` instead of rewriting the caching mechanism? If you do want to keep this `self.cache` please make the name more specific.

Nope. If you call the function with the same `ray` argument you do not want to recompute it from scratch.
 
> - I do not like this '_matrix' function very much. Its name is not very clear (`matrix_from_cached_vector_space`?) but what about just doing this 'if' twice (it is called twice)?

Me neither. That's why I opened #18231. The function just constructs a matrix, why the name is badly chosen? You will get the very same answer as calling `matrix(self.problem.base_ring(), data)`. Except that it is faster. What about `.build_matrix` and `.build_matrix_space`?

I do not understand you remark about the `if`.


---

Comment by ncohen created at 2015-04-18 13:48:41

Hello,

> Nope. If you call the function with the same `ray` argument you do not want to recompute it from scratch.

Oh, okay. Then change the cache's name please

> > - I do not like this '_matrix' function very much. Its name is not very clear (`matrix_from_cached_vector_space`?) but what about just doing this 'if' twice (it is called twice)?
> 
> Me neither. That's why I opened #18231.

Then should it be really fixed inside of this class? Or do we keep this code as it is and try to solve the #18231 instead.

> The function just constructs a matrix, why the name is badly chosen? You will get the very same answer as calling `matrix(self.problem.base_ring(), data)`. Except that it is faster.

Precisely because the name does not reflect the difference. `matrix_from_cached_vector_space` does.

> What about `.build_matrix` and `.build_matrix_space`?

I hate this class already.

> I do not understand you remark about the `if`.

Oh. Well, because all that 'matrix' does is a if. If it is not a function of its own, you just have to copy this 'if' around.

Nathann


---

Comment by ncohen created at 2015-04-18 13:49:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-18 14:44:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 14:47:14

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-18 14:47:14

- I get rid of `def _matrix` and move `Problem._matrix_space -> DoubleDescription.matrix_space`.
- I changed `.cache -> .zero_set_cache`
- I modified the output of `zero_set` to return Python sets instead of tuple (since the most important operation on them is the intersection)

Needs review again.


---

Comment by ncohen created at 2015-04-18 16:17:33

Yoooooooooooooo !

Looks good, almost good to go. Just two things:

- This sentence repeats itself
  {{{
  Add an inequality to the double description with the inequality ``a``
  added.
  }}}
- What is the difference between those two lines?
  {{{
  lines = self._linear_subspace.matrix().rows()
  lines = self._linear_subspace.basis_matrix().rows()
  }}}

Nathann


---

Comment by ncohen created at 2015-04-18 16:17:40

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-18 16:20:53

Hello,

Replying to [comment:18 ncohen]:
> - What is the difference between those two lines?
>   {{{
>   lines = self._linear_subspace.matrix().rows()
>   lines = self._linear_subspace.basis_matrix().rows()
>   }}}

`linear_subspace.matrix` calls `linear_subspace.basis_matrix`. Having aliases is cool, but avoiding using them is cooler ;-)

Vincent


---

Comment by git created at 2015-04-18 16:25:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 16:26:06

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-04-18 16:28:09

Okayyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy


---

Comment by ncohen created at 2015-04-18 16:28:09

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-18 16:32:37

Replying to [comment:23 ncohen]:
> Okayyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy

Great! Thanks. It becomes reasonable to start using the generic backend.

Next step: avoid the recomputation of vertices! The algorithm is currently

```
INPUT: vertices
OUTPUT: (vertices, hyperplanes)
ALGO:
  1. compute hyperplanes from vertices (with no redundancy)
  2. recompute vertices from hyperplanes (with no redundancy)
  3. return (vertices, hyperplanes)
```

And it is precisely step 2 which takes an infinite amount of time for the 600-cell!


---

Comment by vbraun created at 2015-04-18 23:45:38

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-18 23:45:38

reviewer name


---

Comment by ncohen created at 2015-04-19 05:33:31

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-19 16:44:59

Resolution: fixed
