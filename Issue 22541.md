# Issue 22541: improve _chomp_repr_

Issue created by migration from Trac.

Original creator: moritz

Original creation time: 2017-04-07 14:41:37

On behalf of Felix Boes I suggest an improvement to the `ChainComplex_class`: In the function `_chomp_repr_`, replace:


```
                 if col.nonzero_positions():
                     for j in col.nonzero_positions():
```

by

```
                 nonzero_pos = col.nonzero_positions()
                 if col.nonzero_positions():
                     for j in nonzero_pos:
```


Then the method should be faster, since `nonzero_positions` is only called once and not each time the loop is executed.


---

Comment by moritz created at 2017-04-07 14:44:44

This patch should fix it (and removes trailing white space at some places). 
I plan to add some tests to show performance is improved.
----
New commits:


---

Comment by moritz created at 2017-04-07 14:44:44

Set assignee to moritz.


---

Comment by tscrim created at 2017-04-07 15:55:04

Actually, it is only called once as Python is smart enough. However, you can call it before the `if` statement, then have `if nonzero_pos:`, to avoid calling it twice.


---

Comment by git created at 2017-04-10 07:49:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-04-10 07:55:24

Thanks for your comment Travis! I meant to substitute the second occurrence of col.nonzero_positions() as well, see the second commit. 

Then it really seems to be faster:


After the change:

```
sage: C = ChainComplex({0:random_matrix(ZZ,1000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 1.07 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,2000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 4.37 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,3000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 13.9 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,5000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 34 s per loop
```

Before the change:

```
sage: C = ChainComplex({0:random_matrix(ZZ,1000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 1.21 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,2000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 5.06 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,3000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 15.1 s per loop
sage: C = ChainComplex({0:random_matrix(ZZ,5000)})
sage: %timeit C._chomp_repr_()
1 loop, best of 3: 55.5 s per loop
```



---

Comment by moritz created at 2017-04-10 08:01:43

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-07-06 02:43:49

Whoops, forgot about this. LGTM.


---

Comment by tscrim created at 2017-07-06 02:43:49

Changing status from needs_review to positive_review.


---

Comment by moritz created at 2017-07-06 08:17:07

Thanks for reviewing!


---

Comment by vbraun created at 2017-08-03 22:11:40

Resolution: fixed
