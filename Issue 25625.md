# Issue 25625: Upgrade eclib to 20180710

Issue created by migration from https://trac.sagemath.org/ticket/25862

Original creator: @timokau

Original creation time: 2018-07-15 08:42:16

CC:  cremona arojas fbissey

Keywords: eclib upgrade

Tarball: https://github.com/JohnCremona/eclib/archive/v20180710.tar.gz

I'm currently having issues with this update for nix[1]. I will try to see if I can reproduce those issues with sage-the distribution.

With nix I get the following error building sagelib:


```
[180/476] creating build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/eclib
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I./sage/libs/ntl -I./sage/cpython -I./sage/ext -I/nix/store/sgnfm122xn29392fbhbg9vkhqg6mvzc1-python2.>
cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++
gcc -pthread -shared -lgcc_s build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/mpmath/ext_impl.o -L/tmp/nix-build-python2.7-sagelib-8.2.drv-0/sage-src-8.2/lib -L/nix/store/d3aa78jf7pm9l>
In file included from /nix/store/7mrpq5lqdqpmmammsg6c9r7fx9xr03q8-eclib-20180710/include/eclib/homspace.h:28:0,
                 from build/cythonized/sage/libs/eclib/homspace.cpp:655:
/nix/store/7mrpq5lqdqpmmammsg6c9r7fx9xr03q8-eclib-20180710/include/eclib/method.h:57:10: fatal error: types.h: No such file or directory
 #include "types.h"
          ^~~~~~~~~
compilation terminated.
gcc -pthread -shared -lgcc_s build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/arb/arith.o -L/tmp/nix-build-python2.7-sagelib-8.2.drv-0/sage-src-8.2/lib -L/nix/store/d3aa78jf7pm9lk6ad67>
[181/476] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I./sage/libs/ntl -I./sage/cpython -I./sage/ext -I/tmp/nix-build-python2.7-sagelib-8.2.drv-0>
error: command 'gcc' failed with exit status 1
cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++
In file included from /nix/store/7mrpq5lqdqpmmammsg6c9r7fx9xr03q8-eclib-20180710/include/eclib/homspace.h:28:0,
                 from build/cythonized/sage/libs/eclib/mat.cpp:652:
/nix/store/7mrpq5lqdqpmmammsg6c9r7fx9xr03q8-eclib-20180710/include/eclib/method.h:57:10: fatal error: types.h: No such file or directory
 #include "types.h"
          ^~~~~~~~~
compilation terminated.
```


Which sounds more like an eclib error than just a changed interface. Might have something to do with eclibs changelog entry[2]

> Reorganised all include files so each may be included by itself.

Specifically the file in question (`types.h`) gained some preprocessor instructions that are probably relevant[3].

[1] https://github.com/NixOS/nixpkgs/pull/43476
[2] https://github.com/JohnCremona/eclib/releases/tag/v20180710
[3] https://github.com/JohnCremona/eclib/blob/v20180710/libsrc/eclib/types.h


---

Comment by @timokau created at 2018-07-15 08:54:32

Okay I get a similar error on sage-the-distribution. Just this time already while building eclib (which works fine on nix):


```
[eclib-20180710] In file included from ./eclib/xsplit_data.h:41,
[eclib-20180710]                  from ./eclib/xsplit.h:35,
[eclib-20180710]                  from xsplit.cc:32:
[eclib-20180710] ./eclib/method.h:57:10: fatal error: types.h: No such file or directory
[eclib-20180710]  #include "types.h"
[eclib-20180710]           ^~~~~~~~~
[eclib-20180710] compilation terminated.
[eclib-20180710] make[3]: *** [Makefile:570: xsplit.lo] Error 1
```



---

Comment by @timokau created at 2018-07-15 09:25:57

arojas already figured this out. See https://groups.google.com/forum/#!msg/sage-packaging/KD0H2kzE1Z4/McOrPorxBQAJ.


---

Comment by arojas created at 2018-07-15 09:35:38

Reposting the info here:

this eclib patch is needed to fix the missing header error

https://github.com/JohnCremona/eclib/pull/42

and this sage patch is needed to fix build, since bigint has changed from a define to a typedef

https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-eclib-20180710.patch?h=packages/sagemath


---

Comment by @timokau created at 2018-07-15 12:23:31

Additionally to `@`arojas patch there is one small formatting change that has to be included in the doctests (`src/sage/interfaces/mwrank.py`)


```
Failed example:
    print(M('0 0 1 -1 0'))
Expected:
    Curve [0,0,1,-1,0] :    Rank = 1
    Generator 1 is [0:-1:1]; height 0.0511114082399688
    Regulator = 0.0511114082399688
Got:
    Curve [0,0,1,-1,0] :        Rank = 1
    <BLANKLINE>
    Generator 1 is [0:-1:1]; height 0.051111408239969
    <BLANKLINE>
    Regulator = 0.051111408239969
    <BLANKLINE>
```



---

Comment by @timokau created at 2018-07-16 11:48:08

Here's the patch I applied, which includes `@`arojas patch and fixes the rounding issue: https://github.com/NixOS/nixpkgs/blob/c77d1e5b318213ec432cda40f3c4c9bbae429281/pkgs/applications/science/math/sage/patches/eclib-20180710.patch

When actually upgrading the spkg it would be nicer to decrease the precision a bit instead of just using the new rounding.


---

Comment by cremona created at 2018-07-26 10:30:05

Replying to [comment:9 arojas]:

It will only take me a few minutes to make a new release with this fix in, which would surely be preferable.  I have been travelling and not had time but should do it in the next 2 days.  I suppose I forgot to to make dist-check or whatever.


---

Comment by @timokau created at 2018-08-15 10:30:11

`@`arojas' fix was merged for a different reason in #25999.

`@`cremona ping :)


---

Comment by cremona created at 2018-08-15 10:34:12

Ping received.  I got sidetracked by the fact that "make distcheck" did not work for me and was trying to find a better way of getting the correct flags / switches into eclib's configure to get threads working with "manually" added them.  Either way I'll get a new release out today or tomorrow to use instead of 20180710, evn if it only has this patch in it.


---

Comment by @timokau created at 2018-08-15 11:47:39

Awesome, please post here when you do.


---

Comment by @timokau created at 2018-08-15 12:58:53

Thanks! Do you plan to do the sage update or do you want me to do it?


---

Comment by cremona created at 2018-08-15 13:27:00

Replying to [comment:16 gh-timokau]:
> Thanks! Do you plan to do the sage update or do you want me to do it?
Please could you do it.  I am trying to finish something else before going away on Friday.


---

Comment by @timokau created at 2018-08-16 09:19:26

The tarball is a 404. Any reason why we don't just use the one provided by github?


---

Comment by cremona created at 2018-08-16 09:55:41

Replying to [comment:19 gh-timokau]:
> The tarball is a 404. Any reason why we don't just use the one provided by github?
I fixed that but guthub should also be fine.


---

Comment by @timokau created at 2018-08-16 18:18:18

New commits:


---

Comment by @timokau created at 2018-08-16 18:18:28

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-08-16 19:26:10

I think you forgot to put your name in the Authors field here. And you might want to remove the lower part of the ticket description as that problem has been resolved if I understood correctly.

Apart from that, feel free to set this to positive review :)


---

Comment by @timokau created at 2018-08-16 20:05:51

Changing status from needs_review to positive_review.


---

Comment by @timokau created at 2018-08-16 20:06:24

Right. I left it intact but marked it as outdated. Maybe it'll be relevant for someone.

Thanks for the review :)


---

Comment by vbraun created at 2018-08-20 23:38:53

Resolution: fixed


---

Comment by vbraun created at 2018-08-25 10:59:01


```
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_rational_field.py", line 473, in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.mwrank
Failed example:
    print(E.mwrank('-v0 -l -b11'))
Expected:
    Curve [0,0,0,877,0] :   Rank = 1
    Generator 1 is [29604565304828237474403861024284371796799791624792913256602210:-256256267988926809388776834045513089648669153204356603464786949:490078023219787588959802933995928925096061616470779979261000]; height 95.980371987964
    Regulator = 95.980371987964
Got:
    Curve [0,0,0,877,0] :	Rank = 1
    <BLANKLINE>
    Generator 1 is [29604565304828237474403861024284371796799791624792913256602210:-256256267988926809388776834045513089648669153204356603464786949:490078023219787588959802933995928925096061616470779979261000]; height 95.98037198796
    <BLANKLINE>
    Regulator = 95.98037198796
    <BLANKLINE>
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_rational_field.py", line 2446, in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.ngens
Failed example:
    print(E.mwrank('-v0 -b12 -l'))
Expected:
    Curve [0,0,0,877,0] :   Rank = 1
    Generator 1 is [29604565304828237474403861024284371796799791624792913256602210:-256256267988926809388776834045513089648669153204356603464786949:490078023219787588959802933995928925096061616470779979261000]; height 95.980371987964
    Regulator = 95.980...
Got:
    Curve [0,0,0,877,0] :	Rank = 1
    <BLANKLINE>
    Generator 1 is [29604565304828237474403861024284371796799791624792913256602210:-256256267988926809388776834045513089648669153204356603464786949:490078023219787588959802933995928925096061616470779979261000]; height 95.98037198796
    <BLANKLINE>
    Regulator = 95.98037198796
    <BLANKLINE>
**********************************************************************
2 items had failures:
   1 of   7 in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.mwrank
   1 of   6 in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.ngens
    [848 tests, 2 failures, 241.04 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/elliptic_curves/ell_rational_field.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-08-25 10:59:01

Changing status from closed to new.


---

Comment by vbraun created at 2018-08-25 10:59:01

Resolution changed from fixed to 


---

Comment by vbraun created at 2018-08-25 10:59:19

This failure is on 32-bit


---

Comment by @timokau created at 2018-08-25 11:26:01

New commits:


---

Comment by @timokau created at 2018-08-25 11:28:10

Changing status from new to needs_review.


---

Comment by @timokau created at 2018-08-25 11:28:40

Setting back to positive review since the change is trivial (slight relaxation of precision).


---

Comment by @timokau created at 2018-08-25 11:28:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-26 09:37:52

Resolution: fixed
