# Issue 11797: Move $(TESTPRELIMS) out of pipestatus

Issue created by migration from https://trac.sagemath.org/ticket/11969

Original creator: jdemeyer

Original creation time: 2011-10-31 08:30:18

Assignee: GeorgSWeber

Using `&&` inside commands for pipestatus does not work.  Therefore, in the top-level Makefile, we should move `$(TESTPRELIMS)` out of `$(PIPE)`.


---

Comment by jdemeyer created at 2011-10-31 08:34:27

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-10-31 08:57:15

Changing keywords from "" to "Makefile pipestatus".


---

Comment by leif created at 2011-10-31 16:09:14

Looks reasonable, although you could just use parentheses in the parameter to `pipestatus`.  (That way, the output of `sage-starts` would still get logged, too.)


---

Comment by jhpalmieri created at 2011-10-31 17:15:29

Looks okay to me, too. I think it also makes sense to move sage-env out of `TESTPRELIMS` and only run it explicitly where needed.  I think that logging the output from `sage-starts` might be nice, but it's pretty minor.

Does `sage -t` accept `--optional` as meaning the same as `-optional`?  It accepts `--sagenb` and `--long`.  Do you want to change those while you're editing those lines?


---

Comment by jdemeyer created at 2011-10-31 17:32:30

I noticed that `make ptestlong` actually runs `sage-starts` *twice*: once from the `Makefile` and once from `sage-sage`.

I propose *not* to run `sage-starts` when the user explicitly runs

```
$ ./sage -tp [...]
```

but to run `sage-starts` only when the user does

```
$ make ptestlong
```


The rationale is that `sage -tp` is often done with one or few files and then the overhead of `sage-starts` might be significant.  However, for a `make ptestlong` run, running `sage-starts` once does not really impact the testing time.


---

Comment by jdemeyer created at 2011-10-31 17:32:30

Changing status from needs_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2011-10-31 18:03:38

I made some additional changes to the top-level `Makefile`, needs_review


---

Comment by jdemeyer created at 2011-10-31 18:03:38

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-10-31 20:36:49

I'm wary of not running sage-starts as part of "sage -tp".  It was introduced in #7103 to fix a problem when someone ran "sage -tp" before actually running Sage.  I can see someone doing "make build" and then "./sage -tp ..." in order to test whether a new Sage build fixes problems in a particular directory.


---

Comment by jdemeyer created at 2011-10-31 22:37:01

Replying to [comment:11 jhpalmieri]:
> I can see someone doing "make build" and then "./sage -tp ..." in order to test whether a new Sage build fixes problems in a particular directory.

Then all those tests would fail.  Is that a problem?

In all seriousness: I can see some arguments supporting `sage-starts` before `./sage -tp [...]`.  But then we should *also* do that for `./sage -t [...]`.  I value consistency and predictability very high, I prefer either "always" or "never" to anything in between.


---

Comment by jhpalmieri created at 2011-10-31 22:43:34

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 jhpalmieri]:
> > I can see someone doing "make build" and then "./sage -tp ..." in order to test whether a new Sage build fixes problems in a particular directory.
> 
> Then all those tests would fail.  Is that a problem?

No, the problem is that you might get this:

```
A mysterious error (perhaps a memory error?) occurred, which may have crashed doctest.
```

And you get it from a race condition, where multiple processes are simultaneously trying to create the same subdirectories of .sage.  So it doesn't occur when you do "sage -t", only "sage -tp".


---

Comment by leif created at 2011-10-31 22:45:51

Replying to [comment:6 jdemeyer]:
> I noticed that `make ptestlong` actually runs `sage-starts` *twice*: once from the `Makefile` and once from `sage-sage`.
> 
> I propose *not* to run `sage-starts` when the user explicitly runs

```
$ ./sage -tp [...]
```

> but to run `sage-starts` only when the user does

```
$ make ptestlong
```

> 
> The rationale is that `sage -tp` is often done with one or few files and then the overhead of `sage-starts` might be significant.  However, for a `make ptestlong` run, running `sage-starts` once does not really impact the testing time.

Yes, definitely, i.e. remove it from `sage-sage`.


---

Comment by jdemeyer created at 2011-10-31 22:49:48

Rebased to #11926.


---

Comment by jdemeyer created at 2011-10-31 22:59:08

Replying to [comment:13 jhpalmieri]:
> And you get it from a race condition, where multiple processes are simultaneously trying to create the same subdirectories of .sage.

How is this solved by running `sage-starts`?  I would assume that a user doing `./sage -tp` has already ran Sage at least once.  And it also seems that #11926 should solve precisely this problem (except in the rare case where the changed code has to do with creating directories in the Sage startup).

Also, such a race condition is a bug in Sage.  If you have more information about when it occurs and for which directories, we can look into this.  (I find it _very_ annoying that Python doesn't seem to have an equivalent of `mkdir -p`, making a directory but not complaining if it exists).


---

Comment by leif created at 2011-10-31 23:03:28

Sorry, hadn't read John's comments before my last post.

But IMHO, if there are race conditions in creating directories (in `$DOT_SAGE/`), the race conditions should get fixed instead of using dumb work-arounds that are hardly ever necessary.

Note that e.g. only `sage-ptest` supports `SAGE_TEST_ITER`.


---

Comment by leif created at 2011-10-31 23:15:50

Replying to [comment:16 jdemeyer]:
> Replying to [comment:13 jhpalmieri]:
> > And you get it from a race condition, where multiple processes are simultaneously trying to create the same subdirectories of .sage.
> 
> I would assume that a user doing `./sage -tp` has already ran Sage at least once.  And it also seems that #11926 should solve precisely this problem (except in the rare case where the changed code has to do with creating directories in the Sage startup).

This doesn't help if `$DOT_SAGE` differs, e.g. because the user changed the variable's setting, or it's just a different user that runs Sage [for the first time maybe, or deleted his previous `.sage`, or there are new directories to create].


---

Comment by jhpalmieri created at 2011-11-01 04:24:18

> If you have more information about when it occurs and for which directories, we can look into this.

You could look at #7103, as I mentioned above, and to #7079, to which #7103 refers.

> I find it very annoying that Python doesn't seem to have an equivalent of mkdir -p, making a directory but not complaining if it exists

See #11972.  I think the patch there should also take care of the race conditions when creating DOT_SAGE and its various subdirectories, which seemed to be the problem with #7103.  One way to test: remove the sage-starts code from the doctesting routines and set DOT_SAGE to a non-existing directory and run "sage -tp ...".  Repeat many times and see if you ever get "mysterious errors".  Then apply the patch at #11972 and see if that fixes it.

If this fixes it, then I'm willing to make #11972 a prerequisite for this ticket and remove the execution of sage-starts from sage-sage.  But I'm not willing to remove sage-starts unless we're pretty sure that we haven't reintroduced a possible bug in doctesting.


---

Attachment


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jhpalmieri created at 2011-11-12 18:30:24

This all looks good to me, and I'm happy with the patch to the scripts repo now that #11972 is merged.


---

Comment by jhpalmieri created at 2011-11-12 18:30:24

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-14 08:27:13

Replying to [comment:25 jhpalmieri]:
> This all looks good to me, and I'm happy with the patch to the scripts repo now that #11972 is merged.

Thanks for the review!


---

Comment by jdemeyer created at 2011-11-14 17:32:28

Resolution: fixed
