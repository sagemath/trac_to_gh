# Issue 27289: Boltzmann samplers for combinatorial grammars

Issue created by migration from https://trac.sagemath.org/ticket/27526

Original creator: @Kerl13

Original creation time: 2019-03-21 17:16:42

CC:  tmonteil matthieudien martinpepin mantepse




---

Comment by git created at 2019-06-19 11:26:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-19 12:42:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-19 20:31:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-20 15:00:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-21 12:35:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-21 13:07:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by MatthieuDien created at 2019-06-21 13:51:53

New commits:


---

Comment by git created at 2019-06-21 16:16:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-22 13:16:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-22 18:35:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-25 07:38:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-27 09:16:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-28 10:27:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-05 09:43:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-07-15 06:37:43

Please have a look at the patchbot warnings (click on the color round icon on top of the page) and in particular the plugins results.
----
New commits:


---

Comment by mantepse created at 2022-09-08 18:35:57

Hi Martin!

the species implementation is currently undergoing the long awaited overhaul.  Travis and I have just finished a lazy series implementation, which is much more robust than what we had previously.  Ticket #32367 replaces the old (and somewhat unreliable) LazyPowerSeries with our new one.

Do you think we should try to see whether a uniform user interface for defining a grammar is possible?


---

Comment by tmonteil created at 2022-09-08 19:14:42

Replying to [comment:27 Martin Rubey]:
> Hi Martin!
> 
> the species implementation is currently undergoing the long awaited overhaul.  Travis and I have just finished a lazy series implementation, which is much more robust than what we had previously.  Ticket #32367 replaces the old (and somewhat unreliable) LazyPowerSeries with our new one.
> 
> Do you think we should try to see whether a uniform user interface for defining a grammar is possible?

Hi all ! To be transparent, we had an informal discussion this afternoon with Martin Pépin about that same issue !

If you remember, a long time ago (before covid), i proposed to have a general meeting of all people interested in making a plan for the whole analytic combinatorics stuff in Sage (species, ore algebras, (multi-variate, lazy, etc) power series, Bolzmann samplers, singularity analysis, asymptotic expansions, etc). Most people answered positively but wanted to postpone the date, unfortunately the delays were too short as the grant was ending. Maybe, we could revive the idea. What do you think ?


---

Comment by mantepse created at 2022-09-08 19:19:44

I am all for it!  I have no teaching in February.  Until then, zoom and email is fine for me!


---

Comment by MartinPepin created at 2022-09-09 12:18:27

Hi!

First an important note: Matthieu and I (temporarily) moved away from this ticket about 3 years ago as we decided to implement a standalone python library [available here (usainboltz)](https://gitlab.com/ParComb/usain-boltz). This means that the branch tied to this ticket is obsolete and should not be used.

That being said:

1. It doesn't prevent us from adding usainboltz to sage! Adding it as an optional package seems right to me (is it?)

2. I agree with you that having a uniform user interface for defining grammars would be great. And the species, if they work, seem to be a very good candidate to me. I'd love to see some nice integration with usainboltz (and other existing tools) so that sampling objects described by a species becomes as simple as:


```python
>>> sampler = my_specy.get_boltzmann_sampler()
>>> sampler(size_in=[1000, 2000])
<some big object>
```


I'm all in to work on this as well!


---

Comment by git created at 2022-09-13 18:28:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by MartinPepin created at 2022-09-13 18:40:08

I added usainboltz as a pip package following https://doc.sagemath.org/html/en/developer/packaging.html#python-based-packages.

But something must be wrong with what I did, I can't install usainboltz using `sage -i`:


```
$ ./sage -i usainboltz
[ a log of log about sage checking if it needs to rebuild stuff ]
Error: package 'usainboltz' not found
Note: if it is an old-style package, installing these is no longer supported
```


Note that `./sage --optional` and `./sage --info usainboltz` both see usainboltz. I might need a bit of help to understand what is happening.


---

Comment by tmonteil created at 2022-09-13 19:05:47

It worked well for me, i could successfully execute `binarytrees.ipynb`.


---

Comment by tmonteil created at 2022-09-13 19:07:10

I would replace `boltzmann` with `Boltzmann` in the title but apart from that, it looks good to me.


---

Comment by tmonteil created at 2022-09-13 19:12:47

Changing component from combinatorics to packages: optional.


---

Comment by git created at 2022-09-13 19:59:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-13 20:34:01


```
+Usainboltz: fast Boltzmann random generation of tree-like structures
+====================================================================
```

this line should start with lowercase


---

Comment by git created at 2022-09-13 20:44:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2022-09-13 20:57:57

Once you are happy with your changes, you can set the "Action" to "needs review".


---

Comment by MartinPepin created at 2022-09-13 21:08:05

Replying to [comment:40 Thierry Monteil]:
> Once you are happy with your changes, you can set the "Action" to "needs review".

Oh right, thanks for recalling me the usual workflow, I'm not used to it yet ^^

I'm a bit frustrated that I could not test it. I started a new `make build` which seems to want to recompile some stuff. I'll try to test again tomorrow when it's done and update the Action field afterward


---

Comment by MartinPepin created at 2022-09-14 12:50:18

Replying to [comment:34 Thierry Monteil]:
> It worked well for me, i could successfully execute `binarytrees.ipynb`.

I still don't manage to `sage -i usainboltz` (even on a fresh clone after having built sage with `make build`) it seems that usainboltz should appear in the output of `make list` but it doesn't. Rebuilding `build/make/Makefile` doesn't help either.


---

Comment by MartinPepin created at 2022-09-14 14:14:13

Ok now it works! Sorry for the noise, there had been a problem at `make configure` that I didn't spot when I built sage


---

Comment by MartinPepin created at 2022-09-14 14:14:47

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-09-14 14:53:25


```
+++ b/build/pkgs/usainboltz/dependencies
@@ -0,0 +1,4 @@
+$(PYTHON) cython | $(PYTHON_TOOLCHAIN)
```

It's better to put `cython` after the `|`, to make it an order-only dependency


---

Comment by mkoeppe created at 2022-09-14 14:59:57

On macOS (with clang)

```
[usainboltz]       gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -Werror=implicit-function-declaration -Isrc/xoshiro -Isrc/usainboltz -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -c src/usainboltz/cpp_simulator.cpp -o build/temp.macosx-10.14-x86_64-cpython-38/src/usainboltz/cpp_simulator.o
[usainboltz]       In file included from src/usainboltz/cpp_simulator.cpp:7:
[usainboltz]       src/usainboltz/cpp_simulator.hpp:45:7: error: union member '_as_product' has a non-trivial copy constructor
[usainboltz]           } _as_product;
[usainboltz]             ^
[usainboltz]       src/usainboltz/cpp_simulator.hpp:44:28: note: because field of type 'std::vector<CRule *>' has a user-provided copy constructor
[usainboltz]             std::vector<CRule *> args;
[usainboltz]                                  ^
[usainboltz]       /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/c++/v1/vector:581:5: note: declared here
[usainboltz]           vector(const vector& __x);
[usainboltz]           ^
[usainboltz]       In file included from src/usainboltz/cpp_simulator.cpp:7:
[usainboltz]       src/usainboltz/cpp_simulator.hpp:50:37: error: a space is required between consecutive right angle brackets (use '> >')
[usainboltz]             std::vector<std::vector<double>> weights;
[usainboltz]                                           ^~
[usainboltz]                                           > >
```



---

Comment by mkoeppe created at 2022-09-14 15:01:01

I see that `cvxpy` is a dependency of this package. You may be interested in #34251, which adds it as an SPKG


---

Comment by git created at 2022-09-14 15:06:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by MartinPepin created at 2022-09-14 15:07:51

> It's better to put `cython` after the `|`, to make it an order-only dependency

Good point, sorry I missed that


---

Comment by MartinPepin created at 2022-09-14 15:18:00

Replying to [comment:46 Matthias Köppe]:
> On macOS (with clang)
> {{{
> [usainboltz]       src/usainboltz/cpp_simulator.hpp:50:37: error: a space is required between consecutive right angle brackets (use '> >')
> [usainboltz]             std::vector<std::vector<double>> weights;
> [usainboltz]                                           ^~
> }}}

I was not aware of that issue, thanks for reporting, I'll add clang to usainboltz' CI


---

Comment by mkoeppe created at 2022-09-14 15:25:43

Probably needs `-std=c++11` or something like this


---

Comment by MartinPepin created at 2022-09-14 15:31:50

Replying to [comment:47 Matthias Köppe]:
> I see that `cvxpy` is a dependency of this package. You may be interested in #34251, which adds it as an SPKG

Yes it is indeed interesting. How do I benefit from this?
Will sage's pip use the optional `cvxpy` package if I add it as a dependency? Or do I need to switch to the `normal` package format for usainboltz`? I'll be happy to do so if it's considered better.

Btw, Thierry told me a few days ago that our (only “real” dependency `paganini` might be of interest for sage as well. Another good reason to package everything as `normal`?


---

Comment by MartinPepin created at 2022-09-14 15:33:06

Replying to [comment:51 Matthias Köppe]:
> Probably needs `-std=c++11` or something like this

I'll check that but I think I prefer to follow the error message's suggestion if it makes the library compatible with more compilers / compiler versions


---

Comment by mkoeppe created at 2022-09-14 16:14:36

See #32074 for detailed info on compiler supported by Sage & related software


---

Comment by MartinPepin created at 2022-09-19 10:29:29

Replying to [comment:46 Matthias Köppe]:

I fixed the compilation issue with clang (at list on my setup).

Would you mind checking whether `sage -pip install git+https://gitlab.com/ParComb/usain-boltz#master` works for you before I release a new version? That would be really nice.

A few warnings are to be expected because cython does not produce fully c++11 compatible code (https://github.com/cython/cython/pull/4687). I don't know to what extent this is a problem.

> On macOS (with clang)
> {{{
> [usainboltz]       gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -Werror=implicit-function-declaration -Isrc/xoshiro -Isrc/usainboltz -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -c src/usainboltz/cpp_simulator.cpp -o build/temp.macosx-10.14-x86_64-cpython-38/src/usainboltz/cpp_simulator.o
> [...]
> }}}

By the way, I just noticed you seemed to use gcc from the log you pasted.
Is this a mistake or is `gcc` an alias for `clang` in your setup?


---

Comment by git created at 2022-09-19 15:00:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-19 15:31:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by MartinPepin created at 2022-09-19 15:33:15

I could finally get my hands on a mac this afternoon so I could test the compilation there and release a new version, sorry for the noise


---

Comment by mkoeppe created at 2022-09-19 16:54:13

Replying to [comment:55 Martin Pépin]:
> By the way, I just noticed you seemed to use gcc from the log you pasted.
> Is this a mistake or is `gcc` an alias for `clang` in your setup?

On macOS, the `gcc` binary provided by Xcode is a compatibility shim around Apple's version of clang.


---

Comment by mkoeppe created at 2022-09-19 16:58:35

Replying to [comment:52 Martin Pépin]:
> Replying to [comment:47 Matthias Köppe]:
> > I see that `cvxpy` is a dependency of this package. You may be interested in #34251, which adds it as an SPKG
> 
> Yes it is indeed interesting. How do I benefit from this?

#34251 is waiting for reviewers...

> Will sage's pip use the optional `cvxpy` package if I add it as a dependency? Or do I need to switch to the `normal` package format for usainboltz`? I'll be happy to do so if it's considered better.

When #34251 is merged, we should add `cvxpy` to `build/pkgs/usainboltz/dependencies`.
This will avoid the conflict (possible races in parallel builds) between installing `cvxpy` from our package and getting `cvxpy`.

There's no need to switch `usainboltz` to `normal`.


---

Comment by mkoeppe created at 2022-09-19 17:03:47

Replying to [comment:52 Martin Pépin]:
> Btw, Thierry told me a few days ago that our (only “real” dependency `paganini` might be of interest for sage as well.

I can't comment on this; it's outside of my domain of mathematical expertise.

>  Another good reason to package everything as `normal`?

No, I'd say it's best to set things up as `pip` packages as you did. The additional maintenance burden (upgrade tickets) with `normal` packages is typically only warranted if we have tight integration of the provided functionality in Sage.


---

Comment by mkoeppe created at 2022-09-19 17:15:18

Oh, now I see you have made the switch to `normal` packages already on the new branch.
Then it's best to merge the branch of #34251 here. The current branch can't be tested because `cvxpy` is not a package


---

Comment by mkoeppe created at 2022-09-19 17:17:34


```
diff --git a/build/pkgs/optas/dependencies b/build/pkgs/optas/dependencies
new file mode 100644
index 00000000..7d1ace1
--- /dev/null
+++ b/build/pkgs/optas/dependencies
@@ -0,0 +1,4 @@
+$(PYTHON) | $(PYTHON_TOOLCHAIN) gcc
```

There's no need for the `gcc` here. This dependency is implicit for all packages.


---

Comment by mkoeppe created at 2022-09-19 17:20:23

Other than that, it's looking good


---

Comment by MartinPepin created at 2022-09-19 18:55:11

Replying to [comment:61 Matthias Köppe]:
> #34251 is waiting for reviewers...

I think I can do that!
