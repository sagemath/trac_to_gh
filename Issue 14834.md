# Issue 14834: Make it easy to have automatic numerical evaluation of symbolic functions on inexact input

archive/issues_014834.json:
```json
{
    "body": "CC:  burcin benjaminfjones\n\nThis ticket is for making it easy to have symbolic functions automatically evaluate on inexact input. This is already the behaviour of most symbolic functions and as such it would be good to have a standard way of implementing it.\n\nThis ticket modifies `Function._eval_default` to accept an arbitrary number of arguments. To have the numeric evaluation work, `_eval_default` can be assigned to `_eval_`, or it can be called from within `_eval_` and, if it returns `None`, leaves opportunity for exact simplification. For example,\n\n\n```\nsage: from sage.symbolic.function import BuiltinFunction\nsage: class Test(BuiltinFunction):\n....:     def __init__(self):\n....:         BuiltinFunction.__init__(self, 'test', nargs=1)\n....:     def _evalf_(self, x, parent):\n....:         return 0.5\n....:     def _eval_(self, x):\n....:         y = self._eval_default(x)\n....:         if y:\n....:             return y\n....:         else:\n....:             return 3\nsage: test = Test()\nsage: test(1.3)\n0.500000000000000\nsage: test(pi)\n3\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15071\n\n",
    "created_at": "2013-08-21T03:35:41Z",
    "labels": [
        "symbolics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "Make it easy to have automatic numerical evaluation of symbolic functions on inexact input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14834",
    "user": "eviatarbach"
}
```
CC:  burcin benjaminfjones

This ticket is for making it easy to have symbolic functions automatically evaluate on inexact input. This is already the behaviour of most symbolic functions and as such it would be good to have a standard way of implementing it.

This ticket modifies `Function._eval_default` to accept an arbitrary number of arguments. To have the numeric evaluation work, `_eval_default` can be assigned to `_eval_`, or it can be called from within `_eval_` and, if it returns `None`, leaves opportunity for exact simplification. For example,


```
sage: from sage.symbolic.function import BuiltinFunction
sage: class Test(BuiltinFunction):
....:     def __init__(self):
....:         BuiltinFunction.__init__(self, 'test', nargs=1)
....:     def _evalf_(self, x, parent):
....:         return 0.5
....:     def _eval_(self, x):
....:         y = self._eval_default(x)
....:         if y:
....:             return y
....:         else:
....:             return 3
sage: test = Test()
sage: test(1.3)
0.500000000000000
sage: test(pi)
3
```


Issue created by migration from https://trac.sagemath.org/ticket/15071





---

archive/issue_comments_189212.json:
```json
{
    "body": "Attachment [trac15071.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071.patch) by eviatarbach created at 2013-08-21 03:42:39\n\nBenjamin, I CC'ed you since it appears that you implemented this for many symbolic functions. What do you think of this approach?\n\nThe reason why I added `AttributeError` to the `except` in `test_relation` is because this is necessary to make comparisons work with some of the hyperbolic functions. Before it worked because they wouldn't evaluate automatically with `CIF` input, but they should since it's inexact.\n\nI also added a small fix to make the hyperbolic functions work with the Python `complex` type; they didn't before.\n\nPatchbot apply trac15071.patch",
    "created_at": "2013-08-21T03:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189212",
    "user": "eviatarbach"
}
```

Attachment [trac15071.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071.patch) by eviatarbach created at 2013-08-21 03:42:39

Benjamin, I CC'ed you since it appears that you implemented this for many symbolic functions. What do you think of this approach?

The reason why I added `AttributeError` to the `except` in `test_relation` is because this is necessary to make comparisons work with some of the hyperbolic functions. Before it worked because they wouldn't evaluate automatically with `CIF` input, but they should since it's inexact.

I also added a small fix to make the hyperbolic functions work with the Python `complex` type; they didn't before.

Patchbot apply trac15071.patch



---

archive/issue_comments_189213.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-21T03:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189213",
    "user": "eviatarbach"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_189214.json:
```json
{
    "body": "Good idea!\n\nMy initial impression is that your patch looks good, but I don't have time right now to do a thorough review. \n\nThe only immediate change I would suggest is to separate the changes to `hyperbolic.py` and `expression.py` into a different ticket and patch. It's annoying, I know, but it's better to separate issues in the long run.",
    "created_at": "2013-08-21T23:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189214",
    "user": "benjaminfjones"
}
```

Good idea!

My initial impression is that your patch looks good, but I don't have time right now to do a thorough review. 

The only immediate change I would suggest is to separate the changes to `hyperbolic.py` and `expression.py` into a different ticket and patch. It's annoying, I know, but it's better to separate issues in the long run.



---

archive/issue_comments_189215.json:
```json
{
    "body": "Okay thank you!\n\nI can separate one of the changes to `hyperbolic.py`, but the other one is necessary to keep this patch from failing tests, and indeed to not break many comparisons involving hyperbolic functions. Can I keep that one in this patch?",
    "created_at": "2013-08-22T04:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189215",
    "user": "eviatarbach"
}
```

Okay thank you!

I can separate one of the changes to `hyperbolic.py`, but the other one is necessary to keep this patch from failing tests, and indeed to not break many comparisons involving hyperbolic functions. Can I keep that one in this patch?



---

archive/issue_comments_189216.json:
```json
{
    "body": "Attachment [trac15071_2.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_2.patch) by eviatarbach created at 2013-08-31 17:59:39\n\nActually I meant all the changes to `hyperbolic.py` could be reverted (now #15134), but not the one to `expression.pyx`. New patch removes everything not necessary for passing doctests.\n\nNote that I changed the `cot` tests to `coth` since `cot` wasn't actually testing the function, because it doesn't use `_eval_default`.\n\nPatchbot apply trac15071_2.patch\u200b",
    "created_at": "2013-08-31T17:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189216",
    "user": "eviatarbach"
}
```

Attachment [trac15071_2.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_2.patch) by eviatarbach created at 2013-08-31 17:59:39

Actually I meant all the changes to `hyperbolic.py` could be reverted (now #15134), but not the one to `expression.pyx`. New patch removes everything not necessary for passing doctests.

Note that I changed the `cot` tests to `coth` since `cot` wasn't actually testing the function, because it doesn't use `_eval_default`.

Patchbot apply trac15071_2.patchâ€‹



---

archive/issue_comments_189217.json:
```json
{
    "body": "Ok, makes sense. Thanks for doing the separation.\n\nI looked in detail at your latest patch and it looks good. One thing I'd like to see before it's merged is more test coverage. It looks like only the `len(args) == 1` branch is tested right now. We should include tests of the multiple argument case and also the case of multiple arguments with distinct parents. Of course, once we have symbolic functions that use this `_eval_default` the toy test classes like you've included won't be necessary.\n\nAfter that, I'd say this is good to go.",
    "created_at": "2013-09-01T05:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189217",
    "user": "benjaminfjones"
}
```

Ok, makes sense. Thanks for doing the separation.

I looked in detail at your latest patch and it looks good. One thing I'd like to see before it's merged is more test coverage. It looks like only the `len(args) == 1` branch is tested right now. We should include tests of the multiple argument case and also the case of multiple arguments with distinct parents. Of course, once we have symbolic functions that use this `_eval_default` the toy test classes like you've included won't be necessary.

After that, I'd say this is good to go.



---

archive/issue_comments_189218.json:
```json
{
    "body": "Thank you! Here's a version with more tests.",
    "created_at": "2013-09-01T19:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189218",
    "user": "eviatarbach"
}
```

Thank you! Here's a version with more tests.



---

archive/issue_comments_189219.json:
```json
{
    "body": "Attachment [trac15071_3.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_3.patch) by eviatarbach created at 2013-09-01 19:53:45\n\nApparently excepting the `AttributeError` fixes other issues; see http://ask.sagemath.org/question/2957/strange-attributeerror. I would add a test for that but I guess it's not within the scope of the patch; maybe I'll just create a new ticket and mark it as fixed by this one.",
    "created_at": "2013-09-01T19:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189219",
    "user": "eviatarbach"
}
```

Attachment [trac15071_3.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_3.patch) by eviatarbach created at 2013-09-01 19:53:45

Apparently excepting the `AttributeError` fixes other issues; see http://ask.sagemath.org/question/2957/strange-attributeerror. I would add a test for that but I guess it's not within the scope of the patch; maybe I'll just create a new ticket and mark it as fixed by this one.



---

archive/issue_comments_189220.json:
```json
{
    "body": "It looks like now, only the second branch (the else) is being tested. Can we add the original test you had as well as the new one?\n\nAbout the `AttributeError` issue, what you propose sounds reasonable to me, but it excludes the possibility of getting a test in the codebase (since the other ticket wouldn't get to include a patch). Since excepting the error is done here I think it's probably okay to include a test as an \"aside\". What do you think?",
    "created_at": "2013-09-07T17:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189220",
    "user": "benjaminfjones"
}
```

It looks like now, only the second branch (the else) is being tested. Can we add the original test you had as well as the new one?

About the `AttributeError` issue, what you propose sounds reasonable to me, but it excludes the possibility of getting a test in the codebase (since the other ticket wouldn't get to include a patch). Since excepting the error is done here I think it's probably okay to include a test as an "aside". What do you think?



---

archive/issue_comments_189221.json:
```json
{
    "body": "Sounds good! New patch makes the suggested changes.",
    "created_at": "2013-09-10T02:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189221",
    "user": "eviatarbach"
}
```

Sounds good! New patch makes the suggested changes.



---

archive/issue_comments_189222.json:
```json
{
    "body": "Attachment [trac15071_4.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_4.patch) by benjaminfjones created at 2013-09-10 05:54:55\n\nLooks great. After tests come back positive from the bot, I'll give this a positive review.\n\n----\n\npatchbot, apply trac15071_4.patch",
    "created_at": "2013-09-10T05:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189222",
    "user": "benjaminfjones"
}
```

Attachment [trac15071_4.patch](tarball://root/attachments/some-uuid/ticket15071/trac15071_4.patch) by benjaminfjones created at 2013-09-10 05:54:55

Looks great. After tests come back positive from the bot, I'll give this a positive review.

----

patchbot, apply trac15071_4.patch



---

archive/issue_comments_189223.json:
```json
{
    "body": "Old patchbot seems to be on vacation. I'll do the testing myself..",
    "created_at": "2013-09-10T20:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189223",
    "user": "benjaminfjones"
}
```

Old patchbot seems to be on vacation. I'll do the testing myself..



---

archive/issue_comments_189224.json:
```json
{
    "body": "All tests pass! Positive review.",
    "created_at": "2013-09-10T22:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189224",
    "user": "benjaminfjones"
}
```

All tests pass! Positive review.



---

archive/issue_comments_189225.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-09-10T22:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189225",
    "user": "benjaminfjones"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_189226.json:
```json
{
    "body": "Thank you so much for reviewing! Now functions that are doing this manually can be transitioned.",
    "created_at": "2013-09-11T01:42:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189226",
    "user": "eviatarbach"
}
```

Thank you so much for reviewing! Now functions that are doing this manually can be transitioned.



---

archive/issue_comments_189227.json:
```json
{
    "body": "Please add your real names as Author and Reviewer.",
    "created_at": "2013-09-26T15:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189227",
    "user": "jdemeyer"
}
```

Please add your real names as Author and Reviewer.



---

archive/issue_comments_189228.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-10-02T06:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14834",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14834#issuecomment-189228",
    "user": "jdemeyer"
}
```

Resolution: fixed
