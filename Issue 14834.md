# Issue 14834: Make it easy to have automatic numerical evaluation of symbolic functions on inexact input

Issue created by migration from https://trac.sagemath.org/ticket/15071

Original creator: eviatarbach

Original creation time: 2013-08-21 03:35:41

CC:  burcin benjaminfjones

This ticket is for making it easy to have symbolic functions automatically evaluate on inexact input. This is already the behaviour of most symbolic functions and as such it would be good to have a standard way of implementing it.

This ticket modifies `Function._eval_default` to accept an arbitrary number of arguments. To have the numeric evaluation work, `_eval_default` can be assigned to `_eval_`, or it can be called from within `_eval_` and, if it returns `None`, leaves opportunity for exact simplification. For example,


```
sage: from sage.symbolic.function import BuiltinFunction
sage: class Test(BuiltinFunction):
....:     def __init__(self):
....:         BuiltinFunction.__init__(self, 'test', nargs=1)
....:     def _evalf_(self, x, parent):
....:         return 0.5
....:     def _eval_(self, x):
....:         y = self._eval_default(x)
....:         if y:
....:             return y
....:         else:
....:             return 3
sage: test = Test()
sage: test(1.3)
0.500000000000000
sage: test(pi)
3
```



---

Attachment

Benjamin, I CC'ed you since it appears that you implemented this for many symbolic functions. What do you think of this approach?

The reason why I added `AttributeError` to the `except` in `test_relation` is because this is necessary to make comparisons work with some of the hyperbolic functions. Before it worked because they wouldn't evaluate automatically with `CIF` input, but they should since it's inexact.

I also added a small fix to make the hyperbolic functions work with the Python `complex` type; they didn't before.

Patchbot apply trac15071.patch


---

Comment by eviatarbach created at 2013-08-21 03:44:06

Changing status from new to needs_review.


---

Comment by benjaminfjones created at 2013-08-21 23:33:39

Good idea!

My initial impression is that your patch looks good, but I don't have time right now to do a thorough review. 

The only immediate change I would suggest is to separate the changes to `hyperbolic.py` and `expression.py` into a different ticket and patch. It's annoying, I know, but it's better to separate issues in the long run.


---

Comment by eviatarbach created at 2013-08-22 04:41:34

Okay thank you!

I can separate one of the changes to `hyperbolic.py`, but the other one is necessary to keep this patch from failing tests, and indeed to not break many comparisons involving hyperbolic functions. Can I keep that one in this patch?


---

Attachment

Actually I meant all the changes to `hyperbolic.py` could be reverted (now #15134), but not the one to `expression.pyx`. New patch removes everything not necessary for passing doctests.

Note that I changed the `cot` tests to `coth` since `cot` wasn't actually testing the function, because it doesn't use `_eval_default`.

Patchbot apply trac15071_2.patchâ€‹


---

Comment by benjaminfjones created at 2013-09-01 05:04:07

Ok, makes sense. Thanks for doing the separation.

I looked in detail at your latest patch and it looks good. One thing I'd like to see before it's merged is more test coverage. It looks like only the `len(args) == 1` branch is tested right now. We should include tests of the multiple argument case and also the case of multiple arguments with distinct parents. Of course, once we have symbolic functions that use this `_eval_default` the toy test classes like you've included won't be necessary.

After that, I'd say this is good to go.


---

Comment by eviatarbach created at 2013-09-01 19:42:46

Thank you! Here's a version with more tests.


---

Attachment

Apparently excepting the `AttributeError` fixes other issues; see http://ask.sagemath.org/question/2957/strange-attributeerror. I would add a test for that but I guess it's not within the scope of the patch; maybe I'll just create a new ticket and mark it as fixed by this one.


---

Comment by benjaminfjones created at 2013-09-07 17:50:58

It looks like now, only the second branch (the else) is being tested. Can we add the original test you had as well as the new one?

About the `AttributeError` issue, what you propose sounds reasonable to me, but it excludes the possibility of getting a test in the codebase (since the other ticket wouldn't get to include a patch). Since excepting the error is done here I think it's probably okay to include a test as an "aside". What do you think?


---

Comment by eviatarbach created at 2013-09-10 02:09:20

Sounds good! New patch makes the suggested changes.


---

Attachment

Looks great. After tests come back positive from the bot, I'll give this a positive review.

----

patchbot, apply trac15071_4.patch


---

Comment by benjaminfjones created at 2013-09-10 20:41:16

Old patchbot seems to be on vacation. I'll do the testing myself..


---

Comment by benjaminfjones created at 2013-09-10 22:25:25

All tests pass! Positive review.


---

Comment by benjaminfjones created at 2013-09-10 22:25:25

Changing status from needs_review to positive_review.


---

Comment by eviatarbach created at 2013-09-11 01:42:01

Thank you so much for reviewing! Now functions that are doing this manually can be transitioned.


---

Comment by jdemeyer created at 2013-09-26 15:44:08

Please add your real names as Author and Reviewer.


---

Comment by jdemeyer created at 2013-10-02 06:36:32

Resolution: fixed
