# Issue 10057: Segfault in backward and inverse FFT for 2**n elements

archive/issues_010057.json:
```json
{
    "body": "Assignee: jason, jkantor\n\nCC:  @wdjoyner\n\nSage crashes when asked to do a backward or inverse FFT for sizes that are powers of two:\n\n```\nsage: a = FFT(5)\nsage: a[1] = 2\nsage: a.forward_transform()\nsage: a.backward_transform()\nsage: a = FFT(4)\nsage: a[1] = 2\nsage: a.forward_transform()\nsage: a.backward_transform()\n\n\n------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component\nof Sage has a bug in it (typically accessing invalid memory)\nor is not properly wrapped with _sig_on, _sig_off.\nYou might want to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate (sorry).\n------------------------------------------------------------\n```\n\n\nJoal Heagney reported this problem on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/7830e0c484a0f38d).\n\nIssue created by migration from https://trac.sagemath.org/ticket/10058\n\n",
    "created_at": "2010-10-02T21:13:11Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Segfault in backward and inverse FFT for 2**n elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10057",
    "user": "https://github.com/qed777"
}
```
Assignee: jason, jkantor

CC:  @wdjoyner

Sage crashes when asked to do a backward or inverse FFT for sizes that are powers of two:

```
sage: a = FFT(5)
sage: a[1] = 2
sage: a.forward_transform()
sage: a.backward_transform()
sage: a = FFT(4)
sage: a[1] = 2
sage: a.forward_transform()
sage: a.backward_transform()


------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component
of Sage has a bug in it (typically accessing invalid memory)
or is not properly wrapped with _sig_on, _sig_off.
You might want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate (sorry).
------------------------------------------------------------
```


Joal Heagney reported this problem on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/7830e0c484a0f38d).

Issue created by migration from https://trac.sagemath.org/ticket/10058





---

archive/issue_comments_101252.json:
```json
{
    "body": "This happens with `a.inverse_transform()`, too.  From near the end of `sage/gsl/fft.pyx`:\n\n```python\n    def backward_transform(self):\n        cdef gsl_fft_complex_wavetable * wt\n        cdef gsl_fft_complex_workspace * mem\n        N = Integer(self.n)\n        e = N.exact_log(2)\n        if N==2**e:\n            gsl_fft_complex_backward(self.data, self.stride, self.n, wt, mem)\n```\n\nShould this be\n\n```python\n            gsl_fft_complex_radix2_backward(self.data, self.stride, self.n)\n```\n\n(and similarly for `inverse_transform`)?\n\n```python\n        if N!=2**e:\n            mem = gsl_fft_complex_workspace_alloc(self.n)\n            wt = gsl_fft_complex_wavetable_alloc(self.n)\n            gsl_fft_complex_backward(self.data, self.stride, self.n, wt, mem)\n            gsl_fft_complex_workspace_free(mem)\n            gsl_fft_complex_wavetable_free(wt)\n```\n",
    "created_at": "2010-10-02T21:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101252",
    "user": "https://github.com/qed777"
}
```

This happens with `a.inverse_transform()`, too.  From near the end of `sage/gsl/fft.pyx`:

```python
    def backward_transform(self):
        cdef gsl_fft_complex_wavetable * wt
        cdef gsl_fft_complex_workspace * mem
        N = Integer(self.n)
        e = N.exact_log(2)
        if N==2**e:
            gsl_fft_complex_backward(self.data, self.stride, self.n, wt, mem)
```

Should this be

```python
            gsl_fft_complex_radix2_backward(self.data, self.stride, self.n)
```

(and similarly for `inverse_transform`)?

```python
        if N!=2**e:
            mem = gsl_fft_complex_workspace_alloc(self.n)
            wt = gsl_fft_complex_wavetable_alloc(self.n)
            gsl_fft_complex_backward(self.data, self.stride, self.n, wt, mem)
            gsl_fft_complex_workspace_free(mem)
            gsl_fft_complex_wavetable_free(wt)
```




---

archive/issue_comments_101253.json:
```json
{
    "body": "Attachment [trac_10058.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058.patch) by @mwhansen created at 2010-10-11 03:23:12",
    "created_at": "2010-10-11T03:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101253",
    "user": "https://github.com/mwhansen"
}
```

Attachment [trac_10058.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058.patch) by @mwhansen created at 2010-10-11 03:23:12



---

archive/issue_comments_101254.json:
```json
{
    "body": "Attachment [trac_10058.2.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058.2.patch) by @lftabera created at 2013-03-06 12:00:41\n\nrebase to sage-5.8.beta2",
    "created_at": "2013-03-06T12:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101254",
    "user": "https://github.com/lftabera"
}
```

Attachment [trac_10058.2.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058.2.patch) by @lftabera created at 2013-03-06 12:00:41

rebase to sage-5.8.beta2



---

archive/issue_comments_101255.json:
```json
{
    "body": "I have reviewed (and rebased) the code of M. Hansen and it is correct. I have also added another patch that fills coverage of fft.pyx and cleans the plot code. This second patch needs review.\n\nApply: trac_10058.2.patch, trac_10058_doc.patch",
    "created_at": "2013-03-06T12:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101255",
    "user": "https://github.com/lftabera"
}
```

I have reviewed (and rebased) the code of M. Hansen and it is correct. I have also added another patch that fills coverage of fft.pyx and cleans the plot code. This second patch needs review.

Apply: trac_10058.2.patch, trac_10058_doc.patch



---

archive/issue_comments_101256.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-06T12:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101256",
    "user": "https://github.com/lftabera"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_101257.json:
```json
{
    "body": "Changing keywords from \"\" to \"gsl, fft, segfault\".",
    "created_at": "2013-03-06T12:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101257",
    "user": "https://github.com/lftabera"
}
```

Changing keywords from "" to "gsl, fft, segfault".



---

archive/issue_comments_101258.json:
```json
{
    "body": "Hello! The patches look good. I have the following comments about the doc patch.\n\n1. Can you fix the documentation of the functions? It should be like this\n\n```\ndef function(n, p=1):\n    \"\"\"\n    Determine the ``n``-th number. Note that I didn't use `n`\n    since single backticks will format it in latex.\n   \n    INPUT:\n\n    - ``n`` -- Integer. Description of this parameter\n\n    - ``p`` -- Integer (default: 1). Description of this parameter.\n```\n\n\n2. The following line `180\t        See `self.plot` for details. ` should use `:meth:` to refer to plot. Also, ``self.plot`` is used in some other functions.\n\n```\nSee :meth:`.plot` for details.\n```\n\n\n3. `pi` should also be changed to float in this line\n\n```\n191\t        pi    = sage.symbolic.constants.pi   # should append .n() at the end.\n```\n\n\n4. In the function `plot`, the INPUT needs a fix. It should be like this. Also, see 1. for the comment about default values and formatting.\n\n```\n- ``style`` -- Style of the plot, options are ``\"rect\"`` or ``\"polar\"``\n```\n\n\nYou can refer to the [developer guide](http://www.sagemath.org/doc/developer/conventions.html#documentation-strings) for more information about the formatting of docstrings.\n\n*EDIT*: Some formatting fixes.",
    "created_at": "2013-03-31T03:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101258",
    "user": "https://github.com/ppurka"
}
```

Hello! The patches look good. I have the following comments about the doc patch.

1. Can you fix the documentation of the functions? It should be like this

```
def function(n, p=1):
    """
    Determine the ``n``-th number. Note that I didn't use `n`
    since single backticks will format it in latex.
   
    INPUT:

    - ``n`` -- Integer. Description of this parameter

    - ``p`` -- Integer (default: 1). Description of this parameter.
```


2. The following line `180	        See `self.plot` for details. ` should use `:meth:` to refer to plot. Also, ``self.plot`` is used in some other functions.

```
See :meth:`.plot` for details.
```


3. `pi` should also be changed to float in this line

```
191	        pi    = sage.symbolic.constants.pi   # should append .n() at the end.
```


4. In the function `plot`, the INPUT needs a fix. It should be like this. Also, see 1. for the comment about default values and formatting.

```
- ``style`` -- Style of the plot, options are ``"rect"`` or ``"polar"``
```


You can refer to the [developer guide](http://www.sagemath.org/doc/developer/conventions.html#documentation-strings) for more information about the formatting of docstrings.

*EDIT*: Some formatting fixes.



---

archive/issue_comments_101259.json:
```json
{
    "body": "Attachment [trac_10058_doc.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058_doc.patch) by @lftabera created at 2013-05-10 15:06:59\n\ndocumentation, doctest, cleanin the plot code, rebased against sage 5.10.beta2",
    "created_at": "2013-05-10T15:06:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101259",
    "user": "https://github.com/lftabera"
}
```

Attachment [trac_10058_doc.patch](tarball://root/attachments/some-uuid/ticket10058/trac_10058_doc.patch) by @lftabera created at 2013-05-10 15:06:59

documentation, doctest, cleanin the plot code, rebased against sage 5.10.beta2



---

archive/issue_comments_101260.json:
```json
{
    "body": "Gitified and rebased on top of 6.1. The second patch looks good to me, except for minor points that I fixed in my two commits. Could seomeone please check:\n* that I rebased the code correctly;\n* whether you agree with my changes?\n(If both are ok, please go ahead and set the ticket's status to `positive_review`.)",
    "created_at": "2014-02-01T11:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101260",
    "user": "https://github.com/mezzarobba"
}
```

Gitified and rebased on top of 6.1. The second patch looks good to me, except for minor points that I fixed in my two commits. Could seomeone please check:
* that I rebased the code correctly;
* whether you agree with my changes?
(If both are ok, please go ahead and set the ticket's status to `positive_review`.)



---

archive/issue_comments_101261.json:
```json
{
    "body": "Looks good to me. It applies fine to sage-6.1 and `sage/gsl` passes all doctests.\n\nOn a sidenote, I don't even remember having made those comments earlier. In reply to my comments `@`lftabera updated a new patch but I never got any email because adding attachments do not generate emails!\n\n*In short*: add a comment after adding or updating a git branch; otherwise we don't get email notifications!",
    "created_at": "2014-02-01T14:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101261",
    "user": "https://github.com/ppurka"
}
```

Looks good to me. It applies fine to sage-6.1 and `sage/gsl` passes all doctests.

On a sidenote, I don't even remember having made those comments earlier. In reply to my comments `@`lftabera updated a new patch but I never got any email because adding attachments do not generate emails!

*In short*: add a comment after adding or updating a git branch; otherwise we don't get email notifications!



---

archive/issue_comments_101262.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-01T14:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101262",
    "user": "https://github.com/ppurka"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_101263.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-02T16:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101263",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_101264.json:
```json
{
    "body": "Followup at #15799",
    "created_at": "2014-02-08T13:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10057#issuecomment-101264",
    "user": "https://github.com/vbraun"
}
```

Followup at #15799
