# Issue 20929: Improving speed of AffineGometryDesign

Issue created by migration from https://trac.sagemath.org/ticket/21166

Original creator: rschrecker

Original creation time: 2016-08-04 14:18:59

CC:  vdelecroix dimpase

In sage.combinat.designs.block_designs, AffineGeometryDesign is far slower than ProjectiveGeometryDesign. This is easy to fix, perhaps something like this: https://github.com/rschrecker/AffineGeometryDesign


---

Comment by dimpase created at 2016-08-08 11:04:48

New commits:


---

Comment by dimpase created at 2016-08-08 11:04:48

Changing status from new to needs_review.


---

Comment by dimpase created at 2016-08-08 11:07:52

Vincent, could you have a look?


---

Comment by vdelecroix created at 2016-08-08 23:36:56

Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.


---

Comment by dimpase created at 2016-08-09 10:51:22

Replying to [comment:4 vdelecroix]:
> Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.

The new code uses `point_coordinates` provided by `ProjectiveGeometryDesign`, and they are only available with the default algorithm. Needless to say, the current `AffineGeometryDesign` does not provide `algorithm` choice.


---

Comment by vdelecroix created at 2016-08-09 16:10:28

- I implemented a more direct version
- did some cleanup in `AffineGeometryDesign` and `ProjectiveGeometryDesign`
- added a non-trivial check in case `check=True`

Please review.
----
New commits:


---

Comment by vdelecroix created at 2016-08-09 16:20:24

I weirdly did not receive an e-mail notification for [comment:6 comment:6]... let us try with 7.


---

Comment by vdelecroix created at 2016-08-25 13:45:31

ping!


---

Comment by dimpase created at 2016-08-26 07:02:49

One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.
(One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)


---

Comment by dimpase created at 2016-08-26 08:11:48

Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.


---

Comment by git created at 2016-08-28 00:44:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-08-28 00:45:19

Replying to [comment:10 dimpase]:
> One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.
> (One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)

You are right. The fact is now documented.


---

Comment by vdelecroix created at 2016-08-28 00:45:34

Replying to [comment:11 dimpase]:
> Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.

Indeed, it is a bit cleaner with `islice`.


---

Comment by vdelecroix created at 2016-08-28 00:45:47

Needs review again!


---

Comment by dimpase created at 2016-08-28 16:36:09

some English improvements:

```
diff --git a/src/sage/matrix/echelon_matrix.pyx b/src/sage/matrix/echelon_matrix.pyx
index 7d294d2..b699d30 100644
--- a/src/sage/matrix/echelon_matrix.pyx
+++ b/src/sage/matrix/echelon_matrix.pyx
@@ -39,12 +39,12 @@ def reduced_echelon_matrix_iterator(K, k, n, bint sparse=False, bint copy=True,
 
         We ensure that the iteration order is so that all matrices with given
         pivot columns are generated consecutively. Furthermore, the order in
-        which appear the pivot columns is lexicographic.
+        which the pivot columns appear is lexicographic.
 
         It would be faster to generate the pivots columns following a Gray code.
-        There would be only one pivot changing at a time and would avoid the
-        possibly expensive ``m0.__copy__()``. However that we would modify
-        the generation order that some functions depend on.
+        There would be only one pivot changing at a time, avoiding the
+        possibly expensive ``m0.__copy__()``. However that would modify
+        the generation order some functions depend upon.
 
     EXAMPLES::
 
```



---

Comment by dimpase created at 2016-08-28 17:08:37

as well, `l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q) == q^d`, as this is just the number of points in an affine subspace of dimemsion `d`. Thus

```
diff --git a/src/sage/combinat/designs/block_design.py b/src/sage/combinat/designs/block_design.py
index a097317..31b76c5 100644
--- a/src/sage/combinat/designs/block_design.py
+++ b/src/sage/combinat/designs/block_design.py
@@ -857,7 +857,7 @@ def AffineGeometryDesign(n, d, F, point_coordinates=True, check=True):
 
     blocks = []
     l1 = q_binomial(n+1, d+1, q) - q_binomial(n, d+1, q)
-    l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q)
+    l2 = q**d
     for m1 in islice(reduced_echelon_matrix_iterator(F,d+1,n+1,copy=False), l1):
         b = []
         for m2 in islice(reduced_echelon_matrix_iterator(F,1,d+1,copy=False), l2):
```



---

Comment by dimpase created at 2016-08-28 21:50:17

Other than these two issues, it looks good to me.


---

Comment by git created at 2016-08-30 13:41:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-08-30 13:43:06

done and done


---

Comment by dimpase created at 2016-08-30 15:50:14

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2016-08-30 15:50:14

OK, great, thanks.


---

Comment by vbraun created at 2016-09-04 00:13:30

Resolution: fixed
