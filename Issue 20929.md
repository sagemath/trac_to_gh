# Issue 20929: Improving speed of AffineGometryDesign

archive/issues_020929.json:
```json
{
    "body": "CC:  vdelecroix dimpase\n\nIn sage.combinat.designs.block_designs, AffineGeometryDesign is far slower than ProjectiveGeometryDesign. This is easy to fix, perhaps something like this: https://github.com/rschrecker/AffineGeometryDesign\n\nIssue created by migration from https://trac.sagemath.org/ticket/21166\n\n",
    "created_at": "2016-08-04T14:18:59Z",
    "labels": [
        "combinatorial designs",
        "minor",
        "enhancement"
    ],
    "title": "Improving speed of AffineGometryDesign",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20929",
    "user": "rschrecker"
}
```
CC:  vdelecroix dimpase

In sage.combinat.designs.block_designs, AffineGeometryDesign is far slower than ProjectiveGeometryDesign. This is easy to fix, perhaps something like this: https://github.com/rschrecker/AffineGeometryDesign

Issue created by migration from https://trac.sagemath.org/ticket/21166





---

archive/issue_comments_289437.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-08T11:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289437",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_289438.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-08T11:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289438",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_289439.json:
```json
{
    "body": "Vincent, could you have a look?",
    "created_at": "2016-08-08T11:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289439",
    "user": "dimpase"
}
```

Vincent, could you have a look?



---

archive/issue_comments_289440.json:
```json
{
    "body": "Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.",
    "created_at": "2016-08-08T23:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289440",
    "user": "vdelecroix"
}
```

Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.



---

archive/issue_comments_289441.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.\n\nThe new code uses `point_coordinates` provided by `ProjectiveGeometryDesign`, and they are only available with the default algorithm. Needless to say, the current `AffineGeometryDesign` does not provide `algorithm` choice.",
    "created_at": "2016-08-09T10:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289441",
    "user": "dimpase"
}
```

Replying to [comment:4 vdelecroix]:
> Would be better, as in the case of `ProjectiveGeometryDesign` to have a `algorithm` keyword.

The new code uses `point_coordinates` provided by `ProjectiveGeometryDesign`, and they are only available with the default algorithm. Needless to say, the current `AffineGeometryDesign` does not provide `algorithm` choice.



---

archive/issue_comments_289442.json:
```json
{
    "body": "- I implemented a more direct version\n- did some cleanup in `AffineGeometryDesign` and `ProjectiveGeometryDesign`\n- added a non-trivial check in case `check=True`\n\nPlease review.\n----\nNew commits:",
    "created_at": "2016-08-09T16:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289442",
    "user": "vdelecroix"
}
```

- I implemented a more direct version
- did some cleanup in `AffineGeometryDesign` and `ProjectiveGeometryDesign`
- added a non-trivial check in case `check=True`

Please review.
----
New commits:



---

archive/issue_comments_289443.json:
```json
{
    "body": "I weirdly did not receive an e-mail notification for [comment:6 comment:6]... let us try with 7.",
    "created_at": "2016-08-09T16:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289443",
    "user": "vdelecroix"
}
```

I weirdly did not receive an e-mail notification for [comment:6 comment:6]... let us try with 7.



---

archive/issue_comments_289444.json:
```json
{
    "body": "ping!",
    "created_at": "2016-08-25T13:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289444",
    "user": "vdelecroix"
}
```

ping!



---

archive/issue_comments_289445.json:
```json
{
    "body": "One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.\n(One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)",
    "created_at": "2016-08-26T07:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289445",
    "user": "dimpase"
}
```

One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.
(One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)



---

archive/issue_comments_289446.json:
```json
{
    "body": "Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.",
    "created_at": "2016-08-26T08:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289446",
    "user": "dimpase"
}
```

Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.



---

archive/issue_comments_289447.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-28T00:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289447",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_289448.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.\n> (One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)\n\nYou are right. The fact is now documented.",
    "created_at": "2016-08-28T00:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289448",
    "user": "vdelecroix"
}
```

Replying to [comment:10 dimpase]:
> One question: your new code in `AffineGeometryDesign` uses `reduced_echelon_matrix_iterator` in a way that assumes a particular order the latter traverses matrices in question. This order is not documented, and can be changed, breaking your code in turn. I don't like this.
> (One way out would be to document the order produced by `reduced_echelon_matrix_iterator` and add the relevant tests there)

You are right. The fact is now documented.



---

archive/issue_comments_289449.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.\n\nIndeed, it is a bit cleaner with `islice`.",
    "created_at": "2016-08-28T00:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289449",
    "user": "vdelecroix"
}
```

Replying to [comment:11 dimpase]:
> Anyway, instead of `break` in loops use `itertools.islice` to take the needed number of items from `reduced_echelon_matrix_iterator`.

Indeed, it is a bit cleaner with `islice`.



---

archive/issue_comments_289450.json:
```json
{
    "body": "Needs review again!",
    "created_at": "2016-08-28T00:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289450",
    "user": "vdelecroix"
}
```

Needs review again!



---

archive/issue_comments_289451.json:
```json
{
    "body": "some English improvements:\n\n```\ndiff --git a/src/sage/matrix/echelon_matrix.pyx b/src/sage/matrix/echelon_matrix.pyx\nindex 7d294d2..b699d30 100644\n--- a/src/sage/matrix/echelon_matrix.pyx\n+++ b/src/sage/matrix/echelon_matrix.pyx\n@@ -39,12 +39,12 @@ def reduced_echelon_matrix_iterator(K, k, n, bint sparse=False, bint copy=True,\n \n         We ensure that the iteration order is so that all matrices with given\n         pivot columns are generated consecutively. Furthermore, the order in\n-        which appear the pivot columns is lexicographic.\n+        which the pivot columns appear is lexicographic.\n \n         It would be faster to generate the pivots columns following a Gray code.\n-        There would be only one pivot changing at a time and would avoid the\n-        possibly expensive ``m0.__copy__()``. However that we would modify\n-        the generation order that some functions depend on.\n+        There would be only one pivot changing at a time, avoiding the\n+        possibly expensive ``m0.__copy__()``. However that would modify\n+        the generation order some functions depend upon.\n \n     EXAMPLES::\n \n```\n",
    "created_at": "2016-08-28T16:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289451",
    "user": "dimpase"
}
```

some English improvements:

```
diff --git a/src/sage/matrix/echelon_matrix.pyx b/src/sage/matrix/echelon_matrix.pyx
index 7d294d2..b699d30 100644
--- a/src/sage/matrix/echelon_matrix.pyx
+++ b/src/sage/matrix/echelon_matrix.pyx
@@ -39,12 +39,12 @@ def reduced_echelon_matrix_iterator(K, k, n, bint sparse=False, bint copy=True,
 
         We ensure that the iteration order is so that all matrices with given
         pivot columns are generated consecutively. Furthermore, the order in
-        which appear the pivot columns is lexicographic.
+        which the pivot columns appear is lexicographic.
 
         It would be faster to generate the pivots columns following a Gray code.
-        There would be only one pivot changing at a time and would avoid the
-        possibly expensive ``m0.__copy__()``. However that we would modify
-        the generation order that some functions depend on.
+        There would be only one pivot changing at a time, avoiding the
+        possibly expensive ``m0.__copy__()``. However that would modify
+        the generation order some functions depend upon.
 
     EXAMPLES::
 
```




---

archive/issue_comments_289452.json:
```json
{
    "body": "as well, `l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q) == q^d`, as this is just the number of points in an affine subspace of dimemsion `d`. Thus\n\n```\ndiff --git a/src/sage/combinat/designs/block_design.py b/src/sage/combinat/designs/block_design.py\nindex a097317..31b76c5 100644\n--- a/src/sage/combinat/designs/block_design.py\n+++ b/src/sage/combinat/designs/block_design.py\n@@ -857,7 +857,7 @@ def AffineGeometryDesign(n, d, F, point_coordinates=True, check=True):\n \n     blocks = []\n     l1 = q_binomial(n+1, d+1, q) - q_binomial(n, d+1, q)\n-    l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q)\n+    l2 = q**d\n     for m1 in islice(reduced_echelon_matrix_iterator(F,d+1,n+1,copy=False), l1):\n         b = []\n         for m2 in islice(reduced_echelon_matrix_iterator(F,1,d+1,copy=False), l2):\n```\n",
    "created_at": "2016-08-28T17:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289452",
    "user": "dimpase"
}
```

as well, `l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q) == q^d`, as this is just the number of points in an affine subspace of dimemsion `d`. Thus

```
diff --git a/src/sage/combinat/designs/block_design.py b/src/sage/combinat/designs/block_design.py
index a097317..31b76c5 100644
--- a/src/sage/combinat/designs/block_design.py
+++ b/src/sage/combinat/designs/block_design.py
@@ -857,7 +857,7 @@ def AffineGeometryDesign(n, d, F, point_coordinates=True, check=True):
 
     blocks = []
     l1 = q_binomial(n+1, d+1, q) - q_binomial(n, d+1, q)
-    l2 = q_binomial(d+1, 1, q) - q_binomial(d, 1, q)
+    l2 = q**d
     for m1 in islice(reduced_echelon_matrix_iterator(F,d+1,n+1,copy=False), l1):
         b = []
         for m2 in islice(reduced_echelon_matrix_iterator(F,1,d+1,copy=False), l2):
```




---

archive/issue_comments_289453.json:
```json
{
    "body": "Other than these two issues, it looks good to me.",
    "created_at": "2016-08-28T21:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289453",
    "user": "dimpase"
}
```

Other than these two issues, it looks good to me.



---

archive/issue_comments_289454.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-30T13:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289454",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_289455.json:
```json
{
    "body": "done and done",
    "created_at": "2016-08-30T13:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289455",
    "user": "vdelecroix"
}
```

done and done



---

archive/issue_comments_289456.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-30T15:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289456",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_289457.json:
```json
{
    "body": "OK, great, thanks.",
    "created_at": "2016-08-30T15:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289457",
    "user": "dimpase"
}
```

OK, great, thanks.



---

archive/issue_comments_289458.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-04T00:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20929",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20929#issuecomment-289458",
    "user": "vbraun"
}
```

Resolution: fixed
