# Issue 33999: sage.env: Give values from sage_conf precedence over environment variables

archive/issues_033999.json:
```json
{
    "body": "CC:  @jhpalmieri @kiwifb\n\nThis change will make installations of Sage more robust.\n\nCurrently, \n\n```\n    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/python3 -c \"import sage.env; print(sage.env.SAGE_ROOT)\"'\n```\n\nwill give `SAGE_ROOT_A` (bad), whereas\n\n```\n    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/sage -c \"import sage.env; print(sage.env.SAGE_ROOT)\"'\n```\n\nwill give `SAGE_ROOT_B` (good).\n\nSimilarly to #33786 (Top-level sage script: Unconditionally set SAGE_ROOT)\n\nIssue created by migration from https://trac.sagemath.org/ticket/34236\n\n",
    "created_at": "2022-07-28T20:16:17Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage.env: Give values from sage_conf precedence over environment variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33999",
    "user": "@mkoeppe"
}
```
CC:  @jhpalmieri @kiwifb

This change will make installations of Sage more robust.

Currently, 

```
    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/python3 -c "import sage.env; print(sage.env.SAGE_ROOT)"'
```

will give `SAGE_ROOT_A` (bad), whereas

```
    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/sage -c "import sage.env; print(sage.env.SAGE_ROOT)"'
```

will give `SAGE_ROOT_B` (good).

Similarly to #33786 (Top-level sage script: Unconditionally set SAGE_ROOT)

Issue created by migration from https://trac.sagemath.org/ticket/34236





---

archive/issue_comments_482627.json:
```json
{
    "body": "I am a bit dubious when I see the title. I don't think you should override environment variables unless you absolutely have to.\n\nWhat I think the ticket is about, and feel free to correct me, is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables. They should be private. If my interpretation is correct we need to start with a list of those variables that should be private.",
    "created_at": "2022-08-03T00:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482627",
    "user": "@kiwifb"
}
```

I am a bit dubious when I see the title. I don't think you should override environment variables unless you absolutely have to.

What I think the ticket is about, and feel free to correct me, is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables. They should be private. If my interpretation is correct we need to start with a list of those variables that should be private.



---

archive/issue_comments_482628.json:
```json
{
    "body": "Replying to [comment:2 fbissey]:\n> What I think the ticket is about [...] is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables.\n\nWell, that's a slightly stronger form than what I've written.\n\nIn what I wrote, the value would still be taken from the environment if it is not defined in `sage_conf`.\n\nThe stronger form would be fine for me as well.",
    "created_at": "2022-08-03T01:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482628",
    "user": "@mkoeppe"
}
```

Replying to [comment:2 fbissey]:
> What I think the ticket is about [...] is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables.

Well, that's a slightly stronger form than what I've written.

In what I wrote, the value would still be taken from the environment if it is not defined in `sage_conf`.

The stronger form would be fine for me as well.



---

archive/issue_comments_482629.json:
```json
{
    "body": "Thanks for the clarification. I guess from the point of view of what I have written, that makes all variables in `sage_conf` private.\n\nFrom my distro point of view that may mean adding variables there that I did not care to have. Like `SAGE_ROOT`.",
    "created_at": "2022-08-03T01:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482629",
    "user": "@kiwifb"
}
```

Thanks for the clarification. I guess from the point of view of what I have written, that makes all variables in `sage_conf` private.

From my distro point of view that may mean adding variables there that I did not care to have. Like `SAGE_ROOT`.



---

archive/issue_comments_482630.json:
```json
{
    "body": "The stronger form can be implemented by just adding `force=True`.\n\n```\n    - ``force`` -- boolean (optional, default is ``False``). If\n      ``True``, skip the environment variable and only use the\n      fallbacks.\n```\n",
    "created_at": "2022-08-03T01:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482630",
    "user": "@mkoeppe"
}
```

The stronger form can be implemented by just adding `force=True`.

```
    - ``force`` -- boolean (optional, default is ``False``). If
      ``True``, skip the environment variable and only use the
      fallbacks.
```




---

archive/issue_comments_482631.json:
```json
{
    "body": "Some variables such as `UNAME` make no sense to even fetch from `sage_conf`. We could just set the value in sage.env.",
    "created_at": "2022-08-03T01:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482631",
    "user": "@mkoeppe"
}
```

Some variables such as `UNAME` make no sense to even fetch from `sage_conf`. We could just set the value in sage.env.



---

archive/issue_comments_482632.json:
```json
{
    "body": "When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in - do you mean something else? I am asking because I am not sure where `UNAME` comes from.",
    "created_at": "2022-08-03T01:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482632",
    "user": "@kiwifb"
}
```

When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in - do you mean something else? I am asking because I am not sure where `UNAME` comes from.



---

archive/issue_comments_482633.json:
```json
{
    "body": "Replying to [comment:7 fbissey]:\n> When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in \n\nYes\n\n> I am asking because I am not sure where `UNAME` comes from.\n\nIt's set in the `sage-env` script and then again there's the fallback in sage.env.",
    "created_at": "2022-08-03T01:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482633",
    "user": "@mkoeppe"
}
```

Replying to [comment:7 fbissey]:
> When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in 

Yes

> I am asking because I am not sure where `UNAME` comes from.

It's set in the `sage-env` script and then again there's the fallback in sage.env.



---

archive/issue_comments_482634.json:
```json
{
    "body": "So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.",
    "created_at": "2022-08-03T01:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482634",
    "user": "@kiwifb"
}
```

So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.



---

archive/issue_comments_482635.json:
```json
{
    "body": "Replying to [comment:9 fbissey]:\n> So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.\n\nWell, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.\n\nBut by using `force=True` we can at least eliminate the useless dataflow from environment variables to sage.env variables\n----\nNew commits:",
    "created_at": "2022-08-03T02:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482635",
    "user": "@mkoeppe"
}
```

Replying to [comment:9 fbissey]:
> So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.

Well, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.

But by using `force=True` we can at least eliminate the useless dataflow from environment variables to sage.env variables
----
New commits:



---

archive/issue_comments_482636.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> Replying to [comment:9 fbissey]:\n> > So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.\n> \n> Well, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.\n> \n\nAgree on the uselessness. sage-on-gentoo is `sage-env` less and so far I haven't had complains. If we had some kind of repo of user scripts, it would be an interesting thing to test.",
    "created_at": "2022-08-03T02:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482636",
    "user": "@kiwifb"
}
```

Replying to [comment:11 mkoeppe]:
> Replying to [comment:9 fbissey]:
> > So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.
> 
> Well, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.
> 

Agree on the uselessness. sage-on-gentoo is `sage-env` less and so far I haven't had complains. If we had some kind of repo of user scripts, it would be an interesting thing to test.



---

archive/issue_comments_482637.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-03T02:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482637",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482638.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-03T02:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482638",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482639.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-03T03:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33999",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33999#issuecomment-482639",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
