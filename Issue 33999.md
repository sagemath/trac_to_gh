# Issue 33999: sage.env: Give values from sage_conf precedence over environment variables

Issue created by migration from https://trac.sagemath.org/ticket/34236

Original creator: mkoeppe

Original creation time: 2022-07-28 20:16:17

CC:  jhpalmieri fbissey

This change will make installations of Sage more robust.

Currently, 

```
    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/python3 -c "import sage.env; print(sage.env.SAGE_ROOT)"'
```

will give `SAGE_ROOT_A` (bad), whereas

```
    /SAGE_ROOT_A/sage -sh -c '/SAGE_ROOT_B/venv/bin/sage -c "import sage.env; print(sage.env.SAGE_ROOT)"'
```

will give `SAGE_ROOT_B` (good).

Similarly to #33786 (Top-level sage script: Unconditionally set SAGE_ROOT)


---

Comment by fbissey created at 2022-08-03 00:59:15

I am a bit dubious when I see the title. I don't think you should override environment variables unless you absolutely have to.

What I think the ticket is about, and feel free to correct me, is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables. They should be private. If my interpretation is correct we need to start with a list of those variables that should be private.


---

Comment by mkoeppe created at 2022-08-03 01:04:35

Replying to [comment:2 fbissey]:
> What I think the ticket is about [...] is that some variables, needed for sage's own operation, should be internal to sage and not exposed to be modifiable by environment variables.

Well, that's a slightly stronger form than what I've written.

In what I wrote, the value would still be taken from the environment if it is not defined in `sage_conf`.

The stronger form would be fine for me as well.


---

Comment by fbissey created at 2022-08-03 01:08:53

Thanks for the clarification. I guess from the point of view of what I have written, that makes all variables in `sage_conf` private.

From my distro point of view that may mean adding variables there that I did not care to have. Like `SAGE_ROOT`.


---

Comment by mkoeppe created at 2022-08-03 01:36:35

The stronger form can be implemented by just adding `force=True`.

```
    - ``force`` -- boolean (optional, default is ``False``). If
      ``True``, skip the environment variable and only use the
      fallbacks.
```



---

Comment by mkoeppe created at 2022-08-03 01:37:41

Some variables such as `UNAME` make no sense to even fetch from `sage_conf`. We could just set the value in sage.env.


---

Comment by fbissey created at 2022-08-03 01:42:48

When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in - do you mean something else? I am asking because I am not sure where `UNAME` comes from.


---

Comment by mkoeppe created at 2022-08-03 01:54:01

Replying to [comment:7 fbissey]:
> When you say in `sage_conf` I think of variables in this file https://github.com/sagemath/sage/blob/develop/pkgs/sage-conf/_sage_conf/_conf.py.in 

Yes

> I am asking because I am not sure where `UNAME` comes from.

It's set in the `sage-env` script and then again there's the fallback in sage.env.


---

Comment by fbissey created at 2022-08-03 01:56:58

So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.


---

Comment by mkoeppe created at 2022-08-03 02:05:09

Replying to [comment:9 fbissey]:
> So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.

Well, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.

But by using `force=True` we can at least eliminate the useless dataflow from environment variables to sage.env variables
----
New commits:


---

Comment by fbissey created at 2022-08-03 02:21:00

Replying to [comment:11 mkoeppe]:
> Replying to [comment:9 fbissey]:
> > So, are you also wanting to cut some redundancies as part of the ticket? I guess it may make sense with some item.
> 
> Well, many environment variables set in `sage-env` are completely useless, but I've been reluctant to remove them in case user scripts make use of them.
> 

Agree on the uselessness. sage-on-gentoo is `sage-env` less and so far I haven't had complains. If we had some kind of repo of user scripts, it would be an interesting thing to test.


---

Comment by git created at 2022-08-03 02:23:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 02:35:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-03 03:03:40

Branch pushed to git repo; I updated commit sha1. New commits:
