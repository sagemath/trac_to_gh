# Issue 18915: {Real,Complex}Ball: Miscellaneous fixes and improvements

archive/issues_018915.json:
```json
{
    "body": "CC:  cheuberg\n\nMostly for compatibility with RIF/CIF.\n\nMore commits to come (probably), but should already be reviewable.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19152\n\n",
    "created_at": "2015-09-07T12:31:54Z",
    "labels": [
        "numerical",
        "major",
        "enhancement"
    ],
    "title": "{Real,Complex}Ball: Miscellaneous fixes and improvements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18915",
    "user": "mmezzarobba"
}
```
CC:  cheuberg

Mostly for compatibility with RIF/CIF.

More commits to come (probably), but should already be reviewable.

Issue created by migration from https://trac.sagemath.org/ticket/19152





---

archive/issue_comments_259075.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-07T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259075",
    "user": "mmezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_259076.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2015-09-07T12:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259076",
    "user": "mmezzarobba"
}
```

Last 10 new commits:



---

archive/issue_comments_259077.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-07T12:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259077",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259078.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-07T15:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259078",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-10-15T09:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259079",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_259080.json:
```json
{
    "body": "Rebased and extended.",
    "created_at": "2015-10-15T09:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259080",
    "user": "mmezzarobba"
}
```

Rebased and extended.



---

archive/issue_comments_259081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-10-15T12:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_259082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2015-10-16T10:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259082",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_259083.json:
```json
{
    "body": "As discussed in [ticket:17220#comment:15 #17220], the `experimental` decorator should be removed.",
    "created_at": "2015-10-30T13:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259083",
    "user": "cheuberg"
}
```

As discussed in [ticket:17220#comment:15 #17220], the `experimental` decorator should be removed.



---

archive/issue_comments_259084.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-10-31T19:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259084",
    "user": "cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_259085.json:
```json
{
    "body": "I read the modifications and have the following comments.\n1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.\n2. `polynomial_element.pyx`:\n  \t- I am very surprised to see this change here in an arb ticket.\n  \t- The documentation of `is_gen` states: \"Important - this function doesn\u2019t return True if self equals the generator; it returns True if self is the generator.\" I.e., the outcome differs from the old behaviour.\n3. `power_series_ring_element.pyx`: I am surprised to see this change here in an arb ticket, but I guess that it will not do any harm.\n4. `RealBall.__hash__`: I do not like the fact that the fractional part of the midpoint is ignored completely:\n\n```\nsage: hash(RBF(3/4))\n1048577\nsage: hash(RBF(5/8))\n1048577\nsage: hash(RBF(7/8))\n1048577\n```\n\n5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`\n6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections\n7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.\n8. `RealBall.__lshift__`, `RealBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `RealBall` if this is a method of `RealBall`?\n9. `ComplexBall._is_atomic`: `self.is_real() or self.imag().is_zero()` seems to be redundant. Do you want to say `self.real().is_zero()` instead?\n10. `ComplexBall.add_error`: missing INPUT: and OUTPUT: sections\n21. `ComplexBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.\n32. `ComplexBall.__lshift__`, `ComplexBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `ComplexBall` if this is a method of `ComplexBall`?\n----\nNew commits:",
    "created_at": "2015-10-31T19:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259085",
    "user": "cheuberg"
}
```

I read the modifications and have the following comments.
1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.
2. `polynomial_element.pyx`:
  	- I am very surprised to see this change here in an arb ticket.
  	- The documentation of `is_gen` states: "Important - this function doesn’t return True if self equals the generator; it returns True if self is the generator." I.e., the outcome differs from the old behaviour.
3. `power_series_ring_element.pyx`: I am surprised to see this change here in an arb ticket, but I guess that it will not do any harm.
4. `RealBall.__hash__`: I do not like the fact that the fractional part of the midpoint is ignored completely:

```
sage: hash(RBF(3/4))
1048577
sage: hash(RBF(5/8))
1048577
sage: hash(RBF(7/8))
1048577
```

5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`
6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections
7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.
8. `RealBall.__lshift__`, `RealBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `RealBall` if this is a method of `RealBall`?
9. `ComplexBall._is_atomic`: `self.is_real() or self.imag().is_zero()` seems to be redundant. Do you want to say `self.real().is_zero()` instead?
10. `ComplexBall.add_error`: missing INPUT: and OUTPUT: sections
21. `ComplexBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.
32. `ComplexBall.__lshift__`, `ComplexBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `ComplexBall` if this is a method of `ComplexBall`?
----
New commits:



---

archive/issue_comments_259086.json:
```json
{
    "body": "Replying to [comment:12 cheuberg]:\n> I read the modifications and have the following comments.\n\nThank you very much for your comments. I'm a bit busy with other things right now, but I'll try to have a look next Friday, if that's okay with you.",
    "created_at": "2015-10-31T20:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259086",
    "user": "mmezzarobba"
}
```

Replying to [comment:12 cheuberg]:
> I read the modifications and have the following comments.

Thank you very much for your comments. I'm a bit busy with other things right now, but I'll try to have a look next Friday, if that's okay with you.



---

archive/issue_comments_259087.json:
```json
{
    "body": "Replying to [comment:13 mmezzarobba]:\n> Thank you very much for your comments. I'm a bit busy with other things right now, but I'll try to have a look next Friday, if that's okay with you.\n\nI couldn't do much due to network problems, sorry. Hopefully Monday...",
    "created_at": "2015-11-06T19:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259087",
    "user": "mmezzarobba"
}
```

Replying to [comment:13 mmezzarobba]:
> Thank you very much for your comments. I'm a bit busy with other things right now, but I'll try to have a look next Friday, if that's okay with you.

I couldn't do much due to network problems, sorry. Hopefully Monday...



---

archive/issue_comments_259088.json:
```json
{
    "body": "I am having a quick look though this branch, mostly to check for technicalities. It's a lot, so I'm not saying that you really must fix all these for positive_review.\n\n1. The naming of the files is inconsistent: why `real_arb` and `complex_ball_acb`?\n\n2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.\n\n3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).\n\n4. The `__hash__` for `RBF` is bad:\n\n```\nsage: from sage.rings.real_arb import RBF\nsage: hash(RBF(0.6))\n1048577\nsage: hash(RBF(0.7))\n1048577\nsage: hash(RBF(0.8))\n1048577\nsage: hash(RBF(0.9))\n1048577\n```\n\n\n5. For `CBF.__hash__`, what's the point of `>> 7`?\n\n6. This is a very strange way to handle exceptions, what's wrong with `raise`?\n\n```\n        if arf_get_mpfr(rad.value, tmp, GMP_RNDN):\n            abort()\n```\n\n\n7. Replace the `GMP_RND` macros by `MPFR_RND`.\n\n8. You can replace\n\n```\ncdef extern from \"math.h\":\n    long lrint(double)\n```\n\nby `from libc.math cimport lrint` (although I would prefer to not use it in the hash).\n\n9. What's with this comment?\n\n```\n                # FIXME: RBF is not even associative, but CompletionFunctor\n                # only works with rings, and other coercion features require\n                # methods like is_integral_domain() to be defined\n                category=category or sage.categories.fields.Fields().Infinite())\n```\n\nYour class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?\n\n10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.\n\n21. You should really avoid this: `include \"sage/ext/python.pxi\"`, just `cimport` what you need.\n\n32. What's the difference between `contains_exact` and `__contains__`? I don't understand why you need both these methods.\n\n43. When raising exceptions, add a string: don't just `raise TypeError`, but `raise TypeError(\"useful message here\")`\n\n54. You write `.. SEEALSO:: :meth:`abs` but there is no such method.\n\n65. I still don't understand why `below_abs` and `above_abs` return a ball instead of a real number. At the very least, this should be documentated in an `OUTPUT:` block in those methods.\n\n76. This is confusing documentation: `Return the right endpoint of this ball, viewed as an interval.` I would read it like this method returns an interval. Why not `Return the right endpoint of this ball.`?\n\n87. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`\n\n98. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`",
    "created_at": "2015-11-07T10:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259088",
    "user": "jdemeyer"
}
```

I am having a quick look though this branch, mostly to check for technicalities. It's a lot, so I'm not saying that you really must fix all these for positive_review.

1. The naming of the files is inconsistent: why `real_arb` and `complex_ball_acb`?

2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.

3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).

4. The `__hash__` for `RBF` is bad:

```
sage: from sage.rings.real_arb import RBF
sage: hash(RBF(0.6))
1048577
sage: hash(RBF(0.7))
1048577
sage: hash(RBF(0.8))
1048577
sage: hash(RBF(0.9))
1048577
```


5. For `CBF.__hash__`, what's the point of `>> 7`?

6. This is a very strange way to handle exceptions, what's wrong with `raise`?

```
        if arf_get_mpfr(rad.value, tmp, GMP_RNDN):
            abort()
```


7. Replace the `GMP_RND` macros by `MPFR_RND`.

8. You can replace

```
cdef extern from "math.h":
    long lrint(double)
```

by `from libc.math cimport lrint` (although I would prefer to not use it in the hash).

9. What's with this comment?

```
                # FIXME: RBF is not even associative, but CompletionFunctor
                # only works with rings, and other coercion features require
                # methods like is_integral_domain() to be defined
                category=category or sage.categories.fields.Fields().Infinite())
```

Your class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?

10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.

21. You should really avoid this: `include "sage/ext/python.pxi"`, just `cimport` what you need.

32. What's the difference between `contains_exact` and `__contains__`? I don't understand why you need both these methods.

43. When raising exceptions, add a string: don't just `raise TypeError`, but `raise TypeError("useful message here")`

54. You write `.. SEEALSO:: :meth:`abs` but there is no such method.

65. I still don't understand why `below_abs` and `above_abs` return a ball instead of a real number. At the very least, this should be documentated in an `OUTPUT:` block in those methods.

76. This is confusing documentation: `Return the right endpoint of this ball, viewed as an interval.` I would read it like this method returns an interval. Why not `Return the right endpoint of this ball.`?

87. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`

98. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`



---

archive/issue_comments_259089.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> 1. The naming of the files is inconsistent: why `real_arb` and `complex_ball_acb`?\n`real_arb` followed the pattern of `real_mpfi`; whereas `complex_ball_acb` somehow followed `complex_interval`. What names would you suggest?",
    "created_at": "2015-11-08T14:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259089",
    "user": "cheuberg"
}
```

Replying to [comment:15 jdemeyer]:
> 1. The naming of the files is inconsistent: why `real_arb` and `complex_ball_acb`?
`real_arb` followed the pattern of `real_mpfi`; whereas `complex_ball_acb` somehow followed `complex_interval`. What names would you suggest?



---

archive/issue_comments_259090.json:
```json
{
    "body": "Hello Clemens,\n\nThanks again for your comments and the changes you made.\n\nReplying to [comment:12 cheuberg]:\n> I read the modifications and have the following comments.\n> 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.\n\nI fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?\n\n> 2. `polynomial_element.pyx`:\n> \t- I am very surprised to see this change here in an arb ticket.\n\nI tend to consider that what matters is commits, not tickets. So I don't have any problem with that as long as it doesn't make the review harder, and I actually feel if it makes reviews easier... But please tell me if you don't like that and I will try to create separate tickets in the future.\n\n> \t- The documentation of `is_gen` states: \"Important - this function doesn\u2019t return True if self equals the generator; it returns True if self is the generator.\" I.e., the outcome differs from the old behaviour.\n\nGood catch! I'd say it is okay, because the operation that really should be fast IMO is `x^n` where `x = Pol.gen()`, not `(2*x - x)^n`, and the new version seems to be about 10% faster when `n == 2`. But I'm open to suggestions.\n\n> 4. `RealBall.__hash__`: I do not like the fact that the fractional part of the midpoint is ignored completely:\n> {{{\n> sage: hash(RBF(3/4))\n> 1048577\n> sage: hash(RBF(5/8))\n> 1048577\n> sage: hash(RBF(7/8))\n> 1048577\n> }}}\n\nYes, I don't know what I was doing with that hash!\n\n> 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`\n\nThe problem here is that, unlike elements of `RealIntervalField(p)`, elements of `RealBallField(p)` may have endpoints that are not be representable on `p` bits. I wasn't sure what to do in this case, so I implemented a quick wrapper for the interval version and then forgot to come back to it. (This is also the reason for the clumsy formulation \u201cviewed as an interval\u201d Jeroen asks about.)\n\nThe main options I see are:\n- either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,\n- or return the exact endpoints, but then, the output parent will be hard to predict.\n\nWhich do you think is best?\n\n> 6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections\n\nWhat would you suggest to say there?\n\n> 7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.\n\nI'm not sure I understand your comment. As far as I understand (but all this stuff is very badly documented!), in the rest of Sage, `__nonzero__()` means \u201csyntactically nonzero\u201d (for example, the `degree()` methods of polynomials look for the leading `__nonzero__` term), which for balls is exactly the negation of `is_zero()`.\n\n> 8. `RealBall.__lshift__`, `RealBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `RealBall` if this is a method of `RealBall`?\n\nThat's how special methods work in Cython... See http://docs.cython.org/src/userguide/special_methods.html#arithmetic-methods\n\n> 9. `ComplexBall._is_atomic`: `self.is_real() or self.imag().is_zero()` seems to be redundant. Do you want to say `self.real().is_zero()` instead?\n\nI think so, yes, thanks! But actually I don't understand what `_is_atomic()` *really* should do: for example, the documentation seems to suggest that `-2` should not be atomic (since `x + -2` is not correct), while it is atomic in various standard rings, and I think it has to in order to avoid redundant parentheses...",
    "created_at": "2015-11-09T19:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259090",
    "user": "mmezzarobba"
}
```

Hello Clemens,

Thanks again for your comments and the changes you made.

Replying to [comment:12 cheuberg]:
> I read the modifications and have the following comments.
> 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.

I fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?

> 2. `polynomial_element.pyx`:
> 	- I am very surprised to see this change here in an arb ticket.

I tend to consider that what matters is commits, not tickets. So I don't have any problem with that as long as it doesn't make the review harder, and I actually feel if it makes reviews easier... But please tell me if you don't like that and I will try to create separate tickets in the future.

> 	- The documentation of `is_gen` states: "Important - this function doesn’t return True if self equals the generator; it returns True if self is the generator." I.e., the outcome differs from the old behaviour.

Good catch! I'd say it is okay, because the operation that really should be fast IMO is `x^n` where `x = Pol.gen()`, not `(2*x - x)^n`, and the new version seems to be about 10% faster when `n == 2`. But I'm open to suggestions.

> 4. `RealBall.__hash__`: I do not like the fact that the fractional part of the midpoint is ignored completely:
> {{{
> sage: hash(RBF(3/4))
> 1048577
> sage: hash(RBF(5/8))
> 1048577
> sage: hash(RBF(7/8))
> 1048577
> }}}

Yes, I don't know what I was doing with that hash!

> 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`

The problem here is that, unlike elements of `RealIntervalField(p)`, elements of `RealBallField(p)` may have endpoints that are not be representable on `p` bits. I wasn't sure what to do in this case, so I implemented a quick wrapper for the interval version and then forgot to come back to it. (This is also the reason for the clumsy formulation “viewed as an interval” Jeroen asks about.)

The main options I see are:
- either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,
- or return the exact endpoints, but then, the output parent will be hard to predict.

Which do you think is best?

> 6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections

What would you suggest to say there?

> 7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.

I'm not sure I understand your comment. As far as I understand (but all this stuff is very badly documented!), in the rest of Sage, `__nonzero__()` means “syntactically nonzero” (for example, the `degree()` methods of polynomials look for the leading `__nonzero__` term), which for balls is exactly the negation of `is_zero()`.

> 8. `RealBall.__lshift__`, `RealBall.__rshift__`: why is the first parameter called `val` instead of `self` and how can it happen that it is not a `RealBall` if this is a method of `RealBall`?

That's how special methods work in Cython... See http://docs.cython.org/src/userguide/special_methods.html#arithmetic-methods

> 9. `ComplexBall._is_atomic`: `self.is_real() or self.imag().is_zero()` seems to be redundant. Do you want to say `self.real().is_zero()` instead?

I think so, yes, thanks! But actually I don't understand what `_is_atomic()` *really* should do: for example, the documentation seems to suggest that `-2` should not be atomic (since `x + -2` is not correct), while it is atomic in various standard rings, and I think it has to in order to avoid redundant parentheses...



---

archive/issue_comments_259091.json:
```json
{
    "body": "Hello Jeroen,\n\nThank you very much for your remarks.\n\nReplying to [comment:15 jdemeyer]:\n> 2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.\n\nAre you sure? I get:\n\n```\n[2/2] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/marc/co/sage/local/include -I/home/marc/co/sage/local/include/python2.7 -I/home/marc/co/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/marc/co/sage/src -I/home/marc/co/sage/src/sage/ext -I/home/marc/co/sage/src/build/cythonized -I/home/marc/co/sage/src/build/cythonized/sage/ext -I/home/marc/co/sage/local/include/python2.7 -c /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c -o build/temp.linux-x86_64-2.7/home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.o -fno-strict-aliasing -w\nIn file included from /home/marc/co/sage/src/build/cythonized/sage/rings/complex_ball_acb.c:310:0:\n/home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory\ncompilation terminated.\nIn file included from /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c:309:0:\n/home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory\n```\n\n\n> 3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).\n\nA difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?\n\n> 4. The `__hash__` for `RBF` is bad:\n> {{{\n> sage: from sage.rings.real_arb import RBF\n> sage: hash(RBF(0.6))\n> 1048577\n> sage: hash(RBF(0.7))\n> 1048577\n> sage: hash(RBF(0.8))\n> 1048577\n> sage: hash(RBF(0.9))\n> 1048577\n> }}}\n\nFixed (see above).\n\n> 5. For `CBF.__hash__`, what's the point of `>> 7`?\n\nThe idea was just to avoid that the \u03bb(1+i) all hash to zero...\n\n> 6. This is a very strange way to handle exceptions, what's wrong with `raise`?\n> {{{\n>         if arf_get_mpfr(rad.value, tmp, GMP_RNDN):\n>             abort()\n> }}}\n\nI don't remember for sure. I guess I may have wanted to make sure that errors raised by `arf_get_mpfr()` itself and errors raised manually give the same exception, and to avoid repeating the error message.\n\n> 7. Replace the `GMP_RND` macros by `MPFR_RND`.\n\nDone.\n\n> 9. What's with this comment?\n> {{{\n>                 # FIXME: RBF is not even associative, but CompletionFunctor\n>                 # only works with rings, and other coercion features require\n>                 # methods like is_integral_domain() to be defined\n>                 category=category or sage.categories.fields.Fields().Infinite())\n> }}}\n> Your class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?\n\nWell, people seem to disagree about the meaning of categories in Sage, and some people apparently assume that a parent that belongs to the category of fields will satisfy the axioms of fields, not just vaguely model a field. This is particularly harmful in the context of interval arithmetic.\n\nIn the long term, I'd want to fix this by (i) clarifying the \u201cglobal conventions\u201d that need to be used consistently across the whole sage codebase and (ii) depending on the outcome, perhaps creating categories for \u201cinexact fields\u201d and the like.\n\n> 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.\n\nI'm no fan of adding anything to the global namespace, but I'll do it if you insist.\n\n> 11. You should really avoid this: `include \"sage/ext/python.pxi\"`, just `cimport` what you need.\n\nDone.\n\n> 12. What's the difference between `contains_exact` and `__contains__`? I don't understand why you need both these methods.\n\nThe difference is that `contains_exact()` works for fewer kinds of objects, but is guaranteed not to return false negatives, while `__contains__()` just does the check at the parent's precision. Of course, one could do with `__contains__()` alone, but then it would be too easy to call `x in b` by accident with an `x` for which it may not return the correct result.\n\n> 13. When raising exceptions, add a string: don't just `raise TypeError`, but `raise TypeError(\"useful message here\")`\n\nDone. (But I didn't include a message because I couldn't think of a useful message, so I doubt the new version is much better...)\n\n> 14. You write `.. SEEALSO:: :meth:`abs` but there is no such method.\n\nIndeed, I forgot to remove these references, thanks!\n\n> 15. I still don't understand why `below_abs` and `above_abs` return a ball instead of a real number. At the very least, this should be documentated in an `OUTPUT:` block in those methods.\n\nWhy: because I often compute upper or lower bounds on quantities represented by balls and then do arithmetic operations on the bounds that may result in rounding errors. Representing the bounds themselves as thin intervals is pretty convenient then. I also find that choice more consistent with the rest of the interface of real/complex balls...\n\nI added OUPUT blocks, please tell me if there is anything else you feel these blocks should say.\n\n> 16. This is confusing documentation: `Return the right endpoint of this ball, viewed as an interval.` I would read it like this method returns an interval. Why not `Return the right endpoint of this ball.`?\n\nIndeed! See my answer to Clemens above.\n\n> 17. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`\n\nThere are special functions in arb that are only implemented for complex arguments, but that would make sense on sage real balls.\n\n> 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`\n\nAn arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.",
    "created_at": "2015-11-09T21:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259091",
    "user": "mmezzarobba"
}
```

Hello Jeroen,

Thank you very much for your remarks.

Replying to [comment:15 jdemeyer]:
> 2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.

Are you sure? I get:

```
[2/2] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/marc/co/sage/local/include -I/home/marc/co/sage/local/include/python2.7 -I/home/marc/co/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/marc/co/sage/src -I/home/marc/co/sage/src/sage/ext -I/home/marc/co/sage/src/build/cythonized -I/home/marc/co/sage/src/build/cythonized/sage/ext -I/home/marc/co/sage/local/include/python2.7 -c /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c -o build/temp.linux-x86_64-2.7/home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.o -fno-strict-aliasing -w
In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/complex_ball_acb.c:310:0:
/home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory
compilation terminated.
In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c:309:0:
/home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory
```


> 3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).

A difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?

> 4. The `__hash__` for `RBF` is bad:
> {{{
> sage: from sage.rings.real_arb import RBF
> sage: hash(RBF(0.6))
> 1048577
> sage: hash(RBF(0.7))
> 1048577
> sage: hash(RBF(0.8))
> 1048577
> sage: hash(RBF(0.9))
> 1048577
> }}}

Fixed (see above).

> 5. For `CBF.__hash__`, what's the point of `>> 7`?

The idea was just to avoid that the λ(1+i) all hash to zero...

> 6. This is a very strange way to handle exceptions, what's wrong with `raise`?
> {{{
>         if arf_get_mpfr(rad.value, tmp, GMP_RNDN):
>             abort()
> }}}

I don't remember for sure. I guess I may have wanted to make sure that errors raised by `arf_get_mpfr()` itself and errors raised manually give the same exception, and to avoid repeating the error message.

> 7. Replace the `GMP_RND` macros by `MPFR_RND`.

Done.

> 9. What's with this comment?
> {{{
>                 # FIXME: RBF is not even associative, but CompletionFunctor
>                 # only works with rings, and other coercion features require
>                 # methods like is_integral_domain() to be defined
>                 category=category or sage.categories.fields.Fields().Infinite())
> }}}
> Your class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?

Well, people seem to disagree about the meaning of categories in Sage, and some people apparently assume that a parent that belongs to the category of fields will satisfy the axioms of fields, not just vaguely model a field. This is particularly harmful in the context of interval arithmetic.

In the long term, I'd want to fix this by (i) clarifying the “global conventions” that need to be used consistently across the whole sage codebase and (ii) depending on the outcome, perhaps creating categories for “inexact fields” and the like.

> 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.

I'm no fan of adding anything to the global namespace, but I'll do it if you insist.

> 11. You should really avoid this: `include "sage/ext/python.pxi"`, just `cimport` what you need.

Done.

> 12. What's the difference between `contains_exact` and `__contains__`? I don't understand why you need both these methods.

The difference is that `contains_exact()` works for fewer kinds of objects, but is guaranteed not to return false negatives, while `__contains__()` just does the check at the parent's precision. Of course, one could do with `__contains__()` alone, but then it would be too easy to call `x in b` by accident with an `x` for which it may not return the correct result.

> 13. When raising exceptions, add a string: don't just `raise TypeError`, but `raise TypeError("useful message here")`

Done. (But I didn't include a message because I couldn't think of a useful message, so I doubt the new version is much better...)

> 14. You write `.. SEEALSO:: :meth:`abs` but there is no such method.

Indeed, I forgot to remove these references, thanks!

> 15. I still don't understand why `below_abs` and `above_abs` return a ball instead of a real number. At the very least, this should be documentated in an `OUTPUT:` block in those methods.

Why: because I often compute upper or lower bounds on quantities represented by balls and then do arithmetic operations on the bounds that may result in rounding errors. Representing the bounds themselves as thin intervals is pretty convenient then. I also find that choice more consistent with the rest of the interface of real/complex balls...

I added OUPUT blocks, please tell me if there is anything else you feel these blocks should say.

> 16. This is confusing documentation: `Return the right endpoint of this ball, viewed as an interval.` I would read it like this method returns an interval. Why not `Return the right endpoint of this ball.`?

Indeed! See my answer to Clemens above.

> 17. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`

There are special functions in arb that are only implemented for complex arguments, but that would make sense on sage real balls.

> 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`

An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.



---

archive/issue_comments_259092.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-11-09T21:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259092",
    "user": "mmezzarobba"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_259093.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-11-09T21:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259093",
    "user": "mmezzarobba"
}
```

New commits:



---

archive/issue_comments_259094.json:
```json
{
    "body": "Replying to [comment:16 cheuberg]:\n> `real_arb` followed the pattern of `real_mpfi`; whereas `complex_ball_acb` somehow followed `complex_interval`. \nI also find these names confusing, so I don't think it's a model to follow.\n\n> What names would you suggest?\nWhy not simply `real_arb` and `complex_arb`? At least something more consistent.",
    "created_at": "2015-11-09T22:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259094",
    "user": "jdemeyer"
}
```

Replying to [comment:16 cheuberg]:
> `real_arb` followed the pattern of `real_mpfi`; whereas `complex_ball_acb` somehow followed `complex_interval`. 
I also find these names confusing, so I don't think it's a model to follow.

> What names would you suggest?
Why not simply `real_arb` and `complex_arb`? At least something more consistent.



---

archive/issue_comments_259095.json:
```json
{
    "body": "Replying to [comment:17 mmezzarobba]:\n> Replying to [comment:12 cheuberg]:\n> > 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.\n> \n> I fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?\nI agree, there is no issue here. Cython doesn't care about the values.\n\n> > 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`\n> The main options I see are:\n> - either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,\nI would go for: rounding endpoints in the obvious direction (i.e. up for the upper endpoint and down for the lower endpoint)",
    "created_at": "2015-11-09T22:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259095",
    "user": "jdemeyer"
}
```

Replying to [comment:17 mmezzarobba]:
> Replying to [comment:12 cheuberg]:
> > 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.
> 
> I fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?
I agree, there is no issue here. Cython doesn't care about the values.

> > 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`
> The main options I see are:
> - either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,
I would go for: rounding endpoints in the obvious direction (i.e. up for the upper endpoint and down for the lower endpoint)



---

archive/issue_comments_259096.json:
```json
{
    "body": "Replying to [comment:18 mmezzarobba]:\n> Replying to [comment:15 jdemeyer]:\n> > 2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.\n> \n> Are you sure? I get:\n> {{{\n> [2/2] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/marc/co/sage/local/include -I/home/marc/co/sage/local/include/python2.7 -I/home/marc/co/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/marc/co/sage/src -I/home/marc/co/sage/src/sage/ext -I/home/marc/co/sage/src/build/cythonized -I/home/marc/co/sage/src/build/cythonized/sage/ext -I/home/marc/co/sage/local/include/python2.7 -c /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c -o build/temp.linux-x86_64-2.7/home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.o -fno-strict-aliasing -w\n> In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/complex_ball_acb.c:310:0:\n> /home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory\n> compilation terminated.\n> In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c:309:0:\n> /home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory\n> }}}\n\nI must admit I didn't test it, but it seems the problem comes from `arb` (not the Sage library). I'll look into it later.\n\n> > 3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).\n> \n> A difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?\nYes, put the type declarations all in `types.pxd`.\n\n> > 5. For `CBF.__hash__`, what's the point of `>> 7`?\n> \n> The idea was just to avoid that the \u03bb(1+i) all hash to zero...\n??? I don't get it.\n\n> > 6. This is a very strange way to handle exceptions, what's wrong with `raise`?\n> > {{{\n> >         if arf_get_mpfr(rad.value, tmp, GMP_RNDN):\n> >             abort()\n> > }}}\n> \n> I don't remember for sure. I guess I may have wanted to make sure that errors raised by `arf_get_mpfr()` itself and errors raised manually give the same exception, and to avoid repeating the error message.\nYou can use `sig_error()` for that, it just calls `abort()` but it's more explicit.\n\n> > 9. What's with this comment?\n> > {{{\n> >                 # FIXME: RBF is not even associative, but CompletionFunctor\n> >                 # only works with rings, and other coercion features require\n> >                 # methods like is_integral_domain() to be defined\n> >                 category=category or sage.categories.fields.Fields().Infinite())\n> > }}}\n> > Your class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?\n> \n> Well, people seem to disagree about the meaning of categories in Sage, and some people apparently assume that a parent that belongs to the category of fields will satisfy the axioms of fields, not just vaguely model a field. This is particularly harmful in the context of interval arithmetic.\n> \n> In the long term, I'd want to fix this by (i) clarifying the \u201cglobal conventions\u201d that need to be used consistently across the whole sage codebase and (ii) depending on the outcome, perhaps creating categories for \u201cinexact fields\u201d and the like.\nBut that's not at all specific to `arb` right, so I'm just confused by this comment. I propose to remove it.\n\n> > 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.\n> \n> I'm no fan of adding anything to the global namespace, but I'll do it if you insist.\nWhy not?\n\n> > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`\n> \n> An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.\nNow I'm even more confused... I still have no clue what you mean.",
    "created_at": "2015-11-09T23:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259096",
    "user": "jdemeyer"
}
```

Replying to [comment:18 mmezzarobba]:
> Replying to [comment:15 jdemeyer]:
> > 2. You can remove the `include_dirs=[SAGE_INC + '/flint'])` from `src/module_list.py`.
> 
> Are you sure? I get:
> {{{
> [2/2] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/marc/co/sage/local/include -I/home/marc/co/sage/local/include/python2.7 -I/home/marc/co/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/marc/co/sage/src -I/home/marc/co/sage/src/sage/ext -I/home/marc/co/sage/src/build/cythonized -I/home/marc/co/sage/src/build/cythonized/sage/ext -I/home/marc/co/sage/local/include/python2.7 -c /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c -o build/temp.linux-x86_64-2.7/home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.o -fno-strict-aliasing -w
> In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/complex_ball_acb.c:310:0:
> /home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory
> compilation terminated.
> In file included from /home/marc/co/sage/src/build/cythonized/sage/rings/real_arb.c:309:0:
> /home/marc/co/sage/local/include/mag.h:36:19: fatal error: flint.h: No such file or directory
> }}}

I must admit I didn't test it, but it seems the problem comes from `arb` (not the Sage library). I'll look into it later.

> > 3. Ideally, the type declarations in the arb `.pxd` files should be in a different file: try to follow the model of `src/sage/libs/gmp` for example. Then you should add `# distutils: libraries = arb` to the files with library functions (i.e. not types).
> 
> A difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?
Yes, put the type declarations all in `types.pxd`.

> > 5. For `CBF.__hash__`, what's the point of `>> 7`?
> 
> The idea was just to avoid that the λ(1+i) all hash to zero...
??? I don't get it.

> > 6. This is a very strange way to handle exceptions, what's wrong with `raise`?
> > {{{
> >         if arf_get_mpfr(rad.value, tmp, GMP_RNDN):
> >             abort()
> > }}}
> 
> I don't remember for sure. I guess I may have wanted to make sure that errors raised by `arf_get_mpfr()` itself and errors raised manually give the same exception, and to avoid repeating the error message.
You can use `sig_error()` for that, it just calls `abort()` but it's more explicit.

> > 9. What's with this comment?
> > {{{
> >                 # FIXME: RBF is not even associative, but CompletionFunctor
> >                 # only works with rings, and other coercion features require
> >                 # methods like is_integral_domain() to be defined
> >                 category=category or sage.categories.fields.Fields().Infinite())
> > }}}
> > Your class models a mathematical field (real or complex numbers), so I don't see the problem. How would you want to fix this?
> 
> Well, people seem to disagree about the meaning of categories in Sage, and some people apparently assume that a parent that belongs to the category of fields will satisfy the axioms of fields, not just vaguely model a field. This is particularly harmful in the context of interval arithmetic.
> 
> In the long term, I'd want to fix this by (i) clarifying the “global conventions” that need to be used consistently across the whole sage codebase and (ii) depending on the outcome, perhaps creating categories for “inexact fields” and the like.
But that's not at all specific to `arb` right, so I'm just confused by this comment. I propose to remove it.

> > 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.
> 
> I'm no fan of adding anything to the global namespace, but I'll do it if you insist.
Why not?

> > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`
> 
> An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.
Now I'm even more confused... I still have no clue what you mean.



---

archive/issue_comments_259097.json:
```json
{
    "body": "Replying to [comment:18 mmezzarobba]:\n> > 17. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`\n> \n> There are special functions in arb that are only implemented for complex arguments, but that would make sense on sage real balls.\n> \n> > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`\n> \n> An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.\n\nWhen asking these questions above, I'm not just asking for myself personally. It means that the code on the branch should be clarified.",
    "created_at": "2015-11-09T23:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259097",
    "user": "jdemeyer"
}
```

Replying to [comment:18 mmezzarobba]:
> > 17. I don't understand the purpose of this comment: `# TODO: once CBF is there, also wrap functions that only exist in acb*`
> 
> There are special functions in arb that are only implemented for complex arguments, but that would make sense on sage real balls.
> 
> > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`
> 
> An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.

When asking these questions above, I'm not just asking for myself personally. It means that the code on the branch should be clarified.



---

archive/issue_comments_259098.json:
```json
{
    "body": "I consider the fact that `include_dirs` is needed an upstream `arb` bug. So you can leave it for now. See #19563.",
    "created_at": "2015-11-10T00:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259098",
    "user": "jdemeyer"
}
```

I consider the fact that `include_dirs` is needed an upstream `arb` bug. So you can leave it for now. See #19563.



---

archive/issue_comments_259099.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> Why not simply `real_arb` and `complex_arb`? At least something more consistent.\n\nI agree, I already considered making that change several times. Actually, at some point, I'd like to reorganize the code of variants of real and complex numbers in order to make them more consistent with each other and reduce code duplication a little, and I think it would make sense to move them all to a new package `sage.rings.numerical` (or similar) then.",
    "created_at": "2015-11-10T07:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259099",
    "user": "mmezzarobba"
}
```

Replying to [comment:20 jdemeyer]:
> Why not simply `real_arb` and `complex_arb`? At least something more consistent.

I agree, I already considered making that change several times. Actually, at some point, I'd like to reorganize the code of variants of real and complex numbers in order to make them more consistent with each other and reduce code duplication a little, and I think it would make sense to move them all to a new package `sage.rings.numerical` (or similar) then.



---

archive/issue_comments_259100.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> I would go for: rounding endpoints in the obvious direction (i.e. up for the upper endpoint and down for the lower endpoint)\n\nFine with me. The `rnd` argument will be a bit confusing, but I don't think that's too bad.",
    "created_at": "2015-11-10T07:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259100",
    "user": "mmezzarobba"
}
```

Replying to [comment:21 jdemeyer]:
> I would go for: rounding endpoints in the obvious direction (i.e. up for the upper endpoint and down for the lower endpoint)

Fine with me. The `rnd` argument will be a bit confusing, but I don't think that's too bad.



---

archive/issue_comments_259101.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> > A difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?\n> Yes, put the type declarations all in `types.pxd`.\n\nDone.\n\n> > > 5. For `CBF.__hash__`, what's the point of `>> 7`?\n> > \n> > The idea was just to avoid that the \u03bb(1+i) all hash to zero...\n> ??? I don't get it.\n\nI'm sorry, I don't understand what you don't understand. (You are talking about `ComplexBall.__hash__()`, not `ComplexBallField.__hash__()`, right?)\n\n> You can use `sig_error()` for that, it just calls `abort()` but it's more explicit.\n\nChanged (though to me this is \u201cstrange sage-specific stuff\u201d vs \u201cstandard C/POSIX\u201d, so less explicit...)\n\n> But that's not at all specific to `arb` right, so I'm just confused by this comment. I propose to remove it.\n\nFine.\n\n> > > 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.\n> > \n> > I'm no fan of adding anything to the global namespace, but I'll do it if you insist.\n> Why not?\n\nBecause it doesn't make any sense to me to import tons of specialized stuff on startup. It is so much better to import the things you use in your personal `init.sage`... (And `sage -min`, which would mitigate the problem, hasn't worked for years afaik.)\n\n> > > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`\n> > \n> > An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.\n> Now I'm even more confused... I still have no clue what you mean.\n\nI added some documentation, please tell me if it is clear enough.",
    "created_at": "2015-11-10T10:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259101",
    "user": "mmezzarobba"
}
```

Replying to [comment:22 jdemeyer]:
> > A difference is that arb comes with several `.h` files (one for each module, with a more or less well-defined dependency graph): are you suggesting to put all the type definitions in a single `.pxd` file nevertheless?
> Yes, put the type declarations all in `types.pxd`.

Done.

> > > 5. For `CBF.__hash__`, what's the point of `>> 7`?
> > 
> > The idea was just to avoid that the λ(1+i) all hash to zero...
> ??? I don't get it.

I'm sorry, I don't understand what you don't understand. (You are talking about `ComplexBall.__hash__()`, not `ComplexBallField.__hash__()`, right?)

> You can use `sig_error()` for that, it just calls `abort()` but it's more explicit.

Changed (though to me this is “strange sage-specific stuff” vs “standard C/POSIX”, so less explicit...)

> But that's not at all specific to `arb` right, so I'm just confused by this comment. I propose to remove it.

Fine.

> > > 10. Now that all this is standard, can you add `RBF`, `RealBallField`, `CBF` and `ComplexBallField` to the global namespace and then remove all doctest lines of the form `from sage.rings.real_arb import RBF`.
> > 
> > I'm no fan of adding anything to the global namespace, but I'll do it if you insist.
> Why not?

Because it doesn't make any sense to me to import tons of specialized stuff on startup. It is so much better to import the things you use in your personal `init.sage`... (And `sage -min`, which would mitigate the problem, hasn't worked for years afaik.)

> > > 18. I don't understand what this means: `Return a copy of this ball rounded to the precision of the parent.`
> > 
> > An arb ball has no intrinsic precision, and (more or less because of that), an element of `RealBallField(p)` can have a midpoint that doesn't fit on `p` bits. The `round()` method rounds such elements to the precision of their parent.
> Now I'm even more confused... I still have no clue what you mean.

I added some documentation, please tell me if it is clear enough.



---

archive/issue_comments_259102.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-11-10T10:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259102",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_259103.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-10T10:11:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259103",
    "user": "mmezzarobba"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_259104.json:
```json
{
    "body": "Replying to [comment:27 mmezzarobba]:\n> Because it doesn't make any sense to me to import tons of specialized stuff on startup.\nWe have `lazy_import` for that.",
    "created_at": "2015-11-10T16:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259104",
    "user": "jdemeyer"
}
```

Replying to [comment:27 mmezzarobba]:
> Because it doesn't make any sense to me to import tons of specialized stuff on startup.
We have `lazy_import` for that.



---

archive/issue_comments_259105.json:
```json
{
    "body": "Replying to [comment:27 mmezzarobba]:\n> I'm sorry, I don't understand what you don't understand. (You are talking about `ComplexBall.__hash__()`, not `ComplexBallField.__hash__()`, right?)\n\nI now understand what you mean. I would prefer something like\n\n```\nhash(real_part) + 3*hash(complex_part)\n```\n\nthen. By doing `>> 7`, you're throwing away 7 bits for no reason.",
    "created_at": "2015-11-10T16:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259105",
    "user": "jdemeyer"
}
```

Replying to [comment:27 mmezzarobba]:
> I'm sorry, I don't understand what you don't understand. (You are talking about `ComplexBall.__hash__()`, not `ComplexBallField.__hash__()`, right?)

I now understand what you mean. I would prefer something like

```
hash(real_part) + 3*hash(complex_part)
```

then. By doing `>> 7`, you're throwing away 7 bits for no reason.



---

archive/issue_comments_259106.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:27 mmezzarobba]:\n> > Because it doesn't make any sense to me to import tons of specialized stuff on startup.\n> We have `lazy_import` for that.\n\nI'm not talking only about the cost of the imports, but mainly about the namespace pollution.",
    "created_at": "2015-11-10T17:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259106",
    "user": "mmezzarobba"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:27 mmezzarobba]:
> > Because it doesn't make any sense to me to import tons of specialized stuff on startup.
> We have `lazy_import` for that.

I'm not talking only about the cost of the imports, but mainly about the namespace pollution.



---

archive/issue_comments_259107.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-10T17:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259107",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259108.json:
```json
{
    "body": "In `__hash__`, you are still throwing away 1.58 bits, but it's an improvement :-)\n\n> The `rnd` argument will be a bit confusing, but I don't think that's too bad.\nI don't mind deprecating the `rnd` argument, I don't think it's useful anyway.",
    "created_at": "2015-11-10T18:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259108",
    "user": "jdemeyer"
}
```

In `__hash__`, you are still throwing away 1.58 bits, but it's an improvement :-)

> The `rnd` argument will be a bit confusing, but I don't think that's too bad.
I don't mind deprecating the `rnd` argument, I don't think it's useful anyway.



---

archive/issue_comments_259109.json:
```json
{
    "body": "I was reading the `real_arb` documentation and this caught my eye:\n\n> Warning\n>\n> Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t\u2208x} and not the (generally larger) set {tu:t\u2208x,u\u2208x}.\n\nI'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.",
    "created_at": "2015-11-10T19:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259109",
    "user": "jdemeyer"
}
```

I was reading the `real_arb` documentation and this caught my eye:

> Warning
>
> Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t∈x} and not the (generally larger) set {tu:t∈x,u∈x}.

I'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.



---

archive/issue_comments_259110.json:
```json
{
    "body": "I consider this a bug:\n> It is possible to construct a ball whose parent is the real ball field with precision p but whose midpoint does not fit on p bits. However, the results of operations involving such a ball will (usually) be rounded to its parent\u2019s precision.\n\nIt causes too much confusion for example with the `round()` function. It's also too different from all other places in Sage which handle precision.",
    "created_at": "2015-11-10T19:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259110",
    "user": "jdemeyer"
}
```

I consider this a bug:
> It is possible to construct a ball whose parent is the real ball field with precision p but whose midpoint does not fit on p bits. However, the results of operations involving such a ball will (usually) be rounded to its parent’s precision.

It causes too much confusion for example with the `round()` function. It's also too different from all other places in Sage which handle precision.



---

archive/issue_comments_259111.json:
```json
{
    "body": "This is a good reason to round when creating a ball:\n\n```\nsage: a = RealBallField(20)(1.3)\nsage: b = RealBallField(53)(1.3)\nsage: a == b\nTrue\nsage: a+0 == b+0\nFalse\n```\n",
    "created_at": "2015-11-10T19:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259111",
    "user": "jdemeyer"
}
```

This is a good reason to round when creating a ball:

```
sage: a = RealBallField(20)(1.3)
sage: b = RealBallField(53)(1.3)
sage: a == b
True
sage: a+0 == b+0
False
```




---

archive/issue_comments_259112.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-10T19:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259112",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_259113.json:
```json
{
    "body": "Despite what the documentation says, we still have\n\n```\nsage: a = RealBallField(53)(RIF(-1,1))\nsage: (a*(a+0)).identical(a^2)\nTrue\n```\n",
    "created_at": "2015-11-10T19:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259113",
    "user": "jdemeyer"
}
```

Despite what the documentation says, we still have

```
sage: a = RealBallField(53)(RIF(-1,1))
sage: (a*(a+0)).identical(a^2)
True
```




---

archive/issue_comments_259114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-10T20:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259114",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259115.json:
```json
{
    "body": "Replying to [comment:35 jdemeyer]:\n> > Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t\u2208x} and not the (generally larger) set {tu:t\u2208x,u\u2208x}.\n> \n> I'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.\n\nReplying to [comment:36 jdemeyer]:\n> I consider this a bug:\n> > It is possible to construct a ball whose parent is the real ball field with precision p but whose midpoint does not fit on p bits. However, the results of operations involving such a ball will (usually) be rounded to its parent\u2019s precision.\n> \n> It causes too much confusion for example with the `round()` function. It's also too different from all other places in Sage which handle precision.\n\nBoth these design choices were discussed on previous arb-related tickets, in particular #17194. As far as I'm concerend, I'm happy with the way things currently work (even though I was a little bit skeptical at first), and I'm not interested in working on changing it. Incidentally, I'm not sure this ticket would be the right place.",
    "created_at": "2015-11-10T20:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259115",
    "user": "mmezzarobba"
}
```

Replying to [comment:35 jdemeyer]:
> > Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t∈x} and not the (generally larger) set {tu:t∈x,u∈x}.
> 
> I'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.

Replying to [comment:36 jdemeyer]:
> I consider this a bug:
> > It is possible to construct a ball whose parent is the real ball field with precision p but whose midpoint does not fit on p bits. However, the results of operations involving such a ball will (usually) be rounded to its parent’s precision.
> 
> It causes too much confusion for example with the `round()` function. It's also too different from all other places in Sage which handle precision.

Both these design choices were discussed on previous arb-related tickets, in particular #17194. As far as I'm concerend, I'm happy with the way things currently work (even though I was a little bit skeptical at first), and I'm not interested in working on changing it. Incidentally, I'm not sure this ticket would be the right place.



---

archive/issue_comments_259116.json:
```json
{
    "body": "Even though I don't agree with everything in this branch, I'm willing to give it positive_review.",
    "created_at": "2015-11-10T21:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259116",
    "user": "jdemeyer"
}
```

Even though I don't agree with everything in this branch, I'm willing to give it positive_review.



---

archive/issue_comments_259117.json:
```json
{
    "body": "Follow-ups: #19563 and #19568.",
    "created_at": "2015-11-11T06:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259117",
    "user": "jdemeyer"
}
```

Follow-ups: #19563 and #19568.



---

archive/issue_comments_259118.json:
```json
{
    "body": "Replying to [comment:40 mmezzarobba]:\n> Replying to [comment:35 jdemeyer]:\n> > > Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t\u2208x} and not the (generally larger) set {tu:t\u2208x,u\u2208x}.\n> > \n> > I'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.\n> Both these design choices were discussed on previous arb-related tickets, in particular #17194. As far as I'm concerend, I'm happy with the way things currently work (even though I was a little bit skeptical at first), and I'm not interested in working on changing it. Incidentally, I'm not sure this ticket would be the right place.\n\nIn particular, the first issue is a property of arb, see its documentation. Therefore, working around that might have involved that we make copies ourselves.\n\nWhat is now the status of this ticket? Is it still `needs_work`, in particular after Jeroens remark earlier today?",
    "created_at": "2015-11-11T10:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259118",
    "user": "cheuberg"
}
```

Replying to [comment:40 mmezzarobba]:
> Replying to [comment:35 jdemeyer]:
> > > Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance. For example, setting z = x*x sets z to a ball enclosing the set {t2:t∈x} and not the (generally larger) set {tu:t∈x,u∈x}.
> > 
> > I'm not sure that we should do that. It's not what intervals do: I would expect `x*x` to be different from `x^2`.
> Both these design choices were discussed on previous arb-related tickets, in particular #17194. As far as I'm concerend, I'm happy with the way things currently work (even though I was a little bit skeptical at first), and I'm not interested in working on changing it. Incidentally, I'm not sure this ticket would be the right place.

In particular, the first issue is a property of arb, see its documentation. Therefore, working around that might have involved that we make copies ourselves.

What is now the status of this ticket? Is it still `needs_work`, in particular after Jeroens remark earlier today?



---

archive/issue_comments_259119.json:
```json
{
    "body": "Replying to [comment:43 cheuberg]:\n> In particular, the first issue is a property of arb, see its documentation.\nIf that is the case, this absolutely should be mentioned in the Sage documentation for arb.",
    "created_at": "2015-11-11T16:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259119",
    "user": "jdemeyer"
}
```

Replying to [comment:43 cheuberg]:
> In particular, the first issue is a property of arb, see its documentation.
If that is the case, this absolutely should be mentioned in the Sage documentation for arb.



---

archive/issue_comments_259120.json:
```json
{
    "body": "I really would prefer to have a positive_review to this ticket together with a positive_review for #19568. Can somebody please (re)consider reviewing #19568?",
    "created_at": "2015-11-11T17:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259120",
    "user": "jdemeyer"
}
```

I really would prefer to have a positive_review to this ticket together with a positive_review for #19568. Can somebody please (re)consider reviewing #19568?



---

archive/issue_comments_259121.json:
```json
{
    "body": "Replying to [comment:44 jdemeyer]:\n> Replying to [comment:43 cheuberg]:\n> > In particular, the first issue is a property of arb, see its documentation.\n> If that is the case, this absolutely should be mentioned in the Sage documentation for arb.\n\nI do not understand what you mean.\n\n[Arb's documentation](http://fredrikj.net/arb/issues.html#aliasing) says that \"An important caveat applies to aliasing of input variables. Identical pointers are understood to give permission for algebraic simplification.\"\n\nThe [documentation of the real_arb class](https://www.math.aau.at/user/cheuberg/sage/doc/6.10.beta3/en/reference/rings_numerical/sage/rings/real_arb.html#comparison) has a \"Warning\" box stating  \"Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance.\"",
    "created_at": "2015-11-12T14:47:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259121",
    "user": "cheuberg"
}
```

Replying to [comment:44 jdemeyer]:
> Replying to [comment:43 cheuberg]:
> > In particular, the first issue is a property of arb, see its documentation.
> If that is the case, this absolutely should be mentioned in the Sage documentation for arb.

I do not understand what you mean.

[Arb's documentation](http://fredrikj.net/arb/issues.html#aliasing) says that "An important caveat applies to aliasing of input variables. Identical pointers are understood to give permission for algebraic simplification."

The [documentation of the real_arb class](https://www.math.aau.at/user/cheuberg/sage/doc/6.10.beta3/en/reference/rings_numerical/sage/rings/real_arb.html#comparison) has a "Warning" box stating  "Identical RealBall objects are understood to give permission for algebraic simplification. This assumption is made to improve performance."



---

archive/issue_comments_259122.json:
```json
{
    "body": "I meant that the documentation should state this is done by the `arb` library, not the Sage interface to `arb`.",
    "created_at": "2015-11-12T16:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259122",
    "user": "jdemeyer"
}
```

I meant that the documentation should state this is done by the `arb` library, not the Sage interface to `arb`.



---

archive/issue_comments_259123.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-12T16:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259123",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259124.json:
```json
{
    "body": "Replying to [comment:17 mmezzarobba]:\n> Replying to [comment:12 cheuberg]:\n> > 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.\n> \n> I fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?\n\nok. Forget it.\n\n> \n> > 2. `polynomial_element.pyx`:\n> > \t- I am very surprised to see this change here in an arb ticket.\n> \n> I tend to consider that what matters is commits, not tickets. So I don't have any problem with that as long as it doesn't make the review harder, and I actually feel if it makes reviews easier... But please tell me if you don't like that and I will try to create separate tickets in the future.\n\nIt makes reviewing harder as I do not really want to interfere with the polynomials guys ...\n\n> \n> > \t- The documentation of `is_gen` states: \"Important - this function doesn\u2019t return True if self equals the generator; it returns True if self is the generator.\" I.e., the outcome differs from the old behaviour.\n> \n> Good catch! I'd say it is okay, because the operation that really should be fast IMO is `x^n` where `x = Pol.gen()`, not `(2*x - x)^n`, and the new version seems to be about 10% faster when `n == 2`. But I'm open to suggestions.\n\nWell, I would have preferred to have somebody else to decide about that; \n\n> > 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`\n> \n> The problem here is that, unlike elements of `RealIntervalField(p)`, elements of `RealBallField(p)` may have endpoints that are not be representable on `p` bits. I wasn't sure what to do in this case, so I implemented a quick wrapper for the interval version and then forgot to come back to it. (This is also the reason for the clumsy formulation \u201cviewed as an interval\u201d Jeroen asks about.)\n> \n> The main options I see are:\n> - either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,\n> - or return the exact endpoints, but then, the output parent will be hard to predict.\n> \n> Which do you think is best?\n\ncurrent behaviour is fine for me.\n\n> \n> > 6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections\n> \n> What would you suggest to say there?\n\nI'd like to know what `ampl` shall be (any rational number? ball?) and that I'd prefer to state that \nOUTPUT:\n\nA complex ball.\n\n(the description seems to be worded as an inline operation, but it actually returns a new ball).\n\n> \n> > 7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.\n> \n> I'm not sure I understand your comment. As far as I understand (but all this stuff is very badly documented!), in the rest of Sage, `__nonzero__()` means \u201csyntactically nonzero\u201d (for example, the `degree()` methods of polynomials look for the leading `__nonzero__` term), which for balls is exactly the negation of `is_zero()`.\n\nI'd prefer something which separates the two messages of the one sentence, e.g. \"Use `__nonzero__()` to check that a ball is not exactly the zero ball (for instance, to determine the \u201cdegree\u201d of a polynomial with ball coefficients). In fact, `__nonzero__()` is the negation of `is_zero()`, whereas `is_nonzero()` only returns `True` if `0` is known not to be in the ball.\"\n\n\nFurther remark:\n\n19. The AUTHORS section at the beginning of the files is not accurate: I started those files, but most of their contents has been written by you. So please either add your name or remove mine.",
    "created_at": "2015-11-12T17:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259124",
    "user": "cheuberg"
}
```

Replying to [comment:17 mmezzarobba]:
> Replying to [comment:12 cheuberg]:
> > 1. `arf.pxd`: You define `arf_rnd_t` as an enum and rely on the fact that the numeric values of `ARF_RND_DOWN` etc. will never change in the C header files. However, there, the values are macros, so I do not know whether we can safely assume the values never to change.
> 
> I fear I don't understand what you mean here, sorry. I thought that cython would insert textual references to `ARF_RND_*` in the generated C code. Isn't that the case?

ok. Forget it.

> 
> > 2. `polynomial_element.pyx`:
> > 	- I am very surprised to see this change here in an arb ticket.
> 
> I tend to consider that what matters is commits, not tickets. So I don't have any problem with that as long as it doesn't make the review harder, and I actually feel if it makes reviews easier... But please tell me if you don't like that and I will try to create separate tickets in the future.

It makes reviewing harder as I do not really want to interfere with the polynomials guys ...

> 
> > 	- The documentation of `is_gen` states: "Important - this function doesn’t return True if self equals the generator; it returns True if self is the generator." I.e., the outcome differs from the old behaviour.
> 
> Good catch! I'd say it is okay, because the operation that really should be fast IMO is `x^n` where `x = Pol.gen()`, not `(2*x - x)^n`, and the new version seems to be about 10% faster when `n == 2`. But I'm open to suggestions.

Well, I would have preferred to have somebody else to decide about that; 

> > 5. `RealBall.upper`, `RealBall.lower`, `RealBall.endpoints`: missing INPUT: and OUTPUT: sections, document and test parameter `rnd`
> 
> The problem here is that, unlike elements of `RealIntervalField(p)`, elements of `RealBallField(p)` may have endpoints that are not be representable on `p` bits. I wasn't sure what to do in this case, so I implemented a quick wrapper for the interval version and then forgot to come back to it. (This is also the reason for the clumsy formulation “viewed as an interval” Jeroen asks about.)
> 
> The main options I see are:
> - either to return the endpoints rounded (in which direction? we can't be 100% compatible with interval fields!) to the parent's precision,
> - or return the exact endpoints, but then, the output parent will be hard to predict.
> 
> Which do you think is best?

current behaviour is fine for me.

> 
> > 6. `RealBall.add_error`: missing INPUT: and OUTPUT: sections
> 
> What would you suggest to say there?

I'd like to know what `ampl` shall be (any rational number? ball?) and that I'd prefer to state that 
OUTPUT:

A complex ball.

(the description seems to be worded as an inline operation, but it actually returns a new ball).

> 
> > 7. `RealBall.is_nonzero`: The note section is hard to understand because `__nonzero__` and `is_zero` should do very different things.
> 
> I'm not sure I understand your comment. As far as I understand (but all this stuff is very badly documented!), in the rest of Sage, `__nonzero__()` means “syntactically nonzero” (for example, the `degree()` methods of polynomials look for the leading `__nonzero__` term), which for balls is exactly the negation of `is_zero()`.

I'd prefer something which separates the two messages of the one sentence, e.g. "Use `__nonzero__()` to check that a ball is not exactly the zero ball (for instance, to determine the “degree” of a polynomial with ball coefficients). In fact, `__nonzero__()` is the negation of `is_zero()`, whereas `is_nonzero()` only returns `True` if `0` is known not to be in the ball."


Further remark:

19. The AUTHORS section at the beginning of the files is not accurate: I started those files, but most of their contents has been written by you. So please either add your name or remove mine.



---

archive/issue_comments_259125.json:
```json
{
    "body": "Replying to [comment:32 mmezzarobba]:\n> Replying to [comment:30 jdemeyer]:\n> > Replying to [comment:27 mmezzarobba]:\n> > > Because it doesn't make any sense to me to import tons of specialized stuff on startup.\n> > We have `lazy_import` for that.\n> \n> I'm not talking only about the cost of the imports, but mainly about the namespace pollution.\n\nI would not mind having `RBF`, `CBF`, `RealBallField` and `ComplexBallField` in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...",
    "created_at": "2015-11-12T17:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259125",
    "user": "cheuberg"
}
```

Replying to [comment:32 mmezzarobba]:
> Replying to [comment:30 jdemeyer]:
> > Replying to [comment:27 mmezzarobba]:
> > > Because it doesn't make any sense to me to import tons of specialized stuff on startup.
> > We have `lazy_import` for that.
> 
> I'm not talking only about the cost of the imports, but mainly about the namespace pollution.

I would not mind having `RBF`, `CBF`, `RealBallField` and `ComplexBallField` in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...



---

archive/issue_comments_259126.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-13T13:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259126",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259127.json:
```json
{
    "body": "Replying to [comment:49 cheuberg]:\n> It makes reviewing harder as I do not really want to interfere with the polynomials guys ...\n\nOk, sorry, I'll try to avoid doing that in tickets you are likely to review.\n\n> I'd like to know what `ampl` shall be (any rational number? ball?) and that I'd prefer to state that \n> OUTPUT:\n> \n> A complex ball.\n> \n> (the description seems to be worded as an inline operation, but it actually returns a new ball).\n\nDone.\n\n> I'd prefer something which separates the two messages of the one sentence, e.g. \"Use `__nonzero__()` to check that a ball is not exactly the zero ball (for instance, to determine the \u201cdegree\u201d of a polynomial with ball coefficients). In fact, `__nonzero__()` is the negation of `is_zero()`, whereas `is_nonzero()` only returns `True` if `0` is known not to be in the ball.\"\n\nDone.\n\n> Further remark:\n> \n> 19. The AUTHORS section at the beginning of the files is not accurate: I started those files, but most of their contents has been written by you. So please either add your name or remove mine.\n\nI'll be consistent with what I said on sage-devel a few weeks ago and simply remove the AUTHORS block :-). But of course please feel free to add us both back if you prefer.\n\nReplying to [comment:50 cheuberg]:\n> I would not mind having RBF, CBF, RealBallField and ComplexBallField in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...\n\nDone \u2014 I still don't like that very much, but since everyone seems to agree...",
    "created_at": "2015-11-13T13:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259127",
    "user": "mmezzarobba"
}
```

Replying to [comment:49 cheuberg]:
> It makes reviewing harder as I do not really want to interfere with the polynomials guys ...

Ok, sorry, I'll try to avoid doing that in tickets you are likely to review.

> I'd like to know what `ampl` shall be (any rational number? ball?) and that I'd prefer to state that 
> OUTPUT:
> 
> A complex ball.
> 
> (the description seems to be worded as an inline operation, but it actually returns a new ball).

Done.

> I'd prefer something which separates the two messages of the one sentence, e.g. "Use `__nonzero__()` to check that a ball is not exactly the zero ball (for instance, to determine the “degree” of a polynomial with ball coefficients). In fact, `__nonzero__()` is the negation of `is_zero()`, whereas `is_nonzero()` only returns `True` if `0` is known not to be in the ball."

Done.

> Further remark:
> 
> 19. The AUTHORS section at the beginning of the files is not accurate: I started those files, but most of their contents has been written by you. So please either add your name or remove mine.

I'll be consistent with what I said on sage-devel a few weeks ago and simply remove the AUTHORS block :-). But of course please feel free to add us both back if you prefer.

Replying to [comment:50 cheuberg]:
> I would not mind having RBF, CBF, RealBallField and ComplexBallField in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...

Done — I still don't like that very much, but since everyone seems to agree...



---

archive/issue_comments_259128.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-13T13:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259128",
    "user": "mmezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_259129.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-13T13:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259129",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259130.json:
```json
{
    "body": "Oops, merge conflict will the last ``develop``. I will overwrite the last few commits in a minute to avoid the conflict.",
    "created_at": "2015-11-13T13:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259130",
    "user": "mmezzarobba"
}
```

Oops, merge conflict will the last ``develop``. I will overwrite the last few commits in a minute to avoid the conflict.



---

archive/issue_comments_259131.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-11-13T13:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259131",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_259132.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-11-13T13:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259132",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259133.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-11-13T13:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259133",
    "user": "mmezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_259134.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-13T18:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259134",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259135.json:
```json
{
    "body": "Replying to [comment:52 mmezzarobba]:\n> Replying to [comment:50 cheuberg]:\n> > I would not mind having RBF, CBF, RealBallField and ComplexBallField in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...\n> \n> Done \u2014 I still don't like that very much, but since everyone seems to agree...\n\nIs there a particular reason for not using `lazy_import`?\n\nApart from that question, all my concerns have been dealt with and as far as I can see, Jeroen's comments are also all taken into account.\n\nI think that #19568 is not too related to the changes in this ticket (`RealBallField` was never marked as experimental, as that decorator did not yet exist when it was introduced).\n\nTherefore, I intend to set this ticket to positive as soon as the question about lazy imports is settled.",
    "created_at": "2015-11-13T18:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259135",
    "user": "cheuberg"
}
```

Replying to [comment:52 mmezzarobba]:
> Replying to [comment:50 cheuberg]:
> > I would not mind having RBF, CBF, RealBallField and ComplexBallField in the global name space; this is how most of sage seems to work. But this could also happen in another ticket ...
> 
> Done — I still don't like that very much, but since everyone seems to agree...

Is there a particular reason for not using `lazy_import`?

Apart from that question, all my concerns have been dealt with and as far as I can see, Jeroen's comments are also all taken into account.

I think that #19568 is not too related to the changes in this ticket (`RealBallField` was never marked as experimental, as that decorator did not yet exist when it was introduced).

Therefore, I intend to set this ticket to positive as soon as the question about lazy imports is settled.



---

archive/issue_comments_259136.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-11-13T18:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259136",
    "user": "cheuberg"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_259137.json:
```json
{
    "body": "Replying to [comment:59 cheuberg]:\n> I think that #19568 is not too related to the changes in this ticket\n\nIt's not related but it would be nice to fix #19568 before too many people start using `RBF`.",
    "created_at": "2015-11-13T19:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259137",
    "user": "jdemeyer"
}
```

Replying to [comment:59 cheuberg]:
> I think that #19568 is not too related to the changes in this ticket

It's not related but it would be nice to fix #19568 before too many people start using `RBF`.



---

archive/issue_comments_259138.json:
```json
{
    "body": "Replying to [comment:59 cheuberg]:\n> Is there a particular reason for not using `lazy_import`?\n\nYes:  I'm not sure that the modules are expensive enough to be worth importing with `lazy_import`, and it causes doctest failures that I didn't have the time or motivation to investigate...",
    "created_at": "2015-11-16T09:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259138",
    "user": "mmezzarobba"
}
```

Replying to [comment:59 cheuberg]:
> Is there a particular reason for not using `lazy_import`?

Yes:  I'm not sure that the modules are expensive enough to be worth importing with `lazy_import`, and it causes doctest failures that I didn't have the time or motivation to investigate...



---

archive/issue_comments_259139.json:
```json
{
    "body": "Replying to [comment:62 mmezzarobba]:\n> it causes doctest failures that I didn't have the time or motivation to investigate...\n\nCan you at least push your attempt such that it can be investigated?",
    "created_at": "2015-11-16T14:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259139",
    "user": "jdemeyer"
}
```

Replying to [comment:62 mmezzarobba]:
> it causes doctest failures that I didn't have the time or motivation to investigate...

Can you at least push your attempt such that it can be investigated?



---

archive/issue_comments_259140.json:
```json
{
    "body": "Replying to [comment:63 jdemeyer]:\n> Replying to [comment:62 mmezzarobba]:\n> > it causes doctest failures that I didn't have the time or motivation to investigate...\n> \n> Can you at least push your attempt such that it can be investigated?\n\nThe following change:\n\n```\ndiff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\nindex b5d4db7..33f18a1 100644\n--- a/src/sage/rings/all.py\n+++ b/src/sage/rings/all.py\n@@ -83,7 +83,8 @@ from real_double import RealDoubleField, RDF, RealDoubleElement\n \n from real_lazy import RealLazyField, RLF, ComplexLazyField, CLF\n \n-from sage.rings.real_arb import RealBallField, RBF\n+lazy_import(\"sage.rings.real_arb\", \"RealBallField\")\n+lazy_import(\"sage.rings.real_arb\", \"RBF\")\n \n # Polynomial Rings and Polynomial Quotient Rings\n from polynomial.all import *\n```\n\nleads to:\n\n```\n$ ./sage -t src/sage/rings/real_arb.pyx src/sage/rings/complex_arb.pyx\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2015-11-16-16-34-41-63268156.\nGit branch: arb-misc\nUsing --optional=mpir,python2,sage,scons\nDoctesting 2 files.\nsage -t src/sage/rings/real_arb.pyx\n**********************************************************************\nFile \"src/sage/rings/real_arb.pyx\", line 314, in sage.rings.real_arb.RealBallField\nFailed example:\n    (1/2*RBF(1)) + AA(sqrt(2)) - 1 + polygen(QQ, x)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.real_arb.RealBallField[2]>\", line 1, in <module>\n        (Integer(1)/Integer(2)*RBF(Integer(1))) + AA(sqrt(Integer(2))) - Integer(1) + polygen(QQ, x)\n      File \"sage/structure/element.pyx\", line 1702, in sage.structure.element.RingElement.__add__ (build/cythonized/sage/structure/element.c:16575)\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1070, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9739)\n        raise TypeError(arith_error_message(x,y,op))\n    TypeError: unsupported operand parent(s) for '+': 'Real ball field with 53 bits precision' and 'Univariate Polynomial Ring in x over Rational Field'\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.rings.real_arb.RealBallField\n    [454 tests, 1 failure, 0.23 s]\nsage -t src/sage/rings/complex_arb.pyx\n    [253 tests, 0.25 s]\n----------------------------------------------------------------------\nsage -t src/sage/rings/real_arb.pyx  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 0.7 seconds\n    cpu time: 0.5 seconds\n    cumulative wall time: 0.5 seconds\n(exit 1) \n```\n",
    "created_at": "2015-11-16T15:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259140",
    "user": "mmezzarobba"
}
```

Replying to [comment:63 jdemeyer]:
> Replying to [comment:62 mmezzarobba]:
> > it causes doctest failures that I didn't have the time or motivation to investigate...
> 
> Can you at least push your attempt such that it can be investigated?

The following change:

```
diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
index b5d4db7..33f18a1 100644
--- a/src/sage/rings/all.py
+++ b/src/sage/rings/all.py
@@ -83,7 +83,8 @@ from real_double import RealDoubleField, RDF, RealDoubleElement
 
 from real_lazy import RealLazyField, RLF, ComplexLazyField, CLF
 
-from sage.rings.real_arb import RealBallField, RBF
+lazy_import("sage.rings.real_arb", "RealBallField")
+lazy_import("sage.rings.real_arb", "RBF")
 
 # Polynomial Rings and Polynomial Quotient Rings
 from polynomial.all import *
```

leads to:

```
$ ./sage -t src/sage/rings/real_arb.pyx src/sage/rings/complex_arb.pyx
too many failed tests, not using stored timings
Running doctests with ID 2015-11-16-16-34-41-63268156.
Git branch: arb-misc
Using --optional=mpir,python2,sage,scons
Doctesting 2 files.
sage -t src/sage/rings/real_arb.pyx
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 314, in sage.rings.real_arb.RealBallField
Failed example:
    (1/2*RBF(1)) + AA(sqrt(2)) - 1 + polygen(QQ, x)
Exception raised:
    Traceback (most recent call last):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.real_arb.RealBallField[2]>", line 1, in <module>
        (Integer(1)/Integer(2)*RBF(Integer(1))) + AA(sqrt(Integer(2))) - Integer(1) + polygen(QQ, x)
      File "sage/structure/element.pyx", line 1702, in sage.structure.element.RingElement.__add__ (build/cythonized/sage/structure/element.c:16575)
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1070, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9739)
        raise TypeError(arith_error_message(x,y,op))
    TypeError: unsupported operand parent(s) for '+': 'Real ball field with 53 bits precision' and 'Univariate Polynomial Ring in x over Rational Field'
**********************************************************************
1 item had failures:
   1 of  14 in sage.rings.real_arb.RealBallField
    [454 tests, 1 failure, 0.23 s]
sage -t src/sage/rings/complex_arb.pyx
    [253 tests, 0.25 s]
----------------------------------------------------------------------
sage -t src/sage/rings/real_arb.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.7 seconds
    cpu time: 0.5 seconds
    cumulative wall time: 0.5 seconds
(exit 1) 
```




---

archive/issue_comments_259141.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-11-17T10:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259141",
    "user": "mmezzarobba"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_259142.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-23T15:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259142",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_259143.json:
```json
{
    "body": "Replying to [comment:64 mmezzarobba]:\n> Replying to [comment:63 jdemeyer]:\n> > Replying to [comment:62 mmezzarobba]:\n> > Can you at least push your attempt such that it can be investigated?\n> \n> The following change:\n> ...\n> leads to:\n> ...\n> {{{\n>     TypeError: unsupported operand parent(s) for '+': 'Real ball field with 53 bits precision' and 'Univariate Polynomial Ring in x over Rational Field'\n> }}}\n\nI cannot reproduce this. I used your diff and had no problems with `make ptestlong`, neither on `6.10.beta0` where this branch is based on nor after merging with `6.10.beta5`. Tested only on 64-bit linux though.\n\nLet's see what the patchbots say.",
    "created_at": "2015-11-23T15:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259143",
    "user": "cheuberg"
}
```

Replying to [comment:64 mmezzarobba]:
> Replying to [comment:63 jdemeyer]:
> > Replying to [comment:62 mmezzarobba]:
> > Can you at least push your attempt such that it can be investigated?
> 
> The following change:
> ...
> leads to:
> ...
> {{{
>     TypeError: unsupported operand parent(s) for '+': 'Real ball field with 53 bits precision' and 'Univariate Polynomial Ring in x over Rational Field'
> }}}

I cannot reproduce this. I used your diff and had no problems with `make ptestlong`, neither on `6.10.beta0` where this branch is based on nor after merging with `6.10.beta5`. Tested only on 64-bit linux though.

Let's see what the patchbots say.



---

archive/issue_comments_259144.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-11-25T15:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259144",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_259145.json:
```json
{
    "body": "So the patchbot could reproduce the problem (and in the meantime, I could also reproduce it). Thus I reset the branch to the earlier commit.\n\nThe commit with the lazy import is still available as branch `u/cheuberg/19152-arb-misc-lazy-import` if somebody wants to debug this.\n\nMy intention now is to set this ticket to positive review as it is in the next few days unless somebody objects.",
    "created_at": "2015-11-26T08:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259145",
    "user": "cheuberg"
}
```

So the patchbot could reproduce the problem (and in the meantime, I could also reproduce it). Thus I reset the branch to the earlier commit.

The commit with the lazy import is still available as branch `u/cheuberg/19152-arb-misc-lazy-import` if somebody wants to debug this.

My intention now is to set this ticket to positive review as it is in the next few days unless somebody objects.



---

archive/issue_comments_259146.json:
```json
{
    "body": "Fine with me; There seems to be something fishy with lazy import and coercion. Can you open a new ticket and push your lazy-import branch there?",
    "created_at": "2015-11-26T19:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259146",
    "user": "vbraun"
}
```

Fine with me; There seems to be something fishy with lazy import and coercion. Can you open a new ticket and push your lazy-import branch there?



---

archive/issue_comments_259147.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-27T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259147",
    "user": "cheuberg"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_259148.json:
```json
{
    "body": "Replying to [comment:70 vbraun]:\n> Can you open a new ticket and push your lazy-import branch there?\n\nThis is now #19628.\n\nThus it seems time to set this to positive_review.",
    "created_at": "2015-11-27T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259148",
    "user": "cheuberg"
}
```

Replying to [comment:70 vbraun]:
> Can you open a new ticket and push your lazy-import branch there?

This is now #19628.

Thus it seems time to set this to positive_review.



---

archive/issue_comments_259149.json:
```json
{
    "body": "I just noticed a stupid bug in the new `__hash__` (`07e365c509fbbd6e54da9e172f1845f6d24971c9`): I forgot to `fmpz_init` some variables. Would you prefer me to fix it here or to open a new ticket?",
    "created_at": "2015-11-27T11:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259149",
    "user": "mmezzarobba"
}
```

I just noticed a stupid bug in the new `__hash__` (`07e365c509fbbd6e54da9e172f1845f6d24971c9`): I forgot to `fmpz_init` some variables. Would you prefer me to fix it here or to open a new ticket?



---

archive/issue_comments_259150.json:
```json
{
    "body": "It's safer to do it in a new ticket (The release manager might already have pulled this ticket for inclusion).",
    "created_at": "2015-11-27T11:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259150",
    "user": "cheuberg"
}
```

It's safer to do it in a new ticket (The release manager might already have pulled this ticket for inclusion).



---

archive/issue_comments_259151.json:
```json
{
    "body": "Replying to [comment:73 cheuberg]:\n> It's safer to do it in a new ticket (The release manager might already have pulled this ticket for inclusion).\n\nDone in #19629.",
    "created_at": "2015-11-27T12:03:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259151",
    "user": "mmezzarobba"
}
```

Replying to [comment:73 cheuberg]:
> It's safer to do it in a new ticket (The release manager might already have pulled this ticket for inclusion).

Done in #19629.



---

archive/issue_comments_259152.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-28T13:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18915",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18915#issuecomment-259152",
    "user": "vbraun"
}
```

Resolution: fixed
