# Issue 27062: docker docbuild is slow

archive/issues_027062.json:
```json
{
    "body": "CC:  @embray @jdemeyer @slel\n\nIn the lastest beta 8.7.beta4, the docker builds fail their self test. Namely we run make and then we time another run of make (after deleting some cheap build artifacts.) This second run takes 400 seconds since this beta.\n\nHave there been any changes to sphinx that could cause this? For some reason we seem to be rebuilding most of the reference manual:\n\n```\n[dochtml] [combinat ] updating environment: 0 added, 199 changed, 0 removed\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/27299\n\n",
    "created_at": "2019-02-15T20:43:18Z",
    "labels": [
        "component: distribution",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "docker docbuild is slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27062",
    "user": "https://github.com/saraedum"
}
```
CC:  @embray @jdemeyer @slel

In the lastest beta 8.7.beta4, the docker builds fail their self test. Namely we run make and then we time another run of make (after deleting some cheap build artifacts.) This second run takes 400 seconds since this beta.

Have there been any changes to sphinx that could cause this? For some reason we seem to be rebuilding most of the reference manual:

```
[dochtml] [combinat ] updating environment: 0 added, 199 changed, 0 removed
```

Issue created by migration from https://trac.sagemath.org/ticket/27299





---

archive/issue_comments_380811.json:
```json
{
    "body": "The full log is here: https://gitlab-artifacts.s3.amazonaws.com/f3/fa/f3fa641922367cad0a37d11c9acdcc7d8893cb31dee45476ec37fd87f16ca468/2019_02_15/162222618/164521009/job.log?response-content-type=text/plain%3B%20charset%3Dutf-8&response-content-disposition=inline&X-Amz-Expires=600&X-Amz-Date=20190215T203601Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJTOFWQ3GL4O3Q3FA/20190215/us-east-1/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=b0fb458e6737dac19eff37f1ef53b49f7548caaa2282dc56cf60d1f1ddb60e33",
    "created_at": "2019-02-15T20:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380811",
    "user": "https://github.com/saraedum"
}
```

The full log is here: https://gitlab-artifacts.s3.amazonaws.com/f3/fa/f3fa641922367cad0a37d11c9acdcc7d8893cb31dee45476ec37fd87f16ca468/2019_02_15/162222618/164521009/job.log?response-content-type=text/plain%3B%20charset%3Dutf-8&response-content-disposition=inline&X-Amz-Expires=600&X-Amz-Date=20190215T203601Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJTOFWQ3GL4O3Q3FA/20190215/us-east-1/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=b0fb458e6737dac19eff37f1ef53b49f7548caaa2282dc56cf60d1f1ddb60e33



---

archive/issue_comments_380812.json:
```json
{
    "body": "Ok. This is unrelated to the latest beta. This changed earlier most likely. Anyway, the docbuild is taking too long at the moment at rebuilding. At least in the docker setup. It might be that we are throwing something away that is needed for the caching by now. But I doubt it because it used to work but there were always a few files that failed to be taken from the cache\u2026",
    "created_at": "2019-02-15T21:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380812",
    "user": "https://github.com/saraedum"
}
```

Ok. This is unrelated to the latest beta. This changed earlier most likely. Anyway, the docbuild is taking too long at the moment at rebuilding. At least in the docker setup. It might be that we are throwing something away that is needed for the caching by now. But I doubt it because it used to work but there were always a few files that failed to be taken from the cacheâ€¦



---

archive/issue_comments_380813.json:
```json
{
    "body": "I noticed this as well.  I wasn't sure if it was a fluke or what, or if the docbuild just...got slower for some unexplained reason.  \n\nCould you point out where the \"cheap build artifacts\" are being deleted?  Is there an easy way I can run this test locally so I could maybe find out where it changed (e.g. by running git bisect)?",
    "created_at": "2019-02-18T15:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380813",
    "user": "https://github.com/embray"
}
```

I noticed this as well.  I wasn't sure if it was a fluke or what, or if the docbuild just...got slower for some unexplained reason.  

Could you point out where the "cheap build artifacts" are being deleted?  Is there an easy way I can run this test locally so I could maybe find out where it changed (e.g. by running git bisect)?



---

archive/issue_comments_380814.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380814",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_067768.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27062#event-67768"
}
```



---

archive/issue_events_067769.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:54:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27062#event-67769"
}
```



---

archive/issue_comments_380815.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380815",
    "user": "https://github.com/embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_380816.json:
```json
{
    "body": "This is essentially adressed in #28502 though this does not seem to be the full answer yet.",
    "created_at": "2019-09-15T19:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380816",
    "user": "https://github.com/saraedum"
}
```

This is essentially adressed in #28502 though this does not seem to be the full answer yet.



---

archive/issue_comments_380817.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-15T19:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380817",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_events_067770.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2019-09-15T19:17:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27062#event-67770"
}
```



---

archive/issue_comments_380818.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-15T19:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380818",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_380819.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-10-07T07:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27062#issuecomment-380819",
    "user": "https://github.com/fchapoton"
}
```

Resolution: duplicate



---

archive/issue_events_067771.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-10-07T07:46:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27062",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27062#event-67771"
}
```
