# Issue 16162: Matrix stack doesn't coerce to a common parent

archive/issues_016162.json:
```json
{
    "body": "Assignee: @tscrim\n\nKeywords: matrix stack coercion\n\nI feel like we shouldn't have to do an explicit ring change to do this. Plus we get (somewhat) different failures for dense versus sparse matrices:\n\n```\nsage: m = matrix([[1,2]])\nsage: m2 = matrix(QQ, [[1/2,2]])\nsage: m.stack(m2)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: matrix has denominators so can't change to ZZ.\n```\n\n\n```\nsage: m = matrix([[1,2]], sparse=True)\nsage: m.stack(m2)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: no conversion of this rational to integer\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/16399\n\n",
    "created_at": "2014-05-26T03:05:59Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Matrix stack doesn't coerce to a common parent",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16162",
    "user": "https://github.com/tscrim"
}
```
Assignee: @tscrim

Keywords: matrix stack coercion

I feel like we shouldn't have to do an explicit ring change to do this. Plus we get (somewhat) different failures for dense versus sparse matrices:

```
sage: m = matrix([[1,2]])
sage: m2 = matrix(QQ, [[1/2,2]])
sage: m.stack(m2)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: matrix has denominators so can't change to ZZ.
```


```
sage: m = matrix([[1,2]], sparse=True)
sage: m.stack(m2)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: no conversion of this rational to integer
```


Issue created by migration from https://trac.sagemath.org/ticket/16399





---

archive/issue_comments_210823.json:
```json
{
    "body": "I have tried to look at the code. Apparently, one only tries to change the base ring of the bottom matrix. But of course, the coercion could be the other way, or there could be some complicated way to find a common coercion.\n\nI have made a preliminary attempt, very incomplete.\n----\nNew commits:",
    "created_at": "2014-07-27T08:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210823",
    "user": "https://github.com/fchapoton"
}
```

I have tried to look at the code. Apparently, one only tries to change the base ring of the bottom matrix. But of course, the coercion could be the other way, or there could be some complicated way to find a common coercion.

I have made a preliminary attempt, very incomplete.
----
New commits:



---

archive/issue_comments_210824.json:
```json
{
    "body": "Here's how to get a common parent:\n\n```\nsage: from sage.structure.element import get_coercion_model\nsage: CM = get_coercion_model()\nsage: CM.common_parent(QQ, ZZ['x'])\nUnivariate Polynomial Ring in x over Rational Field\n```\n\nand since we're modifying cython files, we could probably use the cdef global coercion model from element.pyx:\n\n```\ncdef CoercionModel coercion_model\n```\n",
    "created_at": "2014-07-27T15:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210824",
    "user": "https://github.com/tscrim"
}
```

Here's how to get a common parent:

```
sage: from sage.structure.element import get_coercion_model
sage: CM = get_coercion_model()
sage: CM.common_parent(QQ, ZZ['x'])
Univariate Polynomial Ring in x over Rational Field
```

and since we're modifying cython files, we could probably use the cdef global coercion model from element.pyx:

```
cdef CoercionModel coercion_model
```




---

archive/issue_comments_210825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-30T14:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210825",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210826.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-07-30T14:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210827.json:
```json
{
    "body": "Given the syntax, `m.stack(...)` it makes a lot of sense to try and let the result depend as much as possible on m and not on \"...\". The error you get now is quick and it is clear how to avoid it. With coercion, you could get an unexpected base \nring change of the resulting matrix, which might give erroneous results much later.\n\nThe example below gives questionable results, but the change you propose here would break the behaviour we have already:\n\n```\nsage: M=matrix(ZZ,[1]).stack(matrix(GF(3),[1])).stack(matrix(GF(5),[1]))\nsage: M.base_ring()\nInteger Ring\n```\n\n\nClearly, the current semantics are *conversion* into the base ring of the first matrix. Changing that into *coercion* into a common parent would be a real change, and it's not clear to me the resulting semantics are entirely desirable.\n\nI'm not particularly defending the current semantics either. I'm just pointing out you're proposing an incompatible change and for that to be justified we'd need fairly wide concensus that the change leads to significantly more desirable behaviour.",
    "created_at": "2014-07-30T18:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210827",
    "user": "https://github.com/nbruin"
}
```

Given the syntax, `m.stack(...)` it makes a lot of sense to try and let the result depend as much as possible on m and not on "...". The error you get now is quick and it is clear how to avoid it. With coercion, you could get an unexpected base 
ring change of the resulting matrix, which might give erroneous results much later.

The example below gives questionable results, but the change you propose here would break the behaviour we have already:

```
sage: M=matrix(ZZ,[1]).stack(matrix(GF(3),[1])).stack(matrix(GF(5),[1]))
sage: M.base_ring()
Integer Ring
```


Clearly, the current semantics are *conversion* into the base ring of the first matrix. Changing that into *coercion* into a common parent would be a real change, and it's not clear to me the resulting semantics are entirely desirable.

I'm not particularly defending the current semantics either. I'm just pointing out you're proposing an incompatible change and for that to be justified we'd need fairly wide concensus that the change leads to significantly more desirable behaviour.



---

archive/issue_comments_210828.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> Given the syntax, `m.stack(...)` it makes a lot of sense to try and let the result depend as much as possible on m and not on \"...\".\nI disagree with this. That's just a pure syntactical thing, mathematically \"stacking\" could be seen as a binary operator.\n\nI am +1 to coercion, but there could indeed be unexpected consequences.",
    "created_at": "2015-01-06T11:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210828",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 nbruin]:
> Given the syntax, `m.stack(...)` it makes a lot of sense to try and let the result depend as much as possible on m and not on "...".
I disagree with this. That's just a pure syntactical thing, mathematically "stacking" could be seen as a binary operator.

I am +1 to coercion, but there could indeed be unexpected consequences.



---

archive/issue_comments_210829.json:
```json
{
    "body": "Note: I hit the issue on this ticket by working on #17585. Apparently, the `basis_matrix()` method of modules with basis always returns a matrix over the fraction field. Changing this gives errors because of the issue here.",
    "created_at": "2015-01-06T11:39:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210829",
    "user": "https://github.com/jdemeyer"
}
```

Note: I hit the issue on this ticket by working on #17585. Apparently, the `basis_matrix()` method of modules with basis always returns a matrix over the fraction field. Changing this gives errors because of the issue here.



---

archive/issue_comments_210830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-06T12:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210830",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-06T16:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210831",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-07T08:44:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210832",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_210833.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-07T08:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210833",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_210834.json:
```json
{
    "body": "Looks good overall, but there are two things.\n\nThe first is could you keep the \"returns a new matrix\" part of the documentation? Since matrices are mutable, your proposed change makes the result slightly ambiguous to me as we could mutate in place and return `self`.\n\nSecond is about this change:\n\n```diff\ndiff --git a/src/sage/modules/fg_pid/fgp_morphism.py b/src/sage/modules/fg_pid/fgp_morphism.py\nindex 80fe02b..86bbe37 100644\n--- a/src/sage/modules/fg_pid/fgp_morphism.py\n+++ b/src/sage/modules/fg_pid/fgp_morphism.py\n@@ -423,6 +423,7 @@ class FGP_Morphism(Morphism):\n \n             # Stack it on top of the basis for W'.\n             Wp = CD.V().coordinate_module(CD.W()).basis_matrix()\n+            Wp = Wp.change_ring(A.base_ring())\n             B = A.stack(Wp)\n \n             # Compute Hermite form of C with transformation\n```\n\nIs this necessary for this ticket or is it suppose to be a part of #17585?",
    "created_at": "2015-01-07T17:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210834",
    "user": "https://github.com/tscrim"
}
```

Looks good overall, but there are two things.

The first is could you keep the "returns a new matrix" part of the documentation? Since matrices are mutable, your proposed change makes the result slightly ambiguous to me as we could mutate in place and return `self`.

Second is about this change:

```diff
diff --git a/src/sage/modules/fg_pid/fgp_morphism.py b/src/sage/modules/fg_pid/fgp_morphism.py
index 80fe02b..86bbe37 100644
--- a/src/sage/modules/fg_pid/fgp_morphism.py
+++ b/src/sage/modules/fg_pid/fgp_morphism.py
@@ -423,6 +423,7 @@ class FGP_Morphism(Morphism):
 
             # Stack it on top of the basis for W'.
             Wp = CD.V().coordinate_module(CD.W()).basis_matrix()
+            Wp = Wp.change_ring(A.base_ring())
             B = A.stack(Wp)
 
             # Compute Hermite form of C with transformation
```

Is this necessary for this ticket or is it suppose to be a part of #17585?



---

archive/issue_comments_210835.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> {{{#!diff\n> diff --git a/src/sage/modules/fg_pid/fgp_morphism.py b/src/sage/modules/fg_pid/fgp_morphism.py\n> index 80fe02b..86bbe37 100644\n> --- a/src/sage/modules/fg_pid/fgp_morphism.py\n> +++ b/src/sage/modules/fg_pid/fgp_morphism.py\n> `@``@` -423,6 +423,7 `@``@` class FGP_Morphism(Morphism):\n>  \n>              # Stack it on top of the basis for W'.\n>              Wp = CD.V().coordinate_module(CD.W()).basis_matrix()\n> +            Wp = Wp.change_ring(A.base_ring())\n>              B = A.stack(Wp)\n>  \n>              # Compute Hermite form of C with transformation\n> }}}\n> Is this necessary for this ticket or is it suppose to be a part of #17585?\nYes, it's necessary for this ticket but it's not needed with #16399 and #17585 *together*. So it could be added here and removed again in #17585.",
    "created_at": "2015-01-07T19:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210835",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 tscrim]:
> {{{#!diff
> diff --git a/src/sage/modules/fg_pid/fgp_morphism.py b/src/sage/modules/fg_pid/fgp_morphism.py
> index 80fe02b..86bbe37 100644
> --- a/src/sage/modules/fg_pid/fgp_morphism.py
> +++ b/src/sage/modules/fg_pid/fgp_morphism.py
> `@``@` -423,6 +423,7 `@``@` class FGP_Morphism(Morphism):
>  
>              # Stack it on top of the basis for W'.
>              Wp = CD.V().coordinate_module(CD.W()).basis_matrix()
> +            Wp = Wp.change_ring(A.base_ring())
>              B = A.stack(Wp)
>  
>              # Compute Hermite form of C with transformation
> }}}
> Is this necessary for this ticket or is it suppose to be a part of #17585?
Yes, it's necessary for this ticket but it's not needed with #16399 and #17585 *together*. So it could be added here and removed again in #17585.



---

archive/issue_comments_210836.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-07T19:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210836",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210837.json:
```json
{
    "body": "Changing component from coercion to linear algebra.",
    "created_at": "2015-01-07T21:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210837",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from coercion to linear algebra.



---

archive/issue_comments_210838.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-08T07:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210838",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_210839.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> > Is this necessary for this ticket or is it suppose to be a part of #17585?\n> Yes, it's necessary for this ticket but it's not needed with #16399 and #17585 *together*. So it could be added here and removed again in #17585.\n\nOkay, then positive review. Thanks for making that change to the doc.",
    "created_at": "2015-01-08T07:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210839",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:15 jdemeyer]:
> > Is this necessary for this ticket or is it suppose to be a part of #17585?
> Yes, it's necessary for this ticket but it's not needed with #16399 and #17585 *together*. So it could be added here and removed again in #17585.

Okay, then positive review. Thanks for making that change to the doc.



---

archive/issue_events_015713.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-12T18:11:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16162#event-15713"
}
```



---

archive/issue_comments_210840.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-12T18:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16162#issuecomment-210840",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
