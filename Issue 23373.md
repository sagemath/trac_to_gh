# Issue 23373: add --import option to sage -t

Issue created by migration from https://trac.sagemath.org/ticket/23610

Original creator: mderickx

Original creation time: 2017-08-11 13:11:27

CC:  mmasdeu

It would be nice to be able to use the doctesting framework of sage in packages that depend on sage.
This is already possible right now, but requires importing all the functions in the package every time which is quite burdensome.  
Adding a `--import=package` option to `sage -t`  that does the equivalent of 

```
from package import *
```

in the doctesting namespace would make life a lot easier.


---

Comment by mderickx created at 2017-08-11 13:19:29

Changing status from new to needs_review.


---

Comment by mderickx created at 2017-08-11 13:22:23

New commits:


---

Comment by roed created at 2017-08-11 16:55:31

Great!  This is definitely a feature that people have requested over the years.

The code mostly looks good.  Why do you need to add quotes around numbers in a few of the tests?

Positive review once tests pass.


---

Comment by mderickx created at 2017-08-11 17:11:14

The quotes are not around numbers perse. It is there for the case that somewhere in the future someone adds an entry to `value_opt` that also accepts lists.  I had to do this first to make `--import` work since it accepts lists. But then later I realised that I had to special case` --import` since `options.import` is an invalid syntax.


---

Comment by mderickx created at 2017-08-11 17:26:37

I think the tests of the buildbots are not going to pass, since the both raise an error. Do you have an idea where these `SkipTicket("unsafe")` errors in the [patchbot](https://patchbot.sagemath.org/log/Pending/23610/Ubuntu/15.10/x86_64/3.13.0-123-generic/sagemath-patchbot-docker/2017-08-11%2013:41:26) is coming from? Is it because I am modifying the doctesting framework?
Also I think the patchbot needs some patching since it shows the status still as pending, even though it already raised an error!


---

Comment by mderickx created at 2017-08-11 17:27:24

ps. thanks for the quick review!


---

Comment by jdemeyer created at 2017-08-11 21:40:03

Replying to [ticket:23610 mderickx]:
> This is already possible right now, but requires importing all the functions in the package every time which is quite burdensome.

On the other hand, having _complete working examples_ in the documentation is really useful. Compared to some other packages, this is one big plus for Sage: I can literally copy/paste the examples and be guaranteed that they work. In other words, at least for documentation, I'm not convinced that this new feature is a good idea.


---

Comment by mderickx created at 2017-08-12 02:56:29

Hi Jeroen,

I totally agree with you that the copy pasting is really usefull. And this ticket should not change any of this for sage itself since the way we say that our users should doctest sage is still without the `--import` option. And I also did not implement this for doctesting the sage library. I implemented this for downstream packages. And right now a downstream package should start every doctest with `from downstream package import *`. The downstream package would even have to do this if it implemented something that made sure that it's functions would get imported into the global sage namespace. For example of you would add `from downstream_package import *` to init.sage this would add all your functions to the global namespace in sage but not to the doctesting namespace. I would say that it is up to the downstream package to make sure that all their functions are automatically available in the global namespace if they start sage (or if they start their own python interpreter which automatically imports all their functions). This extra option is just to make doctesting easier if the downstream package made all their functions automatically available. Maybe an even better thing to do would be to make the sage enhancements to the python doctesting framework available as a standalone python package where the location of the global namespace of the to be tested library is a parameter instead of being hardcoded to be `sage.all_cmdline`. But that is significantly more work so I chose this way of making the sage doctesting framework to be as useful for downstream packages as for sage itself.


---

Comment by vdelecroix created at 2017-08-12 08:04:54

I agree with Jeroen, most Python packages do explicitely write the imports in their doctests (which is useful for the users). The first example in

    http://docs.sympy.org/0.7.6/modules/mpmath/calculus/sums_limits.html

starts with `from sympy.mpmath import *`.

Replying to [comment:9 mderickx]:
> And right now a downstream package should start every doctest with from downstream package import *.

which is good!

> The downstream package would even have to do this if it implemented something that made sure that it's functions would get imported into the global sage namespace. For example of you would add `from downstream_package import *` to init.sage this would add all your functions to the global namespace in sage but not to the doctesting namespace. I would say that it is up to the downstream package to make sure that all their functions are automatically available in the global namespace if they start sage (or if they start their own python interpreter which automatically imports all their functions).

IMHO, it is a bad practice to have the functions in the namespace implictely. And you can definitely not assume that this would be done by all users of your pakcage.


---

Comment by jdemeyer created at 2017-09-19 09:40:44

Proposal: close as wontfix.


---

Comment by vdelecroix created at 2017-09-19 09:47:34

good for me. I would like to here Maarten comments about it.


---

Comment by mderickx created at 2017-09-19 11:18:23

Resolution: wontfix


---

Comment by mderickx created at 2017-09-19 11:18:23

I have been thinking about a little bit more recently, and my main argument was that doing: 

```
from blah import *
```

felt a bit rediculus and since sage was not doing it, I would not want to do it as well in my package. But I now better understand the differences between sage and a pip installable python package. Sage wants to be significantly more then just being a python library, it also wants to present its own user interface (either via jupyter notebook or via the commandline interface) and this is why things are different for sage and a python package. So I agree that this can be closed.

There are two bigger long term things related to this discussion which I think would be good:

1) seperate our doctesting module and make it into a python package. It seems to me that the problems that all our doctesting code is trying to solve is not really sage specific and other people might want to use it as well. Therefor it might be better of as a standalone package.

2) make sage also import less into the global namespace (and have more from .. import .. in the doctests) would also help wit the startup time of sage and remove the need of a lot of lazy importing. I feel less strong about this point then about point 1).
