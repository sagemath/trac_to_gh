# Issue 30396: "RuntimeError: failed to compute analytic rank" doctest failures

Issue created by migration from https://trac.sagemath.org/ticket/30633

Original creator: slabbe

Original creation time: 2020-09-22 20:32:40

CC:  slelievre stephen dimpase mjo mkoeppe

On Ubuntu 18.04 + 9.2.beta13, running

```
sage -tp src/sage/lfunctions/sympow.py src/sage/schemes/elliptic_curves/ell_rational_field.py
```

gives

```
----------------------------------------------------------------------
sage -t --random-seed=0 src/sage/lfunctions/sympow.py  # 3 doctests failed
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_rational_field.py  # 2 doctests failed
----------------------------------------------------------------------
```

with errors looking like:

```
**********************************************************************
File "src/sage/schemes/elliptic_curves/ell_rational_field.py", line 1502, in sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.analytic_rank
Failed example:
    E.analytic_rank(algorithm='all')
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.ell_rational_field.EllipticCurve_rational_field.analytic_rank[5]>", line 1, in <module>
        E.analytic_rank(algorithm='all')
      File "/home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1567, in analytic_rank
        self.analytic_rank('rubinstein'), self.analytic_rank('sympow')])
      File "/home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1551, in analytic_rank
        return sympow.analytic_rank(self)[0]
      File "/home/slabbe/GitBox/sage/local/lib/python3.8/site-packages/sage/lfunctions/sympow.py", line 299, in analytic_rank
        raise RuntimeError("failed to compute analytic rank")
    RuntimeError: failed to compute analytic rank
**********************************************************************
```



---

Comment by slelievre created at 2020-09-24 02:56:16

Changing keywords from "" to "sympow".


---

Comment by slabbe created at 2020-11-01 20:01:38

I confirm I have the issue on Ubuntu 18.04 + 9.3.beta0 running Python 3.8.0.

But, I do not have this issue on Ubuntu 20.04 + 9.2.rc3 running Python 3.8.5.


---

Comment by mkoeppe created at 2020-11-01 20:03:07

To fix it, likely `build/pkgs/sympow/spkg-configure.m4` would need to be improved so that it rejects the broken system versions of sympow.


---

Comment by mkoeppe created at 2020-11-01 20:03:55

Previous work in this direction was done in #30147


---

Comment by slabbe created at 2020-11-01 20:07:53

After doing `sage -i sympow`, the issue disappears.


---

Comment by slabbe created at 2020-11-01 20:10:11

Ok, I see, the version on my system is 1.023:

```
$ sympow -version
1.023 RELEASE (Debian 1.023-8)
(sage-sh) $ sympow -version
2.023.6 RELEASE
```



---

Comment by slabbe created at 2020-11-01 20:11:58

And on Ubuntu 20.04, the version is:

```
$ sympow -version
2.023.5 RELEASE (Debian 2.023.5-2)
```

which explains why it works on my other machine.


---

Comment by dimpase created at 2020-11-01 22:47:14

Replying to [comment:8 slabbe]:
> Ok, I see, the version on my system is 1.023:
> {{{
> $ sympow -version
> 1.023 RELEASE (Debian 1.023-8)
> (sage-sh) $ sympow -version
> 2.023.6 RELEASE
> }}}
Could you check your sympows as follows:

```
$ sympow -curve [1,-1,0,-79,289] -analrank
$ sympow -curve [0,1,1,-2,0] -analrank
```


I believe the 2nd test, but not the 1st, should crash on your system sympow 1.023.

If so, we can add this test to the one we already do on #30147.


---

Comment by slabbe created at 2020-11-02 07:47:57

On Ubuntu 20.04, both commands are ok:


```
$ sympow -version
2.023.5 RELEASE (Debian 2.023.5-2)

$ sympow -curve [1,-1,0,-79,289] -analrank
sympow 2.023.5 RELEASE (Debian 2.023.5-2)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [1,-1,0,-79,289]
At 2: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
At 117223: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 234446
sp 1: Conductor at 2 is 1+0, root number is 1
sp 1: Euler factor at 2 is 1+1*x
sp 1: Conductor at 117223 is 1+0, root number is -1
sp 1: Euler factor at 117223 is 1-1*x
1st sym power conductor is 234446, global root number is 1
NT 1d0: 1064
Maximal number of terms is 1064
0.0E+00
Done with small primes 1049
L(E,1) appears to be zero 8.96886e-13
NT 1d2: 702
0.0E+00
Done with small primes 1049
L''(E,1) appears to be zero 7.93453e-16
NT 1d4: 437
0.0E+00
Done with small primes 1049
Analytic Rank is 4 : leading L-term 8.94385e+00

$ sympow -curve [0,1,1,-2,0] -analrank
sympow 2.023.5 RELEASE (Debian 2.023.5-2)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [0,1,1,-2,0]
At 389: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 389
sp 1: Conductor at 389 is 1+0, root number is -1
sp 1: Euler factor at 389 is 1-1*x
1st sym power conductor is 389, global root number is 1
NT 1d0: 43
Maximal number of terms is 43
0.0E+00
Done with small primes 1049
L(E,1) appears to be zero 4.06614e-17
NT 1d2: 28
0.0E+00
Done with small primes 1049
Analytic Rank is 2 : leading L-term 7.59317e-01
```


On Ubuntu 18.04, both commands return "Segmentation Fault":


```
$ sympow -version
1.023 RELEASE (Debian 1.023-8)

$ sympow -curve [1,-1,0,-79,289] -analrank
sympow 1.023 RELEASE (Debian 1.023-8)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [1,-1,0,-79,289]
At 2: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
At 117223: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 234446
sp 1: Conductor at 2 is 1+0, root number is 1
sp 1: Euler factor at 2 is 1+1*x
sp 1: Conductor at 117223 is 1+0, root number is -1
sp 1: Euler factor at 117223 is 1-1*x
1st sym power conductor is 234446, global root number is 1
NT 1d0: 1064
Maximal number of terms is 1064
0.0E+00
Done with small primes 1049
Erreur de segmentation

$ sympow -curve [0,1,1,-2,0] -analrank
sympow 1.023 RELEASE (Debian 1.023-8)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [0,1,1,-2,0]
At 389: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 389
sp 1: Conductor at 389 is 1+0, root number is -1
sp 1: Euler factor at 389 is 1-1*x
1st sym power conductor is 389, global root number is 1
NT 1d0: 43
Maximal number of terms is 43
0.0E+00
Done with small primes 1049
Erreur de segmentation
```



---

Comment by slabbe created at 2020-11-02 08:01:23

So the input `[1,-1,0,-79,289]` does fail. Copy pasting what is in the current `sage/build/pkgs/sympow/spkg-configure.m4`, I get:


```
$ echo "@<:@1,-1,0,-79,289@:>@" | sympow -analrank | grep ^"Analytic Rank is 4"
**ERROR** Input appears to be bogus
```


on both Ubuntu 20.04 and Ubuntu 18.04.


---

Comment by slabbe created at 2020-11-02 08:08:17

I do get a different behavior if I write:

On Ubuntu 18.04, sympow 1.023:

```
$ sympow -curve [1,-1,0,-79,289] -analrank | grep ^"Analytic Rank is 4"
```


On Ubuntu 20.04, sympow 2.023:

```
$ sympow -curve [1,-1,0,-79,289] -analrank | grep ^"Analytic Rank is 4"
Analytic Rank is 4 : leading L-term 8.94385e+00
```



---

Comment by dimpase created at 2020-11-02 09:56:00

Replying to [comment:12 slabbe]:
> So the input `[1,-1,0,-79,289]` does fail. Copy pasting what is in the current `sage/build/pkgs/sympow/spkg-configure.m4`, I get:
> 
> {{{
> $ echo "`@`<:`@`1,-1,0,-79,289`@`:>`@`" | sympow -analrank | grep ^"Analytic Rank is 4"
> **ERROR** Input appears to be bogus
> }}}
> 
> on both Ubuntu 20.04 and Ubuntu 18.04.

you cannot in general just cut and paste from an m4 file into a shell. m4 files are preprocessed by autoconf, into ./configure (in m4 `[` and `]` have special meanining,
so they have to replaced by ``@`<:`@`` and ``@`:>`@``, respectively). In the latter you can see

```
      { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether sympow works well (cf. :trac:30147)" >&5
$as_echo_n "checking whether sympow works well (cf. :trac:30147)... " >&6; }
      sympow_rank_test=`echo "[1,-1,0,-79,289]" | sympow -analrank | grep ^"Analytic Rank is 4"`
      if test x"$sympow_rank_test" = x; then :

          { $as_echo "$as_me:${as_lineno-$LINENO}: result: no; cannot use system sympow" >&5
$as_echo "no; cannot use system sympow" >&6; }
          sage_spkg_install_sympow=yes

```


Could you check the output of this in `config.log`. If the test succeeds, one should get something like

```
configure:32210: checking whether sympow works well (cf. :trac:30147)
configure:32221: result: yes; use system sympow
```

there (line numbers might differ)


---

Comment by slabbe created at 2020-11-02 10:57:34

Replying to [comment:14 dimpase]: 
> you cannot in general just cut and paste from an m4 file into a shell.

oups, ok, I see.

On the machine running Ubuntu 18.04, I did
`make sympow-clean`
to remove the sage spkg I installed earlier. Then, I did `./configure`. Then


```
$ grep sympow config.log
## Checking whether SageMath should install SPKG sympow... ##
configure:32515: checking for sympow
configure:32533: found /usr/bin/sympow
configure:32545: result: /usr/bin/sympow
configure:32558: checking whether sympow works well (cf. :trac:30147)
configure:32569: result: yes; use system sympow
configure:32579: will use system package and not install SPKG sympow
configure:38100: result: sympow-2.023.6:                              using system package; SPKG will not be installed
ac_cv_path_SYMPOW=/usr/bin/sympow
    sympow \
    sympow \
    sympow \
    sympow \
SYMPOW='/usr/bin/sympow'
deps_sympow = | pari
vers_sympow = 2.023.6

$ /usr/bin/sympow -version
1.023 RELEASE (Debian 1.023-8)
```


so it seems that sympow version 1.023 is passing the test, whereas it should not.


---

Comment by slabbe created at 2020-11-02 11:04:14

> so it seems that sympow version 1.023 is passing the test, whereas it should not.

In fact, sympow 1.023 does pass the test written with the "echo" way:


```
$ echo "[1,-1,0,-79,289]" | sympow -analrank
sympow 1.023 RELEASE (Debian 1.023-8)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [1,-1,0,-79,289]
At 2: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
At 117223: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 234446
sp 1: Conductor at 2 is 1+0, root number is 1
sp 1: Euler factor at 2 is 1+1*x
sp 1: Conductor at 117223 is 1+0, root number is -1
sp 1: Euler factor at 117223 is 1-1*x
1st sym power conductor is 234446, global root number is 1
NT 1d0: 1064
Maximal number of terms is 1064
0.0E+00
Done with small primes 1049
L(E,1) appears to be zero 8.96886e-13
NT 1d2: 702
0.0E+00
Done with small primes 1049
L''(E,1) appears to be zero 7.93453e-16
NT 1d4: 437
0.0E+00
Done with small primes 1049
Analytic Rank is 4 : leading L-term 8.94385e+00
```


But, it does not work with the following syntax:


```
$ sympow -curve [1,-1,0,-79,289] -analrank
sympow 1.023 RELEASE (Debian 1.023-8)  (c) Mark Watkins --- see README and COPYING for details
Minimal model of curve  is [1,-1,0,-79,289]
At 2: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
At 117223: Inertia Group is  C1 MULTIPLICATIVE REDUCTION
Conductor is 234446
sp 1: Conductor at 2 is 1+0, root number is 1
sp 1: Euler factor at 2 is 1+1*x
sp 1: Conductor at 117223 is 1+0, root number is -1
sp 1: Euler factor at 117223 is 1-1*x
1st sym power conductor is 234446, global root number is 1
NT 1d0: 1064
Maximal number of terms is 1064
0.0E+00
Done with small primes 1049
Erreur de segmentation
```



---

Comment by dimpase created at 2020-11-02 11:11:22

ok, I will add a test with the other syntax, too. Thanks for helping to dig the problem (which makes me willing to curse in various languages :-)) up.


---

Comment by dimpase created at 2020-11-02 14:08:59

Changing component from number theory to build: configure.


---

Comment by dimpase created at 2020-11-02 14:08:59

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-11-02 14:08:59

OK, here it is
----
New commits:


---

Comment by slabbe created at 2020-11-02 14:57:57

After `make configure` and  `./configure`, I now get:

```
$ grep sympow config.log
## Checking whether SageMath should install SPKG sympow... ##
configure:32515: checking for sympow
configure:32533: found /usr/bin/sympow
configure:32545: result: /usr/bin/sympow
configure:32558: checking whether sympow works well (cf. :trac:30147 and :trac:30633)
configure:32565: result: no; cannot use system sympow
configure:32592: no suitable system package found for SPKG sympow
configure:38102: result: sympow-2.023.6:                              no suitable system package; will be installed as an SPKG
configure:39587: notice: the following SPKGs did not find equivalent system packages: _recommended boost coxeter3 gp2c isl libsemigroups pari_elldata pari_galpol pari_nftables pari_seadata sympow tox
  $ sudo apt-get install texlive-generic-extra texlive-xetex latexmk pandoc dvipng default-jdk ffmpeg libavdevice-dev libboost-dev pari-gp2c libisl-dev sympow
```


(I wonder if the sentence "the following SPKGs did not find equivalent system packages" should be improved, because it is not clear what is meant by "equivalent". Does it mean that the system `sympow` was not there at all in which case the user will think to install it or that `sympow` from the system was too old and there is nothing to do?)


---

Comment by slabbe created at 2020-11-02 15:03:45

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2020-11-02 15:03:45

I now get:


```
$ sage -tp src/sage/lfunctions/sympow.py src/sage/schemes/elliptic_curves/ell_rational_field.py
Git branch: 30633
Using --optional=4ti2,build,cbc,ccache,cryptominisat,database_jones_numfield,debian,dochtml,dot2tex,e_antic,fricas,glucose,latte_int,libnauty,lidia,lrslib,memlimit,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,sage,sage_numerical_backends_coin,sage_spkg
Doctesting 2 files using 8 threads.
sage -t --warn-long 51.0 --random-seed=0 src/sage/lfunctions/sympow.py
    [10 tests, 0.70 s]
sage -t --warn-long 51.0 --random-seed=0 src/sage/schemes/elliptic_curves/ell_rational_field.py
    [834 tests, 20.51 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by @stephenmontgomerysmith created at 2020-11-02 15:09:37

This might fix your problem:

https://trac.sagemath.org/ticket/12858

By its nature, it is an intermittent bug, which explains your mystery.


---

Comment by slabbe created at 2020-11-02 15:15:15

I don't know if it is related, because on Ubuntu 18.04 with sympow version 1.023, there is no mystery: the command `sympow -curve [1,-1,0,-79,289] -analrank` systematically fails as well as:

```
sage: sympow.analytic_rank(EllipticCurve('11a'))                                                                              
Segmentation fault
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-1-8cf6df7248bc> in <module>
----> 1 sympow.analytic_rank(EllipticCurve('11a'))
~/GitBox/sage/local/lib/python3.8/site-packages/sage/lfunctions/sympow.py in analytic_rank(self, E)
    295         if i == -1:
    296             print(self._fix_err(v))
--> 297             raise RuntimeError("failed to compute analytic rank")
    298         j = v.rfind(':')
    299         r = sage.rings.all.Integer(v[i + len(s):j])
RuntimeError: failed to compute analytic rank
```



---

Comment by @stephenmontgomerysmith created at 2020-11-02 15:20:06

Why not try it and see?  BTW, I definitely identified a bug, so if this isn't the cause of this particular problem, it will likely cause someone else problems down the road.


Replying to [comment:23 slabbe]:
> I don't know if it is related, because on Ubuntu 18.04 with sympow version 1.023, there is no mystery: the command `sympow -curve [1,-1,0,-79,289] -analrank` systematically fails as well as:
> {{{
> sage: sympow.analytic_rank(EllipticCurve('11a'))                                                                              
> Segmentation fault
> ---------------------------------------------------------------------------
> RuntimeError                              Traceback (most recent call last)
> <ipython-input-1-8cf6df7248bc> in <module>
> ----> 1 sympow.analytic_rank(EllipticCurve('11a'))
> ~/GitBox/sage/local/lib/python3.8/site-packages/sage/lfunctions/sympow.py in analytic_rank(self, E)
>     295         if i == -1:
>     296             print(self._fix_err(v))
> --> 297             raise RuntimeError("failed to compute analytic rank")
>     298         j = v.rfind(':')
>     299         r = sage.rings.all.Integer(v[i + len(s):j])
> RuntimeError: failed to compute analytic rank
> }}}


---

Comment by slabbe created at 2020-11-02 16:39:54

Replying to [comment:24 gh-stephenmontgomerysmith]:
> Why not try it and see? 

I don't see what I should try? Is your branch public? If yes, what is the name of the branch?

> BTW, I definitely identified a bug, so if this isn't the cause of this particular problem, it will likely cause someone else problems down the road.

Okay, so maybe it should be part of another ticket, since the bug described in the current ticket is already fixed by the proposed branch.


---

Comment by dimpase created at 2020-11-02 16:56:15

Replying to [comment:25 slabbe]:
> Replying to [comment:24 gh-stephenmontgomerysmith]:
> > Why not try it and see? 
> 
> I don't see what I should try? Is your branch public? If yes, what is the name of the branch?

see #12858, more precisely 
https://trac.sagemath.org/ticket/12858#comment:16
I gather this is Debian "upstream", with this bug still in.
 
I agree that this is an upstream bug, and the problem is to identify the upstream...

> 
> > BTW, I definitely identified a bug, so if this isn't the cause of this particular problem, it will likely cause someone else problems down the road.
> 
> Okay, so maybe it should be part of another ticket, since the bug described in the current ticket is already fixed by the proposed branch.


---

Comment by @stephenmontgomerysmith created at 2020-11-02 17:32:35

There is no branch I know of that contains this patch.  You will either have to hack the source code yourself, or wait until someone else puts it into a branch.

Replying to [comment:26 dimpase]:
> Replying to [comment:25 slabbe]:
> > Replying to [comment:24 gh-stephenmontgomerysmith]:
> > > Why not try it and see? 
> > 
> > I don't see what I should try? Is your branch public? If yes, what is the name of the branch?
> 
> see #12858, more precisely 
> #12858#comment:16
> I gather this is Debian "upstream", with this bug still in.
>  
> I agree that this is an upstream bug, and the problem is to identify the upstream...
> 
> > 
> > > BTW, I definitely identified a bug, so if this isn't the cause of this particular problem, it will likely cause someone else problems down the road.
> > 
> > Okay, so maybe it should be part of another ticket, since the bug described in the current ticket is already fixed by the proposed branch.


---

Comment by @stephenmontgomerysmith created at 2020-11-03 20:21:01

It looks like another fix was committed a while ago.  While the other fix wasn't technically correct, it should nevertheless have solved this issue.  So most likely this won't fix your particular problem.  Sorry.


---

Comment by slabbe created at 2020-11-04 13:01:18

Replying to [comment:19 slabbe]:
> (I wonder if the sentence "the following SPKGs did not find equivalent system packages" should be improved, because it is not clear what is meant by "equivalent". Does it mean that the system `sympow` was not there at all in which case the user will think to install it or that `sympow` from the system was too old and there is nothing to do?)

I created #30863 to address this issue.


---

Comment by dimpase created at 2020-11-04 15:16:21

Replying to [comment:28 gh-stephenmontgomerysmith]:
> It looks like another fix was committed a while ago.  While the other fix wasn't technically correct, it should nevertheless have solved this issue. 

I've proposed your change to upstream in https://gitlab.com/rezozer/forks/sympow/-/merge_requests/4

So it will eventually be fixed.


---

Comment by vbraun created at 2020-11-15 22:47:29

Resolution: fixed
