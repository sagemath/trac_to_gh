# Issue 27477: Sagelib build error on Cygwin using system GMP

Issue created by migration from https://trac.sagemath.org/ticket/27714

Original creator: embray

Original creation time: 2019-04-23 10:58:45

CC:  jdemeyer

Keywords: cygwin sagelib gmp

Since #27212 I get an error building sagelib:


```
[sagelib-8.8.beta3] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.9.0-x86_64-2.7/build/cythonized/sage/ext/fast_callable.o -L/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib/python2.7/config -L/home/embray/src/sagemath/sage/local/lib -lpython2.7 -o build/lib.cygwin-2.9.0-x86_64-2.7/sage/ext/fast_callable.dll
[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3442:29: error: conflicting types for ‘__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit’
[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t __pyx_v_n) {
[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3170:29: note: previous declaration of ‘__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit’ was here
[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t); /*proto*/
[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
```


followed by a long string of similar errors in the same module.

This is probably similar to the error fixed in #27713 but a different manifestation thereof.


---

Comment by embray created at 2019-04-23 12:42:07

Hmm, changing these ctypedefs to what I actually have in my `gmp.h` does not seem to fix it.  If my reading of the Cython docs is correct this actually should't matter anyways: It's still going to output literally `mp_limb_t` to the C code and does not redefine it in any way.

The "conflicting types" error first appears just after


```
/* Late includes */
#include "macros.h"
#include "string_impl.h"
#include "flint/flint.h"
#include "flint/fmpz.h"
#include "cython_metaclass.h"
```


so I wonder if one of these is somehow responsible.


---

Comment by embray created at 2019-04-23 13:21:18

Changing keywords from "cygwin sagelib gmp" to "cygwin sagelib gmp flint".


---

Comment by embray created at 2019-04-23 13:21:18

I traced the problem to this line in `flint.h`:


```
#define mp_bitcnt_t ulong
```


I have no idea why it would do this, but it's almost certainly wrong.


---

Comment by embray created at 2019-04-23 13:25:51

Added 10 years ago for no readily apparent reason in https://github.com/wbhart/flint2/commit/f988d3eaab92ad477fe73cb346060fc0b700c566

Later it was changed to `#define mp_bitcnt_t ulong` in a mass rename.  But flint's `ulong` type is defined in terms of `mp_limb_t` hence the breakage.


---

Comment by embray created at 2019-04-23 16:48:19

The previous PR to flint partially fixed the problem, but not fully.  See updated description.


---

Comment by embray created at 2019-04-23 17:03:45

Yeah, zn_poly has its own `typedef unsigned long ulong` totally unrelated to flint, except when both headers get included in the same module it's a mess.  I'll clean up the zn_poly ulong stuff... :(


---

Comment by embray created at 2019-04-24 10:14:17

Wow.  PARI has one of these too.  In `pari/parigen.h`:


```
#ifdef _WIN64
typedef unsigned long long pari_ulong;
#define long long long
#define labs llabs
#else
typedef unsigned long pari_ulong;
#endif
#define ulong pari_ulong
typedef long *GEN;
```


I think I encountered a problem caused by this `#define long long long` before.  I hate it.


---

Comment by embray created at 2019-04-24 12:26:31

I think ultimately the worse perpetrator of this is flint.  Its `ulong` and `slong` defines result in the worse compatibility issues.


---

Comment by embray created at 2019-06-07 15:15:03

This will be fixed by #27721 if it's accepted.


---

Comment by embray created at 2019-07-03 11:39:12

Moving open critical and blocker issues to the next release milestone (optimistically).


---

Comment by embray created at 2019-08-07 17:00:24

Resolution: worksforme


---

Comment by embray created at 2019-08-07 17:00:24

Should be fixed by #27721.
