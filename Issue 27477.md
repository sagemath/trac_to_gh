# Issue 27477: Sagelib build error on Cygwin using system GMP

archive/issues_027477.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: cygwin sagelib gmp\n\nSince #27212 I get an error building sagelib:\n\n```\n[sagelib-8.8.beta3] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.9.0-x86_64-2.7/build/cythonized/sage/ext/fast_callable.o -L/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib/python2.7/config -L/home/embray/src/sagemath/sage/local/lib -lpython2.7 -o build/lib.cygwin-2.9.0-x86_64-2.7/sage/ext/fast_callable.dll\n[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3442:29: error: conflicting types for \u2018__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit\u2019\n[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t __pyx_v_n) {\n[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3170:29: note: previous declaration of \u2018__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit\u2019 was here\n[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t); /*proto*/\n[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n...\n```\n\nfollowed by a long string of similar errors in the same module.\n\nThis is probably similar to the error fixed in #27713 but a different manifestation thereof.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27714\n\n",
    "created_at": "2019-04-23T10:58:45Z",
    "labels": [
        "component: porting: cygwin",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Sagelib build error on Cygwin using system GMP",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27477",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer

Keywords: cygwin sagelib gmp

Since #27212 I get an error building sagelib:

```
[sagelib-8.8.beta3] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.9.0-x86_64-2.7/build/cythonized/sage/ext/fast_callable.o -L/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib/python2.7/config -L/home/embray/src/sagemath/sage/local/lib -lpython2.7 -o build/lib.cygwin-2.9.0-x86_64-2.7/sage/ext/fast_callable.dll
[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3442:29: error: conflicting types for ‘__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit’
[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t __pyx_v_n) {
[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-8.8.beta3] build/cythonized/sage/data_structures/bounded_integer_sequences.c:3170:29: note: previous declaration of ‘__pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit’ was here
[sagelib-8.8.beta3]  static CYTHON_INLINE mp_limb_t __pyx_f_4sage_15data_structures_25bounded_integer_sequences_limb_one_set_bit(mp_bitcnt_t); /*proto*/
[sagelib-8.8.beta3]                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
```

followed by a long string of similar errors in the same module.

This is probably similar to the error fixed in #27713 but a different manifestation thereof.

Issue created by migration from https://trac.sagemath.org/ticket/27714





---

archive/issue_comments_387010.json:
```json
{
    "body": "Hmm, changing these ctypedefs to what I actually have in my `gmp.h` does not seem to fix it.  If my reading of the Cython docs is correct this actually should't matter anyways: It's still going to output literally `mp_limb_t` to the C code and does not redefine it in any way.\n\nThe \"conflicting types\" error first appears just after\n\n```\n/* Late includes */\n#include \"macros.h\"\n#include \"string_impl.h\"\n#include \"flint/flint.h\"\n#include \"flint/fmpz.h\"\n#include \"cython_metaclass.h\"\n```\n\nso I wonder if one of these is somehow responsible.",
    "created_at": "2019-04-23T12:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387010",
    "user": "https://github.com/embray"
}
```

Hmm, changing these ctypedefs to what I actually have in my `gmp.h` does not seem to fix it.  If my reading of the Cython docs is correct this actually should't matter anyways: It's still going to output literally `mp_limb_t` to the C code and does not redefine it in any way.

The "conflicting types" error first appears just after

```
/* Late includes */
#include "macros.h"
#include "string_impl.h"
#include "flint/flint.h"
#include "flint/fmpz.h"
#include "cython_metaclass.h"
```

so I wonder if one of these is somehow responsible.



---

archive/issue_comments_387011.json:
```json
{
    "body": "Changing keywords from \"cygwin sagelib gmp\" to \"cygwin sagelib gmp flint\".",
    "created_at": "2019-04-23T13:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387011",
    "user": "https://github.com/embray"
}
```

Changing keywords from "cygwin sagelib gmp" to "cygwin sagelib gmp flint".



---

archive/issue_comments_387012.json:
```json
{
    "body": "I traced the problem to this line in `flint.h`:\n\n```\n#define mp_bitcnt_t ulong\n```\n\nI have no idea why it would do this, but it's almost certainly wrong.",
    "created_at": "2019-04-23T13:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387012",
    "user": "https://github.com/embray"
}
```

I traced the problem to this line in `flint.h`:

```
#define mp_bitcnt_t ulong
```

I have no idea why it would do this, but it's almost certainly wrong.



---

archive/issue_comments_387013.json:
```json
{
    "body": "Added 10 years ago for no readily apparent reason in https://github.com/wbhart/flint2/commit/f988d3eaab92ad477fe73cb346060fc0b700c566\n\nLater it was changed to `#define mp_bitcnt_t ulong` in a mass rename.  But flint's `ulong` type is defined in terms of `mp_limb_t` hence the breakage.",
    "created_at": "2019-04-23T13:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387013",
    "user": "https://github.com/embray"
}
```

Added 10 years ago for no readily apparent reason in https://github.com/wbhart/flint2/commit/f988d3eaab92ad477fe73cb346060fc0b700c566

Later it was changed to `#define mp_bitcnt_t ulong` in a mass rename.  But flint's `ulong` type is defined in terms of `mp_limb_t` hence the breakage.



---

archive/issue_comments_387014.json:
```json
{
    "body": "The previous PR to flint partially fixed the problem, but not fully.  See updated description.",
    "created_at": "2019-04-23T16:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387014",
    "user": "https://github.com/embray"
}
```

The previous PR to flint partially fixed the problem, but not fully.  See updated description.



---

archive/issue_comments_387015.json:
```json
{
    "body": "Yeah, zn_poly has its own `typedef unsigned long ulong` totally unrelated to flint, except when both headers get included in the same module it's a mess.  I'll clean up the zn_poly ulong stuff... :(",
    "created_at": "2019-04-23T17:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387015",
    "user": "https://github.com/embray"
}
```

Yeah, zn_poly has its own `typedef unsigned long ulong` totally unrelated to flint, except when both headers get included in the same module it's a mess.  I'll clean up the zn_poly ulong stuff... :(



---

archive/issue_comments_387016.json:
```json
{
    "body": "Wow.  PARI has one of these too.  In `pari/parigen.h`:\n\n```\n#ifdef _WIN64\ntypedef unsigned long long pari_ulong;\n#define long long long\n#define labs llabs\n#else\ntypedef unsigned long pari_ulong;\n#endif\n#define ulong pari_ulong\ntypedef long *GEN;\n```\n\nI think I encountered a problem caused by this `#define long long long` before.  I hate it.",
    "created_at": "2019-04-24T10:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387016",
    "user": "https://github.com/embray"
}
```

Wow.  PARI has one of these too.  In `pari/parigen.h`:

```
#ifdef _WIN64
typedef unsigned long long pari_ulong;
#define long long long
#define labs llabs
#else
typedef unsigned long pari_ulong;
#endif
#define ulong pari_ulong
typedef long *GEN;
```

I think I encountered a problem caused by this `#define long long long` before.  I hate it.



---

archive/issue_comments_387017.json:
```json
{
    "body": "I think ultimately the worse perpetrator of this is flint.  Its `ulong` and `slong` defines result in the worse compatibility issues.",
    "created_at": "2019-04-24T12:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387017",
    "user": "https://github.com/embray"
}
```

I think ultimately the worse perpetrator of this is flint.  Its `ulong` and `slong` defines result in the worse compatibility issues.



---

archive/issue_comments_387018.json:
```json
{
    "body": "This will be fixed by #27721 if it's accepted.",
    "created_at": "2019-06-07T15:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387018",
    "user": "https://github.com/embray"
}
```

This will be fixed by #27721 if it's accepted.



---

archive/issue_comments_387019.json:
```json
{
    "body": "Moving open critical and blocker issues to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387019",
    "user": "https://github.com/embray"
}
```

Moving open critical and blocker issues to the next release milestone (optimistically).



---

archive/issue_events_068720.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:39:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27477#event-68720"
}
```



---

archive/issue_comments_387020.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-08-07T17:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387020",
    "user": "https://github.com/embray"
}
```

Resolution: worksforme



---

archive/issue_events_068721.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-08-07T17:00:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27477#event-68721"
}
```



---

archive/issue_comments_387021.json:
```json
{
    "body": "Should be fixed by #27721.",
    "created_at": "2019-08-07T17:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27477#issuecomment-387021",
    "user": "https://github.com/embray"
}
```

Should be fixed by #27721.



---

archive/issue_events_068722.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-08-07T17:00:24Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27477#event-68722"
}
```



---

archive/issue_events_068723.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-08-07T17:00:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27477",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27477#event-68723"
}
```
