# Issue 33363: Configure mathjax in sphinx config  public/docs/mathjax_ext

Issue created by migration from https://trac.sagemath.org/ticket/33600

Original creator: @tobiasdiez

Original creation time: 2022-03-30 12:43:48

CC:  klee strogdon â€‹schilly mkoeppe

Configure mathjax in sphinx config, and not in a javascript file. In this way, we can get ride of the custom theme option `mathjax_macros`, which is not understood by other themes. This is preparation to support the furo theme.


---

Comment by @tobiasdiez created at 2022-03-30 13:46:25

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-03-30 13:46:25

This seems to do the job for me. With the disclaimer that I could only test the tutorial and dev guide, since "reference" fails with a lot of errors on gitpod. Among them

```
[tensor_fr] Extension error (matplotlib.sphinxext.plot_directive):
[tensor_fr] Handler <function _copy_css_file at 0x7f47e225b4c0> for event 'build-finished' threw an exception (exception: [Errno 17] File exists: '/home/gitpod/sage-local/share/doc/sage/html/en/reference/tensor_free_modules/_static')
```



---

Comment by git created at 2022-03-30 13:46:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-30 16:30:53

See #30296 and references within for previous efforts / discussion regarding mathjax 3


---

Comment by @tobiasdiez created at 2022-03-30 18:41:18

Thanks for the pointer. It seems the issues discussed in that ticket revolve around packaging problems. I circumvent these here by using the CDN.


---

Comment by mkoeppe created at 2022-03-30 23:31:32

I would expect that people want to keep an offline version without using the CDN.


---

Comment by mkoeppe created at 2022-03-31 01:33:07

Replying to [comment:5 gh-tobiasdiez]:
> It seems the issues discussed in that ticket revolve around packaging problems.

One of the "references within" is #25833 for the upgrade to 3.x. 
It would be important to know whether #25833#comment:9 is still current, and whether it is relevant for our use of Sphinx.


---

Comment by mkoeppe created at 2022-03-31 01:33:07

Changing status from needs_review to needs_info.


---

Comment by klee created at 2022-03-31 05:03:59

Replying to [comment:7 mkoeppe]:
> One of the "references within" is #25833 for the upgrade to 3.x. 
> It would be important to know whether #25833#comment:9 is still current, and whether it is relevant for our use of Sphinx.

That feature (not compatible with latex) of mathjax2 would be relevant only in online use of mathjax, such as in jupyter notebook. 

As far as I know, that "automatic line breaking" is not used in our documentation. If there is any, then that is something to be fixed.

For us, there is no reason not to upgrade to mathjax3.


---

Comment by klee created at 2022-03-31 05:14:43

Sage cell has moved to mathjax3 (relatively) long time ago. It may be worth while to check the mathjax3 configuration used in sage cell:

https://github.com/sagemath/sagecell/blob/master/js/cell.js


---

Comment by klee created at 2022-03-31 05:25:04

You converted single quotes to double quotes. Single quotes are conventionally used for strings containing code (not plain English). You should not change them without compelling reasons.


---

Comment by @tobiasdiez created at 2022-03-31 08:34:45

Changing status from needs_info to needs_review.


---

Comment by @tobiasdiez created at 2022-03-31 08:34:45

Replying to [comment:8 klee]:
> Replying to [comment:7 mkoeppe]:
> > One of the "references within" is #25833 for the upgrade to 3.x. 
> > It would be important to know whether #25833#comment:9 is still current, and whether it is relevant for our use of Sphinx.
> 
> That feature (not compatible with latex) of mathjax2 would be relevant only in online use of mathjax, such as in jupyter notebook. 
> 
> As far as I know, that "automatic line breaking" is not used in our documentation. If there is any, then that is something to be fixed.
> 
> For us, there is no reason not to upgrade to mathjax3.

Thanks for the clarification!


---

Comment by @tobiasdiez created at 2022-03-31 08:37:17

Replying to [comment:10 klee]:
> You converted single quotes to double quotes. Single quotes are conventionally used for strings containing code (not plain English). You should not change them without compelling reasons. 

I wasn't aware that such a styleguide rule exists. The existing code in both files doesn't seem to follow it either - it's just a random mix of single and double quotes. I tried to make at least the lines homogeneous that I've touched.


---

Comment by klee created at 2022-03-31 10:56:00

Replying to [comment:12 gh-tobiasdiez]:
> Replying to [comment:10 klee]:
> > You converted single quotes to double quotes. Single quotes are conventionally used for strings containing code (not plain English). You should not change them without compelling reasons. 
> 
> I wasn't aware that such a style guide rule exists. 

I must say it's not a rule. But single quotes are commonly used for code strings.

> The existing code in both files doesn't seem to follow it either - it's just a random mix of single and double quotes. I tried to make at least the lines homogeneous that I've touched.

Leaving single-quoted strings as they are will contribute overall homogeneity of the sage code base.


---

Comment by git created at 2022-03-31 11:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-31 11:56:00

Replying to [comment:13 klee]:
> Leaving single-quoted strings as they are will contribute overall homogeneity of the sage code base. 

Sadly there is not much of a homogeneity. For example, latex-macros.py contains

```python
    args = "("
    for x in sample_args:
        count += 1
        args += str(x) + ','
    args += ')'
```


Anyway, I've reverted these changes.


---

Comment by klee created at 2022-03-31 12:58:40

Replying to [comment:15 gh-tobiasdiez]:
> Sadly there is not much of a homogeneity. For example, latex-macros.py contains
> {{{#!python
>     args = "("
>     for x in sample_args:
>         count += 1
>         args += str(x) + ','
>     args += ')'
> }}}

Well.. that is embarrassing.

> Anyway, I've reverted these changes.

Thank you.


---

Comment by klee created at 2022-04-05 00:44:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-04-05 14:54:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-05 14:55:44

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-04-05 18:29:34

comment:6?


---

Comment by git created at 2022-04-06 01:25:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by klee created at 2022-04-06 01:37:46

My commit contains minor edits. I removed the comment to 'sphinx.ext.mathjax', which seems unnecessary only cluttering code.

Otherwise all looks good to me. But as Matthias points out, this ticket needs to ship MathJax3 for offline users.

I noticed a glitch in `local/share/doc/sage/html/en/index.html`:

![](screen-shot.png)

but this seems a bug of MathJax3, hopefully temporary.


---

Comment by klee created at 2022-04-06 01:41:22

A question: 

mathjax2 config `theme_mathjax_macros` is missing in the new mathjax3 config. Is this never used in sage documentation?


---

Comment by klee created at 2022-04-06 01:52:02

Are these 

- Remove ignoreHtmlClass/processHtmlClass since they are set to the default values.
- Remove noerrors extension, which hides error messages. ...

true? I don't see them in the code before the patch.


---

Comment by @tobiasdiez created at 2022-04-06 19:57:11

Replying to [comment:6 mkoeppe]:
> I would expect that people want to keep an offline version without using the CDN.

Isn't the pdf enough for offline documentation? And if you really need the html docs offline, you can also save them from the browser.

We can of course download the js file from the cdn and ship it, but that would make the experience for other people less nice since you don't get all the advantages that a central cdn gives you.


---

Comment by @tobiasdiez created at 2022-04-06 19:59:39

Replying to [comment:22 klee]:
> My commit contains minor edits. I removed the comment to 'sphinx.ext.mathjax', which seems unnecessary only cluttering code.

Did you forget to push it? Or at least I cannot see your commit.


---

Comment by @tobiasdiez created at 2022-04-06 20:01:29

Replying to [comment:23 klee]:
> A question: 
> 
> mathjax2 config `theme_mathjax_macros` is missing in the new mathjax3 config. Is this never used in sage documentation?

This was only used to inject the mathjax macros into the `mathjax_sage.js_t` file. Now the macros are directly defined via the new `mathjax3_config` in `docs/conf.py`.
`


---

Comment by @tobiasdiez created at 2022-04-06 20:04:59

Replying to [comment:24 klee]:
> Are these 
> 
> - Remove ignoreHtmlClass/processHtmlClass since they are set to the default values.
> - Remove noerrors extension, which hides error messages. ...
> 
> true? I don't see them in the code before the patch.

I've used the config migration tool https://mathjax.github.io/MathJax-demos-web/convert-configuration/convert-configuration.html, which then output these config options. They might be implicitly defined in the old `config=TeX-AMS_HTML-full`, or it just might be bug in the migration tool.


---

Comment by klee created at 2022-04-06 21:33:42

Replying to [comment:28 gh-tobiasdiez]:
> Replying to [comment:24 klee]:
> > Are these 
> > 
> > - Remove ignoreHtmlClass/processHtmlClass since they are set to the default values.
> > - Remove noerrors extension, which hides error messages. ...
> > 
> > true? I don't see them in the code before the patch.
> 
> I've used the config migration tool https://mathjax.github.io/MathJax-demos-web/convert-configuration/convert-configuration.html, which then output these config options. They might be implicitly defined in the old `config=TeX-AMS_HTML-full`, or it just might be bug in the migration tool.

If the messages are merely suggesting you to make those changes and you didn't do the manual changes, then the messages copied to the ticket description are just confusing.


---

Comment by klee created at 2022-04-06 21:43:34

Replying to [comment:27 gh-tobiasdiez]:
> Replying to [comment:23 klee]:
> > A question: 
> > 
> > mathjax2 config `theme_mathjax_macros` is missing in the new mathjax3 config. Is this never used in sage documentation?
> 
> This was only used to inject the mathjax macros into the `mathjax_sage.js_t` file. Now the macros are directly defined via the new `mathjax3_config` in `docs/conf.py`.

If it was really used, then it is defined somewhere, and now it must be deleted in you branch. But I don't see them...


---

Comment by klee created at 2022-04-06 21:44:52

Replying to [comment:26 gh-tobiasdiez]:
> Replying to [comment:22 klee]:
> > My commit contains minor edits. I removed the comment to 'sphinx.ext.mathjax', which seems unnecessary only cluttering code.
> 
> Did you forget to push it? Or at least I cannot see your commit.

It is in comment:21.


---

Comment by klee created at 2022-04-06 21:56:10

Replying to [comment:25 gh-tobiasdiez]:
> We can of course download the js file from the cdn and ship it, but that would make the experience for other people less nice since you don't get all the advantages that a central cdn gives you.

It seems we need `./configure --offline-doc` or something.


---

Comment by klee created at 2022-04-07 05:03:42

See #25833.


---

Comment by git created at 2022-04-07 07:55:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-07 07:58:56

Now the branch at #25833 is merged.

Presently the default is offline mathjax3, to experiment. When everything is okay, we should decide what should be the default.


---

Comment by git created at 2022-04-07 08:08:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-07 16:01:57

Replying to [comment:37 klee]:
> Now the branch at #25833 is merged.
> 
> Presently the default is offline mathjax3, to experiment. When everything is okay, we should decide what should be the default.

Thanks for your work on this!


---

Comment by git created at 2022-04-08 01:19:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-08 01:24:31

I think that offline sage documentation should be the default as it has been. So I renamed the config variable to `--use-cdns`. If we change the default to "online" in the future, then we can just turn on `--use-cdns`.


---

Comment by git created at 2022-04-08 01:35:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-08 02:43:17

To build doc with mathjax cdn, we only need

```diff
diff --git a/src/doc/Makefile b/src/doc/Makefile
index 90bea5dfac..82134ea3b4 100644
--- a/src/doc/Makefile
+++ b/src/doc/Makefile
@@ -21,7 +21,7 @@ doc-inventory--%:
 
 # Matches doc-html--developer, doc-html--reference-manifolds etc.
 doc-html--%:
-       cd $(SAGE_ROOT) && ./sage --docbuild --no-pdf-links $(subst -,/,$(subst doc-html--,,$@)) html $(SAGE_DOCBUILD_OPTS)
+       cd $(SAGE_ROOT) && ./sage --docbuild --use-cdns --no-pdf-links $(subst -,/,$(subst doc-html--,,$@)) html $(SAGE_DOCBUILD_OPTS)
 
 # reference manual, inventory
 ifndef SAGE_ROOT
```


So `./configure --online-doc` would do the above.


---

Comment by arojas created at 2022-04-08 06:06:52

Any reason `os.path.join(SAGE_SHARE, 'mathjax3')` is hardcoded in `docs/conf.py` instead of using the `MATHJAX_DIR` defined in `env.py`?


---

Comment by git created at 2022-04-08 06:12:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-08 06:12:47

Replying to [comment:45 arojas]:
> Any reason `os.path.join(SAGE_SHARE, 'mathjax3')` is hardcoded in `docs/conf.py` instead of using the `MATHJAX_DIR` defined in `env.py`?

No. You are right. Thanks.


---

Comment by git created at 2022-04-08 12:51:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-08 18:31:28

Should we merge this ticket with #25833, since you replace the mathjax 2 package there, so one probably should upgrade the config in one go as well. What do you think?


---

Comment by @tobiasdiez created at 2022-04-08 19:29:22

Replying to [comment:42 klee]:
> I think that offline sage documentation should be the default as it has been. So I renamed the config variable to `--use-cdns`. If we change the default to "online" in the future, then we can just turn on `--use-cdns`.

I'm not sure what should be the default for developers (but I guess everyone has internet if they contribute to trac...so I guess cdn would make sense), but the server should use the cdn to increase the speed or not? Comparing the loading times from the cdn vs sage's server, the cdn is a factor 10 quicker (13 ms vs 140ms).


---

Comment by klee created at 2022-04-08 23:42:02

Replying to [comment:49 gh-tobiasdiez]:
> Should we merge this ticket with #25833, since you replace the mathjax 2 package there, so one probably should upgrade the config in one go as well. What do you think?

I agree. Let's do it. I will upload the branch of this ticket to #25833.


---

Comment by klee created at 2022-04-08 23:49:25

Replying to [comment:50 gh-tobiasdiez]:
> Replying to [comment:42 klee]:
> > I think that offline sage documentation should be the default as it has been. So I renamed the config variable to `--use-cdns`. If we change the default to "online" in the future, then we can just turn on `--use-cdns`.
> 
> I'm not sure what should be the default for developers (but I guess everyone has internet if they contribute to trac...so I guess cdn would make sense), but the server should use the cdn to increase the speed or not? Comparing the loading times from the cdn vs sage's server, the cdn is a factor 10 quicker (13 ms vs 140ms).

The default is aimed at sage users with lowest resources.

I think we need to provide `./configure --online-doc` option so that everyone can choose what he/she wants. Developers would of course have internet resource usually, but sometimes not (on airplane :). Personally I would prefer offline-doc.


---

Comment by klee created at 2022-04-08 23:53:10

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-04-09 11:41:53

Replying to [comment:52 klee]:
> I think we need to provide `./configure --online-doc` option so that everyone can choose what he/she wants. 

No. We already have `SAGE_DOCBUILD_OPTS` environment variable. So we can

```
export SAGE_DOCBUILD_OPTS="--use-cdns"
```

before `make`.


---

Comment by @tobiasdiez created at 2022-04-09 19:39:37

Changing status from needs_work to positive_review.


---

Comment by klee created at 2022-04-09 23:46:45

Replying to [comment:55 gh-tobiasdiez]:

https://doc.sagemath.org/html/en/developer/trac.html#reviewing-and-closing-tickets

Okay. Let's close this.


---

Comment by mkoeppe created at 2022-05-11 02:14:43

Resolution: invalid
