# Issue 28633: meataxe not working with MatrixSpace

Issue created by migration from https://trac.sagemath.org/ticket/28870

Original creator: dimpase

Original creation time: 2019-12-11 09:57:03

CC:  vdelecroix simonking @ivo-maffei jdemeyer

the following contradicts the doc:
with `meataxe` installed, I get

```
sage: m=MatrixSpace(GF(2),5, 5, implementation='meataxe')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-6-f0ba29cfe335> in <module>()
----> 1 m=MatrixSpace(GF(Integer(2)),Integer(5), Integer(5), implementation='meataxe')

/home/dimpase/sage/local/lib/python3.7/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)()
    332         """
    333         if cls.classcall is not None:
--> 334             return cls.classcall(cls, *args, **kwds)
    335         else:
    336             # Fast version of type.__call__(cls, *args, **kwds)

/home/dimpase/sage/local/lib/python3.7/site-packages/sage/matrix/matrix_space.py in __classcall__(cls, base_ring, nrows, ncols, sparse, implementation)
    473             raise OverflowError("number of rows and columns may be at most %s" % sys.maxsize)
    474 
--> 475         matrix_cls = get_matrix_class(base_ring, nrows, ncols, sparse, implementation)
    476         return super(MatrixSpace, cls).__classcall__(
    477                 cls, base_ring, nrows, ncols, sparse, matrix_cls)

/home/dimpase/sage/local/lib/python3.7/site-packages/sage/matrix/matrix_space.py in get_matrix_class(R, nrows, ncols, sparse, implementation)
    305         # generic fallback
    306         if implementation != 'generic' and implementation is not None:
--> 307             raise ValueError("unknown matrix implementation %r over %r" % (implementation, R))
    308         else:
    309             return matrix_generic_dense.Matrix_generic_dense

ValueError: unknown matrix implementation 'meataxe' over Finite Field of size 2
```


And, by the way, `gap` instead of `meataxe` appears to work, but is not documented. 


---

Comment by SimonKing created at 2019-12-11 14:43:13

Note that I've opened #28871 for a different meataxe issue (compiler warnings for the meataxe wrappers in the sage library). But I don't think there is a dependency in one direction or the other.


---

Comment by SimonKing created at 2019-12-11 14:48:09

After installing meataxe and `sage -b`, one has

```
sage: M = random_matrix(GF(25,'x'),5)
sage: type(M)
<class 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
sage: M.parent().element_class
<class 'sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense'>
```


So, meataxe as default implementation does work.


---

Comment by SimonKing created at 2019-12-11 15:07:38

Here's the problem:

```
sage: sage.rings.finite_rings.integer_mod_ring.is_IntegerModRing(GF(5))
True
```

The non-default implementation "meataxe" would only be considered when `is_IntegerModRing(R)` returns False but `is_FiniteField(R)` returns True.

What do you think: Would it be a good idea to totally rewrite the logic that is implemented in `get_matrix_class`? It seems rather convoluted to me. The easiest fix would of course be to _first_ check whether we have a finite field and only later check whether we at least have an `IntegerModRing`.


---

Comment by SimonKing created at 2019-12-11 21:20:57

Replying to [comment:3 SimonKing]:
> What do you think: Would it be a good idea to totally rewrite the logic that is implemented in `get_matrix_class`? It seems rather convoluted to me. The easiest fix would of course be to _first_ check whether we have a finite field and only later check whether we at least have an `IntegerModRing`.

With the new commit, I switch the "if-then" branches for integer-mod-rings and for finite fields, which is needed since we want to treat finite prime fields as fields and not as integer-mod-rings.

Also, I added an example for `implementation='gap'`.

I didn't run tests yet, but switch it to "needs review" anyway...
----
New commits:


---

Comment by SimonKing created at 2019-12-11 21:20:57

Changing status from new to needs_review.


---

Comment by SimonKing created at 2019-12-12 11:42:45

I don't know what pyflakes complains about (it says "no such log"). Anyway, without meataxe tests pass. So, hopefully the remaining question is whether they also pass with meataxe installed.


---

Comment by dimpase created at 2019-12-12 11:56:37

how about also correcting the docstrings for `MatrixSpace` (and adding tests)?


---

Comment by SimonKing created at 2019-12-12 12:00:00

Replying to [comment:7 dimpase]:
> how about also correcting the docstrings for `MatrixSpace` (and adding tests)?

Makes sense. So far, I only added a test concerning gap for `get_matrix_class`, but `MatrixSpace` clearly is more visible. Maybe in the `matrix` constructor, too?


---

Comment by git created at 2019-12-12 15:06:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-12-12 15:08:58

I added another optional test in the documentation of `MatrixSpace`. I did not add to the `matrix` constructor, because so far choosing an implementation is not documented there at all (AFAIC).

Also, I saw that the optional meataxe tests are marked as `# optional: meataxe`, whereas all other optional tests are marked as `# optional - bla`. To be consistent, I changed to `# optional - meataxe` (but I guess it did work before, so, it is just a cosmetic change.


---

Comment by tscrim created at 2019-12-13 03:55:29

cc-ing Jeroen in case he has any comments about the change in `get_matrix_class` logic since (IIRC) he was the person who last rewrote that constructor.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by SimonKing created at 2020-01-10 20:58:35

Ping...


---

Comment by tscrim created at 2020-01-11 18:34:32

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-01-11 18:34:32

LGTM.

Dima, I added you as a reviewer for comment:7.


---

Comment by vbraun created at 2020-01-18 14:13:52

Various failures of the form

```
sage -t --warn-long 44.0 src/sage/dynamics/arithmetic_dynamics/projective_ds.py
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 6156, in sage.dynamics.arithmetic_dynamics.projective_ds.?.conjugating_set
Failed example:
    m = f.conjugating_set(g)[0]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.dynamics.arithmetic_dynamics.projective_ds.?.conjugating_set[42]>", line 1, in <module>
        m = f.conjugating_set(g)[Integer(0)]
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 6216, in conjugating_set
        bol,m = m2.is_similar(m1, transformation=True)
      File "sage/matrix/matrix2.pyx", line 10977, in sage.matrix.matrix2.Matrix.is_similar (build/cythonized/sage/matrix/matrix2.c:77253)
        _, SA = A.jordan_form(transformation=True)
      File "sage/matrix/matrix2.pyx", line 10242, in sage.matrix.matrix2.Matrix.jordan_form (build/cythonized/sage/matrix/matrix2.c:72434)
        evals = A.charpoly().roots()
      File "sage/matrix/matrix_cyclo_dense.pyx", line 1263, in sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense.charpoly (build/cythonized/sage/matrix/matrix_cyclo_dense.cpp:12236)
        f = self._charpoly_multimodular(var, proof=proof)
      File "sage/matrix/matrix_cyclo_dense.pyx", line 1368, in sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense._charpoly_multimodular (build/cythonized/sage/matrix/matrix_cyclo_dense.cpp:13543)
        X = A._charpoly_mod(p)
      File "sage/matrix/matrix_cyclo_dense.pyx", line 1302, in sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense._charpoly_mod (build/cythonized/sage/matrix/matrix_cyclo_dense.cpp:12517)
        R, denom = self._reductions(p)
      File "sage/matrix/matrix_cyclo_dense.pyx", line 1439, in sage.matrix.matrix_cyclo_dense.Matrix_cyclo_dense._reductions (build/cythonized/sage/matrix/matrix_cyclo_dense.cpp:14366)
        ans = R._matrices_from_rows(self._nrows, self._ncols)
      File "sage/structure/element.pyx", line 487, in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4608)
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 500, in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4717)
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 394, in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2614)
        raise AttributeError(dummy_error_message)
    AttributeError: 'sage.matrix.matrix_generic_dense.Matrix_generic_dense' object has no attribute '_matrices_from_rows'
**********************************************************************
```



---

Comment by vbraun created at 2020-01-18 14:13:52

Changing status from positive_review to needs_work.


---

Comment by SimonKing created at 2020-01-18 14:58:16

Replying to [comment:15 vbraun]:
> Various failures of the form
> {{{
> ...
>     AttributeError: 'sage.matrix.matrix_generic_dense.Matrix_generic_dense' object has no attribute '_matrices_from_rows'
> **********************************************************************
> }}}

Interesting. According to "git blame", that method was introduced by Burcin Erocal 10 years ago. Why has that error never shown up before?

The method `_matrices_from_rows` is defined in `src/sage/matrix/matrix_modn_dense_template.pxi`. So, perhaps Matrix_gfpn_dense should use the template?


---

Comment by SimonKing created at 2020-01-18 15:04:39

Replying to [comment:16 SimonKing]:
> The method `_matrices_from_rows` is defined in `src/sage/matrix/matrix_modn_dense_template.pxi`. So, perhaps Matrix_gfpn_dense should use the template?

Apparently not. Its first line states "Dense matrices over `\ZZ/n\ZZ` for `n` small using the LinBox library (FFLAS/FFPACK)."

Actually it could be that the creation of matrices from rows is defined for general matrices anyway. And as there is only a single line of code that actually uses `_matrices_from_rows`, it may very well be a better solution to nuke `_matrices_from_rows`.


---

Comment by SimonKing created at 2020-01-18 15:21:00

I was mistaken about the purpose of `_matrices_from_rows`: It isn't about slicing but it is a very technical and hardly natural construction.

`src/sage/matrix/matrix_cyclo_dense.pyx` is the only place in which this method. It is supposed to be with a matrix over ZZ/nZZ, but meataxe is strictly over a field. Moreover, by default, meataxe should only be used in Sage when there is a finite NON-PRIME field. Hence, even over ZZ/(prime(ZZ), meataxe should normally not be used.

So, one could argue that the matrix implementation used in `src/sage/matrix/matrix_cyclo_dense.pyx` should be hard-coded. Would that be a solution that you could accept?


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
