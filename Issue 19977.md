# Issue 19977: Type inconsistencies in polynomial factorization

Issue created by migration from https://trac.sagemath.org/ticket/20214

Original creator: vdelecroix

Original creation time: 2016-03-15 14:03:36

CC:  slelievre


```
sage: R.<x> = ZZ[]
sage: parent((x+1).factor().unit())
Univariate Polynomial Ring in x over Integer Ring
sage: parent(R.one().factor().unit())
Integer Ring
```



---

Comment by behackl created at 2016-03-29 08:58:13

Changing status from new to needs_review.


---

Comment by behackl created at 2016-03-29 08:58:13

I've fixed this to return the unit as an element of the base ring, as it is done for the rationals or by the factorization with Pari.
----
New commits:


---

Comment by behackl created at 2016-03-29 13:16:52

... the doctest failures show that fixing this does require more effort than that. ;-)


---

Comment by vdelecroix created at 2016-03-29 13:43:00

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-03-29 13:43:00

Factorization is aimed to be a generic class, not only polynomials. I am a little bit worried about your one line change (and patchbot as well). For example the free group has no base ring and matrix groups (`GL` or `SL`) have no multiplication defined with element of the base ring.

Note that some of the patchbot issue is just because `_repr_` of `Factorization` is bad. I will add a commit for that.


---

Comment by git created at 2016-03-29 13:44:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-03-29 13:45:44

The biggest issue seems to be that the matrix group code was relying on the current behavior for its factorization. Although I am somewhat more inclined to think the current behavior is the correct way to go because the units do not have to live in the base ring in general. Also from looking at the code, I don't see this fixing things if you work over `QQ[]`.

BTW, you should use `.one()`. It is usually cached, making construction of units in more non-trivial rings much faster and doesn't have to use the coercion framework.


---

Comment by behackl created at 2016-03-29 14:48:45

With the changes to the representation string and by fixing a silly error I made earlier (pushed one commit), there's just one failure remaining. It seems that the action from a finite field onto the general linear group is not implemented; I think that should be possible. E.g.:

```
sage: G = GL(3,5); F = G.base_ring()
sage: F(2) * G.one()
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for '*': 'Finite Field of size 5' and 'General Linear Group of degree 3 over Finite Field of size 5'
```


Should this be handled on this ticket as well or should we open a separate ticket? (Personally, I'm for a separate ticket...)
----
New commits:


---

Comment by tscrim created at 2016-03-29 14:51:26

I think that is a separate bug that does need to be fixed. +1 to a separate ticket (but it might be needed as a dependency).


---

Comment by vdelecroix created at 2016-03-29 15:17:49

It is not that trivial to fix. The thing is that you can not multiply by `0` in `GL` and there are much more restriction in `SL`... So the action should not go through a coercion.


---

Comment by vdelecroix created at 2016-03-29 15:28:34

And still the free group has no base ring... you would better do

```
try:
    unit = self.__universe.base_ring().one()
except XXX:
    try:
        unit = self.__universe.one()
    except XXX
        unit = Integer(1)
```

And as Travis mentionned in [comment:6 comment:6] it is not clear to me either if this is the way to go.


---

Comment by behackl created at 2016-03-29 16:27:22

Replying to [comment:9 vdelecroix]:
> It is not that trivial to fix. The thing is that you can not multiply by `0` in `GL` and there are much more restriction in `SL`... So the action should not go through a coercion.

I'd propose to implement `_lmul_` and `_rmul_`; I agree that embedding via coercion is not practicable.

Regarding the `base_ring` and the fact that there might not be one: yes, that has to be taken care of. I haven't thought of that because I was implementing the original version with #20086 in mind. I can't really contribute to the discussion which approach is the most suitable; it just has to be consistent.


---

Comment by mmarco created at 2016-05-14 23:09:12

My two cents: factoring makes sense in rings (more precisely, in UFD's), so the factors and the unit should be in the corresponding ring. 

So, I think that the correct behaviour should be the opposite of what you propose. That is, we should have:


```
sage: R.<x> = ZZ[]
sage: parent((x+1).factor().unit())
Univariate Polynomial Ring in x over Integer Ring
sage: parent(R.one().factor().unit())
Univariate Polynomial Ring in x over Integer Ring
```


There might be rings (e.g. Laurent polynomials) with units that are not in the rings base ring. So the only possible consistent behaviour is to have the units in the ring (and not in its base ring).


---

Comment by vdelecroix created at 2016-05-17 02:44:56

Of course. But in some cases, the units live in a well identified subgring. And it makes sense to keep them here. For me it would still be acceptable if the parent of the unit only had a coercion to the main ring. But of course this should be done consistently for a given ring. Hence the creation of this ticket.

I agree that it is much simpler to enforce the unit to belong in the same ring (or more generally multiplicative semigroup).


---

Comment by vdelecroix created at 2016-06-26 07:02:03

New commits:


---

Comment by vdelecroix created at 2016-06-26 07:03:01

Changing status from needs_work to needs_review.


---

Comment by mmarco created at 2016-06-26 09:41:36

Some questions after a first quick look.

Why in this part of the code, 


```
        elif universe is not None:
            x = [(universe(i),j) for i,j in x]
            if unit is None:
                try:
                    unit = universe(1)
                except (ValueError,TypeError):
                    pass
```


we don't include this first attempt?:


```
                 try:
                    unit = universe.one()
```

.


In the neg method we only allow negation of factorizations with unit (from what I have seen, it could happen in parents with no one method, and that doesn't allow to convert 1, not sure if they exist).

Otherwise it looks ok, but I still have to test it a bit more deeply.


---

Comment by vdelecroix created at 2016-06-26 10:22:21

Replying to [comment:17 mmarco]:
> Some questions after a first quick look.
> 
> Why in this part of the code, 
> 
> `...`
>
> we don't include this first attempt?:
> 
> `...`
> 

Right. It can be simplified a bit.

> In the neg method we only allow negation of factorizations with unit (from what I have seen, it could happen in parents with no one method, and that doesn't allow to convert 1, not sure if they exist).

Right, there is a problem here. What should we do for `-fac` when there is no unit? Raise an error?

> Otherwise it looks ok, but I still have to test it a bit more deeply.

Thanks for looking at it!


---

Comment by mmarco created at 2016-06-26 10:28:12

Maybe for the -fac problem we could just change the sign to the first factor if there is no unit?


---

Comment by vdelecroix created at 2016-06-26 10:47:07

Do you have concrete examples where there is no unit available but `x -> -x` is well defined (inside Sage of course)? I would rather raise a `ValueError`.


---

Comment by mmarco created at 2016-06-26 11:56:21

Fair enough. Raise error it is.


---

Comment by chapoton created at 2016-06-26 18:35:33

bad trac link, see patchbot report:

```
+inside file:  b/src/sage/structure/factorization.py
+@@ -1054,21 +1067,24 @@ class Factorization(SageObject):
++        Check that it only depends on the universe (trac:`20214`)::
```



---

Comment by git created at 2016-06-26 20:51:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-27 08:55:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-06-27 13:06:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-06-28 06:04:56

one failing doctest

```
File "src/sage/tests/french_book/polynomes.py", line 144, in sage.tests.french_book.polynomes
Failed example:
    for A in [QQ, ComplexField(16), GF(5), QQ[sqrt(2)]]:
        print("{} :".format(A)); print(A['x'](p).factor())
```



---

Comment by git created at 2016-06-28 06:14:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-07-06 14:38:41

ping?


---

Comment by chapoton created at 2016-11-05 07:28:53

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2016-11-05 07:28:53

no longer applies


---

Comment by slelievre created at 2018-12-26 09:34:08

This came up again at

- [Ask Sage question 44764: LaurentPolynomial can't factor constants](https://ask.sagemath.org/question/44764)

Can the work done here be rebased to apply on the latest release?


---

Comment by slelievre created at 2018-12-26 09:38:01

Changing keywords from "" to "factor, polynomial, Laurent polynomial".


---

Comment by git created at 2018-12-31 13:12:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-12-31 13:14:13

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-01-03 09:53:43

Replying to [comment:30 slelievre]:
> This came up again at
> 
> - [Ask Sage question 44764: LaurentPolynomial can't factor constants](https://ask.sagemath.org/question/44764)
> 
> Can the work done here be rebased to apply on the latest release?

Can you do the review now that it is rebased on your demand?


---

Comment by git created at 2019-01-03 09:58:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-02-05 08:00:41

Replying to [comment:34 vdelecroix]:
> Replying to [comment:30 slelievre]:
> > This came up again at
> > 
> > - [Ask Sage question 44764: LaurentPolynomial can't factor constants](https://ask.sagemath.org/question/44764)
> > 
> > Can the work done here be rebased to apply on the latest release?
> 
> Can you do the review now that it is rebased on your demand?

How much time do you need Samuel for the review?


---

Comment by chapoton created at 2019-02-16 10:25:50

red branch => needs work


---

Comment by chapoton created at 2019-02-16 10:25:50

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-01-25 02:50:46

Possibly related: #29076


---

Comment by vdelecroix created at 2020-01-25 16:29:42

Replying to [comment:42 mkoeppe]:
> Possibly related: #29076

it is not.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
