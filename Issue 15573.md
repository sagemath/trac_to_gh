# Issue 15573: Immutable directed graphs should know that they are directed

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2014-02-11 14:13:07

CC:  ncohen

Keywords: immutable directed graph

Bug:

```
sage: Q = DiGraph({1:{2:['a','b'], 3:['c']}, 2:{3:['d']}})
sage: Q.is_directed_acyclic()
True
sage: I = Q.copy(immutable=True)
sage: I.is_directed_acyclic()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-19-1dc52c5fb57c> in <module>()
----> 1 I.is_directed_acyclic()

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/digraph.pyc in is_directed_acyclic(self, certificate)
   1117             False
   1118         """
-> 1119         return self._backend.is_directed_acyclic(certificate = certificate)
   1120 
   1121     def to_directed(self):

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/base/c_graph.so in sage.graphs.base.c_graph.CGraphBackend.is_directed_acyclic (sage/graphs/base/c_graph.c:19314)()

ValueError: Input must be a directed graph.
```



---

Comment by SimonKing created at 2014-02-11 14:18:12

Variation of the theme:

```
sage: Q = DiGraph({1:{2:['a','b'], 3:['c']}, 2:{3:['d']}}, immutable=True)
sage: Q.is_directed_acyclic()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-3-a8ff599a3235> in <module>()
----> 1 Q.is_directed_acyclic()

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/digraph.pyc in is_directed_acyclic(self, certificate)
   1108             False
   1109         """
-> 1110         return self._backend.is_directed_acyclic(certificate = certificate)
   1111 
   1112     def to_directed(self):

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/base/c_graph.so in sage.graphs.base.c_graph.CGraphBackend.is_directed_acyclic (sage/graphs/base/c_graph.c:19328)()

/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/graphs/base/c_graph.so in sage.graphs.base.c_graph.bitset_init (sage/graphs/base/c_graph.c:3113)()

ValueError: bitset capacity must be greater than 0
```



---

Comment by SimonKing created at 2014-02-11 14:18:43

PS: In that case, `Q.show()` barks, too.


---

Comment by ncohen created at 2014-02-11 14:20:23

That's because in `static_sparse_backend` the binary variable for directed is `self.directed` instead of `self._directed`............

Nathann


---

Comment by SimonKing created at 2014-02-11 14:22:14

Replying to [comment:3 ncohen]:
> That's because in `static_sparse_backend` the binary variable for directed is `self.directed` instead of `self._directed`............

So, easy to fix, then? What are the dependencies of this ticket? Actually, the error with the master branch is as in comment:1, whereas I get the error shown in the ticket description with a different branch (develop?).


---

Comment by SimonKing created at 2014-02-11 14:32:26

New commits:


---

Comment by SimonKing created at 2014-02-11 14:32:26

Changing status from new to needs_review.


---

Comment by SimonKing created at 2014-02-11 14:34:29

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2014-02-11 14:34:29

There is more than this one type "_directed  --> directed" to fix.


---

Comment by ncohen created at 2014-02-11 14:35:07

Arg... I was uploading mine `:-/`

Nathann


---

Comment by ncohen created at 2014-02-11 14:35:43

NOnonono it's not this one that should be changed. Give me a second.

Nathann


---

Comment by SimonKing created at 2014-02-11 14:36:37

WTF?????

When I generally replace _directed by directed for static graph backend, I get numerous errors!!


---

Comment by SimonKing created at 2014-02-11 14:36:53

Replying to [comment:10 ncohen]:
> NOnonono it's not this one that should be changed. Give me a second.
> 
> Nathann

Why not? It fixes it.


---

Comment by SimonKing created at 2014-02-11 14:40:01

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-02-11 14:40:01

With my branch, all tests in sage.graphs pass. So, what's the problem?


---

Comment by ncohen created at 2014-02-11 14:40:47

> When I generally replace _directed by directed for static graph backend, I get numerous errors!!

The file `static_graph_backend` also contains a CGraph class, which uses `.directed` and not `_directed`. It's just a terrible choice. It has to be `._directed` for GraphBackend and `.directed` for CGraph. And if you change the value used in `is_directed_acyclic` that's going to fail when the backend is a `SparseGraph`. `:-/`

Nathann


---

Comment by ncohen created at 2014-02-11 14:41:48

> With my branch, all tests in sage.graphs pass. So, what's the problem?

`O_o`

No problem with SparseGraph backends ? Then I don't get it either.

Nathann


---

Comment by SimonKing created at 2014-02-11 14:43:36

Replying to [comment:15 ncohen]:
> No problem with SparseGraph backends ? Then I don't get it either.

Apparently:

```
sage: D = DiGraph({1:{2:['a','b'], 3:['c']}, 2:{3:['d']}})
sage: D.is_directed_acyclic()
True
sage: I = D.copy(immutable=True)
sage: I.is_directed_acyclic()
True
sage: D._backend
<class 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
sage: I._backend
<class 'sage.graphs.base.static_sparse_backend.StaticSparseBackend'>
```



---

Comment by SimonKing created at 2014-02-11 14:44:23

Replying to [comment:15 ncohen]:
> No problem with SparseGraph backends ? Then I don't get it either.

Did you not fix something of this kind in #15623 (which is a dependency)?


---

Comment by ncohen created at 2014-02-11 14:46:55

> Did you not fix something of this kind in #15623 (which is a dependency)?

No idea `O_o`

It's merged anyway, so what's the point ?

I'm trying to find out why your branch works while I thought it wouldn't.

Nathann


---

Comment by ncohen created at 2014-02-11 14:48:04


```
sage: d = DiGraph()       
sage: d._backend.directed 
True
sage: d._backend._directed
True
```


I hate this code.

Nathann


---

Comment by SimonKing created at 2014-02-11 14:48:53

Replying to [comment:18 ncohen]:
> It's merged anyway, so what's the point ?

I think it is in "develop", but not in "master", which is the default branching point when you create a ticket.


---

Comment by SimonKing created at 2014-02-11 14:49:21

Replying to [comment:19 ncohen]:
> {{{
> sage: d = DiGraph()       
> sage: d._backend.directed 
> True
> sage: d._backend._directed
> True
> }}}
> 
> I hate this code.

Understandably.
> Nathann


---

Comment by SimonKing created at 2014-02-11 14:50:39

OK, but this seems to indicate that `_backend.directed` and `_backend._directed` are both used and are out of sync. That's bad. Perhaps this can be cleaned up in this ticket.


---

Comment by ncohen created at 2014-02-11 14:51:31

> I think it is in "develop", but not in "master", which is the default branching point when you create a ticket.

Simon, I don't want to antagonize anybody and I'm sorry enough that you have to deal with stupid errors like that in the graph code (even though these things are not my doing either), but I really believe that the develop/ branch exists for developpers to work with.

Nathann


---

Comment by ncohen created at 2014-02-11 14:52:10

> OK, but this seems to indicate that `_backend.directed` and `_backend._directed` are both used and are out of sync. That's bad. Perhaps this can be cleaned up in this ticket.

Yeah, the `.directed` variable is set explicitly in the `DiGraph` constructor. I will update my branch in a second and add a message here when it is done.

Nathann


---

Comment by SimonKing created at 2014-02-11 14:55:07

Replying to [comment:24 ncohen]:
> Yeah, the `.directed` variable is set explicitly in the `DiGraph` constructor. I will update my branch in a second and add a message here when it is done.

OK. Will your branch include #15623 (i.e., more than master)?


---

Comment by ncohen created at 2014-02-11 14:56:01

> OK. Will your branch include #15623 (i.e., more than master)?

Well.... It will be based on develop, and include nothing else.

Nathann


---

Comment by ncohen created at 2014-02-11 15:02:57

By the way if you use the dev scripts and if they use the master branch as a default then that's probably a bug that should be fixed. Could you write to sage-git if that's the case ?

Nathann


---

Comment by ncohen created at 2014-02-11 15:18:50

What do you think of the current public/15810 ? It removes the ugly definition of `.directed` in the constructor of `DiGraph`. Another part of the code used this `.directed` once, and I converted it too. Now, Backends only have a `._directed` flag, as indicated by the very first lines of GenericGraphBackend

Nathann


---

Comment by SimonKing created at 2014-02-11 15:29:42

Replying to [comment:28 ncohen]:
> What do you think of the current public/15810

Can you remind me how to obtain that branch and how to set the default location for pushing a commit?


---

Comment by ncohen created at 2014-02-11 15:32:31

> Can you remind me how to obtain that branch and how to set the default location for pushing a commit?

git fetch trac `public/15810:local_branch` will fetch this branch and call it `local_branch` on your computer.

I do not know if it is what you ask with your second question, but `git push trac local_branch:remote_branch` will upload `local_branch` on Trac where it will be called `remote_branch`. `remote_branch` can be something like `public/168543843` or `u/your_trac_login/7687687`.

Nathann


---

Comment by SimonKing created at 2014-02-11 15:35:01

Thank you!

Simon


---

Comment by SimonKing created at 2014-02-11 15:39:09

Is the purpose of this ticket to remove the confusion between `_directed` and `directed`? Then it needs work, as both is still in the code.


---

Comment by ncohen created at 2014-02-11 15:43:21

> Is the purpose of this ticket to remove the confusion between `_directed` and `directed`? Then it needs work, as both is still in the code.

Where ? 

- There is a `Graph._directed` which cannot be renamed to .directed, for that's an internal variable
- With this ticket there is a `CGraphBackend._directed`, and only that.
- There is a `CGraph.directed`, as before.

How simple can it get ? We only store this boolean 3 times, and probably have as many functions that only return its value `>_<`

Nathann


---

Comment by SimonKing created at 2014-02-11 15:43:39


```
king`@`linux-etl7:~/Sage/git/sage> grep "\._directed" -R src/sage/graphs/ | grep pyx:
src/sage/graphs/base/static_sparse_backend.pyx:        self._directed = cg.directed
src/sage/graphs/base/static_sparse_backend.pyx:        if self._directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if self._directed:
src/sage/graphs/base/sparse_graph.pyx:        self._directed = directed
src/sage/graphs/base/sparse_graph.pyx:                      self._cg, self._cg_rev, self._directed)
src/sage/graphs/base/sparse_graph.pyx:                      self._cg, self._cg_rev, self._directed)
src/sage/graphs/base/sparse_graph.pyx:                      self._cg, self._cg_rev, self._directed)
src/sage/graphs/base/sparse_graph.pyx:                      self._cg, self._cg_rev, self._directed)
src/sage/graphs/base/dense_graph.pyx:        self._directed = directed
src/sage/graphs/base/c_graph.pyx:        if self._directed:
src/sage/graphs/base/c_graph.pyx:                     (self._directed and
src/sage/graphs/base/c_graph.pyx:        if not self._directed:
src/sage/graphs/base/c_graph.pyx:        if not self._directed:
src/sage/graphs/base/c_graph.pyx:        if not self.graph._directed:
src/sage/graphs/graph_decompositions/vertex_separation.pyx:        if G._directed:
```

versus

```
king`@`linux-etl7:~/Sage/git/sage> grep "\.directed" -R src/sage/graphs/ | grep pyx:
src/sage/graphs/base/static_sparse_backend.pyx:        self.directed = G.is_directed()
src/sage/graphs/base/static_sparse_backend.pyx:        if self.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if not self.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if not self.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if not self.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        self._directed = cg.directed
src/sage/graphs/base/static_sparse_backend.pyx:        if not cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:            if cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:            if cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:            if cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:            if cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if cg.directed:
src/sage/graphs/base/static_sparse_backend.pyx:        if cg.directed:
src/sage/graphs/generic_graph_pyx.pyx:        self.directed = G.is_directed()
src/sage/graphs/generic_graph_pyx.pyx:        if self.directed:
src/sage/graphs/generic_graph_pyx.pyx:                    if is_admissible and self.directed:
src/sage/graphs/generic_graph_pyx.pyx:        if self.directed:
```



---

Comment by SimonKing created at 2014-02-11 15:44:57

PS: There are numerous hits for both directed and _directed in .py files, too.


---

Comment by ncohen created at 2014-02-11 15:49:17

Oh. Looks like the CGraph do not insist on having a `_directed` or a `directed`. So I can change the instances of `static_sparse_backend` if you like. I don't think that those of SubgraphSearch matter to you, do they ? Those are the ones you find in `generic_graph_pyx.pyx`.


---

Comment by ncohen created at 2014-02-11 15:57:49

I updated the branch with a new commit. I set it as this ticket's branch so that you can see it more easily. The only `.directed` that remain are those of SubgraphSearch in `generic_graph_pyx.pyx`.

Nathann
----
New commits:


---

Comment by SimonKing created at 2014-02-11 16:16:21

Could you elaborate why you _remove_ one line in the following chunks, rather than replace `.directed` by `._directed`?

```diff
diff --git a/src/sage/graphs/digraph.py b/src/sage/graphs/digraph.py
index f869bb0..d95e96e 100644
--- a/src/sage/graphs/digraph.py
+++ b/src/sage/graphs/digraph.py
`@``@` -919,7 +919,6 `@``@` class DiGraph(GenericGraph):
                 self._weighted = weighted
                 self.allow_loops(loops, check=False)
                 self.allow_multiple_edges(multiedges, check=False)
-            self._backend.directed = True
         else:
             raise NotImplementedError("Supported implementations: networkx, c_graph.")
 
diff --git a/src/sage/graphs/graph.py b/src/sage/graphs/graph.py
index a3f1dcd..4d15305 100644
--- a/src/sage/graphs/graph.py
+++ b/src/sage/graphs/graph.py
`@``@` -1542,7 +1542,6 `@``@` class Graph(GenericGraph):
                 self._weighted = weighted
                 self.allow_loops(loops, check=False)
                 self.allow_multiple_edges(multiedges, check=False)
-            self._backend.directed = False
         else:
             raise NotImplementedError("Supported implementations: networkx, c_graph.")
```



---

Comment by ncohen created at 2014-02-11 16:20:48

Because several lines above those two lines, `self._backend` is created using the backend's constructor, which takes the value `True/False` as an input. 

And well, setting the value of a private variable of the backend is the backend's constructor's job. So this way, the constructors of !Graph and DiGraph do not mess with what they should not touch, the value of `_directed` is set only in the backend's constructor's code, and there is no fancy alias in the backend that is set where there should not be.

Nathann


---

Comment by SimonKing created at 2014-02-11 16:26:39

Replying to [comment:39 ncohen]:
> And well, setting the value of a private variable of the backend is the backend's constructor's job. So this way, the constructors of !Graph and DiGraph do not mess with what they should not touch, the value of `_directed` is set only in the backend's constructor's code, and there is no fancy alias in the backend that is set where there should not be.

OK. Then, provided tests pass, it will be positive review.


---

Comment by SimonKing created at 2014-02-11 20:00:41

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2014-02-11 20:00:41

Thank you, Nathann!

Simon


---

Comment by ncohen created at 2014-02-11 20:04:12

Thanks for the review `:-)`

Nathann


---

Comment by vbraun created at 2014-02-14 19:44:54

Resolution: fixed
