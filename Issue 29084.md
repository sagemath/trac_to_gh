# Issue 29084: CC(-1).agm(1) hangs

Issue created by migration from https://trac.sagemath.org/ticket/29321

Original creator: fredrik.johansson

Original creation time: 2020-03-12 19:23:10

This hangs:


```
CC(-1).agm(1)
```



---

Comment by @DaveWitteMorris created at 2020-03-23 06:04:57

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2020-03-23 06:04:57

The code hangs if the value `0` is encountered at any point in the iteration, because the termination condition is based on relative difference, rather than absolute difference. This happens when calculating `AGM(a,0)` and `AGM(a,-a)`, so the code treats these as special cases.  The bug reported in this ticket is that the test for `a == -b` was faulty when either `real(a)` or `imag(a)` is `0`. I fixed this.

The value `0` will also be encountered (and the original code will hang) when using the "principal" algorithm to calculate `AGM(a,a)`, if `a` is in the left half-plane. Unfortunately, rounding errors make it difficult to predict in advance whether iterates near the imaginary axis will be in the left half-plane or not, so it is not clear (to me, at least) whether this situation will arise at some point in the iteration. Therefore, I revised the termination condition to check for the presence of `0` when the algorithm is "principal".

An easy analysis shows that no other situations can encounter `0`, so these fixes should eliminate the hanging problem.

I also refactored, added doctests, and revised the documentation (including moving the "optimal" algorithm to be first, since it is the default).
----
New commits:


---

Comment by @DaveWitteMorris created at 2020-03-23 15:09:26

I need to fix two issues.
    1. The original code was careful to employ `mpfr` for all floating-point calculations, so I think I should eliminate my use of `-self` in the test for `AGM(a,-a)`.
    2. My termination condition for the "principal" algorithm is very poor. The program should be allowed to run until it actually hits 0 (or converges), not just when it gets near 0. I think this means that, in exceptional circumstances, the "principal" algorithm cannot be guaranteed to converge, because it conceivably could hit an infinite sequence of values that converge to 0. (In contrast, the "optimal" algorithm converges exponentially fast.) So I think I should add a `sig_check()` to the "principal" algorithm after I revise the termination condition.


---

Comment by @DaveWitteMorris created at 2020-03-23 15:09:26

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
