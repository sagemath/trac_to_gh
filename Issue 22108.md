# Issue 22108: Elliptic curve isogenies over number fields II: implement Billeray's algorithm for reducible primes

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2017-02-10 14:41:12

CC:  aly.deines kedlaya

This follows in from #22343 which is a dependency.  We implement Billeray's algorithm for finding the set of reducible primes for an elliptic curve without CM over a number field.  This is based on an implementation by Ciaran Schembri for a masters' project at Warwick.


---

Comment by aly.deines created at 2017-07-22 16:59:59

I started putting Cremona's code for Billerey's algorithm into appropriate places in Sage.  I cleaned it up a bit and addes some documentations.  

Things left to do or fix:
 * add documentation
 * only works if the curve has integral discriminant
 * incorporate into isogeny finding for EC's over number fields
 * more examples, especially over larger fields
 * timings against other methods
 * probably more . . .


---

Comment by aly.deines created at 2017-07-22 16:59:59

Changing keywords from "" to "elliptic curves, isogenies, number fields".


---

Comment by aly.deines created at 2017-07-22 17:02:16

Changing priority from major to minor.


---

Comment by cremona created at 2017-08-01 10:56:57

Thanks for the work so far.  I'm working on this again now and will go through your to-do list.


---

Comment by cremona created at 2017-08-02 14:57:14

I have rearranged the code quite a bit.  The technical parts of Billerey I though were better kept separate and not as methods of the elliptic curve class itself, so I put them in gal_reps_number_field.py.  (Alternatives were a new file, or on isogeny_class.py.)   In isogeny_class.py I also refactored the code to produce a finite set of primes, separating out the cm case, and allowing the user a choice of 3 algorithms, Billerey, Larson or 'heuristic', the latter being non-rigorous, just testing all primes up a to a given bound to see if they passthe necessary local conditions.  This is never the default and the docstring makes it clear that the output is not guaranteed complete.

This leaves a much simplified method reducible_primes() in the elliptic curves class itself, while the isogeny class code uses the new function to find the reducible primes, with Billerey the default algorithm.

I could put in more examples if desired.  I have not done systematic timing tests, but note that until the work done on another ticket Larson's method could not handle fields of degree 5 and up at all.

While writing this I realised that I have not yet provided the possibility for E.isogeny_class() to use a non-default algorithm, and will add that, but I'll leave the ticket at "needs review" so that patchbots get working on it.


---

Comment by cremona created at 2017-08-02 14:57:14

Changing status from new to needs_review.


---

Comment by cremona created at 2017-08-02 16:05:25

Some timings: with z=zeta_101 and E=[0,1,0,z,z], reducible_primes_naive(E) with default parameters (max_l=1000, num_P=100) returns [2, 607] in 2m, while reducible_primes_naive(E, max_l=2000, num_P=200) returns [2] in about the same time (starting from scratch; if you do the second right after the first it is faster since some previous work is cached).
Working on this example revealed something stupid only indirectly relevant to this ticket:  computing the 2-isogeny takes for ever!  The stupid reason is that after computing the isogenous curve it tries to compute its global_minimal model.  Which involves computing the class group of K.....
That needs fixing somehow but on a different ticket.


---

Comment by git created at 2017-08-04 14:12:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-08-04 14:17:52

The last commit makes several improvements after more testing.  In Billerey's algorithm itself the improvement is to only use B. to find reducible primes greater than some lower bound (default 200) which never occur in practice, using the local test for smaller primes.  Secondly, after noticing that some "easy" examples were taking forever on account of class group computations (which in turn are triggered by the conversion to global minimal models) I added a minimal_models flag which defaults to True to give the old behaviour but which can be set to False.  New doctest to illustrate this are added.  This flag had to be put into dozens of places from the top-level E.isogeny_class() down through various layers to the underlying isogeny code.

I am currently checking that all the additional docstrings compile OK...


---

Comment by cremona created at 2017-08-04 14:18:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-04 15:05:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-08-04 15:05:38

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-08-21 16:43:00

Looks like this need rebasing, or is it only trac's git which is not smart enough?


---

Comment by cremona created at 2017-08-21 18:26:43

I'll rebase. I thought it was based on a recent version but maybe not


---

Comment by git created at 2017-08-22 07:45:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2017-08-22 07:52:15

That took longer than expected.  The rebase was easy but when I tested all of schemes/elliptic_curves there was a long time warning coming from a test in kraus.py, relating to an earlier fix for #20737, marked as 15s but taking a minute (in semi_global_minimal_model()).  I am not sure where the regression came from (not at all to do with this ticket, which in fact makes it possible for semi_global_minimal_model() not to be called when computing isogenies, precisely for the reason that it can take too long when the class group is large).   I did two things which help: first, use prime_range() instead of primes() in the primes_of_bounded_norm methods for number fields, and secondly to use a larger bound when searching for a prime in an ideal class -- since if it fails it doubles the bound, which is of course wasteful since the small ones are re-tested.  If the resulting time (25s for me for this test) is deemed too long we can mark it 'not tested', but it is there precisely because this case is a hard one.


---

Comment by cremona created at 2017-10-05 18:50:47

Aly can you explain the branch change you made on Aug 24 which I only just noticed?  I cannot read your branch (it shows on trac but not as a link) so I don't know what you changed.
----
New commits:


---

Comment by chapoton created at 2017-12-07 15:28:34

branch does not apply


---

Comment by chapoton created at 2017-12-07 15:28:34

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2018-07-10 08:50:00

I have merged in 8.3.rc0, fixed conflicts and checked that all tests pass.  I hope I will not have to do this again a year from now!
----
New commits:


---

Comment by cremona created at 2018-07-10 08:50:00

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-07-10 18:48:34

Please look at my commit, fixing some details about py3:

* using `r"""` for documentation containing latex operators

* do not use `.next`

If you agree with my changes, you can set to positive.. But I do not claim anything about checking the math, so you may want to wait for an expert's opinion.
----
New commits:


---

Comment by cremona created at 2018-07-10 19:03:38

I am happy with your changes.  Thanks. I have discussed the ideas here with people who have not actually looked at the code in detail.  I think the only reasonable thing to do is to get it merged so that it gets used (if there is anyone out there interested).  I have used this a lot in computing isogeny classes of curves for the LMFDB, which is how I found out that the old code in Sage was completely useless over number fields of degree >4.


---

Comment by cremona created at 2018-07-10 19:03:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-11 16:55:06

Resolution: fixed
