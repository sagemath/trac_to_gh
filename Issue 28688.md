# Issue 28688: Modify clean_stale_files to support modularization of sagelib by namespace packages

Issue created by migration from https://trac.sagemath.org/ticket/28925

Original creator: mkoeppe

Original creation time: 2019-12-30 01:31:06

CC:  isuruf embray jdemeyer dimpase dcoudert vdelecroix vbraun @tobiasdiez fbissey

As discussed in #28175 and https://github.com/mkoeppe/sage-numerical-backends-coin/pull/4, it may be useful to modularize sage by the use of namespace packages - See â€‹https://packaging.python.org/guides/packaging-namespace-packages/

One obstacle to using namespace packages is that `src/setup.py` (`clean_stale_files`) deletes unknown files in the installation tree (`$SAGE_LIB/sage` = `..../site-packages/sage`). This would remove installed namespace packages within the `sage` package.


---

Comment by mkoeppe created at 2020-04-14 06:38:06

pushing these forward to 9.2


---

Comment by mkoeppe created at 2020-05-20 04:49:35

New commits:


---

Comment by git created at 2020-05-20 05:11:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-20 05:51:31

Next steps: adjust the cleaner, find Cython sources


---

Comment by mkoeppe created at 2020-05-20 05:55:14

The Cython source finder could perhaps also parse a new directive that controls `OptionalExtension` behavior (until we get rid of `OptionalExtension` altogether in #29701) so that we can get rid of `module_list.py` completely (see #29706)


---

Comment by git created at 2020-05-20 22:36:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-21 04:50:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 00:18:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 00:45:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-02 02:00:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 02:01:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 02:21:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-02 07:07:16

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-02 07:08:25

Next: Fix `find_extra_files` so that it finds the `.pxd` files in `sage.numerical.backends`


---

Comment by git created at 2020-06-03 01:16:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-03 02:03:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-03 02:43:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-03 03:07:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-03 03:35:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-03 03:49:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-10 02:52:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-10 02:52:37

Squashed some commits


---

Comment by git created at 2020-06-10 02:57:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-10 03:05:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-10 03:05:36

Rebased on top of #29701


---

Comment by git created at 2020-07-16 20:09:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-18 02:16:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-08-18 02:24:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-08-18 04:53:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-09 01:38:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-10-16 22:39:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-10-17 00:08:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-10-17 01:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-17 01:57:32

Changing status from new to needs_review.


---

Comment by git created at 2020-10-17 02:19:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-17 04:25:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-17 17:05:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-17 18:14:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-17 18:23:23

Ready for review


---

Comment by git created at 2020-10-17 18:56:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-17 21:54:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-10-18 09:25:33

What's the advantage/reason to introduce the sage-specific namespace/nonamespace convention instead of following PEP 420 and keep the `__init__.py` file as a marker for namespace packages together with `setuptools.find_namespace_packages()`?


---

Comment by mkoeppe created at 2020-10-19 21:31:41

Replying to [comment:84 gh-tobiasdiez]:
> What's the advantage/reason to introduce the sage-specific namespace/nonamespace convention instead of following PEP 420 and keep the `__init__.py` file as a marker for namespace packages together with `setuptools.find_namespace_packages()`?

One **cannot** keep `__init__.py` for native namespace packages. PEP 420 is quite clear about it. Sub-packages of namespace packages do have `__init__.py`; and also the present ticket keeps them.


---

Comment by mkoeppe created at 2020-10-19 21:37:12

`find_namespace_packages` accepts any directory as a package directory:

```
class PEP420PackageFinder(PackageFinder):
    @staticmethod
    def _looks_like_package(path):
        return True
```

(https://github.com/pypa/setuptools/blob/f991fbb3c9d0e10a0a78ae2b508b3fd99f9cdef2/setuptools/__init__.py#L110)

But our source tree has some directories that should not be considered package directories. I have marked these with the `nonamespace` file.

Having both `nonamespace` and `namespace` files results in simpler changes to the existing code.


---

Comment by @tobiasdiez created at 2020-10-19 22:31:51

Oh ok, sorry, I've misunderstood the ticket description. You are of course right, implicit namespace packages don't have a `__init__.py` file.

Concerning the package discovery, I would still prefer using `setuptools.find_namespace_packages()`, and then filter out unwanted folders based on a hard-coded list. The `(no)namespace` files just add complexity (especially for new developers). They are also very similar to the explicit declaration of namespace packages proposed by [PEP 382](https://www.python.org/dev/peps/pep-0382/), which was rejected in favor of PEP 420.

If you do prefer to have these files, I would like to ask you to add documentation to the dev docs.


---

Comment by git created at 2020-10-20 03:16:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-20 03:18:44

Replying to [comment:87 gh-tobiasdiez]:
> Concerning the package discovery, I would still prefer using `setuptools.find_namespace_packages()`, and then filter out unwanted folders based on a hard-coded list. The `(no)namespace` files just add complexity (especially for new developers). They are also very similar to the explicit declaration of namespace packages proposed by [PEP 382](https://www.python.org/dev/peps/pep-0382/), which was rejected in favor of PEP 420.

Thanks for the input and the pointer to PEP 382.
I'll try out if your suggestion can be implemented without major changes.


---

Comment by mkoeppe created at 2020-10-20 03:20:06

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-10-20 03:20:06

TBD: In incremental builds, the cleaner fails to remove previously installed `__init__.py` files:

```
**********************************************************************
File "src/sage_setup/find.py", line 343, in sage_setup.find.installed_files_by_module
Failed example:
    files_by_module['sage.graphs.graph_decompositions']
Expected nothing
Got:
    {'sage/graphs/graph_decompositions/__init__.py',
     'sage/graphs/graph_decompositions/__pycache__/__init__.cpython-37.pyc'}
**********************************************************************
```



---

Comment by mkoeppe created at 2020-10-20 04:57:56

Note that one annoying thing about `find_namespace_packages` when applied to our source tree is that we have lots of directories that do not contain any python files, leading to output like this from distutils:

```
[sagelib-9.2.rc2] package init file 'sage/schemes/generic/notes/__init__.py' not found (or not a regular file)
```

The branch on this ticket handles such directories specially (no need for `nonamespace` files there). If there is a solution that could silence these notes, the code could be brought closer to `find_namespace_packages` behavior.


---

Comment by @tobiasdiez created at 2020-10-20 08:35:29

`find_namespace_packages` excepts `include` and `exclude` directories as arguments. So one option would be to get a list of all folders not including any python files, and pass this as `exclude` (or the same approach using a whitelist).


---

Comment by mkoeppe created at 2020-12-06 17:41:50

Changing keywords from "" to "sd111".


---

Comment by git created at 2020-12-09 05:15:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by git created at 2021-11-26 23:21:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-26 23:29:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-27 22:13:42

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-11 04:42:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-12-11 05:24:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-11 06:05:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-11 06:28:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-16 19:52:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-16 21:52:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-16 22:04:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-16 22:09:47

Replying to [comment:89 mkoeppe]:
> Replying to [comment:87 gh-tobiasdiez]:
> > Concerning the package discovery, I would still prefer using `setuptools.find_namespace_packages()`, and then filter out unwanted folders based on a hard-coded list. The `(no)namespace` files just add complexity (especially for new developers). They are also very similar to the explicit declaration of namespace packages proposed by [PEP 382](https://www.python.org/dev/peps/pep-0382/), which was rejected in favor of PEP 420.
> 
> Thanks for the input and the pointer to PEP 382.
> I'll try out if your suggestion can be implemented without major changes.

Done now via #33033.


---

Comment by mkoeppe created at 2021-12-16 23:46:29

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-12-16 23:47:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-17 00:03:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-12-17 00:04:23

Rebased away from #32927.


---

Comment by git created at 2021-12-17 06:16:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-17 12:45:23

Replying to [comment:115 mkoeppe]:
> Replying to [comment:89 mkoeppe]:
> > Replying to [comment:87 gh-tobiasdiez]:
> > > Concerning the package discovery, I would still prefer using `setuptools.find_namespace_packages()`, and then filter out unwanted folders based on a hard-coded list. The `(no)namespace` files just add complexity (especially for new developers). They are also very similar to the explicit declaration of namespace packages proposed by [PEP 382](https://www.python.org/dev/peps/pep-0382/), which was rejected in favor of PEP 420.
> > 
> > Thanks for the input and the pointer to PEP 382.
> > I'll try out if your suggestion can be implemented without major changes.
> 
> Done now via #33033.

Probably I'm missing something here. The new mechanism seems to still rely on indicator/marker files, just that the are now named `all__`. Except for the different name this seems to be exactly the approach of the rejected PEP 382.
The point of my proposal was that only the setup file should know/decide on which packages it want to include and exclude. Then the general helper in #33033 would like

```
is_namespace_package(dir):
   return dir in setuptools.find_namespace_packages(include=..., exclude=...)
```

And the setup.cfg would use https://setuptools.pypa.io/en/latest/userguide/package_discovery.html.


---

Comment by mkoeppe created at 2021-12-17 16:14:02

Replying to [comment:122 gh-tobiasdiez]:
> The new mechanism seems to still rely on indicator/marker files, just that the are now named `all__`. Except for the different name this seems to be exactly the approach of the rejected PEP 382.

That's certainly true, but at least the Sage source tree already has these files


---

Comment by mkoeppe created at 2021-12-17 16:23:53

Replying to [comment:122 gh-tobiasdiez]:
> The point of my proposal was that only the setup file should know/decide on which packages it want to include and exclude. Then the general helper in #33033 would like
> {{{
> is_namespace_package(dir):
>    return dir in setuptools.find_namespace_packages(include=..., exclude=...)
> }}}

The helper function is added in #33033 for runtime use (doctesting). Doctesting needs to be able to work on (a) Sage source trees, (b) installed Sage packages (this is important, for example, for the downstream packagers), (c) arbitrary files. 
Hardcoding inclusions and exclusions in the helper function seems a bit unmodular


---

Comment by @tobiasdiez created at 2021-12-17 17:56:58

In the end it comes down to who should have the control:
- Should the doctest code decide what to test, and the setup.py/cfg file what to distribute and the sage startup script what to expose
- or should the module/package be responsible to declare that it should be tested, distributed and exposed

Currently, this ticket (and the related ones) go in the direction of the second approach by using `all.py`. For me, using inversion of control and following the first approach seems more natural and flexible. Since you have a better overview though, I trust your judgement.


---

Comment by git created at 2022-01-23 06:24:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 03:33:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 04:13:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 04:47:22

All dependencies are merged


---

Comment by git created at 2022-02-14 06:55:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-22 02:02:52

Changing priority from major to critical.


---

Comment by git created at 2022-03-13 17:46:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-13 18:04:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-29 16:03:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-05 17:34:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-05 17:45:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-05-06 16:37:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-09 18:26:40

The failure in `src/sage/interfaces/expect.py` shown by the patchbot is unrelated.
Ready for review


---

Comment by dimpase created at 2022-05-10 22:19:20

should one `exclude` not only *.so, but *.dylib, too?


---

Comment by mkoeppe created at 2022-05-10 22:26:07

On macOS, the compiled python modules are also .so, not .dylib.


---

Comment by git created at 2022-05-29 23:05:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-08 06:48:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-09 18:54:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-12 18:46:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @GMS103 created at 2022-06-21 13:09:27

Sorry for my ignorance, but I am unable to merge this ticket:

```
% git clone -c core.symlinks=true --branch develop --tags https://github.com/sagemath/sage.git
[...]
% cd sage
% git-trac-merge 28925

#28925
remote branch: u/mkoeppe/modify_find_python_sources__clean_stale_files_to_support_modularization_of_sagelib_by_native_namespace_packages__pep_420_

From git://trac.sagemath.org/sage
 * branch                  u/mkoeppe/modify_find_python_sources__clean_stale_files_to_support_modularization_of_sagelib_by_native_namespace_packages__pep_420_ -> FETCH_HEAD
 * [new branch]            u/mkoeppe/modify_find_python_sources__clean_stale_files_to_support_modularization_of_sagelib_by_native_namespace_packages__pep_420_ -> trac/u/mkoeppe/modify_find_python_sources__clean_stale_files_to_support_modularization_of_sagelib_by_native_namespace_packages__pep_420_

Auto-merging build/pkgs/sage_setup/dependencies
CONFLICT (content): Merge conflict in build/pkgs/sage_setup/dependencies
Automatic merge failed; fix conflicts and then commit the result.
% 
```



---

Comment by git created at 2022-06-25 18:20:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-25 18:20:45

I've resolved the merge conflict


---

Comment by klee created at 2022-06-30 01:22:49

Not used import?

```diff
diff --git a/pkgs/sagemath-objects/setup.py b/pkgs/sagemath-objects/setup.py
index 124f0cb218..907cabef83 100644
--- a/pkgs/sagemath-objects/setup.py
+++ b/pkgs/sagemath-objects/setup.py
@@ -42,7 +42,7 @@ if sdist:
     python_modules = []
     cython_modules = []
 else:
-    from sage_setup.find import find_python_sources, is_package_or_namespace_package_dir
+    from sage_setup.find import find_python_sources
     python_packages, python_modules, cython_modules = find_python_sources(
         '.', ['sage'])   # for now, we do the filtering using MANIFEST
```



---

Comment by git created at 2022-07-01 00:06:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-01 00:07:04

Thanks!

And I have applied the change that left that import unused also to another file.


---

Comment by klee created at 2022-07-01 01:25:38

Thanks. 

Another comment: `clean_install_dir` and `find_extra_files` have a new argument `distributions`, but the docstrings do not explain it.


---

Comment by git created at 2022-07-01 01:49:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-07-04 02:47:24

Thank you for the update.

I have been testing (using) this ticket and and the sequel #33011 for a while. They works well. I checked the code as far as I can (not very far), and it looks good to me. 

If we don't have further comments on this ticket, then it would better be tested by more developers in the wild by merging this now, so that we can fix problems before the next release.

I will wait for your (not Matthias) meta comments, and proceed to "positive review" in a couple of days.


---

Comment by klee created at 2022-07-06 06:39:56

Is this

```
./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'  
```

broken? It doesn't work with (and without) this ticket.


---

Comment by dimpase created at 2022-07-06 09:00:54

Replying to [comment:158 klee]:
> Is this
> {{{
> ./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'  
> }}}
> broken? It doesn't work with (and without) this ticket.

works for me (after `make build` from a clean state done)


---

Comment by klee created at 2022-07-06 09:06:36

Replying to [comment:159 dimpase]:
> Replying to [comment:158 klee]:
> > Is this
> > {{{
> > ./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'  
> > }}}
> > broken? It doesn't work with (and without) this ticket.
> 
> works for me (after `make build` from a clean state done)

I did `make distclean; make -j8; ./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'`. So this is clean.

This is the initial part that goes wrong:

```
sage -t --random-seed=251639358214975434990568781743714015030 --environment=sage.all__sagemath_categories /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/structure/coerce_actions.pyx
**********************************************************************
File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/structure/coerce_actions.pyx", line 58, in sage.structure.coerce_actions.GenericAction.__init__
Failed example:
    M = MatrixSpace(ZZ,2)
Exception raised:
    Traceback (most recent call last):
      File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.coerce_actions.GenericAction.__init__[0]>", line 1, in <module>
        M = MatrixSpace(ZZ,Integer(2))
    NameError: name 'MatrixSpace' is not defined
```

Any clue? I am on Mac.


---

Comment by dimpase created at 2022-07-06 10:28:40

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-07-06 10:28:40

I start from `git clean -fdx` - which cleans much more.

You'll probably want to move `upstream/` outside and after `git clean` make a symbolic link to it, otherwise it will re-download things.

So it's positive review from me.


---

Comment by klee created at 2022-07-06 12:57:46

Replying to [comment:161 dimpase]:
> I start from `git clean -fdx` - which cleans much more.

Thanks. But it didn't help. As far as I understand, the doctest failures are expected. The real problem is:

```python
$ pkgs/sagemath-categories/.tox/py39/bin/python3.9 
Python 3.9.13 (main, May 24 2022, 21:28:31) 
[Clang 13.1.6 (clang-1316.0.21.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.categories.category import Category
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages/sage/categories/category.py", line 107, in <module>
    from sage.misc.c3_controlled import _cmp_key, _cmp_key_named, C3_sorted_merge
  File "sage/misc/c3_controlled.pyx", line 364, in init sage.misc.c3_controlled (build/cythonized/sage/misc/c3_controlled.c:11819)
  File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages/sage/structure/__init__.py", line 2, in <module>
    import sage.structure.element
  File "sage/structure/element.pyx", line 1, in init sage.structure.element (build/cythonized/sage/structure/element.c:36204)
  File "sage/structure/category_object.pyx", line 60, in init sage.structure.category_object (build/cythonized/sage/structure/category_object.c:9982)
ImportError: cannot import name Category
```

Strangely this works 

```python
Hera:sage-dev$ pkgs/sagemath-categories/.tox/py39/bin/python3.9 
Python 3.9.13 (main, May 24 2022, 21:28:31) 
[Clang 13.1.6 (clang-1316.0.21.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.structure.sage_object import SageObject
>>> from sage.categories.category import Category
>>> 
```


Anyway, this is not a problem of this ticket. The situation is the same without this ticket.

Hence my positive review to this ticket!


---

Comment by dimpase created at 2022-07-06 14:10:28

hmm, do you have the current directory, i.e. `.`, in your `PATH`? IMHO this might mess things up.


---

Comment by klee created at 2022-07-06 14:56:25

Replying to [comment:163 dimpase]:
> hmm, do you have the current directory, i.e. `.`, in your `PATH`? IMHO this might mess things up.

Yes. But even after removing it from the path, it's the same. 

`./configure` shows `python3-3.10.3: using system package; SPKG will not be installed`, and


```python
$ pkgs/sagemath-categories/.tox/py39/bin/python3.9 
Python 3.9.13 (main, May 24 2022, 21:28:31) 
[Clang 13.1.6 (clang-1316.0.21.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.path
['', '/usr/local/Cellar/python@3.9/3.9.13_1/Frameworks/Python.framework/Versions/3.9/lib/python39.zip', '/usr/local/Cellar/python@3.9/3.9.13_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9', '/usr/local/Cellar/python@3.9/3.9.13_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/lib-dynload', '/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages']
```


```python
$ pkgs/sagemath-categories/.tox/python/bin/python 
Python 3.10.4 (main, Apr 26 2022, 19:42:59) [Clang 13.1.6 (clang-1316.0.21.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> sys.path
['', '/usr/local/Cellar/python@3.10/3.10.4/Frameworks/Python.framework/Versions/3.10/lib/python310.zip', '/usr/local/Cellar/python@3.10/3.10.4/Frameworks/Python.framework/Versions/3.10/lib/python3.10', '/usr/local/Cellar/python@3.10/3.10.4/Frameworks/Python.framework/Versions/3.10/lib/python3.10/lib-dynload', '/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages']
```



---

Comment by mkoeppe created at 2022-07-06 18:04:16

Replying to [comment:159 dimpase]:
> Replying to [comment:158 klee]:
> > Is this
> > {{{
> > ./sage -sh -c '(cd pkgs/sagemath-categories && tox -v -v -v)'  
> > }}}
> > broken? It doesn't work with (and without) this ticket.
> 
> works for me (after `make build` from a clean state done)

sagemath-categories (in contrast to sagemath-standard) does not need `make build` because all of its build and runtime dependencies can be found on PyPI.


---

Comment by mkoeppe created at 2022-07-06 18:10:27

Replying to [comment:160 klee]:
> This is the initial part that goes wrong:
> {{{
> sage -t --random-seed=251639358214975434990568781743714015030 --environment=sage.all__sagemath_categories /Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/structure/coerce_actions.pyx
> **********************************************************************
> File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/structure/coerce_actions.pyx", line 58, in sage.structure.coerce_actions.GenericAction.__init__
> Failed example:
>     M = MatrixSpace(ZZ,2)
> Exception raised:
>     Traceback (most recent call last):
>       File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/python/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.structure.coerce_actions.GenericAction.__init__[0]>", line 1, in <module>
>         M = MatrixSpace(ZZ,Integer(2))
>     NameError: name 'MatrixSpace' is not defined
> }}}

*sagemath-categories* as of this ticket does not contain src/sage/matrix/matrix_space.py (see `pkgs/sagemath-categories/MANIFEST.in`), so `MatrixSpace` is not available in `sage.all__sagemath_categories`.

Note that the `tox` run ends with the message "lots of doctest failures are expected". This is one of them.


---

Comment by mkoeppe created at 2022-07-06 18:13:13

Replying to [comment:162 klee]:
> The real problem is:
> {{{#!python
> $ pkgs/sagemath-categories/.tox/py39/bin/python3.9 
> Python 3.9.13 (main, May 24 2022, 21:28:31) 
> [Clang 13.1.6 (clang-1316.0.21.2)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> from sage.categories.category import Category
> Traceback (most recent call last):
>   File "<stdin>", line 1, in <module>
>   File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages/sage/categories/category.py", line 107, in <module>
>     from sage.misc.c3_controlled import _cmp_key, _cmp_key_named, C3_sorted_merge
>   File "sage/misc/c3_controlled.pyx", line 364, in init sage.misc.c3_controlled (build/cythonized/sage/misc/c3_controlled.c:11819)
>   File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages/sage/structure/__init__.py", line 2, in <module>
>     import sage.structure.element
>   File "sage/structure/element.pyx", line 1, in init sage.structure.element (build/cythonized/sage/structure/element.c:36204)
>   File "sage/structure/category_object.pyx", line 60, in init sage.structure.category_object (build/cythonized/sage/structure/category_object.c:9982)
> ImportError: cannot import name Category
> }}}
> Strangely this works 
> {{{#!python
> Hera:sage-dev$ pkgs/sagemath-categories/.tox/py39/bin/python3.9 
> Python 3.9.13 (main, May 24 2022, 21:28:31) 
> [Clang 13.1.6 (clang-1316.0.21.2)] on darwin
> Type "help", "copyright", "credits" or "license" for more information.
> >>> from sage.structure.sage_object import SageObject
> >>> from sage.categories.category import Category
> >>> 
> }}}

The Sage library contains many cyclic imports. If one starts at the wrong place in an import cycle, one can run into problems with partially initialized modules. See #33580 (Meta-ticket: make all modules importable without sage.all)


---

Comment by mkoeppe created at 2022-07-06 18:13:36

Thanks both for the review!


---

Comment by klee created at 2022-07-07 04:45:28

Replying to [comment:166 mkoeppe]: 
> Note that the `tox` run ends with the message "lots of doctest failures are expected". 

Yes, it's there. It would perhaps better be colored red or green...


---

Comment by vbraun created at 2022-07-08 21:12:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-07-08 21:12:46

Merge failure on top of:

843eb03e7e Updated [SageMath](SageMath) version to 9.7.beta4



merge was not clean: conflicts in pkgs/sagemath-categories/tox.ini


---

Comment by git created at 2022-07-08 23:35:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-08 23:35:45

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-07-10 22:35:02

Resolution: fixed
