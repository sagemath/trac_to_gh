# Issue 29401: replace tuples by ETuples in free abelian monoids

Issue created by migration from https://trac.sagemath.org/ticket/29638

Original creator: @mwageringel

Original creation time: 2020-05-03 10:23:01

CC:  tscrim

This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents in an `ETuple` instead of a tuple in order to make use of the cythonized arithmetics implemented for `ETuple`. This makes multiplication about twice as fast:


```
M = FreeAbelianMonoid('x', 5)
L = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]
%timeit _ = [a * b for a in L for b in L]
# 1 loop, best of 5: 7.34 s per loop  (before)
# 1 loop, best of 5: 4.07 s per loop  (after)
```


Another motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.


---

Comment by @mwageringel created at 2020-05-03 10:25:17

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-05-03 10:25:17

New commits:


---

Comment by git created at 2020-05-29 20:08:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2020-05-29 20:08:47

Rebased.


---

Comment by chapoton created at 2020-06-04 18:32:05

Looks good, thanks for doing that. Maybe Travis will have a comment ?


---

Comment by tscrim created at 2020-06-04 22:45:00

+1 for moving away from Python code. Did you try using *Z*<sup>n</sup> elements for the backend structure?


---

Comment by tscrim created at 2020-06-04 22:46:04

Well, `mpz` vectors (maybe C arrays?) would perhaps be ideal, but that would need this file to be Cythonized.


---

Comment by chapoton created at 2020-06-05 10:30:19

I am tempted to give a positive review as it is, because it is already a large improvement. Travis, do you agree ? What do you mean by "using Z<sup>n</sup>" ?


---

Comment by tscrim created at 2020-06-05 11:13:46

I am also thinking of giving it a positive review, but I just wanted to see if Markus had tested it before a positive review.

As you know, any free abelian group has a natural isomorphism with *Z*<sup>n</sup> with the ith generator mapping to e<sub>i</sub> with `*` -> `+`, and the monoid naturally lies inside of that. So I was wondering if it has been tested using the corresponding free module code and how that compared. If it hasn't been done, I can write the code to test it.


---

Comment by @mwageringel created at 2020-06-05 18:25:45

No, I have not tried using integer vectors. Though, I imagine that cythonizing the whole file could already give another speedup. I only chose ETuples because it seemed natural, as I sometimes use `FreeAbelianMonoid().algebra()` as a replacement for polynomial rings, as it is in the `ModulesWithBasis` category (maybe this axiom could be added to polynomial rings as well, in the future?).


---

Comment by tscrim created at 2020-06-22 08:27:17

Sorry for not being able to get to this sooner. Here is a version unwrapping the dense integer vectors, with a fair amount of overlap with that implementation. Ideally we would refactor that out, but the lack of multiple inheritance in Cython makes that impossible.

On my machine:

```
1 loop, best of 5: 1.7 s per loop  -- Old

1 loop, best of 5: 282 ms per loop  -- With my branch
```

----
New commits:


---

Comment by @mwageringel created at 2020-06-22 17:46:50

This looks like a decent speedup. Would it be much slower to make `_element_vector` a `Vector_integer_dense` (or a sparse one)? This would avoid much of the duplication. I assume most of the speedup comes from the cythonization and assume the additional function call overhead would be small, but I might be wrong about this.


---

Comment by tscrim created at 2020-06-24 23:07:00

Sorry, I haven't had time yet to try it. It likely will slow it down a little bit because of the extra level of indirection and handling of an extra Element object, but it is worth seeing to reduce the duplication.


---

Comment by tscrim created at 2020-06-30 04:28:52

There is about a 10% slowdown:

```
sage: %timeit _ = [a * b for a in L for b in L]
1 loop, best of 5: 304 ms per loop  -- New branch
```


```
sage: timeit("_ = [a * b for a in L for b in L]", repeat=5)
5 loops, best of 5: 427 ms per loop  -- New branch

5 loops, best of 5: 384 ms per loop  -- Previous branch
```

So it depends on how much you want the extra speed. IMO, the amount of duplication is not significant enough compared to the extra speed. It is just unfortunate that we cannot work around the class hierarchy (and don't have multiple inheritance) to have a common ABC.

Of course, the next step after this would be doing the same treatment for free Abelian groups.
----
New commits:


---

Comment by @mwageringel created at 2020-07-05 12:26:15

Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:


```
sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
```



Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).


---

Comment by @mwageringel created at 2020-07-05 12:26:15

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2020-07-05 23:50:39

Replying to [comment:14 gh-mwageringel]:
> Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:
> 
> {{{
> sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
> sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
> }}}

Strange, I wasn't getting those. I will try again with the latest beta version.

> Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

I think it is coming from the additional redirections and extra temporary objects (probably also the allocation as well).

> By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).

There probably is a benefit from having both a sparse version if someone wants a free abelian monoid (or group) with say 10000 generators and utilize that sparseness. Although I would be a bit surprised if there was a good use case.


---

Comment by tscrim created at 2020-07-06 00:15:43

Nope, I am still not getting those errors. Can you post the traceback of the errors and/or reproduce them locally on your computer?


---

Comment by @mwageringel created at 2020-07-06 18:21:51

The problem can be reproduced like this, for example:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: F._test_elements_eq_symmetric()
free(): invalid pointer
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/home/math/mwagerin/git/sage_compute/src/bin/sage-python: line 2: 756763 Aborted                 (core dumped) sage -python "$@"
```


It can also be obtained like this:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
```


It seems to come from the call to `_Integer_from_mpz` in `_repr_`, but I cannot see anything wrong with it.


---

Comment by git created at 2020-07-06 23:00:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-06 23:02:30

I still cannot reproduce them, but based on your message, that gave me an idea of something to try. Please test this.

I also released there was no `_latex_`, so I quickly added that. There probably should be a common helper function for printing/latexing monomials with various options; I have definitely written a number of these methods in various places...


---

Comment by tscrim created at 2020-07-06 23:03:12

I am also a bit confused why the `_repr_` would be called in those tests too; it is not like it is used in the hash...


---

Comment by @mwageringel created at 2020-07-07 19:24:27

I have rebuilt Sage from scratch, but the problem persists. This is on Ubuntu 20.04.

It can also be reproduced with the `_repr_` directly (I have added sig_on/sig_off):


```
sage: F = FreeAbelianMonoid(6,'b')
sage: [F.an_element()._repr_() for _ in range(30)]
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-bc2f259b5b12> in <module>()
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

<ipython-input-2-bc2f259b5b12> in <listcomp>(.0)
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```


Here is a stack trace for the equality test, which shows that the `_repr_` is used in an error message:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-be4380b2bde6> in <module>()
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

<ipython-input-2-be4380b2bde6> in <genexpr>(.0)
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (build/cythonized/sage/structure/element.c:10160)()
   1115             return (<Element>self)._richcmp_(other, op)
   1116         else:
-> 1117             return coercion_model.richcmp(self, other, op)
   1118
   1119     cpdef _richcmp_(left, right, int op):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19864)()
   1971         # Coerce to a common parent
   1972         try:
-> 1973             x, y = self.canonical_coercion(x, y)
   1974         except (TypeError, NotImplementedError):
   1975             pass

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13208)()
   1391                 self._record_exception()
   1392
-> 1393         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
   1394
   1395

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid.py in __repr__(self)
    203     def __repr__(self):
    204         n = self.__ngens
--> 205         return "Free abelian monoid on %s generators %s"%(n,self.gens())
    206
    207     def __call__(self, x):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2435)()
    192         except AttributeError:
    193             return super().__repr__()
--> 194         result = reprfunc()
    195         if isinstance(result, str):
    196             return result

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```



---

Comment by git created at 2020-07-08 01:28:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-08 01:29:28

I am really perplexed by this. The only difference between this an dense integer vectors is the `_repr_`, which simply unrolls the call to `list`. I feel like this should also fail for you by replacing `F` with `ZZ^5`. I cannot see what the difference is. I made some other changes that I doubt will fix the problem, but are good do have done. Since I don't get the failure, it is really hard to figure this out. `:/` (I am running Ubuntu 18.04 LTS.)


---

Comment by @mwageringel created at 2020-07-08 19:13:58

Yes, the problem indeed exists with ZZ-vectors as well. The compiler gives the warning

```
[sagelib-9.2.beta3] warning: sage/rings/integer.pxd:41:37: Declarations should not be declared inline.
```

so I tried to remove the `inline` from the pxd file (this is the same format as used for `smallInteger` in that file), but it does not change the underlying problem.

However, the following change seems to fix the issue.


```diff
diff --git a/src/sage/rings/integer.pxd b/src/sage/rings/integer.pxd
index e90abd6c1c..778fd1cf7b 100644
--- a/src/sage/rings/integer.pxd
+++ b/src/sage/rings/integer.pxd
@@ -1,4 +1,5 @@
 from sage.libs.gmp.types cimport __mpz_struct, mpz_t, mpz_ptr
+from sage.libs.gmp.mpz cimport mpz_set
 from sage.libs.ntl.types cimport ZZ_c

 from sage.structure.element cimport EuclideanDomainElement, RingElement
@@ -38,7 +39,10 @@ cdef int mpz_set_str_python(mpz_ptr z, char* s, int base) except -1

 cdef Integer smallInteger(long value)

-cdef inline Integer _Integer_from_mpz(mpz_t e)
+cdef inline Integer _Integer_from_mpz(mpz_t e):
+    cdef Integer z = Integer.__new__(Integer)
+    mpz_set(z.value, e)
+    return z

 cdef class int_to_Z(Morphism):
     pass
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index 6ef08a3a5c..d3bd868ec7 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -7480,11 +7480,6 @@ cdef integer(x):
         return x
     return Integer(x)

-cdef inline Integer _Integer_from_mpz(mpz_t e):
-    cdef Integer z = Integer.__new__(Integer)
-    mpz_set(z.value, e)
-    return z
-
 def free_integer_pool():
     cdef int i
     cdef PyObject *o
```


This passes all the tests for me now, but I am still a bit confused about the issue – particularly because it occured with some randomness.


---

Comment by git created at 2020-07-09 01:55:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-09 02:00:53

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-07-09 02:00:53

That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

Anyways, I have pushed the change that works for you. It still works for me as well.


---

Comment by @mwageringel created at 2020-07-10 19:23:09

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2020-07-10 19:23:09

Replying to [comment:26 tscrim]:
> That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

No – just with that branch. Maybe it is a Cython bug, but I do no think I will be able to debug this much further.

> Anyways, I have pushed the change that works for you. It still works for me as well.

Thank you. I think we can move forward with this now, so I am setting this to positive.


---

Comment by vbraun created at 2020-07-12 08:30:42

Resolution: fixed
