# Issue 29401: replace tuples by ETuples in free abelian monoids

archive/issues_029401.json:
```json
{
    "body": "CC:  tscrim\n\nThis ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents in an `ETuple` instead of a tuple in order to make use of the cythonized arithmetics implemented for `ETuple`. This makes multiplication about twice as fast:\n\n\n```\nM = FreeAbelianMonoid('x', 5)\nL = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]\n%timeit _ = [a * b for a in L for b in L]\n# 1 loop, best of 5: 7.34 s per loop  (before)\n# 1 loop, best of 5: 4.07 s per loop  (after)\n```\n\n\nAnother motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29638\n\n",
    "created_at": "2020-05-03T10:23:01Z",
    "labels": [
        "commutative algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "replace tuples by ETuples in free abelian monoids",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29401",
    "user": "@mwageringel"
}
```
CC:  tscrim

This ticket changes the implementation of `FreeAbelianMonoidElement` to store its exponents in an `ETuple` instead of a tuple in order to make use of the cythonized arithmetics implemented for `ETuple`. This makes multiplication about twice as fast:


```
M = FreeAbelianMonoid('x', 5)
L = [M(list(v)) for d in (0..7) for v in IntegerVectors(d, 5)]
%timeit _ = [a * b for a in L for b in L]
# 1 loop, best of 5: 7.34 s per loop  (before)
# 1 loop, best of 5: 4.07 s per loop  (after)
```


Another motivation for this change is to facilitate viewing free abelian monoids as the indexing set of polynomial rings.

Issue created by migration from https://trac.sagemath.org/ticket/29638





---

archive/issue_comments_417122.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-03T10:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417122",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_417123.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-05-03T10:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417123",
    "user": "@mwageringel"
}
```

New commits:



---

archive/issue_comments_417124.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-29T20:08:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417124",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417125.json:
```json
{
    "body": "Rebased.",
    "created_at": "2020-05-29T20:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417125",
    "user": "@mwageringel"
}
```

Rebased.



---

archive/issue_comments_417126.json:
```json
{
    "body": "Looks good, thanks for doing that. Maybe Travis will have a comment ?",
    "created_at": "2020-06-04T18:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417126",
    "user": "chapoton"
}
```

Looks good, thanks for doing that. Maybe Travis will have a comment ?



---

archive/issue_comments_417127.json:
```json
{
    "body": "+1 for moving away from Python code. Did you try using **Z**<sup>n</sup> elements for the backend structure?",
    "created_at": "2020-06-04T22:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417127",
    "user": "tscrim"
}
```

+1 for moving away from Python code. Did you try using **Z**<sup>n</sup> elements for the backend structure?



---

archive/issue_comments_417128.json:
```json
{
    "body": "Well, `mpz` vectors (maybe C arrays?) would perhaps be ideal, but that would need this file to be Cythonized.",
    "created_at": "2020-06-04T22:46:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417128",
    "user": "tscrim"
}
```

Well, `mpz` vectors (maybe C arrays?) would perhaps be ideal, but that would need this file to be Cythonized.



---

archive/issue_comments_417129.json:
```json
{
    "body": "I am tempted to give a positive review as it is, because it is already a large improvement. Travis, do you agree ? What do you mean by \"using Z<sup>n</sup>\" ?",
    "created_at": "2020-06-05T10:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417129",
    "user": "chapoton"
}
```

I am tempted to give a positive review as it is, because it is already a large improvement. Travis, do you agree ? What do you mean by "using Z<sup>n</sup>" ?



---

archive/issue_comments_417130.json:
```json
{
    "body": "I am also thinking of giving it a positive review, but I just wanted to see if Markus had tested it before a positive review.\n\nAs you know, any free abelian group has a natural isomorphism with **Z**<sup>n</sup> with the ith generator mapping to e<sub>i</sub> with `*` -> `+`, and the monoid naturally lies inside of that. So I was wondering if it has been tested using the corresponding free module code and how that compared. If it hasn't been done, I can write the code to test it.",
    "created_at": "2020-06-05T11:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417130",
    "user": "tscrim"
}
```

I am also thinking of giving it a positive review, but I just wanted to see if Markus had tested it before a positive review.

As you know, any free abelian group has a natural isomorphism with **Z**<sup>n</sup> with the ith generator mapping to e<sub>i</sub> with `*` -> `+`, and the monoid naturally lies inside of that. So I was wondering if it has been tested using the corresponding free module code and how that compared. If it hasn't been done, I can write the code to test it.



---

archive/issue_comments_417131.json:
```json
{
    "body": "No, I have not tried using integer vectors. Though, I imagine that cythonizing the whole file could already give another speedup. I only chose ETuples because it seemed natural, as I sometimes use `FreeAbelianMonoid().algebra()` as a replacement for polynomial rings, as it is in the `ModulesWithBasis` category (maybe this axiom could be added to polynomial rings as well, in the future?).",
    "created_at": "2020-06-05T18:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417131",
    "user": "@mwageringel"
}
```

No, I have not tried using integer vectors. Though, I imagine that cythonizing the whole file could already give another speedup. I only chose ETuples because it seemed natural, as I sometimes use `FreeAbelianMonoid().algebra()` as a replacement for polynomial rings, as it is in the `ModulesWithBasis` category (maybe this axiom could be added to polynomial rings as well, in the future?).



---

archive/issue_comments_417132.json:
```json
{
    "body": "Sorry for not being able to get to this sooner. Here is a version unwrapping the dense integer vectors, with a fair amount of overlap with that implementation. Ideally we would refactor that out, but the lack of multiple inheritance in Cython makes that impossible.\n\nOn my machine:\n\n```\n1 loop, best of 5: 1.7 s per loop  -- Old\n\n1 loop, best of 5: 282 ms per loop  -- With my branch\n```\n\n----\nNew commits:",
    "created_at": "2020-06-22T08:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417132",
    "user": "tscrim"
}
```

Sorry for not being able to get to this sooner. Here is a version unwrapping the dense integer vectors, with a fair amount of overlap with that implementation. Ideally we would refactor that out, but the lack of multiple inheritance in Cython makes that impossible.

On my machine:

```
1 loop, best of 5: 1.7 s per loop  -- Old

1 loop, best of 5: 282 ms per loop  -- With my branch
```

----
New commits:



---

archive/issue_comments_417133.json:
```json
{
    "body": "This looks like a decent speedup. Would it be much slower to make `_element_vector` a `Vector_integer_dense` (or a sparse one)? This would avoid much of the duplication. I assume most of the speedup comes from the cythonization and assume the additional function call overhead would be small, but I might be wrong about this.",
    "created_at": "2020-06-22T17:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417133",
    "user": "@mwageringel"
}
```

This looks like a decent speedup. Would it be much slower to make `_element_vector` a `Vector_integer_dense` (or a sparse one)? This would avoid much of the duplication. I assume most of the speedup comes from the cythonization and assume the additional function call overhead would be small, but I might be wrong about this.



---

archive/issue_comments_417134.json:
```json
{
    "body": "Sorry, I haven't had time yet to try it. It likely will slow it down a little bit because of the extra level of indirection and handling of an extra Element object, but it is worth seeing to reduce the duplication.",
    "created_at": "2020-06-24T23:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417134",
    "user": "tscrim"
}
```

Sorry, I haven't had time yet to try it. It likely will slow it down a little bit because of the extra level of indirection and handling of an extra Element object, but it is worth seeing to reduce the duplication.



---

archive/issue_comments_417135.json:
```json
{
    "body": "There is about a 10% slowdown:\n\n```\nsage: %timeit _ = [a * b for a in L for b in L]\n1 loop, best of 5: 304 ms per loop  -- New branch\n```\n\n\n```\nsage: timeit(\"_ = [a * b for a in L for b in L]\", repeat=5)\n5 loops, best of 5: 427 ms per loop  -- New branch\n\n5 loops, best of 5: 384 ms per loop  -- Previous branch\n```\n\nSo it depends on how much you want the extra speed. IMO, the amount of duplication is not significant enough compared to the extra speed. It is just unfortunate that we cannot work around the class hierarchy (and don't have multiple inheritance) to have a common ABC.\n\nOf course, the next step after this would be doing the same treatment for free Abelian groups.\n----\nNew commits:",
    "created_at": "2020-06-30T04:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417135",
    "user": "tscrim"
}
```

There is about a 10% slowdown:

```
sage: %timeit _ = [a * b for a in L for b in L]
1 loop, best of 5: 304 ms per loop  -- New branch
```


```
sage: timeit("_ = [a * b for a in L for b in L]", repeat=5)
5 loops, best of 5: 427 ms per loop  -- New branch

5 loops, best of 5: 384 ms per loop  -- Previous branch
```

So it depends on how much you want the extra speed. IMO, the amount of duplication is not significant enough compared to the extra speed. It is just unfortunate that we cannot work around the class hierarchy (and don't have multiple inheritance) to have a common ABC.

Of course, the next step after this would be doing the same treatment for free Abelian groups.
----
New commits:



---

archive/issue_comments_417136.json:
```json
{
    "body": "Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:\n\n\n```\nsage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort\nsage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort\n```\n\n\n\nOut of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?\n\nBy the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).",
    "created_at": "2020-07-05T12:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417136",
    "user": "@mwageringel"
}
```

Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:


```
sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
```



Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).



---

archive/issue_comments_417137.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-05T12:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417137",
    "user": "@mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417138.json:
```json
{
    "body": "Replying to [comment:14 gh-mwageringel]:\n> Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:\n> \n> {{{\n> sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort\n> sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort\n> }}}\n\nStrange, I wasn't getting those. I will try again with the latest beta version.\n\n> Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?\n\nI think it is coming from the additional redirections and extra temporary objects (probably also the allocation as well).\n\n> By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).\n\nThere probably is a benefit from having both a sparse version if someone wants a free abelian monoid (or group) with say 10000 generators and utilize that sparseness. Although I would be a bit surprised if there was a good use case.",
    "created_at": "2020-07-05T23:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417138",
    "user": "tscrim"
}
```

Replying to [comment:14 gh-mwageringel]:
> Thank you for trying this. I get similar timings on my machine. We should go with the previous branch then, I guess, but there are some errors when running the tests:
> 
> {{{
> sage -t --long src/sage/monoids/free_abelian_monoid.py  # Killed due to abort
> sage -t --long src/sage/monoids/free_abelian_monoid_element.pyx  # Killed due to abort
> }}}

Strange, I wasn't getting those. I will try again with the latest beta version.

> Out of curiosity, is the slowdown with `timeit(..., repeat=5)` caused by deallocation?

I think it is coming from the additional redirections and extra temporary objects (probably also the allocation as well).

> By the way, I have also tried to use `vector_integer_sparse.mpz_vector` which is just a struct, but it is even slower (which is somewhat expected as the elements in the test case are not very sparse).

There probably is a benefit from having both a sparse version if someone wants a free abelian monoid (or group) with say 10000 generators and utilize that sparseness. Although I would be a bit surprised if there was a good use case.



---

archive/issue_comments_417139.json:
```json
{
    "body": "Nope, I am still not getting those errors. Can you post the traceback of the errors and/or reproduce them locally on your computer?",
    "created_at": "2020-07-06T00:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417139",
    "user": "tscrim"
}
```

Nope, I am still not getting those errors. Can you post the traceback of the errors and/or reproduce them locally on your computer?



---

archive/issue_comments_417140.json:
```json
{
    "body": "The problem can be reproduced like this, for example:\n\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: F._test_elements_eq_symmetric()\nfree(): invalid pointer\n------------------------------------------------------------------------\n...\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n/home/math/mwagerin/git/sage_compute/src/bin/sage-python: line 2: 756763 Aborted                 (core dumped) sage -python \"$@\"\n```\n\n\nIt can also be obtained like this:\n\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: any(F.an_element() == 0 for _ in range(10))\nfree(): invalid pointer\n```\n\n\nIt seems to come from the call to `_Integer_from_mpz` in `_repr_`, but I cannot see anything wrong with it.",
    "created_at": "2020-07-06T18:21:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417140",
    "user": "@mwageringel"
}
```

The problem can be reproduced like this, for example:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: F._test_elements_eq_symmetric()
free(): invalid pointer
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/home/math/mwagerin/git/sage_compute/src/bin/sage-python: line 2: 756763 Aborted                 (core dumped) sage -python "$@"
```


It can also be obtained like this:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
```


It seems to come from the call to `_Integer_from_mpz` in `_repr_`, but I cannot see anything wrong with it.



---

archive/issue_comments_417141.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-06T23:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417141",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417142.json:
```json
{
    "body": "I still cannot reproduce them, but based on your message, that gave me an idea of something to try. Please test this.\n\nI also released there was no `_latex_`, so I quickly added that. There probably should be a common helper function for printing/latexing monomials with various options; I have definitely written a number of these methods in various places...",
    "created_at": "2020-07-06T23:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417142",
    "user": "tscrim"
}
```

I still cannot reproduce them, but based on your message, that gave me an idea of something to try. Please test this.

I also released there was no `_latex_`, so I quickly added that. There probably should be a common helper function for printing/latexing monomials with various options; I have definitely written a number of these methods in various places...



---

archive/issue_comments_417143.json:
```json
{
    "body": "I am also a bit confused why the `_repr_` would be called in those tests too; it is not like it is used in the hash...",
    "created_at": "2020-07-06T23:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417143",
    "user": "tscrim"
}
```

I am also a bit confused why the `_repr_` would be called in those tests too; it is not like it is used in the hash...



---

archive/issue_comments_417144.json:
```json
{
    "body": "I have rebuilt Sage from scratch, but the problem persists. This is on Ubuntu 20.04.\n\nIt can also be reproduced with the `_repr_` directly (I have added sig_on/sig_off):\n\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: [F.an_element()._repr_() for _ in range(30)]\nfree(): invalid pointer\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-bc2f259b5b12> in <module>()\n----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]\n\n<ipython-input-2-bc2f259b5b12> in <listcomp>(.0)\n----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()\n    204         cdef Integer val\n    205         for i in range(self._n):\n--> 206             sig_on()\n    207             val = _Integer_from_mpz(v[i])\n    208             sig_off()\n\nRuntimeError: Aborted\n```\n\n\nHere is a stack trace for the equality test, which shows that the `_repr_` is used in an error message:\n\n\n```\nsage: F = FreeAbelianMonoid(6,'b')\nsage: any(F.an_element() == 0 for _ in range(10))\nfree(): invalid pointer\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-be4380b2bde6> in <module>()\n----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))\n\n<ipython-input-2-be4380b2bde6> in <genexpr>(.0)\n----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (build/cythonized/sage/structure/element.c:10160)()\n   1115             return (<Element>self)._richcmp_(other, op)\n   1116         else:\n-> 1117             return coercion_model.richcmp(self, other, op)\n   1118\n   1119     cpdef _richcmp_(left, right, int op):\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19864)()\n   1971         # Coerce to a common parent\n   1972         try:\n-> 1973             x, y = self.canonical_coercion(x, y)\n   1974         except (TypeError, NotImplementedError):\n   1975             pass\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13208)()\n   1391                 self._record_exception()\n   1392\n-> 1393         raise TypeError(\"no common canonical parent for objects with parents: '%s' and '%s'\"%(xp, yp))\n   1394\n   1395\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid.py in __repr__(self)\n    203     def __repr__(self):\n    204         n = self.__ngens\n--> 205         return \"Free abelian monoid on %s generators %s\"%(n,self.gens())\n    206\n    207     def __call__(self, x):\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2435)()\n    192         except AttributeError:\n    193             return super().__repr__()\n--> 194         result = reprfunc()\n    195         if isinstance(result, str):\n    196             return result\n\n/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()\n    204         cdef Integer val\n    205         for i in range(self._n):\n--> 206             sig_on()\n    207             val = _Integer_from_mpz(v[i])\n    208             sig_off()\n\nRuntimeError: Aborted\n```\n",
    "created_at": "2020-07-07T19:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417144",
    "user": "@mwageringel"
}
```

I have rebuilt Sage from scratch, but the problem persists. This is on Ubuntu 20.04.

It can also be reproduced with the `_repr_` directly (I have added sig_on/sig_off):


```
sage: F = FreeAbelianMonoid(6,'b')
sage: [F.an_element()._repr_() for _ in range(30)]
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-bc2f259b5b12> in <module>()
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

<ipython-input-2-bc2f259b5b12> in <listcomp>(.0)
----> 1 [F.an_element()._repr_() for _ in range(Integer(30))]

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```


Here is a stack trace for the equality test, which shows that the `_repr_` is used in an error message:


```
sage: F = FreeAbelianMonoid(6,'b')
sage: any(F.an_element() == 0 for _ in range(10))
free(): invalid pointer
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-be4380b2bde6> in <module>()
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

<ipython-input-2-be4380b2bde6> in <genexpr>(.0)
----> 1 any(F.an_element() == Integer(0) for _ in range(Integer(10)))

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__richcmp__ (build/cythonized/sage/structure/element.c:10160)()
   1115             return (<Element>self)._richcmp_(other, op)
   1116         else:
-> 1117             return coercion_model.richcmp(self, other, op)
   1118
   1119     cpdef _richcmp_(left, right, int op):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19864)()
   1971         # Coerce to a common parent
   1972         try:
-> 1973             x, y = self.canonical_coercion(x, y)
   1974         except (TypeError, NotImplementedError):
   1975             pass

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13208)()
   1391                 self._record_exception()
   1392
-> 1393         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
   1394
   1395

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid.py in __repr__(self)
    203     def __repr__(self):
    204         n = self.__ngens
--> 205         return "Free abelian monoid on %s generators %s"%(n,self.gens())
    206
    207     def __call__(self, x):

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.__repr__ (build/cythonized/sage/structure/sage_object.c:2435)()
    192         except AttributeError:
    193             return super().__repr__()
--> 194         result = reprfunc()
    195         if isinstance(result, str):
    196             return result

/amd/compute/mwagerin/git/sage_compute/local/lib/python3.7/site-packages/sage/monoids/free_abelian_monoid_element.pyx in sage.monoids.free_abelian_monoid_element.FreeAbelianMonoidElement._repr_ (build/cythonized/sage/monoids/free_abelian_monoid_element.c:3749)()
    204         cdef Integer val
    205         for i in range(self._n):
--> 206             sig_on()
    207             val = _Integer_from_mpz(v[i])
    208             sig_off()

RuntimeError: Aborted
```




---

archive/issue_comments_417145.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-08T01:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417145",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417146.json:
```json
{
    "body": "I am really perplexed by this. The only difference between this an dense integer vectors is the `_repr_`, which simply unrolls the call to `list`. I feel like this should also fail for you by replacing `F` with `ZZ^5`. I cannot see what the difference is. I made some other changes that I doubt will fix the problem, but are good do have done. Since I don't get the failure, it is really hard to figure this out. `:/` (I am running Ubuntu 18.04 LTS.)",
    "created_at": "2020-07-08T01:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417146",
    "user": "tscrim"
}
```

I am really perplexed by this. The only difference between this an dense integer vectors is the `_repr_`, which simply unrolls the call to `list`. I feel like this should also fail for you by replacing `F` with `ZZ^5`. I cannot see what the difference is. I made some other changes that I doubt will fix the problem, but are good do have done. Since I don't get the failure, it is really hard to figure this out. `:/` (I am running Ubuntu 18.04 LTS.)



---

archive/issue_comments_417147.json:
```json
{
    "body": "Yes, the problem indeed exists with ZZ-vectors as well. The compiler gives the warning\n\n```\n[sagelib-9.2.beta3] warning: sage/rings/integer.pxd:41:37: Declarations should not be declared inline.\n```\n\nso I tried to remove the `inline` from the pxd file (this is the same format as used for `smallInteger` in that file), but it does not change the underlying problem.\n\nHowever, the following change seems to fix the issue.\n\n\n```diff\ndiff --git a/src/sage/rings/integer.pxd b/src/sage/rings/integer.pxd\nindex e90abd6c1c..778fd1cf7b 100644\n--- a/src/sage/rings/integer.pxd\n+++ b/src/sage/rings/integer.pxd\n@@ -1,4 +1,5 @@\n from sage.libs.gmp.types cimport __mpz_struct, mpz_t, mpz_ptr\n+from sage.libs.gmp.mpz cimport mpz_set\n from sage.libs.ntl.types cimport ZZ_c\n\n from sage.structure.element cimport EuclideanDomainElement, RingElement\n@@ -38,7 +39,10 @@ cdef int mpz_set_str_python(mpz_ptr z, char* s, int base) except -1\n\n cdef Integer smallInteger(long value)\n\n-cdef inline Integer _Integer_from_mpz(mpz_t e)\n+cdef inline Integer _Integer_from_mpz(mpz_t e):\n+    cdef Integer z = Integer.__new__(Integer)\n+    mpz_set(z.value, e)\n+    return z\n\n cdef class int_to_Z(Morphism):\n     pass\ndiff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx\nindex 6ef08a3a5c..d3bd868ec7 100644\n--- a/src/sage/rings/integer.pyx\n+++ b/src/sage/rings/integer.pyx\n@@ -7480,11 +7480,6 @@ cdef integer(x):\n         return x\n     return Integer(x)\n\n-cdef inline Integer _Integer_from_mpz(mpz_t e):\n-    cdef Integer z = Integer.__new__(Integer)\n-    mpz_set(z.value, e)\n-    return z\n-\n def free_integer_pool():\n     cdef int i\n     cdef PyObject *o\n```\n\n\nThis passes all the tests for me now, but I am still a bit confused about the issue \u2013 particularly because it occured with some randomness.",
    "created_at": "2020-07-08T19:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417147",
    "user": "@mwageringel"
}
```

Yes, the problem indeed exists with ZZ-vectors as well. The compiler gives the warning

```
[sagelib-9.2.beta3] warning: sage/rings/integer.pxd:41:37: Declarations should not be declared inline.
```

so I tried to remove the `inline` from the pxd file (this is the same format as used for `smallInteger` in that file), but it does not change the underlying problem.

However, the following change seems to fix the issue.


```diff
diff --git a/src/sage/rings/integer.pxd b/src/sage/rings/integer.pxd
index e90abd6c1c..778fd1cf7b 100644
--- a/src/sage/rings/integer.pxd
+++ b/src/sage/rings/integer.pxd
@@ -1,4 +1,5 @@
 from sage.libs.gmp.types cimport __mpz_struct, mpz_t, mpz_ptr
+from sage.libs.gmp.mpz cimport mpz_set
 from sage.libs.ntl.types cimport ZZ_c

 from sage.structure.element cimport EuclideanDomainElement, RingElement
@@ -38,7 +39,10 @@ cdef int mpz_set_str_python(mpz_ptr z, char* s, int base) except -1

 cdef Integer smallInteger(long value)

-cdef inline Integer _Integer_from_mpz(mpz_t e)
+cdef inline Integer _Integer_from_mpz(mpz_t e):
+    cdef Integer z = Integer.__new__(Integer)
+    mpz_set(z.value, e)
+    return z

 cdef class int_to_Z(Morphism):
     pass
diff --git a/src/sage/rings/integer.pyx b/src/sage/rings/integer.pyx
index 6ef08a3a5c..d3bd868ec7 100644
--- a/src/sage/rings/integer.pyx
+++ b/src/sage/rings/integer.pyx
@@ -7480,11 +7480,6 @@ cdef integer(x):
         return x
     return Integer(x)

-cdef inline Integer _Integer_from_mpz(mpz_t e):
-    cdef Integer z = Integer.__new__(Integer)
-    mpz_set(z.value, e)
-    return z
-
 def free_integer_pool():
     cdef int i
     cdef PyObject *o
```


This passes all the tests for me now, but I am still a bit confused about the issue – particularly because it occured with some randomness.



---

archive/issue_comments_417148.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T01:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417148",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417149.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-09T02:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417149",
    "user": "tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_417150.json:
```json
{
    "body": "That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?\n\nAnyways, I have pushed the change that works for you. It still works for me as well.",
    "created_at": "2020-07-09T02:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417150",
    "user": "tscrim"
}
```

That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

Anyways, I have pushed the change that works for you. It still works for me as well.



---

archive/issue_comments_417151.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-10T19:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417151",
    "user": "@mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_417152.json:
```json
{
    "body": "Replying to [comment:26 tscrim]:\n> That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?\n\nNo \u2013 just with that branch. Maybe it is a Cython bug, but I do no think I will be able to debug this much further.\n\n> Anyways, I have pushed the change that works for you. It still works for me as well.\n\nThank you. I think we can move forward with this now, so I am setting this to positive.",
    "created_at": "2020-07-10T19:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417152",
    "user": "@mwageringel"
}
```

Replying to [comment:26 tscrim]:
> That is a little strange. Is that ZZ vector issue also on 9.2.beta3 or just using this branch?

No – just with that branch. Maybe it is a Cython bug, but I do no think I will be able to debug this much further.

> Anyways, I have pushed the change that works for you. It still works for me as well.

Thank you. I think we can move forward with this now, so I am setting this to positive.



---

archive/issue_comments_417153.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-12T08:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29401",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29401#issuecomment-417153",
    "user": "vbraun"
}
```

Resolution: fixed
