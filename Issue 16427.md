# Issue 16427: Add a finite field implementation using FLINT's fq[_zech] module

Issue created by migration from https://trac.sagemath.org/ticket/16664

Original creator: jpflori

Original creation time: 2014-07-16 13:39:17

CC:  defeo pbruin erousseau

Keywords: flint finite field




---

Comment by jpflori created at 2014-07-16 13:39:47

I've set up something at `u/jpflori/flint_fq`.
Completely incomplete though.


---

Comment by jpflori created at 2014-07-16 13:40:09

New commits:


---

Comment by git created at 2014-07-17 12:28:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-17 12:37:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-17 13:27:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-17 15:02:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-17 15:22:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-17 15:32:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-18 13:42:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-18 13:46:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-07-18 13:48:08

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-07-18 13:48:08

Not thouroughly tested but it at least passes its testsuite.

Comments welcome.


---

Comment by jpflori created at 2014-07-21 15:25:22

I've also pushed another branch including an implem using the fq_nmod type at ``u/jpflori/flint_fq_nmod``.
Note that you'll need a FLINT version including my latest git commits from https://github.com/jpflori/flint2
At least now, FLINT seems to provide implementation faster than PARI for basic arithmetic over all ranges.

Doing the same thing for the fq_zech type should be as easy as for the fq_nmod type.
But there is so much code duplication that it should definitely be templated (that should already be done for the fq and fq_nmod types alone).
And not sure that the fq_zech type will be so useful as we have Givaro.


---

Comment by jpflori created at 2014-07-29 12:21:39

Still depends on git version of FLINT, my changes are now merged upstream.
----
New commits:


---

Comment by jpflori created at 2014-07-29 12:26:38

I'll do the templating stuff in a later tickets.
It really needs more thoughts than what I already did here, especially if I want to convert some other implementations to it.


---

Comment by git created at 2014-08-18 16:47:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-19 12:33:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-19 13:31:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-19 15:48:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-19 19:27:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-21 10:19:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-22 13:30:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-08-29 12:44:24

Needs to be merged.


---

Comment by jdemeyer created at 2014-08-29 12:44:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-01 13:00:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-01 13:04:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-09-01 13:07:03

Should merge cleanly now.

Still needs a git version of FLINT though.


---

Comment by git created at 2014-10-14 16:19:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-15 08:06:04

Could you please explicitly list in "Dependencies" the tickets which are merged in this branch? I'm a bit lost in the git forest.


---

Comment by jdemeyer created at 2014-10-15 08:11:06

I don't really like the fact that `element_flint_fq_nmod.pyx` and `element_flint_fq.pyx` are almost identical. Wouldn't it make sense to implement a common base class for them or use templating techniques?


---

Comment by jdemeyer created at 2014-10-15 08:21:54

Also, be aware of #16983 and #16855 which could potentially conflict.


---

Comment by jpflori created at 2014-10-15 08:42:38

This is really work in progress, so it's not really ready for review.
I thought very hard of templating but it was too much work for the time I had.
Note that the `pari_ffelt` class at least (and maybe the `pari_mod` one) is also very similar, so the templating/common base class should surely cover a wider area.

I'll fill in the dependencies asap.


---

Comment by jdemeyer created at 2014-10-15 08:45:44

Replying to [comment:32 jpflori]:
> This is really work in progress, so it's not really ready for review.
Sure, I just wanted to give some comments based on a first glance.


---

Comment by jdemeyer created at 2014-10-15 08:47:47

Replying to [comment:32 jpflori]:
> Note that the `pari_ffelt` class at least (and maybe the `pari_mod` one) is also very similar, so the templating/common base class should surely cover a wider area.
Perhaps. I noticed you moved some functions to `element_base.pyx` in your branch, could that be made into a separate ticket?


---

Comment by jpflori created at 2014-10-15 08:53:45

Ok, I'll try to do that (because I do agree it would be the good way to go and feel guilty about my dirty commits).
There are also some other things related to the PARI FF implem that I'll try to move out of this ticket.


---

Comment by git created at 2014-10-16 15:01:15

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by jpflori created at 2014-10-16 15:06:06

Groumpf, I accidently merged #17148 and #15015 into this one...
Not really a problem as we'll probably have to wait for a proper FLINT 2.5 for this one, and that should come after the actual MPIR 2.7.0 release.


---

Comment by git created at 2014-10-16 16:29:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-10-17 10:24:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-08 15:58:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-09 11:06:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-12-09 13:59:57

I guess the dependencies are correct now.

Apart from bug fixing and heavy testing, the real question is whether I should try to make some code factoring/templating now.


---

Comment by git created at 2015-01-14 10:13:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-05 11:58:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-06-05 11:59:50

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-05 12:08:58

Like I said before, I still don't like that the `fq` files are almost identical to the `fq_nmod` files.

And instead of writing comments like

```
# JPF: the following should definitely go into element_base.pyx.
```

just do it (on a different ticket please, same for `def rational_reconstruction`


---

Comment by git created at 2015-06-05 12:11:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-06-05 12:58:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-05 13:54:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-06-05 13:54:52

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-07-01 15:13:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-01 15:16:14

`@`Jeroen: where would you put the distutils magic to simplify linking with flint?
In only one pxd file in `src/sage/libs/flint` which is included by all other ones?
Or in each of them?


---

Comment by jdemeyer created at 2015-07-01 15:26:36

Replying to [comment:55 jpflori]:
> `@`Jeroen: where would you put the distutils magic to simplify linking with flint?
> In only one pxd file in `src/sage/libs/flint` which is included by all other ones?
> Or in each of them?

First of all, I would prefer to move all changes to `libs/flint` to a different ticket.

If you want `distutils` magic, I would put it in every `.pxd` file which defines library functions (in practice, this is probably all of them except `types.pxd`).

Note #18837 which makes FLINT-related changes to `module_list.py`. The new ticket should probably depend on #18837.


---

Comment by jdemeyer created at 2015-07-01 15:27:59

Another small comment: you can replace

```
    ctypedef struct X:
        pass
```

by

```
    ctypedef struct X
```



---

Comment by git created at 2015-07-03 08:57:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-03 16:56:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-07-16 12:48:48

Replying to [comment:56 jdemeyer]:
> Replying to [comment:55 jpflori]:
> > `@`Jeroen: where would you put the distutils magic to simplify linking with flint?
> > In only one pxd file in `src/sage/libs/flint` which is included by all other ones?
> > Or in each of them?
> 
> First of all, I would prefer to move all changes to `libs/flint` to a different ticket.
I only add new files needed by this ticket, I'm not sure it would make sense to add these files in another ticket.


---

Comment by jpflori created at 2015-07-16 12:49:36

Ok, there is also a slight modification to `types.h`.


---

Comment by jpflori created at 2015-07-16 12:51:16

Replying to [comment:57 jdemeyer]:
> Another small comment: you can replace
> {{{
>     ctypedef struct X:
>         pass
> }}}
> by
> {{{
>     ctypedef struct X
> }}}
Noted.
Note though that the other types in `types.h` use the syntax with `pass`.
So I'm not sure if we should not modify all of them at once later.


---

Comment by git created at 2015-07-16 12:51:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-17 10:32:09

Replying to [comment:60 jpflori]:
> I only add new files needed by this ticket, I'm not sure it would make sense to add these files in another ticket.

But you were talking about adding `# distutils: libraries = flint`, weren't you? I would suggest to do this on a new ticket. So, when you're changing `libs/flint` anyway, you might as well add the new files too.


---

Comment by jpflori created at 2015-07-17 11:06:38

Replying to [comment:64 jdemeyer]:
> Replying to [comment:60 jpflori]:
> > I only add new files needed by this ticket, I'm not sure it would make sense to add these files in another ticket.
> 
> But you were talking about adding `# distutils: libraries = flint`, weren't you? I would suggest to do this on a new ticket. So, when you're changing `libs/flint` anyway, you might as well add the new files too.
Oh yes, the distutils part should definitely be done elsewhere.


---

Comment by vdelecroix created at 2015-08-10 10:15:00

Hello,

In `_element_constructor_` the following case should not happen

```
if isinstance(x, self.element_class) and x.parent() is self:
```

as if `parent(x)` is `self` then this is catched by the `__call__` of `Parent`. See line 1080-1083 of `parent.pyx`

```
        cdef R = parent_c(x) 
        cdef bint no_extra_args = len(args) == 0 and len(kwds) == 0 
        if R is self and no_extra_args: 
            return x
```


Instead of making `__nonzero__` relies on `is_unit` I would rather implement `__nonzero__` and call it in bot `is_unit` and `is_zero`. BTW for the latter this is what is in `Element.is_zero` by default, so you can even remove it. The reason why is that there is a special slot for `__nonzero__` in Python objects. So the fastest (Python) way to do things should be

```
if not my_element:
    XYZ
```

and not

```
if my_element.is_zero():
    XYZ
```


What are the status of the flint patches? Are there incorporated in flint-2.5? If that is so, it would make sense to first include it into Sage.

Vincent


---

Comment by jpflori created at 2015-08-10 10:26:25

Replying to [comment:66 vdelecroix]:
> Hello,
> 
> In `_element_constructor_` the following case should not happen
> {{{
> if isinstance(x, self.element_class) and x.parent() is self:
> }}}
> as if `parent(x)` is `self` then this is catched by the `__call__` of `Parent`. See line 1080-1083 of `parent.pyx`
> {{{
>         cdef R = parent_c(x) 
>         cdef bint no_extra_args = len(args) == 0 and len(kwds) == 0 
>         if R is self and no_extra_args: 
>             return x
> }}}
> 
> Instead of making `__nonzero__` relies on `is_unit` I would rather implement `__nonzero__` and call it in bot `is_unit` and `is_zero`. BTW for the latter this is what is in `Element.is_zero` by default, so you can even remove it. The reason why is that there is a special slot for `__nonzero__` in Python objects. So the fastest (Python) way to do things should be
> {{{
> if not my_element:
>     XYZ
> }}}
> and not
> {{{
> if my_element.is_zero():
>     XYZ
> }}}
Thanks, I'll have a look at both of these.
Not that the code is mainly cpoied/pasted from the PARI wrapper by Peter Bruin.
I'll also check the PARI wrapper.
Note the PARI wrapper is Python rather than Cython (as we have already have a cython "proxy" for PARI elements).

> 
> What are the status of the flint patches? Are there incorporated in flint-2.5? If that is so, it would make sense to first include it into Sage.
I guess so.
Integrating flint 2.5 first is a good idea anyway.
It will also allow to use the lacking in flint 2.4 fq_div function.
> 
> Vincent


---

Comment by vdelecroix created at 2015-08-10 22:04:37

Replying to [comment:67 jpflori]:
> Replying to [comment:66 vdelecroix]:
> > What are the status of the flint patches? Are there incorporated in flint-2.5? If that is so, it would make sense to first include it into Sage.
> I guess so.
> Integrating flint 2.5 first is a good idea anyway.
> It will also allow to use the lacking in flint 2.4 fq_div function.

This is #19009 (needs review).


---

Comment by vdelecroix created at 2015-08-14 18:31:35

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-08-14 18:31:35

Conflicts with the flint upgrade (#19009).


---

Comment by jdemeyer created at 2015-11-29 21:19:23

Conflicts with 6.10.beta6. If you fix this conflict, I can easily merge #19646.


---

Comment by jpflori created at 2017-06-06 11:49:30

I guess the branch here is now completely broken.
A more current implementation can be found at https://github.com/defeo/ffisom/
