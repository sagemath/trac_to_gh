# Issue 12521: bug in jordan_form(transformation=true) for integer matrices

Issue created by migration from https://trac.sagemath.org/ticket/12693

Original creator: hthomas

Original creation time: 2012-03-19 00:28:55

Assignee: jason, was

Keywords: jordan form


```
sage: M=matrix(((2,2,2),(0,0,0),(-2,-2,-2)))
sage: M.jordan_form(transformation=true) 
(
[0 1|0]            
[0 0|0]  [ 2  1  1]
[---+-]  [ 0  0  0]
[0 0|0], [-2  0 -1]
)
```


If the output from M.jordan_form(transformation=true) is J,P, then we are supposed to have J=P<sup>-1</sup> M P.  The output here is obviously wrong, since P is not invertible (having a zero row).  

If you change the 2's to 1's and the -2's to -1's it works properly.  

This behaviour exists in 4.8 and 5.0beta5.


---

Comment by dsm created at 2012-03-19 00:58:06

Looks like a simple type error somewhere.  Fails for integers, works for rationals:


```

sage: M
[ 2  2  2]
[ 0  0  0]
[-2 -2 -2]
sage: parent(M)
Full MatrixSpace of 3 by 3 dense matrices over Integer Ring
sage: M.jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  1]
[---+-]  [ 0  0  0]
[0 0|0], [-2  0 -1]
)
```


but


```
sage: (M/1).jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  0]
[---+-]  [ 0  0  1]
[0 0|0], [-2  0 -1]
)
sage: parent(M/1)
Full MatrixSpace of 3 by 3 dense matrices over Rational Field
sage: (M/1).jordan_form(transformation=True)
(
[0 1|0]            
[0 0|0]  [ 2  1  0]
[---+-]  [ 0  0  1]
[0 0|0], [-2  0 -1]
)
sage: J, P = (M/1).jordan_form(transformation=True)
sage: J == P**(-1)*M*P
True
```


Will see if I can track it down.


---

Comment by hthomas created at 2012-03-19 01:05:32

Thanks!  And thanks for the quick-and-dirty fix, which will mean I can finish the calculation I was working on!


---

Comment by dsm created at 2012-03-19 03:00:18

I can see what's going on, but I'm not sure what the best way to deal with it is.  For my part I'd probably simply push everything to the fraction field during the base_ring changes of jordan_form() in matrix2.pyx and work with vector spaces over the field instead of free modules over the ring, but not everyone might like that.


Comparing the differences between the code paths for ZZ and QQ, the first divergence seems to come in _jordan_form_vector_in_difference.  Both cases get V= [(1, 0, -1), (0, 1, -1)] and W = [(2, 0, -2), (1, 0, 0)], but in the integer case the resulting W_space is


```
W_space: Free module of degree 3 and rank 2 over Integer Ring
Echelon basis matrix:
[1 0 0]
[0 0 2]
```


i.e. a FreeModule_submodule_pid_with_category (not a FreeModule_submodule_field_with_category, as it would be in QQ) at which point Sage decides (reasonably enough) that (1, 0, -1) isn't in W_space. For comparison, the QQ case gives


```
W_space: Vector space of degree 3 and dimension 2 over Rational Field
Basis matrix:
[1 0 0]
[0 0 1]
```


and it returns (0, 1, -1) instead.  

Good news is that whatever we decide to do should be straightforward.


---

Comment by hthomas created at 2012-03-19 12:40:09

Working over QQ (or, in general, over the fraction field) seems fine to me.  Basically, though, I am not knowledgeable enough to have an opinion.


---

Comment by rbeezer created at 2012-05-26 03:12:04

I cannot see how this routine should be guaranteed to succeed over a ring that is not a field.  And eventually we need to factor the characteristic polynomial over the ring anyway.

So I see no harm into moving to the fraction field now and if there *is* a way to do this over a ring, another patch can attempt that.

Rob


---

Comment by rbeezer created at 2012-05-26 03:12:04

Changing keywords from "jordan form" to "jordan form, sd40.5".


---

Comment by dsm created at 2012-05-26 03:57:12

Okay, here's a draft.  It passes matrix/* doctests but I haven't yet run the full test suite.


---

Attachment

push ring to the field


---

Attachment

push ring to the field


---

Attachment

push ring to the field


---

Comment by rbeezer created at 2012-05-26 05:47:30

Looking good.  I'll be more thorough in the morning.


---

Comment by rbeezer created at 2012-05-27 04:33:28

Reviewer patch


---

Comment by rbeezer created at 2012-05-27 04:37:49

Changing status from new to needs_review.


---

Attachment


---

Comment by rbeezer created at 2012-05-27 04:38:38

Version 3 patch has a positive review from me, my reviewer patch will need a look (from Doug?).


---

Comment by dsm created at 2012-05-27 05:20:56

Okay, the reviewer patch looks good to me.


---

Comment by rbeezer created at 2012-05-27 05:39:18

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-18 10:23:44

Resolution: fixed
