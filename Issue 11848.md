# Issue 11848: major (BLOCKER!) bug probably in matrix_space.py

Issue created by migration from https://trac.sagemath.org/ticket/12020

Original creator: was

Original creation time: 2011-11-13 19:28:23

Assignee: jason, was

CC:  vbraun

Observe this:


```
sage: D=DirichletGroup(20);
sage: g=D[7].extend(400); #order 4 character
sage: M=ModularSymbols(g,2,sign=1).cuspidal_subspace()
sage: N=M.new_subspace()
TypeError                                 Traceback (most recent call last)

/mnt/usb1/scratch/wstein/ref/sage-4.8.alpha2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in _coerce_non_number_field_element_in(self, x)
   5399         except (TypeError, AttributeError), msg:
   5400             pass
-> 5401         raise TypeError, type(x)
   5402 
   5403     def _coerce_from_str(self, x):
TypeError: <type 'NoneType'>
```


Debugging we see that the problem is that this code in matrix_space.py:

```
    479         if entries is None or entries == 0:
    480             if self._copy_zero: # faster to copy than to create a new one.
    481                 return self.zero_matrix().__copy__()
    482             else:
--> 483                 return self.__matrix_class(self, None, coerce=coerce, copy=copy)
```

That None in the last line is then coerced for some reason into a number field (Cyclotomic Field of order 4 and degree) which makes no sense now...   

This page suggests this is a recently introduced bug, since the above worked fine there:  http://ask.sagemath.org/question/147/insufficient-ram-for-computing-newforms


---

Comment by was created at 2011-11-13 19:45:24

I figured this out.  This bug was introduced by #11589 (by Simon King and Martin Albrecht).   Basically the zero_matrix() method's code was "mangled/changed" (?) when being copied into the __init__ method by replacing "0" by "None".  This breaks the code, since there is no reason that None be coercible into a ring R, and I don't think that has to be supported because, e.g., in Python `int(None)` is an error.   Also, this is a weird change since the zero_matrix method in the new code still uses 0. 

Patch coming up.


---

Comment by was created at 2011-11-13 19:49:37

Here is a simple test to reveal the bug.  Small size matrices don't show the bug, probably because of some arbitrary caching parameter in #11589, which is probably why this bug slipped through our test framework (we *really* need a random larger testing framework!):

```
sage: A = MatrixSpace(CyclotomicField(4),60,30)(0)
sage: A.augment(A)
boom!
```



---

Attachment

Same patch with corrected doc formatting


---

Comment by jdemeyer created at 2011-11-14 08:46:29

Changing status from new to needs_review.


---

Comment by malb created at 2011-11-14 12:20:33

I have attached an alternative solution: instead of switching back to `0` instead of `None` make `Matrix_cyclo_dense` deal with `None` properly. The reason we switched to `None` was because this is faster since most (?, perhaps only some) matrix classes do nothing if `None` is passed, while they write 0 along the main diagonal if zero is passed. Of course, one could also fix those matrix classes and switch back to `0`.


---

Comment by jdemeyer created at 2011-11-14 14:00:56

Replying to [comment:5 malb]:
> Of course, one could also fix those matrix classes and switch back to `0`.
I slightly prefer that because it seems safer to me.


---

Comment by vbraun created at 2011-11-14 15:08:40

I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.


---

Comment by jdemeyer created at 2011-11-14 15:49:15

Replying to [comment:7 vbraun]:
> I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.
Especially with such a nice ticket number...

Proposing to close this as "duplicate"


---

Comment by malb created at 2011-11-14 15:52:49

If "this" is "this ticket" then I agree.


---

Comment by was created at 2011-11-14 16:18:07

The fix for #12000 also works for this particular example.    I really hope that all other matrix types (now and in the future) respect this None convention, since they will all have the same problem if we go with the #12000 fix rather than the fix here.  We could add documentation in the file matrix/docs.py that reflects what should happen with None, and we should try to add a test that things work with several different types.


---

Comment by malb created at 2011-11-14 17:09:12

I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.


---

Comment by was created at 2011-11-14 17:17:47

Replying to [comment:11 malb]:
> I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.

Cool.  Great work checking that.  I'm really happy with this now then.


---

Comment by was created at 2011-11-14 17:20:59

I give malb's trac_12020_alt.patch a positive review.    Note that the patch at 12000 by Volker is isomorphic to malb's, except it also has sphinxification of the relevant docstrings (though the rest of the file is pre-sphinx) and a different doctest illustrating the same issue.


---

Comment by was created at 2011-11-14 17:20:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-14 17:25:32

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-11-14 17:25:32

Replying to [comment:13 was]:
> I give malb's trac_12020_alt.patch a positive review.

He just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...


---

Comment by was created at 2011-11-14 17:38:09

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 was]:
> > I give malb's trac_12020_alt.patch a positive review.
> 
> He just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...

Woops --  I agree with not giving this a positive review.  

It would be good to have a test that runs through a large number of base rings.


---

Attachment


---

Comment by malb created at 2011-11-14 18:43:40

I added a comment to docs.py and added a return `if entries is None`. However, since e.g., `GF(7)(None) == 0`} it does not actually fix a bug, just exits slightly faster.


---

Comment by malb created at 2011-11-14 18:43:40

Changing status from needs_work to needs_review.


---

Comment by was created at 2011-11-14 18:51:19

Changing status from needs_review to positive_review.


---

Comment by was created at 2011-11-14 18:51:19

Thanks malb.  It looks great to me.     (And if you want to do something else for Sage-5.0, you could doctest "matrix/benchmark.py: 0% (0 of 29)" from #12024.)


---

Comment by jdemeyer created at 2011-11-14 21:03:39

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-11-14 21:04:13

Reviewer patch adding extra doctests like William suggested, needs_review.


---

Comment by jdemeyer created at 2011-11-14 21:04:13

Changing status from needs_work to needs_review.


---

Comment by was created at 2011-11-14 21:07:33

It would be nice to define a list of 100 (say) various rings in a file in the tests directory.  Then the test could be


```
sage: from sage.tests.examples import commutative_rings0
sage: for R in commutative_rings0: 
         do something
```


Then people could add new rings to that list, and tests all over may benefit.  

And in addition to rings, we could assemble many other lists of examples of objects in that file.

This could be on another ticket.


---

Attachment


---

Comment by jdemeyer created at 2011-11-15 09:08:12

I added Volker's patch from #12000 here.


---

Comment by jdemeyer created at 2011-11-19 12:00:40

*ping* needs review


---

Comment by vbraun created at 2011-11-19 12:35:01

Looks good!


---

Comment by vbraun created at 2011-11-19 12:35:01

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-11-21 10:45:42

Resolution: fixed
