# Issue 11848: major (BLOCKER!) bug probably in matrix_space.py

archive/issues_011848.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  vbraun\n\nObserve this:\n\n\n```\nsage: D=DirichletGroup(20);\nsage: g=D[7].extend(400); #order 4 character\nsage: M=ModularSymbols(g,2,sign=1).cuspidal_subspace()\nsage: N=M.new_subspace()\nTypeError                                 Traceback (most recent call last)\n\n/mnt/usb1/scratch/wstein/ref/sage-4.8.alpha2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in _coerce_non_number_field_element_in(self, x)\n   5399         except (TypeError, AttributeError), msg:\n   5400             pass\n-> 5401         raise TypeError, type(x)\n   5402 \n   5403     def _coerce_from_str(self, x):\nTypeError: <type 'NoneType'>\n```\n\n\nDebugging we see that the problem is that this code in matrix_space.py:\n\n```\n    479         if entries is None or entries == 0:\n    480             if self._copy_zero: # faster to copy than to create a new one.\n    481                 return self.zero_matrix().__copy__()\n    482             else:\n--> 483                 return self.__matrix_class(self, None, coerce=coerce, copy=copy)\n```\n\nThat None in the last line is then coerced for some reason into a number field (Cyclotomic Field of order 4 and degree) which makes no sense now...   \n\nThis page suggests this is a recently introduced bug, since the above worked fine there:  http://ask.sagemath.org/question/147/insufficient-ram-for-computing-newforms\n\nIssue created by migration from https://trac.sagemath.org/ticket/12020\n\n",
    "created_at": "2011-11-13T19:28:23Z",
    "labels": [
        "linear algebra",
        "blocker",
        "bug"
    ],
    "title": "major (BLOCKER!) bug probably in matrix_space.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11848",
    "user": "was"
}
```
Assignee: jason, was

CC:  vbraun

Observe this:


```
sage: D=DirichletGroup(20);
sage: g=D[7].extend(400); #order 4 character
sage: M=ModularSymbols(g,2,sign=1).cuspidal_subspace()
sage: N=M.new_subspace()
TypeError                                 Traceback (most recent call last)

/mnt/usb1/scratch/wstein/ref/sage-4.8.alpha2-sage.math.washington.edu-x86_64-Linux/local/lib/python2.6/site-packages/sage/rings/number_field/number_field.pyc in _coerce_non_number_field_element_in(self, x)
   5399         except (TypeError, AttributeError), msg:
   5400             pass
-> 5401         raise TypeError, type(x)
   5402 
   5403     def _coerce_from_str(self, x):
TypeError: <type 'NoneType'>
```


Debugging we see that the problem is that this code in matrix_space.py:

```
    479         if entries is None or entries == 0:
    480             if self._copy_zero: # faster to copy than to create a new one.
    481                 return self.zero_matrix().__copy__()
    482             else:
--> 483                 return self.__matrix_class(self, None, coerce=coerce, copy=copy)
```

That None in the last line is then coerced for some reason into a number field (Cyclotomic Field of order 4 and degree) which makes no sense now...   

This page suggests this is a recently introduced bug, since the above worked fine there:  http://ask.sagemath.org/question/147/insufficient-ram-for-computing-newforms

Issue created by migration from https://trac.sagemath.org/ticket/12020





---

archive/issue_comments_135614.json:
```json
{
    "body": "I figured this out.  This bug was introduced by #11589 (by Simon King and Martin Albrecht).   Basically the zero_matrix() method's code was \"mangled/changed\" (?) when being copied into the __init__ method by replacing \"0\" by \"None\".  This breaks the code, since there is no reason that None be coercible into a ring R, and I don't think that has to be supported because, e.g., in Python `int(None)` is an error.   Also, this is a weird change since the zero_matrix method in the new code still uses 0. \n\nPatch coming up.",
    "created_at": "2011-11-13T19:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135614",
    "user": "was"
}
```

I figured this out.  This bug was introduced by #11589 (by Simon King and Martin Albrecht).   Basically the zero_matrix() method's code was "mangled/changed" (?) when being copied into the __init__ method by replacing "0" by "None".  This breaks the code, since there is no reason that None be coercible into a ring R, and I don't think that has to be supported because, e.g., in Python `int(None)` is an error.   Also, this is a weird change since the zero_matrix method in the new code still uses 0. 

Patch coming up.



---

archive/issue_comments_135615.json:
```json
{
    "body": "Here is a simple test to reveal the bug.  Small size matrices don't show the bug, probably because of some arbitrary caching parameter in #11589, which is probably why this bug slipped through our test framework (we *really* need a random larger testing framework!):\n\n```\nsage: A = MatrixSpace(CyclotomicField(4),60,30)(0)\nsage: A.augment(A)\nboom!\n```\n",
    "created_at": "2011-11-13T19:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135615",
    "user": "was"
}
```

Here is a simple test to reveal the bug.  Small size matrices don't show the bug, probably because of some arbitrary caching parameter in #11589, which is probably why this bug slipped through our test framework (we *really* need a random larger testing framework!):

```
sage: A = MatrixSpace(CyclotomicField(4),60,30)(0)
sage: A.augment(A)
boom!
```




---

archive/issue_comments_135616.json:
```json
{
    "body": "Attachment [trac_12020.2.patch](tarball://root/attachments/some-uuid/ticket12020/trac_12020.2.patch) by jdemeyer created at 2011-11-14 08:44:08\n\nSame patch with corrected doc formatting",
    "created_at": "2011-11-14T08:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135616",
    "user": "jdemeyer"
}
```

Attachment [trac_12020.2.patch](tarball://root/attachments/some-uuid/ticket12020/trac_12020.2.patch) by jdemeyer created at 2011-11-14 08:44:08

Same patch with corrected doc formatting



---

archive/issue_comments_135617.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-14T08:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135617",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_135618.json:
```json
{
    "body": "I have attached an alternative solution: instead of switching back to `0` instead of `None` make `Matrix_cyclo_dense` deal with `None` properly. The reason we switched to `None` was because this is faster since most (?, perhaps only some) matrix classes do nothing if `None` is passed, while they write 0 along the main diagonal if zero is passed. Of course, one could also fix those matrix classes and switch back to `0`.",
    "created_at": "2011-11-14T12:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135618",
    "user": "malb"
}
```

I have attached an alternative solution: instead of switching back to `0` instead of `None` make `Matrix_cyclo_dense` deal with `None` properly. The reason we switched to `None` was because this is faster since most (?, perhaps only some) matrix classes do nothing if `None` is passed, while they write 0 along the main diagonal if zero is passed. Of course, one could also fix those matrix classes and switch back to `0`.



---

archive/issue_comments_135619.json:
```json
{
    "body": "Replying to [comment:5 malb]:\n> Of course, one could also fix those matrix classes and switch back to `0`.\nI slightly prefer that because it seems safer to me.",
    "created_at": "2011-11-14T14:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135619",
    "user": "jdemeyer"
}
```

Replying to [comment:5 malb]:
> Of course, one could also fix those matrix classes and switch back to `0`.
I slightly prefer that because it seems safer to me.



---

archive/issue_comments_135620.json:
```json
{
    "body": "I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.",
    "created_at": "2011-11-14T15:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135620",
    "user": "vbraun"
}
```

I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.



---

archive/issue_comments_135621.json:
```json
{
    "body": "Replying to [comment:7 vbraun]:\n> I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.\nEspecially with such a nice ticket number...\n\nProposing to close this as \"duplicate\"",
    "created_at": "2011-11-14T15:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135621",
    "user": "jdemeyer"
}
```

Replying to [comment:7 vbraun]:
> I found and fixed this bug earlier in #12000. Of course nobody ever reviews my patches, sniff.
Especially with such a nice ticket number...

Proposing to close this as "duplicate"



---

archive/issue_comments_135622.json:
```json
{
    "body": "If \"this\" is \"this ticket\" then I agree.",
    "created_at": "2011-11-14T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135622",
    "user": "malb"
}
```

If "this" is "this ticket" then I agree.



---

archive/issue_comments_135623.json:
```json
{
    "body": "The fix for #12000 also works for this particular example.    I really hope that all other matrix types (now and in the future) respect this None convention, since they will all have the same problem if we go with the #12000 fix rather than the fix here.  We could add documentation in the file matrix/docs.py that reflects what should happen with None, and we should try to add a test that things work with several different types.",
    "created_at": "2011-11-14T16:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135623",
    "user": "was"
}
```

The fix for #12000 also works for this particular example.    I really hope that all other matrix types (now and in the future) respect this None convention, since they will all have the same problem if we go with the #12000 fix rather than the fix here.  We could add documentation in the file matrix/docs.py that reflects what should happen with None, and we should try to add a test that things work with several different types.



---

archive/issue_comments_135624.json:
```json
{
    "body": "I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.",
    "created_at": "2011-11-14T17:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135624",
    "user": "malb"
}
```

I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.



---

archive/issue_comments_135625.json:
```json
{
    "body": "Replying to [comment:11 malb]:\n> I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.\n\nCool.  Great work checking that.  I'm really happy with this now then.",
    "created_at": "2011-11-14T17:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135625",
    "user": "was"
}
```

Replying to [comment:11 malb]:
> I checked the `__init__` methods of all pyx files in sage/matrix/ and found one which doesn't treat `entries==None` properly: `matrix_modn_sparse.pyx`, so this one should get fixed. Note that all others explicitly support `entries==None` and many do nothing when it is passed, i.e., it's the explicit fast path.

Cool.  Great work checking that.  I'm really happy with this now then.



---

archive/issue_comments_135626.json:
```json
{
    "body": "I give malb's trac_12020_alt.patch a positive review.    Note that the patch at 12000 by Volker is isomorphic to malb's, except it also has sphinxification of the relevant docstrings (though the rest of the file is pre-sphinx) and a different doctest illustrating the same issue.",
    "created_at": "2011-11-14T17:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135626",
    "user": "was"
}
```

I give malb's trac_12020_alt.patch a positive review.    Note that the patch at 12000 by Volker is isomorphic to malb's, except it also has sphinxification of the relevant docstrings (though the rest of the file is pre-sphinx) and a different doctest illustrating the same issue.



---

archive/issue_comments_135627.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-11-14T17:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135627",
    "user": "was"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_135628.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-11-14T17:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135628",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_135629.json:
```json
{
    "body": "Replying to [comment:13 was]:\n> I give malb's trac_12020_alt.patch a positive review.\n\nHe just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...",
    "created_at": "2011-11-14T17:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135629",
    "user": "jdemeyer"
}
```

Replying to [comment:13 was]:
> I give malb's trac_12020_alt.patch a positive review.

He just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...



---

archive/issue_comments_135630.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> Replying to [comment:13 was]:\n> > I give malb's trac_12020_alt.patch a positive review.\n> \n> He just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...\n\nWoops --  I agree with not giving this a positive review.  \n\nIt would be good to have a test that runs through a large number of base rings.",
    "created_at": "2011-11-14T17:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135630",
    "user": "was"
}
```

Replying to [comment:14 jdemeyer]:
> Replying to [comment:13 was]:
> > I give malb's trac_12020_alt.patch a positive review.
> 
> He just said that `matrix_modn_sparse.pyx` is also broken (and not yet fixed by the patch here)...

Woops --  I agree with not giving this a positive review.  

It would be good to have a test that runs through a large number of base rings.



---

archive/issue_comments_135631.json:
```json
{
    "body": "Attachment [trac_12020_alt.patch](tarball://root/attachments/some-uuid/ticket12020/trac_12020_alt.patch) by malb created at 2011-11-14 18:41:30",
    "created_at": "2011-11-14T18:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135631",
    "user": "malb"
}
```

Attachment [trac_12020_alt.patch](tarball://root/attachments/some-uuid/ticket12020/trac_12020_alt.patch) by malb created at 2011-11-14 18:41:30



---

archive/issue_comments_135632.json:
```json
{
    "body": "I added a comment to docs.py and added a return `if entries is None`. However, since e.g., `GF(7)(None) == 0`} it does not actually fix a bug, just exits slightly faster.",
    "created_at": "2011-11-14T18:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135632",
    "user": "malb"
}
```

I added a comment to docs.py and added a return `if entries is None`. However, since e.g., `GF(7)(None) == 0`} it does not actually fix a bug, just exits slightly faster.



---

archive/issue_comments_135633.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-11-14T18:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135633",
    "user": "malb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_135634.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-11-14T18:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135634",
    "user": "was"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_135635.json:
```json
{
    "body": "Thanks malb.  It looks great to me.     (And if you want to do something else for Sage-5.0, you could doctest \"matrix/benchmark.py: 0% (0 of 29)\" from #12024.)",
    "created_at": "2011-11-14T18:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135635",
    "user": "was"
}
```

Thanks malb.  It looks great to me.     (And if you want to do something else for Sage-5.0, you could doctest "matrix/benchmark.py: 0% (0 of 29)" from #12024.)



---

archive/issue_comments_135636.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-11-14T21:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135636",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_135637.json:
```json
{
    "body": "Reviewer patch adding extra doctests like William suggested, needs_review.",
    "created_at": "2011-11-14T21:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135637",
    "user": "jdemeyer"
}
```

Reviewer patch adding extra doctests like William suggested, needs_review.



---

archive/issue_comments_135638.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-11-14T21:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135638",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_135639.json:
```json
{
    "body": "It would be nice to define a list of 100 (say) various rings in a file in the tests directory.  Then the test could be\n\n\n```\nsage: from sage.tests.examples import commutative_rings0\nsage: for R in commutative_rings0: \n         do something\n```\n\n\nThen people could add new rings to that list, and tests all over may benefit.  \n\nAnd in addition to rings, we could assemble many other lists of examples of objects in that file.\n\nThis could be on another ticket.",
    "created_at": "2011-11-14T21:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135639",
    "user": "was"
}
```

It would be nice to define a list of 100 (say) various rings in a file in the tests directory.  Then the test could be


```
sage: from sage.tests.examples import commutative_rings0
sage: for R in commutative_rings0: 
         do something
```


Then people could add new rings to that list, and tests all over may benefit.  

And in addition to rings, we could assemble many other lists of examples of objects in that file.

This could be on another ticket.



---

archive/issue_comments_135640.json:
```json
{
    "body": "Attachment [12020_review.patch](tarball://root/attachments/some-uuid/ticket12020/12020_review.patch) by jdemeyer created at 2011-11-15 09:06:54",
    "created_at": "2011-11-15T09:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135640",
    "user": "jdemeyer"
}
```

Attachment [12020_review.patch](tarball://root/attachments/some-uuid/ticket12020/12020_review.patch) by jdemeyer created at 2011-11-15 09:06:54



---

archive/issue_comments_135641.json:
```json
{
    "body": "I added Volker's patch from #12000 here.",
    "created_at": "2011-11-15T09:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135641",
    "user": "jdemeyer"
}
```

I added Volker's patch from #12000 here.



---

archive/issue_comments_135642.json:
```json
{
    "body": "*ping* needs review",
    "created_at": "2011-11-19T12:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135642",
    "user": "jdemeyer"
}
```

*ping* needs review



---

archive/issue_comments_135643.json:
```json
{
    "body": "Looks good!",
    "created_at": "2011-11-19T12:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135643",
    "user": "vbraun"
}
```

Looks good!



---

archive/issue_comments_135644.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-11-19T12:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135644",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_135645.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-11-21T10:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11848",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11848#issuecomment-135645",
    "user": "jdemeyer"
}
```

Resolution: fixed
