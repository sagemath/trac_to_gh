# Issue 25776: lots of warnings when uninstalling spkgs

archive/issues_025776.json:
```json
{
    "body": "CC:  @jdemeyer @embray\n\nWhen upgrading Sage from 8.3.rc2 to 8.4.beta0: `mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0.log`:\n\n```\nUninstalling existing 'mpir'\nWarning: File '/share/info/dir' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info-1' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info-2' not found\nWarning: Directory '/share/info' not found\nWarning: File '/include/gmp.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/gmpxx.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/mpir.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/mpirxx.h' not found\nWarning: Directory '/include' not found\nWarning: File '/lib/libgmp.23.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmp.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmp.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.8.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.23.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.8.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.dylib' not found\nWarning: Directory '/lib' not found\n```\n\n`mpc-1.1.0.log`:\n\n```\nUninstalling existing 'mpc'\nWarning: File '/share/info/dir' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpc.info' not found\nWarning: Directory '/share/info' not found\nWarning: File '/include/mpc.h' not found\nWarning: Directory '/include' not found\nWarning: File '/lib/libmpc.3.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpc.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpc.dylib' not found\nWarning: Directory '/lib' not found\n```\n\nand similarly in many other log files. As far as I can tell, files are not being uninstalled before the new versions are built. Is the problem just that the path names should have `SAGE_LOCAL` prepended?\n\nIssue created by migration from https://trac.sagemath.org/ticket/26013\n\n",
    "created_at": "2018-08-06T20:08:08Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "lots of warnings when uninstalling spkgs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25776",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @jdemeyer @embray

When upgrading Sage from 8.3.rc2 to 8.4.beta0: `mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0.log`:

```
Uninstalling existing 'mpir'
Warning: File '/share/info/dir' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info-1' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info-2' not found
Warning: Directory '/share/info' not found
Warning: File '/include/gmp.h' not found
Warning: Directory '/include' not found
Warning: File '/include/gmpxx.h' not found
Warning: Directory '/include' not found
Warning: File '/include/mpir.h' not found
Warning: Directory '/include' not found
Warning: File '/include/mpirxx.h' not found
Warning: Directory '/include' not found
Warning: File '/lib/libgmp.23.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmp.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmp.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.8.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.23.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.8.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.dylib' not found
Warning: Directory '/lib' not found
```

`mpc-1.1.0.log`:

```
Uninstalling existing 'mpc'
Warning: File '/share/info/dir' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpc.info' not found
Warning: Directory '/share/info' not found
Warning: File '/include/mpc.h' not found
Warning: Directory '/include' not found
Warning: File '/lib/libmpc.3.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpc.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpc.dylib' not found
Warning: Directory '/lib' not found
```

and similarly in many other log files. As far as I can tell, files are not being uninstalled before the new versions are built. Is the problem just that the path names should have `SAGE_LOCAL` prepended?

Issue created by migration from https://trac.sagemath.org/ticket/26013





---

archive/issue_comments_363486.json:
```json
{
    "body": "Replying to [ticket:26013 jhpalmieri]:\n> Is the problem just that the path names should have `SAGE_LOCAL` prepended?\n\nIndeed. However, it works for me.",
    "created_at": "2018-08-07T06:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363486",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:26013 jhpalmieri]:
> Is the problem just that the path names should have `SAGE_LOCAL` prepended?

Indeed. However, it works for me.



---

archive/issue_comments_363487.json:
```json
{
    "body": "It happens on two different machines. Maybe something is broken. I added some print statements, and they do not clarify things. Here is the change I made:\n\n```diff\ndiff --git a/build/sage_bootstrap/uninstall.py b/build/sage_bootstrap/uninstall.py\nindex 94a1203f0b..ed00ceac46 100644\n--- a/build/sage_bootstrap/uninstall.py\n+++ b/build/sage_bootstrap/uninstall.py\n@@ -187,7 +187,10 @@ def modern_uninstall(spkg_name, sage_local, files, verbose=False):\n     # Remove the files; if a directory is empty after removing a file\n     # from it, remove the directory too.\n     for filename in files:\n+        print(\"  * sage_local = {}\".format(sage_local))\n+        print(\"  * orig filename = {}\".format(filename))\n         filename = pth.join(sage_local, filename)\n+        print(\"  ** new filename = {}\".format(filename))\n         dirname = pth.dirname(filename)\n         if os.path.exists(filename):\n             if verbose:\n```\n\nHere is typical output:\n\n```\nUninstalling existing 'glpk'\n  * sage_local = /Users/jpalmier/Desktop/Sage_stuff/git/sage/local\n  * orig filename = /bin/glpsol\n  ** new filename = /bin/glpsol\n```\n\nI don't understand.",
    "created_at": "2018-08-07T16:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363487",
    "user": "https://github.com/jhpalmieri"
}
```

It happens on two different machines. Maybe something is broken. I added some print statements, and they do not clarify things. Here is the change I made:

```diff
diff --git a/build/sage_bootstrap/uninstall.py b/build/sage_bootstrap/uninstall.py
index 94a1203f0b..ed00ceac46 100644
--- a/build/sage_bootstrap/uninstall.py
+++ b/build/sage_bootstrap/uninstall.py
@@ -187,7 +187,10 @@ def modern_uninstall(spkg_name, sage_local, files, verbose=False):
     # Remove the files; if a directory is empty after removing a file
     # from it, remove the directory too.
     for filename in files:
+        print("  * sage_local = {}".format(sage_local))
+        print("  * orig filename = {}".format(filename))
         filename = pth.join(sage_local, filename)
+        print("  ** new filename = {}".format(filename))
         dirname = pth.dirname(filename)
         if os.path.exists(filename):
             if verbose:
```

Here is typical output:

```
Uninstalling existing 'glpk'
  * sage_local = /Users/jpalmier/Desktop/Sage_stuff/git/sage/local
  * orig filename = /bin/glpsol
  ** new filename = /bin/glpsol
```

I don't understand.



---

archive/issue_comments_363488.json:
```json
{
    "body": "Oh, I do understand. From the [documentation for os.path.join](https://docs.python.org/2/library/os.path.html#os.path.join):\n\n```\nIf a component is an absolute path, all previous components are thrown away and joining continues from the absolute path component.\n```\n\nSo we need to strip `os.sep` from the left end of `filename`.",
    "created_at": "2018-08-07T16:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363488",
    "user": "https://github.com/jhpalmieri"
}
```

Oh, I do understand. From the [documentation for os.path.join](https://docs.python.org/2/library/os.path.html#os.path.join):

```
If a component is an absolute path, all previous components are thrown away and joining continues from the absolute path component.
```

So we need to strip `os.sep` from the left end of `filename`.



---

archive/issue_comments_363489.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-08-08T03:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363489",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_363490.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-08T03:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363490",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_363491.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-08T03:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363491",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363492.json:
```json
{
    "body": "Some other OSX users have pointed this issue out before, but I could never figure out why it was happening.  Let me look into this a bit more for a sec because there *shouldn't* be absolute paths in those filenames in the first place.  They should be written as relative paths.  For example I have:\n\n\n```\n$ cat local/var/lib/sage/installed/mpc-1.1.0\n{\n    \"package_name\": \"mpc\",\n    \"package_version\": \"1.1.0\",\n    \"install_date\": \"Thu Jul 19 08:10:31 UTC 2018\",\n    \"system_uname\": \"Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\",\n    \"sage_version\": \"SageMath version 8.3.rc1, Release Date: 2018-07-14\",\n    \"test_result\": \"\",\n    \"files\": [\n        \"include/mpc.h\",\n        \"lib/libmpc.a\",\n        \"lib/libmpc.so\",\n        \"lib/libmpc.so.3\",\n        \"lib/libmpc.so.3.1.0\",\n        \"share/info/dir\",\n        \"share/info/mpc.info\"\n    ]\n}\n```\n\n\nDo you see absolute paths being written into those files?",
    "created_at": "2018-08-08T11:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363492",
    "user": "https://github.com/embray"
}
```

Some other OSX users have pointed this issue out before, but I could never figure out why it was happening.  Let me look into this a bit more for a sec because there *shouldn't* be absolute paths in those filenames in the first place.  They should be written as relative paths.  For example I have:


```
$ cat local/var/lib/sage/installed/mpc-1.1.0
{
    "package_name": "mpc",
    "package_version": "1.1.0",
    "install_date": "Thu Jul 19 08:10:31 UTC 2018",
    "system_uname": "Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux",
    "sage_version": "SageMath version 8.3.rc1, Release Date: 2018-07-14",
    "test_result": "",
    "files": [
        "include/mpc.h",
        "lib/libmpc.a",
        "lib/libmpc.so",
        "lib/libmpc.so.3",
        "lib/libmpc.so.3.1.0",
        "share/info/dir",
        "share/info/mpc.info"
    ]
}
```


Do you see absolute paths being written into those files?



---

archive/issue_comments_363493.json:
```json
{
    "body": "Unfortunately the OSX machine I used to have access to appears to be down, and everyone here is on vacation...",
    "created_at": "2018-08-08T11:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363493",
    "user": "https://github.com/embray"
}
```

Unfortunately the OSX machine I used to have access to appears to be down, and everyone here is on vacation...



---

archive/issue_comments_363494.json:
```json
{
    "body": "The relevant code is in `sage-spkg` (yet more reason this should probably be rewritten in Python as it is growing in complexity, though as Jeroen wrote elsewhere it would be a tedious task...).  A summarized version is as follows:\n\n\n```\nPREFIX=\"${SAGE_DESTDIR_LOCAL%/}/\"\nold_IFS=\"$IFS\"; IFS=$'\\n'\nfor filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n    filename=\"${filename#$PREFIX}\"\n    echo \"$filename\"\ndone\n```\n\n\nin the above, `$PREFIX` should end with a `/`, and `${filename#$PREFIX}` should have the effect of stripping `$PREFIX` (up to and including the final `/`) from the front of `$filename`.  But maybe there's a bug or some other subtlety with that I was unaware of.",
    "created_at": "2018-08-08T11:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363494",
    "user": "https://github.com/embray"
}
```

The relevant code is in `sage-spkg` (yet more reason this should probably be rewritten in Python as it is growing in complexity, though as Jeroen wrote elsewhere it would be a tedious task...).  A summarized version is as follows:


```
PREFIX="${SAGE_DESTDIR_LOCAL%/}/"
old_IFS="$IFS"; IFS=$'\n'
for filename in $(find "$PREFIX" -type f -o -type l | sort); do
    filename="${filename#$PREFIX}"
    echo "$filename"
done
```


in the above, `$PREFIX` should end with a `/`, and `${filename#$PREFIX}` should have the effect of stripping `$PREFIX` (up to and including the final `/`) from the front of `$filename`.  But maybe there's a bug or some other subtlety with that I was unaware of.



---

archive/issue_comments_363495.json:
```json
{
    "body": "Another way maybe it could fail is if your `$SAGE_LOCAL` somehow had a superfluous double-slash at the end of it...?",
    "created_at": "2018-08-08T11:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363495",
    "user": "https://github.com/embray"
}
```

Another way maybe it could fail is if your `$SAGE_LOCAL` somehow had a superfluous double-slash at the end of it...?



---

archive/issue_comments_363496.json:
```json
{
    "body": "If nothing else, something like this should do the trick.  But I think I will be rewriting a chunk of this code anyways...\n\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 125dd15..ded872f 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -889,6 +889,13 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     old_IFS=\"$IFS\"; IFS=$'\\n'\n     for filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n         filename=\"${filename#$PREFIX}\"\n+        # Make really sure there are still no leading slashes on the filename\n+        # (which could happen if enough superfluous slashes were added\n+        # elsewhere)\n+        while [[ \"$filename\" == /* ]]; do\n+            filename=\"${filename#/}\"\n+        done\n+\n         if [ $FIRST -eq 1 ]; then\n             FILE_LIST=\"\\\"$filename\\\"\"\n             FIRST=0\n```\n",
    "created_at": "2018-08-08T12:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363496",
    "user": "https://github.com/embray"
}
```

If nothing else, something like this should do the trick.  But I think I will be rewriting a chunk of this code anyways...


```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 125dd15..ded872f 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -889,6 +889,13 @@ if [ -d "$SAGE_DESTDIR" ]; then
     old_IFS="$IFS"; IFS=$'\n'
     for filename in $(find "$PREFIX" -type f -o -type l | sort); do
         filename="${filename#$PREFIX}"
+        # Make really sure there are still no leading slashes on the filename
+        # (which could happen if enough superfluous slashes were added
+        # elsewhere)
+        while [[ "$filename" == /* ]]; do
+            filename="${filename#/}"
+        done
+
         if [ $FIRST -eq 1 ]; then
             FILE_LIST="\"$filename\""
             FIRST=0
```




---

archive/issue_comments_363497.json:
```json
{
    "body": "I added `echo \"$filename\"` in `sage-spkg`, and there are indeed leading backslashes. My `$SAGE_LOCAL` has no trailing backslashes (at least when I do `sage -sh` and `echo $SAGE_LOCAL`), and the `$PREFIX` variable in `sage-spkg` has one. As you probably know, `bash` behavior can vary depending on whether it's GNU/linux or BSD. Maybe that's what's going on. Is there an issue with just using `lstrip(os.sep)` as my branch does?",
    "created_at": "2018-08-08T16:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363497",
    "user": "https://github.com/jhpalmieri"
}
```

I added `echo "$filename"` in `sage-spkg`, and there are indeed leading backslashes. My `$SAGE_LOCAL` has no trailing backslashes (at least when I do `sage -sh` and `echo $SAGE_LOCAL`), and the `$PREFIX` variable in `sage-spkg` has one. As you probably know, `bash` behavior can vary depending on whether it's GNU/linux or BSD. Maybe that's what's going on. Is there an issue with just using `lstrip(os.sep)` as my branch does?



---

archive/issue_comments_363498.json:
```json
{
    "body": "I'd be curious if you could figure out exactly which part is behaving differently in your bash? What happens with `filename=\"${filename#$PREFIX}`.  Not even necessarily in this script, but just in general? What does something like:\n\n\n```\nPREFIX=/a/\nfilename=/a/b\nfilename=${filename#$PREFIX}\necho \"$filename\"\n```\n\n\nIf that returns anything other than just `b` this is a bug in your bash I think.\n\n> Is there an issue with just using `lstrip(os.sep)` as my branch does?\n\nThe point is that shouldn't even be necessary.  It might not be a bad idea anyways just as a sanity check, though I might also issue a warning.  The intent is that these files contain a list of relative paths.  If they don't then the files are malformatted, which means the real problem is in the code producing those files (whether the bug ultimately originates from a buggy bash or not).",
    "created_at": "2018-08-08T16:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363498",
    "user": "https://github.com/embray"
}
```

I'd be curious if you could figure out exactly which part is behaving differently in your bash? What happens with `filename="${filename#$PREFIX}`.  Not even necessarily in this script, but just in general? What does something like:


```
PREFIX=/a/
filename=/a/b
filename=${filename#$PREFIX}
echo "$filename"
```


If that returns anything other than just `b` this is a bug in your bash I think.

> Is there an issue with just using `lstrip(os.sep)` as my branch does?

The point is that shouldn't even be necessary.  It might not be a bad idea anyways just as a sanity check, though I might also issue a warning.  The intent is that these files contain a list of relative paths.  If they don't then the files are malformatted, which means the real problem is in the code producing those files (whether the bug ultimately originates from a buggy bash or not).



---

archive/issue_comments_363499.json:
```json
{
    "body": "Alternatively, it's also possible that your `find` is slipping in some superfluous slashes.",
    "created_at": "2018-08-08T16:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363499",
    "user": "https://github.com/embray"
}
```

Alternatively, it's also possible that your `find` is slipping in some superfluous slashes.



---

archive/issue_comments_363500.json:
```json
{
    "body": "This seems to suggest that it is in fact the `find` at fault: https://apple.stackexchange.com/a/254224/44101",
    "created_at": "2018-08-08T16:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363500",
    "user": "https://github.com/embray"
}
```

This seems to suggest that it is in fact the `find` at fault: https://apple.stackexchange.com/a/254224/44101



---

archive/issue_comments_363501.json:
```json
{
    "body": "This patch should do it:\n\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 9b90421eaf..9dffb481df 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -869,9 +869,12 @@ fi\n # case DESTDIR=$SAGE_DESTDIR installation was not used\n echo \"Copying package files from temporary location $SAGE_DESTDIR to $SAGE_LOCAL\"\n if [ -d \"$SAGE_DESTDIR\" ]; then\n-    PREFIX=\"${SAGE_DESTDIR_LOCAL%/}/\"\n+    # Some `find` implementations will put superfluous slashes in the\n+    # output if we give them a directory name with a slash; so make sure\n+    # any trailing slash is removed; https://trac.sagemath.org/ticket/26013\n+    PREFIX=\"${SAGE_DESTDIR_LOCAL%/}\"\n\n-    rm -f \"$PREFIX\"lib/*.la\n+    rm -f \"$PREFIX\"/lib/*.la\n     if [ $? -ne 0 ]; then\n         error_msg \"Error deleting unnecessary libtool archive files\"\n         exit 1\n@@ -882,7 +885,7 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     FIRST=1\n     old_IFS=\"$IFS\"; IFS=$'\\n'\n     for filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n-        filename=\"${filename#$PREFIX}\"\n+        filename=\"${filename#$PREFIX/}\"\n         if [ $FIRST -eq 1 ]; then\n             FILE_LIST=\"\\\"$filename\\\"\"\n             FIRST=0\n@@ -893,7 +896,7 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n         if [ ! -d \"$SAGE_LOCAL/$(dirname \"$filename\")\" ]; then\n             $SAGE_SUDO mkdir -p \"$SAGE_LOCAL/$(dirname \"$filename\")\"\n         fi\n-        $SAGE_SUDO mv \"$PREFIX$filename\" \"${SAGE_LOCAL%/}/$filename\"\n+        $SAGE_SUDO mv \"$PREFIX/$filename\" \"${SAGE_LOCAL%/}/$filename\"\n         if [ $? -ne 0 ]; then\n             error_msg \"Error moving files for $PKG_NAME.\"\n             exit 1\n```\n\n\nI'm fine with adding this to your existing patch to `uninstall.py` as long a comment is also added pointing back to this ticket (and assuming this patch does in fact work).",
    "created_at": "2018-08-08T16:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363501",
    "user": "https://github.com/embray"
}
```

This patch should do it:


```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 9b90421eaf..9dffb481df 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -869,9 +869,12 @@ fi
 # case DESTDIR=$SAGE_DESTDIR installation was not used
 echo "Copying package files from temporary location $SAGE_DESTDIR to $SAGE_LOCAL"
 if [ -d "$SAGE_DESTDIR" ]; then
-    PREFIX="${SAGE_DESTDIR_LOCAL%/}/"
+    # Some `find` implementations will put superfluous slashes in the
+    # output if we give them a directory name with a slash; so make sure
+    # any trailing slash is removed; https://trac.sagemath.org/ticket/26013
+    PREFIX="${SAGE_DESTDIR_LOCAL%/}"

-    rm -f "$PREFIX"lib/*.la
+    rm -f "$PREFIX"/lib/*.la
     if [ $? -ne 0 ]; then
         error_msg "Error deleting unnecessary libtool archive files"
         exit 1
@@ -882,7 +885,7 @@ if [ -d "$SAGE_DESTDIR" ]; then
     FIRST=1
     old_IFS="$IFS"; IFS=$'\n'
     for filename in $(find "$PREFIX" -type f -o -type l | sort); do
-        filename="${filename#$PREFIX}"
+        filename="${filename#$PREFIX/}"
         if [ $FIRST -eq 1 ]; then
             FILE_LIST="\"$filename\""
             FIRST=0
@@ -893,7 +896,7 @@ if [ -d "$SAGE_DESTDIR" ]; then
         if [ ! -d "$SAGE_LOCAL/$(dirname "$filename")" ]; then
             $SAGE_SUDO mkdir -p "$SAGE_LOCAL/$(dirname "$filename")"
         fi
-        $SAGE_SUDO mv "$PREFIX$filename" "${SAGE_LOCAL%/}/$filename"
+        $SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
         if [ $? -ne 0 ]; then
             error_msg "Error moving files for $PKG_NAME."
             exit 1
```


I'm fine with adding this to your existing patch to `uninstall.py` as long a comment is also added pointing back to this ticket (and assuming this patch does in fact work).



---

archive/issue_comments_363502.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-08T17:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363502",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363503.json:
```json
{
    "body": "Your patch works for me. Here is a new branch.",
    "created_at": "2018-08-08T17:55:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363503",
    "user": "https://github.com/jhpalmieri"
}
```

Your patch works for me. Here is a new branch.



---

archive/issue_comments_363504.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-09T12:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363504",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_363505.json:
```json
{
    "body": "Thanks!",
    "created_at": "2018-08-09T12:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363505",
    "user": "https://github.com/embray"
}
```

Thanks!



---

archive/issue_events_023971.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-11T16:55:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25776#event-23971"
}
```



---

archive/issue_comments_363506.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-11T16:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25776",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25776#issuecomment-363506",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
