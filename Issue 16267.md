# Issue 16267: Fix the confusion in MILP.new_variable()

Issue created by migration from https://trac.sagemath.org/ticket/16504

Original creator: jdemeyer

Original creation time: 2014-06-20 15:11:13

CC:  ncohen dimpase vbraun dcoudert hartke wdj john_perry benjaminfjones ingolfured

This should create an unbounded real variable:

```
sage: p = MixedIntegerLinearProgram()
sage: x = p.new_variable(nonnegative=False) 
```


We should see `nonnegative` as a toggle, not as a type. The following should also work as expected intuitively:

```
sage: x = p.new_variable(integer=True, nonnegative=False)
sage: x = p.new_variable(integer=True, nonnegative=True)
```



---

Comment by jdemeyer created at 2014-06-20 15:18:57

I personally have no idea on the implementation of all this LP stuff. Would it be easy to implement this?


---

Comment by ncohen created at 2014-06-20 20:24:54

Yes, it would be easy. The main problem is that if you want to change the current behaviour of the function (i.e. if you want nonnegative=False to be the default) then you will have to "make nonnegative mandatory" for a while and raise a warning when it is not set. Otherwise when you will change it, guys who currently use "integer=True" to mean "nonnegative integer" will find themselves with LP returning weird answers.

That was the point of #15521.

Also, it may seem weird to see all these variables be nonnegative by default but that's really the standard for LP solvers. The LP backends really assume non negativity unless asked otherwise, and changing the standard in Sage is really something that we do "for the general mathematicians knowing that it could surprise guys used to LP".

Nathann


---

Comment by jdemeyer created at 2014-06-20 20:49:57

Replying to [comment:2 ncohen]:
> That was the point of #15521.
I don't think that #15521 made things more clear...

How about this:
we require at most one of `integer`, `binary`, `real` to be given, with `real` the default if none is given.

`nonnegative` is a boolean determining whether or not the variable is assumed to be nonnegative. In the function, we have `nonnegative=None` by default which is currently interpreted as `nonnegative=True` but with the warning from #15521.

I think this proposal is backwards- and forwards-compatible (unlike #15521, which is backwards- but not forwards-compatible).


---

Comment by jdemeyer created at 2014-06-20 20:51:43

Replying to [comment:2 ncohen]:
> The main problem is that if you want to change the current behaviour of the function (i.e. if you want nonnegative=False to be the default) then you will have to "make nonnegative mandatory" for a while and raise a warning when it is not set.
I agree with this, but I don't see the problem. The deprecation warning from #15521 isn't a problem either...


---

Comment by jdemeyer created at 2014-06-20 21:01:02

Essentially, the code should look like

```python
def new_variable(self, real=False, binary=False, integer=False, nonnegative=None):
    if sum([real, binary, integer]) >= 2:
        raise ValueError("exactly one of the available types has to be True")
    
    if nonnegative is None:
        deprecation(15521, "The default value of 'nonnegative' will change, to "+
                    "False instead of True. " +
                    "You should add the explicit 'nonnegative=True'.")
        nonnegative = True

    if binary:
        vtype = self.__BINARY
    elif integer:
        vtype = self.__INTEGER
    else:  # real is the default if no type is explicitly given
        vtype = self.__REAL
        
    # Set minimum value to 0 or -oo depending on "nonnegative"
    ...
```



---

Comment by ncohen created at 2014-06-21 08:20:56

> I agree with this, but I don't see the problem. The deprecation warning from #15521 isn't a problem either...

It is not a problem, it just means that "doing the job" takes one year :-P

Nathann


---

Comment by ncohen created at 2014-06-21 08:23:43

> I don't think that #15521 made things more clear...

Well, then improve it if you do not like it :-P

> How about this:
> we require at most one of `integer`, `binary`, `real` to be given, with `real` the default if none is given.

Makes sense. Even though, with the turn that events take, I wonder if it would not be better to require one of them to be explicitly given : no default. Again, nonnegative variables are the default in this field, and we switched to another. Requiring a variable would require the users to read the doc, which may avoid misunderstandings.

> `nonnegative` is a boolean determining whether or not the variable is assumed to be nonnegative. In the function, we have `nonnegative=None` by default which is currently interpreted as `nonnegative=True` but with the warning from #15521.
> 
> I think this proposal is backwards- and forwards-compatible (unlike #15521, which is backwards- but not forwards-compatible).

It does make sense.

Nathann


---

Comment by ncohen created at 2014-06-21 08:24:20

Yo !

> Essentially, the code should look like

Looks good.

Nathann


---

Comment by tmonteil created at 2014-06-21 10:05:38

Since `integer, binary, real` are mutually exclusive, why not simply have a `type` variable that takes one on the three values ?


---

Comment by jdemeyer created at 2014-06-22 18:22:27

Replying to [comment:9 tmonteil]:
> Since `integer, binary, real` are mutually exclusive, why not simply have a `type` variable that takes one on the three values ?
Backwards compatibility. With my proposal, we would have full backwards compatibility.


---

Comment by jdemeyer created at 2014-06-22 18:23:06

Replying to [comment:7 ncohen]:
> Even though, with the turn that events take, I wonder if it would not be better to require one of them to be explicitly given : no default.
Again, for backwards compatibility, we cannot just do that.


---

Comment by jdemeyer created at 2014-06-22 18:23:59

Replying to [comment:7 ncohen]:
> nonnegative variables are the default in this field, and we switched to another.
No, we didn't switch, we just added a deprecation warning. This ticket doesn't change that.


---

Comment by jdemeyer created at 2014-06-22 18:24:49

Replying to [comment:8 ncohen]:
> Looks good.
Hi Nathann,

Given that you know this code and I don't, could you make the final implementation based on my pseudo-code?


---

Comment by ncohen created at 2014-06-23 08:46:57

Yo !

> Given that you know this code and I don't, could you make the final implementation

Hmmmm.... You are hardly a beginner with Sage, but let's make a deal : I implement this ticket and you finish #16308 using #16374 that has been merged in the meantime ? I need this for my combinatorial design stuff `:-P`

Nathann


---

Comment by ncohen created at 2014-06-23 10:55:44

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-06-23 10:55:44

Hello !

Here is the branch. Took much longer than I thought.

What it does :
- Removes the `is_nonnegative`, `set_nonnegative` functions that were introduced in #15521 as 'nonnegative' is not meant to be a variable type but a  'property' of any type. Those functions are renamed to `is_real` and `set_real`, i.e. their status before #16504

- It was formerly possible to do things like that 

```
sage: p = MixedIntegerLinearProgram()
sage: v = p.new_variable()
sage: p.set_min(v[0],15)
sage: p.get_min(v[0])
15.0
```

  but it was NOT possible to do things like that

```
sage: p.set_min(v,17)
sage: p.get_min(v[18])
17.0
```

  i.e. it was possible to define upper/lower bound on a specific variable, but not to do the same on a dictionary of variables in such a way that the new variables created fro the dictionary will inherit the bounds. But that's exactly what we wanted to do here.

  Thus I needed to add arguments lower/upper bound to the constructor of `MIPVariable`, plus set functions where it was needed.

Well... `needs_review` !

Nathann


---

Comment by git created at 2014-06-23 10:56:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2014-06-23 11:27:16

As now `p.set_min(v,17)` becomes possible, why not have optional `max` and `min` in `new_variable()` (many solvers have it, at least per variable) ? E.g. `v=p.new_variable(min=17, max=18)`. A usual application is relaxation of binary IPs, so one would have real variables `p.new_variable(min=0, max=1)`.


---

Comment by jdemeyer created at 2014-06-23 11:30:42

Replying to [comment:18 dimpase]:
> As now `p.set_min(v,17)` becomes possible, why not have optional `max` and `min` in `new_variable()` (many solvers have it, at least per variable) ? E.g. `v=p.new_variable(min=17, max=18)`. A usual application is relaxation of binary IPs, so one would have real variables `p.new_variable(min=0, max=1)`.
I agree, but perhaps not on this ticket. Let's try not to do too many things at the same time.


---

Comment by jdemeyer created at 2014-06-23 12:25:07

Can you undo this change:

```diff
@@ -241,11 +239,10 @@ cdef class MixedIntegerLinearProgram(SageObject):
sage: g = graphs.PetersenGraph()
sage: p = MixedIntegerLinearProgram(maximization=True)
- sage: b = p.new_variable()
+ sage: b = p.new_variable(binary=True)
sage: p.set_objective(sum([b[v] for v in g]))
sage: for (u,v) in g.edges(labels=None):
... p.add_constraint(b[u] + b[v], max=1)
- sage: p.set_binary(b)
sage: p.solve(objective_only=True)
4.0
"""
```



---

Comment by jdemeyer created at 2014-06-23 12:26:14

And why remove this warning?

```diff
.. WARNING::
-
- By default, all ``x[i]`` are assumed to be non-negative. See
- :meth:`set_min` to set a different lower bound.
```



---

Comment by jdemeyer created at 2014-06-23 12:28:01

You should add more doctests for `nonnegative=False`. As far as I can see, there is no doctest for an actual MILP problem with `nonnegative=False` variables. You should doctest this both for `integer` and `real` types.


---

Comment by jdemeyer created at 2014-06-23 12:28:01

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2014-06-23 12:34:06

Am I correct that this is a safe change in the sense that the existing code using `nonnegative=True` as default would either continue to work, or will refuse to work? I.e. people won't possibly start getting wrong answers?


---

Comment by jdemeyer created at 2014-06-23 12:38:02

Replying to [comment:24 dimpase]:
> Am I correct that this is a safe change in the sense that the existing code using `nonnegative=True` as default would either continue to work, or will refuse to work? I.e. people won't possibly start getting wrong answers?
Old code should work exactly as before, possibly with a deprecation warning.


---

Comment by jdemeyer created at 2014-06-23 12:48:28

Could you replace

```
if isinstance(v, MIPVariable):
    v.set_min(min)
else:
    self._backend.variable_lower_bound(self._variables[v], min)
```

by the more Pythonic

```
try:
    v.set_min(min)
except AttributeError:
    self._backend.variable_lower_bound(self._variables[v], min)
```


My personal opinion is that `v.set_min(min)` should actually work in all cases, but that's perhaps for a new ticket.


---

Comment by ncohen created at 2014-06-23 14:13:47

> Can you undo this change:

Why ? `O_o`

It's better in the new version, isn't it ? `O_o`

Nathann


---

Comment by ncohen created at 2014-06-23 14:15:12

> And why remove this warning?
> {{{
> #!diff
> .. WARNING::
> -
> - By default, all ``x[i]`` are assumed to be non-negative. See
> - :meth:`set_min` to set a different lower bound.
> }}}

Because there is no need for a warning anymore : now the user explicitly says whether he wants the variables to be nonnegative or not, or he gets a warning.

Plus it will be the other way around next year.

Nathann


---

Comment by ncohen created at 2014-06-23 14:16:23

> Am I correct that this is a safe change in the sense that the existing code using `nonnegative=True` as default would either continue to work, or will refuse to work? I.e. people won't possibly start getting wrong answers?

It will work, and there should be no wrong answer (unless there is a bug somewhere). The default behaviour is now "nonnegative + warning", and the correct way to use this class is to specify a value for nonnegative.

Nathann


---

Comment by ncohen created at 2014-06-23 14:25:07

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-06-23 14:25:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-23 14:28:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-06-23 17:02:02

Still needs `nonnegative=False` doctests.


---

Comment by jdemeyer created at 2014-06-23 17:02:02

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-06-24 07:31:40

Here are the 10 lines you requested. 

Nathann


---

Comment by ncohen created at 2014-06-24 07:31:45

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-06-24 07:31:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-06-24 13:24:32

New commits:


---

Comment by jdemeyer created at 2014-06-24 13:25:20

Please review this commit.


---

Comment by ncohen created at 2014-06-24 13:28:27

I see nothing wrong with it !

Nathann


---

Comment by jdemeyer created at 2014-06-24 13:35:49

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-06-24 13:36:55

Hey man... What about #16308 ?

Nathann


---

Comment by jdemeyer created at 2014-06-24 14:37:30

Replying to [comment:44 ncohen]:
> Hey man... What about #16308 ?
Easy, I will look at it...


---

Comment by vbraun created at 2014-06-25 13:49:03

doctest failure src/doc/en/thematic_tutorials/linear_programming.rst


---

Comment by vbraun created at 2014-06-25 13:49:03

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2014-06-25 14:12:55

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-06-25 14:12:55

Cursed tutorial. Sorry 'bout that `:-/`

I rewrote the necessary part in an additional commit.

Nathann
----
New commits:


---

Comment by dimpase created at 2014-06-26 14:11:06

Yo!
YLC LGTM.


---

Comment by dimpase created at 2014-06-26 14:11:06

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-06-26 14:12:21

Your Loving Cousin ? `O_o`


---

Comment by ncohen created at 2014-06-26 14:13:01

YOUR LAST CHANGES ????

(I think I got it `:-P`)


---

Comment by dimpase created at 2014-06-26 14:15:58

Your Last Commit ;-)


---

Comment by vbraun created at 2014-06-27 02:49:50

Doctests fail in src/sage/numerical/mip.pyx


---

Comment by vbraun created at 2014-06-27 02:49:50

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2014-06-27 07:24:08

Not on my computer. Did you merge anything in between ?

Nathann


---

Comment by dimpase created at 2014-06-27 07:30:07

Replying to [comment:53 ncohen]:
> Not on my computer. Did you merge anything in between ?
same here, works for me too, so that must be cosmic rays (possibly emitted by git) affecting Volker's machine...


---

Comment by dimpase created at 2014-07-03 10:56:50

just to make sure I merged public/16504 over the latest 6.3.beta5, and I get 2 failures:

```
sage -t src/sage/numerical/mip.pyx
**********************************************************************
File "src/sage/numerical/mip.pyx", line 253, in sage.numerical.mip.MixedIntegerLinearProgram
Failed example:
    for type in ["binary", "integer"]:
        k = 3
        items = [1/5, 1/3, 2/3, 3/4, 5/7]
        maximum=1
        p=MixedIntegerLinearProgram()
        box=p.new_variable(**{type:True})
        for b in range(k):
             p.add_constraint(p.sum([items[i]*box[i,b] for i in range(len(items))]) <= maximum)
        for i in range(len(items)):
            p.add_constraint(p.sum([box[i,b] for b in range(k)]) == 1)
        p.set_objective(None)
        _ = p.solve()
        box=p.get_values(box)
        print(all(v in ZZ for v in box.values()))
Expected:
    True
    True
Got:
    True
    doctest:839: DeprecationWarning: The default value of 'nonnegative' will change, to False instead of True. You should add the explicit 'nonnegative=True'.
    See http://trac.sagemath.org/15521 for details.
    True
**********************************************************************
File "src/sage/numerical/mip.pyx", line 364, in sage.numerical.mip.MixedIntegerLinearProgram.?
Failed example:
    v = p.new_variable(real=True)
Expected:
    doctest:839: DeprecationWarning: The default value of 'nonnegative' will change, to False instead of True. You should add the explicit 'nonnegative=True'.
    See http://trac.sagemath.org/15521 for details.
Got:
    <BLANKLINE>
**********************************************************************
2 items had failures:
   1 of   9 in sage.numerical.mip.MixedIntegerLinearProgram
   1 of  15 in sage.numerical.mip.MixedIntegerLinearProgram.?
    [440 tests, 2 failures, 8.08 s]
----------------------------------------------------------------------
sage -t src/sage/numerical/mip.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 8.7 seconds
    cpu time: 8.1 seconds
    cumulative wall time: 8.1 seconds
```



---

Comment by dimpase created at 2014-07-03 11:02:04

the following obvious change fixes the things:

```
diff --git a/src/sage/numerical/mip.pyx b/src/sage/numerical/mip.pyx
index 2f8d0e3..5741f68 100644
--- a/src/sage/numerical/mip.pyx
+++ b/src/sage/numerical/mip.pyx
@@ -265,6 +265,8 @@ cdef class MixedIntegerLinearProgram(SageObject):
         ....:     box=p.get_values(box)
         ....:     print(all(v in ZZ for v in box.values()))
         True
+        doctest:839: DeprecationWarning: The default value of 'nonnegative' will change, to False inst
+        See http://trac.sagemath.org/15521 for details.
         True
     """
 
@@ -362,8 +364,6 @@ cdef class MixedIntegerLinearProgram(SageObject):
 
             sage: p = MixedIntegerLinearProgram()
             sage: v = p.new_variable(real=True)
-            doctest:839: DeprecationWarning: The default value of 'nonnegative' will change, to False 
-            See http://trac.sagemath.org/15521 for details.
             sage: p.get_min(v[0])
             0.0
         """
```



---

Comment by dimpase created at 2014-07-03 11:29:18

To fix this properly, some commit untangling is needed, I suppose. Probably, a rebase over beta5 might be the easiest option, but I am not 100% sure.


---

Comment by git created at 2014-07-03 11:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-07-03 11:43:42

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2014-07-03 21:54:19

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2014-07-03 21:54:19

LGTM


---

Comment by vbraun created at 2014-07-06 17:55:54

Resolution: fixed
