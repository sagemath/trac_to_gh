# Issue 11497: optimize quaternion algebra elements a bit, in some obvious ways

Issue created by migration from Trac.

Original creator: was

Original creation time: 2011-08-08 18:53:37

Assignee: AlexGhitza

There are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:

```

sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 115 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 1.80 s, Wall: 1.80 s
sage: timeit('a*z')
625 loops, best of 3: 96.4 µs per loop
```

and after:

```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 20.6 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 0.31 s, Wall: 0.31 s
sage: timeit('a*z')
625 loops, best of 3: 4.63 µs per loop
```


The changes in the patch to give this "order of magnitude" speedup are very simple, and will make quaternion arithmetic over all base rings much faster for certain important operation.  The main idea of the patch (after I had tried many things and deleted most of them) is just to add a check parameter to get rid of some coercion that isn't needed, plus adding lmul and rmul methods generically.  That's it.  But it leads to 6-20 times speedups on basic operations of importance to me.


---

Attachment


---

Comment by was created at 2011-08-08 19:00:45

Changing status from new to needs_review.


---

Comment by was created at 2011-08-08 19:36:13

I found a subtle issue, namely that when unpickling elements, they suddenly get the wrong quadratic field as parent.  This ends up making other code I have that uses quaternion algebras actually massively slower.    Anyway, I have to fix this before this patch can be used.


```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K     # output should be "True"
False
```



---

Comment by was created at 2011-08-08 19:36:13

Changing status from needs_review to needs_work.


---

Comment by was created at 2011-08-09 17:31:18

The issue I mentioned above is fixed by #11670.  


```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: 
sage:  w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K
True
```



---

Comment by was created at 2011-08-09 17:31:31

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2011-09-27 03:55:58

Changing status from needs_review to positive_review.


---

Comment by ohanar created at 2011-09-27 03:55:58

Code makes sense and everything passes.


---

Comment by pbruin created at 2014-05-02 13:59:20

Patch converted into a Git branch, fixed trivial merge conflict and whitespace.  All tests still pass.


---

Comment by vbraun created at 2014-05-08 11:50:10

Resolution: fixed
