# Issue 11497: optimize quaternion algebra elements a bit, in some obvious ways

archive/issues_011497.json:
```json
{
    "body": "Assignee: @aghitza\n\nThere are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:\n\n```\n\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: type(z)\n<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>\nsage: timeit('~z')\n625 loops, best of 3: 115 \u00b5s per loop\nsage: v = [z+i for i in range(1000)]\nsage: time k = loads(dumps(v))\nTime: CPU 1.80 s, Wall: 1.80 s\nsage: timeit('a*z')\n625 loops, best of 3: 96.4 \u00b5s per loop\n```\n\nand after:\n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: type(z)\n<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>\nsage: timeit('~z')\n625 loops, best of 3: 20.6 \u00b5s per loop\nsage: v = [z+i for i in range(1000)]\nsage: time k = loads(dumps(v))\nTime: CPU 0.31 s, Wall: 0.31 s\nsage: timeit('a*z')\n625 loops, best of 3: 4.63 \u00b5s per loop\n```\n\n\nThe changes in the patch to give this \"order of magnitude\" speedup are very simple, and will make quaternion arithmetic over all base rings much faster for certain important operation.  The main idea of the patch (after I had tried many things and deleted most of them) is just to add a check parameter to get rid of some coercion that isn't needed, plus adding lmul and rmul methods generically.  That's it.  But it leads to 6-20 times speedups on basic operations of importance to me.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11669\n\n",
    "created_at": "2011-08-08T18:53:37Z",
    "labels": [
        "component: algebra",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "optimize quaternion algebra elements a bit, in some obvious ways",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11497",
    "user": "https://github.com/williamstein"
}
```
Assignee: @aghitza

There are a couple of simple optimizations to quaternion algebras that will help a lot with speed.  For example, before this patch:

```

sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 115 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 1.80 s, Wall: 1.80 s
sage: timeit('a*z')
625 loops, best of 3: 96.4 µs per loop
```

and after:

```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: type(z)
<type 'sage.algebras.quatalg.quaternion_algebra_element.QuaternionAlgebraElement_generic'>
sage: timeit('~z')
625 loops, best of 3: 20.6 µs per loop
sage: v = [z+i for i in range(1000)]
sage: time k = loads(dumps(v))
Time: CPU 0.31 s, Wall: 0.31 s
sage: timeit('a*z')
625 loops, best of 3: 4.63 µs per loop
```


The changes in the patch to give this "order of magnitude" speedup are very simple, and will make quaternion arithmetic over all base rings much faster for certain important operation.  The main idea of the patch (after I had tried many things and deleted most of them) is just to add a check parameter to get rid of some coercion that isn't needed, plus adding lmul and rmul methods generically.  That's it.  But it leads to 6-20 times speedups on basic operations of importance to me.

Issue created by migration from https://trac.sagemath.org/ticket/11669





---

archive/issue_comments_128347.json:
```json
{
    "body": "Attachment [trac_11669.patch](tarball://root/attachments/some-uuid/ticket11669/trac_11669.patch) by @williamstein created at 2011-08-08 19:00:45",
    "created_at": "2011-08-08T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128347",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_11669.patch](tarball://root/attachments/some-uuid/ticket11669/trac_11669.patch) by @williamstein created at 2011-08-08 19:00:45



---

archive/issue_comments_128348.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-08T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128348",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_128349.json:
```json
{
    "body": "I found a subtle issue, namely that when unpickling elements, they suddenly get the wrong quadratic field as parent.  This ends up making other code I have that uses quaternion algebras actually massively slower.    Anyway, I have to fix this before this patch can be used.\n\n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: w = loads(dumps(z))\nsage: w.parent().base_ring() is K\nTrue\nsage: w[0].parent() is K     # output should be \"True\"\nFalse\n```\n",
    "created_at": "2011-08-08T19:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128349",
    "user": "https://github.com/williamstein"
}
```

I found a subtle issue, namely that when unpickling elements, they suddenly get the wrong quadratic field as parent.  This ends up making other code I have that uses quaternion algebras actually massively slower.    Anyway, I have to fix this before this patch can be used.


```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K     # output should be "True"
False
```




---

archive/issue_comments_128350.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-08-08T19:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128350",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_128351.json:
```json
{
    "body": "The issue I mentioned above is fixed by #11670.  \n\n\n```\nsage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8\nsage: \nsage:  w = loads(dumps(z))\nsage: w.parent().base_ring() is K\nTrue\nsage: w[0].parent() is K\nTrue\n```\n",
    "created_at": "2011-08-09T17:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128351",
    "user": "https://github.com/williamstein"
}
```

The issue I mentioned above is fixed by #11670.  


```
sage: K.<a> = NumberField(x^2-x-1); Q.<i,j,k> = QuaternionAlgebra(K,-1,-1); z=2*i+3*j+4/3*k+5/8
sage: 
sage:  w = loads(dumps(z))
sage: w.parent().base_ring() is K
True
sage: w[0].parent() is K
True
```




---

archive/issue_comments_128352.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-08-09T17:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128352",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_128353.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-09-27T03:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128353",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_128354.json:
```json
{
    "body": "Code makes sense and everything passes.",
    "created_at": "2011-09-27T03:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128354",
    "user": "https://github.com/ohanar"
}
```

Code makes sense and everything passes.



---

archive/issue_comments_128355.json:
```json
{
    "body": "Patch converted into a Git branch, fixed trivial merge conflict and whitespace.  All tests still pass.",
    "created_at": "2014-05-02T13:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128355",
    "user": "https://github.com/pjbruin"
}
```

Patch converted into a Git branch, fixed trivial merge conflict and whitespace.  All tests still pass.



---

archive/issue_comments_128356.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-08T11:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11497",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11497#issuecomment-128356",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
