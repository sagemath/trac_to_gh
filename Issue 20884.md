# Issue 20884: Precision in doctest tolerance: x > x

archive/issues_020884.json:
```json
{
    "body": "Keywords: doctest error exceeded\n\n\n```\nFailed example:\n    A.exp()  # tol 1e-14\nExpected:\n    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]\n    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]\nGot:\n    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]\n    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]\nTolerance exceeded in 1 of 8:\n    2.269633004093535 vs 2.2696330040935115, tolerance 1e-14 > 1e-14\n```\n\n\\\\\n\nSage saying that 10<sup>-14</sup> > 10<sup>-14</sup> appears a bit stupid; either the doctesting framework should be more tolerant here, or give better messages regarding the deviation.\n\n(Inspired by #21119.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/21121\n\n",
    "created_at": "2016-07-28T20:27:36Z",
    "labels": [
        "doctest framework",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Precision in doctest tolerance: x > x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20884",
    "user": "@nexttime"
}
```
Keywords: doctest error exceeded


```
Failed example:
    A.exp()  # tol 1e-14
Expected:
    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]
    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]
Got:
    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]
    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]
Tolerance exceeded in 1 of 8:
    2.269633004093535 vs 2.2696330040935115, tolerance 1e-14 > 1e-14
```

\\

Sage saying that 10<sup>-14</sup> > 10<sup>-14</sup> appears a bit stupid; either the doctesting framework should be more tolerant here, or give better messages regarding the deviation.

(Inspired by #21119.)

Issue created by migration from https://trac.sagemath.org/ticket/21121





---

archive/issue_comments_288727.json:
```json
{
    "body": "The culprit (at least regarding the weird ouput) is here, namely in the local function `failstr()`:\n\n```python\n    def output_difference(self, example, got, optionflags):\n        r\"\"\" ... \"\"\"\n        got = self.human_readable_escape_sequences(got)\n        want = example.want\n        diff = doctest.OutputChecker.output_difference(self, example, got, optionflags)\n        if isinstance(want, MarkedOutput) and (want.tol or want.abs_tol or want.rel_tol):\n            if diff[-1] != \"\\n\":\n                diff += \"\\n\"\n            want_str = [g[0] for g in float_regex.findall(want)]\n            got_str = [g[0] for g in float_regex.findall(got)]\n            want_values = [RIFtol(g) for g in want_str]\n            want_intervals = [self.add_tolerance(v, want) for v in want_values]\n            got_values = [RIFtol(g) for g in got_str]\n            if len(want_values) == len(got_values):\n                def failstr(astr, bstr, actual, desired):\n                    return \"    %s vs %s, tolerance %.0e > %.0e\"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).center())\n\n                fails = []\n                for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):\n                    if not ainterval.overlaps(b):\n                        if want.tol:\n                            if a == 0:\n                                fails.append(failstr(astr, bstr, abs(b), want.tol))\n                            else:\n                                fails.append(failstr(astr, bstr, abs(1 - b/a), want.tol))\n                        elif want.abs_tol:\n                            fails.append(failstr(astr, bstr, abs(a - b), want.abs_tol))\n                        else:\n                            fails.append(failstr(astr, bstr, abs(1 - b/a), want.rel_tol))\n\n                if fails:\n                    if len(want_values) == 1:\n                        diff += \"Tolerance exceeded:\\n\"\n                    else:\n                        diff += \"Tolerance exceeded in %s of %s:\\n\"%(len(fails), len(want_values))\n                    diff += \"\\n\".join(fails) + \"\\n\"\n        return diff\n```\n\n(A method of class `SageOutputChecker` in `src/sage/doctest/parsing.py`.)\n\nOne could also change the code below its definition rather than (just) `failstr()`.",
    "created_at": "2016-08-13T12:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288727",
    "user": "@nexttime"
}
```

The culprit (at least regarding the weird ouput) is here, namely in the local function `failstr()`:

```python
    def output_difference(self, example, got, optionflags):
        r""" ... """
        got = self.human_readable_escape_sequences(got)
        want = example.want
        diff = doctest.OutputChecker.output_difference(self, example, got, optionflags)
        if isinstance(want, MarkedOutput) and (want.tol or want.abs_tol or want.rel_tol):
            if diff[-1] != "\n":
                diff += "\n"
            want_str = [g[0] for g in float_regex.findall(want)]
            got_str = [g[0] for g in float_regex.findall(got)]
            want_values = [RIFtol(g) for g in want_str]
            want_intervals = [self.add_tolerance(v, want) for v in want_values]
            got_values = [RIFtol(g) for g in got_str]
            if len(want_values) == len(got_values):
                def failstr(astr, bstr, actual, desired):
                    return "    %s vs %s, tolerance %.0e > %.0e"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).center())

                fails = []
                for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):
                    if not ainterval.overlaps(b):
                        if want.tol:
                            if a == 0:
                                fails.append(failstr(astr, bstr, abs(b), want.tol))
                            else:
                                fails.append(failstr(astr, bstr, abs(1 - b/a), want.tol))
                        elif want.abs_tol:
                            fails.append(failstr(astr, bstr, abs(a - b), want.abs_tol))
                        else:
                            fails.append(failstr(astr, bstr, abs(1 - b/a), want.rel_tol))

                if fails:
                    if len(want_values) == 1:
                        diff += "Tolerance exceeded:\n"
                    else:
                        diff += "Tolerance exceeded in %s of %s:\n"%(len(fails), len(want_values))
                    diff += "\n".join(fails) + "\n"
        return diff
```

(A method of class `SageOutputChecker` in `src/sage/doctest/parsing.py`.)

One could also change the code below its definition rather than (just) `failstr()`.



---

archive/issue_comments_288728.json:
```json
{
    "body": "(As is, `failstr()` truncates the mantissa to *just one digit*, i.e., the digit before the decimal point.)",
    "created_at": "2016-08-13T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288728",
    "user": "@nexttime"
}
```

(As is, `failstr()` truncates the mantissa to *just one digit*, i.e., the digit before the decimal point.)



---

archive/issue_comments_288729.json:
```json
{
    "body": "I.e., we should **at least** make sure `\"%.0e\" % RIFtol(actual).center()` doesn't give the same as `\"%.0e\" % RIFtol(desired).center()`.  (Not sure whether using `.center()` here is at all the right thing, or whether we should at all use `RIF` for the *tolerance values* themselves; see also below.)\n\nIf it does, we may increase the number of (mantissa) digits in the former.  Or in both, until they differ.\n\nAnd that's orthogonal to improving hints regarding the actual deviation, i.e., if one wants to adjust the *expected figures* rather than (just) the tolerance.\n\nIf the intervals of *want* and *got* do not overlap (i.e., when the tolerance is exceeded), we could also give `.upper()` and `.lower()` (or vice versa, depending on whether *want* is smaller or larger than *got*).",
    "created_at": "2016-08-13T13:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288729",
    "user": "@nexttime"
}
```

I.e., we should **at least** make sure `"%.0e" % RIFtol(actual).center()` doesn't give the same as `"%.0e" % RIFtol(desired).center()`.  (Not sure whether using `.center()` here is at all the right thing, or whether we should at all use `RIF` for the *tolerance values* themselves; see also below.)

If it does, we may increase the number of (mantissa) digits in the former.  Or in both, until they differ.

And that's orthogonal to improving hints regarding the actual deviation, i.e., if one wants to adjust the *expected figures* rather than (just) the tolerance.

If the intervals of *want* and *got* do not overlap (i.e., when the tolerance is exceeded), we could also give `.upper()` and `.lower()` (or vice versa, depending on whether *want* is smaller or larger than *got*).



---

archive/issue_comments_288730.json:
```json
{
    "body": "With\n\n```diff\ndiff --git a/src/sage/doctest/parsing.py b/src/sage/doctest/parsing.py\nindex b297bb1..def1e31 100644\n--- a/src/sage/doctest/parsing.py\n+++ b/src/sage/doctest/parsing.py\n@@ -963,8 +963,19 @@ class SageOutputChecker(doctest.OutputChecker):\n             want_intervals = [self.add_tolerance(v, want) for v in want_values]\n             got_values = [RIFtol(g) for g in got_str]\n             if len(want_values) == len(got_values):\n+\n                 def failstr(astr, bstr, actual, desired):\n-                    return \"    %s vs %s, tolerance %.0e > %.0e\"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).\n+                    # Do not print 'x > x' (#21121):\n+                    dp = 0 # start with zero decimal places in output of tolerance\n+                    while True: # XXX kind of dangerous...\n+                        allowed_tol = \"%.*e\" % (dp, RIFtol(desired).center())\n+                        effective_tol = \"%.*e\" % (dp, RIFtol(actual).center())\n+                        if allowed_tol != effective_tol:\n+                            # we achieved meaningful output\n+                            break\n+                        dp += 1 # increase number of decimal places to be shown\n+\n+                    return \"    %s vs %s, tolerance %s > %s\"%(astr, bstr, effective_tol, allowed_tol)\n \n                 fails = []\n                 for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):\n```\n\nI would for example get the following for the failing test from the ticket's description / #21119:\n\n```\nsage -t src/sage/matrix/matrix_double_dense.pyx\n**********************************************************************\nFile \"src/sage/matrix/matrix_double_dense.pyx\", line 3761, in sage.matrix.matrix_double_dense.Matrix_double_dense.exp\nFailed example:\n    A.exp()  # tol 1e-14\nExpected:\n    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]\n    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]\nGot:\n    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]\n    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]\nTolerance exceeded in 1 of 8:\n    2.269633004093535 vs 2.2696330040935115, tolerance 1.04e-14 > 1.00e-14\n**********************************************************************\n```\n\n\nAFAICT, we unfortunately *there* do not know whether `# tol 1e-14` or e.g. `# tol 1.0e-14` was specified in the failing doctest.",
    "created_at": "2016-08-13T14:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288730",
    "user": "@nexttime"
}
```

With

```diff
diff --git a/src/sage/doctest/parsing.py b/src/sage/doctest/parsing.py
index b297bb1..def1e31 100644
--- a/src/sage/doctest/parsing.py
+++ b/src/sage/doctest/parsing.py
@@ -963,8 +963,19 @@ class SageOutputChecker(doctest.OutputChecker):
             want_intervals = [self.add_tolerance(v, want) for v in want_values]
             got_values = [RIFtol(g) for g in got_str]
             if len(want_values) == len(got_values):
+
                 def failstr(astr, bstr, actual, desired):
-                    return "    %s vs %s, tolerance %.0e > %.0e"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).
+                    # Do not print 'x > x' (#21121):
+                    dp = 0 # start with zero decimal places in output of tolerance
+                    while True: # XXX kind of dangerous...
+                        allowed_tol = "%.*e" % (dp, RIFtol(desired).center())
+                        effective_tol = "%.*e" % (dp, RIFtol(actual).center())
+                        if allowed_tol != effective_tol:
+                            # we achieved meaningful output
+                            break
+                        dp += 1 # increase number of decimal places to be shown
+
+                    return "    %s vs %s, tolerance %s > %s"%(astr, bstr, effective_tol, allowed_tol)
 
                 fails = []
                 for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):
```

I would for example get the following for the failing test from the ticket's description / #21119:

```
sage -t src/sage/matrix/matrix_double_dense.pyx
**********************************************************************
File "src/sage/matrix/matrix_double_dense.pyx", line 3761, in sage.matrix.matrix_double_dense.Matrix_double_dense.exp
Failed example:
    A.exp()  # tol 1e-14
Expected:
    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]
    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]
Got:
    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]
    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]
Tolerance exceeded in 1 of 8:
    2.269633004093535 vs 2.2696330040935115, tolerance 1.04e-14 > 1.00e-14
**********************************************************************
```


AFAICT, we unfortunately *there* do not know whether `# tol 1e-14` or e.g. `# tol 1.0e-14` was specified in the failing doctest.



---

archive/issue_comments_288731.json:
```json
{
    "body": "To do:\n\nReplace `True` by `dp <= some_meaningful_number` and `break` by `return ...` (returning what's now returned below, after the loop).\n\nThen if we exit the `while` loop (giving up on too many decimal places), fall back to returning some other (meaningful) output, of course again other than `... x > x`.",
    "created_at": "2016-08-13T14:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288731",
    "user": "@nexttime"
}
```

To do:

Replace `True` by `dp <= some_meaningful_number` and `break` by `return ...` (returning what's now returned below, after the loop).

Then if we exit the `while` loop (giving up on too many decimal places), fall back to returning some other (meaningful) output, of course again other than `... x > x`.



---

archive/issue_comments_288732.json:
```json
{
    "body": "... and the mentioned doctests for the doctest framework itself of course need to get adjusted to the new output.",
    "created_at": "2016-08-13T14:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288732",
    "user": "@nexttime"
}
```

... and the mentioned doctests for the doctest framework itself of course need to get adjusted to the new output.



---

archive/issue_comments_288733.json:
```json
{
    "body": "You just need to print the numbers with directed roundings (up/down). But that needs #21124 to properly print the numbers.",
    "created_at": "2016-08-15T08:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288733",
    "user": "@jdemeyer"
}
```

You just need to print the numbers with directed roundings (up/down). But that needs #21124 to properly print the numbers.



---

archive/issue_comments_288734.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-08-29T10:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288734",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_288735.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-29T10:43:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288735",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288736.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-29T11:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288736",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288737.json:
```json
{
    "body": "Changing keywords from \"doctest error exceeded\" to \"doctest tolerance exceeded\".",
    "created_at": "2018-08-29T11:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288737",
    "user": "@jdemeyer"
}
```

Changing keywords from "doctest error exceeded" to "doctest tolerance exceeded".



---

archive/issue_comments_288738.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-29T11:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288738",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_288739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-29T12:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288739",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288740.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-29T12:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288740",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288741.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-29T14:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288741",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288742.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T13:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288742",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-25T10:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288743",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_288744.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-26T09:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288744",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288745.json:
```json
{
    "body": "LGTM (except that \u201cit is carries\u201d in the comment should be \u201cit carries\u201d).",
    "created_at": "2019-01-26T09:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288745",
    "user": "@mezzarobba"
}
```

LGTM (except that “it is carries” in the comment should be “it carries”).



---

archive/issue_comments_288746.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-01-26T09:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288746",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_288747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2019-01-26T09:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288747",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_288748.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-26T09:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288748",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_288749.json:
```json
{
    "body": "Fixed typo",
    "created_at": "2019-01-26T09:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288749",
    "user": "@jdemeyer"
}
```

Fixed typo



---

archive/issue_comments_288750.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-27T10:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20884",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20884#issuecomment-288750",
    "user": "@vbraun"
}
```

Resolution: fixed
