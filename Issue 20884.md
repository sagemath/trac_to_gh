# Issue 20884: Precision in doctest tolerance: x > x

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2016-07-28 20:27:36

Keywords: doctest error exceeded


```
Failed example:
    A.exp()  # tol 1e-14
Expected:
    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]
    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]
Got:
    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]
    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]
Tolerance exceeded in 1 of 8:
    2.269633004093535 vs 2.2696330040935115, tolerance 1e-14 > 1e-14
```

\\

Sage saying that 10<sup>-14</sup> > 10<sup>-14</sup> appears a bit stupid; either the doctesting framework should be more tolerant here, or give better messages regarding the deviation.

(Inspired by #21119.)


---

Comment by leif created at 2016-08-13 12:56:37

The culprit (at least regarding the weird ouput) is here, namely in the local function `failstr()`:

```python
    def output_difference(self, example, got, optionflags):
        r""" ... """
        got = self.human_readable_escape_sequences(got)
        want = example.want
        diff = doctest.OutputChecker.output_difference(self, example, got, optionflags)
        if isinstance(want, MarkedOutput) and (want.tol or want.abs_tol or want.rel_tol):
            if diff[-1] != "\n":
                diff += "\n"
            want_str = [g[0] for g in float_regex.findall(want)]
            got_str = [g[0] for g in float_regex.findall(got)]
            want_values = [RIFtol(g) for g in want_str]
            want_intervals = [self.add_tolerance(v, want) for v in want_values]
            got_values = [RIFtol(g) for g in got_str]
            if len(want_values) == len(got_values):
                def failstr(astr, bstr, actual, desired):
                    return "    %s vs %s, tolerance %.0e > %.0e"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).center())

                fails = []
                for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):
                    if not ainterval.overlaps(b):
                        if want.tol:
                            if a == 0:
                                fails.append(failstr(astr, bstr, abs(b), want.tol))
                            else:
                                fails.append(failstr(astr, bstr, abs(1 - b/a), want.tol))
                        elif want.abs_tol:
                            fails.append(failstr(astr, bstr, abs(a - b), want.abs_tol))
                        else:
                            fails.append(failstr(astr, bstr, abs(1 - b/a), want.rel_tol))

                if fails:
                    if len(want_values) == 1:
                        diff += "Tolerance exceeded:\n"
                    else:
                        diff += "Tolerance exceeded in %s of %s:\n"%(len(fails), len(want_values))
                    diff += "\n".join(fails) + "\n"
        return diff
```

(A method of class `SageOutputChecker` in `src/sage/doctest/parsing.py`.)

One could also change the code below its definition rather than (just) `failstr()`.


---

Comment by leif created at 2016-08-13 13:01:30

(As is, `failstr()` truncates the mantissa to _just one digit_, i.e., the digit before the decimal point.)


---

Comment by leif created at 2016-08-13 13:39:43

I.e., we should *at least* make sure `"%.0e" % RIFtol(actual).center()` doesn't give the same as `"%.0e" % RIFtol(desired).center()`.  (Not sure whether using `.center()` here is at all the right thing, or whether we should at all use `RIF` for the _tolerance values_ themselves; see also below.)

If it does, we may increase the number of (mantissa) digits in the former.  Or in both, until they differ.

And that's orthogonal to improving hints regarding the actual deviation, i.e., if one wants to adjust the _expected figures_ rather than (just) the tolerance.

If the intervals of _want_ and _got_ do not overlap (i.e., when the tolerance is exceeded), we could also give `.upper()` and `.lower()` (or vice versa, depending on whether _want_ is smaller or larger than _got_).


---

Comment by leif created at 2016-08-13 14:46:46

With

```diff
diff --git a/src/sage/doctest/parsing.py b/src/sage/doctest/parsing.py
index b297bb1..def1e31 100644
--- a/src/sage/doctest/parsing.py
+++ b/src/sage/doctest/parsing.py
`@``@` -963,8 +963,19 `@``@` class SageOutputChecker(doctest.OutputChecker):
             want_intervals = [self.add_tolerance(v, want) for v in want_values]
             got_values = [RIFtol(g) for g in got_str]
             if len(want_values) == len(got_values):
+
                 def failstr(astr, bstr, actual, desired):
-                    return "    %s vs %s, tolerance %.0e > %.0e"%(astr, bstr, RIFtol(actual).center(), RIFtol(desired).
+                    # Do not print 'x > x' (#21121):
+                    dp = 0 # start with zero decimal places in output of tolerance
+                    while True: # XXX kind of dangerous...
+                        allowed_tol = "%.*e" % (dp, RIFtol(desired).center())
+                        effective_tol = "%.*e" % (dp, RIFtol(actual).center())
+                        if allowed_tol != effective_tol:
+                            # we achieved meaningful output
+                            break
+                        dp += 1 # increase number of decimal places to be shown
+
+                    return "    %s vs %s, tolerance %s > %s"%(astr, bstr, effective_tol, allowed_tol)
 
                 fails = []
                 for a, ainterval, b, astr, bstr in zip(want_values, want_intervals, got_values, want_str, got_str):
```

I would for example get the following for the failing test from the ticket's description / #21119:

```
sage -t src/sage/matrix/matrix_double_dense.pyx
**********************************************************************
File "src/sage/matrix/matrix_double_dense.pyx", line 3761, in sage.matrix.matrix_double_dense.Matrix_double_dense.exp
Failed example:
    A.exp()  # tol 1e-14
Expected:
    [-19.614602953804912 + 12.517743846762578*I   3.7949636449582176 + 28.88379930658099*I]
    [ -32.383580980922254 + 21.88423595789845*I   2.269633004093535 + 44.901324827684824*I]
Got:
    [-19.614602953804923 + 12.517743846762574*I  3.7949636449582007 + 28.883799306580993*I]
    [-32.383580980922275 + 21.884235957898447*I  2.2696330040935115 + 44.901324827684846*I]
Tolerance exceeded in 1 of 8:
    2.269633004093535 vs 2.2696330040935115, tolerance 1.04e-14 > 1.00e-14
**********************************************************************
```


AFAICT, we unfortunately _there_ do not know whether `# tol 1e-14` or e.g. `# tol 1.0e-14` was specified in the failing doctest.


---

Comment by leif created at 2016-08-13 14:56:02

To do:

Replace `True` by `dp <= some_meaningful_number` and `break` by `return ...` (returning what's now returned below, after the loop).

Then if we exit the `while` loop (giving up on too many decimal places), fall back to returning some other (meaningful) output, of course again other than `... x > x`.


---

Comment by leif created at 2016-08-13 14:59:11

... and the mentioned doctests for the doctest framework itself of course need to get adjusted to the new output.


---

Comment by jdemeyer created at 2016-08-15 08:05:05

You just need to print the numbers with directed roundings (up/down). But that needs #21124 to properly print the numbers.


---

Comment by jdemeyer created at 2018-08-29 10:36:39

New commits:


---

Comment by git created at 2018-08-29 10:43:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-29 11:14:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-08-29 11:22:54

Changing keywords from "doctest error exceeded" to "doctest tolerance exceeded".


---

Comment by jdemeyer created at 2018-08-29 11:22:54

Changing status from new to needs_review.


---

Comment by git created at 2018-08-29 12:05:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-29 12:20:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-29 14:17:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-11 13:12:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-25 10:55:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-01-26 09:39:06

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2019-01-26 09:39:06

LGTM (except that “it is carries” in the comment should be “it carries”).


---

Comment by git created at 2019-01-26 09:55:18

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-01-26 09:55:18

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-26 09:55:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-01-26 09:55:59

Fixed typo


---

Comment by vbraun created at 2019-01-27 10:50:34

Resolution: fixed
