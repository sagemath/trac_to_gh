# Issue 13563: upgrade boost to version 1.52.0

Issue created by migration from https://trac.sagemath.org/ticket/13767

Original creator: tkluck

Original creation time: 2012-11-28 02:00:00

Assignee: tbd

CC:  jpflori

There was a discussion on sage-devel a while ago about including the Boost headers [1]. As noted there, the latest version of the optional spkg `polymake` doesn't compile with the current boost package. The current boost package is called `boost-cropped` because it contains only a subset of the boost headers, because of package size.

This new package is contains _all_ headers, which is still only a subset of the upstream tarball. The total packaged size is ~ 5M, which feels reasonable to me.

I've checked that the current version `polybori-0.8.2` and the current upstream version `polymake-2.12-rc3` both compile under Sage with these headers. I'm also submitting an spkg for polymake in another ticket.

[1] https://groups.google.com/d/topic/sage-devel/fcxNrQqVSz0/discussion


---

Comment by tkluck created at 2012-11-28 02:05:05

Because of the file size limit on trac attachment, I've put it here:

http://www.infty.nl/misc/boost-cropped-1.52.0.spkg


---

Comment by tkluck created at 2012-11-28 02:05:24

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-02-24 03:57:07

The deleted patch is still in the repo:

```
[vbraun@laptop boost-cropped-1.52.0]$ hg st
! patches/boost-1.34.1-gcc-4.4.0-fixes.patch
```

Also, I take it the following in SPKG.txt is no longer true?

```
Merged against policy a patch that makes boost build with gcc 4.4.0. Will be obsoleted by an updated boost shortly.
```



---

Comment by tkluck created at 2013-02-25 11:25:38

Thanks for reviewing. I've removed that line from SKPG.txt, and committed my changes into the hg repo. I also renamed the package to boost_cropped (underscore instead of dash) to conform to the name-version scheme.

The current version is here:

http://www.infty.nl/misc/boost_cropped-1.52.0.spkg


---

Comment by tkluck created at 2013-02-25 11:49:45

I just uploaded a slightly newer version (md5sum d897d8e152623fab9f9c866ce184b501) that fixes a bash escaping error in spkg-install that I happened to notice.


---

Comment by vbraun created at 2013-02-25 19:24:49

+1 for underscore but don't we have to patch those as well?

```
[vbraun@laptop Sage]$ egrep boost-cropp sage/spkg/*
sage/spkg/install:BOOST_CROPPED=`newest_version boost-cropped`
sage/spkg/Makefile:BOOST_CROPPED=boost-cropped-1.34.1
```



---

Comment by tkluck created at 2013-02-25 19:34:16

I attached a patch doing just that. I don't know how to instruct the patchbot to apply this to sage_root, and it wouldn't work anyway since it needs the new spkg. Let me know if I can do anything more, though.

Note that the file spkg/Makefile is automatically generated, so I didn't patch it.


---

Comment by vbraun created at 2013-02-25 21:28:06

Looks good to me


---

Comment by vbraun created at 2013-02-25 21:28:06

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2013-02-26 16:44:07

Dumb question:  Will the change in package name (though salutary) affect upgrading?  (I.e., would we need a build patch for that?)

CC:ing JP in case this might help any Cygwin woes with not having certain function (along the lines of what cephes was supposed to accomplish, but wasn't accomplishing since it wasn't installed...), though looks like he's gotten most of them ironed out :)


---

Comment by jdemeyer created at 2013-02-26 21:53:39

In `SPKG.txt`, replace

```
### boost-cropped-1.52.0 (Timo Kluck, November 28, 2012)
```

by

```
### boost_cropped-1.52.0 (Timo Kluck, November 28, 2012)
```



---

Comment by jdemeyer created at 2013-02-26 21:55:24

Replying to [comment:10 kcrisman]:
> Dumb question:  Will the change in package name (though salutary) affect upgrading?
Yes.

> (I.e., would we need a build patch for that?)
Yes, but there is such a patch.


---

Comment by tkluck created at 2013-02-26 22:23:28

Replying to [comment:11 jdemeyer]:
> In `SPKG.txt`, replace
> {{{
> === boost-cropped-1.52.0 (Timo Kluck, November 28, 2012) ===
> }}}
> by
> {{{
> === boost_cropped-1.52.0 (Timo Kluck, November 28, 2012) ===
> }}}
Done and set the date to today. I uploaded a new version (md5sum 2e12e082e9db4e908d0796246d0af351).


---

Comment by kcrisman created at 2013-02-26 22:25:32

> > (I.e., would we need a build patch for that?)
> Yes, but there is such a patch.
Ok, I see that now.  I will trust you that it will perform appropriately :)


---

Comment by jdemeyer created at 2013-02-27 12:54:02

Could this have caused

```
sage -t  --long -force_lib devel/sage/sage/rings/polynomial/pbori.pyx
**********************************************************************
File "/release/merger/sage-5.8.beta2/devel/sage-main/sage/rings/polynomial/pbori.pyx", line 7868:
    sage: random_set((a*b*c*d).lm(),2)
Expected:
    {{b,c}, {b}}
Got:
    {{b}, {c}}
**********************************************************************
[...more like this...]
```



---

Comment by jdemeyer created at 2013-02-27 12:54:02

Changing status from positive_review to needs_work.


---

Comment by tkluck created at 2013-02-27 15:55:14

Replying to [comment:15 jdemeyer]:
> Could this have caused
> {{{
> sage -t  --long -force_lib devel/sage/sage/rings/polynomial/pbori.pyx
> **********************************************************************
> File "/release/merger/sage-5.8.beta2/devel/sage-main/sage/rings/polynomial/pbori.pyx", line 7868:
>     sage: random_set((a*b*c*d).lm(),2)
> Expected:
>     {{b,c}, {b}}
> Got:
>     {{b}, {c}}
> **********************************************************************
> [...more like this...]
> }}}

Yes, I'm pretty sure it has: I can reproduce this issue on my stock 5.5 installation with upgraded boost and recompiled polybori.

The reason is possibly that polybori probably relies on `Boost.Random` for its randomness. Since we're doing a rather large update 1.34 - > 1.52, it's quite possible that the implementation has changed sufficiently to obtain different random values even with the same seed.

I would be inclined to just update the doctests, since these are inherently random results. But I would prefer to first hear the opinion of someone who actually uses polybori.


---

Comment by tkluck created at 2013-02-27 16:08:25

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2013-02-28 02:24:10

I approve the patch for the polybori tests. I have seen exactly this output in sage-on-gentoo for the last few months. I have it documented at least as far back as the time of sage-5.4.


---

Comment by AlexanderDreyer created at 2013-02-28 08:49:41

These random ;-) changes in `PolyBoRi`'s random functions won't cause any problems.

But maybe we should just ignore the doctest results and add additional tests for the following assumed properties `result =  random_set(monomial, n)` should obey
`len(result) == n` and `result.diff(monomial.divisors()).empty()` .


---

Comment by AlexanderDreyer created at 2013-02-28 09:05:29

Edited: it should read `len(result) == n`.


---

Comment by AlexanderDreyer created at 2013-02-28 09:29:26

Anyway, if we need a quick fix: I can also give a positive review. The more generic test would then be a new ticket.


---

Comment by tkluck created at 2013-02-28 10:30:31

Replying to [comment:21 AlexanderDreyer]:
> Anyway, if we need a quick fix: I can also give a positive review. The more generic test would then be a new ticket.

That would be great; the polymake upgrade also depends on this ticket, so it would be great to just get it in.


---

Comment by AlexanderDreyer created at 2013-02-28 10:39:41

Changing status from needs_review to positive_review.


---

Comment by AlexanderDreyer created at 2013-02-28 10:39:41

Replying to [comment:22 tkluck]:
> That would be great; the polymake upgrade also depends on this ticket, so it would be great to just get it in.
Allright then. Please set up the other ticket when there is time and CC me there.

Just out of curiosity: how is the polymake ticket related to `PolyBoRi`?


---

Comment by jdemeyer created at 2013-02-28 10:57:51

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-02-28 10:57:51

Could you make `SPKG.txt` world-readable inside the spkg:

```
1435597707    4 -rw-------   1 jdemeyer jdemeyer     1406 Feb 26 22:22 ./SPKG.txt
```



---

Comment by jdemeyer created at 2013-02-28 11:17:25

Also: the two patches are not proper Mercurial changesets (they lack a header). You should generate patches using `hg export tip` (see [http://sagemath.org/doc/developer/walk_through.html#creating-a-change](http://sagemath.org/doc/developer/walk_through.html#creating-a-change) or [http://sagemath.org/doc/developer/walk_through.html#creating-your-own-patch-with-queues](http://sagemath.org/doc/developer/walk_through.html#creating-your-own-patch-with-queues))


---

Comment by tkluck created at 2013-02-28 13:41:30

Replying to [comment:23 AlexanderDreyer]:
> > That would be great; the polymake upgrade also depends on this ticket, so it would be great to just get it in.
> Just out of curiosity: how is the polymake ticket related to `PolyBoRi`?
This is not a polybori ticket, but a boost ticket :-)


---

Comment by AlexanderDreyer created at 2013-02-28 13:45:59

Replying to [comment:26 tkluck]:
> This is not a polybori ticket, but a boost ticket :-)
Sorry, I misunderstood this. (Ticket vs. patch.)


---

Comment by AlexanderDreyer created at 2013-02-28 13:46:55

(You wrote it correctly, I just misread)


---

Attachment


---

Attachment

The patches are now hg changesets. Sorry about that, I've been doing development on an integrated git tree recently, and I still had to setup the conversion git -> hg.


---

Comment by tkluck created at 2013-02-28 14:07:31

Changing status from needs_work to needs_review.


---

Comment by tkluck created at 2013-02-28 16:44:31

I created #14205 for possibly making those doctests non-random, and put Alexander in the CC as requested.


---

Comment by kcrisman created at 2013-02-28 17:15:24

Could this be dependent on platform (the pbori tests, I mean)?  I get all the _original_ ones after installing this spkg and patches, doing `./sage -b` and testing (hence failures).

```

----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: from polybori import random_set, set_random_seed
sage: B.<a,b,c,d,e> = BooleanPolynomialRing()
sage: (a*b*c*d).lm()
a*b*c*d
sage: set_random_seed(1337)
sage: random_set((a*b*c*d).lm(),2)
{{b,c}, {b}}
```

Is there something else I should have done to make sure this change works?  (I'm on an Intel Mac OSX 10.7.)


---

Comment by tkluck created at 2013-02-28 17:25:23

Replying to [comment:31 kcrisman]:
> Could this be dependent on platform (the pbori tests, I mean)?  I get all the _original_ ones after installing this spkg and patches, doing `./sage -b` and testing (hence failures).
> Is there something else I should have done to make sure this change works?  (I'm on an Intel Mac OSX 10.7.)

Did you recompile the Polybori package?

```
sage -f polybori
```



---

Comment by tkluck created at 2013-02-28 18:05:25

Replying to [comment:24 jdemeyer]:
> Could you make `SPKG.txt` world-readable inside the spkg:
> {{{
> 1435597707    4 -rw-------   1 jdemeyer jdemeyer     1406 Feb 26 22:22 ./SPKG.txt
> }}}
This has been done, too. New package version with md5sum 2852b9e02ede0ab2785930d0f9268c6f.


---

Comment by kcrisman created at 2013-02-28 18:10:56

> Did you recompile the Polybori package?
No, because it didn't say to.  Maybe there should be something that retriggers this on update?  Anyway, works fine now, sorry for the noise (on the way to #13768...)


---

Comment by jdemeyer created at 2013-02-28 18:23:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-02-28 18:23:00

All administrative issues are fixed.


---

Comment by tkluck created at 2013-03-01 00:30:10

Replying to [comment:34 kcrisman]:
> > Did you recompile the Polybori package?
> No, because it didn't say to.  Maybe there should be something that retriggers this on update?  
You're right. The makefile `spkg/Makefile` knows which packages depend on which others. Your comment reminded me to check whether it knows that polybori depends on boost_cropped: it does. I'm pretty sure that means that the upgrade path will work.

Thanks for testing!


---

Comment by jdemeyer created at 2013-03-05 11:00:12

Resolution: fixed
