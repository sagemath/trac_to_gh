# Issue 30230: src/tox.ini: Check patchbot plugin patterns

Issue created by migration from https://trac.sagemath.org/ticket/30467

Original creator: mkoeppe

Original creation time: 2020-08-29 23:48:20

CC:  chapoton jhpalmieri @tobiasdiez tscrim slelievre @kliem

(from #30448)


---

Comment by git created at 2020-08-30 01:53:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-30 01:54:24

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2020-08-30 10:31:17

Overall looks good to me. A few suggestions:
- Please try not to use `sh -c` in the tox, because this is not platform compatible i.e. doesn't work on Windows. 
- The trailing whitespace error can also be checked by pycodestyle, https://pycodestyle.pycqa.org/en/latest/intro.html#error-codes W291. Thus, I guess this custom regex lint rule can be replaced by adding W291 to the pycodestyle config.
- Not sure if the first "python 3 incompatible" check is still needed. Since if you use python 3 incompatible code, then it simply shouldn't run, right?
- relint should also be documented #30361 and added to the lint action #30404


---

Comment by mkoeppe created at 2020-08-30 14:38:58

Replying to [comment:10 gh-tobiasdiez]:
> Overall looks good to me. A few suggestions:
> - Please try not to use `sh -c` in the tox, because this is not platform compatible i.e. doesn't work on Windows. 

Thanks for the heads-up. Do you have a specific suggestion what to do instead?

> - The trailing whitespace error can also be checked by pycodestyle, https://pycodestyle.pycqa.org/en/latest/intro.html#error-codes W291. Thus, I guess this custom regex lint rule can be replaced by adding W291 to the pycodestyle config.
> - Not sure if the first "python 3 incompatible" check is still needed. Since if you use python 3 incompatible code, then it simply shouldn't run, right?

Right. For now I just wanted to get these on par with the patchbot. I would prefer to make further refinements in follow-up tickets.

Regarding Python 3 - these patterns may still be helpful when reviving ancient branches. Some of these patterns, of course, will be flagged by the Python 3 parser; but other patterns are for syntactically correct but outdated library functions that may be used in parts of code that is not covered by doctests.

> - relint should also be documented #30361 

I'll do this in #30453 (Document "sage -tox")

> and added to the lint action #30404

#30404 should possibly just invoke tox


---

Comment by @tobiasdiez created at 2020-08-30 16:34:06

I think in most cases you can simply remove the `sh -c` part. The if/for statements need a bit more work, probably the easiest solution is to write a small python wrapper. 

Scrolling through the tox documentation, I'm also not sure if the processing of arguments is really in the spirit of tox. For example, the foreach loop for relint makes it impossible to pass further cmd args to relint (since they would end up in the loop). On the other hand, I see that its also convenient to have a systematic interface to apply the command to only one file. Maybe leave this functionality to `sage --tox`?


---

Comment by mkoeppe created at 2020-08-30 17:30:27

Replying to [comment:12 gh-tobiasdiez]:
> Scrolling through the tox documentation, I'm also not sure if the processing of arguments is really in the spirit of tox. For example, the foreach loop for relint makes it impossible to pass further cmd args to relint (since they would end up in the loop). On the other hand, I see that its also convenient to have a systematic interface to apply the command to only one file. Maybe leave this functionality to `sage --tox`?

tox runs all environments by default -- so there needs to be a uniform interface for file/directory arguments


---

Comment by mkoeppe created at 2020-08-30 17:35:14

Replying to [comment:12 gh-tobiasdiez]:
> I think in most cases you can simply remove the `sh -c` part. The if/for statements need a bit more work, probably the easiest solution is to write a small python wrapper. 

OK. I think I am going to change `sage --coverage` so that it can invoke `sage --coverageall` if necessary.

Then I can get rid of `sh -c` for all "sagedirect" environments.


---

Comment by mkoeppe created at 2020-08-30 17:54:59

I'll do this in #30474


---

Comment by mkoeppe created at 2020-08-30 17:56:34

Replying to [comment:12 gh-tobiasdiez]:
> ... Maybe leave this functionality to `sage --tox`?

No, I think it's important to keep plain `tox` from the command line the same as `sage --tox`


---

Comment by mkoeppe created at 2020-08-31 17:02:32

Needs review.


---

Comment by git created at 2020-09-01 21:22:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-09-04 19:50:02

I like it. It saves you from waiting on the patchbots to do trivial stuff.

As for the python3 style. That is still helpful. Iterator classes will probably still take `.next()`, but you shouldn't use it anymore and at some point, this should be removed.

Works for me.

`@`gh-tobiasdiez: Do you have anything that needs changing yet.


---

Comment by @tobiasdiez created at 2020-09-04 20:01:06

No, it looks fine for me as well (given that #30474 is addressed at some point).


---

Comment by mkoeppe created at 2020-09-04 22:41:00

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-04 22:41:00

Thanks!


---

Comment by vbraun created at 2020-09-18 20:22:46

Resolution: fixed
