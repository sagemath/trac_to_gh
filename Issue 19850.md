# Issue 19850: `E(message)` for a linear code encoder `E` should encode `message`

Issue created by migration from Trac.

Original creator: jsrn

Original creation time: 2016-02-19 15:58:59

CC:  dlucas cpernet jlavauzelle danielaugot

If `E` is an `Encoder` for a `LinearCode`, one can use `E.encode(message)`, where `message` is in the appropriate space. `E(message)` should default to the same behaviour.


---

Comment by git created at 2016-02-22 11:58:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-02-22 11:59:26

Changing status from new to needs_review.


---

Comment by dlucas created at 2016-02-22 11:59:26

`E(message)` now defaults to `E.encode(message)`.
I added a few lines to the documentation of `encode` in `encoder.py` and in `GRSEvaluationPolynomialEncoder` to highlight this shortcut.

Setting this as `needs_review`.
----
New commits:


---

Comment by dlucas created at 2016-02-22 16:14:36

Changing keywords from "" to "beginner".


---

Comment by git created at 2016-02-25 15:52:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-02-25 15:54:43

I added the same mechanism with codes: let `C` be a code, and `m` an element from the message space of the encoder `'encoder'`.

`C(m, encoder_name='encoder')` is now a shortcut to `C.encode(m, encoder_name='encoder')`


---

Comment by dlucas created at 2016-03-18 13:42:56

There's a doctest failing which indicates the test suite is broken for codes.
That's because in the test suite, there's an idempotency test for element construction.

It picks `c = C.an_element()` and then tries `C(c)`... Which of course fails in our case as `__call__` has been redefined as `encode` - and the input of encode cannot be an element of `C`.


---

Comment by dlucas created at 2016-03-18 14:53:58

Because of the above, which is related to the way linear codes are set in the category framework, it seems impossible to do the proposed improvement.

Setting this to invalid/won't fix.


---

Comment by jsrn created at 2016-03-31 12:51:36

Changing status from needs_review to needs_work.


---

Comment by jsrn created at 2016-03-31 12:51:36

This issue is not a show-stopper: instead of `__call__` simply aliasing `self.encode`, it is a proper method which checks its input. If the input is a codeword, it returns that unchanged. If the input has the correct length of a message, return the encoded codeword, via `self.encode`. Otherwise, throw a `ValueError`.

Re-opening.


---

Comment by git created at 2016-03-31 14:25:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-03-31 14:29:38

Changing status from needs_work to needs_review.


---

Comment by dlucas created at 2016-03-31 14:29:38

Done.
Except for the `ValueError`. If the input is not a codeword, it passes it to `encode` which does the check. As `encode` knows the message space of the encoder to use, it returns a nice error message which specifies the expected input (e.g. "The value to encode must be in Vector space of dimension 4 over Finite Field of size 2").

Maybe leave this review for Daniel as he wanted to do it? I just Cc'd him on this ticket.


---

Comment by panda314 created at 2016-04-01 11:40:51

Hi, Maybe the check of whether the vector passed is a codeword or not can be done before passing it to the encode function. That way if a user means to pass a codeword rather than the message, and passed th wrong vector, he/she will be notified.


---

Comment by jsrn created at 2016-04-01 12:02:24

David, didn't you accidentally put the Encoder-related code on the GRS encoder? It should be on the abstract class `Encoder`. Also, the check `if m in self` should be `if m in self.code()` on the Encoder. And your doc-test there doesn't test that method.

Replying to [comment:12 panda314]:
> Hi, Maybe the check of whether the vector passed is a codeword or not can be done before passing it to the encode function. That way if a user means to pass a codeword rather than the message, and passed th wrong vector, he/she will be notified. 

As far as I can see, the check in `LinearCode` *does* check for code membership before passing it to the encoder.


---

Comment by git created at 2016-04-01 12:15:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-04-01 12:21:53

Hello,

> David, didn't you accidentally put the Encoder-related code on the GRS encoder? 

Indeed, I removed it.

> It should be on the abstract class Encoder.

Should it? IMHO, there's nothing elaborate to do for the encoder. If one creates a code `C` and an encoder `E` for `C`, and types `E(c)` for some `c`, if `c` does not belong to the message space of `E` it should fail. To me, the only purpose of an encoder is to transform elements of the message space into codeword. So if one passes an element which does not belong to the message space, failing makes sense.

> As far as I can see, the check in LinearCode *does* check for code membership before passing it to the encoder.

I think he meant if one tries to pass an element of the ambient space of the code which does not belong to the code. I added a check for that: as I cannot picture an encoder whose message space is the ambient space of the code, it makes sense to immediately reject vectors which are in the ambient space but not in the code, as it avoids calling `encode` and thus constructing an encoder for nothing.


---

Comment by jsrn created at 2016-04-01 12:34:00

> Should it? IMHO, there's nothing elaborate to do for the encoder. If one creates a code `C` and an encoder `E` for `C`, and types `E(c)` for some `c`, if `c` does not belong to the message space of `E` it should fail. To me, the only purpose of an encoder is to transform elements of the message space into codeword. So if one passes an element which does not belong to the message space, failing makes sense.

Oh yeah, you're right. But this patch then still adds the alias `Encoder.__call__` as `Encoder.encode`, I presume?

> I think he meant if one tries to pass an element of the ambient space of the code which does not belong to the code. I added a check for that: as I cannot picture an encoder whose message space is the ambient space of the code, it makes sense to immediately reject vectors which are in the ambient space but not in the code, as it avoids calling `encode` and thus constructing an encoder for nothing.

Hm, makes sense. You have a typo in the error message though (is -> it)


---

Comment by git created at 2016-04-01 12:51:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-04-01 12:52:16

> Oh yeah, you're right. But this patch then still adds the alias Encoder.__call__ as Encoder.encode, I presume?

Indeed. I fixed that.

> Hm, makes sense. You have a typo in the error message though (is -> it)

Oops. Fixed too.


---

Comment by jsrn created at 2016-04-01 13:02:31

Replying to [comment:18 dlucas]:
> > Oh yeah, you're right. But this patch then still adds the alias Encoder.__call__ as Encoder.encode, I presume?
> 
> Indeed. I fixed that.

You added it to GRS, not to Encoder...


---

Comment by dlucas created at 2016-04-01 13:13:48

> You added it to GRS, not to Encoder...

Err yes, because `encode` is overridden in the polynomial encoder for GRS codes.
The alias is already added to `encoder.py`, and `E(m)` encodes `m` if possible.


---

Comment by jsrn created at 2016-04-01 13:50:08

> Err yes, because `encode` is overridden in the polynomial encoder for GRS codes.
> The alias is already added to `encoder.py`, and `E(m)` encodes `m` if possible.

Ouch, that's a super-nasty trap! All encoders written in the future will fall into this!

I vote for *not* defining `Encoder.__call__` as an alias, then, but instead rely on dynamic dispatch to avoid the trap:


```
    def __call__(self, m):
        return self.encode(m)
```



---

Comment by git created at 2016-04-01 14:07:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dlucas created at 2016-04-01 14:08:06

> I vote for *not* defining `Encoder.__call__` as an alias, then, but instead rely on dynamic dispatch to avoid the trap

Yes, it's a good idea. Done in the last commit.


---

Comment by panda314 created at 2016-04-01 15:45:18

are the changes compiling? The copy of this branch is not compiling on my local pc (new to sage, am i missing something?). Here's the error:
InternalError: Internal compiler error: 'cysignals/signals.pxi' not found

Detailed message is,

Traceback (most recent call last):
  File "setup.py", line 590, in <module>
    run_cythonize()
  File "setup.py", line 582, in run_cythonize
    'profile': profile,
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 758, in cythonize
    aliases=aliases)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 664, in create_extension_list
    kwds = deps.distutils_info(file, aliases, base).values
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 564, in distutils_info
    return (self.transitive_merge(filename, self.distutils_info0, DistutilsInfo.merge)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 574, in transitive_merge
    node, extract, merge, seen, {}, self.cimported_files)![0]
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 579, in transitive_merge_helper
    deps = extract(node)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 555, in distutils_info0
    externs = self.cimports_and_externs(filename)![1]
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Utils.py", line 43, in wrapper
    res = cache[args] = f(self, *args)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 465, in cimports_and_externs
    for include in self.included_files(filename):
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Utils.py", line 43, in wrapper
    res = cache[args] = f(self, *args)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 448, in included_files
    include_path = self.context.find_include_file(include, None)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Compiler/Main.py", line 274, in find_include_file
    error(pos, "'%s' not found" % filename)
  File "/home/panda/sage/local/lib/python2.7/site-packages/Cython-0.23.3-py2.7-linux-x86_64.egg/Cython/Compiler/Errors.py", line 177, in error
    raise InternalError(message)
InternalError: Internal compiler error: 'cysignals/signals.pxi' not found
************************************************************************
Error building the Sage library
************************************************************************
make: *** [sage] Error 1


---

Comment by dlucas created at 2016-04-01 16:19:45

It's compiling on my side. According to the error report you sent, a file is missing on your side.
I guess you'll have to download Sage again and recompile it...


---

Comment by danielaugot created at 2016-08-24 10:10:25

I used the terminology "ambient space" in the doc string, to avoid being specific in details. Daniel
----
New commits:


---

Comment by git created at 2016-08-24 18:04:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-24 18:56:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-24 19:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jsrn created at 2016-09-12 09:09:30

I mistakenly pushed another branch on top of this one. I've reverted it now -- sorry for the noise.


---

Comment by cpernet created at 2017-02-07 09:18:29

Changing keywords from "beginner" to "beginner, rd3".


---

Comment by cpernet created at 2017-02-07 09:18:29

Doc string of the `__call__` method of encoder (encoder.py:187) should test whether `E(p)` works not `E.encode(p)`.


---

Comment by git created at 2017-02-07 09:34:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cpernet created at 2017-02-07 09:36:16

Changing status from needs_review to positive_review.


---

Comment by cpernet created at 2017-02-07 09:36:16

It's all good, after the two minor docstring edits that I've pushed to the ticket. Positive review.


---

Comment by vbraun created at 2017-02-08 22:48:53

Resolution: fixed
