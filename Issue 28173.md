# Issue 28173: Bug with docker image sagemath/sagemath-dev:develop

Issue created by migration from https://trac.sagemath.org/ticket/28410

Original creator: mercatp

Original creation time: 2019-08-26 22:48:10

CC:  vdelecroix saraedum cpernet fbissey

When we run the docker image with


```
$docker run -it sagemath/sagemath-dev:develop
```


the following code fail:


```
sage@56153d827f26:~/sage$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.9.beta8, Release Date: 2019-08-25               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Setting permissions of DOT_SAGE directory so only you can read and write it.
sage: m = identity_matrix(2)
sage: m.charpoly()
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-2-caa4c4748463> in <module>()
----> 1 m.charpoly()

/home/sage/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense.pyx in sage.matrix.matrix_integer_dense.Matrix_integer_dense.charpoly (build/cythonized/sage/matrix/matrix_integer_dense.c:12819)()
   1337         elif algorithm == 'linbox':
   1338             g = (<Polynomial_integer_dense_flint> PolynomialRing(ZZ, names=var).gen())._new()
-> 1339             sig_on()
   1340             linbox_fmpz_mat_charpoly(g.__poly, self._matrix)
   1341             sig_off()

SignalError: Illegal instruction
sage: 
```



---

Comment by mercatp created at 2019-08-26 22:49:22

Changing component from PLEASE CHANGE to linear algebra.


---

Comment by mercatp created at 2019-08-26 22:49:22

Changing type from PLEASE CHANGE to defect.


---

Comment by vdelecroix created at 2019-08-27 08:42:55

Most likely, the docker image is built with a set of CPU instructions that is not supported by all computers. That can be because the built script is not careful about that or that some library (here libox) are just ignoring some configuration variables...


---

Comment by cpernet created at 2019-08-27 08:56:06

Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.
You can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.
I assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:

```
 --disable-avx2 --disable-avx --disable-fma --disable-fma4
```


You may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.


---

Comment by saraedum created at 2019-09-15 12:32:20

Sorry, I had not seen this ticket (though I am on CC.)

Replying to [comment:4 cpernet]:
> Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.
> You can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.
> I assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:
> {{{
>  --disable-avx2 --disable-avx --disable-fma --disable-fma4
> }}}
> 
> You may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.

I believe we should use the flags that we use on conda https://github.com/conda-forge/linbox-feedstock/blob/master/recipe/build.sh. I remember we did some research there so these are very widely supported.

Do you know how we can pass these flags without patching the SPKG?


---

Comment by saraedum created at 2019-09-15 12:38:50

There's `LINBOX_CONFIGURE`, `FFLAS_FFPACK_CONFIGURE`, `GIVARO_CONFIGURE`. Let's set them in the docker build.


---

Comment by saraedum created at 2019-09-15 12:39:58

I need some docker build fixes from #28041 to be able to test this in CI.


---

Comment by saraedum created at 2019-09-15 12:42:04

Actually, we build the docker images with SAGE_FAT_BINARY=yes:

https://gitlab.com/sagemath/sage/blob/master/docker/Dockerfile#L159


---

Comment by saraedum created at 2019-09-15 12:56:49

The build log for `8.9.beta8` that you were using says:

```
[linbox-1.6.3] -----------------------------------------------
[linbox-1.6.3]         START  LINBOX CONFIG                   
[linbox-1.6.3] -----------------------------------------------
[linbox-1.6.3] Detecting SIMD instruction set
[linbox-1.6.3] SSE disabled
[linbox-1.6.3] SSE2 disabled
[linbox-1.6.3] SSE3 disabled
[linbox-1.6.3] SSSE3 disabled
[linbox-1.6.3] SSE4.1 disabled
[linbox-1.6.3] SSE4.2 disabled
[linbox-1.6.3] AVX disabled
[linbox-1.6.3] AVX2 disabled
[linbox-1.6.3] FMA3 disabled
[linbox-1.6.3] FMA4 disabled
```


However, fflas-ffpack says:

```
[fflas_ffpack-2.4.3] Detecting SIMD instruction set
[fflas_ffpack-2.4.3] SSE disabled
[fflas_ffpack-2.4.3] SSE2 disabled
[fflas_ffpack-2.4.3] SSE3 disabled
[fflas_ffpack-2.4.3] SSSE3 disabled
[fflas_ffpack-2.4.3] SSE4.1 disabled
[fflas_ffpack-2.4.3] SSE4.2 disabled
[fflas_ffpack-2.4.3] AVX disabled
[fflas_ffpack-2.4.3] AVX2 disabled
[fflas_ffpack-2.4.3] AVX512F enabled
[fflas_ffpack-2.4.3] AVX512VL enabled
[fflas_ffpack-2.4.3] AVX512DQ enabled
[fflas_ffpack-2.4.3] FMA3 disabled
[fflas_ffpack-2.4.3] FMA4 disabled
```


Could that be the problem?


---

Comment by saraedum created at 2019-09-15 13:08:52

Once #28041 has been merged, I can schedule a manual pipeline from GitLab's web interface. Once that has completed, mercatp should check that this actually makes the docker image work for him :)
----
New commits:


---

Comment by saraedum created at 2019-09-15 13:08:52

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-09-15 21:19:53

There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.


---

Comment by fbissey created at 2019-09-15 21:27:13

Replying to [comment:13 gh-mwageringel]:
> There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.

Yes indeed, and that last commit is what is needed from that discussion. If I remember correctly the macros are all included in `givaro`, `fflas-ffpack` and `linbox`. Currently most of them only have an effect on `fflas-ffpack` but it would be a good idea to extend fat binary setting across all three packages.


---

Comment by vdelecroix created at 2019-09-22 18:08:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-03 17:57:55

Resolution: fixed
