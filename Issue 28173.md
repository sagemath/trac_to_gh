# Issue 28173: Bug with docker image sagemath/sagemath-dev:develop

archive/issues_028173.json:
```json
{
    "body": "CC:  @videlec @saraedum @ClementPernet @kiwifb\n\nWhen we run the docker image with\n\n```\n$docker run -it sagemath/sagemath-dev:develop\n```\n\nthe following code fail:\n\n```\nsage@56153d827f26:~/sage$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.9.beta8, Release Date: 2019-08-25               \u2502\n\u2502 Using Python 2.7.15. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nSetting permissions of DOT_SAGE directory so only you can read and write it.\nsage: m = identity_matrix(2)\nsage: m.charpoly()\n---------------------------------------------------------------------------\nSignalError                               Traceback (most recent call last)\n<ipython-input-2-caa4c4748463> in <module>()\n----> 1 m.charpoly()\n\n/home/sage/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense.pyx in sage.matrix.matrix_integer_dense.Matrix_integer_dense.charpoly (build/cythonized/sage/matrix/matrix_integer_dense.c:12819)()\n   1337         elif algorithm == 'linbox':\n   1338             g = (<Polynomial_integer_dense_flint> PolynomialRing(ZZ, names=var).gen())._new()\n-> 1339             sig_on()\n   1340             linbox_fmpz_mat_charpoly(g.__poly, self._matrix)\n   1341             sig_off()\n\nSignalError: Illegal instruction\nsage: \n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/28410\n\n",
    "created_at": "2019-08-26T22:48:10Z",
    "labels": [],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Bug with docker image sagemath/sagemath-dev:develop",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28173",
    "user": "https://trac.sagemath.org/admin/accounts/users/mercatp"
}
```
CC:  @videlec @saraedum @ClementPernet @kiwifb

When we run the docker image with

```
$docker run -it sagemath/sagemath-dev:develop
```

the following code fail:

```
sage@56153d827f26:~/sage$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.9.beta8, Release Date: 2019-08-25               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Setting permissions of DOT_SAGE directory so only you can read and write it.
sage: m = identity_matrix(2)
sage: m.charpoly()
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-2-caa4c4748463> in <module>()
----> 1 m.charpoly()

/home/sage/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_integer_dense.pyx in sage.matrix.matrix_integer_dense.Matrix_integer_dense.charpoly (build/cythonized/sage/matrix/matrix_integer_dense.c:12819)()
   1337         elif algorithm == 'linbox':
   1338             g = (<Polynomial_integer_dense_flint> PolynomialRing(ZZ, names=var).gen())._new()
-> 1339             sig_on()
   1340             linbox_fmpz_mat_charpoly(g.__poly, self._matrix)
   1341             sig_off()

SignalError: Illegal instruction
sage: 
```

Issue created by migration from https://trac.sagemath.org/ticket/28410





---

archive/issue_comments_397307.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to linear algebra.",
    "created_at": "2019-08-26T22:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397307",
    "user": "https://trac.sagemath.org/admin/accounts/users/mercatp"
}
```

Changing component from PLEASE CHANGE to linear algebra.



---

archive/issue_comments_397308.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-08-26T22:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397308",
    "user": "https://trac.sagemath.org/admin/accounts/users/mercatp"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_397309.json:
```json
{
    "body": "Most likely, the docker image is built with a set of CPU instructions that is not supported by all computers. That can be because the built script is not careful about that or that some library (here libox) are just ignoring some configuration variables...",
    "created_at": "2019-08-27T08:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397309",
    "user": "https://github.com/videlec"
}
```

Most likely, the docker image is built with a set of CPU instructions that is not supported by all computers. That can be because the built script is not careful about that or that some library (here libox) are just ignoring some configuration variables...



---

archive/issue_comments_397310.json:
```json
{
    "body": "Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.\nYou can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.\nI assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:\n\n```\n --disable-avx2 --disable-avx --disable-fma --disable-fma4\n```\n\nYou may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.",
    "created_at": "2019-08-27T08:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397310",
    "user": "https://github.com/ClementPernet"
}
```

Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.
You can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.
I assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:

```
 --disable-avx2 --disable-avx --disable-fma --disable-fma4
```

You may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.



---

archive/issue_comments_397311.json:
```json
{
    "body": "Sorry, I had not seen this ticket (though I am on CC.)\n\nReplying to [comment:4 cpernet]:\n> Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.\n> You can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.\n> I assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:\n> \n> ```\n>  --disable-avx2 --disable-avx --disable-fma --disable-fma4\n> ```\n> \n> You may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.\n\n\nI believe we should use the flags that we use on conda https://github.com/conda-forge/linbox-feedstock/blob/master/recipe/build.sh. I remember we did some research there so these are very widely supported.\n\nDo you know how we can pass these flags without patching the SPKG?",
    "created_at": "2019-09-15T12:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397311",
    "user": "https://github.com/saraedum"
}
```

Sorry, I had not seen this ticket (though I am on CC.)

Replying to [comment:4 cpernet]:
> Indeed, givaro, fflas_ffpack and linbox detect available instruction sets at configure time.
> You can force disable them by passing a `--disable-XXX` argument to the call to configure in the spkg-install files.
> I assume the following sequence would do the job for portability on any x86 or i686 up to nehalem:
> 
> ```
>  --disable-avx2 --disable-avx --disable-fma --disable-fma4
> ```
> 
> You may add `--disable-sse42 --disable-sse41 --disable-ssse3 --disable-sse3` if you want to support older micro-archs.


I believe we should use the flags that we use on conda https://github.com/conda-forge/linbox-feedstock/blob/master/recipe/build.sh. I remember we did some research there so these are very widely supported.

Do you know how we can pass these flags without patching the SPKG?



---

archive/issue_comments_397312.json:
```json
{
    "body": "There's `LINBOX_CONFIGURE`, `FFLAS_FFPACK_CONFIGURE`, `GIVARO_CONFIGURE`. Let's set them in the docker build.",
    "created_at": "2019-09-15T12:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397312",
    "user": "https://github.com/saraedum"
}
```

There's `LINBOX_CONFIGURE`, `FFLAS_FFPACK_CONFIGURE`, `GIVARO_CONFIGURE`. Let's set them in the docker build.



---

archive/issue_comments_397313.json:
```json
{
    "body": "I need some docker build fixes from #28041 to be able to test this in CI.",
    "created_at": "2019-09-15T12:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397313",
    "user": "https://github.com/saraedum"
}
```

I need some docker build fixes from #28041 to be able to test this in CI.



---

archive/issue_comments_397314.json:
```json
{
    "body": "Actually, we build the docker images with SAGE_FAT_BINARY=yes:\n\nhttps://gitlab.com/sagemath/sage/blob/master/docker/Dockerfile#L159",
    "created_at": "2019-09-15T12:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397314",
    "user": "https://github.com/saraedum"
}
```

Actually, we build the docker images with SAGE_FAT_BINARY=yes:

https://gitlab.com/sagemath/sage/blob/master/docker/Dockerfile#L159



---

archive/issue_comments_397315.json:
```json
{
    "body": "The build log for `8.9.beta8` that you were using says:\n\n```\n[linbox-1.6.3] -----------------------------------------------\n[linbox-1.6.3]         START  LINBOX CONFIG                   \n[linbox-1.6.3] -----------------------------------------------\n[linbox-1.6.3] Detecting SIMD instruction set\n[linbox-1.6.3] SSE disabled\n[linbox-1.6.3] SSE2 disabled\n[linbox-1.6.3] SSE3 disabled\n[linbox-1.6.3] SSSE3 disabled\n[linbox-1.6.3] SSE4.1 disabled\n[linbox-1.6.3] SSE4.2 disabled\n[linbox-1.6.3] AVX disabled\n[linbox-1.6.3] AVX2 disabled\n[linbox-1.6.3] FMA3 disabled\n[linbox-1.6.3] FMA4 disabled\n```\n\nHowever, fflas-ffpack says:\n\n```\n[fflas_ffpack-2.4.3] Detecting SIMD instruction set\n[fflas_ffpack-2.4.3] SSE disabled\n[fflas_ffpack-2.4.3] SSE2 disabled\n[fflas_ffpack-2.4.3] SSE3 disabled\n[fflas_ffpack-2.4.3] SSSE3 disabled\n[fflas_ffpack-2.4.3] SSE4.1 disabled\n[fflas_ffpack-2.4.3] SSE4.2 disabled\n[fflas_ffpack-2.4.3] AVX disabled\n[fflas_ffpack-2.4.3] AVX2 disabled\n[fflas_ffpack-2.4.3] AVX512F enabled\n[fflas_ffpack-2.4.3] AVX512VL enabled\n[fflas_ffpack-2.4.3] AVX512DQ enabled\n[fflas_ffpack-2.4.3] FMA3 disabled\n[fflas_ffpack-2.4.3] FMA4 disabled\n```\n\nCould that be the problem?",
    "created_at": "2019-09-15T12:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397315",
    "user": "https://github.com/saraedum"
}
```

The build log for `8.9.beta8` that you were using says:

```
[linbox-1.6.3] -----------------------------------------------
[linbox-1.6.3]         START  LINBOX CONFIG                   
[linbox-1.6.3] -----------------------------------------------
[linbox-1.6.3] Detecting SIMD instruction set
[linbox-1.6.3] SSE disabled
[linbox-1.6.3] SSE2 disabled
[linbox-1.6.3] SSE3 disabled
[linbox-1.6.3] SSSE3 disabled
[linbox-1.6.3] SSE4.1 disabled
[linbox-1.6.3] SSE4.2 disabled
[linbox-1.6.3] AVX disabled
[linbox-1.6.3] AVX2 disabled
[linbox-1.6.3] FMA3 disabled
[linbox-1.6.3] FMA4 disabled
```

However, fflas-ffpack says:

```
[fflas_ffpack-2.4.3] Detecting SIMD instruction set
[fflas_ffpack-2.4.3] SSE disabled
[fflas_ffpack-2.4.3] SSE2 disabled
[fflas_ffpack-2.4.3] SSE3 disabled
[fflas_ffpack-2.4.3] SSSE3 disabled
[fflas_ffpack-2.4.3] SSE4.1 disabled
[fflas_ffpack-2.4.3] SSE4.2 disabled
[fflas_ffpack-2.4.3] AVX disabled
[fflas_ffpack-2.4.3] AVX2 disabled
[fflas_ffpack-2.4.3] AVX512F enabled
[fflas_ffpack-2.4.3] AVX512VL enabled
[fflas_ffpack-2.4.3] AVX512DQ enabled
[fflas_ffpack-2.4.3] FMA3 disabled
[fflas_ffpack-2.4.3] FMA4 disabled
```

Could that be the problem?



---

archive/issue_comments_397316.json:
```json
{
    "body": "Once #28041 has been merged, I can schedule a manual pipeline from GitLab's web interface. Once that has completed, mercatp should check that this actually makes the docker image work for him :)\n\n---\nNew commits:",
    "created_at": "2019-09-15T13:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397316",
    "user": "https://github.com/saraedum"
}
```

Once #28041 has been merged, I can schedule a manual pipeline from GitLab's web interface. Once that has completed, mercatp should check that this actually makes the docker image work for him :)

---
New commits:



---

archive/issue_comments_397317.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-15T13:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397317",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_397318.json:
```json
{
    "body": "There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.",
    "created_at": "2019-09-15T21:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397318",
    "user": "https://github.com/mwageringel"
}
```

There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.



---

archive/issue_comments_397319.json:
```json
{
    "body": "Replying to [comment:13 gh-mwageringel]:\n> There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.\n\n\nYes indeed, and that last commit is what is needed from that discussion. If I remember correctly the macros are all included in `givaro`, `fflas-ffpack` and `linbox`. Currently most of them only have an effect on `fflas-ffpack` but it would be a good idea to extend fat binary setting across all three packages.",
    "created_at": "2019-09-15T21:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397319",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:13 gh-mwageringel]:
> There was a related discussion on [sage-release](https://groups.google.com/d/msg/sage-release/x13Ug2AXNdE/uiKw4pONFgAJ) a few weeks ago.


Yes indeed, and that last commit is what is needed from that discussion. If I remember correctly the macros are all included in `givaro`, `fflas-ffpack` and `linbox`. Currently most of them only have an effect on `fflas-ffpack` but it would be a good idea to extend fat binary setting across all three packages.



---

archive/issue_comments_397320.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-22T18:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397320",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_071022.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2019-09-22T18:08:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28173#event-71022"
}
```



---

archive/issue_events_071023.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-10-03T17:57:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28173#event-71023"
}
```



---

archive/issue_comments_397321.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-03T17:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28173",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28173#issuecomment-397321",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
