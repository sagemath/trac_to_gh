# Issue 28771: Move sage.rings.homset to the "new" coercion model

Issue created by migration from https://trac.sagemath.org/ticket/29008

Original creator: pbruin

Original creation time: 2020-01-14 11:01:33

The classes `RingHomset_generic` and `RingHomset_quo_ring` in `sage.rings.homset` still have a custom `__call__()` method and an old-style `_coerce_impl()`.  The goal of this ticket is to merge these into a simpler `_element_constructor_()` method.  This is a prerequisite for #28869.

Note on the changed doctest in `sage.categories.modules_with_basis`: `pAdicWeightSpace` is one of the few remaining parents that do not use the new coercion model.  There are a few more (Hecke algebras, lazy power series rings), but these cannot be used in this doctest because their element are not hashable.


---

Comment by pbruin created at 2020-01-14 11:05:03

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-01-14 17:11:15

It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.


---

Comment by git created at 2020-01-15 13:21:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2020-01-15 13:27:19

Replying to [comment:2 tscrim]:
> It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.
I agree that `_element_constructor_()` should normally return instances of `element_class`.  I'm not sure if there is anything that obviously goes wrong if it doesn't, and I didn't come across such problems, but is better not to take risks, though, and the last commit fixes this.

Note that `element_class` is now `RingHomomorphism` (not a dynamically created subclass) since the latter is a Cython class, so the types that can be returned (`RingHomomorphism_{im_gens,cover,from_base}`) are indeed subclasses of it.


---

Comment by pbruin created at 2020-01-15 13:29:41

While looking into this I did come across something that looks like a bug:

```
sage: R.<x> = ZZ[]
sage: Q = R.quo(x - 1)
sage: H = R.Hom(Q)
sage: h = R.hom(Q)
sage: h in H
False
sage: h.parent() == H
False
```

This already happens without this branch, so I suggest fixing this in a separate ticket.


---

Comment by pbruin created at 2020-01-15 14:27:59

Replying to [comment:5 pbruin]:
> While looking into this I did come across something that looks like a bug:
> {{{
> sage: R.<x> = ZZ[]
> sage: Q = R.quo(x - 1)
> sage: H = R.Hom(Q)
> sage: h = R.hom(Q)
> sage: h in H
> False
> sage: h.parent() == H
> False
> }}}
> This already happens without this branch, so I suggest fixing this in a separate ticket.
This is now #29017.


---

Comment by tscrim created at 2020-01-16 04:32:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-01-16 04:32:06

Okay, thanks for looking into it. LGTM.


---

Comment by vbraun created at 2020-01-20 21:17:36

Resolution: fixed
