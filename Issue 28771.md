# Issue 28771: Move sage.rings.homset to the "new" coercion model

archive/issues_028771.json:
```json
{
    "body": "The classes `RingHomset_generic` and `RingHomset_quo_ring` in `sage.rings.homset` still have a custom `__call__()` method and an old-style `_coerce_impl()`.  The goal of this ticket is to merge these into a simpler `_element_constructor_()` method.  This is a prerequisite for #28869.\n\nNote on the changed doctest in `sage.categories.modules_with_basis`: `pAdicWeightSpace` is one of the few remaining parents that do not use the new coercion model.  There are a few more (Hecke algebras, lazy power series rings), but these cannot be used in this doctest because their element are not hashable.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29008\n\n",
    "created_at": "2020-01-14T11:01:33Z",
    "labels": [
        "coercion",
        "minor",
        "enhancement"
    ],
    "title": "Move sage.rings.homset to the \"new\" coercion model",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28771",
    "user": "pbruin"
}
```
The classes `RingHomset_generic` and `RingHomset_quo_ring` in `sage.rings.homset` still have a custom `__call__()` method and an old-style `_coerce_impl()`.  The goal of this ticket is to merge these into a simpler `_element_constructor_()` method.  This is a prerequisite for #28869.

Note on the changed doctest in `sage.categories.modules_with_basis`: `pAdicWeightSpace` is one of the few remaining parents that do not use the new coercion model.  There are a few more (Hecke algebras, lazy power series rings), but these cannot be used in this doctest because their element are not hashable.

Issue created by migration from https://trac.sagemath.org/ticket/29008





---

archive/issue_comments_406372.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-01-14T11:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406372",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406373.json:
```json
{
    "body": "It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.",
    "created_at": "2020-01-14T17:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406373",
    "user": "tscrim"
}
```

It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.



---

archive/issue_comments_406374.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T13:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406374",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406375.json:
```json
{
    "body": "Replying to [comment:2 tscrim]:\n> It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.\nI agree that `_element_constructor_()` should normally return instances of `element_class`.  I'm not sure if there is anything that obviously goes wrong if it doesn't, and I didn't come across such problems, but is better not to take risks, though, and the last commit fixes this.\n\nNote that `element_class` is now `RingHomomorphism` (not a dynamically created subclass) since the latter is a Cython class, so the types that can be returned (`RingHomomorphism_{im_gens,cover,from_base}`) are indeed subclasses of it.",
    "created_at": "2020-01-15T13:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406375",
    "user": "pbruin"
}
```

Replying to [comment:2 tscrim]:
> It would be great to get this done. Do we have any doctests that return a morphism that is not an instance of the `element_class`? I have a recollection I tried that once and it didn't work. Specifically, I think this was when I implemented the crystal morphisms, which is why it uses the same setup as the ring morphisms, but it might have been just when returning a non-`Element` instance (e.g., a Python `list`). However, that was a few years ago, so things might have changed.
I agree that `_element_constructor_()` should normally return instances of `element_class`.  I'm not sure if there is anything that obviously goes wrong if it doesn't, and I didn't come across such problems, but is better not to take risks, though, and the last commit fixes this.

Note that `element_class` is now `RingHomomorphism` (not a dynamically created subclass) since the latter is a Cython class, so the types that can be returned (`RingHomomorphism_{im_gens,cover,from_base}`) are indeed subclasses of it.



---

archive/issue_comments_406376.json:
```json
{
    "body": "While looking into this I did come across something that looks like a bug:\n\n```\nsage: R.<x> = ZZ[]\nsage: Q = R.quo(x - 1)\nsage: H = R.Hom(Q)\nsage: h = R.hom(Q)\nsage: h in H\nFalse\nsage: h.parent() == H\nFalse\n```\n\nThis already happens without this branch, so I suggest fixing this in a separate ticket.",
    "created_at": "2020-01-15T13:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406376",
    "user": "pbruin"
}
```

While looking into this I did come across something that looks like a bug:

```
sage: R.<x> = ZZ[]
sage: Q = R.quo(x - 1)
sage: H = R.Hom(Q)
sage: h = R.hom(Q)
sage: h in H
False
sage: h.parent() == H
False
```

This already happens without this branch, so I suggest fixing this in a separate ticket.



---

archive/issue_comments_406377.json:
```json
{
    "body": "Replying to [comment:5 pbruin]:\n> While looking into this I did come across something that looks like a bug:\n> {{{\n> sage: R.<x> = ZZ[]\n> sage: Q = R.quo(x - 1)\n> sage: H = R.Hom(Q)\n> sage: h = R.hom(Q)\n> sage: h in H\n> False\n> sage: h.parent() == H\n> False\n> }}}\n> This already happens without this branch, so I suggest fixing this in a separate ticket.\nThis is now #29017.",
    "created_at": "2020-01-15T14:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406377",
    "user": "pbruin"
}
```

Replying to [comment:5 pbruin]:
> While looking into this I did come across something that looks like a bug:
> {{{
> sage: R.<x> = ZZ[]
> sage: Q = R.quo(x - 1)
> sage: H = R.Hom(Q)
> sage: h = R.hom(Q)
> sage: h in H
> False
> sage: h.parent() == H
> False
> }}}
> This already happens without this branch, so I suggest fixing this in a separate ticket.
This is now #29017.



---

archive/issue_comments_406378.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-16T04:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406378",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406379.json:
```json
{
    "body": "Okay, thanks for looking into it. LGTM.",
    "created_at": "2020-01-16T04:32:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406379",
    "user": "tscrim"
}
```

Okay, thanks for looking into it. LGTM.



---

archive/issue_comments_406380.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-20T21:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28771#issuecomment-406380",
    "user": "vbraun"
}
```

Resolution: fixed
