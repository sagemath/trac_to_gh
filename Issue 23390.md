# Issue 23390: Update points() in projective_homset.py to work over CC

Issue created by migration from Trac.

Original creator: rlmiller

Original creation time: 2017-08-16 18:30:18

CC:  paul fili

Updated numerical point finding in the projective_homset.py file to work over the complex numbers.


---

Comment by rlmiller created at 2017-08-16 18:32:00

New commits:


---

Comment by rlmiller created at 2017-08-16 18:32:00

Changing status from new to needs_review.


---

Comment by git created at 2017-08-24 01:34:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rlmiller created at 2017-08-24 20:15:40

Changing priority from major to minor.


---

Comment by bhutz created at 2017-08-25 14:26:04

Changing type from PLEASE CHANGE to enhancement.


---

Comment by bhutz created at 2017-08-25 14:26:04

Changing component from dynamics to algebraic geometry.


---

Comment by bhutz created at 2017-08-25 14:26:04

This ticket and #23693 have the same branch and contains both the changes for affine_homset and projective_homset. What did you mean to do with these two tickets?

Otherwise, just a few minor things:

- CDF should work in addition to CC

- a couple of the comments in the affine_homset reference projective. Fix those.

- the sorting line is commented out in affine_homset and should be restored

- You need to update the docmentation of .rational_points() to describe the changes and add an example there.


---

Comment by bhutz created at 2017-08-25 14:26:04

Changing status from needs_review to needs_work.


---

Comment by raghukul01 created at 2018-05-15 08:06:02

Rebase from current master


---

Comment by git created at 2018-05-15 19:36:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by raghukul01 created at 2018-05-16 18:57:50

Changing keywords from "" to "gsoc2018".


---

Comment by git created at 2018-05-17 17:05:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-17 17:40:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by bhutz created at 2018-05-17 19:10:17

Just a couple simple comments before I test functionality.

Instead of importing, its better to use members function whenever possible (i.e., .floor())

The two for loops

```
for i in range(len(dupl_points)):
    for j in range(len(dupl_points)):
        if j > i:
            u = dupl_points[i]
```

can be simplified to

```
for i in range(len(dupl_points)):
    u = dupl_points[i]
    for j in range(i+1, len(dupl_points)):
```



---

Comment by raghukul01 created at 2018-05-17 19:34:58

Actually after product with tolerance, the result becomes float, and hence floor(), member function doesn't exist. So there are 2 options

1) Convert tolerance to RealNumber and then use .floor()

2) use floor from math

currently I implemented using 2), should I change to 1)? or do you have any other idea?

Thanks

Replying to [comment:12 bhutz]:
> Just a couple simple comments before I test functionality.
> 
> Instead of importing, its better to use members function whenever possible (i.e., .floor())
> 
> The two for loops
> {{{
> for i in range(len(dupl_points)):
>     for j in range(len(dupl_points)):
>         if j > i:
>             u = dupl_points[i]
> }}}
> can be simplified to
> {{{
> for i in range(len(dupl_points)):
>     u = dupl_points[i]
>     for j in range(i+1, len(dupl_points)):
> }}}


---

Comment by bhutz created at 2018-05-17 19:38:53

I would do 1) since you should do basic input checking on tolerance anyway, so you can convert to RealField and check that it's positive.


---

Comment by git created at 2018-05-17 20:22:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by bhutz created at 2018-05-19 01:31:57

in testing, I found that the method does very poorly when the base ring is numerical such as CC or RR. For simple subschemes, it was ok, but for even mildly complicated schemes (such as projective closures of intersections of affine curves) you could easily get wildly wrong answers. So, I think the verbose warning is warranted in this case.

This also led me to separate out the case where the subscheme is defined over a number field and the user wants points numerically approximated which is much faster. This seems to work well in my testing (up to precision/tolerance).

Additionally, the documenation was significantly updated as well as normalizing all the inputs for the various points/rational_points methods.

So I'm marking this as needs-review, but it should undergo fairly extensive testing as I'm sure there are cases I missed.
----
New commits:


---

Comment by bhutz created at 2018-05-19 01:31:57

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-16 21:09:37

## There are couple of documentation updated 
 - Value of dimension need to be corrected (line no := for projective_homset 74, 188, 383, 453; for affine_homset 129, 138).

 - Calculation of dimension in projective homset is wrong (needs to be one less than I.dimension(), line no :- 185, 380).

 - Subscheme should be replaced by scheme (line no: for projective homset 75, 293; for affine homset 129, 317).

 - Projective word should be replaced by affine in affine homset (line no := 283, 436).

 - Example in docstring of projective_homset for CC, and CDF are similar. different example need to be added.

 - For `NumberFields` embeddings should be specified during formation, this needs to be added in documentation.

 - In affine homset example below is better to illustrate working in CDF, compared to current example

```
sage: A.<x1, x2> = AffineSpace(CDF, 2)
sage: E = A.subscheme([x1^2 + x2^2 + x1*x2 + 1, x1 + x2])
sage: E(A.base_ring()).points() 
verbose 0 (124: affine_homset.py, points) Warning: computations in the
numerical fields are inexact;points may be computed partially or
incorrectly.
[(-2.77555756156e-17 + 1.0*I, 2.77555756156e-17 - 1.0*I), (-1.0*I,
1.0*I)]
```

 - There should be an example in projective and affine homset to illustrate use of tolerance, some thing like this

```
sage: A.<x1, x2> = AffineSpace(QQ, 2)
sage: E = A.subscheme([x1^1000 + x2^2 + x1*x2 + 1, x1 + x2])
sage: len(E(A.base_ring()).numerical_points(F=CDF, zero_tolerance =1e-11))
987
sage: len(E(A.base_ring()).numerical_points(F=CDF, zero_tolerance =1e-10))
1000
```

**Following gives wrong result**

```
sage: P.<x1, x2> = ProjectiveSpace(QQ, 1)
sage: E = A.subscheme([x1^2 -3*x1 + 2, x2])
sage: E(A.base_ring()).numerical_points(F=CDF, zero_tolerance =1e-10)
[(1.0, 0.0), (2.0, 0.0)]
sage: E(A.base_ring()).points()
[(1, 0), (2, 0)]
```

They are same projective point, and hence only 1 should be returned.

**This also**

```
sage: P.<x1> = ProjectiveSpace(QQ, 0)
sage: E = A.subscheme([x1^2 -3*x1 + 2])
sage: E(A.base_ring()).points(bound=5)
[(1, -5), (1, -4), (1, -3), (1, -2), (1, -1), (1, 0), (1, 1), (1, 2),
(1, 3), (1, 4), (1, 5), (2, -5), (2, -4), (2, -3), (2, -2), (2, -1), (2,
0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5)]
```

----
New commits:


---

Comment by raghukul01 created at 2018-06-17 08:57:42

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2018-06-17 17:16:46

Changes made. A few comment below

- The dimension checks are actually correct, that is why the comments are there

- made doc changes where appropriate (can't really have a 0 dim scheme in sage)

- I modified the examples as specified

- However, the two examples above that are 'failing' are actually problems with the examples. Notice that you are defining a project space P and using subschemes of A.
----
New commits:


---

Comment by bhutz created at 2018-06-17 17:16:46

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-17 18:04:50

Those 2 examples were so silly of me :P


---

Comment by raghukul01 created at 2018-06-17 18:04:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-19 06:58:08

Test failures... Always run 'make ptestlong' before setting stuff to positive review.


---

Comment by vbraun created at 2018-06-19 06:58:08

Changing status from positive_review to needs_work.


---

Comment by raghukul01 created at 2018-06-19 12:56:33

I guess most of the doc test are failing due to following line in sage/coding/source-coding/hamming_code.py `PFn = [list(p) for p in X.point_set(F).points(F)]` (line no 147)


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-06-19 18:55:23

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2018-06-19 18:55:23

looks like hamming_codes was calling .points() and trying to pass in the field. This was never possible in the first place (only could pass in `bound` or `precision`) it was only coming up since the keyword parameters were moved to *kwds and not listed explicitly.


This one change fixed all doctests for me.


---

Comment by raghukul01 created at 2018-06-20 09:07:39

Changing status from needs_review to positive_review.


---

Comment by raghukul01 created at 2018-06-20 09:07:39

Passed on my system as well.


---

Comment by vbraun created at 2018-06-20 18:48:14

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-06-20 18:48:14

merge conflict


---

Comment by git created at 2018-06-26 01:06:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-06-26 01:09:56

merge conflict resolved


---

Comment by bhutz created at 2018-06-26 01:09:56

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-27 09:18:28

Changing status from needs_review to positive_review.


---

Comment by raghukul01 created at 2018-06-27 09:18:28

Following doctest are failing however they are not due to this ticket, they are failing on the develop(8.3.beta7) branch as well.


```
sage -t --long --warn-long 91.1 src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --long --warn-long 91.1 src/sage/functions/other.py  # 1 doctest failed
sage -t --long --warn-long 91.1 src/sage/rings/complex_arb.pyx  # 24 doctests failed
sage -t --long --warn-long 91.1 src/sage/misc/sphinxify.py  # 1 doctest failed
sage -t --long --warn-long 91.1 src/sage/rings/real_arb.pyx  # 7 doctests failed
sage -t --long --warn-long 91.1 src/sage/matrix/matrix_complex_ball_dense.pyx  # 1 doctest failed
sage -t --long --warn-long 91.1 src/sage/rings/polynomial/polynomial_complex_arb.pyx  # 2 doctests failed
```



---

Comment by vbraun created at 2018-06-28 20:18:18

On 32-bit

```
**********************************************************************
File "src/sage/schemes/projective/projective_homset.py", line 160, in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.points
Failed example:
    E(P.base_ring()).points()
Expected:
    verbose 0 (70: projective_homset.py, points) Warning: computations in the numerical fields are inexact;points may be computed partially or incorrectly.
    [(-1.0000000000000004*I : 1.0 : 0.0),
     (0.0 : 0.9999999999999997*I : 1.0),
     (0.0 : 2.7755575615628914e-17 - 1.0*I : 1.0),
     (0.9999999999999997*I : 1.0 : 0.0),
     (2.7755575615628914e-17 - 1.0*I : 0.0 : 1.0),
     (2.7755575615628914e-17 + 1.0*I : 0.0 : 1.0)]
Got:
    verbose 0 (70: projective_homset.py, points) Warning: computations in the numerical fields are inexact;points may be computed partially or incorrectly.
    [(-1.3091741232762466e-17 - 1.0*I : 0.0 : 1.0),
     (-1.3091741232762466e-17 + 1.0*I : 0.0 : 1.0),
     (-1.0000000000000002*I : 1.0 : 0.0),
     (0.0 : -1.0000000000000002*I : 1.0),
     (0.0 : 0.9999999999999998*I : 1.0),
     (0.9999999999999998*I : 1.0 : 0.0)]
**********************************************************************
File "src/sage/schemes/projective/projective_homset.py", line 335, in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.numerical_points
Failed example:
    X(K).numerical_points(F=CDF)
Expected:
    [(-1.475773161594552 : 1.475773161594552 : 1.0),
     (1.475773161594551 : 1.4757731615945517 : 1.0)]
Got:
    [(-1.475773161594552 : 1.475773161594552 : 1.0),
     (1.4757731615945517 : 1.4757731615945517 : 1.0)]
**********************************************************************
2 items had failures:
   1 of  22 in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.numerical_points
   1 of  20 in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.points
    [75 tests, 2 failures, 1.65 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/projective/projective_homset.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-06-28 20:18:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-06-28 21:12:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-06-28 21:13:16

corrected a minor whitespace typo as well.


---

Comment by bhutz created at 2018-06-28 21:13:16

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-06-28 21:54:08

How can I run doctest for a 32-bit machine? Mine is 64.


---

Comment by raghukul01 created at 2018-07-01 03:27:42

Changing status from needs_review to positive_review.


---

Comment by raghukul01 created at 2018-07-01 03:27:42

tested, LGTM


---

Comment by vbraun created at 2018-07-15 17:59:53

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-07-15 17:59:53


```
sage -t --long src/sage/schemes/projective/projective_homset.py
**********************************************************************
File "src/sage/schemes/projective/projective_homset.py", line 146, in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.points
Failed example:
    L=E(P.base_ring()).points();L
Expected:
    verbose 0 (70: projective_homset.py, points) Warning: computations in the numerical fields are inexact;points may be computed partially or incorrectly.
    [(-0.500000000000000 + 0.866025403784439*I : 1.00000000000000 : 0.000000000000000),
    (-0.500000000000000 - 0.866025403784439*I : 1.00000000000000 : 0.000000000000000),
    (-1.00000000000000*I : 0.000000000000000 : 1.00000000000000),
    (0.000000000000000 : 0.000000000000000 : 1.00000000000000),
    (1.00000000000000*I : 0.000000000000000 : 1.00000000000000),
    (1.00000000000000 : 1.00000000000000 : 0.000000000000000)]
Got:
    verbose 0 (71: projective_homset.py, points) Warning: computations in the numerical fields are inexact;points may be computed partially or incorrectly.
    [(-0.500000000000000 + 0.866025403784439*I : 1.00000000000000 : 0.000000000000000),
     (-0.500000000000000 - 0.866025403784439*I : 1.00000000000000 : 0.000000000000000),
     (-1.00000000000000*I : 0.000000000000000 : 1.00000000000000),
     (0.000000000000000 : 0.000000000000000 : 1.00000000000000),
     (1.00000000000000*I : 0.000000000000000 : 1.00000000000000),
     (1.00000000000000 : 1.00000000000000 : 0.000000000000000)]
**********************************************************************
File "src/sage/schemes/projective/projective_homset.py", line 161, in sage.schemes.projective.projective_homset.SchemeHomset_points_projective_field.points
```



---

Comment by git created at 2018-07-16 00:59:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2018-07-16 01:00:54

merged in and updated doctests for latest beta


---

Comment by bhutz created at 2018-07-16 01:00:54

Changing status from needs_work to needs_review.


---

Comment by raghukul01 created at 2018-07-19 12:47:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-08 18:18:16

Resolution: fixed
