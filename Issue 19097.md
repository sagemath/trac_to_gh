# Issue 19097: Update to Cython-0.23.3

Issue created by migration from https://trac.sagemath.org/ticket/19334

Original creator: vbraun

Original creation time: 2015-10-02 18:48:52

CC:  fbissey dcoudert




---

Comment by vbraun created at 2015-10-02 19:13:02

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2015-10-02 19:13:02

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-10-02 19:13:02

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2015-10-02 19:13:02

New commits:


---

Comment by fbissey created at 2015-10-02 22:52:22

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-10-02 22:52:22

Looks trivial enough. Lucky to catch me there (I am on leave, moving and without internet at home before at least Tuesday- catching you from the public library).


---

Comment by jdemeyer created at 2015-10-03 07:50:43

I see segfaults on the patchbot.


---

Comment by jdemeyer created at 2015-10-03 09:08:28

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-10-03 09:08:28

Are you not seeing these errors?

```
sage -t --long src/sage/graphs/asteroidal_triples.pyx
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 105, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(G)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[2]>", line 1, in <module>
        is_asteroidal_triple_free(G)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 107, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(G, certificate=True)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[3]>", line 1, in <module>
        is_asteroidal_triple_free(G, certificate=True)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 110, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(LG)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[5]>", line 1, in <module>
        is_asteroidal_triple_free(LG)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 113, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(LLG)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[7]>", line 1, in <module>
        is_asteroidal_triple_free(LLG)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 120, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(G)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[10]>", line 1, in <module>
        is_asteroidal_triple_free(G)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
File "src/sage/graphs/asteroidal_triples.pyx", line 122, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free
Failed example:
    is_asteroidal_triple_free(G, certificate=True)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.asteroidal_triples.is_asteroidal_triple_free[11]>", line 1, in <module>
        is_asteroidal_triple_free(G, certificate=True)
      File "sage/graphs/asteroidal_triples.pyx", line 171, in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6443)
        sig_on()
      File "sage/ext/interrupt/interrupt.pyx", line 110, in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1357)
        raise SignalError(msg)
    SignalError: Segmentation fault
**********************************************************************
```



---

Comment by vbraun created at 2015-10-03 09:57:13

I can confirm that; Bug in asteroidal triples?

```
$ sage -valgrind
┌────────────────────────────────────────────────────────────────────┐
│ SageMath Version 6.9.rc1, Release Date: 2015-10-01                 │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Using default flags: --leak-resolution=high --leak-check=full --num-callers=25  --suppressions=/home/vbraun/Code/sage.git/local/share/sage/ext/valgrind/python.supp --suppressions=/home/vbraun/Code/sage.git/local/share/sage/ext/valgrind/pyalloc.supp --suppressions=/home/vbraun/Code/sage.git/local/share/sage/ext/valgrind/sage.supp --suppressions=/home/vbraun/Code/sage.git/local/share/sage/ext/valgrind/sage-additional.supp
==16537== Memcheck, a memory error detector
==16537== Copyright (C) 2002-2013, and GNU GPL'd, by Julian Seward et al.
==16537== Using Valgrind-3.10.1 and LibVEX; rerun with -h for copyright info
==16537== Command: python /home/vbraun/Code/sage.git/local/bin/sage-ipython -i
==16537== 
sage:         sage: from sage.graphs.asteroidal_triples import *
sage:         sage: G = graphs.CompleteGraph(5)
sage:         sage: is_asteroidal_triple_free(G)
==16537== Invalid read of size 8
==16537==    at 0x3FCA844D: __pyx_f_4sage_6graphs_18asteroidal_triples_bitset_add (asteroidal_triples.c:3100)
==16537==    by 0x3FCA844D: __pyx_f_4sage_6graphs_18asteroidal_triples_is_asteroidal_triple_free_C (asteroidal_triples.c:6922)
==16537==    by 0x3FCA844D: __pyx_pf_4sage_6graphs_18asteroidal_triples_is_asteroidal_triple_free.isra.11 (asteroidal_triples.c:6451)
==16537==    by 0x3FCA906F: __pyx_pw_4sage_6graphs_18asteroidal_triples_1is_asteroidal_triple_free (asteroidal_triples.c:6146)
==16537==    by 0x4F3C070: call_function (ceval.c:4033)
==16537==    by 0x4F3C070: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3D798: PyEval_EvalCode (ceval.c:667)
==16537==    by 0x4F3BDDD: exec_statement (ceval.c:4730)
==16537==    by 0x4F3BDDD: PyEval_EvalFrameEx (ceval.c:1881)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3C393: fast_function (ceval.c:4129)
==16537==    by 0x4F3C393: call_function (ceval.c:4054)
==16537==    by 0x4F3C393: PyEval_EvalFrameEx (ceval.c:2679)
==16537==    by 0x4F3D67B: PyEval_EvalCodeEx (ceval.c:3265)
==16537==    by 0x4F3D798: PyEval_EvalCode (ceval.c:667)
==16537==    by 0x4F60D79: run_mod (pythonrun.c:1365)
==16537==    by 0x4F60D79: PyRun_FileExFlags (pythonrun.c:1351)
==16537==    by 0x4F62126: PyRun_SimpleFileExFlags (pythonrun.c:943)
==16537==    by 0x4F785FD: Py_Main (main.c:640)
==16537==    by 0x5B806FF: (below main) (in /usr/lib64/libc-2.21.so)
==16537==  Address 0x511adfa8 is not stack'd, malloc'd or (recently) free'd
==16537== 
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-3-b56905c730da> in <module>()
----> 1 is_asteroidal_triple_free(G)

/home/vbraun/Code/sage.git/src/sage/graphs/asteroidal_triples.pyx in sage.graphs.asteroidal_triples.is_asteroidal_triple_free (build/cythonized/sage/graphs/asteroidal_triples.c:6442)()
    169 
    170     try:
--> 171         sig_on()
    172         ret = is_asteroidal_triple_free_C(n, sd, connected_structure, waiting_list, seen)
    173         sig_off()

/home/vbraun/Code/sage.git/src/sage/ext/interrupt/interrupt.pyx in sage.ext.interrupt.interrupt.sig_raise_exception (build/cythonized/sage/ext/interrupt/interrupt.c:1356)()
    108         if msg == NULL:
    109             msg = "Segmentation fault"
--> 110         raise SignalError(msg)
    111 
    112     raise SystemError("unknown signal number %s"%sig)

SignalError: Segmentation fault
```

Its here

```
(gdb) frame 0
#0  __pyx_f_4sage_6graphs_18asteroidal_triples_is_asteroidal_triple_free_C (__pyx_v_sd=0x7fffffffbd30, 
    __pyx_v_seen=<synthetic pointer>, __pyx_v_waiting_list=0x2c2c5e0, __pyx_v_connected_structure=0x2ced6a0, 
    __pyx_v_n=<optimized out>) at build/cythonized/sage/graphs/asteroidal_triples.c:6922
6922	      __pyx_f_4sage_6graphs_18asteroidal_triples_bitset_add(__pyx_v_seen, __pyx_v_v);
(gdb) l
6917	 *             idx_cc += 1
6918	 *             bitset_add(seen, v)             # <<<<<<<<<<<<<<
6919	 *             connected_structure[source][v] = idx_cc
6920	 * 
6921	 */
6922	      __pyx_f_4sage_6graphs_18asteroidal_triples_bitset_add(__pyx_v_seen, __pyx_v_v);
6923	
6924	      /* "sage/graphs/asteroidal_triples.pyx":252
6925	 *             idx_cc += 1
6926	 *             bitset_add(seen, v)
```



---

Comment by vbraun created at 2015-10-03 10:12:58

Unsigned means: negative not allowed for the record:

```
    cdef uint32_t source, u, v, w
    [...]
    v = bitset_first_in_complement(seen)
    while v!=-1:
        [...]
```

Cython now optimizes that into `while (1)` since unsigned values obviously can't be negative.


---

Comment by vbraun created at 2015-10-03 10:26:56

Legal in plain C but probably a bad idea (good old `v < -1` fun)


---

Comment by vbraun created at 2015-10-03 10:31:13

Ah nevermind didn't read far enough into the generated C code...


---

Comment by vbraun created at 2015-10-03 10:53:14

The difference is that Cython previously used `-1` as C integer literal, but now uses `-1L`. By the rules of C type promotion and on machines with 32-bit ints, this means that 
* `v = -1` sets `v` to `4294967295` = `UINT32_MAX - 1`
* `v == -1` converts `-1L` to `UINT64_MAX - 1` = `18446744073709551615` and then compares with `v`

TLDR: don't use unsigned and negative numbers


---

Comment by git created at 2015-10-03 10:57:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-10-03 11:02:37

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-10-03 11:02:37

The asteroidal triple code should be careful about signed values, but I'm not going to rewrite it on this ticket.


---

Comment by dcoudert created at 2015-10-03 12:10:57

I will improve the code of asteroidal triples in #19337.


---

Comment by jdemeyer created at 2015-10-03 13:24:05

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-10-03 13:27:14

One question: you set dependency to #19337 in which I have set dependency to #19334 (so circular dependencies).
Shouldn't we remove the dependency from this ticket to #19337 ?


---

Comment by jdemeyer created at 2015-10-03 13:30:16

Replying to [comment:16 dcoudert]:
> Shouldn't we remove the dependency from this ticket to #19337 ? 

No, we should remove the dependency of #19337 on this ticket (which I just did).


---

Comment by dcoudert created at 2015-10-03 13:43:39

I'm not sure to follow you since 19337 is build on top of this ticket, but as long as it is working, it's fine for me.


---

Comment by vbraun created at 2015-10-12 22:52:42

Resolution: fixed
