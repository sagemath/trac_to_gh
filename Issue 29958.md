# Issue 29958: tox.ini: Add manylinux

Issue created by migration from https://trac.sagemath.org/ticket/30195

Original creator: mkoeppe

Original creation time: 2020-07-22 02:39:12

CC:  @kliem slelievre

https://github.com/pypa/manylinux


---

Comment by mkoeppe created at 2020-07-22 04:08:31

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-07-22 04:08:31

Branch is 1 commit on top of #29929, which also needs review
----
Last 10 new commits:


---

Comment by @kliem created at 2020-07-22 07:35:50

Can you provide an example of this at work?

According to the readme, only CPython up to 3.8 are provided with manylinux. Why have you configured python3.9?


---

Comment by mkoeppe created at 2020-07-22 07:39:55

The readme does not seem to be up to date. On an actual docker image:

```
[root@4185c8d9310b /]# /opt/python/cp3 TAB
cp35-cp35m/ cp36-cp36m/ cp37-cp37m/ cp38-cp38/  cp39-cp39/  
```



---

Comment by @kliem created at 2020-07-22 07:41:28

That was one of my guesses.

Do the new environments work with github actions? If you haven't tested it yet, I have free capacities and can just test this ticket.


---

Comment by mkoeppe created at 2020-07-22 07:43:06

They should work, just add them to tox.yml for testing. I haven't tested them widely yet, only one run of `docker-manylinux-2014-standard` on my computer. Best to test together with #30173


---

Comment by @kliem created at 2020-07-22 09:25:54


```
 File "/usr/lib/python3/dist-packages/tox/session.py", line 38, in main
    config = prepare(args)
  File "/usr/lib/python3/dist-packages/tox/session.py", line 26, in prepare
    config = parseconfig(args)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 239, in parseconfig
    parseini(config, inipath)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 760, in __init__
    self.make_envconfig(name, section, reader._subs, config)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 791, in make_envconfig
    res = meth(env_attr.name, env_attr.default)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 964, in getargvlist
    return _ArgvlistReader.getargvlist(self, s)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1134, in getargvlist
    commands.append(cls.processcommand(reader, current_command))
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1164, in processcommand
    new_word = reader._replace(word)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1008, in _replace
    return Replacer(self, crossonly=crossonly).do_replace(value)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1028, in do_replace
    return self.RE_ITEM_REF.sub(self._replace_match, x)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1057, in _replace_match
    return self._replace_env(match)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1077, in _replace_env
    (envkey, envkey))
tox.ConfigError: ConfigError: substitution env:'BOOTSTRAP': unknown environment variable 'BOOTSTRAP'  or recursive definition.
##[error]Process completed with exit code 1.
```


https://github.com/kliem/sage/runs/897566509?check_suite_focus=true


---

Comment by git created at 2020-07-22 15:47:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-22 15:47:50

Thanks for catching this


---

Comment by @kliem created at 2020-07-23 17:09:34

Centos 6 seems to work in the way that it fails to buil `mpir`.

There are many errors with manylinux like


```
   File "/usr/lib/python3/dist-packages/tox/config.py", line 1008, in _replace
    return Replacer(self, crossonly=crossonly).do_replace(value)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1028, in do_replace
    return self.RE_ITEM_REF.sub(self._replace_match, x)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1057, in _replace_match
    return self._replace_env(match)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1071, in _replace_env
    envvalue = self.reader.get_environ_value(envkey)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 903, in get_environ_value
    return self._setenv.get(name)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 286, in get
    self.resolved[name] = res = self.reader._replace(val)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1008, in _replace
    return Replacer(self, crossonly=crossonly).do_replace(value)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1028, in do_replace
    return self.RE_ITEM_REF.sub(self._replace_match, x)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1057, in _replace_match
    return self._replace_env(match)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 1077, in _replace_env
    (envkey, envkey))
tox.ConfigError: ConfigError: substitution env:'BASE_IMAGE': unknown environment variable 'BASE_IMAGE'  or recursive definition.
```


https://github.com/kliem/sage/runs/899346008?check_suite_focus=true

and 


```
 Step 14/18 : RUN ${BOOTSTRAP}
 ---> Running in d5c9ccb6ceb3
rm -rf config configure build/make/Makefile-auto.in
rm -f src/doc/en/installation/*.txt
rm -rf src/doc/en/reference/spkg/*.rst
rm -f src/doc/en/reference/repl/*.txt
Traceback (most recent call last):
  File "/sage/build/bin/sage-download-file", line 27, in ?
    from sage_bootstrap.download.cmdline import run_safe
  File "/sage/build/bin/../sage_bootstrap/download/__init__.py", line 7, in ?
    from sage_bootstrap.download.transfer import Download
  File "/sage/build/bin/../sage_bootstrap/download/transfer.py", line 43
    n = 0 if chunks_so_far == 0 else self.length // 2
           ^
SyntaxError: invalid syntax
Error: downloading configure-339b4599590f3dc3acec5eace4b7a82f210d3219.tar.gz failed
```


https://github.com/kliem/sage/runs/899346035?check_suite_focus=true

Should they be fixed here?


---

Comment by mkoeppe created at 2020-07-23 17:27:02

I'll look into the tox config error first.


---

Comment by mkoeppe created at 2020-07-23 17:27:02

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-07-23 23:13:23

Replying to [comment:11 gh-kliem]:
> Centos 6 seems to work in the way that it fails to buil `mpir`.

Right... errors from an ancient assembler version.

```
tmp-mul_1.s: Assembler messages:
tmp-mul_1.s:94: Error: no such instruction: `mulx (%rsi),%r9,%r8'
tmp-mul_1.s:95: Error: no such instruction: `mulx 8(%rsi),%r11,%r10'
tmp-mul_1.s:96: Error: no such instruction: `mulx 16(%rsi),%rcx,%r12'
```

We'll definitely not try to support `centos-6` and shouldn't be adding it to `tox.yml`.


---

Comment by mkoeppe created at 2020-07-23 23:16:31

Replying to [comment:11 gh-kliem]:
> Centos 6 seems to work in the way that it fails to buil `mpir`.
> 
> There are many errors with manylinux like
> 
> {{{
> tox.ConfigError: ConfigError: substitution env:'BASE_IMAGE': unknown environment variable 'BASE_IMAGE'  or recursive definition.
> }}}

This is just caused by me not adding documentation and leaving you to guess what is supported. `manylinux` is not a configuration - only `manylinux-1`, `manylinux-2010`, `manylinux-2014` are.

I'll make `manylinux` an alias for `manylinux-2014` and add some documentation.


---

Comment by git created at 2020-07-23 23:17:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-23 23:19:34

Replying to [comment:11 gh-kliem]:
> {{{
>   File "/sage/build/bin/../sage_bootstrap/download/transfer.py", line 43
>     n = 0 if chunks_so_far == 0 else self.length // 2
>            ^
> SyntaxError: invalid syntax
> Error: downloading configure-339b4599590f3dc3acec5eace4b7a82f210d3219.tar.gz failed
> }}}
> 
> https://github.com/kliem/sage/runs/899346035?check_suite_focus=true

The added comments also explain this one -- `manylinux-1` is too old, after all, and sage cannot build on it


---

Comment by mkoeppe created at 2020-07-23 23:28:05

On `manylinux-2010-minimal` (https://github.com/kliem/sage/runs/899346056), building python3 fails with `./python: error while loading shared libraries: libcrypt.so.2: cannot open shared object file: No such file or directory` (related to #29012?)
... but actually it was intended to use the installed python3 in `/opt`. Looks like I need to make adjustments for `-2010`.


---

Comment by git created at 2020-07-24 01:23:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-24 01:25:04

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-07-24 01:46:32

When you have a chance, please test this version again. See above on my comments on the supported tox environments. Also note the images for non-x86 archs can't work on Linux Docker (and thus on GH Actions) because they are not multi-arch images. They work on macOS Docker Desktop because they are running inside of an emulator.


---

Comment by @kliem created at 2020-07-24 06:19:54

https://github.com/kliem/sage/actions/runs/180807074

That is what I'm testing for now:

```
 tox_system_factor: [ubuntu-focal, debian-buster, centos-8, manylinux-1, manylinux-2010, manylinux-2014, manylinux-2014-python3.7]
```


manylinux-1 will of course fail.


---

Comment by @kliem created at 2020-07-24 11:09:35

I'm getting configure failures with minimal. Will this be a subject of this ticket or of another one?

Otherwise it's looking fine.


---

Comment by git created at 2020-07-24 15:38:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-07-24 19:42:39

manylinux-2014-python3.7, minimal still fails at configuration.

https://github.com/kliem/sage/runs/908012032?check_suite_focus=true

Maybe I just got the name scheme wrong.


---

Comment by mkoeppe created at 2020-07-24 19:46:16

`minimal` with `python3.7` cannot work because python3 dependencies such as sqlite3 are not available from the system and therefore it cannot use system python3.


---

Comment by @kliem created at 2020-07-24 21:14:41

https://github.com/kliem/sage/actions/runs/181590963

This seems to work well. At least according to the timings we are well in the build process. Any failures are probably subject to different tickets now.

If the run turns out to your satisfaction, you can put it on positive review on my behalf.


---

Comment by mkoeppe created at 2020-07-25 01:49:46

Thank you!


---

Comment by mkoeppe created at 2020-07-25 01:49:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-28 22:32:03

Resolution: fixed
