# Issue 10914: E.integral_points has a bug

Issue created by migration from https://trac.sagemath.org/ticket/10999

Original creator: gagansekhon

Original creation time: 2011-03-23 19:31:11

Assignee: cremona

CC:  cremona rlm aly.deines mstreng

Keywords: Cremona database, integral points, gens

After installing the large cremona database. The following code produces an error. 

```

E=EllipticCurve('389a1')
G=E.gens()
P1=E.point((-1,1,1))
P2=E.point((0,0,1))
print E.integral_points([P1,P2])
print E.integral_points(G)
```


[(-2 : 0 : 1), (-1 : 1 : 1), (0 : 0 : 1), (1 : 0 : 1), (3 : 5 : 1), (4 : 8 : 1), (6 : 15 : 1), (39 : 246 : 1), (133 : 1539 : 1), (188 : 2584 : 1)]
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_3.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("RT1FbGxpcHRpY0N1cnZlKCczODlhMScpCkc9RS5nZW5zKCkKUDE9RS5wb2ludCgoLTEsMSwxKSkKUDI9RS5wb2ludCgoMCwwLDEpKQpwcmludCBFLmludGVncmFsX3BvaW50cyhbUDEsUDJdKQpwcmludCBFLmludGVncmFsX3BvaW50cyhHKQ=="),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/private/var/folders/rt/rtyQ7RPsHRCDmvOBf9SYwU+++TI/-Tmp-/tmpwbmbeK/___code___.py", line 8, in <module>
    exec compile(u'print E.integral_points(G)
  File "", line 1, in <module>
    
  File "/Users/sekhon/Documents/sage-4.7.alpha2/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 5310, in integral_points
    raise ValueError, "points are not on the correct curve"
ValueError: points are not on the correct curve


---

Comment by cremona created at 2011-03-24 19:37:49

I have found the problem, in lines 190-199 in ell_rational_field.py.  It copies the points from the database curve in a way which does not change te curve those points lie on.

Patch on its way!


---

Comment by cremona created at 2011-03-24 20:43:17

I'm testing the whole library now and will ask for reviews if that goes ok.


---

Comment by cremona created at 2011-03-24 20:52:28

Changing status from new to needs_review.


---

Comment by weigandt created at 2011-03-25 01:06:21

Changing status from needs_review to positive_review.


---

Comment by weigandt created at 2011-03-25 01:06:21

Looks good. The tests pass.


---

Comment by jdemeyer created at 2011-03-28 14:16:18

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-03-28 14:16:18

Replying to [comment:5 weigandt]:
> The tests pass.

Really?  Both the patchbot and my personal testing seems to indicate doctest problems.  Am I missing something?

```
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/devel/sage-main/doc/en/bordeaux_2008/elliptic_curves.rst", line 139:
    sage: E.padic_regulator(5, 10)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_3[3]>", line 1, in <module>
        E.padic_regulator(Integer(5), Integer(10))###line 139:
    sage: E.padic_regulator(5, 10)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line
 269, in padic_regulator
        d = self.padic_height_pairing_matrix(p=p, prec=prec, height=height, check_hypotheses=False)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line
 344, in padic_height_pairing_matrix
        basis = self.gens()
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.alpha3/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_fie
ld.py", line 1802, in gens
        return list(self.__gens[proof])  # return copy so not changed
      File "parent.pyx", line 738, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:5752)
      File "parent.pyx", line 177, in sage.structure.parent.raise_attribute_error (sage/structure/parent.c:2724)
    AttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'
**********************************************************************
```



```
The following tests failed:

        sage -t  -long -force_lib devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 7 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padics.py # 23 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 13 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/padic_lseries.py # 2 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_point.py # 11 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_tate_curve.py # 4 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/BSD.py # 4 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/gp_simon.py # 1 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_number_field.py # 3 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # 33 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 27 doctests failed
        sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 17 doctests failed
```



---

Comment by weigandt created at 2011-03-28 14:46:18

It would appear that I have made a serious error. I did run doctests, and they passed. I will admit to the possibility of having made a rookie mistake and tested the wrong copy of sage on my machine. 

Another possible explanation is that I didn't have the large Cremona database installed when I applied the patch. So I applied the patch THEN installed the database and it seems the doctests passed under those circumstances.

I'm running to tests again to see what happened.


---

Comment by cremona created at 2011-03-29 01:43:04

Jamie, let me take another look at this.


---

Comment by cremona created at 2011-03-29 02:05:08

OK, fixed.  There was a simple indentation error in the patch so removing 3 spaces did the trick.  The patch did work OK on Sage+large database but not without the large database.  Luckily I still had a 4.6.rc1 lying around without the database installed so I could test on that as well as on 4.7.alpha2 + database.  (There's no way of uninstalling the database!)

I'm now doing full test of entire library with and without the database, and will post a new patch when done.


---

Comment by cremona created at 2011-03-29 02:34:26

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2011-03-29 02:34:26

OK, please re-review this one.  As I said, the difference between the previous patch and this one is just one indentation.

In order to test this one should test against a Sage installation with and without the spkg database_cremona_ellcurve.  I have done that (full test of entire library).


---

Comment by mstreng created at 2011-06-09 09:45:18

Changing status from needs_review to needs_work.


---

Comment by mstreng created at 2011-06-09 09:45:18

sage 4.7 without database spkg without patch:

```
sage: E=EllipticCurve('389a1')
sage: E.gens()
[(-1 : 1 : 1), (0 : -1 : 1)]
```

sage 4.7 without database spkg with patch:

```
sage: E=EllipticCurve('389a1')
sage: E.gens()
...
AttributeError: 'EllipticCurve_rational_field' object has no attribute '_EllipticCurve_rational_field__gens'
```



---

Comment by cremona created at 2011-06-09 14:42:11

Applies to 4.7.1.alpha2


---

Comment by cremona created at 2011-06-09 14:43:14

Changing status from needs_work to needs_review.


---

Attachment

I have fixed that problem (which was a real problem, not just a rebase).  Please retest!  I did test the whole library before and after installing the optional database.


---

Comment by mstreng created at 2011-06-09 16:12:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-06-15 15:23:51

Resolution: fixed
