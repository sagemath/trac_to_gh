# Issue 33012: BipartiteGraph() silently ignores given 'partition' argument

Issue created by migration from https://trac.sagemath.org/ticket/33249

Original creator: @maxale

Original creation time: 2022-01-30 15:18:27

`BipartiteGraph()` turns to ignore the given `partition` argument (whether it is valid or invalid) as illustrated by the following two examples.


----


First, the following code shows that `BipartiteGraph()` ignores the given (valid) partition and just uses its own:



```
sage: G = BipartiteGraph( {2:[1], 3:[1], 4:[5]}, partition=([2,3,4],[1,5]) )                                                                                                                                       
sage: print(G.left, G.right)                                                                                                                                                                                       
{1, 4} {2, 3, 5}
```



----


Second, the documentation says:

   check – boolean (default: True); if True, an invalid input partition raises an exception. In the other case offending edges simply won’t be included.


However, in the following code `BipartiteGraph()` fails to check the validity of the given (invalid) `partition` and again just silently ignores it:



```
sage: G = BipartiteGraph( {2:[1], 3:[1]}, partition=([1,2],[3]), check=True )
sage: print(G.left, G.right)                                                                                                                                                                                       
{1} {2, 3}
```



---

Comment by dcoudert created at 2022-01-31 10:33:07

This is a severe issue. I don't know yet how to fix that.


---

Comment by @kliem created at 2022-02-01 18:28:22

`partition` is completely ignored for other input formats. If you put it in a graph first, it should work just fine.

Here is the relevant code from `__init__`:


```
        elif isinstance(data, GenericGraph) and partition is not None:
            left, right = set(partition[0]), set(partition[1])
            verts = left | right
            if set(data) != verts:
                data = data.subgraph(verts)
            Graph.__init__(self, data, *args, **kwds)
            if check:
                if (any(left.intersection(data.neighbor_iterator(a)) for a in left) or
                    any(right.intersection(data.neighbor_iterator(a)) for a in right)):
                    raise TypeError("input graph is not bipartite with "
                                    "respect to the given partition")
            else:
                for a in left:
                    a_nbrs = left.intersection(data.neighbor_iterator(a))
                    if a_nbrs:
                        self.delete_edges((a, b) for b in a_nbrs)
                for a in right:
                    a_nbrs = right.intersection(data.neighbor_iterator(a))
                    if a_nbrs:
                        self.delete_edges((a, b) for b in a_nbrs)
            self.left, self.right = left, right
        elif isinstance(data, GenericGraph):
            Graph.__init__(self, data, *args, **kwds)
            self._upgrade_from_graph()
        else:
            import networkx
            Graph.__init__(self, data, *args, **kwds)
            if isinstance(data, (networkx.MultiGraph, networkx.Graph)):
                ... # Treating networkx
            # make sure we found a bipartition
            if not (hasattr(self, "left") and hasattr(self, "right")):
                self._upgrade_from_graph()
```


Finding some fix, doesn't appear to be too hard. I will see, if I can find some fix with little code duplication.


---

Comment by @kliem created at 2022-02-01 20:50:01

Changing status from new to needs_review.


---

Comment by @kliem created at 2022-02-01 20:50:01

New commits:


---

Comment by dcoudert created at 2022-02-01 21:07:56

This is much better but not enough: if we give an extra vertex to the partition, we get an error, but if a vertex is not given, it is not added to left or right.

```
sage: G = BipartiteGraph({2:[1], 3:[1], 4:[5]}, partition=([2,3,4],[1,5, 6]))
---------------------------------------------------------------------------
LookupError                               Traceback (most recent call last)
<ipython-input-2-539aa21fa22d> in <module>
----> 1 G = BipartiteGraph({Integer(2):[Integer(1)], Integer(3):[Integer(1)], Integer(4):[Integer(5)]}, partition=([Integer(2),Integer(3),Integer(4)],[Integer(1),Integer(5), Integer(6)]))

~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/bipartite_graph.py in __init__(self, data, partition, check, *args, **kwds)
    417                 if check:
    418                     if (any(left.intersection(self.neighbor_iterator(a)) for a in left) or
--> 419                         any(right.intersection(self.neighbor_iterator(a)) for a in right)):
    420                         raise TypeError("input graph is not bipartite with "
    421                                         "respect to the given partition")

~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/bipartite_graph.py in <genexpr>(.0)
    417                 if check:
    418                     if (any(left.intersection(self.neighbor_iterator(a)) for a in left) or
--> 419                         any(right.intersection(self.neighbor_iterator(a)) for a in right)):
    420                         raise TypeError("input graph is not bipartite with "
    421                                         "respect to the given partition")

~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py in neighbor_iterator(self, vertex, closed)
  10671                 yield vertex
  10672 
> 10673         for u in self._backend.iterator_nbrs(vertex):
  10674             yield u
  10675 

~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/base/c_graph.pyx in iterator_nbrs (build/cythonized/sage/graphs/base/c_graph.cpp:14617)()
   2211         """
   2212         if not self._directed:
-> 2213             yield from self.iterator_out_nbrs(v)
   2214             return
   2215 

~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/base/c_graph.pyx in iterator_out_nbrs (build/cythonized/sage/graphs/base/c_graph.cpp:15368)()
   2310         cdef int v_int = self.get_vertex(v)
   2311         if v_int == -1 or not bitset_in(self.cg().active_vertices, v_int):
-> 2312             raise LookupError("vertex ({0}) is not a vertex of the graph".format(v))
   2313 
   2314         for u_int in self.cg().out_neighbors(v_int):

LookupError: vertex (6) is not a vertex of the graph
```



```
sage: G = BipartiteGraph({2:[1], 3:[1], 4:[5]}, partition=([2,3,4],[1]))
sage: G.left, G.right
({2, 3, 4}, {1})
sage: G.vertices()
[1, 2, 3, 4, 5]
```



---

Comment by git created at 2022-02-01 21:18:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2022-02-02 06:13:30

Replying to [comment:5 dcoudert]:
> This is much better but not enough: if we give an extra vertex to the partition, we get an error, but if a vertex is not given, it is not added to left or right.
> {{{
> sage: G = BipartiteGraph({2:[1], 3:[1], 4:[5]}, partition=([2,3,4],[1,5, 6]))
> ---------------------------------------------------------------------------
> LookupError                               Traceback (most recent call last)
> <ipython-input-2-539aa21fa22d> in <module>
> ----> 1 G = BipartiteGraph({Integer(2):[Integer(1)], Integer(3):[Integer(1)], Integer(4):[Integer(5)]}, partition=([Integer(2),Integer(3),Integer(4)],[Integer(1),Integer(5), Integer(6)]))
> 
> ~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/bipartite_graph.py in __init__(self, data, partition, check, *args, **kwds)
>     417                 if check:
>     418                     if (any(left.intersection(self.neighbor_iterator(a)) for a in left) or
> --> 419                         any(right.intersection(self.neighbor_iterator(a)) for a in right)):
>     420                         raise TypeError("input graph is not bipartite with "
>     421                                         "respect to the given partition")
> 
> ~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/bipartite_graph.py in <genexpr>(.0)
>     417                 if check:
>     418                     if (any(left.intersection(self.neighbor_iterator(a)) for a in left) or
> --> 419                         any(right.intersection(self.neighbor_iterator(a)) for a in right)):
>     420                         raise TypeError("input graph is not bipartite with "
>     421                                         "respect to the given partition")
> 
> ~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/generic_graph.py in neighbor_iterator(self, vertex, closed)
>   10671                 yield vertex
>   10672 
> > 10673         for u in self._backend.iterator_nbrs(vertex):
>   10674             yield u
>   10675 
> 
> ~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/base/c_graph.pyx in iterator_nbrs (build/cythonized/sage/graphs/base/c_graph.cpp:14617)()
>    2211         """
>    2212         if not self._directed:
> -> 2213             yield from self.iterator_out_nbrs(v)
>    2214             return
>    2215 
> 
> ~/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/graphs/base/c_graph.pyx in iterator_out_nbrs (build/cythonized/sage/graphs/base/c_graph.cpp:15368)()
>    2310         cdef int v_int = self.get_vertex(v)
>    2311         if v_int == -1 or not bitset_in(self.cg().active_vertices, v_int):
> -> 2312             raise LookupError("vertex ({0}) is not a vertex of the graph".format(v))
>    2313 
>    2314         for u_int in self.cg().out_neighbors(v_int):
> 
> LookupError: vertex (6) is not a vertex of the graph
> }}}
> 
> {{{
> sage: G = BipartiteGraph({2:[1], 3:[1], 4:[5]}, partition=([2,3,4],[1]))
> sage: G.left, G.right
> ({2, 3, 4}, {1})
> sage: G.vertices()
> [1, 2, 3, 4, 5]
> }}}

I see, I added some error checking.


---

Comment by git created at 2022-02-02 07:29:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-02-02 07:30:05

I added a test for the case a vertex of the partition is not a vertex of input data.


---

Comment by @kliem created at 2022-02-02 08:31:21

Replying to [comment:9 dcoudert]:
> I added a test for the case a vertex of the partition is not a vertex of input data.

That test LGTM.


---

Comment by dcoudert created at 2022-02-02 09:52:25

LGTM.


---

Comment by dcoudert created at 2022-02-02 09:52:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-13 10:16:34

Resolution: fixed
