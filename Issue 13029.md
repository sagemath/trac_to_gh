# Issue 13029: patch setuptools to allow for parallel usage

Issue created by migration from Trac.

Original creator: ohanar

Original creation time: 2012-07-04 22:23:39

Assignee: GeorgSWeber

CC:  jdemeyer kini jason

Currently we have to force the spkgs that use setuptools to build serially because setuptools does not do any file locking with `easy_install.pth`. This is an inconvenience that has a fairly straightforward fix.


Installation Instructions:
* Use the new spkg [http://wstein.org/home/ohanar/spkgs/setuptools-0.6.16.p1.spkg](http://wstein.org/home/ohanar/spkgs/setuptools-0.6.16.p1.spkg)
* Apply ... to the root repo.


---

Comment by ohanar created at 2012-07-04 22:25:39

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-08-13 12:39:39

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-08-13 12:39:39

Why re-invent the wheel?  Why not use [http://docs.python.org/library/fcntl.html#fcntl.lockf](http://docs.python.org/library/fcntl.html#fcntl.lockf)?

Also, this should obviously be reported upstream.


---

Comment by ohanar created at 2012-09-04 21:01:41

Replying to [comment:2 jdemeyer]:
> Why re-invent the wheel?  Why not use [http://docs.python.org/library/fcntl.html#fcntl.lockf](http://docs.python.org/library/fcntl.html#fcntl.lockf)?
Because I was being dumb and couldn't find that function :).
> Also, this should obviously be reported upstream.
Yup, although upstream is basically dead. IMO we should switch to distribute (I'll see about making an SPKG).


---

Comment by ohanar created at 2012-09-06 11:17:56

new patch applied to setuptools; for review purposes


---

Attachment

apply to root repo


---

Comment by ohanar created at 2012-09-06 11:23:54

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-09-06 11:35:01

I unfortuntely don't understand `setuptools` well enough to review this.  It seems there are some changes unrelated to the locking.  What do they do?

Also, do we really need to do this _every time_ Sage runs (could it be moved to `sage-location`?):

```
    # Hack around setuptools since --egg-path isn't fully respected 
    sed -i 's-.*sagenb.*-\.\./\.\./\.\./\.\./devel/sagenb-' \ 
        "$SAGE_LOCAL/lib/python/site-packages/easy-install.pth" 
```

You also need to handle the case that `$SAGE_ROOT` isn't writeable.


---

Comment by ohanar created at 2012-09-06 11:50:54

Replying to [comment:6 jdemeyer]:
> I unfortuntely don't understand `setuptools` well enough to review this.  It seems there are some changes unrelated to the locking.  What do they do?
Internally setuptools identifies packages based on a normalized path (no absolute paths without symlinks, and a normalized case for case-insensitive filesystems). It reads these from easy-install.pth, and then creates a brand new easy-install.pth if it detects that it needs to. The issue is that it loads the list of packages when it starts, and then writes it back when it finishes, if any changes were made to the file in the meantime, setuptools doesn't detect them, and just overrides them with its new easy-install.pth. What I did was add a bit of code for reloading the file right before writing a new one -- making sure things that were deleted don't pop back up, and making sure things that were added don't disappear.
> Also, do we really need to do this _every time_ Sage runs (could it be moved to `sage-location`?):
> {{{
>     # Hack around setuptools since --egg-path isn't fully respected 
>     sed -i 's-.*sagenb.*-\.\./\.\./\.\./\.\./devel/sagenb-' \ 
>         "$SAGE_LOCAL/lib/python/site-packages/easy-install.pth" 
> }}}
> You also need to handle the case that `$SAGE_ROOT` isn't writeable.
Well no you don't have to run it every time sage starts, just every time a package using setuptools is installed, since setuptools always inscribes the absolute path into easy-install.pth (even if you specify a relative path for `--egg-path`).


---

Comment by jdemeyer created at 2012-09-06 11:57:36

Since `sage-location` specifically deals with rewriting paths, I would do it there.


---

Comment by ohanar created at 2012-09-06 23:06:45

I thought that was for rewriting paths when `SAGE_ROOT` changed. The issue is that setuptools rewrites paths, regardless of what happens to `SAGE_ROOT`, so we have to overwrite their rewrites. An alternative (now that we have the flask notebook has been merged), is to treat sagenb like any other upstream package, and just install it in site-packages (I don't think the sagenb developers would be opposed to this, we are already planning on doing this in the transition to git).


---

Comment by jdemeyer created at 2012-09-07 07:30:13

Replying to [comment:9 ohanar]:
> I thought that was for rewriting paths when `SAGE_ROOT` changed.
Well, the reason you need to rewrite the `setuptools` paths is to allow relocation, right? (or am I missing something?)


---

Comment by ohanar created at 2012-09-07 07:45:12

Replying to [comment:10 jdemeyer]:
> Well, the reason you need to rewrite the `setuptools` paths is to allow relocation, right? (or am I missing something?)
Well we also support clones for sagenb, which will brake every time setuptools is run (it readlinks everything). If we don't care about that, then we could.

I'm CCing Keshav and Jason on this ticket, they might have an opinion on how we handle this (since currently it only affects sagenb).


---

Comment by jason created at 2012-09-07 08:28:09

Since sagenb is now distributed without a repository, it might make sense for it not to be installed in SAGE_ROOT/devel/.  The reason for it to be in SAGE_ROOT/devel/sagenb is so that the barrier is way lower for people wanting to patch it and work with it.  If we're making them clone the git repository anyway, the barrier isn't lower.

So what do you think, kini?  Should we just install it like a normal spkg?  If they want to develop, they need to git clone and do `sage setup.py develop`?

(personally, I'm mildly in favor of going back to installing the git repo in SAGE_ROOT/devel/sagenb...)


---

Comment by kini created at 2012-09-07 08:35:40

Absolutely. I 100% think that sagenb should be installed like any other python package, i.e. in the site packages directory.


---

Comment by jdemeyer created at 2013-03-16 22:42:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-03-16 22:42:12

In any case, this needs work because it assumes that `$SAGE_ROOT` is writable and it needs to be rebased.


---

Comment by fbissey created at 2013-03-17 09:34:06

Replying to [comment:3 ohanar]:
> Replying to [comment:2 jdemeyer]:
> > Why re-invent the wheel?  Why not use [http://docs.python.org/library/fcntl.html#fcntl.lockf](http://docs.python.org/library/fcntl.html#fcntl.lockf)?
> Because I was being dumb and couldn't find that function :).
> > Also, this should obviously be reported upstream.
> Yup, although upstream is basically dead. IMO we should switch to distribute (I'll see about making an SPKG).

At this point I'd like to point you to SPKG.txt and actually read it:

```
# setuptools

## Description

setuptools is a collection of enhancements to the Python distutils (for Python 2.3.5 and up on mo
st platforms; 64-bit platforms require a minimum of Python 2.4) that allow you to more easily bui
ld and distribute Python packages, especially ones that have dependencies on other packages.

Website: http://pypi.python.org/pypi/setuptools/

The present spkg is based on the fork of setuptools known as distribute.
Website: http://pypi.python.org/pypi/distribute
```

And

```
### setuptools-0.6.16 (Francois Bissey, June 1, 2011)
 * Switch to the "distribute" fork of setuptools and update to 0.6.16, 
 * adopt a Gentoo patch to avoid warnings with python-2.7 (works with 2.6 too). 
 * Remove the two windows binaries and patch so setup.py doesn't
   try to install them.
```

This was a pre-requisite to the upgrade to python-2.7.3. Fell free to upgrade to a newer version of distribute and change the name if you want too.


---

Comment by ohanar created at 2013-03-17 09:50:25

Yeah, I made that remark about 5 minutes before completely reading through the SPKG.txt. I haven't really looked at this in awhile, but I probably won't be touching this soon, as I'm really trying to put all of my time into working on the transition to git.


---

Comment by fbissey created at 2013-03-17 09:53:43

I checked if you said that in the ticket but didn't see it so I assumed... too much. ;)


---

Comment by git created at 2014-02-28 15:24:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-28 20:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-02-28 20:23:19

New attempt... The patch didn't apply, so I wrote a different version. It is now IMHO clearer though perhaps at the cost of rewriting a pth file even if it is not dirty. But then it is hardly a performance-critical step.


---

Comment by vbraun created at 2014-02-28 20:24:15

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-02-28 20:24:15

We can't push the changes upstream since fcntl is unix only but setuptools has to work on (non-cygwin) windows


---

Comment by vbraun created at 2014-02-28 20:26:43

Changing priority from major to critical.


---

Comment by vbraun created at 2014-02-28 20:26:43

Critical as we currently have some races as I noticed in parallel testing.


---

Comment by ohanar created at 2014-02-28 21:29:29

Looks fine, although I'll have to test it out. It would be good to get some sort of proper locking in upstream -- maybe doing something along the lines of http://code.activestate.com/recipes/65203/.


---

Comment by ohanar created at 2014-02-28 21:43:27

The patch version of setuptools will need a version bump to force a rebuild. Also, it would be good to have the patch documented in the SPKG.txt. Pending those two things, positive review.


---

Comment by git created at 2014-03-11 12:53:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-03-11 12:53:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-03-11 12:53:41

Done.


---

Comment by git created at 2014-03-11 12:56:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2014-03-11 12:56:48

Changing status from positive_review to needs_review.


---

Comment by vbraun created at 2014-03-11 16:15:35

Resolution: fixed


---

Comment by jdemeyer created at 2014-10-31 13:39:09

You just broke sagenb: #17268
