# Issue 21193: Set JUPYTER_CONFIG_DIR

Issue created by migration from https://trac.sagemath.org/ticket/21430

Original creator: jdemeyer

Original creation time: 2016-09-06 07:38:51

CC:  chapoton

We should set `JUPYTER_CONFIG_DIR` instead of `IPYTHONDIR`.


---

Comment by vbraun created at 2016-09-06 08:38:19

I would still try to version the directory name as this caused breakage before


---

Comment by jdemeyer created at 2016-09-06 09:02:15

New commits:


---

Comment by jdemeyer created at 2016-09-06 09:02:15

Changing status from new to needs_review.


---

Comment by embray created at 2016-09-09 08:27:11

Versioning the directory name is a good idea, but I'm not sure about hard-coding it `sage-env`.  There is no obvious pointer that this would need to be updated when updating the IPython/Jupyter versions in Sage.  This will inevitably bit-rot.  Instead it should read the package version from somewhere else.


---

Comment by jdemeyer created at 2016-09-09 08:38:02

Replying to [comment:7 embray]:
> Versioning the directory name is a good idea, but I'm not sure about hard-coding it `sage-env`.  There is no obvious pointer that this would need to be updated when updating the IPython/Jupyter versions in Sage.  This will inevitably bit-rot.  Instead it should read the package version from somewhere else.

You are misunderstanding. The hardcoding is intentional, the idea is *not* to update it every time that IPython/Jupyter gets updated. I thought that the comments in `sage-env` explain this, but apparently that is not clear.


---

Comment by leif created at 2016-09-09 08:41:23

Replying to [comment:7 embray]:
> Versioning the directory name is a good idea, but I'm not sure about hard-coding it `sage-env`.  There is no obvious pointer that this would need to be updated when updating the IPython/Jupyter versions in Sage.  This will inevitably bit-rot.  Instead it should read the package version from somewhere else.

Hmmm, the `spkg-install` files currently don't seem very suited for a sanity-check, although they could parse their own `package-version.txt` and compare that to the env var(s).  I don't trust upstream versioning though.


---

Comment by leif created at 2016-09-09 08:46:07

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 embray]:
> > Versioning the directory name is a good idea, but I'm not sure about hard-coding it `sage-env`.  There is no obvious pointer that this would need to be updated when updating the IPython/Jupyter versions in Sage.  This will inevitably bit-rot.  Instead it should read the package version from somewhere else.
> 
> You are misunderstanding. The hardcoding is intentional, the idea is *not* to update it every time that IPython/Jupyter gets updated. I thought that the comments in `sage-env` explain this, but apparently that is not clear.

I think he rather meant who will remember to change `sage-env` when one upgrades to IPython 6.x (presumably next week ;-) ).


---

Comment by embray created at 2016-09-09 08:46:57

No, the comment was pretty vague.  I don't know what "IPython versions compatible with that version" means.


---

Comment by embray created at 2016-09-09 08:49:32

Replying to [comment:9 leif]:
> Replying to [comment:7 embray]:
> > Versioning the directory name is a good idea, but I'm not sure about hard-coding it `sage-env`.  There is no obvious pointer that this would need to be updated when updating the IPython/Jupyter versions in Sage.  This will inevitably bit-rot.  Instead it should read the package version from somewhere else.
> 
> Hmmm, the `spkg-install` files currently don't seem very suited for a sanity-check, although they could parse their own `package-version.txt` and compare that to the env var(s).  I don't trust upstream versioning though.

I'm thinking each spkg should have its own "sage environment setup participant hook"--i.e. "here is a bash snippet _specific_ to this package that should be sourced during `sage-env`."  That would go a long way toward making `sage-env` more comprehensible, and keeping spkgs better self-contained.


---

Comment by git created at 2016-09-09 08:51:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by leif created at 2016-09-09 08:54:29

Replying to [comment:12 embray]:
> I'm thinking each spkg should have its own "sage environment setup participant hook"--i.e. "here is a bash snippet _specific_ to this package that should be sourced during `sage-env`."  That would go a long way toward making `sage-env` more comprehensible, and keeping spkgs better self-contained.

Yes, tag regions of the shell script with `# optional -- foo, bar`...


---

Comment by leif created at 2016-09-09 08:55:58

I guess you'll quickly end up in a dependency hell.


---

Comment by jdemeyer created at 2016-09-09 08:58:40

Replying to [comment:12 embray]:
> I'm thinking each spkg should have its own "sage environment setup participant hook"--i.e. "here is a bash snippet _specific_ to this package that should be sourced during `sage-env`."  That would go a long way toward making `sage-env` more comprehensible, and keeping spkgs better self-contained.

Perhaps, but that's besides the point of this ticket.


---

Comment by fbissey created at 2016-09-09 08:59:24

I guess Erik is thinking of something akin to `/etc/env.d` or `/etc/profile.d` but sourced from `build/pkg/$pkgname/env`. An interesting idea in principle. it doesn't have to be involved with dependencies.

But I was OK with the old comments and I am OK with the new one.


---

Comment by leif created at 2016-09-09 09:02:57

Replying to [comment:17 fbissey]:
> I guess Erik is thinking of something akin to `/etc/env.d` or `/etc/profile.d` but sourced from `build/pkg/$pkgname/env`. An interesting idea in principle. it doesn't have to be involved with dependencies.
> 
> But I was OK with the old comments and I am OK with the new one. 

Still, this needs to be documented in `build/pkgs/*`.  (Who reads `SPKG.txt`?  Better also in `spkg-install` IMHO, if not even adding a sanity check as mentioned.)


---

Comment by leif created at 2016-09-09 09:10:27

Doesn't seem we yet do similar for `ipython_genutils`.


---

Comment by leif created at 2016-09-09 09:14:42

Replying to [comment:19 leif]:
> Doesn't seem we yet do similar for `ipython_genutils`.

Ooops, but that's yet another `build/pkgs/foo/...`.


---

Comment by fbissey created at 2016-09-09 09:20:53

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2016-09-09 09:20:53

Enough bike shedding. Positive review.


---

Comment by leif created at 2016-09-09 10:16:06

Replying to [comment:21 fbissey]:
> Enough bike shedding. Positive review.

I'll remind you next time you want something documented.

(These environment variables aren't even documented in the Sage _Installation_ Guide, where *all* environment variables used by Sage, not necessarily supposed to be set or modified by the user, are documented for historical reasons.)

----

But definitely needs work because you're not exactly hardcoding the folders; if a user happens to have them already set in his/her environment, this is asking for trouble.


---

Comment by leif created at 2016-09-09 10:16:06

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-09-09 10:34:01

Replying to [comment:22 leif]:
> (These environment variables aren't even documented in the Sage _Installation_ Guide, where *all* environment variables used by Sage, not necessarily supposed to be set or modified by the user, are documented for historical reasons.)

I don't think it makes sense for Sage to document *all* environment variables used by *all* packages of Sage. It should document Sage-specific environment variables, not those of packages inside the Sage distribution.

> But definitely needs work because you're not exactly hardcoding the folders; if a user happens to have them already set in his/her environment, this is asking for trouble.

No, if the user has them already set in his environment, we assume that the user knows what he is doing. I see the `JUPYTER_CONFIG_DIR` in `sage-env` simply as a reasonable default that users should still be able to override.


---

Comment by jdemeyer created at 2016-09-09 10:34:01

Changing status from needs_work to needs_review.


---

Comment by leif created at 2016-09-09 14:42:39

Replying to [comment:23 jdemeyer]:
> Replying to [comment:22 leif]:
> > (These environment variables aren't even documented in the Sage _Installation_ Guide, where *all* environment variables used by Sage, not necessarily supposed to be set or modified by the user, are documented for historical reasons.)
> 
> I don't think it makes sense for Sage to document *all* environment variables used by *all* packages of Sage. It should document Sage-specific environment variables, not those of packages inside the Sage distribution.

We don't document variables that are solely set and used internally, but those the user may want to set or modify, those that Sage sets and a user/developer may find to be valuable to use, and those that we change _although the user is likely to expect we honor his/her setting_, for example `MPLCONFIGDIR`.

\\

> > But definitely needs work because you're not exactly hardcoding the folders; if a user happens to have them already set in his/her environment, this is asking for trouble.
> 
> No, if the user has them already set in his environment, we assume that the user knows what he is doing.

Besides that your assumption is presumably wrong in most cases, then "hardcoding" is the wrong term.

\\

> I see the `JUPYTER_CONFIG_DIR` in `sage-env` simply as a reasonable default that users should still be able to override.

`IPYTHONDIR`  as well?  `PYTHONPATH`?  `PYTHONHOME`?  What else?

(Btw., `CC`, `CXX` etc. get overridden in case Sage's GCC is installed; why don't you respect a user's setting there as well?)

If you really want to create more of such pitfalls, the need to document this is even greater, i.e., it needs to get mentioned in more prominent locations such as READMEs as well, and a warning should get issued unless it is totally clear the user did intentionally override one of these "default" settings.  You'll get error reports because of this anyway, but hopefully less.  But it would still be better to provide other, more explicit ways to override Sage's "default" settings if you really want to support that.  Sage's `configure` for example also bails out in a couple of cases *unless* one sets `SAGE_PORT=yes`, which is a pretty similar situation, although this affects even less people, namely only those building from source.

Only a tiny percentage of the Sage users will even know these environment variables exist, what their meaning is, and whether they're perhaps (unintentionally) set in their environment.  Just read a bit in sage-support, or on ask.sagemath.org.  Even "Sage _developers_" are mostly mathematicians, and not all of them have computers, operating systems, shells etc. as their beloved hobby.


---

Comment by leif created at 2016-09-09 14:54:14

P.S.:  I'm absolutely no fan of nannying people, but we should follow the principle of least surprise (and disappointment) also for those not that deep in Sage's (and its packages') matter.

After all, there are configuration files those that want to can modify.  Still no `.sagerc` though, if I'm not mistaken.


---

Comment by jdemeyer created at 2016-09-09 19:36:48

It is still not clear to me why Sage should document environment variables which have nothing to do with Sage but which are for other projects.


---

Comment by leif created at 2016-09-09 19:52:48

Replying to [comment:26 jdemeyer]:
> It is still not clear to me why Sage should document environment variables which have nothing to do with Sage but which are for other projects.

Such as?


---

Comment by jdemeyer created at 2016-09-09 20:41:58

Replying to [comment:27 leif]:
> Replying to [comment:26 jdemeyer]:
> > It is still not clear to me why Sage should document environment variables which have nothing to do with Sage but which are for other projects.
> 
> Such as?

`JUPYTER_CONFIG_DIR` what this ticket is about. It is perfectly fine if users don't know about this variable.


---

Comment by leif created at 2016-09-09 21:16:35

But you're doing the same with `IPYTHONDIR` (although not mentioned in the ticket's title, and the description is misleading as well).

More precisely, you're introducing sharing folders (hence configuration) between unrelated and potentially different/incompatible instances of IPython.  This is essentially the same as with Python and `PYTHONUSERBASE`.  It _might_ work to some extent (if you're lucky), but is more likely to cause trouble unless you really know/are aware of what you (and probably others) are doing, so IMHO nothing for "ordinary" users.  (Not to mention distros will mess with "their" installations as they like, and a user may not even know or immediately notice.)

Using the same folder for compatible versions of *Sage's* IPython makes sense, but nothing prevents people from (accidentally) using a folder outside of `$DOT_SAGE`, and especially not from using _the system's_ IPython's folder, and no matter what version the system's IPython is, as the variable name itself does not carry a version, because it is assumed there is exactly one "active" version.


---

Comment by jdemeyer created at 2016-09-09 21:34:36

Replying to [comment:29 leif]:
> nothing prevents people from (accidentally) using a folder outside of `$DOT_SAGE`

which is a problem because .......... (fill in the blank)


---

Comment by leif created at 2016-09-09 21:50:54

Replying to [comment:30 jdemeyer]:
> Replying to [comment:29 leif]:
> > nothing prevents people from (accidentally) using a folder outside of `$DOT_SAGE`
> 
> which is a problem because .......... (fill in the blank)

... that already violates the general convention of Sage to not modify anything outside `$SAGE_ROOT`, `$DOT_SAGE` (by default `$HOME/.sage/`), besides `$TMPDIR`.

Other exceptions are for example `$SAGE_BUILD_DIR`, but

 * that's well-documented,
 * it defaults to some location below `$SAGE_ROOT`,
 * the user has to explicitly set it,
 * there can't be any confusion (or unintentional collision) because the variable name starts with `SAGE_`, so (hopefully) isn't used by any other application,
 * we don't store persistent things, especially no configuration, there,
 * ...

But you of course missed the more important point.


---

Comment by jdemeyer created at 2016-09-09 22:03:04

Replying to [comment:31 leif]:
> ... that already violates the general convention of Sage to not modify anything outside `$SAGE_ROOT`, `$DOT_SAGE` (by default `$HOME/.sage/`), besides `$TMPDIR`.

I agree that this should be the case _by default_. However, if the user explicitly asks for a different directory, we should honor that.

> But you of course missed the more important point.

Well, you are writing so much stuff in the comments here, most of which is unrelated to the topic of this ticket. So it's easy to miss the important point. Honestly, I cannot really figure out which point you are making.


---

Comment by leif created at 2016-09-10 01:13:19

Replying to [comment:32 jdemeyer]:
> Replying to [comment:31 leif]:
> > ... that already violates the general convention of Sage to not modify anything outside `$SAGE_ROOT`, `$DOT_SAGE` (by default `$HOME/.sage/`), besides `$TMPDIR`.
> 
> I agree that this should be the case _by default_. However, if the user explicitly asks for a different directory, we should honor that.
> 
> > But you of course missed the more important point.
> 
> Well, you are writing so much stuff in the comments here, most of which is unrelated to the topic of this ticket. So it's easy to miss the important point. Honestly, I cannot really figure out which point you are making.

Well, you're just not willing to get the point, instead quoting just subsentences and asking for details regarding less important things.  Which part of _"accidentally"_, _"unintentionally"_ or _"not set by the user itself"_ did you _not_ understand?

The bare fact that `IPYTHONDIR` is (already) set means nothing, and especially not that it was set for the (same) version of IPython Sage ships and uses.

(And you didn't answer either why in your opinion in contrast `SAGE_PORT=yes` is necessary, `CC` needs to get overridden, why you force some compiler flags regardless of the context, or why `MAKE="$MAKE -j1"` should be necessary just because you personally once did get a failure without it.  That's just inconsistent to what you propose here.  In addition, `IPYTHONDIR` affects _any Sage user_, not just developers or people building from source.)


---

Comment by jdemeyer created at 2016-09-10 07:21:03

Replying to [comment:33 leif]:
> instead quoting just subsentences and asking for details regarding less important things.

Again, the more details you write, the easier it is for me to get lost in those details.

> Which part of _"accidentally"_, _"unintentionally"_ or _"not set by the user itself"_ did you _not_ understand?

I just don't understand how environment variables can be set _accidentally_.

> `CC` needs to get overridden

Well, we only override `CC` if the GCC package was installed. That makes sense because it means that the system `CC` was not good enough.

> why `MAKE="$MAKE -j1"` should be necessary

Which `MAKE="$MAKE -j1"` do you mean?


---

Comment by embray created at 2016-09-22 14:01:53

Replying to [comment:34 jdemeyer]:
> Replying to [comment:33 leif]:
> > Which part of _"accidentally"_, _"unintentionally"_ or _"not set by the user itself"_ did you _not_ understand?
> 
> I just don't understand how environment variables can be set _accidentally_.

Try teaching a workshop sometime.  You would not _believe_ the stuff users have in their `.profile` with literally no idea how it got there (usually something they added 13 months ago while feverishly copy-pasting and otherwise punching at the darkness while trying to get some .c file their professor e-mailed them to compile :)


---

Comment by embray created at 2016-09-22 14:07:27

Also, I haven't read this entire thread but just my $0.02 USD--I think it's appropriate to document environment variables that pertain to Sage--either that affect how Sage runs, or that Sage itself affects--even if they are not _specific_ to Sage.  Yes there's a slippery slope, but some variables may have more unexpected impact than others and are less generally well-understood.


---

Comment by jdemeyer created at 2016-09-22 15:23:55

Replying to [comment:36 embray]:
> Yes there's a slippery slope, but some variables may have more unexpected impact than others and are less generally well-understood.

I still think it's not the job of Sage to document all Jupyter-related environment variables. Maybe a compromise could be to add a pointer to the Jupyter documentation: http://jupyter.readthedocs.io/en/latest/projects/jupyter-directories.html


---

Comment by fbissey created at 2016-09-22 19:47:39

Replying to [comment:37 jdemeyer]:
> Replying to [comment:36 embray]:
> > Yes there's a slippery slope, but some variables may have more unexpected impact than others and are less generally well-understood.
> 
> I still think it's not the job of Sage to document all Jupyter-related environment variables. Maybe a compromise could be to add a pointer to the Jupyter documentation: http://jupyter.readthedocs.io/en/latest/projects/jupyter-directories.html

While it may not be the job to document other package variables, there is a case for documentation when sage change their default values. An experienced jupyter user may be wondering why they don't find stuff in `~/.jupyter` it should be easy for them to find out about sage's setting (other than reading `sage-env`).


---

Comment by klee created at 2016-09-23 08:34:00

How about adding "+" at the end: `export IPYTHONDIR="$DOT_SAGE/ipython-5.0.0+"`?


---

Comment by jdemeyer created at 2016-09-23 09:26:48

Replying to [comment:39 klee]:
> How about adding "+" at the end: `export IPYTHONDIR="$DOT_SAGE/ipython-5.0.0+"`?

What does this `+` symbol mean?


---

Comment by klee created at 2016-09-23 10:14:59

To mean that the configuration applies not only to `ipython-5.0.0` but also to all higher versions (until upgraded to a non-compatible version)


---

Comment by jdemeyer created at 2016-09-23 10:22:43

Replying to [comment:41 klee]:
> To mean that the configuration applies not only to `ipython-5.0.0` but also to all higher versions (until upgraded to a non-compatible version) 

Then you might as well call it `ipython-a` or whatever... I only chose `5.0.0` because that is the current version.


---

Comment by embray created at 2016-09-23 11:33:36

Replying to [comment:37 jdemeyer]:
> Replying to [comment:36 embray]:
> > Yes there's a slippery slope, but some variables may have more unexpected impact than others and are less generally well-understood.
> 
> I still think it's not the job of Sage to document all Jupyter-related environment variables. Maybe a compromise could be to add a pointer to the Jupyter documentation: http://jupyter.readthedocs.io/en/latest/projects/jupyter-directories.html

Nobody said it's the job of Sage to document "all" Jupyter-related variables.  Just ones that are commonly impacted by how Sage uses them.


---

Comment by git created at 2016-09-23 11:42:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-30 10:28:50

Still needs review...


---

Comment by embray created at 2016-10-03 09:43:38

Thanks for adding the docs!


---

Comment by embray created at 2016-10-03 09:43:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-03 22:42:03

Resolution: fixed
