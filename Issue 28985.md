# Issue 28985: Improvements to padic poylog

Issue created by migration from https://trac.sagemath.org/ticket/29222

Original creator: alexjbest

Original creation time: 2020-02-19 21:02:00

CC:  caruso

Keywords: polylog, padic

Two improvements for p-adic polylogarithms:

Python2->3 broke range of a rational in a way that didn't trigger any doctest failures, fix it and add a doctest.

Allow the user to specify the branch of the p-adic logarithm that is used, in the same way as for logarithm.


---

Comment by alexjbest created at 2020-04-16 22:40:39

Changing status from new to needs_review.


---

Comment by alexjbest created at 2020-04-16 22:40:39

New commits:


---

Comment by chapoton created at 2020-05-17 16:27:31

one failing doctest, see bot report


---

Comment by chapoton created at 2020-05-17 16:27:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-05-17 17:27:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2020-05-17 17:28:26

Ooops how did I miss that, thanks for the heads up.


---

Comment by chapoton created at 2020-05-22 11:59:08

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-05-22 11:59:08

rather ask an expert of the field


---

Comment by git created at 2020-05-27 20:53:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-05-28 09:03:57

The two new `raise ValueError` should be doctested.


---

Comment by git created at 2020-05-30 21:38:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-30 21:46:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-06-04 19:06:09

one doctest for the ValueError does not pass, and seems to trigger the other one instead


---

Comment by chapoton created at 2020-07-02 19:48:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-10-20 20:39:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2020-10-20 21:45:33

There appears to be some memory leak type problems with the polylog functions as the code

```
for p in prime_range(100):
    K = Qp(p,prec=10)
    print(p)
    for t in K.teichmuller_system():
        if t == 1:      
            continue    
        l = t.polylog(2)
        print(p,l)
```

eats more and more memory which isn't freed at the end.

I don't think these problems were necessarily introduced in this ticket, but nevertheless I'd like to diagnose them if anyone has any suggestions how to find the leaks or advice about likely culprits in the code.


---

Comment by alexjbest created at 2020-10-20 21:45:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-10-20 21:50:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2020-11-13 22:14:28

The memory leaks could be the same issue as #27536 it appears there are many `sage.rings.real_mpfr.RealNumber` left on the heap.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by roed created at 2021-04-28 21:08:58

Changing status from needs_review to needs_info.


---

Comment by roed created at 2021-04-28 21:08:58

Overall this looks good to me.

Have you made any progress on the memory leak?  I don't have any suggestions off the top of my head.  I think it's fine to create another ticket for that issue.

You use the `.n()` numerical approximation extensively.  Would it be better to specify the precision of the real field to use?  I'm also not sure if people like seeing the symbolic expression in some cases.  Maybe have a precision parameter that defaults to 53, but if it's set to None uses symbolic logs?

I'm happy giving this a positive review if you don't want to work on either of these.


---

Comment by alexjbest created at 2021-05-10 22:51:36

I haven't made progress on the leak, #27536 seems to have stalled too, so I think your suggestion of merging this as is and making a separate ticket sounds good.

Most of the `.n()` parts are just for determining various cutoffs for correct precision bounds, for most of these numbers only the integer part of the result matters.
I doubt anyone would want to look at them symbolically, or that more than 53 digits of precision would be needed. The motivation for the numerical approximations was that a lot of time was being wasted comparing various symbolic expressions to see which is larger, when comparing numerical approximations was far faster.
I could write these sorts of things as `RR(gsl-1).log(p)` instead I suppose, but I don't think it would make too much difference?

So I don't propose making further changes, unless you have more thoughts on these two issues mentioned of course!


---

Comment by roed created at 2021-05-14 18:15:00

Sounds good to me.


---

Comment by roed created at 2021-05-14 18:15:00

Changing status from needs_info to positive_review.


---

Comment by slelievre created at 2021-05-15 11:37:17

Leak issue now tracked at #31826.


---

Comment by vbraun created at 2021-06-06 13:19:28

Resolution: fixed
