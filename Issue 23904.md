# Issue 23904: Optimizations to Kleber tree

Issue created by migration from https://trac.sagemath.org/ticket/24141

Original creator: tscrim

Original creation time: 2017-11-02 08:51:40

CC:  sage-combinat aschilling bsalisbury01

Keywords: crystals, kleber tree

We are getting more speed out of the Kleber tree by:

- Using the brute force enumeration for "small" number of possible branches.
- Better Python code


---

Comment by tscrim created at 2017-11-02 09:16:31

By avoiding the polytopes, I get the following

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 4.94 s, sys: 16 ms, total: 4.96 s
Wall time: 2.78 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```

in contrast to

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time RC.kleber_tree()
CPU times: user 2min 40s, sys: 340 ms, total: 2min 41s
Wall time: 29 s
Virtual Kleber tree of Cartan type ['F', 4, 1] and B = ((3, 8),)
```

Note that I am using `normaliz` on a machine with 4 CPUs + 4 hyperthreaded cores, which works very well for getting those initial branchings.


---

Comment by tscrim created at 2017-11-02 09:57:03

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-11-02 09:57:03

By being better about how often we are creating a dense matrix (in other words, only do it once!), I got some more speed:

```
sage: RC = RiggedConfigurations(['F',4,1], [[3,8]])
sage: %time len(RC.kleber_tree())
CPU times: user 3.58 s, sys: 12 ms, total: 3.59 s
Wall time: 2.08 s
3395
```


There might be a better way to pre-prune in `_children_iter_vector` as I believe the edge roots need to be symmetric as well. So by utilizing the folding, we could further limit the number of cases checked by the virtual Kleber trees. I might do that tomorrow, but it could easily enough go on a followup. This is already a huge speed gain.
----
New commits:


---

Comment by bsalisbury1 created at 2018-02-02 20:26:34

Everything looks good to me.


---

Comment by bsalisbury1 created at 2018-02-02 20:26:34

Changing status from needs_review to positive_review.


---

Comment by git created at 2018-02-02 20:27:32

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2018-02-02 20:27:32

Changing status from positive_review to needs_review.


---

Comment by bsalisbury1 created at 2018-02-02 20:27:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-03 21:22:03

Resolution: fixed
