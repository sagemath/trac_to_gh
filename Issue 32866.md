# Issue 32866: gitpod integration using Docker images from portability testing workflow

Issue created by migration from https://trac.sagemath.org/ticket/33103

Original creator: mkoeppe

Original creation time: 2022-01-01 19:34:16

CC:  @tobiasdiez dimpase saraedum

Based on #32749.


---

Comment by mkoeppe created at 2022-01-01 19:41:25

Last 10 new commits:


---

Comment by git created at 2022-01-01 19:44:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 20:27:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 20:59:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-01 21:35:52

Running into `pyenv` issues (#29285) here too: 

```
[pytest] installing. Log file: /home/gitpod/sage/logs/pkgs/pytest.log
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   /home/gitpod/sage-local/var/lib/sage/venv-python3.8/bin/python3: No module named pip
  [pytest] Full log file: /home/gitpod/sage/logs/pkgs/pytest.log
make[4]: *** [Makefile:2756: pytest-no-deps] Error 1
```



---

Comment by git created at 2022-01-02 02:01:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-02 02:09:46

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-02 02:26:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-02 05:04:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-02 06:56:25

This works. To be done:
- Additional tags for the images, for example `latest` for releases, or branch/tag name (`${GITHUB_REF_NAME}` - https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables) -  suitable for `.gitpod.yml`
- Could use `docker/.gitpod.Dockerfile` again with `COPY --from` to make the final image smaller (currently /home/gitpod/sage has the old source tree)


---

Comment by git created at 2022-01-02 21:42:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-02 22:30:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-02 23:51:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-03 05:36:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 05:46:49

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-01-03 07:19:13

Also the configuration of VS Code should be improved. It seems to start up using the wrong interpreter (not `venv/bin/python3`), and also one needs to manually select the right Jupyter kernel. 

The scipy folks have some good documentation and configuration (https://scipy.github.io/devdocs/dev/contributor/quickstart_gitpod.html), perhaps we can lift something from there.


---

Comment by @tobiasdiez created at 2022-01-03 12:11:37

Is the prebuild working for this branch?

How can one work with branches that update sage packages? With #32749 one could trigger a rebuild of the docker image (and thus of the system packages) using the `#imagebuild` context. Can something like this also be implemented here? For example, take the github action build docker as base, and then re-install system or python packages on top of this if they have newer versions?

For the VS integration, #30677 is closed but not yet merged into develop.


---

Comment by mkoeppe created at 2022-01-03 17:35:18

Replying to [comment:32 gh-tobiasdiez]:
> Is the prebuild working for this branch?

I've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.

> How can one work with branches that update sage packages? 

Nothing special, `make` just rebuilds what needs rebuilding.


---

Comment by mkoeppe created at 2022-01-03 17:41:51

Replying to [comment:32 gh-tobiasdiez]:
> For the VS integration, #30677 is closed but not yet merged into develop.

I forgot to say that the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates already contains #30677 and other updates


---

Comment by @tobiasdiez created at 2022-01-03 17:44:24

Replying to [comment:33 mkoeppe]:
> Replying to [comment:32 gh-tobiasdiez]:
> > Is the prebuild working for this branch?
> 
> I've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.
> 
> > How can one work with branches that update sage packages? 
> 
> Nothing special, `make` just rebuilds what needs rebuilding.

So this would then be done as part of the prebuild?


---

Comment by mkoeppe created at 2022-01-03 18:14:31

Yes, I think so


---

Comment by mkoeppe created at 2022-01-03 18:18:20

Looks like I'll have to add some configuration so that it does prebuilds on all branches


---

Comment by mkoeppe created at 2022-01-03 18:24:49

I created a "project" and now it looks like the prebuild triggered by a push is running - https://gitpod.io/projects/sage


---

Comment by git created at 2022-01-03 18:25:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 18:31:31

Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package


---

Comment by @tobiasdiez created at 2022-01-03 18:33:31

Replying to [comment:40 mkoeppe]:
> Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package

That's very nice!


---

Comment by git created at 2022-01-03 18:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 19:06:46

The prebuild was just killed because of the 35m timeout. 
What's the best choice of timeout according to your experiments?


---

Comment by @tobiasdiez created at 2022-01-03 19:12:01

If its really the timeout that killed the prebuild (in which the prebuild would be green and be used for the next workspace, but maybe doesn't contain all packages) then you can go to 50min. Maybe a bit less since the docker image is quite big so this part may take some time. But essentially you have to calculate 60min - bootstrap and config (2-3min) - docker init and copying (?? min).

However, for me the prebuild often timed out after 1h (then its shown red in the project view). The only solution I've found for this is not using symlinks into /home/.


---

Comment by mkoeppe created at 2022-01-03 19:13:54

https://gitpod.io/projects/sage/e8780c03-b8b8-4810-a772-d4cc2994b6bf shows

```
[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log
  [pytest] successfully installed.
  [sphinx-4.3.1] successfully installed.
make[1]: *** [Makefile:39: all-build] Terminated
make: *** [Makefile:16: build] Terminated
exit
```


but it is still claims "RUNNING: Prebuild in progress"


---

Comment by mkoeppe created at 2022-01-03 19:14:28

However, https://gitpod.io/projects/sage/prebuilds shows READY.


---

Comment by mkoeppe created at 2022-01-03 19:14:50


```

ðŸ¤™ This task ran as a workspace prebuild
ðŸŽ‰ Well done on saving 37 minutes
```



---

Comment by @tobiasdiez created at 2022-01-03 19:21:09

A few more points:
- please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)
- `--prefix=$HOME/sage-local` in gitpod.yml should probably be `/workspace/sage-local` or a few lines above `$HOME` should be used?
- probably 8 parallel tasks are fine. gitpod gives 6 (or 7?) vCPUs to users.


---

Comment by @tobiasdiez created at 2022-01-03 19:21:35

Replying to [comment:48 mkoeppe]:
> {{{
> 
> ðŸ¤™ This task ran as a workspace prebuild
> ðŸŽ‰ Well done on saving 37 minutes
> }}}

Nice, then you can go to 50min indeed.


---

Comment by git created at 2022-01-03 19:26:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 19:28:02

Presumably the `before` script should try to resume the build in case the prebuild timed out.


---

Comment by @tobiasdiez created at 2022-01-03 19:34:55

I agree. But `init` is called after `before` during the prebuild, and I couldn't find a way to detect if one is in a prebuild or not...


---

Comment by git created at 2022-01-03 19:43:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-03 19:54:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 19:56:12

Replying to [comment:49 gh-tobiasdiez]:
> - please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)

I've updated it - the ssh stuff was already same


---

Comment by git created at 2022-01-03 20:00:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-03 20:11:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-03 20:46:06

https://gitpod.io/projects/sage/134676a9-2a0e-429a-816d-68ad30441f58

```
[sphinx-4.3.1] installing. Log file: /workspace/sage/logs/pkgs/sphinx-4.3.1.log
[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log
  [pytest] successfully installed.
  [sphinx-4.3.1] successfully installed.
  [sagelib-9.5.beta9] successfully installed.
make --no-print-directory sage_docbuild-SAGE_VENV-no-deps
[sage_docbuild-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sage_docbuild-9.5.beta9.log
  [sage_docbuild-9.5.beta9] successfully installed.
make[2]: Leaving directory '/workspace/sage/build/make'

real    31m8.684s
user    101m44.392s
sys     3m47.093s
SAGE_CHECK=warn, so scanning the log files. This may take a few seconds.
Sage build/upgrade complete!
make[1]: Leaving directory '/workspace/sage'
exit

ðŸ¤™ This task ran as a workspace prebuild
ðŸŽ‰ Well done on saving 34 minutes
```



---

Comment by mkoeppe created at 2022-01-03 22:52:34

Replying to [comment:54 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[fdb332d](https://git.sagemath.org/sage.git/commit/?id=fdb332d2a52db9f63fc54960d029a5ad9c529a61)||`.gitpod.yml: Run 'make' again in 'before' task if prebuild 'make' timed out`||

This worked but for some reason the Sphinx package installation was repeated in this step. It's fast but I'll try if refreshing the timestamps of the install records will avoid it.


---

Comment by git created at 2022-01-04 00:15:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-04 01:10:06

There are some weird synchronization issues on the server side - it seems that if one creates a workspace right after a prebuild has completed, it can happen that it does not use the prebuild.


---

Comment by git created at 2022-01-04 01:21:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-04 01:30:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-04 06:46:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-04 07:59:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-04 08:59:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-04 09:01:15

OK, now it's in good shape.

Could you check that the SSH stuff works as intended and matches the added documentation?
I see

```
$ ls -l ~/.ssh
total 24
-rw-r--r-- 1 gitpod gitpod   381 Jan  4 08:53 authorized_keys
-rw------- 1 gitpod gitpod     0 Jan  4 08:53 id_rsa
-rw-r--r-- 1 gitpod gitpod   664 Jan  4 08:53 known_hosts
-rw-r--r-- 1 gitpod gitpod 15544 Jan  4 08:53 supervisor_env
```

and am not sure what the empty `id_rsa` is intended for


---

Comment by @tobiasdiez created at 2022-01-04 12:16:23

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR27

There you don't need/want the timeout.


---

Comment by @tobiasdiez created at 2022-01-04 12:20:03

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR17

I'm not sure if I understand the logic behind this and related commands (maybe add a bit more documentation of what's going on?). But please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror (which is probably what's going to happen if you want to check someone elses branch)


---

Comment by @tobiasdiez created at 2022-01-04 12:22:37

Replying to [comment:68 mkoeppe]:
> Could you check that the SSH stuff works as intended and matches the added documentation?
> and am not sure what the empty `id_rsa` is intended for

Did you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.


---

Comment by @tobiasdiez created at 2022-01-04 12:28:35

Replying to [comment:68 mkoeppe]:
> OK, now it's in good shape.

For me it takes over 5min to start a workspace due to the large workspace image (it displays "fetching build image" or something like this in the loading screen). I think this should be optimized as part of this ticket since otherwise I fear people will not adopt gitpod for e.g. reviewing of tickets.

Also it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.


---

Comment by @tobiasdiez created at 2022-01-04 12:32:40

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442

Is the somewhat strange indention by design?


---

Comment by mkoeppe created at 2022-01-04 13:17:38

Replying to [comment:72 gh-tobiasdiez]:
> Also it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.

It no longer breaks the Sage build since #29285, but I'll add it anyway


---

Comment by git created at 2022-01-04 13:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-04 13:21:10

Replying to [comment:73 gh-tobiasdiez]:
> https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442
> 
> Is the somewhat strange indention by design?

The link does not show a particular line -- what are you referring to?


---

Comment by mkoeppe created at 2022-01-04 13:22:18

Replying to [comment:70 gh-tobiasdiez]:
>  please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror 

Thanks, done.


---

Comment by mkoeppe created at 2022-01-04 13:27:32

Replying to [comment:71 gh-tobiasdiez]:
> Replying to [comment:68 mkoeppe]:
> > Could you check that the SSH stuff works as intended and matches the added documentation?
> > and am not sure what the empty `id_rsa` is intended for
> 
> Did you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.

Thanks for checking - I had missed a step.


---

Comment by git created at 2022-01-04 13:49:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-04 13:57:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-04 17:12:15

Replying to [comment:76 mkoeppe]:
> Replying to [comment:73 gh-tobiasdiez]:
> > https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442
> > 
> > Is the somewhat strange indention by design?
> 
> The link does not show a particular line -- what are you referring to?

Strange, normally that works. It's the gitpod related changes in `tox.ini` (l. 438)


---

Comment by mkoeppe created at 2022-01-04 17:47:30

Replying to [comment:81 gh-tobiasdiez]:
> Replying to [comment:76 mkoeppe]:
> > Replying to [comment:73 gh-tobiasdiez]:
> > > Is the somewhat strange indention by design?
> 
> the gitpod related changes in `tox.ini` (l. 438)

It is indented as intended. This file aspires to be a spreadsheet.


---

Comment by mkoeppe created at 2022-01-04 19:03:59

There are still some minor details wrong. In `logs/sphinx-4.3.1.log`:

```
Uninstalling existing 'sphinx'
Warning: File '/home/gitpod/sage-local/var/lib/sage/wheels/Sphinx-4.2.0-py3-none-any.whl' not found
Warning: Directory '/home/gitpod/sage-local/var/lib/sage/wheels' not found
Running pip-uninstall script for 'sphinx'
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/scripts/sphinx/spkg-piprm: line 14: /home/gitpod/sage/build/bin/sage-dist-helpers: No such file or directory
Error: failed to source /home/gitpod/sage/build/bin/sage-dist-helpers
Is /home/gitpod/sage the correct SAGE_ROOT?
Warning: Error running the pip-uninstall script for 'sphinx'; uninstallation may have left behind some files
Removing stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'
```



---

Comment by mkoeppe created at 2022-01-04 19:09:33

Package-removal scripts (`{prefix,venv}/var/lib/sage/scripts/*/spkg-piprm`) hardcode the `SAGE_ROOT` and `SAGE_SRC` from the time when the package was installed (the Docker-build phase); so I will also put a symlink in place for that.


---

Comment by git created at 2022-01-04 19:19:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-04 21:12:04

Fixed now, `logs/sphinx-4.3.1.log` now shows:

```
Found existing installation: Sphinx 4.2.0
Uninstalling Sphinx-4.2.0:
  Successfully uninstalled Sphinx-4.2.0
Removing stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'
Installing sphinx-4.3.1
```

and also `venv/var/lib/sage/wheels/` now only contains one sphinx wheel.


---

Comment by mkoeppe created at 2022-01-04 22:05:32

Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there


---

Comment by git created at 2022-01-05 03:46:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-05 05:04:11

Now it starts with the right interpreter, and also "Jupyter: Create New Jupyter Notebook" works - "Select Kernel" offers the Sage kernel.


---

Comment by @tobiasdiez created at 2022-01-05 12:19:21

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-01-05 12:19:21

It still takes over 8min until the workspace is loaded for me due to "Pulling container image". This should really optimized as part of this ticket. 

Also pyenv shell still seems to be activated, I think it needs to be disabled in before and init.


---

Comment by git created at 2022-01-05 16:48:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-05 17:04:41

Ready now in https://github.com/mkoeppe?tab=packages&q=gitpod


---

Comment by git created at 2022-01-05 19:20:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-05 19:25:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-05 19:25:21

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-01-06 12:38:07

That sadly doesn't solve the issue for me. Starting a workspace still takes 8+ mins, while #32749 takes about 2mins.

It also seems that the workspace image is quite large at around 16GB. In particular, the sage folder contains

``` 
4.9G    local
6.2G    src
```


I'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):

```
1.8G    ./local/share/doc
4.3G    ./src/build
```


Moreover,

```
3.0G    /usr
3.3G    /home
```


is also bigger than the one from the other image of #32749

```
2.2G    /usr
2.3G    /home
```


So I suggest to use gitpod/workspace-base as a base.


---

Comment by mkoeppe created at 2022-01-06 17:27:19

Replying to [comment:99 gh-tobiasdiez]:
> Starting a workspace still takes 8+ mins

Probably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance


---

Comment by mkoeppe created at 2022-01-06 17:31:38

Replying to [comment:99 gh-tobiasdiez]:
> I'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):
> {{{
> 1.8G    ./local/share/doc
> 4.3G    ./src/build
> }}}

I'll check if we can delete them without sacrificing fast rebuilds of documentation (`make doc-html`) and sagelib (`./sage -b`). 

For documentation, I see

```
[sagemath_doc_html-none] make doc-inventory--reference-references
[sagemath_doc_html-none] cd /workspace/sage && ./sage --docbuild --no-pdf-links reference/references inventory 
[sagemath_doc_html-none] [reference] loading pickled environment... failed
[sagemath_doc_html-none] [reference] failed: source directory has changed
```

... so something is not ideal there anyway


---

Comment by @tobiasdiez created at 2022-01-06 17:40:38

Replying to [comment:100 mkoeppe]:
> Replying to [comment:99 gh-tobiasdiez]:
> > Starting a workspace still takes 8+ mins
> 
> Probably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance

Apparently, images are built in the US and then downloaded every time from there without caching. This explains why it takes so much longer for me. Gitpod is working on a solution https://github.com/gitpod-io/gitpod/issues/7002 and https://github.com/gitpod-io/gitpod/issues/6145. But having a 15GB+ image is not ideal anyway.


---

Comment by mkoeppe created at 2022-01-06 18:01:00

top-level `Makefile` has targets `micro_release`, `fast-rebuild-clean` that do related stuff.


---

Comment by git created at 2022-01-06 19:31:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-06 19:32:52

Replying to [comment:99 gh-tobiasdiez]:
> {{{
> 3.0G    /usr
> 3.3G    /home
> }}}
> 
> is also bigger than the one from the other image of #32749
> {{{
> 2.2G    /usr
> 2.3G    /home
> }}}
> 
> So I suggest to use gitpod/workspace-base as a base.

Building a new image at https://github.com/mkoeppe/sage/runs/4731195747


---

Comment by mkoeppe created at 2022-01-06 19:48:17


```
fast-rebuild-clean: misc-clean
	rm -rf upstream/
	rm -rf build/pkgs/sagelib/src/build/temp.*
	# The .py files in src/build are restored from src/sage without their
	# mtimes changed.
	-find build/pkgs/sagelib/src/build -name '*.py' -exec rm \{\} \;
	# Remove leftovers from ancient branches
	rm -rf src/build
```

This is not compatible with `configure --enable-editable`, which uses `src/build/` instead of `build/pkgs/sagelib/src/build/`.


---

Comment by @tobiasdiez created at 2022-01-06 20:43:09

Why does the editable install actually needs `src/build` or even copies something there? The compiled cython code (.so files) are placed next to the cython file.


---

Comment by mkoeppe created at 2022-01-06 21:20:32

I think that's just standard `setuptools` behavior


---

Comment by mkoeppe created at 2022-01-06 22:38:48

The `setuptools` option `--build-temp` could be used to put the temp directories outside of `/workspace`.

Or we could just unconditionally remove the temp directory at the end of `build/pkgs/sagelib/spkg-install`.


---

Comment by git created at 2022-01-06 23:08:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-07 07:34:39

It's much smaller now

```
gitpod /workspace/sage (mkoeppe-9.5.beta9+updates) $ du -sh src local /usr /home
3.1G    src
3.9G    local
2.4G    /usr
76K     /home
```

and rebuilds are still fast


---

Comment by git created at 2022-01-07 07:35:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-07 12:59:49

Thanks, its way better now (around 4-5min). I would say the doc folder can still be removed. If someone is working on the docs, then one can easily only create the relevant file without the need to build the whole docs.


---

Comment by @tobiasdiez created at 2022-01-07 16:04:17

The following folders should be deleted as well

```
212M    /tmp
32M     /var/lib/apt/lists (remove as part of the apt-get install command)
```


A few packages that I think are not used by the built script or needed in general:

```
3722    python2.7-minimal
9370    libflint-dev
10026   pari-gp (and other pari-related stuff)
13215   ecl
14279   libsingular4-dev (and other singular-related stuff)
19531   libgiac0 (and other giac-related stuff)
30765   vim-runtime
41291   emacs-nox
66816   emacs-common
330712  libgl1-mesa-dri (?)
```

I would suggest to exclude them from the installation / uninstall them, similar to what is done in #32749. 

Together that should give another 1GB.


---

Comment by git created at 2022-01-07 18:19:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-07 18:23:56

New image building at https://github.com/mkoeppe/sage/runs/4742213151


---

Comment by git created at 2022-01-07 18:39:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-01-07 20:10:46

For the record, that's how gitpod is cleaning up the package installation cache/log: https://github.com/gitpod-io/workspace-images/blob/master/base/install-packages#L32-L36


---

Comment by @tobiasdiez created at 2022-01-07 20:11:37

Replying to [comment:116 mkoeppe]:
> New image building at https://github.com/mkoeppe/sage/runs/4742213151

Thanks! Will try it once its finished.


---

Comment by git created at 2022-01-07 20:14:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-08 06:04:23


```
$ du -sh src local /usr /home /tmp /var/tmp
3.1G    src
3.1G    local
2.0G    /usr
36K     /home
31M     /tmp
0       /var/tmp
```



---

Comment by mkoeppe created at 2022-01-08 06:23:34

I don't think it's necessary to remove packages such as `emacs` that come with `gitpod/workspace-base`.


---

Comment by mkoeppe created at 2022-01-08 07:11:01

Replying to [comment:88 mkoeppe]:
> Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there

Too bad, this no longer works with the smaller base image because it does not have docker. 

And `sudo apt-get install docker.io` is not sufficient to fix it:

```
$ docker run -it ubuntu:bionic bash
[...]
docker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.
ERRO[0008] error waiting for container: context canceled 

$ sudo docker run -it ubuntu:bionic bash
docker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.
ERRO[0001] error waiting for container: context canceled 
```



---

Comment by @tobiasdiez created at 2022-01-08 20:11:25

Thanks, this seems to work reasonable well for me (still 4 mins, but well...).

One could still shave off 250mb by uninstalling emacs-nox, vim and python2.7 but that is not very significant in view of an 8GB image in total.


---

Comment by slelievre created at 2022-01-09 06:05:32

Ticket description misses verb in this sentence:

> After this ticket is merged, we should
> the automatic prebuild using a github app


---

Comment by git created at 2022-01-09 18:17:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-01-11 12:17:47

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-01-11 12:17:47

let's get this in, it seems to work, I can get `./sage` in console there, etc.
`./sage -n` leads to problems, but probably that's not the way it's intendend.


---

Comment by @tobiasdiez created at 2022-01-11 12:21:16

Thanks for the review!


---

Comment by mkoeppe created at 2022-01-11 16:33:46

Replying to [comment:130 dimpase]:
> `./sage -n` leads to problems, but probably that's not the way it's intendend.

There's no web browser in the container, so you can't use `sage -n`.
To use Jupyter notebooks, use the Command Palette to run "Jupyter: Create New Jupyter Notebook", see
https://code.visualstudio.com/docs/datascience/jupyter-notebooks


---

Comment by git created at 2022-01-11 20:47:29

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-01-11 20:47:29

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2022-01-11 20:47:52

Fixes the PDF docbuild


---

Comment by mkoeppe created at 2022-01-11 20:47:52

Changing status from needs_review to positive_review.


---

Comment by git created at 2022-01-12 06:25:32

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-01-12 06:25:32

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-01-12 07:06:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-01-12 07:07:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-01-13 13:21:31

Is it easy to configure launching this (with prebuids) on branches in https://github.com/sagemath/sagetrac-mirror ?


---

Comment by @tobiasdiez created at 2022-01-13 14:31:28

Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds
However, it needs to be done by someone with rights to install apps in the sagemath org.


---

Comment by dimpase created at 2022-01-13 17:40:07

Replying to [comment:139 gh-tobiasdiez]:
> Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds
> However, it needs to be done by someone with rights to install apps in the sagemath org.

I've sent you an invite. I guess I installed their "app", but I don't see how to proceed.
(I think it should be enabled on the branch of this ticket only, before it's merged.)

Did you see my email message about trac access?


---

Comment by @tobiasdiez created at 2022-01-14 11:59:49

Thanks! I've now created a "team" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.

Currently, the creation of the image fails however due to a permission error:

```
 > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
------
.gitpod.Dockerfile:3
--------------------
   1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
   2 |     ARG BASE_TAG=dev
   3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
   4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
   5 |     # Fast doc rebuilds do not work because
--------------------
error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
```

Matthias, can you have a look please?

https://gitpod.io/#prebuild/https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow


---

Comment by dimpase created at 2022-01-14 12:17:24

Replying to [comment:141 gh-tobiasdiez]:
> Thanks! I've now created a "team" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.

my email is shown on my [GitHub](GitHub) account https://github.com/dimpase

Thanks!


---

Comment by mkoeppe created at 2022-01-14 16:20:50

Replying to [comment:141 gh-tobiasdiez]:
> Currently, the creation of the image fails however due to a permission error:
> {{{
>  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
> ------
> .gitpod.Dockerfile:3
> --------------------
>    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
>    2 |     ARG BASE_TAG=dev
>    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
>    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
>    5 |     # Fast doc rebuilds do not work because
> --------------------
> error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
> }}}

I think you need to deposit a secret providing read access similar to what is explained in
https://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry


---

Comment by mkoeppe created at 2022-01-14 18:51:48

... alternatively I suppose we could push the required Docker images to DockerHub -- but I don't have write access there; `@`saraedum, could you deposit an access token for that as a secret here? https://github.com/organizations/sagemath/settings/secrets/actions


---

Comment by @tobiasdiez created at 2022-01-14 20:09:07

Replying to [comment:143 mkoeppe]:
> Replying to [comment:141 gh-tobiasdiez]:
> > Currently, the creation of the image fails however due to a permission error:
> > {{{
> >  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
> > ------
> > .gitpod.Dockerfile:3
> > --------------------
> >    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
> >    2 |     ARG BASE_TAG=dev
> >    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
> >    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
> >    5 |     # Fast doc rebuilds do not work because
> > --------------------
> > error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
> > }}}
> 
> I think you need to deposit a secret providing read access similar to what is explained in
> https://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry

That link is for a self-hosted gitpod and thus does not apply to our situation (we don't have a gitpod config other than what is committed in this branch).

I think the issue is that the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?


---

Comment by mkoeppe created at 2022-01-14 20:12:45

Replying to [comment:146 gh-tobiasdiez]:
> the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?

Because on my testing branch used for the prebuild, I am setting the correct repo:
https://github.com/mkoeppe/sage/blob/mkoeppe-9.5.beta9%2Bupdates/docker/.gitpod.Dockerfile


---

Comment by mkoeppe created at 2022-01-14 20:14:11

(And because every GH workflow automatically has the credentials to access its own GH packages (gchr.io)!)


---

Comment by @tobiasdiez created at 2022-01-14 20:15:32

Ahh okay, I thought this is an environment variable that is picked up somewhere.

So in this case we just have to wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?


---

Comment by mkoeppe created at 2022-01-14 20:20:46

Replying to [comment:149 gh-tobiasdiez]:
> wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?

Yes, on the next release that includes this branch, the Docker image will be pushed (by separate instances of the workflow) both to `gchr.io/sagemath/sage` and to `gchr.io/sagemath/sagetrac-mirror`.

We will then see whether the 403 Forbidden will go away. I think it will not, for workflows run on `github.com/sagemath/sagetrac-mirror`, because it may not have the `read:packages` credential for `gchr.io/sagemath/sage`.


---

Comment by mkoeppe created at 2022-01-16 21:38:47

I think we may need to do this:
https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#configuring-visibility-of-container-images-for-an-organization


---

Comment by mkoeppe created at 2022-01-16 21:44:53

Well, no, all packages are already set to "public": For example https://github.com/orgs/sagemath/packages/container/sage%2Fsage-docker-ubuntu-focal-standard-configured/settings


---

Comment by mkoeppe created at 2022-01-16 21:46:49

But perhaps this is needed: https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#github-actions-access-for-organization-owned-container-images


---

Comment by mkoeppe created at 2022-01-16 21:53:49

No, this makes no sense.


---

Comment by mkoeppe created at 2022-02-11 19:50:49

Changing priority from major to critical.


---

Comment by vbraun created at 2022-02-12 22:04:53

Resolution: fixed
