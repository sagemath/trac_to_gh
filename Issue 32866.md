# Issue 32866: gitpod integration using Docker images from portability testing workflow

archive/issues_032866.json:
```json
{
    "body": "CC:  @tobiasdiez @dimpase @saraedum\n\nBased on #32749.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33103\n\n",
    "created_at": "2022-01-01T19:34:16Z",
    "labels": [
        "docker",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "gitpod integration using Docker images from portability testing workflow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32866",
    "user": "@mkoeppe"
}
```
CC:  @tobiasdiez @dimpase @saraedum

Based on #32749.

Issue created by migration from https://trac.sagemath.org/ticket/33103





---

archive/issue_comments_468677.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2022-01-01T19:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468677",
    "user": "@mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_468678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-01T19:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468678",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-01T20:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468679",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468680.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-01T20:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468680",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468681.json:
```json
{
    "body": "Running into `pyenv` issues (#29285) here too: \n\n```\n[pytest] installing. Log file: /home/gitpod/sage/logs/pkgs/pytest.log\n  [pytest] error installing, exit status 1. End of log file:\n  [pytest]   /home/gitpod/sage-local/var/lib/sage/venv-python3.8/bin/python3: No module named pip\n  [pytest] Full log file: /home/gitpod/sage/logs/pkgs/pytest.log\nmake[4]: *** [Makefile:2756: pytest-no-deps] Error 1\n```\n",
    "created_at": "2022-01-01T21:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468681",
    "user": "@mkoeppe"
}
```

Running into `pyenv` issues (#29285) here too: 

```
[pytest] installing. Log file: /home/gitpod/sage/logs/pkgs/pytest.log
  [pytest] error installing, exit status 1. End of log file:
  [pytest]   /home/gitpod/sage-local/var/lib/sage/venv-python3.8/bin/python3: No module named pip
  [pytest] Full log file: /home/gitpod/sage/logs/pkgs/pytest.log
make[4]: *** [Makefile:2756: pytest-no-deps] Error 1
```




---

archive/issue_comments_468682.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T02:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468682",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468683.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-01-02T02:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468683",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_468684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T02:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468684",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468685.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T05:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468685",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468686.json:
```json
{
    "body": "This works. To be done:\n- Additional tags for the images, for example `latest` for releases, or branch/tag name (`${GITHUB_REF_NAME}` - https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables) -  suitable for `.gitpod.yml`\n- Could use `docker/.gitpod.Dockerfile` again with `COPY --from` to make the final image smaller (currently /home/gitpod/sage has the old source tree)",
    "created_at": "2022-01-02T06:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468686",
    "user": "@mkoeppe"
}
```

This works. To be done:
- Additional tags for the images, for example `latest` for releases, or branch/tag name (`${GITHUB_REF_NAME}` - https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables) -  suitable for `.gitpod.yml`
- Could use `docker/.gitpod.Dockerfile` again with `COPY --from` to make the final image smaller (currently /home/gitpod/sage has the old source tree)



---

archive/issue_comments_468687.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T21:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468687",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468688.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T22:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468688",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468689.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-02T23:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468689",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468690.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T05:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468690",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468691.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-03T05:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468691",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468692.json:
```json
{
    "body": "Also the configuration of VS Code should be improved. It seems to start up using the wrong interpreter (not `venv/bin/python3`), and also one needs to manually select the right Jupyter kernel. \n\nThe scipy folks have some good documentation and configuration (https://scipy.github.io/devdocs/dev/contributor/quickstart_gitpod.html), perhaps we can lift something from there.",
    "created_at": "2022-01-03T07:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468692",
    "user": "@mkoeppe"
}
```

Also the configuration of VS Code should be improved. It seems to start up using the wrong interpreter (not `venv/bin/python3`), and also one needs to manually select the right Jupyter kernel. 

The scipy folks have some good documentation and configuration (https://scipy.github.io/devdocs/dev/contributor/quickstart_gitpod.html), perhaps we can lift something from there.



---

archive/issue_comments_468693.json:
```json
{
    "body": "Is the prebuild working for this branch?\n\nHow can one work with branches that update sage packages? With #32749 one could trigger a rebuild of the docker image (and thus of the system packages) using the `#imagebuild` context. Can something like this also be implemented here? For example, take the github action build docker as base, and then re-install system or python packages on top of this if they have newer versions?\n\nFor the VS integration, #30677 is closed but not yet merged into develop.",
    "created_at": "2022-01-03T12:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468693",
    "user": "@tobiasdiez"
}
```

Is the prebuild working for this branch?

How can one work with branches that update sage packages? With #32749 one could trigger a rebuild of the docker image (and thus of the system packages) using the `#imagebuild` context. Can something like this also be implemented here? For example, take the github action build docker as base, and then re-install system or python packages on top of this if they have newer versions?

For the VS integration, #30677 is closed but not yet merged into develop.



---

archive/issue_comments_468694.json:
```json
{
    "body": "Replying to [comment:32 gh-tobiasdiez]:\n> Is the prebuild working for this branch?\n\nI've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.\n\n> How can one work with branches that update sage packages? \n\nNothing special, `make` just rebuilds what needs rebuilding.",
    "created_at": "2022-01-03T17:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468694",
    "user": "@mkoeppe"
}
```

Replying to [comment:32 gh-tobiasdiez]:
> Is the prebuild working for this branch?

I've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.

> How can one work with branches that update sage packages? 

Nothing special, `make` just rebuilds what needs rebuilding.



---

archive/issue_comments_468695.json:
```json
{
    "body": "Replying to [comment:32 gh-tobiasdiez]:\n> For the VS integration, #30677 is closed but not yet merged into develop.\n\nI forgot to say that the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates already contains #30677 and other updates",
    "created_at": "2022-01-03T17:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468695",
    "user": "@mkoeppe"
}
```

Replying to [comment:32 gh-tobiasdiez]:
> For the VS integration, #30677 is closed but not yet merged into develop.

I forgot to say that the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates already contains #30677 and other updates



---

archive/issue_comments_468696.json:
```json
{
    "body": "Replying to [comment:33 mkoeppe]:\n> Replying to [comment:32 gh-tobiasdiez]:\n> > Is the prebuild working for this branch?\n> \n> I've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.\n> \n> > How can one work with branches that update sage packages? \n> \n> Nothing special, `make` just rebuilds what needs rebuilding.\n\nSo this would then be done as part of the prebuild?",
    "created_at": "2022-01-03T17:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468696",
    "user": "@tobiasdiez"
}
```

Replying to [comment:33 mkoeppe]:
> Replying to [comment:32 gh-tobiasdiez]:
> > Is the prebuild working for this branch?
> 
> I've just merged #33071 into the branch https://github.com/mkoeppe/sage/tree/mkoeppe-9.5.beta9%2Bupdates to try this out.
> 
> > How can one work with branches that update sage packages? 
> 
> Nothing special, `make` just rebuilds what needs rebuilding.

So this would then be done as part of the prebuild?



---

archive/issue_comments_468697.json:
```json
{
    "body": "Yes, I think so",
    "created_at": "2022-01-03T18:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468697",
    "user": "@mkoeppe"
}
```

Yes, I think so



---

archive/issue_comments_468698.json:
```json
{
    "body": "Looks like I'll have to add some configuration so that it does prebuilds on all branches",
    "created_at": "2022-01-03T18:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468698",
    "user": "@mkoeppe"
}
```

Looks like I'll have to add some configuration so that it does prebuilds on all branches



---

archive/issue_comments_468699.json:
```json
{
    "body": "I created a \"project\" and now it looks like the prebuild triggered by a push is running - https://gitpod.io/projects/sage",
    "created_at": "2022-01-03T18:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468699",
    "user": "@mkoeppe"
}
```

I created a "project" and now it looks like the prebuild triggered by a push is running - https://gitpod.io/projects/sage



---

archive/issue_comments_468700.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T18:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468700",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468701.json:
```json
{
    "body": "Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package",
    "created_at": "2022-01-03T18:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468701",
    "user": "@mkoeppe"
}
```

Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package



---

archive/issue_comments_468702.json:
```json
{
    "body": "Replying to [comment:40 mkoeppe]:\n> Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package\n\nThat's very nice!",
    "created_at": "2022-01-03T18:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468702",
    "user": "@tobiasdiez"
}
```

Replying to [comment:40 mkoeppe]:
> Before the push I had merged #32968 with the Sphinx update; and the prebuild has just installed the upgraded package

That's very nice!



---

archive/issue_comments_468703.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T18:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468703",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468704.json:
```json
{
    "body": "The prebuild was just killed because of the 35m timeout. \nWhat's the best choice of timeout according to your experiments?",
    "created_at": "2022-01-03T19:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468704",
    "user": "@mkoeppe"
}
```

The prebuild was just killed because of the 35m timeout. 
What's the best choice of timeout according to your experiments?



---

archive/issue_comments_468705.json:
```json
{
    "body": "If its really the timeout that killed the prebuild (in which the prebuild would be green and be used for the next workspace, but maybe doesn't contain all packages) then you can go to 50min. Maybe a bit less since the docker image is quite big so this part may take some time. But essentially you have to calculate 60min - bootstrap and config (2-3min) - docker init and copying (?? min).\n\nHowever, for me the prebuild often timed out after 1h (then its shown red in the project view). The only solution I've found for this is not using symlinks into /home/.",
    "created_at": "2022-01-03T19:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468705",
    "user": "@tobiasdiez"
}
```

If its really the timeout that killed the prebuild (in which the prebuild would be green and be used for the next workspace, but maybe doesn't contain all packages) then you can go to 50min. Maybe a bit less since the docker image is quite big so this part may take some time. But essentially you have to calculate 60min - bootstrap and config (2-3min) - docker init and copying (?? min).

However, for me the prebuild often timed out after 1h (then its shown red in the project view). The only solution I've found for this is not using symlinks into /home/.



---

archive/issue_comments_468706.json:
```json
{
    "body": "https://gitpod.io/projects/sage/e8780c03-b8b8-4810-a772-d4cc2994b6bf shows\n\n```\n[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log\n  [pytest] successfully installed.\n  [sphinx-4.3.1] successfully installed.\nmake[1]: *** [Makefile:39: all-build] Terminated\nmake: *** [Makefile:16: build] Terminated\nexit\n```\n\n\nbut it is still claims \"RUNNING: Prebuild in progress\"",
    "created_at": "2022-01-03T19:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468706",
    "user": "@mkoeppe"
}
```

https://gitpod.io/projects/sage/e8780c03-b8b8-4810-a772-d4cc2994b6bf shows

```
[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log
  [pytest] successfully installed.
  [sphinx-4.3.1] successfully installed.
make[1]: *** [Makefile:39: all-build] Terminated
make: *** [Makefile:16: build] Terminated
exit
```


but it is still claims "RUNNING: Prebuild in progress"



---

archive/issue_comments_468707.json:
```json
{
    "body": "However, https://gitpod.io/projects/sage/prebuilds shows READY.",
    "created_at": "2022-01-03T19:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468707",
    "user": "@mkoeppe"
}
```

However, https://gitpod.io/projects/sage/prebuilds shows READY.



---

archive/issue_comments_468708.json:
```json
{
    "body": "\n```\n\n\ud83e\udd19 This task ran as a workspace prebuild\n\ud83c\udf89 Well done on saving 37 minutes\n```\n",
    "created_at": "2022-01-03T19:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468708",
    "user": "@mkoeppe"
}
```


```

🤙 This task ran as a workspace prebuild
🎉 Well done on saving 37 minutes
```




---

archive/issue_comments_468709.json:
```json
{
    "body": "A few more points:\n- please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)\n- `--prefix=$HOME/sage-local` in gitpod.yml should probably be `/workspace/sage-local` or a few lines above `$HOME` should be used?\n- probably 8 parallel tasks are fine. gitpod gives 6 (or 7?) vCPUs to users.",
    "created_at": "2022-01-03T19:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468709",
    "user": "@tobiasdiez"
}
```

A few more points:
- please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)
- `--prefix=$HOME/sage-local` in gitpod.yml should probably be `/workspace/sage-local` or a few lines above `$HOME` should be used?
- probably 8 parallel tasks are fine. gitpod gives 6 (or 7?) vCPUs to users.



---

archive/issue_comments_468710.json:
```json
{
    "body": "Replying to [comment:48 mkoeppe]:\n> {{{\n> \n> \ud83e\udd19 This task ran as a workspace prebuild\n> \ud83c\udf89 Well done on saving 37 minutes\n> }}}\n\nNice, then you can go to 50min indeed.",
    "created_at": "2022-01-03T19:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468710",
    "user": "@tobiasdiez"
}
```

Replying to [comment:48 mkoeppe]:
> {{{
> 
> 🤙 This task ran as a workspace prebuild
> 🎉 Well done on saving 37 minutes
> }}}

Nice, then you can go to 50min indeed.



---

archive/issue_comments_468711.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T19:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468711",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468712.json:
```json
{
    "body": "Presumably the `before` script should try to resume the build in case the prebuild timed out.",
    "created_at": "2022-01-03T19:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468712",
    "user": "@mkoeppe"
}
```

Presumably the `before` script should try to resume the build in case the prebuild timed out.



---

archive/issue_comments_468713.json:
```json
{
    "body": "I agree. But `init` is called after `before` during the prebuild, and I couldn't find a way to detect if one is in a prebuild or not...",
    "created_at": "2022-01-03T19:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468713",
    "user": "@tobiasdiez"
}
```

I agree. But `init` is called after `before` during the prebuild, and I couldn't find a way to detect if one is in a prebuild or not...



---

archive/issue_comments_468714.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T19:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468714",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468715.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T19:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468715",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468716.json:
```json
{
    "body": "Replying to [comment:49 gh-tobiasdiez]:\n> - please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)\n\nI've updated it - the ssh stuff was already same",
    "created_at": "2022-01-03T19:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468716",
    "user": "@mkoeppe"
}
```

Replying to [comment:49 gh-tobiasdiez]:
> - please use the recent version of gitpod.yml from https://github.com/tobiasdiez/sagetrac-mirror/blob/develop/.gitpod.yml (the ssh stuff and num threads = 8)

I've updated it - the ssh stuff was already same



---

archive/issue_comments_468717.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T20:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468717",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468718.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-03T20:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468718",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468719.json:
```json
{
    "body": "https://gitpod.io/projects/sage/134676a9-2a0e-429a-816d-68ad30441f58\n\n```\n[sphinx-4.3.1] installing. Log file: /workspace/sage/logs/pkgs/sphinx-4.3.1.log\n[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log\n  [pytest] successfully installed.\n  [sphinx-4.3.1] successfully installed.\n  [sagelib-9.5.beta9] successfully installed.\nmake --no-print-directory sage_docbuild-SAGE_VENV-no-deps\n[sage_docbuild-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sage_docbuild-9.5.beta9.log\n  [sage_docbuild-9.5.beta9] successfully installed.\nmake[2]: Leaving directory '/workspace/sage/build/make'\n\nreal    31m8.684s\nuser    101m44.392s\nsys     3m47.093s\nSAGE_CHECK=warn, so scanning the log files. This may take a few seconds.\nSage build/upgrade complete!\nmake[1]: Leaving directory '/workspace/sage'\nexit\n\n\ud83e\udd19 This task ran as a workspace prebuild\n\ud83c\udf89 Well done on saving 34 minutes\n```\n",
    "created_at": "2022-01-03T20:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468719",
    "user": "@mkoeppe"
}
```

https://gitpod.io/projects/sage/134676a9-2a0e-429a-816d-68ad30441f58

```
[sphinx-4.3.1] installing. Log file: /workspace/sage/logs/pkgs/sphinx-4.3.1.log
[sagelib-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sagelib-9.5.beta9.log
  [pytest] successfully installed.
  [sphinx-4.3.1] successfully installed.
  [sagelib-9.5.beta9] successfully installed.
make --no-print-directory sage_docbuild-SAGE_VENV-no-deps
[sage_docbuild-9.5.beta9] installing. Log file: /workspace/sage/logs/pkgs/sage_docbuild-9.5.beta9.log
  [sage_docbuild-9.5.beta9] successfully installed.
make[2]: Leaving directory '/workspace/sage/build/make'

real    31m8.684s
user    101m44.392s
sys     3m47.093s
SAGE_CHECK=warn, so scanning the log files. This may take a few seconds.
Sage build/upgrade complete!
make[1]: Leaving directory '/workspace/sage'
exit

🤙 This task ran as a workspace prebuild
🎉 Well done on saving 34 minutes
```




---

archive/issue_comments_468720.json:
```json
{
    "body": "Replying to [comment:54 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[fdb332d](https://git.sagemath.org/sage.git/commit/?id=fdb332d2a52db9f63fc54960d029a5ad9c529a61)||`.gitpod.yml: Run 'make' again in 'before' task if prebuild 'make' timed out`||\n\nThis worked but for some reason the Sphinx package installation was repeated in this step. It's fast but I'll try if refreshing the timestamps of the install records will avoid it.",
    "created_at": "2022-01-03T22:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468720",
    "user": "@mkoeppe"
}
```

Replying to [comment:54 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[fdb332d](https://git.sagemath.org/sage.git/commit/?id=fdb332d2a52db9f63fc54960d029a5ad9c529a61)||`.gitpod.yml: Run 'make' again in 'before' task if prebuild 'make' timed out`||

This worked but for some reason the Sphinx package installation was repeated in this step. It's fast but I'll try if refreshing the timestamps of the install records will avoid it.



---

archive/issue_comments_468721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T00:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468721",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468722.json:
```json
{
    "body": "There are some weird synchronization issues on the server side - it seems that if one creates a workspace right after a prebuild has completed, it can happen that it does not use the prebuild.",
    "created_at": "2022-01-04T01:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468722",
    "user": "@mkoeppe"
}
```

There are some weird synchronization issues on the server side - it seems that if one creates a workspace right after a prebuild has completed, it can happen that it does not use the prebuild.



---

archive/issue_comments_468723.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T01:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468723",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468724.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T01:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468724",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468725.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T06:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468725",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468726.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T07:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468726",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T08:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468727",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468728.json:
```json
{
    "body": "OK, now it's in good shape.\n\nCould you check that the SSH stuff works as intended and matches the added documentation?\nI see\n\n```\n$ ls -l ~/.ssh\ntotal 24\n-rw-r--r-- 1 gitpod gitpod   381 Jan  4 08:53 authorized_keys\n-rw------- 1 gitpod gitpod     0 Jan  4 08:53 id_rsa\n-rw-r--r-- 1 gitpod gitpod   664 Jan  4 08:53 known_hosts\n-rw-r--r-- 1 gitpod gitpod 15544 Jan  4 08:53 supervisor_env\n```\n\nand am not sure what the empty `id_rsa` is intended for",
    "created_at": "2022-01-04T09:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468728",
    "user": "@mkoeppe"
}
```

OK, now it's in good shape.

Could you check that the SSH stuff works as intended and matches the added documentation?
I see

```
$ ls -l ~/.ssh
total 24
-rw-r--r-- 1 gitpod gitpod   381 Jan  4 08:53 authorized_keys
-rw------- 1 gitpod gitpod     0 Jan  4 08:53 id_rsa
-rw-r--r-- 1 gitpod gitpod   664 Jan  4 08:53 known_hosts
-rw-r--r-- 1 gitpod gitpod 15544 Jan  4 08:53 supervisor_env
```

and am not sure what the empty `id_rsa` is intended for



---

archive/issue_comments_468729.json:
```json
{
    "body": "https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR27\n\nThere you don't need/want the timeout.",
    "created_at": "2022-01-04T12:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468729",
    "user": "@tobiasdiez"
}
```

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR27

There you don't need/want the timeout.



---

archive/issue_comments_468730.json:
```json
{
    "body": "https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR17\n\nI'm not sure if I understand the logic behind this and related commands (maybe add a bit more documentation of what's going on?). But please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror (which is probably what's going to happen if you want to check someone elses branch)",
    "created_at": "2022-01-04T12:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468730",
    "user": "@tobiasdiez"
}
```

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-370a022e48cb18faf98122794ffc5ce775b2606b09a9d1f80b71333425ec078eR17

I'm not sure if I understand the logic behind this and related commands (maybe add a bit more documentation of what's going on?). But please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror (which is probably what's going to happen if you want to check someone elses branch)



---

archive/issue_comments_468731.json:
```json
{
    "body": "Replying to [comment:68 mkoeppe]:\n> Could you check that the SSH stuff works as intended and matches the added documentation?\n> and am not sure what the empty `id_rsa` is intended for\n\nDid you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.",
    "created_at": "2022-01-04T12:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468731",
    "user": "@tobiasdiez"
}
```

Replying to [comment:68 mkoeppe]:
> Could you check that the SSH stuff works as intended and matches the added documentation?
> and am not sure what the empty `id_rsa` is intended for

Did you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.



---

archive/issue_comments_468732.json:
```json
{
    "body": "Replying to [comment:68 mkoeppe]:\n> OK, now it's in good shape.\n\nFor me it takes over 5min to start a workspace due to the large workspace image (it displays \"fetching build image\" or something like this in the loading screen). I think this should be optimized as part of this ticket since otherwise I fear people will not adopt gitpod for e.g. reviewing of tickets.\n\nAlso it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.",
    "created_at": "2022-01-04T12:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468732",
    "user": "@tobiasdiez"
}
```

Replying to [comment:68 mkoeppe]:
> OK, now it's in good shape.

For me it takes over 5min to start a workspace due to the large workspace image (it displays "fetching build image" or something like this in the loading screen). I think this should be optimized as part of this ticket since otherwise I fear people will not adopt gitpod for e.g. reviewing of tickets.

Also it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.



---

archive/issue_comments_468733.json:
```json
{
    "body": "https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442\n\nIs the somewhat strange indention by design?",
    "created_at": "2022-01-04T12:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468733",
    "user": "@tobiasdiez"
}
```

https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442

Is the somewhat strange indention by design?



---

archive/issue_comments_468734.json:
```json
{
    "body": "Replying to [comment:72 gh-tobiasdiez]:\n> Also it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.\n\nIt no longer breaks the Sage build since #29285, but I'll add it anyway",
    "created_at": "2022-01-04T13:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468734",
    "user": "@mkoeppe"
}
```

Replying to [comment:72 gh-tobiasdiez]:
> Also it still loads `pyenv`: `pyenv shell 3.8.12` so https://github.com/tobiasdiez/sagetrac-mirror/blob/20ca179bed4ff605de4111362b02c8e2acca617e/.gitpod.yml#L18-L19 should probably be readded.

It no longer breaks the Sage build since #29285, but I'll add it anyway



---

archive/issue_comments_468735.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T13:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468735",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468736.json:
```json
{
    "body": "Replying to [comment:73 gh-tobiasdiez]:\n> https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442\n> \n> Is the somewhat strange indention by design?\n\nThe link does not show a particular line -- what are you referring to?",
    "created_at": "2022-01-04T13:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468736",
    "user": "@mkoeppe"
}
```

Replying to [comment:73 gh-tobiasdiez]:
> https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442
> 
> Is the somewhat strange indention by design?

The link does not show a particular line -- what are you referring to?



---

archive/issue_comments_468737.json:
```json
{
    "body": "Replying to [comment:70 gh-tobiasdiez]:\n>  please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror \n\nThanks, done.",
    "created_at": "2022-01-04T13:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468737",
    "user": "@mkoeppe"
}
```

Replying to [comment:70 gh-tobiasdiez]:
>  please be aware that the code may be in a different location such as `/workspace/sagetrac-mirror` if someone starts gitpod from https://github.com/sagemath/sagetrac-mirror 

Thanks, done.



---

archive/issue_comments_468738.json:
```json
{
    "body": "Replying to [comment:71 gh-tobiasdiez]:\n> Replying to [comment:68 mkoeppe]:\n> > Could you check that the SSH stuff works as intended and matches the added documentation?\n> > and am not sure what the empty `id_rsa` is intended for\n> \n> Did you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.\n\nThanks for checking - I had missed a step.",
    "created_at": "2022-01-04T13:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468738",
    "user": "@mkoeppe"
}
```

Replying to [comment:71 gh-tobiasdiez]:
> Replying to [comment:68 mkoeppe]:
> > Could you check that the SSH stuff works as intended and matches the added documentation?
> > and am not sure what the empty `id_rsa` is intended for
> 
> Did you added a `PRIVATE_SSH_KEY` env variable in gitpod with your trac ssh as described in the docs? It's working for me.

Thanks for checking - I had missed a step.



---

archive/issue_comments_468739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T13:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468739",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468740.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T13:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468740",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468741.json:
```json
{
    "body": "Replying to [comment:76 mkoeppe]:\n> Replying to [comment:73 gh-tobiasdiez]:\n> > https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442\n> > \n> > Is the somewhat strange indention by design?\n> \n> The link does not show a particular line -- what are you referring to?\n\nStrange, normally that works. It's the gitpod related changes in `tox.ini` (l. 438)",
    "created_at": "2022-01-04T17:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468741",
    "user": "@tobiasdiez"
}
```

Replying to [comment:76 mkoeppe]:
> Replying to [comment:73 gh-tobiasdiez]:
> > https://github.com/sagemath/sagetrac-mirror/compare/develop...u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow#diff-ef2cef9f88b4fe09ca3082140e67f5ad34fb65fb6e228f119d3812261ae51449R438-R442
> > 
> > Is the somewhat strange indention by design?
> 
> The link does not show a particular line -- what are you referring to?

Strange, normally that works. It's the gitpod related changes in `tox.ini` (l. 438)



---

archive/issue_comments_468742.json:
```json
{
    "body": "Replying to [comment:81 gh-tobiasdiez]:\n> Replying to [comment:76 mkoeppe]:\n> > Replying to [comment:73 gh-tobiasdiez]:\n> > > Is the somewhat strange indention by design?\n> \n> the gitpod related changes in `tox.ini` (l. 438)\n\nIt is indented as intended. This file aspires to be a spreadsheet.",
    "created_at": "2022-01-04T17:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468742",
    "user": "@mkoeppe"
}
```

Replying to [comment:81 gh-tobiasdiez]:
> Replying to [comment:76 mkoeppe]:
> > Replying to [comment:73 gh-tobiasdiez]:
> > > Is the somewhat strange indention by design?
> 
> the gitpod related changes in `tox.ini` (l. 438)

It is indented as intended. This file aspires to be a spreadsheet.



---

archive/issue_comments_468743.json:
```json
{
    "body": "There are still some minor details wrong. In `logs/sphinx-4.3.1.log`:\n\n```\nUninstalling existing 'sphinx'\nWarning: File '/home/gitpod/sage-local/var/lib/sage/wheels/Sphinx-4.2.0-py3-none-any.whl' not found\nWarning: Directory '/home/gitpod/sage-local/var/lib/sage/wheels' not found\nRunning pip-uninstall script for 'sphinx'\n/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/scripts/sphinx/spkg-piprm: line 14: /home/gitpod/sage/build/bin/sage-dist-helpers: No such file or directory\nError: failed to source /home/gitpod/sage/build/bin/sage-dist-helpers\nIs /home/gitpod/sage the correct SAGE_ROOT?\nWarning: Error running the pip-uninstall script for 'sphinx'; uninstallation may have left behind some files\nRemoving stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'\n```\n",
    "created_at": "2022-01-04T19:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468743",
    "user": "@mkoeppe"
}
```

There are still some minor details wrong. In `logs/sphinx-4.3.1.log`:

```
Uninstalling existing 'sphinx'
Warning: File '/home/gitpod/sage-local/var/lib/sage/wheels/Sphinx-4.2.0-py3-none-any.whl' not found
Warning: Directory '/home/gitpod/sage-local/var/lib/sage/wheels' not found
Running pip-uninstall script for 'sphinx'
/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/scripts/sphinx/spkg-piprm: line 14: /home/gitpod/sage/build/bin/sage-dist-helpers: No such file or directory
Error: failed to source /home/gitpod/sage/build/bin/sage-dist-helpers
Is /home/gitpod/sage the correct SAGE_ROOT?
Warning: Error running the pip-uninstall script for 'sphinx'; uninstallation may have left behind some files
Removing stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'
```




---

archive/issue_comments_468744.json:
```json
{
    "body": "Package-removal scripts (`{prefix,venv}/var/lib/sage/scripts/*/spkg-piprm`) hardcode the `SAGE_ROOT` and `SAGE_SRC` from the time when the package was installed (the Docker-build phase); so I will also put a symlink in place for that.",
    "created_at": "2022-01-04T19:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468744",
    "user": "@mkoeppe"
}
```

Package-removal scripts (`{prefix,venv}/var/lib/sage/scripts/*/spkg-piprm`) hardcode the `SAGE_ROOT` and `SAGE_SRC` from the time when the package was installed (the Docker-build phase); so I will also put a symlink in place for that.



---

archive/issue_comments_468745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-04T19:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468745",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468746.json:
```json
{
    "body": "Fixed now, `logs/sphinx-4.3.1.log` now shows:\n\n```\nFound existing installation: Sphinx 4.2.0\nUninstalling Sphinx-4.2.0:\n  Successfully uninstalled Sphinx-4.2.0\nRemoving stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'\nInstalling sphinx-4.3.1\n```\n\nand also `venv/var/lib/sage/wheels/` now only contains one sphinx wheel.",
    "created_at": "2022-01-04T21:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468746",
    "user": "@mkoeppe"
}
```

Fixed now, `logs/sphinx-4.3.1.log` now shows:

```
Found existing installation: Sphinx 4.2.0
Uninstalling Sphinx-4.2.0:
  Successfully uninstalled Sphinx-4.2.0
Removing stamp file '/home/gitpod/sage-local/var/lib/sage/venv-python3.8/var/lib/sage/installed/sphinx-4.2.0'
Installing sphinx-4.3.1
```

and also `venv/var/lib/sage/wheels/` now only contains one sphinx wheel.



---

archive/issue_comments_468747.json:
```json
{
    "body": "Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there",
    "created_at": "2022-01-04T22:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468747",
    "user": "@mkoeppe"
}
```

Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there



---

archive/issue_comments_468748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-05T03:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468748",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468749.json:
```json
{
    "body": "Now it starts with the right interpreter, and also \"Jupyter: Create New Jupyter Notebook\" works - \"Select Kernel\" offers the Sage kernel.",
    "created_at": "2022-01-05T05:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468749",
    "user": "@mkoeppe"
}
```

Now it starts with the right interpreter, and also "Jupyter: Create New Jupyter Notebook" works - "Select Kernel" offers the Sage kernel.



---

archive/issue_comments_468750.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-05T12:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468750",
    "user": "@tobiasdiez"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_468751.json:
```json
{
    "body": "It still takes over 8min until the workspace is loaded for me due to \"Pulling container image\". This should really optimized as part of this ticket. \n\nAlso pyenv shell still seems to be activated, I think it needs to be disabled in before and init.",
    "created_at": "2022-01-05T12:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468751",
    "user": "@tobiasdiez"
}
```

It still takes over 8min until the workspace is loaded for me due to "Pulling container image". This should really optimized as part of this ticket. 

Also pyenv shell still seems to be activated, I think it needs to be disabled in before and init.



---

archive/issue_comments_468752.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-05T16:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468752",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468753.json:
```json
{
    "body": "Ready now in https://github.com/mkoeppe?tab=packages&q=gitpod",
    "created_at": "2022-01-05T17:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468753",
    "user": "@mkoeppe"
}
```

Ready now in https://github.com/mkoeppe?tab=packages&q=gitpod



---

archive/issue_comments_468754.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-05T19:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468754",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468755.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-05T19:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468755",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468756.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-05T19:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468756",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_468757.json:
```json
{
    "body": "That sadly doesn't solve the issue for me. Starting a workspace still takes 8+ mins, while #32749 takes about 2mins.\n\nIt also seems that the workspace image is quite large at around 16GB. In particular, the sage folder contains\n\n``` \n4.9G    local\n6.2G    src\n```\n\n\nI'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):\n\n```\n1.8G    ./local/share/doc\n4.3G    ./src/build\n```\n\n\nMoreover,\n\n```\n3.0G    /usr\n3.3G    /home\n```\n\n\nis also bigger than the one from the other image of #32749\n\n```\n2.2G    /usr\n2.3G    /home\n```\n\n\nSo I suggest to use gitpod/workspace-base as a base.",
    "created_at": "2022-01-06T12:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468757",
    "user": "@tobiasdiez"
}
```

That sadly doesn't solve the issue for me. Starting a workspace still takes 8+ mins, while #32749 takes about 2mins.

It also seems that the workspace image is quite large at around 16GB. In particular, the sage folder contains

``` 
4.9G    local
6.2G    src
```


I'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):

```
1.8G    ./local/share/doc
4.3G    ./src/build
```


Moreover,

```
3.0G    /usr
3.3G    /home
```


is also bigger than the one from the other image of #32749

```
2.2G    /usr
2.3G    /home
```


So I suggest to use gitpod/workspace-base as a base.



---

archive/issue_comments_468758.json:
```json
{
    "body": "Replying to [comment:99 gh-tobiasdiez]:\n> Starting a workspace still takes 8+ mins\n\nProbably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance",
    "created_at": "2022-01-06T17:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468758",
    "user": "@mkoeppe"
}
```

Replying to [comment:99 gh-tobiasdiez]:
> Starting a workspace still takes 8+ mins

Probably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance



---

archive/issue_comments_468759.json:
```json
{
    "body": "Replying to [comment:99 gh-tobiasdiez]:\n> I'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):\n> {{{\n> 1.8G    ./local/share/doc\n> 4.3G    ./src/build\n> }}}\n\nI'll check if we can delete them without sacrificing fast rebuilds of documentation (`make doc-html`) and sagelib (`./sage -b`). \n\nFor documentation, I see\n\n```\n[sagemath_doc_html-none] make doc-inventory--reference-references\n[sagemath_doc_html-none] cd /workspace/sage && ./sage --docbuild --no-pdf-links reference/references inventory \n[sagemath_doc_html-none] [reference] loading pickled environment... failed\n[sagemath_doc_html-none] [reference] failed: source directory has changed\n```\n\n... so something is not ideal there anyway",
    "created_at": "2022-01-06T17:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468759",
    "user": "@mkoeppe"
}
```

Replying to [comment:99 gh-tobiasdiez]:
> I'm not sure if the following folders are really necessary or if they can be deleted (latest at the end of the prebuild):
> {{{
> 1.8G    ./local/share/doc
> 4.3G    ./src/build
> }}}

I'll check if we can delete them without sacrificing fast rebuilds of documentation (`make doc-html`) and sagelib (`./sage -b`). 

For documentation, I see

```
[sagemath_doc_html-none] make doc-inventory--reference-references
[sagemath_doc_html-none] cd /workspace/sage && ./sage --docbuild --no-pdf-links reference/references inventory 
[sagemath_doc_html-none] [reference] loading pickled environment... failed
[sagemath_doc_html-none] [reference] failed: source directory has changed
```

... so something is not ideal there anyway



---

archive/issue_comments_468760.json:
```json
{
    "body": "Replying to [comment:100 mkoeppe]:\n> Replying to [comment:99 gh-tobiasdiez]:\n> > Starting a workspace still takes 8+ mins\n> \n> Probably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance\n\nApparently, images are built in the US and then downloaded every time from there without caching. This explains why it takes so much longer for me. Gitpod is working on a solution https://github.com/gitpod-io/gitpod/issues/7002 and https://github.com/gitpod-io/gitpod/issues/6145. But having a 15GB+ image is not ideal anyway.",
    "created_at": "2022-01-06T17:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468760",
    "user": "@tobiasdiez"
}
```

Replying to [comment:100 mkoeppe]:
> Replying to [comment:99 gh-tobiasdiez]:
> > Starting a workspace still takes 8+ mins
> 
> Probably depends on the data center region. I just timed it here, it took < 3.5 minutes; but there is considerable variance

Apparently, images are built in the US and then downloaded every time from there without caching. This explains why it takes so much longer for me. Gitpod is working on a solution https://github.com/gitpod-io/gitpod/issues/7002 and https://github.com/gitpod-io/gitpod/issues/6145. But having a 15GB+ image is not ideal anyway.



---

archive/issue_comments_468761.json:
```json
{
    "body": "top-level `Makefile` has targets `micro_release`, `fast-rebuild-clean` that do related stuff.",
    "created_at": "2022-01-06T18:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468761",
    "user": "@mkoeppe"
}
```

top-level `Makefile` has targets `micro_release`, `fast-rebuild-clean` that do related stuff.



---

archive/issue_comments_468762.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-06T19:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468762",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468763.json:
```json
{
    "body": "Replying to [comment:99 gh-tobiasdiez]:\n> {{{\n> 3.0G    /usr\n> 3.3G    /home\n> }}}\n> \n> is also bigger than the one from the other image of #32749\n> {{{\n> 2.2G    /usr\n> 2.3G    /home\n> }}}\n> \n> So I suggest to use gitpod/workspace-base as a base.\n\nBuilding a new image at https://github.com/mkoeppe/sage/runs/4731195747",
    "created_at": "2022-01-06T19:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468763",
    "user": "@mkoeppe"
}
```

Replying to [comment:99 gh-tobiasdiez]:
> {{{
> 3.0G    /usr
> 3.3G    /home
> }}}
> 
> is also bigger than the one from the other image of #32749
> {{{
> 2.2G    /usr
> 2.3G    /home
> }}}
> 
> So I suggest to use gitpod/workspace-base as a base.

Building a new image at https://github.com/mkoeppe/sage/runs/4731195747



---

archive/issue_comments_468764.json:
```json
{
    "body": "\n```\nfast-rebuild-clean: misc-clean\n\trm -rf upstream/\n\trm -rf build/pkgs/sagelib/src/build/temp.*\n\t# The .py files in src/build are restored from src/sage without their\n\t# mtimes changed.\n\t-find build/pkgs/sagelib/src/build -name '*.py' -exec rm \\{\\} \\;\n\t# Remove leftovers from ancient branches\n\trm -rf src/build\n```\n\nThis is not compatible with `configure --enable-editable`, which uses `src/build/` instead of `build/pkgs/sagelib/src/build/`.",
    "created_at": "2022-01-06T19:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468764",
    "user": "@mkoeppe"
}
```


```
fast-rebuild-clean: misc-clean
	rm -rf upstream/
	rm -rf build/pkgs/sagelib/src/build/temp.*
	# The .py files in src/build are restored from src/sage without their
	# mtimes changed.
	-find build/pkgs/sagelib/src/build -name '*.py' -exec rm \{\} \;
	# Remove leftovers from ancient branches
	rm -rf src/build
```

This is not compatible with `configure --enable-editable`, which uses `src/build/` instead of `build/pkgs/sagelib/src/build/`.



---

archive/issue_comments_468765.json:
```json
{
    "body": "Why does the editable install actually needs `src/build` or even copies something there? The compiled cython code (.so files) are placed next to the cython file.",
    "created_at": "2022-01-06T20:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468765",
    "user": "@tobiasdiez"
}
```

Why does the editable install actually needs `src/build` or even copies something there? The compiled cython code (.so files) are placed next to the cython file.



---

archive/issue_comments_468766.json:
```json
{
    "body": "I think that's just standard `setuptools` behavior",
    "created_at": "2022-01-06T21:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468766",
    "user": "@mkoeppe"
}
```

I think that's just standard `setuptools` behavior



---

archive/issue_comments_468767.json:
```json
{
    "body": "The `setuptools` option `--build-temp` could be used to put the temp directories outside of `/workspace`.\n\nOr we could just unconditionally remove the temp directory at the end of `build/pkgs/sagelib/spkg-install`.",
    "created_at": "2022-01-06T22:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468767",
    "user": "@mkoeppe"
}
```

The `setuptools` option `--build-temp` could be used to put the temp directories outside of `/workspace`.

Or we could just unconditionally remove the temp directory at the end of `build/pkgs/sagelib/spkg-install`.



---

archive/issue_comments_468768.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-06T23:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468768",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468769.json:
```json
{
    "body": "It's much smaller now\n\n```\ngitpod /workspace/sage (mkoeppe-9.5.beta9+updates) $ du -sh src local /usr /home\n3.1G    src\n3.9G    local\n2.4G    /usr\n76K     /home\n```\n\nand rebuilds are still fast",
    "created_at": "2022-01-07T07:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468769",
    "user": "@mkoeppe"
}
```

It's much smaller now

```
gitpod /workspace/sage (mkoeppe-9.5.beta9+updates) $ du -sh src local /usr /home
3.1G    src
3.9G    local
2.4G    /usr
76K     /home
```

and rebuilds are still fast



---

archive/issue_comments_468770.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-07T07:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468770",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468771.json:
```json
{
    "body": "Thanks, its way better now (around 4-5min). I would say the doc folder can still be removed. If someone is working on the docs, then one can easily only create the relevant file without the need to build the whole docs.",
    "created_at": "2022-01-07T12:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468771",
    "user": "@tobiasdiez"
}
```

Thanks, its way better now (around 4-5min). I would say the doc folder can still be removed. If someone is working on the docs, then one can easily only create the relevant file without the need to build the whole docs.



---

archive/issue_comments_468772.json:
```json
{
    "body": "The following folders should be deleted as well\n\n```\n212M    /tmp\n32M     /var/lib/apt/lists (remove as part of the apt-get install command)\n```\n\n\nA few packages that I think are not used by the built script or needed in general:\n\n```\n3722    python2.7-minimal\n9370    libflint-dev\n10026   pari-gp (and other pari-related stuff)\n13215   ecl\n14279   libsingular4-dev (and other singular-related stuff)\n19531   libgiac0 (and other giac-related stuff)\n30765   vim-runtime\n41291   emacs-nox\n66816   emacs-common\n330712  libgl1-mesa-dri (?)\n```\n\nI would suggest to exclude them from the installation / uninstall them, similar to what is done in #32749. \n\nTogether that should give another 1GB.",
    "created_at": "2022-01-07T16:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468772",
    "user": "@tobiasdiez"
}
```

The following folders should be deleted as well

```
212M    /tmp
32M     /var/lib/apt/lists (remove as part of the apt-get install command)
```


A few packages that I think are not used by the built script or needed in general:

```
3722    python2.7-minimal
9370    libflint-dev
10026   pari-gp (and other pari-related stuff)
13215   ecl
14279   libsingular4-dev (and other singular-related stuff)
19531   libgiac0 (and other giac-related stuff)
30765   vim-runtime
41291   emacs-nox
66816   emacs-common
330712  libgl1-mesa-dri (?)
```

I would suggest to exclude them from the installation / uninstall them, similar to what is done in #32749. 

Together that should give another 1GB.



---

archive/issue_comments_468773.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-07T18:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468773",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468774.json:
```json
{
    "body": "New image building at https://github.com/mkoeppe/sage/runs/4742213151",
    "created_at": "2022-01-07T18:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468774",
    "user": "@mkoeppe"
}
```

New image building at https://github.com/mkoeppe/sage/runs/4742213151



---

archive/issue_comments_468775.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-07T18:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468775",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468776.json:
```json
{
    "body": "For the record, that's how gitpod is cleaning up the package installation cache/log: https://github.com/gitpod-io/workspace-images/blob/master/base/install-packages#L32-L36",
    "created_at": "2022-01-07T20:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468776",
    "user": "@tobiasdiez"
}
```

For the record, that's how gitpod is cleaning up the package installation cache/log: https://github.com/gitpod-io/workspace-images/blob/master/base/install-packages#L32-L36



---

archive/issue_comments_468777.json:
```json
{
    "body": "Replying to [comment:116 mkoeppe]:\n> New image building at https://github.com/mkoeppe/sage/runs/4742213151\n\nThanks! Will try it once its finished.",
    "created_at": "2022-01-07T20:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468777",
    "user": "@tobiasdiez"
}
```

Replying to [comment:116 mkoeppe]:
> New image building at https://github.com/mkoeppe/sage/runs/4742213151

Thanks! Will try it once its finished.



---

archive/issue_comments_468778.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-07T20:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468778",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468779.json:
```json
{
    "body": "\n```\n$ du -sh src local /usr /home /tmp /var/tmp\n3.1G    src\n3.1G    local\n2.0G    /usr\n36K     /home\n31M     /tmp\n0       /var/tmp\n```\n",
    "created_at": "2022-01-08T06:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468779",
    "user": "@mkoeppe"
}
```


```
$ du -sh src local /usr /home /tmp /var/tmp
3.1G    src
3.1G    local
2.0G    /usr
36K     /home
31M     /tmp
0       /var/tmp
```




---

archive/issue_comments_468780.json:
```json
{
    "body": "I don't think it's necessary to remove packages such as `emacs` that come with `gitpod/workspace-base`.",
    "created_at": "2022-01-08T06:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468780",
    "user": "@mkoeppe"
}
```

I don't think it's necessary to remove packages such as `emacs` that come with `gitpod/workspace-base`.



---

archive/issue_comments_468781.json:
```json
{
    "body": "Replying to [comment:88 mkoeppe]:\n> Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there\n\nToo bad, this no longer works with the smaller base image because it does not have docker. \n\nAnd `sudo apt-get install docker.io` is not sufficient to fix it:\n\n```\n$ docker run -it ubuntu:bionic bash\n[...]\ndocker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.\nERRO[0008] error waiting for container: context canceled \n\n$ sudo docker run -it ubuntu:bionic bash\ndocker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.\nERRO[0001] error waiting for container: context canceled \n```\n",
    "created_at": "2022-01-08T07:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468781",
    "user": "@mkoeppe"
}
```

Replying to [comment:88 mkoeppe]:
> Nice, also docker-in-docker works in the gitpod, so I can run commands such as `tox -e docker-ubuntu-bionic-minimal -- config.status` there

Too bad, this no longer works with the smaller base image because it does not have docker. 

And `sudo apt-get install docker.io` is not sufficient to fix it:

```
$ docker run -it ubuntu:bionic bash
[...]
docker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.
ERRO[0008] error waiting for container: context canceled 

$ sudo docker run -it ubuntu:bionic bash
docker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: error adding seccomp filter rule for syscall clone3: permission denied: unknown.
ERRO[0001] error waiting for container: context canceled 
```




---

archive/issue_comments_468782.json:
```json
{
    "body": "Thanks, this seems to work reasonable well for me (still 4 mins, but well...).\n\nOne could still shave off 250mb by uninstalling emacs-nox, vim and python2.7 but that is not very significant in view of an 8GB image in total.",
    "created_at": "2022-01-08T20:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468782",
    "user": "@tobiasdiez"
}
```

Thanks, this seems to work reasonable well for me (still 4 mins, but well...).

One could still shave off 250mb by uninstalling emacs-nox, vim and python2.7 but that is not very significant in view of an 8GB image in total.



---

archive/issue_comments_468783.json:
```json
{
    "body": "Ticket description misses verb in this sentence:\n\n> After this ticket is merged, we should\n> the automatic prebuild using a github app",
    "created_at": "2022-01-09T06:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468783",
    "user": "@slel"
}
```

Ticket description misses verb in this sentence:

> After this ticket is merged, we should
> the automatic prebuild using a github app



---

archive/issue_comments_468784.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-09T18:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468784",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468785.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-11T12:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468785",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468786.json:
```json
{
    "body": "let's get this in, it seems to work, I can get `./sage` in console there, etc.\n`./sage -n` leads to problems, but probably that's not the way it's intendend.",
    "created_at": "2022-01-11T12:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468786",
    "user": "@dimpase"
}
```

let's get this in, it seems to work, I can get `./sage` in console there, etc.
`./sage -n` leads to problems, but probably that's not the way it's intendend.



---

archive/issue_comments_468787.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2022-01-11T12:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468787",
    "user": "@tobiasdiez"
}
```

Thanks for the review!



---

archive/issue_comments_468788.json:
```json
{
    "body": "Replying to [comment:130 dimpase]:\n> `./sage -n` leads to problems, but probably that's not the way it's intendend.\n\nThere's no web browser in the container, so you can't use `sage -n`.\nTo use Jupyter notebooks, use the Command Palette to run \"Jupyter: Create New Jupyter Notebook\", see\nhttps://code.visualstudio.com/docs/datascience/jupyter-notebooks",
    "created_at": "2022-01-11T16:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468788",
    "user": "@mkoeppe"
}
```

Replying to [comment:130 dimpase]:
> `./sage -n` leads to problems, but probably that's not the way it's intendend.

There's no web browser in the container, so you can't use `sage -n`.
To use Jupyter notebooks, use the Command Palette to run "Jupyter: Create New Jupyter Notebook", see
https://code.visualstudio.com/docs/datascience/jupyter-notebooks



---

archive/issue_comments_468789.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-01-11T20:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468789",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_468790.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-01-11T20:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468790",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_468791.json:
```json
{
    "body": "Fixes the PDF docbuild",
    "created_at": "2022-01-11T20:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468791",
    "user": "@mkoeppe"
}
```

Fixes the PDF docbuild



---

archive/issue_comments_468792.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-11T20:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468792",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468793.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-01-12T06:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468793",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_468794.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-01-12T06:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468794",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_468795.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-12T07:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468795",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_468796.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-12T07:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468796",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468797.json:
```json
{
    "body": "Is it easy to configure launching this (with prebuids) on branches in https://github.com/sagemath/sagetrac-mirror ?",
    "created_at": "2022-01-13T13:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468797",
    "user": "@dimpase"
}
```

Is it easy to configure launching this (with prebuids) on branches in https://github.com/sagemath/sagetrac-mirror ?



---

archive/issue_comments_468798.json:
```json
{
    "body": "Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds\nHowever, it needs to be done by someone with rights to install apps in the sagemath org.",
    "created_at": "2022-01-13T14:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468798",
    "user": "@tobiasdiez"
}
```

Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds
However, it needs to be done by someone with rights to install apps in the sagemath org.



---

archive/issue_comments_468799.json:
```json
{
    "body": "Replying to [comment:139 gh-tobiasdiez]:\n> Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds\n> However, it needs to be done by someone with rights to install apps in the sagemath org.\n\nI've sent you an invite. I guess I installed their \"app\", but I don't see how to proceed.\n(I think it should be enabled on the branch of this ticket only, before it's merged.)\n\nDid you see my email message about trac access?",
    "created_at": "2022-01-13T17:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468799",
    "user": "@dimpase"
}
```

Replying to [comment:139 gh-tobiasdiez]:
> Yes, it's only a few clicks see: https://www.gitpod.io/docs/prebuilds#projects-and-prebuilds
> However, it needs to be done by someone with rights to install apps in the sagemath org.

I've sent you an invite. I guess I installed their "app", but I don't see how to proceed.
(I think it should be enabled on the branch of this ticket only, before it's merged.)

Did you see my email message about trac access?



---

archive/issue_comments_468800.json:
```json
{
    "body": "Thanks! I've now created a \"team\" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.\n\nCurrently, the creation of the image fails however due to a permission error:\n\n```\n > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:\n------\n.gitpod.Dockerfile:3\n--------------------\n   1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage\n   2 |     ARG BASE_TAG=dev\n   3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets\n   4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*\n   5 |     # Fast doc rebuilds do not work because\n--------------------\nerror: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden\n```\n\nMatthias, can you have a look please?\n\nhttps://gitpod.io/#prebuild/https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow",
    "created_at": "2022-01-14T11:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468800",
    "user": "@tobiasdiez"
}
```

Thanks! I've now created a "team" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.

Currently, the creation of the image fails however due to a permission error:

```
 > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
------
.gitpod.Dockerfile:3
--------------------
   1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
   2 |     ARG BASE_TAG=dev
   3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
   4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
   5 |     # Fast doc rebuilds do not work because
--------------------
error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
```

Matthias, can you have a look please?

https://gitpod.io/#prebuild/https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/gitpod_integration_using_docker_images_from_portability_testing_workflow



---

archive/issue_comments_468801.json:
```json
{
    "body": "Replying to [comment:141 gh-tobiasdiez]:\n> Thanks! I've now created a \"team\" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.\n\nmy email is shown on my [GitHub](GitHub) account https://github.com/dimpase\n\nThanks!",
    "created_at": "2022-01-14T12:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468801",
    "user": "@dimpase"
}
```

Replying to [comment:141 gh-tobiasdiez]:
> Thanks! I've now created a "team" sagemath and added the `sage` and `sagetrac-mirror` as projects. If you have a gitpod account and want to be invited to this team (in order to access the config), just post your email address and I send an invite.

my email is shown on my [GitHub](GitHub) account https://github.com/dimpase

Thanks!



---

archive/issue_comments_468802.json:
```json
{
    "body": "Replying to [comment:141 gh-tobiasdiez]:\n> Currently, the creation of the image fails however due to a permission error:\n> {{{\n>  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:\n> ------\n> .gitpod.Dockerfile:3\n> --------------------\n>    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage\n>    2 |     ARG BASE_TAG=dev\n>    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets\n>    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*\n>    5 |     # Fast doc rebuilds do not work because\n> --------------------\n> error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden\n> }}}\n\nI think you need to deposit a secret providing read access similar to what is explained in\nhttps://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry",
    "created_at": "2022-01-14T16:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468802",
    "user": "@mkoeppe"
}
```

Replying to [comment:141 gh-tobiasdiez]:
> Currently, the creation of the image fails however due to a permission error:
> {{{
>  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
> ------
> .gitpod.Dockerfile:3
> --------------------
>    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
>    2 |     ARG BASE_TAG=dev
>    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
>    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
>    5 |     # Fast doc rebuilds do not work because
> --------------------
> error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
> }}}

I think you need to deposit a secret providing read access similar to what is explained in
https://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry



---

archive/issue_comments_468803.json:
```json
{
    "body": "... alternatively I suppose we could push the required Docker images to DockerHub -- but I don't have write access there; `@`saraedum, could you deposit an access token for that as a secret here? https://github.com/organizations/sagemath/settings/secrets/actions",
    "created_at": "2022-01-14T18:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468803",
    "user": "@mkoeppe"
}
```

... alternatively I suppose we could push the required Docker images to DockerHub -- but I don't have write access there; `@`saraedum, could you deposit an access token for that as a secret here? https://github.com/organizations/sagemath/settings/secrets/actions



---

archive/issue_comments_468804.json:
```json
{
    "body": "Replying to [comment:143 mkoeppe]:\n> Replying to [comment:141 gh-tobiasdiez]:\n> > Currently, the creation of the image fails however due to a permission error:\n> > {{{\n> >  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:\n> > ------\n> > .gitpod.Dockerfile:3\n> > --------------------\n> >    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage\n> >    2 |     ARG BASE_TAG=dev\n> >    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets\n> >    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*\n> >    5 |     # Fast doc rebuilds do not work because\n> > --------------------\n> > error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden\n> > }}}\n> \n> I think you need to deposit a secret providing read access similar to what is explained in\n> https://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry\n\nThat link is for a self-hosted gitpod and thus does not apply to our situation (we don't have a gitpod config other than what is committed in this branch).\n\nI think the issue is that the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?",
    "created_at": "2022-01-14T20:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468804",
    "user": "@tobiasdiez"
}
```

Replying to [comment:143 mkoeppe]:
> Replying to [comment:141 gh-tobiasdiez]:
> > Currently, the creation of the image fails however due to a permission error:
> > {{{
> >  > [internal] load metadata for ghcr.io/sagemath/sage/sage-docker-gitpod-standard-with-targets:dev:
> > ------
> > .gitpod.Dockerfile:3
> > --------------------
> >    1 |     ARG BASE_GITHUB_REPOSITORY=sagemath/sage
> >    2 |     ARG BASE_TAG=dev
> >    3 | >>> FROM ghcr.io/${BASE_GITHUB_REPOSITORY}/sage-docker-gitpod-standard-with-targets:${BASE_TAG} as with-targets
> >    4 |     RUN sudo rm -rf /var/cache/debconf/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
> >    5 |     # Fast doc rebuilds do not work because
> > --------------------
> > error: failed to solve: failed to fetch anonymous token: unexpected status: 403 Forbidden
> > }}}
> 
> I think you need to deposit a secret providing read access similar to what is explained in
> https://www.gitpod.io/docs/self-hosted/latest/configuration/docker-registry

That link is for a self-hosted gitpod and thus does not apply to our situation (we don't have a gitpod config other than what is committed in this branch).

I think the issue is that the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?



---

archive/issue_comments_468805.json:
```json
{
    "body": "Replying to [comment:146 gh-tobiasdiez]:\n> the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?\n\nBecause on my testing branch used for the prebuild, I am setting the correct repo:\nhttps://github.com/mkoeppe/sage/blob/mkoeppe-9.5.beta9%2Bupdates/docker/.gitpod.Dockerfile",
    "created_at": "2022-01-14T20:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468805",
    "user": "@mkoeppe"
}
```

Replying to [comment:146 gh-tobiasdiez]:
> the image `sage-docker-gitpod-standard-with-targets` is not yet published under `sagemath/sage`. But how is this then working with your account Matthias?

Because on my testing branch used for the prebuild, I am setting the correct repo:
https://github.com/mkoeppe/sage/blob/mkoeppe-9.5.beta9%2Bupdates/docker/.gitpod.Dockerfile



---

archive/issue_comments_468806.json:
```json
{
    "body": "(And because every GH workflow automatically has the credentials to access its own GH packages (gchr.io)!)",
    "created_at": "2022-01-14T20:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468806",
    "user": "@mkoeppe"
}
```

(And because every GH workflow automatically has the credentials to access its own GH packages (gchr.io)!)



---

archive/issue_comments_468807.json:
```json
{
    "body": "Ahh okay, I thought this is an environment variable that is picked up somewhere.\n\nSo in this case we just have to wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?",
    "created_at": "2022-01-14T20:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468807",
    "user": "@tobiasdiez"
}
```

Ahh okay, I thought this is an environment variable that is picked up somewhere.

So in this case we just have to wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?



---

archive/issue_comments_468808.json:
```json
{
    "body": "Replying to [comment:149 gh-tobiasdiez]:\n> wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?\n\nYes, on the next release that includes this branch, the Docker image will be pushed (by separate instances of the workflow) both to `gchr.io/sagemath/sage` and to `gchr.io/sagemath/sagetrac-mirror`.\n\nWe will then see whether the 403 Forbidden will go away. I think it will not, for workflows run on `github.com/sagemath/sagetrac-mirror`, because it may not have the `read:packages` credential for `gchr.io/sagemath/sage`.",
    "created_at": "2022-01-14T20:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468808",
    "user": "@mkoeppe"
}
```

Replying to [comment:149 gh-tobiasdiez]:
> wait until this ticket is merged, which would then build and publish the docker image to `sagemath/sage`, right?

Yes, on the next release that includes this branch, the Docker image will be pushed (by separate instances of the workflow) both to `gchr.io/sagemath/sage` and to `gchr.io/sagemath/sagetrac-mirror`.

We will then see whether the 403 Forbidden will go away. I think it will not, for workflows run on `github.com/sagemath/sagetrac-mirror`, because it may not have the `read:packages` credential for `gchr.io/sagemath/sage`.



---

archive/issue_comments_468809.json:
```json
{
    "body": "I think we may need to do this:\nhttps://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#configuring-visibility-of-container-images-for-an-organization",
    "created_at": "2022-01-16T21:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468809",
    "user": "@mkoeppe"
}
```

I think we may need to do this:
https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#configuring-visibility-of-container-images-for-an-organization



---

archive/issue_comments_468810.json:
```json
{
    "body": "Well, no, all packages are already set to \"public\": For example https://github.com/orgs/sagemath/packages/container/sage%2Fsage-docker-ubuntu-focal-standard-configured/settings",
    "created_at": "2022-01-16T21:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468810",
    "user": "@mkoeppe"
}
```

Well, no, all packages are already set to "public": For example https://github.com/orgs/sagemath/packages/container/sage%2Fsage-docker-ubuntu-focal-standard-configured/settings



---

archive/issue_comments_468811.json:
```json
{
    "body": "But perhaps this is needed: https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#github-actions-access-for-organization-owned-container-images",
    "created_at": "2022-01-16T21:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468811",
    "user": "@mkoeppe"
}
```

But perhaps this is needed: https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#github-actions-access-for-organization-owned-container-images



---

archive/issue_comments_468812.json:
```json
{
    "body": "No, this makes no sense.",
    "created_at": "2022-01-16T21:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468812",
    "user": "@mkoeppe"
}
```

No, this makes no sense.



---

archive/issue_comments_468813.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-02-11T19:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468813",
    "user": "@mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_468814.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-12T22:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32866#issuecomment-468814",
    "user": "@vbraun"
}
```

Resolution: fixed
