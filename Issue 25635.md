# Issue 25635: Modular decomposition bug

Issue created by migration from https://trac.sagemath.org/ticket/25872

Original creator: jmantysalo

Original creation time: 2018-07-18 07:45:25

CC:  jlokesh dimpase dcoudert deinst


```
sage: G1 = Graph('FwA]w')
sage: G2 = Graph('F@Nfg')
sage: G1.modular_decomposition()
(PRIME, [6, 2, 1, 5, 0, (PARALLEL, [3, 4])])
sage: G2.modular_decomposition()
(PRIME, [6, 5, 0, 2, 3, 1, 4])
sage: G1.is_isomorphic(G2)
True
```


I suppose #24898 was not enought.


---

Comment by dcoudert created at 2018-07-18 09:07:32

That's certainly not an easy issue to fix. I have not clue what's going on :(


---

Comment by jmantysalo created at 2018-07-18 09:20:19

I don't know if this helps, but I was cross-checking #25763 and it seems that the bug is not visible with

`P._hasse_diagram.transitive_closure().to_undirected().is_prime()`

where `P` is any poset. In the internal digraph we have consecutive integers as vertices and `0, 1, ..., n-1` is a topological sort of the digraph.


---

Comment by dcoudert created at 2018-07-18 11:40:02

I tried other labelings of the graph and its working correctly when the first vertex of `G.vertex_iterator()` is not involved in the parallel node. 

```
sage: G3 = Graph('F|NE?')
sage: G3.modular_decomposition()
(PRIME, [2, (PARALLEL, [5, 6]), 1, 3, 0, 4])
```


With 'G2', the construction starts from vertex 0 that should be in a parallel node `(PARALLEL, [0, 1])`. If I add a twin to vertex 4, the new parallel node is detected.

```
sage: G2.add_edges([(2,7), (3,7)])
sage: G2.modular_decomposition()
(PRIME, [6, 5, 0, 2, 3, 1, (PARALLEL, [4, 7])])
```



---

Comment by jlokesh created at 2018-10-07 16:21:21

I have pushed the changes which were required to fix the bug. The change required was to remove the is_separated field from Node class in modular_decomposition.py. It removes the optimization which was causing the bug.
----
New commits:


---

Comment by dcoudert created at 2018-10-07 16:40:57

Thank you Lokesh.

You must add the following tests to the TESTS block of method `modular_decomposition` to show that the issue is fixed.


```
Ticket :trac:`25872` is fixed::

    sage: G1 = Graph('FwA]w')
    sage: G2 = Graph('F@Nfg')
    sage: G1.is_isomorphic(G2)
    True
    sage: G1.modular_decomposition()
    (PRIME, [6, 2, 1, 5, 0, (PARALLEL, [3, 4])])
    sage: G2.modular_decomposition()
    (PRIME, [6, 5, (PARALLEL, [0, 1]), 2, 3, 4])
    sage: G2.add_edges([(2,7), (3,7)])
    sage: G2.modular_decomposition()
    (PRIME, [6, 5, (PARALLEL, [0, 1]), 2, 3, (PARALLEL, [4, 7])])
```



---

Comment by jmantysalo created at 2018-10-08 04:44:04

Still doesn't work.


```
sage: a = Graph('PdDoIHG?o@OeC?_BsWCSsI?c')
sage: b = a.canonical_label()
sage: a.is_prime(), b.is_prime()
(True, False)
```


Found by


```
set_random_seed(0)
for i in xrange(10^3):
    G1 = graphs.RandomGNP(17, 0.3)
    G2 = G1.canonical_label()
    if G1.is_prime() != G2.is_prime():
        print(i)
        G1.show()
        break
else:
    print("OK")
```



---

Comment by git created at 2018-10-08 04:58:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jlokesh created at 2018-10-08 05:07:22

Replying to [comment:7 jmantysalo]:
> Still doesn't work.
 
Thanks for posting the example. Let me take a look.


---

Comment by deinst created at 2018-10-16 13:17:08

A few questions.

Would it be of use to add an `algorithm` parameter to `modular_decomposition` and `is_prime`?  I have code for the O(n<sup>3</sup>) algorithm of [Habib and Maurer 1979] that is probably slower than the current code, but seems to work.  Should I attempt to integrate it, and if so should I do it in this ticket or start a new one?

Should we move `modular_decomposition.py` into the `src/sage/graphs/graph_decompositions` directory?

In the testing section of `modular_decomposition.py` the function `children_node_type` is used to flag an error if all of the children of a SERIES or PARALLEL node are of the same type as their parent.  I think that this is too loose and an error should be noted if any of the children have the same type as their parents, otherwise the condition that nodes in the tree represent maximal modules is violated.


---

Comment by dcoudert created at 2018-10-16 15:46:17

This is a very good idea to add another algorithm and the parameter `algorithm` if it helps checking the validity of both algorithms. A slow algorithm is OK in such case.
However, it should be done in a separate ticket.

It is possible to move the file to `src/sage/graphs/graph_decompositions` while working on the new ticket.


---

Comment by deinst created at 2018-10-16 21:25:42

I added trac #26496.  The code there should be functional if you add `algorithm='habib'` to each call to `modular_decomposition` or `is_prime`.


---

Comment by dimpase created at 2022-05-25 16:39:21

see also #33902 

How about removing `'tedder'` completely?


---

Comment by dcoudert created at 2022-05-25 16:43:51

I can only agree with that. The code is buggy and I don't know how to fix that.


---

Comment by dimpase created at 2022-05-25 18:52:56

OK, I'll try doing this.


---

Comment by dcoudert created at 2022-05-25 20:28:37

We can at least start with a deprecation warning.


---

Comment by dimpase created at 2022-05-25 23:30:29

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-05-25 23:30:29

New commits:


---

Comment by dimpase created at 2022-05-25 23:31:23

As it's buggy, no need for deprecation, IMHO


---

Comment by dcoudert created at 2022-05-26 08:47:48

This looks good, but In `graph.py`, we should add the ticket number to the note explaining that we removed a buggy algorithm


---

Comment by git created at 2022-05-26 09:45:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-26 09:47:40

Replying to [comment:19 dcoudert]:
> This looks good, but In `graph.py`, we should add the ticket number to the note explaining that we removed a buggy algorithm

done


---

Comment by dcoudert created at 2022-05-26 09:52:00

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2022-05-26 09:52:00

Thank you Dima.

LGTM.


---

Comment by dcoudert created at 2022-05-26 09:53:19

We should certainly update the ticket description to reflect the removal.


---

Comment by mkoeppe created at 2022-05-26 14:54:19

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-05-26 14:54:19

> the algorithm= option is removed, as we only have one implementation now.

This breaks existing code


---

Comment by dcoudert created at 2022-05-26 16:07:55

So what should we do ? deprecate this option before removing tedder in a year ? remove tedder now and let this parameter even if unused with a deprecation ? something else ?


---

Comment by mkoeppe created at 2022-05-26 16:09:57

Just make it so that passing `algorithm='habib'` does not become an error


---

Comment by dimpase created at 2022-05-26 17:03:59

`algorithm='tedder'` should be an error now. 

The problem is, however, not limited to this, as there is also a `modular_decomposition(foo)` function, which was equivalent to `foo.modular_decomposition(algorithm='tedder')`. In the present branch `modular_decomposition(foo)` became
equivalent to the (old) `foo.modular_decomposition(algorithm='habib')`, because, what else?

I think it's too much fuss to fiddle around with deprecations here.


---

Comment by mkoeppe created at 2022-05-26 17:42:20

Just don't make these breaking API changes:

```
--- a/src/sage/graphs/graph.py
+++ b/src/sage/graphs/graph.py
@@ -7574,7 +7574,7 @@ class Graph(GenericGraph):
             return list(core.values())
 
     @doc_index("Leftovers")
-    def modular_decomposition(self, algorithm='habib', style='tuple'):
+    def modular_decomposition(self, style='tuple'):
         r"""
         Return the modular decomposition of the current graph.
 
@@ -8035,23 +8014,13 @@ class Graph(GenericGraph):
         return self.planar_dual().is_circumscribable(solver=solver, verbose=verbose)
 
     @doc_index("Graph properties")
-    def is_prime(self, algorithm='habib'):
+    def is_prime(self):
         r"""
         Test whether the current graph is prime.
 
```



---

Comment by git created at 2022-05-26 21:19:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-26 21:19:24

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-26 22:33:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-26 22:33:29

LGTM, thanks.


---

Comment by vbraun created at 2022-05-29 11:29:22

Resolution: fixed
