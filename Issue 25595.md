# Issue 25595: py3: replacing some .vertices() by .vertex_iterator()

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-07-11 18:34:31

CC:  tscrim jmantysalo dcoudert

mainly inside loops.

* This is faster
* This does not sort the vertices

Inspired by ##22349


---

Comment by chapoton created at 2018-07-11 18:35:21

New commits:


---

Comment by git created at 2018-07-11 18:36:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-07-11 18:44:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-07-12 21:03:00

Needs review?


---

Comment by jmantysalo created at 2018-07-13 03:19:35

Replying to [comment:5 tscrim]:
> Needs review?

I guess no, this fails several tests.


---

Comment by git created at 2018-07-13 06:24:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-13 06:33:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-07-13 10:00:53

There remains failing doctests in species. Probably we can just change the doctests.


---

Comment by git created at 2018-07-13 12:08:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-07-13 12:09:11

I have undone the change in species, that was making some doctests return random results.


---

Comment by tscrim created at 2018-07-13 14:56:28

Perhaps the thing to do would be to run `sorted` in each of those places (e.g., in defining `var_mapping`) as progress towards #22349.


---

Comment by chapoton created at 2018-07-13 15:05:03

Hmm, what do you mean ? Using "sorted" in species ?


---

Comment by tscrim created at 2018-07-13 15:15:36

Yes, that is correct.


---

Comment by tscrim created at 2018-07-13 15:17:04

Well, ideally we would write doctests that do not depend on the output order, but sometimes that is harder than its worth.


---

Comment by chapoton created at 2018-07-14 07:37:56

oh, well. Maybe we can just keep that for another ticket, no ?


---

Comment by chapoton created at 2018-07-14 07:43:15

Changing status from new to needs_review.


---

Comment by dcoudert created at 2018-07-14 09:15:34

A few comments in `quiver.py`:
* Apparently, you can replace `set(frozen).issubset(set(data.vertex_iterator()))` by `set(frozen).issubset(data.vertex_iterator())`.

```
sage: G = graphs.PetersenGraph()
sage: set([1,2]).issubset(G.vertex_iterator())
True
sage: set([1,10]).issubset(G.vertex_iterator())
False
```


* I don't know the size of `mlist` in this code, but it might be interesting to first convert it to a set before doing `nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in mlist)`

* `if any((a,a) in edges for a in data.vertex_iterator()):` -> `if data.has_loops():`. Furthermore, the list `edges` could be turned to a set for the next test (2-cycles).

* There are places where you could replace `edges()` by `edge_iterator()`, but may be you prefer to let that for another ticket.

* and finally, the following block 

```
if dg.has_multiple_edges():
    multi_edges = {}
    for v1,v2,label in dg.multiple_edges():
        ...
```

  could be changed to

```
multiple_edges = dg.multiple_edges()
if multiple_edges:
    multi_edges = {}
    for v1,v2,label in multiple_edges:
        ....
```

  Indeed, the cost of `has_multiple_edges` is almost the same as `multiple_edges`, that is visiting all the edges. So we can save one call.


---

Comment by git created at 2018-07-14 14:10:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2018-07-14 15:03:06

To avoid converting `frozen` to set and later to list again, and also to benefit from the set, I suggest to do:

```
            elif isinstance(frozen, list):
                s_frozen = set(frozen)
                if not s_frozen.issubset(data.vertex_iterator()):
                     raise ValueError("the optional list of frozen elements"
                                      " must be vertices of the digraph")
                 else:
                    mlist = self._mlist = frozen
                    nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in s_frozen)
```



---

Comment by chapoton created at 2018-07-14 15:10:19

I am not sure of what is exactly the point of converting to set. I can see that it can handle bad input, namely duplicate elements in the given frozen list, in which case we do not want to use the bad input itself. But you seem to say that by itself it will be faster in the loop ? Is this just by being a set instead of a list ?


---

Comment by dcoudert created at 2018-07-14 17:07:07

Testing if an element is in a list takes time `O(n)` while in a set it takes time `O(1)`. Of course, converting a list to a set has a cost, but if you to several test, it's interesting

```
sage: L = list(range(1000))
sage: S = set(L)
sage: %timeit [i for i in range(10000) if i in L]
10 loops, best of 3: 137 ms per loop
sage: %timeit [i for i in range(10000) if i in S]
1000 loops, best of 3: 877 µs per loop
sage: %timeit S = set(L)
10000 loops, best of 3: 21.3 µs per loop
```

I agree it's a minor improvement compared to other modifications.


---

Comment by chapoton created at 2018-07-14 17:55:49

In the quiver.py file, we are mostly dealing with digraphs with a small number of vertices. Probably almost never above 50. So these 'optimizations" are not really useful, I think.


---

Comment by dcoudert created at 2018-07-16 07:02:45

I agree that it's not really useful, but as you have to convert frozen to set, you just have to do:

```
nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in frozen)
mlist = self._mlist = list(frozen)
```



---

Comment by git created at 2018-07-16 07:30:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-07-16 07:30:28

ok, done. Thanks


---

Comment by dcoudert created at 2018-07-16 07:48:45

LGTM


---

Comment by dcoudert created at 2018-07-16 07:48:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-05 08:16:26

Resolution: fixed
