# Issue 25595: py3: replacing some .vertices() by .vertex_iterator()

archive/issues_025595.json:
```json
{
    "body": "CC:  @tscrim @jm58660 @dcoudert\n\nmainly inside loops.\n\n* This is faster\n* This does not sort the vertices\n\nInspired by ##22349\n\nIssue created by migration from https://trac.sagemath.org/ticket/25832\n\n",
    "created_at": "2018-07-11T18:34:31Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "py3: replacing some .vertices() by .vertex_iterator()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25595",
    "user": "@fchapoton"
}
```
CC:  @tscrim @jm58660 @dcoudert

mainly inside loops.

* This is faster
* This does not sort the vertices

Inspired by ##22349

Issue created by migration from https://trac.sagemath.org/ticket/25832





---

archive/issue_comments_360873.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-11T18:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360873",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_360874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-11T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360874",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-11T18:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360875",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360876.json:
```json
{
    "body": "Needs review?",
    "created_at": "2018-07-12T21:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360876",
    "user": "@tscrim"
}
```

Needs review?



---

archive/issue_comments_360877.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> Needs review?\n\nI guess no, this fails several tests.",
    "created_at": "2018-07-13T03:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360877",
    "user": "@jm58660"
}
```

Replying to [comment:5 tscrim]:
> Needs review?

I guess no, this fails several tests.



---

archive/issue_comments_360878.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-13T06:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360878",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360879.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-13T06:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360879",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360880.json:
```json
{
    "body": "There remains failing doctests in species. Probably we can just change the doctests.",
    "created_at": "2018-07-13T10:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360880",
    "user": "@fchapoton"
}
```

There remains failing doctests in species. Probably we can just change the doctests.



---

archive/issue_comments_360881.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-07-13T12:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360881",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_360882.json:
```json
{
    "body": "I have undone the change in species, that was making some doctests return random results.",
    "created_at": "2018-07-13T12:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360882",
    "user": "@fchapoton"
}
```

I have undone the change in species, that was making some doctests return random results.



---

archive/issue_comments_360883.json:
```json
{
    "body": "Perhaps the thing to do would be to run `sorted` in each of those places (e.g., in defining `var_mapping`) as progress towards #22349.",
    "created_at": "2018-07-13T14:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360883",
    "user": "@tscrim"
}
```

Perhaps the thing to do would be to run `sorted` in each of those places (e.g., in defining `var_mapping`) as progress towards #22349.



---

archive/issue_comments_360884.json:
```json
{
    "body": "Hmm, what do you mean ? Using \"sorted\" in species ?",
    "created_at": "2018-07-13T15:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360884",
    "user": "@fchapoton"
}
```

Hmm, what do you mean ? Using "sorted" in species ?



---

archive/issue_comments_360885.json:
```json
{
    "body": "Yes, that is correct.",
    "created_at": "2018-07-13T15:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360885",
    "user": "@tscrim"
}
```

Yes, that is correct.



---

archive/issue_comments_360886.json:
```json
{
    "body": "Well, ideally we would write doctests that do not depend on the output order, but sometimes that is harder than its worth.",
    "created_at": "2018-07-13T15:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360886",
    "user": "@tscrim"
}
```

Well, ideally we would write doctests that do not depend on the output order, but sometimes that is harder than its worth.



---

archive/issue_comments_360887.json:
```json
{
    "body": "oh, well. Maybe we can just keep that for another ticket, no ?",
    "created_at": "2018-07-14T07:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360887",
    "user": "@fchapoton"
}
```

oh, well. Maybe we can just keep that for another ticket, no ?



---

archive/issue_comments_360888.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-14T07:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360888",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_360889.json:
```json
{
    "body": "A few comments in `quiver.py`:\n* Apparently, you can replace `set(frozen).issubset(set(data.vertex_iterator()))` by `set(frozen).issubset(data.vertex_iterator())`.\n\n```\nsage: G = graphs.PetersenGraph()\nsage: set([1,2]).issubset(G.vertex_iterator())\nTrue\nsage: set([1,10]).issubset(G.vertex_iterator())\nFalse\n```\n\n\n* I don't know the size of `mlist` in this code, but it might be interesting to first convert it to a set before doing `nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in mlist)`\n\n* `if any((a,a) in edges for a in data.vertex_iterator()):` -> `if data.has_loops():`. Furthermore, the list `edges` could be turned to a set for the next test (2-cycles).\n\n* There are places where you could replace `edges()` by `edge_iterator()`, but may be you prefer to let that for another ticket.\n\n* and finally, the following block \n\n```\nif dg.has_multiple_edges():\n    multi_edges = {}\n    for v1,v2,label in dg.multiple_edges():\n        ...\n```\n\n  could be changed to\n\n```\nmultiple_edges = dg.multiple_edges()\nif multiple_edges:\n    multi_edges = {}\n    for v1,v2,label in multiple_edges:\n        ....\n```\n\n  Indeed, the cost of `has_multiple_edges` is almost the same as `multiple_edges`, that is visiting all the edges. So we can save one call.",
    "created_at": "2018-07-14T09:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360889",
    "user": "@dcoudert"
}
```

A few comments in `quiver.py`:
* Apparently, you can replace `set(frozen).issubset(set(data.vertex_iterator()))` by `set(frozen).issubset(data.vertex_iterator())`.

```
sage: G = graphs.PetersenGraph()
sage: set([1,2]).issubset(G.vertex_iterator())
True
sage: set([1,10]).issubset(G.vertex_iterator())
False
```


* I don't know the size of `mlist` in this code, but it might be interesting to first convert it to a set before doing `nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in mlist)`

* `if any((a,a) in edges for a in data.vertex_iterator()):` -> `if data.has_loops():`. Furthermore, the list `edges` could be turned to a set for the next test (2-cycles).

* There are places where you could replace `edges()` by `edge_iterator()`, but may be you prefer to let that for another ticket.

* and finally, the following block 

```
if dg.has_multiple_edges():
    multi_edges = {}
    for v1,v2,label in dg.multiple_edges():
        ...
```

  could be changed to

```
multiple_edges = dg.multiple_edges()
if multiple_edges:
    multi_edges = {}
    for v1,v2,label in multiple_edges:
        ....
```

  Indeed, the cost of `has_multiple_edges` is almost the same as `multiple_edges`, that is visiting all the edges. So we can save one call.



---

archive/issue_comments_360890.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-14T14:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360890",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360891.json:
```json
{
    "body": "To avoid converting `frozen` to set and later to list again, and also to benefit from the set, I suggest to do:\n\n```\n            elif isinstance(frozen, list):\n                s_frozen = set(frozen)\n                if not s_frozen.issubset(data.vertex_iterator()):\n                     raise ValueError(\"the optional list of frozen elements\"\n                                      \" must be vertices of the digraph\")\n                 else:\n                    mlist = self._mlist = frozen\n                    nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in s_frozen)\n```\n",
    "created_at": "2018-07-14T15:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360891",
    "user": "@dcoudert"
}
```

To avoid converting `frozen` to set and later to list again, and also to benefit from the set, I suggest to do:

```
            elif isinstance(frozen, list):
                s_frozen = set(frozen)
                if not s_frozen.issubset(data.vertex_iterator()):
                     raise ValueError("the optional list of frozen elements"
                                      " must be vertices of the digraph")
                 else:
                    mlist = self._mlist = frozen
                    nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in s_frozen)
```




---

archive/issue_comments_360892.json:
```json
{
    "body": "I am not sure of what is exactly the point of converting to set. I can see that it can handle bad input, namely duplicate elements in the given frozen list, in which case we do not want to use the bad input itself. But you seem to say that by itself it will be faster in the loop ? Is this just by being a set instead of a list ?",
    "created_at": "2018-07-14T15:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360892",
    "user": "@fchapoton"
}
```

I am not sure of what is exactly the point of converting to set. I can see that it can handle bad input, namely duplicate elements in the given frozen list, in which case we do not want to use the bad input itself. But you seem to say that by itself it will be faster in the loop ? Is this just by being a set instead of a list ?



---

archive/issue_comments_360893.json:
```json
{
    "body": "Testing if an element is in a list takes time `O(n)` while in a set it takes time `O(1)`. Of course, converting a list to a set has a cost, but if you to several test, it's interesting\n\n```\nsage: L = list(range(1000))\nsage: S = set(L)\nsage: %timeit [i for i in range(10000) if i in L]\n10 loops, best of 3: 137 ms per loop\nsage: %timeit [i for i in range(10000) if i in S]\n1000 loops, best of 3: 877 \u00b5s per loop\nsage: %timeit S = set(L)\n10000 loops, best of 3: 21.3 \u00b5s per loop\n```\n\nI agree it's a minor improvement compared to other modifications.",
    "created_at": "2018-07-14T17:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360893",
    "user": "@dcoudert"
}
```

Testing if an element is in a list takes time `O(n)` while in a set it takes time `O(1)`. Of course, converting a list to a set has a cost, but if you to several test, it's interesting

```
sage: L = list(range(1000))
sage: S = set(L)
sage: %timeit [i for i in range(10000) if i in L]
10 loops, best of 3: 137 ms per loop
sage: %timeit [i for i in range(10000) if i in S]
1000 loops, best of 3: 877 µs per loop
sage: %timeit S = set(L)
10000 loops, best of 3: 21.3 µs per loop
```

I agree it's a minor improvement compared to other modifications.



---

archive/issue_comments_360894.json:
```json
{
    "body": "In the quiver.py file, we are mostly dealing with digraphs with a small number of vertices. Probably almost never above 50. So these 'optimizations\" are not really useful, I think.",
    "created_at": "2018-07-14T17:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360894",
    "user": "@fchapoton"
}
```

In the quiver.py file, we are mostly dealing with digraphs with a small number of vertices. Probably almost never above 50. So these 'optimizations" are not really useful, I think.



---

archive/issue_comments_360895.json:
```json
{
    "body": "I agree that it's not really useful, but as you have to convert frozen to set, you just have to do:\n\n```\nnlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in frozen)\nmlist = self._mlist = list(frozen)\n```\n",
    "created_at": "2018-07-16T07:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360895",
    "user": "@dcoudert"
}
```

I agree that it's not really useful, but as you have to convert frozen to set, you just have to do:

```
nlist = self._nlist = sorted(x for x in data.vertex_iterator() if x not in frozen)
mlist = self._mlist = list(frozen)
```




---

archive/issue_comments_360896.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-16T07:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360896",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_360897.json:
```json
{
    "body": "ok, done. Thanks",
    "created_at": "2018-07-16T07:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360897",
    "user": "@fchapoton"
}
```

ok, done. Thanks



---

archive/issue_comments_360898.json:
```json
{
    "body": "LGTM",
    "created_at": "2018-07-16T07:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360898",
    "user": "@dcoudert"
}
```

LGTM



---

archive/issue_comments_360899.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-16T07:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360899",
    "user": "@dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_360900.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-05T08:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25595",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25595#issuecomment-360900",
    "user": "@vbraun"
}
```

Resolution: fixed
