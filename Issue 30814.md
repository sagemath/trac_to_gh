# Issue 30814: change AC_MSG_ERROR to AC_MSG_ERROR in the configuration of gp2c

Issue created by migration from https://trac.sagemath.org/ticket/31051

Original creator: dcoudert

Original creation time: 2020-12-15 15:09:52

CC:  dimpase slelievre mjo

Without this change, I can not run `./bootstrap` on fedora 32, and so I can not compile


---

Comment by dcoudert created at 2020-12-15 15:10:50

Changing status from new to needs_review.


---

Comment by dcoudert created at 2020-12-15 15:10:50

New commits:


---

Comment by slelievre created at 2020-12-15 15:39:02

Changing keywords from "" to "gp2c".


---

Comment by dimpase created at 2020-12-15 19:56:06

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-12-15 19:56:06

OK


---

Comment by dimpase created at 2020-12-15 19:57:33

Do I get it right that the compilation goes through with the change on Fedora 32, right?


---

Comment by dcoudert created at 2020-12-15 20:21:16

Yes, I was able to compile with this change (plus the use of upstream url for libsemigroups).


---

Comment by mkoeppe created at 2020-12-15 21:22:30

I don't think this is the correct fix. When `gp2c` is enabled to be installed, then this should be a hard error


---

Comment by mjo created at 2020-12-15 22:02:21

Replying to [comment:7 mkoeppe]:
> I don't think this is the correct fix. When `gp2c` is enabled to be installed, then this should be a hard error

True, and building gp2c should also fail since we don't know where pari.cfg is. Like the comment says, "If we can't find pari.cfg, gp2c isn't going to work."

What was the original `./configure` command, and what did it output? What does it output after the message was changed to a warning? Something is fishy.


---

Comment by dcoudert created at 2020-12-15 23:09:25

I tried to upgrade from 9.3.beta3. After `git pull` on develop branch, I tried `make build` and it fails during configuration. the config.log can be found in the message https://groups.google.com/g/sage-release/c/dmqD6CIRUVo/m/9oCozIMkAwAJ.
and in this message https://groups.google.com/g/sage-release/c/dmqD6CIRUVo/m/CM7JJqJNAwAJ you can find the config.log with this modification.

I agree that this might be a symptom of another issue.


---

Comment by mjo created at 2020-12-16 00:35:28

Ok, there are two things weird:

1. Why is it trying to install the (optional) gp2c package when you haven't enabled it with `--enable-gp2c`?
2. Why can't it find your system `pari.cfg`?

The real problem is the first item... but, I'm curious. Your config log shows...


```
configure:17361: checking for gp
configure:17379: found /bin/gp
```


Is that really where `gp` lives, or is it a symlink to `/usr/bin/gp`? Perhaps `/bin` is a symlink to `/usr/bin`? We use that path when guessing the location of `pari.cfg`, so having it return `/bin/gp` instead of `/usr/bin/gp` would throw a wrench into things. It's an easy fix however.

(But regardless, you haven't enabled gp2c at all, so you shouldn't be hitting this problem.)


---

Comment by dcoudert created at 2020-12-16 00:46:31

You get it right, `/bin` is a symlink

```
gelati:/home/dcoudert>ls -ll /bin 
lrwxrwxrwx. 1 root root 7 Jan 28  2020 /bin -> usr/bin
gelati:/home/dcoudert> ls -l /usr/bin/gp*  
lrwxrwxrwx  1 root root       7 Nov 12 23:19 /usr/bin/gp -> gp-2.11
-rwxr-xr-x  1 root root  132936 Nov 12 23:19 /usr/bin/gp-2.11
...
```


I haven't enabled `gp2c`. May be it's a dependency of another package ? I haven't check that. I have (ok, it's certainly not the best way to get the list): 

```
gelati:/home/dcoudert/sage> ./sage -t src/sage/graphs/print_graphs.py 
too few successful tests, not using stored timings
Running doctests with ID 2020-12-16-01-44-24-894c14a1.
Git branch: develop
Using --optional=benzene,bliss,buckygen,build,cryptominisat,csdp,dochtml,dot2tex,fedora,gap_packages,glucose,libsemigroups,mcqd,memlimit,pip,plantri,python_igraph,rubiks,sage,sage_numerical_backends_cplex,sage_spkg,tdlib,texttable
Doctesting 1 file.
sage -t --random-seed=0 src/sage/graphs/print_graphs.py
    [12 tests, 0.02 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```



---

Comment by mjo created at 2020-12-16 01:13:54

This should fix the second problem, and allow `--enable-gp2c` to work on systems where `/bin` is a symlink to `/usr/bin`. I still have no idea about the larger issue, though.
----
New commits:


---

Comment by mjo created at 2020-12-16 01:13:54

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-12-16 01:24:58

Replying to [comment:11 dcoudert]:
> I haven't enabled `gp2c`. May be it's a dependency of another package ?

For all packages, including non-enabled optional packages, the presence of system packages is checked. Wishlist tickets #29372, #29498 propose to change this.


---

Comment by mjo created at 2020-12-16 01:31:53

Replying to [comment:13 mkoeppe]:
> For all packages, including non-enabled optional packages, the presence of system packages is checked. Wishlist tickets #29372, #29498 propose to change this.

This failure is within an `AS_IF([test "x$sage_spkg_install_gp2c" = "xyes"]...` block. Should that be passing when gp2c is not enabled?


---

Comment by dcoudert created at 2020-12-16 09:18:17

It's working for me on that desktop. Thanks!

I let you decide if we can set back to positive review and how to change authors/reviewers.


---

Comment by dimpase created at 2020-12-16 12:40:59

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2020-12-16 12:40:59

Looks good to me. Please add the names :-)

Let me also point out that the fact that my fix worked too is an indication that there could be  a better way to discover `pari.cfg` than the one currently implemented in spkg-configure of gp2c.


---

Comment by mjo created at 2020-12-16 14:06:38

I would still very much prefer that we not do these checks at all when gp2c is disabled, but if everyone's content to do that in some other ticket, this is still an improvement.

Ultimately, pari itself should tell us where pari.cfg is installed, via either pkg-config or something like `gp --pari-cfg`. Nobody thinks enumerating all possible locations is a good way to do it, but the build would eventually fail if gp2c was enabled and if we allowed the check to proceed with a warning. The previous way of running `find` on all of `/usr` and then waiting five minutes was even worse.


---

Comment by dimpase created at 2020-12-19 11:17:07

pari.cfg file can be found in the PARI object directory and is installed in $prefix/lib/pari/.

this is in gp2c docs of the Par project:
https://pari.math.u-bordeaux.fr/pub/pari/manuals/gp2c/gp2c.html

Fedora is wrong about the location it installs pari.cfg to


---

Comment by mjo created at 2020-12-19 15:06:07

And those docs are wrong =)

pari.cfg is installed to `$(sysdatadir)`, which defaults to (but is not guaranteed to be) `$prefix/lib/pari`


---

Comment by vbraun created at 2020-12-27 00:23:02

Resolution: fixed
