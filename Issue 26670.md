# Issue 26670: Exact division in ℤ[x][y] is broken

archive/issues_026670.json:
```json
{
    "body": "\n```\nsage: P.<x> = ZZ[]\nsage: Q.<y> = P[]\nsage: a = 3*y + 1\nsage: a//a\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-28-932792481982> in <module>()\n----> 1 a//a\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:88374)()\n  10816         \"\"\"\n  10817         if have_same_parent(self, right):\n> 10818             return (<Polynomial_generic_dense>self)._floordiv_(<Polynomial_generic_dense>right)\n  10819         P = parent(self)\n  10820         d = P.base_ring()(right)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial._floordiv_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:28587)()\n   2748             # quite typical when removing gcds...\n   2749             return self\n-> 2750         Q, _ = self.quo_rem(right)\n   2751         return Q\n   2752 \n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/element.pyx in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:27512)()\n   4282     def new_method(self, other, *args, **kwargs):\n   4283         if have_same_parent(self, other):\n-> 4284             return method(self, other, *args, **kwargs)\n   4285         else:\n   4286             a, b = coercion_model.canonical_coercion(self, other)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.quo_rem (build/cythonized/sage/rings/polynomial/polynomial_element.c:91271)()\n  11065         cdef Py_ssize_t j, k\n  11066         try:\n> 11067             inv = y[n-1].inverse_of_unit()\n  11068         except (ArithmeticError, ValueError):\n  11069             inv = ~(y[n-1])\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.inverse_of_unit (build/cythonized/sage/rings/polynomial/polynomial_element.c:14449)()\n   1385         elif d == -1:\n   1386             return self._parent(~self._parent._base.zero())\n-> 1387         return self._parent(~self.get_unsafe(0))\n   1388 \n   1389     def inverse_mod(a, m):\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9531)()\n    917         if mor is not None:\n    918             if no_extra_args:\n--> 919                 return mor._call_(x)\n    920             else:\n    921                 return mor._call_with_args(x, args, kwds)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4595)()\n    143                 print(type(C), C)\n    144                 print(type(C._element_constructor), C._element_constructor)\n--> 145             raise\n    146 \n    147     cpdef Element _call_with_args(self, x, args=(), kwds={}):\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4487)()\n    138         cdef Parent C = self._codomain\n    139         try:\n--> 140             return C._element_constructor(x)\n    141         except Exception:\n    142             if print_warnings:\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring.pyc in _element_constructor_(self, x, check, is_gen, construct, **kwds)\n    458         elif isinstance(x, sage.rings.power_series_ring_element.PowerSeries):\n    459             x = x.truncate()\n--> 460         return C(self, x, check, is_gen, construct=construct, **kwds)\n    461 \n    462     @classmethod\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_integer_dense_flint.pyx in sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_integer_dense_flint.cpp:6706)()\n    286             else:\n    287                 if not isinstance(a, Integer):\n--> 288                     a = ZZ(a)\n    289                 sig_on()\n    290                 fmpz_poly_set_coeff_mpz(self.__poly, i, (<Integer>a).value)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9531)()\n    917         if mor is not None:\n    918             if no_extra_args:\n--> 919                 return mor._call_(x)\n    920             else:\n    921                 return mor._call_with_args(x, args, kwds)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Q_to_Z._call_ (build/cythonized/sage/rings/rational.c:32086)()\n   4140         \"\"\"\n   4141         if not mpz_cmp_si(mpq_denref((<Rational>x).value), 1) == 0:\n-> 4142             raise TypeError(\"no conversion of this rational to integer\")\n   4143         cdef Integer n = Integer.__new__(Integer)\n   4144         n.set_from_mpz(mpq_numref((<Rational>x).value))\n\nTypeError: no conversion of this rational to integer\n```\n\n\nI think it might be due to cb8db697a1b (#26433), but I didn't check.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26907\n\n",
    "created_at": "2018-12-17T11:37:28Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Exact division in \u2124[x][y] is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26670",
    "user": "mmezzarobba"
}
```

```
sage: P.<x> = ZZ[]
sage: Q.<y> = P[]
sage: a = 3*y + 1
sage: a//a
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-28-932792481982> in <module>()
----> 1 a//a

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.__floordiv__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:88374)()
  10816         """
  10817         if have_same_parent(self, right):
> 10818             return (<Polynomial_generic_dense>self)._floordiv_(<Polynomial_generic_dense>right)
  10819         P = parent(self)
  10820         d = P.base_ring()(right)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial._floordiv_ (build/cythonized/sage/rings/polynomial/polynomial_element.c:28587)()
   2748             # quite typical when removing gcds...
   2749             return self
-> 2750         Q, _ = self.quo_rem(right)
   2751         return Q
   2752 

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/element.pyx in sage.structure.element.coerce_binop.new_method (build/cythonized/sage/structure/element.c:27512)()
   4282     def new_method(self, other, *args, **kwargs):
   4283         if have_same_parent(self, other):
-> 4284             return method(self, other, *args, **kwargs)
   4285         else:
   4286             a, b = coercion_model.canonical_coercion(self, other)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.quo_rem (build/cythonized/sage/rings/polynomial/polynomial_element.c:91271)()
  11065         cdef Py_ssize_t j, k
  11066         try:
> 11067             inv = y[n-1].inverse_of_unit()
  11068         except (ArithmeticError, ValueError):
  11069             inv = ~(y[n-1])

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.inverse_of_unit (build/cythonized/sage/rings/polynomial/polynomial_element.c:14449)()
   1385         elif d == -1:
   1386             return self._parent(~self._parent._base.zero())
-> 1387         return self._parent(~self.get_unsafe(0))
   1388 
   1389     def inverse_mod(a, m):

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9531)()
    917         if mor is not None:
    918             if no_extra_args:
--> 919                 return mor._call_(x)
    920             else:
    921                 return mor._call_with_args(x, args, kwds)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4595)()
    143                 print(type(C), C)
    144                 print(type(C._element_constructor), C._element_constructor)
--> 145             raise
    146 
    147     cpdef Element _call_with_args(self, x, args=(), kwds={}):

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/coerce_maps.pyx in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4487)()
    138         cdef Parent C = self._codomain
    139         try:
--> 140             return C._element_constructor(x)
    141         except Exception:
    142             if print_warnings:

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring.pyc in _element_constructor_(self, x, check, is_gen, construct, **kwds)
    458         elif isinstance(x, sage.rings.power_series_ring_element.PowerSeries):
    459             x = x.truncate()
--> 460         return C(self, x, check, is_gen, construct=construct, **kwds)
    461 
    462     @classmethod

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_integer_dense_flint.pyx in sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint.__init__ (build/cythonized/sage/rings/polynomial/polynomial_integer_dense_flint.cpp:6706)()
    286             else:
    287                 if not isinstance(a, Integer):
--> 288                     a = ZZ(a)
    289                 sig_on()
    290                 fmpz_poly_set_coeff_mpz(self.__poly, i, (<Integer>a).value)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9531)()
    917         if mor is not None:
    918             if no_extra_args:
--> 919                 return mor._call_(x)
    920             else:
    921                 return mor._call_with_args(x, args, kwds)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Q_to_Z._call_ (build/cythonized/sage/rings/rational.c:32086)()
   4140         """
   4141         if not mpz_cmp_si(mpq_denref((<Rational>x).value), 1) == 0:
-> 4142             raise TypeError("no conversion of this rational to integer")
   4143         cdef Integer n = Integer.__new__(Integer)
   4144         n.set_from_mpz(mpq_numref((<Rational>x).value))

TypeError: no conversion of this rational to integer
```


I think it might be due to cb8db697a1b (#26433), but I didn't check.

Issue created by migration from https://trac.sagemath.org/ticket/26907





---

archive/issue_comments_374937.json:
```json
{
    "body": "The simple fix should be to add\n\n```diff\n         try:\n             inv = y[n-1].inverse_of_unit()\n-        except (ArithmeticError, ValueError):\n+        except (ArithmeticError, ValueError, TypeError):\n             inv = ~(y[n-1])\n             convert = True\n```\n\nHowever, I would argue the real bug is here:\n\n```\nsage: R.<x> = ZZ[]\nsage: R(2).inverse_of_unit()\n...\nTypeError: no conversion of this rational to integer\n```\n\nIn particular, we are inconsistent about the type of error that is raised. This was an assumption in the code block above, which is why it was not caught. Hence, the above change should fix this, but sweep the underlying issue under the rug.\n\nAlso, wouldn't it be better to do\n\n```diff\n         elif d == -1:\n             return self._parent(~self._parent._base.zero())\n-        return self._parent(~self.get_unsafe(0))\n+        return self._parent(self.get_unsafe(0).inverse_of_unit())\n```\n\n\nSide note: We probably should add a generic `inverse_of_unit` to the category of `Fields` that simply returns `~self`.",
    "created_at": "2018-12-17T11:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374937",
    "user": "tscrim"
}
```

The simple fix should be to add

```diff
         try:
             inv = y[n-1].inverse_of_unit()
-        except (ArithmeticError, ValueError):
+        except (ArithmeticError, ValueError, TypeError):
             inv = ~(y[n-1])
             convert = True
```

However, I would argue the real bug is here:

```
sage: R.<x> = ZZ[]
sage: R(2).inverse_of_unit()
...
TypeError: no conversion of this rational to integer
```

In particular, we are inconsistent about the type of error that is raised. This was an assumption in the code block above, which is why it was not caught. Hence, the above change should fix this, but sweep the underlying issue under the rug.

Also, wouldn't it be better to do

```diff
         elif d == -1:
             return self._parent(~self._parent._base.zero())
-        return self._parent(~self.get_unsafe(0))
+        return self._parent(self.get_unsafe(0).inverse_of_unit())
```


Side note: We probably should add a generic `inverse_of_unit` to the category of `Fields` that simply returns `~self`.



---

archive/issue_comments_374938.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-22T20:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374938",
    "user": "mmezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_374939.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-22T20:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374939",
    "user": "mmezzarobba"
}
```

New commits:



---

archive/issue_comments_374940.json:
```json
{
    "body": "So this behavior should change now with this change:\n\n```\nsage: RR(0).inverse_of_unit()\n---------------------------------------------------------------------------\nArithmeticError                           Traceback (most recent call last)\n<ipython-input-7-9817ebd4dc31> in <module>()\n----> 1 RR(Integer(0)).inverse_of_unit()\n\n/home/travis/sage-build/local/lib/python2.7/site-packages/sage/categories/rings.pyc in inverse_of_unit(self)\n   1155             try:\n   1156                 if not self.is_unit():\n-> 1157                     raise ArithmeticError(\"element is not a unit\")\n   1158             except NotImplementedError:\n   1159                 # if an element does not implement is_unit, we just try to\n\nArithmeticError: element is not a unit\nsage: 1/RR(0)\n+infinity\n```\n\nI think it is the correct change, but I am now maybe a little worried about assumptions and we might want to quickly ask on sage-devel about this to confirm.\n\nAlso, a better test:\n\n```\n                sage: try:\n                ....:    QQ(0).inverse_of_unit()\n                ....: except ArithmeticError as e:\n                ....:    print(type(e))\n                <... 'exceptions.ZeroDivisionError'>\n```\n\nto\n\n```\n                sage: QQ(0).inverse_of_unit()\n                Traceback (most recent call last):\n                ...\n                ZeroDivisionError: rational division by zero\n```\n",
    "created_at": "2018-12-22T21:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374940",
    "user": "tscrim"
}
```

So this behavior should change now with this change:

```
sage: RR(0).inverse_of_unit()
---------------------------------------------------------------------------
ArithmeticError                           Traceback (most recent call last)
<ipython-input-7-9817ebd4dc31> in <module>()
----> 1 RR(Integer(0)).inverse_of_unit()

/home/travis/sage-build/local/lib/python2.7/site-packages/sage/categories/rings.pyc in inverse_of_unit(self)
   1155             try:
   1156                 if not self.is_unit():
-> 1157                     raise ArithmeticError("element is not a unit")
   1158             except NotImplementedError:
   1159                 # if an element does not implement is_unit, we just try to

ArithmeticError: element is not a unit
sage: 1/RR(0)
+infinity
```

I think it is the correct change, but I am now maybe a little worried about assumptions and we might want to quickly ask on sage-devel about this to confirm.

Also, a better test:

```
                sage: try:
                ....:    QQ(0).inverse_of_unit()
                ....: except ArithmeticError as e:
                ....:    print(type(e))
                <... 'exceptions.ZeroDivisionError'>
```

to

```
                sage: QQ(0).inverse_of_unit()
                Traceback (most recent call last):
                ...
                ZeroDivisionError: rational division by zero
```




---

archive/issue_comments_374941.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> So this behavior should change now with this change:\n> {{{\n> sage: RR(0).inverse_of_unit()\n> ---------------------------------------------------------------------------\n> ArithmeticError                           Traceback (most recent call last)\n> <ipython-input-7-9817ebd4dc31> in <module>()\n> ----> 1 RR(Integer(0)).inverse_of_unit()\n> \n> /home/travis/sage-build/local/lib/python2.7/site-packages/sage/categories/rings.pyc in inverse_of_unit(self)\n>    1155             try:\n>    1156                 if not self.is_unit():\n> -> 1157                     raise ArithmeticError(\"element is not a unit\")\n>    1158             except NotImplementedError:\n>    1159                 # if an element does not implement is_unit, we just try to\n> \n> ArithmeticError: element is not a unit\n> sage: 1/RR(0)\n> +infinity\n> }}}\n> I think it is the correct change, but I am now maybe a little worried about assumptions and we might want to quickly ask on sage-devel about this to confirm.\n\nI just followed your suggestion here, I have no opinion on the matter.\n\n> Also, a better test:\n> {{{\n>                 sage: try:\n>                 ....:    QQ(0).inverse_of_unit()\n>                 ....: except ArithmeticError as e:\n>                 ....:    print(type(e))\n>                 <... 'exceptions.ZeroDivisionError'>\n> }}}\n> to\n> {{{\n>                 sage: QQ(0).inverse_of_unit()\n>                 Traceback (most recent call last):\n>                 ...\n>                 ZeroDivisionError: rational division by zero\n> }}}\n\nI deliberately wrote it that way, to hint to the fact that it is often better to catch all `ArithmeticError`s than just `ZeroDivisionError`s if you are `calling inverse_of_unit()`\u2014but yes, I should have been more explicit!",
    "created_at": "2018-12-23T06:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374941",
    "user": "mmezzarobba"
}
```

Replying to [comment:3 tscrim]:
> So this behavior should change now with this change:
> {{{
> sage: RR(0).inverse_of_unit()
> ---------------------------------------------------------------------------
> ArithmeticError                           Traceback (most recent call last)
> <ipython-input-7-9817ebd4dc31> in <module>()
> ----> 1 RR(Integer(0)).inverse_of_unit()
> 
> /home/travis/sage-build/local/lib/python2.7/site-packages/sage/categories/rings.pyc in inverse_of_unit(self)
>    1155             try:
>    1156                 if not self.is_unit():
> -> 1157                     raise ArithmeticError("element is not a unit")
>    1158             except NotImplementedError:
>    1159                 # if an element does not implement is_unit, we just try to
> 
> ArithmeticError: element is not a unit
> sage: 1/RR(0)
> +infinity
> }}}
> I think it is the correct change, but I am now maybe a little worried about assumptions and we might want to quickly ask on sage-devel about this to confirm.

I just followed your suggestion here, I have no opinion on the matter.

> Also, a better test:
> {{{
>                 sage: try:
>                 ....:    QQ(0).inverse_of_unit()
>                 ....: except ArithmeticError as e:
>                 ....:    print(type(e))
>                 <... 'exceptions.ZeroDivisionError'>
> }}}
> to
> {{{
>                 sage: QQ(0).inverse_of_unit()
>                 Traceback (most recent call last):
>                 ...
>                 ZeroDivisionError: rational division by zero
> }}}

I deliberately wrote it that way, to hint to the fact that it is often better to catch all `ArithmeticError`s than just `ZeroDivisionError`s if you are `calling inverse_of_unit()`—but yes, I should have been more explicit!



---

archive/issue_comments_374942.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-23T06:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374942",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_374943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-05T09:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374943",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_374944.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2019-01-05T09:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374944",
    "user": "mmezzarobba"
}
```

Changing priority from major to critical.



---

archive/issue_comments_374945.json:
```json
{
    "body": "*Critical* is perhaps a bit strong, but it would be nice if this branch could go in 8.6, since it fixes a regression introduced in 8.5.",
    "created_at": "2019-01-05T09:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374945",
    "user": "mmezzarobba"
}
```

*Critical* is perhaps a bit strong, but it would be nice if this branch could go in 8.6, since it fixes a regression introduced in 8.5.



---

archive/issue_comments_374946.json:
```json
{
    "body": "The following works without any patch\n\n```\nsage: NumberField(x^7+2,'a')(2).inverse_of_unit()\n1/2\n```\n",
    "created_at": "2019-01-05T10:10:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374946",
    "user": "vdelecroix"
}
```

The following works without any patch

```
sage: NumberField(x^7+2,'a')(2).inverse_of_unit()
1/2
```




---

archive/issue_comments_374947.json:
```json
{
    "body": "Why do you try/catch here\n\n```\n+        try:\n+            inv = cst.inverse_of_unit()\n+        except (TypeError, ValueError):\n+            raise ArithmeticError(f\"{self} is not a unit in {self.parent()}\")\n```\n\nThe error generated by calling `inverse_of_unit` should just be fine.",
    "created_at": "2019-01-05T10:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374947",
    "user": "vdelecroix"
}
```

Why do you try/catch here

```
+        try:
+            inv = cst.inverse_of_unit()
+        except (TypeError, ValueError):
+            raise ArithmeticError(f"{self} is not a unit in {self.parent()}")
```

The error generated by calling `inverse_of_unit` should just be fine.



---

archive/issue_comments_374948.json:
```json
{
    "body": "Replying to [comment:8 vdelecroix]:\n> The following works without any patch\n> {{{\n> sage: NumberField(x^7+2,'a')(2).inverse_of_unit()\n> 1/2\n> }}}\n\nThat's expected. The part that fixes the bug is in the first two commits; the third is general cleanup suggested by Travis above.",
    "created_at": "2019-01-05T10:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374948",
    "user": "mmezzarobba"
}
```

Replying to [comment:8 vdelecroix]:
> The following works without any patch
> {{{
> sage: NumberField(x^7+2,'a')(2).inverse_of_unit()
> 1/2
> }}}

That's expected. The part that fixes the bug is in the first two commits; the third is general cleanup suggested by Travis above.



---

archive/issue_comments_374949.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> Why do you try/catch here\n> {{{\n> +        try:\n> +            inv = cst.inverse_of_unit()\n> +        except (TypeError, ValueError):\n> +            raise ArithmeticError(f\"{self} is not a unit in {self.parent()}\")\n> }}}\n> The error generated by calling `inverse_of_unit` should just be fine.\n\nBecause `//` now relies on the exception being `ArithmeticError` (that's what caused of the regression, and the convention used by `inverse_of_unit()` elsewhere in Sage). While I fixed `inverse_of_unit()` in the case that caused the issue reported in this ticket, there may be other code paths that raise the wrong exception.",
    "created_at": "2019-01-05T10:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374949",
    "user": "mmezzarobba"
}
```

Replying to [comment:9 vdelecroix]:
> Why do you try/catch here
> {{{
> +        try:
> +            inv = cst.inverse_of_unit()
> +        except (TypeError, ValueError):
> +            raise ArithmeticError(f"{self} is not a unit in {self.parent()}")
> }}}
> The error generated by calling `inverse_of_unit` should just be fine.

Because `//` now relies on the exception being `ArithmeticError` (that's what caused of the regression, and the convention used by `inverse_of_unit()` elsewhere in Sage). While I fixed `inverse_of_unit()` in the case that caused the issue reported in this ticket, there may be other code paths that raise the wrong exception.



---

archive/issue_comments_374950.json:
```json
{
    "body": "Replying to [comment:11 mmezzarobba]:\n> Replying to [comment:9 vdelecroix]:\n> > Why do you try/catch here\n> > {{{\n> > +        try:\n> > +            inv = cst.inverse_of_unit()\n> > +        except (TypeError, ValueError):\n> > +            raise ArithmeticError(f\"{self} is not a unit in {self.parent()}\")\n> > }}}\n> > The error generated by calling `inverse_of_unit` should just be fine.\n> \n> Because `//` now relies on the exception being `ArithmeticError` (that's what caused of the regression, and the convention used by `inverse_of_unit()` elsewhere in Sage). While I fixed `inverse_of_unit()` in the case that caused the issue reported in this ticket, there may be other code paths that raise the wrong exception.\n\nIf any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.",
    "created_at": "2019-01-05T11:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374950",
    "user": "vdelecroix"
}
```

Replying to [comment:11 mmezzarobba]:
> Replying to [comment:9 vdelecroix]:
> > Why do you try/catch here
> > {{{
> > +        try:
> > +            inv = cst.inverse_of_unit()
> > +        except (TypeError, ValueError):
> > +            raise ArithmeticError(f"{self} is not a unit in {self.parent()}")
> > }}}
> > The error generated by calling `inverse_of_unit` should just be fine.
> 
> Because `//` now relies on the exception being `ArithmeticError` (that's what caused of the regression, and the convention used by `inverse_of_unit()` elsewhere in Sage). While I fixed `inverse_of_unit()` in the case that caused the issue reported in this ticket, there may be other code paths that raise the wrong exception.

If any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.



---

archive/issue_comments_374951.json:
```json
{
    "body": "Since you seriously modified `inverse_of_unit`, you should update the ticket description.",
    "created_at": "2019-01-05T11:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374951",
    "user": "vdelecroix"
}
```

Since you seriously modified `inverse_of_unit`, you should update the ticket description.



---

archive/issue_comments_374952.json:
```json
{
    "body": "Replying to [comment:12 vdelecroix]:\n> If any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.\n\nI don't think so. Raising another exception is a really minor issue compared to breaking mathematical functionality; and, since it will typically come from conversion failures, it might even be a reasonable choice in some cases.\n\n\nReplying to [comment:13 vdelecroix]:\n> Since you seriously modified inverse_of_unit, you should update the ticket description.\n\nDone, though IMO people really should stop confusing ticket descriptions and commit messages...",
    "created_at": "2019-01-05T11:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374952",
    "user": "mmezzarobba"
}
```

Replying to [comment:12 vdelecroix]:
> If any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.

I don't think so. Raising another exception is a really minor issue compared to breaking mathematical functionality; and, since it will typically come from conversion failures, it might even be a reasonable choice in some cases.


Replying to [comment:13 vdelecroix]:
> Since you seriously modified inverse_of_unit, you should update the ticket description.

Done, though IMO people really should stop confusing ticket descriptions and commit messages...



---

archive/issue_comments_374953.json:
```json
{
    "body": "Replying to [comment:14 mmezzarobba]:\n> Replying to [comment:12 vdelecroix]:\n> > If any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.\n> \n> I don't think so. Raising another exception is a really minor issue compared to breaking mathematical functionality; and, since it will typically come from conversion failures, it might even be a reasonable choice in some cases.\n\nI agree with Vincent here as consistent error messages are not only better practice, but are also  useful. It allows a `TypeError` raised from actual bug to be percolated up instead of being caught and maybe silently working.",
    "created_at": "2019-01-05T17:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374953",
    "user": "tscrim"
}
```

Replying to [comment:14 mmezzarobba]:
> Replying to [comment:12 vdelecroix]:
> > If any, it would be better to fix the error in inverse of unit rather than introducing this workaround that hides the problem.
> 
> I don't think so. Raising another exception is a really minor issue compared to breaking mathematical functionality; and, since it will typically come from conversion failures, it might even be a reasonable choice in some cases.

I agree with Vincent here as consistent error messages are not only better practice, but are also  useful. It allows a `TypeError` raised from actual bug to be percolated up instead of being caught and maybe silently working.



---

archive/issue_comments_374954.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-06T10:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374954",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_374955.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> I agree with Vincent here as consistent error messages are not only better practice, but are also  useful. It allows a `TypeError` raised from actual bug to be percolated up instead of being caught and maybe silently working.\n\nI really don't follow your reasoning, but if that's what it takes to get the issue fixed, so be it.",
    "created_at": "2019-01-06T10:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374955",
    "user": "mmezzarobba"
}
```

Replying to [comment:15 tscrim]:
> I agree with Vincent here as consistent error messages are not only better practice, but are also  useful. It allows a `TypeError` raised from actual bug to be percolated up instead of being caught and maybe silently working.

I really don't follow your reasoning, but if that's what it takes to get the issue fixed, so be it.



---

archive/issue_comments_374956.json:
```json
{
    "body": "The test failure in `polyhedron/library.py` seems unrelated (and doesn't occur on my box).",
    "created_at": "2019-01-06T14:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374956",
    "user": "mmezzarobba"
}
```

The test failure in `polyhedron/library.py` seems unrelated (and doesn't occur on my box).



---

archive/issue_comments_374957.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-07T07:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374957",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_374958.json:
```json
{
    "body": "Ok for me. Merci Marc.",
    "created_at": "2019-01-07T07:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374958",
    "user": "vdelecroix"
}
```

Ok for me. Merci Marc.



---

archive/issue_comments_374959.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374959",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_374960.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T15:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26670#issuecomment-374960",
    "user": "vbraun"
}
```

Resolution: fixed
