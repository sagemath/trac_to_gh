# Issue 26717: The gcc package doesn't build with new gcc

Issue created by migration from https://trac.sagemath.org/ticket/26954

Original creator: vbraun

Original creation time: 2018-12-25 14:04:40

CC:  slelievre

Looks like https://gcc.gnu.org/bugzilla/show_bug.cgi?id=85835

```
[gcc-7.2.0] libtool: compile:  /mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/xgcc -B/mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/var/tmp/sage/build/gcc-7.2.0/gcc-build/./gcc/ -B/mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/x86_64-pc-linux-gnu/bin/ -B/mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/x86_64-pc-linux-gnu/lib/ -isystem /mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/x86_64-pc-linux-gnu/include -isystem /mnt/disk/home/buildslave-sage/slave/binary_pkg/build/source/SageMath/jc4b6yulaujayb9sr94ia88eourzeq/local/x86_64-pc-linux-gnu/sys-include -DHAVE_CONFIG_H -I../../../src/libatomic/config/x86 -I../../../src/libatomic/config/posix -I../../../src/libatomic -I. -Wall -Werror -pthread -g -O2 -MT cas_16_1_.lo -MD -MP -MF .deps/cas_16_1_.lo.Ppo -DN=16 -DIFUNC_ALT=1 -mcx16 -c ../../../src/libatomic/cas_n.c -o cas_16_1_.o >/dev/null 2>&1
[gcc-7.2.0] ../../../../src/libsanitizer/sanitizer_common/sanitizer_platform_limits_posix.cc:157:10: fatal error: sys/ustat.h: No such file or directory
[gcc-7.2.0]  #include <sys/ustat.h>
[gcc-7.2.0]           ^~~~~~~~~~~~~
[gcc-7.2.0] compilation terminated.
[gcc-7.2.0] make[10]: *** [Makefile:523: sanitizer_platform_limits_posix.lo] Error 1
```



---

Comment by Konrad127123 created at 2018-12-30 22:39:21

Changing status from new to needs_review.


---

Comment by Konrad127123 created at 2018-12-30 22:39:21

The attached commits upgrade `gcc` to 7.4, which should fix this and make that the fix for #26735 redundant.

I've also disabled building `gcc` with `isl`, since that is now an optional package in sage (see also discussion in #26735). If `isl` ever becomes a standard package, `gcc` should be made to depend on it, the `--disable-isl` line can be removed and the hacks for `gmp` and friends when building `gcc` should also be added for `isl`.

I have not tested this set of changes yet.
----
New commits:


---

Comment by Konrad127123 created at 2019-01-01 23:21:51

Update: with the attached changes, `gcc` now builds again on my computer (and #26735 does not come back).


(Later in the build process (but only if I build `gcc`), I get the following error when trying to build `givaro`:

```
-----------------------------------------------
checking gmp.h usability... yes
checking gmp.h presence... yes
checking for gmp.h... yes
checking for GMP library... yes
checking gmpxx.h usability... no
checking gmpxx.h presence... yes
configure: WARNING: gmpxx.h: present but cannot be compiled
configure: WARNING: gmpxx.h:     check for missing prerequisite headers?
configure: WARNING: gmpxx.h: see the Autoconf documentation
configure: WARNING: gmpxx.h:     section "Present But Cannot Be Compiled"
configure: WARNING: gmpxx.h: proceeding with the compiler's result
configure: WARNING:     ## --------------------------------------------------- ##
configure: WARNING:     ## Report this to http://github.com/linbox-team/givaro ##
configure: WARNING:     ## --------------------------------------------------- ##
checking for gmpxx.h... no
your GMP does not have c++ support. Compile GMP with --enable-cxx
********************************************************************************
```

My suspicion is that this failure is unrelated, and should be a separate issue.)


---

Comment by Konrad127123 created at 2019-01-04 21:50:46

Update: I tried bulding sage again with the attached patch. It worked, and all tests passed with `make testlong`. The `givaro` issue above was most likely a case of running out of diskspace.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by Konrad127123 created at 2019-01-23 19:22:08

> Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.
This patch is ready to go. It just needs someone to review it :).


---

Comment by embray created at 2019-01-23 22:30:21

It looks like #27016 will likely conflict with this. Perhaps I could combine the two (especially if my ticket is reviewed)?


---

Comment by Konrad127123 created at 2019-01-23 23:51:46

Replying to [comment:7 embray]:
> It looks like #27016 will likely conflict with this. Perhaps I could combine the two (especially if my ticket is reviewed)? 
I don't have enough knowledge of the build system to feel comfortable reviewing #27016. I have no objection to you combining the two: cherry-pick 6f07d2f and 62d8e3b, then add --without-isl to the configure options for both gcc and gfortran (I just noticed gfortran is built from the same source as gcc, so it should also get the --without-isl option for the same reason; my patch currently omits this.)


---

Comment by Konrad127123 created at 2019-01-23 23:51:46

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-01-28 13:59:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Konrad127123 created at 2019-01-28 14:02:52

I've now also added --without-isl to the configure script for gfortran. I've not tested the gfortran part. I've not merged with #27016.


---

Comment by Konrad127123 created at 2019-01-28 14:02:52

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2019-01-30 12:53:11

Changing keywords from "" to "upgrade, gcc, gfortran, isl".


---

Comment by slelievre created at 2019-01-30 12:53:11

Changing the ticket summary from "The gcc package doesn't build with new gcc"
to "Upgrade to gcc 7.4.0 and build gcc and gfortran without isl".


---

Comment by git created at 2019-03-19 17:10:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by Konrad127123 created at 2019-03-19 17:19:00

Patch now rebased on top of #27016.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by vbraun created at 2019-07-02 17:21:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-04 11:09:36

Resolution: fixed
