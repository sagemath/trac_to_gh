# Issue 19523: Rpath Fairy

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-12-23 05:09:33




---

Comment by vbraun created at 2015-12-23 10:47:00

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2015-12-23 10:47:00

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2015-12-23 10:47:00

New commits:


---

Comment by vbraun created at 2015-12-23 10:47:13

Changing status from new to needs_review.


---

Comment by git created at 2015-12-23 12:42:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-12-23 19:44:51

Are you sure that `objdump` exists on every system?


---

Comment by vbraun created at 2015-12-23 19:46:19

Its part of binutils so I'm pretty sure that its wherever there is a compiler. Though of course a buildbot run will show...


---

Comment by jdemeyer created at 2015-12-23 19:47:40

Instead of this:


```
            for cls in FileClasses:
                if cls.is_magic(head):
                    try:
                        cls(fqn).perform_tests()
                    except TestException as exc:
                        ...
```

I would prefer

```
            for cls in FileClasses:
                try:
                    cls(fqn).perform_tests()
                except NotImplementedError:
                    pass
                except TestException as exc:
                    ...
```

or something along these lines. Not all file types can be determined by "magic" and perhaps `perform_tests()` might do some unsupported checks (like if `objdump` is not available).


---

Comment by jdemeyer created at 2015-12-23 19:47:46

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-12-23 19:48:06

Replying to [comment:6 vbraun]:
> Its part of binutils so I'm pretty sure that its wherever there is a compiler.

What about non-Linux systems?


---

Comment by jdemeyer created at 2015-12-23 19:49:22

Are sure you want `return` here?

```
            if not os.path.isfile(fqn):
                return
```



---

Comment by jdemeyer created at 2015-12-23 19:50:45

Since you obviously want this to be something general (which is a good thing), you should define `TestException` in `recursive_check.py` and `import` it in `binary_audit.py`.


---

Comment by vbraun created at 2015-12-23 19:53:12

For speed reasons I want to hang everything of the first 512 bytes; Just running "file" for each of the 50k files in Sage takes a long time. But reading the head of each is just about acceptable, about 10s with warm caches.

Non-Linux systems shouldn't have files with ELF magic. In fact, if they do then I'd like to get an error.

I don't want circular imports


---

Comment by jdemeyer created at 2015-12-23 19:57:19

Replying to [comment:12 vbraun]:
> For speed reasons I want to hang everything of the first 512 bytes
That wasn't my point, I was saying to move the "magic" check to `ELFBinaryFile.__init__()` and raise `NotImplementedError` if it's not magic.


---

Comment by jdemeyer created at 2015-12-23 20:01:15

Will this work on 32-bit?

```
            sage: patch.rpath_string
            '/.../local/lib:/.../local/lib64'
```



---

Comment by git created at 2015-12-23 20:07:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-23 20:11:44

Right now LDFLAGS has both lib and lib64 unconditionally; IMHO its easier than to sprinkle 32/64 branches everywhere. E.g. gcc sometimes insists on putting libraries into lib64. It is perfectly fine to add a non-existing directory to the path.


---

Comment by fbissey created at 2015-12-23 20:28:34

No `objdump` on OS X.


---

Comment by git created at 2015-12-23 20:30:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-23 20:30:20

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2015-12-23 20:31:10

As long as there are no ELF binaries on OSX we won't call objdump either


---

Comment by fbissey created at 2015-12-23 20:44:08

So those test only run on `elf` systems (linux, freeBSD). I think I understand how that work, on OS X you'll just pass the test. You count on things to be picked up on linux and not having to do it elsewhere. A fair assumption.


---

Comment by jdemeyer created at 2015-12-23 21:43:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-12-23 21:43:03

Obvious error:

```
sage -t src/sage/tests/local/binary_audit.py
**********************************************************************
File "src/sage/tests/local/binary_audit.py", line 127, in sage.tests.local.binary_audit.ELFBinaryFile.rpath
Failed example:
    patch.rpath()
Expected:
    ('/.../sage/local/lib', '/.../sage/local/lib64')
Got:
    ('/usr/local/src/sage-git/local/lib', '/usr/local/src/sage-git/local/lib64')
**********************************************************************
```



---

Comment by jdemeyer created at 2015-12-23 21:46:19

Are there any non-executable ELF files? Checking only executable files would be an obvious optimization.


---

Comment by git created at 2015-12-23 21:49:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-12-23 21:51:38

Shared libraries need not be executable, though if they have o+x then they can be executed. In fact its rather difficult to tell ELF binaries and shared libraries apart.


---

Comment by vbraun created at 2015-12-23 21:51:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-12-23 22:19:54

Would it make sense to mark this as `# optional - buildbot` and run it only on the buildbot? I see two reasons:

1. The test takes a really long time (430s from cold cache and 50s from warm cache on my system)

2. I sometimes install custom stuff in `$SAGE_LOCAL` which might not use the `rpath` from Sage.


---

Comment by jdemeyer created at 2015-12-23 22:28:38

Any clue?


```
    File /usr/local/src/sage-git/local/lib/libcblas.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
    File /usr/local/src/sage-git/local/lib/libLfunction.so: /usr/local/src/sage-git/local/lib not in rpath: ()
    File /usr/local/src/sage-git/local/lib/libptf77blas.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
    File /usr/local/src/sage-git/local/lib/libf77blas.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
    File /usr/local/src/sage-git/local/lib/libptcblas.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
    File /usr/local/src/sage-git/local/lib/libptlapack.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
    File /usr/local/src/sage-git/local/lib/liblapack.so.3.0.0: /usr/local/src/sage-git/local/lib64 not in rpath: ('/usr/local/src/sage-git/local/lib',)
```



---

Comment by vbraun created at 2015-12-23 22:32:59

Your ATLAS build did not respect LDFLAGS

The libLfunction issue is fixed in #19755


---

Comment by vbraun created at 2015-12-23 22:36:31

The tests will only trigger if you require a sage library (via NEEDED) but have no rpath. You'll want to know that especially for other custom stuff that you install in SAGE_LOCAL.


---

Comment by jdemeyer created at 2015-12-23 22:48:44

ATLAS libraries fail the tests.


---

Comment by jdemeyer created at 2015-12-23 22:48:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-12-25 13:10:34

With a Sage-built GCC:

```
    File /home/jdemeyer/sage-git/local/libexec/gcc/i686-pc-linux-gnu/4.9.2/lto1: /home/jdemeyer/sage-git/local/lib64 not in rpath: ('/home/jdemeyer/sage-git/local/lib',)   
    File /home/jdemeyer/sage-git/local/libexec/gcc/i686-pc-linux-gnu/4.9.2/cc1plus: /home/jdemeyer/sage-git/local/lib64 not in rpath: ('/home/jdemeyer/sage-git/local/lib',)
    File /home/jdemeyer/sage-git/local/libexec/gcc/i686-pc-linux-gnu/4.9.2/f951: /home/jdemeyer/sage-git/local/lib64 not in rpath: ('/home/jdemeyer/sage-git/local/lib',)   
    File /home/jdemeyer/sage-git/local/libexec/gcc/i686-pc-linux-gnu/4.9.2/cc1: /home/jdemeyer/sage-git/local/lib64 not in rpath: ('/home/jdemeyer/sage-git/local/lib',)
```

