# Issue 11696: PARI library interface broken by design

archive/issues_011696.json:
```json
{
    "body": "Assignee: @williamstein\n\nKeywords: t0GEN t1GEN gen\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11868\n\n",
    "created_at": "2011-09-29T08:42:32Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.13",
    "title": "PARI library interface broken by design",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11696",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: @williamstein

Keywords: t0GEN t1GEN gen



Issue created by migration from https://trac.sagemath.org/ticket/11868





---

archive/issue_comments_132008.json:
```json
{
    "body": "The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.",
    "created_at": "2011-09-29T08:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132008",
    "user": "https://github.com/jdemeyer"
}
```

The `t0GEN()`, `t1GEN()`,... system in the PARI interface is broken by design.  Apply [attachment:demonstrate_11868.patch] to see the bug in action.



---

archive/issue_comments_132009.json:
```json
{
    "body": "Patch to *demonstrate* the bug",
    "created_at": "2011-09-29T08:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132009",
    "user": "https://github.com/jdemeyer"
}
```

Patch to *demonstrate* the bug



---

archive/issue_comments_132010.json:
```json
{
    "body": "Attachment [demonstrate_11868.patch](tarball://root/attachments/some-uuid/ticket11868/demonstrate_11868.patch) by @jdemeyer created at 2011-09-29 09:11:31",
    "created_at": "2011-09-29T09:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132010",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [demonstrate_11868.patch](tarball://root/attachments/some-uuid/ticket11868/demonstrate_11868.patch) by @jdemeyer created at 2011-09-29 09:11:31



---

archive/issue_comments_132011.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132011",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_132012.json:
```json
{
    "body": "Attachment [trac_11868-t0GEN.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN.patch) by @pjbruin created at 2013-11-24 02:26:28\n\neliminate global GEN variables",
    "created_at": "2013-11-24T02:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132012",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_11868-t0GEN.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN.patch) by @pjbruin created at 2013-11-24 02:26:28

eliminate global GEN variables



---

archive/issue_events_031360.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-11-24T02:28:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "milestone": "sage-5.13",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11696#event-31360"
}
```



---

archive/issue_comments_132013.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-11-24T02:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132013",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_132014.json:
```json
{
    "body": "The patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.",
    "created_at": "2013-11-24T02:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132014",
    "user": "https://github.com/pjbruin"
}
```

The patch contains (slightly) more changes than strictly necessary; this is to make life a bit easier for #15185.



---

archive/issue_comments_132015.json:
```json
{
    "body": "Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?",
    "created_at": "2013-11-24T17:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132015",
    "user": "https://github.com/jdemeyer"
}
```

Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?



---

archive/issue_comments_132016.json:
```json
{
    "body": "I agree with the general approach, but have to check the many details...",
    "created_at": "2013-11-24T17:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132016",
    "user": "https://github.com/jdemeyer"
}
```

I agree with the general approach, but have to check the many details...



---

archive/issue_comments_132017.json:
```json
{
    "body": "In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\n\n```\ndevel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::\ndevel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer\ndevel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868\n```\n",
    "created_at": "2013-11-24T17:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132017",
    "user": "https://github.com/jdemeyer"
}
```

In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:

```
devel/sage/sage/schemes/elliptic_curves/ell_point.py:        We need to explicitly call ``pari()`` because of :trac:`11868`::
devel/sage/sage/rings/number_field/number_field.py:            # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/rings/number_field/number_field.py:        # to work around Trac #11868 -- Jeroen Demeyer
devel/sage/sage/libs/pari/gen.pyx:            sage: pari(K).nfhilbert(t, t+2)  # not tested, known bug #11868
```




---

archive/issue_comments_132018.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-11-24T17:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132018",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_132019.json:
```json
{
    "body": "Maybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?",
    "created_at": "2013-11-24T17:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132019",
    "user": "https://github.com/jdemeyer"
}
```

Maybe rename `get_nf()` as `_get_nf()` to emphazise that it's a private internal function?



---

archive/issue_comments_132020.json:
```json
{
    "body": "One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.",
    "created_at": "2013-11-24T18:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132020",
    "user": "https://github.com/jdemeyer"
}
```

One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.



---

archive/issue_comments_132021.json:
```json
{
    "body": "Maybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).",
    "created_at": "2013-11-24T18:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132021",
    "user": "https://github.com/jdemeyer"
}
```

Maybe the right thing to do is to have things like `t0` of type `gen` instead of `GEN` and then using `t0.g` (like we already often do for `self`).



---

archive/issue_comments_132022.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:\nDone, patch on its way.",
    "created_at": "2013-11-24T22:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132022",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:8 jdemeyer]:
> In the PARI sources, there are various workarounds for #11868, could you undo these workarounds:
Done, patch on its way.



---

archive/issue_comments_132023.json:
```json
{
    "body": "remove workarounds for bug related to global GEN variables",
    "created_at": "2013-11-24T22:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132023",
    "user": "https://github.com/pjbruin"
}
```

remove workarounds for bug related to global GEN variables



---

archive/issue_comments_132024.json:
```json
{
    "body": "Attachment [trac_11868-remove_workarounds.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-remove_workarounds.patch) by @pjbruin created at 2013-11-24 22:13:30",
    "created_at": "2013-11-24T22:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132024",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_11868-remove_workarounds.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-remove_workarounds.patch) by @pjbruin created at 2013-11-24 22:13:30



---

archive/issue_comments_132025.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?\nIt is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.",
    "created_at": "2013-11-24T22:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132025",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:6 jdemeyer]:
> Is it not possible to keep `get_nf()` as a function returning a `GEN` without copying?
It is actually even possible that we don't need `get_nf()` at all, since PARI has higher-level functions like `member_pol()`, `member_diff()` etc. that accept various types of number fields.  (Maybe these didn't exist when `gen.pyx` was written?)  I'll look into it.



---

archive/issue_comments_132026.json:
```json
{
    "body": "Attachment [trac_11868-get_nf.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-get_nf.patch) by @pjbruin created at 2013-11-25 00:26:31\n\neliminate the gen.get_nf() method",
    "created_at": "2013-11-25T00:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132026",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_11868-get_nf.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-get_nf.patch) by @pjbruin created at 2013-11-25 00:26:31

eliminate the gen.get_nf() method



---

archive/issue_comments_132027.json:
```json
{
    "body": "It turns out that `get_nf()` can indeed be done away with entirely.",
    "created_at": "2013-11-25T00:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132027",
    "user": "https://github.com/pjbruin"
}
```

It turns out that `get_nf()` can indeed be done away with entirely.



---

archive/issue_comments_132028.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\nIn an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.",
    "created_at": "2013-11-25T00:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132028",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:10 jdemeyer]:
> One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.
In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.



---

archive/issue_comments_132029.json:
```json
{
    "body": "Replying to [comment:16 pbruin]:\n> Replying to [comment:10 jdemeyer]:\n> > One important \"detail\": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.\n> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.\n\nI don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):\n- some PARI computation creates a `GEN` on the PARI stack\n- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n- `toGEN` copies the object back to the PARI stack\n\nMy proposal is essentially removing the last step.",
    "created_at": "2013-11-25T09:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132029",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:16 pbruin]:
> Replying to [comment:10 jdemeyer]:
> > One important "detail": it seems this ticket causes a lot more copying of data (because of the `gcopy()` in `cdef GEN toGEN`. That's bad.
> In an earlier attempt I did make the `t0` variables of type `gen`.  I think the reason I changed them back to `GEN` is to decrease the number of `gen` objects that had to be created/deleted.  The (only) price to pay for this is an extra `gcopy()` for Sage objects that are converted via their `_pari_()` method.  This is an extremely common case of course.  I'll have to think some more about this issue.

I don't my suggestion would create more `gen` objects. What usually happens is (with this patch applied):
- some PARI computation creates a `GEN` on the PARI stack
- `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
- `toGEN` copies the object back to the PARI stack

My proposal is essentially removing the last step.



---

archive/issue_comments_132030.json:
```json
{
    "body": "I found another problem with your patch: you must not do\n\n```\npari_catch_sig_on()\ncdef GEN t0 = P.toGEN(x)\n```\n\nbecause you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.",
    "created_at": "2013-11-25T09:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132030",
    "user": "https://github.com/jdemeyer"
}
```

I found another problem with your patch: you must not do

```
pari_catch_sig_on()
cdef GEN t0 = P.toGEN(x)
```

because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.



---

archive/issue_comments_132031.json:
```json
{
    "body": "I have also been thinking about using a `with` statement:\n\n```\ncdef GEN r\nwith to_GEN(s) as t0:\n    pari_catch_sig_on\n    r = gwhatever(t0)\n    pari_catch_sig_off\nreturn new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()\n```\n\n\nThen `to_GEN` would be something like\n\n```\ncimport cython\n\n@cython.final\ncdef class to_GEN:\n    cdef gen x\n\n    def __init__(to_GEN self, s):\n        self.x = s._pari_()\n\n    cdef inline GEN __enter__(to_GEN self):\n        return self.x.g\n\n    cdef inline int __exit__(to_GEN self, typ, value, traceback):\n        return 0\n```\n\n\nThis looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.",
    "created_at": "2013-11-25T10:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132031",
    "user": "https://github.com/jdemeyer"
}
```

I have also been thinking about using a `with` statement:

```
cdef GEN r
with to_GEN(s) as t0:
    pari_catch_sig_on
    r = gwhatever(t0)
    pari_catch_sig_off
return new_gen(r)  # Clears stack but doesn't call pari_catch_sig_off()
```


Then `to_GEN` would be something like

```
cimport cython

@cython.final
cdef class to_GEN:
    cdef gen x

    def __init__(to_GEN self, s):
        self.x = s._pari_()

    cdef inline GEN __enter__(to_GEN self):
        return self.x.g

    cdef inline int __exit__(to_GEN self, typ, value, traceback):
        return 0
```


This looks more complicated, but it has the added advantage that the `gen` object for `s` is hidden inside the `to_GEN` class and that the `gen` `x` is kept alive for just the right amount of time. This opens a possibility (not on this ticket) to make `deepcopy_to_python_heap()` lazy, such that it only activates when the PARI stack is cleared.



---

archive/issue_comments_132032.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> I found another problem with your patch: you must not do\n> {{{\n> pari_catch_sig_on()\n> cdef GEN t0 = P.toGEN(x)\n> }}}\n> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.\nYes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in comment:11.  (This is essentially very close to what we currently have.)",
    "created_at": "2013-11-25T14:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132032",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:18 jdemeyer]:
> I found another problem with your patch: you must not do
> {{{
> pari_catch_sig_on()
> cdef GEN t0 = P.toGEN(x)
> }}}
> because you should not call Python code within `sig_on()`/`sig_off()` and `toGEN()` potentially calls Python code. So the `toGEN` should be before `pari_catch_sig_on()`.
Yes, I also realised in the meantime that this is a problem.  With the current policy of clearing the whole stack at every `new_gen()`, this means that have to wrap every temporary `GEN` in a `gen` if we want it to survive subsequent applications of `toGEN()`.  So I think the best solution is to use `gen` instead of `GEN`, as in comment:11.  (This is essentially very close to what we currently have.)



---

archive/issue_comments_132033.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> I don't my suggestion would create more `gen` objects.\nIt doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.\n> What usually happens is (with this patch applied):\n> - some PARI computation creates a `GEN` on the PARI stack\n> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object\n> - `toGEN` copies the object back to the PARI stack\n> \n> My proposal is essentially removing the last step.\nThat is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).\n\nAnyway, this idea is now defeated for the time being because of comment:18 and comment:20.  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).\n\nNow working on a new patch in the spirit of comment:11.",
    "created_at": "2013-11-25T14:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132033",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:17 jdemeyer]:
> I don't my suggestion would create more `gen` objects.
It doesn't create any more `gen` objects than what we have now, but I wanted (and failed for now) to create *fewer* `gen` objects than what we have now.
> What usually happens is (with this patch applied):
> - some PARI computation creates a `GEN` on the PARI stack
> - `_new_gen()` calls `deepcopy_to_python_heap` which copies the object to the Python heap and makes it into a `gen` object
> - `toGEN` copies the object back to the PARI stack
> 
> My proposal is essentially removing the last step.
That is what happens for objects with a `_pari_()` method.  For other objects, my idea was to not create any `gen` object and keep the converted `GEN` on the PARI stack.  Ideally, `toGEN()` should either leave the temporary `GEN` in the Python heap (if it comes from an existing `gen` or from a `_pari_()` method) or on the PARI stack (if it is converted, withouth an intermediate `gen`, from a Python object without a `_pari_()` method).

Anyway, this idea is now defeated for the time being because of comment:18 and comment:20.  To implement it, we would need a more fine-grained way of clearing the PARI stack (only clear what you have used, and leave the rest of the stack alone).

Now working on a new patch in the spirit of comment:11.



---

archive/issue_comments_132034.json:
```json
{
    "body": "Attachment [trac_11868-t0GEN_new.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN_new.patch) by @pjbruin created at 2013-11-25 18:33:06\n\neliminate global GEN variables",
    "created_at": "2013-11-25T18:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132034",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_11868-t0GEN_new.patch](tarball://root/attachments/some-uuid/ticket11868/trac_11868-t0GEN_new.patch) by @pjbruin created at 2013-11-25 18:33:06

eliminate global GEN variables



---

archive/issue_comments_132035.json:
```json
{
    "body": "[attachment:trac_11868-t0GEN_new.patch] replaces [attachment:trac_11868-t0GEN.patch] and [attachment:trac_11868-get_nf.patch]\n\nApply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch",
    "created_at": "2013-11-25T18:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132035",
    "user": "https://github.com/pjbruin"
}
```

[attachment:trac_11868-t0GEN_new.patch] replaces [attachment:trac_11868-t0GEN.patch] and [attachment:trac_11868-get_nf.patch]

Apply trac_11868-t0GEN_new.patch, trac_11868-remove_workarounds.patch



---

archive/issue_comments_132036.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-11-25T18:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132036",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_132037.json:
```json
{
    "body": "I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.",
    "created_at": "2013-11-26T14:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132037",
    "user": "https://github.com/jdemeyer"
}
```

I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.



---

archive/issue_comments_132038.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.\nI will look at this more carefully later; just two questions for now:\n- What exactly is a dangerous `malloc()`?\n- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?",
    "created_at": "2013-11-26T14:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132038",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:26 jdemeyer]:
> I added some small changes, see [attachment:11868_pari_extra.patch]. It's not strictly a reviewer patch, since many changes are unrelated to this ticket but just small things I observed while checking your patch.
I will look at this more carefully later; just two questions for now:
- What exactly is a dangerous `malloc()`?
- In some places (e.g. `isprime()`), doing `P.clear_stack()` instead of `pari_catch_sig_off()` is clearly better because we call a PARI function returing a `GEN` that would otherwise be left on the stack.  In other cases (e.g. `ispseudoprime()`) we only call a PARI function returning `long`; is `clear_stack()` really necessary here?



---

archive/issue_comments_132039.json:
```json
{
    "body": "Replying to [comment:27 pbruin]:\n> - What exactly is a dangerous `malloc()`?\n`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.\n\n> is `clear_stack()` really necessary here?\nYou're right, it's not needed.\n\nI also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.",
    "created_at": "2013-11-26T15:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132039",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 pbruin]:
> - What exactly is a dangerous `malloc()`?
`malloc()` inside `sig_on()` is dangerous because an interrupt **during** `malloc()` will almost certainly corrupt the heap. `sage_malloc()` fixes this, but of course PARI doesn't know about `sage_malloc()`.

> is `clear_stack()` really necessary here?
You're right, it's not needed.

I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.



---

archive/issue_comments_132040.json:
```json
{
    "body": "Replying to [comment:28 jdemeyer]:\n> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.\n\nI changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.",
    "created_at": "2013-11-26T17:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132040",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 jdemeyer]:
> I also noticed that Cython seems unable to optimize `P(x)`, so it might be better to invent a `cdef` method for that (say, `P.togen(x)`) which can be more optimized.

I changed `P(x)` to `objtogen(x)` everywhere, where `objtogen` is a `cdef` function (not method). This gives a noticable speed gain.



---

archive/issue_comments_132041.json:
```json
{
    "body": "In `objtogen`, I also added an extra case for strings which should be faster now.",
    "created_at": "2013-11-26T17:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132041",
    "user": "https://github.com/jdemeyer"
}
```

In `objtogen`, I also added an extra case for strings which should be faster now.



---

archive/issue_comments_132042.json:
```json
{
    "body": "Your change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as\n\n```\nglobal Integer \nif Integer is None: \n    import sage.rings.integer \n    Integer = sage.rings.integer.Integer \n```\n",
    "created_at": "2013-11-26T22:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132042",
    "user": "https://github.com/pjbruin"
}
```

Your change to `__int__()` and `__long__()` gives a major slowdown due to the importing of `Integer` (a factor of more than 6 for small examples on my system).  The `late_import()` does look ugly; it may be slightly nicer to inline it in `__int__()` and `__long__()` as

```
global Integer 
if Integer is None: 
    import sage.rings.integer 
    Integer = sage.rings.integer.Integer 
```




---

archive/issue_comments_132043.json:
```json
{
    "body": "I agree with the rest of your extra changes.",
    "created_at": "2013-11-26T22:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132043",
    "user": "https://github.com/pjbruin"
}
```

I agree with the rest of your extra changes.



---

archive/issue_comments_132044.json:
```json
{
    "body": "For `__int__()`, I also experimented with first doing\n\n```python\n    cdef long i\n    try:\n        pari_catch_sig_on()\n        i = gtolong(self.g)\n        pari_catch_sig_off()\n        return i\n    except PariError:  # overflow\n        pass\n```\n\nThis gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.",
    "created_at": "2013-11-26T22:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132044",
    "user": "https://github.com/pjbruin"
}
```

For `__int__()`, I also experimented with first doing

```python
    cdef long i
    try:
        pari_catch_sig_on()
        i = gtolong(self.g)
        pari_catch_sig_off()
        return i
    except PariError:  # overflow
        pass
```

This gives a speedup of a factor about 2 if there is no overflow, but is very slow if the exception occurs.



---

archive/issue_comments_132045.json:
```json
{
    "body": "`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of\n\n```\n        global Integer\n        if Integer is None:\n            import sage.rings.integer\n            Integer = sage.rings.integer.Integer\n        return int(Integer(self))\n```\n\nand added two doctests for conversion `t_REAL` -> `int`",
    "created_at": "2013-11-27T16:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132045",
    "user": "https://github.com/jdemeyer"
}
```

`gtolong` doesn't check for overflow when converting from `t_REAL`. I used your proposal of

```
        global Integer
        if Integer is None:
            import sage.rings.integer
            Integer = sage.rings.integer.Integer
        return int(Integer(self))
```

and added two doctests for conversion `t_REAL` -> `int`



---

archive/issue_comments_132046.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> added two doctests for conversion `t_REAL` -> `int`\nThose doctests don't seem to involve PARI, or am I missing something?",
    "created_at": "2013-11-27T17:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132046",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:34 jdemeyer]:
> added two doctests for conversion `t_REAL` -> `int`
Those doctests don't seem to involve PARI, or am I missing something?



---

archive/issue_comments_132047.json:
```json
{
    "body": "Replying to [comment:35 pbruin]:\n> Those doctests don't seem to involve PARI, or am I missing something?\nYou're right, I fixed them.",
    "created_at": "2013-11-27T17:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132047",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:35 pbruin]:
> Those doctests don't seem to involve PARI, or am I missing something?
You're right, I fixed them.



---

archive/issue_comments_132048.json:
```json
{
    "body": "For the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.",
    "created_at": "2013-11-27T17:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132048",
    "user": "https://github.com/pjbruin"
}
```

For the conversion to `bool`, Cython translates `bool(x)` into a complicated call to the `bool` type.  Using `x != 0` or `PyBool_FromLong(x)` is more efficient.



---

archive/issue_comments_132049.json:
```json
{
    "body": "Added patch\n\n```diff\ndiff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx\n--- a/sage/libs/pari/gen.pyx\n+++ b/sage/libs/pari/gen.pyx\n@@ -1871,7 +1871,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal(a.g, t0.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal0(gen a):\n         r\"\"\"\n@@ -1893,7 +1893,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequal0(a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n \n     def gequal_long(gen a, long b):\n         r\"\"\"\n@@ -1920,7 +1920,7 @@\n         pari_catch_sig_on()\n         cdef int ret = gequalsg(b, a.g)\n         pari_catch_sig_off()\n-        return bool(ret)\n+        return ret != 0\n     \n \n     ###########################################\n@@ -1962,7 +1962,7 @@\n         pari_catch_sig_on()\n         cdef long t = signe(gisprime(self.g, flag))\n         P.clear_stack()\n-        return bool(t)\n+        return t != 0\n \n     def qfbhclassno(gen n):\n         r\"\"\"\n@@ -2041,7 +2041,7 @@\n         pari_catch_sig_on()\n         cdef long t = ispseudoprime(self.g, flag)\n         pari_catch_sig_off()\n-        return bool(t)\n+        return t != 0\n \n     def ispower(gen self, k=None):\n         r\"\"\"\n@@ -3209,9 +3209,9 @@\n             [True, False, True, True, True, True, True, True, True, True]\n         \"\"\"\n         pari_catch_sig_on()\n-        b = bool(bittest(x.g, n))\n+        cdef long b = bittest(x.g, n)\n         pari_catch_sig_off()\n-        return b\n+        return b != 0\n     \n     def bitxor(gen x, y):\n         \"\"\"\n@@ -5541,24 +5541,24 @@\n \n     def issquare(gen x, find_root=False):\n         \"\"\"\n-        issquare(x,n): true(1) if x is a square, false(0) if not. If\n-        find_root is given, also returns the exact square root if it was\n-        computed.\n-        \"\"\"\n-        cdef GEN G, t\n+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If\n+        ``find_root`` is given, also returns the exact square root.\n+        \"\"\"\n+        cdef GEN G\n+        cdef long t\n         cdef gen g\n         pari_catch_sig_on()\n         if find_root:\n-            t = gissquareall(x.g, &G)\n-            v = bool(P.new_gen_noclear(t))\n-            if v:\n-                return v, P.new_gen(G)\n+            t = itos(gissquareall(x.g, &G))\n+            if t:\n+                return True, P.new_gen(G)\n             else:\n-                pari_catch_sig_off()\n-                return v, None\n+                P.clear_stack()\n+                return False, None\n         else:\n-            return P.new_gen(gissquare(x.g))\n-\n+            t = itos(gissquare(x.g))\n+            pari_catch_sig_off()\n+            return t != 0\n \n     def issquarefree(gen self):\n         \"\"\"\n@@ -5570,9 +5570,9 @@\n             False\n         \"\"\"\n         pari_catch_sig_on()\n-        t = bool(issquarefree(self.g))\n+        cdef long t = issquarefree(self.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def lcm(gen x, y):\n         \"\"\"\n@@ -6203,9 +6203,9 @@\n         \"\"\"\n         cdef gen t0 = objtogen(x)\n         pari_catch_sig_on()\n-        t = bool(oncurve(self.g, t0.g) == 1)\n+        cdef int t = oncurve(self.g, t0.g)\n         pari_catch_sig_off()\n-        return t\n+        return t != 0\n \n     def elllocalred(self, p):\n         r\"\"\"\n@@ -8034,9 +8034,10 @@\n         non-constant polynomial, or False if f is reducible or constant.\n         \"\"\"\n         pari_catch_sig_on()\n-        return bool(self.new_gen(gisirreducible(self.g)))\n-        \n-        \n+        cdef long t = itos(gisirreducible(self.g))\n+        P.clear_stack()\n+        return t != 0\n+\n     def pollead(self, v=-1):\n         \"\"\"\n         self.pollead(v): leading coefficient of polynomial or series self,\n```\n",
    "created_at": "2013-11-27T20:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132049",
    "user": "https://github.com/jdemeyer"
}
```

Added patch

```diff
diff --git a/sage/libs/pari/gen.pyx b/sage/libs/pari/gen.pyx
--- a/sage/libs/pari/gen.pyx
+++ b/sage/libs/pari/gen.pyx
@@ -1871,7 +1871,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal(a.g, t0.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal0(gen a):
         r"""
@@ -1893,7 +1893,7 @@
         pari_catch_sig_on()
         cdef int ret = gequal0(a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
 
     def gequal_long(gen a, long b):
         r"""
@@ -1920,7 +1920,7 @@
         pari_catch_sig_on()
         cdef int ret = gequalsg(b, a.g)
         pari_catch_sig_off()
-        return bool(ret)
+        return ret != 0
     
 
     ###########################################
@@ -1962,7 +1962,7 @@
         pari_catch_sig_on()
         cdef long t = signe(gisprime(self.g, flag))
         P.clear_stack()
-        return bool(t)
+        return t != 0
 
     def qfbhclassno(gen n):
         r"""
@@ -2041,7 +2041,7 @@
         pari_catch_sig_on()
         cdef long t = ispseudoprime(self.g, flag)
         pari_catch_sig_off()
-        return bool(t)
+        return t != 0
 
     def ispower(gen self, k=None):
         r"""
@@ -3209,9 +3209,9 @@
             [True, False, True, True, True, True, True, True, True, True]
         """
         pari_catch_sig_on()
-        b = bool(bittest(x.g, n))
+        cdef long b = bittest(x.g, n)
         pari_catch_sig_off()
-        return b
+        return b != 0
     
     def bitxor(gen x, y):
         """
@@ -5541,24 +5541,24 @@
 
     def issquare(gen x, find_root=False):
         """
-        issquare(x,n): true(1) if x is a square, false(0) if not. If
-        find_root is given, also returns the exact square root if it was
-        computed.
-        """
-        cdef GEN G, t
+        issquare(x,n): ``True`` if x is a square, ``False`` if not. If
+        ``find_root`` is given, also returns the exact square root.
+        """
+        cdef GEN G
+        cdef long t
         cdef gen g
         pari_catch_sig_on()
         if find_root:
-            t = gissquareall(x.g, &G)
-            v = bool(P.new_gen_noclear(t))
-            if v:
-                return v, P.new_gen(G)
+            t = itos(gissquareall(x.g, &G))
+            if t:
+                return True, P.new_gen(G)
             else:
-                pari_catch_sig_off()
-                return v, None
+                P.clear_stack()
+                return False, None
         else:
-            return P.new_gen(gissquare(x.g))
-
+            t = itos(gissquare(x.g))
+            pari_catch_sig_off()
+            return t != 0
 
     def issquarefree(gen self):
         """
@@ -5570,9 +5570,9 @@
             False
         """
         pari_catch_sig_on()
-        t = bool(issquarefree(self.g))
+        cdef long t = issquarefree(self.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def lcm(gen x, y):
         """
@@ -6203,9 +6203,9 @@
         """
         cdef gen t0 = objtogen(x)
         pari_catch_sig_on()
-        t = bool(oncurve(self.g, t0.g) == 1)
+        cdef int t = oncurve(self.g, t0.g)
         pari_catch_sig_off()
-        return t
+        return t != 0
 
     def elllocalred(self, p):
         r"""
@@ -8034,9 +8034,10 @@
         non-constant polynomial, or False if f is reducible or constant.
         """
         pari_catch_sig_on()
-        return bool(self.new_gen(gisirreducible(self.g)))
-        
-        
+        cdef long t = itos(gisirreducible(self.g))
+        P.clear_stack()
+        return t != 0
+
     def pollead(self, v=-1):
         """
         self.pollead(v): leading coefficient of polynomial or series self,
```




---

archive/issue_comments_132050.json:
```json
{
    "body": "Attachment [11868_pari_extra.patch](tarball://root/attachments/some-uuid/ticket11868/11868_pari_extra.patch) by @pjbruin created at 2013-11-27 21:30:38\n\nExcellent, I'm happy with the current state.",
    "created_at": "2013-11-27T21:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132050",
    "user": "https://github.com/pjbruin"
}
```

Attachment [11868_pari_extra.patch](tarball://root/attachments/some-uuid/ticket11868/11868_pari_extra.patch) by @pjbruin created at 2013-11-27 21:30:38

Excellent, I'm happy with the current state.



---

archive/issue_comments_132051.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-11-27T21:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132051",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_031361.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-12-05T08:02:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11696#event-31361"
}
```



---

archive/issue_comments_132052.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-05T08:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11696",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11696#issuecomment-132052",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
