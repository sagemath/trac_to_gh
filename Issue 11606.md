# Issue 11606: p_iter_fork doesn't flush stdout properly

Issue created by migration from https://trac.sagemath.org/ticket/11778

Original creator: johanbosman

Original creation time: 2011-09-05 12:05:14

Assignee: tbd

Keywords: parallel fork stdout

The following code

```
from sage.parallel.use_fork import p_iter_fork

def f(n):
    print "Entering f with n=%s" % n 
    X = p_iter_fork(1, verbose=True)
    iter_result = X(g, [((n,), {})])
    result = list(iter_result)[0][1]
    print "Leaving f with n=%s" % n
    return result  # Which is just n
    
def g(n):
    print "Inside g with n=%s" % n
    return n
    
def test():
    X = p_iter_fork(2, verbose=True)
    inputs = [((n,), {}) for n in range(5)]
    iter_result = X(f, inputs)
    for n in iter_result:
        pass  

test()
```

gives this output (perhaps in a different order):

```
Entering f with n=1
Entering f with n=1
Inside g with n=1
Leaving f with n=1
Entering f with n=0
Entering f with n=0
Inside g with n=0
Leaving f with n=0
Entering f with n=2
Entering f with n=2
Inside g with n=2
Leaving f with n=2
Entering f with n=3
Entering f with n=3
Inside g with n=3
Leaving f with n=3
Entering f with n=4
Entering f with n=4
Inside g with n=4
Leaving f with n=4
```

The point is that stdout isn't flushed before the process is forked and therefore its contents are copied to the child process as well and thus lives in 2 processes.


---

Comment by johanbosman created at 2011-09-05 12:18:13

The attached patch fixes the problem, but it probably still needs a doctest.


---

Comment by leif created at 2011-09-05 12:32:38

How about `stderr`?


---

Comment by leif created at 2011-09-05 12:32:38

Changing component from PLEASE CHANGE to misc.


---

Comment by leif created at 2011-09-05 12:32:38

Changing status from new to needs_review.


---

Comment by leif created at 2011-09-05 12:39:44

In general I'd move the `flush`(s) out of the loop.


---

Comment by johanbosman created at 2011-09-05 12:52:10

Replying to [comment:4 leif]:
> In general I'd move the `flush`(s) out of the loop.
Okay. ;)


---

Attachment

And now stderr as well.


---

Comment by leif created at 2011-09-05 13:27:14

Replying to [comment:6 johanbosman]:
> And now stderr as well.

Sorry, not your problem here, but IMHO the output should also be flushed after every `print` statement (in verbose mode), e.g. when processes get killed.


---

Comment by leif created at 2011-09-05 13:28:07

Oh, actually not just verbose mode.


---

Comment by johanbosman created at 2011-09-05 15:01:10

Okay, so you're saying this stderr flush can be left out?  Flushing is time consuming so it'd be better to flush as little as possible.


---

Comment by leif created at 2011-09-05 15:04:25

Replying to [comment:9 johanbosman]:
> Okay, so you're saying this stderr flush can be left out?

No. The subprocesses shouldn't inherit an unflushed buffer.

I can add a reviewer patch for flushing the output of the `print` statements, unless you want to change your patch.


---

Comment by johanbosman created at 2011-09-05 15:06:16

Okay, go ahead; I don't want to change this patch. ;).


---

Comment by leif created at 2011-09-05 15:34:46

Sage library patch. Also flushs the output of further `print` statements in the parent process. Apply on top of Johan's patch.


---

Attachment

Replying to [comment:11 johanbosman]:
> Okay, go ahead; I don't want to change this patch. ;).

Gone.

If you're ok with my additional changes, we have a positive review.


---

Comment by johanbosman created at 2011-09-05 15:53:09

There's a typo (which was already there):
In "Killing subprocess %s with input %s which took too long" there should be a comma between the second %s and "which".

Okay, that was "mierenneuken" (you may want to look up that word); I'll have a more serious look it later on (don't have much time right now).


---

Comment by leif created at 2011-09-05 16:10:18

Replying to [comment:13 johanbosman]:
> There's a typo (which was already there):
> In "Killing subprocess %s with input %s which took too long" there should be a comma between the second %s and "which".

I'd say a comma there isn't absolutely necessary, but I should have added periods... (I saw that of course<sup>TM</sup> _after_ I had committed my changes.)

> Okay, that was "mierenneuken" (you may want to look up that word).

_"De pagina "mierenneuken" aanmaken op deze wiki."_

Guessing nit-picking.




> I'll have a more serious look it later on (don't have much time right now).

Go ahead... ;-)


---

Comment by johanbosman created at 2011-09-05 16:17:51

Replying to [comment:14 leif]:
> I'd say a comma there isn't absolutely necessary, but I should have added periods... (I saw that of course<sup>TM</sup> _after_ I had committed my changes.)
Have a look at http://en.wikipedia.org/wiki/Comma#Separation_of_clauses ;).


---

Comment by leif created at 2011-09-05 16:56:21

Replying to [comment:15 johanbosman]:
> Replying to [comment:14 leif]:
> > I'd say a comma there isn't absolutely necessary, but I should have added periods... (I saw that of course<sup>TM</sup> _after_ I had committed my changes.)
> Have a look at http://en.wikipedia.org/wiki/Comma#Separation_of_clauses ;).

Well, since "which" refers to a single subprocess, it is unambiguous.

(But you're in principle right, omitting the comma might be considered a bit sloppy, as the clause is non-restrictive from a _grammatical_ point of view. I'd say it _is_ restrictive, or constraining, from a logical point of view though, as the subprocess wouldn't have been killed in that situation otherwise, i.e. if it had not taken too long.)

We could also change "_which_ took too long" to "_because_ it took too long"... :)


---

Comment by johanbosman created at 2011-09-06 16:45:07

Changing status from needs_review to positive_review.


---

Comment by johanbosman created at 2011-09-06 16:45:07

Replying to [comment:12 leif]:
> Replying to [comment:11 johanbosman]:
> > Okay, go ahead; I don't want to change this patch. ;).
> 
> Gone.
> 
> If you're ok with my additional changes, we have a positive review.
I'm okay with it.  Let's not worry about the comma, which is mierenneuken anyway (the word is explained at http://en.wikipedia.org/wiki/Dutch_profanity) ;).


---

Comment by leif created at 2011-09-13 07:50:38

Resolution: fixed
