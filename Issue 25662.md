# Issue 25662: conversion of fricas sums and products

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2018-07-22 17:10:09

CC:  rws chapoton




---

Comment by mantepse created at 2018-07-27 21:03:05

Changing keywords from "" to "FriCAS".


---

Comment by mantepse created at 2018-07-27 21:03:05

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2018-07-27 21:03:05

New commits:


---

Comment by mantepse created at 2018-07-27 21:03:05

Changing component from PLEASE CHANGE to interfaces: optional.


---

Comment by git created at 2018-08-09 11:54:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-01-25 07:48:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-03 18:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-03 18:53:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2019-02-03 18:55:55

Changing status from new to needs_review.


---

Comment by tscrim created at 2019-02-05 04:02:30

Couple of small comments and nitpicks:

- It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.
- Doc formatting:
  {{{
        Parse and evaluate the string.

        INPUT:

        - ``s`` -- a string
        - ``start`` -- integer; specifies where to start parsing

        OUTPUT:

        - a pair ``(L, end)``, where ``L`` is the parsed list and
          ``end`` is the position of the last parsed letter
  }}}
- Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.
- Newline here in `_parse_other`: `"""Symbols and numbers must not contain`
- Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?
- This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.
- Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.


---

Comment by mantepse created at 2019-02-05 11:34:00

Replying to [comment:9 tscrim]:

> - It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.

done, I tried to make it more readable, too.

> - Doc formatting:

done! (and improved a bit)

> - Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.

either a patchbot does it, or I will do it once the other issues are settled.

> - Newline here in `_parse_other`: `"""Symbols and numbers must not contain`

done

> - Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?

yes.  I also tried to `lazy_import` in `interfaces/all.py`, but that gives

```
sage -t src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 794, in sage.interfaces.fricas.FriCAS.__reduce__
Failed example:
    fricas.__reduce__()                                           # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCAS.__reduce__[0]>", line 1, in <module>
        fricas.__reduce__()                                           # optional - fricas
      File "/home/martin/sage-develop/local/lib/python2.7/copy_reg.py", line 70, in _reduce_ex
        raise TypeError, "can't pickle %s objects" % base.__name__
    TypeError: can't pickle LazyImport objects
```


Help very much appreciated!

> - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.

`ZZ(e)` doesn't work, it gives


```
sage: FriCASElement._parse_other("0123 xyz")
/home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0
If you do not want this number to be interpreted as octal, remove the leading zeros.
See http://trac.sagemath.org/17413 for details.
  #!/usr/bin/env sage-python23
(83, 3)
```



> - Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.

done!


---

Comment by git created at 2019-02-05 11:35:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-05 13:19:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2019-02-05 13:22:02

I managed to fix the import problem! I probably misunderstood your hint: the solution was to 

```
lazy_import('sage.libs.pynac.pynac', ['symbol_table'])
lazy_import('sage.calculus.var', ['var', 'function'])
```

rather than lazily importing `fricas`.

Thanks!


---

Comment by tscrim created at 2019-02-05 13:31:08

Replying to [comment:10 mantepse]:
> Replying to [comment:9 tscrim]:
> > - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.
> 
> `ZZ(e)` doesn't work, it gives
> 
> {{{
> sage: FriCASElement._parse_other("0123 xyz")
> /home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0
> If you do not want this number to be interpreted as octal, remove the leading zeros.
> See http://trac.sagemath.org/17413 for details.
>   #!/usr/bin/env sage-python23
> (83, 3)
> }}}

This will be a problem when we switch to python3:

```
>>> int(0123)
  File "<stdin>", line 1
    int(0123)
           ^
SyntaxError: invalid token
>>> int('029')  # not treated as a octal
29
```


```
sage: ZZ('0o27')
23
sage: ZZ('0o29')
TypeError: unable to convert '0o29' to an integer
```

So it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).


---

Comment by tscrim created at 2019-02-05 13:31:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-02-05 16:38:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2019-02-05 17:14:22

Changing status from needs_work to needs_review.


---

Comment by mantepse created at 2019-02-06 09:41:52

I just realised the following was never sent...

Replying to [comment:14 tscrim]:

> So it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).

I think it's best to trust that FriCAS doesn't actually output leading zeros.  I only allowed them, because I know that FriCAS allows them as input.

I also added better documentation and tests.


---

Comment by tscrim created at 2019-02-06 21:05:09

Okay. Then positive review.


---

Comment by tscrim created at 2019-02-06 21:05:09

Changing status from needs_review to positive_review.


---

Comment by mantepse created at 2019-02-06 21:09:17

Thank you!


---

Comment by vbraun created at 2019-02-08 23:21:49

Resolution: fixed
