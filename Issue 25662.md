# Issue 25662: conversion of fricas sums and products

archive/issues_025662.json:
```json
{
    "body": "CC:  @rwst @fchapoton\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25899\n\n",
    "created_at": "2018-07-22T17:10:09Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "conversion of fricas sums and products",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25662",
    "user": "@mantepse"
}
```
CC:  @rwst @fchapoton



Issue created by migration from https://trac.sagemath.org/ticket/25899





---

archive/issue_comments_361930.json:
```json
{
    "body": "Changing keywords from \"\" to \"FriCAS\".",
    "created_at": "2018-07-27T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361930",
    "user": "@mantepse"
}
```

Changing keywords from "" to "FriCAS".



---

archive/issue_comments_361931.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-07-27T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361931",
    "user": "@mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_361932.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-27T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361932",
    "user": "@mantepse"
}
```

New commits:



---

archive/issue_comments_361933.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to interfaces: optional.",
    "created_at": "2018-07-27T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361933",
    "user": "@mantepse"
}
```

Changing component from PLEASE CHANGE to interfaces: optional.



---

archive/issue_comments_361934.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-09T11:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361934",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361935.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-25T07:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361935",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361936.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-03T18:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361936",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361937.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-03T18:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361937",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361938.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-03T18:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361938",
    "user": "@mantepse"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_361939.json:
```json
{
    "body": "Couple of small comments and nitpicks:\n\n- It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.\n- Doc formatting:\n  {{{\n        Parse and evaluate the string.\n\n        INPUT:\n\n        - ``s`` -- a string\n        - ``start`` -- integer; specifies where to start parsing\n\n        OUTPUT:\n\n        - a pair ``(L, end)``, where ``L`` is the parsed list and\n          ``end`` is the position of the last parsed letter\n  }}}\n- Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.\n- Newline here in `_parse_other`: `\"\"\"Symbols and numbers must not contain`\n- Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?\n- This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.\n- Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.",
    "created_at": "2019-02-05T04:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361939",
    "user": "@tscrim"
}
```

Couple of small comments and nitpicks:

- It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.
- Doc formatting:
  {{{
        Parse and evaluate the string.

        INPUT:

        - ``s`` -- a string
        - ``start`` -- integer; specifies where to start parsing

        OUTPUT:

        - a pair ``(L, end)``, where ``L`` is the parsed list and
          ``end`` is the position of the last parsed letter
  }}}
- Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.
- Newline here in `_parse_other`: `"""Symbols and numbers must not contain`
- Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?
- This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.
- Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.



---

archive/issue_comments_361940.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n\n> - It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.\n\ndone, I tried to make it more readable, too.\n\n> - Doc formatting:\n\ndone! (and improved a bit)\n\n> - Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.\n\neither a patchbot does it, or I will do it once the other issues are settled.\n\n> - Newline here in `_parse_other`: `\"\"\"Symbols and numbers must not contain`\n\ndone\n\n> - Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?\n\nyes.  I also tried to `lazy_import` in `interfaces/all.py`, but that gives\n\n```\nsage -t src/sage/interfaces/fricas.py\n**********************************************************************\nFile \"src/sage/interfaces/fricas.py\", line 794, in sage.interfaces.fricas.FriCAS.__reduce__\nFailed example:\n    fricas.__reduce__()                                           # optional - fricas\nException raised:\n    Traceback (most recent call last):\n      File \"/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.fricas.FriCAS.__reduce__[0]>\", line 1, in <module>\n        fricas.__reduce__()                                           # optional - fricas\n      File \"/home/martin/sage-develop/local/lib/python2.7/copy_reg.py\", line 70, in _reduce_ex\n        raise TypeError, \"can't pickle %s objects\" % base.__name__\n    TypeError: can't pickle LazyImport objects\n```\n\n\nHelp very much appreciated!\n\n> - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.\n\n`ZZ(e)` doesn't work, it gives\n\n\n```\nsage: FriCASElement._parse_other(\"0123 xyz\")\n/home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0\nIf you do not want this number to be interpreted as octal, remove the leading zeros.\nSee http://trac.sagemath.org/17413 for details.\n  #!/usr/bin/env sage-python23\n(83, 3)\n```\n\n\n\n> - Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.\n\ndone!",
    "created_at": "2019-02-05T11:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361940",
    "user": "@mantepse"
}
```

Replying to [comment:9 tscrim]:

> - It would be good to break the string after the `FRICAS_HELPER_CODE = (` line to <= ~80chars/line.

done, I tried to make it more readable, too.

> - Doc formatting:

done! (and improved a bit)

> - Did you run the tests on an install that does not have `fricas` installed? In particular, this would catch tests that need the `# optional - fricas`.

either a patchbot does it, or I will do it once the other issues are settled.

> - Newline here in `_parse_other`: `"""Symbols and numbers must not contain`

done

> - Do you get an import loop for all of those in `_parse_other`? (I might also avoiding from `rings.all` and be more specific about which file.) What about doing a `lazy_import`?

yes.  I also tried to `lazy_import` in `interfaces/all.py`, but that gives

```
sage -t src/sage/interfaces/fricas.py
**********************************************************************
File "src/sage/interfaces/fricas.py", line 794, in sage.interfaces.fricas.FriCAS.__reduce__
Failed example:
    fricas.__reduce__()                                           # optional - fricas
Exception raised:
    Traceback (most recent call last):
      File "/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/martin/sage-develop/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.fricas.FriCAS.__reduce__[0]>", line 1, in <module>
        fricas.__reduce__()                                           # optional - fricas
      File "/home/martin/sage-develop/local/lib/python2.7/copy_reg.py", line 70, in _reduce_ex
        raise TypeError, "can't pickle %s objects" % base.__name__
    TypeError: can't pickle LazyImport objects
```


Help very much appreciated!

> - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.

`ZZ(e)` doesn't work, it gives


```
sage: FriCASElement._parse_other("0123 xyz")
/home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0
If you do not want this number to be interpreted as octal, remove the leading zeros.
See http://trac.sagemath.org/17413 for details.
  #!/usr/bin/env sage-python23
(83, 3)
```



> - Could we change the `NotImplementedError` message to start with a lowercase letter and not end with a period? This is a python (and hence Sage) convention.

done!



---

archive/issue_comments_361941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-05T11:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361941",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361942.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-05T13:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361942",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361943.json:
```json
{
    "body": "I managed to fix the import problem! I probably misunderstood your hint: the solution was to \n\n```\nlazy_import('sage.libs.pynac.pynac', ['symbol_table'])\nlazy_import('sage.calculus.var', ['var', 'function'])\n```\n\nrather than lazily importing `fricas`.\n\nThanks!",
    "created_at": "2019-02-05T13:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361943",
    "user": "@mantepse"
}
```

I managed to fix the import problem! I probably misunderstood your hint: the solution was to 

```
lazy_import('sage.libs.pynac.pynac', ['symbol_table'])
lazy_import('sage.calculus.var', ['var', 'function'])
```

rather than lazily importing `fricas`.

Thanks!



---

archive/issue_comments_361944.json:
```json
{
    "body": "Replying to [comment:10 mantepse]:\n> Replying to [comment:9 tscrim]:\n> > - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.\n> \n> `ZZ(e)` doesn't work, it gives\n> \n> {{{\n> sage: FriCASElement._parse_other(\"0123 xyz\")\n> /home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0\n> If you do not want this number to be interpreted as octal, remove the leading zeros.\n> See http://trac.sagemath.org/17413 for details.\n>   #!/usr/bin/env sage-python23\n> (83, 3)\n> }}}\n\nThis will be a problem when we switch to python3:\n\n```\n>>> int(0123)\n  File \"<stdin>\", line 1\n    int(0123)\n           ^\nSyntaxError: invalid token\n>>> int('029')  # not treated as a octal\n29\n```\n\n\n```\nsage: ZZ('0o27')\n23\nsage: ZZ('0o29')\nTypeError: unable to convert '0o29' to an integer\n```\n\nSo it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).",
    "created_at": "2019-02-05T13:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361944",
    "user": "@tscrim"
}
```

Replying to [comment:10 mantepse]:
> Replying to [comment:9 tscrim]:
> > - This seems like overkill: `ZZ(int(e))` as `ZZ(e)` should be sufficient.
> 
> `ZZ(e)` doesn't work, it gives
> 
> {{{
> sage: FriCASElement._parse_other("0123 xyz")
> /home/martin/sage-develop/src/bin/sage-ipython:1: DeprecationWarning: use 0o as octal prefix instead of 0
> If you do not want this number to be interpreted as octal, remove the leading zeros.
> See http://trac.sagemath.org/17413 for details.
>   #!/usr/bin/env sage-python23
> (83, 3)
> }}}

This will be a problem when we switch to python3:

```
>>> int(0123)
  File "<stdin>", line 1
    int(0123)
           ^
SyntaxError: invalid token
>>> int('029')  # not treated as a octal
29
```


```
sage: ZZ('0o27')
23
sage: ZZ('0o29')
TypeError: unable to convert '0o29' to an integer
```

So it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).



---

archive/issue_comments_361945.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-05T13:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361945",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_361946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-05T16:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361946",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_361947.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-05T17:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361947",
    "user": "@mantepse"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_361948.json:
```json
{
    "body": "I just realised the following was never sent...\n\nReplying to [comment:14 tscrim]:\n\n> So it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).\n\nI think it's best to trust that FriCAS doesn't actually output leading zeros.  I only allowed them, because I know that FriCAS allows them as input.\n\nI also added better documentation and tests.",
    "created_at": "2019-02-06T09:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361948",
    "user": "@mantepse"
}
```

I just realised the following was never sent...

Replying to [comment:14 tscrim]:

> So it eventually needs to be fixed one way or the other. Thus I think we should fix it properly here. When parsing numbers, you will need to check for leading `0` and change it to `0o` (or strip them if it should not be interpreted as a octal).

I think it's best to trust that FriCAS doesn't actually output leading zeros.  I only allowed them, because I know that FriCAS allows them as input.

I also added better documentation and tests.



---

archive/issue_comments_361949.json:
```json
{
    "body": "Okay. Then positive review.",
    "created_at": "2019-02-06T21:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361949",
    "user": "@tscrim"
}
```

Okay. Then positive review.



---

archive/issue_comments_361950.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-06T21:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361950",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_361951.json:
```json
{
    "body": "Thank you!",
    "created_at": "2019-02-06T21:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361951",
    "user": "@mantepse"
}
```

Thank you!



---

archive/issue_comments_361952.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-08T23:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25662",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25662#issuecomment-361952",
    "user": "@vbraun"
}
```

Resolution: fixed
