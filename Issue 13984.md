# Issue 13984: IPython 0.13: merge user configuration with Sage configuration

archive/issues_013984.json:
```json
{
    "body": "Assignee: jason\n\nCC:  vbraun jason\n\nKeywords: IPython config\n\nAfter #12719, user configuration files (in `.sage/ipython-0.12/profile_default/` and `.../profile_sage/`) seem to be effectively ignored: I think they are read after the Sage terminal app has already been initialized, at which point it is too late. \n\nThe attached patch remedies this, reading the configuration from `.sage/ipython-0.12/profile_default/ipython_config.py` during the initialization. Question: should it read from this directory or from `profile_sage`?\n\nIssue created by migration from https://trac.sagemath.org/ticket/14188\n\n",
    "created_at": "2013-02-26T18:28:16Z",
    "labels": [
        "misc",
        "minor",
        "enhancement"
    ],
    "title": "IPython 0.13: merge user configuration with Sage configuration",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13984",
    "user": "jhpalmieri"
}
```
Assignee: jason

CC:  vbraun jason

Keywords: IPython config

After #12719, user configuration files (in `.sage/ipython-0.12/profile_default/` and `.../profile_sage/`) seem to be effectively ignored: I think they are read after the Sage terminal app has already been initialized, at which point it is too late. 

The attached patch remedies this, reading the configuration from `.sage/ipython-0.12/profile_default/ipython_config.py` during the initialization. Question: should it read from this directory or from `profile_sage`?

Issue created by migration from https://trac.sagemath.org/ticket/14188





---

archive/issue_comments_174587.json:
```json
{
    "body": "It should read from `/profile_sage/ipython_config.py` for sure.",
    "created_at": "2013-02-26T18:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174587",
    "user": "vbraun"
}
```

It should read from `/profile_sage/ipython_config.py` for sure.



---

archive/issue_comments_174588.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-26T18:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174588",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_174589.json:
```json
{
    "body": "Here's a new version which reads from `profile_sage`.",
    "created_at": "2013-02-26T19:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174589",
    "user": "jhpalmieri"
}
```

Here's a new version which reads from `profile_sage`.



---

archive/issue_comments_174590.json:
```json
{
    "body": "Reworked patch",
    "created_at": "2013-02-26T23:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174590",
    "user": "vbraun"
}
```

Reworked patch



---

archive/issue_comments_174591.json:
```json
{
    "body": "Attachment [trac_14188_vb.patch](tarball://root/attachments/some-uuid/ticket14188/trac_14188_vb.patch) by vbraun created at 2013-02-26 23:15:49\n\nI changed your code to override `load_config_file()` instead of stuffing it in the ctor. Now the configuration is only loaded once, as one can easily check by putting a print statement into `ipython_config.py`. \n\nAlso, after discussion with Jason and William we decided to default to colors in the terminal. For simplicity I just added this into this patch.",
    "created_at": "2013-02-26T23:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174591",
    "user": "vbraun"
}
```

Attachment [trac_14188_vb.patch](tarball://root/attachments/some-uuid/ticket14188/trac_14188_vb.patch) by vbraun created at 2013-02-26 23:15:49

I changed your code to override `load_config_file()` instead of stuffing it in the ctor. Now the configuration is only loaded once, as one can easily check by putting a print statement into `ipython_config.py`. 

Also, after discussion with Jason and William we decided to default to colors in the terminal. For simplicity I just added this into this patch.



---

archive/issue_comments_174592.json:
```json
{
    "body": "And I agree with your changes, of course. Feel free to set it to positive review if you are happy with it.",
    "created_at": "2013-02-26T23:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174592",
    "user": "vbraun"
}
```

And I agree with your changes, of course. Feel free to set it to positive review if you are happy with it.



---

archive/issue_comments_174593.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-26T23:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174593",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_174594.json:
```json
{
    "body": "Apply trac_14188_vb.patch",
    "created_at": "2013-02-27T01:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174594",
    "user": "klee"
}
```

Apply trac_14188_vb.patch



---

archive/issue_comments_174595.json:
```json
{
    "body": "And IPython is of course **not** smart enough to turn off colors when the output is a pipe, thanks a bunch. The second patch is the one-line fix to do it by hand.",
    "created_at": "2013-02-27T09:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174595",
    "user": "vbraun"
}
```

And IPython is of course **not** smart enough to turn off colors when the output is a pipe, thanks a bunch. The second patch is the one-line fix to do it by hand.



---

archive/issue_comments_174596.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-02-27T12:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174596",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_174597.json:
```json
{
    "body": "Second patch needs review.",
    "created_at": "2013-02-27T12:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174597",
    "user": "jdemeyer"
}
```

Second patch needs review.



---

archive/issue_comments_174598.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-27T12:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174598",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_174599.json:
```json
{
    "body": "If someone customizes their IPython configuration, this can cause doctests to fail (for example, if you turn on an output prompt like \"Out[1]:\", interfaces/sage0.py fails). I think this is okay, but I'm going to post at #12415 about it.",
    "created_at": "2013-02-27T16:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174599",
    "user": "jhpalmieri"
}
```

If someone customizes their IPython configuration, this can cause doctests to fail (for example, if you turn on an output prompt like "Out[1]:", interfaces/sage0.py fails). I think this is okay, but I'm going to post at #12415 about it.



---

archive/issue_comments_174600.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-27T18:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174600",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_174601.json:
```json
{
    "body": "All tests passed.",
    "created_at": "2013-02-27T18:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174601",
    "user": "jhpalmieri"
}
```

All tests passed.



---

archive/issue_comments_174602.json:
```json
{
    "body": "I see doctest failures on OS X 10.6: [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio)",
    "created_at": "2013-02-27T19:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174602",
    "user": "jdemeyer"
}
```

I see doctest failures on OS X 10.6: [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio)



---

archive/issue_comments_174603.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-02-27T19:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174603",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_174604.json:
```json
{
    "body": "Same problem on lena (Fedora 16 x86_64): [http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio)",
    "created_at": "2013-02-27T21:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174604",
    "user": "jdemeyer"
}
```

Same problem on lena (Fedora 16 x86_64): [http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio)



---

archive/issue_comments_174605.json:
```json
{
    "body": "I see this on bsd.math.washington.edu (OS X 10.6), but I have no problems on lena.",
    "created_at": "2013-02-28T15:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174605",
    "user": "jhpalmieri"
}
```

I see this on bsd.math.washington.edu (OS X 10.6), but I have no problems on lena.



---

archive/issue_comments_174606.json:
```json
{
    "body": "A typical failure on OS X 10.6:\n\n```\n    sage: subsage = Sage()\n    sage: s = ZZ(subsage('initial_seed()'))\n    <boom>\n```\n\nIt looks like when running Sage as a subprocess on this platform, `sys.stdout.isatty()` returns `True`, even while doctesting. How else can we detect this situation?",
    "created_at": "2013-02-28T18:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174606",
    "user": "jhpalmieri"
}
```

A typical failure on OS X 10.6:

```
    sage: subsage = Sage()
    sage: s = ZZ(subsage('initial_seed()'))
    <boom>
```

It looks like when running Sage as a subprocess on this platform, `sys.stdout.isatty()` returns `True`, even while doctesting. How else can we detect this situation?



---

archive/issue_comments_174607.json:
```json
{
    "body": "Pexpect runs in a pty, so on any platform isatty() will return true. This is why we explicitly disable colors when starting a sage-in-sage session. My current theory is that the pty gets messed up somehow by the ansi codes since we disable colors by sending `%colors NoColor`, so at least one colored prompt will be displayed. I'm currently trying if disabling color via command line switch works...",
    "created_at": "2013-02-28T19:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174607",
    "user": "vbraun"
}
```

Pexpect runs in a pty, so on any platform isatty() will return true. This is why we explicitly disable colors when starting a sage-in-sage session. My current theory is that the pty gets messed up somehow by the ansi codes since we disable colors by sending `%colors NoColor`, so at least one colored prompt will be displayed. I'm currently trying if disabling color via command line switch works...



---

archive/issue_comments_174608.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> How else can we detect this situation?\npexpect children have the environment variable `TERM` unset (#12221, similar: #12263). We did this precisely to solve problems like this where the terminal did strange things.\n\n\n```\nsage: \"TERM\" in os.environ\nTrue\nsage: sage0('\"TERM\" in os.environ')\nFalse\n```\n",
    "created_at": "2013-02-28T19:32:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174608",
    "user": "jdemeyer"
}
```

Replying to [comment:16 jhpalmieri]:
> How else can we detect this situation?
pexpect children have the environment variable `TERM` unset (#12221, similar: #12263). We did this precisely to solve problems like this where the terminal did strange things.


```
sage: "TERM" in os.environ
True
sage: sage0('"TERM" in os.environ')
False
```




---

archive/issue_comments_174609.json:
```json
{
    "body": "A change like this fixes the failures on bsd.math.washington.edu. I haven't run a full test suite yet.\n\n```diff\ndiff --git a/sage/misc/interpreter.py b/sage/misc/interpreter.py\n--- a/sage/misc/interpreter.py\n+++ b/sage/misc/interpreter.py\n@@ -660,7 +660,7 @@\n         verbose_crash = True),\n     TerminalInteractiveShell = Config(\n         ast_node_interactivity = 'all',\n-        colors = 'LightBG' if sys.stdout.isatty() else 'NoColor',\n+        colors = 'LightBG' if (sys.stdout.isatty() and 'TERM' in os.environ) else 'NoColor',\n         confirm_exit = False,\n         separate_in = ''),\n     # The extension is *always* loaded for SageTerminalApp\n```\n",
    "created_at": "2013-02-28T19:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174609",
    "user": "jhpalmieri"
}
```

A change like this fixes the failures on bsd.math.washington.edu. I haven't run a full test suite yet.

```diff
diff --git a/sage/misc/interpreter.py b/sage/misc/interpreter.py
--- a/sage/misc/interpreter.py
+++ b/sage/misc/interpreter.py
@@ -660,7 +660,7 @@
         verbose_crash = True),
     TerminalInteractiveShell = Config(
         ast_node_interactivity = 'all',
-        colors = 'LightBG' if sys.stdout.isatty() else 'NoColor',
+        colors = 'LightBG' if (sys.stdout.isatty() and 'TERM' in os.environ) else 'NoColor',
         confirm_exit = False,
         separate_in = ''),
     # The extension is *always* loaded for SageTerminalApp
```




---

archive/issue_comments_174610.json:
```json
{
    "body": "Attachment [trac_14188_docfix.patch](tarball://root/attachments/some-uuid/ticket14188/trac_14188_docfix.patch) by vbraun created at 2013-02-28 19:55:31\n\nImproved patch",
    "created_at": "2013-02-28T19:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174610",
    "user": "vbraun"
}
```

Attachment [trac_14188_docfix.patch](tarball://root/attachments/some-uuid/ticket14188/trac_14188_docfix.patch) by vbraun created at 2013-02-28 19:55:31

Improved patch



---

archive/issue_comments_174611.json:
```json
{
    "body": "I'd rather always turn off colors in the sage<->sage interface than rely on the `TERM` variable. The updated patch fixes sage0 on OSX (bsd.math) for me.",
    "created_at": "2013-02-28T19:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174611",
    "user": "vbraun"
}
```

I'd rather always turn off colors in the sage<->sage interface than rely on the `TERM` variable. The updated patch fixes sage0 on OSX (bsd.math) for me.



---

archive/issue_comments_174612.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-28T22:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174612",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_174613.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-01T00:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174613",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_174614.json:
```json
{
    "body": "This passes tests for me on bsd.",
    "created_at": "2013-03-01T00:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174614",
    "user": "jhpalmieri"
}
```

This passes tests for me on bsd.



---

archive/issue_comments_174615.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-03-04T07:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13984",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13984#issuecomment-174615",
    "user": "jdemeyer"
}
```

Resolution: fixed
