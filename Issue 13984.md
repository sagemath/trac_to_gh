# Issue 13984: IPython 0.13: merge user configuration with Sage configuration

Issue created by migration from https://trac.sagemath.org/ticket/14188

Original creator: jhpalmieri

Original creation time: 2013-02-26 18:28:16

Assignee: jason

CC:  vbraun jason

Keywords: IPython config

After #12719, user configuration files (in `.sage/ipython-0.12/profile_default/` and `.../profile_sage/`) seem to be effectively ignored: I think they are read after the Sage terminal app has already been initialized, at which point it is too late. 

The attached patch remedies this, reading the configuration from `.sage/ipython-0.12/profile_default/ipython_config.py` during the initialization. Question: should it read from this directory or from `profile_sage`?


---

Comment by vbraun created at 2013-02-26 18:29:30

It should read from `/profile_sage/ipython_config.py` for sure.


---

Comment by jhpalmieri created at 2013-02-26 18:30:16

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2013-02-26 19:01:50

Here's a new version which reads from `profile_sage`.


---

Comment by vbraun created at 2013-02-26 23:13:13

Reworked patch


---

Attachment

I changed your code to override `load_config_file()` instead of stuffing it in the ctor. Now the configuration is only loaded once, as one can easily check by putting a print statement into `ipython_config.py`. 

Also, after discussion with Jason and William we decided to default to colors in the terminal. For simplicity I just added this into this patch.


---

Comment by vbraun created at 2013-02-26 23:17:14

And I agree with your changes, of course. Feel free to set it to positive review if you are happy with it.


---

Comment by jhpalmieri created at 2013-02-26 23:57:18

Changing status from needs_review to positive_review.


---

Comment by klee created at 2013-02-27 01:03:51

Apply trac_14188_vb.patch


---

Comment by vbraun created at 2013-02-27 09:37:55

And IPython is of course **not** smart enough to turn off colors when the output is a pipe, thanks a bunch. The second patch is the one-line fix to do it by hand.


---

Comment by jdemeyer created at 2013-02-27 12:50:11

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-02-27 12:50:36

Second patch needs review.


---

Comment by jdemeyer created at 2013-02-27 12:50:36

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-02-27 16:27:26

If someone customizes their IPython configuration, this can cause doctests to fail (for example, if you turn on an output prompt like "Out[1]:", interfaces/sage0.py fails). I think this is okay, but I'm going to post at #12415 about it.


---

Comment by jhpalmieri created at 2013-02-27 18:13:25

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2013-02-27 18:13:25

All tests passed.


---

Comment by jdemeyer created at 2013-02-27 19:07:33

I see doctest failures on OS X 10.6: [http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio](http://build.sagemath.org/sage/builders/UW%20bsd%20%28OSX%2010.6%20x86_64%29/builds/214/steps/shell_8/logs/stdio)


---

Comment by jdemeyer created at 2013-02-27 19:07:33

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-02-27 21:35:48

Same problem on lena (Fedora 16 x86_64): [http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio](http://build.sagemath.org/sage/builders/Skynet%20lena%20%28Fedora%2016%20x86_64%29/builds/113/steps/shell_7/logs/stdio)


---

Comment by jhpalmieri created at 2013-02-28 15:45:01

I see this on bsd.math.washington.edu (OS X 10.6), but I have no problems on lena.


---

Comment by jhpalmieri created at 2013-02-28 18:39:37

A typical failure on OS X 10.6:

```
    sage: subsage = Sage()
    sage: s = ZZ(subsage('initial_seed()'))
    <boom>
```

It looks like when running Sage as a subprocess on this platform, `sys.stdout.isatty()` returns `True`, even while doctesting. How else can we detect this situation?


---

Comment by vbraun created at 2013-02-28 19:00:34

Pexpect runs in a pty, so on any platform isatty() will return true. This is why we explicitly disable colors when starting a sage-in-sage session. My current theory is that the pty gets messed up somehow by the ansi codes since we disable colors by sending `%colors NoColor`, so at least one colored prompt will be displayed. I'm currently trying if disabling color via command line switch works...


---

Comment by jdemeyer created at 2013-02-28 19:32:45

Replying to [comment:16 jhpalmieri]:
> How else can we detect this situation?
pexpect children have the environment variable `TERM` unset (#12221, similar: #12263). We did this precisely to solve problems like this where the terminal did strange things.


```
sage: "TERM" in os.environ
True
sage: sage0('"TERM" in os.environ')
False
```



---

Comment by jhpalmieri created at 2013-02-28 19:47:26

A change like this fixes the failures on bsd.math.washington.edu. I haven't run a full test suite yet.

```diff
diff --git a/sage/misc/interpreter.py b/sage/misc/interpreter.py
--- a/sage/misc/interpreter.py
+++ b/sage/misc/interpreter.py
@@ -660,7 +660,7 @@
         verbose_crash = True),
     TerminalInteractiveShell = Config(
         ast_node_interactivity = 'all',
-        colors = 'LightBG' if sys.stdout.isatty() else 'NoColor',
+        colors = 'LightBG' if (sys.stdout.isatty() and 'TERM' in os.environ) else 'NoColor',
         confirm_exit = False,
         separate_in = ''),
     # The extension is *always* loaded for SageTerminalApp
```



---

Attachment

Improved patch


---

Comment by vbraun created at 2013-02-28 19:57:51

I'd rather always turn off colors in the sage<->sage interface than rely on the `TERM` variable. The updated patch fixes sage0 on OSX (bsd.math) for me.


---

Comment by vbraun created at 2013-02-28 22:04:51

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-03-01 00:16:42

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2013-03-01 00:16:42

This passes tests for me on bsd.


---

Comment by jdemeyer created at 2013-03-04 07:38:48

Resolution: fixed
