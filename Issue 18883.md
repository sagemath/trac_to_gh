# Issue 18883: efficient algorithm to compute continued fraction of a sum of continued fractions

Issue created by migration from Trac.

Original creator: sstarosta

Original creation time: 2015-09-01 12:03:07

Assignee: sstarosta

CC:  vdelecroix sstarosta

Keywords: continued fractions

knowing continued fractions of x and y, compute the continued fraction of x+y

(overlaps with the following TODO item of sage/rings/continued_fraction.py:
Add Gosper’s algorithm to compute the continued fraction of (ax + b)/(cx + d) knowing the one of x (see Gosper (1972, http://www.inwap.com/pdp10/hbaker/hakmem/cf.html), Knuth (1998, TAOCP vol 2, Exercise 4.5.3.15), Fowler (1999). See also Liardet, P. and Stambul, P. “Algebraic Computation with Continued Fractions.” J. Number Th. 73, 92-121, 1998.)


---

Comment by git created at 2016-04-29 09:39:40

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2016-04-29 11:07:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-04-29 18:11:48

Hello,

Some remarks:

1. You would better edit the description of this ticket to explain what you want to do.

2. Your branch does not merge cleanly with the last beta. The reason is that you added a line in `lazy_list.pyx`: `from sage.rings.all import Infinity`. It is always better to base your work on the latest available version of the source code. You can consult the [developer manual](http://doc.sagemath.org/html/en/developer/manual_git.html).

3. The commit message should reflect what is inside the commit. Not your mood at the time you did the commit.

4. The file with gosper algorithm should not be in `sage/misc/`. Put it in the same directory as `continued_fraction.py`. And you would better call it `continued_fraction_gosper.py`.

5. In `continued_fraction.py` you added the following in the comparison code

```diff
`@``@` -530,6 +530,8 `@``@` class ContinuedFraction_base(SageObject):
             if a == ZZ_0 and b == ZZ_0 and i:  # rational case
                 return 0
             i += 1
+            if i == 300:
+                return 0
```

  I understand why you did it but it is definitely not a solution. What you can do is to raise a `RuntimeError` after a certain limit.

6. All methods must be documented as explained in details in the [developer manual](http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings).

Vincent


---

Comment by vdelecroix created at 2016-04-29 19:16:30

And last but not the least: it would be very nice to have Gosper algorithm within Sage!!


---

Comment by mirgee created at 2016-04-30 08:35:06

Hi,

thanks for the great input. 

As for 5.: We need a way to compare instances of _infinite, and even though this is not a valid test, if enough terms are the same, the two continued fractions could be regarded as equal for most practical purposes. Another option would be to compare values, as in _real, but the problem is that

1. value() method is by documentation optional,

2. in case of _infinite, this would delegate the computation of value to RLF, which itself may use comparison,

3. this solution would effectively do the same thing - compute the value of the operands with certain precision and then compare the intervals.

What do you think?


---

Comment by git created at 2016-04-30 09:21:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-04-30 15:34:46

Replying to [comment:6 mirgee]:
> Hi,
> 
> thanks for the great input. 
> 
> As for 5.: We need a way to compare instances of _infinite, and even though this is not a valid test, if enough terms are the same, the two continued fractions could be regarded as equal for most practical purposes. Another option would be to compare values, as in _real, but the problem is that
> 
> 1. value() method is by documentation optional,
> 
> 2. in case of _infinite, this would delegate the computation of value to RLF, which itself may use comparison,
> 
> 3. this solution would effectively do the same thing - compute the value of the operands with certain precision and then compare the intervals.
> 
> What do you think?

Everything would be better than an silent approximate comparison. If equality can not be decided just raise an error (see [Python exceptions](https://docs.python.org/2/tutorial/errors.html)). I think that in that case an `ArithmeticError` would make sense.

If you want to check equality up to some precision, you should do

```
sage: abs(cf1 - cf2) < 2**-100
```

or

```
sage: R = RealIntervalField(256)
sage: R(cf1).overlaps(R(cf2))
```



---

Comment by vdelecroix created at 2016-04-30 15:46:33

For the sake of this ticket I would not implement something like `1+cf` or `3*cf` which needs some work. Having a method `apply_homography` would be enough for a first ticket. In order to include this first part in Sage you need to

 - make it compatible with the last version of Sage source code (see 2. in [comment:4]). By the way why did you make this change in `lazy_list.pyx`?

 - add doctests to each method or function


---

Comment by mirgee created at 2016-04-30 16:52:12

The change in `lazy_list()` is unnecessary and can be deleted. Personally I don't think it is necessary to add doctests for the simple helper functions, but I will comply with the standards and add them, no problem. I will also look into the the comparison.


---

Comment by git created at 2016-05-03 17:03:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-04 09:17:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-05-08 20:21:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-05-12 12:50:57

rebase, squashed, py3-compatible
----
New commits:


---

Comment by git created at 2019-05-12 20:06:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-09-24 11:21:36

Changing keywords from "continued fractions" to "continued_fraction".


---

Comment by git created at 2020-09-24 11:41:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-09-24 11:48:10

Changing status from new to needs_review.


---

Comment by git created at 2020-09-24 12:06:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-09-24 16:53:39

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2020-09-24 16:53:39

not suitable yet. I will provide a commit.


---

Comment by vdelecroix created at 2020-09-24 17:11:32

Author? (name in the git log is `John Doe <miroslav.kovar`@`concur.com>`)


---

Comment by mirgee created at 2020-09-24 17:16:28

Replying to [comment:24 vdelecroix]:
> Author? (name in the git log is `John Doe <miroslav.kovar`@`concur.com>`)

I am the author: Miroslav Kovar (miroslavkovar`@`protonmail.com)


---

Comment by git created at 2020-09-24 17:59:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-09-24 17:59:29

Replying to [comment:25 mirgee]:
> Replying to [comment:24 vdelecroix]:
> > Author? (name in the git log is `John Doe <miroslav.kovar`@`concur.com>`)
> 
> I am the author: Miroslav Kovar (miroslavkovar`@`protonmail.com)

Thanks. I put your name and mail in the copyright header of the file.


---

Comment by vdelecroix created at 2020-09-24 18:00:29

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-09-25 07:24:41

patchbot plugins complain


---

Comment by chapoton created at 2020-09-25 07:38:55

Le reference [LS1998] a une allure bizarre, avec un P isolé


---

Comment by git created at 2020-09-25 13:34:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-09-26 06:17:30

Merci. Pyflakes est encore pas content:

```
src/sage/rings/continued_fraction_gosper.py:37:1 'sage.rings.real_mpfr.RR' imported but unused
```



---

Comment by git created at 2020-09-26 15:24:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-09-26 15:42:17

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2020-09-26 15:42:17

There is something wrong in the way infinity is handled. In the situation where we apply `x -> 1 / (qx - p)` to `x=p/q` Gosper iterator is empty. But currently `continued_fraction([])` is wrongly `0`.


---

Comment by git created at 2020-09-26 15:56:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-09-26 15:57:26

fixed


---

Comment by vdelecroix created at 2020-09-26 15:57:26

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-09-28 07:42:58

ok, this seems to be ready for a positive review ?


---

Comment by vdelecroix created at 2020-09-28 09:36:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-11-07 16:23:27

Resolution: fixed
