# Issue 23539: arctan2 for RDF causes plotting errors

archive/issues_023539.json:
```json
{
    "body": "Carlo Verschoor reports that this is broken in Sage 8.0\n\n```\ncones = [Cone([(0,1),(1,0)]),Cone([(-2,-1),(-1,-3)]),Cone([(0,1),(-2,-1)]),Cone([(-1,-3),(1,0)])]\nF = Fan(cones)\nF.plot()\n```\n\ndue to `float(arctan2(RDF(-3),RDF(-1)))` having an imaginary component\n\nIssue created by migration from https://trac.sagemath.org/ticket/23776\n\n",
    "created_at": "2017-09-02T03:50:25Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "arctan2 for RDF causes plotting errors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23539",
    "user": "@novoselt"
}
```
Carlo Verschoor reports that this is broken in Sage 8.0

```
cones = [Cone([(0,1),(1,0)]),Cone([(-2,-1),(-1,-3)]),Cone([(0,1),(-2,-1)]),Cone([(-1,-3),(1,0)])]
F = Fan(cones)
F.plot()
```

due to `float(arctan2(RDF(-3),RDF(-1)))` having an imaginary component

Issue created by migration from https://trac.sagemath.org/ticket/23776





---

archive/issue_comments_329767.json:
```json
{
    "body": "The problem is that we are chasing parents in https://github.com/sagemath/sage/blob/master/src/sage/libs/pynac/pynac.pyx#L1829\n\nA naive fix would be\n\n```\ndiff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx\nindex acc1424188..b08dca2285 100644\n--- a/src/sage/libs/pynac/pynac.pyx\n+++ b/src/sage/libs/pynac/pynac.pyx\n@@ -1819,6 +1819,7 @@ cdef py_atan2(x, y):\n     \"\"\"\n     from sage.symbolic.constants import pi, NaN\n     from sage.rings.real_arb import RealBallField\n+    from sage.rings.real_double import RealDoubleField_class\n     from sage.rings.real_mpfr import RealField_class\n     P = coercion_model.common_parent(x, y)\n     is_real = False\n@@ -1826,6 +1827,7 @@ cdef py_atan2(x, y):\n         P = RR\n     if (P is float\n             or parent(P) is RealField_class\n+            or isinstance(P, RealDoubleField_class)\n             or isinstance(P, RealBallField)):\n         is_real = True\n     if y != 0:\n```\n\nbut maybe there is a better way to recognize real parents and catch them all?",
    "created_at": "2017-09-02T06:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329767",
    "user": "@rwst"
}
```

The problem is that we are chasing parents in https://github.com/sagemath/sage/blob/master/src/sage/libs/pynac/pynac.pyx#L1829

A naive fix would be

```
diff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx
index acc1424188..b08dca2285 100644
--- a/src/sage/libs/pynac/pynac.pyx
+++ b/src/sage/libs/pynac/pynac.pyx
@@ -1819,6 +1819,7 @@ cdef py_atan2(x, y):
     """
     from sage.symbolic.constants import pi, NaN
     from sage.rings.real_arb import RealBallField
+    from sage.rings.real_double import RealDoubleField_class
     from sage.rings.real_mpfr import RealField_class
     P = coercion_model.common_parent(x, y)
     is_real = False
@@ -1826,6 +1827,7 @@ cdef py_atan2(x, y):
         P = RR
     if (P is float
             or parent(P) is RealField_class
+            or isinstance(P, RealDoubleField_class)
             or isinstance(P, RealBallField)):
         is_real = True
     if y != 0:
```

but maybe there is a better way to recognize real parents and catch them all?



---

archive/issue_comments_329768.json:
```json
{
    "body": "Changing component from graphics to symbolics.",
    "created_at": "2017-09-02T06:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329768",
    "user": "@rwst"
}
```

Changing component from graphics to symbolics.



---

archive/issue_comments_329769.json:
```json
{
    "body": "To me the whole passage trying to figure out if `P` is real or not looks wrong and error prone (and `parent(P)` given that `P` is common parent is confusing). And presumably the question of whether to work over reals or not may arise in other situations, so there has to be a better way to do that will work for possible future fields as well. Why not do something like `is_real = RDF.has_coerce_map_from(P)` and stop on it? Are there situations when this will not work or are there performance considerations?",
    "created_at": "2017-09-03T22:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329769",
    "user": "@novoselt"
}
```

To me the whole passage trying to figure out if `P` is real or not looks wrong and error prone (and `parent(P)` given that `P` is common parent is confusing). And presumably the question of whether to work over reals or not may arise in other situations, so there has to be a better way to do that will work for possible future fields as well. Why not do something like `is_real = RDF.has_coerce_map_from(P)` and stop on it? Are there situations when this will not work or are there performance considerations?



---

archive/issue_comments_329770.json:
```json
{
    "body": "While we are at it, this is also wrongish:\n\n```\n    if P is ZZ:\n        P = RR\n```\n\nfor\n\n```\nfrom sage.libs.pynac.pynac import py_atan2_for_doctests as py_atan2\npy_atan2(-1/2, 0)\n```\n\ngives `TypeError: unable to convert pi to a rational` Not sure what is correct fix here - maybe if `P` is real, we need to check that it is possible to convert something like `RDF` or `RR` into `P` as well and if not - replace `P` with \"generic reals\" whatever that is?",
    "created_at": "2017-09-03T22:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329770",
    "user": "@novoselt"
}
```

While we are at it, this is also wrongish:

```
    if P is ZZ:
        P = RR
```

for

```
from sage.libs.pynac.pynac import py_atan2_for_doctests as py_atan2
py_atan2(-1/2, 0)
```

gives `TypeError: unable to convert pi to a rational` Not sure what is correct fix here - maybe if `P` is real, we need to check that it is possible to convert something like `RDF` or `RR` into `P` as well and if not - replace `P` with "generic reals" whatever that is?



---

archive/issue_comments_329771.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-04T01:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329771",
    "user": "@novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329772.json:
```json
{
    "body": "Using the check that `P` coerces into `RR` seems to work.\n----\nNew commits:",
    "created_at": "2017-09-04T01:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329772",
    "user": "@novoselt"
}
```

Using the check that `P` coerces into `RR` seems to work.
----
New commits:



---

archive/issue_comments_329773.json:
```json
{
    "body": "Thanks. Looking good, patchbot testing passes.",
    "created_at": "2017-09-04T05:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329773",
    "user": "@rwst"
}
```

Thanks. Looking good, patchbot testing passes.



---

archive/issue_comments_329774.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-04T05:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329774",
    "user": "@rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329775.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-10T11:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23539#issuecomment-329775",
    "user": "@vbraun"
}
```

Resolution: fixed
