# Issue 19841: Minimal non faces of simplicial complexes: Improve speed

Issue created by migration from Trac.

Original creator: jipilab

Original creation time: 2016-02-18 12:32:30

CC:  chapoton jipilab tscrim stumpc5 vdelecroix vpilaud

Keywords: simplicial complex, minimal nonface

The current implementation to compute minimal non-faces of simplicial complexes is really slow:


```
sage: SC = SimplicialComplex([(0,1,2),
 (0,2,3),
 (2,3,4),
 (1,2,4),
 (1,4,5),
 (0,3,6),
 (3,6,7),
 (4,5,7)])
sage: %time SC.minimal_nonfaces()
CPU times: user 11 s, sys: 140 ms, total: 11.2 s
Wall time: 11.2 s
{(3, 4, 7), (5, 6), (0, 4), (0, 5), (3, 5), (4, 6), (2, 5), (0, 7), (1, 3), (1, 7), (1, 6), (2, 6), (2, 7)}
```


This is a difficult problem but it seems that the algorithm could be improved with not too much efforts. I made a first try here:


```
sage: %time mnf(SC)
CPU times: user 21.3 ms, sys: 4.25 ms, total: 25.6 ms
Wall time: 26.6 ms
{{3, 4, 7}, {0, 7}, {0, 4}, {0, 5}, {3, 5}, {1, 7}, {2, 5}, {5, 6}, {1, 3}, {4, 6}, {1, 6}, {2, 6}, {2, 7}}
```



---

Comment by jipilab created at 2016-02-18 12:32:40

I have a patch coming, containing a new implemented function, then I will profile properly.


---

Comment by stumpc5 created at 2016-02-18 12:40:28

It might be worth having a look at the polymake implementation of minimal nonfaces; I usually moved there to do that computation. (Also, you can compare speed if desired...)


---

Comment by jipilab created at 2016-02-22 14:42:47

Sage7.1.beta4 gives:

sage -t simplicial_complex.py
    [483 tests, 6.84 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------

With the patch it gives:

sage -t simplicial_complex.py
    [483 tests, 5.70 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------

Of course, there are definitely cases where the presented new implementation will be slow. I am open to include any improvement if you have suggestions.


---

Comment by tscrim created at 2016-02-22 14:45:51

Changing component from PLEASE CHANGE to algebraic topology.


---

Comment by tscrim created at 2016-02-22 14:45:51

New commits:


---

Comment by jipilab created at 2016-02-22 14:46:47

Changing component from algebraic topology to PLEASE CHANGE.


---

Comment by jipilab created at 2016-02-22 14:46:47

`@`Christian: Do you think you could profile the following example in polymake (it is the multi-cluster complex A_3 with k=2):

sage: SC = SimplicialComplex({(0, 3, 5, 9, 10, 11), (0, 1, 7, 8, 9, 11), (2, 3, 4, 8, 9, 10), (1, 3, 5, 6, 7, 11), (1, 2, 3, 5, 7, 9), (0, 1, 8, 9, 10, 11), (0, 2, 3, 4, 9, 10), (2, 3, 4, 6, 7, 8), (0, 1, 2, 4, 5, 6), (2, 3, 4, 5, 7, 9), (0, 3, 4, 5, 10, 11), (0, 1, 2, 3, 4, 5), (5, 7, 8, 9, 10, 11), (0, 4, 5, 6, 9, 10), (1, 3, 8, 9, 10, 11), (0, 1, 2, 3, 10, 11), (0, 1, 6, 7, 8, 11), (4, 5, 6, 8, 10, 11), (3, 4, 5, 7, 8, 9), (1, 3, 7, 8, 9, 11), (1, 2, 3, 8, 10, 11), (0, 1, 5, 6, 7, 11), (0, 1, 3, 4, 5, 11), (4, 5, 6, 8, 9, 10), (0, 5, 6, 7, 9, 10), (3, 4, 5, 6, 8, 11), (0, 2, 6, 8, 10, 11), (1, 2, 3, 7, 8, 9), (0, 1, 2, 5, 6, 7), (0, 5, 6, 7, 10, 11), (1, 2, 3, 8, 9, 10), (0, 1, 2, 7, 8, 9), (5, 6, 7, 8, 9, 10), (1, 2, 3, 6, 8, 11), (0, 1, 2, 4, 6, 11), (0, 2, 4, 5, 6, 9), (0, 1, 4, 5, 6, 11), (0, 1, 2, 8, 9, 10), (0, 2, 6, 7, 8, 9), (2, 3, 4, 8, 10, 11), (3, 4, 5, 8, 10, 11), (0, 1, 2, 6, 8, 11), (2, 3, 4, 5, 6, 7), (0, 2, 5, 6, 7, 9), (5, 6, 7, 8, 10, 11), (0, 1, 2, 8, 10, 11), (0, 1, 2, 5, 7, 9), (1, 2, 3, 4, 5, 6), (0, 1, 3, 5, 9, 11), (0, 7, 8, 9, 10, 11), (3, 5, 7, 8, 9, 11), (3, 5, 6, 7, 8, 11), (2, 3, 4, 7, 8, 9), (2, 4, 6, 8, 10, 11), (0, 1, 3, 9, 10, 11), (1, 3, 6, 7, 8, 11), (0, 1, 2, 3, 9, 10), (2, 3, 4, 6, 8, 11), (3, 5, 8, 9, 10, 11), (2, 4, 6, 8, 9, 10), (0, 1, 2, 3, 4, 11), (4, 5, 6, 7, 8, 9), (0, 6, 7, 8, 10, 11), (0, 3, 4, 5, 9, 10), (0, 1, 2, 3, 5, 9), (0, 1, 2, 6, 7, 8), (3, 4, 5, 8, 9, 10), (2, 4, 5, 6, 7, 9), (1, 2, 3, 5, 6, 7), (0, 4, 5, 6, 10, 11), (0, 6, 7, 8, 9, 10), (2, 4, 6, 7, 8, 9), (0, 2, 6, 8, 9, 10), (1, 2, 3, 4, 6, 11), (0, 2, 4, 6, 9, 10), (0, 5, 7, 9, 10, 11), (1, 2, 3, 6, 7, 8), (1, 3, 4, 5, 6, 11), (0, 2, 3, 4, 10, 11), (0, 2, 3, 4, 5, 9), (1, 3, 5, 7, 9, 11), (0, 1, 5, 7, 9, 11), (3, 4, 5, 6, 7, 8), (0, 2, 4, 6, 10, 11)})
sage: %time SC.minimal_nonfaces()
CPU times: user 427 ms, sys: 94.1 ms, total: 521 ms
Wall time: 533 ms
{(9, 3, 6), (1, 10, 6), (2, 10, 7), (2, 10, 5), (1, 10, 7), (1, 4, 9), (1, 4, 7), (8, 1, 4), (11, 4, 7), (10, 3, 7), (1, 6, 9), (8, 2, 5), (9, 11, 6), (0, 8, 3), (8, 1, 5), (0, 8, 5), (9, 11, 4), (10, 4, 7), (1, 10, 5), (0, 3, 7), (9, 2, 11), (0, 3, 6), (2, 11, 7), (0, 4, 7), (2, 11, 5), (1, 10, 4), (0, 8, 4), (10, 3, 6)}


---

Comment by jipilab created at 2016-02-22 14:47:13

Changing component from PLEASE CHANGE to algebraic topology.


---

Comment by jipilab created at 2016-02-22 14:48:59

The example above was simply taking forever with the previous implementation.
----
New commits:


---

Comment by jipilab created at 2016-02-22 14:49:26

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-02-22 15:03:20

Just from a quick lookthrough:

- I would use `itertools` instead `Subsets`:
  {{{
sage: S = (1,2,3,4)
sage: %timeit list(Subsets(S,2))
10000 loops, best of 3: 162 Âµs per loop
sage: %timeit list(itertools.combinations(S,2))
The slowest run took 27.61 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 907 ns per loop
sage: S = range(20)
sage: %timeit list(itertools.combinations(S,9))
100 loops, best of 3: 14.8 ms per loop
sage: %timeit list(Subsets(S,9))
1 loop, best of 3: 3.8 s per loop
  }}}
  (Actually, we probably should change the iterator for `Subset` to use `itertools`.)
- In general, I would try to avoid using Sage's `Set` at much as possible (which we should cythonize). Instead, I would use python's (`frozen`)`set`s. This way we avoid the overhead.


---

Comment by jipilab created at 2016-02-22 15:04:29

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2016-02-22 15:04:58

Hi Travis,

All right, I'll do the changes! Thanks!


---

Comment by stumpc5 created at 2016-02-22 15:11:38

Replying to [comment:13 tscrim]:
> - I would use `itertools` instead `Subsets`:
> - In general, I would try to avoid using Sage's `Set` at much as possible (which we should cythonize). Instead, I would use python's (`frozen`)`set`s. This way we avoid the overhead.

I was just thinking the same thing (and trying to play with it) -- beside that, this is a brute force implementation, but hopefully good enough until someone hits its limits :-)


---

Comment by git created at 2016-02-22 15:24:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2016-02-22 15:24:40

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2016-02-22 15:24:40

New commits:
----
New commits:


---

Comment by git created at 2016-02-22 15:27:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2016-02-22 15:31:30

> sage: %time SC.minimal_nonfaces()
> CPU times: user 427 ms, sys: 94.1 ms, total: 521 ms
> Wall time: 533 ms
> {(9, 3, 6), (1, 10, 6), (2, 10, 7), (2, 10, 5), (1, 10, 7), (1, 4, 9), (1, 4, 7), (8, 1, 4), (11, 4, 7), (10, 3, 7), (1, 6, 9), (8, 2, 5), (9, 11, 6), (0, 8, 3), (8, 1, 5), (0, 8, 5), (9, 11, 4), (10, 4, 7), (1, 10, 5), (0, 3, 7), (9, 2, 11), (0, 3, 6), (2, 11, 7), (0, 4, 7), (2, 11, 5), (1, 10, 4), (0, 8, 4), (10, 3, 6)}

This is now:

sage: %time SC.minimal_nonfaces()
CPU times: user 54.5 ms, sys: 4.31 ms, total: 58.8 ms
Wall time: 108 ms
{(9, 3, 6), (1, 10, 6), (2, 10, 7), (2, 10, 5), (1, 10, 7), (1, 4, 9), (1, 4, 7), (8, 1, 4), (11, 4, 7), (10, 3, 7), (1, 6, 9), (8, 2, 5), (9, 11, 6), (0, 8, 3), (0, 3, 7), (0, 8, 5), (9, 11, 4), (10, 4, 7), (1, 10, 5), (8, 1, 5), (9, 2, 11), (0, 3, 6), (2, 11, 7), (0, 4, 7), (2, 11, 5), (1, 10, 4), (0, 8, 4), (10, 3, 6)}


---

Comment by stumpc5 created at 2016-02-22 15:34:00

Replying to [comment:6 jipilab]:
> `@`Christian: Do you think you could profile the following example in polymake (it is the multi-cluster complex A_3 with k=2):

A3 with k=2 is immediate, A3 with k=3 takes less than 250ms. (I am a rather bad polymake user, so I don't know how to properly profile.)
----
New commits:


---

Comment by tscrim created at 2016-02-22 15:34:54

Nice, at least a 5x speedup. My last comments:

- `any((set_candidate.issuperset(mnf) for mnf in set_mnf))` the inner parenthesis `()` are redundant.
- `set_mnf` can be a `set` and `set_mnf = set_mnf.union(frozenset([set_candidate]))` could become `set_mnf.add(set_candidate)`.
- Change `cube.append([0, ])` -> `cube.append([0])` (and the same for `[1, ]`.
- Add the example in the ticket description as a doctest (maybe with a comment indicating that this was slow before this ticket).

Once you make these changes, you can consider it a positive review by me.


---

Comment by stumpc5 created at 2016-02-22 15:40:50

A3 with k=4 doesn't take any longer either. But given your great speed now, it might not be worth comparing anymore.


---

Comment by stumpc5 created at 2016-02-22 15:53:08

Final call: A4 with k=3, it takes about 3.5 secs.


---

Comment by git created at 2016-02-22 16:24:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2016-02-22 16:39:44

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2016-02-22 16:39:44

`@`Christian: I guess you were profiling in polymake, right? I am profiling on my old laptop (5yo macbook pro).

For A3, k=3 it takes 16.4ms.

For A3, k=4 it takes:
CPU times: user 16.7 s, sys: 1.3 s, total: 18 s
Wall time: 18.2 s

For A4, k=2 it takes:
CPU times: user 1.77 s, sys: 643 ms, total: 2.41 s
Wall time: 2.45 s

For A4, k=3 it takes:
CPU times: user 1min 34s, sys: 3.06 s, total: 1min 37s
Wall time: 1min 40s

I don't really know why it takes so long on the Wall time, but the 'sys' time looks like 3sec. So I think it is good enough!

If everyone is happy I will set it now to positive review


---

Comment by vbraun created at 2016-02-23 08:26:13

Resolution: fixed
