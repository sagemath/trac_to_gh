# Issue 33094: Meta-ticket: improve conda setup

Issue created by migration from https://trac.sagemath.org/ticket/33331

Original creator: @tobiasdiez

Original creation time: 2022-02-13 13:57:32

CC:  isuruf dimpase saraedum mkoeppe slelievre

- Update documentation to use conda to manage python dependencies instead of relying on `pip -r requirements.txt`
- Migrate documentation from wiki https://wiki.sagemath.org/Conda to developer docs
- Documentation doesn't mention the use of `--prefix=$CONDA_PREFIX` (without this things like `ecl-config` are not found)
- The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding `conda.txt` files
- #33330: primecountpy is not installed in the conda env because its not listed in `environment.yml`
- Installation with `src/environment-optional.yml` uses rather old packages such as lcalc 1 and pari 2.11.4. This leads to issues such as the one below. Or that the package is then rejected by `configure` as being too old. This is most likely an issue with some of the optional packages that get installed and that still relies on an old version of some conda package, which then leads to various downgrades. See discussion at #30845.

```
building 'sage.libs.lcalc.lcalc_Lfunction' extension
    cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++
    In file included from sage/libs/lcalc/lcalc_Lfunction.cpp:740:
    sage/libs/lcalc/lcalc_sage.h:1:10: fatal error: lcalc/L.h: No such file or directory
        1 | #include "lcalc/L.h"
          |          ^~~~~~~~~~~
    compilation terminated.
```



---

Comment by isuruf created at 2022-02-17 01:00:34

> The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 

`@`gh-tobiasdiez, is this fixed by #33358 too?


---

Comment by @tobiasdiez created at 2022-02-17 12:06:57

Replying to [comment:4 isuruf]:
> > The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 
> 
> `@`gh-tobiasdiez, is this fixed by #33358 too?

Nope, still present. See e.g. output of https://pipelines.actions.githubusercontent.com/wUvxDab7ZCURYAl3HeSwsAoJVAdvXg6u4iTbsP5NChUqrJ4TKs/_apis/pipelines/1/runs/9243/signedlogcontent/3?urlExpires=2022-02-17T12%3A02%3A43.1351322Z&urlSigningMethod=HMACV1&urlSignature=ildfTJhaQ2KGVywf69MDFQSVOl7GTONDSdIOurIphKI%3D

Conda is installing rpy2 v3.4.5, while sagelib install requires specify <3.4,>=3.3. Thus pip will download an older version. I think it should be enough to specify the same upper constraint (for the few python packages that have one) in the distros/conda.txt.


---

Comment by dimpase created at 2022-03-21 09:37:53

in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?


---

Comment by slelievre created at 2022-03-21 10:40:31

I think after running `mamba init` you can
always use `mamba` instead of `conda`.


---

Comment by slelievre created at 2022-03-21 10:41:48

I followed the "Conda for Sage developers"
section of the Conda page on the Sage wiki.

I noticed it downgrades the openssl version from 3.0.0 to 1.1.1l.
Can that be fixed?


---

Comment by slelievre created at 2022-03-21 10:47:27

Using `src/environment-optional.yml`
downgrades a few more packages:

- `boost-cpp` from 1.77.0 to 1.74.0
- `cmake` from 3.22.3 to 3.21.3
- `ncurses`from 6.3 to 6.2
- `python` from 3.10.2 to 3.8.12
- `singular` from 4.2.1.p3 to 4.2.0.p3
- `sqlite` from 3.37.1 to 3.37.0


---

Comment by mkoeppe created at 2022-03-21 11:53:54

Did you use the branch of #30845?


---

Comment by mkoeppe created at 2022-03-21 11:58:20

Replying to [comment:12 dimpase]:
> in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?

They can, but I'm not sure if it would be an improvement to this documentation.
I have added a comment to the step "conda install mamba", please take a look


---

Comment by slelievre created at 2022-03-22 00:01:34

Replying to [comment:16 mkoeppe]:
> Did you use the branch of #30845?

Oops, I had not used that branch.
Using it, only `openssl` gets downgraded,

- whether using `src/environment.yml`
- or using  `src/environment-optional.yml`

This is on macOS 11.6.5 Big Sur.
