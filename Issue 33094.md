# Issue 33094: Meta-ticket: improve conda setup

archive/issues_033094.json:
```json
{
    "body": "CC:  isuruf dimpase saraedum mkoeppe slelievre\n\n- Update documentation to use conda to manage python dependencies instead of relying on `pip -r requirements.txt`\n- Migrate documentation from wiki https://wiki.sagemath.org/Conda to developer docs\n- Documentation doesn't mention the use of `--prefix=$CONDA_PREFIX` (without this things like `ecl-config` are not found)\n- The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding `conda.txt` files\n- #33330: primecountpy is not installed in the conda env because its not listed in `environment.yml`\n- Installation with `src/environment-optional.yml` uses rather old packages such as lcalc 1 and pari 2.11.4. This leads to issues such as the one below. Or that the package is then rejected by `configure` as being too old. This is most likely an issue with some of the optional packages that get installed and that still relies on an old version of some conda package, which then leads to various downgrades. See discussion at #30845.\n\n```\nbuilding 'sage.libs.lcalc.lcalc_Lfunction' extension\n    cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++\n    In file included from sage/libs/lcalc/lcalc_Lfunction.cpp:740:\n    sage/libs/lcalc/lcalc_sage.h:1:10: fatal error: lcalc/L.h: No such file or directory\n        1 | #include \"lcalc/L.h\"\n          |          ^~~~~~~~~~~\n    compilation terminated.\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33331\n\n",
    "created_at": "2022-02-13T13:57:32Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: improve conda setup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33094",
    "user": "@tobiasdiez"
}
```
CC:  isuruf dimpase saraedum mkoeppe slelievre

- Update documentation to use conda to manage python dependencies instead of relying on `pip -r requirements.txt`
- Migrate documentation from wiki https://wiki.sagemath.org/Conda to developer docs
- Documentation doesn't mention the use of `--prefix=$CONDA_PREFIX` (without this things like `ecl-config` are not found)
- The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding `conda.txt` files
- #33330: primecountpy is not installed in the conda env because its not listed in `environment.yml`
- Installation with `src/environment-optional.yml` uses rather old packages such as lcalc 1 and pari 2.11.4. This leads to issues such as the one below. Or that the package is then rejected by `configure` as being too old. This is most likely an issue with some of the optional packages that get installed and that still relies on an old version of some conda package, which then leads to various downgrades. See discussion at #30845.

```
building 'sage.libs.lcalc.lcalc_Lfunction' extension
    cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++
    In file included from sage/libs/lcalc/lcalc_Lfunction.cpp:740:
    sage/libs/lcalc/lcalc_sage.h:1:10: fatal error: lcalc/L.h: No such file or directory
        1 | #include "lcalc/L.h"
          |          ^~~~~~~~~~~
    compilation terminated.
```


Issue created by migration from https://trac.sagemath.org/ticket/33331





---

archive/issue_comments_471812.json:
```json
{
    "body": "> The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files \n\n`@`gh-tobiasdiez, is this fixed by #33358 too?",
    "created_at": "2022-02-17T01:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471812",
    "user": "isuruf"
}
```

> The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 

`@`gh-tobiasdiez, is this fixed by #33358 too?



---

archive/issue_comments_471813.json:
```json
{
    "body": "Replying to [comment:4 isuruf]:\n> > The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files \n> \n> `@`gh-tobiasdiez, is this fixed by #33358 too?\n\nNope, still present. See e.g. output of https://pipelines.actions.githubusercontent.com/wUvxDab7ZCURYAl3HeSwsAoJVAdvXg6u4iTbsP5NChUqrJ4TKs/_apis/pipelines/1/runs/9243/signedlogcontent/3?urlExpires=2022-02-17T12%3A02%3A43.1351322Z&urlSigningMethod=HMACV1&urlSignature=ildfTJhaQ2KGVywf69MDFQSVOl7GTONDSdIOurIphKI%3D\n\nConda is installing rpy2 v3.4.5, while sagelib install requires specify <3.4,>=3.3. Thus pip will download an older version. I think it should be enough to specify the same upper constraint (for the few python packages that have one) in the distros/conda.txt.",
    "created_at": "2022-02-17T12:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471813",
    "user": "@tobiasdiez"
}
```

Replying to [comment:4 isuruf]:
> > The correct version of rpy2, scipy, sphinx among other packages is not installed in the conda env, so add version constraints in the corresponding conda.txt files 
> 
> `@`gh-tobiasdiez, is this fixed by #33358 too?

Nope, still present. See e.g. output of https://pipelines.actions.githubusercontent.com/wUvxDab7ZCURYAl3HeSwsAoJVAdvXg6u4iTbsP5NChUqrJ4TKs/_apis/pipelines/1/runs/9243/signedlogcontent/3?urlExpires=2022-02-17T12%3A02%3A43.1351322Z&urlSigningMethod=HMACV1&urlSignature=ildfTJhaQ2KGVywf69MDFQSVOl7GTONDSdIOurIphKI%3D

Conda is installing rpy2 v3.4.5, while sagelib install requires specify <3.4,>=3.3. Thus pip will download an older version. I think it should be enough to specify the same upper constraint (for the few python packages that have one) in the distros/conda.txt.



---

archive/issue_comments_471814.json:
```json
{
    "body": "in \u200bhttps://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?",
    "created_at": "2022-03-21T09:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471814",
    "user": "dimpase"
}
```

in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?



---

archive/issue_comments_471815.json:
```json
{
    "body": "I think after running `mamba init` you can\nalways use `mamba` instead of `conda`.",
    "created_at": "2022-03-21T10:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471815",
    "user": "slelievre"
}
```

I think after running `mamba init` you can
always use `mamba` instead of `conda`.



---

archive/issue_comments_471816.json:
```json
{
    "body": "I followed the \"Conda for Sage developers\"\nsection of the Conda page on the Sage wiki.\n\nI noticed it downgrades the openssl version from 3.0.0 to 1.1.1l.\nCan that be fixed?",
    "created_at": "2022-03-21T10:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471816",
    "user": "slelievre"
}
```

I followed the "Conda for Sage developers"
section of the Conda page on the Sage wiki.

I noticed it downgrades the openssl version from 3.0.0 to 1.1.1l.
Can that be fixed?



---

archive/issue_comments_471817.json:
```json
{
    "body": "Using `src/environment-optional.yml`\ndowngrades a few more packages:\n\n- `boost-cpp` from 1.77.0 to 1.74.0\n- `cmake` from 3.22.3 to 3.21.3\n- `ncurses`from 6.3 to 6.2\n- `python` from 3.10.2 to 3.8.12\n- `singular` from 4.2.1.p3 to 4.2.0.p3\n- `sqlite` from 3.37.1 to 3.37.0",
    "created_at": "2022-03-21T10:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471817",
    "user": "slelievre"
}
```

Using `src/environment-optional.yml`
downgrades a few more packages:

- `boost-cpp` from 1.77.0 to 1.74.0
- `cmake` from 3.22.3 to 3.21.3
- `ncurses`from 6.3 to 6.2
- `python` from 3.10.2 to 3.8.12
- `singular` from 4.2.1.p3 to 4.2.0.p3
- `sqlite` from 3.37.1 to 3.37.0



---

archive/issue_comments_471818.json:
```json
{
    "body": "Did you use the branch of #30845?",
    "created_at": "2022-03-21T11:53:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471818",
    "user": "mkoeppe"
}
```

Did you use the branch of #30845?



---

archive/issue_comments_471819.json:
```json
{
    "body": "Replying to [comment:12 dimpase]:\n> in \u200bhttps://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?\n\nThey can, but I'm not sure if it would be an improvement to this documentation.\nI have added a comment to the step \"conda install mamba\", please take a look",
    "created_at": "2022-03-21T11:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471819",
    "user": "mkoeppe"
}
```

Replying to [comment:12 dimpase]:
> in ​https://wiki.sagemath.org/Conda there is a confusing mix of conda and mamba commands. Can they all be mamba?

They can, but I'm not sure if it would be an improvement to this documentation.
I have added a comment to the step "conda install mamba", please take a look



---

archive/issue_comments_471820.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> Did you use the branch of #30845?\n\nOops, I had not used that branch.\nUsing it, only `openssl` gets downgraded,\n\n- whether using `src/environment.yml`\n- or using  `src/environment-optional.yml`\n\nThis is on macOS 11.6.5 Big Sur.",
    "created_at": "2022-03-22T00:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33094#issuecomment-471820",
    "user": "slelievre"
}
```

Replying to [comment:16 mkoeppe]:
> Did you use the branch of #30845?

Oops, I had not used that branch.
Using it, only `openssl` gets downgraded,

- whether using `src/environment.yml`
- or using  `src/environment-optional.yml`

This is on macOS 11.6.5 Big Sur.
