# Issue 15203: Random spaces injected into Maxima pexpect output

Issue created by migration from https://trac.sagemath.org/ticket/15440

Original creator: vbraun

Original creation time: 2013-11-21 01:39:53

Sometimes doctests fail because randomly spaces are injected into Maxima output. For example:

```
sage -t --long src/sage/schemes/affine/affine_morphism.py
**********************************************************************
File "src/sage/schemes/affine/affine_morphism.py", line 208, in sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize
Failed example:
    f.homogenize(0,'z')
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize[17]>", line 1, in <module>
        f.homogenize(Integer(0),'z')
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/schemes/affine/affine_morphism.py", line 230, in homogenize
        F=[S(((self[i]*l).numerator())._maxima_().divide(self[i].denominator())[0].sage()) for i in range(N)]
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 588, in __call__
        return self._obj.parent().function_call(self._name, [self._obj] + list(args), kwds)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 484, in function_call
        args, kwds = self._convert_args_kwds(args, kwds)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 445, in _convert_args_kwds
        args[i] = self(arg)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 201, in __call__
        return self._coerce_from_special_method(x)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 227, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage_object.pyx", line 603, in sage.structure.sage_object.SageObject._maxima_ (sage/structure/sage_object.c:6332)
      File "sage_object.pyx", line 515, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4376)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 1156, in __init__
        ExpectElement.__init__(self, parent, value, is_name=False, name=None)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1291, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 1001, in set
        self._eval_line(cmd)
      File "/home/buildbot/build/sage/eno-1/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 757, in _eval_line
        assert line_echo.strip() == line.strip(), 'mismatch:\n' + line_echo + line
    AssertionError: mismatch:
    sa ge9 : y$

    sage9 : y$
**********************************************************************
1 item had failures:
   1 of  19 in sage.schemes.affine.affine_morphism.SchemeMorphism_polynomial_affine_space.homogenize
```

This involves a race of some sort since the position is random and it mainly occurs on slower machines (e.g. Skynet, I've never seen it on a Core i7). The exact cause is unknown.


---

Comment by vbraun created at 2013-11-21 01:40:42

Example strace collected from eno: http://boxen.math.washington.edu/home/vbraun/testing/


---

Comment by vbraun created at 2013-11-21 02:05:44

Pertinent bits: Sage = `strace.5419` executes 

```
read(11, "(%", 10000)                   = 2
wait4(5422, 0x7fff644ea860, WNOHANG, NULL) = 0
wait4(5422, 0x7fff644ea860, WNOHANG, NULL) = 0
select(12, [11], [], [], {0, 494115})   = 1 (in [11], left {0, 494112})
read(11, "i5", 10000)                   = 2
wait4(5422, 0x7fff644ea860, WNOHANG, NULL) = 0
wait4(5422, 0x7fff644ea860, WNOHANG, NULL) = 0
select(12, [11], [], [], {0, 493908})   = 1 (in [11], left {0, 493905})
read(11, "8)", 10000)                   = 2
write(11, "_tmp_ : sage7$", 14)         = 14
write(11, "\n", 1)                      = 1
wait4(5422, 0x7fff644eaaa0, WNOHANG, NULL) = 0
wait4(5422, 0x7fff644eaaa0, WNOHANG, NULL) = 0
select(12, [11], [], [], NULL)          = 1 (in [11])
read(11, "_ tmp_ : sage7$\r\n", 10000)  = 17
```

Note the error in the last line: there is a space between `_` and `tmp_`!

Maxima = `strace.5422` executes:

```
write(1, "%", 1)                        = 1
write(1, "i", 1)                        = 1
write(1, "5", 1)                        = 1
write(1, "8", 1)                        = 1
write(1, ")", 1)                        = 1
write(1, " ", 1)                        = 1
read(0, "_tmp_ : sage7$\n", 1024)       = 15
getrusage(RUSAGE_SELF, {ru_utime={0, 552915}, ru_stime={0, 85986}, ...}) = 0
getrusage(RUSAGE_SELF, {ru_utime={0, 552915}, ru_stime={0, 85986}, ...}) = 0
write(1, "\n", 1)                       = 1
write(1, "<", 1)                        = 1
```


Analysis: Sage did not read the last space in the Maxima output, that is, the `write(1, " ", 1)`. This space can (unlikely, but possible) end up interleaved with the TTY echo from the input `"_tmp_ : sage7$"`.


---

Attachment

Strace of PID 5419


---

Comment by vbraun created at 2013-11-21 02:18:09

Strace of PID 5422


---

Attachment

New commits:


---

Comment by vbraun created at 2013-11-21 03:17:43

The fix is of course to read the trailing space, too...


---

Comment by vbraun created at 2013-11-26 21:40:08

Changing status from new to needs_review.


---

Comment by pbruin created at 2013-12-14 12:44:47

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2013-12-14 12:44:47

I have seen doctest failures caused by this quite a few times in `maxima_abstract.py`.  With this fix applied, I have run doctests 1200 times without a single failure.


---

Comment by vbraun created at 2013-12-16 14:48:14

Resolution: fixed
