# Issue 27544: 2 doctests failing in src/sage/misc/package.py when --optional=sage,internet

Issue created by migration from https://trac.sagemath.org/ticket/27781

Original creator: slabbe

Original creation time: 2019-05-06 12:39:23

CC:  vklein

With [SageMath](SageMath) version 8.8.beta4, Release Date: 2019-05-04,


```
sage -t --long src/sage/misc/package.py
```


is ok:


```
Using --optional=4ti2,bliss,build,cbc,ccache,cmake,cryptominisat,dochtml,dot2tex,e_antic,glucose,latte_int,lidia,lrslib,memlimit,mpir,ninja_build,normaliz,notedown,pandoc_attributes,pycosat,pynormaliz,python2,qhull,rst2ipynb,sage,topcom
Doctesting 1 file.
sage -t --long src/sage/misc/package.py
    [45 tests, 2.35 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


but with tag internet:


```
sage -t --long --optional=sage,internet src/sage/misc/package.py
```


gives


```
Using --optional=internet,memlimit,sage
Doctesting 1 file.
sage -t --long src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 202, in sage.misc.package.list_packages
Failed example:
    L['beautifulsoup']
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.list_packages[3]>", line 1, in <module>
        L['beautifulsoup']
    KeyError: 'beautifulsoup'
**********************************************************************
File "src/sage/misc/package.py", line 368, in sage.misc.package.package_versions
Failed example:
    std['zn_poly']  # random
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.package_versions[0]>", line 1, in <module>
        std['zn_poly']  # random
    TypeError: 'function' object has no attribute '__getitem__'
**********************************************************************
2 items had failures:
   1 of   5 in sage.misc.package.list_packages
   1 of   2 in sage.misc.package.package_versions
    [25 tests, 2 failures, 1.07 s]
----------------------------------------------------------------------
sage -t --long src/sage/misc/package.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by slabbe created at 2019-05-09 08:44:49

Probably caused by #27635


---

Comment by slabbe created at 2019-05-09 08:48:00

It has to do with tag `build`. When missing it creates issues. Because with `--optional=sage,internet,build` it works:


```
sage -t --long --optional=sage,internet,build src/sage/misc/package.py
```


gives


```
Using --optional=build,internet,memlimit,sage
Doctesting 1 file.
sage -t --long src/sage/misc/package.py
    [49 tests, 10.22 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 10.2 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 10.2 seconds
```



---

Comment by slabbe created at 2019-05-09 08:50:45

New commits:


---

Comment by slabbe created at 2019-05-09 08:50:45

Changing status from new to needs_review.


---

Comment by vklein created at 2019-05-09 10:03:07

Changing keywords from "" to "thursdaysbdx".


---

Comment by vklein created at 2019-05-09 12:11:57

Looks good to me.


---

Comment by embray created at 2019-05-09 14:21:15

Resolution: duplicate


---

Comment by embray created at 2019-05-09 14:21:15

Thanks, but this was already fixed (duplicate of #27766).
