# Issue 33170: sage -t --all-installed

Issue created by migration from https://trac.sagemath.org/ticket/33407

Original creator: mkoeppe

Original creation time: 2022-02-23 18:52:04

CC:  fbissey arojas @tobiasdiez

This new option would test all Sage modules installed (in `SAGE_LIB`) instead of `SAGE_SRC`. This would be useful for testing modularized distributions.


---

Comment by mkoeppe created at 2022-02-24 05:55:43

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-02-24 22:40:11

New commits:


---

Comment by fbissey created at 2022-02-24 22:47:21

I think the move makes some sense especially in the context of the elimination of `SAGE_LIB` and potentially more variables as sage matures more in the future.

The only thing I am not sure is introducing a new option. Why not make it the default instead? What workflow would that prevent?


---

Comment by mkoeppe created at 2022-02-24 22:51:26

Replying to [comment:5 fbissey]:
> Why not make it the default instead? What workflow would that prevent?

I think the default is valuable because doctests can be written / updated and immediately tested without having to build the Sage library.


---

Comment by fbissey created at 2022-02-24 22:53:31

Valid for pure python files but not `.pyx`, you need to build those before testing them. But on the numbers they probably are the minority.


---

Comment by mkoeppe created at 2022-02-24 23:07:33

Replying to [comment:7 fbissey]:
> Valid for pure python files but not `.pyx`, you need to build those before testing them. 

When you are done changing code, you can still edit doctests and in this phase you don't need to recompile in order to tests the doctests.


---

Comment by fbissey created at 2022-02-24 23:19:09

Replying to [comment:8 mkoeppe]:
> Replying to [comment:7 fbissey]:
> > Valid for pure python files but not `.pyx`, you need to build those before testing them. 
> 
> When you are done changing code, you can still edit doctests and in this phase you don't need to recompile in order to tests the doctests.

More to the point, it is a pain in the workflow to recompile in that case. But you should explicitly test a file or directory in that case. But let's go with a developer focused for now.

We may want to suggest not to use `--installed` and `--all` at the same time for distros as it will try to add a non-existent path once we remove the default `SAGE_SRC` -> `SAGE_LIB`. Also the current `--all` will catch `sage_setup`, `sage_docbuild` and `SAGE_DOC_SRC` (which in distros will point to `SAGE_DOC`). But `--installed` doesn't do any of that. Should it?


---

Comment by mkoeppe created at 2022-02-24 23:42:45

Replying to [comment:9 fbissey]:
> We may want to suggest not to use `--installed` and `--all` at the same time

Yes, they are mutually exclusive options


---

Comment by fbissey created at 2022-02-24 23:44:42

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 fbissey]:
> > We may want to suggest not to use `--installed` and `--all` at the same time
> 
> Yes, they are mutually exclusive options

I didn't pay enough attention to that part of the code. I see it now.


---

Comment by git created at 2022-02-24 23:52:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-24 23:54:00

Replying to [comment:9 fbissey]:
> Also the current `--all` will catch `sage_setup`, `sage_docbuild` and `SAGE_DOC_SRC` (which in distros will point to `SAGE_DOC`). But `--installed` doesn't do any of that. Should it?

I have added `sage_setup`, `sage_docbuild` but I'm not sure about `SAGE_DOC_SRC` because Sage does not install it; do you install it in the Gentoo package?


---

Comment by fbissey created at 2022-02-24 23:57:16

No, I don't install SAGE_DOC_SRC. But as I said it points to the installed `SAGE_DOC` which effectively tests nothing. Because the point would be to test the `.rst` files, but all those are installed as `.rst.txt` for some reason. It would make sense to me to add `SAGE_DOC` for `--installed` if we could test those.


---

Comment by mkoeppe created at 2022-02-25 00:07:37

Ah, I see, in the `_sources` subdirectories


---

Comment by mkoeppe created at 2022-02-25 00:19:46

I looked at these files but they do not seem useful


---

Comment by fbissey created at 2022-02-25 00:24:55

What else do you test in `SAGE_DOC_SRC`? `conf.py` files? Those do not have doctests either. If there is no value in testing a `.rst.txt` in `SAGE_DOC`, I am not sure there is value in testing the corresponding `.rst` in `SAGE_DOC_SRC`.


---

Comment by fbissey created at 2022-02-25 00:36:53

None of these files have `TESTS` blocks but a few have stuff that does get tested

```
$ sage -t --long src/doc/en/thematic_tutorials/sandpile.rst
too many failed tests, not using stored timings
Running doctests with ID 2022-02-25-13-31-30-ea5e5e11.
Using --optional=pip,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,pdftocairo,plantri,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --long --random-seed=249406959745805344364707629509298952414 src/doc/en/thematic_tutorials/sandpile.rst
    [705 tests, 12.50 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2022-02-25 00:38:53

Yes, my mistake


---

Comment by git created at 2022-02-25 00:41:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-25 00:44:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-25 00:52:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-25 01:10:53

Should I remove the fallback `SAGE_DOC_SRC` -> `SAGE_DOC`?


---

Comment by fbissey created at 2022-02-25 01:15:51

Replying to [comment:25 mkoeppe]:
> Should I remove the fallback `SAGE_DOC_SRC` -> `SAGE_DOC`?

Let's leave it for another clean up ticket. I am already quite happy that we fixed the `.rst.txt` thing in this one. I'll want a clean slate in my brain to think properly of all the consequences when we get to it.

It was good work on this one, thank you for all the commits :)

If you have nothing to add, it is a positive review from me.


---

Comment by git created at 2022-02-25 01:20:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-25 01:21:20

Here's another change, just stopping short of actually removing the fallbacks


---

Comment by mkoeppe created at 2022-02-25 01:21:58

But we can leave this for another ticket if you prefer.


---

Comment by fbissey created at 2022-02-25 01:23:59

Well, I'll be going for the school run in 20-25 minutes, I'll try to wrap my head around what this commit is about before going.


---

Comment by git created at 2022-02-25 01:25:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-02-25 01:40:41

Good spotting that last commit. The previous commit is neat, it almost negates the need for having the `--installed` option. I can continue doing `--all` on distro and it will behave as `--installed`. It is only distinctive on vanilla sage where it does something different.

It feels like I won my first point about making it the default without you really conceding anything. Really well done. The code reorganisation around it is also quite good. It is all more clear about what each part does.


---

Comment by mkoeppe created at 2022-02-25 04:34:41

Replying to [comment:32 fbissey]:
> The previous commit is neat, it almost negates the need for having the `--installed` option. 

Yes, for the Sage-on-distro use case, but not for my use case (doctesting a modularized subset distribution like *sagemath-polyhedra*).


---

Comment by fbissey created at 2022-02-27 21:33:08

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-02-28 02:07:38

Thank you!


---

Comment by vbraun created at 2022-02-28 22:27:19

Test fail


---

Comment by vbraun created at 2022-02-28 22:27:19

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-02-28 22:57:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-28 22:57:22

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2022-02-28 23:03:52

Apologies, that was very sloppy of me.


---

Comment by mkoeppe created at 2022-03-01 01:04:17

Patchbots have been on strike, hard to see failures.


---

Comment by fbissey created at 2022-03-01 01:10:50

I have now run a full doctest on sage-on-gentoo with `--installed`. Because we have not acted yet on `SAGE_SRC`/`SAGE_LIB`/`SAGE_DOC_SRC` checking with `--all` was just business as usual. But nothing else came up (apart from the current lot of failures in #33141 and new giac issues that I have to inspect more closely).


---

Comment by fbissey created at 2022-03-17 09:07:02

While it is unrelated to eliminating `SAGE_*` variables, there is something related to testing an installed sage that we need to address in a follow up. pytest doesn't work if you cannot write in the "rootdir" of what is tested.

There are two issues with that. First it may leave unwanted files all over the place. Second it fails miserably if you try to test something that is read-only.

```
============================= test session starts ==============================
platform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /usr
plugins: hypothesis-6.38.0
collected 0 items

=============================== warnings summary ===============================
../../usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433
  /usr/lib/python3.10/site-packages/_pytest/cacheprovider.py:433: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/nodeids
    config.cache.set("cache/nodeids", sorted(self.cached_nodeids))

../../usr/lib/python3.10/site-packages/_pytest/stepwise.py:52
  /usr/lib/python3.10/site-packages/_pytest/stepwise.py:52: PytestCacheWarning: could not create cache path /usr/.pytest_cache/v/cache/stepwise
    session.config.cache.set(STEPWISE_CACHE_DIR, [])

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
```



There seem to be some option to change where the cache is created (`-o cache_dir=$somelocation`) but I have so far failed to integrate it successfully in `sage-runtest` when `pytest` is called.


---

Comment by fbissey created at 2022-03-17 19:47:42

Follow up for `pytest` at #33521.


---

Comment by arojas created at 2022-03-17 22:45:16

Changing status from needs_review to positive_review.


---

Comment by arojas created at 2022-03-17 22:45:16

Working fine here.


---

Comment by mkoeppe created at 2022-03-17 22:46:26

Thanks all for the review!


---

Comment by vbraun created at 2022-03-21 23:34:29

Resolution: fixed
