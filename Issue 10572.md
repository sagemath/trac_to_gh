# Issue 10572: Generic smith form of a matrix fails on integer matrix

archive/issues_010572.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @loefflerd\n\nThe generic Smith Form routine fails for integer matrices, making me suspicious it needs some attention.  The specialized version for integer matrices seems fine, so this is not a problem per se, just evidence something is amiss.  Here's the evidence, obtained by shipping in a sparse matrix - this should soon be fixed by sending sparse matrices to the working dense version.  So if you test this *use something like 4.6.1 or earlier*.\n\n\n```\nsage: A = matrix(2,range(4), sparse=True)\nsage: A.smith_form()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/home/sage/sage-4.6.1.alpha2/<ipython console> in <module>()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.smith_form (sage/matrix/matrix2.c:37477)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42366)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42181)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._generic_clear_column (sage/matrix/matrix2.c:41049)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.inverse_mod (sage/rings/integer.c:28740)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.as_Integer (sage/rings/integer.c:6052)()\n\n/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:7312)()\n\nTypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer\n```\n\n\nOn the input above, I think the failure is in `sage.matrix.matrix2._generic_clear_column` at the line:\n\n\n```\nc = R(a[0,0] / B).inverse_mod(R.ideal(a[k,0] / B))\n```\n\n\nwhich would be \n\n\n```\nZZ(2/1).inverse_mod(ZZ.ideal(3/1))\n```\n\n\nwhich by itself fails in a similar fashion.\n\nCan you place an ideal inside `Integer.inverse_mod`?\n\nIssue created by migration from https://trac.sagemath.org/ticket/10625\n\n",
    "created_at": "2011-01-13T18:40:02Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "Generic smith form of a matrix fails on integer matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10572",
    "user": "https://github.com/rbeezer"
}
```
Assignee: @aghitza

CC:  @loefflerd

The generic Smith Form routine fails for integer matrices, making me suspicious it needs some attention.  The specialized version for integer matrices seems fine, so this is not a problem per se, just evidence something is amiss.  Here's the evidence, obtained by shipping in a sparse matrix - this should soon be fixed by sending sparse matrices to the working dense version.  So if you test this *use something like 4.6.1 or earlier*.


```
sage: A = matrix(2,range(4), sparse=True)
sage: A.smith_form()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/sage/sage-4.6.1.alpha2/<ipython console> in <module>()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.smith_form (sage/matrix/matrix2.c:37477)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42366)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42181)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._generic_clear_column (sage/matrix/matrix2.c:41049)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.inverse_mod (sage/rings/integer.c:28740)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.as_Integer (sage/rings/integer.c:6052)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:7312)()

TypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer
```


On the input above, I think the failure is in `sage.matrix.matrix2._generic_clear_column` at the line:


```
c = R(a[0,0] / B).inverse_mod(R.ideal(a[k,0] / B))
```


which would be 


```
ZZ(2/1).inverse_mod(ZZ.ideal(3/1))
```


which by itself fails in a similar fashion.

Can you place an ideal inside `Integer.inverse_mod`?

Issue created by migration from https://trac.sagemath.org/ticket/10625





---

archive/issue_comments_110358.json:
```json
{
    "body": "I don't mean to seem hostile, but: I wrote the generic Smith and Hermite form code, and I used no assumptions on the methods of the ring elements other than those mandated by the docstrings of the top-level `sage.structure.element.RingElement` class. The problem is that the Integer class doesn't play by the rules (because it's so routine to confuse an ideal of ZZ with its non-negative generator).\n\nSo the solution is not to change the Smith form code, but to add a couple of lines to `Integer.inverse_mod` to make it consistent with the general ring element template.",
    "created_at": "2011-01-16T16:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110358",
    "user": "https://github.com/loefflerd"
}
```

I don't mean to seem hostile, but: I wrote the generic Smith and Hermite form code, and I used no assumptions on the methods of the ring elements other than those mandated by the docstrings of the top-level `sage.structure.element.RingElement` class. The problem is that the Integer class doesn't play by the rules (because it's so routine to confuse an ideal of ZZ with its non-negative generator).

So the solution is not to change the Smith form code, but to add a couple of lines to `Integer.inverse_mod` to make it consistent with the general ring element template.



---

archive/issue_comments_110359.json:
```json
{
    "body": "Attachment [trac_10625-inverse_mod_ideal_of_zz.patch](tarball://root/attachments/some-uuid/ticket10625/trac_10625-inverse_mod_ideal_of_zz.patch) by @loefflerd created at 2011-01-16 16:34:39\n\npatch against 4.6.2.alpha0",
    "created_at": "2011-01-16T16:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110359",
    "user": "https://github.com/loefflerd"
}
```

Attachment [trac_10625-inverse_mod_ideal_of_zz.patch](tarball://root/attachments/some-uuid/ticket10625/trac_10625-inverse_mod_ideal_of_zz.patch) by @loefflerd created at 2011-01-16 16:34:39

patch against 4.6.2.alpha0



---

archive/issue_comments_110360.json:
```json
{
    "body": "Here's the required 2-line patch.",
    "created_at": "2011-01-16T16:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110360",
    "user": "https://github.com/loefflerd"
}
```

Here's the required 2-line patch.



---

archive/issue_comments_110361.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-01-16T16:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110361",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_110362.json:
```json
{
    "body": "Hi David,\n\nThanks for the explanation, and the patch (and the review on #10626).  I spent several hours tracking down a number field doctest-failure to this \"problem\" with a sparse matrix being shipped to the generic routine.  At that point, I was just puzzled by the failure of the generic code to behave properly on a simple example and did not dig any deeper.  In retrospect, a post to sage-devel might have been a better course, but I knew you would know what was up.  So thanks again for the explanation and the fix.\n\nI'll work up a review of this later today.\n\nRob",
    "created_at": "2011-01-18T20:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110362",
    "user": "https://github.com/rbeezer"
}
```

Hi David,

Thanks for the explanation, and the patch (and the review on #10626).  I spent several hours tracking down a number field doctest-failure to this "problem" with a sparse matrix being shipped to the generic routine.  At that point, I was just puzzled by the failure of the generic code to behave properly on a simple example and did not dig any deeper.  In retrospect, a post to sage-devel might have been a better course, but I knew you would know what was up.  So thanks again for the explanation and the fix.

I'll work up a review of this later today.

Rob



---

archive/issue_comments_110363.json:
```json
{
    "body": "Passes all tests on 4.6.1.alpha3, rectifies problem at #10626, and looks good.  Positive review.",
    "created_at": "2011-01-19T20:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110363",
    "user": "https://github.com/rbeezer"
}
```

Passes all tests on 4.6.1.alpha3, rectifies problem at #10626, and looks good.  Positive review.



---

archive/issue_comments_110364.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-19T20:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110364",
    "user": "https://github.com/rbeezer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_010693.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2011-01-25T08:17:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10572#event-10693"
}
```



---

archive/issue_comments_110365.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-25T08:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10572",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10572#issuecomment-110365",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
