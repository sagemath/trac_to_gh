# Issue 10572: Generic smith form of a matrix fails on integer matrix

Issue created by migration from https://trac.sagemath.org/ticket/10625

Original creator: rbeezer

Original creation time: 2011-01-13 18:40:02

Assignee: AlexGhitza

CC:  davidloeffler

The generic Smith Form routine fails for integer matrices, making me suspicious it needs some attention.  The specialized version for integer matrices seems fine, so this is not a problem per se, just evidence something is amiss.  Here's the evidence, obtained by shipping in a sparse matrix - this should soon be fixed by sending sparse matrices to the working dense version.  So if you test this _use something like 4.6.1 or earlier_.


```
sage: A = matrix(2,range(4), sparse=True)
sage: A.smith_form()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/sage/sage-4.6.1.alpha2/<ipython console> in <module>()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2.Matrix.smith_form (sage/matrix/matrix2.c:37477)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42366)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._smith_onestep (sage/matrix/matrix2.c:42181)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/matrix/matrix2.so in sage.matrix.matrix2._generic_clear_column (sage/matrix/matrix2.c:41049)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.inverse_mod (sage/rings/integer.c:28740)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.as_Integer (sage/rings/integer.c:6052)()

/home/sage/sage-4.6.1.alpha2/local/lib/python2.6/site-packages/sage/rings/integer.so in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:7312)()

TypeError: unable to coerce <class 'sage.rings.ideal.Ideal_pid'> to an integer
```


On the input above, I think the failure is in `sage.matrix.matrix2._generic_clear_column` at the line:


```
c = R(a[0,0] / B).inverse_mod(R.ideal(a[k,0] / B))
```


which would be 


```
ZZ(2/1).inverse_mod(ZZ.ideal(3/1))
```


which by itself fails in a similar fashion.

Can you place an ideal inside `Integer.inverse_mod`?


---

Comment by davidloeffler created at 2011-01-16 16:28:41

I don't mean to seem hostile, but: I wrote the generic Smith and Hermite form code, and I used no assumptions on the methods of the ring elements other than those mandated by the docstrings of the top-level `sage.structure.element.RingElement` class. The problem is that the Integer class doesn't play by the rules (because it's so routine to confuse an ideal of ZZ with its non-negative generator).

So the solution is not to change the Smith form code, but to add a couple of lines to `Integer.inverse_mod` to make it consistent with the general ring element template.


---

Attachment

patch against 4.6.2.alpha0


---

Comment by davidloeffler created at 2011-01-16 16:34:59

Here's the required 2-line patch.


---

Comment by davidloeffler created at 2011-01-16 16:34:59

Changing status from new to needs_review.


---

Comment by rbeezer created at 2011-01-18 20:46:55

Hi David,

Thanks for the explanation, and the patch (and the review on #10626).  I spent several hours tracking down a number field doctest-failure to this "problem" with a sparse matrix being shipped to the generic routine.  At that point, I was just puzzled by the failure of the generic code to behave properly on a simple example and did not dig any deeper.  In retrospect, a post to sage-devel might have been a better course, but I knew you would know what was up.  So thanks again for the explanation and the fix.

I'll work up a review of this later today.

Rob


---

Comment by rbeezer created at 2011-01-19 20:06:27

Passes all tests on 4.6.1.alpha3, rectifies problem at #10626, and looks good.  Positive review.


---

Comment by rbeezer created at 2011-01-19 20:06:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-01-25 08:17:09

Resolution: fixed
