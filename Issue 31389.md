# Issue 31389: ModuleNotFoundError in doctesting src/sage/misc/sageinspect.py

Issue created by migration from https://trac.sagemath.org/ticket/31626

Original creator: strogdon

Original creation time: 2021-04-08 20:47:31

The two main failures are:

```
File "src/sage/misc/sageinspect.py", line 2102, in sage.misc.sageinspect._sage_getsourcelines_name_with_dot
Failed example:
    cython('''
    class A:
        def __init__(self):
            "some init doc"
            pass
    class B:
        "some class doc"
        class A(A):
            pass
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sageinspect._sage_getsourcelines_name_with_dot[3]>", line 1, in <module>
        cython('''
      File "sage/misc/lazy_import.pyx", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)
        return self.get_object()(*args, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 659, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 549, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 529, in cython_import
        return builtins.__import__(name)
    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp_isl9jpcz_pyx_0'
```

and

```
File "src/sage/misc/sageinspect.py", line 2251, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    cython('''cpdef test_funct(x,y): return''')
Exception raised:
    Traceback (most recent call last):
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.sageinspect.sage_getsourcelines[6]>", line 1, in <module>
        cython('''cpdef test_funct(x,y): return''')
      File "sage/misc/lazy_import.pyx", line 360, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)
        return self.get_object()(*args, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 659, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 549, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py", line 529, in cython_import
        return builtins.__import__(name)
    ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_2359_tmp__qk8dlm5_pyx_0'
```



---

Attachment

A simple example that demonstrates the failure is:

```
sage: cython(''' 
....: ''')                                                                                                                                                                                                                                   
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-1-e3fd0203ef75> in <module>
----> 1 cython('''
      2 ''')

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4032)()
    358             True
    359         """
--> 360         return self.get_object()(*args, **kwds)
    361 
    362     def __repr__(self):

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)
    657     with open(tmpfile, 'w') as f:
    658         f.write(code)
--> 659     return cython_import_all(tmpfile, get_globals(), **kwds)
    660 
    661 

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)
    547       code
    548     """
--> 549     m = cython_import(filename, **kwds)
    550     for k, x in m.__dict__.items():
    551         if k[0] != '_':

/local/sage-git/sage/local/lib/python3.9/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)
    527     try:
    528         sys.path.append(build_dir)
--> 529         return builtins.__import__(name)
    530     finally:
    531         sys.path = oldpath

ModuleNotFoundError: No module named '_home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0'
```

where the module is present

```
$ tree -a ~/.sage/temp
/home/steven/.sage/temp
└── hp-probook
    ├── 3426
    │   ├── ecl
    │   ├── spyx
    │   │   └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx
    │   │       ├── build
    │   │       │   └── temp.linux-x86_64-3.9
    │   │       │       └── home
    │   │       │           └── steven
    │   │       │               └── .sage
    │   │       │                   └── temp
    │   │       │                       └── hp-probook
    │   │       │                           └── 3426
    │   │       │                               └── spyx
    │   │       │                                   └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx
    │   │       │                                       └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.o
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.c
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.cpython-39-x86_64-linux-gnu.so
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.err
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.html
    │   │       ├── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.lis
    │   │       └── _home_steven__sage_temp_hp_probook_3426_tmp_p61fqom7_pyx_0.pyx
    │   └── tmp_p61fqom7.pyx
    ├── cleaner.log
    └── cleaner.pid
```


Occasionally, the above will not fail.


---

Comment by strogdon created at 2021-04-08 20:59:06

Usually the following will not fail

```
sage: cython(''' 
....: ''', create_local_so_file=True)
sage:
```

but even this will occasionally fail.


---

Comment by mkoeppe created at 2021-04-10 22:47:37

see also old ticket #28928


---

Comment by strogdon created at 2021-04-24 02:43:36

This hack seems to resolve things here

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..f77d7d956b 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -523,6 +523,8 @@ def cython_import(filename, **kwds):
     """
     name, build_dir = cython(filename, **kwds)
 
+    build_dir = build_dir + '/'
+
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
```



```
$ ./sage -t src/sage/misc/sageinspect.py 
Running doctests with ID 2021-04-23-20-30-52-2178c446.
Git branch: develop
Using --optional=build,dochtml,gentoo,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 95.9 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 106.40 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 106.7 seconds
    cpu time: 103.9 seconds
    cumulative wall time: 106.4 seconds
```


And the [above](https://trac.sagemath.org/ticket/31626#comment:1) simple example:

```
sage: import sys                                                                                         
sage: cython(''' 
....: ''')                                                                                               
sage: sys.path                                                                                           
['/local/sage-git/sage/src/bin',
 '/usr/lib/python39.zip',
 '/usr/lib/python3.9',
 '/usr/lib/python3.9/lib-dynload',
 '',
 '/local/sage-git/sage/local/lib/python3.9/site-packages',
 '/local/sage-git/sage/local/lib/python3.9/site-packages/IPython/extensions',
 '/home/steven/.sage/ipython-5.0.0',
 '/home/steven/.sage/temp/hp-probook/10953/spyx/_home_steven__sage_temp_hp_probook_10953_tmp_terjz7ms_pyx/']
sage:
```

So why is the `/` needed?


---

Comment by @sheerluck created at 2021-05-31 14:24:47

"three dots magic" is too slow, it costs 130 seconds:

```diff
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -2276,11 +2276,10 @@
         ([...'class MPolynomialIdeal( MPolynomialIdeal_singular_repr, \\\n',
         ...)
         sage: x = var('x')
-        sage: sage_getsourcelines(x)
-        (['cdef class Expression(CommutativeRingElement):\n',
-          '    cpdef object pyobject(self):\n',
-        ...)
-        sage: sage_getsourcelines(x)[0][-1]    # last line
+        sage: lines, lineno = sage_getsourcelines(x); lines[0:2]
+        ['cdef class Expression(CommutativeRingElement):\n',
+         '    cpdef object pyobject(self):\n']
+        sage: lines[-1]    # last line
         '        return S\n'
```


before:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 158.98 s]
```

after:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 34.82 s]
```



---

Comment by strogdon created at 2021-05-31 16:34:07

Same basic result here on hardware where there is no `ModuleNotFoundError`:

before:

```
sage -t --long --warn-long 182.5 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 156.74 s]
```


after:

```
sage -t --long --warn-long 183.3 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 25.88 s]
```


However, this does not resolve the `ModuleNotFoundError` on the hardware listed in the description.


---

Comment by strogdon created at 2021-06-17 22:02:54

Invalidating internal caches seems to resolve things here on the machine in the description (see [https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches](https://docs.python.org/3/library/importlib.html#importlib.invalidate_caches)


```diff

diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..ec67e6042c 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
+        import importlib
+        importlib.invalidate_caches()
         return builtins.__import__(name)
     finally:
         sys.path = oldpath
```


I'm not sure why it's needed nor if this is a proper `fix`, but `sageinspect.py` does not fail with it

```
$ ./sage -t src/sage/misc/sageinspect.py 
Running doctests with ID 2021-06-17-15-51-51-0193a7dc.
Git branch: trac_31626
Using --optional=build,dochtml,gentoo,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 95.3 --random-seed=0 src/sage/misc/sageinspect.py
    [340 tests, 152.35 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 152.6 seconds
    cpu time: 149.9 seconds
    cumulative wall time: 152.4 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

Comment by fbissey created at 2021-06-17 22:10:50

I actually like it. From https://docs.python.org/3/library/importlib.html :

"This function should be called if any modules are created/installed while your program is running to guarantee all finders will notice the new module’s existence."

So, it is actually highly appropriate because that's exactly what the code is doing. Create a temporary module and trying to load it.


---

Comment by strogdon created at 2021-06-18 15:56:07

Pushed the recent suggestion. Let's see what the Bots say - if there are any unintended consequences. This may be difficult to review since the issue seems rare.
----
New commits:


---

Comment by strogdon created at 2021-06-18 15:56:07

Changing status from new to needs_review.


---

Comment by strogdon created at 2021-06-26 22:13:45

Not every meta path finder

```
sage: sys.meta_path                                                                                      
[<class '_frozen_importlib.BuiltinImporter'>,
 <class '_frozen_importlib.FrozenImporter'>,
 <class '_frozen_importlib_external.PathFinder'>,
 <six._SixMetaPathImporter object at 0x7fd4688217c0>]
```

has an `invalidate_caches` attribute, that allows applying the `invalidate_caches()` method. The offending item here is `PathFinder`.

```
sage: import _frozen_importlib_external                                                                  
sage: _frozen_importlib_external.PathFinder.__dict__                                                     
mappingproxy({'__module__': '_frozen_importlib_external',
              '__doc__': 'Meta path finder for sys.path and package __path__ attributes.',
              'invalidate_caches': <classmethod object at 0x7fd468c713a0>,
              '_path_hooks': <classmethod object at 0x7fd468c713d0>,
              '_path_importer_cache': <classmethod object at 0x7fd468c71400>,
              '_legacy_get_spec': <classmethod object at 0x7fd468c71430>,
              '_get_spec': <classmethod object at 0x7fd468c71460>,
              'find_spec': <classmethod object at 0x7fd468c71490>,
              'find_module': <classmethod object at 0x7fd468c714c0>,
              'find_distributions': <classmethod object at 0x7fd468c714f0>,
              '__dict__': <attribute '__dict__' of 'PathFinder' objects>,
              '__weakref__': <attribute '__weakref__' of 'PathFinder' objects>})
```

The following achieves the same as this branch

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index e72c97f5c3..b3fc341b05 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -526,6 +526,8 @@ def cython_import(filename, **kwds):
     oldpath = sys.path
     try:
         sys.path.append(build_dir)
+        import _frozen_importlib_external
+        _frozen_importlib_external.PathFinder.invalidate_caches()
         return builtins.__import__(name)
     finally:
         sys.path = oldpath
```

Apparently, the `ModuleNotFoundError` is the result of a race condition that can exit on certain archs when a module is created on the fly and then imported. This is a potential `feature` since Python 3.3.


---

Comment by strogdon created at 2021-07-27 03:36:30

I'm convinced that I need to call

```
importlib.invalidate_caches()
```

in order to get things to work properly. From the documentation there appears to be no harm in making the call. However, it seems that the call is not always needed and making the call unconditionally may introduce overhead. Therefore I propose to make the call conditionally as

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index 8277842084..822d115660 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):
     try:
         sys.path.append(build_dir)
         return builtins.__import__(name)
+    except ModuleNotFoundError:
+        import importlib
+        importlib.invalidate_caches()
+        return builtins.__import__(name)
     finally:
         sys.path = oldpath
```

This fixed things for me. Comments are welcome.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by strogdon created at 2021-12-18 22:24:36

I still get the `ModuleNotFoundError` when doctesting `sageinspect.py` on the indicated hardware. I therefore patch each new beta with

```diff
diff --git a/src/sage/misc/cython.py b/src/sage/misc/cython.py
index 8277842084..822d115660 100644
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -529,6 +529,10 @@ def cython_import(filename, **kwds):
     try:
         sys.path.append(build_dir)
         return builtins.__import__(name)
+    except ModuleNotFoundError:
+        import importlib
+        importlib.invalidate_caches()
+        return builtins.__import__(name)
     finally:
         sys.path = oldpath
```

And this patch is used on Sage-on-Gentoo to avoid the same issue. This ticket's branch is sufficient to remove the issue for me but I believe the above patch to be preferred. Reviewing will be difficult unless someone has the issue.


---

Comment by mkoeppe created at 2022-07-16 18:07:54

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2022-07-16 18:07:54

Is this still needed after #33213?


---

Comment by strogdon created at 2022-07-16 23:42:48

Replying to [comment:18 mkoeppe]:
> Is this still needed after #33213?
Still not fixed here. The following will eventually fail

```
sage: cython('''
....: ''')
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-8-e3fd0203ef75> in <module>
----> 1 cython('''
      2 ''')

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4241)()
    388             True
    389         """
--> 390         return self.get_object()(*args, **kwds)
    391 
    392     def __repr__(self):

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_compile(code, **kwds)
    658     with open(tmpfile, 'w') as f:
    659         f.write(code)
--> 660     return cython_import_all(tmpfile, get_globals(), **kwds)
    661 
    662 

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import_all(filename, globals, **kwds)
    548       code
    549     """
--> 550     m = cython_import(filename, **kwds)
    551     for k, x in m.__dict__.items():
    552         if k[0] != '_':

/local/sage-git/sage/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/misc/cython.py in cython_import(filename, **kwds)
    528     try:
    529         sys.path.append(build_dir)
--> 530         return builtins.__import__(name)
    531     finally:
    532         sys.path = oldpath

ModuleNotFoundError: No module named '_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0'
```

with relevant files created

```
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.c
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.cpython-310-x86_64-linux-gnu.so
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.html
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.pyx
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.lis
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.err
/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/build/temp.linux-x86_64-cpython-310/tmp/tmpe6pubgmm/spyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx/_tmp_tmpbhkcqcpr_tmp_zmd87hg9_pyx_0.o
```

comment:16 still works here.


---

Comment by mkoeppe created at 2022-07-17 18:31:14

comment:16 looks like the right fix. Could you update the branch please?


---

Comment by mkoeppe created at 2022-07-17 18:31:34

Changing status from needs_info to needs_work.


---

Comment by git created at 2022-07-18 00:37:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by strogdon created at 2022-07-18 00:39:39

Changing status from needs_work to needs_review.


---

Comment by strogdon created at 2022-07-18 00:39:39

patch updated


---

Comment by mkoeppe created at 2022-07-18 01:01:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-21 21:12:16

Resolution: fixed
