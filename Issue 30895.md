# Issue 30895: homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build

archive/issues_030895.json:
```json
{
    "body": "CC:  mjo jhpalmieri @zlscherr fbissey dunfield @kliem\n\nAs previously discussed in #30745, `/usr/local` is leaking into our build, through wrong orders of include and/or library directives.\n\nIn #30745, this problem was not fixed but rather some more packages were found to be usable on homebrew, so distro information was added.\n\nThe problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.\n\nAs noted in #30745, the change in #29697 (`sage_include_directories`: Do not add another copy of `SAGE_INC`, `SAGE_LOCAL/lib` to include dirs, library dirs) may need careful reconsideration.\n\nSee also:\n- #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl\n- #25993 Upgrade Singular\n\nIssue created by migration from https://trac.sagemath.org/ticket/31132\n\n",
    "created_at": "2020-12-29T19:43:03Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "title": "homebrew: Unused packages (singular, pari, ...) in /usr/local leak into build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30895",
    "user": "mkoeppe"
}
```
CC:  mjo jhpalmieri @zlscherr fbissey dunfield @kliem

As previously discussed in #30745, `/usr/local` is leaking into our build, through wrong orders of include and/or library directives.

In #30745, this problem was not fixed but rather some more packages were found to be usable on homebrew, so distro information was added.

The problem has been reported again with `pari` (building `cypari2`) in #31029/#30589.

As noted in #30745, the change in #29697 (`sage_include_directories`: Do not add another copy of `SAGE_INC`, `SAGE_LOCAL/lib` to include dirs, library dirs) may need careful reconsideration.

See also:
- #30770 cython_aliases: Use ecl-config to determine compiler/linker flags for ecl
- #25993 Upgrade Singular

Issue created by migration from https://trac.sagemath.org/ticket/31132





---

archive/issue_comments_441486.json:
```json
{
    "body": "I discovered another annoying leak while testing.  I have octave installed via homebrew and one of its dependencies is qhull.  With qhull installed via homebrew if I build sage and run\n\n\n\n```\n./sage -tp 8 --long --warn-long 31.1 --random-seed=0 src/sage/plot/plot3d/list_plot3d.py\n```\n\n\nthen it crashes with\n\n\n\n```\nsage: m = matrix(RDF, 6, [sin(i^2 + j^2) for i in [0,pi/5,..,pi] for j in [0,pi/5,..,pi]]) ## line 379 ##\nsage: list_plot3d(m, color='yellow', interpolation_type='linear', num_points=5) # indirect doctest ## line 380 ##\nQH6249 qh_lib_check: Incorrect qhull library called.  Size of qhT for caller is 2896, but for library is 2792.\nQH6256 qh_lib_check: Cannot continue.  Library 'qhull 7.2.0 (2015.2 2016/01/18)' uses a static qhT (e.g., libqhull.so)\n```\n\n\nI was able to track the problem down to matplotlib.  If I do:\n\nmake matplotlib-clean\\\\\nbrew unlink qhull\\\\\nmake matplotlib\\\\\nbrew link qhull\\\\\n\nthen the tests pass without any issues.",
    "created_at": "2020-12-31T19:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441486",
    "user": "@zlscherr"
}
```

I discovered another annoying leak while testing.  I have octave installed via homebrew and one of its dependencies is qhull.  With qhull installed via homebrew if I build sage and run



```
./sage -tp 8 --long --warn-long 31.1 --random-seed=0 src/sage/plot/plot3d/list_plot3d.py
```


then it crashes with



```
sage: m = matrix(RDF, 6, [sin(i^2 + j^2) for i in [0,pi/5,..,pi] for j in [0,pi/5,..,pi]]) ## line 379 ##
sage: list_plot3d(m, color='yellow', interpolation_type='linear', num_points=5) # indirect doctest ## line 380 ##
QH6249 qh_lib_check: Incorrect qhull library called.  Size of qhT for caller is 2896, but for library is 2792.
QH6256 qh_lib_check: Cannot continue.  Library 'qhull 7.2.0 (2015.2 2016/01/18)' uses a static qhT (e.g., libqhull.so)
```


I was able to track the problem down to matplotlib.  If I do:

make matplotlib-clean\\
brew unlink qhull\\
make matplotlib\\
brew link qhull\\

then the tests pass without any issues.



---

archive/issue_comments_441487.json:
```json
{
    "body": "I think I'll open an issue with matplotlib since it's not really a sage problem.",
    "created_at": "2020-12-31T20:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441487",
    "user": "@zlscherr"
}
```

I think I'll open an issue with matplotlib since it's not really a sage problem.



---

archive/issue_comments_441488.json:
```json
{
    "body": "I created #31148 to use system qhull when building matplotlib if it is present.  This should fix these issues.",
    "created_at": "2021-01-02T05:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441488",
    "user": "@zlscherr"
}
```

I created #31148 to use system qhull when building matplotlib if it is present.  This should fix these issues.



---

archive/issue_comments_441489.json:
```json
{
    "body": "In #31180, `@`dunfield pointed out that if we use `python3` from homebrew, `/usr/local/include` ends up on the front of the include search path via sysconfig `CFLAGS`.\n\n```\n>>> import sysconfig\n>>> sysconfig.get_config_var('CFLAGS')\n'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'\n```\n",
    "created_at": "2021-01-07T03:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441489",
    "user": "mkoeppe"
}
```

In #31180, `@`dunfield pointed out that if we use `python3` from homebrew, `/usr/local/include` ends up on the front of the include search path via sysconfig `CFLAGS`.

```
>>> import sysconfig
>>> sysconfig.get_config_var('CFLAGS')
'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'
```




---

archive/issue_comments_441490.json:
```json
{
    "body": "Happening in `setuptools._distutils.sysconfig.customize_compiler` (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/sysconfig.py#L185) via `__init_posix`",
    "created_at": "2021-01-07T04:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441490",
    "user": "mkoeppe"
}
```

Happening in `setuptools._distutils.sysconfig.customize_compiler` (https://github.com/pypa/setuptools/blob/main/setuptools/_distutils/sysconfig.py#L185) via `__init_posix`



---

archive/issue_comments_441491.json:
```json
{
    "body": "By setting environment variables, one cannot override these flags, only append.",
    "created_at": "2021-01-07T05:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441491",
    "user": "mkoeppe"
}
```

By setting environment variables, one cannot override these flags, only append.



---

archive/issue_comments_441492.json:
```json
{
    "body": "I think this is really a packaging bug in homebrew's python3.",
    "created_at": "2021-01-07T05:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441492",
    "user": "mkoeppe"
}
```

I think this is really a packaging bug in homebrew's python3.



---

archive/issue_comments_441493.json:
```json
{
    "body": "I agree that this is a packaging bug in homebrew.  I checked four other Python 3 .* packages (Ubuntu 20.04, CentOS 7, Python.org's macOS installer, Conda) and none of them have `-Iincludes` in `sysconfig.get_config_var('CFLAGS')`.",
    "created_at": "2021-01-07T15:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441493",
    "user": "dunfield"
}
```

I agree that this is a packaging bug in homebrew.  I checked four other Python 3 .* packages (Ubuntu 20.04, CentOS 7, Python.org's macOS installer, Conda) and none of them have `-Iincludes` in `sysconfig.get_config_var('CFLAGS')`.



---

archive/issue_comments_441494.json:
```json
{
    "body": "homebrew issue: https://github.com/Homebrew/homebrew-core/issues/68352",
    "created_at": "2021-01-07T20:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441494",
    "user": "mkoeppe"
}
```

homebrew issue: https://github.com/Homebrew/homebrew-core/issues/68352



---

archive/issue_comments_441495.json:
```json
{
    "body": "Let's see what the homebrew maintainers do with this.\n\nFor now the best thing we can do is detect the issue and print a warning (or we could reject the homebrew python with this issue entirely.)\n\n----\nNew commits:",
    "created_at": "2021-01-08T02:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441495",
    "user": "mkoeppe"
}
```

Let's see what the homebrew maintainers do with this.

For now the best thing we can do is detect the issue and print a warning (or we could reject the homebrew python with this issue entirely.)

----
New commits:



---

archive/issue_comments_441496.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-08T02:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441496",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_441497.json:
```json
{
    "body": "This warning is buried in `config.log`. Would it be better to print it at the end, along with the instructions for what additional packages should be installed, or is that too hard to implement.",
    "created_at": "2021-01-08T06:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441497",
    "user": "jhpalmieri"
}
```

This warning is buried in `config.log`. Would it be better to print it at the end, along with the instructions for what additional packages should be installed, or is that too hard to implement.



---

archive/issue_comments_441498.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-08T17:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441498",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441499.json:
```json
{
    "body": "Here's a different approach. Now actually rejecting the broken homebrew python3.\n\nFor any package, to see the reasons why a system package is rejected, one needs to scroll up in the configure output (or look into config.log)",
    "created_at": "2021-01-08T17:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441499",
    "user": "mkoeppe"
}
```

Here's a different approach. Now actually rejecting the broken homebrew python3.

For any package, to see the reasons why a system package is rejected, one needs to scroll up in the configure output (or look into config.log)



---

archive/issue_comments_441500.json:
```json
{
    "body": "Looks okay to me. It took one machine about 30 seconds longer to build Sage when it had to build its own Python (just one iteration, so not very scientific), so avoiding homebrew's Python for now is not placing a huge burden on developers.",
    "created_at": "2021-01-09T04:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441500",
    "user": "jhpalmieri"
}
```

Looks okay to me. It took one machine about 30 seconds longer to build Sage when it had to build its own Python (just one iteration, so not very scientific), so avoiding homebrew's Python for now is not placing a huge burden on developers.



---

archive/issue_comments_441501.json:
```json
{
    "body": "On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.",
    "created_at": "2021-01-10T19:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441501",
    "user": "mkoeppe"
}
```

On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.



---

archive/issue_comments_441502.json:
```json
{
    "body": "Let's get this in please",
    "created_at": "2021-01-10T19:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441502",
    "user": "mkoeppe"
}
```

Let's get this in please



---

archive/issue_comments_441503.json:
```json
{
    "body": "looks good to me on Mac.  Big Sur also has /usr/bin/python3 which gets picked up and accepted.",
    "created_at": "2021-01-11T00:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441503",
    "user": "@zlscherr"
}
```

looks good to me on Mac.  Big Sur also has /usr/bin/python3 which gets picked up and accepted.



---

archive/issue_comments_441504.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-11T00:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441504",
    "user": "@zlscherr"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_441505.json:
```json
{
    "body": "sorry, might be premature in a positive review.  I'll take a second look later on.",
    "created_at": "2021-01-11T00:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441505",
    "user": "@zlscherr"
}
```

sorry, might be premature in a positive review.  I'll take a second look later on.



---

archive/issue_comments_441506.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-01-11T00:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441506",
    "user": "@zlscherr"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_441507.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.\n\nNot for me:\n\n```\n% ./configure --with-python=/usr/bin/python3\n...\nchecking for /usr/bin/python3... /usr/bin/python3\nchecking ... whether /usr/bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension\nconfigure: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable\n```\n\n\n(This is on a machine running Catalina.)",
    "created_at": "2021-01-11T00:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441507",
    "user": "jhpalmieri"
}
```

Replying to [comment:21 mkoeppe]:
> On my machine (I'm still running Catalina), it accepts `/usr/bin/python3`.

Not for me:

```
% ./configure --with-python=/usr/bin/python3
...
checking for /usr/bin/python3... /usr/bin/python3
checking ... whether /usr/bin/python3 is good... no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
configure: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable
```


(This is on a machine running Catalina.)



---

archive/issue_comments_441508.json:
```json
{
    "body": "I think that building using the included version of Python 3 on OS X is not required for this \u2014\u00a0Sage can just build its own Python \u2014 but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:\n\n```\n## -------------------------------------------------------- ##\n## Checking whether SageMath should install SPKG python3... ##\n## -------------------------------------------------------- ##\nconfigure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG\nconfigure:31750: result: no\nconfigure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core\nconfigure:31763: result: \nconfigure:31767: checking for /usr/bin/python3\nconfigure:31797: result: /usr/bin/python3\nconfigure:31812: checking ... whether /usr/bin/python3 is good\nCC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir\nrunning build\nrunning build_ext\nbuilding 'config_check_distutils' extension\ncreating conftest.dir\ncreating conftest.dir/temp.macosx-10.14.6-x86_64-3.8\ngcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:\nIn file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:63:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/cdefs.h:807:2: error: Unsupported architecture\n#error Unsupported architecture\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:\nIn file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:64:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/limits.h:8:2: error: architecture not supported\n#error architecture not supported\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:33:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/_types.h:34:2: error: architecture not supported\n#error architecture not supported\n ^\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:55:9: error: unknown type name '__int64_t'\ntypedef __int64_t       __darwin_blkcnt_t;      /* total blocks */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:56:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_blksize_t;     /* preferred block size */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:57:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_dev_t;         /* dev_t */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:60:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_gid_t;         /* [???] process and group IDs */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:61:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_id_t;          /* [XSI] pid_t, uid_t, or gid_t*/\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:62:9: error: unknown type name '__uint64_t'\ntypedef __uint64_t      __darwin_ino64_t;       /* [???] Used for 64 bit inodes */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:68:9: error: unknown type name '__darwin_natural_t'\ntypedef __darwin_natural_t __darwin_mach_port_name_t; /* Used by mach */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:70:9: error: unknown type name '__uint16_t'; did you mean '__uint128_t'?\ntypedef __uint16_t      __darwin_mode_t;        /* [???] Some file attributes */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:71:9: error: unknown type name '__int64_t'\ntypedef __int64_t       __darwin_off_t;         /* [???] Used for file sizes */\n        ^\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:72:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_pid_t;         /* [???] process and group IDs */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:73:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_sigset_t;      /* [???] signal set */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:74:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?\ntypedef __int32_t       __darwin_suseconds_t;   /* [???] microseconds */\n        ^\nnote: '__int128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:75:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_uid_t;         /* [???] user IDs */\n        ^\nnote: '__uint128_t' declared here\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:76:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_useconds_t;    /* [???] microseconds */\n        ^\nnote: '__uint128_t' declared here\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:43:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?\ntypedef __uint32_t      __darwin_wctype_t;\n        ^\nnote: '__uint128_t' declared here\nIn file included from conftest.c:66:\nIn file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:75:\nIn file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types/_va_list.h:31:\n/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/types.h:37:2: error: architecture not supported\n#error architecture not supported\n ^\nfatal error: too many errors emitted, stopping now [-ferror-limit=]\n20 errors generated.\nerror: command 'gcc' failed with exit status 1\nconfigure:32019: result: no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension\nconfigure:32062: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable\n```\n",
    "created_at": "2021-01-11T00:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441508",
    "user": "jhpalmieri"
}
```

I think that building using the included version of Python 3 on OS X is not required for this — Sage can just build its own Python — but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:

```
## -------------------------------------------------------- ##
## Checking whether SageMath should install SPKG python3... ##
## -------------------------------------------------------- ##
configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG
configure:31750: result: no
configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core
configure:31763: result: 
configure:31767: checking for /usr/bin/python3
configure:31797: result: /usr/bin/python3
configure:31812: checking ... whether /usr/bin/python3 is good
CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir
running build
running build_ext
building 'config_check_distutils' extension
creating conftest.dir
creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:
In file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:63:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/cdefs.h:807:2: error: Unsupported architecture
#error Unsupported architecture
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:11:
In file included from /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/include/limits.h:21:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/limits.h:64:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/limits.h:8:2: error: architecture not supported
#error architecture not supported
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:33:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/_types.h:34:2: error: architecture not supported
#error architecture not supported
 ^
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:27:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:55:9: error: unknown type name '__int64_t'
typedef __int64_t       __darwin_blkcnt_t;      /* total blocks */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:56:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_blksize_t;     /* preferred block size */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:57:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_dev_t;         /* dev_t */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:60:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_gid_t;         /* [???] process and group IDs */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:61:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_id_t;          /* [XSI] pid_t, uid_t, or gid_t*/
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:62:9: error: unknown type name '__uint64_t'
typedef __uint64_t      __darwin_ino64_t;       /* [???] Used for 64 bit inodes */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:68:9: error: unknown type name '__darwin_natural_t'
typedef __darwin_natural_t __darwin_mach_port_name_t; /* Used by mach */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:70:9: error: unknown type name '__uint16_t'; did you mean '__uint128_t'?
typedef __uint16_t      __darwin_mode_t;        /* [???] Some file attributes */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:71:9: error: unknown type name '__int64_t'
typedef __int64_t       __darwin_off_t;         /* [???] Used for file sizes */
        ^
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:72:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_pid_t;         /* [???] process and group IDs */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:73:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_sigset_t;      /* [???] signal set */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:74:9: error: unknown type name '__int32_t'; did you mean '__int128_t'?
typedef __int32_t       __darwin_suseconds_t;   /* [???] microseconds */
        ^
note: '__int128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:75:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_uid_t;         /* [???] user IDs */
        ^
note: '__uint128_t' declared here
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types.h:76:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_useconds_t;    /* [???] microseconds */
        ^
note: '__uint128_t' declared here
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:71:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_types.h:43:9: error: unknown type name '__uint32_t'; did you mean '__uint128_t'?
typedef __uint32_t      __darwin_wctype_t;
        ^
note: '__uint128_t' declared here
In file included from conftest.c:66:
In file included from /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8/Python.h:25:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/stdio.h:64:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_stdio.h:75:
In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/sys/_types/_va_list.h:31:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/machine/types.h:37:2: error: architecture not supported
#error architecture not supported
 ^
fatal error: too many errors emitted, stopping now [-ferror-limit=]
20 errors generated.
error: command 'gcc' failed with exit status 1
configure:32019: result: no, the version is in the supported range, and the modules can be imported, but distutils cannot build a C extension
configure:32062: error: the python3 selected using --with-python=/usr/bin/python3 is not suitable
```




---

archive/issue_comments_441509.json:
```json
{
    "body": "on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n\n\n\n```\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n  clang: error: the clang compiler does not support '-march=native'\n  error: command 'gcc' failed with exit status 1\n```\n",
    "created_at": "2021-01-11T00:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441509",
    "user": "@zlscherr"
}
```

on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.



```
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
  clang: error: the clang compiler does not support '-march=native'
  error: command 'gcc' failed with exit status 1
```




---

archive/issue_comments_441510.json:
```json
{
    "body": "Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  Doing\n\nsource .homebrew-build-env\\\\\n./configure --with-system-python3=no\\\\\nmake python3\\\\\n\nends with an error\n\n\n\n```\n[python3-3.8.5] ld: warning: dylib (/usr/local/lib/libintl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\n[python3-3.8.5] sed -e \"s,@EXENAME@,/Users/zscherr/sage/develop/local/bin/python3.8,\" < ./Misc/python-config.in >python-config.py\n[python3-3.8.5] LC_ALL=C sed -e 's,\\$(\\([A-Za-z0-9_]*\\)),\\$\\{\\1\\},g' < Misc/python-config.sh >python-config\n[python3-3.8.5] Testing importing of various modules...\n[python3-3.8.5] ctypes module imported OK\n[python3-3.8.5] math module imported OK\n[python3-3.8.5] hashlib module imported OK\n[python3-3.8.5] crypt module imported OK\n[python3-3.8.5] Traceback (most recent call last):\n[python3-3.8.5]   File \"<string>\", line 1, in <module>\n[python3-3.8.5] ModuleNotFoundError: No module named 'readline'\n[python3-3.8.5] readline module failed to import\n[python3-3.8.5] socket module imported OK\n[python3-3.8.5] Traceback (most recent call last):\n[python3-3.8.5]   File \"<string>\", line 1, in <module>\n[python3-3.8.5] ModuleNotFoundError: No module named 'zlib'\n[python3-3.8.5] zlib module failed to import\n[python3-3.8.5] sqlite3 module imported OK\n[python3-3.8.5] _scproxy module imported OK\n[python3-3.8.5] Error: One or more modules failed to import.\n```\n\n\nI don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.",
    "created_at": "2021-01-11T02:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441510",
    "user": "@zlscherr"
}
```

Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  Doing

source .homebrew-build-env\\
./configure --with-system-python3=no\\
make python3\\

ends with an error



```
[python3-3.8.5] ld: warning: dylib (/usr/local/lib/libintl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
[python3-3.8.5] sed -e "s,@EXENAME@,/Users/zscherr/sage/develop/local/bin/python3.8," < ./Misc/python-config.in >python-config.py
[python3-3.8.5] LC_ALL=C sed -e 's,\$(\([A-Za-z0-9_]*\)),\$\{\1\},g' < Misc/python-config.sh >python-config
[python3-3.8.5] Testing importing of various modules...
[python3-3.8.5] ctypes module imported OK
[python3-3.8.5] math module imported OK
[python3-3.8.5] hashlib module imported OK
[python3-3.8.5] crypt module imported OK
[python3-3.8.5] Traceback (most recent call last):
[python3-3.8.5]   File "<string>", line 1, in <module>
[python3-3.8.5] ModuleNotFoundError: No module named 'readline'
[python3-3.8.5] readline module failed to import
[python3-3.8.5] socket module imported OK
[python3-3.8.5] Traceback (most recent call last):
[python3-3.8.5]   File "<string>", line 1, in <module>
[python3-3.8.5] ModuleNotFoundError: No module named 'zlib'
[python3-3.8.5] zlib module failed to import
[python3-3.8.5] sqlite3 module imported OK
[python3-3.8.5] _scproxy module imported OK
[python3-3.8.5] Error: One or more modules failed to import.
```


I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.



---

archive/issue_comments_441511.json:
```json
{
    "body": "Replying to [comment:28 gh-zlscherr]:\n> on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> \n> \n> {{{\n>   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n>   clang: error: the clang compiler does not support '-march=native'\n>   error: command 'gcc' failed with exit status 1\n> }}}\n\nThis looks like a complication that may have come in through #27122",
    "created_at": "2021-01-11T03:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441511",
    "user": "mkoeppe"
}
```

Replying to [comment:28 gh-zlscherr]:
> on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> 
> 
> {{{
>   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
>   clang: error: the clang compiler does not support '-march=native'
>   error: command 'gcc' failed with exit status 1
> }}}

This looks like a complication that may have come in through #27122



---

archive/issue_comments_441512.json:
```json
{
    "body": "Replying to [comment:29 gh-zlscherr]:\n> Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  \n\nI think we need the upgrade to python 3.9 for this in #30589",
    "created_at": "2021-01-11T03:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441512",
    "user": "mkoeppe"
}
```

Replying to [comment:29 gh-zlscherr]:
> Also on Big Sur I am not able to build python3 through sage (with or without this ticket).  

I think we need the upgrade to python 3.9 for this in #30589



---

archive/issue_comments_441513.json:
```json
{
    "body": "Replying to [comment:29 gh-zlscherr]:\n> I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.\n\nLooks like there are two missing libraries, readline and zlib.  For brew, readline is \"keg only\", and I get the following message when I install it:\n\n```\nreadline is keg-only, which means it was not symlinked into /usr/local,\nbecause macOS provides BSD libedit.\n\nFor compilers to find readline you may need to set:\n  export LDFLAGS=\"-L/usr/local/opt/readline/lib\"\n  export CPPFLAGS=\"-I/usr/local/opt/readline/include\"\n\nFor pkg-config to find readline you may need to set:\n  export PKG_CONFIG_PATH=\"/usr/local/opt/readline/lib/pkgconfig\"\n```\n\nI didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.",
    "created_at": "2021-01-11T03:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441513",
    "user": "dunfield"
}
```

Replying to [comment:29 gh-zlscherr]:
> I don't think I've ever tried building python3 from scratch since I always have relied on homebrew's version, so I'm not sure where this is coming from.

Looks like there are two missing libraries, readline and zlib.  For brew, readline is "keg only", and I get the following message when I install it:

```
readline is keg-only, which means it was not symlinked into /usr/local,
because macOS provides BSD libedit.

For compilers to find readline you may need to set:
  export LDFLAGS="-L/usr/local/opt/readline/lib"
  export CPPFLAGS="-I/usr/local/opt/readline/include"

For pkg-config to find readline you may need to set:
  export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"
```

I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.



---

archive/issue_comments_441514.json:
```json
{
    "body": "Replying to [comment:27 jhpalmieri]:\n> I think that building using the included version of Python 3 on OS X is not required for this \u2014\u00a0Sage can just build its own Python \u2014 but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:\n> {{{\n> ## -------------------------------------------------------- ##\n> ## Checking whether [SageMath](SageMath) should install SPKG python3... ##\n> ## -------------------------------------------------------- ##\n> configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG\n> configure:31750: result: no\n> configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core\n> configure:31763: result: \n> configure:31767: checking for /usr/bin/python3\n> configure:31797: result: /usr/bin/python3\n> configure:31812: checking ... whether /usr/bin/python3 is good\n> CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir\n> running build\n> running build_ext\n> building 'config_check_distutils' extension\n> creating conftest.dir\n> creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8\n> gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o\n> }}}\n\nThe `-arch arm64 -arch x86_64` there looks scary.\n\nCould you post the whole config.log please",
    "created_at": "2021-01-11T03:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441514",
    "user": "mkoeppe"
}
```

Replying to [comment:27 jhpalmieri]:
> I think that building using the included version of Python 3 on OS X is not required for this — Sage can just build its own Python — but in case anyone wants to help troubleshoot, here is an excerpt from `config.log`:
> {{{
> ## -------------------------------------------------------- ##
> ## Checking whether [SageMath](SageMath) should install SPKG python3... ##
> ## -------------------------------------------------------- ##
> configure:31741: checking whether any of libpng bzip2 xz libffi is installed as or will be installed as SPKG
> configure:31750: result: no
> configure:31756: checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core
> configure:31763: result: 
> configure:31767: checking for /usr/bin/python3
> configure:31797: result: /usr/bin/python3
> configure:31812: checking ... whether /usr/bin/python3 is good
> CC=gcc CXX=g++ -std=gnu++11 conftest_venv/bin/python3 conftest.py --verbose build --build-base=conftest.dir
> running build
> running build_ext
> building 'config_check_distutils' extension
> creating conftest.dir
> creating conftest.dir/temp.macosx-10.14.6-x86_64-3.8
> gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -I/Users/jpalmier/Desktop/Sage/git/sage/conftest_venv/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c conftest.c -o conftest.dir/temp.macosx-10.14.6-x86_64-3.8/conftest.o
> }}}

The `-arch arm64 -arch x86_64` there looks scary.

Could you post the whole config.log please



---

archive/issue_comments_441515.json:
```json
{
    "body": "Replying to [comment:32 dunfield]:\n> Looks like there are two missing libraries, readline and zlib.  For brew, readline is \"keg only\", and I get the following message when I install it:\n> {{{\n> readline is keg-only, which means it was not symlinked into /usr/local,\n> because macOS provides BSD libedit.\n> \n> For compilers to find readline you may need to set:\n>   export LDFLAGS=\"-L/usr/local/opt/readline/lib\"\n>   export CPPFLAGS=\"-I/usr/local/opt/readline/include\"\n> \n> For pkg-config to find readline you may need to set:\n>   export PKG_CONFIG_PATH=\"/usr/local/opt/readline/lib/pkgconfig\"\n> }}}\n> I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.\n\nWe already do that in `.homebrew-build-env`",
    "created_at": "2021-01-11T03:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441515",
    "user": "mkoeppe"
}
```

Replying to [comment:32 dunfield]:
> Looks like there are two missing libraries, readline and zlib.  For brew, readline is "keg only", and I get the following message when I install it:
> {{{
> readline is keg-only, which means it was not symlinked into /usr/local,
> because macOS provides BSD libedit.
> 
> For compilers to find readline you may need to set:
>   export LDFLAGS="-L/usr/local/opt/readline/lib"
>   export CPPFLAGS="-I/usr/local/opt/readline/include"
> 
> For pkg-config to find readline you may need to set:
>   export PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig"
> }}}
> I didn't check, but likely zlib is similar. The fix should be to tell `configure` to look in `/usr/local/opt/readline` in addition to `/usr/local`.

We already do that in `.homebrew-build-env`



---

archive/issue_comments_441516.json:
```json
{
    "body": "I just wanted to confirm that on Big Sur I have no trouble building sage's python and Cython using ticket #30589, provided that I run configure with --with-system-python3=no.",
    "created_at": "2021-01-11T05:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441516",
    "user": "@zlscherr"
}
```

I just wanted to confirm that on Big Sur I have no trouble building sage's python and Cython using ticket #30589, provided that I run configure with --with-system-python3=no.



---

archive/issue_comments_441517.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket31132/config.log) by jhpalmieri created at 2021-01-11 18:15:10\n\nReplying to [comment:33 mkoeppe]:\n> \n> The `-arch arm64 -arch x86_64` there looks scary.\n> \n> Could you post the whole config.log please\n\nHere it is.",
    "created_at": "2021-01-11T18:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441517",
    "user": "jhpalmieri"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket31132/config.log) by jhpalmieri created at 2021-01-11 18:15:10

Replying to [comment:33 mkoeppe]:
> 
> The `-arch arm64 -arch x86_64` there looks scary.
> 
> Could you post the whole config.log please

Here it is.



---

archive/issue_comments_441518.json:
```json
{
    "body": "I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.",
    "created_at": "2021-01-11T19:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441518",
    "user": "@zlscherr"
}
```

I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.



---

archive/issue_comments_441519.json:
```json
{
    "body": "Replying to [comment:37 gh-zlscherr]:\n> I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.\n\nYes, I have just updated my CLT to 12.3 and now also see this on my machine. (Still running on Catalina.)",
    "created_at": "2021-01-13T00:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441519",
    "user": "mkoeppe"
}
```

Replying to [comment:37 gh-zlscherr]:
> I don't know anything about this, but my guess is that `-arch arm64 -arch x86_64` is because Mac is pushing to build universal binaries, so it may have been introduced in the latest Xcode/CLT on Big Sur.

Yes, I have just updated my CLT to 12.3 and now also see this on my machine. (Still running on Catalina.)



---

archive/issue_comments_441520.json:
```json
{
    "body": "A workaround from https://github.com/tensorflow/io/pull/1168/files\nis to pass `ARCHFLAGS=\"-arch x86_64\"`",
    "created_at": "2021-01-13T00:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441520",
    "user": "mkoeppe"
}
```

A workaround from https://github.com/tensorflow/io/pull/1168/files
is to pass `ARCHFLAGS="-arch x86_64"`



---

archive/issue_comments_441521.json:
```json
{
    "body": "Also `ARCHFLAGS=\"\"` works for me.",
    "created_at": "2021-01-13T01:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441521",
    "user": "mkoeppe"
}
```

Also `ARCHFLAGS=""` works for me.



---

archive/issue_comments_441522.json:
```json
{
    "body": "Last time `ARCHFLAGS` was touched - #29408",
    "created_at": "2021-01-13T01:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441522",
    "user": "mkoeppe"
}
```

Last time `ARCHFLAGS` was touched - #29408



---

archive/issue_comments_441523.json:
```json
{
    "body": "I have opened #31227 for trying to make python3 from CLT 12.3 usable.",
    "created_at": "2021-01-13T01:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441523",
    "user": "mkoeppe"
}
```

I have opened #31227 for trying to make python3 from CLT 12.3 usable.



---

archive/issue_comments_441524.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-13T01:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441524",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441525.json:
```json
{
    "body": "Replying to [comment:30 mkoeppe]:\n> Replying to [comment:28 gh-zlscherr]:\n> > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> > \n> > \n> > {{{\n> >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n> >   clang: error: the clang compiler does not support '-march=native'\n> >   error: command 'gcc' failed with exit status 1\n> > }}}\n> \n> This looks like a complication that may have come in through #27122\n\nI have opened #31228 for this.",
    "created_at": "2021-01-13T01:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441525",
    "user": "mkoeppe"
}
```

Replying to [comment:30 mkoeppe]:
> Replying to [comment:28 gh-zlscherr]:
> > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> > 
> > 
> > {{{
> >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
> >   clang: error: the clang compiler does not support '-march=native'
> >   error: command 'gcc' failed with exit status 1
> > }}}
> 
> This looks like a complication that may have come in through #27122

I have opened #31228 for this.



---

archive/issue_comments_441526.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-13T01:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441526",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_441527.json:
```json
{
    "body": "I have merged the Python 3.9 upgrade ticket (#30589). \nDoes anything else need changing on this ticket?",
    "created_at": "2021-01-13T01:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441527",
    "user": "mkoeppe"
}
```

I have merged the Python 3.9 upgrade ticket (#30589). 
Does anything else need changing on this ticket?



---

archive/issue_comments_441528.json:
```json
{
    "body": "I tested this by installing as many homebrew packages as I can, and then building with --with-system-python3=no and everything builds correctly at least on Big Sur.  Of course --with-system-python3=no is currently necessary since otherwise configure will use /usr/bin/python3 which needs #31228 to work.\n\nOn another note, when I test I see lots of warnings of the form:\n\n\n\n```\nld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgmpxx.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libgsl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\nld: warning: dylib (/usr/local/lib/libntl.dylib) was built for newer macOS version (10.15) than being linked (10.9)\n```\n\n\nI did a little bit of poking, and it appears this might be caused by src/bin/sage-env setting MACOSX_DEPLOYMENT_TARGET to 10.9.  Maybe we can open a ticket for this? The source code for sage-env mentions that this was done in response to #7095, which is a ticket from 11 years ago.",
    "created_at": "2021-01-14T00:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441528",
    "user": "@zlscherr"
}
```

I tested this by installing as many homebrew packages as I can, and then building with --with-system-python3=no and everything builds correctly at least on Big Sur.  Of course --with-system-python3=no is currently necessary since otherwise configure will use /usr/bin/python3 which needs #31228 to work.

On another note, when I test I see lots of warnings of the form:



```
ld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgmp.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgmpxx.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libgsl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
ld: warning: dylib (/usr/local/lib/libntl.dylib) was built for newer macOS version (10.15) than being linked (10.9)
```


I did a little bit of poking, and it appears this might be caused by src/bin/sage-env setting MACOSX_DEPLOYMENT_TARGET to 10.9.  Maybe we can open a ticket for this? The source code for sage-env mentions that this was done in response to #7095, which is a ticket from 11 years ago.



---

archive/issue_comments_441529.json:
```json
{
    "body": "#31204 silences some of those \"ld: warning: ...\" messages. I agree that we should also explore the proper setting (or unsetting) of `MACOSX_DEPLOYMENT_TARGET`.",
    "created_at": "2021-01-14T00:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441529",
    "user": "jhpalmieri"
}
```

#31204 silences some of those "ld: warning: ..." messages. I agree that we should also explore the proper setting (or unsetting) of `MACOSX_DEPLOYMENT_TARGET`.



---

archive/issue_comments_441530.json:
```json
{
    "body": "I don't know anything about m4 files (something to learn I guess!) but I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set \n\n\n```\nSAGE_MACOSX_DEPLOYMENT_TARGET='legacy'\n```\n\n\nwhich is then picked up by sage-env.",
    "created_at": "2021-01-14T00:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441530",
    "user": "@zlscherr"
}
```

I don't know anything about m4 files (something to learn I guess!) but I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set 


```
SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'
```


which is then picked up by sage-env.



---

archive/issue_comments_441531.json:
```json
{
    "body": "We have ticket #30711 (`src/bin/sage-env`: Update `MACOSX_DEPLOYMENT_TARGET` in builds with python3 from SPKG) for this task.",
    "created_at": "2021-01-14T00:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441531",
    "user": "mkoeppe"
}
```

We have ticket #30711 (`src/bin/sage-env`: Update `MACOSX_DEPLOYMENT_TARGET` in builds with python3 from SPKG) for this task.



---

archive/issue_comments_441532.json:
```json
{
    "body": "Thanks.  I'm happy to give this ticket a positive review since it seems to fix all issues of homebrew leaking into the builds.  It would be good to sort out using /usr/bin/python3 on mac, but as far as I can tell this ticket fixes the leaking.",
    "created_at": "2021-01-14T00:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441532",
    "user": "@zlscherr"
}
```

Thanks.  I'm happy to give this ticket a positive review since it seems to fix all issues of homebrew leaking into the builds.  It would be good to sort out using /usr/bin/python3 on mac, but as far as I can tell this ticket fixes the leaking.



---

archive/issue_comments_441533.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-14T00:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441533",
    "user": "@zlscherr"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_441534.json:
```json
{
    "body": "Replying to [comment:49 gh-zlscherr]:\n> I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set \n> \n> {{{\n> SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'\n> }}}\n> \n> which is then picked up by sage-env.  \n\nThat's right, this mechanism deactivates the old code in `sage-env` when we use system python3 instead of building our own python.",
    "created_at": "2021-01-14T00:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441534",
    "user": "mkoeppe"
}
```

Replying to [comment:49 gh-zlscherr]:
> I think this is caused by build/pkgs/python3/spkg-configure.m4.  It appears to set 
> 
> {{{
> SAGE_MACOSX_DEPLOYMENT_TARGET='legacy'
> }}}
> 
> which is then picked up by sage-env.  

That's right, this mechanism deactivates the old code in `sage-env` when we use system python3 instead of building our own python.



---

archive/issue_comments_441535.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-01-14T00:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441535",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_441536.json:
```json
{
    "body": "The Homebrew python maintainers are still struggling to fix up their python builds. I have added some links to the ticket description to track these efforts.",
    "created_at": "2021-01-14T01:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441536",
    "user": "mkoeppe"
}
```

The Homebrew python maintainers are still struggling to fix up their python builds. I have added some links to the ticket description to track these efforts.



---

archive/issue_comments_441537.json:
```json
{
    "body": "Replying to [comment:45 mkoeppe]:\n> Replying to [comment:30 mkoeppe]:\n> > Replying to [comment:28 gh-zlscherr]:\n> > > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.\n> > > \n> > > \n> > > {{{\n> > >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o\n> > >   clang: error: the clang compiler does not support '-march=native'\n> > >   error: command 'gcc' failed with exit status 1\n> > > }}}\n> > \n> > This looks like a complication that may have come in through #27122\n> \n> I have opened #31228 for this.\n\nSee also #30725.",
    "created_at": "2021-01-16T18:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441537",
    "user": "mkoeppe"
}
```

Replying to [comment:45 mkoeppe]:
> Replying to [comment:30 mkoeppe]:
> > Replying to [comment:28 gh-zlscherr]:
> > > on Big Sur, configure allowed me to use /usr/bin/python3 but then Cython failed to build.
> > > 
> > > 
> > > {{{
> > >   gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-p2i1cj72/Cython/Plex/Scanners.o
> > >   clang: error: the clang compiler does not support '-march=native'
> > >   error: command 'gcc' failed with exit status 1
> > > }}}
> > 
> > This looks like a complication that may have come in through #27122
> 
> I have opened #31228 for this.

See also #30725.



---

archive/issue_comments_441538.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441538",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_441539.json:
```json
{
    "body": "A fix has just been merged into homebrew master https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825",
    "created_at": "2021-02-03T06:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441539",
    "user": "mkoeppe"
}
```

A fix has just been merged into homebrew master https://github.com/Homebrew/homebrew-core/commit/784d29205ee5bd27fed226a5f96837428e171825



---

archive/issue_comments_441540.json:
```json
{
    "body": "And indeed the upgrade of `python3` to `3.9.1_7` has repaired it.",
    "created_at": "2021-02-03T07:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441540",
    "user": "mkoeppe"
}
```

And indeed the upgrade of `python3` to `3.9.1_7` has repaired it.



---

archive/issue_comments_441541.json:
```json
{
    "body": "`brew info python`@`3.9` tells me that I have 3.9.1_7 installed, but I still see this in `config.log`:\n\n```\n\tCFLAGS = \"-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include\"\n\tLDFLAGS = \"-L/usr/local/lib -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk\"\nconfigure:32994: result: no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3\n```\n",
    "created_at": "2021-02-03T21:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441541",
    "user": "jhpalmieri"
}
```

`brew info python`@`3.9` tells me that I have 3.9.1_7 installed, but I still see this in `config.log`:

```
	CFLAGS = "-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include"
	LDFLAGS = "-L/usr/local/lib -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
configure:32994: result: no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/usr/local/bin/python3
```




---

archive/issue_comments_441542.json:
```json
{
    "body": "very bizarre.  I had to do:\n\nbrew reinstall python`@`3.9 --build-from-source\n\nand that fixed it for me.  Maybe the bottle hasn't been updated yet?",
    "created_at": "2021-02-03T22:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441542",
    "user": "@zlscherr"
}
```

very bizarre.  I had to do:

brew reinstall python`@`3.9 --build-from-source

and that fixed it for me.  Maybe the bottle hasn't been updated yet?



---

archive/issue_comments_441543.json:
```json
{
    "body": "Although I'm not sure if I needed the --build-from-source.  Maybe just try brew reinstall first?",
    "created_at": "2021-02-03T22:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441543",
    "user": "@zlscherr"
}
```

Although I'm not sure if I needed the --build-from-source.  Maybe just try brew reinstall first?



---

archive/issue_comments_441544.json:
```json
{
    "body": "I tried `brew reinstall python`@`3.9` and that seems to have worked.",
    "created_at": "2021-02-03T22:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441544",
    "user": "jhpalmieri"
}
```

I tried `brew reinstall python`@`3.9` and that seems to have worked.



---

archive/issue_comments_441545.json:
```json
{
    "body": "I mentioned this on the thread and it\u2019s because they forgot to bump the version number I guess from 7 to 8.  The next time it upgrades everything should be good without needing to reinstall.",
    "created_at": "2021-02-03T22:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441545",
    "user": "@zlscherr"
}
```

I mentioned this on the thread and it’s because they forgot to bump the version number I guess from 7 to 8.  The next time it upgrades everything should be good without needing to reinstall.



---

archive/issue_comments_441546.json:
```json
{
    "body": "Has anyone else tried building sage with the newest homebrew python? Configure now accepts it, but I still have issues with /usr/local leaking into the builds.  Not sure why that happens now that python3-config no longer remembers /usr/local.",
    "created_at": "2021-02-04T01:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441546",
    "user": "@zlscherr"
}
```

Has anyone else tried building sage with the newest homebrew python? Configure now accepts it, but I still have issues with /usr/local leaking into the builds.  Not sure why that happens now that python3-config no longer remembers /usr/local.



---

archive/issue_comments_441547.json:
```json
{
    "body": "Although I should add that cypari build fine even with homebrew's pari was installed.  The problem was that singular and pari were leaking into building sagelib, and then ecl leaked into building the manifolds documentation.",
    "created_at": "2021-02-04T01:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441547",
    "user": "@zlscherr"
}
```

Although I should add that cypari build fine even with homebrew's pari was installed.  The problem was that singular and pari were leaking into building sagelib, and then ecl leaked into building the manifolds documentation.



---

archive/issue_comments_441548.json:
```json
{
    "body": "Follow up in #31335.",
    "created_at": "2021-02-04T02:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441548",
    "user": "mkoeppe"
}
```

Follow up in #31335.



---

archive/issue_comments_441549.json:
```json
{
    "body": "Replying to [comment:63 jhpalmieri]:\n> I tried `brew reinstall python`@`3.9` and that seems to have worked.\n\nThis worked on one machine (Big Sur) but not another (Catalina). I deleted the cached download and it still didn't work, and neither did `brew reinstall python`@`3.9 -s`. Oh well, maybe 3.9.1_8 will work on this machine.",
    "created_at": "2021-02-04T06:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441549",
    "user": "jhpalmieri"
}
```

Replying to [comment:63 jhpalmieri]:
> I tried `brew reinstall python`@`3.9` and that seems to have worked.

This worked on one machine (Big Sur) but not another (Catalina). I deleted the cached download and it still didn't work, and neither did `brew reinstall python`@`3.9 -s`. Oh well, maybe 3.9.1_8 will work on this machine.



---

archive/issue_comments_441550.json:
```json
{
    "body": "I think I had to do `brew update` first, which displayed some instructions regarding unshallowing, after which I ran `brew update` again.",
    "created_at": "2021-02-04T06:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441550",
    "user": "mkoeppe"
}
```

I think I had to do `brew update` first, which displayed some instructions regarding unshallowing, after which I ran `brew update` again.



---

archive/issue_comments_441551.json:
```json
{
    "body": "Doing `brew upgrade` and then forcing the upgrade to Python worked, although maybe that's because it's now version 3.9.1_8. (Pro-tip: if you've forced Sage to build with homebrew's Python, don't upgrade that Python in the middle of doctesting, at least if you want doctesting to go well.)",
    "created_at": "2021-02-04T17:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441551",
    "user": "jhpalmieri"
}
```

Doing `brew upgrade` and then forcing the upgrade to Python worked, although maybe that's because it's now version 3.9.1_8. (Pro-tip: if you've forced Sage to build with homebrew's Python, don't upgrade that Python in the middle of doctesting, at least if you want doctesting to go well.)



---

archive/issue_comments_441552.json:
```json
{
    "body": "This is now rejecting the system python on Gentoo, I guess because of the `-L` in `LDFLAGS`:\n\n\n```\n$ python3 -m sysconfig\n...\nCONFIGURE_LDFLAGS = \"-Wl,-O1 -Wl,--as-needed -L.\"\nLDFLAGS = \"-Wl,-O1 -Wl,--as-needed -L.\"\n```\n\n\nThat is added to our python build for obsolete reasons (there is no Gentoo/FreeBSD anymore):\n\n\n```\n# Set LDFLAGS so we link modules with -lpython3.2 correctly.                                                                                                             \n# Needed on FreeBSD unless Python 3.2 is already installed.                                                                                                              \n# Please query BSD team before removing this!                                                                                                                            \nappend-ldflags \"-L.\"\n```\n\n\nCan someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?",
    "created_at": "2021-02-11T13:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441552",
    "user": "mjo"
}
```

This is now rejecting the system python on Gentoo, I guess because of the `-L` in `LDFLAGS`:


```
$ python3 -m sysconfig
...
CONFIGURE_LDFLAGS = "-Wl,-O1 -Wl,--as-needed -L."
LDFLAGS = "-Wl,-O1 -Wl,--as-needed -L."
```


That is added to our python build for obsolete reasons (there is no Gentoo/FreeBSD anymore):


```
# Set LDFLAGS so we link modules with -lpython3.2 correctly.                                                                                                             
# Needed on FreeBSD unless Python 3.2 is already installed.                                                                                                              
# Please query BSD team before removing this!                                                                                                                            
append-ldflags "-L."
```


Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?



---

archive/issue_comments_441553.json:
```json
{
    "body": "Replying to [comment:71 mjo]:\n> Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?\n\nWhen building a C/C++ extension module for Python in the standard way (distutils/setuptools), compiler and linker flags are pulled from `sysconfig`.  While you can specify additional flags for such a module, the ones in sysconfig come first in the compile/link commands, meaning that they take precedence.  In the present case, that means if there is a copy of a library in `.` there is no way to instead use a version located elsewhere, e.g. in `/usr/lib`.",
    "created_at": "2021-02-11T14:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441553",
    "user": "dunfield"
}
```

Replying to [comment:71 mjo]:
> Can someone briefly summarize the problem that this `-L.` causes, so that I can get it removed?

When building a C/C++ extension module for Python in the standard way (distutils/setuptools), compiler and linker flags are pulled from `sysconfig`.  While you can specify additional flags for such a module, the ones in sysconfig come first in the compile/link commands, meaning that they take precedence.  In the present case, that means if there is a copy of a library in `.` there is no way to instead use a version located elsewhere, e.g. in `/usr/lib`.



---

archive/issue_comments_441554.json:
```json
{
    "body": "Great, thanks. Fix is in progress.",
    "created_at": "2021-02-11T14:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441554",
    "user": "mjo"
}
```

Great, thanks. Fix is in progress.



---

archive/issue_comments_441555.json:
```json
{
    "body": "Exception for `-L.` was done in #31358",
    "created_at": "2021-02-11T17:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441555",
    "user": "mkoeppe"
}
```

Exception for `-L.` was done in #31358



---

archive/issue_comments_441556.json:
```json
{
    "body": "Can't this be fixed by stripping `CFLAGS` and `LDSHARED` of `-I` and `-L` flags and then appending them to `CFLAGS` and `LDFLAGS` env variables?",
    "created_at": "2021-09-24T21:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441556",
    "user": "isuruf"
}
```

Can't this be fixed by stripping `CFLAGS` and `LDSHARED` of `-I` and `-L` flags and then appending them to `CFLAGS` and `LDFLAGS` env variables?



---

archive/issue_comments_441557.json:
```json
{
    "body": "`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.",
    "created_at": "2021-09-24T21:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441557",
    "user": "isuruf"
}
```

`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.



---

archive/issue_comments_441558.json:
```json
{
    "body": "Let's discuss this in #31539",
    "created_at": "2021-09-25T01:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30895",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30895#issuecomment-441558",
    "user": "mkoeppe"
}
```

Let's discuss this in #31539
