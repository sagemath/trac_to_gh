# Issue 33469: sage -t: Bad exit code from pytest

Issue created by migration from https://trac.sagemath.org/ticket/33706

Original creator: mkoeppe

Original creation time: 2022-04-14 00:41:34

CC:  @tobiasdiez mjo parisse tornaria vbraun dimpase

https://github.com/sagemath/sage/runs/5962279659?check_suite_focus=true

```
sage -t --random-seed=156404901056981760924144629149815074678 src/sage/tests/cmdline.py
    [216 tests, 73.54 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 3739.0 seconds
    cpu time: 6427.0 seconds
    cumulative wall time: 10155.6 seconds
Features detected for doctesting: gfan,nauty,palp,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx
============================= test session starts ==============================
platform linux -- Python 3.10.4, pytest-7.1.1, pluggy-1.0.0
rootdir: /sage/src, configfile: tox.ini
collected 26 items / 104 skipped

src/sage/manifolds/differentiable/symplectic_form_test.py .............. [ 53%]
........                                                                 [ 84%]
src/sage/manifolds/differentiable/examples/symplectic_space_test.py .... [100%]

================= 26 passed, 104 skipped in 102.79s (0:01:42) ==================
The command '/bin/sh -c make SAGE_SPKG="sage-spkg -y -o" ${USE_MAKEFLAGS} ${TARGETS_OPTIONAL} || echo "(error ignored)"' returned a non-zero code: 130
```



---

Comment by mkoeppe created at 2022-04-14 23:20:46

The exit code 130 from the shell is rather mysterious. Not sure if it really has anything to do with pytest.

It appears to be non-deterministic. I have reproduced it in the container (`docker run -it docker.pkg.github.com/sagemath/sage/sage-docker-gitpod-standard-with-targets-optional:9.6.rc0-failed bash`) after adding some `print` calls to `src/bin/sage-runtests` to see what the return values of the Sage doctester and pytest are.

```
gitpod ~/sage $ /bin/sh -c 'make SAGE_SPKG="sage-spkg -y -o" ${USE_MAKEFLAGS} ptest-nodoc || echo "(error ignored)"'
----------------------------------------------------------------------
sage -t --warn-long 102.2 --random-seed=17067963460848597109909214796612832081 src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t --warn-long 102.2 --random-seed=17067963460848597109909214796612832081 src/sage/interfaces/expect.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1677.6 seconds
    cpu time: 13605.8 seconds
    cumulative wall time: 24340.6 seconds
Features detected for doctesting: gfan,imagemagick,nauty,palp,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx
ERR=5
============================================================ test session starts =============================================================
platform linux -- Python 3.8.10, pytest-7.1.1, pluggy-1.0.0
rootdir: /home/gitpod/sage/src, configfile: tox.ini
collected 26 items / 104 skipped                                                                                                             

src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                       [ 84%]
src/sage/manifolds/differentiable/examples/symplectic_space_test.py ....                                                               [100%]

================================================ 26 passed, 104 skipped in 104.61s (0:01:44) =================================================
exit_code_pytest=0
make: *** [Makefile:287: ptest-nodoc] Error 5
(error ignored)

gitpod ~/sage $ echo $?
130
gitpod ~/sage $ ls -l /bin/sh
lrwxrwxrwx 1 root root 4 Jul 18  2019 /bin/sh -> dash
```

I think it may be specific to the shell that is used on the systems where the failure was observed.


---

Comment by mkoeppe created at 2022-04-15 06:17:11

The problem can be reproduced about 1 in 5 times using `/bin/bash -c './sage -t src/sage/calculus/calculus.py'`. 

A `giac` process sends SIGINT to the whole process group, sometimes succeeding to take down the calling `bash`, which then gives exit code 130.


---

Comment by mkoeppe created at 2022-04-15 06:51:20

This might be breakage from #8784


---

Comment by mkoeppe created at 2022-04-15 21:57:11

An easy way to reproduce: `while true; do /bin/bash -c './sage -t src/sage/calculus/calculus.py'; done` -- this infinite loop ends in a finite number of iterations


---

Comment by mkoeppe created at 2022-04-15 22:47:29

With binary search I have obtained the following simple reproducer:

```
while true; do ./sage -c "k, n = var('k,n'); from sage.calculus.calculus import symbolic_sum; print(symbolic_sum(1/(1+k^2), k, -oo, oo, algorithm = 'giac')); print(gp.eval('intnum(x=17,42,exp(-x^2)*log(x))'))"; done
```



---

Comment by mkoeppe created at 2022-04-15 22:50:29

Even simpler:

```
while true; do ./sage -c "print(giac.eval('1')); print(gp.eval('2'))"; done
```



---

Comment by mkoeppe created at 2022-04-16 00:55:08

`gp` can also be replaced with `maxima` or `singular` with same results.

Some stracing:

```
$ while true; do rm -f STRAC*; strace -ff -o STRACE ./sage -c "print(giac.eval('1')); print(gp.eval('2'))"; done
1
2

gitpod ~/sage $ echo $?
130
$ grep kill STRA*
...
STRACE.99696:kill(1, SIGINT)                         = 0
...
STRACE.99732:kill(-99700, SIGCONT)                   = 0
STRACE.99732:kill(-99700, SIGINT)                    = -1 ESRCH (No such process)
STRACE.99733:kill(-99696, SIGCONT)                   = 0
STRACE.99733:kill(-99696, SIGINT)                    = 0
STRACE.99733:kill(-99696, SIGHUP)                    = -1 ESRCH (No such process)
```

99696 is the `giac` process.


---

Comment by mkoeppe created at 2022-04-16 04:42:13

`@`parisse
This is happening in https://github.com/geogebra/giac/blob/c2058a0c8921af8a762f6fbede1354b974bf5a70/src/giac/cpp/global.cc#L3761 (although we are still on GIAC 1.6). Somehow `child_id` is 1 and it ends up killing the whole process group with SIGINT.


---

Comment by @sheerluck created at 2022-04-16 06:55:05

Replying to [comment:7 mkoeppe]:
> Even simpler:
> {{{
> while true; do ./sage -c "print(giac.eval('1')); print(gp.eval('2'))"; done
> }}}
for me that loop never ends when giac is 1.7.0.47


---

Comment by mkoeppe created at 2022-04-16 18:37:34

I'll try with the upgrade ticket #31563 on this platform. Unfortunately the upgrade is stuck


---

Comment by tornaria created at 2022-04-16 19:43:17

Replying to [comment:7 mkoeppe]:
> Even simpler:
> {{{
> while true; do ./sage -c "print(giac.eval('1')); print(gp.eval('2'))"; done
> }}}

No failure here, tested with giac 1.7.0-53 or 1.9.0-5.


---

Comment by mkoeppe created at 2022-04-17 19:27:17

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2022-04-17 19:27:17

New commits:


---

Comment by mkoeppe created at 2022-04-17 19:27:17

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-04-17 19:41:51

We won't be able to do the upgrade for Sage 9.6 because Cygwin support is unresolved.
So here is a hotfix.


---

Comment by vbraun created at 2022-04-18 21:04:13

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-04-18 21:17:53

Thanks!


---

Comment by vbraun created at 2022-04-19 20:34:06

Resolution: fixed


---

Comment by mkoeppe created at 2022-04-30 20:00:59

This (unsurprisingly) still happens in 9.6.rc3 on systems where the system giac is used: `ubuntu-jammy-standard` (https://github.com/sagemath/sage/runs/6236167662, 1.7.0.39+dfsg2-1build2) and `debian-sid-standard`.


---

Comment by mkoeppe created at 2022-05-13 15:40:15

Follow-up = #33848
