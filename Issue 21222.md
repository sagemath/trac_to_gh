# Issue 21222: Fix building of sage_setup.autogen.interpreters output on Cygwin/Windows

archive/issues_021222.json:
```json
{
    "body": "CC:  @tscrim gouezel jpflori\n\nThis adds a new file generated for each interpreter, called `interp_<name>.h`.  Its purpose is to provide the correct `__declspec(dllexport/import)` on exported function definitions, so that they have the correct link-time behavior when building the interpreter wrappers themselves.\n\nThis is a workaround to #19868.  Ideally this would be fixed directly in Cython so that such a workaround is not needed, but after exploring the issue it seems that for now providing such a workaround is easier than fixing Cython.\n\nExplicit use of the `interp_<name>.h` headers replaces the implicit `cdef extern:` statements in the `wrapper_<name>.pxd` definition files.  This ensures that the function declarations (with the correct `__declspec` are included from the .h files, instead of being written directly into Cython-generated C files.  The end result has no visible differences for users of the library.\n\nThis currently depends on #20730 but doesn't strictly have to.  It was just easier to understand the code and see what needed to be changed where *after* it was refactored.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21459\n\n",
    "created_at": "2016-09-09T12:06:31Z",
    "labels": [
        "component: porting: cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Fix building of sage_setup.autogen.interpreters output on Cygwin/Windows",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21222",
    "user": "https://github.com/embray"
}
```
CC:  @tscrim gouezel jpflori

This adds a new file generated for each interpreter, called `interp_<name>.h`.  Its purpose is to provide the correct `__declspec(dllexport/import)` on exported function definitions, so that they have the correct link-time behavior when building the interpreter wrappers themselves.

This is a workaround to #19868.  Ideally this would be fixed directly in Cython so that such a workaround is not needed, but after exploring the issue it seems that for now providing such a workaround is easier than fixing Cython.

Explicit use of the `interp_<name>.h` headers replaces the implicit `cdef extern:` statements in the `wrapper_<name>.pxd` definition files.  This ensures that the function declarations (with the correct `__declspec` are included from the .h files, instead of being written directly into Cython-generated C files.  The end result has no visible differences for users of the library.

This currently depends on #20730 but doesn't strictly have to.  It was just easier to understand the code and see what needed to be changed where *after* it was refactored.

Issue created by migration from https://trac.sagemath.org/ticket/21459





---

archive/issue_comments_293932.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-09T12:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293932",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_293933.json:
```json
{
    "body": "Does not merge with 7.5.rc2",
    "created_at": "2017-01-08T06:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293933",
    "user": "https://github.com/cheuberg"
}
```

Does not merge with 7.5.rc2



---

archive/issue_comments_293934.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-08T06:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293934",
    "user": "https://github.com/cheuberg"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293935.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-04-11T12:51:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293935",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_293936.json:
```json
{
    "body": "Rebased--would be nice to get this fixed finally.  This workaround is still perhaps not an ideal solution to the problem, but it's been working well for quite some time now on my Cygwin branch.",
    "created_at": "2017-04-11T13:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293936",
    "user": "https://github.com/embray"
}
```

Rebased--would be nice to get this fixed finally.  This workaround is still perhaps not an ideal solution to the problem, but it's been working well for quite some time now on my Cygwin branch.



---

archive/issue_comments_293937.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-11T13:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293937",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293938.json:
```json
{
    "body": "If anyone wants to review this it's really only the last 3 commits on this branch that matter.  The rest is from #20730",
    "created_at": "2017-04-11T13:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293938",
    "user": "https://github.com/embray"
}
```

If anyone wants to review this it's really only the last 3 commits on this branch that matter.  The rest is from #20730



---

archive/issue_comments_293939.json:
```json
{
    "body": "Changing priority from minor to blocker.",
    "created_at": "2017-04-21T12:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293939",
    "user": "https://github.com/embray"
}
```

Changing priority from minor to blocker.



---

archive/issue_comments_293940.json:
```json
{
    "body": "This issue keeps coming up, can't we just fix it in Cython? This is at least the third time that Sage needs a workaround for the same Cython on Cygwin bug (the one which causes the `module_api` test in Cython to fail, which may or may not be fixed by https://github.com/cython/cython/pull/360).",
    "created_at": "2017-04-21T14:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293940",
    "user": "https://github.com/jdemeyer"
}
```

This issue keeps coming up, can't we just fix it in Cython? This is at least the third time that Sage needs a workaround for the same Cython on Cygwin bug (the one which causes the `module_api` test in Cython to fail, which may or may not be fixed by https://github.com/cython/cython/pull/360).



---

archive/issue_comments_293941.json:
```json
{
    "body": "I've already explained multiple times here and there (I thought on this ticket but apparently not?) it's easier to fix this here, now, than to fix it properly in Cython.  The PR you referenced does not fix this issue.",
    "created_at": "2017-04-21T16:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293941",
    "user": "https://github.com/embray"
}
```

I've already explained multiple times here and there (I thought on this ticket but apparently not?) it's easier to fix this here, now, than to fix it properly in Cython.  The PR you referenced does not fix this issue.



---

archive/issue_comments_293942.json:
```json
{
    "body": "Yes, but fixing the same issue independently in Sage *N* times takes *O(N)* time while fixing it in Cython takes *O(1)* time. Although I'm not making any claim about the constants...\n\nAnyway, let me look at the Cython issue, maybe I see something that you don't.",
    "created_at": "2017-04-21T16:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293942",
    "user": "https://github.com/jdemeyer"
}
```

Yes, but fixing the same issue independently in Sage *N* times takes *O(N)* time while fixing it in Cython takes *O(1)* time. Although I'm not making any claim about the constants...

Anyway, let me look at the Cython issue, maybe I see something that you don't.



---

archive/issue_comments_293943.json:
```json
{
    "body": "I don't think it's worth your time.  AFAIK this is the only place in Sage now or any time soon this needs to be addressed again.  I'm sure it can be fixed in Cython and am sure I could do it too, it was just annoying last I tried and this is much simpler.  Please, this ticket has been open for 7 months and I'm tired of rebasing it.  Just let it be...",
    "created_at": "2017-04-21T16:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293943",
    "user": "https://github.com/embray"
}
```

I don't think it's worth your time.  AFAIK this is the only place in Sage now or any time soon this needs to be addressed again.  I'm sure it can be fixed in Cython and am sure I could do it too, it was just annoying last I tried and this is much simpler.  Please, this ticket has been open for 7 months and I'm tired of rebasing it.  Just let it be...



---

archive/issue_comments_293944.json:
```json
{
    "body": "You can open a separate issue for the general problem and assign it to me if you want, but I really don't think it's a high priority.",
    "created_at": "2017-04-21T16:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293944",
    "user": "https://github.com/embray"
}
```

You can open a separate issue for the general problem and assign it to me if you want, but I really don't think it's a high priority.



---

archive/issue_comments_293945.json:
```json
{
    "body": "I don't want to be annoying, but this ticket depends on #20730 which depends on #20238, so it might not be merged soon anyway.",
    "created_at": "2017-04-21T17:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293945",
    "user": "https://github.com/jdemeyer"
}
```

I don't want to be annoying, but this ticket depends on #20730 which depends on #20238, so it might not be merged soon anyway.



---

archive/issue_comments_293946.json:
```json
{
    "body": "What is holding up #20238?  We could also invert that dependency considering that #20730 is much simpler.",
    "created_at": "2017-04-21T17:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293946",
    "user": "https://github.com/embray"
}
```

What is holding up #20238?  We could also invert that dependency considering that #20730 is much simpler.



---

archive/issue_comments_293947.json:
```json
{
    "body": "The only reason that dependency exists in the first place is due to a minor merge conflict that can be resolved in either direction.  I know you have good intentions in wanted to solve the problem generally and I agree, but it's not worth holding up any longer...",
    "created_at": "2017-04-21T17:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293947",
    "user": "https://github.com/embray"
}
```

The only reason that dependency exists in the first place is due to a minor merge conflict that can be resolved in either direction.  I know you have good intentions in wanted to solve the problem generally and I agree, but it's not worth holding up any longer...



---

archive/issue_comments_293948.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> What is holding up #20238?\n\nLack of reviewers.",
    "created_at": "2017-04-21T18:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293948",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 embray]:
> What is holding up #20238?

Lack of reviewers.



---

archive/issue_comments_293949.json:
```json
{
    "body": "Perhaps what we should ask is: Erik, are you willing to review #20238, and Jeroen, are you willing to review #20730? (Both in the near future.) Otherwise, I would say we should invert the dependency.",
    "created_at": "2017-04-23T02:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293949",
    "user": "https://github.com/tscrim"
}
```

Perhaps what we should ask is: Erik, are you willing to review #20238, and Jeroen, are you willing to review #20730? (Both in the near future.) Otherwise, I would say we should invert the dependency.



---

archive/issue_comments_293950.json:
```json
{
    "body": "It is still my opinion that it would be better to fix this ticket in Cython instead of adding yet another workaround in Sage. So in this view, it doesn't actually depend on #20730 and #20238.",
    "created_at": "2017-04-23T06:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293950",
    "user": "https://github.com/jdemeyer"
}
```

It is still my opinion that it would be better to fix this ticket in Cython instead of adding yet another workaround in Sage. So in this view, it doesn't actually depend on #20730 and #20238.



---

archive/issue_comments_293951.json:
```json
{
    "body": "This is such a minor fix though--it took me like an hour to make at the most.  Seven months ago.  I feel like I've spent more time arguing about this than I spent working on the fix in the first place--that's why I'm frustrated.  It would be easy to just merge this fix and then work on the \"general\" problem as time permits (the \"general\" problem, which I'll remind, currently does not affect any other code that I know of--as you suggested the constants here are not such that O(1) < O(N)).",
    "created_at": "2017-04-24T11:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293951",
    "user": "https://github.com/embray"
}
```

This is such a minor fix though--it took me like an hour to make at the most.  Seven months ago.  I feel like I've spent more time arguing about this than I spent working on the fix in the first place--that's why I'm frustrated.  It would be easy to just merge this fix and then work on the "general" problem as time permits (the "general" problem, which I'll remind, currently does not affect any other code that I know of--as you suggested the constants here are not such that O(1) < O(N)).



---

archive/issue_comments_293952.json:
```json
{
    "body": "I mean, Jeroen, if you think you can fix the issue in Cython obviously that's your prerogative and I'd welcome such a fix if it can be done in time for Sage 8.0.  Otherwise I'm happy to help with that too but not until after Sage 8.0 is out.  My main issue here is just getting all open Cygwin blockers fixed for 8.0, including this one, and I don't care *how* it's fixed.  I just don't want to spend time on chasing a general fix right now when I already have this one.  It's not like I actually care about merging this code for its own sake.",
    "created_at": "2017-04-24T13:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293952",
    "user": "https://github.com/embray"
}
```

I mean, Jeroen, if you think you can fix the issue in Cython obviously that's your prerogative and I'd welcome such a fix if it can be done in time for Sage 8.0.  Otherwise I'm happy to help with that too but not until after Sage 8.0 is out.  My main issue here is just getting all open Cygwin blockers fixed for 8.0, including this one, and I don't care *how* it's fixed.  I just don't want to spend time on chasing a general fix right now when I already have this one.  It's not like I actually care about merging this code for its own sake.



---

archive/issue_comments_293953.json:
```json
{
    "body": "Let's get this in as a temporary but simple workaround.",
    "created_at": "2017-04-27T11:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293953",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Let's get this in as a temporary but simple workaround.



---

archive/issue_comments_293954.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-27T11:51:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293954",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_293955.json:
```json
{
    "body": "It seems that this needs to be rebased.\n\nFor the record, I *guess* I can fix the problem using https://github.com/cython/cython/pull/1650 and https://github.com/cython/cython/pull/1687 and with the following trivial patch:\n\n```diff\ndiff --git a/src/sage_setup/autogen/interpreters.py b/src/sage_setup/autogen/interpreters.py\nindex 31526e6..4f8774f 100644\n--- a/src/sage_setup/autogen/interpreters.py\n+++ b/src/sage_setup/autogen/interpreters.py\n@@ -3267,7 +3267,6 @@ interp_{{ s.name }}(args\n \n         w(je(\"\"\"\n # {{ warn }}\n-# distutils: sources = sage/ext/interpreters/interp_{{ s.name }}.c\n {{ s.pyx_header }}\n \n include \"cysignals/memory.pxi\"\n@@ -3286,7 +3285,7 @@ cdef extern from \"Python.h\":\n \n from sage.ext.fast_callable cimport Wrapper\n \n-cdef extern:\n+cdef extern from \"|interp_{{ s.name }}.c\":\n     {{ myself.func_header(cython=true) -}}\n {% if s.err_return != 'NULL' %}\n  except? {{ s.err_return }}\n```\n\n\n(Only tested on Linux)",
    "created_at": "2017-04-28T10:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293955",
    "user": "https://github.com/jdemeyer"
}
```

It seems that this needs to be rebased.

For the record, I *guess* I can fix the problem using https://github.com/cython/cython/pull/1650 and https://github.com/cython/cython/pull/1687 and with the following trivial patch:

```diff
diff --git a/src/sage_setup/autogen/interpreters.py b/src/sage_setup/autogen/interpreters.py
index 31526e6..4f8774f 100644
--- a/src/sage_setup/autogen/interpreters.py
+++ b/src/sage_setup/autogen/interpreters.py
@@ -3267,7 +3267,6 @@ interp_{{ s.name }}(args
 
         w(je("""
 # {{ warn }}
-# distutils: sources = sage/ext/interpreters/interp_{{ s.name }}.c
 {{ s.pyx_header }}
 
 include "cysignals/memory.pxi"
@@ -3286,7 +3285,7 @@ cdef extern from "Python.h":
 
 from sage.ext.fast_callable cimport Wrapper
 
-cdef extern:
+cdef extern from "|interp_{{ s.name }}.c":
     {{ myself.func_header(cython=true) -}}
 {% if s.err_return != 'NULL' %}
  except? {{ s.err_return }}
```


(Only tested on Linux)



---

archive/issue_comments_293956.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-28T10:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293956",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_293957.json:
```json
{
    "body": "What does the pipe symbol mean in `cdef extern from \"|interp_{{ s.name }}.c\":`?  I don't recall seeing that syntax before.",
    "created_at": "2017-04-28T10:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293957",
    "user": "https://github.com/embray"
}
```

What does the pipe symbol mean in `cdef extern from "|interp_{{ s.name }}.c":`?  I don't recall seeing that syntax before.



---

archive/issue_comments_293958.json:
```json
{
    "body": "Nevermind; answered my own question by actually reading your links.",
    "created_at": "2017-04-28T10:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293958",
    "user": "https://github.com/embray"
}
```

Nevermind; answered my own question by actually reading your links.



---

archive/issue_comments_293959.json:
```json
{
    "body": "Needs rebasing.",
    "created_at": "2017-05-03T03:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293959",
    "user": "https://github.com/tscrim"
}
```

Needs rebasing.



---

archive/issue_comments_293960.json:
```json
{
    "body": "I know--I still want to test out Jeroen's idea for fixing this.  In the short term I think taking this patch as-is is more likely, since his fix involves bikeshedding in Cython.  But who knows--maybe we can come to a conclusion on that quickly.",
    "created_at": "2017-05-03T09:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293960",
    "user": "https://github.com/embray"
}
```

I know--I still want to test out Jeroen's idea for fixing this.  In the short term I think taking this patch as-is is more likely, since his fix involves bikeshedding in Cython.  But who knows--maybe we can come to a conclusion on that quickly.



---

archive/issue_comments_293961.json:
```json
{
    "body": "I tried building with a Cython with Jeroen's two patches applied, and with his suggested patch above, and early signs are good for this solving the problem.\n\nI'm still running full `ptestlong` just to be sure, but it compiled with no problems--bravo!\n\nAssuming this works, the question remains what to do in the short term.  There's still not a consensus on accepting [Cython-1650](https://github.com/cython/cython/pull/1650).  And even if it were accepted there's no consensus yet on the syntax.  \n\n1) We could accept my fix in the short term, if needed, and back it out later.  But that's slightly annoying, especially since it adds new generated files.\n\n2) Alternatively, we could patch Cython for now assuming that Jeroen's patch will be accepted *at some point*, but that's problematic for downstream support, especially considering the syntax uncertainties.\n\nI prefer 1) for now because I don't like relying on patches, especially when it means building is impossible downstream *without* those patches, and further still given that it's a not completely insignificant patch (it's a new feature to Cython, not just a bug fix).\n\nThat said, I'm okay with either way.",
    "created_at": "2017-05-11T13:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293961",
    "user": "https://github.com/embray"
}
```

I tried building with a Cython with Jeroen's two patches applied, and with his suggested patch above, and early signs are good for this solving the problem.

I'm still running full `ptestlong` just to be sure, but it compiled with no problems--bravo!

Assuming this works, the question remains what to do in the short term.  There's still not a consensus on accepting [Cython-1650](https://github.com/cython/cython/pull/1650).  And even if it were accepted there's no consensus yet on the syntax.  

1) We could accept my fix in the short term, if needed, and back it out later.  But that's slightly annoying, especially since it adds new generated files.

2) Alternatively, we could patch Cython for now assuming that Jeroen's patch will be accepted *at some point*, but that's problematic for downstream support, especially considering the syntax uncertainties.

I prefer 1) for now because I don't like relying on patches, especially when it means building is impossible downstream *without* those patches, and further still given that it's a not completely insignificant patch (it's a new feature to Cython, not just a bug fix).

That said, I'm okay with either way.



---

archive/issue_comments_293962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-05-11T13:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_293963.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-11T13:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293963",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293964.json:
```json
{
    "body": "Went ahead and rebased my existing branch, so that it's good to go if need be. But I'll await further feedback on how to move forward with this...",
    "created_at": "2017-05-11T13:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293964",
    "user": "https://github.com/embray"
}
```

Went ahead and rebased my existing branch, so that it's good to go if need be. But I'll await further feedback on how to move forward with this...



---

archive/issue_comments_293965.json:
```json
{
    "body": "I agree with you that 1) is not very satisfactory but is the way to go before the discussion about cython settles down.\n\nCould you use the :trac: syntax for http://trac.sagemath.org/ticket/19868\nAnd mention the way 2) should fix the wrongly generated headers in the docstrings, including ticket numbers on cython tracker?",
    "created_at": "2017-05-11T13:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293965",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I agree with you that 1) is not very satisfactory but is the way to go before the discussion about cython settles down.

Could you use the :trac: syntax for http://trac.sagemath.org/ticket/19868
And mention the way 2) should fix the wrongly generated headers in the docstrings, including ticket numbers on cython tracker?



---

archive/issue_comments_293966.json:
```json
{
    "body": "Sure, I'll fix that.",
    "created_at": "2017-05-11T15:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293966",
    "user": "https://github.com/embray"
}
```

Sure, I'll fix that.



---

archive/issue_comments_293967.json:
```json
{
    "body": "There are various changes on this patch which seem unrelated to Cygwin support: are those really needed? For example\n\n```diff\ndiff --git a/src/sage_setup/autogen/interpreters/specs/rr.py b/src/sage_setup/autogen/interpreters/specs/rr.py\nindex f4d3dc5..fe7a5cb 100644\n--- a/src/sage_setup/autogen/interpreters/specs/rr.py\n+++ b/src/sage_setup/autogen/interpreters/specs/rr.py\n@@ -184,9 +183,9 @@ class RRInterpreter(StackInterpreter):\n                         S=self.mc_stack,\n                         P=self.mc_py_constants)\n         self.pg = pg\n+        self.h_header = '#include <mpfr.h>'\n         self.c_header = ri(0,\n             '''\n-            #include <mpfr.h>\n             #include \"interpreters/wrapper_rr.h\"\n             ''')\n```\n\n\nFor the record: I prefer the solution of patching Cython and hoping that upstream Cython will fix it. Especially because the Sage patch here is quite invasive (adding new auto-generated files).\n\nI might be able to get my branch working without https://github.com/cython/cython/pull/1650 if that turns out to be problematic. But https://github.com/cython/cython/pull/1687 is really crucial for my approach to work.",
    "created_at": "2017-05-14T13:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293967",
    "user": "https://github.com/jdemeyer"
}
```

There are various changes on this patch which seem unrelated to Cygwin support: are those really needed? For example

```diff
diff --git a/src/sage_setup/autogen/interpreters/specs/rr.py b/src/sage_setup/autogen/interpreters/specs/rr.py
index f4d3dc5..fe7a5cb 100644
--- a/src/sage_setup/autogen/interpreters/specs/rr.py
+++ b/src/sage_setup/autogen/interpreters/specs/rr.py
@@ -184,9 +183,9 @@ class RRInterpreter(StackInterpreter):
                         S=self.mc_stack,
                         P=self.mc_py_constants)
         self.pg = pg
+        self.h_header = '#include <mpfr.h>'
         self.c_header = ri(0,
             '''
-            #include <mpfr.h>
             #include "interpreters/wrapper_rr.h"
             ''')
```


For the record: I prefer the solution of patching Cython and hoping that upstream Cython will fix it. Especially because the Sage patch here is quite invasive (adding new auto-generated files).

I might be able to get my branch working without https://github.com/cython/cython/pull/1650 if that turns out to be problematic. But https://github.com/cython/cython/pull/1687 is really crucial for my approach to work.



---

archive/issue_comments_293968.json:
```json
{
    "body": "I don't think you can get it working without PR 1650 either.  I mean all power to you if you can, but I tried and failed some time ago.  You know Cython's inner workings better than I do though.\n\nThe change you mention, however, was necessary for some reason. I just don't remember what it was because I worked on it, oh, 8 months ago.  But I'm fine with dumping it if you can put together an alternative branch including the necessary patches to Cython.  I'm still not super happy about the `|` syntax though, or the possibility of needing to change it later.  Another problem is that it's being put in unconditionally, which really this is only a problem on Windows, and yet you'd force downstream packagers (e.g. on Debian) to accept this patch to Cython in order for Sage to build *at all*.  So I don't think it's a good idea unless you can find some other workaround.",
    "created_at": "2017-05-15T12:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293968",
    "user": "https://github.com/embray"
}
```

I don't think you can get it working without PR 1650 either.  I mean all power to you if you can, but I tried and failed some time ago.  You know Cython's inner workings better than I do though.

The change you mention, however, was necessary for some reason. I just don't remember what it was because I worked on it, oh, 8 months ago.  But I'm fine with dumping it if you can put together an alternative branch including the necessary patches to Cython.  I'm still not super happy about the `|` syntax though, or the possibility of needing to change it later.  Another problem is that it's being put in unconditionally, which really this is only a problem on Windows, and yet you'd force downstream packagers (e.g. on Debian) to accept this patch to Cython in order for Sage to build *at all*.  So I don't think it's a good idea unless you can find some other workaround.



---

archive/issue_comments_293969.json:
```json
{
    "body": "`@`Eric: could you try moving back the headers include and check it still work?\n\nI would be very happy if Sage 8.0 could support Cygwin...",
    "created_at": "2017-05-16T08:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293969",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

`@`Eric: could you try moving back the headers include and check it still work?

I would be very happy if Sage 8.0 could support Cygwin...



---

archive/issue_comments_293970.json:
```json
{
    "body": "This seems to work without needing any additional Cython patches...\n\nIt's still a slight hack, but at least a simple hack.\n----\nNew commits:",
    "created_at": "2017-06-09T10:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293970",
    "user": "https://github.com/jdemeyer"
}
```

This seems to work without needing any additional Cython patches...

It's still a slight hack, but at least a simple hack.
----
New commits:



---

archive/issue_comments_293971.json:
```json
{
    "body": "Okay, I can see why this works.  But while you call it simple (and it is, in terms of impact), it's not very explicit what it's doing or why.  I don't mind that, if it works, for now, but it definitely needs more explanation about why it's needed and what it's doing (and under what circumstances it could eventually be removed).",
    "created_at": "2017-06-09T11:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293971",
    "user": "https://github.com/embray"
}
```

Okay, I can see why this works.  But while you call it simple (and it is, in terms of impact), it's not very explicit what it's doing or why.  I don't mind that, if it works, for now, but it definitely needs more explanation about why it's needed and what it's doing (and under what circumstances it could eventually be removed).



---

archive/issue_comments_293972.json:
```json
{
    "body": "I am correct when interpreting your comment as \"I accept Jeroen's patch, provided that some documentation is added\"?",
    "created_at": "2017-06-09T12:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293972",
    "user": "https://github.com/jdemeyer"
}
```

I am correct when interpreting your comment as "I accept Jeroen's patch, provided that some documentation is added"?



---

archive/issue_comments_293973.json:
```json
{
    "body": "Yes.",
    "created_at": "2017-06-09T12:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293973",
    "user": "https://github.com/embray"
}
```

Yes.



---

archive/issue_comments_293974.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-09T20:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293974",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293975.json:
```json
{
    "body": "Ping?",
    "created_at": "2017-06-14T08:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293975",
    "user": "https://github.com/jdemeyer"
}
```

Ping?



---

archive/issue_comments_293976.json:
```json
{
    "body": "Shouldn't it at least have a link back to this ticket?  Or if nothing else, we should open a new ticket to not forget to implement a \"better\" fix if/when the needed capabilities are in Cython.",
    "created_at": "2017-06-14T09:11:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293976",
    "user": "https://github.com/embray"
}
```

Shouldn't it at least have a link back to this ticket?  Or if nothing else, we should open a new ticket to not forget to implement a "better" fix if/when the needed capabilities are in Cython.



---

archive/issue_comments_293977.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-14T10:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293977",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293978.json:
```json
{
    "body": "Just doing commit pushes don't send trac e-mails unless you are in cc I've found.",
    "created_at": "2017-06-14T12:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293978",
    "user": "https://github.com/tscrim"
}
```

Just doing commit pushes don't send trac e-mails unless you are in cc I've found.



---

archive/issue_comments_293979.json:
```json
{
    "body": "(That was meant as a ping for Erik to note that Jeroen pushed another commit.)",
    "created_at": "2017-06-16T13:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293979",
    "user": "https://github.com/tscrim"
}
```

(That was meant as a ping for Erik to note that Jeroen pushed another commit.)



---

archive/issue_comments_293980.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-06-16T16:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293980",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_293981.json:
```json
{
    "body": "Dashed off a ticket to remind to fix this later: #23258",
    "created_at": "2017-06-16T16:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293981",
    "user": "https://github.com/embray"
}
```

Dashed off a ticket to remind to fix this later: #23258



---

archive/issue_events_020093.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-06-17T10:29:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/21222#event-20093"
}
```



---

archive/issue_comments_293982.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-06-17T10:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21222",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21222#issuecomment-293982",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
