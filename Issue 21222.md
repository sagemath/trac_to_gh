# Issue 21222: Fix building of sage_setup.autogen.interpreters output on Cygwin/Windows

Issue created by migration from https://trac.sagemath.org/ticket/21459

Original creator: embray

Original creation time: 2016-09-09 12:06:31

CC:  tscrim gouezel jpflori

This adds a new file generated for each interpreter, called `interp_<name>.h`.  Its purpose is to provide the correct `__declspec(dllexport/import)` on exported function definitions, so that they have the correct link-time behavior when building the interpreter wrappers themselves.

This is a workaround to #19868.  Ideally this would be fixed directly in Cython so that such a workaround is not needed, but after exploring the issue it seems that for now providing such a workaround is easier than fixing Cython.

Explicit use of the `interp_<name>.h` headers replaces the implicit `cdef extern:` statements in the `wrapper_<name>.pxd` definition files.  This ensures that the function declarations (with the correct `__declspec` are included from the .h files, instead of being written directly into Cython-generated C files.  The end result has no visible differences for users of the library.

This currently depends on #20730 but doesn't strictly have to.  It was just easier to understand the code and see what needed to be changed where _after_ it was refactored.


---

Comment by embray created at 2016-09-09 12:07:15

Changing status from new to needs_review.


---

Comment by cheuberg created at 2017-01-08 06:35:12

Does not merge with 7.5.rc2


---

Comment by cheuberg created at 2017-01-08 06:35:12

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-04-11 12:51:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-04-11 13:36:20

Rebased--would be nice to get this fixed finally.  This workaround is still perhaps not an ideal solution to the problem, but it's been working well for quite some time now on my Cygwin branch.


---

Comment by embray created at 2017-04-11 13:36:20

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-04-11 13:50:57

If anyone wants to review this it's really only the last 3 commits on this branch that matter.  The rest is from #20730


---

Comment by embray created at 2017-04-21 12:23:02

Changing priority from minor to blocker.


---

Comment by jdemeyer created at 2017-04-21 14:46:48

This issue keeps coming up, can't we just fix it in Cython? This is at least the third time that Sage needs a workaround for the same Cython on Cygwin bug (the one which causes the `module_api` test in Cython to fail, which may or may not be fixed by https://github.com/cython/cython/pull/360).


---

Comment by embray created at 2017-04-21 16:20:51

I've already explained multiple times here and there (I thought on this ticket but apparently not?) it's easier to fix this here, now, than to fix it properly in Cython.  The PR you referenced does not fix this issue.


---

Comment by jdemeyer created at 2017-04-21 16:41:51

Yes, but fixing the same issue independently in Sage _N_ times takes _O(N)_ time while fixing it in Cython takes _O(1)_ time. Although I'm not making any claim about the constants...

Anyway, let me look at the Cython issue, maybe I see something that you don't.


---

Comment by embray created at 2017-04-21 16:46:57

I don't think it's worth your time.  AFAIK this is the only place in Sage now or any time soon this needs to be addressed again.  I'm sure it can be fixed in Cython and am sure I could do it too, it was just annoying last I tried and this is much simpler.  Please, this ticket has been open for 7 months and I'm tired of rebasing it.  Just let it be...


---

Comment by embray created at 2017-04-21 16:59:23

You can open a separate issue for the general problem and assign it to me if you want, but I really don't think it's a high priority.


---

Comment by jdemeyer created at 2017-04-21 17:02:08

I don't want to be annoying, but this ticket depends on #20730 which depends on #20238, so it might not be merged soon anyway.


---

Comment by embray created at 2017-04-21 17:09:51

What is holding up #20238?  We could also invert that dependency considering that #20730 is much simpler.


---

Comment by embray created at 2017-04-21 17:12:48

The only reason that dependency exists in the first place is due to a minor merge conflict that can be resolved in either direction.  I know you have good intentions in wanted to solve the problem generally and I agree, but it's not worth holding up any longer...


---

Comment by jdemeyer created at 2017-04-21 18:14:13

Replying to [comment:14 embray]:
> What is holding up #20238?

Lack of reviewers.


---

Comment by tscrim created at 2017-04-23 02:48:17

Perhaps what we should ask is: Erik, are you willing to review #20238, and Jeroen, are you willing to review #20730? (Both in the near future.) Otherwise, I would say we should invert the dependency.


---

Comment by jdemeyer created at 2017-04-23 06:17:49

It is still my opinion that it would be better to fix this ticket in Cython instead of adding yet another workaround in Sage. So in this view, it doesn't actually depend on #20730 and #20238.


---

Comment by embray created at 2017-04-24 11:09:51

This is such a minor fix though--it took me like an hour to make at the most.  Seven months ago.  I feel like I've spent more time arguing about this than I spent working on the fix in the first place--that's why I'm frustrated.  It would be easy to just merge this fix and then work on the "general" problem as time permits (the "general" problem, which I'll remind, currently does not affect any other code that I know of--as you suggested the constants here are not such that O(1) < O(N)).


---

Comment by embray created at 2017-04-24 13:34:03

I mean, Jeroen, if you think you can fix the issue in Cython obviously that's your prerogative and I'd welcome such a fix if it can be done in time for Sage 8.0.  Otherwise I'm happy to help with that too but not until after Sage 8.0 is out.  My main issue here is just getting all open Cygwin blockers fixed for 8.0, including this one, and I don't care _how_ it's fixed.  I just don't want to spend time on chasing a general fix right now when I already have this one.  It's not like I actually care about merging this code for its own sake.


---

Comment by jpflori created at 2017-04-27 11:51:53

Let's get this in as a temporary but simple workaround.


---

Comment by jpflori created at 2017-04-27 11:51:53

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-04-28 10:12:00

It seems that this needs to be rebased.

For the record, I _guess_ I can fix the problem using https://github.com/cython/cython/pull/1650 and https://github.com/cython/cython/pull/1687 and with the following trivial patch:

```diff
diff --git a/src/sage_setup/autogen/interpreters.py b/src/sage_setup/autogen/interpreters.py
index 31526e6..4f8774f 100644
--- a/src/sage_setup/autogen/interpreters.py
+++ b/src/sage_setup/autogen/interpreters.py
@@ -3267,7 +3267,6 @@ interp_{{ s.name }}(args
 
         w(je("""
 # {{ warn }}
-# distutils: sources = sage/ext/interpreters/interp_{{ s.name }}.c
 {{ s.pyx_header }}
 
 include "cysignals/memory.pxi"
@@ -3286,7 +3285,7 @@ cdef extern from "Python.h":
 
 from sage.ext.fast_callable cimport Wrapper
 
-cdef extern:
+cdef extern from "|interp_{{ s.name }}.c":
     {{ myself.func_header(cython=true) -}}
 {% if s.err_return != 'NULL' %}
  except? {{ s.err_return }}
```


(Only tested on Linux)


---

Comment by embray created at 2017-04-28 10:44:36

Changing status from positive_review to needs_work.


---

Comment by embray created at 2017-04-28 10:45:33

What does the pipe symbol mean in `cdef extern from "|interp_{{ s.name }}.c":`?  I don't recall seeing that syntax before.


---

Comment by embray created at 2017-04-28 10:46:03

Nevermind; answered my own question by actually reading your links.


---

Comment by tscrim created at 2017-05-03 03:28:04

Needs rebasing.


---

Comment by embray created at 2017-05-03 09:01:06

I know--I still want to test out Jeroen's idea for fixing this.  In the short term I think taking this patch as-is is more likely, since his fix involves bikeshedding in Cython.  But who knows--maybe we can come to a conclusion on that quickly.


---

Comment by embray created at 2017-05-11 13:35:21

I tried building with a Cython with Jeroen's two patches applied, and with his suggested patch above, and early signs are good for this solving the problem.

I'm still running full `ptestlong` just to be sure, but it compiled with no problems--bravo!

Assuming this works, the question remains what to do in the short term.  There's still not a consensus on accepting [Cython-1650](https://github.com/cython/cython/pull/1650).  And even if it were accepted there's no consensus yet on the syntax.  

1) We could accept my fix in the short term, if needed, and back it out later.  But that's slightly annoying, especially since it adds new generated files.

2) Alternatively, we could patch Cython for now assuming that Jeroen's patch will be accepted _at some point_, but that's problematic for downstream support, especially considering the syntax uncertainties.

I prefer 1) for now because I don't like relying on patches, especially when it means building is impossible downstream _without_ those patches, and further still given that it's a not completely insignificant patch (it's a new feature to Cython, not just a bug fix).

That said, I'm okay with either way.


---

Comment by git created at 2017-05-11 13:43:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-05-11 13:44:16

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-05-11 13:44:16

Went ahead and rebased my existing branch, so that it's good to go if need be. But I'll await further feedback on how to move forward with this...


---

Comment by jpflori created at 2017-05-11 13:48:06

I agree with you that 1) is not very satisfactory but is the way to go before the discussion about cython settles down.

Could you use the :trac: syntax for http://trac.sagemath.org/ticket/19868
And mention the way 2) should fix the wrongly generated headers in the docstrings, including ticket numbers on cython tracker?


---

Comment by embray created at 2017-05-11 15:04:33

Sure, I'll fix that.


---

Comment by jdemeyer created at 2017-05-14 13:59:35

There are various changes on this patch which seem unrelated to Cygwin support: are those really needed? For example

```diff
diff --git a/src/sage_setup/autogen/interpreters/specs/rr.py b/src/sage_setup/autogen/interpreters/specs/rr.py
index f4d3dc5..fe7a5cb 100644
--- a/src/sage_setup/autogen/interpreters/specs/rr.py
+++ b/src/sage_setup/autogen/interpreters/specs/rr.py
@@ -184,9 +183,9 @@ class RRInterpreter(StackInterpreter):
                         S=self.mc_stack,
                         P=self.mc_py_constants)
         self.pg = pg
+        self.h_header = '#include <mpfr.h>'
         self.c_header = ri(0,
             '''
-            #include <mpfr.h>
             #include "interpreters/wrapper_rr.h"
             ''')
```


For the record: I prefer the solution of patching Cython and hoping that upstream Cython will fix it. Especially because the Sage patch here is quite invasive (adding new auto-generated files).

I might be able to get my branch working without https://github.com/cython/cython/pull/1650 if that turns out to be problematic. But https://github.com/cython/cython/pull/1687 is really crucial for my approach to work.


---

Comment by embray created at 2017-05-15 12:05:34

I don't think you can get it working without PR 1650 either.  I mean all power to you if you can, but I tried and failed some time ago.  You know Cython's inner workings better than I do though.

The change you mention, however, was necessary for some reason. I just don't remember what it was because I worked on it, oh, 8 months ago.  But I'm fine with dumping it if you can put together an alternative branch including the necessary patches to Cython.  I'm still not super happy about the `|` syntax though, or the possibility of needing to change it later.  Another problem is that it's being put in unconditionally, which really this is only a problem on Windows, and yet you'd force downstream packagers (e.g. on Debian) to accept this patch to Cython in order for Sage to build _at all_.  So I don't think it's a good idea unless you can find some other workaround.


---

Comment by jpflori created at 2017-05-16 08:49:48

`@`Eric: could you try moving back the headers include and check it still work?

I would be very happy if Sage 8.0 could support Cygwin...


---

Comment by jdemeyer created at 2017-06-09 10:04:48

This seems to work without needing any additional Cython patches...

It's still a slight hack, but at least a simple hack.
----
New commits:


---

Comment by embray created at 2017-06-09 11:42:40

Okay, I can see why this works.  But while you call it simple (and it is, in terms of impact), it's not very explicit what it's doing or why.  I don't mind that, if it works, for now, but it definitely needs more explanation about why it's needed and what it's doing (and under what circumstances it could eventually be removed).


---

Comment by jdemeyer created at 2017-06-09 12:47:47

I am correct when interpreting your comment as "I accept Jeroen's patch, provided that some documentation is added"?


---

Comment by embray created at 2017-06-09 12:57:32

Yes.


---

Comment by git created at 2017-06-09 20:48:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-06-14 08:25:46

Ping?


---

Comment by embray created at 2017-06-14 09:11:55

Shouldn't it at least have a link back to this ticket?  Or if nothing else, we should open a new ticket to not forget to implement a "better" fix if/when the needed capabilities are in Cython.


---

Comment by git created at 2017-06-14 10:27:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-14 12:07:20

Just doing commit pushes don't send trac e-mails unless you are in cc I've found.


---

Comment by tscrim created at 2017-06-16 13:36:24

(That was meant as a ping for Erik to note that Jeroen pushed another commit.)


---

Comment by embray created at 2017-06-16 16:01:58

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-06-16 16:16:41

Dashed off a ticket to remind to fix this later: #23258


---

Comment by vbraun created at 2017-06-17 10:29:06

Resolution: fixed
