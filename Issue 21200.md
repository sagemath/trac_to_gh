# Issue 21200: Some additions to the optional MeatAxe wrapper

Issue created by migration from https://trac.sagemath.org/ticket/21437

Original creator: SimonKing

Original creation time: 2016-09-06 12:44:38




---

Comment by SimonKing created at 2016-09-06 12:56:00

New commits:


---

Comment by SimonKing created at 2016-09-06 12:56:00

Changing status from new to needs_review.


---

Comment by SimonKing created at 2016-09-06 12:56:00

Changing type from PLEASE CHANGE to defect.


---

Comment by SimonKing created at 2016-09-06 12:56:00

Changing keywords from "" to "MeatAxe, matrix backend".


---

Comment by SimonKing created at 2016-09-06 12:56:00

Changing component from PLEASE CHANGE to packages: optional.


---

Comment by git created at 2016-09-06 15:12:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-09-08 09:06:01

I guess you forgot some `# optional` in the doctests 

```
**********************************************************************
File "src/sage/matrix/matrix_gfpn_dense.pyx", line 657, in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.get_slice
Failed example:
    from sage.matrix.matrix_gfpn_dense import Matrix_gfpn_dense as MTX
Exception raised:
    Traceback (most recent call last):
    ...
    ImportError: No module named matrix_gfpn_dense
**********************************************************************
```



---

Comment by git created at 2016-09-08 11:06:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2016-09-08 11:08:43

Replying to [comment:4 vdelecroix]:
> I guess you forgot some `# optional` in the doctests 

Done!


---

Comment by SimonKing created at 2016-09-12 10:25:22

The patchbot reports a timout. Is that reproducible?

Also, according to the coverage plugin, it seems that one function lacks testing. 

And I found that the function FfTrueRowSize is uselessly called in a couple of places: It always holds true that `FfCurrentRowSizeIo == FfTrueRowSize(FfNoc)`,  where FfCurrentRowSizeIo and FfNoc are both some global variables. Nevertheless, there are calls to `FfTrueRowSize(FfNoc)` in various places. When profiling my cohomology computations, a measurable amount of time was spent on FfTrueRowSize; therefore I want to create another patch.


---

Comment by SimonKing created at 2016-09-12 10:25:22

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-09-12 16:07:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2016-09-12 16:07:59

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-09-13 21:48:39

There are strange doctest errors on arando. Could you have a look?


---

Comment by vdelecroix created at 2016-09-13 21:48:39

Changing status from needs_review to needs_info.


---

Comment by git created at 2016-09-14 11:04:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2016-09-14 11:09:04

I have pushed another commit, since I made a typo in doc formatting.

Replying to [comment:10 vdelecroix]:
> There are strange doctest errors on arando. Could you have a look?

Maybe it isn't strange after all. It is about a random test. The values I provide in the test are what I get when I start a fresh Sage session, but probably I forgot that the random seed in doctests is different.

So, easy to fix...


---

Comment by git created at 2016-09-14 11:11:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2016-09-14 11:12:20

Fixed!


---

Comment by SimonKing created at 2016-09-14 11:12:20

Changing status from needs_info to needs_review.


---

Comment by SimonKing created at 2017-01-09 12:32:43

Admittedly, the bugs fixed here only concern users of the optional meataxe package. However, I'd appreciate a review. At least the patchbot seems happy about it.


---

Comment by jdemeyer created at 2017-02-22 10:04:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-02-22 10:04:12

For Python 3 compatibility, you should use `bytes` instead of `str` for pickling.

This means changing the `PyString_...` functions to `PyBytes_...` and this:

```diff
-def mtx_unpickle(f, int nr, int nc, str Data, bint m):
+def mtx_unpickle(f, int nr, int nc, bytes Data, bint m):
```



---

Comment by jdemeyer created at 2017-02-22 10:04:53

Replying to [ticket:21437 SimonKing]:
> - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.

Are you sure? I thought this was handled by the `MtxLibDir` array?


---

Comment by jdemeyer created at 2017-02-22 10:14:38

This is deprecated syntax:

```
for i from 0<=i<self.Data.Nor:
```

Cython understands `range()`.


---

Comment by jdemeyer created at 2017-02-22 10:15:28

You're not checking the result of this call:

```
d = <char*>sig_malloc(pickle_size)
```

you can use instead

```
d = check_malloc(pickle_size)
```



---

Comment by jdemeyer created at 2017-02-22 10:17:48

Wrong ticket:

```
deprecation(12345, "Reading this pickle may be machine dependent")
```



---

Comment by jdemeyer created at 2017-02-22 10:18:28

This function is not used nor tested anywhere:

```
cdef Matrix_t *rawMatrix(int Field, list entries) except NULL
```



---

Comment by jdemeyer created at 2017-02-22 10:20:31

Replace

```
 cdef extern from "Python.h":
     object PyString_FromStringAndSize(char *s, Py_ssize_t len)
     char* PyString_AsString(object string)
```

by

```
from cpython.bytes cimport PyBytes_FromStringAndSize, PyBytes_AsString
```



---

Comment by SimonKing created at 2017-02-22 10:22:49

Replying to [comment:17 jdemeyer]:
> Replying to [ticket:21437 SimonKing]:
> > - MeatAxe executable rely on an environment variable declaring where to find multiplication tables.
> 
> Are you sure? I thought this was handled by the `MtxLibDir` array?

Yes, I am sure. Setting the MtxLibDir variable in your programs works if your program calls mtx library functions. It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable. That's what the envirionment variable is for.


---

Comment by jdemeyer created at 2017-02-22 10:27:48

Replying to [comment:23 SimonKing]:
> It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.

And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?

You could set them in `sage-env` where many similar variables are handled.


---

Comment by SimonKing created at 2017-02-22 10:30:35

Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 SimonKing]:
> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.
> 
> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?

My modular group cohomology package does. It was made dysfunctional by changes in Sage, and my long-standing plan is to turn it into a new style package.


---

Comment by jdemeyer created at 2017-02-22 10:34:24

Replying to [comment:25 SimonKing]:
> My modular group cohomology package does.

Then I think you should either deal with those environment variables in your package or in `sage-env`. But not in `src/sage/matrix/matrix_gfpn_dense.pyx` which has absolutely nothing to do with running meataxe executables.


---

Comment by jdemeyer created at 2017-02-22 10:46:04

There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.


---

Comment by SimonKing created at 2017-07-08 12:22:00

It seems that I forgot to import a couple of things: sig_malloc, sig_free.

Currently I am using sig_malloc and sig_free, but check_realloc.
I wonder whether I use these functions correctly. Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?


---

Comment by jdemeyer created at 2017-07-08 12:47:56

Replying to [comment:28 SimonKing]:
> Reading the code in cysignals: Do I see correctly that sig_* functions would not raise an error (so that I have to test whether they return NULL, in which case I have to raise my own error), whereas check_* would raise an error?

Yes: `sig_malloc` would just return `NULL` when an allocation failed while `check_allocarray` would `raise MemoryError`.


---

Comment by git created at 2017-07-08 12:54:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-08 12:57:30

I think I have now addressed all your remarks, so, I put it back to "needs review".

One question, though. While building the code, I see one warning:

```
[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function 'initmatrix_gfpn_dense':
[sagelib-8.0.rc1] /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:19604:22: warning: passing argument 1 of 'MtxSetErrorHandler' from incompatible pointer type [-Wincompatible-pointer-types]
[sagelib-8.0.rc1]    MtxSetErrorHandler(__pyx_f_4sage_6matrix_17matrix_gfpn_dense_ErrorHandler);
[sagelib-8.0.rc1]                       ^
[sagelib-8.0.rc1] In file included from /home/king/Sage/git/sage/src/build/cythonized/sage/matrix/matrix_gfpn_dense.c:479:0:
[sagelib-8.0.rc1] /home/king/Sage/git/sage/local/include/meataxe.h:371:20: note: expected 'void (*)(const MtxErrorRecord_t *) {aka void (*)(const struct <anonymous> *)}' but argument is of type 'void (*)(MtxErrorRecord_t *) {aka void (*)(struct <anonymous> *)}'
[sagelib-8.0.rc1]  MtxErrorHandler_t *MtxSetErrorHandler(MtxErrorHandler_t *h);
[sagelib-8.0.rc1]                     ^
```

How could I fix that?


---

Comment by SimonKing created at 2017-07-08 12:57:30

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-08 13:11:05

Replying to [comment:27 jdemeyer]:
> There are also some very dubious uses of `sig_on()` in `src/sage/matrix/matrix_gfpn_dense.pyx`, but let's keep that for a different ticket.

Would you insist on a different ticket, or could I try to fix it here?


---

Comment by SimonKing created at 2017-07-08 13:27:03

I guess in some places I also have to replace `cdef str` by `cdef bytes`...


---

Comment by SimonKing created at 2017-07-08 13:27:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-08 14:39:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-08 14:39:59

Replying to [comment:33 SimonKing]:
> I guess in some places I also have to replace `cdef str` by `cdef bytes`...

Done. But I think I should also have a look at the `sig_on()` thingy...


---

Comment by SimonKing created at 2017-07-08 14:43:35

Question: By "dubious use of sig_on", do you mean stuff like the following?

```
                sig_on()
                if nc%MPB:
                    for i in range(nr):
                        y = <unsigned char*>x
                        for j in range(FfCurrentRowSizeIo-1):
                            y[j] = randint()%O
                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))
                        FfStepPtr(&(x))
                else:
                    for i in range(nr):
                        y = <unsigned char*>x
                        for j in range(FfCurrentRowSizeIo):
                            y[j] = randint()%O
                        FfStepPtr(&(x))
                sig_off()
```

Somewhere I was reading that sig_on/sig_off should be used if there are potentially long c commands, whereas in the code above (only very short commands are executed in tight loops) one should use sig_check.

Did I describe the intended use of sig_* correctly?


---

Comment by git created at 2017-07-08 15:39:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-08 15:41:50

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-08 15:41:50

Replying to [comment:36 SimonKing]:
> Did I describe the intended use of sig_* correctly?

I hope that the last commit did improve the situation.


---

Comment by SimonKing created at 2017-07-08 16:09:06

I hate git.

My plan was to merge this ticket with #23352 (from my point of view it doesn't matter what is merged into what).

But there is a merge conflict. Although #23352 only has a very small diff, git apparently reports conflicts all over the place. WTF? In #23352, we just have

```diff
diff --git a/src/sage/matrix/matrix_gfpn_dense.pyx b/src/sage/matrix/matrix_gfpn_dense.pyx
index 7b5fac9..a5b4ecb 100644
--- a/src/sage/matrix/matrix_gfpn_dense.pyx
+++ b/src/sage/matrix/matrix_gfpn_dense.pyx
@@ -703,6 +703,12 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
             [2*z^2 + 2*z + 2               0               0   2*z^2 + z + 2               0         2*z + 1]
             [              0       2*z^2 + z               0               1               0   2*z^2 + z + 1]
 
+        The following tests against a bug that was fixed in :trac:`23352`::
+
+            sage: MS = MatrixSpace(GF(9,'x'),1,5)
+            sage: MS.random_element()     # optional: meataxe
+            [x + 1     x     2 x + 2 x + 2]
+
         """
         self.check_mutability()
         cdef int fl = self.Data.Field
@@ -741,7 +747,8 @@ cdef class Matrix_gfpn_dense(Matrix_dense):
                         y = <unsigned char*>x
                         for j from 0 <= j < FfCurrentRowSizeIo-1:
                             y[j] = randint()%O
-                        y[FfCurrentRowSizeIo-1] = randint()%(fl**(nc%MPB))
+                        for j from nc-(nc%MPB) <= j < nc:
+                            FfInsert(x, j, FfFromInt( (randint()%fl) ))
                         FfStepPtr(&(x))
                 else:
                     for i from 0 <= i < nr:
```

By definition, we don't have conflicts in parts of the file that are untouched by the above diff!

Really, I hate git.


---

Comment by SimonKing created at 2017-07-08 21:43:20

Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 SimonKing]:
> > It will not work when you call a meataxe executable that does *not* set the MtxLibDir variable.
> 
> And which part of `src/sage/matrix/matrix_gfpn_dense.pyx` calls a meataxe executable?
> 
> You could set them in `sage-env` where many similar variables are handled.

Working on #18514, I found that the situation is confusing for me.

My plan was:

- With the current code from here and #23352, `sage.matrix.matrix_gfpn_dense` overrides the MtxLibDir variable that is declared in `sage.libs.meataxe`, but it doesn't touch the environment variables.
- The cohomology code cimports MtxLibDir from `sage.matrix.matrix_gfpn_dense` and reads its content. It is then also written into an environment variable, so that the MTX-executables can find the multiplication tables.

The reality is:

- When the cohomology code cimports MtxLibDir, its content is a certain location in `/usr/local/`, which is where the multiplication tables can NOT be found. Thus, any computation crashes.

If I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library. Hence, any Cython module and any C program using meataxe has to define MtxLibDir explicitly: Cimporting it won't suffice.


---

Comment by SimonKing created at 2017-07-08 22:19:16

The following would work:

- Define MtxLibDir in sage.matrix.matrix_gfpn_dense.
- Use a copy, say, `_MtxLibDr`
- As it turns out, when cimporting `_MtxLibDir`, one gets the correct value. Hence, one uses `_MtxLibDir` to override MtxLibDir in any module that uses the meataxe library.

Do you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?


---

Comment by git created at 2017-07-08 22:43:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-08 22:46:38

Replying to [comment:41 SimonKing]:
> Do you agree to add `_MtxLibDir` in this ticket, although I will only need it in #18514?

... as in the latest commit.


---

Comment by jdemeyer created at 2017-07-10 07:50:05

Replying to [comment:36 SimonKing]:
> Question: By "dubious use of sig_on", do you mean stuff like the following?

Not quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where _Python_ code is inside `sig_on()` blocks, which shouldn't be done.


---

Comment by jdemeyer created at 2017-07-10 07:56:14

Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.

Things like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.


---

Comment by SimonKing created at 2017-07-10 08:52:46

Replying to [comment:45 jdemeyer]:
> Concerning `MtxLibDir`: I think that part of the problem comes from insufficient separation between (1) the MeatAxe library and (2) the implementation of matrices using MeatAxe.
> 
> Things like dealing with the `MtxLibDir` and also the error handler really have nothing to do with matrices and should be moved to `src/sage/libs/meataxe.pyx`. If you set `MtxLibDir` in `src/sage/libs/meataxe.pyx` and you `import sage.libs.meataxe`, then that should work too and it's a much cleaner solution.

OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`), and it also means that I need to import, right? "cimport" wouldn't suffice?


---

Comment by SimonKing created at 2017-07-10 08:57:17

Replying to [comment:44 jdemeyer]:
> Replying to [comment:36 SimonKing]:
> > Question: By "dubious use of sig_on", do you mean stuff like the following?
> 
> Not quite, that example is acceptable, although you certainly could `sig_check()` there. I meant cases where _Python_ code is inside `sig_on()` blocks, which shouldn't be done.

I think I have removed all such cases. `sig_on()` now only appears three times in the code, namely

```python
        sig_on()
        OUT.Data = MatDup(self.Data)
        MatMul(OUT.Data,right.Data)
        sig_off()
```


```python
        sig_on()
        MatMulStrassen(OUT.Data, self.Data, right.Data)
        sig_off()
```


```python
        sig_on()
        try:
            OUT.Data = MatInverse(self.Data)
        except ZeroDivisionError:
            sig_off()
            raise
        sig_off()
```

It doesn't involve python code, right?


---

Comment by jdemeyer created at 2017-07-10 09:43:20

The error handler involves Python code. So to be extra-safe, it would be better to surround the call to `PyErr_SetObject` with `sig_block()`/`sig_unblock()`.

PS: 12437 is still not the correct Trac ticket.


---

Comment by jdemeyer created at 2017-07-10 09:45:07

Replying to [comment:46 SimonKing]:
> OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)

Yes, that is what I meant.

> and it also means that I need to import, right? "cimport" wouldn't suffice?

Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).


---

Comment by jdemeyer created at 2017-07-10 09:56:34

[comment:22] has not been addressed


---

Comment by SimonKing created at 2017-07-10 10:15:21

Replying to [comment:49 jdemeyer]:
> Replying to [comment:46 SimonKing]:
> > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)
> 
> Yes, that is what I meant.
> 
> > and it also means that I need to import, right? "cimport" wouldn't suffice?
> 
> Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).

No, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.

And comment:22 *has* been addressed. There is no `PyString` in the files.


---

Comment by git created at 2017-07-10 10:17:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-07-10 10:20:32

Sorry, I meant replacing

```
cdef extern from "Python.h":
    char* PyBytes_AsString(object string)
```

by

```
from cpython.bytes cimport PyBytes_AsString
```

Note also that Cython can auto-convert between `bytes` and `char*`, so this function might not be needed at all.


---

Comment by SimonKing created at 2017-07-10 10:21:23

Replying to [comment:51 SimonKing]:
> Replying to [comment:49 jdemeyer]:
> > Replying to [comment:46 SimonKing]:
> > > OK, but it means that I need to add a new module (currently, there is only the pxd file `src/sage/libs/meataxe.pxd`)
> > 
> > Yes, that is what I meant.
> > 
> > > and it also means that I need to import, right? "cimport" wouldn't suffice?
> > 
> > Yes, I think so. You need `import sage.libs.meataxe` (there is nothing you need to import from that, but you need to ensure that the module is loaded).
> 
> No, it doesn't work. Apparently each cython module that is linked against the dynamic meataxe library needs to do the assignment of MtxLibDir and also needs to fix the error handler.

Example, with the latest commit:

```
sage: M = random_matrix(GF(81,'x'),1000)
MTX location /usr/local/mtx/lib
os.c(254):p081.zzz: No such file or directory
```

which is an unhandled crash. So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).

How can this be overcome?


---

Comment by SimonKing created at 2017-07-10 10:26:03

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2017-07-10 10:57:55

Replying to [comment:54 SimonKing]:
> ... So, both MtxLibDir is not visible for `sage.matrix.matrix_gfpn_dense` (otherwise meataxe would find the multiplication table) and the error handler is not defined (otherwise it would raise an error rather than crash).
> 
> How can this be overcome?

By this, I mean: We have modules A,B,C, and A is supposed to do some initialisation to a dynamic library that A, B and C link against. Is it possible to make it so that "import A" in B and C automatically executes code that will do the initialisation in B resp. in C rather than only in A?

Here, we have A=sage.libs.meataxe, B=sage.matrix.matrix_gfpn_dense and C=the cohomology code from #18514


---

Comment by SimonKing created at 2017-07-10 11:11:12

A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.

However, that sounds like an ugly hack.


---

Comment by jdemeyer created at 2017-07-10 11:14:30

Replying to [comment:40 SimonKing]:
> If I recall correctly, the reason for the bad behaviour is the fact that the meataxe library is a dynamic, not a static, library.

You're swapping "static" and "dynamic" but otherwise you are right: the problem with static libraries is that each Cython module gets its own "copy" of the static library.


---

Comment by jdemeyer created at 2017-07-10 11:16:42

Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.


---

Comment by SimonKing created at 2017-07-10 11:22:15

Replying to [comment:59 jdemeyer]:
> Looking at the MeatAxe `Makefile`, there is no support for building as dynamic library.

Would it be difficult to add support? After all, we are patching meataxe anyway.


---

Comment by jdemeyer created at 2017-07-10 11:26:47

Replying to [comment:60 SimonKing]:
> Would it be difficult to add support? After all, we are patching meataxe anyway.

Instead of "adding support", I would prefer to rewrite the build system to use autotools. Probably not hard, but not fun either.


---

Comment by jdemeyer created at 2017-07-10 11:28:32

Replying to [comment:57 SimonKing]:
> A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.

Here is a better idea: in `meataxe.pxd`, define an inline function

```
cdef inline init_meataxe():
    # set up MtxLibDir and error handler
```

Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.


---

Comment by SimonKing created at 2017-07-10 11:36:59

Replying to [comment:62 jdemeyer]:
> Replying to [comment:57 SimonKing]:
> > A potential solution would be to write `sage.libs.meataxe.pxi`, and then include the .pxi file rather than cimport.
> 
> Here is a better idea: in `meataxe.pxd`, define an inline function
> {{{
> cdef inline init_meataxe():
>     # set up MtxLibDir and error handler
> }}}
> Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.

Let's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.


---

Comment by jdemeyer created at 2017-07-10 11:48:45

Replying to [comment:63 SimonKing]:
> Let's see if it works. I did the same with a function defined in sage.libs.meataxe.pyx (that I added only for that purpose), and it did not work.

The difference between an _inline_ function and a regular function is crucial here.


---

Comment by SimonKing created at 2017-07-10 12:07:15

Replying to [comment:63 SimonKing]:
> > Here is a better idea: in `meataxe.pxd`, define an inline function
> > {{{
> > cdef inline init_meataxe():
> >     # set up MtxLibDir and error handler
> > }}}
> > Then you just need to call `init_meataxe()` in the module(s) where you want to use MeatAxe.

Doesn't work. At least not when I do the following:

In sage/libs/meataxe.pxd

```python
cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    from sage.env import DOT_SAGE
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
```

In sage/matrix/matrix_gfpn_dense.pyx:

```python
print("MTX location", MtxLibDir)
meataxe_init()
print("New location", MtxLibDir)
```

Before and after calling meataxe_init() I get the same wrong location.


---

Comment by SimonKing created at 2017-07-10 12:09:42

I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.


---

Comment by jdemeyer created at 2017-07-10 12:15:32

Replying to [comment:65 SimonKing]:
> {{{
> #!python
> cdef inline meataxe_init():
>     ## Define an environment variable that enables MeatAxe to find
>     ## its multiplication tables.
>     from sage.env import DOT_SAGE
>     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
> }}}

That's a beginner Python bug :-)

You need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.


---

Comment by jdemeyer created at 2017-07-10 12:16:47

Replying to [comment:66 SimonKing]:
> I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.

No, this is about the *Cython* interpretation of `inline`. Whether the *C* compiler inlines it or not is irrelevant.


---

Comment by SimonKing created at 2017-07-10 12:17:25

Replying to [comment:68 jdemeyer]:
> Replying to [comment:66 SimonKing]:
> > I guess the problem is the import statement in the "cdef inline" function. IIRC, "inline" is only a hint for the compiler, not a strict order. And apparently the compiler decided to not inline it.
> 
> No, this is about the *Cython* interpretation of `inline`. Whether the *C* compiler inlines it or not is irrelevant.

Anyway, it doesn't work.


---

Comment by SimonKing created at 2017-07-10 12:19:19

Replying to [comment:67 jdemeyer]:
> Replying to [comment:65 SimonKing]:
> > {{{
> > #!python
> > cdef inline meataxe_init():
> >     ## Define an environment variable that enables MeatAxe to find
> >     ## its multiplication tables.
> >     from sage.env import DOT_SAGE
> >     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
> > }}}

In the same pxd file:

```
    cdef extern char MtxLibDir[1024]    # Where to search/create multiplication tables
```

Is "global" needed, then?
> That's a beginner Python bug :-)
> 
> You need `global MtxLibDir` otherwise `MtxLibDir` will be treated as local variable.


---

Comment by jdemeyer created at 2017-07-10 12:21:12

Replying to [comment:70 SimonKing]:
> Is "global" needed, then?

Yes. The rules for global/local variables in Cython are exactly the same as for Python.


---

Comment by SimonKing created at 2017-07-10 12:25:03

The following doesn't work either:

```
cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    global MtxLibDir
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
    ## Error handling for MeatAxe, to prevent immediate exit of the program
    MtxSetErrorHandler(ErrorHandler)
```


Here, I have moved the definition into a pyx file, where I do all the python imports and also the definition of a the dictionary that is used in the ErrorHandler --- am I right that it would be problematic to define the dictionary in a pxd file?


---

Comment by jdemeyer created at 2017-07-10 12:27:17

Replying to [comment:72 SimonKing]:
> Here, I have moved the definition into a pyx file

Don't! This *MUST* be inline and it *MUST* be in the `.pxd` file.


---

Comment by jdemeyer created at 2017-07-10 12:30:25

Replying to [comment:72 SimonKing]:
> am I right that it would be problematic to define the dictionary in a pxd file?

Probably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file. Something like:

```
cdef void ErrorHandler(...)

cdef inline meataxe_init():
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
    global MtxLibDir
    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
    ## Error handling for MeatAxe, to prevent immediate exit of the program
    MtxSetErrorHandler(ErrorHandler)
```



---

Comment by SimonKing created at 2017-07-10 12:31:51

Replying to [comment:74 jdemeyer]:
> Replying to [comment:72 SimonKing]:
> > am I right that it would be problematic to define the dictionary in a pxd file?
> 
> Probably yes. You can move the error handler itself to the `.pyx` file but the call `MtxSetErrorHandler` in `init_meataxe()` in the `.pxd` file.

Hooray, that seems to work!


---

Comment by jdemeyer created at 2017-07-10 12:36:27

BTW: I would change the name `ErrorHandler` to something more descriptive, like `sage_meataxe_error_handler` or something.


---

Comment by git created at 2017-07-10 12:58:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-10 12:59:48

Am I right in guessing that I shouldn't simplify the git history of this ticket? After all, there are commits that just revert what previous commits have done.
----
New commits:


---

Comment by git created at 2017-07-10 13:01:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-10 13:01:59

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-10 13:05:09

Replying to [comment:78 SimonKing]:
> Am I right in guessing that I shouldn't simplify the git history of this ticket?

It depends mainly on whether you think that somebody else is building on top of your branch here. I guess chances are very small , so you could simplify the git history. Just keep in mind #23352.


---

Comment by jdemeyer created at 2017-07-10 13:10:13

For Python 3 compatibility, it would be good to add

```
from __future__ import absolute_import, division
```

in `src/sage/matrix/matrix_gfpn_dense.pyx`

Then you should also use floor division if that's what you want, for example here:

```
cdef size_t pickled_rowsize = len(Data)/nr
```

There might be other such places too, I have not checked.


---

Comment by jdemeyer created at 2017-07-10 13:14:46

Replying to [ticket:21437 SimonKing]:
> - There are some auxiliary functions that I would like to use in my group cohomology package (related with slicing).

Since this patch is getting rather big, would it be possible to separate this part? Then we could keep this ticket just to fix things, not adding new functionality.

If you feel up to it, I would actually suggest to split it up even further. For example, the pickling fixes alone deserve a separate ticket.

NOTE: I'm not saying this just out of principle. My experience is that it's a lot easier to get multiple small tickets reviewed than one big ticket.


---

Comment by jdemeyer created at 2017-07-10 13:15:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-10 13:15:06

The deprecation ticket number is still wrong.


---

Comment by jdemeyer created at 2017-07-10 13:20:48

About this comment:


```
###############################################################
## It is needed to do some initialisation. Since meataxe is
## a dynamic library, it is needed to do this initialisation
## in all modules cimporting sage.libs.meataxe. So, you HAVE
## to call the meataxe_init() function when you cimport sage.libs.meataxe!
```


1. Replace "dynamic" by "static"

2. It's not really correct that `meataxe_init()` must be called whenever `sage.libs.meataxe` is cimported. It's more correct to say that `meataxe_init()` must be called whenever the MeatAxe library is used. This may seem like a silly difference, but it is possible that some module needs access to some MeatAxe type (say, to pass around pointers or for simple conversions) without actually using anything from the MeatAxe static library.


---

Comment by git created at 2017-07-10 13:49:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-10 14:14:48

If I see that correctly, the following git commits belong to this ticket:

* b6c8114 - (HEAD -> t/21437/fix-mtx-matrices) Make matrix_gfpn_dense python 3 compliant; fix a deprecation (20 seconds ago) <Simon King>
* 08e03c2 - Change ErrorHandler into sage_meataxe_error_handler (48 minutes ago) <Simon King>
* 353a8b9 - meataxe_init() inline function (49 minutes ago) <Simon King>
* 67a85ca - Move meataxe definitions from sage.matrix to sage.libs (4 hours ago) <Simon King>
* 6a65600 - Use a fixed copy of MtxLibDir (2 days ago) <Simon King>
* 04e7986 - Improve use of sig_on/off/check (2 days ago) <Simon King>
* b70bc5f - Change some str into bytes (2 days ago) <Simon King>
* c929fcc - Remove unused MTX* environment variables (2 days ago) <Simon King>
* d943f93 - Remove rawMatrix function (2 days ago) <Simon King>
* 413e4a9 - Remove deprecated Cython syntax, use check_malloc (2 days ago) <Simon King>
* 5ed2269 - Fix one doctest (10 months ago) <Simon King>
* 03ce5c0 - Fix bad INPUT::/OUTPUT:: blocks (10 months ago) <Simon King>
* 291f4dc - Some minor tweaks for performance (10 months ago) <Simon King>
* e17e4df - Document and test _rowlist_() (10 months ago) <Simon King>
* a4dded9 - Make new tests optional (10 months ago) <Simon King>
* 4f3d56c - Fix index check in get_slice (10 months ago) <Simon King>
* e861781 - Add c(p)def functions to get/set horizontal matrix slices (10 months ago) <Simon King>
* 02fa8a2 - Make pickling machine independent (10 months ago) <Simon King>
* 778df7d - Help using MeatAxe executables in Sage (10 months ago) <Simon King>
* 9e0f5d4 - Fix reading mtx-matrix from non-existent file (10 months ago) <Simon King>

On top of that, #23352 adds one more commit:
* 6e33226 - (t/23352/fix_random_matrix_gfpn_dense) Properly fill the last few columns of random meataxe matrices (2 days ago) <Simon King>

OK, quite a lot...

How to split that into smaller chunks? I see the following four topics:

1. Bug fixes, for example:
  * 6e33226 - Properly fill the last few columns of random meataxe matrices
  * 02fa8a2 - Make pickling machine independent
  * 9e0f5d4 - Fix reading mtx-matrix from non-existent file
2. Code style/cleanliness, for example:
  * b6c8114 - Make matrix_gfpn_dense python 3 compliant
  * 04e7986 - Improve use of sig_on/off/check
  * b70bc5f - Change some str into bytes
  * 413e4a9 - Remove deprecated Cython syntax, use check_malloc
  * d943f93 - Remove rawMatrix function 
3. Proper MeatAxe initialisation, for example
  * 08e03c2 - Change ErrorHandler? into sage_meataxe_error_handler
  * 353a8b9 - meataxe_init() inline function
  * 67a85ca - Move meataxe definitions from sage.matrix to sage.libs
  * c929fcc - Remove unused MTX* environment variables
4. Additions, for example
  * e17e4df - Document and test _rowlist_()
  * e861781 - Add c(p)def functions to get/set horizontal matrix slices

Since this ticket's name is about "addition", I suggest to deal with 4. *here*.

Since #23352 is about fixing something, I suggest to deal with 1. *there*, and make it a dependency of everything else.

And then there should be two new tickets for 2. and 3. Probably I will not cherry-pick commits, but will go through the whole diff and manually move stuff to the different topics.
Does that sound reasonable to you?
----
New commits:


---

Comment by git created at 2017-07-11 11:08:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by SimonKing created at 2017-07-11 11:10:11

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-11 11:10:11

From my perspective, the work is done. Thus, together with #23352, #23399 and #23400, it needs review!


---

Comment by SimonKing created at 2017-07-12 18:51:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-13 00:03:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2017-07-13 00:22:58

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-07-13 00:22:58

I hope it is ok that this now has three dependencies...


---

Comment by SimonKing created at 2017-07-16 13:03:12

#23410 is not a dependency (and merges cleanly). So, let's simplify the list of dependencies.


---

Comment by git created at 2017-07-16 13:42:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-16 13:43:21

Manual merging of the last few commits of #23352 was needed.


---

Comment by jdemeyer created at 2017-07-17 12:43:01

Better use `RuntimeError` instead of `SystemError` for unknown error messages.


---

Comment by SimonKing created at 2017-07-17 12:46:58

Replying to [comment:98 jdemeyer]:
> Better use `RuntimeError` instead of `SystemError` for unknown error messages.

OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).


---

Comment by jdemeyer created at 2017-07-17 13:00:51

Replying to [comment:99 SimonKing]:
> Replying to [comment:98 jdemeyer]:
> > Better use `RuntimeError` instead of `SystemError` for unknown error messages.
> 
> OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).

`OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.


---

Comment by SimonKing created at 2017-07-17 14:59:42

Replying to [comment:100 jdemeyer]:
> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
> 
> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.

In that case I should change the current IOError as well. And since #23411 introduces another test with a SystemError that should better be an OSError, I'll merge #23411.


---

Comment by git created at 2017-07-17 15:12:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-07-17 15:13:34

Replying to [comment:100 jdemeyer]:
> Replying to [comment:99 SimonKing]:
> > Replying to [comment:98 jdemeyer]:
> > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.
> > 
> > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
> 
> `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.

Done and done!


---

Comment by SimonKing created at 2017-08-18 14:24:18

Replying to [comment:103 SimonKing]:
> Replying to [comment:100 jdemeyer]:
> > Replying to [comment:99 SimonKing]:
> > > Replying to [comment:98 jdemeyer]:
> > > > Better use `RuntimeError` instead of `SystemError` for unknown error messages.
> > > 
> > > OK. Also, I found another case where I could be more specific (namely: If a file of a given name doesn't exist, which I guess should result in an !IOError).
> > 
> > `OSError` instead of `IOError` because `IOError` is just an alias of `OSError` in Python 3.
> 
> Done and done!

I think I have addressed all objections...


---

Comment by tscrim created at 2017-08-25 22:42:42

Jeroen, do you plan on finishing the review on this ticket? You already have been through this code and are more of a Cython expert than I am. However, I can probably finishing reviewing this ticket if you'd prefer.


---

Comment by jdemeyer created at 2017-08-30 15:38:24

Viewing the diff of this ticket fails with HTTP error 500. I just sent an email to `sagemath-admins` for this.


---

Comment by embray created at 2017-08-31 12:44:41

For now the best thing to do might be to rebase this on the latest develop branch and then `git push -f`.  SimonKing: Let me know if you need any help with the git-fu.


---

Comment by jdemeyer created at 2017-08-31 12:52:31

I just did that.
----
New commits:


---

Comment by jdemeyer created at 2017-08-31 12:57:23

This is not going to work on Python 3:

```
MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE, 'meataxe'))
```

(the reason is that `os.path.join(DOT_SAGE, 'meataxe')` is `unicode`, not `bytes`.

I'm not sure if this should hold back this ticket, there are probably many issues like this in Sage.


---

Comment by jdemeyer created at 2017-08-31 13:04:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-08-31 13:04:53

Some imports can be cleaned up.

You can remove

```
cdef extern from "Python.h":
    object PyString_FromStringAndSize(char *s, Py_ssize_t len)
    char* PyString_AsString(object string)
```

and

```
####################
#
# auxiliary functions
#
####################
import sys
from libc.string cimport memcpy
```


I would also remove

```
from libc.stdlib cimport free
```

and replace `free()` by `sig_free()` in `free(old)`.


---

Comment by embray created at 2017-08-31 13:05:50

Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frédéric) pull their hair out later.

For one, why is it unicode (on Python 2) in the first place?


---

Comment by jdemeyer created at 2017-08-31 13:09:56

Replying to [comment:112 embray]:
> For one, why is it unicode (on Python 2) in the first place?

It's really `str` which is `bytes` on Python 2 but `unicode` (a.k.a. `str`) on Python 3.


---

Comment by jdemeyer created at 2017-08-31 13:12:21

Replying to [comment:112 embray]:
> Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frédéric) pull their hair out later.

Right, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx


---

Comment by SimonKing created at 2017-08-31 13:51:29

What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?


---

Comment by SimonKing created at 2017-08-31 13:58:00

Replying to [comment:115 SimonKing]:
> What should `os.path.join(DOT_SAGE, 'meataxe')` be replaced with? Shouldn't both Python2 and Python3 just do the right thing, given whatever type DOT_SAGE and 'meataxe' are in the respective Python version?

Sorry, I just realise that `PyBytes_AsString` is the probable culprit.

In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?


---

Comment by jdemeyer created at 2017-08-31 14:06:52

Replying to [comment:116 SimonKing]:
> In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?

It's not so easy, see [comment:114]


---

Comment by SimonKing created at 2017-09-01 09:24:42

Replying to [comment:117 jdemeyer]:
> Replying to [comment:116 SimonKing]:
> > In any case, can you tell me precisely what the line should be replaced with, so that it works both in Python2 and Python3?
> 
> It's not so easy, see [comment:114]

If I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.

So, for now, I will change the code only according to your other objections.


---

Comment by SimonKing created at 2017-09-01 09:37:39

Replying to [comment:118 SimonKing]:
> If I understand correctly, it currently has to stay as it is and needs to be addressed as soon as Sage really moves on.
> 
> So, for now, I will change the code only according to your other objections.

Done. Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.


---

Comment by SimonKing created at 2017-09-01 09:37:39

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-09-01 09:56:28

Replying to [comment:114 jdemeyer]:
> Replying to [comment:112 embray]:
> > Let me think about this for a sec.  While it's true there are many issues like this in Sage, if we're aware of one now it would be better to address it now rather than make people working on the Python 3 port (i.e. Frédéric) pull their hair out later.
> 
> Right, but we might want to consider implementing/using a general solution to the problem of converting filenames (or strings in general) from `unicode` to `bytes`. Something along the lines of https://github.com/defeo/cypari2/blob/master/cypari2/string_utils.pyx

I see. I didn't realize that wasn't already the case.  Is there any reason these have to be written in Cython? I don't see functions like these getting much speedup from it.  In any case , maybe I can just copy these directly into Sage and sprinkle them around the appropriate places.


---

Comment by jdemeyer created at 2017-09-01 12:05:46

Replying to [comment:121 embray]:
> I don't see functions like these getting much speedup from it.

You do get the speedup from _calling_ those functions (calling a `cdef` function vs. calling a Python function).

And for `cypari2`, Cython was an obvious choice since `cypari2` is completely implemented in Cython.


---

Comment by jdemeyer created at 2017-09-04 10:26:27

Replying to [comment:120 SimonKing]:
> Why did `sage -git trac push` not change the commit field but only the branch field? I changed the commit field manually.

Known bug: https://github.com/sagemath/sage_trac_plugin/issues/10


---

Comment by jdemeyer created at 2017-09-06 08:28:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-09-06 08:28:53

[comment:85]


---

Comment by jdemeyer created at 2017-09-06 08:33:29

Also: please merge 8.1.beta4


---

Comment by git created at 2017-09-11 12:23:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-09-11 12:24:30

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2017-09-11 12:24:30

Done, so "needs review", with the caveat that I didn't run tests again.


---

Comment by jdemeyer created at 2017-09-14 11:42:49

One detail:

```
    ## Define an environment variable that enables MeatAxe to find
    ## its multiplication tables.
```

It's not an environment variable, it's a string inside the meataxe library.

If you fix this comment, you can set this ticket to positive review.


---

Comment by git created at 2017-09-14 12:23:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2017-09-14 12:25:12

Thank you! I hope the comment is fine now.


---

Comment by SimonKing created at 2017-09-14 12:25:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-15 07:30:59

Resolution: fixed
