# Issue 30024: Immutability for manifold objects

Issue created by migration from https://trac.sagemath.org/ticket/30261

Original creator: @mjungmath

Original creation time: 2020-07-31 13:29:57

CC:  egourgoulhon mkoeppe tscrim

Keywords: immutable

According to #30181, tensor fields, scalar fields, sections and (bundle) connections are a priori mutable. However, it should be possible to make them immutable to make them hashable.

Connections and bundle connections are already hashable even though they are not immutable. This will be changed accordingly to #30181 in this ticket.


---

Comment by @mjungmath created at 2020-07-31 20:18:16

I haven't found any active use of the `Mutability` class in the whole Sage library. For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections. Either one adds such a class to `sage.structure.mutability` or, since the aforementioned class is not actively used anywhere, rename it accordingly (like `ElementWithMutability`) and adding an inheritance from `SageObject`. Of course, I would open another ticket for that. Probably, the `ModuleElementWithMutability` should be shifted in that file, too?

There is another issue, I have encountered due to the dependence of #30181. I simply changed the following lines in `sage.manifolds.differentiable.tensorfield`:


```diff
-from sage.structure.element import ModuleElement
+from sage.structure.element import ModuleElementWithMutability

-class TensorField(ModuleElement):
+class TensorField(ModuleElementWithMutability):

-        ModuleElement.__init__(self, parent)
+        super().__init__(parent)
```


and I get the following error message:


```
sage: M = Manifold(2, 'M')
sage: U = M.open_subset('U'); V = M.open_subset('V')
sage: c_xy.<x,y> = U.chart(); c_uv.<u,v> = V.chart()
Traceback (most recent call last)
...
TypeError: __init__() missing 1 required positional argument: 'tensor_type'
```



---

Comment by mkoeppe created at 2020-07-31 20:36:09

If you `super`, all `__init__`s need to have a compatible signature...


---

Comment by tscrim created at 2020-08-01 01:48:50

Replying to [comment:6 gh-mjungmath]:
> For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections.

Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.

> Probably, the `ModuleElementWithMutability` should be shifted in that file, too?

-1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.


---

Comment by @mjungmath created at 2020-08-01 06:26:58

Replying to [comment:8 tscrim]:
> Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.

You mean


```diff
-class AffineConnection(SageObject):
+class AffineConnection(SageObject, Mutability):
```


Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.

> 
> > Probably, the `ModuleElementWithMutability` should be shifted in that file, too?
> 
> -1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.

Alright, that makes sense.

---

The inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:


```
File "src/sage/manifolds/differentiable/affine_connection.py", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__
Failed example:
    TestSuite(nab).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
        test_method(tester=tester)
      File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
        tester.assertEqual(loads(dumps(self)), self)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 839, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 832, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M
    ------------------------------------------------------------
    The following tests failed: _test_pickling
```



---

Comment by tscrim created at 2020-08-01 09:31:54

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:8 tscrim]:
> > Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.
> 
> You mean
> 
> {{{
> #!diff
> -class AffineConnection(SageObject):
> +class AffineConnection(SageObject, Mutability):
> }}}
> 
> Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.

No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.

> ----
> 
> The inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:
> 
> {{{
> File "src/sage/manifolds/differentiable/affine_connection.py", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__
> Failed example:
>     TestSuite(nab).run()
> Expected nothing
> Got:
>     Failure in _test_pickling:
>     Traceback (most recent call last):
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
>         test_method(tester=tester)
>       File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
>         tester.assertEqual(loads(dumps(self)), self)
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 839, in assertEqual
>         assertion_func(first, second, msg=msg)
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 832, in _baseAssertEqual
>         raise self.failureException(msg)
>     AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M
>     ------------------------------------------------------------
>     The following tests failed: _test_pickling
> }}}
> 

Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.


---

Comment by @mjungmath created at 2020-08-01 10:17:08

Replying to [comment:10 tscrim]:
> > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.
> 
> No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.

I'm confused because `SageObject` and `Mutability` both add methods and


```diff
-class FreeModuleTensor(ModuleElement):
+class FreeModuleTensor(ModuleElement, Mutability):
```


won't work. What is the difference? Is it because `ModuleElement` already is inherited?

> Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.
 
Mh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.


---

Comment by @mjungmath created at 2020-08-01 13:03:00

Let's work step-wise here. Scalar fields made no problem, I have created a new ticket devoted to them: #30266.


---

Comment by @mjungmath created at 2020-08-02 20:53:35

Changing type from defect to task.


---

Comment by tscrim created at 2020-08-03 12:08:41

Replying to [comment:11 gh-mjungmath]:
> Replying to [comment:10 tscrim]:
> > > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.
> > 
> > No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.
> 
> I'm confused because `SageObject` and `Mutability` both add methods and
> 
> {{{
> #!diff
> -class FreeModuleTensor(ModuleElement):
> +class FreeModuleTensor(ModuleElement, Mutability):
> }}}
> 
> won't work. What is the difference? Is it because `ModuleElement` already is inherited?

Won't work how? The difference with what? The pickling/`__reduce__` issue is because of the implementation of `Mutability`, not a Python/Cython issue. I need something more precise here.

> > Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.
>  
> Mh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.

You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).


---

Comment by @mjungmath created at 2020-08-03 12:40:56

Replying to [comment:18 tscrim]:
> You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).

Would you agree if I remove `__reduce__` from `Mutability`?

> Won't work how? The difference with what? 

My example above raises a type error while doctesting:


```
TypeError: multiple bases have instance lay-out conflict
```


Wasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.


---

Comment by tscrim created at 2020-08-03 12:51:59

Replying to [comment:19 gh-mjungmath]:
> Replying to [comment:18 tscrim]:
> > You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).
> 
> Would you agree if I remove `__reduce__` from `Mutability`?

Yes, but that should be done on a separate ticket.

> > Won't work how? The difference with what? 
> 
> My example above raises a type error while doctesting:
> 
> {{{
> TypeError: multiple bases have instance lay-out conflict
> }}}
> 
> Wasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.

There is a technical reason with incompatible slots in the Cython classes. However, this was not the original intent of this class. The reason is Sage vectors are Cython classes, not Python classes, which only have single inheritance. So they cannot have mixin classes. All of this is done to optimize them because linear algebra needs to be fast.


---

Comment by @mjungmath created at 2020-08-07 13:03:22

Changing keywords from "immutable" to "immutability".


---

Comment by @mjungmath created at 2020-08-07 13:15:23

That should be all. In case I missed something, please let me know.


---

Comment by @mjungmath created at 2021-01-04 18:12:21

The pickling test still fails, though #30281. See [here](https://trac.sagemath.org/ticket/30310#comment:13). Made a ticket, see #31182.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by @mjungmath created at 2021-05-01 10:33:14

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-05-01 10:33:21

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-06-30 09:54:25

Changing status from positive_review to needs_info.


---

Comment by slelievre created at 2021-06-30 09:54:25

By positive review, do you mean all goals of this meta-ticket are complete?

We might want to wait for #31706 to be merged before closing here.

Once that is done, maybe set the milestone here to sage-duplicate/invalid/wontfix?


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by @mjungmath created at 2021-07-25 13:33:18

Changing status from needs_info to positive_review.


---

Comment by slelievre created at 2021-07-25 13:50:22

Resolution: fixed
