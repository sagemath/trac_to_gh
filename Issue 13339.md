# Issue 13339: Multi-character variables not supported in legend_labels

Issue created by migration from Trac.

Original creator: mjo

Original creation time: 2012-09-28 02:27:51

Assignee: jason, was

CC:  kcrisman

The simplest example I have is,


```
sage: hello = var('hello')
sage: latex(hello)
\mbox{hello}
sage: label = '$' + latex(hello) + '$'                    
sage: label
$ \mbox{hello} $
sage: plot(x, x, 0, 1, legend_label=label)
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (409, 0))
...
ParseFatalException: Expected end of math '$'
$ \mbox{hello} $ (at char 0), (line:1, col:1)
```


It seems that matplotlib doesn't understand `\mbox`. If that's the bug to be fixed, we can simply replace `\mbox` with `\rm` when passing to matplotlib.

On the other hand, if I've declared `hello` to be a symbolic variable, shouldn't it be marked up as a symbolic variable (i.e. left in math mode)?



---

Comment by mjo created at 2012-10-20 01:28:19

Ok, I finally got a chance to look at this. Matplotlib doesn't use a full TeX implementation by default. It has its own subset called _mathtext_ that it uses unless you tell it to do otherwise via,


```
from matplotlib import rcParams
rcParams['text.usetex']=True
```


This requires you to have "TeX" available in your `$PATH`, whatever that means. I've done some experimenting and it's possible to set this globally via,


```
#text.usetex         : False # use latex for all text handling.
```


in `local/lib/python2.7/site-packages/matplotlib/mpl-data/matplotlibrc`.

However, I have a full, standalone LaTeX installed everywhere that I work, so I'm not sure if doing this would break a clean install.


---

Comment by mjo created at 2012-10-20 02:10:54

Ok, that doesn't work on a clean install (you can set an empty `$PATH` to convince it to crash). It requires ghostscript, dvipng (see #12276), and full tex installation. For a workaround, you can add,


```
from matplotlib import rcParams
rcParams['text.usetex'] = True
```


to `~/.sage/init.sage`. The real fix would be one of the following:

1. Get Matplotlib to support `\mbox` in their _mathtext_ package.
2. Replace all occurrences of `\mbox` in Sage with `\mathrm`. This might cause regressions.
3. Ship tex, ghostscript, and dvipng with Sage.


---

Comment by ppurka created at 2013-06-17 03:20:54

Please check if #14664 fixes this ticket. If so, we can close this.


---

Comment by mjo created at 2013-06-17 05:22:18

I don't know, because I can't plot anything thanks to #12276 =)

I'm *guessing* that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:

1. My example in the description will still crash.

2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.


---

Comment by ppurka created at 2013-06-17 07:21:02

Replying to [comment:4 mjo]:
> I don't know, because I can't plot anything thanks to #12276 =)
> 
> I'm *guessing* that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:
> 
> 1. My example in the description will still crash.

Works for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.

```
...5.10.rc0.sagenb/local/lib» ldd libgd.so | grep jpeg
...rc0.sagenb/local/lib [1] » ldd /usr/lib/libgd.so | grep jpeg
	libjpeg.so.8 => /usr/lib64/libjpeg.so.8 (0x00000030b4200000)
...5.10.rc0.sagenb/local/lib» sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/punarbasu/Installations/sage-5.10.rc0.sagenb
...5.10.rc0.sagenb/local/lib» which -a dvipng
/usr/bin/dvipng
...5.10.rc0.sagenb/local/lib»
```


> 2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.

We can not expect to package latex with Sage. Latex packages are _huge_! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.


---

Comment by mjo created at 2013-06-19 12:03:46

Replying to [comment:5 ppurka]:
> Replying to [comment:4 mjo]:
> > I don't know, because I can't plot anything thanks to #12276 =)
> > 
> > I'm *guessing* that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:
> > 
> > 1. My example in the description will still crash.
> 
> Works for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.

Sorry, like I said, I was just guessing. Did you try running dvipng from within the sage shell? This is what I get:


```
gantu ~ $ dvipng foo.dvi 
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
gantu ~ $ sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/mjo/src/sage-5.10.rc2
(sage-sh) mjo`@`gantu:~$ dvipng foo.dvi
dvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr
(sage-sh) mjo`@`gantu:~$
```



> We can not expect to package latex with Sage. Latex packages are _huge_! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.

There's a GSOC project that will hopefully go a long ways towards fixing the build system, but if you're going to decide to ship all of sage's dependencies, you've really got to ship all of them. Otherwise certain parts of the program will break, apparently at random.


---

Comment by ppurka created at 2013-06-19 12:36:05

dvipng works from inside sage -sh for me.

```
/tmp/a» ls
a.dvi
/tmp/a» dvipng a.dvi
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
/tmp/a» ls
a1.png	a.dvi
/tmp/a» sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/mnt/usb/Installations/sage-5.10.rc0
/tmp/a» rm a1.png
/tmp/a» dvipng a.dvi
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
/tmp/a» ls
a1.png	a.dvi
```



---

Comment by mjo created at 2013-06-19 12:47:18

Replying to [comment:7 ppurka]:
> dvipng works from inside sage -sh for me.

Huh. And you use Gentoo, right? So we built dvipng the same way. Beats me.


---

Comment by ppurka created at 2013-06-19 12:53:24

Yes. Using pure (i.e. _not_ one of the "forks" like Funtoo, Sabayon, etc) amd64 Gentoo here. :)

Edit: One thing that is different is my shell. I am using zsh.


---

Comment by novoselt created at 2014-04-04 19:51:13

Works fine with 6.2.beta6


---

Comment by mjo created at 2014-04-05 21:40:01

Looks like it:


```
sage: hello = var('hello')
sage: latex(hello)
\mathit{hello}
```


The absence of \mbox probably makes a better unit test than the presence of \mathit.


---

Comment by novoselt created at 2014-04-05 21:44:56

I think the test for this ticket should be that plotting command works - what exactly is fed into it is not as relevant. Feel free to write the test and I'll review it ;-)


---

Comment by mjo created at 2014-04-08 15:26:05

Before the fix, the variable was math-escaped (as well as unplottable). A much lesser bug for sure, but now it's correctly marked up as a variable. I guess we should test that too but checking for \mbox or \mathrm is all I can think of.


---

Comment by mjo created at 2015-12-04 01:59:41

I guess I shouldn't leave this open forever.
----
New commits:


---

Comment by mjo created at 2015-12-04 01:59:41

Changing status from new to needs_review.


---

Comment by kcrisman created at 2015-12-04 02:42:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-12-05 10:01:17

Resolution: fixed
