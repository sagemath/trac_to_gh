# Issue 13339: Multi-character variables not supported in legend_labels

archive/issues_013339.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  kcrisman\n\nThe simplest example I have is,\n\n\n```\nsage: hello = var('hello')\nsage: latex(hello)\n\\mbox{hello}\nsage: label = '$' + latex(hello) + '$'                    \nsage: label\n$ \\mbox{hello} $\nsage: plot(x, x, 0, 1, legend_label=label)\nERROR: An unexpected error occurred while tokenizing input\nThe following traceback may be corrupted or invalid\nThe error message is: ('EOF in multi-line statement', (409, 0))\n...\nParseFatalException: Expected end of math '$'\n$ \\mbox{hello} $ (at char 0), (line:1, col:1)\n```\n\n\nIt seems that matplotlib doesn't understand `\\mbox`. If that's the bug to be fixed, we can simply replace `\\mbox` with `\\rm` when passing to matplotlib.\n\nOn the other hand, if I've declared `hello` to be a symbolic variable, shouldn't it be marked up as a symbolic variable (i.e. left in math mode)?\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13543\n\n",
    "created_at": "2012-09-28T02:27:51Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "title": "Multi-character variables not supported in legend_labels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13339",
    "user": "mjo"
}
```
Assignee: jason, was

CC:  kcrisman

The simplest example I have is,


```
sage: hello = var('hello')
sage: latex(hello)
\mbox{hello}
sage: label = '$' + latex(hello) + '$'                    
sage: label
$ \mbox{hello} $
sage: plot(x, x, 0, 1, legend_label=label)
ERROR: An unexpected error occurred while tokenizing input
The following traceback may be corrupted or invalid
The error message is: ('EOF in multi-line statement', (409, 0))
...
ParseFatalException: Expected end of math '$'
$ \mbox{hello} $ (at char 0), (line:1, col:1)
```


It seems that matplotlib doesn't understand `\mbox`. If that's the bug to be fixed, we can simply replace `\mbox` with `\rm` when passing to matplotlib.

On the other hand, if I've declared `hello` to be a symbolic variable, shouldn't it be marked up as a symbolic variable (i.e. left in math mode)?


Issue created by migration from https://trac.sagemath.org/ticket/13543





---

archive/issue_comments_163888.json:
```json
{
    "body": "Ok, I finally got a chance to look at this. Matplotlib doesn't use a full TeX implementation by default. It has its own subset called *mathtext* that it uses unless you tell it to do otherwise via,\n\n\n```\nfrom matplotlib import rcParams\nrcParams['text.usetex']=True\n```\n\n\nThis requires you to have \"TeX\" available in your `$PATH`, whatever that means. I've done some experimenting and it's possible to set this globally via,\n\n\n```\n#text.usetex         : False # use latex for all text handling.\n```\n\n\nin `local/lib/python2.7/site-packages/matplotlib/mpl-data/matplotlibrc`.\n\nHowever, I have a full, standalone LaTeX installed everywhere that I work, so I'm not sure if doing this would break a clean install.",
    "created_at": "2012-10-20T01:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163888",
    "user": "mjo"
}
```

Ok, I finally got a chance to look at this. Matplotlib doesn't use a full TeX implementation by default. It has its own subset called *mathtext* that it uses unless you tell it to do otherwise via,


```
from matplotlib import rcParams
rcParams['text.usetex']=True
```


This requires you to have "TeX" available in your `$PATH`, whatever that means. I've done some experimenting and it's possible to set this globally via,


```
#text.usetex         : False # use latex for all text handling.
```


in `local/lib/python2.7/site-packages/matplotlib/mpl-data/matplotlibrc`.

However, I have a full, standalone LaTeX installed everywhere that I work, so I'm not sure if doing this would break a clean install.



---

archive/issue_comments_163889.json:
```json
{
    "body": "Ok, that doesn't work on a clean install (you can set an empty `$PATH` to convince it to crash). It requires ghostscript, dvipng (see #12276), and full tex installation. For a workaround, you can add,\n\n\n```\nfrom matplotlib import rcParams\nrcParams['text.usetex'] = True\n```\n\n\nto `~/.sage/init.sage`. The real fix would be one of the following:\n\n1. Get Matplotlib to support `\\mbox` in their *mathtext* package.\n2. Replace all occurrences of `\\mbox` in Sage with `\\mathrm`. This might cause regressions.\n3. Ship tex, ghostscript, and dvipng with Sage.",
    "created_at": "2012-10-20T02:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163889",
    "user": "mjo"
}
```

Ok, that doesn't work on a clean install (you can set an empty `$PATH` to convince it to crash). It requires ghostscript, dvipng (see #12276), and full tex installation. For a workaround, you can add,


```
from matplotlib import rcParams
rcParams['text.usetex'] = True
```


to `~/.sage/init.sage`. The real fix would be one of the following:

1. Get Matplotlib to support `\mbox` in their *mathtext* package.
2. Replace all occurrences of `\mbox` in Sage with `\mathrm`. This might cause regressions.
3. Ship tex, ghostscript, and dvipng with Sage.



---

archive/issue_comments_163890.json:
```json
{
    "body": "Please check if #14664 fixes this ticket. If so, we can close this.",
    "created_at": "2013-06-17T03:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163890",
    "user": "ppurka"
}
```

Please check if #14664 fixes this ticket. If so, we can close this.



---

archive/issue_comments_163891.json:
```json
{
    "body": "I don't know, because I can't plot anything thanks to #12276 =)\n\nI'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:\n\n1. My example in the description will still crash.\n\n2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.",
    "created_at": "2013-06-17T05:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163891",
    "user": "mjo"
}
```

I don't know, because I can't plot anything thanks to #12276 =)

I'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:

1. My example in the description will still crash.

2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.



---

archive/issue_comments_163892.json:
```json
{
    "body": "Replying to [comment:4 mjo]:\n> I don't know, because I can't plot anything thanks to #12276 =)\n> \n> I'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:\n> \n> 1. My example in the description will still crash.\n\nWorks for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.\n\n```\n...5.10.rc0.sagenb/local/lib\u00bb ldd libgd.so | grep jpeg\n...rc0.sagenb/local/lib [1] \u00bb ldd /usr/lib/libgd.so | grep jpeg\n\tlibjpeg.so.8 => /usr/lib64/libjpeg.so.8 (0x00000030b4200000)\n...5.10.rc0.sagenb/local/lib\u00bb sage -sh\n\nStarting subshell with Sage environment variables set.  Don't forget\nto exit when you are done.  Beware:\n * Do not do anything with other copies of Sage on your system.\n * Do not use this for installing Sage packages using \"sage -i\" or for\n   running \"make\" at Sage's root directory.  These should be done\n   outside the Sage shell.\n\nBypassing shell configuration files...\n\nNote: SAGE_ROOT=/home/punarbasu/Installations/sage-5.10.rc0.sagenb\n...5.10.rc0.sagenb/local/lib\u00bb which -a dvipng\n/usr/bin/dvipng\n...5.10.rc0.sagenb/local/lib\u00bb\n```\n\n\n> 2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.\n\nWe can not expect to package latex with Sage. Latex packages are *huge*! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.",
    "created_at": "2013-06-17T07:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163892",
    "user": "ppurka"
}
```

Replying to [comment:4 mjo]:
> I don't know, because I can't plot anything thanks to #12276 =)
> 
> I'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:
> 
> 1. My example in the description will still crash.

Works for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.

```
...5.10.rc0.sagenb/local/lib» ldd libgd.so | grep jpeg
...rc0.sagenb/local/lib [1] » ldd /usr/lib/libgd.so | grep jpeg
	libjpeg.so.8 => /usr/lib64/libjpeg.so.8 (0x00000030b4200000)
...5.10.rc0.sagenb/local/lib» sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/punarbasu/Installations/sage-5.10.rc0.sagenb
...5.10.rc0.sagenb/local/lib» which -a dvipng
/usr/bin/dvipng
...5.10.rc0.sagenb/local/lib»
```


> 2. None of this works on a bare sage install, the user has to go find the missing ghostscript, latex, and dvipng dependencies and install them himself.

We can not expect to package latex with Sage. Latex packages are *huge*! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.



---

archive/issue_comments_163893.json:
```json
{
    "body": "Replying to [comment:5 ppurka]:\n> Replying to [comment:4 mjo]:\n> > I don't know, because I can't plot anything thanks to #12276 =)\n> > \n> > I'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:\n> > \n> > 1. My example in the description will still crash.\n> \n> Works for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.\n\nSorry, like I said, I was just guessing. Did you try running dvipng from within the sage shell? This is what I get:\n\n\n```\ngantu ~ $ dvipng foo.dvi \nThis is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson\n[1] \ngantu ~ $ sage -sh\n\nStarting subshell with Sage environment variables set.  Don't forget\nto exit when you are done.  Beware:\n * Do not do anything with other copies of Sage on your system.\n * Do not use this for installing Sage packages using \"sage -i\" or for\n   running \"make\" at Sage's root directory.  These should be done\n   outside the Sage shell.\n\nBypassing shell configuration files...\n\nNote: SAGE_ROOT=/home/mjo/src/sage-5.10.rc2\n(sage-sh) mjo@gantu:~$ dvipng foo.dvi\ndvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr\n(sage-sh) mjo@gantu:~$\n```\n\n\n\n> We can not expect to package latex with Sage. Latex packages are *huge*! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.\n\nThere's a GSOC project that will hopefully go a long ways towards fixing the build system, but if you're going to decide to ship all of sage's dependencies, you've really got to ship all of them. Otherwise certain parts of the program will break, apparently at random.",
    "created_at": "2013-06-19T12:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163893",
    "user": "mjo"
}
```

Replying to [comment:5 ppurka]:
> Replying to [comment:4 mjo]:
> > I don't know, because I can't plot anything thanks to #12276 =)
> > 
> > I'm **guessing** that it will work if I use `typeset='latex'` or `typeset='type1'` everywhere, but there are two problems:
> > 
> > 1. My example in the description will still crash.
> 
> Works for me. I have no problems with plotting with `typeset='latex'`. And my (external) dvipng is compiled with jpeg. My Sage's gd is not linked to jpeg, but the system gd is.

Sorry, like I said, I was just guessing. Did you try running dvipng from within the sage shell? This is what I get:


```
gantu ~ $ dvipng foo.dvi 
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
gantu ~ $ sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/home/mjo/src/sage-5.10.rc2
(sage-sh) mjo@gantu:~$ dvipng foo.dvi
dvipng: symbol lookup error: dvipng: undefined symbol: gdImageCreateFromJpegPtr
(sage-sh) mjo@gantu:~$
```



> We can not expect to package latex with Sage. Latex packages are *huge*! We are better off asking the user to install them externally, especially since they are not an essential component of Sage.

There's a GSOC project that will hopefully go a long ways towards fixing the build system, but if you're going to decide to ship all of sage's dependencies, you've really got to ship all of them. Otherwise certain parts of the program will break, apparently at random.



---

archive/issue_comments_163894.json:
```json
{
    "body": "dvipng works from inside sage -sh for me.\n\n```\n/tmp/a\u00bb ls\na.dvi\n/tmp/a\u00bb dvipng a.dvi\nThis is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson\n[1] \n/tmp/a\u00bb ls\na1.png\ta.dvi\n/tmp/a\u00bb sage -sh\n\nStarting subshell with Sage environment variables set.  Don't forget\nto exit when you are done.  Beware:\n * Do not do anything with other copies of Sage on your system.\n * Do not use this for installing Sage packages using \"sage -i\" or for\n   running \"make\" at Sage's root directory.  These should be done\n   outside the Sage shell.\n\nBypassing shell configuration files...\n\nNote: SAGE_ROOT=/mnt/usb/Installations/sage-5.10.rc0\n/tmp/a\u00bb rm a1.png\n/tmp/a\u00bb dvipng a.dvi\nThis is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson\n[1] \n/tmp/a\u00bb ls\na1.png\ta.dvi\n```\n",
    "created_at": "2013-06-19T12:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163894",
    "user": "ppurka"
}
```

dvipng works from inside sage -sh for me.

```
/tmp/a» ls
a.dvi
/tmp/a» dvipng a.dvi
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
/tmp/a» ls
a1.png	a.dvi
/tmp/a» sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/mnt/usb/Installations/sage-5.10.rc0
/tmp/a» rm a1.png
/tmp/a» dvipng a.dvi
This is dvipng 1.14 Copyright 2002-2010 Jan-Ake Larsson
[1] 
/tmp/a» ls
a1.png	a.dvi
```




---

archive/issue_comments_163895.json:
```json
{
    "body": "Replying to [comment:7 ppurka]:\n> dvipng works from inside sage -sh for me.\n\nHuh. And you use Gentoo, right? So we built dvipng the same way. Beats me.",
    "created_at": "2013-06-19T12:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163895",
    "user": "mjo"
}
```

Replying to [comment:7 ppurka]:
> dvipng works from inside sage -sh for me.

Huh. And you use Gentoo, right? So we built dvipng the same way. Beats me.



---

archive/issue_comments_163896.json:
```json
{
    "body": "Yes. Using pure (i.e. *not* one of the \"forks\" like Funtoo, Sabayon, etc) amd64 Gentoo here. :)\n\nEdit: One thing that is different is my shell. I am using zsh.",
    "created_at": "2013-06-19T12:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163896",
    "user": "ppurka"
}
```

Yes. Using pure (i.e. *not* one of the "forks" like Funtoo, Sabayon, etc) amd64 Gentoo here. :)

Edit: One thing that is different is my shell. I am using zsh.



---

archive/issue_comments_163897.json:
```json
{
    "body": "Works fine with 6.2.beta6",
    "created_at": "2014-04-04T19:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163897",
    "user": "novoselt"
}
```

Works fine with 6.2.beta6



---

archive/issue_comments_163898.json:
```json
{
    "body": "Looks like it:\n\n\n```\nsage: hello = var('hello')\nsage: latex(hello)\n\\mathit{hello}\n```\n\n\nThe absence of \\mbox probably makes a better unit test than the presence of \\mathit.",
    "created_at": "2014-04-05T21:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163898",
    "user": "mjo"
}
```

Looks like it:


```
sage: hello = var('hello')
sage: latex(hello)
\mathit{hello}
```


The absence of \mbox probably makes a better unit test than the presence of \mathit.



---

archive/issue_comments_163899.json:
```json
{
    "body": "I think the test for this ticket should be that plotting command works - what exactly is fed into it is not as relevant. Feel free to write the test and I'll review it ;-)",
    "created_at": "2014-04-05T21:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163899",
    "user": "novoselt"
}
```

I think the test for this ticket should be that plotting command works - what exactly is fed into it is not as relevant. Feel free to write the test and I'll review it ;-)



---

archive/issue_comments_163900.json:
```json
{
    "body": "Before the fix, the variable was math-escaped (as well as unplottable). A much lesser bug for sure, but now it's correctly marked up as a variable. I guess we should test that too but checking for \\mbox or \\mathrm is all I can think of.",
    "created_at": "2014-04-08T15:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163900",
    "user": "mjo"
}
```

Before the fix, the variable was math-escaped (as well as unplottable). A much lesser bug for sure, but now it's correctly marked up as a variable. I guess we should test that too but checking for \mbox or \mathrm is all I can think of.



---

archive/issue_comments_163901.json:
```json
{
    "body": "I guess I shouldn't leave this open forever.\n----\nNew commits:",
    "created_at": "2015-12-04T01:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163901",
    "user": "mjo"
}
```

I guess I shouldn't leave this open forever.
----
New commits:



---

archive/issue_comments_163902.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-04T01:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163902",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_163903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-04T02:42:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163903",
    "user": "kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_163904.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-05T10:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13339",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13339#issuecomment-163904",
    "user": "vbraun"
}
```

Resolution: fixed
